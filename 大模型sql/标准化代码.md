1. 单独主题
0. 征信-1

-- 最新中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250630201_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250630201_CST_01 AS
select cst_id,prd_dt,cst_cr_grd_val
    ,nvl(cst_cr_grd_val,0) as zz_score
    ,scor_rng
    ,concat('[',floor(cst_cr_grd_val/20)*20,',',floor(cst_cr_grd_val/20)*20+20,')') as scor_rng_mod
    ,row_number() over(partition by cst_id order by prd_dt desc) rn
from(
    SELECT cst_id,prd_dt,cst_cr_grd_val,scor_rng
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20250630'
    union
    SELECT cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                          AS cst_cr_grd_val
        ,scor_rng
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20250630'
)t where nvl(cst_id,'')<>''
;

-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ20250630201_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250630201_CST_02 AS
SELECT cst_id,REPLACE(substr(report_dt,1,10),'-','') as prd_dt
    ,idv_crd_sco_val
    ,case when idv_crd_sco_val is null or idv_crd_sco_val <=0 then 0 else idv_crd_sco_val end as zx_score
    ,scor_rng
    ,concat('[',floor(idv_crd_sco_val/20)*20,',',floor(idv_crd_sco_val/20)*20+20,')') as scor_rng_mod
from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
where dt='20250630'
and report_dsc_rn=1
;

-- 征信 征信分 dws_cst_ccrc_idv_ind_inf_di
select cst_id,report_dt    --报告日期
    ,qry_rsn    --查询原因
    ,'个人' as cst_type
    ,cred_total_amt,cred_total_balan
from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
where dt='20250713'
and report_dsc_rn=1
union all
select cst_id,report_dt    --报告日期
    ,qry_rsn    --查询原因
    ,'企业'
    ,cred_total_amt,cred_total_balan
from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
where dt='20250713'
and report_dsc_rn=1
;

select '个人征信指标' as tbl_nm
     ,count(1) cnt
     ,count(distinct crdt_rpt_no) as 征信报告编号
     ,count(distinct cst_id) as 客户号
from adm_pub_app.adm_pblc_cst_crdt_indiv_cst_idx_dd --个人征信指标
where dt='20250630';
-- tbl_nm     cnt     征信报告编号     客户号
-- 个人征信指标     26100344     26100344     5855372



select '征信报告风险指标表' as tbl_nm
     ,count(1) cnt
     ,count(distinct crdt_rpt_no) as 征信报告编号
     ,count(distinct cst_id) as 客户编号
     ,count(distinct idtc_rsk_ctrl_no) as 同一风险控制号
from adm_ind.adm_ind_i_crdt_rpt_rsk_idx_dd --征信报告风险指标表 20250507 开始有数据
where dt='20250630';
-- tbl_nm     cnt     征信报告编号     客户编号     同一风险控制号
-- 征信报告风险指标表     6365469     6365469     6365469     4963690


-- dtrb_org_typ_cd
-- 11:商业银行
-- 12:村镇银行
-- 14:住房储蓄银行
-- 15:外资银行
-- 16:财务公司
-- 21:信托公司
-- 22:融资租赁公司
-- 23:汽车金融公司
-- 24:消费金融公司
-- 25:贷款公司
-- 26:金融资产管理公司
-- 31:证券公司
-- 41:保险公司
-- 51:小额贷款公司
-- 52:公积金管理中心
-- 53:融资担保公司
-- 54:保理公司
-- 99:其他机构

-- act_sts_cd
-- 1:正常
-- 2:逾期
-- 3:结清
-- 31:银行止付（由于持卡人信用问题导致商业银行停用其信用卡账户的透支功能）
-- 4:呆账
-- 5:转出/银行止付
-- 6:担保物不足
-- 7:强制平仓
-- 8:司法追偿

-- five_ctg_cd
-- 1    正常
-- 2    关注
-- 3    次级
-- 4    可疑
-- 5    损失
-- 9    未分类
2. 量化风险
-- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
select cst_id
    ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
    ,risk_model_score as 泰隆分
    --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
where dt = '20250630'
union
select cst_id
    ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    ,risk_model_score as 泰隆分
from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
where dt = '20250630'
;
2. 合同、担保合同、押品-1
-- 押品信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_03 AS
select t1.cltr_no                                  --押品编号|c32
    ,t1.cltr_typ_cd                              --押品类型代码|c7
    ,t1.cltr_nm                                  --押品名称|c200
    ,t1.mort_pldg_gds_sts_cd                     --抵质押物状态代码|c2
    ,t1.cltr_chk_dt                              --押品核验日期|c8
    ,t1.at_oth_bnk_mort_pldg_ind                 --他行有抵质押标志|c1
    ,t1.our_bnk_psit_cd                          --我行顺位代码|c1
    ,t1.oth_bnk_mort_pldg_cnt                    --他行抵质押笔数|int10
    ,t1.oth_bnk_mort_pldg_amt                    --他行抵质押金额|decimal(21, 2)
    ,t1.mort_pldg_gds_situ                       --抵质押物情况|c2
    ,t1.sys_reg_tm                               --系统登记时间|c20
    ,t2.wrnt_no         --权证编号
    ,t2.wrnt_typ_cd     --权证类型代码
    ,t2.oois_sts_nm     --出入库状态
    ,t3.val_ases_serno                           --价值评估流水号
    ,t3.ases_bss_dt                              --评估基准日期
    ,t3.ases_avldt_stop_dt                       --评估效力截止日期
    ,t3.ases_mod_cd                              --评估方式代码|c1
    ,t3.cltr_ases_chnl_cd                        --押品评估渠道代码|c2
    ,t3.ccy_cd                                   --币种代码|c3
    ,t3.ases_val                                 --评估价值
    ,t3.afm_val         as new_afm_val           --认定价值
    ,t3.mort_pldg_rat                            --抵质押率
from edw.dim_bus_loan_cltr_bas_inf_dd    t1      --押品基本信息
left join (
    SELECT  t1.cltr_no                --押品编号|C32
        ,concat_ws('|',collect_set(t1.wrnt_no)) as wrnt_no --权证编号
        ,concat_ws('|',collect_set(t1.wrnt_typ_cd)) as wrnt_typ_cd --权证类型代码|C2
        ,concat_ws('|',collect_set(t1.oois_sts_cd)) as oois_sts_cd --出入库状态代码|C2
        ,concat_ws('|',collect_set(c1.cd_val_dscr)) as oois_sts_nm
    FROM edw.dwd_bus_loan_cltr_wrnt_inf_dd  t1 --押品权证信息
    LEFT JOIN edw.dwd_code_library_dd       c1 -- 码值表
    ON t1.OOIS_STS_CD = c1.cd_val
    AND c1.tbl_nm = 'DWD_BUS_LOAN_CLTR_WRNT_INF_DD'
    AND c1.fld_nm = 'OOIS_STS_CD'
    AND c1.dt = t1.dt
    WHERE t1.dt = '@@{yyyyMMdd}'
    group by t1.cltr_no
)t2 on t1.cltr_no=t2.cltr_no
left join(
    select cltr_no                                --押品编号|c32
        ,val_ases_serno                           --价值评估流水号|c32
        ,ases_bss_dt                              --评估基准日期
        ,ases_avldt_stop_dt                       --评估效力截止日期
        ,ases_mod_cd                              --评估方式代码|c1
        ,cltr_ases_chnl_cd                        --押品评估渠道代码|c2
        ,ccy_cd                                   --币种代码|c3
        ,ases_val                                 --评估价值
        ,afm_val                                  --认定价值
        ,incl_mortd_amt_ind                       --包含已抵金额标志|c1
        ,mort_pldg_rat                            --抵质押率
        ,eff_ind                                  --生效标识
        ,row_number() over(partition by cltr_no order by sys_reg_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd --押品价值评估申请信息表
    where dt='@@{yyyyMMdd}'
)t3 on t1.cltr_no=t3.cltr_no
and t3.rn=1
where t1.dt='@@{yyyyMMdd}'
;

-- 合同流水号担保合同编号担保物编号
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_04 AS
select t1.ctr_serno                              --合同流水号|c32
    ,t1.grnt_ctr_no                              --担保合同编号|c32
    ,t1.grnt_gds_id                              --担保物编号|c20|包括押品编号和保证人客户号
    ,t1.grnt_gds_nm                              --担保物名称|c200
    ,t1.grnt_amt                                 --担保金额|decimal(21,2)
    ,t1.hgst_can_grnt_amt                        --最高可担保金额|decimal(21,2)
    ,t1.grnt_gds_typ_cd                          --担保物类型代码|c1|1 保证人 2 押品
    -- ,decode(t1.grnt_gds_typ_cd,'1','保证人','2','押品') AS grnt_gds_typ_nm --担保物类型
    ,COALESCE(SUBSTR(t2.CLTR_TYP_CD,1,5),'')       AS 押品二级分类代码
    ,COALESCE(c1.CLTR_CTG_NM,'')                   AS 押品二级分类名称
    ,t2.CLTR_TYP_CD                                AS 押品三级分类代码
    ,COALESCE(c2.CLTR_CTG_NM,'')                   AS 押品三级分类名称
    ,t2.afm_val         as grnt_afm_val          --认定价值|decimal
    ,t3.cst_id                                   --客户号
    ,t3.cst_nm                                   --客户名称
    ,t3.rel_serno                                 --用信申请流水号
    ,t3.发生类型
    ,t3.ctr_amt                                  --合同金额
    ,t3.ctr_bal                                  --合同余额
    ,t3.ctr_bgn_dt                               --合同起始日期
    ,t3.ctr_mtu_dt                               --合同到期日期
    ,t3.ctr_sts_cd                               --合同状态代码
    ,t3.mgr_id            --管户人工号
    ,t3.mgr_nm            --管户人
    ,t3.mgr_org_id        --管户机构号
    ,t3.hdl_org_id        --经办机构编号|c10
    ,t3.hdl_opr_id        --经办人工号
    ,t3.hdl_opr_nm        --经办人
    ,t3.brc_org_nm,t3.sbr_org_nm,t3.tem_org_nm
    ,t4.grnt_ctr_typ_cd                          --担保合同类型代码|c3
    ,t4.colc_grnt_ind                            --集合型担保标志|c1
    ,t4.wrat_cst_id                              --被担保人客户号|c20
    ,t4.wrat_nm                                  --被担保人名称|c200
    ,t4.grnt_mod_cd                              --担保方式代码|c3
    ,t4.ast_pool_ind                             --资产池标志|c1
    ,t4.ast_pool_no                              --资产池编号|c32
    ,t4.ofln_grnt_ind                            --线下担保标志|c1
    ,t4.ccy_cd                                   --币种代码|c3
    ,t4.exr                                      --汇率|decimal
    ,t4.grnt_ctr_amt                             --担保合同金额|decimal
    ,t4.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
    ,t4.rvlg_ind                                 --循环标志|c1
    ,t4.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
    ,t4.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
    ,t4.ofln_grnt_rsn                            --线下担保原因|c512
    ,t4.sgn_ctr_mod_cd                           --签约方式代码|c1
    ,t4.dbl_rcd_ind                              --双录标志|c1
    ,t4.dbl_rcd_mod_cd                           --双录模式代码|c1
    ,t4.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,t4.grnt_ctr_sts_nm
    ,t4.ctr_crcl_sts_cd                          --合同流转状态代码|c1
    ,t4.aprv_sts_cd                              --审批状态代码|c2
    ,t4.colc_typ_grnt_ctr_no                     --集合型担保合同编号|c32
    ,t4.sys_reg_psn_id                           --系统登记人编号|c20
    ,t4.sys_reg_org_id                           --系统登记机构号|c20
    ,t4.sys_reg_dt                               --系统登记日期|c8
    ,t4.last_upd_dt                              --最后更新日期|c8
    ,t4.ctr_sgn_dt                               --合同签收日期|c8
    ,t5.cltr_typ_cd                              --押品类型代码|c7
    ,t5.cltr_no
    ,t5.cltr_nm                                  --押品名称|c200
    ,t5.mort_pldg_gds_sts_cd                     --抵质押物状态代码|c2
    ,t5.cltr_chk_dt                              --押品核验日期|c8
    ,t5.at_oth_bnk_mort_pldg_ind                 --他行有抵质押标志|c1
    ,t5.our_bnk_psit_cd                          --我行顺位代码|c1
    ,t5.oth_bnk_mort_pldg_cnt                    --他行抵质押笔数|int10
    ,t5.oth_bnk_mort_pldg_amt                    --他行抵质押金额|decimal(21, 2)
    ,t5.mort_pldg_gds_situ                       --抵质押物情况|c2
    ,t5.sys_reg_tm                               --系统登记时间|c20
    ,t5.wrnt_no         --权证编号
    ,t5.wrnt_typ_cd     --权证类型代码
    ,t5.oois_sts_nm     --出入库状态
    ,t5.val_ases_serno                           --价值评估流水号
    ,t5.ases_bss_dt                              --评估基准日期
    ,t5.ases_avldt_stop_dt                       --评估效力截止日期
    ,t5.ases_mod_cd                              --评估方式代码|c1
    ,t5.cltr_ases_chnl_cd                        --押品评估渠道代码|c2
    ,t5.ccy_cd     as yp_ccy_cd                  --币种代码|c3
    ,t5.ases_val                                 --评估价值
    ,t5.new_afm_val                              --认定价值
    ,t5.mort_pldg_rat                            --抵质押率
    ,t6.wrnt_no         as g_c_wrnt_no     --权证编号
    ,t6.wrnt_typ_cd     as g_c_wrnt_typ_cd --权证类型代码
    ,t6.oois_sts_nm     as g_c_oois_sts_nm --出入库状态
from edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd      t1 --主合同、担保合同、担保物关系
LEFT JOIN    edw.dim_bus_loan_grnt_ctr_mort_pldg_dd t2 --担保合同抵质押信息
ON  t1.grnt_ctr_no = t2.grnt_ctr_no
and t1.grnt_gds_id=t2.cltr_no
AND t2.dt = t1.dt
LEFT JOIN    edw.DIM_BUS_LOAN_CLTR_CTG_INF_DD c1 --押品分类信息
ON      SUBSTR(t2.CLTR_TYP_CD, 1, 5) = c1.CLTR_CTG_CD
AND     c1.DT = t1.dt
LEFT JOIN    edw.DIM_BUS_LOAN_CLTR_CTG_INF_DD c2 --押品分类信息
ON      t2.CLTR_TYP_CD = c2.CLTR_CTG_CD
AND     c2.DT = t1.dt
inner join SJXQ_SJ2025030766_CST_01 t3 on t1.ctr_serno=t3.ctr_serno
inner join SJXQ_SJ2025030766_CST_02 t4 on t1.grnt_ctr_no=t4.grnt_ctr_no
inner join SJXQ_SJ2025030766_CST_03 t5 on t1.grnt_gds_id=t5.cltr_no
left join (
    SELECT  t1.grnt_ctr_no,t1.cltr_no                --押品编号|C32
        ,concat_ws('|',collect_set(t1.wrnt_no))      as wrnt_no --权证编号
        ,concat_ws('|',collect_set(t1.wrnt_typ_cd)) as wrnt_typ_cd --权证类型代码|C2
        ,concat_ws('|',collect_set(t1.oois_sts_cd)) as oois_sts_cd --出入库状态代码|C2
        ,concat_ws('|',collect_set(c1.cd_val_dscr)) as oois_sts_nm
    FROM edw.dwd_bus_loan_cltr_wrnt_inf_dd  t1 --押品权证信息
    LEFT JOIN edw.dwd_code_library_dd       c1 -- 码值表
    ON t1.OOIS_STS_CD = c1.cd_val
    AND c1.tbl_nm = 'DWD_BUS_LOAN_CLTR_WRNT_INF_DD'
    AND c1.fld_nm = 'OOIS_STS_CD'
    AND c1.dt = t1.dt
    WHERE t1.dt = '@@{yyyyMMdd}'
    group by t1.grnt_ctr_no,t1.cltr_no
)t6 on t1.grnt_gds_id=t6.cltr_no
and t1.grnt_ctr_no=t6.grnt_ctr_no
where t1.dt='@@{yyyyMMdd}'
and t1.GRNT_GDS_TYP_CD='2' -- 押品
;
2.0. 申请受理
edw.dwd_bus_loan_aply_acpt_inf_dd    申请受理信息
2.1 合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025070206_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070206_CST_01 AS
select t1.cst_id                                   --客户号
    ,min(case when ctr_bgn_dt<>'18991231' then t1.ctr_bgn_dt end) as fst_ctr_dt --合同起始日期
    ,sum(case when t1.dt='20250630'  and ((t1.CTR_STS_CD IN ( '2' , '4' ) AND t1.TMT_DT = '18991231'
        AND to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date('20250630', 'yyyyMMdd') )
        OR t1.CTR_BAL > 0) then ctr_amt else 0 end)             as ctr_amt
    ,sum(case when t1.dt='20250630' then ctr_bal else 0 end)    as ctr_bal
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
where t1.dt<='20250630'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
group by t1.cst_id
;

-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.cst_id                                   --客户号
    ,t1.cst_nm                                   --客户名称
    ,t1.rel_serno                                 --用信申请流水号
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as 发生类型
    ,t1.ctr_amt                                  --合同金额
    ,t1.ctr_bal                                  --合同余额
    ,t1.ctr_bgn_dt                               --合同起始日期
    ,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,t1.mgr_id            --管户人工号
    ,t3.empe_nm         as 管户人
    ,t1.mgr_org_id        --管户机构号
    ,t1.hdl_org_id        --经办机构编号|c10
    ,t1.hdl_opr_id        --经办人工号
    ,t5.empe_nm         as 经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2  --不需要产品名称字段可删除该表
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
-- and t1.mgr_org_id like '3561%' --政和村行
-- and t1.sys_reg_dt >='20240801' --系统登记日期
;
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ20251231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20251231_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno                                 --用信申请流水号
    ,t1.cst_id                                   --客户号|C20
    ,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt                             --合同敞口金额|decimal(21,2)
    ,t1.ctr_epsr_bal                             --合同敞口余额
    ,t1.ctr_bgn_dt                               --合同起始日期
    ,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT                                     --终结日期
    ,t1.CTR_STS_CD                               --合同状态 1:未生效|2:已生效|3:终止|4:冻结|5:作废
    ,t1.exec_intr_rat                            --执行利率DECIMAL(13,7)
    ,t1.hpn_typ_cd    --    发生类型代码|c6
    ,t1.grnt_mod_colc        --担保方式集合|c200
    ,t1.cpt_usg_cd    --资金用途代码|c4
    ,t1.cpt_usg_rmk    --资金用途备注|c4000
    ,t1.bsn_mark_cd
    ,case when t1.bsn_mark_cd='03' then '是' ELSE '否' end pre_dfd_pre_rpt_ind    --预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN T1.bsn_mark_cd='04' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt                                    --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt                                    --逾期日期
    ,t1.onbs_ovd_intr_bal                        --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal                        --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt                                --欠息日期|C8
    ,t1.ref_intr_rat                            --参考利率DECIMAL(13,2)
    ,t1.SYS_REG_DT                                --系统登记日期 经办日期
    ,t1.RVLG_TYP_CD        --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then'是' else '' end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then'是' else '' end is_tyd
    ,t1.mgr_id                                     --管户人工号|C10
    ,t3.empe_nm                                     --管户人姓名|C200
    ,t1.mgr_org_id                                 --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm --管户机构
    ,t5.cst_chn_nm
    ,decode(t5.cst_typ_cd,'1','对私','2','对公') as 客户类型
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = t1.dt
and c1.tbl_nm=upper('dim_bus_loan_ctr_bse_inf_dd')
and c1.fld_nm=upper('bsn_mark_cd')
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = t1.dt
and c2.tbl_nm=upper('dim_bus_loan_ctr_bse_inf_dd')
and c2.fld_nm=upper('RVLG_TYP_CD')
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;

select cst_id,sum(ctr_bal) as ctr_bal
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
group by cst_id

--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_01 AS
SELECT  a.grnt_mod_colc
       ,WM_CONCAT('|',COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
FROM
(
    SELECT  distinct grnt_mod_colc
           ,grnt_mod_colc2
    FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
    WHERE dt = '@@{yyyyMMdd}'
    AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.grnt_mod_colc
;
2.2 担保合同
select ctr_serno                                --合同流水号|c32
    ,grnt_ctr_no                              --担保合同编号|c32
    ,thstm_ocp_grnt_lmt                       --本次占用担保额度|decimal
    ,ocp_seq                                  --占用顺序|bigint
    ,grnt_ctr_typ_cd                          --担保合同类型代码|c3
    ,busi_typ_cd                              --业务类型代码1贷款业务2信用卡业务|c1
    ,eff_sts_cd                               --生效状态代码|c1
from edw.dwd_bus_loan_ctr_rel_grnt_dd         --主合同、担保合同关系
where dt='@@{yyyyMMdd}'
;
-- 担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_02 AS
select t1.grnt_ctr_no                              --担保合同编号|c32
    ,t1.grnt_ctr_typ_cd                          --担保合同类型代码|c3
    ,t1.colc_grnt_ind                            --集合型担保标志|c1
    ,t1.wrat_cst_id                              --被担保人客户号|c20
    ,t1.wrat_nm                                  --被担保人名称|c200
    ,t1.grnt_mod_cd                              --担保方式代码|c3
    ,t1.ast_pool_ind                             --资产池标志|c1
    ,t1.ast_pool_no                              --资产池编号|c32
    ,t1.ofln_grnt_ind                            --线下担保标志|c1
    ,t1.ccy_cd                                   --币种代码|c3
    ,t1.exr                                      --汇率|decimal
    ,t1.grnt_ctr_amt                             --担保合同金额|decimal
    ,t1.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
    ,t1.rvlg_ind                                 --循环标志|c1
    ,t1.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
    ,t1.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
    ,t1.ofln_grnt_rsn                            --线下担保原因|c512
    ,t1.sgn_ctr_mod_cd                           --签约方式代码|c1
    ,t1.dbl_rcd_ind                              --双录标志|c1
    ,t1.dbl_rcd_mod_cd                           --双录模式代码|c1
    ,t1.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,t2.cd_val_dscr     as grnt_ctr_sts_nm
    ,t1.ctr_crcl_sts_cd                          --合同流转状态代码|c1
    ,t1.aprv_sts_cd                              --审批状态代码|c2
    ,t1.colc_typ_grnt_ctr_no                     --集合型担保合同编号|c32
    ,t1.sys_reg_psn_id                           --系统登记人编号|c20
    ,t1.sys_reg_org_id                           --系统登记机构号|c20
    ,t1.sys_reg_dt                               --系统登记日期|c8
    ,t1.last_upd_dt                              --最后更新日期|c8
    ,t1.ctr_sgn_dt                               --合同签收日期|c8
from edw.dim_bus_loan_ctr_grnt_inf_dd   t1      --担保合同信息
LEFT JOIN    edw.dwd_code_library_dd     t2 --码值表
ON      t1.GRNT_CTR_STS_CD = t2.cd_val
AND     t2.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     t2.fld_nm = 'GRNT_CTR_STS_CD'
AND     t2.DT = t1.dt
where t1.dt='@@{yyyyMMdd}'
;
2.3 押品
2.4 预评估-1
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030421_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030421_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t1.sys_reg_tm        --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t2.PRE_ASES_rul_nm  --预评估触发规则
    ,t2.PRE_ASES_prmpt_msg  --预评估提示信息
from(
    SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm            --客户名称
        ,mbrwr_cst_id    --主借款人客户号
        ,aply_org_id    --申请机构号|c32
        ,sys_reg_tm        --系统登记时间|c19
        ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
    FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
    WHERE DT = '@@{yyyyMMdd}'
)t1 left JOIN (
    SElECT t1.PRE_ASES_SERNO
        ,WM_CONCAT('|',COALESCE(c1.cd_val_dscr)) rul_set_rslt_nm
        ,WM_CONCAT('|',COALESCE(T2.PRE_ASES_rul_nm))    as PRE_ASES_rul_nm
        ,WM_CONCAT('|',COALESCE(T2.PRE_ASES_prmpt_msg)) as PRE_ASES_prmpt_msg
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t1
    LEFT JOIN edw.dwd_code_library_dd               c1
    ON  t1.RUL_SET_RSLT_CD = c1.cd_val
    AND c1.DT = '@@{yyyyMMdd}'
    AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND c1.fld_nm = 'RUL_SET_RSLT_CD'
    LEFT JOIN
    (
        SELECT  B1.rul_set_rslt_serno
               ,WM_CONCAT('||',B1.rul_nm)    AS PRE_ASES_rul_nm
               ,WM_CONCAT('||',B1.prmpt_msg) AS PRE_ASES_prmpt_msg
        FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
        WHERE B1.DT = '@@{yyyyMMdd}'
        GROUP BY  B1.rul_set_rslt_serno
    ) T2
    ON T1.rul_set_rslt_serno = T2.rul_set_rslt_serno
    where t1.DT = '@@{yyyyMMdd}'
    group by t1.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;

-- 合同申请时预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_02_1 AS
SELECT t1.ctr_serno
    ,t1.CST_ID                                   --客户号|C20
    ,t1.CST_NM                                   --客户名称
    ,t1.grnt_mod_colc                            --担保方式集合
    ,t1.cpt_usg_rmk                              --资金用途备注
    ,t2.USC_APLY_SERNO
    ,t2.cst_id                                   as 预评估客户号
    ,t2.PRE_ASES_SERNO                           --预评估流水号|C32
    ,t2.rul_set_no
    ,t2.rul_set_rslt_cd
    ,c1.cd_val_dscr     as 预评估结果
    ,t2.app_cst_rol_cd
    ,c2.cd_val_dscr     as 客户角色
from edw.DIM_BUS_LOAN_CTR_BSE_INF_DD     t1
left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd  t2   --授信关联预评估信息表
ON t2.USC_APLY_SERNO = t1.REL_SERNO
and t2.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd               c1
ON  t2.RUL_SET_RSLT_CD = c1.cd_val
AND c1.DT = '@@{yyyyMMdd}'
AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND c1.fld_nm = 'RUL_SET_RSLT_CD'
LEFT JOIN edw.dwd_code_library_dd               c2
ON  t2.app_cst_rol_cd = c2.cd_val
AND c2.DT = '@@{yyyyMMdd}'
AND c2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND c2.fld_nm = upper('app_cst_rol_cd')
where t1.DT = '@@{yyyyMMdd}'
;
2.5 借据-逾期次数
select *
from app_rpt.adm_pub_bus_loan_dbil_inf_dd     --公共集市-贷款业务信息汇总表
where dt='@@{yyyyMMdd}'
;

select t1.ctr_srl_no                               --合同流水号
    ,t1.dbil_srl_no                              --借据流水号
    ,t1.cst_id                                   --核心客户编号
    ,t1.cst_nm                                   --客户名称
    ,t1.dbil_bal_cny                             --余额
    ,t1.grant_amt                                --发放金额
    ,t1.grant_date                               --发放日期
    ,t1.end_date                                 --到期日期
    ,t1.five_level_ctg                           --五级分类
    ,t1.ovd_day                                  --逾期天数
    ,t1.prcp_ovd_date                            --本金逾期日期
    ,t1.intr_ovd_date                            --利息逾期日期
    ,t1.ovd_prcp_bal                             --逾期本金余额
    ,t1.start_ctr_srl_no_1                       --初始合同号1
    ,t1.start_cst_nm_1                           --初始客户名称1
    ,t1.start_ctr_srl_no_2                       --初始合同号2
    ,t1.start_cst_nm_2                           --初始客户名称2
    ,t1.other_and_memo                           --其他及备注
    ,t1.rfin_ctg                                 --重组分类
    ,t1.wtf_sts_label                            --核销状态标识 1-核销已结清 2-核销未结清
    ,t2.col_6 as 是否预保预报
from adm_rsk.adm_rsk_apl_inter_all  t1 --风险集市应用表-资产质量日常监测源表
INNER JOIN SJXQ_SJ2025071161_CST_01 t2
on t1.ctr_srl_no=t2.col_1
where t1.dt='20250713'
;

select t1.DBIL_ID                                  --借据编号|C64
    ,t1.CTR_SERNO                                --合同流水号|C32
    ,t1.CST_ID                                   --客户号|C20
    ,t1.CST_NM                                   --客户名称|C200
    ,t1.AMT                                      --金额
    ,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
    ,t1.PRCP_BAL                                 --本金余额
    ,t1.NORM_BAL                                 --正常余额
    ,t1.OVD_AMT                                  --逾期金额
    ,t1.DULL_BAL                                 --呆滞余额
    ,t1.STGN_DBT_BAL                             --呆账余额
    ,t1.ONBS_OVD_INTR_BAL                        --表内欠息余额
    ,t1.OFBS_OVD_INTR_BAL                        --表外欠息余额
    ,t1.OVD_DT                                   --逾期日期|C8
    ,t1.OVD_INTR_DT                              --欠息日期|C8
    ,t1.OVD_DAY                                  --逾期天数
    ,t1.OVD_INTR_DAY                             --欠息天数
    ,case when t1.OVD_DT<>'18991231' then t1.OVD_DAY else 0 end as 本金逾期天数
    ,case when t1.OVD_INTR_DT<>'18991231' then t1.OVD_INTR_DAY else 0 end as 本金逾期天数
    ,t1.HIS_MAX_OVD_DAYS                         --历史最大逾期天数
    ,t1.TMT_DT                                   --终结日期|C8
    ,t1.PYF_IND                                  --结清标志|C1
    ,t1.CTR_AMT                                  --合同金额
    ,t1.CUR_DTRB_AMT                             --已发放金额
    ,t1.RMN_DTRB_AMT                             --可发放金额
    ,t1.MTU_DT                                   --到期日期|C8
    ,t1.dt
from edw.dim_bus_loan_dbil_inf_dd   t1 --信贷借据信息
where t1.dt='20250713'

-- 逾期本金、逾期利息、逾期总额
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_02 as
select t2.ctr_serno                               --合同流水号
    ,sum(t1.dbil_amt            ) as dbil_amt             --借据金额
    ,sum(t1.dbil_bal            ) as dbil_bal             --借据余额 = 正常本金+逾期本金+呆滞本金+呆账本金
    ,sum(t1.cny_dbil_bal        ) as cny_dbil_bal         --借据余额(折人民币)
    ,sum(t1.nrm_prcp            ) as nrm_prcp             --正常本金
    ,sum(t1.ovd_prcp            ) as ovd_prcp             --逾期本金
    ,sum(t1.dead_prcp           ) as dead_prcp            --呆滞本金
    ,sum(t1.bad_debt_prcp       ) as bad_debt_prcp        --呆账本金
    ,sum(t1.ovd_intr            ) as ovd_intr             --逾期利息 = 表内欠息+表外欠息
    ,sum(t1.table_intn_debt_intr) as table_intn_debt_intr --表内欠息
    ,sum(t1.table_extn_debt_intr) as table_extn_debt_intr --表外欠息
    ,count(distinct dbil_srl_no) as dbil_cnt
from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd   t1 --风险集市信贷业务借据信息表
inner join SJXQ_SJ20241112121_CST_01        t2
on t1.ctr_srl_no=t2.ctr_serno
where t1.dt='20240930'
group by t2.ctr_serno
;

-- 借据汇总 与上面数据一致
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_03_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_03_1 as
SELECT  t1.ctr_serno                                     --合同流水号|c32
       ,SUM(t1.amt)               AS fk_amt             --金额|decimal(21,2)
       ,MIN(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt     --出账起始日期|c8
       ,MAX(t1.exec_mtu_dt)       AS exec_mtu_dt        --执行到期日|c8
       ,SUM(t1.prcp_bal)          AS prcp_bal           --本金余额 = 正常余额+逾期金额+呆滞余额+呆账余额
       ,SUM(t1.norm_bal)          AS norm_bal           --正常余额|decimal(22,2)
       ,SUM(t1.ovd_amt)           AS ovd_amt            --逾期金额|decimal(21,2)
       ,SUM(t1.dull_bal)          AS dull_bal           --呆滞余额|decimal(22,2)
       ,SUM(t1.stgn_dbt_bal)      AS stgn_dbt_bal       --呆账余额|decimal(21,2)
       ,SUM(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal  --表内欠息余额|decimal(21,2)
       ,SUM(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal  --表外欠息余额|decimal(21,2)
       ,MAX(t1.tmt_dt)            AS tmt_dt             --终结日期|c8
       ,MAX(t1.prcp_pyf_dt)       AS prcp_pyf_dt        --本金结清日期|c8
       ,MAX(t1.pyf_ind)           AS pyf_ind            --结清标志
       ,COUNT(distinct dbil_id)   AS dbil_cnt
from edw.dim_bus_loan_dbil_inf_dd       t1
inner join SJXQ_SJ20241112121_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt='20240930'
GROUP BY t1.ctr_serno
;
2.6 精准贷后 贷后管理

SELECT  T1.cst_id       --客户号
        ,T2.tsk_gen_dt  --最近一次触碰精准贷后_处置类时间
        ,ROW_NUMBER() over(PARTITION BY T1.cst_id ORDER BY t2.tsk_gen_dt desc) rn
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
AND     T2.DT = '20241231'
WHERE   T1.DT = '20241231'
;
-- 精准贷后 取2024年首次触发精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025031081_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031081_CST_01 AS -- explain
SELECT t1.btch_serno
    ,t1.tsk_gen_dt
    ,COALESCE(t2.cst_id,t3.cst_id) as cst_id
    ,t2.cst_lvl_pst_loan_mng_pln_cd,t2.cst_lvl_pst_loan_mng_pln_nm,t2.chk_cpl_dt
    ,t3.pst_loan_mng_pln_cd,t3.pst_loan_mng_pln_nm
    ,t3.ctr_serno                                --合同流水号|c32
    ,t3.ori_ctr_amt                              --原合同金额|decimal(21,2)
    ,t3.new_ctr_amt                              --新合同金额|decimal(21,2)
    ,t3.ctr_amt,t3.ctr_bal,t3.sys_reg_tm
    ,case when t2.cst_lvl_pst_loan_mng_pln_nm REGEXP '退出|清收|预保预报|重组|诉讼' then 1 else 0 end as is_cst_out  --客户级
    ,case when t3.pst_loan_mng_pln_nm REGEXP '预保预报|重组|诉讼|清收' then 1 else 0 end as is_biz_out      --业务级
from(
    SELECT btch_serno
        ,tsk_gen_dt   --任务生成日期 精准贷后风险触发时间
        ,ROW_NUMBER() over(PARTITION BY btch_serno ORDER BY tsk_gen_dt aSC) rn_asc
    from edw.dwd_bus_loan_psp_chk_tsk_inf_dd  AS T2 --贷后检查任务信息
    where DT = '@@{yyyyMMdd}'
    AND pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
    AND tsk_gen_dt between '20240101' and '20241231'
)t1 left JOIN (
    SELECT t1.btch_serno,t1.cst_id
        ,t1.cst_lvl_pst_loan_mng_pln_cd              --客户级贷后管理方案代码 ,'03','重组','04','退出','06','预保预报','07','清收','08','诉讼'
        ,c1.cd_val_dscr     as cst_lvl_pst_loan_mng_pln_nm
        ,t1.chk_cpl_dt        --检查完成日期|c8
    from edw.dwd_bus_loan_psp_chk_btch_inf_dd AS T1 --贷后检查批次信息表
    LEFT JOIN    edw.dwd_code_library_dd     c1 --码值表
    ON      t1.cst_lvl_pst_loan_mng_pln_cd = c1.cd_val
    AND     c1.tbl_nm = upper('dwd_bus_loan_psp_chk_btch_inf_dd')
    AND     c1.fld_nm = upper('cst_lvl_pst_loan_mng_pln_cd')
    AND     c1.DT = t1.dt
    where t1.DT = '@@{yyyyMMdd}'
)t2 on t1.btch_serno=t2.btch_serno
left join(
    SELECT t.*
    from (
        SELECT t1.btch_serno,t2.cst_id
            ,t1.ctr_serno                                --合同流水号|c32
            ,t1.ori_ctr_amt                              --原合同金额|decimal(21,2)
            ,t1.new_ctr_amt                              --新合同金额|decimal(21,2)
            ,t2.ctr_amt,t2.ctr_bal
            ,t1.pst_loan_mng_opnn_src_cd                 --贷后管理意见来源代码 ,'1','客户经理意见','2','中台意见'
            ,t1.pst_loan_mng_pln_cd    --    贷后管理方案代码
            ,c1.cd_val_dscr     as pst_loan_mng_pln_nm
            ,t1.sys_reg_tm
            ,ROW_NUMBER() over(PARTITION BY t1.btch_serno ORDER BY t1.sys_reg_tm desc) rn
        from edw.dwd_bus_loan_bsn_mng_pln_dd        t1 --业务贷后管理方案
        left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
        on t1.ctr_serno=t2.ctr_serno
        and t2.dt=t1.dt
        LEFT JOIN    edw.dwd_code_library_dd     c1 --码值表
        ON  t1.pst_loan_mng_pln_cd = c1.cd_val
        AND c1.tbl_nm = upper('dwd_bus_loan_bsn_mng_pln_dd')
        AND c1.fld_nm = upper('pst_loan_mng_pln_cd')
        AND c1.DT = t1.dt
        and c1.cd_val_dscr REGEXP '预保预报|重组|诉讼|清收'     --,'13','预保预报','14','清收','15','诉讼','16','重组'
        where t1.DT = '@@{yyyyMMdd}'
    )t where t.rn=1
)t3 on t1.btch_serno=t3.btch_serno
where t1.rn_asc=1
;
2.7 审批-1

-- 审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_03 AS
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.cst_typ_cd         --客户类型代码
       ,t1.prd_no             --产品编号
       ,t1.pd_nm              --产品名称
       ,t1.hpn_typ_cd         --发生类型代码
       ,t1.apl_amt            --申请金额
       ,t1.aply_epsr_amt      --申请敞口金额
       ,t1.grnt_mod_colc_cd   --担保方式集合代码
       ,t1.apl_dt             --申请日期
       ,t1.rmk                --备注
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_org_id         --管户机构编号
       ,t1.exec_intr_rat      --执行利率
       ,t2.sam_rsk_ctrl_no    --同一风险控制号
       ,t2.csld_cr_lmt        --统一授信额度
       ,t2.csld_cr_xpos       --统一授信敞口
       ,t2.sys_reg_psn_id     --系统登记人
       ,t3.ctr_serno          --合同号
       ,t4.flow_starter       --流程发起者
       ,t4.flow_starter_name  --发起者姓名
       ,t4.start_time         --流程发起时间
       ,t4.org_id             --发起人机构id
       ,t4.biz_id             --业务流水号
       ,t11.aprv_nm           as 团队总经理
       ,t12.aprv_nm           as 审批支行行长
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join SJXQ_SJ2025042991_CST_02            t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join SJXQ_SJ2025042991_CST_01            t5 --合同基础信息
on t3.ctr_serno=t5.col_2
inner join (
    SELECT instance_id              --流程实例id|c32
        ,flow_starter               --流程发起者
        ,flow_starter_name          --发起者姓名
        ,start_time                 --流程发起时间
        ,org_id                     --发起人机构id
        ,biz_id                     --业务流水号
        ,flow_id                                  --流程id|c32
        ,flow_name                                --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='20250430'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t2.sys_reg_psn_id=t4.flow_starter
and t4.rn=1
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='20250430'
    and t1.node_nm='团队总经理'
    GROUP BY instance_id,node_nm
)t11 on t4.instance_id=t11.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='20250430'
    and t1.node_nm='支行行长'
    GROUP BY instance_id,node_nm
)t12 on t4.instance_id=t12.instance_id
where t1.dt='20250430'
;

DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_01 as
SELECT  t1.usc_aply_serno     AS 用信申请流水号
       ,t1.ahn_ltr_aply_serno AS 授用信申请流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.cst_typ_cd         AS 客户类型代码
       ,t1.prd_no             AS 产品编号
       ,t1.pd_nm              AS 产品名称
       ,t1.hpn_typ_cd         AS 发生类型代码
       ,t1.apl_amt            AS 申请金额
       ,t1.aply_epsr_amt      AS 申请敞口金额
       ,t1.grnt_mod_colc_cd   AS 担保方式集合代码
       ,t1.apl_dt             AS 申请日期
       ,t1.rmk                AS 备注
       ,t1.mgr_id             AS 管户人工号
       ,t1.mgr_org_id         AS 管户机构编号
       ,t1.exec_intr_rat      AS 执行利率
       ,t2.sam_rsk_ctrl_no    AS 同一风险控制号
       ,t2.csld_cr_lmt        AS 统一授信额度
       ,t2.csld_cr_xpos       AS 统一授信敞口
       ,t2.sys_reg_psn_id     AS 系统登记人
       ,t3.ctr_serno          AS 合同号
       ,t3.ctr_bgn_dt         AS 合同起始日期
       ,t3.ctr_mtu_dt         AS 合同到期日期
       ,t3.ctr_amt            AS 合同金额
       ,t3.ctr_bal            AS 合同余额
       ,h1.empe_nm            AS 经办人
       ,h2.pos_nm             AS 经办人职位
       ,t4.flow_starter       AS 流程发起者
       ,t4.flow_starter_name  AS 发起者姓名
       ,t4.start_time         AS 流程发起时间
       ,t4.org_id             AS 发起人机构id
       ,t4.biz_id             AS 业务流水号
       ,t5.back_cnt           AS 流程退回次数
       ,t6.empe_id            AS 最终审批人工号
       ,t6.empe_nm            AS 最终审批人姓名
       ,t6.node_nm            AS 最终审批人岗位
       ,t6.user_comment       AS 最终审批人用户评价
       ,t6.aprv_drtn          AS 最终审批人审批时长
       ,t6.cmt_tm             AS 最终审批人审批时间
       ,t7.flow_param
       ,t9.aprv_id            AS 客户经理工号
       ,t9.aprv_nm            AS 客户经理姓名
       ,t10.aprv_id           AS 团队审查岗工号
       ,t10.aprv_nm           AS 团队审查岗姓名
       ,t10.aprv_drtn_min     AS 团队审查岗审批时长_分
       ,t10.user_comment      AS 团队审查岗审批意见
       ,t10.aprv_cnt          AS 团队审查岗审批次数
       ,t10.back_cnt          AS 团队审查岗退回次数
       ,t11.aprv_id           AS 团队总经理工号
       ,t11.aprv_nm           AS 团队总经理姓名
       ,t11.aprv_drtn_min     AS 团队总经理审批时长_分
       ,t11.user_comment      AS 团队总经理审批意见
       ,t11.aprv_cnt          AS 团队总经理审批次数
       ,t11.back_cnt          AS 团队总经理退回次数
       ,t12.aprv_id           AS 审批支行行长工号
       ,t12.aprv_nm           AS 审批支行行长姓名
       ,t12.aprv_drtn_min     AS 审批支行行长审批时长_分
       ,t12.user_comment      AS 审批支行行长审批意见
       ,t12.aprv_cnt          AS 审批支行行长审批次数
       ,t12.back_cnt          AS 审批支行行长退回次数
       ,t13.aprv_id           AS 市场部审查岗工号
       ,t13.aprv_nm           AS 市场部审查岗姓名
       ,t13.aprv_drtn_min     AS 市场部审查岗审批时长_分
       ,t13.user_comment      AS 市场部审查岗审批意见
       ,t13.aprv_cnt          AS 市场部审查岗审批次数
       ,t13.back_cnt          AS 市场部审查岗退回次数
       ,t14.aprv_id           AS 市场部总经理工号
       ,t14.aprv_nm           AS 市场部总经理姓名
       ,t14.aprv_drtn_min     AS 市场部总经理审批时长_分
       ,t14.user_comment      AS 市场部总经理审批意见
       ,t14.aprv_cnt          AS 市场部总经理审批次数
       ,t14.back_cnt          AS 市场部总经理退回次数
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD    t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
and t3.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            h1 --员工信息汇总
on  t3.hdl_opr_id=h1.empe_id
and h1.dt=t1.dt
left join edw.dim_hr_org_job_inf_dd            h2 --职位信息
on  h1.pos_enc=h2.pos_id
and h2.dt=t1.dt
inner join (
    SELECT instance_id              --流程实例id|c32
        ,flow_starter               --流程发起者
        ,flow_starter_name          --发起者姓名
        ,start_time                 --流程发起时间
        ,org_id                     --发起人机构id
        ,biz_id                     --业务流水号
        ,flow_id                                  --流程id|c32
        ,flow_name                                --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='@@{yyyyMMdd}'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t2.sys_reg_psn_id=t4.flow_starter
and t4.rn=1
left join(
    select instance_id
        ,sum(case when user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd
    where dt='@@{yyyyMMdd}'
    group by instance_id
)t5 on t4.instance_id=t5.instance_id
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn                --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
left join(
    SELECT instance_id,flow_param
    from edw.loan_n_wf_instance
    where dt='@@{yyyyMMdd}'
    union
    SELECT instance_id,flow_param
    from edw.loan_n_wf_instance_his
    where dt='@@{yyyyMMdd}'
)t7 on t4.instance_id=t7.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm regexp '客户经理'
    GROUP BY instance_id,node_nm
)t9 on t4.instance_id=t9.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队审查岗'
    GROUP BY instance_id,node_nm
)t10 on t4.instance_id=t10.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队总经理'
    GROUP BY instance_id,node_nm
)t11 on t4.instance_id=t11.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='支行行长'
    GROUP BY instance_id,node_nm
)t12 on t4.instance_id=t12.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='村行市场部审查岗'
    GROUP BY instance_id,node_nm
)t13 on t4.instance_id=t13.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_id))) as aprv_id
        ,CONCAT_WS('|',COLLECT_SET(concat(t3.empe_nm))) as aprv_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,CONCAT_WS('|',COLLECT_SET(concat(t1.user_comment)))       as user_comment
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='村行市场部总经理'
    GROUP BY instance_id,node_nm
)t14 on t4.instance_id=t14.instance_id
where t1.dt='@@{yyyyMMdd}'
;

-- 合同的业务流水号
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_04 as
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_nm     AS 客户名称
       ,t1.ctr_serno  AS 合同号
       ,h1.empe_nm    AS 经办人
       ,h2.pos_nm     AS 经办人职位
       ,t3.ahn_ltr_aply_serno
       ,t4.biz_id
       ,t4.flow_id
       ,t4.flow_name  AS 流程名称
       ,t4.start_time AS 流程发起时间
       ,t4.instance_id
        ,ROW_NUMBER() over(partition by t3.ahn_ltr_aply_serno order by t4.start_time desc) rn
from SJXQ_SJ2025031471_CST_02               t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            h1 --员工信息汇总
on  t2.hdl_opr_id=h1.empe_id
and h1.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_job_inf_dd            h2 --职位信息
on  h1.pos_enc=h2.pos_id
and h2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_lmt_aply_biz_dd  t3 --用信方案
on t2.rel_serno=t3.usc_aply_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
on t3.ahn_ltr_aply_serno=t4.biz_id
and t4.dt='@@{yyyyMMdd}'

;

-- 审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_05 as
SELECT t1.*
    ,ROW_NUMBER() over(partition by t1.instance_id order by t1.start_time asc) rn_asc
from(
    SELECT t4.instance_id
            ,t5.user_id         --用户id
            ,t6.empe_nm         --审批人名称
            ,t5.node_nm         --审批节点
            ,t5.start_time        --审批时间
            ,t5.user_comment    --用户评价
            ,ROW_NUMBER() over(partition by t4.instance_id,t5.node_nm order by t5.start_time desc) rn
    from SJXQ_SJ2025031471_CST_04                   t4
    INNER JOIN edw.dwd_bus_loan_n_wf_comment_his_dd t5 --流程审批意见历史
    on  t4.instance_id=t5.instance_id
    and t5.dt='@@{yyyyMMdd}'
    left join edw.dws_hr_empe_inf_dd                t6 --员工信息汇总
    on  substr(t5.user_id,1,6)=t6.empe_id
    and t6.dt='@@{yyyyMMdd}'
    where t4.rn=1   --业务最新实例流程
)t1 where t1.rn=1   --最后审批流
;
2.8 调查走访-1

-- 客户调查记录信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025031281_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031281_CST_02 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as 调查方式 --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.cst_rol_cd               --客户角色代码|C2
    ,t1.adiv                     --行政区划|C12
    ,t1.svy_addr                 --调查地址
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c2.cd_val_dscr          as 调查地址类型
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t2.参与人岗位姓名
    ,t1.svy_ctnt_and_rslt        --调查内容及结果|C4000
    ,t1.rmk                      --备注|c4000
    ,t1.lct_nd_mid_grd_audt_ind  --定位需中台审核标志|C1
    ,t1.sys_reg_tm
    ,t3.调查对象名称
    ,t3.调查对象关系及名称
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join(
    SELECT rel_serno
        ,CONCAT_WS('|',COLLECT_SET(concat(pst_nm,':',pcp_psn_nm))) as 参与人岗位姓名
    from edw.loan_svy_rcd_rel_pcpt_inf  --调查记录关联参与人信息
    where dt='@@{yyyyMMdd}'
    and del_ind='0'
    GROUP BY rel_serno
)t2 on t1.svy_rcd_serno=t2.rel_serno
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt=t1.dt
left join(
    SELECT t1.rel_serno
        ,WM_CONCAT('|',concat(t1.svy_obj_nm))                   as 调查对象名称
        ,WM_CONCAT('|',concat(c1.cd_val_dscr,':',t1.svy_obj_nm))    as 调查对象关系及名称
    from edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd    t1
    LEFT JOIN    EDW.dwd_code_library_dd                c1
    ON      T1.with_be_svy_psn_rel_cd = C1.CD_VAL
    AND     C1.TBL_NM = upper('DWD_BUS_LOAN_SVY_RCD_REL_SVY_OBJ_INF_DD')
    AND     C1.FLD_NM = upper('with_be_svy_psn_rel_cd')
    and     c1.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and nvl(t1.svy_obj_nm,'')<>''
    GROUP BY t1.rel_serno
) t3 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t3.rel_serno --关联流水号
where t1.dt='@@{yyyyMMdd}'
;


SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as svy_mod_nm --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.cst_rol_cd               --客户角色代码|C2
    ,t1.adiv                     --行政区划|C12
    ,t1.svy_addr                 --调查地址
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c2.cd_val_dscr          as svy_addr_typ_nm
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t1.svy_ctnt_and_rslt        --调查内容及结果|C4000
    ,t1.rmk                      --备注|c4000
    ,t1.lct_nd_mid_grd_audt_ind  --定位需中台审核标志|C1
    ,t1.sys_reg_tm
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.svy_dt>='20250101'
and t1.svy_mod_cd='01' --01:现场（实地）
;

-- 合同关联调查报告编号
SELECT t1.ctr_serno,t1.REL_SERNO,t1.cst_id
    ,t2.USC_APLY_SERNO,t2.AHN_LTR_APLY_SERNO
    ,t3.SVY_RPT_NO
    ,t3.eff_ind        --生效标志|c1
    ,t3.sys_reg_psn_id --系统登记人编号|c20
    ,t3.sys_reg_org_id --系统登记机构编号|c12
    ,t3.sys_reg_tm     --系统登记时间|c20
FROM edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同基础信息
LEFT JOIN edw.dwd_bus_loan_lmt_aply_biz_dd t2 --用信方案
ON t1.REL_SERNO = t2.USC_APLY_SERNO
AND t2.dt = t1.dt
LEFT JOIN edw.dwd_bus_loan_svy_rpt_inf_dd t3 --调查报告信息
ON t3.REL_SERNO = t2.AHN_LTR_APLY_SERNO
AND t3.dt = t1.dt
WHERE t1.dt = '20250630'
2.9 保证人担保人
--保证人
DROP   TABLE IF     EXISTS SJXQ_SJ20250731131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250731131_CST_02 AS
select t1.ctr_serno
    ,t2.grnt_ctr_no                              --担保合同编号|c32
    ,nvl(t3.gtor_no,t4.OBG_ID) as 保证人编号
    ,nvl(t3.gtor_nm,t4.OBG_NM) as 保证人名称
from SJXQ_SJ20250731131_CST_01                  t1
inner join edw.dwd_bus_loan_ctr_rel_grnt_dd     t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20250731'
left JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='20250731'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20250731'
) t4 on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
;

-- 担保人汇总信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_04 as
SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    ,concat_ws('|',collect_set(t1.wrnt_cst_id))                                   AS wrnt_cst_id  --保证人客户编号|C20
    ,concat_ws('|',collect_set(concat(t1.grnt_psn_seq_nbr,'-',t1.wrnt_cst_nm)))   AS wrnt_cst_nm  --保证人客户名称|C200
    ,concat_ws('|',collect_set(concat(t1.grnt_psn_seq_nbr,'-',t1.wrnt_doc_nbr)))  AS wrnt_doc_nbr --保证人证件号码|C60
    ,concat_ws('|',collect_set(concat(t1.grnt_psn_seq_nbr,'-',t3.mbl_nbr)))       AS mbl_nbr      --保证人手机号
from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
inner join SJXQ_SJ20241112121_CST_01        t2
on t1.bus_ctr_id=t2.ctr_serno
left join edw.dws_cst_idv_bas_inf_dd        t3 --个人客户基本信息汇总表
on t1.wrnt_cst_id=t3.cst_id
and t3.dt='20240930'
where t1.dt='20240930'
group by t1.bus_ctr_id
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_03 AS
SElECT distinct t1.cst_id
    ,t2.wrnt_cst_id         --保证人客户编号
    -- ,t2.wrnt_cst_nm         --保证人客户名称
    -- ,t2.grnt_psn_seq_nbr    --担保人序号
    -- ,concat_ws('|',collect_set(concat(t2.wrnt_cst_id,t2.wrnt_cst_nm))) as wrnt_cst_nms
from SJXQ_SJ2024112701_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.ctr_serno=t2.bus_ctr_id           --业务合同编号
and t2.dt = '@@{yyyyMMdd}'
2.10 地址
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_02 AS
SELECT  t1.cst_id
       ,t2.dtl_addr        AS 信贷经营地址
       ,t3.dtl_addr        AS 信贷户籍地址
       ,t4.dtl_addr        AS 信贷居住地址
       ,t5.dtl_addr        AS 信贷办公地址
       ,t6.dtl_addr        AS 信贷注册地址
       ,t7.dtl_addr        AS 信贷主地址
       ,c1.cd_val_dscr     AS 信贷主地址类型
from(
    select distinct cst_id
    from edw.loan_cst_ctc_addr
    where dt = '@@{yyyyMMdd}'
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '@@{yyyyMMdd}' and t2.del_ind='0'     --未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '@@{yyyyMMdd}' and t3.del_ind='0'     --未删除
AND t3.addr_typ = '050100' --户籍地址
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '@@{yyyyMMdd}' and t4.del_ind='0'     --未删除
AND t4.addr_typ = '050200' --家庭地址
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}' and t5.del_ind='0'     --未删除
AND t5.addr_typ = '050400' --办公地址
LEFT JOIN edw.loan_cst_ctc_addr t6
ON t1.cst_id = t6.cst_id and t6.del_ind='0'     --未删除
AND t6.dt = '@@{yyyyMMdd}'
AND t6.addr_typ = '050800' --注册地址
LEFT JOIN edw.loan_cst_ctc_addr t7
ON t1.cst_id = t7.cst_id and t7.del_ind='0'     --未删除
AND t7.dt = '@@{yyyyMMdd}'
AND t7.main_addr_ind = '1' --主地址
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t7.addr_typ=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
AND C1.TBL_NM=UPPER('DWD_BUS_LOAN_SVY_CST_OPR_PLC_DD')
AND C1.FLD_NM=UPPER('ADDR_TYP_CD')
;

SELECT  t1.cst_id
    ,c1.cd_val_dscr as 经营地址行政区划
    ,c2.cd_val_dscr as 户籍地址行政区划
    -- ,t4.pvc_lvl_id_cd    as     户籍省级编号代码
    -- ,t4.cty_lvl_id_cd    as     户籍市级编号代码
    -- ,t4.cnr_lvl_id_cd    as     户籍县级编号代码
    -- ,t5.pvc_lvl_id_cd    as     经营省级编号代码
    -- ,t5.cty_lvl_id_cd    as     经营市级编号代码
    -- ,t5.cnr_lvl_id_cd    as     经营县级编号代码
from(
    select distinct col_7 as cst_id
    from SJXQ_SJ2025042991_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250430' and t2.del_ind='0'     --未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250430' and t3.del_ind='0'     --未删除
AND t3.addr_typ = '050100' --户籍地址
-- left  join edw.dim_cst_bas_phy_adr_inf_dd   t4   --客户物理地址信息
-- on   t1.cst_id = t4.cst_id
-- and  t4.dt = '20250430'
-- and  t4.phy_adr_typ_cd = '050100'   --户籍地址
-- left  join edw.dim_cst_bas_phy_adr_inf_dd   t5   --客户物理地址信息
-- on   t1.cst_id = t5.cst_id
-- and  t5.dt = '20250430'
-- and  t5.phy_adr_typ_cd = '050900'    --经营所在地地址
left join   edw.dwd_code_library_dd   c1 -- 码值表
ON      substr(t2.adiv,1,6) = c1.cd_val
AND     c1.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND     c1.fld_nm = 'AREA_OR_CNR_DTRCT_DVD_CD'     --区县
AND     c1.dt = '20250430'
left join   edw.dwd_code_library_dd   c2 -- 码值表
ON      substr(t3.adiv,1,6) = c2.cd_val
AND     c2.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND     c2.fld_nm = 'AREA_OR_CNR_DTRCT_DVD_CD'     --区县
AND     c2.dt = '20250430'
;
2.11 综合评价
2.12 管户交接
--是否有发生过交接，判断count > 0
SELECT  b.cst_id
       ,COUNT(1)
FROM edw.loan_cst_mgr_hdv_aply a
INNER JOIN edw.loan_cst_mgr_hdv_cst b
ON a.APLY_SERNO = b.APLY_SERNO
AND b.dt = '20241231'
AND b.del_ind = '0'
AND substr(replace(b.sys_reg_tm, '-', ''), 1, 8) >= '20240101' --近1年
WHERE a.dt = '20241231'
GROUP BY  b.cst_id
HAVING COUNT(1) > 0

-- 信贷客户交接明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250605136_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250605136_CST_01 AS
SELECT a.cst_id
    ,a.bfr_hdv_cst_magr_id    --移交前客户经理工号
    ,t1.empe_nm     as 移交前客户经理
    ,a.bfr_hdv_mgr_org_no    --移交前管户机构编号
    ,t5.org_nm      as 移交前管户机构
    ,a.aft_hdv_cst_magr_id    --移交后客户经理工号
    ,t2.empe_nm     as 移交后客户经理
    ,a.aft_hdv_mgr_org_no    --移交后管户机构编号
    ,t4.org_nm      as 移交后管户机构
    ,a.sys_reg_psn            --系统登记人
    ,t3.empe_nm     as 系统登记人
    ,substr(REPLACE(a.sys_reg_tm, '-', ''),1,8) as HDV_DT   --交接日期
    ,t4.brc_org_nm
FROM    edw.loan_cst_mgr_hdv_rcd AS a  --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
inner join (
    select distinct  cst_id
    from EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD  t1
    where dt= '20250630'
    and  ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )    OR nvl(t1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
    AND     t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) --剔除信用卡
)ctr on a.cst_id=ctr.cst_id
left join edw.dws_hr_empe_inf_dd    t1 --员工汇总信息
on a.bfr_hdv_cst_magr_id=t1.empe_id
and t1.dt=a.dt
left join edw.dws_hr_empe_inf_dd    t2 --员工汇总信息
on a.aft_hdv_cst_magr_id=t2.empe_id
and t2.dt=a.dt
left join edw.dws_hr_empe_inf_dd    t3 --员工汇总信息
on a.sys_reg_psn=t3.empe_id
and t3.dt=a.dt
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd AS t4 --机构树_考核维度
ON  a.aft_hdv_mgr_org_no = t4.org_id
AND t4.dt = a.dt
and t4.brc_org_nm regexp '汝南'
left JOIN    edw.dim_hr_org_mng_org_tree_dd AS t5 --机构树_考核维度
ON  a.bfr_hdv_mgr_org_no = t5.org_id
AND t5.dt = a.dt
WHERE a.dt = '20250630'
and a.del_ind='0'    --    删除标识
AND REPLACE(a.sys_reg_tm, '-', '') >= '20250101'
AND REPLACE(a.sys_reg_tm, '-', '') <= '20250630'
AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
AND a.hdv_typ = '1'
and a.bfr_hdv_cst_magr_id<>a.aft_hdv_cst_magr_id
and substr(a.bfr_hdv_cst_magr_id,1,1) in ('0','1','2','3','4','5','6','7','8','9') --剔除首次从虚拟管户到实际管户人场景
and substr(a.aft_hdv_cst_magr_id,1,1) in ('0','1','2','3','4','5','6','7','8','9') --剔除首次从虚拟管户到实际管户人场景
;
3. 社区
    ,t6.cprh_cmnt_id    as    综合社区编号
    ,t6.cprh_cmnt_plt_id    as    综合社区板块编号
    ,t6.sub_cmnt_id    as    普惠子社区编号
    ,t7.cmnt_nm               as 普惠子社区名称
    ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND t2.empe_id REGEXP T10.EMPLOY_NO THEN '是'    --客户管护人是否是子社区的定人之一
            when nvl(T6.SUB_CMNT_ID,'')='' then ''
            ELSE '否' END AS 更新人是否为子社区定人
    ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND t2.empe_id = T8.EMPLOY_NO THEN '是'          --子社区主维护人是否等于客户管护人
            when nvl(T6.SUB_CMNT_ID,'')='' then ''
            ELSE '否' END AS 更新人是否为子社区主维护人
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.col_1 = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
LEFT JOIN    edw.XWDT_ETL_XW_COMMUNITY_PER T8 --普惠社区定人信息表
ON      t6.SUB_CMNT_ID = T8.COMMUNITY_CODE --社区编号
AND     T8.IS_MAIN_PERSON = '1' --主维护人
AND     T8.DT = t6.dt
LEFT JOIN
(
    SELECT  COMMUNITY_CODE
           ,WM_CONCAT('|',EMPLOY_NO) AS EMPLOY_NO --一个社区会有多个定人
    FROM edw.XWDT_ETL_XW_COMMUNITY_PER --普惠社区定人信息表
    WHERE dt = '@@{yyyyMMdd}'
    AND IS_MAIN_PERSON = '2' ---- 1主维护人，2社区定人
    GROUP BY  COMMUNITY_CODE
) T10
ON T6.SUB_CMNT_ID = T10.COMMUNITY_CODE --社区编号

select cst_id                                 --客户号|C20
    ,cprh_cmnt_id                             --综合社区编号|C32
    ,cprh_cmnt_plt_id                         --综合社区版块编号|C32
    ,sub_cmnt_id                              --子社区编号|C32
    ,opr_sts_cd                               --操作状态代码|C1
    ,decode(opr_sts_cd,'0','正常' ,'1','转出转移中' ,'2','转出成功' ,'3','转移成功' ,'4','转移转出拒绝','') as opr_sts_nm
    ,dpd_tm                                   --挂靠时间|C20
    ,dpd_sts_cd                               --挂靠状态代码|C1
    ,dpd_typ_cd                               --挂靠类型代码|C1
    ,decode(dpd_typ_cd,'1','普惠','2','小企业','') as dpd_typ_nm
    ,sub_cmnt_nm                              --子社区名称|C900
    ,sub_cmnt_typ_cd                          --子社区类型代码|C96
    ,decode(sub_cmnt_typ_cd, '01', '综合社区', '02', '综合社区版块', '03', '子社区','04','社区单元','05','虚拟子社区') AS sub_cmnt_typ_nm
from edw.dwd_cst_mng_cmnt_rel_dd              --客户社区信息
where dt='@@{yyyyMMdd}'
;

select cust_no                                --客户号
    ,decode(attach_flag,'0','手动','1','自动','') as 挂靠方式
from edw.xwdt_xw_cust_com                     -- 客户与社区关联表
where dt='@@{yyyyMMdd}'
;
4. 外部数据
1. 外部工商数据
-- 外部工商状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025081311_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025081311_CST_03 AS
SELECT  t1.company_id     --主体唯一键
    ,t1.company_name   --企业名称
    ,t1.company_status --登记状态
    ,t1.legal_person                             --法定代表人
    ,t1.company_address                          --地址
    ,t1.business_scope                           --经营范围
    ,t1.cancel_date    --注销日期
    ,t1.revoke_date    --吊销日期
    ,t3.lctax_cert_no
    ,t3.cst_id         --客户号|C20
    ,t3.cst_nm         --客户名称|C200
    ,t4.n_company_status
from edw.nout_company_base              t1 --企业基本信息表
inner join edw.dim_cst_entp_bas_inf_dd    t3 --企业客户基本信息
on t1.credit_no=t3.lctax_cert_no    --地税证件号
and t3.dt=t1.dt
inner JOIN edw.nout_company_base_clean  t4
on t1.company_id=t4.company_id
and t4.dt=t1.dt
and t4.use_flag<>'10'  --10废弃数据
-- and t4.n_company_status regexp '吊销|注销|迁入|迁出|停业|清算'
where t1.dt='20250816'
and nvl(t1.credit_no,'')<>''
;
5. 信用卡
left join(
    SELECT distinct cst_id,usc_aply_serno
        ,acs_org_id,frs_mgr_id,frs_mgr_nm
    from edw.dwd_bus_crd_cr_crd_mgr_inf_dd
    where dt='@@{yyyyMMdd}'
) t6 --信用卡管护信息
on t1.rel_serno=t6.usc_aply_serno
and t1.cst_id=t6.cst_id
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  coalesce(t3.mgr_org_id,t6.acs_org_id) = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
SELECT  cr_crd_card_nbr AS 信用卡卡号
        ,card_sts_cd    AS 卡片状态代码
        ,c1.cd_val_dscr AS 卡片状态
        ,card_sts_dt    AS 卡片状态日期
        ,cst_id         AS 客户编号
        ,cst_nm         AS 客户名称
        ,isu_dt         AS 发卡日期
        ,rsnd_dt        AS 重发卡日期
        ,card_actv_dt   AS 卡片激活日期
        ,late_trx_dt    AS 最后交易日期
        ,cr_crd_act_id  AS 信用卡账号
        ,late_card_ind  AS 最新卡标志
from edw.dws_bus_crd_cr_crd_inf_dd      t1      --信用卡卡片信息汇总
left join EDW.DWD_CODE_LIBRARY_DD       c1
on t1.card_sts_cd=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
AND C1.TBL_NM=UPPER('dws_bus_crd_cr_crd_inf_dd')
AND C1.FLD_NM=UPPER('card_sts_cd')
where t1.dt='@@{yyyyMMdd}'
and t1.cr_crd_card_nbr='6222878805982103'
;

-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025061936_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061936_CST_03 AS
select t1.cr_crd_act_id                            --信用卡账号|C32
    ,t1.cr_crd_card_nbr                          --信用卡卡号|C32
    ,t1.trx_dt                                   --交易日期|C8
    ,t1.trx_tm                                   --交易时间|C32
    ,t1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,t1.trx_typ_cd                               --交易类型代码|C32
    ,t1.trx_typ_dscr                             --交易类型描述|C32
    ,t1.act_dt                                   --入帐日期|C8
    ,t1.mon_id                                   --月份编号|C32
    ,t1.trx_ind                                  --交易标志|C10
    ,t1.rtn_gds_trx_id                           --退货交易标识|C32
    ,t1.trx_dscr_1                               --交易描述1|C64
    ,t1.trx_dscr_2                               --交易描述2|C64
    ,t1.wdw_rvs_ind                              --撤销冲正标志|C1
    ,t1.trx_hpn_dt                               --交易发生日期|C8
    ,t1.actl_trx_tm                              --实际交易时间|C8
    ,case when t1.trx_dscr_1 regexp '财付通|微信' THEN '微信'
        when t1.trx_dscr_1 regexp '支付宝' THEN '支付宝'
        when t1.trx_dscr_1 regexp '云闪付' THEN '云闪付'
        when t1.trx_dscr_1 regexp '抖音' THEN '抖音' when t1.trx_dscr_1 regexp '拼多多' THEN '拼多多'
        when t1.trx_dscr_1 regexp '京东' THEN '京东' when t1.trx_typ_dscr regexp 'ATM' then 'ATM'
        when t1.trx_dscr_1 regexp '美团' THEN '美团' when t1.trx_typ_dscr regexp 'POS消费' then t1.trx_typ_dscr
        else '' end as platform
from edw.dwd_bus_crd_cr_crd_trx_dtl_di  t1        --信用卡客户交易流水
inner join SJXQ_SJ2025061936_CST_02     t2
on t1.cr_crd_card_nbr=t2.cr_crd_card_nbr
WHERE t1.dt <= '20250622'
AND t1.dt > '20250322'
AND substr(t1.trx_typ_cd, 1, 1) IN ('1', '2') --1消费类 2取现类 7还款类
AND t1.trx_typ_cd <> '1050'  --筛选交易类型为消费
AND t1.wdw_rvs_ind <> '1'
;

select t1.cst_id                                   --客户号|C20
    ,t1.cr_crd_act_id                            --信用卡账号|C32
    ,t1.cr_crd_card_nbr                          --信用卡卡号|C32
    ,t1.srl_nbr                                     --流水号
    ,t1.trx_typ_cd                               --交易类型代码|C32
    ,t1.trx_typ_dscr                             --交易类型描述|C32
    ,t1.trx_ccy_cd                               --交易币种代码|C3
    ,c1.cd_val_dscr     as trx_ccy_nm
    ,t1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,t1.mch_typ_cd                               --商户类型代码|C32
    ,t1.mch_cd                                   --商户代码|C32
    ,t1.trx_dt                                   --交易日期|C8
    ,t1.trx_tm                                   --交易时间|C32
    ,t1.act_dt                                   --入帐日期|C8
    ,t1.trx_hpn_dt                               --交易发生日期|C8
    ,t1.actl_trx_tm                              --实际交易时间|C8
    ,t1.cnt_pty_act_id                           --对方账号|C100
    ,t1.cnt_pty_act_nm                           --对方户名|C200
    ,t1.trx_dscr_1                               --交易描述1|C64
    ,t1.trx_dscr_2                               --交易描述2|C6
    ,t1.acq_mch_enc                              --收单商户编码|C15
    ,t1.acq_org_id                               --收单机构码|N11
    ,t1.mch_seq_nbr                              --商户序号|N6
    ,t1.act_bal                                  --账户余额|DECIMAL(20,2)
    ,t1.ip                                       --IP
    ,t1.mac                                      --MAC
from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di t1 --信用卡交易宽表
left join edw.dwd_code_library_dd                 c1
on  t1.trx_ccy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
and c1.tbl_nm=upper('DWD_BUS_CRD_CR_CRD_TRX_DTL_DI')
and c1.fld_nm=upper('trx_ccy_cd')
WHERE t1.dt between '20140101' and '20151231'
AND t1.cr_crd_card_nbr = '6227171606541103'
;
9. 个人客户
10. 企业客户
11. 账户
1. 止付、冻结、关闭非柜面
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ2025062656_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062656_CST_01 AS
SELECT  t1.cst_act_id
       ,t1.frz_dt     AS 止付日期
       ,t1.frz_rsn    AS 止付原因
       ,t1.frz_bgn_dt AS 止付起始日期
       ,t1.frz_tmn_dt AS 止付终止日期
       ,t1.止付种类
from(
    select t1.cst_act_id                               --客户账号
        ,t1.frz_opr_cd                               --冻结操作代码
        ,t1.frz_scp_cd                               --冻结范围代码
        ,c3.cd_val_dscr     as 止付范围
        ,t1.frz_src_cd                               --冻结来源代码
        ,t1.frz_cls_cd                               --冻结种类代码
        ,t1.c1.cd_val_dscr  as 止付种类
        ,t1.frz_dt                                   --冻结日期
        ,t1.frz_tm                                   --冻结时间
        ,t1.frz_bgn_dt                               --冻结起始日期
        ,t1.frz_tmn_dt                               --冻结终止日期
        ,t1.frz_rsn                                  --冻结原因
        ,t1.trx_org_id                               --交易机构编号
        ,t1.act_stop_pmt_typ_cd                      --账户止付类型
        ,c2.cd_val_dscr     as 止付类型
        ,ROW_NUMBER() over (partition by t1.cst_act_id order by t1.frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.dt
    left join edw.dwd_code_library_dd   c2
    on t1.frz_cls_cd = c2.cd_val
    and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
    and c2.dt=t1.dt
    left join edw.dwd_code_library_dd   c3
    on t1.frz_scp_cd = c3.cd_val
    and c3.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c3.fld_nm=upper('frz_scp_cd')
    and c3.dt=t1.dt
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='2'   --止付
    AND     t1.NFRZ_IND = '0'   --解冻标志 0否|1是 未解冻
)t1 where t1.rn=1
;

--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_02 AS
select cst_act_id,frz_dt,frz_rsn
    ,frz_cls_cd,frz_cls
from(
    SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
        ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.dt
    WHERE   T1.DT = '@@{yyyyMMdd}'
    AND     T1.FRZ_SRC_CD='1'   --冻结
    AND     T1.NFRZ_IND = '0'   --未解冻 0否|1是
)t1 where t1.rn=1
;

--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_03 AS
select cst_act_id,lmt_eft_dt,close_fg_rsn
from(
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '@@{yyyyMMdd}'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t1 where t1.rn=1
;

--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_04 AS
SELECT  cengcgjz      AS cst_act_id
       ,MAX(danciedu) AS fg_per_lmt
       ,MAX(leijiedu) AS fg_day_lmt
FROM edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE dt = '20250720'
AND zhxeleix = '2'
AND shijbhao = 'FGMXIANE' -- 非柜面限额
AND edkzzhqi = '1D'
GROUP BY cengcgjz
;
    ,CASE WHEN T8.cst_act_id IS NULL     THEN '否'
           WHEN T8.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,T8.fg_per_lmt                      AS 非柜单笔限额
    ,T8.fg_day_lmt                      AS 非柜日累计限额
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
left join SJXQ_SJ2024011296_CST_01 t5 --止付
on t3.cst_act_id=t5.cst_act_id
left join SJXQ_SJ2024011296_CST_02 t6 --冻结
on t3.cst_act_id=t6.cst_act_id
left join SJXQ_SJ2024011296_CST_03 t7 --关闭非柜面
on t3.cst_act_id=t7.cst_act_id
left join SJXQ_SJ2024011296_CST_04 t8 --非柜面限额
on t3.cst_act_id=t8.cst_act_id
WHERE T1.DT = '@@{yyyyMMdd}'
;
2. 账户交易
-- 交易维度
-- 1. 存款账户余额发生明细 edw.dwd_bus_dep_bal_chg_dtl_di
-- 2023年度 柜面现金业务
DROP   TABLE IF     EXISTS SJXQ_SJ20241114_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241114_CST_07 AS
SELECT t1.dep_act_id,t1.cst_act_id,t1.trx_dt
    ,t1.trx_amt --  柜面现金交易金额
    ,t1.crd_and_dbt_ind --存入 'D' 支取
    ,t1.txt_code
    ,t1.smr_dscr
    ,t2.cst_id    --客户号|C20
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   t2 --存款账户信息汇总
on t1.dep_act_id=t2.dep_act_id
and t1.cst_act_id=t2.cst_act_id
and t2.dt='@@{yyyyMMdd}'
where t1.dt>='20230101' and t1.dt<='@@{yyyyMMdd}'
and t1.trx_chnl_cd='A01' --交易渠道柜面
and t1.csh_ind='0' --0:现金;1:转账
and t1.TXT_CODE <> 'DP2137'  --无卡
and t1.bal_fld_nm = 'DPLDGBAL' --动账
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025explore_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025explore_CST_01 AS
select t2.cst_id
    ,t1.dep_act_id                               --存款账号|C32
    ,t1.dtl_seq_nbr                              --明细序号|INTEGER
    ,t1.trx_dt                                   --交易日期|C8
    ,t1.trx_tm                                   --交易时间|C9
    ,t1.crd_and_dbt_ind                          --借贷标志 C:贷 D:借
    ,t1.trx_ccy_cd                               --交易币种代码|C3
    ,t1.trx_amt                                  --交易金额
    ,t1.act_bal                                  --账户余额
    ,t1.cst_act_id                               --客户账号|C32
    ,t1.trx_chnl_cd                              --交易渠道代码 A01:柜面 C01:ATM H14:数字人民币系统
    ,t1.csh_ind                                  --现转标志  0:现金|1:转账
    ,t1.cnt_pty_cst_act_id                       --对方客户账号|C32
    ,t1.cnt_pty_act_nm                           --对方户名|c200
    ,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
    ,t1.cnt_pty_fin_instt_cd                     --对方金融机构代码|C12
    ,t1.tlr_srl_nbr                              --柜员流水号|C32
    ,t1.trx_bus_org                              --交易营业机构|C12
    ,t1.opn_org                                  --开户机构|C12
    ,t1.opr_tlr                                  --操作柜员|C10
    ,t1.cmt                                      --备注|C200
    ,t1.act_nm                                   --账户名称|C200
    ,t1.prod_id                                  --产品编号|C24
    ,t1.cst_act_typ_cd                           --客户账户类型代码|C1
    ,t1.bal_fld_nm                               --余额字段名称 DPLDGBAL --动账
    ,t1.txt_code                                 --摘要代码|C10
    ,t1.smr_dscr
    ,case when t1.txt_code='IB9999' then t1.txt_code else t1.smr_dscr end as smr_dscr --摘要描述|C512
    ,case WHEN T1.CSH_IND = '1' AND T1.CRD_AND_DBT_IND = 'C' THEN '转入'
        WHEN T1.CSH_IND = '1' AND T1.CRD_AND_DBT_IND = 'D' THEN '转出'
        WHEN T1.CSH_IND = '0' AND T1.CRD_AND_DBT_IND = 'C' THEN '存现'
        WHEN T1.CSH_IND = '0' AND T1.CRD_AND_DBT_IND = 'D' THEN '取现' else ''
         END    as   trx_type1
    ,case when t4.cst_id like '0%' then 1 else 0 end as is_sam_industry  --同业客户
    ,case when nvl(t2.cst_id,'')<>'' and t2.cst_id=t3.cst_id then 1 else 0 end as is_sam_nm --'同名转账'
    ,case WHEN (
        (t1.txt_code IN ('LN0002', '546') or ((t1.smr_dscr LIKE '%贷款发放%' AND t1.txt_code IS NULL) AND t1.crd_and_dbt_ind = 'C'))
        OR (t1.txt_code LIKE 'B49' AND t1.smr_dscr LIKE '%转贷%' AND t1.cnt_pty_act_nm NOT LIKE '%利息%')) then 1 else 0 end as is_loan_ff --贷款发放
    , CASE
        WHEN t1.txt_code in('01', 'BA0001', 'CG0002', 'CG0018', 'CG0019', 'CG0027', 'DC0033', 'DC0037', 'DE0001', 'DP0202'
        , 'DP0208', 'DP0209', 'DP0228', 'DP2105', 'DPW031', 'DPW040', 'DPW085', 'DPWT34', 'FX0632', 'FX0633', 'GJ0001'
        , 'LCPS01', 'SGZ001', 'SJZZ01', 'TY0013', 'TY0049', 'TY1917', 'TYMD03', 'TYN001', 'XE0001' , 'YL0021', 'YL0033'
        , 'YL0040', 'YL0042') or t1.smr_dscr in('新柜面系统', '认购开户') THEN '行外转入'
        WHEN t1.txt_code IN ('B00632', 'DP2129', 'FD0005', 'IB0040', 'IB0042', 'IB0043', 'IB0044', 'IB0045', 'LC0002', 'LC0009'
        , 'LC0010', 'LN1033', 'TA0005', 'TA0632', 'TY0066', 'TY0067', 'TY0068', 'TY0069', 'TY0089', 'TY0141', 'TY5055', 'ZHB002') THEN '开放式理财赎回'
        WHEN t1.txt_code = 'LC0003' or t1.smr_dscr in('理财到期利息转回活期', '理财到期本金转回活期') THEN '封闭式理财到期'
        WHEN t1.txt_code IN ('AT0002', 'AT0003', 'BA0004', 'CGTH01', 'DP0204', 'DP0212', 'DP0217', 'DP0232', 'DP0235'
        , 'DP0243', 'DP0251', 'DP0622', 'DP0628', 'DP0700', 'DP1000', 'DP2019', 'DP2020', 'DP2022', 'DP2126', 'DPW040', 'DPW289'
        , 'FD0003', 'FD0004', 'FD0011', 'FD0013', 'IB9999', 'LC0005', 'LC0006', 'LN0002', 'SGZ001', 'ST0001', 'THS009'
        , 'TY0011', 'TY5020', 'XE0003', 'XE0026', 'XETH01', 'YL0001', 'YL0015') THEN '行内资金'
        WHEN T1.TXT_CODE IN ( 'DC0068' , 'DC0069' , 'DC0070' , 'DC0071' , 'DC0072' , 'DC0073' , 'DC0074' , 'DC0075' , 'DC0076'
        , 'DC0077' , 'DC0078' , 'DC0079' , 'DC0080' , 'DC0081' , 'NS0001' , 'NS0002' , 'ZF0046' , 'DC0107' , 'DC0109' , 'YL0011'
        , 'YL0012' , 'YL0013' , 'YL0014' , 'ZF0001' , 'ZF0002' , 'ZF0003' , 'ZF0004' , 'ZF0005' , 'ZF0006' , 'ZF0007' , 'ZF0008'
        , 'ZF0009' , 'ZF0010' , 'ZF0011' , 'KJ0001' , 'KJ0002' , 'KJ0003' , 'KJ0010' , 'WG0001' , 'NSDC01' , 'NSDC02' , 'NSDC04'
        , 'NSDC05' , 'WWB010' , 'WWB011' , 'WWB012' , 'YL1003' , 'YL1006' , 'YL1012' , 'YL1013' , 'IB0023' , 'IB0024' , 'THS001'
        , 'THS002' , 'XF0001' , 'XF0002' , 'XF0003' , 'XF0004' , 'YL0403' , 'YL0504' , 'THS004' , 'THS005' , 'THS007' , 'THS008'
        , 'TY1919' , 'TY1921' ) THEN '消费'
        WHEN T1.TXT_CODE IN ( 'IB0047' , 'TY0021' , 'IB0007' , 'IB0008' , 'IB0009' , 'IB0010' , 'IB0011' , 'IB0012' , 'IB0013'
        , 'IB0014' , 'IB0015' , 'IB0016' , 'IB0017' , 'IB0018' , 'IB0019' , 'IB0020' , 'DPW035' , 'DPW036' , 'DPW037' , 'DPW038'
        , 'DPW039' , 'DPW040' , 'DPW041' , 'DPW042' , 'TY0145' , 'TY0146' , 'DFGZ01' , 'SGZ001' , 'WZGZ01' , 'DFGZ02' , 'NBGZ01' ) THEN '代发'
        WHEN T1.TXT_CODE IN ( 'IB0048' , 'IB0049' , 'IB0050' , 'IB0053' , 'IB0052' , 'IB0054' ) THEN '代扣'
        WHEN T1.TXT_CODE IN ( 'TY0136' , 'TY0137' ) THEN '代缴'
        WHEN T1.TXT_CODE IN ( 'DP0210' , 'GL0002' , 'GL0621' , 'IB0034' , 'TY1915' ) THEN '结息'
        WHEN T1.TXT_CODE IN ( 'TY0023' , 'TY0024' , 'TY0025' , 'TY0026' , 'TY0061' , 'TY0062' , 'TY0063' , 'TY0064' , 'TY0090'
        , 'C201' , 'TY0081' , 'TY0082' , 'LCPS01', 'TY0168' , 'TY0148' , 'TY1790' , 'TY1792' ) THEN '投资理财' else '' end trx_type2
    ,t4.cst_typ_cd
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
left JOIN edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
ON t1.cst_act_id = t2.cst_act_id
AND t2.dt = '@@{yyyyMMdd}'
left JOIN edw.dim_bus_dep_cst_act_inf_dd    t3
ON t1.cnt_pty_cst_act_id = t3.cst_act_id
AND t3.DT = '@@{yyyyMMdd}'
inner JOIN edw.dws_cst_bas_inf_dd            t4 --客户基础信息汇总
ON t2.cst_id = t4.cst_id
AND t4.dt = '@@{yyyyMMdd}'
where t1.dt>='20250101'
AND t1.dt <= '@@{yyyyMMdd}'
;

DROP   TABLE IF     EXISTS SJXQ_SJ2025explore_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025explore_CST_02 AS
SELECT  txt_code --摘要代码|C10
       ,smr_dscr --摘要描述|C512
       ,trx_type1
       ,is_sam_industry --同业客户
       ,is_sam_nm --同名转账
       ,is_loan_ff --贷款发放
       ,trx_type2
       ,cst_typ_cd
       ,COUNT(1)     AS trx_cnt
       ,SUM(trx_amt) AS trx_amt
FROM SJXQ_SJ2025explore_CST_01
GROUP BY  txt_code,smr_dscr,trx_type1,is_sam_industry
    ,is_sam_nm,is_loan_ff,trx_type2,cst_typ_cd;

SElECT '01' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025explore_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct txt_code) custs
from SJXQ_SJ2025explore_CST_02
;
/*
01    181053817    181053817
02    860    351
*/

SElECT '02' seq, *
from SJXQ_SJ2025explore_CST_02
;
SElECT *
from SJXQ_SJ2025explore_CST_01
;
12. 财富
1. 存款
DROP   TABLE IF     EXISTS SJXQ_SJ2024123116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024123116_CST_02 AS
SElECT T1.dep_act_id,T1.cst_act_id,T1.cst_id,T1.ACT_NM
    ,T1.OPN_DT,T1.INT_VAL_DT,T1.MTU_DT
    ,cur_act_bal,gl_bal
    ,C1.cd_val_dscr PROD_NM
    ,T1.act_sts_cd
    ,decode(T1.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结'
        ,'F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
    ,t1.ACT_CTG_CD_2
    ,decode(t1.ACT_CTG_CD_2,'301','I类户','302','II类户','303','III类户') act_typ
from edw.dws_bus_dep_act_inf_dd     T1  --存款账户信息汇总 dep_act_id
INNER JOIN EDW.DWD_CODE_LIBRARY_DD  C1
ON T1.prod_id=C1.CD_VAL
AND C1.DT='@@{yyyyMMdd}'
AND C1.TBL_NM='DIM_BUS_DEP_ACT_INF_DD'
AND C1.FLD_NM='PROD_ID'
and c1.cd_val_dscr REGEXP '成长|长寿|泰隆一本'
where T1.dt = '@@{yyyyMMdd}'
AND T1.OPN_DT between '20171120' AND '@@{yyyyMMdd}'     --开户日期
--ACT_STS_CD <> 'C' and STL_ACT_IND = '1' --非销户且为结算账户 cst_act_id 99%近似唯一
--ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' )    --账户状态正常（不确定）
--ACT_CTG_CD_2 in ('301','302','303')  -- I、II、III类账户
;
2. 理财
dwd_bus_chm_trx_cfm_dtl_di
-- 截至2023年底 自营/代销 理财业务交易量
DROP   TABLE IF     EXISTS SJXQ_SJ20241114_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241114_CST_03 AS
SELECT CST_ID
    ,TRX_DT
    ,TRX_TM
    ,CFM_DT --确认日期
    ,TRX_AMT --交易金额
    ,CFM_AMT --确认金额
    ,trx_cd
    ,BUS_CD     --,'120','认购' ,'122','申购' ,'130','认购' ,'134','非交易过户转入' ,'139','定时定额'
    ,TRX_STS_CD
    ,CASE WHEN TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
FROM EDW.dwd_bus_chm_trx_cfm_dtl_di         T1  --理财交易确认流水明细
where dt<='@@{yyyyMMdd}'
AND TRX_STS_CD IN ('6','7', '8','S' )  -- '6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功'
and CFM_AMT>0    --确认金额
and trx_cd ='100200'    --100200购买,100202 赎回
union all
SELECT CST_ID
    ,TRX_DT
    ,TRX_TM
    ,CFM_DT  --确认日期
    ,TRX_AMT --交易金额
    ,CFM_AMT --确认金额
    ,trx_cd
    ,BUS_CD   --,'142','强行赎回' ,'125','预约赎回' ,'124','赎回'
    ,TRX_STS_CD
    ,CASE WHEN TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
FROM EDW.dwd_bus_chm_trx_cfm_dtl_di         T1  --理财交易确认流水明细
where dt<='@@{yyyyMMdd}'
and trx_cd = '100202'  --100200购买,100202 赎回
;

select pd_cd                                    --产品代码|C24
    ,pd_nm                                    --产品名称|C256
    ,pd_val_dt
    ,pd_found_dt                              --产品成立日期|C8
    ,pd_end_dt                                --产品结束日期|C8
    ,actl_found_dt                            --实际成立日期|C8
    ,DATEDIFF(TO_DATE(pd_end_dt,'yyyyMMdd'),TO_DATE(pd_val_dt,'yyyyMMdd'),'dd') as trm_days
    ,round(DATEDIFF(TO_DATE(pd_end_dt,'yyyyMMdd'),TO_DATE(pd_val_dt,'yyyyMMdd'),'dd')/365,0) as y_trm
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='@@{yyyyMMdd}'
and (pd_nm REGEXP '挂钩型' or (ta_cd <> 'TL' and pd_nm REGEXP '钱潮'))  --挂钩型理财新口径
and pd_sts_cd<>'3'              --发行失败
;
3. 基金

-- 基金交易确认流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241114_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241114_CST_04 AS
SELECT T1.CST_ID
    ,T2.BUS_CD
    ,DECODE(T2.BUS_CD,'020','认购','022','申购','039','定投申请') TRX_TYPE
    ,T2.bus_glo_srl_nbr TRX_SRL_NBR
    ,T2.chnl_dt TRX_DT
    ,T2.chnl_tm TRX_tm
    ,T1.CFM_DT
    ,T2.CHNL_CD         TRX_CHNL_CD
    ,T2.APL_AMT         TRX_AMT
    ,T1.CFM_AMT                     --确认金额
    ,t2.ta_cd
FROM EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI     t1
inner join (
    SElECT apl_id,cst_Id,BUS_CD,bus_glo_srl_nbr,chnl_dt,chnl_tm,CHNL_CD,APL_AMT,rcm_psn_id
        ,trx_act_id,taact_id,ta_cd,pd_cd
        ,row_number() OVER(PARTITION by apl_id order by dt desc) rn
    FROM edw.dwd_bus_chm_fnd_cst_rqs_srl_dd  --基金客户资金类交易申请流水
    WHERE dt<='@@{yyyyMMdd}'
    -- and chnl_dt between '20230810' and '20240820'   --交易时间
    -- AND trx_cd IN ( '100200' , '100201' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
    AND trx_sts_cd IN ( '3','S' )        -- 交易成功
    and bus_cd in ('020','022','039')    -- 认购结果 020    认购申请 022    申购申请 039 定投申请
)t2 on t1.orig_apl_id = t2.apl_id and t2.rn=1
WHERE T1.DT <= '@@{yyyyMMdd}'
AND   T1.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND   T1.BUS_CD IN ( '120' , '122' , '136' , '139' , '138') --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
-- ,'124','赎回确认' ,'125','预约赎回确认' ,'142','强行赎回确认' ,'163','定时定额赎回确认'
AND   T1.CFM_AMT > 0
;
4. 贵金属
-- 贵金属交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241114_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241114_CST_06 AS
SELECT  ord_id    --    订单号
    ,cst_id              --客户号
    ,cst_nm              --客户名称
    ,SUBSTR(replace(pmt_tm,'-',''), 1, 8)    as trx_dt   --付款时间
    ,cmdt_pay_unt_prc                        as trx_amt  --商品应付现金总额
    ,data_src            --数据来源
    ,'0'                 as is_hand
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '@@{yyyyMMdd}'
UNION all
SELECT  ord_id    --    订单号
    ,cst_id           --客户号
    ,cst_nm           --客户名称
    ,SUBSTR(replace(pmt_tm,'-',''), 1, 8)    as trx_dt   --付款时间
    ,cmdt_pay_unt_prc                        as trx_amt  --商品应付现金总额
    ,data_src            --数据来源
    ,'1'                 as is_hand
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI     --贵金属柜面或退款交易手工表
WHERE dt <= '@@{yyyyMMdd}'
;

-- 贵金属交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241114_CST_06_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241114_CST_06_1 AS
SELECT  ord_id    --    订单号
    ,cst_id              --客户号
    ,cst_nm              --客户名称
    ,SUBSTR(replace(pmt_tm,'-',''), 1, 8)    as trx_dt   --付款时间
    ,cmdt_pay_unt_prc                        as trx_amt  --商品应付现金总额
FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di --贵金属交易整合表
WHERE dt <= '@@{yyyyMMdd}'
;
5. 保险

-- 截至2023年底 保险交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241114_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241114_CST_05 AS
select replace(t1.trx_dt,'-','') trx_dt       --交易日期
    ,t1.cst_id                                   --客户号
    ,t1.insu_hld_nm                              --投保人姓名
    ,t1.prod_cd                                  --产品代码
    ,t1.prod_nm                                  --产品名称
    ,t1.insu_ord_nbr                             --投保单号
    ,t1.insu_plcy_id                             --保单号
    ,t1.insu_plcy_sts                            --保单状态
    ,t1.cur_insu_plcy_sts_nm                     --新保单状态
    ,t1.insu_amt                                 --保额
    ,t1.frs_trm_insu_fee                         --首期保费
    ,t1.mng_cnv_insu_fee  as trx_amt             --管护折算保费
    ,t1.mng_cnv_cmsn_fee                         --管护折算手续费
    ,t1.mng_cnv_nbr_num                          --管护折算件数
    ,t1.mng_mgr_id                               --管护客户经理工号
    ,t1.mng_mgr_nm                               --管护客户经理姓名
    ,t1.mng_rto                                  --管护比例
    ,t1.mng_org_id                               --管护机构号
    ,t1.mng_org_nm                               --管护机构名称
    ,t1.trx_chnl                                 --交易渠道
    ,t1.trx_cd                                   --交易代码
    ,t1.trx_nm                                   --交易名称
    ,t1.trx_sts                                  --交易状态
    ,t1.stl_sts_cd                               --保司结算状态
    ,decode(t1.stl_sts_cd,'0','待确认' ,'1','待结算' ,'2','不可结算' ,'3','可结算' ,'4','已结算') as stl_sts_nm  --结算状态
FROM    app_rpt.fct_insu_agn_bus_acs_dtl_tbl t1 --保险代销业务考核明细表
WHERE   t1.DT = '@@{yyyyMMdd}'
AND     replace(t1.trx_dt,'-','') <= '@@{yyyyMMdd}'
and     t1.stl_sts_cd in('0','1','3','4')    --保司 结算状态 0待确认,1待结算,2不可结算,3可结算,4已结算
AND     t1.insu_plcy_sts = '新保投保' --保单状态 '正常','退保','满期退保'
-- AND     t1.INSU_PLCY_STS IN('新保投保','正常','退保','满期退保')
-- AND     t1.cur_insu_plcy_sts_nm = '已生效'
;

14. 反洗钱
1. 联网核查
-- 联网核查结果是在'20240812'批量导入的历史数据，以后才是每天更新
SELECT id_no
    ,checkdate
    ,result
FROM adm_upss.AML_T3R_LWHC_LOG --公民联网核查日志记录表
WHERE dt >= '20240812' -- AND checkdate BETWEEN '20240201' AND '20240210'
AND nvl(id_no,'') <> ''
group by id_no,checkdate
;
-- result
11：公民身份号码与姓名一致，且存在照片
12：姓名与号码相符但照片不存在；
13：姓名与号码相符但照片错误
14：号码存在但与姓名不匹配
15：号码不存在
16：其他
-- 5、可疑案例信息
-- 直接查
SELECT  substr(t1.party_id,3,12)              --客户号
       ,t1.party_name                         --客户名称
       ,t1.application_num                    --案例编号
       ,substr(replace(t1.app_dt,'-',''),1,8) --创建日期
       ,deocde(t1.app_state_cd,'1','处理中','2','已审批','3','退回','4','已排除','5','上报') 案列状态
       ,t1.application_advice                 --案例意见
       ,t1.post_id                            --当前岗位
       ,t1.case_date                          --案例时间
       ,t1.app_org_id                         --创建机构
       ,row_number() over(partition by substr(t1.party_id,3,12) order by t1.app_dt) as rn
FROM    adm_upss.aml_t07_case_application_uh t1
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250731'
-- AND     t1.cast_type = '2' --案例类型:1:大额 2:可疑
AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报


-- 洗钱风险评级等级
left join(
    SELECT  cst_id
    FROM
    (
        SELECT  SUBSTR(party_id,3,10) AS cst_id
            ,levelkey
            ,decode(levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as 最终风险等级
            ,statistic_dt
            ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY  statistic_dt DESC ) AS rn
        FROM adm_upss.aml_t37_party_result_curr
        WHERE dt = '20250430'
    ) t
    WHERE t.levelkey IN ( '1004' , '1005' )
    AND t.rn = 1
)t6 on t1.cst_id=t6.cst_id

-- 公安机关查冻扣记录
left join(
    SELECT distinct t1.cst_id
    FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd t1 --司法查冻扣汇总信息
    WHERE t1.dt = '20250430'
    -- AND qry_ctrl_dt between '20240430' and '20250430'
    AND qry_ctrl_typ_nm IN ('查询', '冻结', '划扣')
    AND ( t1.instt_typ_cd IN ( '04' , '05' ) OR ( ( t1.instt_nm LIKE '%法院%' OR t1.instt_typ_cd = '01' ) AND t1.LAW_DOC_ID LIKE '%刑%' ) )
)t7 on t1.cst_id=t7.cst_id


--标准代码块：司法查冻扣
SELECT  inpt_inf_id          AS 录入信息编号
        ,instt_typ_cd        AS 有权机关类型
        ,instt_nm            AS 有权机关名称
        ,cst_id              AS 客户号
        ,cst_nm              AS 客户名称
        ,cst_act_id          AS 客户账号
        ,bch_srl_nbr         AS 批次流水号
        ,qry_ctrl_dt         AS 查控日期
        ,qry_ctrl_tm         AS 查控时间
        ,exe_ppl_anm         AS 执法人员A名称
        ,exe_ppl_adoc_typ_cd AS 执法人员A证件类型
        ,exe_ppl_adoc_nbr    AS 执法人员A证件号码
        ,exe_ppl_bnm         AS 执法人员B名称
        ,exe_ppl_bdoc_typ_cd AS 执法人员B证件类型
        ,exe_ppl_bdoc_nbr    AS 执法人员B证件号码
        ,law_doc_nm          AS 法律文书名称
        ,law_doc_id          AS 法律文书编号
        ,exe_cas_id          AS 执行案号
        ,asst_qry_cntnt      AS 协助查询内容
        ,exe_rsn             AS 执行原因
        ,exe_rsl_cd          AS 执行结果代码
        ,fail_rsn            AS 失败原因
        ,qry_ctrl_typ_nm     AS 查控类型代码
        ,frz_typ_cd          AS 冻结类型代码
        ,nfrz_ind            AS 解冻标志
        ,frz_bgn_dt          AS 冻结起始日期
        ,frz_tmn_dt          AS 冻结终止日期
        ,frz_amt             AS 冻结金额
        ,src_tbl_nm          AS 源表名
        ,opn_org_id          AS 开户机构编号
        ,cst_typ_cd          AS 客户类型
        ,cst_act_typ_cd      AS 客户账户类型代码
        ,qry_ctrl_chnl_nm    AS 查控渠道名称
        ,deal_sts_cd         AS 处理状态代码
        ,qry_cntnt_bgn_dt    AS 查询内容起始日期
        ,qry_cntnt_end_dt    AS 查询内容截止日期
        ,CONCAT(law_doc_nm, '%')
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd
WHERE   dt = '20240811'
20. 其他

-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_02 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    -- ,t2.cst_chn_nm    --客户姓名|C200
    -- ,t1.rel_typ
    -- ,c1.cd_val_dscr as rel_typ_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd     t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '@@{yyyyMMdd}'
-- AND C1.TBL_NM=UPPER('DIM_CST_REL_INF_DD')
-- AND C1.FLD_NM=UPPER('REL_TYP_CD')
;

--客户担任法人的企业 关联企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025051701_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051701_CST_02 AS
select t.*
    ,row_number() over(partition by cst_id,entp_cst_id order by prio) rn
from(
    select lgp_cst_id   as cst_id                           --对公客户法人客户号
        ,lgp_nm         as cst_nm                           --对公客户法人客户名称
        ,cst_id         as entp_cst_id                      --客户号
        ,cst_nm         as entp_cst_nm                      --客户名称
        ,'1' as prio
    from edw.dim_cst_entp_lgp_inf_dd              --对公客户法人信息表
    where dt='@@{yyyyMMdd}'
)t
;

-- 实控人、法人
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_02 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm    --客户姓名|C200
    ,t2.doc_nbr     --证件号码|C60
from(
    SElECT cst_id,rel_cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20250703'
    and REL_TYP_CD='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20250703'
    and REL_TYP_CD='0109' --实际控制人
)t1 inner join edw.dws_cst_bas_inf_dd     t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='20250703'
and t2.cst_typ_cd='1'   --实控人为个人客户
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '20250703'
-- AND C1.TBL_NM=UPPER('DIM_CST_REL_INF_DD')
-- AND C1.FLD_NM=UPPER('REL_TYP_CD')
;

-- 受益所有人
SELECT substr(party_id,3,10) as cst_id
    ,CONCAT_WS(';',COLLECT_SET(CONCAT(bfi_id,':',bfi_name))) as 受益所有人
from adm_upss.adm_upss_aml_t47_beneficiary     --对公客户受益所有人表
where dt='20250630'
GROUP BY cst_id

-- 同一风险控制号下我行授信总额
DROP   TABLE IF     EXISTS SJXQ_SJ20251231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20251231_CST_01 AS


-- 工商 数据最全，查询慢
DROP   TABLE IF     EXISTS SJXQ_SJ20250513161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250513161_CST_01 AS
SELECT  t1.company_id
    ,decode(t1.company_major_type, 1, '个体户', 2, '合作社', 3, '企业', '') AS 归类后的主体类型
    ,t1.n_company_status                                                 AS 归类后的登记状态
    ,t1.province                                                         AS 省
    ,t1.city                                                             AS 城市
    ,t1.district                                                         AS 区县
from edw.nout_company_base_clean t1 --企业基本信息清洗表
where t1.dt='@@{yyyyMMdd-1d}'
and t1.city='台州市'
and t1.n_company_status not in('停业','吊销','撤销','注销')
;

DROP   TABLE IF     EXISTS SJXQ_SJ20250513161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250513161_CST_02 AS
SELECT  t1.company_name      AS 企业名称
    ,t1.credit_no            AS 统一信用代码
    ,t1.org_code             AS 组织机构代码
    ,t1.establish_date       AS 成立日期
    ,t1.legal_person         AS 法定代表人
    ,t1.legal_person_caption AS 法人头衔
    ,t1.company_status       AS 登记状态
    ,t1.company_type         AS 类型
    ,t1.issue_date           AS 核准日期
    ,t1.operation_startdate  AS 营业期限自
    ,t1.operation_enddate    AS 营业期限至
    ,t1.capital              AS 注册资本
    ,t1.company_address      AS 地址
    ,t1.business_scope       AS 经营范围
    ,t1.real_capital         AS 实缴资本
    ,t2.归类后的主体类型
    ,t2.归类后的登记状态
    ,t2.省
    ,t2.城市
    ,t2.区县
    ,t3.industry             AS 最深一级的行业名称
    ,t3.industry_code        AS 最深一级的行业代码
    ,t3.industry_l1_code     AS 一级行业编码
    ,t3.industry_l1_name     AS 一级行业名称
    ,t3.industry_l2_code     AS 二级行业编码
    ,t3.industry_l2_name     AS 二级行业名称
    ,t3.industry_l3_code     AS 三级行业编码
    ,t3.industry_l3_name     AS 三级行业名称
    ,t3.industry_l4_code     AS 四级行业编码
    ,t3.industry_l4_name     AS 四级行业名称
    ,ROW_NUMBER() over(partition by t1.credit_no order by t1.use_flag,t1.id desc) as 同一统一信用代码排序
from edw.nout_company_base              t1 --企业基本信息表
inner join SJXQ_SJ20250513161_CST_01    t2
on t1.company_id=t2.company_id
left join edw.nout_company_industry     t3 --企业行业信息表
on t1.company_id=t3.company_id
and t3.dt=t1.dt
where t1.dt='@@{yyyyMMdd-1d}'
;


客户集市的有效信贷户之类的标签，目前已经迁移到指标集市，后续使用到类似标签建议使用新表取数，后续客户集市的表会逐步下线，以下是迁移的新表：
adm_ind.ADM_IND_L_RUL_UNVS_CMPN_CHRST_L4_DD.SLP_ACT_MARK 改为 SLP_ACT --睡眠户：0否1是
adm_ind.ADM_IND_L_RUL_UNVS_CMPN_CHRST_L2_DD.DOMT_CST_MARK 改为 DOMT_CST --沉睡客户：0否1是
adm_ind.ADM_IND_L_RUL_UNVS_FIN_BHV_WLTH_DD.VLD_CHM_CST  --有效理财客户：0否1是
                                  .VLD_FND_CST  --有效基金客户：0否1是
                                  .VLD_INSU_CST --有效保险客户：0否1是
                                  .VLD_PM_CST    --有效贵金属客户：0否1是
adm_ind.ADM_IND_L_RUL_UNVS_FIN_BHV_CR_CRD_DD.VLD_CR_CRD_CST --有效信用卡客户：0否1是
adm_ind.ADM_IND_L_RUL_UNVS_FIN_BHV_CR_CRD_L2_DD.OLY_VLD_CR_CRD_CST --仅有效信用卡客户：0否1是

select t1.cst_id
    ,t2.forml_cst_ind                            --正式客户标识
    ,t3.vld_cst                                  --有效户
    ,case when t4.cst_id is not null then '1' else '0' end as is_crdt_cst
    ,t5.vld_dep_act                              --有效存款户
    ,t6.vld_loan_act                             --有效贷款户
    ,t7.vld_wlth_cst                             --有效财富客户
    ,t8.vld_itnl_bsn_cst                         --有效国际业务客户
    ,t9.val_cst                                     --价值客户
from SJXQ_SJ2025071616_CST_01               t1
left join adm_pub.adm_csm_cbas_mng_inf_dd   t2 --客户集市-客户基础-客户管户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t3 --客户规则类通用营销特性表3
on t1.cst_id=t3.cst_id
and t3.dt='20250715'
left join (
    select distinct t1.cst_id
    from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
    where t1.dt='20250715'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' ) AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 )
) t4 on t1.cst_id=t4.cst_id
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     t5 --规则通用金融行为存款标签
on t1.cst_id=t5.cst_id
and t5.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t6 --通用金融行为贷款标签表2
on t1.cst_id=t6.cst_id
and t6.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_wlth_l2_dd t7 --通用金融行为客户标签2表
on t1.cst_id=t7.cst_id
and t7.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_mid_bsn_l2_dd t8 --通用-金融行为-中间业务2表
on t1.cst_id=t8.cst_id
and t8.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_cst_val_l4_dd        t9 --客户通用风险评估标签表4
on t1.cst_id=t9.cst_id
and t9.dt='20250715'
;