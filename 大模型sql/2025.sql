***20250229_许海萍_SJ2025022816_宁波分行外呼反馈情况.sql
﻿-- 1月19日和2月28日客户一年期存款、活期存款和3年挂钩理财购买情况
-- 客户号、客户名称、1月19日一年期存款余额、2月28日一年期存款余额、1月19日活期存款余额、2月28日活期存款余额、1月19-2月28日期间3年挂钩型理财购买金额
-- 2月28日一年期存款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025022816_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022816_CST_01 AS
SElECT t1.cst_id
    ,t2.brc_org_nm
        then gl_bal else 0 end) as gl_bal  --账户总账余额
FROM edw.dws_bus_dep_act_inf_dd             T1             -- 存款账户信息表
left join edw.dim_hr_org_mng_org_tree_dd    t2             --考核机构树 4481 org_id 唯一
on      t1.opn_org = t2.org_id
and     t2.dt = '20250228'
WHERE   T1.DT = '20250228'
and     t2.brc_org_nm = '宁波分行'
group by t1.cst_id,t2.brc_org_nm
;
-- 1月19日一年期存款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025022816_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022816_CST_02 AS
SElECT t1.cst_id
    ,sum(t1.gl_bal) as   gl_bal                                 --账户总账余额
FROM edw.dws_bus_dep_act_inf_dd             T1             -- 存款账户信息表
left join edw.dim_hr_org_mng_org_tree_dd    t2             --考核机构树 4481 org_id 唯一
on      t1.opn_org = t2.org_id
and     t2.dt = '20250228'
WHERE   T1.DT = '20250119'
-- and     T1.ACT_STS_CD <>'C'         -- 账户状态
and     t2.brc_org_nm = '宁波分行'
group by t1.cst_id
;
-- 1月19-2月28日期间3年挂钩型理财购买金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025022816_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022816_CST_03_1 AS
select pd_cd                                    --产品代码|C24
	,pd_nm                                    --产品名称|C256
    ,pd_val_dt
	,pd_found_dt                              --产品成立日期|C8
	,pd_end_dt                                --产品结束日期|C8
	,actl_found_dt                            --实际成立日期|C8
    ,DATEDIFF(TO_DATE(pd_end_dt,'yyyyMMdd'),TO_DATE(pd_val_dt,'yyyyMMdd'),'dd') as trm_days
    ,round(DATEDIFF(TO_DATE(pd_end_dt,'yyyyMMdd'),TO_DATE(pd_val_dt,'yyyyMMdd'),'dd')/365,0) as y_trm
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='20250228'
and (pd_nm REGEXP '挂钩型' or (ta_cd <> 'TL' and pd_nm REGEXP '钱潮'))  --挂钩型理财新口径
and pd_sts_cd<>'3'              --发行失败
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025022816_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022816_CST_03 AS
SELECT t1.srl_nbr,T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,C1.cd_val_dscr bus_nm
    ,T1.pd_cd                                    --产品代码|C20
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                 T1 --理财交易确认流水明细
INNER JOIN SJXQ_SJ2025022816_CST_03_1               t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
and t2.y_trm=3
left join edw.dwd_code_library_dd                   c1
on t1.bus_cd=c1.cd_val
and c1.dt='20250228'
where T1.DT<='20250228'
and t1.trx_dt>='20240101'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025022816_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022816_CST_04 AS
SElECT t1.cst_id        as 客户号
    ,t6.cst_chn_nm      as 客户名称
    ,t2.gl_bal          as 1月19日一年期存款余额
    ,t1.gl_bal          as 2月28日一年期存款余额
    ,t4.dmnd_dep_bal	as 1月19日活期存款余额
    ,t5.dmnd_dep_bal	as 2月28日活期存款余额
    ,t3.gglc_amt        as 1月19到2月28日期间3年挂钩型理财购买金额
from SJXQ_SJ2025022816_CST_01       t1
left join SJXQ_SJ2025022816_CST_02  t2
on t1.cst_id=t2.cst_id
left join(
    select cst_ID,sum(CFM_AMT) as gglc_amt
    from SJXQ_SJ2025022816_CST_03
    where trx_dt between '20250119' and '20250228'
    group by cst_ID
)  t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbus_dep_inf_dd	t4 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250119'
left join adm_pub.adm_csm_cbus_dep_inf_dd	t5 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250228'
left join edw.dws_cst_bas_inf_dd 			t6	    --客户基础信息汇总表
on  t1.cst_id=t6.cst_id
and t6.dt='20250228'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022816_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022816_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022816_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025022816_CST_04
;
select count(t1.cst_id)
from SJXQ_SJ2025022816_CST_01 t1
inner join SJXQ_SJ2025022816_CST_02 t2
on t1.cst_ID=t2.cst_id
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025022816_CST_04
;
/*
01	633969	633969
02	63976	63976
03	57769	42760
04	633969	633969
*/***name_SJ2025060441_旬阳村行交易明细.sql
﻿-- 空
SELECT  cst_id,cst_chn_nm
from edw.dws_cst_bas_inf_dd            t4 --客户基础信息汇总
where t4.dt = '20250604'
and t4.cst_chn_nm regexp '亚盟联盈'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025060441_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060441_CST_01 AS
SELECT  t2.cst_id               AS 客户号
    --    ,t4.cst_chn_nm           AS 客户名称
       ,t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_tm               AS 交易时间
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.trx_ccy_cd           AS 交易币种代码
       ,t1.trx_amt              AS 交易金额
       ,t1.act_bal              AS 账户余额
       ,t1.cst_act_id           AS 客户账号
       ,t1.trx_chnl_cd          AS 交易渠道代码
       ,t1.csh_ind              AS 现转标志
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.cnt_pty_fin_instt_cd AS 对方金融机构代码
       ,t1.tlr_srl_nbr          AS 柜员流水号
       ,t1.trx_bus_org          AS 交易营业机构
       ,t1.opn_org              AS 开户机构
       ,t1.opr_tlr              AS 操作柜员
       ,t1.cmt                  AS 备注
       ,t1.act_nm               AS 账户名称
       ,t1.prod_id              AS 产品编号
       ,t1.cst_act_typ_cd       AS 客户账户类型代码
       ,t1.bal_fld_nm           AS 余额字段名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
	,case when t1.txt_code='IB9999' then t1.txt_code else t1.smr_dscr end as smr_dscr --摘要描述|C512
    ,case WHEN T1.CSH_IND = '1' AND T1.CRD_AND_DBT_IND = 'C' THEN '转入'
        WHEN T1.CSH_IND = '1' AND T1.CRD_AND_DBT_IND = 'D' THEN '转出'
        WHEN T1.CSH_IND = '0' AND T1.CRD_AND_DBT_IND = 'C' THEN '存现'
        WHEN T1.CSH_IND = '0' AND T1.CRD_AND_DBT_IND = 'D' THEN '取现' else ''
         END    as   trx_type1
    ,case when t2.cst_id like '0%' then 1 else 0 end as is_sam_industry  --同业客户
    ,case when (nvl(t1.act_nm,'')<>'' and t1.act_nm=t1.cnt_pty_act_nm) or t1.cst_act_id=t1.cnt_pty_cst_act_id then 1 else 0 end as is_sam_nm --'同名转账'
    ,case WHEN (
        OR (t1.txt_code LIKE 'B49' AND t1.smr_dscr LIKE '%转贷%' AND t1.cnt_pty_act_nm NOT LIKE '%利息%')) then 1 else 0 end as is_loan_ff --贷款发放
    , CASE
        , 'DP0208', 'DP0209', 'DP0228', 'DP2105', 'DPW031', 'DPW040', 'DPW085', 'DPWT34', 'FX0632', 'FX0633', 'GJ0001'
        , 'LCPS01', 'SGZ001', 'SJZZ01', 'TY0013', 'TY0049', 'TY1917', 'TYMD03', 'TYN001', 'XE0001' , 'YL0021', 'YL0033'
        , 'LC0010', 'LN1033', 'TA0005', 'TA0632', 'TY0066', 'TY0067', 'TY0068', 'TY0069', 'TY0089', 'TY0141', 'TY5055', 'ZHB002') THEN '开放式理财赎回'
        , 'DP0243', 'DP0251', 'DP0622', 'DP0628', 'DP0700', 'DP1000', 'DP2019', 'DP2020', 'DP2022', 'DP2126', 'DPW040', 'DPW289'
        , 'FD0003', 'FD0004', 'FD0011', 'FD0013', 'IB9999', 'LC0005', 'LC0006', 'LN0002', 'SGZ001', 'ST0001', 'THS009'
        , 'TY0011', 'TY5020', 'XE0003', 'XE0026', 'XETH01', 'YL0001', 'YL0015') THEN '行内资金'
        WHEN T1.TXT_CODE IN ( 'DC0068' , 'DC0069' , 'DC0070' , 'DC0071' , 'DC0072' , 'DC0073' , 'DC0074' , 'DC0075' , 'DC0076'
        , 'DC0077' , 'DC0078' , 'DC0079' , 'DC0080' , 'DC0081' , 'NS0001' , 'NS0002' , 'ZF0046' , 'DC0107' , 'DC0109' , 'YL0011'
        , 'YL0012' , 'YL0013' , 'YL0014' , 'ZF0001' , 'ZF0002' , 'ZF0003' , 'ZF0004' , 'ZF0005' , 'ZF0006' , 'ZF0007' , 'ZF0008'
        , 'ZF0009' , 'ZF0010' , 'ZF0011' , 'KJ0001' , 'KJ0002' , 'KJ0003' , 'KJ0010' , 'WG0001' , 'NSDC01' , 'NSDC02' , 'NSDC04'
        , 'NSDC05' , 'WWB010' , 'WWB011' , 'WWB012' , 'YL1003' , 'YL1006' , 'YL1012' , 'YL1013' , 'IB0023' , 'IB0024' , 'THS001'
        , 'THS002' , 'XF0001' , 'XF0002' , 'XF0003' , 'XF0004' , 'YL0403' , 'YL0504' , 'THS004' , 'THS005' , 'THS007' , 'THS008'
        , 'TY1919' , 'TY1921' ) THEN '消费'
        WHEN T1.TXT_CODE IN ( 'IB0047' , 'TY0021' , 'IB0007' , 'IB0008' , 'IB0009' , 'IB0010' , 'IB0011' , 'IB0012' , 'IB0013'
        , 'IB0014' , 'IB0015' , 'IB0016' , 'IB0017' , 'IB0018' , 'IB0019' , 'IB0020' , 'DPW035' , 'DPW036' , 'DPW037' , 'DPW038'
        , 'DPW039' , 'DPW040' , 'DPW041' , 'DPW042' , 'TY0145' , 'TY0146' , 'DFGZ01' , 'SGZ001' , 'WZGZ01' , 'DFGZ02' , 'NBGZ01' ) THEN '代发'
        WHEN T1.TXT_CODE IN ( 'IB0048' , 'IB0049' , 'IB0050' , 'IB0053' , 'IB0052' , 'IB0054' ) THEN '代扣'
        WHEN T1.TXT_CODE IN ( 'TY0136' , 'TY0137' ) THEN '代缴'
        WHEN T1.TXT_CODE IN ( 'DP0210' , 'GL0002' , 'GL0621' , 'IB0034' , 'TY1915' ) THEN '结息'
        WHEN T1.TXT_CODE IN ( 'TY0023' , 'TY0024' , 'TY0025' , 'TY0026' , 'TY0061' , 'TY0062' , 'TY0063' , 'TY0064' , 'TY0090'
        , 'C201' , 'TY0081' , 'TY0082' , 'LCPS01', 'TY0168' , 'TY0148' , 'TY1790' , 'TY1792' ) THEN '投资理财' else '' end  as 交易类型
	,t3.prm_mgr_id                               as 主管护客户经理工号
	,t3.prm_mgr_nm                               as 主管护客户经理姓名
	,t3.prm_org_id                               as 主管护机构号
	,t3.prm_org_nm                               as 主管户机构名称
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
left JOIN edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
ON t1.cst_act_id = t2.cst_act_id
AND t2.dt = '20250604'
inner join adm_pub.adm_csm_cbas_mng_inf_dd   t3 --客户集市-客户基础-客户管户信息
on  t2.cst_id = t3.cst_id
and t3.dt = '20250604'
and t3.prm_org_id like '6161%' --旬阳村行
-- inner JOIN edw.dws_cst_bas_inf_dd            t4 --客户基础信息汇总
-- ON t2.cst_id = t4.cst_id
-- AND t4.dt = '20250604'
where t1.dt >='20190101'
AND t1.dt <= '20250604'
and concat(t1.act_nm,t1.cnt_pty_act_nm,t1.cmt) regexp '亚盟联盈'
;
-- 空
SElECT '01' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025060441_CST_01
;
-- 含关键字交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2025060441_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060441_CST_02 AS
SELECT t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_tm               AS 交易时间
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.trx_ccy_cd           AS 交易币种代码
       ,t1.trx_amt              AS 交易金额
       ,t1.act_bal              AS 账户余额
       ,t1.cst_act_id           AS 客户账号
       ,t1.trx_chnl_cd          AS 交易渠道代码
       ,t1.csh_ind              AS 现转标志
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.cnt_pty_fin_instt_cd AS 对方金融机构代码
       ,t1.tlr_srl_nbr          AS 柜员流水号
       ,t1.trx_bus_org          AS 交易营业机构
       ,t1.opn_org              AS 开户机构
       ,t1.opr_tlr              AS 操作柜员
       ,t1.cmt                  AS 备注
       ,t1.act_nm               AS 账户名称
       ,t1.prod_id              AS 产品编号
       ,t1.cst_act_typ_cd       AS 客户账户类型代码
       ,t1.bal_fld_nm           AS 余额字段名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
where t1.dt <= '20250604'
and concat(t1.act_nm,t1.cnt_pty_act_nm,t1.cmt) regexp '亚盟联盈'
;
-- 空
SElECT '02' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025060441_CST_02
;
***SJ20241127111.sql
--SJ20241127111
select * from  lab_sharedata_dev.np_tmp_nb_2305_2403_241203_list limit 100;
select count(1) from  lab_sharedata_dev.np_tmp_nb_2305_2403_241203_list limit 100;
-- 直接引用聂的自建表
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ20241127111_cstlist PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ20241127111_cstlist AS
SELECT  *
FROM    lab_sharedata_dev.np_tmp_nb_2305_2403_241203_list;
SELECT MAX(合同生效日期),MIN(合同生效日期) FROM lab_sjxq.SJXQ_SJ20241127111_cstlist
SELECT * FROM lab_sjxq.SJXQ_SJ20241127111_cstlist WHERE 客户号='2607470119'
SELECT 客户号,合同流水号,COUNT(1) AS SM FROM lab_sjxq.SJXQ_SJ20241127111_cstlist GROUP BY 客户号,合同流水号 HAVING SM>1 ORDER BY SM DESC
-- 产品类型	业务标识	是否消费
-- 子社区名称	主维人工号	主维人	经办时所在社区名称（合同生效后30天内最终挂靠子社区）	经办时所在社区主维人工号	经办时所在社区主维人
-- 最近一次处置类精准贷后触发时间	精准贷后反馈客户风险程度	客户/业务贷后管理方案
-- 他行是否有逾期	近半年我行是否有逾期
-- 高风险客户首次标签时间	业务办理时高风险客户标识
-- 补充字段：
-- 子社区名称	主维人工号	主维人	经办时所在社区名称（合同生效后30天内最终挂靠子社区）	经办时所在社区主维人工号	经办时所在社区主维人
-- 最近一次处置类精准贷后触发时间	精准贷后反馈客户风险程度	客户/业务贷后管理方案
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ20241127111_JGB PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ20241127111_JGB AS
SELECT  T1 . *
        -- ,T1.合同流水号
        -- ,T1.合同生效日期
        -- ,TO_CHAR(dateadd(TO_DATE(T1.合同生效日期,'yyyymmdd'), 30, 'dd'),'yyyymmdd')
        ,T2.sub_cmnt_id             AS 子社区编号
        ,T2.sub_cmnt_nm             AS 子社区名称
        ,T2.sub_cmnt_prm_mnt_psn_id AS 子社区主维护人编号
        ,T2.sub_cmnt_prm_mnt_psn_nm AS 子社区主维护人名称
        ,T3.sub_cmnt_id             AS 经办时所在子社区编号
        ,T3.sub_cmnt_nm             AS 经办时所在子社区名称
        ,T3.sub_cmnt_prm_mnt_psn_id AS 经办时所在子社区主维护人编号
        ,T3.sub_cmnt_prm_mnt_psn_nm AS 经办时所在子社区主维护人名称
        ,T4.最近一次触碰精准贷后_处置类时间
        ,T4.客户风险程度代码
        ,T4.客户级贷后管理方案代码
FROM    lab_sjxq.SJXQ_SJ20241127111_cstlist T1
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd T2
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
AND     T2.dpd_sts_cd ='0' --挂靠状态代码  0:正常挂靠；1：错挂
and     T2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    (
                 SELECT  cst_id
                         ,sub_cmnt_id
                         ,sub_cmnt_nm
                         ,sub_cmnt_prm_mnt_psn_id
                         ,sub_cmnt_prm_mnt_psn_nm
                         ,DT
                 FROM    edw.dwd_cst_mng_cmnt_rel_dd
                 WHERE   DT >= '20230501'
                 AND     DT <= '20240331'
                 AND     dpd_sts_cd ='0' --挂靠状态代码  0:正常挂靠；1：错挂
                 and     dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
             ) T3
ON      T1.客户号 = T3.cst_id
-- AND     T3.DT = TO_CHAR(dateadd(TO_DATE(T1.合同生效日期,'yyyymmdd'), 30, 'dd'),'yyyymmdd')
AND     TO_CHAR(TO_DATE(T3.DT, 'yyyymmdd'), 'yyyymmdd') = TO_CHAR(dateadd(TO_DATE(T1.合同生效日期, 'yyyymmdd'), 30, 'dd'), 'yyyymmdd')
LEFT JOIN    (
                 SELECT  T1.cst_id                                                                 AS 客户号
                         ,T2.tsk_gen_dt                                                            AS 最近一次触碰精准贷后_处置类时间
                         ,T2.cst_rsk_dgr_cd                                                        AS 客户风险程度代码
                         ,T1.cst_lvl_pst_loan_mng_pln_cd                                           AS 客户级贷后管理方案代码
                         ,CASE
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类'
                          END                                                                      AS 触发类型
                         ,t3.rul_sub_clss_nm                                                       AS 最近一次触碰精准贷后_处置类规则细类
                         ,t3.rul_ctg_nm                                                            AS 最近一次触碰精准贷后_处置类规则分类名称
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T2.tsk_gen_dt DESC ) AS RN --倒序
                 FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
                 INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
                 ON      T1.btch_serno = T2.btch_serno
                 AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
                 AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
                 AND     T2.DT = '20241130'
                 LEFT JOIN    (
                                  SELECT  A1.btch_serno
                                          --,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)                                AS 触发规则分类名称
                                          ,A1.rul_ctg_nm --规则分类名称
                                          ,A1.rul_sub_clss_nm --规则细类名称
                                          ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
                                  FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
                                  WHERE   A1.DT = '20241130'
                              ) T3
                 ON      T1.btch_serno = T3.btch_serno
                 AND     T3.RN = 1
                 WHERE   T1.DT = '20241130'
             ) T4
ON      T1.客户号 = T4.客户号
AND     t4.RN = 1
;
-- SELECT * FROM lab_sjxq.SJXQ_SJ20241127111_JGB LIMIT 1000
-- SELECT COUNT(1) FROM lab_sjxq.SJXQ_SJ20241127111_JGB
-- SELECT ovd_day,CST_ID,* FROM adm_rsk.ADM_RSK_APL_INTER_ALL WHERE DT>='20240504' AND ovd_day>0
-- 补充字段：
-- 他行是否有逾期	近半年我行是否有逾期
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ20241127111_JGB_ADD01 PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ20241127111_JGB_ADD01 AS
SELECT  T1 . *
        ,CASE
           WHEN T2.CST_ID <> '' THEN '是'
           ELSE '否'
         END AS 该客户近半年我行是否有逾期
        ,CASE
           WHEN T3.CST_ID <> '' THEN '是'
           ELSE '否'
         END AS 该客户近半年征信报告中他行是否有逾期
FROM    lab_sjxq.SJXQ_SJ20241127111_JGB T1
LEFT JOIN    (
                 SELECT  CST_ID
                         ,SUM(ovd_day) AS ovd_day
                 FROM    adm_rsk.ADM_RSK_APL_INTER_ALL
                 WHERE   DT >= '20240504'
                 AND     ovd_day > 0
                 GROUP BY CST_ID
             ) T2
ON      T1.客户号 = T2.CST_ID
LEFT JOIN    (
                 SELECT  cst_id
                         ,report_id
                         ,ovd_amt
                         ,row_number() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) AS rn
                 FROM    edw.dim_cst_ccrc_idv_loan_inf_dd
                 WHERE   DT = '20241130'
                 AND     dtrb_org <> 'ZJTLCB' --剔除泰隆
                 AND     ovd_amt > 0
                 AND     SUBSTR(report_id, 1, 8) >= '20240501'
                 UNION
                 SELECT  cst_id
                         ,report_id
                         ,ovd_tot_amt                                                       AS ovd_amt
                         ,row_number() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) AS rn
                 FROM    edw.dim_cst_ccrc_entp_loan_inf_dd
                 WHERE   DT = '20241130'
                 AND     dtrb_org_typ_cd <> '00' --排除发放机构为泰隆
                 AND     dtrb_org_typ_cd <> '' --排除发放机构为泰隆
                 AND     ovd_prcp > 0
                 AND     SUBSTR(report_id, 1, 8) >= '20240501'
             ) T3
ON      T1.客户号 = T3.CST_ID
AND     T3.rn = 1;
-- SELECT * FROM lab_sjxq.SJXQ_SJ20241127111_JGB_ADD01 LIMIT 1000
-- SELECT COUNT(1) FROM lab_sjxq.SJXQ_SJ20241127111_JGB_ADD01
-- 补充字段：
-- 高风险客户首次标签时间	业务办理时高风险客户标识
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ20241127111_JGB_ADD02 PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ20241127111_JGB_ADD02 AS
SELECT  T1 . *
        ,CASE
           WHEN T2.idv_model_scr > 0 AND t2.idv_model_scr <= 750 THEN '是'
           ELSE '否'
         END               AS 业务办理时高风险客户标识
        ,T3.ctr_start_date AS 高风险客户首次标签合同开始日期
FROM    lab_sjxq.SJXQ_SJ20241127111_JGB_ADD01 T1
LEFT JOIN    adm_rsk.adm_rsk_apl_rsk_cost_crdt_loan_ctr_check_rsk_cost_rslt_dd T2
ON      T1.客户号 = T2.CST_ID
AND     T1.合同流水号 = T2.ctr_srl_no
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  cst_id
                         ,idv_model_scr
                         ,ctr_start_date
                         ,ROW_NUMBER() OVER ( PARTITION BY CST_ID ORDER BY ctr_start_date ASC ) AS RN
                 FROM    adm_rsk.adm_rsk_apl_rsk_cost_crdt_loan_ctr_check_rsk_cost_rslt_dd --包含新信贷
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     idv_model_scr > 0
                 AND     idv_model_scr <= 750
             ) T3
ON      T1.客户号 = T3.CST_ID
AND     T3.RN = 1;
-- 传结果表
SELECT * FROM lab_sjxq.SJXQ_SJ20241127111_JGB_ADD02 LIMIT 1000
SELECT COUNT(1) FROM lab_sjxq.SJXQ_SJ20241127111_JGB_ADD02
***SJ2025010781_截止2024年12月31日嘉兴分行全量清单业务对应的预评估结果.sql
-- SJ2025010781
-- 截止2024年12月31日，嘉兴分行全量清单业务对应的预评估结果
-- 数据需求字段
-- 以合同号为单位，每笔合同开立时间对应的预评估结果

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_JX_YPG_SJ2025010781_01;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_JX_YPG_SJ2025010781_01 AS
SELECT  B1.cst_id       AS 客户号
        ,B1.ctr_serno   AS 合同流水号
        ,B1.rel_serno   AS 用信申请流水号
		,B1.ctr_bgn_dt  AS 合同起始日期
		,B2.app_cst_rol_cd AS 预评估客户角色代码
		,B4.cd_val_dscr    AS 预评估客户角色
		,B2.cst_id	       AS 预评估客户号
        ,B2.pre_ases_rslt_serno AS 预评估结果流水号
        ,B2.rul_set_rslt_cd AS 预评估结果代码
        ,B3.cd_val_dscr AS 预评估结果
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B1 --合同基础信息
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_rel_ases_dd B2 --授信关联预评估信息表
ON      B1.rel_serno = B2.usc_aply_serno
AND     B2.DT = '20241231'
LEFT JOIN    edw.dwd_code_library_dd B3 -- 码值表
ON      B2.rul_set_rslt_cd = B3.cd_val
AND     B3.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     B3.fld_nm = 'RUL_SET_RSLT_CD'
AND     B3.DT = '20241231'
LEFT JOIN    edw.dwd_code_library_dd B4 -- 码值表
ON      B2.APP_CST_ROL_CD = B4.cd_val
AND     B4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     B4.fld_nm = 'APP_CST_ROL_CD'
AND     B4.DT = '20241231'
WHERE   B1.dt = '20241231'
AND     SUBSTR(B1.mgr_org_id, 1, 4) = '3309'  --管护机构 嘉兴分行
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( B1.CTR_STS_CD IN ( '2' , '4' ) AND B1.TMT_DT = '18991231' AND to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )
         OR B1.CTR_BAL > 0 )
;
                             ***SJ20250303126_取衢州分行开业至今流失的信贷客户清单.sql
-- SJ20250303126
-- 取衢州分行开业至今流失的信贷客户清单，用于流失挽回。
-- 数据日期：截止2025年2月底；
-- 范围：衢州分行历史上发生过信贷业务，目前已经流失的客户；
-- 客户号	客户名称	支行机构编号	支行机构名称	主管户机构	主管户机构名称	主管户客户经理工号	主管户客户经理姓名	客户最早开户日期
-- 客户首次在我行发生信贷业务的时间	客户我行最后一笔信贷业务结清的时间（流失客户）	客户在我行最高授信额度	客户目前我行是否有信贷业务
-- 客户2025年2月底我行存款余额	客户2025年2月底AUM余额	客户2025年2月底是否正式客户	客户2025年2月底是否有效存款户	客户2025年2月底是否有效财富户
-- 客户在我行是否有信用卡	客户手机号码	客户身份证地址	客户居住住址	客户经营地址	客户所属子社区编号	客户所属子社区名称	客户单位名称
-- 客户最近一次征信报告时间	人行征信最新评分
-- 衢州分行开业至今之前有过贷款或随贷通卡业务，但是当前无贷款和随贷通授信的客户
-- 贷款1001、贷款2001、随贷通（消费）2001010101003、随贷通（经营）2001020101003
--1. 衢州分行 流失客户筛选
DROP TABLE IF EXISTS tmp_xqy_sj20250303126_qz_lskh_01 PURGE;
CREATE TABLE tmp_xqy_sj20250303126_qz_lskh_01 AS
SELECT  T1.cst_id      AS 客户号
        ,T1.cst_nm     AS 客户名称
        ,T3.sbr_org_id AS 支行机构编号
        ,T3.sbr_org_nm AS 支行机构名称
        ,T1.prm_org_id AS 主管户机构编号
        ,T1.prm_org_nm AS 主管户机构名称
        ,T1.prm_mgr_id AS 主管户客户经理工号
        ,T1.prm_mgr_nm AS 主管户客户经理姓名
        ,T2.客户首次在我行发生信贷业务的时间
        ,T2.客户我行最后一笔信贷业务结清的时间
        ,T2.客户在我行最高授信额度
        ,T2.客户目前我行是否有信贷业务
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1
LEFT JOIN (
           SELECT  A1.cst_id
                   ,MIN(A1.ctr_bgn_dt) AS 客户首次在我行发生信贷业务的时间
                   ,MAX(CASE WHEN A1.tmt_dt <> '18991231' THEN A1.tmt_dt ELSE A1.ctr_mtu_dt END)           AS 客户我行最后一笔信贷业务结清的时间
                   ,MAX(A1.ctr_amt)    AS 客户在我行最高授信额度
                   ,MAX(CASE
                         WHEN ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') ) OR A1.CTR_BAL > 0 ) THEN '是'
                         ELSE '否'
                        END)           AS 客户目前我行是否有信贷业务
           FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
           WHERE   A1.DT = '20250228'
           AND     SUBSTR(A1.prd_no,1,4) IN ( '1001' , '2001' ) --贷款1001、贷款2001、随贷通（消费）2001010101003、随贷通（经营）2001020101003
           GROUP BY A1.cst_id
           ) T2
ON      T1.cst_id = T2.cst_id
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树考核维度
ON      T1.prm_org_id = T3.org_id
AND     T3.DT = '20250228'
WHERE   T1.DT = '20250228'
AND     T3.brc_org_nm = '衢州分行'
AND     T2.客户目前我行是否有信贷业务 = '否';
--2. 客户业务指标信息加工
DROP TABLE IF EXISTS tmp_xqy_sj20250303126_qz_lskh_02 PURGE;
CREATE TABLE tmp_xqy_sj20250303126_qz_lskh_02 AS
SELECT  T1.客户号
        ,T5.客户最早开户日期
        ,T5.客户2025年2月底我行存款余额
        ,T2.aum_bal AS 客户2025年2月底AUM余额
        ,CASE WHEN T4.forml_cst_ind = '1' THEN '是' ELSE '否' END       AS 客户2025年2月底是否正式客户
        ,CASE WHEN T3.efe_dep_cst_ind = '1' THEN '是' ELSE '否' END     AS 客户2025年2月底是否有效存款户
        ,CASE WHEN T3.efe_wlth_cst_ind = '1' THEN '是' ELSE '否' END    AS 客户2025年2月底是否有效财富户
        ,CASE WHEN T6.cst_id IS NOT NULL THEN '是' ELSE '否' END        AS 客户在我行是否有信用卡
FROM    tmp_xqy_sj20250303126_qz_lskh_01 T1
LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd T2 --客户集市-业务信息-客户金融资产信息表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '20250228'
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T3 --客户集市-基础信息-客户基础标识信息
ON      T1.客户号 = T3.cst_id
AND     T3.DT = '20250228'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T4 --客户集市-客户基础-客户管户信息
ON      T1.客户号 = T4.cst_id
AND     T4.DT = '20250228'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.gl_bal) AS 客户2025年2月底我行存款余额
                         ,MIN(A1.opn_dt) AS 客户最早开户日期
                 FROM    edw.dws_bus_dep_act_inf_dd A1
                 WHERE   A1.DT = '20250228'
                 GROUP BY A1.cst_id
             ) T5
ON      T1.客户号 = T5.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                 FROM    edw.dim_bus_crd_cr_crd_inf_dd A1 --信用卡卡片信息
                 WHERE   A1.DT = '20250228'
                 AND     A1.card_sts_cd NOT IN ( 'Q' , 'V' , '2' ) --销户申请,核销,过期未续卡片
                 GROUP BY A1.cst_id
             ) T6
ON      T1.客户号 = T6.cst_id;
--3. 客户基本信息加工
DROP TABLE IF EXISTS tmp_xqy_sj20250303126_qz_lskh_03 PURGE;
CREATE TABLE tmp_xqy_sj20250303126_qz_lskh_03 AS
SELECT  T1.客户号
        ,concat(substr(regexp_replace(T2.reg_adr, '\\s|,', ''), 1, greatest(length(regexp_replace(T2.reg_adr, '\\s|,', '')) - 6, 0)), '******') AS 户籍_注册地址脱敏
        ,concat(substr(regexp_replace(T2.fml_adr, '\\s|,', ''), 1, greatest(length(regexp_replace(T2.fml_adr, '\\s|,', '')) - 6, 0)), '******') AS 居住地址脱敏
        ,concat(substr(regexp_replace(T2.wrk_adr, '\\s|,', ''), 1, greatest(length(regexp_replace(T2.wrk_adr, '\\s|,', '')) - 6, 0)), '******') AS 工作单位_经营地址脱敏
        ,T2.sub_cmnt_id                                                                                                                         AS 客户所属子社区编号
        ,T3.cmnt_nm                                                                                                                             AS 客户所属子社区名称
        ,T4.job_unt_nm                                                                                                                          AS 客户单位名称
        ,SUBSTR(REPLACE(T5.report_dt, '-', ''), 1, 8)                                                                                           AS 客户最近一次征信报告时间
        ,T5.idv_crd_sco_val                                                                                                                     AS 征信评分
        ,T5.scor_rng                                                                                                                            AS 分数区间
FROM    tmp_xqy_sj20250303126_qz_lskh_01 T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '20250228'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON      T2.sub_cmnt_id = T3.cmnt_enc
AND     T3.DT = '20250228'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T4 --个人客户基本信息汇总表
ON      T1.客户号 = T4.cst_id
AND     T4.DT = '20250228'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T5 --个人征信指标信息表
ON      T1.客户号 = T5.cst_id
AND     T5.report_dsc_rn = 1
AND     T5.DT = '20250228';
--4. 结果表汇总
DROP TABLE IF EXISTS tmp_xqy_sj20250303126_qz_lskh_jgb PURGE;
CREATE TABLE tmp_xqy_sj20250303126_qz_lskh_jgb AS
SELECT  T1.客户号
        ,T1.客户名称
        ,T1.支行机构编号
        ,T1.支行机构名称
        ,T1.主管户机构编号
        ,T1.主管户机构名称
        ,T1.主管户客户经理工号
        ,T1.主管户客户经理姓名
        ,T2.客户最早开户日期
        ,T1.客户首次在我行发生信贷业务的时间
        ,T1.客户我行最后一笔信贷业务结清的时间
        ,T1.客户在我行最高授信额度
        ,T1.客户目前我行是否有信贷业务
        ,T2.客户2025年2月底我行存款余额
        ,T2.客户2025年2月底AUM余额
        ,T2.客户2025年2月底是否正式客户
        ,T2.客户2025年2月底是否有效存款户
        ,T2.客户2025年2月底是否有效财富户
        ,T2.客户在我行是否有信用卡
        ,T3.户籍_注册地址脱敏
        ,T3.居住地址脱敏
        ,T3.工作单位_经营地址脱敏
        ,T3.客户所属子社区编号
        ,T3.客户所属子社区名称
        ,T3.客户单位名称
        ,T3.客户最近一次征信报告时间
        --,T3.征信评分
        --,T3.分数区间
FROM    tmp_xqy_sj20250303126_qz_lskh_01 T1
LEFT JOIN    tmp_xqy_sj20250303126_qz_lskh_02 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    tmp_xqy_sj20250303126_qz_lskh_03 T3
ON      T1.客户号 = T3.客户号;
户号
客户姓名
主管护机构编号
&quot;主管护机构名称&quot;
主管户支行
&quot;主管护分行名称&quot;
&quot;主管户支行名称&quot;
&quot;主管户客户经理工号&quot;
&quot;主管户客户经理名称&quot;
&quot;信贷管户机构编号&quot;
&quot;信贷管户机构名称&quot;
&quot;信贷管户客户经理工号&quot;
&quot;信贷管户客户经理名称&quot;
年龄
性别
客群分类
&quot;客户流失前2年内交接次数&quot;
&quot;客户最后一笔结清合同结清日期&quot;
&quot;客户最后一笔结清合同合同金额&quot;
&quot;客户最后一笔结清合同执行利率&quot;
&quot;客户最后一笔结清合同产品名称&quot;
&quot;最后一次发放借据执行利率&quot;
&quot;最后一次发放借据金额&quot;
&quot;最后一次发放借据结清日期&quot;
&quot;客户流失时长_月&quot;
&quot;行内近90天交易金额&quot;
&quot;行内近90天交易笔数&quot;
&quot;近六个月新增授信金额&quot;
&quot;近六个月贷款申请查询次数&quot;
&quot;近180天内获取的客户安装贷款app的数量&quot;
&quot;资金需求度客群类别&quot;
&quot;资金需求等级(D5资金需求大)&quot;
&quot;最近一笔征信数据时间&quot;
&quot;2025年5月客户存款月日均&quot;
&quot;2025年5月客户综合金融资产aum月日均&quot;
子社区名称
&quot;子社区主维护人&quot;
&quot;子社区定人&quot;
&quot;我行历史是否用信&quot;
客户类型
中征分
&quot;风险量化画像等级(C1逾期概率大)&quot;
&quot;是否命中风险审慎客户标签&quot;
风险审慎触发原因
&quot;是否命中风险提示客户标签&quot;
&quot;风险提示触发原因&quot;
&quot;最近一笔经办人工号&quot;
&quot;最近一笔经办人经办人在职状态&quot;
&quot;最早一笔经办人工号&quot;
&quot;最早一笔经办人经办人在职状态&quot;
&quot;客户最早开户日期&quot;
&quot;客户首次在我行发生信贷业务的时间&quot;
&quot;客户2025年5月底我行存款余额&quot;
&quot;客户2025年5月底aum余额&quot;
&quot;客户2025年5月底是否正式客户&quot;
&quot;客户2025年5月底是否有效存款户&quot;
&quot;客户2025年5月底是否有效财富户&quot;
&quot;客户在我行是否有信用卡&quot;
&quot;户籍_注册地址脱敏&quot;
&quot;居住地址脱敏&quot;
&quot;工作单位_经营地址脱敏&quot;
客户单位名称
***SJ20250410_匹配合同号.sql
﻿-- 0.郭少聪017097-担保合同编号对应的借款合同编号
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250410_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250410_CST_01 AS
SELECT  t1.col_1 as 序号
       ,t1.col_2 as 担保合同编号
       ,t1.col_3 as 保证人编号
       ,t1.col_4 as 保证人名称
       ,t1.col_5 as 被担保人名称
       ,t1.col_6 as 被担保人客户号
from lab_bigdata_dev.qbi_file_20250410_14_36_47_0 t1
where t1.pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250410_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250410_CST_02 AS
SELECT t1.*
       ,t2.合同流水号
from SJXQ_SJ20250410_CST_01 t1
left join (
    SELECT grnt_ctr_no
    from edw.dwd_bus_loan_ctr_rel_grnt_dd  t2       --主合同、担保合同关系
    where t2.dt='@@{yyyyMMdd}'
    GROUP BY grnt_ctr_no
)t2 on t1.担保合同编号=t2.grnt_ctr_no
;
SElECT '02' seq, *
from lab_sjxq.SJXQ_SJ20250410_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20250410_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20250410_CST_02
;
***SJ20250606116_龙海村行企业名单.sql
﻿-- 截至2025年6月6日，在龙海村行辖内开立的企业名称中含有附件（详见附件）字样的非持牌涉金融经营主体名称
-- 企业主体名称，客户号，管户人，管户机构（支行和团队）
-- 1、法定前置许可事项行业字样：银行、城商行；保险 (保险公司、保险资产管理公司、保险集团公司、保险控股公司、自保公司、相互保险组织、互联网保险)；理财；
-- 农商行、信用社、信用合作社、资金互助社、储蓄所；金融控股、金融集团；融资担保；金融租赁；汽车金融；消费金融；财务 (财务公司)；货币经纪；金融资产管理；信托 (信托公司)
DROP   TABLE IF     EXISTS SJXQ_SJ20250606116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250606116_CST_01 AS
SELECT  distinct t1.cst_id AS 客户号
       ,t1.act_nm          AS 账户名称
	,t5.brc_org_nm      as 开户分行
       ,t3.prm_mgr_id      AS 主管护客户经理工号
       ,t3.prm_mgr_nm      AS 主管护客户经理姓名
       ,t3.prm_org_id      AS 主管护机构号
       ,t3.prm_org_nm      AS 主管户机构名称
       ,t4.brc_org_nm      AS 主管户分行
       ,t4.sbr_org_nm      AS 主管户支行
       ,t4.tem_org_nm      AS 主管户团队
from edw.dim_bus_dep_act_inf_dd             t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
and t2.cst_typ_cd='2'   --对公
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250606'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250606'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t1.opn_org = t5.org_id
and t5.dt = t1.dt
and t5.brc_org_nm regexp '龙海'
where t1.dt='20250606'
and concat(t1.act_nm,t2.cst_chn_nm) regexp '银行|城商行|保险|理财|农商行|信用社|信用合作社|资金互助社|储蓄所|金融控股|金融集团|融资担保|金融租赁|汽车金融|消费金融|财务|货币经纪|金融资产管理|信托'
and t1.act_sts_cd <> 'C' 	--剔除销户
;
-- 2、适用防控性准入管理措施行业字样：贷款、小贷、信贷；典当；保理；融资租赁；保险代理；保险经纪；金融；资产管理
DROP   TABLE IF     EXISTS SJXQ_SJ20250606116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250606116_CST_02 AS
SELECT  distinct t1.cst_id AS 客户号
       ,t1.act_nm          AS 账户名称
	   ,t5.brc_org_nm 	   as 开户分行
       ,t3.prm_mgr_id      AS 主管护客户经理工号
       ,t3.prm_mgr_nm      AS 主管护客户经理姓名
       ,t3.prm_org_id      AS 主管护机构号
       ,t3.prm_org_nm      AS 主管户机构名称
       ,t4.brc_org_nm      AS 主管户分行
       ,t4.sbr_org_nm      AS 主管户支行
       ,t4.tem_org_nm      AS 主管户团队
from edw.dim_bus_dep_act_inf_dd             t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
and t2.cst_typ_cd='2'   --对公
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250606'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250606'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t1.opn_org = t5.org_id
and t5.dt = t1.dt
-- and t5.brc_org_nm regexp '龙海'
where t1.dt='20250606'
and concat(t1.act_nm,t2.cst_chn_nm) regexp '贷款|小贷|信贷|典当|保理|融资租赁|保险代理|保险经纪|金融|资产管理'
and t1.act_sts_cd <> 'C' 	--剔除销户
;
-- 3、全面禁止使用行业字样：金控；财富管理、财富投资管理；网贷、网络借贷、P2P
DROP   TABLE IF     EXISTS SJXQ_SJ20250606116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250606116_CST_03 AS
SELECT  distinct t1.cst_id AS 客户号
       ,t1.act_nm          AS 账户名称
	   ,t5.brc_org_nm 	   as 开户分行
       ,t3.prm_mgr_id      AS 主管护客户经理工号
       ,t3.prm_mgr_nm      AS 主管护客户经理姓名
       ,t3.prm_org_id      AS 主管护机构号
       ,t3.prm_org_nm      AS 主管户机构名称
       ,t4.brc_org_nm      AS 主管户分行
       ,t4.sbr_org_nm      AS 主管户支行
       ,t4.tem_org_nm      AS 主管户团队
from edw.dim_bus_dep_act_inf_dd             t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
and t2.cst_typ_cd='2'   --对公
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250606'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250606'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t1.opn_org = t5.org_id
and t5.dt = t1.dt
-- and t5.brc_org_nm regexp '龙海'
where t1.dt='20250606'
and concat(t1.act_nm,t2.cst_chn_nm) regexp '金控|财富管理|财富投资管理|网贷|网络借贷|P2P'
and t1.act_sts_cd <> 'C' 	--剔除销户
;
-- 4、其他行业字样：如助贷、转贷、金服、担保等。
DROP   TABLE IF     EXISTS SJXQ_SJ20250606116_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250606116_CST_04 AS
SELECT  distinct t1.cst_id AS 客户号
       ,t1.act_nm          AS 账户名称
	   ,t5.brc_org_nm 	   as 开户分行
       ,t3.prm_mgr_id      AS 主管护客户经理工号
       ,t3.prm_mgr_nm      AS 主管护客户经理姓名
       ,t3.prm_org_id      AS 主管护机构号
       ,t3.prm_org_nm      AS 主管户机构名称
       ,t4.brc_org_nm      AS 主管户分行
       ,t4.sbr_org_nm      AS 主管户支行
       ,t4.tem_org_nm      AS 主管户团队
from edw.dim_bus_dep_act_inf_dd             t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
and t2.cst_typ_cd='2'   --对公
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250606'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250606'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t1.opn_org = t5.org_id
and t5.dt = t1.dt
-- and t5.brc_org_nm regexp '龙海'
where t1.dt='20250606'
and concat(t1.act_nm,t2.cst_chn_nm) regexp '助贷|转贷|金服|担保'
and t1.act_sts_cd <> 'C' 	--剔除销户
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250606116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250606116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250606116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250606116_CST_04
;
SElECT '01' seq, *
from SJXQ_SJ20250606116_CST_04
***SJ2025080801_泰e贷调查信息.sql
-- SJ2025080801_泰e贷调查信息
-- 客户
DROP   TABLE IF EXISTS SJXQ_SJ2025080801_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025080801_CST_01
(
    seq     string COMMENT ''
    ,cst_id      string COMMENT ''
)
;
insert into SJXQ_SJ2025080801_CST_01
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025080801_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080801_CST_02 AS
SELECT  t1.seq                     AS 序号
       ,t1.svy_rcd_serno           AS 调查记录流水号
       ,t1.svy_mod_cd              AS 调查方式代码
       ,t1.调查方式
       ,t1.svy_dt                  AS 调查日期
       ,t1.cst_id                  AS 客户号
       ,t1.cst_nm                  AS 客户名称
       ,t1.cst_rol_cd              AS 客户角色代码
       ,t1.adiv                    AS 行政区划
       ,t1.svy_addr                AS 调查地址
       ,t1.svy_addr_typ_cd         AS 调查地址类型代码
       ,t1.调查地址类型
       ,t1.pcp_mnl_no              AS 参与人工号
       ,t1.pcp_psn_nm              AS 参与人姓名
       ,t1.svy_ctnt_and_rslt       AS 调查内容及结果
       ,t1.rmk                     AS 备注
       ,t1.lct_nd_mid_grd_audt_ind AS 定位需中台审核标志
       ,t1.pht_mid_grd_audt_rslt   AS 照片中台审核结果
       ,t1.sys_reg_tm              AS 系统登记时间
       ,t2.pht_tm                  AS 照片时间
       ,t2.pht_addr                AS 照片地址
       ,t2.svy_pht_typ             AS 调查照片类型
from(
    SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
        ,t1.svy_mod_cd               --调查方式代码|C2
        ,c1.cd_val_dscr          as 调查方式 --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
        ,t1.svy_dt                   --调查日期|C8
        ,t1.cst_id                   --客户号|C20
        ,t1.cst_nm                   --客户名称|C200
        ,t1.cst_rol_cd               --客户角色代码|C2
        ,t1.adiv                     --行政区划|C12
        ,t1.svy_addr                 --调查地址
        ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
        ,c2.cd_val_dscr          as 调查地址类型
        ,t1.pcp_mnl_no               --参与人工号|C20
        ,t1.pcp_psn_nm               --参与人姓名|C200
        ,t1.svy_ctnt_and_rslt        --调查内容及结果|C4000
        ,t1.rmk                      --备注|c4000
        ,t1.lct_nd_mid_grd_audt_ind  --定位需中台审核标志|C1
        ,t1.pht_mid_grd_audt_rslt                    --照片中台审核结果|C256
        ,t1.sys_reg_tm
        ,t2.seq
        ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
    from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
    inner join SJXQ_SJ2025080801_CST_01     t2
    on t1.cst_id=t2.cst_id
    LEFT JOIN    EDW.dwd_code_library_dd  c1
    ON      T1.SVY_MOD_CD = c1.CD_VAL
    AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
    AND     c1.FLD_NM = 'SVY_MOD_CD'
    and     c1.dt=t1.dt
    LEFT JOIN    EDW.dwd_code_library_dd  c2
    ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
    AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
    AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
    and     c2.dt=t1.dt
    where t1.dt='20250731'
)t1 left join edw.loan_svy_rcd_rel_pht_inf t2
on t1.svy_rcd_serno=t2.svy_rcd_serno
and t2.dt='20250731'
where t1.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080801_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025080801_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025080801_CST_02
***丁乙秦_SJ2025032596_合同信息老信贷.sql
﻿-- 2023年&mdash;&mdash;2024年新系统上线前，提交至分行审批的业务
-- （老系统数据无法导出，老系统查询路径：快速统计查询&mdash;&mdash;申请信息查询）
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_01 AS
SELECT  t1.ctr_serno        --合同流水号
    ,t1.rel_serno        --用信申请流水号
    ,t1.usc_aply_dt	     --用信申请日期|c8
    ,t1.cst_id           --客户号|C20
    ,t1.cst_nm           --客户名称|C200
    ,t1.prd_no
    ,t2.PD_NM
    ,t1.ctr_amt          --合同金额DECIMAL(21,2)
    ,t1.ctr_bal          --合同余额DECIMAL(21,2)
    ,t1.ctr_bgn_dt       --合同起始日期
    ,t1.ctr_mtu_dt       --合同到期日期
    ,t1.TMT_DT           --终结日期
    ,t1.CTR_STS_CD
    ,decode(t1.CTR_STS_CD,'1','未生效','2','已生效','3','终止','4','冻结','5','作废','') as CTR_STS_nm
    ,t1.ref_intr_rat     --参考利率DECIMAL(13,2)
    ,t1.exec_intr_rat    --执行利率DECIMAL(13,7)
    ,t1.hpn_typ_cd       --发生类型代码|c6
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as hpn_typ_nm
    ,t1.facl_trm         --授信期限|bigint
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr bsn_mark_nm --业务标识
    ,case when t1.bsn_mark_cd='03' then '是' ELSE '否' end as 预保预报标识
    ,t1.sys_reg_psn_id          --系统登记人编号|c20
    ,t3.empe_nm     as sys_reg_psn_nm
    ,t1.sys_reg_org_id          --系统登记机构号|c20
    ,t6.org_nm  as sys_reg_org_nm
    ,t1.SYS_REG_DT              --系统登记日期 经办日期
    ,t1.cst_src_chnl_cd         --客户来源渠道代码|c3
    ,c2.cd_val_dscr     as cst_src_chnl_nm
    ,t1.hdl_org_id              --经办机构编号|c10
    ,t1.hdl_opr_id              --经办人工号
    ,t5.empe_nm AS hdl_opr_nm   --经办人
    ,t4.org_nm  as hdl_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.PD_NM not regexp '信用卡'
and t2.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.sys_reg_psn_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.hdl_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = t1.dt
left join edw.dwd_code_library_dd           c2
on t1.cst_src_chnl_cd = c2.cd_val
and c2.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t1.sys_reg_org_id = t6.org_id
and t6.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
and t4.brc_org_nm='台州分行'
and (t1.usc_aply_dt>='20230101' or t1.SYS_REG_DT>='20230101' or t1.ctr_bgn_dt>='20230101')
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_02 AS
select t2.ctr_serno                              --合同流水号
	,t1.ctr_yr_intr_rate                         --合同年利率
	,t1.ref_yr_intr_rate                         --参考年利率
	,t1.is_ctr_valid                             --合同是否有效
	,t1.bsn_type_cd                              --业务品种     pd_nm
	,t1.bsn_lable_cd                             --业务标签     BUSINESSTAG
	,t1.apl_chnl_cd                              --申请渠道
    ,c1.cd_val_dscr     as apl_chnl_nm
	,t1.is_prdt                                  --是否预保预报
from adm_rsk.adm_rsk_ast_loan_ctr_inf_dd    t1     --风险集市合同基本信息模型表
inner join SJXQ_SJ2025032596_CST_01         t2
on t1.ctr_srl_no=t2.ctr_serno
left join edw.dwd_code_library_dd           c1
on t1.apl_chnl_cd = c1.cd_val
and c1.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
;
-- 审批 新信贷
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_03 AS
SELECT  t3.rel_serno          --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.cst_typ_cd         --客户类型代码
       ,t1.prd_no             --产品编号
       ,t1.pd_nm              --产品名称
       ,t1.hpn_typ_cd         --发生类型代码
       ,t1.apl_amt            --申请金额
       ,t1.aply_epsr_amt      --申请敞口金额
       ,t1.grnt_mod_colc_cd   --担保方式集合代码
       ,t1.apl_dt             --申请日期
       ,t1.rmk                --备注
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_org_id         --管户机构编号
       ,t1.exec_intr_rat      --执行利率
       ,t4.instance_id
       ,t4.flow_starter       --流程发起者
       ,t4.flow_starter_name  --发起者姓名
       ,t4.start_time         --流程发起时间
       ,t4.org_id             --发起人机构id
       ,t4.biz_id             --业务流水号
       ,t5.back_cnt           --流程退回次数
       ,t6.empe_id            as 最终审批人工号
       ,t6.empe_nm            as 最终审批人姓名
       ,t6.node_nm            as 最终审批人岗位
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
inner join(
    SELECT DISTINCT rel_serno
    from SJXQ_SJ2025032596_CST_01
)t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join (
    SELECT t4.instance_id
        ,t4.flow_starter              --流程发起者
       ,t4.flow_starter_name          --发起者姓名
       ,t4.start_time                 --流程发起时间
       ,t4.org_id                     --发起人机构id
       ,t4.biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by t4.biz_id order by t4.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where t4.dt='@@{yyyyMMdd}'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t4.rn=1
left join(
    select instance_id
        ,sum(case when user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd
    where dt='@@{yyyyMMdd}'
    group by instance_id
)t5 on t4.instance_id=t5.instance_id
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
where t1.dt='@@{yyyyMMdd}'
;
-- 审批流程 新信贷
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_04 AS
SELECT t4.instance_id
        ,t5.user_id         --用户id
        ,t6.empe_nm         --审批人名称
        ,t5.node_nm         --审批节点
        ,t5.start_time	    --审批时间
        ,t5.user_comment	--用户评价
        -- ,ROW_NUMBER() over(partition by t4.instance_id,t5.node_nm order by t5.start_time desc) rn
        ,ROW_NUMBER() over(partition by t4.instance_id order by t5.start_time asc) rn
from (
    SELECT DISTINCT instance_id
    from SJXQ_SJ2025032596_CST_03
)t4
INNER JOIN edw.dwd_bus_loan_n_wf_comment_his_dd t5 --流程审批意见历史
on  t4.instance_id=t5.instance_id
and t5.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                t6 --员工信息汇总
on  substr(t5.user_id,1,6)=t6.empe_id
and t6.dt='@@{yyyyMMdd}'
;
-- 审批流程 老信贷
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_05 AS
select T1.aprv_srl_nbr                             --审批流水号|C32
	,T1.obj_id                                   --对象编号|C32
	,T1.obj_typ                                  --对象类型|C18
	,T1.prcs_id                                  --流程编号|C32
	,T1.prcs_nm                                  --流程名称|C80
	,T1.stg_id                                   --阶段编号|C32
	,T1.stg_nm                                   --阶段名称 角色
	,T1.stg_typ                                  --阶段类型|C18
    ,DECODE(t1.stg_typ,'1010','发起阶段','1020','审批阶段','1030','退回补充资料阶段','1040','批准阶段','1050','否决阶段','') as 阶段类型
	,T1.apl_typ_cd                               --申请类型代码|C18
	,T1.opr_id                                   --经办人编号|C10
	,T1.opr_nm                                   --经办人姓名|C100
	,T1.hdl_org_id                               --经办机构编号|C12
	,T1.hdl_org_nm                               --经办机构名称|C80
	,T1.orig_exe_tm                              --开始执行时间|C20
	,T1.cpl_exe_tm                               --完成执行时间|C20
	,T1.stg_opnn                                 --阶段意见|c80
	,T1.stg_actn                                 --阶段动作|C250
	,T1.det_the_comm
	,T1.cprh_opnn
    ,t5.POS_NM          as 审批人岗位
    ,case when substr(t5.POS_NM,1,2)='总行' then '总行'
        when substr(t5.POS_NM,1,2)='分行' then '分行'
        when substr(t5.POS_NM,1,2)='支行' then '支行'
        when substr(t5.POS_NM,1,4)='业务团队' then '团队'
        else '其他' end as 审批层级
    ,ROW_NUMBER() OVER ( PARTITION BY T1.obj_id ORDER BY T1.aprv_srl_nbr DESC) AS RN
    ,ROW_NUMBER() OVER ( PARTITION BY T1.obj_id ORDER BY T1.aprv_srl_nbr aSC) AS RN_asc
from edw.dwd_bus_loan_aprv_inf_dd  t1           --信贷审批信息
inner join(
    SELECT DISTINCT rel_serno
    from SJXQ_SJ2025032596_CST_01
)t3 --合同基础信息
on t1.obj_id=t3.rel_serno
left join edw.dws_hr_empe_inf_dd    t4
on  substr(t1.opr_id,1,6)=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN edw.DIM_HR_ORG_JOB_INF_DD t5 --职位信息
ON      t4.POS_ENC = t5.POS_ID
AND     t5.DT = '@@{yyyyMMdd}'
where T1.dt='20240719'
AND T1.opr_id <> 'system'
and T1.hdl_org_id LIKE '3301%'    --台州分行
and replace(substr(t1.orig_exe_tm,1,10),'/','') >='20230101'
AND T1.obj_typ IN ( 'CreditApply' , 'CycleCardConApply' )
;
-- -- 审批流程 老信贷 没权限
-- DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_06 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_06 AS
-- select t1.serialno                                 --流水号 max(ft.serialno)
-- 	,t1.objectno                                 --对象编号 rel_serno
--     ,t1.objecttype
-- 	,t1.flowno                                   --流程编号
-- 	,t1.flowname                                 --流程名称
-- 	,t1.phaseno                                  --阶段编号
-- 	,t1.phasename                                --阶段名称  角色 客户经理|部门总经理|支行行长
-- 	,t1.phasetype                                --阶段类型
-- 	,t1.applytype                                --申请类型
-- 	,t1.userid                                   --承办人编号
-- 	,t1.username                                 --承办人姓名
-- 	,t1.orgid                                    --承办机构编号
-- 	,t1.orgname                                  --承办机构名称
-- 	,t1.begintime                                --开始执行时间
-- 	,t1.endtime                                  --完成执行时间
-- 	,t1.phasechoice                              --阶段意见
-- 	,t1.phaseaction                              --阶段动作
-- 	,t1.processtaskno                            --
--     ,t5.POS_NM          最终审批人岗位
--     ,case when substr(t5.POS_NM,1,2)='总行' then '总行'
--         when substr(t5.POS_NM,1,2)='分行' then '分行'
--         when substr(t5.POS_NM,1,2)='支行' then '支行'
--         when substr(t5.POS_NM,1,4)='业务团队' then '团队'
--         else '其他' end as 最终审批层级
--     ,ROW_NUMBER()over(partition by t1.objectno order by t1.endtime desc) as rn
-- from edw.loan_flow_task             t1                 --流程任务
-- inner join(
--     SELECT DISTINCT rel_serno
--     from SJXQ_SJ2025032596_CST_01
-- )t3 --合同基础信息
-- on t1.objectno=t3.rel_serno
-- left join edw.dws_hr_empe_inf_dd    t4
-- on  substr(t1.userid,1,6)=t4.empe_id
-- and t4.dt='@@{yyyyMMdd}'
-- LEFT JOIN edw.DIM_HR_ORG_JOB_INF_DD t5 --职位信息
-- ON      t4.POS_ENC = t5.POS_ID
-- AND     t5.DT = '@@{yyyyMMdd}'
-- where t1.dt='20240719'
-- and t1.userid <> 'system'
-- 	'CreditAdjustApply','CycleCardConApply','QuaUpApply')
-- -- AND t1.phasetype = '1020'
-- AND t1.orgid LIKE '3301%'    --台州分行
-- ;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_07 AS
SELECT  t1.ctr_serno     AS 合同流水号
    ,t1.rel_serno        AS 用信申请流水号
    ,t1.usc_aply_dt      AS 用信申请日期
    ,t1.cst_id           AS 客户号
    ,t1.cst_nm           AS 客户名称
    ,t1.PD_NM            AS 业务品种
    ,t1.ctr_amt          AS 合同金额
    ,t1.ctr_bal          AS 合同余额
    ,t1.ctr_bgn_dt       AS 合同起始日期
    ,t1.ctr_mtu_dt       AS 合同到期日期
    ,t1.TMT_DT           AS 终结日期
    ,t1.CTR_STS_nm       AS 合同状态
    ,t1.ref_intr_rat     AS 参考利率
    ,t1.exec_intr_rat    AS 执行利率
    ,t2.ctr_yr_intr_rate AS 合同年利率
    ,t2.ref_yr_intr_rate AS 参考年利率
    ,t1.hpn_typ_nm       AS 发生类型
    ,t1.facl_trm         AS 授信期限
    ,t1.bsn_mark_nm      AS 业务标识
    ,t1.预保预报标识
    ,t1.sys_reg_psn_nm   AS 系统登记人
    ,t1.sys_reg_org_nm   AS 系统登记机构
    ,t1.SYS_REG_DT       AS 系统登记日期_经办日期
    ,t1.cst_src_chnl_nm  AS 客户来源渠道
    ,COALESCE(t2.apl_chnl_nm,t2.apl_chnl_cd) AS 申请渠道
    ,t1.hdl_org_nm       AS 经办机构
    ,t1.hdl_opr_nm       AS 经办人
	,t2.bsn_lable_cd     as 业务标签
    ,t3.back_cnt         as 流程退回次数
    ,t3.最终审批人姓名
    ,t3.最终审批人岗位
    ,t3.各审批节点岗位及姓名
from SJXQ_SJ2025032596_CST_01       t1
left join SJXQ_SJ2025032596_CST_02  t2
on t1.ctr_serno=t2.ctr_serno
inner join(
    SELECT t1.rel_serno
        ,t1.最终审批人姓名
        ,t1.最终审批人岗位
        ,t2.各审批节点岗位及姓名
        ,t2.back_cnt
    from SJXQ_SJ2025032596_CST_03 t1
    left join(
        SELECT instance_id
            ,sum(case when user_comment regexp '退回' then 1 else 0 end) as back_cnt
        from SJXQ_SJ2025032596_CST_04
        GROUP BY instance_id
    ) t2 on t1.instance_id=t2.instance_id
    union all
    SELECT t1.obj_id
        ,T1.opr_nm                                   --经办人姓名|C100
        ,T1.stg_nm                                   --阶段名称 角色
        ,t2.各审批节点岗位及姓名
        ,t2.back_cnt
    from SJXQ_SJ2025032596_CST_05 t1
    left join(
        SELECT obj_id
            ,sum(case when det_the_comm ='退回补充资料' then 1 else 0 end) as back_cnt
        from SJXQ_SJ2025032596_CST_05
        GROUP BY obj_id
    )t2 on t1.obj_id=t2.obj_id
    where t1.rn=1
) t3 on t1.rel_serno=t3.rel_serno
;
SElECT '07' seq, *
from SJXQ_SJ2025032596_CST_07
where 用信申请日期<='20240719'
;
SElECT '01' seq, count(1) cnt,count(distinct rel_serno) custs
from SJXQ_SJ2025032596_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032596_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct rel_serno) custs
from SJXQ_SJ2025032596_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ2025032596_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct obj_id) custs
from SJXQ_SJ2025032596_CST_05
-- union all
-- SElECT '06' seq, count(1) cnt,count(distinct instance_id) custs
-- from SJXQ_SJ2025032596_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025032596_CST_07
;
/*
01	304574	304560
02	304574	304574
03	88426	88426
04	443773	86843
05	856351	195701
07	283692	283692
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2025032596_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032596_CST_08 AS
SElECT t1.*
from SJXQ_SJ2025032596_CST_01 t1
left join SJXQ_SJ2025032596_CST_07 t2 on t1.ctr_serno=t2.合同流水号
where t2.合同流水号 is null
;
SELECT pd_nm,count(1) cnt
from SJXQ_SJ2025032596_CST_08
GROUP BY pd_nm
order by cnt desc
***丁乙秦_SJ2025042876_分行普惠业务审批量.sql
﻿-- 2024年11月&mdash;2025年03月低，台州分行到普惠金融部审批的业务
--当前合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025042876_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042876_CST_01 AS
select t1.ctr_serno                 --合同流水号
	,t1.cst_id                      --客户号
	,t1.cst_nm                      --客户名称
    ,t1.rel_serno	                --用信申请流水号
	,t1.ctr_amt                     --合同金额
	,t1.ctr_bal                     --合同余额
	,t1.ctr_bgn_dt                  --合同起始日期
	,t1.ctr_mtu_dt                  --合同到期日期
    ,t1.mgr_org_id	                --管户机构号
    ,t1.hdl_org_id	                --经办机构编号|c10
    ,t1.hdl_opr_id	                --经办客户经理工号
    ,t2.PD_NM           as 产品名称
    ,t2.prm_bus_bred_ctg	        --主业务品种分类
    ,c1.cd_val_dscr     as 主业务品种分类_业务类型
    ,t3.DBIL_IDs        as 借据编号
    ,t5.empe_nm         as 经办客户经理
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_code_library_dd           c1
on t2.PRM_BUS_BRED_CTG = c1.cd_val
and c1.dt = t1.dt
left join(
    from edw.dim_bus_loan_dbil_inf_dd
    where dt='@@{yyyyMMdd}'
    group by ctr_serno
)t3 on t1.ctr_serno=t3.ctr_serno
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.hdl_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='台州分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
;
-- 审批
DROP   TABLE IF     EXISTS SJXQ_SJ2025042876_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042876_CST_02 AS
select t1.ctr_serno
    ,t1.rel_serno	    --用信申请流水号
    ,t1.hdl_org_id	    --经办机构编号|c10
	,t2.ahn_ltr_aply_serno
    ,t5.biz_id
    ,t5.instance_id
    ,t5.flow_id                                  --流程id|c32
    ,t5.flow_name                                --流程名称|c100
	,t5.start_time              --流程发起时间
	,t5.end_time				--流程结束时间
    ,t6.aprv_id           AS 分行普惠部信审岗工号
    ,t6.aprv_nm           AS 分行普惠部信审岗姓名
    ,t6.fst_aprv_time   as 分行普惠部信审岗审批时间
    ,t7.flow_param
    ,SPLIT(COALESCE(replace(t7.flow_param,'-2024-','-2025-'), '[]'), '-2025-') AS ARR1
from SJXQ_SJ2025042876_CST_01                t1
inner join edw.dwd_bus_loan_lmt_aply_biz_dd  t2 --用信方案
on t2.USC_APLY_SERNO=t1.rel_serno
and t2.dt='@@{yyyyMMdd}'
inner join (
    SELECT instance_id
		,flow_starter               --流程发起者
		,flow_starter_name          --发起者姓名
		,start_time                 --流程发起时间
		,end_time					--流程结束时间
		,org_id                     --发起人机构id
		,biz_id                     --业务流水号
        ,flow_id                    --流程id|c32
        ,flow_name                  --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='@@{yyyyMMdd}'
    -- and flow_id='195' 	--授用信申请流程
)t5 on t2.ahn_ltr_aply_serno=t5.biz_id
and t2.sys_reg_psn_id=t5.flow_starter
and t5.rn=1
inner join(
    SELECT t1.instance_id
        ,min(t1.start_time) as fst_aprv_time
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='分行普惠金融部授信审查岗'
    and substr(replace(t1.start_time,'-',''),1,8) between '20241101' and '20250331'
    GROUP BY instance_id
)t6 on t5.instance_id=t6.instance_id
left join(
    SELECT instance_id,flow_param
    from edw.loan_n_wf_instance     --没权限
    where dt='@@{yyyyMMdd}'
    union
    SELECT instance_id,flow_param   --没权限
    from edw.loan_n_wf_instance_his
    where dt='@@{yyyyMMdd}'
)t7 on t5.instance_id=t7.instance_id
;
-- 审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ2025042876_CST_02_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042876_CST_02_1 as
SELECT t1.*
    ,ROW_NUMBER() over(partition by t1.instance_id order by t1.start_time asc) rn_asc
from(
    SELECT t4.instance_id
        ,t4.flow_id                                  --流程id|c32
        ,t4.flow_name                                --流程名称|c100
        ,t5.user_id         --用户id
        ,t6.empe_nm         --审批人名称
        ,t5.node_nm         --审批节点
        ,t5.start_time	    --审批时间
        ,t5.user_comment	--用户评价
        ,ROW_NUMBER() over(partition by t4.instance_id,t5.node_nm order by t5.start_time desc) rn
    from SJXQ_SJ2025042876_CST_02                   t4
    INNER JOIN edw.dwd_bus_loan_n_wf_comment_his_dd t5 --流程审批意见历史
    on  t4.instance_id=t5.instance_id
    and t5.dt='@@{yyyyMMdd}'
    and t5.node_nm = '分行普惠金融部授信审查岗'
    left join edw.dws_hr_empe_inf_dd                t6 --员工信息汇总
    on  substr(t5.user_id,1,6)=t6.empe_id
    and t6.dt='@@{yyyyMMdd}'
)t1 where t1.rn=1   --最后审批流
;
--处理json:获取岗位为支行行长的最新一笔审批信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025042876_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042876_CST_03 AS
SELECT  t.*
       ,SPLIT(COALESCE(t.ARR,'[]'),'&quot;outputParam&quot;:') AS ARR_2
FROM
(
	SELECT  biz_id
	       ,substr(ARR,instr(ARR,'isApprove')+12,1) 最终授权审批结果
	       ,CONCAT(ARR,'}') ARR
	FROM SJXQ_SJ2025042876_CST_02 LATERAL VIEW EXPLODE(ARR1) TMP_TBL1 AS ARR
	WHERE ARR REGEXP '&quot;4105&quot;|&quot;4001&quot;'
	AND ARR REGEXP 'outputParam'
)t
WHERE t.rn = 1
;
--解析授权类型和日志，多条合并一行
DROP   TABLE IF     EXISTS SJXQ_SJ2025042876_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042876_CST_04 AS
SELECT  t.biz_id
-- , t.支行行长最终授权审批结果
       ,t.支行行长审批时间
FROM
(
	SELECT  biz_id
	-- , 最终授权审批结果 支行行长最终授权审批结果
	       ,支行行长审批时间
	       ,GET_JSON_OBJECT(ARR_3,'$.OUT_利率授权结果变量') 利率授权结果
	       ,GET_JSON_OBJECT(ARR_3,'$.OUT_利率授权日志') 利率授权日志
	       ,GET_JSON_OBJECT(ARR_3,'$.OUT_人员授权结果') 人员授权结果
	       ,GET_JSON_OBJECT(ARR_3,'$.OUT_人员授权日志') 人员授权日志
	       ,GET_JSON_OBJECT(ARR_3,'$.OUT_业务是否有权审批') 业务是否有权审批
	       ,GET_JSON_OBJECT(ARR_3,'$.规则描述') 规则描述
	FROM SJXQ_SJ2025042876_CST_03 LATERAL VIEW EXPLODE(ARR_2) TMP_TBL1 AS ARR_3
)t
GROUP BY  t.biz_id
-- , t.支行行长最终授权审批结果
         ,t.支行行长审批时间
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025042876_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042876_CST_05 AS
SELECT  t1.cst_id
       ,t1.cst_nm     AS 客户名称
       ,t1.ctr_serno  AS 合同流水号
       ,t1.借据编号
       ,t1.ctr_bgn_dt AS 合同起始日期
       ,t1.ctr_mtu_dt AS 合同到期日期
       ,t1.hdl_opr_id AS 经办客户经理工号
       ,t1.经办客户经理
       ,t1.tem_org_nm AS 经办团队
       ,t1.sbr_org_nm AS 经办支行
       ,t1.产品名称
       ,t1.主业务品种分类_业务类型
       ,t2.分行普惠部信审岗工号
       ,t2.分行普惠部信审岗姓名
       ,t2.分行普惠部信审岗审批时间
       ,t3.利率授权结果
       ,t3.利率授权日志
       ,t3.人员授权结果
       ,t3.人员授权日志
       ,t3.业务是否有权审批
       ,t3.业务规则描述
from SJXQ_SJ2025042876_CST_01       t1
inner join SJXQ_SJ2025042876_CST_02 t2
on  t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ2025042876_CST_04  t3
on t2.biz_id=t3.biz_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042876_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042876_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct biz_id) custs
from SJXQ_SJ2025042876_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct biz_id) custs
from SJXQ_SJ2025042876_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025042876_CST_05
;
/*
01	68965	68965
02	68965	68965
*/
***丁乙秦_SJ2025042911_贷后变更.sql
﻿-- 2024年11月&mdash;&mdash;2025年4月，台州分行发生过贷后变更的业务的具体情况分析
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025042911_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042911_CST_01 AS
SELECT  col_1  --流程实例号
       ,col_2  --业务流水号
       ,col_3  --流程类型
       ,col_4  --客户名称
       ,col_5  --客户号
       ,col_6  --当前审批人名称
       ,col_7  --当前审批人工号
       ,col_8  --当前审批节点
       ,col_9  --流程发起人名称
       ,col_10 --流程发起人工号
       ,col_11 --流程上一处理人名称
       ,col_12 --上一审批节点
       ,col_13 --审批状态
       ,col_14 --流程状态
       ,col_15 --流程发起时间
       ,col_16 --流程完成时间
from lab_bigdata_dev.qbi_file_20250429_14_57_37_0
where pt<>''
;
-- 合同流水号、贷后变更业务流水号、变更类型（利率变更）
DROP   TABLE IF     EXISTS SJXQ_SJ2025042911_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042911_CST_02 AS
SELECT  t1.mdf_serno             --变更流水号
       ,t1.ctr_serno             --合同流水号
       ,t1.dbil_no               --借据编号
       ,t1.pst_loan_mdf_typ_colc --贷后变更类型集合
	   ,case when t1.pst_loan_mdf_typ_colc regexp '01' then '是' else '否' end as 是否利率变更
       ,t1.cst_id                --客户号
       ,t1.cst_nm                --客户名称
       ,t1.prd_no                --产品编号
       ,t1.mdf_rsn_dscr          --变更原因描述
       ,t1.aprv_sts              --审批状态
       ,t1.tsk_sts               --任务状态
       ,t2.col_1    as instance_id
from edw.loan_psp_dbil_mdf_rcd 			t1
inner join SJXQ_SJ2025042911_CST_01  	t2
on t1.mdf_serno=t2.col_2
where t1.dt='@@{yyyyMMdd}'
-- and t1.del_ind='0' --删除标识
;
-- 贷后变更类型集合
-- ,'01','利率变更','02','优惠方案变更','03','还款信息变更','04','账户信息变更','05','期限变更','06','金额变更'
-- ,'07','冻结方式变更','08','适用产品变更','09','贸易融资功能变更','10','保函变更','11','信用证变更','12','还款自动止付变更'
DROP   TABLE IF     EXISTS SJXQ_SJ2025042911_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042911_CST_03 AS
SELECT  a.mdf_serno
       ,a.pst_loan_mdf_typ_colc
FROM
(
	SELECT  mdf_serno
	       ,pst_loan_mdf_typ_colc
	       ,decode(pst_loan_mdf_typ_colc2,'01','利率变更','02','优惠方案变更','03','还款信息变更','04','账户信息变更','05','期限变更'
            ,'06','金额变更','07','冻结方式变更','08','适用产品变更','09','贸易融资功能变更','10','保函变更','11','信用证变更','12','还款自动止付变更') as pst_loan_mdf_typ_colc2
	FROM SJXQ_SJ2025042911_CST_02 LATERAL VIEW explode(split(pst_loan_mdf_typ_colc, ',')) pst_loan_mdf_typ_colc as pst_loan_mdf_typ_colc2
	WHERE nvl(pst_loan_mdf_typ_colc,'')<>''
) a
GROUP BY  a.mdf_serno
         ,a.pst_loan_mdf_typ_colc
;
-- 合同流水号、业务发起时间、业务审批结束时间、最终审批人、经办团队、经办支行
DROP   TABLE IF     EXISTS SJXQ_SJ2025042911_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042911_CST_04 AS
select t1.ctr_serno
    ,t1.rel_serno	                             as 用信申请流水号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t2.mdf_serno
    ,p1.pd_nm
	,t4.sbr_org_nm,t4.tem_org_nm
	,t3.ahn_ltr_aply_serno
    ,t5.instance_id
	,t5.start_time              --流程发起时间
	,t5.end_time				--流程结束时间
	,t6.empe_id            AS 最终审批人工号
	,t6.empe_nm            AS 最终审批人姓名
from edw.dim_bus_loan_ctr_bse_inf_dd    t1 --合同基础信息
inner join SJXQ_SJ2025042911_CST_02 	t2
on t1.ctr_serno=t2.ctr_serno
left join edw.dim_bus_loan_prd_frml_dd     p1
on t1.prd_no=p1.prd_no
and p1.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.hdl_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dwd_bus_loan_lmt_aply_biz_dd  t3 --用信方案
on t3.USC_APLY_SERNO=t1.rel_serno
and t3.dt=t1.dt
left join (
    SELECT instance_id
		,flow_starter               --流程发起者
		,flow_starter_name          --发起者姓名
		,start_time                 --流程发起时间
		,end_time					--流程结束时间
		,org_id                     --发起人机构id
		,biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by biz_id order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='@@{yyyyMMdd}'
)t5 on t3.ahn_ltr_aply_serno=t5.biz_id
and t5.rn=1
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t5.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
where t1.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025042911_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042911_CST_05 AS
SELECT  t1.col_1                    AS 流程实例号
       ,t1.col_2                    AS 业务流水号
       ,t1.col_3                    AS 流程类型
       ,t1.col_4                    AS 客户名称
       ,t1.col_5                    AS 客户号
       ,t1.col_6                    AS 当前审批人名称
       ,t1.col_7                    AS 当前审批人工号
       ,t1.col_8                    AS 当前审批节点
       ,t1.col_9                    AS 流程发起人名称
       ,t1.col_10                   AS 流程发起人工号
       ,t1.col_11                   AS 流程上一处理人名称
       ,t1.col_12                   AS 上一审批节点
       ,t1.col_13                   AS 审批状态
       ,t1.col_14                   AS 流程状态
       ,t1.col_15                   AS 流程发起时间
       ,t1.col_16                   AS 流程完成时间
       ,t2.mdf_serno                AS 变更流水号
       ,t2.ctr_serno                AS 合同流水号
       ,t3.pst_loan_mdf_typ_colc_nm AS 贷后变更类型集合
       ,t2.是否利率变更
       ,t4.sbr_org_nm               AS 经办支行
       ,t4.tem_org_nm               AS 经办团队
       ,t4.start_time               AS 业务审批发起时间
       ,t4.end_time                 AS 业务审批结束时间
       ,t4.最终审批人工号
       ,t4.最终审批人姓名
       ,t4.pd_nm
from SJXQ_SJ2025042911_CST_01 		t1
left join SJXQ_SJ2025042911_CST_02 	t2
on t2.mdf_serno=t1.col_2
left join SJXQ_SJ2025042911_CST_03 	t3
on t2.mdf_serno=t3.mdf_serno
left join SJXQ_SJ2025042911_CST_04 	t4
on t2.mdf_serno=t4.mdf_serno
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2025042911_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct mdf_serno) custs
from SJXQ_SJ2025042911_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct mdf_serno) custs
from SJXQ_SJ2025042911_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct mdf_serno) custs
from SJXQ_SJ2025042911_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025042911_CST_05
;
/*
01	856	856
02	856	856
03	589	589
04	856	856
05	856	856
*/
SELECT * FROM lab_sjxq.SJXQ_SJ2025042911_CST_05
***于新伟_SJ2025030751_嘉兴分行取现客户.sql
/*
2024年3月1日-2025年3月7日，嘉兴分行部分客户交易情况，具体见附件。
1. 借方指 D
2. 近一年 2020301-20250307
*/
-- 嘉兴分行交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025030751_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030751_CST_01 AS
SELECT  t1.dep_act_id
       ,t1.trx_dt          --交易日期|C8
       ,t1.trx_tm          --交易时间|C9
       ,t1.crd_and_dbt_ind --借贷标志|C1    C贷 D借
       ,t1.trx_ccy_cd      --交易币种代码|C3
       ,t1.trx_amt         --交易金额
       ,T1.trx_amt * T5.usd_exr  AS 折美元交易金额
       ,T1.trx_amt * T5.cny_exr  AS 折人民币交易金额
       ,t1.act_bal         --账户余额
       ,t1.cmt             --备注|C200
       ,t1.cst_act_id      --客户账号|C32
       ,t1.txt_code        --摘要代码|C10
       ,t1.smr_dscr        --摘要描述|C512
       ,t1.cnt_pty_act_nm  --对方户名|c200
       ,t1.agn_nm          --代理人姓名|C200
       ,t1.agn_doc_nbr     --代理人证件号码|C60
       ,t1.agn_psn_tel     --代理人电话|C16
       ,length(t1.agn_psn_tel) as agn_psn_tel_len
       ,t1.trx_chnl_cd     --交易渠道代码|C3
       ,t1.csh_ind         --现转标志|C1
       ,t1.trx_bus_org     --交易营业机构|C12
       ,t2.cst_id          --客户号|C20
    ,t3.prm_mgr_id,t3.prm_mgr_nm
    ,t4.brc_org_nm,t4.org_nm
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   t2 --存款账户信息汇总
on t1.dep_act_id=t2.dep_act_id
and t2.dt='20250312'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt = '20250312'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250312'
and t4.brc_org_nm = '嘉兴分行'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20240301' and '20250312'
where t1.dt>='20240301'
and t1.trx_dt between '20240301' and '20250312'
and t1.bal_fld_nm = 'DPLDGBAL' --动账
;
--客户贷方Credit 交易对手
DROP   TABLE IF     EXISTS SJXQ_SJ2025030751_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030751_CST_02 AS
select distinct cst_id,cnt_pty_act_nm
from SJXQ_SJ2025030751_CST_01
where crd_and_dbt_ind='C'
and nvl(cnt_pty_act_nm,'')<>''
;
-- 客户交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025030751_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030751_CST_03 AS
select t1.cst_id
    ,sum(case when t1.csh_ind='0' then t1.trx_amt else 0 end) as cst_csh_amt
    ,sum(case when crd_and_dbt_ind='D' then t1.trx_amt else 0 end) as cst_debit_amt
    ,count(distinct case when t1.csh_ind='0' and nvl(agn_nm,'')<>'' then t1.agn_nm end) as agn_nm_custs
    ,count(distinct case when t1.csh_ind='0' and nvl(t1.agn_nm,'')<>'' and nvl(t1.agn_psn_tel,'')<>'' then t1.agn_psn_tel end) as agn_psn_tel_num
    ,max(case when t2.cst_id is not null then 1 else 0 end) as agn_is_same_ds
    ,max(case when t3.agn_psn_tel is not null then 1 else 0 end) as is_agn_psn_tel_mul
from SJXQ_SJ2025030751_CST_01       t1
left join SJXQ_SJ2025030751_CST_02  t2
on t1.cst_id=t2.cst_id
and t1.agn_nm=t2.cnt_pty_act_nm
left join(
    select agn_psn_tel,count(distinct agn_nm) as custs
    from SJXQ_SJ2025030751_CST_01 t1
    where csh_ind='0'
    and nvl(agn_psn_tel,'')<>''
    and nvl(agn_nm,'')<>''
    group by agn_psn_tel having custs>1
)t3 on t1.agn_psn_tel=t3.agn_psn_tel
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030751_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030751_CST_04 AS
SELECT  t1.cst_id                                  AS 客户号
       ,t3.cst_chn_nm                              AS 客户姓名
       ,t2.prm_mgr_id                              AS 管户客户经理名称
       ,t2.prm_mgr_nm                              AS 管户客户经理工号
       ,t2.brc_org_nm                              AS 管户分行
       ,t2.org_nm                                  AS 管户机构名称
       ,t2.cst_act_id                              AS 客户账号
       ,t2.trx_dt                                  AS 交易日期
       ,t2.trx_tm                                  AS 交易时间
       ,t4.org_nm                                  AS 交易营业机构
       ,t2.trx_ccy_cd                              AS 交易币种代码
       ,t2.trx_amt                                 AS 交易金额
       ,T2.折人民币交易金额
       ,T2.折美元交易金额
       ,t2.act_bal                                 AS 账户余额
       ,decode(t2.crd_and_dbt_ind,'C','贷','D','借') AS 借贷标志 --C贷 D借
       ,decode(t2.csh_ind,'0','现','1','转')         AS 现转标志
       ,t2.cmt                                     AS 备注
       ,t2.agn_nm                                  AS 代理人姓名
       ,t2.agn_doc_nbr                             AS 代理人证件号码
       ,t2.agn_psn_tel                             AS 代理人电话
       ,t2.agn_psn_tel_len                         AS 代理人电话位数
       ,t2.smr_dscr                                AS 摘要描述
from SJXQ_SJ2025030751_CST_03       t1
inner join SJXQ_SJ2025030751_CST_01 t2
on t1.cst_id=t2.cst_id
and nvl(t2.agn_nm,'')<>''
left join edw.dws_cst_bas_inf_dd 	t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20250312'
left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
on  t2.trx_bus_org = t4.org_id
and t4.dt = '20250312'
where t1.cst_debit_amt>0
and t1.cst_csh_amt/t1.cst_debit_amt>=0.5
and t1.agn_nm_custs>=5
and t1.agn_psn_tel_num>=5
and t1.is_agn_psn_tel_mul=1
and t1.agn_is_same_ds=1
;
SElECT *
from SJXQ_SJ2025030751_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030751_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030751_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030751_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025030751_CST_04
;
***何卓诚_SJ2025061316_金华分行反洗钱.sql
-- 何卓诚_SJ2025061316_金华分行反洗钱
-- 单独取数含有外币账户的较高风险客户和高风险客户；所有外籍客户中被评为较高风险及高风险客户，截止6.12号金华分行最新数据
-- 洗钱风险评级等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025061316_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061316_CST_01 AS
SELECT cst_id
    ,decode(levelkey,'1004','较高风险','1005','高风险') as 风险等级
    ,ADJUST_REASON AS 调查结论_编辑岗处理意见
FROM
(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.levelkey
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    WHERE t1.dt = '20250612'
) t
WHERE t.levelkey IN ( '1004' , '1005' )
AND t.rn = 1
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025061316_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061316_CST_02 AS
SELECT  distinct t1.cst_id                      AS 客户号
       ,t2.cst_chn_nm                           AS 客户名称
       ,decode(t2.cst_typ_cd,'1','对私','2','对公') AS 客户类型
       ,t3.prm_org_id                           AS 主管护机构号
       ,t3.prm_org_nm                           AS 主管户机构名称
       ,t3.prm_mgr_id                           AS 主管护客户经理工号
       ,t3.prm_mgr_nm                           AS 主管护客户经理姓名
       ,t1.cst_act_id                           AS 外币和NRA账号
       ,t6.风险等级
       ,c1.cd_val_dscr                          AS 国籍
       ,t6.调查结论_编辑岗处理意见
FROM edw.dim_bus_dep_act_inf_dd  			t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '金华分行'
left join(
    select cst_id,ntn_cd                                   --国籍代码
    from edw.dim_cst_idv_bas_inf_dd              --个人客户基本信息
    where dt='20250612'
    union
    select cst_id,reg_cnr_cd                               --注册国家代码
    from edw.dim_cst_entp_bas_inf_dd  			--企业客户基本信息
    where dt='20250612'
)t5 on t1.cst_id=t5.cst_id
left join edw.dwd_code_library_dd   c1
on t5.ntn_cd = c1.cd_val
and c1.dt = t1.dt
inner join SJXQ_SJ2025061316_CST_01  t6
on t1.cst_id=t6.cst_id
where t1.dt='20250612'
and (t1.ccy_cd<>'156' or t1.cst_act_id like 'NRA%') --156:人民币元
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025061316_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061316_CST_03 AS
SELECT  distinct t1.cst_id                      AS 客户号
       ,t2.cst_chn_nm                           AS 客户名称
       ,decode(t2.cst_typ_cd,'1','对私','2','对公') AS 客户类型
       ,t3.prm_org_id                           AS 主管护机构号
       ,t3.prm_org_nm                           AS 主管户机构名称
       ,t3.prm_mgr_id                           AS 主管护客户经理工号
       ,t3.prm_mgr_nm                           AS 主管护客户经理姓名
       ,t1.cst_act_id                           AS 外币和NRA账号
       ,t6.风险等级
       ,c1.cd_val_dscr                          AS 国籍
       ,t6.调查结论_编辑岗处理意见
FROM edw.dim_bus_dep_act_inf_dd  			t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '金华分行'
inner join edw.dim_cst_idv_bas_inf_dd   t5 --个人客户基本信息 不含对公
on t1.cst_id=t5.cst_id
and t5.dt='20250612'
and t5.ntn_cd<>'156' --156:中华人民共和国
left join edw.dwd_code_library_dd   c1
on t5.ntn_cd = c1.cd_val
and c1.dt = t1.dt
inner join SJXQ_SJ2025061316_CST_01  t6
on t1.cst_id=t6.cst_id
where t1.dt='20250612'
and (t1.ccy_cd<>'156' or t1.cst_act_id like 'NRA%') --156:人民币元
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061316_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061316_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061316_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025061316_CST_03
;
***何卓诚_SJ2025062516_金华反洗钱工作分析.sql
-- 何卓诚_SJ2025062516_金华反洗钱工作分析
/*
国际业务部门反洗钱工作分析，截止20250531的金华分行最新数据
单独取数含有外币账户的较高风险客户和高风险客户，截止2025年6月20日，最新数据
数据需求字段
客户号、管护机构、管护客户经理，外币账号（字段中有显示其他币种）和NRA账户、2025年1月1日至2025年6月20日的被经侦、刑侦的外部监管查询、最新反洗钱调查结论
*/
-- 洗钱风险评级等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025062516_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062516_CST_01 AS
SELECT cst_id
    ,decode(levelkey,'1004','较高风险','1005','高风险') as 风险等级
    ,ADJUST_REASON AS 调查结论_编辑岗处理意见
    ,case when t2.party_id is not null then '是' else '' end as 是否2025年被经侦刑侦的外部监管查询
    ,t2.有权机关名称
    ,t2.机关名称及风险情况简述
FROM
(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.party_id
        ,t1.levelkey
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    WHERE t1.dt = '20250620'
) t1
left join(
    select party_id
    from app_fxq.T10_PARTY_RISK
    where dt between '20250101' and '20250620'
    group by party_id
)t2 on t1.party_id=t2.party_id
WHERE t1.levelkey IN ( '1004' , '1005' )
AND t1.rn = 1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025062516_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062516_CST_02 AS
SELECT  distinct t1.cst_id                      AS 客户号
       ,t2.cst_chn_nm                           AS 客户名称
       ,decode(t2.cst_typ_cd,'1','对私','2','对公') AS 客户类型
       ,t3.prm_org_id                           AS 主管护机构号
       ,t3.prm_org_nm                           AS 主管户机构名称
       ,t3.prm_mgr_id                           AS 主管护客户经理工号
       ,t3.prm_mgr_nm                           AS 主管护客户经理姓名
       ,t1.cst_act_id                           AS 外币和NRA账号
       ,t6.风险等级
       ,t6.是否2025年被经侦刑侦的外部监管查询
       ,t6.有权机关名称
       ,t6.机关名称及风险情况简述
       ,t6.调查结论_编辑岗处理意见
FROM edw.dim_bus_dep_act_inf_dd  			t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '金华分行'
inner join SJXQ_SJ2025062516_CST_01  t6     --风险客户
on t1.cst_id=t6.cst_id
where t1.dt='20250620'
and (t1.ccy_cd<>'156' or t1.cst_act_id like 'NRA%') --156:人民币元 NRA账户
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025062516_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025062516_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025062516_CST_02
;
***何卓诚_SJ20250701206_金华分行反洗钱数据.sql
-- 何卓诚_SJ20250701206_金华分行反洗钱数据
-- 从20230630至20250630的金华分行反洗钱数据
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ20250701206_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250701206_CST_01 AS
SELECT  cengcgjz      AS cst_act_id
       ,MAX(danciedu) AS fg_per_lmt
       ,MAX(leijiedu) AS fg_day_lmt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
group by cengcgjz
;
-- 洗钱风险评级等级
DROP   TABLE IF     EXISTS SJXQ_SJ20250701206_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250701206_CST_02 AS
SELECT cst_id
    ,decode(levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as 最终风险等级
    ,ADJUST_REASON  AS 调查结论_编辑岗处理意见
FROM
(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.party_id
        ,t1.levelkey
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    WHERE t1.dt = '20250620'
) t1 WHERE t1.rn = 1
;
-- 被外部监管查询5次及以上客群
DROP   TABLE IF     EXISTS SJXQ_SJ20250701206_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250701206_CST_03 AS
SELECT  t1.cst_id
       ,t1.外部监管查询次数
       ,t1.有权机关名称
       ,t1.机关名称及风险情况简述
       ,t3.prm_org_id --主管护机构号
       ,t3.prm_org_nm --主管户机构名称
       ,t3.prm_mgr_id --主管护客户经理工号
       ,t3.prm_mgr_nm --主管护客户经理姓名
       ,t4.sbr_org_nm --主管户支行
from(
    select substr(party_id,3,10) as cst_id
        ,count(distinct partyrisk_no)           as 外部监管查询次数
    from app_fxq.t10_party_risk                   --风险事件结果表
    where dt between '20230630' and '20250630'
    and replace(create_dt,'-','') between '20230630' and '20250630'     --创建日期
    group by cst_id having count(distinct partyrisk_no)>=5
)t1
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250630'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250630'
and t4.brc_org_nm = '金华分行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250701206_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250701206_CST_04 AS
SELECT  t1.cst_id as 客户号
       ,t1.sbr_org_nm  AS 主管户支行
       ,t1.prm_org_id  AS 主管护机构号
       ,t1.prm_org_nm  AS 主管户机构名称
       ,t1.prm_mgr_id  AS 主管护客户经理工号
       ,t1.prm_mgr_nm  AS 主管护客户经理姓名
       ,t1.外部监管查询次数
       ,t1.有权机关名称
       ,t1.机关名称及风险情况简述
       ,t2.最终风险等级
       ,t2.调查结论_编辑岗处理意见
       ,t3.cst_act_id  AS 客户账号
       ,c1.cd_val_dscr AS 账户状态
       ,t4.fg_per_lmt  AS 非柜单笔限额
       ,t4.fg_day_lmt  AS 非柜日累计限额
from SJXQ_SJ20250701206_CST_03          t1
left join SJXQ_SJ20250701206_CST_02     t2
on t1.cst_id=t2.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t3 --客户存款账户信息
on t1.cst_id=t3.cst_id
and t3.dt='20250630'
left join SJXQ_SJ20250701206_CST_01     t4
on t3.cst_act_id=t4.cst_act_id
left join edw.dwd_code_library_dd       c1
on t3.act_sts_cd = c1.cd_val
and c1.dt = '20250630'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20250701206_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250701206_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250701206_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250701206_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ20250701206_CST_04
;
***何卓诚_SJ2025080566_金华反洗钱客户.sql
﻿-- 何卓诚_SJ2025080566_金华反洗钱客户
-- 单独取数系统预警为较高风险和高风险客户，数据日期为2025年1月1日至2025年6月30日。
-- 洗钱风险评级等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025080566_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080566_CST_01 AS
SELECT t1.cst_id
    ,t1.party_chn_name
    ,t1.gsname
    ,decode(t1.fristappralevel,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as 初评等级
    ,decode(t1.levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as 最终风险等级
    ,t1.statistic_dt
    ,t1.ADJUST_REASON  AS 调查结论_编辑岗处理意见
    ,t3.prm_org_id --主管护机构号
    ,t3.prm_org_nm --主管户机构名称
    ,t3.prm_mgr_id --主管护客户经理工号
    ,t3.prm_mgr_nm --主管护客户经理姓名
    ,t4.sbr_org_nm --主管户支行
FROM
(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.party_chn_name                           --客户名称
        ,t1.party_id
        ,t1.levelkey
        ,t1.fristappralevel
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,t1.gskey	    --公式编号
        ,t3.gsname
        ,t1.dt
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.dt desc,t1.statistic_dt DESC) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    LEFT JOIN    adm_upss.aml_t31_def_gs        t3
    ON  t1.gskey = t3.gskey
    AND t3.dt = t1.dt
    WHERE t1.dt between '20250101' and '20250630'
) t1
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250630'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250630'
and t4.brc_org_nm = '金华分行'
WHERE t1.rn = 1
;
-- 本年度单个客户项下的所有反洗钱调查结论及调查人（剔除中台人员的调查结论）
DROP   TABLE IF     EXISTS SJXQ_SJ2025080566_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080566_CST_02 AS
select t1.check_no                                 --结论id
	,t1.check_type                               --识别类型 1.新开客户 2.持续客户识别 3,一次性交易 4 跨境汇兑 5.重新客户识别 6 其他情形
	,t1.party_id                                 --客户号
    ,t1.party_chn_name                           --客户名称
	,t1.check_dt                                 --调查日期
	,t1.check_result                             --调查结论
	,t1.check_explain                            --调查情况说明
	,t1.checker                                  --调查人
	,t1.checker_org                              --调查机构
   	,t1.check_user                               --nan
	,t1.check_date                               --nan
	,t1.organkey                                 --归属机构 客户
    ,t2.org_nm  as 客户归属机构
    ,t3.org_nm  as 调查人机构
from adm_upss.aml_t10_checkparty_relt       t1 --反洗钱客户调查表
left join edw.dim_hr_org_mng_org_tree_dd    t2 --考核机构树
on  t1.organkey=t2.org_id
and t2.dt=t1.dt
left join edw.dws_hr_empe_inf_dd    t3
on  t1.checker=t3.empe_id
and t3.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and replace(substr(t1.check_dt,1,10),'-','') between '20250101' and '20250630'
and t3.org_nm not like '中台%'
union all
select t1.check_no                                 --结论id
	,t1.check_type                               --识别类型 1 .新开客户 2. 持续客户识别 3,一次性交易 4.跨境汇兑 5.重新客户识别 6.其他情形
	,t1.party_id                                 --客户号
	,t1.party_chn_name                           --客户名称
	,t1.check_dt                                 --调查日期
    ,null
	,t1.check_explain                            --调查情况说明
	,t1.checker                                  --调查人
	,t1.checker_org                              --调查机构
	,t1.check_user                               --nan
	,t1.check_date                               --nan
	,t1.organkey                                 --归属机构
    ,t2.org_nm  as 客户归属机构
    ,t3.org_nm  as 调查人机构
from adm_upss.aml_t10_checkparty_relt_uh    t1 --反洗钱客户调查历史表
left join edw.dim_hr_org_mng_org_tree_dd    t2 --考核机构树
on  t1.organkey=t2.org_id
and t2.dt=t1.dt
left join edw.dws_hr_empe_inf_dd    t3
on  t1.checker=t3.empe_id
and t3.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and replace(substr(t1.check_dt,1,10),'-','') between '20250101' and '20250630'
and t3.org_nm not like '中台%'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025080566_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080566_CST_03 AS
SELECT  t1.cst_id         AS 客户号
    ,t1.party_chn_name AS 客户名称
    ,t1.gsname         AS 公式名称
    ,t1.初评等级
    ,t1.最终风险等级
    ,t1.statistic_dt   AS 评级日期
    ,t1.调查结论_编辑岗处理意见
    ,t1.prm_org_id     AS 主管护机构号
    ,t1.prm_org_nm     AS 主管户机构名称
    ,t1.prm_mgr_id     AS 主管护客户经理工号
    ,t1.prm_mgr_nm     AS 主管护客户经理姓名
    ,t1.sbr_org_nm     AS 主管户支行
    ,t2.check_no    as 结论id
    ,t2.check_dt       AS 调查日期
    ,t2.check_result   AS 调查结论
    ,t2.check_explain  AS 调查情况说明
    ,t2.checker        AS 调查人
    ,t2.客户归属机构
    ,t2.调查人机构
    ,decode(t2.check_type,'1','新开客户','2','持续客户识别','3','一次性交易','4','跨境汇兑','5','重新客户识别','6','其他情形') as 识别类型
from SJXQ_SJ2025080566_CST_01          t1
left join SJXQ_SJ2025080566_CST_02     t2
on t1.cst_id=substr(T2.party_id,3,10)
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080566_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ2025080566_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025080566_CST_03
;
/*
01	19048	19048
02	38855	29086
03	22099	19048
*/
SElECT '03' seq, *
from lab_sjxq.SJXQ_SJ2025080566_CST_03
LIMIT 1000
;
SElECT '03' seq, *
from lab_sjxq.SJXQ_SJ2025080566_CST_03
where 调查结论 is not null
LIMIT 1000
***何卓诚_SJ2025080571_金华反洗钱分析.sql
﻿-- 何卓诚_SJ2025080571_金华反洗钱分析
-- 单独取数系统预警为较高风险和高风险中的在我行有外币账户的客户，数据日期为2025年7月1日至2025年7月31日。
--非柜面限额
DROP   TABLE IF     EXISTS SJXQ_SJ2025080571_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080571_CST_01 AS
SELECT  cengcgjz      AS cst_act_id
       ,MAX(danciedu) AS fg_per_lmt
       ,MAX(leijiedu) AS fg_day_lmt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
group by cengcgjz
;
-- 洗钱风险评级等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025080571_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080571_CST_02 AS
SELECT t1.cst_id
    ,t1.party_chn_name	--	客户名称
    ,t1.fristappralevel
    ,decode(t1.levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as 最终风险等级
    ,t1.ADJUST_REASON  AS 调查结论_编辑岗处理意见
    ,t3.prm_org_id --主管护机构号
    ,t3.prm_org_nm --主管户机构名称
    ,t3.prm_mgr_id --主管护客户经理工号
    ,t3.prm_mgr_nm --主管护客户经理姓名
    ,t4.sbr_org_nm --主管户支行
FROM
(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.party_id
        ,t1.party_chn_name	--	客户名称
        ,t1.levelkey
        ,t1.fristappralevel
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    WHERE t1.dt between '20250701' and '20250731'
)t1 inner join(
    select distinct cst_id
    from edw.dim_bus_dep_act_inf_dd  			--存款账户信息
    where dt='20250731'
    and ccy_cd <> '156' -- 外币账户
)t2 on t1.cst_id=t2.cst_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250731'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250731'
and t4.brc_org_nm = '金华分行'
WHERE t1.rn = 1
;
-- 被外部监管查询
DROP   TABLE IF     EXISTS SJXQ_SJ2025080571_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080571_CST_03 AS
SELECT  t1.cst_id
       ,t1.外部监管查询次数
       ,t1.有权机关名称
       ,t1.机关名称及风险情况简述
from(
    select substr(party_id,3,10) as cst_id
        ,count(distinct partyrisk_no)           as 外部监管查询次数
    from app_fxq.t10_party_risk                   --风险事件结果表
    where dt between '20250701' and '20250731'
    and replace(create_dt,'-','') between '20250701' and '20250731'     --创建日期
    group by cst_id
)t1
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250731'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250731'
and t4.brc_org_nm = '金华分行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025080571_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080571_CST_04 AS
SELECT  t1.cst_id      AS 客户号
    ,t1.party_chn_name	as 客户名称
    ,t1.fristappralevel as 初评等级
       ,t1.sbr_org_nm  AS 主管户支行
       ,t1.prm_org_id  AS 主管护机构号
       ,t1.prm_org_nm  AS 主管户机构名称
       ,t1.prm_mgr_id  AS 主管护客户经理工号
       ,t1.prm_mgr_nm  AS 主管护客户经理姓名
       ,t2.外部监管查询次数
       ,t2.有权机关名称
       ,t2.机关名称及风险情况简述
       ,t1.最终风险等级
       ,t1.调查结论_编辑岗处理意见
       ,t3.cst_act_id  AS 客户账号
       ,c1.cd_val_dscr AS 账户状态
       ,t4.fg_per_lmt  AS 非柜单笔限额
       ,t4.fg_day_lmt  AS 非柜日累计限额
from SJXQ_SJ2025080571_CST_02          t1
left join SJXQ_SJ2025080571_CST_03     t2
on t1.cst_id=t2.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t3 --客户存款账户信息
on t1.cst_id=t3.cst_id
and t3.dt='20250731'
left join SJXQ_SJ2025080571_CST_01     t4
on t3.cst_act_id=t4.cst_act_id
left join edw.dwd_code_library_dd       c1
on t3.act_sts_cd = c1.cd_val
and c1.dt = '20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025080571_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080571_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080571_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025080571_CST_04
;
/*
01	7420796	7420796
02	5318	5318
03	1287	1287
04	57697	5318
*/
SElECT '04' seq, *
from SJXQ_SJ2025080571_CST_04
limit 1000
;
***何文骏_SJ20250102106_嘉兴分行积分赠送情况.sql
-- 数据日期：2024年10月1日至2024年12月31日
-- 嘉兴分行综合积分系统下，交易类型0141至0150所有代码、交易类型0265代码下分行积分赠送金额情况
-- 数据需求字段
-- 客户号、交易日期、积分交易类型、借贷标识、积分交易数额、凭证号、积分归属机构号与机构名称（参考附件的字段）
DROP   TABLE IF     EXISTS SJXQ_SJ20250102106_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102106_CST_01 as
SELECT  t1.customersid   AS 积分客户号
       ,t4.hostcustno    AS 银行客户号
       ,t1.transdate     AS 交易日期
       ,t1.pointstypeno  AS 积分类型
       ,t1.transtypeno   AS 交易类型
       ,t2.description   AS 交易类型说明
       ,t1.debitorcredit AS 借贷标识
       ,t1.pointsamount  AS 积分交易金额
       ,t1.voucherno     AS 凭证号
       ,t1.belongbranch  AS 积分归属机构号
       ,t3.org_nm        AS 积分归属机构名称
FROM edw.sirs_pointstransminutes t1 --积分帐户详细记录表，增量表
LEFT JOIN edw.sirs_transtype t2 --积分交易类型表
ON t1.transtypeno = t2.TRANSTYPENO AND t2.dt = '20241231'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd t3 --机构树_考核维度
ON t1.belongbranch = t3.org_id AND t3.dt = '20241231'
LEFT JOIN edw.sirs_customers t4 --客户表
ON t1.customersid = t4.customersid AND t4.dt = '20241231'
WHERE t1.dt between '20241001' and '20241231'
AND t1.pointstypeno = '0001' --综合积分
AND t1.transstatus = '1' --交易正常
AND t1.reversedflag = '0' --冲正标志正常
--0141 0142 ...到0150，外加0265
AND t1.belongbranch LIKE '3309%' --嘉兴分行
;
select *
from lab_bigdata_dev.SJXQ_SJ20250102106_CST_01
***何文骏_SJ2025071616_嘉兴分行细分客群.sql
﻿-- 何文骏_SJ2025071616_嘉兴分行细分客群
-- 截止2025年7月15日，嘉兴分行所有子社区里面的细分客群对应的客户清单（已建档部分）
DROP   TABLE IF     EXISTS SJXQ_SJ2025071616_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071616_CST_01 AS
SELECT  t1.cst_id         --客户号
       ,t2.brc_org_nm     --主管户分行
       ,t2.sbr_org_nm     --主管户支行
       ,t2.tem_org_nm     --主管户团队
       ,t6.sub_cmnt_id    --子社区编号
       ,t7.cmnt_nm        --子社区名称
       ,t3.com_cst_grp_id --细分客群id
       ,t4.cst_group_name --细分客群名称
       ,t4.segment_type	  --细分客群分类 行业类或其他
       ,t4.remark         --细分客群备注
       ,t5.cst_chn_nm
       ,t5.file_dt        --建档日期
from adm_pub.adm_csm_cbas_mng_inf_dd        t1 --客户集市-客户基础-客户管户信息
INNER JOIN edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm='嘉兴分行'
INNER join edw.xwdt_xw_com_csts_by_grp      t3        --社区细分客群客户表
on t1.cst_id=t3.cust_no
and t3.dt=t1.dt
left join edw.xwdt_xw_community_cst_group	t4 --细分客群信息表
on t3.com_cst_grp_id=t4.id
and t4.dt=t1.dt
inner join edw.dws_cst_bas_inf_dd	        t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
INNER JOIN    edw.dwd_cst_mng_cmnt_rel_dd   t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = t1.dt
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd    t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
where t1.dt = '20250715'
;
-- 当前状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025071616_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071616_CST_02 AS
select t1.cst_id
    ,t2.forml_cst_ind                            --正式客户标识
    ,t3.vld_cst                                  --有效户
    ,case when t4.cst_id is not null then '1' else '0' end as is_crdt_cst
    ,t5.vld_dep_act                              --有效存款户
	,t6.vld_loan_act                             --有效贷款户
	,t7.vld_wlth_cst                             --有效财富客户
	,t8.vld_itnl_bsn_cst                         --有效国际业务客户
    ,t9.val_cst	                                 --价值客户
from SJXQ_SJ2025071616_CST_01               t1
left join adm_pub.adm_csm_cbas_mng_inf_dd   t2 --客户集市-客户基础-客户管户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t3 --客户规则类通用营销特性表3
on t1.cst_id=t3.cst_id
and t3.dt='20250715'
left join (
    select distinct t1.cst_id
    from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
    where t1.dt='20250715'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' ) AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 )
) t4 on t1.cst_id=t4.cst_id
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     t5 --规则通用金融行为存款标签
on t1.cst_id=t5.cst_id
and t5.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t6 --通用金融行为贷款标签表2
on t1.cst_id=t6.cst_id
and t6.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_wlth_l2_dd t7 --通用金融行为客户标签2表
on t1.cst_id=t7.cst_id
and t7.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_mid_bsn_l2_dd t8 --通用-金融行为-中间业务2表
on t1.cst_id=t8.cst_id
and t8.dt='20250715'
left join adm_ind.adm_ind_l_rul_unvs_cst_val_l4_dd	    t9 --客户通用风险评估标签表4
on t1.cst_id=t9.cst_id
and t9.dt='20250715'
;
-- 20241231状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025071616_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071616_CST_03 AS
select t1.cst_id
    ,t2.forml_cst_ind                            --正式客户标识
    ,t3.vld_cst                                  --有效户
    ,case when t4.cst_id is not null then '1' else '0' end as is_crdt_cst
    ,t5.vld_dep_act                              --有效存款户
	,t6.vld_loan_act                             --有效贷款户
	,t7.vld_wlth_cst                             --有效财富客户
	,t8.vld_itnl_bsn_cst                         --有效国际业务客户
    ,t9.val_cst	                                 --价值客户
from SJXQ_SJ2025071616_CST_01               t1
left join adm_pub.adm_csm_cbas_mng_inf_dd   t2 --客户集市-客户基础-客户管户信息
on t1.cst_id=t2.cst_id
and t2.dt='20241231'
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t3 --客户规则类通用营销特性表3
on t1.cst_id=t3.cst_id
and t3.dt='20241231'
left join (
    select distinct t1.cst_id
    from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
    where t1.dt='20241231'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' ) AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 )
) t4 on t1.cst_id=t4.cst_id
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     t5 --规则通用金融行为存款标签
on t1.cst_id=t5.cst_id
and t5.dt='20241231'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t6 --通用金融行为贷款标签表2
on t1.cst_id=t6.cst_id
and t6.dt='20241231'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_wlth_l2_dd t7 --通用金融行为客户标签2表
on t1.cst_id=t7.cst_id
and t7.dt='20241231'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_mid_bsn_l2_dd t8 --通用-金融行为-中间业务2表
on t1.cst_id=t8.cst_id
and t8.dt='20241231'
left join adm_ind.adm_ind_l_rul_unvs_cst_val_l4_dd	    t9 --客户通用风险评估标签表4
on t1.cst_id=t9.cst_id
and t9.dt='20250101'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071616_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071616_CST_04 AS
SELECT  '20250715'    AS 数据日期
       ,t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 客户名称
       ,t1.brc_org_nm       AS 主管户分行
       ,t1.sbr_org_nm       AS 主管户支行
       ,t1.tem_org_nm       AS 主管户团队
       ,t1.sub_cmnt_id      AS 子社区编号
       ,t1.cmnt_nm          AS 子社区名称
       ,t1.com_cst_grp_id as 细分客群id
       ,t1.cst_group_name as 细分客群名称
       ,t1.segment_type	  as 细分客群分类
       ,t1.remark         as 细分客群备注
       ,t1.file_dt          AS 建档日期
       ,t2.forml_cst_ind    AS 当前是否正式客户
       ,t2.vld_cst          AS 当前是否有效户
       ,t2.is_crdt_cst      AS 当前是否授信客户
       ,t2.vld_dep_act      AS 当前是否有效存款户
       ,t2.vld_loan_act     AS 当前是否有效贷款户
       ,t2.vld_wlth_cst     AS 当前是否有效财富客户
       ,t2.vld_itnl_bsn_cst AS 当前是否有效国际业务客户
       ,t2.val_cst          AS 当前是否价值客户
       ,t3.forml_cst_ind    AS 年初是否正式客户
       ,t3.vld_cst          AS 年初是否有效户
       ,t3.is_crdt_cst      AS 年初是否授信客户
       ,t3.vld_dep_act      AS 年初是否有效存款户
       ,t3.vld_loan_act     AS 年初是否有效贷款户
       ,t3.vld_wlth_cst     AS 年初是否有效财富客户
       ,t3.vld_itnl_bsn_cst AS 年初是否有效国际业务客户
       ,t3.val_cst          AS 年初是否价值客户
from SJXQ_SJ2025071616_CST_01       t1
left join SJXQ_SJ2025071616_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025071616_CST_03  t3
on t1.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071616_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071616_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071616_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071616_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2025071616_CST_04
;
***何灵杰_SJ2025041666_绍兴分行最高额补充担保.sql
﻿-- 截至2025年3月31日，绍兴分行授信正常且增加过最高额补充担保的信贷业务。
-- 发生过贷后担保变更类型为增加担保，且增加的为最高额担保合同
--截至2025年3月31日合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_01 AS
SELECT  t1.ctr_serno    --合同流水号
    ,t1.cst_id          --客户号
    ,t1.cst_nm          --客户名称
    ,t1.rel_serno       --用信申请流水号
    ,t1.ctr_amt         --合同金额
    ,t1.ctr_bal         --合同余额
    ,t1.ctr_bgn_dt      --合同起始日期
    ,t1.ctr_mtu_dt      --合同到期日期
    ,t1.ovd_amt         --逾期金额|decimal(21,2)
    ,t1.ovd_dt          --逾期日期|c8
    ,t1.mgr_id          --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t2.pd_nm   as 业务品种
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20250331'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20250331'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20250331'
and t4.brc_org_nm = '绍兴分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20250331'
where t1.dt='20250331'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 审查人、最终审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_02 AS
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.cst_typ_cd         --客户类型代码
       ,t1.prd_no             --产品编号
       ,t1.pd_nm              --产品名称
       ,t1.hpn_typ_cd         --发生类型代码
       ,t1.apl_amt            --申请金额
       ,t1.aply_epsr_amt      --申请敞口金额
       ,t1.grnt_mod_colc_cd   --担保方式集合代码
       ,t1.apl_dt             --申请日期
       ,t1.rmk                --备注
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_org_id         --管户机构编号
       ,t1.exec_intr_rat      --执行利率
       ,t3.rel_serno          --合同号
       ,t4.flow_starter       --流程发起者
       ,t4.flow_starter_name  --发起者姓名
       ,t4.start_time         --流程发起时间
       ,t4.org_id             --发起人机构id
       ,t4.biz_id             --业务流水号
       ,t6.empe_id            AS 最终审批人工号
       ,t6.empe_nm            AS 最终审批人姓名
       ,t10.aprv_id           AS 团队审查岗工号
       ,t10.aprv_nm           AS 团队审查岗姓名
from edw.dwd_bus_loan_lmt_aply_biz_dd   t1 --用信方案
inner join(
    select distinct rel_serno
    from SJXQ_SJ2025041666_CST_01
)	    t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join (
    SELECT t4.instance_id
        ,t4.flow_starter              --流程发起者
       ,t4.flow_starter_name          --发起者姓名
       ,t4.start_time                 --流程发起时间
       ,t4.org_id                     --发起人机构id
       ,t4.biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by t4.biz_id order by t4.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where t4.dt='@@{yyyyMMdd}'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t4.rn=1
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队审查岗'
    GROUP BY instance_id,node_nm
)t10 on t4.instance_id=t10.instance_id
where t1.dt='@@{yyyyMMdd}'
;
-- 发放金额,贷款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_03 AS
SELECT  t1.CTR_SERNO        --合同流水号|C32
       ,SUM(t1.AMT)      AS 发放金额
       ,SUM(t1.PRCP_BAL) AS 贷款余额
from edw.dim_bus_loan_dbil_inf_dd       t1           --信贷借据信息
inner join SJXQ_SJ2025041666_CST_01     t2
on t1.CTR_SERNO=t2.CTR_SERNO
where t1.dt='@@{yyyyMMdd}'
group by t1.ctr_serno
;
-- 发生过贷后担保变更类型为增加担保，且增加的为最高额担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_04 AS
SELECT t1.mdf_serno                              --变更流水号
	,t1.ctr_serno                                --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.rvlg_typ                                 --循环类型
	,t1.prd_no                                   --产品编号
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
	,t1.adj_rsn                                  --调整原因
	,t1.grnt_mod_colc                            --担保方式集合
	,t1.arcv_dt	        --归档日期
	,t1.sys_reg_tm	    --系统登记时间
	,t2.grnt_ctr_no                              --担保合同编号
	,t2.grnt_ctr_typ                             --担保合同类型
	,t2.wrat_cst_id                              --被担保人客户号
	,t2.wrat_nm                                  --被担保人名称
	,t2.grnt_mod                                 --担保方式
	,t2.grnt_ctr_amt                             --担保合同金额
	,t2.cltr_hgst_can_grnt_amt                   --押品最高可担保金额
	,t2.rvlg_ind                                 --循环标志
	,t2.grnt_ctr_bgn_dt                          --担保合同起始日期
	,t2.grnt_ctr_mtu_dt                          --担保合同到期日期
	,t2.grnt_ctr_sts                             --担保合同状态
    ,decode(t2.grnt_ctr_sts,'1','未生效','2','已生效','3','终止','4','冻结','5','作废') as grnt_ctr_sts_nm
	,t2.rmk                                      --备注
	,t2.obg_id                                   --权利人编号
	,t2.obg_nm                                   --权利人名称
FROM edw.loan_psp_grnt_ctr_mdf_rcd           t1 --担保合同变更记录明细
inner JOIN edw.loan_psp_ctr_rel_grnt_ctr_dtl t2 --主合同关联担保合同明细
ON t1.MDF_SERNO = t2.MDF_SERNO
and t2.dt=t1.dt
AND t2.del_ind = '0'
and t2.grnt_ctr_typ='020'  --020:最高额担保
inner join SJXQ_SJ2025041666_CST_01     t3
on t1.ctr_serno=t3.ctr_serno
WHERE t1.dt='20250331'
AND t1.del_ind = '0';
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_05 AS
select t2.ctr_serno                                --合同流水号|c32
	,t2.grnt_ctr_no                              --担保合同编号|c32
	,t1.bus_typ_cd                               --业务类型|C1
	,t1.grnt_ctr_typ_cd                          --担保合同类型代码|C3
	,t1.grnt_typ_cd                              --担保类型代码|C6
	,t1.grnt_ccy_cd                              --担保币种代码|C3
	,t1.grnt_tot_amt                             --担保总金额|DECIMAL(21,2)
	,t1.wrnt_cst_id                              --保证人客户编号|C20
	,t1.wrnt_cst_nm                              --保证人客户名称|C200
	,t1.wrnt_doc_typ                             --保证人证件类型|C5
	,t1.id_val                                   --认定价值|DECIMAL(21,2)
	,t1.grnt_psn_seq_nbr                         --担保人序号|C10
from edw.dws_bus_grnt_prsn_inf_dd   t1          --担保人汇总信息
INNER JOIN(
    select distinct ctr_serno,grnt_ctr_no
    from SJXQ_SJ2025041666_CST_04
) t2 on t1.bus_ctr_id=t2.ctr_serno
and t1.grnt_ctr_id=t2.grnt_ctr_no
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_06 AS
SELECT  t1.ctr_serno       AS 合同流水号
       ,t2.cst_id          AS 客户号
       ,t2.cst_nm          AS 客户名称
       ,t2.业务品种
       ,t2.ovd_amt         AS 逾期金额
       ,t2.ovd_dt          AS 逾期日期
       ,t2.hdl_opr_id      AS 经办人工号
       ,t2.hdl_opr_nm      AS 经办人
       ,t3.团队审查岗工号
       ,t3.团队审查岗姓名
       ,t3.最终审批人工号
       ,t3.最终审批人姓名
       ,t4.发放金额
       ,t4.贷款余额
       ,t2.sbr_org_nm      AS 管户支行
       ,t2.tem_org_nm      AS 管户团队
       ,t2.mgr_id          AS 管户人工号
       ,t2.mgr_nm          AS 管户人
       ,t1.mdf_serno       AS 变更流水号
       ,t1.arcv_dt         AS 归档日期
       ,t1.sys_reg_tm      AS 系统登记时间
       ,t1.grnt_ctr_no     AS 补充担保合同编号
       ,t1.grnt_ctr_bgn_dt AS 补充担保合同起始日期
       ,t1.grnt_ctr_mtu_dt AS 补充担保合同到期日期
       ,t1.grnt_ctr_sts_nm AS 补充担保合同状态
       ,t5.保证人 as 补充担保担保人
from SJXQ_SJ2025041666_CST_04       t1
inner join SJXQ_SJ2025041666_CST_01 t2
on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ2025041666_CST_02  t3
on t2.rel_serno=t3.usc_aply_serno
left join SJXQ_SJ2025041666_CST_03  t4
on t2.ctr_serno=t4.ctr_serno
left join(
    select ctr_serno,grnt_ctr_no
    from SJXQ_SJ2025041666_CST_05
    group by ctr_serno,grnt_ctr_no
)t5 on t1.ctr_serno=t5.ctr_serno
and t1.grnt_ctr_no=t5.grnt_ctr_no
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041666_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct rel_serno) custs
from SJXQ_SJ2025041666_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041666_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ2025041666_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ2025041666_CST_05
;
/*
01	40360	40360
02	16307	16307
03	29092	29092
04	24957	24957
*/
select '担保合同变更记录明细' as tbl_nm
	,count(1) cnt
	,count(distinct mdf_serno) as 变更流水号
	,count(distinct ctr_serno) as 合同流水号
from edw.loan_psp_grnt_ctr_mdf_rcd --担保合同变更记录明细
where dt='20241231';
select '主合同关联担保合同明细' as tbl_nm
	,count(1) cnt
	,count(distinct mdf_serno) as 变更流水号
	,count(distinct ctr_serno) as 合同流水号
	,count(distinct grnt_ctr_no) as 担保合同编号
from edw.loan_psp_ctr_rel_grnt_ctr_dtl --主合同关联担保合同明细
where dt='20241231';
***何灵杰_SJ2025041666_绍兴分行最高额补充担保0418.sql
﻿-- 截至2025年3月31日，绍兴分行授信正常且增加过最高额补充担保的信贷业务。
-- 发生过贷后担保变更类型为增加担保，且增加的为最高额担保合同
--截至2025年3月31日合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_01 AS
SELECT  t1.ctr_serno    --合同流水号
    ,t1.cst_id          --客户号
    ,t1.cst_nm          --客户名称
    ,t1.rel_serno       --用信申请流水号
    ,t1.ctr_amt         --合同金额
    ,t1.ctr_bal         --合同余额
    ,t1.ctr_bgn_dt      --合同起始日期
    ,t1.ctr_mtu_dt      --合同到期日期
    ,t1.ovd_amt         --逾期金额|decimal(21,2)
    ,t1.ovd_dt          --逾期日期|c8
    ,t1.mgr_id          --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t2.pd_nm   as 业务品种
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20250331'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20250331'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20250331'
and t4.brc_org_nm = '绍兴分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20250331'
where t1.dt='20250331'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 审查人、最终审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_02 AS
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.cst_typ_cd         --客户类型代码
       ,t1.prd_no             --产品编号
       ,t1.pd_nm              --产品名称
       ,t1.hpn_typ_cd         --发生类型代码
       ,t1.apl_amt            --申请金额
       ,t1.aply_epsr_amt      --申请敞口金额
       ,t1.grnt_mod_colc_cd   --担保方式集合代码
       ,t1.apl_dt             --申请日期
       ,t1.rmk                --备注
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_org_id         --管户机构编号
       ,t1.exec_intr_rat      --执行利率
       ,t3.rel_serno          --合同号
       ,t4.flow_starter       --流程发起者
       ,t4.flow_starter_name  --发起者姓名
       ,t4.start_time         --流程发起时间
       ,t4.org_id             --发起人机构id
       ,t4.biz_id             --业务流水号
       ,t6.empe_id            AS 最终审批人工号
       ,t6.empe_nm            AS 最终审批人姓名
       ,t10.aprv_id           AS 团队审查岗工号
       ,t10.aprv_nm           AS 团队审查岗姓名
from edw.dwd_bus_loan_lmt_aply_biz_dd   t1 --用信方案
inner join(
    select distinct rel_serno
    from SJXQ_SJ2025041666_CST_01
)	    t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join (
    SELECT t4.instance_id
        ,t4.flow_starter              --流程发起者
       ,t4.flow_starter_name          --发起者姓名
       ,t4.start_time                 --流程发起时间
       ,t4.org_id                     --发起人机构id
       ,t4.biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by t4.biz_id order by t4.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where t4.dt='@@{yyyyMMdd}'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t4.rn=1
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队审查岗'
    GROUP BY instance_id,node_nm
)t10 on t4.instance_id=t10.instance_id
where t1.dt='@@{yyyyMMdd}'
;
-- 发放金额,贷款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_03 AS
SELECT  t1.CTR_SERNO        --合同流水号|C32
       ,SUM(t1.AMT)      AS 发放金额
       ,SUM(t1.PRCP_BAL) AS 贷款余额
from edw.dim_bus_loan_dbil_inf_dd       t1           --信贷借据信息
inner join SJXQ_SJ2025041666_CST_01     t2
on t1.CTR_SERNO=t2.CTR_SERNO
where t1.dt='@@{yyyyMMdd}'
group by t1.ctr_serno
;
-- 发生过贷后担保变更类型为增加担保，且增加的为最高额担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_04 AS
select t1.ctr_serno                                --合同流水号|c32
	,t1.grnt_ctr_no                              --担保合同编号|c32
	,t1.thstm_ocp_grnt_lmt                       --本次占用担保额度|decimal
	,t1.eff_sts_cd                               --生效状态代码|c1
    ,T2.cst_id
	,t3.grnt_ctr_typ_cd                          --担保合同类型代码|c3
	,t3.wrat_cst_id                              --被担保人客户号|c20
	,t3.wrat_nm                                  --被担保人名称|c200
	,t3.grnt_mod_cd                              --担保方式代码|c3
	,t3.grnt_ctr_amt                             --担保合同金额|decimal
	,t3.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
	,t3.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
	,t3.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
	,t3.grnt_ctr_sts_cd                          --担保合同状态代码 ,'1','未生效','2','已生效','3','终止','4','冻结','5','作废'
from edw.dwd_bus_loan_ctr_rel_grnt_dd   t1       --主合同、担保合同关系
inner join SJXQ_SJ2025041666_CST_01     t2
on t1.ctr_serno=t2.ctr_serno
left join edw.dim_bus_loan_ctr_grnt_inf_dd t3 --担保合同信息
on t1.grnt_ctr_no=t3.grnt_ctr_no
and t3.dt='@@{yyyyMMdd}'
-- and t3.grnt_ctr_typ_cd='020'   --020:最高额担保
where t1.dt='@@{yyyyMMdd}'
and t1.grnt_ctr_typ_cd='020'   --020:最高额担保
and t1.eff_sts_cd='1'   --,'0','待生效','1','已生效','2','已失效'
and t1.busi_typ_cd='1'  --1贷款业务
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_05 AS
select t2.ctr_serno                                --合同流水号|c32
	,t2.grnt_ctr_no                              --担保合同编号|c32
	,t1.busi_typ_cd                              --业务类型
	,t1.ctr_typ_cd                               --担保合同类型代码
	,t1.grnt_typ_cd                              --担保类型代码
	,t1.grnt_ccy_cd                              --担保币种代码
	,t1.grnt_tot_amt                             --担保总金额
	,t1.grnt_id                                  --担保物编号
	,t1.cltr_nm                                  --押品名称
	,t1.cltr_typ_cd                              --押品类型代码
	,t1.mtg_and_impn_ccy_cd                      --抵质押币种代码
	,t1.hi_mrgn_amt                              --最高担保金额
	,t1.ctr_eft_dt                               --合同生效日期
	,t1.ctr_mtu_dt                               --合同到期日期
	,t1.lo_rsk_bil_ind                           --低风险标志
	,t1.sts_cd                                   --状态代码
from edw.dws_bus_grnt_itm_inf_dd    t1           --担保物汇总信息
INNER JOIN SJXQ_SJ2025041666_CST_04 t2
on t1.busi_ctr_id=t2.ctr_serno
and t1.grnt_ctr_id=t2.grnt_ctr_no
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_06 AS
select t2.ctr_serno                                --合同流水号|c32
	,t2.grnt_ctr_no                              --担保合同编号|c32
	,t1.bus_typ_cd                               --业务类型|C1
	,t1.grnt_ctr_typ_cd                          --担保合同类型代码|C3
	,t1.grnt_typ_cd                              --担保类型代码|C6
	,t1.grnt_ccy_cd                              --担保币种代码|C3
	,t1.grnt_tot_amt                             --担保总金额|DECIMAL(21,2)
	,t1.wrnt_cst_id                              --保证人客户编号|C20
	,t1.wrnt_cst_nm                              --保证人客户名称|C200
	,t1.wrnt_doc_typ                             --保证人证件类型|C5
	,t1.id_val                                   --认定价值|DECIMAL(21,2)
	,t1.grnt_psn_seq_nbr                         --担保人序号|C10
from edw.dws_bus_grnt_prsn_inf_dd   t1          --担保人汇总信息
INNER JOIN SJXQ_SJ2025041666_CST_04 t2
on t1.bus_ctr_id=t2.ctr_serno
and t1.grnt_ctr_id=t2.grnt_ctr_no
where dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025041666_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041666_CST_07 AS
SELECT t1.btch_serno,t2.cst_id
    ,t1.ctr_serno                                --合同流水号|c32
    ,t1.ori_ctr_amt                              --原合同金额|decimal(21,2)
    ,t1.new_ctr_amt                              --新合同金额|decimal(21,2)
    ,t1.pst_loan_mng_opnn_src_cd                 --贷后管理意见来源代码 ,'1','客户经理意见','2','中台意见'
    ,t1.pst_loan_mng_pln_cd	--	贷后管理方案代码
    ,t1.sys_reg_tm
    ,ROW_NUMBER() over(PARTITION BY t1.btch_serno ORDER BY t1.sys_reg_tm desc) rn
from edw.dwd_bus_loan_bsn_mng_pln_dd        t1 --业务贷后管理方案
inner join SJXQ_SJ2025041666_CST_01      t2 --合同基础信息
on t1.ctr_serno=t2.ctr_serno
where t1.DT = '@@{yyyyMMdd}'
and t1.pst_loan_mng_pln_cd='08' --担保变更
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041666_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct rel_serno) custs
from SJXQ_SJ2025041666_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041666_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ2025041666_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ2025041666_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ2025041666_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041666_CST_07
;
/*
01	40360	40360
02	16307	16307
03	29092	29092
04	24957	24957
05	1454	1311
06	40894	23635
*/
借款人客户号
借款人客户名
业务品种
逾期状态
经办人
审查人
最终审批人
发放金额
贷款余额
管户支行
管户团队
管户人
补充担保合同起始日
补充担保合同到期日
补充担保最高主债权余额?
补充担保担保人客户号
补充担保担保人姓名
补充担保合同流水号
***何灵杰_SJ2025051371_绍兴分行信贷数据分析.sql
﻿-- 截至2025年5月11日 绍兴分行 同一风险控制号总敞口&isin;[1000000,3000000]
-- 同一风险控制号下我行授信总额
DROP   TABLE IF     EXISTS SJXQ_SJ2025051371_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051371_CST_01 AS
SELECT  T1.CST_ID
       ,t5.cst_chn_nm                                                                         --客户名称
       ,T1.客户授信总额
       ,t1.客户敞口总额
       ,t1.客户可用授信总额
       ,t1.客户可用敞口总额
       ,CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t5.sam_rsk_ctrl_id END AS sam_rsk_ctrl_id
FROM
(
	SELECT  le.cst_id
	       ,SUM(FACL_LMT)                                                                        AS 客户授信总额
	       ,SUM(EPSR_LMT)                                                                        AS 客户敞口总额
	       ,SUM(IF(le.LMT_STS = '03',IF(le.avl_facl_lmt > 0,0,le.avl_facl_lmt),le.avl_facl_lmt)) AS 客户可用授信总额
	       ,SUM(IF(le.LMT_STS = '03',IF(le.avl_epsr_lmt > 0,0,le.avl_epsr_lmt),le.avl_epsr_lmt)) AS 客户可用敞口总额
	FROM edw.loan_lmt_exmp le
	INNER JOIN edw.loan_cst_bsc cb
	ON le.CST_ID = cb.CST_ID AND cb.DT = '20250511'
	WHERE le.DEL_IND = '0'
	AND ( EXISTS (
	SELECT  1
	FROM edw.loan_lmt_use_rslt_rcd u
	WHERE u.SPLT_LMT_NO = le.SPLT_LMT_NO
	AND INI_OCP_FACL_AMT > ALRY_RSM_FACL_LMT
	AND OCP_STS = '1'
	AND U.DT = '20250511' ) OR le.LMT_STS IN ( '01' , '02' ) ) AND LE.DT = '20250511'
	GROUP BY  le.cst_id
) T1
LEFT JOIN edw.DWS_CST_BAS_INF_DD t5
ON T1.cst_id = t5.cst_id AND t5.dt = '20250511'
;
--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025051371_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051371_CST_02 AS
SELECT  a.grnt_mod_colc
FROM
(
	SELECT  distinct grnt_mod_colc
	       ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE dt = '20250511'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '20250511'
GROUP BY  a.grnt_mod_colc
;
-- 合同数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025051371_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051371_CST_03 AS
SELECT  t1.sam_rsk_ctrl_id    --同一风险控制号
       ,t2.cst_id             --客户号
       ,t3.ctr_serno          --合同流水号
       ,t3.rel_serno          --用信申请流水号
       ,t3.ctr_bal            --合同余额
       ,t7.grnt_mod_nm        --担保方式集合
       ,t5.empe_nm            --管户人
       ,t6.org_nm             --管户机构
       ,t8.final_aprv_empe_id --最终审批人
       ,c1.cd_val_dscr        as 户籍地址行政区划
       ,t10.ast_lbl_rat       --资产负债率
       ,t10.slf_ast_lbl_rat   --本人资产负债率
    ,case when t11.cst_id is not null then '是' else '' end as 绍兴市是否有房产
from(
    select sam_rsk_ctrl_id
    from SJXQ_SJ2025051371_CST_01
    group by sam_rsk_ctrl_id
    having sum(客户敞口总额) between 1000000 and 3000000
)T1 inner join SJXQ_SJ2025051371_CST_01      t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
inner join edw.dim_bus_loan_ctr_bse_inf_dd   t3 --合同基础信息
on t2.cst_id=t3.cst_id
and t3.dt='20250511'
inner join edw.dim_bus_loan_prd_frml_dd     t4
on t3.prd_no=t4.prd_no
and t4.dt='20250511'
and t4.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t3.mgr_id=t5.empe_id
and t5.dt='20250511'
inner join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t3.mgr_org_id = t6.org_id
and t6.dt = '20250511'
and t6.brc_org_nm='绍兴分行'
left join SJXQ_SJ2025051371_CST_02  t7
on t3.grnt_mod_colc=t7.grnt_mod_colc
left join(
    select ctr_srl_no
    from adm_rsk.adm_rsk_apl_inter_all
    where dt= '20250511'
    group by ctr_srl_no
)t8 on t3.ctr_serno=t8.ctr_srl_no
LEFT JOIN edw.loan_cst_ctc_addr                 t9
ON t2.cst_id = t9.cst_id
AND t9.dt = '20250511'
and t9.del_ind='0' 	--未删除
AND t9.addr_typ = '050100' --户籍地址
left join   edw.dwd_code_library_dd     c1 -- 码值表
ON  concat(substr(t9.adiv,1,4),'00') = c1.cd_val
AND c1.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND c1.fld_nm = 'CTY_DTRCT_DVD_CD'   --市
AND c1.dt = '20250511'
left join(
	select cst_id                                   --客户号|c20
		,rcd_tm                                   --记录时间|c20
		,ast_amt                                  --资产总额|decimal(21,2)
		,lbl_tot_amt                              --负债总额|decimal(21,2)
		,ast_lbl_rat                              --资产负债率|decimal(10,6)
		,slf_ast_amt                              --本人资产总额|decimal(21,2)
		,slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
		,slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
		,last_upd_tm                              --最后更新时间|C19
		,row_number() over(partition by cst_id order by rcd_tm desc) rn
	from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
	where dt='20250511'
)t10 on t2.cst_id=t10.cst_id
and t10.rn=1
LEFT JOIN    (
    SELECT  DISTINCT cst_id
    FROM    edw.dwd_bus_loan_svy_fnc_stat_dtl_data_ass_rl_est_dd --调查报告&mdash;资产负债详情-资产-不动产
    WHERE   DT = '20250511'
    AND     substr(adiv_cd,1,4)='3306'  --绍兴
) T11 ON      t2.cst_id = T11.cst_id
;
-- 最终审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2025051371_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051371_CST_04 AS
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t3.ctr_serno          --合同号
       ,t4.biz_id             --业务流水号
       ,t6.empe_id            --最终审批人工号
       ,t6.empe_nm            --最终审批人姓名
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join SJXQ_SJ2025051371_CST_03	        t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join (
    SELECT instance_id              --流程实例id|c32
        ,flow_starter               --流程发起者
        ,flow_starter_name          --发起者姓名
        ,start_time                 --流程发起时间
        ,org_id                     --发起人机构id
        ,biz_id                     --业务流水号
        ,flow_id                                  --流程id|c32
        ,flow_name                                --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='20250430'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t2.sys_reg_psn_id=t4.flow_starter
and t4.rn=1
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
where t1.dt='20250430'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025051371_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051371_CST_05 AS
SELECT  t1.sam_rsk_ctrl_id    as 同一风险控制号
	,t1.cst_id             as 客户号
	,t1.ctr_serno          as 合同流水号
	,t1.rel_serno          as 用信申请流水号
	,t1.ctr_bal            as 合同余额
	,t1.grnt_mod_nm        as 担保方式集合
	,t1.empe_nm            as 管户人
	,t1.org_nm             as 管户机构
	,coalesce(t1.final_aprv_empe_id,concat(t2.empe_id,t2.empe_nm))  as 最终审批人
	,t1.户籍地址行政区划
	,t1.ast_lbl_rat       as资产负债率
	,t1.slf_ast_lbl_rat   as本人资产负债率
    ,t1.绍兴市是否有房产
from SJXQ_SJ2025051371_CST_03 		t1
left join SJXQ_SJ2025051371_CST_04 	t2
on t1.ctr_serno=t2.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051371_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct grnt_mod_colc) custs
from SJXQ_SJ2025051371_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051371_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051371_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025051371_CST_05
;
***余小敏_SJ20250402221_四会村行贵金属宝石客户.sql
﻿-- 余小敏023182-统计我行贵金属和宝石行业客户群体风险状况
-- 2024年我行贵金属和宝石行业客户（行业或经营范围或名称关键字为贵金属或宝石）的客户的相关数据（表1的A列）
-- 基于表1，提取对公客户的相关内容（表2的A-I列）
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_01 AS
SELECT DISTINCT
	substr(party_id, 3, 12) as cst_id                                 --客户ID
	,app_state_cd                             --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
FROM adm_upss.aml_t07_case_application_uh a    --案例历史表
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'           --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
-- AND A.APP_ORG_ID IN (
--     SELECT B.ORGANKEY FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
--     WHERE B.report_organkey = 'C1406244000019' AND B.DT = '20241231'
-- )
;
-- 存款账号
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_02 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.cntry_tax_nbr                            --国税证|C64
	,t1.opr_scp_dscr                             --经营范围描述|C3000
	,t1.idt_ctg_cd                               --行业分类代码|C10
    ,c1.cd_val_dscr     as idt_ctg_nm
	,t1.lctax_cert_no                            --地税证件号|C60
	,t1.cst_sts_cd                               --客户状态代码|C1
    ,t2.cst_act_id,t2.dep_act_id
    ,t4.brc_org_nm
    ,t4.org_nm as opn_org_nm
    ,t5.qefe_slp_cst_ind	--睡眠户客户标识
    ,t5.qefe_lost_cst_ind	--沉睡客户
    ,t6.levelkey
    ,case when t7.cst_id is not null then 1 else 0 end as is_cdk
    ,t8.app_state_cd
from edw.dim_cst_entp_bas_inf_dd        t1  --企业客户基本信息
inner join edw.dim_bus_dep_act_inf_dd  	t2	--存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = t1.dt
left join edw.dwd_code_library_dd       c1
on t1.idt_ctg_cd = c1.cd_val
and c1.dt=t1.dt
left join adm_pub.adm_csm_cbas_ind_inf_dd	t5 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id = t5.cst_id
and t5.dt = t1.dt
left JOIN
(
	SELECT  substr(t2.party_id,3,12)  AS cst_id
	       ,t2.levelkey
	       ,t2.rcheck_dt
	       ,ROW_NUMBER() OVER ( PARTITION BY substr(t2.party_id,3,12) ORDER BY  t2.statistic_dt DESC ) AS rn
	       ,t2.statistic_dt
	FROM adm_upss.aml_t37_party_result_curr t2
	WHERE t2.dt = '20241231'
) t6
ON t1.cst_id = t6.cst_id AND t6.rn = 1
left join(
	SELECT  aa.cst_id
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	WHERE aa.dt = '20250131'
	AND qry_ctrl_dt >= '20240101'
	AND qry_ctrl_dt <= '20241231'
)t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ20250402221_CST_01 t8
on t1.cst_id=t8.cst_id
where t1.dt='20241231'
and (
    concat(t1.cst_nm,t1.opr_scp_dscr) regexp '贵金属|宝石'
    or t1.idt_ctg_cd regexp '^(B092|B0929|B1093|C2438|C322|C3229|C3253|F5245)'
)
;
-- 客户交易信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_04 AS
SELECT  t1.cst_id,t1.cst_act_id
    ,t1.dep_act_id
    ,t3.dtl_seq_nbr
    ,t3.trx_dt
    ,t3.trx_amt
    ,t3.dt
FROM SJXQ_SJ20250402221_CST_02  t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   T3
ON  T1.dep_act_id=T3.dep_act_id
AND T3.dt >='20231201'
and t3.trx_dt between '20240101' and '20241231'
and t3.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_05 AS
SELECT  COUNT(t1.cst_id)                                          AS 2024年客户数量
       ,SUM(t2.trx_cnt_2024)                                      AS 2024年交易笔数
       ,SUM(t2.trx_amt_2024)                                      AS 2024年交易金额
       ,COUNT(case WHEN t1.levelkey = '1005' THEN t1.cst_id end)  AS 高风险客户数
       ,COUNT(case WHEN t1.levelkey = '1004' THEN t1.cst_id end)  AS 次高风险客户数
       ,COUNT(case WHEN t1.levelkey = '1003' THEN t1.cst_id end)  AS 中风险客户数
       ,COUNT(case WHEN t1.is_cdk = 1 THEN t1.cst_id end)         AS 涉查冻扣客户数
       ,COUNT(case WHEN t1.app_state_cd is not null THEN t1.cst_id end) 上报及排除可疑交易报告客户数
       ,COUNT(case WHEN t1.app_state_cd = '5' THEN t1.cst_id end) AS 上报可疑交易报告客户数
from SJXQ_SJ20250402221_CST_02 t1
left join(
    select cst_id
        ,count(1) as trx_cnt_2024
        ,sum(trx_amt) as trx_amt_2024
    from SJXQ_SJ20250402221_CST_04
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
where t1.brc_org_nm = '广东四会泰隆村镇银行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_06 AS
SELECT  t1.cst_id            AS 客户号
       ,t1.cst_nm            AS 客户名称
       ,t1.cst_act_id        AS 客户账号
       ,t1.dep_act_id        AS 存款账号
       ,t1.qefe_slp_cst_ind  AS 睡眠户客户标识
       ,t1.qefe_lost_cst_ind AS 沉睡客户
       ,t3.lgp_nm            AS 对公客户法人客户名称
       ,t1.opn_org_nm        AS 开户机构
       ,t1.lctax_cert_no     AS 统一社会信用代码
       ,t1.idt_ctg_nm        AS 行业
       ,t1.opr_scp_dscr      AS 经营范围描述
       ,t4.mbl_nbr           AS 手机
       ,t4.cmp_tel_nbr       AS 公司电话
from SJXQ_SJ20250402221_CST_02          t1
left join edw.dim_cst_entp_lgp_inf_dd   t3 --对公客户法人信息表
on t1.cst_id=t3.cst_id
and t3.dt='20250331'
left join edw.dws_cst_bas_inf_dd        t4 --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
where t1.brc_org_nm = '广东四会泰隆村镇银行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_07 AS
SELECT  COUNT(t1.cst_id)                                          AS 2024年客户数量
       ,SUM(t2.trx_cnt_2024)                                      AS 2024年交易笔数
       ,SUM(t2.trx_amt_2024)                                      AS 2024年交易金额
       ,COUNT(case WHEN t1.levelkey = '1005' THEN t1.cst_id end)  AS 高风险客户数
       ,COUNT(case WHEN t1.levelkey = '1004' THEN t1.cst_id end)  AS 次高风险客户数
       ,COUNT(case WHEN t1.levelkey = '1003' THEN t1.cst_id end)  AS 中风险客户数
       ,COUNT(case WHEN t1.is_cdk = 1 THEN t1.cst_id end)         AS 涉查冻扣客户数
       ,COUNT(case WHEN t1.app_state_cd is not null THEN t1.cst_id end) 上报及排除可疑交易报告客户数
       ,COUNT(case WHEN t1.app_state_cd = '5' THEN t1.cst_id end) AS 上报可疑交易报告客户数
from SJXQ_SJ20250402221_CST_02 t1
left join(
    select cst_id
        ,count(1) as trx_cnt_2024
        ,sum(trx_amt) as trx_amt_2024
    from SJXQ_SJ20250402221_CST_04
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
where t1.brc_org_nm = '广东英德泰隆村镇银行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250402221_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250402221_CST_08 AS
SELECT  t1.cst_id            AS 客户号
       ,t1.cst_nm            AS 客户名称
       ,t1.cst_act_id        AS 客户账号
       ,t1.dep_act_id        AS 存款账号
       ,t1.qefe_slp_cst_ind  AS 睡眠户客户标识
       ,t1.qefe_lost_cst_ind AS 沉睡客户
       ,t3.lgp_nm            AS 对公客户法人客户名称
       ,t1.opn_org_nm        AS 开户机构
       ,t1.lctax_cert_no     AS 统一社会信用代码
       ,t1.idt_ctg_nm        AS 行业
       ,t1.opr_scp_dscr      AS 经营范围描述
       ,t4.mbl_nbr           AS 手机
       ,t4.cmp_tel_nbr       AS 公司电话
from SJXQ_SJ20250402221_CST_02          t1
left join edw.dim_cst_entp_lgp_inf_dd   t3 --对公客户法人信息表
on t1.cst_id=t3.cst_id
and t3.dt='20250331'
left join edw.dws_cst_bas_inf_dd        t4 --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
where t1.brc_org_nm = '广东英德泰隆村镇银行'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,app_state_cd) custs
from SJXQ_SJ20250402221_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250402221_CST_02
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250402221_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 2024年客户数量) custs
from SJXQ_SJ20250402221_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250402221_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 2024年客户数量) custs
from SJXQ_SJ20250402221_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250402221_CST_08
;
/*
01	19487	19487
*/
***余艳君_SJ2025052146_可疑案例排查.sql
﻿-- 余艳君_SJ2025052146_可疑案例排查
-- 1-交易数据
-- 统计2024年至2025年5月20日单个客户双边交易金额，分别取交易量最大的前500名对公客户、前500名对私客户（交易统计时剔除行内放贷、还贷、理财购买及赎回、行内同名转账交易）
--2024年至2025年5月20日客户双边交易金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_01 AS
SELECT *
from(
    select cst_id,cst_typ_cd,trx_cnt,trx_amt_tot
        ,row_number() over(partition by cst_typ_cd order by trx_amt_tot desc) rn
    from(
        SELECT  c.cst_id,c.cst_typ_cd
            ,count(1)       as trx_cnt
            ,SUM(a.trx_amt) as trx_amt_tot
        FROM edw.dwd_bus_dep_bal_chg_dtl_di a --存款余额发生明细
        INNER JOIN edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
        ON a.cst_act_id = b.cst_act_id AND  b.dt = '20250520'
        INNER JOIN edw.dws_cst_bas_inf_dd    c --客户基础信息汇总
        ON b.cst_id = c.cst_id AND c.dt = '20250520'
        and c.cst_id not like '0%'  --剔除同业客户 客户号是0开头
        -- 同名账户互转
        LEFT JOIN
        (
            SELECT  dep_act_id
                ,dtl_seq_nbr
            FROM edw.dwd_bus_dep_bal_chg_dtl_di AS a1
            INNER JOIN edw.dim_bus_dep_cst_act_inf_dd AS a2
            ON a1.cst_act_id = a2.cst_act_id AND a2.DT = '20250520'
            INNER JOIN edw.dim_bus_dep_cst_act_inf_dd AS a3
            ON a1.cnt_pty_cst_act_id = a3.cst_act_id AND a3.DT = '20250520'
            WHERE a1.dt >= '20240101'
            AND a1.dt <= '20250520'
            AND a2.cst_id = a3.cst_id
        ) AS t4
        ON a.dep_act_id = t4.dep_act_id AND a.dtl_seq_nbr = t4.dtl_seq_nbr
        WHERE a.dt >= '20240101'
        AND a.dt <= '20250520'
        and a.bal_fld_nm = 'DPLDGBAL' --动账
            ,'LN0002'	--贷款发放
            ,'LC0001'	--财富产品购买
            ,'LC0002'	--财富产品赎回
            ,'LC0003'	--财富产品兑付
            ,'LC0006'	--财富产品
        ) 	--剔除行内放贷、还贷、理财购买及赎回
        AND t4.dep_act_id is null 	--剔除同名账户互转
        GROUP BY  c.cst_id,c.cst_typ_cd
    )t1
)t1 where t1.rn<=500
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_02 AS
SELECT  t1.cst_id      AS 客户号
       ,t2.cst_chn_nm  AS 客户名称
       ,decode(t1.cst_typ_cd,'1','对私','2','对公') as 客户类型
       ,t3.prm_org_nm  AS 主管户机构名称
       ,c1.cd_val_dscr AS 行业
       ,c2.cd_val_dscr AS 职业
       ,t1.trx_cnt     AS 交易笔数
       ,t1.trx_amt_tot AS 交易金额_元
       ,t5.levelkey_nm as 风险等级
       ,case when t6.cst_id is not null then '是' else '否' end as 是否上报过可疑交易报告
from SJXQ_SJ2025052146_CST_01           t1
left join edw.dws_cst_bas_inf_dd        t2 --客户基础信息汇总
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250525'
left join adm_pub.adm_csm_cbas_mng_inf_dd t3 --客户集市-客户基础-客户管户信息
on t1.cst_id=t3.cst_id
and t3.dt='20250525'
left join edw.dwd_code_library_dd       c1
on  t2.idt_cd = c1.cd_val
and c1.dt = '20250525'
left join edw.dws_cst_idv_bas_inf_dd        t4 --个人客户基本信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250525'
left join edw.dwd_code_library_dd       c2
on  t4.OCP_CD = c2.cd_val
and c2.dt = '20250525'
left join(
    SELECT  SUBSTR(party_id,3,10) AS cst_id
        ,decode(levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
        ,statistic_dt
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr
    WHERE dt = '20250525'
)t5 on t1.cst_id=t5.cst_id
and t5.rn=1
left join(
    SELECT  distinct substr(t1.party_id, 3, 12) AS cst_id
    FROM    adm_upss.aml_t07_case_application_uh t1 --案例历史表
    WHERE   t1.dt = '20250525'
    AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250525'
    AND     t1.cast_type = '2' --案例类型:1:大额 2:可疑
    AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
)t6 on t1.cst_id=t6.cst_id
;
-- 2-多次预警均排除客户
-- 2024年至今，反洗钱系统中可疑案例预警在5次及以上但上报为0次的客户
-- （单个案例下若客户主体在5个及以下，则每个客户均纳入统计，单个案例下若客户主体在5个以上，则仅统计主客户）
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_03 AS
--案例下客户小于等于5且未上报的
SELECT  DISTINCT m.party_id AS 客户号
       ,m.party_chn_name    AS 客户名称
       ,t4.org_nm           AS 客户归属机构
       ,m.application_cou   AS 客户预警次数
       ,m.levelkey_nm       AS 风险等级
FROM
(
	SELECT  tt.party_id
	       ,tt.party_chn_name
	       ,tt.organkey
	       ,tt.levelkey
           ,decode(tt.levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
	       ,COUNT(DISTINCT tt.application_num) OVER ( PARTITION BY tt.party_id ) AS application_cou
	FROM
	(
		SELECT  DISTINCT t.party_id
		       ,t1.party_chn_name
		       ,t1.organkey
		       ,t.application_num
		       ,t.case_date
		       ,t2.levelkey
		FROM
		(
			SELECT  party_id
			       ,application_num
			       ,case_date
			       ,COUNT(party_id) OVER ( PARTITION BY application_num ) AS party_cou
			FROM ADM_UPSS.aml_t07_case_stcr_ky_uh
			WHERE dt = '20250525'
			AND to_char(case_date, 'yyyymmdd') >= '20240101'
		) t
		INNER JOIN adm_upss.adm_upss_aml_t47_party t1
		ON t.party_id = t1.party_id AND t1.dt = '20250525'
		INNER JOIN adm_upss.aml_t37_party_result_curr t2
		ON t.party_id = t2.party_id AND t2.dt = '20250525'
		INNER JOIN adm_upss.aml_t07_case_application_uh t3
		ON t.application_num = t3.application_num AND t3.dt = '20250525' AND t3.app_state_cd <> '5' --案例未被上报
		WHERE t.party_cou <= 5
	) TT
) m
left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
on  m.organkey = t4.org_id
and t4.dt = '20250525'
union all
--案例下客户大于5且未上报的
SELECT  DISTINCT m.party_id AS 客户号
       ,m.party_chn_name    AS 客户名称
       ,t4.org_nm           AS 客户归属机构
       ,m.application_cou   AS 客户预警次数
       ,m.levelkey_nm       AS 风险等级
FROM
(
	SELECT  tt.party_id
	       ,tt.party_chn_name
	       ,tt.organkey
	       ,tt.levelkey
           ,decode(tt.levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
	       ,COUNT(DISTINCT tt.application_num) OVER ( PARTITION BY tt.party_id ) AS application_cou
	FROM
	(
		SELECT  DISTINCT t.party_id
		       ,t1.party_chn_name
		       ,t1.organkey
		       ,t.application_num
		       ,t.case_date
		       ,t2.levelkey
		FROM adm_upss.aml_t07_case_application_uh t
		INNER JOIN adm_upss.adm_upss_aml_t47_party t1
		ON t.party_id = t1.party_id AND t1.dt = '20250525'
		INNER JOIN adm_upss.aml_t37_party_result_curr t2
		ON t.party_id = t2.party_id AND t2.dt = '20250525'
        INNER JOIN
        (
            SELECT application_num
            FROM ADM_UPSS.aml_t07_case_stcr_ky_uh
            WHERE dt = '20250525'
            AND to_char(case_date, 'yyyymmdd') >= '20240101'
            group by application_num having COUNT(party_id)>5
        ) t3 on t.application_num=t3.application_num
		WHERE t.dt = '20250525'
		AND t.app_state_cd <> '5' --案例未被上报
		AND to_char(t.case_date, 'yyyymmdd') >= '20240101'
	) TT
) m left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
on  m.organkey = t4.org_id
and t4.dt = '20250525'
;
-- 3-高风险等级客户
-- 全量高风险及较高风险客户
-- 客户号、客户名称、客户归属机构、风险等级、最近一次风险等级评定理由、是否上报过可疑交易报告
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_04 AS
select t1.cst_id as 客户号
    ,t1.party_chn_name  as 客户名称
    ,t1.org_nm as 客户归属机构
    ,t1.levelkey_nm as 风险等级
    ,t1.ADJUST_REASON as 最近一次风险等级评定理由
    ,case when t6.cst_id is not null then '是' else '否' end as 是否上报过可疑交易报告
from(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.party_chn_name                           --客户名称
	    ,t1.organkey                                 --客户机构
        ,t1.levelkey
        ,decode(t1.levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,t4.org_nm
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr     t1
    left join adm_upss.aml_t37_level_audit_curr t2 --评级等级调整当前表
    on T1.RESULEKEY = t2.RSLTKEY
    and t2.dt=t1.dt
    left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
    on  t1.organkey = t4.org_id
    and t4.dt = '20250525'
    WHERE t1.dt = '20250525'
)t1 left join(
    SELECT  distinct substr(t1.party_id, 3, 12) AS cst_id
    FROM    adm_upss.aml_t07_case_application_uh t1 --案例历史表
    WHERE   t1.dt = '20250525'
    AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250525'
    AND     t1.cast_type = '2' --案例类型:1:大额 2:可疑
    AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
)t6 on t1.cst_id=t6.cst_id
where t1.rn=1
;
-- 4-协查客户
-- 根据提供的协查客户清单，匹配相关报送情况
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_05 AS
SELECT  t1.party_id         AS 客户号
       ,t1.party_chn_name    AS 客户姓名
       ,t4.org_nm           AS 机构
       ,t2.levelkey          AS 风险等级
       ,decode(max(CASE WHEN t3.app_state_cd = '5' AND t3.cast_type = '2' THEN 1
            ELSE 0 END),1,'是',0,'否') AS 是否上报过可疑交易报告
FROM    adm_upss.aml_t07_case_stcr_ky_uh        t
INNER JOIN    adm_upss.adm_upss_aml_t47_party   t1
ON      t.party_id = t1.party_id
AND     t1.dt = '20250525'
INNER JOIN    adm_upss.aml_t37_party_result_curr t2
ON      t.party_id = t2.party_id
AND     t2.dt = '20250525'
INNER JOIN    adm_upss.aml_t07_case_application_uh t3
ON      t.application_num = t3.application_num
AND     t3.dt = '20250525'
    left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
    on  t1.organkey = t4.org_id
    and t4.dt = '20250525'
WHERE   t.dt = '20250525'
AND     to_char(t.case_date, 'yyyymmdd') >= '20240101'
    ,'1045747378','1696373231','1618828196','1027628538','1009498023','1013822258','1010268798','1005618553','2605202193'
    ,'2605203057','1005997131','1604615877','1006025718','1005829182','2603449251','1008942044','2601694262','2608456252'
    ,'1683839264','2603629388','1602458547','1623413167','1619603171','1003194637','1011914898','1009686853','1000120497'
    ,'1006128198','1000145621','1003981257','1006231722','1004664243','1025237086','2605813440','1026271700','2600425719'
    ,'2606961258','2604087068','2608303305','1010128324','1012100799','2602230667','1606962905','1003580294','1631284941'
    ,'1643489530','1016193531','1035875391','1012616524','1010101233','1000226826','1622243813','1026395169','1004389229'
    ,'2621175263','2602111220','2606530224','2609976636','1037736599')
group by t1.party_id,t1.party_chn_name,t4.org_nm,t2.levelkey
;
-- 6-案例意见与操作不符数据
-- 2024年至今全部被排除的可疑案例
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_06 AS
SELECT  DISTINCT t.party_id AS 客户号
       ,t1.party_chn_name   AS 客户姓名
       ,t4.org_nm         AS 机构
       ,t.application_num   AS 案例编号
       ,t2.application_advice as 最后一次编辑岗意见
FROM    adm_upss.aml_t07_case_application_uh t
INNER JOIN    adm_upss.adm_upss_aml_t47_party t1
ON      t.party_id = t1.party_id
AND     t1.dt = '20250525'
INNER JOIN    (
                  SELECT  t.application_num
                          ,t.application_advice
                          ,ROW_NUMBER() OVER ( PARTITION BY t.application_num ORDER BY t.last_upd_dt DESC ) AS rownum
                  FROM    adm_upss.aml_t07_app_movefate_uh t
                  WHERE   dt = '20250525'
                  AND     t.curr_post = 'P0102'
              ) t2
ON      t.application_num = t2.application_num
AND     t2.rownum = '1' --案例编辑岗最新的意见
    left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
    on  t1.organkey = t4.org_id
    and t4.dt = '20250525'
WHERE   t.dt = '20250525'
AND     t.app_state_cd <> '5' --案例都被排除
AND     to_char(t.case_date, 'yyyymmdd') >= '20240101';
-- 7-查冻扣客户清单
-- 2024年至今全部刑事查冻扣客户清单
-- 客户号、客户名称、客户归属机构、查冻扣次数、风险等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_07 AS
SELECT  t1.cst_id as 客户号
       ,t1.客户名称
       ,t1.查冻扣次数
       ,t3.prm_org_nm  AS 主管户机构名称
       ,t5.levelkey_nm AS 风险等级
    ,case when t6.cst_id is not null then '是' else '否' end as 是否上报过可疑交易报告
from(
    SELECT  t1.cst_id   --客户号
        ,t3.cst_chn_nm as 客户名称
        ,COUNT(1)       as 查冻扣次数
    FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd t1 --司法查冻扣汇总信息
    left join (
        select distinct cst_act_id
        from edw.dws_bus_dep_act_inf_dd  	--存款账户信息
        where dt='@@{yyyyMMdd}'
    )t2 on t1.cst_act_id=t2.cst_act_id
        INNER JOIN edw.dws_cst_bas_inf_dd    t3 --客户基础信息汇总
        ON t1.cst_id = t3.cst_id AND t3.dt = '20250520'
    WHERE t1.dt = '@@{yyyyMMdd}'
    and (nvl(t1.cst_id,'')<>'' or t2.cst_act_id is not null)
    AND t1.qry_ctrl_dt >= '20240101'
    AND ( t1.instt_typ_cd IN ( '04' , '05' ) OR ( ( t1.instt_nm LIKE '%法院%' OR t1.instt_typ_cd = '01' ) AND t1.LAW_DOC_ID LIKE '%刑%' ) )
    and (nvl(t1.cst_id,'')<>'' or nvl(t1.cst_act_id,'')<>'')
    GROUP BY  t1.cst_id,t3.cst_chn_nm
)t1
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join(
    SELECT  SUBSTR(party_id,3,10) AS cst_id
        ,decode(levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
        ,statistic_dt
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr
    WHERE dt = '20250525'
)t5 on t1.cst_id=t5.cst_id
and t5.rn=1
left join(
    SELECT  distinct substr(t1.party_id, 3, 12) AS cst_id
    FROM    adm_upss.aml_t07_case_application_uh t1 --案例历史表
    WHERE   t1.dt = '20250525'
    AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250525'
    AND     t1.cast_type = '2' --案例类型:1:大额 2:可疑
    AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
)t6 on t1.cst_id=t6.cst_id
;
-- 8-应控未控数据
-- 筛选2024年至今全部上报且控制措施选择了&ldquo;限制客户交易方式、规模、频率等，特别是非面对面业务的规模、频率&rdquo;和&ldquo;其他控制措施&rdquo;的案例
-- 客户号、客户名称、客户归属机构、案例编号、选择的控制措施、当前管控状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025052146_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052146_CST_08 AS
SELECT  t1.cst_id          AS 客户号
    ,t1.客户名称
    ,t2.prm_org_nm      AS 主管户机构名称
    ,t1.创建日期
    ,t1.application_num AS 案例编号
    ,t1.control_measures as 控制措施
    ,t3.cst_act_id  as 活期客户账号
    ,t3.账户状态
    ,CASE WHEN T8.cst_act_id IS NULL     THEN '否'
           WHEN T8.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,T8.fg_per_lmt                      AS 非柜单笔限额
    ,T8.fg_day_lmt                      AS 非柜日累计限额
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
from(
    SELECT distinct substr(t1.party_id, 3, 10) AS cst_id
        ,party_name	as	客户名称
        ,application_num                          --案例编号
        ,control_measures --控制措施
        ,substr(replace(t1.app_dt,'-',''),1,8) as 创建日期
    FROM    adm_upss.aml_t07_case_application_uh t1 --案例历史表
    WHERE   t1.dt = '20250525'
    AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250525'
    AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
    and nvl(t1.party_id,'')<>''  --null
)t1
left join adm_pub.adm_csm_cbas_mng_inf_dd           t2 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t2.cst_id
and t2.dt = '@@{yyyyMMdd}'
left join(
    select t1.cst_id,t1.cst_act_id                               --客户账号|C32
    from edw.dim_bus_dep_act_inf_dd t1              --存款账户信息
    left join edw.dwd_code_library_dd c1
    on t1.act_sts_cd = c1.cd_val
    and c1.dt = t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.lbl_prod_typ_cd='0'  --负债产品类型代码 1:定期产品|0:活期产品
    group by t1.cst_id,t1.cst_act_id
)t3 on t1.cst_id=t3.cst_id
left join(
    SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
        ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
        ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt='@@{yyyyMMdd}'
    left join edw.dwd_code_library_dd   c2
    on t1.frz_cls_cd = c2.cd_val
    and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
    and c2.dt='@@{yyyyMMdd}'
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='2'  --止付
    AND     t1.NFRZ_IND = '0'
)              t5 --止付
on t3.cst_act_id=t5.cst_act_id and t5.rn=1
left join (
    SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
        ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt='@@{yyyyMMdd}'
    WHERE   T1.DT = '@@{yyyyMMdd}'
    AND     T1.FRZ_SRC_CD='1'  --冻结
    AND     T1.NFRZ_IND = '0'
)              t6 --冻结
on t3.cst_act_id=t6.cst_act_id and t6.rn=1
left join (
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '@@{yyyyMMdd}'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)              t7 --关闭非柜面
on t3.cst_act_id=t7.cst_act_id and t7.rn=1
left join (
    SELECT  cengcgjz   as cst_act_id
        ,max(danciedu) as  fg_per_lmt
        ,max(leijiedu) as  fg_day_lmt
    FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
    WHERE   dt = '@@{yyyyMMdd}'
    AND     zhxeleix = '2'
    AND     shijbhao = 'FGMXIANE' -- 非柜面限额
    AND     edkzzhqi = '1D'
    group by cengcgjz
)              t8 --非柜面限额
on t3.cst_act_id=t8.cst_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,cst_typ_cd) custs
from SJXQ_SJ2025052146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052146_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052146_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052146_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052146_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号,案例编号) custs
from SJXQ_SJ2025052146_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052146_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号,案例编号,活期客户账号) custs
from SJXQ_SJ2025052146_CST_08
;
/*
01	1000	1000
02	1000	1000
03	35636	31480
04	39982	39982
05	28	23
06	83356	83356
07	59787	59787
08	3278	3231
*/
***余艳君_SJ2025060956_分村行交易前50客户.sql
-- 1-交易数据
-- 统计2024年至2025年5月20日单个客户双边交易金额，分别取交易量最大的前500名对公客户、前500名对私客户（交易统计时剔除行内放贷、还贷、理财购买及赎回、行内同名转账交易）
--2024年至2025年5月20日客户双边交易金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025060956_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060956_CST_01 AS
SELECT *
from(
    select brc_org_nm,cst_id,cst_typ_cd,trx_cnt,trx_amt_tot
        ,row_number() over(partition by brc_org_nm,cst_typ_cd order by trx_amt_tot desc) rn
    from(
        SELECT  c.cst_id,c.cst_typ_cd,t5.brc_org_nm
            ,count(1)       as trx_cnt
            ,SUM(a.trx_amt) as trx_amt_tot
        FROM edw.dwd_bus_dep_bal_chg_dtl_di a --存款余额发生明细
        INNER JOIN edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
        ON a.cst_act_id = b.cst_act_id AND  b.dt = '20250531'
        INNER JOIN edw.dws_cst_bas_inf_dd    c --客户基础信息汇总
        ON b.cst_id = c.cst_id AND c.dt = '20250531'
        and c.cst_id not like '0%'  --剔除同业客户 客户号是0开头
        -- 同名账户互转
        LEFT JOIN
        (
            SELECT  dep_act_id
                ,dtl_seq_nbr
            FROM edw.dwd_bus_dep_bal_chg_dtl_di AS a1
            INNER JOIN edw.dim_bus_dep_cst_act_inf_dd AS a2
            ON a1.cst_act_id = a2.cst_act_id AND a2.DT = '20250531'
            INNER JOIN edw.dim_bus_dep_cst_act_inf_dd AS a3
            ON a1.cnt_pty_cst_act_id = a3.cst_act_id AND a3.DT = '20250531'
            WHERE a1.dt >= '20240101'
            AND a1.dt <= '20250531'
            AND a2.cst_id = a3.cst_id
        ) AS t4
        ON a.dep_act_id = t4.dep_act_id AND a.dtl_seq_nbr = t4.dtl_seq_nbr
        inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
        on  c.cst_id = t3.cst_id
        and t3.dt = '20250531'
        inner join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
        on  t3.prm_org_id = t5.org_id
        and t5.dt = '20250531'
        and t5.brc_org_nm regexp '分行|村镇银行'
        WHERE a.dt >= '20240101'
        AND a.dt <= '20250531'
        and a.bal_fld_nm = 'DPLDGBAL' --动账
            ,'LN0002'	--贷款发放
            ,'LC0001'	--财富产品购买
            ,'LC0002'	--财富产品赎回
            ,'LC0003'	--财富产品兑付
            ,'LC0006'	--财富产品
        ) 	--剔除行内放贷、还贷、理财购买及赎回
        AND t4.dep_act_id is null 	--剔除同名账户互转
        GROUP BY  c.cst_id,c.cst_typ_cd,t5.brc_org_nm
    )t1
)t1 where t1.rn<=50
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025060956_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060956_CST_02 AS
SELECT  t1.cst_id      AS 客户号
       ,t2.cst_chn_nm  AS 客户名称
       ,decode(t1.cst_typ_cd,'1','对私','2','对公') as 客户类型
       ,t31.brc_org_nm  as 主管户分行
       ,t31.sbr_org_nm  as 主管户支行
       ,t3.prm_org_nm  AS 主管户机构名称
       ,c1.cd_val_dscr AS 行业
       ,c2.cd_val_dscr AS 职业
       ,t1.trx_cnt     AS 交易笔数
       ,t1.trx_amt_tot AS 交易金额_元
       ,t1.rn          as 交易名次
       ,t5.levelkey_nm as 风险等级
       ,case when t6.cst_id is not null then '是' else '否' end as 是否上报过可疑交易报告
from SJXQ_SJ2025060956_CST_01           t1
left join edw.dws_cst_bas_inf_dd        t2 --客户基础信息汇总
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250531'
left join adm_pub.adm_csm_cbas_mng_inf_dd t3 --客户集市-客户基础-客户管户信息
on t1.cst_id=t3.cst_id
and t3.dt='20250531'
inner join edw.dim_hr_org_mng_org_tree_dd            t31 --考核机构树
on  t3.prm_org_id = t31.org_id
and t31.dt = '20250531'
left join edw.dwd_code_library_dd       c1
on  t2.idt_cd = c1.cd_val
and c1.dt = '20250531'
left join edw.dws_cst_idv_bas_inf_dd        t4 --个人客户基本信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250531'
left join edw.dwd_code_library_dd       c2
on  t4.OCP_CD = c2.cd_val
and c2.dt = '20250531'
left join(
    SELECT  SUBSTR(party_id,3,10) AS cst_id
        ,decode(levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
        ,statistic_dt
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr
    WHERE dt = '20250531'
)t5 on t1.cst_id=t5.cst_id
and t5.rn=1
left join(
    SELECT  distinct substr(t1.party_id, 3, 12) AS cst_id
    FROM    adm_upss.aml_t07_case_application_uh t1 --案例历史表
    WHERE   t1.dt = '20250531'
    AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250531'
    AND     t1.cast_type = '2' --案例类型:1:大额 2:可疑
    AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
)t6 on t1.cst_id=t6.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025060956_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060956_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025060956_CST_02
***余艳君_SJ2025071531_查冻扣原因.sql
-- 余艳君_SJ2025071531_查冻扣原因
-- 2024年至今，附件清单中客户的查冻扣机构及查冻扣原因
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025071531_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071531_CST_01 AS
SELECT  col_1 --客户号
       ,col_2 --客户名称
       ,col_3 --查冻扣次数
       ,col_4 --主管户机构名称
from lab_bigdata_dev.qbi_file_20250717_10_30_29_0
where pt<>''
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071531_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071531_CST_02 AS
SELECT  t1.col_1       AS 客户号
       ,t1.col_2       AS 客户名称
       ,t1.col_3       AS 查冻扣次数
       ,t1.col_4       AS 主管户机构名称
       ,t2.qry_ctrl_dt AS 查控日期
       ,t2.instt_nm    AS 查冻扣机构
       ,t2.exe_rsn     AS 查冻扣原因
       ,row_number() over(partition by t1.col_1 order by t2.qry_ctrl_dt) as 序号
from SJXQ_SJ2025071531_CST_01   t1
left join edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd t2 --司法查冻扣汇总信息
on t1.col_1=t2.cst_id
and t2.dt = '20250716'
AND t2.qry_ctrl_dt >='20240101'
AND ( t2.instt_typ_cd IN ( '04' , '05' ) OR ( ( t2.instt_nm LIKE '%法院%' OR t2.instt_typ_cd = '01' ) AND t2.LAW_DOC_ID LIKE '%刑%' ) )
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025071531_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071531_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025071531_CST_02
***倪品品_SJ2025042567_湖州分行社区信息.sql
-- 因分行拟开展社区归位管理工作，下周二（4.29）进行内部班子管理分析，需针对分行全量客户社区情况进行分析，截至250425即可
-- 湖州分行全量客户社区地址在跨社区版块清单 250425
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ20250422126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422126_CST_01 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.cst_typ_cd                               --客户类型|C1
    ,decode(t1.cst_typ_cd,'1','对私','2','对公') as 客户类型
	,case when length(t1.mbl_nbr)>=7 then t1.mbl_nbr when length(t1.fml_tel_nbr)<=3 then t1.mbl_nbr
        else t1.fml_tel_nbr end as mbl_nbr       --手机|C32
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t1.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t1.fml_adr                                  --家庭地址|C256
    ,t2.prm_mgr_id                               --主管户客户经理工号
	,t2.prm_mgr_nm                               --主管户客户经理姓名
	,t2.prm_org_id                               --主管户机构号
	,t2.prm_org_nm                               --主管户机构名称
	,t2.forml_cst_ind                            --正式客户标识
	,t2.ptt_cst_ind                              --潜在客户标识
    ,t3.sbr_org_id,t3.tem_org_id
    ,t3.sbr_org_nm,t3.tem_org_nm
    ,l1.vld_cst             --有效户：0否1是
    ,l2.vld_dep_act         --有效存款户：0否1是
    ,l3.vld_loan_act        --有效贷款户：0否1是
    ,l4.vld_wlth_cst        --有效财富客户：0否1是
    ,l5.vld_itnl_bsn_cst    --有效国际业务客户：0否1是
from edw.dws_cst_bas_inf_dd                     t1 --客户基础信息汇总表
inner join adm_pub.adm_csm_cbas_mng_inf_dd      t2 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t2.cst_id
and t2.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd       t3 --考核机构树
on  t2.prm_org_id = t3.org_id
and t3.dt = t1.dt
and t3.brc_org_nm = '湖州分行'
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd   l1
on t1.cst_id = l1.cst_id
and l1.dt=t1.dt
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     l2
on t1.cst_id = l2.cst_id
and l2.dt=t1.dt
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd l3
on t1.cst_id = l3.cst_id
and l3.dt=t1.dt
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_wlth_l2_dd l4
on t1.cst_id = l4.cst_id
and l4.dt=t1.dt
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_mid_bsn_l2_dd l5
on t1.cst_id = l5.cst_id
and l5.dt=t1.dt
where t1.dt='20250425'
;
-- 地址
DROP   TABLE IF     EXISTS SJXQ_SJ20250422126_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422126_CST_02 AS
SELECT  t1.cst_id
       ,t2.dtl_addr        AS 信贷经营地址
       ,t3.dtl_addr        AS 信贷户籍地址
       ,t4.dtl_addr        AS 信贷居住地址
       ,t5.dtl_addr        AS 信贷办公地址
       ,t6.dtl_addr        AS 信贷注册地址
       ,t7.dtl_addr        AS 信贷主地址
       ,c1.cd_val_dscr     AS 信贷主地址类型
from(
    select distinct cst_id
    from SJXQ_SJ20250422126_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250425' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250425' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '20250425' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --家庭地址
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '20250425' and t5.del_ind='0' 	--未删除
AND t5.addr_typ = '050400' --办公地址
LEFT JOIN edw.loan_cst_ctc_addr t6
ON t1.cst_id = t6.cst_id and t6.del_ind='0' 	--未删除
AND t6.dt = '20250425'
AND t6.addr_typ = '050800' --注册地址
LEFT JOIN edw.loan_cst_ctc_addr t7
ON t1.cst_id = t7.cst_id and t7.del_ind='0' 	--未删除
AND t7.dt = '20250425'
AND t7.main_addr_ind = '1' --主地址
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t7.addr_typ=c1.cd_val
and C1.DT = '20250425'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250422126_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422126_CST_03 AS
SELECT  t1.cst_id           AS 客户号
       ,t1.cst_chn_nm       AS 客户姓名
       ,t1.客户类型
       ,t1.mbl_nbr          AS 联系方式
       ,t1.forml_cst_ind    AS 正式客户标识
       ,t1.ptt_cst_ind      AS 潜在客户标识
       ,t1.vld_cst          AS 有效户_0否1是
       ,t1.vld_loan_act     AS 有效贷款户_0否1是
       ,t1.vld_dep_act      AS 有效存款户_0否1是
       ,t1.vld_wlth_cst     AS 有效财富客户_0否1是
       ,t1.vld_itnl_bsn_cst AS 有效国际业务客户_0否1是
       ,t4.crd_amt          AS 授信金额
       ,t4.use_crd_bal      AS 用信余额
       ,t5.dep_bal          AS 存款余额
       ,t1.sbr_org_id       AS 主管户支行机构号
       ,t1.sbr_org_nm       AS 主管户支行名称
       ,t1.tem_org_id       AS 主管户团队机构号
       ,t1.tem_org_nm       AS 主管户团队名称
       ,t1.prm_mgr_id       AS 主管户客户经理工号
       ,t1.prm_mgr_nm       AS 主管户客户经理姓名
       ,t2.信贷户籍地址
       ,t2.信贷居住地址
       ,t2.信贷经营地址
       ,t2.信贷办公地址
       ,t2.信贷注册地址
       ,t2.信贷主地址
       ,t1.reg_adr          AS 户籍地址or注册地址
       ,t1.wrk_adr          AS 工作单位地址or经营所在地地址
       ,t1.fml_adr          AS 家庭地址
       ,decode(t3.main_add_flag,'1','经营','2','通讯','3','家庭','4','户籍','') AS 主地址类型
       ,t3.main_add         AS 主地址
       ,t6.sub_cmnt_id      AS 子社区编号
       ,t7.cmnt_nm          AS 子社区名称
       ,t6.cprh_cmnt_id     AS 综合社区编号
       ,t8.cmnt_nm          AS 综合社区名称
       ,t6.cprh_cmnt_plt_id AS 综合社区板块编号
       ,t9.cmnt_nm          AS 综合社区板块名称
from SJXQ_SJ20250422126_CST_01      t1
left join SJXQ_SJ20250422126_CST_02 t2
on  t1.cst_id=t2.cst_id
left join edw.xwdt_xw_customer      t3
on t1.cst_id=t3.cust_no
and t3.dt = '20250425'
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	t4 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t4.cst_id
and t4.dt = '20250425'
left join adm_pub.adm_csm_cbus_dep_inf_dd	    t5 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt = '20250425'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t2.cst_id = t6.cst_id
AND     t6.dt = '20250425'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.cprh_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20250425'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t8
ON      t6.sub_cmnt_id = t8.cmnt_enc
AND     t8.dt = '20250425'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t9
ON      t6.cprh_cmnt_plt_id = t9.cmnt_enc
AND     t9.dt = '20250425'
;
SElECT '03' seq, *
from lab_sjxq.SJXQ_SJ20250422126_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250422126_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250422126_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250422126_CST_03
***傅小红_SJ20250311171_金融机构监管评估.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 于彪
-- 创建日期: 2025-03-19 18:17:03
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- report_organkey = 'C1406344000011' 	英德
-- organkey LIKE '4461%' 	英德
-- brc_org_nm = '广东英德泰隆村镇银行'
/*5.1客户尽职调查（初次识别）、风险等级划分、身份资料保存情况
1.对建立业务关系的客户与符合条件的一次性交易客户开展尽职调查，准确了解客户及代理人、受益所有人身份信息，并完整保存；
2.客户洗钱风险分类管理机制完善，风险等级划分方法、流程或指标合理，能够及时划分和调整客户洗钱风险等级；
3.全面、准确保存客户身份识别所获取的身份资料及客户尽职调查工作记录，能够以客户为单位实现统一查询、更新和管理，身份资料便于客户尽职调查、可疑交易监测与反洗钱调查使用；
（保险、支付等行业客户尽调以达到法规要求起点金额或其他条件为前提）
*/
-- 5.1.f.最近一次自查存量客户信息完整率（法定基本信息全部具备的客户/全部客户）的时间，法规规定的个人客户要素信息完整和对公客户要素信息完整的客户比例分别是？
-- （计算完整率时，名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、个人客户完整：客户名称、客户名称、证件类型、证件类型、证件号码、证件到期日、客户国籍、性别、客户职业均有值，且居住地址/户籍地址任已一项有值,手机号码/联系电话任已一项有值。
-- 名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 2、个人客户：截至2024年底，开立账户的自然人客户及办理过网贷的自然人客户，名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.fct_idv_dep_act_inf_dd  个人存量账户信息表
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
--odps.adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD  客户集市-客户基础-对私客户基础信息
--odps.adm_pub.adm_csm_cbas_org_bas_inf_dd  客户集市客户基础属性字段处理
-- 暂停非柜
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_01 AS
SELECT  distinct cst_act_id
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '20241231'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_02 AS
SELECT  t0.cst_id           --客户号
       ,t0.cst_chn_nm       --客户名称
       ,t00.doc_typ_cd      --证件类型
       ,t00.doc_nbr         --证件号
       ,t00.doc_mtu_dt      --证件到期日
       ,t0.ntn_cd           --客户国籍
       ,t0.gdr_cd           --性别
       ,t0.ocp_cd           --职业
	,case when length(t00.fml_adr)<length(t00.reg_adr) then t00.reg_adr else t00.fml_adr end AS adr --家庭地址_户籍地址
	,case when length(t00.mbl_nbr)<length(t00.fml_tel_nbr) then t00.fml_tel_nbr else t00.mbl_nbr end AS tel --手机_家庭电话
       ,t1.是否全部销户
       ,t2.网贷余额
       ,t3.不收不付标识
       ,t4.只收不付标志
       ,t5.暂停非柜面
FROM edw.dim_cst_idv_bas_inf_dd t0 -- 个人客户基本信息 gdr_cd性别ocp_cd职业ntn_cd国籍
INNER JOIN edw.dws_cst_bas_inf_dd t00 --客户基础信息汇总表 证件号及到期日
ON t0.cst_id = t00.cst_id AND t00.dt = '20241231'
LEFT JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM edw.dim_cst_idv_bas_inf_dd a
	-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息 账户状态不准 下同 2000005133
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	WHERE a.dt = '20241231'
	GROUP BY  a.cst_id
) t1 -- t1判断是否全部销户
ON t0.cst_id = t1.cst_id
LEFT JOIN
(
	SELECT  a.cst_id
	       ,SUM(b.ctr_bal) AS 网贷余额
	FROM edw.dim_cst_idv_bas_inf_dd a
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd b -- 信贷合同信息
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	LEFT JOIN edw.dim_bus_loan_pd_inf_dd c -- 信贷产品信息
	ON b.pd_cd = c.pd_cd AND c.dt = '20241231'
	WHERE c.pd_nm IN ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
	AND a.dt = '20241231'
	GROUP BY  a.cst_id
) t2 -- t2判断互联网贷款余额
ON t0.cst_id = t2.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM edw.dim_cst_idv_bas_inf_dd a
			-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
			WHERE a.dt = '20241231'
			UNION
			SELECT  a.cst_id
			       ,'1' AS act_cls_frz_ind -- 封闭冻结
			FROM edw.dim_cst_idv_bas_inf_dd a
			INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
            AND (b.card_sts_cd IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) or b.LATE_CARD_IND <> '1')
            AND b.dt = '20241231'
			WHERE a.dt = '20241231'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = '1'
	AND min_ = '1' -- 只保留所有账户都不收不付的客户
) t3
ON t0.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20241231'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t0.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join SJXQ_SJ20250311171_CST_01  t2  --暂停非柜
        on t1.cst_act_id=t2.cst_act_id
        where t1.dt='20241231'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INner join(
    SELECT DISTINCT cst_id
    -- from edw.dim_bus_dep_cst_act_inf_dd
	from edw.dws_bus_dep_act_inf_dd
    where dt='20241231' and act_sts_cd='A'
)t6 on t1.cst_id=t6.cst_id
WHERE t0.dt = '20241231'
;
-- 3、对公客户：客户名称、证件类型、证件号码、证件到期日、客户国籍、经营范围、组织机构类型、注册地址、法定代表人、法定代表人证件类型、法定代表人证件号、
-- 法定代表人证件到期日、实际控制人名称、实际控制人证件类型、实际控制人证件号码、实际控制人证件到期日、受益所有人名称、受益所有人证件类型、
-- 受益所有人证件号码、受益所有人证件到期日、受益所有人地址。名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 4、截至2024年底，开立账户的对公客户，名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_03 AS
SELECT  t0.cst_id                              --客户号
       ,t0.cst_chn_nm                          --客户名称
       ,t0.doc_typ_cd                          --证件类型
       ,t0.doc_nbr                             --证件号
       ,t0.doc_mtu_dt                          --证件到期日
       ,t00.opr_scp_dscr                       --经营范围
       ,COALESCE(t000.reg_adr,t000.wrk_adr) AS adr --地址
       ,b1.cst_chn_nm     AS fr_cst_chn_nm 		--法定代表人
       ,b1.prm_doc_typ_cd AS fr_prm_doc_typ_cd  --法人证件类型
       ,b1.prm_doc_nbr    AS fr_prm_doc_nbr     --法人证件号
       ,b1.prm_doc_mtu_dt AS fr_prm_doc_mtu_dt  --法人证件到期日
       ,b2.cst_chn_nm     AS sk_cst_chn_nm      --实控人名称
       ,b2.prm_doc_typ_cd AS sk_prm_doc_typ_cd  --法人证件类型
       ,b2.prm_doc_nbr    AS sk_prm_doc_nbr     --实控人证件号码
       ,b2.prm_doc_mtu_dt AS sk_prm_doc_mtu_dt  --实控人证件到期日
       ,b3.cst_chn_nm     AS sy_cst_chn_nm      --受益人名称
       ,b3.prm_doc_typ_cd AS sy_prm_doc_typ_cd  --受益人证件类型
       ,b3.prm_doc_nbr    AS sy_prm_doc_nbr     --受益人证件号码
       ,b3.prm_doc_mtu_dt AS sy_prm_doc_mtu_dt  --受益人证件到期日
       ,t1.是否全部销户
       ,t2.网贷余额
       ,t3.不收不付标识
       ,t4.只收不付标志
       ,t5.暂停非柜面
FROM adm_pub.adm_csm_cbas_org_bas_inf_dd t0 -- 客户集市客户基础属性字段处理
LEFT JOIN edw.dim_cst_entp_bas_inf_dd t00 --企业客户表
ON t0.cst_id = t00.cst_id AND t00.dt = '20241231'
LEFT JOIN edw.dws_cst_bas_inf_dd t000
ON t0.cst_id = t000.cst_id AND t000.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a1 --客户关联关系信息
ON t0.cst_id = a1.cst_id AND a1.dt = '20241231' AND a1.rel_typ_cd = '0101' --法人
and LENGTH(a1.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b1 --客户基本信息
ON a1.rel_cst_id = b1.cst_id AND b1.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a2 --客户关联关系信息
ON t0.cst_id = a2.cst_id AND a2.dt = '20241231' AND a2.rel_typ_cd = '0109' --实控人
and LENGTH(a2.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b2 --客户基本信息
ON a2.rel_cst_id = b2.cst_id AND b2.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a3 --客户关联关系信息
ON t0.cst_id = a3.cst_id AND a3.dt = '20241231' AND a3.rel_typ_cd LIKE '09%' --受益人
and LENGTH(a3.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b3 --客户基本信息
ON a3.rel_cst_id = b3.cst_id AND b3.dt = '20241231'
LEFT JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	WHERE a.dt = '20241231'
	GROUP BY  a.cst_id
) t1 -- t1判断是否全部销户
ON t0.cst_id = t1.cst_id
LEFT JOIN
(
	SELECT  a.cst_id
	       ,SUM(b.ctr_bal) AS 网贷余额
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd b -- 信贷合同信息
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	LEFT JOIN edw.dim_bus_loan_pd_inf_dd c -- 信贷产品信息
	ON b.pd_cd = c.pd_cd AND c.dt = '20241231'
	WHERE c.pd_nm IN ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
	AND a.dt = '20241231'
	GROUP BY  a.cst_id
) t2 -- t2判断互联网贷款余额
ON t0.cst_id = t2.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
			-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
			WHERE a.dt = '20241231'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = 1
	AND min_ = 1 -- 只保留所有账户都不收不付的客户
) t3
ON t1.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		FROM  edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20241231'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t0.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join SJXQ_SJ20250311171_CST_01  t2  --暂停非柜
        on t1.cst_act_id=t2.cst_act_id
        where t1.dt='20241231'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INner join(
    SELECT DISTINCT cst_id
    -- from edw.dim_bus_dep_cst_act_inf_dd
	from edw.dws_bus_dep_act_inf_dd
    where dt='20241231' and act_sts_cd='A'
)t6 on t1.cst_id=t6.cst_id
WHERE t0.dt = '20241231'
;
--5.1.f
SELECT  '5.1.f1 个人客户完整数' id_nm
       ,COUNT(distinct aa.cst_id) as 客户数
FROM SJXQ_SJ20250311171_CST_02 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
where nvl(cst_chn_nm,'')<>''
and   nvl(doc_typ_cd,'')<>''
and   nvl(doc_nbr   ,'')<>''
and   nvl(doc_mtu_dt,'')<>''
and   nvl(ntn_cd    ,'')<>''
and   nvl(gdr_cd    ,'')<>''
and   nvl(ocp_cd    ,'')<>''
and   nvl(adr       ,'')<>''
and   nvl(tel       ,'')<>''
and   是否全部销户 = '否'
and   (网贷余额 > 0 or 网贷余额 is null)
and   (不收不付标识 is null or 不收不付标识 = '')
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
union all
SELECT  '5.1.f2 个人客户数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM SJXQ_SJ20250311171_CST_02 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
WHERE 是否全部销户 = '否'
AND (网贷余额 > 0 or 网贷余额 is null) --5245667
AND (不收不付标识 is null or 不收不付标识 = '') --5189441
and (只收不付标志 is null or 只收不付标志 = '')
and (暂停非柜面 is null or 暂停非柜面 = '')
union all
SELECT  '5.1.f3 对公客户完整数' id_nm
       ,COUNT(distinct aa.cst_id) as 客户数
FROM SJXQ_SJ20250311171_CST_03 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
where nvl(cst_chn_nm       ,'')<>''
and   nvl(doc_typ_cd       ,'')<>''
and   nvl(doc_nbr          ,'')<>''
and   nvl(doc_mtu_dt       ,'')<>''
and   nvl(opr_scp_dscr     ,'')<>''
and   nvl(adr              ,'')<>''
and   nvl(fr_cst_chn_nm    ,'')<>''
and   nvl(fr_prm_doc_typ_cd,'')<>''
and   nvl(fr_prm_doc_nbr   ,'')<>''
and   nvl(fr_prm_doc_mtu_dt,'')<>''
and   nvl(sk_cst_chn_nm    ,'')<>''
and   nvl(sk_prm_doc_typ_cd,'')<>''
and   nvl(sk_prm_doc_nbr   ,'')<>''
and   nvl(sk_prm_doc_mtu_dt,'')<>''
and   nvl(sy_cst_chn_nm    ,'')<>''
and   nvl(sy_prm_doc_typ_cd,'')<>''
and   nvl(sy_prm_doc_nbr   ,'')<>''
and   nvl(sy_prm_doc_mtu_dt,'')<>''
and   是否全部销户 = '否'
and   (网贷余额 > 0 or 网贷余额 is null)
and   (不收不付标识 is null or 不收不付标识 = '') --36127  --36209 --280744
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
union all
SELECT  '5.1.f4 对公客户数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM SJXQ_SJ20250311171_CST_03 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
WHERE 是否全部销户 = '否'
AND (网贷余额 > 0 or 网贷余额 is null)
AND (不收不付标识 is null or 不收不付标识 = '') --384902
and (只收不付标志 is null or 只收不付标志 = '')
and (暂停非柜面 is null or 暂停非柜面 = '')
;
/*
-- 剔除 只收不付 暂停非柜面
-- 限制账户状态正常
-- 换表 edw.dws_bus_dep_act_inf_dd
5.1.f1 个人客户完整数	16101
5.1.f2 个人客户数	16101
5.1.f3 对公客户完整数	401
5.1.f4 对公客户数	401
*/
-- 5.1.h.客户洗钱风险分类划分的级别和各级别数量、占比
-- 1、在2024年12月31日时点，最终人工认定为高风险、较高风险、一般风险、较低风险、低风险的客户有多少
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_04 AS
SELECT  '5.1.h 洗钱风险等级' id_nm
       ,S.LEVELKEY
       ,COUNT(distinct bb.cst_id) as 客户数
FROM
(
	SELECT  A.PARTY_ID
	       ,A.LEVELKEY
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND A.DT = '20241231'
	UNION
	SELECT  T.PARTY_ID
	       ,T.LEVELKEY
	FROM
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		AND NOT EXISTS (
		SELECT  1
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
		WHERE A.PARTY_ID = B.PARTY_ID
		AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND B.DT = '20241231')
	) T
	WHERE RN = 1
) S inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on substr(s.party_id,3) = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
GROUP BY  S.LEVELKEY
;
select t1.id_nm
       ,t1.LEVELKEY
       ,t1.客户数
       ,round(t1.客户数/t2.total_custs,4) as 占比
from SJXQ_SJ20250311171_CST_04 t1
left join(
    select id_nm,sum(客户数) as total_custs
    from SJXQ_SJ20250311171_CST_04
    GROUP BY id_nm
)t2 on  t1.id_nm=t2.id_nm
;
-- 5.1.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比 (少了部分新开户客户没有评级)
--账户均已销户的客户
DROP TABLE IF EXISTS SJXQ_SJ20250311171_CST_05 PURGE;
create table IF NOT EXISTS SJXQ_SJ20250311171_CST_05  as
select  customer_id     --？12
       ,count(1)    AS  CLOSE_ACCT_SM
from adm_upss.aml_t47_agreement    -- 反洗钱账户表
group by customer_id
having  count(1)=sum( case when acct_status_cd='1' then 1 else 0 end ) --？
;
SELECT  '5.1.i1 近一年建立业务关系客户数' id_nm
       ,COUNT(distinct SUBSTR(aa.PARTY_ID,3)) num
FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
INNER JOIN edw.dws_cst_bas_inf_dd SS
ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
WHERE aa.dt = '20241231'
AND SS.file_dt >= '20240101' --开户日期
AND SS.file_dt <= '20241231' --开户日期
AND aa.CUST_KIND <> '3'     --1有账户的客户 2无账户的客户 3一次性金融服务客户 4境外卡客户
AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ20250311171_CST_05 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID
)
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_06 AS
SELECT  '5.1.i2 近一年建立业务关系客户数' id_nm
       ,S.LEVELKEY
       ,COUNT(SUBSTR(S.PARTY_ID,3)) as 客户数
FROM
(
	SELECT  aa.PARTY_ID
	       ,CASE WHEN DD.LEVELKEY IS NULL THEN '1001'  ELSE DD.LEVELKEY END AS LEVELKEY
	FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
	INNER JOIN edw.dws_cst_bas_inf_dd SS
	ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
	LEFT JOIN
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
		AND A.DT = '20250115'
		UNION
		SELECT  T.PARTY_ID
		       ,T.LEVELKEY
		FROM
		(
			SELECT  A.PARTY_ID
			       ,A.LEVELKEY
			       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
			FROM adm_upss.AML_T37_PARTY_RESULT_UH A
			WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND A.DT = '20250115'
			AND NOT EXISTS (
			SELECT  1
			FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
			WHERE A.PARTY_ID = B.PARTY_ID
			AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND B.DT = '20250115')
		) T
		WHERE RN = 1
	) dd
	ON AA.PARTY_ID = dd.party_id
	WHERE aa.dt = '20241231'
	AND SS.file_dt >= '20240101' --开户日期
	AND SS.file_dt <= '20241231' --开户日期
	AND aa.CUST_KIND <> '3'
	AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ20250311171_CST_05 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID)
) s
GROUP BY  s.LEVELKEY
;
select t1.*,round(t1.客户数/t2.total_custs,4) as 占比
from SJXQ_SJ20250311171_CST_06 t1
left join(
    select id_nm,sum(客户数) as total_custs
    from SJXQ_SJ20250311171_CST_06
    group by id_nm
)t2 on t1.id_nm=t2.id_nm
;
-- 5.1.j.近一年内，在建立业务关系环节对客户采取强化尽职调查的客户数量
-- 5.1.k.近一年内，在建立业务关系环节，经尽职调查认为风险过高或无法有效识别客户身份而拒绝建立业务关系的客户人次和占比
-- 5.1.l.近一年内，在建立业务关系或其他线下业务办理环节，发现客户身份信息或行为异常而上报可疑交易报告或向公安机关报案的数量（非系统监测预警方式）
-- 5.1.m.近一年内，因信息不完整而未予解付的跨境汇款笔数
-- (1)表名：Irmt_Master,日期：remit_Date 处理类型为退汇：deal_Type='RETURN'
-- 2851
SELECT  '5.1.m 未解付跨境汇款笔数' id_nm
       ,COUNT(distinct ir_no) 	as 笔数 --汇款编号
FROM edw.niss_irmt_master a
INNER JOIN edw.dim_hr_org_mng_org_tree_dd b --机构树
ON a.trans_org_id = b.org_id AND b.dt = '20241231' AND b.brc_org_nm = '广东英德泰隆村镇银行'
WHERE a.dt = '20241231'
AND SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20240101'
AND SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20241231'
AND deal_Type = 'RETURN' --处理类型为退汇
;
/*5.2持续尽职调查与高风险客户强化尽调
1.建立专门部门或指定部门、岗位开展强化客户尽职调查和风险管控工作，并确保岗位人员能够全面获取客户有关身份、交易信息，直接或通过业务部门向客户补充了解资金来源、交易目的等信息；
2.根据客户尽职调查和风险等级划分结果，对高风险客户包括外国政治公众人物等采取报请高管层审批等强化尽调措施，及时对超出风险接受程度的客户采取管控措施，使本机构相关产品、业务被客户利用与洗钱的风险显著降低；
3.风险管控措施与客户或交易的风险程度相匹配，避免一刀切或&ldquo;去风险化&rdquo;。
*/
-- 5.2.d.近一年内发现个人身份证件过期的数量，因身份证件过期且无合理理由未更新而中止业务关系的客户数量
-- 121618
SELECT  '5.2.d1 近半年证件过期数' id_nm
       ,COUNT(distinct party_id) as 客户数
FROM
(
	SELECT  a.party_id,a.ORGANKEY
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240701'
	AND b.card_end_dt <= '20241231'
	--AND (a.party_status_cd = '0' or b.flag = '0')
) T INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON t.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
union all
SELECT  '5.2.d2 近半年证件过期中止业务数' id_nm
       ,COUNT(distinct party_id)
FROM
(
	SELECT  a.party_id,a.ORGANKEY
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	       ,SUBSTR(a.host_cust_id,3) AS cst_id
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240701'
	AND b.card_end_dt <= '20241231'
) T INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON t.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
inner JOIN
(
	SELECT  cst_id
	       ,MAX(zf) AS max_zf
	FROM
	(
		SELECT  cst_act_id
		       ,cst_id
		       ,CASE WHEN act_cls_frz_ind = '1' or act_rcv_oly_ind = '1' THEN 0  ELSE 1 END AS zf
		FROM edw.dim_bus_dep_cst_act_inf_dd --客户存款账户信息
		WHERE dt = '20241231'
	) AS a1
	GROUP BY  cst_id
	HAVING max_zf = 0
) AS t1
ON t.cst_id = t1.cst_id
;
-- 5.2.f.近一年内发现客户身份注销的数量及终止业务关系的数量，从发现注销到完成终止业务关系流程的最长时间
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_07 AS
SELECT  dt             --查询日期
       ,geb_creditcode --统一信用代码
       ,geb_entname    --企业名称
       ,geb_entstatus  --经营状态 --工商状态
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
FROM
(
	SELECT  dt
	       ,geb_creditcode
	       ,geb_entname
	       ,geb_entstatus
	       ,geb_candate
	       ,geb_revdate
	       ,geb_orgcodes
	       ,geb_regno
	       ,ROW_NUMBER() OVER ( PARTITION BY geb_entname ORDER BY  dt DESC ) rnk
	FROM edw.outd_gs_entinfo_basic
	WHERE dt >= '20240101'
	AND dt <= '20241231'
) t
WHERE t.rnk = 1
;
-- 新口径
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_08 AS
SELECT *
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC) AS RN
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY is_abnormal desc,GEB_HOSTSENDTIME ASC) AS RN2
FROM    (
    SELECT  GEB_ENTNAME             --客户名称
        ,GEB_CREDITCODE             --统一社会信用代码
        ,GEB_ENTTYPE                --企业机构类型
        ,GEB_FRNAME                 --法定代表人负责人执行事务合伙人
        ,GEB_ENTSTATUS              --经营状态
        ,GEB_RECCAP                 --实收资本万元
        ,GEB_REGCAPCUR              --注册资本币种
        ,GEB_REGORGCITY             --所在城市
        ,GEB_REGORGDISTRICT         --所在区县
        ,GEB_ZSOPSCOPE              --经营业务范围
        ,GEB_DOM                    --住所
        ,GEB_INDUSTRYCONAME         --国民经济代码名称
        ,geb_esdate                 --成立日期
        ,geb_othertel               --其他电话
        ,GEB_HOSTSENDTIME           --geb_hostsendtime 交易发送主机时间
        ,geb_regorgprovince         --所在省份
        ,geb_regorgcode             --注册地址行政编号
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
	   ,dt
    FROM    edw.OUTD_GS_ENTINFO_BASIC   --工商企业-企业基本信息
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(GEB_CREDITCODE,'')<>''
    UNION ALL
    SELECT  dt_entname         AS GEB_ENTNAME
        ,dt_creditcode         AS GEB_CREDITCODE
        ,dt_enttype            AS GEB_ENTTYPE
        ,dt_frname             AS GEB_FRNAME
        ,dt_entstatus          AS GEB_ENTSTATUS
        ,dt_reccap             AS GEB_RECCAP
        ,dt_regcapcur          AS GEB_REGCAPCUR
        ,dt_regorgcity         AS GEB_REGORGCITY
        ,dt_regorgdistrict     AS GEB_REGORGDISTRICT
        ,dt_zsopscope          AS GEB_ZSOPSCOPE
        ,dt_dom                AS GEB_DOM
        ,dt_industryconame     AS GEB_INDUSTRYCONAME
        ,dt_esdate             AS geb_esdate
        ,dt_othertel           AS geb_othertel
        ,insert_time_chinadaas AS GEB_HOSTSENDTIME
        ,dt_regorgprovince     AS geb_regorgprovince
        ,dt_regorgcode         AS geb_regorgcode
       ,dt_candate    --注销日期
       ,dt_revdate    --吊销日期
       ,dt_orgcodes   --组织机构代码
       ,dt_regno      --注册号
	   ,dt
    FROM    edw.nout_zs_ent_basic
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(dt_creditcode,'')<>''
)a
;
--步骤二：对公账户工商注销后，其在我行开立的结算账户状态
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_09 AS
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep --存款账户信息
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ20250311171_CST_08 B
ON A.cst_chn_nm = B.geb_entname
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ20250311171_CST_08 B
ON A.prm_doc_nbr = B.geb_creditcode
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ20250311171_CST_08 B
ON A.prm_doc_nbr = B.geb_orgcodes
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ20250311171_CST_08 B
ON A.prm_doc_nbr = B.geb_regno
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
;
-- 近一年内发现客户身份注销的数量 --99145
SELECT  '5.2.f1 身份注销客户数' id_nm
       ,COUNT(distinct cst_id) as 客户数
FROM SJXQ_SJ20250311171_CST_09 t
union all
-- 近一年内发现客户身份注销的数量及终止业务关系的数量
-- 94572
SELECT  '5.2.f2 身份注销终止业务客户数' id_nm
       ,COUNT(distinct cst_id) as 客户数
FROM SJXQ_SJ20250311171_CST_09
WHERE act_sts_cd <> 'A' --账户状态异常
;
-- 从发现注销到完成终止业务关系流程的最长时间
SELECT  '5.2.f3 最长时间' id_nm
       ,MAX(tt.dateminus) max_days
FROM
(
	SELECT  cst_id
	       ,CASE WHEN act_dstr_act_dt >= dt THEN DATEDIFF(to_date(act_dstr_act_dt,'yyyymmdd'),to_date(dt,'yyyymmdd'),'dd')  ELSE 0 END AS dateminus
	FROM
	(
		SELECT  cst_id
		       ,act_dstr_act_dt
		       ,dt
		FROM SJXQ_SJ20250311171_CST_09
		WHERE act_sts_cd <> 'A'
	) t
) tt
;
-- 5.2.g.近一年内，根据机构客户风险等级划分设定，应当及实际开展到期重评客户风险等级的客户数量
-- 2024年，存量客户月底到期重评的客户数量，2021年12月-2024年11月预警的客户。
SELECT  '5.2.g 到期重评的客户数量' id_nm
       ,COUNT(distinct t.party_id) as 客户数
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON a.organkey = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON a.organkey = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
) T;
-- 5.2.h.近一年内，经持续尽调认为业务关系不符合客户身份，需开展强化尽职调查和重新评定客户风险等级的客户数量（不包含以上定期重评、因外部查冻扣开展强化尽调客户）及占全部客户数量比例（名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、2024年完成人工评定的客户，不含新开客户评级、PKG99、PKG51、CXD11两个公式。
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_10 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','') AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T
) S
WHERE S.RN <= 2
;
SELECT  '5.2.h1 重评客户数' id_nm
       ,COUNT(DISTINCT A.PARTY_ID) AS 客户数
FROM SJXQ_SJ20250311171_CST_10 A
WHERE ( ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' ) --初评等级
 AND A.STATISTIC_DT between '20240101' AND '20241231' ) OR ( A.LEVELKEY IN ( '1004' , '1005' ) --最终风险等级
 AND A.RCHECK_DT between '20240101' AND '20241231' ) )
AND ORGANKEY IN ( SELECT B.ORGANKEY FROM adm_upss.adm_upss_aml_t07_report_organ_rel B WHERE B.report_organkey = 'C1406344000011' AND B.DT = '20241231' )
AND A.TEMPCATEGORY = '2' --模板类别（ 1：新开户 2：定期核查）
AND A.organkey LIKE '4461%'
union all
SELECT  '5.2.h2 全部客户数' id_nm
       ,COUNT(1) AS num
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT, 1, 10), '-', '') BETWEEN '20240101' AND '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
	AND A.organkey LIKE '4461%'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	WHERE replace(SUBSTR(A.RCHECK_DT, 1, 10), '-', '') BETWEEN '20240101' AND '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
	AND A.organkey LIKE '4461%'
) T
;
-- 5.2.i.近一年内，经尽职调查后，调升、调降客户风险等级的客户数量，调升至最高等级和由最高风险等级调降的客户数量（以上分别统计）
-- 1、调升：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级比前一次高，且系统初评等级不是低风险、较低风险、一般风险。
-- 2013
SELECT  '5.2.i1-调升' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ20250311171_CST_10 A , SJXQ_SJ20250311171_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY < A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T ;
-- 2、调降：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级比前一次低，且系统初评等级不是低风险、较低风险、一般风险。
-- 1360
SELECT  '5.2.i2-调降' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ20250311171_CST_10 A , SJXQ_SJ20250311171_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY > A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 3、调升至最高等级：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级是高风险，前一次风险等级不是高风险。
-- 216
SELECT  '5.2.i3-调升至最高等级' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ20250311171_CST_10 A , SJXQ_SJ20250311171_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY = '1005'
	AND B.LEVELKEY != '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 4、由最高风险等级调降的客户：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级比前一次低，且前一次风险等级是高风险。
-- 534
SELECT  '5.2.i4-由最高风险等级调降的客户' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ20250311171_CST_10 A , SJXQ_SJ20250311171_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY != '1005'
	AND B.LEVELKEY = '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
--5.2.j 近一年内，经强化尽职调查后，采取业务与交易限制措施的客户数量
-- 1、2024年底，客户风险等级是较高风险、高风险客户数量
-- 2、2024年底，客户风险等级是较高风险、高风险，且在2024年被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付的客户。
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_11 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON t.organkey = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东英德泰隆村镇银行'
) S
WHERE S.RN <= 2
;
--迭代版代码
--2、取2024年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，关联2024年暂停非柜面、账户只收不付、不收不付的客户
--1、取2024年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，去重。
SELECT  '5.2.j1 2024年底较高风险及以上客户数'  AS ind
       ,COUNT(DISTINCT A.PARTY_ID) AS val
FROM SJXQ_SJ20250311171_CST_11 A
WHERE (
    ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
        AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2024-01-01'
        AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-12-31'
    ) OR
    ( A.LEVELKEY IN ( '1004' , '1005' )
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
    )
)
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
)
UNION ALL
SELECT  '5.2.j2 2024年底较高风险及以上且交易限制客户数' AS ind
       ,COUNT(DISTINCT S.party_id) AS val
FROM SJXQ_SJ20250311171_CST_11 S
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
    AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
);
--5.2.k.近一年内，经强化尽职调查后，终止业务关系的客户数量，以及占全部强化尽职调查客户的比例和占全部客户数量的比例
--2024年底，客户风险等级是较高风险、高风险，且在2024年账户不收不付、销户的客户。
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_12 AS
--账户全部销户
SELECT  A.PARTY_ID --客户号
       ,'1' AS STS --客户状态
FROM adm_upss.ADM_UPSS_AML_T47_PARTY A
WHERE NOT EXISTS (
SELECT  1
FROM adm_upss.ADM_UPSS_AML_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.ACCT_STATUS_CD = '0'
AND B.dt = '20241231') AND A.DT = '20241231'
UNION
--互联网贷款客户借款余额已为0
SELECT  A.PARTY_ID
       ,'2' AS STS
FROM adm_upss.adm_upss_aml_t47_loan_acct A
WHERE A.LTYPEKEY = '201050101040319'
AND AMT_VAL = '0'
AND NOT EXISTS (
SELECT  1
FROM adm_upss.adm_upss_aml_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.DT = '20241231') AND A.DT = '20241231'
UNION
--采取不收不付
SELECT  C.CST_ACT_ID
       ,'3'
FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
WHERE A.DT = '20241231'
AND A.FRZ_SCP_CD = '2'
AND A.NFRZ_IND = '0'
AND A.LMT_TYP IN ( '1' , '2' )
AND B.FRZ_ID IS NULL
AND LMT_TYP = '2'
AND C.CST_ACT_ID IS NOT NULL
;
--9380
SELECT  '5.2.k 2024年底较高风险及以上且账户不收不付销户的客户数'              AS ind
       ,COUNT(distinct A.PARTY_ID) AS val -- 客户数
FROM SJXQ_SJ20250311171_CST_11 A
WHERE A.LEVELKEY IN ( '1004' , '1005' )
AND A.PARTY_ID LIKE 'ZH%'
AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
AND EXISTS (
    SELECT  1
    FROM SJXQ_SJ20250311171_CST_12 B
    WHERE A.PARTY_ID = B.PARTY_ID
    AND B.STS IN ( '1' , '3' )
)
;
--5.2.n 反洗钱 1587
-- 1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
-- 2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且2024年第一次冻扣前已被划分为高风险、较高风险的客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_13 AS
SELECT  aa.cst_id
       ,aa.qry_ctrl_dt
       ,aa.qry_ctrl_tm
       ,aa.frz_bgn_dt
       ,aa.frz_tmn_dt
       ,ROW_NUMBER() OVER ( PARTITION BY aa.cst_id ORDER BY  aa.qry_ctrl_dt ,aa.qry_ctrl_tm ) AS rn
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.brc_org_nm = '广东英德泰隆村镇银行'
WHERE aa.dt = '20241231'
AND qry_ctrl_dt >= '20240101'
AND qry_ctrl_dt <= '20241231'
AND qry_ctrl_typ_nm IN ( '冻结' , '划扣' )
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) );
--57关联高风险客群
-- 10692
-- 1587
SELECT  '5.2.n1 2024年度被公安机关冻结扣划客户数'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ20250311171_CST_13 t
UNION ALL
SELECT  '5.2.n2 2024年度被公安机关冻结扣划客户数且冻扣前已被划分为较高风险以上客户数' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ20250311171_CST_13 t
INNER JOIN (
	SELECT party_id,min(STATISTIC_DT) as min_STATISTIC_DT
	from SJXQ_SJ20250311171_CST_11
	where LEVELKEY IN ( '1004' , '1005' )
	AND party_id LIKE 'ZH%'
	group by party_id
) A ON T.cst_id = substr(A.party_id, 3)
and t.qry_ctrl_dt>a.min_STATISTIC_DT
WHERE t.rn=1
;
/*6.1大额交易监测
1.大额交易监测系统全面覆盖各项金融业务。包括开立账户等建立持续业务关系的客户、以及未开立账户但办理达到识别金额起点的一次性金融服务的客户；
2.系统设定的大额交易监测标准完全覆盖规定的情形，对同时符合两项以上大额交易标准的交易，能够分别提交大额交易报告；
3.能够在大额交易发生之日起5个工作日内以电子方式提交大额交易报告。
*/
--6.1.b、b.近一年内，机构上报大额交易报告笔数、份数
SELECT  '6.1.b' AS ind
       ,COUNT(B.TICD) as 大额交易笔数
       ,COUNT(DISTINCT A.REPORTKEY) as 大额交易份数
FROM adm_upss.AML_T07_MSG_UH A
inner join adm_upss.aml_t3a_tsdt_n_hst B
on A.REPORTKEY = B.RPT_ID AND B.DT = '20250110'
-- AND B.cust_id LIKE 'ZH%' 	--政和
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON b.tr_org_id = d.org_id --交易机构
AND d.dt = '20241231' AND d.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.REPORTORGANKEY = 'C1406344000011'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
;
--6.1.c.近一年内，大额交易报告交易对手为空（包括填写替代符&ldquo;@N&rdquo;）、为内部过渡账户的比例（按笔计）分别是？（不包括机构自身与客户之间发生的交易，如贷款、付息等）
/*大额现转标志是转账，交易对手账号是空或者交易对手名称是空的；*/
--6373
--538218
SELECT  '6.1.c1 近一年内交易对手为空笔数' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A
inner join adm_upss.AML_T3A_TSDT_N_HST B
on A.REPORTKEY = B.RPT_ID
AND B.DT = '20250110'
AND B.IS_CASH = '01'
AND (B.TCAC = '@N' OR B.TCNM = '@N')
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON b.tr_org_id = d.org_id --交易机构
AND d.dt = '20241231' AND d.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.REPORTORGANKEY = 'C1406344000011'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND A.REPORT_TYPE_CD = 'BH'
;
/*大额现转标志是转账，交易对手账号是内部账户；*/
SELECT  '6.1.c2 近一年内交易对手为内部过渡账户笔数' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A
inner join adm_upss.AML_T3A_TSDT_N_HST B
on A.REPORTKEY = B.RPT_ID
AND B.DT = '20250110'
AND B.IS_CASH = '01'
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON b.tr_org_id = d.org_id --交易机构
AND d.dt = '20241231' AND d.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.REPORTORGANKEY = 'C1406344000011'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
AND EXISTS (
    SELECT  1
    FROM adm_upss.ADM_UPSS_AML_T47_AGREEMENT_ACCT C
    WHERE B.TCAC = C.ACCT_NUM
    AND C.TXN_DSC = 'NBZH'
    AND C.DT = '20250110'
);
--6.1.d.近一年内，大额交易报告报送超时的笔数及比例
--大额交易回执是警告回执，且回执内容含有逾期报送
--273402
SELECT  '6.1.d 近一年报送超时的笔数'                   AS ind
       ,COUNT(DISTINCT D.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B, adm_upss.AML_T3A_FDCF_FCER C , adm_upss.AML_T3A_TSDT_N_HST D
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON d.tr_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE C.ERRS LIKE '%逾期%'
AND B.RCPT_ID = C.RCPT_ID
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = D.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND D.DT = '20250110'
AND A.REPORTORGANKEY = 'C1406344000011'
AND A.REPORT_TYPE_CD = 'BH'
;
--6.1.e.近一年内，反洗钱监测分析中心校验不合格、要求更正或补录的笔数及比例
--大额交易回执是错误回执、系统补正回执、通用错误回执
--367698
SELECT  '6.1.e 近一年校验不合格等的笔数'                   AS ind
       ,COUNT(DISTINCT C.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B , adm_upss.AML_T3A_TSDT_N_HST C
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON c.tr_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = C.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND A.REPORTORGANKEY = 'C1406344000011'
AND A.REPORT_TYPE_CD = 'BH'
;
--6.1.f.近一年内，人工填报大额交易报告涉及的业务类型、笔数、比例（人工填报大额交易报告笔数/所有大额交易报告笔数）
--大额案例类型是人工新增
--2516
SELECT  '6.1.f 近一年人工填报大额交易报告笔数及占比'                   AS ind
       ,COUNT(DISTINCT case when A.DATE_STATUS_CD = '1' then B.TICD end) AS val
	   ,COUNT(DISTINCT case when A.DATE_STATUS_CD = '1' then B.TICD end)/COUNT(DISTINCT B.TICD) as rate
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A, adm_upss.AML_T3A_TSDT_N_HST B
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON b.tr_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE A.CAST_TYPE = '1'
-- AND A.DATE_STATUS_CD = '1'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20250110'
)
;
/*6.2可疑交易监测覆盖范围与模型优化
1.可疑交易监测系统全面覆盖所有业务、客户和交易，包括开立账户等建立持续业务关系的客户，以及未开立账户但办理达到识别金额起点的一次性金融服务的客户；
2.定期对交易监测标准的有效性进行评估，并根据评估结果和监管部门、司法机关下发的风险提示、洗钱类型分析报告和风险评估报告等持续优化完善监测模型；
3.交易监测模型有效性较高，对非法资金交易的监测预警命中率较高、误报率较低。
*/
--6.2.a.可疑交易监测系统是否覆盖本机构所有金融业务、渠道和客户？是否覆盖未开户客户办理一次性金融业务？如有未覆盖的业务、渠道、客户或场景，按规模衡量，主要包括哪些？采取了哪些替代监测措施？
--6.2.b.可疑交易监测模型（可独立产生可疑交易预警的指标组合及相应参数）的数量，最近一年内新增或调整模型（指标组合，不含仅调节参数的）次数、相应时间，新增或调整的主要内容和依据
SELECT  '6.2.b 2024年可疑交易监测模型数量' AS ind
	,count(distinct trigger_model_code)
from adm_upss.AML_T3R_XCP_TRX_WRN_CAS_DTL_INF
where dt = '20250311'
and trigger_model_code <> ''
;
--6.2.c.由监测系统形成的可疑交易预警数量，经复核后排除可疑的数量
-- 近一年
SELECT  '6.2.c 系统可疑复核排除可疑的数量' AS ind
    ,count(A.PARTY_ID) as 数量
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
and a.date_status_cd='2' --数据来源1：手工新增2：系统生成
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑   --案例类型:1:大额 2:可疑
and a.app_state_cd='4'	--1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
);
--6.2.d.在监测系统之外，由人工识别触发（如业务人员识别发现）的可疑预警数量
-- 近一年
SELECT  '6.2.d 人工识别可疑预警数量' AS ind
    ,count(A.PARTY_ID) as 可疑预警数量
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
and a.date_status_cd='1' --数据来源1：手工新增2：系统生成
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
);
--6.2.e.运用创新技术，改进可疑交易监测系统功能的有益做法及成效
--6.2.f.可疑交易预警延后2年实现率：近2年内产生可疑交易预警的客户，在预警后受到司法机关查冻扣、人民银行反洗钱调查或税务机立案调查的客户数量和占比
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_14 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2023-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
);
SELECT  '6.2.f1 近2年可疑客户数'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM SJXQ_SJ20250311171_CST_14
UNION ALL
--6.2.f2、近2年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '6.2.f2 近2年可疑且之后被查冻扣客户数'                    AS ind
       ,COUNT(DISTINCT p.PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ20250311171_CST_14 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.cst_id
	       ,aa.qry_ctrl_dt
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON aa.cst_id = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.brc_org_nm = '广东英德泰隆村镇银行'
	WHERE aa.dt = '20250101'
	AND qry_ctrl_dt >= '20230101'
	AND qry_ctrl_dt <= '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--6.2.g.查冻扣客户3年历史预警率：评估时点近三年内受到司法机关新增查冻扣（不含已有冻扣客户新增轮候冻扣）、人民银行反洗钱调查或税务机立案调查的客户中
-- 在接受调查或冻扣前已产生可疑交易预警的客户数量和占比
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_15 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑 	--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
);
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_16 AS
SELECT  DISTINCT aa.cst_id
       ,aa.qry_ctrl_dt
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.brc_org_nm = '广东英德泰隆村镇银行'
WHERE aa.dt = '20250101'
AND qry_ctrl_dt >= '20220101'
AND qry_ctrl_dt <= '20241231'
;
SELECT  '6.2.g1 近三年查冻扣客户数'                  AS ind
       ,COUNT(DISTINCT cst_id) AS val
FROM SJXQ_SJ20250311171_CST_16
UNION ALL
--66 2、2020年至2024年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '6.2.g2 近三年查冻扣且之前可疑预警客户数'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ20250311171_CST_15 t
	WHERE t.rn = 1
) p
INNER JOIN SJXQ_SJ20250311171_CST_16 s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
/*6.3可疑交易监测分析与上报机制和流程
1.根据机构规模和风险，建立专业化的可疑交易监测部门或设置相对固定的监测岗位，监测分析人员熟悉本机构业务和洗钱风险特征，从事监测分析工作的平均年限达到一定水平；
2.可疑交易监测人员能够及时、全面获取有关可疑主体的身份背景信息和关联交易情况，必要时从业务或客户部门（基层网点）获取补充信息，或收集外部信息，在全面考量的基础上作出合理判断；
3.可疑交易分析与报告及时性、准确性、有效性较高，具有较高的情报价值，无严重的遗漏或过度防御性报告的倾向。
4.针对重大、紧急案件线索，及时向当地人民银行报送重点可疑交易报告。
*/
--6.3.f.近一年内，向反洗钱中心报送可疑交易报告数量，向人民银行分支机构直接报送重点可疑交易报告数量，向侦查、监察机关和税务部门报案数量
--2024年，上报可疑案例的报告数量
SELECT  '6.3.f 2024年上报可疑案例的报告数'     AS ind
       ,COUNT(*) AS val
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
)
;
--6.3.g.近一年内，可疑交易报告涉及客户数量，以及因上报可疑交易而对客户采取强化尽职调查、调整风险等级、采取管控措施、中止业务关系的客户数量（以上分别统计）
--1、2024年上报可疑案例的主客户数量
DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_17 AS
SELECT  DISTINCT A.PARTY_ID
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报 	--1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
AND A.CAST_TYPE = '2'   	--案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1406344000011'
    AND     B.DT = '20241231'
);
SELECT  '6.3.g1 2024年上报可疑案例客户数' AS ind
       ,COUNT(DISTINCT PARTY_ID)
FROM SJXQ_SJ20250311171_CST_17
--2、被上报可疑案例后，风险等级是高风险、较高风险、被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付、不收不付、销户的客户
--786
UNION ALL
SELECT  '6.3.g2 2024年上报可疑案例客户数且之后调查管控客户数' AS ind
       ,COUNT(DISTINCT aaa.party_id)
FROM SJXQ_SJ20250311171_CST_17 aaa
INNER JOIN SJXQ_SJ20250311171_CST_11 S
ON aaa.PARTY_ID = S.PARTY_ID
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
	AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406344000011'
    AND B.DT = '20241231'
);
--6.3.i.近一年内司法机关新增冻扣客户（不含已有冻扣客户新增轮候冻扣）中，已在近年内（不超过5年）被提交可疑交易报告的客户数量与占比
--1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
--2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且在2020-2024年被上报可疑案例的主客户
-- 10692
-- 413
SELECT  '6.3.i1 2024年被公安机关冻扣客户数'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ20250311171_CST_13 t
UNION ALL
SELECT  '6.3.i2 2024年被公安机关冻扣且近5年被上报可疑客户数' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ20250311171_CST_13 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2020-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑 		--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1406344000011'
    AND     B.DT = '20241231'
);
--6.3.j.近一年内被提交可疑交易报告的客户中，已被司法机关查冻扣、人民银行反洗钱调查、涉诈通报客户数量与占比
--2024年上报可疑案例的主客户，且在上报前，已被司法查冻扣、预警人行黑名单的客户
--200
SELECT  '6.3.j 近一年上报可疑且之前被查冻扣客户数' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东英德泰隆村镇银行'
INNER JOIN
(
	select cst_id,min(qry_ctrl_dt) as qry_ctrl_dt
	from SJXQ_SJ20250311171_CST_16
	where qry_ctrl_dt >= '20240101'
	group by cst_id
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01' --近1年
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND REPLACE(substr(A.APP_DT, 1, 10), '-', '') > s.qry_ctrl_dt --查扣时间小于预警时间
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1406344000011'
    AND     B.DT = '20241231'
);
-- k.重点可疑交易移送率（人民银行自行统计）
/*7.1交易记录保存情况
1.全面、准确保存交易与业务信息，包括对手方信息，能够完整反映资金交易，还原内部过渡户等中间账户的实际资金流向
2.各类业务、交易信息能够实现电子化集中保存或可便捷查询、获取
*/
-- 7.1.d.（银行）交易对手方通过其他机构（如第三方支付机构）间接与本机构客户发生交易的，是否能够获取到对手方实际名称（包括以支付机构名称添加后缀方式获取）？
-- （非银行）通过代销渠道销售产品的，是否能够获取客户核心身份信息（客户名称、证件类型、证件号码）
-- 请列举与本机构交易笔数最多的5家机构的客户名称获取比率及名称，以及获取比率最低的5家机构的比率及名称。
-- 2、2024年各第三方支付机构交易笔数：网联 epcc_paysrl_attachl 表按 instgid 支付机构编码统计交易笔数
-- + wk_jrnl 表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')按 snd_ins_id_cd 统计交易笔数。
-- 取支付机构编码、名称、笔数。
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_17 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_17 AS
-- SELECT  t1.instgid AS 支付机构编码
--        ,t2.instgnm AS 名称
--        ,COUNT(1)   AS 笔数
-- FROM edw.epcc_epcc_paysrl AS t1 --支付流水表
-- inner join edw.dim_bus_dep_cst_act_inf_dd b on t1.acctid=b.cst_act_id and b.dt='20241231' and b.opn_org_id like '4461%'
-- LEFT JOIN edw.epcc_epcc_instgidinf AS t2 --网联支付机构信息
-- ON t1.instgid = t2.instgid AND t2.dt = '20241231'
-- WHERE t1.dt >= '20240101'
-- AND t1.dt <= '20241231'
-- AND t1.epccstatus = '00'
-- GROUP BY  t1.instgid
--          ,t2.instgnm
-- ;
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_18 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_18 AS
-- SELECT  t1.snd_ins_id_cd AS 支付机构编码
--        ,COUNT(1)         AS 笔数
-- FROM edw.frhd_wk_jrnl AS t1 --无卡交易流水
-- INNER JOIN    edw.dim_bus_dep_cst_act_inf_dd t2
-- ON      t1.snd_acct_no = t2.cst_act_id
-- AND     t2.dt = '20241231'
-- and     t2.opn_org_id like '4461%'
-- WHERE t1.dt >= '20240101'
-- AND t1.dt <= '20241231'
-- GROUP BY  t1.snd_ins_id_cd
-- ;
-- -- 3、2024年各第三方支付机构商户实际名称获取率： 网联 epcc_paysrl_attach 按instgid统计mkinfo6 不为空的笔数/对应支付机构笔数，
-- -- 银联 wk_jrnl 表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101') 按 snd_ins_id_cd 统计 snd_ins_id_cd 不为空的笔数/对应支付机构限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')的笔数。
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_19 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_19 AS
-- SELECT  t1.instgid AS 支付机构编码
--        ,t2.instgnm AS 名称
--        ,SUM(case WHEN nvl(t3.mkinfo6,'') <> '' AND t3.mkinfo6 NOT IN ( '上海寻梦信息技术有限公司' ,'微信红包' ,'扫二维码付款'
--             ,'信用卡还款' ,'北京三快在线科技有限公司' ,'中移动金融科技有限公司' ,'成都所见所得科技有限公司' ,'微信转账'
--              ,'高德信息技术有限公司' ,'上海格物致品网络科技有限公司' ,'上海拉扎斯信息科技有限公司' ,'特约商户' ) THEN 1
--              else 0 end) /COUNT(1) AS 获取率
-- FROM edw.epcc_epcc_paysrl AS t1 --支付流水表
-- inner join edw.dim_bus_dep_cst_act_inf_dd b on t1.acctid=b.cst_act_id and b.dt='20241231' and b.opn_org_id like '4461%'
-- LEFT JOIN edw.epcc_epcc_instgidinf AS t2 --网联支付机构信息
-- ON t1.instgid = t2.instgid AND t2.dt = '20241231'
-- LEFT JOIN edw.epcc_epcc_paysrl_attach AS t3 --支付流水表附表
-- ON t1.trxid = t3.trxid AND t1.instgid = t3.instgid
-- WHERE t1.dt >= '20240101'
-- AND t1.dt <= '20241231'
-- AND t3.dt >= '20240101'
-- AND t3.dt <= '20241231'
-- AND t1.epccstatus = '00'
-- GROUP BY  t1.instgid
--          ,t2.instgnm
-- ;
-- -- 46个机构均为1
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250311171_CST_20 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250311171_CST_20 AS
-- SELECT  t1.snd_ins_id_cd                                                     AS 支付机构编码
--        ,SUM(case WHEN nvl(t1.mchnt_nm,'') <> '' THEN 1 else 0 end) /COUNT(1) AS 获取率
-- FROM edw.frhd_wk_jrnl AS t1 --无卡交易流水
-- INNER JOIN    edw.dim_bus_dep_cst_act_inf_dd t2
-- ON      t1.snd_acct_no = t2.cst_act_id
-- AND     t2.dt = '20241231'
-- and     t2.opn_org_id like '4461%'
-- WHERE t1.dt >= '20240101'
-- AND t1.dt <= '20241231'
-- GROUP BY  t1.snd_ins_id_cd
-- ;
-- Select '71-网联-交易笔数前5' AS ind
--     ,t1.支付机构编码
--     ,t1.名称
--     ,t2.获取率
-- from(
--     select 支付机构编码,名称,笔数
--     from SJXQ_SJ20250311171_CST_17 	--网联
--     order by 笔数 desc limit 5
-- )t1 left join SJXQ_SJ20250311171_CST_19  t2
-- on t1.支付机构编码=t2.支付机构编码
-- union all
-- Select '71-网联-获取率后5' AS ind
--     ,支付机构编码
--     ,名称
--     ,获取率
-- from SJXQ_SJ20250311171_CST_19
-- order by 获取率 limit 5
-- ;
-- Select '71-银联-交易笔数前5' AS ind
--     ,t1.支付机构编码
--     ,t2.获取率
-- from(
--     select 支付机构编码,笔数
--     from SJXQ_SJ20250311171_CST_18 	--网联
--     order by 笔数 desc limit 5
-- )t1 left join SJXQ_SJ20250311171_CST_20  t2
-- on t1.支付机构编码=t2.支付机构编码
-- union all
-- Select '71-银联-获取率后5' AS ind
--     ,支付机构编码
--     ,获取率
-- from SJXQ_SJ20250311171_CST_20
-- order by 获取率 limit 5
-- ;
-- 取支付机构编码、名称、笔数。
select
     t1.instgid as 支付机构编码
    ,t2.instgnm as 名称
    ,count(1) as 笔数
from edw.epcc_epcc_paysrl as t1    --支付流水表
inner join edw.dim_bus_dep_cst_act_inf_dd b on t1.acctid=b.cst_act_id and b.dt='20241231' and b.opn_org_id like '4461%'
left join edw.epcc_epcc_instgidinf as t2    --网联支付机构信息
  on t1.instgid = t2.instgid
   and t2.dt = '20241231'
where t1.dt >= '20240101'
   and t1.dt <= '20241231'
   and t1.epccstatus = '00'
group by t1.instgid,t2.instgnm
;
-- 3、2023年各第三方支付机构商户实际名称获取率： 网联epcc_paysrl_attach 按instgid统计mkinfo6 不为空的笔数/对应支付机构笔数，银联wk_jrnl表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')
-- 按snd_ins_id_cd统计snd_ins_id_cd不为空的笔数/对应支付机构限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')的笔数。
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.qwj_mis_SJ2024022942_713_paysrl PURGE;
CREATE TABLE qwj_mis_SJ2024022942_713_paysrl AS
select
     t1.instgid as 支付机构编码
    ,t2.instgnm as 名称
    ,sum(case when nvl(t3.mkinfo6,'') <> '' and t3.mkinfo6 not in (
      -- '还款','货币基金申购','美团平台商户','特约商户','滴滴出行','拼多多平台商户','抖音','扫二维码付款','手机充值','微信零钱充值账户'
      --     ,'微信转账','微信红包'
'上海寻梦信息技术有限公司'
,'微信红包'
,'扫二维码付款'
,'信用卡还款'
,'北京三快在线科技有限公司'
-- ,'拼多多平台商户'
,'中移动金融科技有限公司'
-- ,'京东商城平台商户'
-- ,'美团'
,'成都所见所得科技有限公司'
,'微信转账'
-- ,'抖音'
,'高德信息技术有限公司'
-- ,'美团平台商户'
,'上海格物致品网络科技有限公司'
-- ,'抖音生活服务商家'
,'上海拉扎斯信息科技有限公司'
,'特约商户'
-- ,'抖店平台商户'
          )  then 1 else 0 end) /count(1) as 获取率
from edw.epcc_epcc_paysrl as t1    --支付流水表
inner join edw.dim_bus_dep_cst_act_inf_dd b on t1.acctid=b.cst_act_id and b.dt='20241231' and b.opn_org_id like '4461%'
left join edw.epcc_epcc_instgidinf as t2    --网联支付机构信息
  on t1.instgid = t2.instgid
   and t2.dt = '20241231'
left join edw.epcc_epcc_paysrl_attach as t3   --支付流水表附表
  on t1.trxid = t3.trxid
   and t1.instgid = t3.instgid
where t1.dt >= '20240101'
   and t1.dt <= '20241231'
   and t3.dt >= '20240101'
   and t3.dt <= '20241231'
   and t1.epccstatus = '00'
group by t1.instgid,t2.instgnm
;
/*8.1名单监测
1.名单库覆盖中国政府发布的或者要求执行的恐怖活动组织及恐怖活动人员，联合国安理会决议中所列的恐怖活动组织及恐怖活动人员，百名红通人员；
2.名单监测全面覆盖机构的所有业务条线、环节和所有客户和境外交易对手；
3.采取切实有效的技术手段，对监控名单实施全天候实时监测。
4.名单库更新机制符合机构业务规模，能够实现及时更新；
5.名单库变化后能够及时完成对所有客户及境外交易对手的回溯性筛查。
*/
-- 8.1.g.近一年内，名单筛查命中或疑似命中三类名单的客户（或交易对手）数量，如有发现，采取了那些核实和后续处理措施？
***刘佳瑜_SJ20250603231_舟山分行反洗钱.sql
-- 机构：截至 20250601 舟山分行；全行洗钱高风险客户清单
/*
问题：
1. 全行洗钱高风险客户清单/全行洗钱高风险客户尽职调查工作记录及管控情况？全行洗钱高风险客户清单
2. 敏感字段:号码、地址？可取
3. 规则编号，规则名称，问题详情？参考代码，调查结论：编辑岗处理意见
4. 账户维度? 合并？客户账号出数据
5. 反洗钱监测系统预警的异常交易（电子版）
6. 新客户清单？对公? 控股股东 换 实控人
系统评级结果  最终风险等级? 是
系统评级日期
评级结果状态 ？不取了
*/
-- 截至 20250601 舟山分行；全行洗钱高风险客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_01 AS
SELECT  t1.cst_id
       ,t1.levelkey      AS 最终风险等级
       ,t1.ADJUST_REASON AS 最终风险等级编辑岗处理意见
FROM
(
	SELECT  SUBSTR(a.party_id,3,10)  AS cst_id
	       ,a.organkey
	       ,a.levelkey
	       ,a.statistic_dt
           ,b.ADJUST_REASON
	       ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(a.party_id,3,10) ORDER BY  a.statistic_dt DESC ) AS rn
	FROM adm_upss.aml_t37_party_result_curr         A
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  B
    ON      A.RESULEKEY = B.RSLTKEY
    AND     A.PARTY_ID = B.PARTY_ID
    AND     B.POST_ID = 'P2001' --编辑岗
    and a.dt=b.dt
	WHERE a.dt = '20250601'
) t1
WHERE t1.levelkey = '1005'       --高风险
and t1.organkey like '3312%'     --舟山分行
AND t1.rn = 1
;
--身份信息识别规则
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_02 AS
--个人客户身份信息识别规则(跑批日期T-3)
SELECT  A.RULE_OBJ -- '检查规则项'
        ,A.CHECK_INFO -- '检查内容'
        ,A.RULE_NO -- '规则编号'
        ,A.RULE_NM -- '规则名称'
        ,A.PARTY_ID -- '客户号'
        ,A.PROB_DTL -- '问题详情（关键字段拼接）'
        ,A.OPN_DT -- '客户开户日期'
        ,A.ORG_NO -- '客户归属机构号'
        ,A.ORG_NM -- '客户归属机构名称'
        ,A.MNG_NO -- '管护人工号'
        ,A.MNG_NM -- '管护人名称'
        ,A.MNG_ORG_NO -- '管护机构号'
        ,A.MNG_ORG_NM -- '管护机构名称'
FROM    app_fxq.AY_AML_CHECK_CUST_DTL_PERS A
LEFT JOIN    adm_upss.AML_T00_ORGAN B
ON      B.DT = '20250601'
AND     A.mng_org_no = B.ORGANKEY
WHERE   A.DT = '20250601'
AND     A.RULE_OBJ = '存量个人客户'
AND     ( B.uporgankey = '331200000' --支行上级机构为舟山分行
    OR B.organkey = '331200000' ) --舟山分行本级
union all
--单位客户身份信息识别规则(跑批日期T-3)
SELECT  A.RULE_OBJ --'检查规则项'
        ,A.CHECK_INFO --'检查内容'
        ,A.RULE_NO --'规则编号'
        ,A.RULE_NM --'规则名称'
        ,A.PARTY_ID --'客户号'
        ,A.PROB_DTL --'问题详情（关键字段拼接）'
        ,A.OPN_DT --'客户开户日期'
        ,A.ORG_NO --'客户归属机构号'
        ,A.ORG_NM --'客户归属机构名称'
        ,A.MNG_NO --'管护人工号'
        ,A.MNG_NM --'管护人名称'
        ,A.MNG_ORG_NO --'管护机构号'
        ,A.MNG_ORG_NM --'管护机构名称'
FROM    app_fxq.AY_AML_CHECK_CUST_DTL_UNIT A
LEFT JOIN    adm_upss.AML_T00_ORGAN B
ON      B.DT = '20250601'
AND     A.mng_org_no = B.ORGANKEY
WHERE   a.DT = '20250601'
AND     a.RULE_OBJ = '单位客户身份识别'
AND     ( B.uporgankey = '331200000' --支行上级机构为舟山分行
    OR B.organkey = '331200000' ) --舟山分行本级
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_03 AS
SELECT  t1.cst_id     AS 客户号
       ,t2.cst_chn_nm AS 客户名称
       ,t2.doc_nbr    AS 证件号码
       ,t2.doc_typ_cd AS 证件类型代码
       ,t2.doc_mtu_dt AS 证件到期日期
	,case when length(t2.mbl_nbr)>=7 or length(t2.fml_tel_nbr)<=3 then t2.mbl_nbr
        else t2.fml_tel_nbr end as 联系电话
    ,t3.RULE_NO  AS 规则编号
    ,t3.RULE_NM  AS 规则名称
    ,t3.PROB_DTL AS 问题详情
    ,t1.最终风险等级编辑岗处理意见 as 调查结论_编辑岗处理意见
    ,t3.MNG_NM      AS 管户经理
    ,t3.MNG_ORG_NM  as 管户机构
    ,t4.cst_act_id      as 客户账号
    ,c2.cd_val_dscr     as 账户状态
    ,t5.org_nm          as 开户机构
from SJXQ_SJ20250603231_CST_01       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250601'
left join(
    SELECT  SUBSTR(party_id,3,10)               AS cst_id
    from SJXQ_SJ20250603231_CST_02
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd  t4 --客户存款账户信息
on t1.cst_id=t4.cst_id
and t4.dt='20250601'
left join edw.dwd_code_library_dd c1
on t2.doc_typ_cd = c1.cd_val
and c1.dt = '20250601'
left join edw.dwd_code_library_dd c2
on t4.act_sts_cd = c2.cd_val
and c2.dt = '20250601'
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t4.opn_org_id = t5.org_id
and t5.dt = '20250601'
;
-- 新客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_04 AS
select substr(party_id,3,10) as cst_id     --当事人编号
	,host_cust_id                             --原客户号
	,party_class_cd                           --当事人类型 C:对公当事人 I:个人当事人
	,new_ind                                  --是否新增客户:0:否1:是
	,party_chn_name                           --当事人中文名称
	,card_type                                --证件类型 01:居民身份证、临时居民身份证或户口簿02：军人身份证件或警察身份证件03：港澳居民往来内地通行证、台湾居民往来内地通行证或者其他有效旅行证件04：护照05：其他51:机构代码证
	,card_no                                  --证件号码
	,create_dt                                --建立时间
	,organkey                                 --所属机构
	,id_deadline                              --执照有效期限
	,reg_adr                                  --户籍地址|注册地址
	,cmn_adr                                  --通讯地址
	,wrk_adr                                  --工作单位地址|经营所在地地址
	,fml_adr                                  --家庭地址
	,cust_kind                                --1有账户的客户 2无账户的客户 3一次性金融服务客户 4境外卡客户
	,party_state                              --客户状态
	,close_dt                                 --销户时间
from adm_upss.adm_upss_aml_t47_party          --反洗钱客户表
where dt='20250601'
and create_dt between '20240101' and '20250601'
and organkey like '3312%' --舟山分行
;
--风险等级
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_05 AS
SELECT  SUBSTR(a.party_id,3,10)            AS cst_id --客户号
       ,A.party_chn_name      AS 客户名称
       ,A.organkey            AS 客户机构
       ,A.fristappralevel     AS 初评等级
       ,A.statistic_dt        AS 评级日期
       ,A.emendationlevel     AS 调整等级
       ,A.levelkey            AS 最终风险等级
       ,A.curr_post           AS 当前岗位
       ,A.audit_user          AS 提交人
       ,B.level_before_adjust AS 调整前风险等级
       ,B.level_after_adjust  AS 调整后风险等级
       ,B.adjust_reason       AS 处理意见
       ,B.res_post_id         AS 接收岗位
       ,B.post_id             AS 提交岗位
       ,B.last_upd_dt         AS 调整日期
       ,B.last_upd_user       AS 调整人
       ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(a.party_id,3,10) ORDER BY  a.statistic_dt DESC) AS rn
FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
INNER JOIN adm_upss.AML_T37_LEVEL_AUDIT_CURR B
ON A.RESULEKEY = B.RSLTKEY
AND A.PARTY_ID = B.PARTY_ID
AND B.DT = '20250601'
WHERE A.DT = '20250601'
;
--客户担任法人的企业 关联企业
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_06 AS
select t1.cst_id                         --对公客户法人客户号
    ,t1.cst_nm                           --对公客户法人客户名称
    ,t1.entp_cst_id                      --客户号
    ,t1.entp_cst_nm                      --客户名称
    ,t1.doc_typ_cd                          --对公客户法人证件类型
    ,t1.doc_mtu_dt                          --对公客户法人证件到期日
    ,t1.bth_dt       --出生日期
    ,c2.cd_val_dscr  as doc_typ_nm --证件类型
    ,row_number() over(partition by t1.cst_id,t1.entp_cst_id order by prio) rn
from(
    select t1.lgp_cst_id   as cst_id                           --对公客户法人客户号
        ,t1.lgp_nm         as cst_nm                           --对公客户法人客户名称
        ,t1.cst_id         as entp_cst_id                      --客户号
        ,t1.cst_nm         as entp_cst_nm                      --客户名称
        ,t1.lgp_doc_typ_cd as doc_typ_cd                          --对公客户法人证件类型
        ,t1.lgp_doc_mtu_dt as doc_mtu_dt                          --对公客户法人证件到期日
        ,t3.bth_dt       --出生日期
        ,'1' as prio
    from edw.dim_cst_entp_lgp_inf_dd     t1         --对公客户法人信息表
    left join edw.dim_cst_idv_bas_inf_dd t3 --个人客户基本信息
    on t1.cst_id=t3.cst_id
    and t3.dt=t1.dt
    where t1.dt='20250601'
    union all
    select t1.cst_id
        ,t2.cst_chn_nm                               --客户中文名称
        ,t1.rel_cst_id  as entp_cst_id
        ,t3.cst_chn_nm  as entp_cst_nm
        ,t3.doc_typ_cd
        ,t3.doc_mtu_dt   --证件到期日期
        ,t2.bth_dt       --出生日期
        ,'2' as prio
    from(
        SElECT cst_id,rel_cst_id
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '20250601'
        and rel_typ='0101' --0101:法定代表人
        union
        SElECT rel_cst_id,cst_id
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '20250601'
        and rel_typ='0101' --0101:法定代表人
    )t1 inner join edw.dim_cst_idv_bas_inf_dd   t2 --个人客户基本信息
    on t1.cst_id=t2.cst_id
    and t2.dt='20250601'
    left join edw.dws_cst_bas_inf_dd 		    t3 --客户基础信息汇总表
    on t1.rel_cst_id=t3.cst_id
    and t3.dt='20250601'
)t1 left join edw.dwd_code_library_dd   c2
on t1.doc_typ_cd = c2.cd_val
and c2.dt = '20250601'
;
-- 实控人、法人
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_07 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	    --客户姓名|C200
    ,t2.doc_typ_cd
    ,c2.cd_val_dscr     as doc_typ_nm
    ,t2.doc_mtu_dt   --证件到期日期
    ,t3.bth_dt       --出生日期
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '20250601'
    and rel_typ='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '20250601'
    and rel_typ='0109' --实际控制人
)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='20250601'
and t2.cst_typ_cd='1'   --实控人为个人客户
left join edw.dim_cst_idv_bas_inf_dd t3 --个人客户基本信息
on t1.rel_cst_id=t3.cst_id
and t3.dt=t2.dt
left join edw.dwd_code_library_dd   c2
on t2.doc_typ_cd = c2.cd_val
and c2.dt = t2.dt
;
-- 个人当事人
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_08 AS
SELECT  t1.cst_id      AS 客户号
       ,t2.cst_chn_nm  AS 客户名称
       ,t2.doc_typ_cd  AS 证件类型代码
       ,c2.cd_val_dscr  as 证件类型
       ,t2.doc_mtu_dt  AS 证件到期日期
       ,c1.cd_val_dscr AS 职业
       ,t3.job_unt_nm  AS 工作单位名称
       ,t2.reg_adr     AS 户籍地址
       ,t2.cmn_adr     AS 通讯地址
       ,t4.prm_mgr_id  AS 主管护客户经理工号
       ,t4.prm_mgr_nm  AS 主管护客户经理姓名
       ,t4.prm_org_id  AS 主管护机构号
       ,t4.prm_org_nm  AS 主管户机构名称
       ,t5.最终风险等级
       ,t5.处理意见
       ,t6.cst_act_id  AS 客户账号
       ,t6.opn_dt      AS 开户日期
from SJXQ_SJ20250603231_CST_04       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250601'
left join edw.dim_cst_idv_bas_inf_dd t3 --个人客户基本信息
on t1.cst_id=t3.cst_id
and t3.dt=t2.dt
left join edw.dwd_code_library_dd   c1
on t3.ocp_cd = c1.cd_val
and c1.dt = t2.dt
left join edw.dwd_code_library_dd   c2
on t2.doc_typ_cd = c2.cd_val
and c2.dt = t2.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd           t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt =  t2.dt
left join SJXQ_SJ20250603231_CST_05  t5
on t1.cst_id=t5.cst_id and t5.rn=1
left join edw.dim_bus_dep_cst_act_inf_dd t6  		--客户存款账户信息
on t1.cst_id=t6.cst_id
and t6.dt=t2.dt
where t1.party_class_cd='I' --个人当事人
;
-- 对公当事人
DROP   TABLE IF     EXISTS SJXQ_SJ20250603231_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250603231_CST_09 AS
SELECT  t1.cst_id       AS 客户号
       ,t2.cst_chn_nm   AS 客户名称
       ,t2.doc_nbr      AS 证件号
       ,t2.doc_typ_cd   AS 证件类型代码
       ,c2.cd_val_dscr  AS 证件类型
       ,t2.doc_mtu_dt   AS 证件到期日期
       ,t3.opr_scp_dscr AS 经营范围描述
       ,t2.cmn_adr      AS 通讯地址
       ,t7.cst_nm       AS 法定代表人姓名
       ,t7.doc_typ_nm   AS 法定代表人证件类型
       ,t7.bth_dt       AS 法定代表人出生日期
       ,t7.doc_mtu_dt   AS 法定代表人证件有效期
       ,t8.cst_chn_nm   AS 实际控制人姓名
       ,t8.doc_typ_nm   AS 实际控制人证件类型
       ,t8.bth_dt       AS 实际控制人出生日期
       ,t8.doc_mtu_dt   AS 实际控制人证件有效期
       ,t9.BFI_NAME     AS 受益所有人姓名
       ,t9.CARD_TYPE    AS 受益所有人证件类型
       ,t9.brth_dt      AS 受益所有人出生日期
       ,t9.CARD_END_DT  AS 受益所有人证件到期日
       ,t9.addr         AS 受益所有人联系地址
       ,t4.prm_mgr_id  AS 主管护客户经理工号
       ,t4.prm_mgr_nm  AS 主管护客户经理姓名
       ,t4.prm_org_id  AS 主管护机构号
       ,t4.prm_org_nm  AS 主管户机构名称
       ,t5.最终风险等级
       ,t5.评级日期
       ,t5.处理意见
       ,t5.调整等级
       ,t6.cst_act_id  AS 客户账号
       ,t6.opn_dt      AS 开户日期
from SJXQ_SJ20250603231_CST_04       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250601'
left join edw.dim_cst_entp_bas_inf_dd t3 --企业客户基本信息
on t1.cst_id=t3.cst_id
and t3.dt=t2.dt
left join edw.dwd_code_library_dd   c2
on t2.doc_typ_cd = c2.cd_val
and c2.dt = t2.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd           t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt =  t2.dt
left join SJXQ_SJ20250603231_CST_05  t5
on t1.cst_id=t5.cst_id and t5.rn=1
left join edw.dim_bus_dep_cst_act_inf_dd t6  		--客户存款账户信息
on t1.cst_id=t6.cst_id
and t6.dt=t2.dt
left join SJXQ_SJ20250603231_CST_06  t7
on t1.cst_id = t7.entp_cst_id and t7.rn=1
left join SJXQ_SJ20250603231_CST_07  t8
on t1.cst_id = t8.cst_id
left join adm_upss.adm_upss_aml_t47_beneficiary	t9 --对公客户受益所有人表
on t1.cst_id=substr(t9.party_id, 3, 10)
and t9.dt='@@{yyyyMMdd}'
where t1.party_class_cd='C' --C:对公当事人
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250603231_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct PARTY_ID) custs
from SJXQ_SJ20250603231_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20250603231_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250603231_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250603231_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,entp_cst_id) custs
from SJXQ_SJ20250603231_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ20250603231_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250603231_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250603231_CST_09
;
--输出结果
SElECT '03' seq, * from SJXQ_SJ20250603231_CST_03 ;
SElECT '08' seq, * from SJXQ_SJ20250603231_CST_08 ;
SElECT '09' seq, * from SJXQ_SJ20250603231_CST_09 ;***刘康_SJ2025052271_社区定人和主维护人.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025052271_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052271_CST_01 AS
SELECT  col_1   --客户号
       ,col_2   --客户名称
       ,col_3   --客户属性
       ,col_4   --客户类型
       ,col_5   --客户建档时间
       ,col_6   --客户信息完整度
       ,col_7   --最近一次信息更新时间
       ,col_8   --最近一次信息更新人工号
       ,col_9   --最近一次信息更新人名称
from lab_bigdata_dev.qbi_file_20250527_17_27_06_0
where pt<>''
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025052271_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052271_CST_02 AS
SELECT  t1.col_1   as 客户号
       ,t1.col_2   as 客户名称
       ,t1.col_3   as 客户属性
       ,t1.col_4   as 客户类型
       ,t1.col_5   as 客户建档时间
       ,t1.col_6   as 客户信息完整度
       ,t1.col_7   as 最近一次信息更新时间
       ,t1.col_8   as 最近一次信息更新人工号
       ,t1.col_9   as 最近一次信息更新人名称
       ,t6.sub_cmnt_id                                                   AS 子社区编号
       ,t7.cmnt_nm                                                       AS 子社区名称
       ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND t2.empe_id REGEXP T10.EMPLOY_NO THEN '是'    --客户管护人是否是子社区的定人之一
              when nvl(T6.SUB_CMNT_ID,'')='' then ''
             ELSE '否' END AS 更新人是否为子社区定人
       ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND t2.empe_id = T8.EMPLOY_NO THEN '是'          --子社区主维护人是否等于客户管护人
              when nvl(T6.SUB_CMNT_ID,'')='' then ''
             ELSE '否' END AS 更新人是否为子社区主维护人
from SJXQ_SJ2025052271_CST_01  t1
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  cast(t1.col_8 as int) = cast(t2.empe_id as int)
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.col_1 = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
LEFT JOIN    edw.XWDT_ETL_XW_COMMUNITY_PER T8 --普惠社区定人信息表
ON      t6.SUB_CMNT_ID = T8.COMMUNITY_CODE --社区编号
AND     T8.IS_MAIN_PERSON = '1' --主维护人
AND     T8.DT = t6.dt
LEFT JOIN
(
	SELECT  COMMUNITY_CODE
	FROM edw.XWDT_ETL_XW_COMMUNITY_PER --普惠社区定人信息表
	WHERE dt = '@@{yyyyMMdd}'
	AND IS_MAIN_PERSON = '2' ---- 1主维护人，2社区定人
	GROUP BY  COMMUNITY_CODE
) T10
ON T6.SUB_CMNT_ID = T10.COMMUNITY_CODE --社区编号
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025052271_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052271_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025052271_CST_02
;
***刘斌_SJ20250123141_商户及其关联人产销.sql
﻿-- 截止2024年12月31日，商户及其同一风险控制号下的活期存款年日均、存款年日均、贷款贷款年日均、理财年日均、全量营收ftp、泰惠收我行信用卡收款次数
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250123141_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250123141_CST_01 AS
SELECT  t1.col_1   --商户编号
    ,t1.col_2      --商户名称
    ,t1.col_3      --简称
    ,t1.col_4      --泰惠收状态
    ,t1.col_5      --管户机构
    ,t1.col_6      --支行
    ,t1.col_7      --地址
    ,t1.col_8      --活动编号
    ,t1.col_9      --活动名
	,t2.mch_id                                   --商户编号|C32
	,t2.cst_id                                   --客户号|C20
from qbi_file_20250124_08_35_08_0 			t1
left join edw.dim_bus_chnl_ths_mch_inf_dd   t2 --泰惠收商户基本信息
on t1.col_1=t2.mch_id
and t2.dt='20241231'
where t1.pt<>''
;
-- 客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250123141_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250123141_CST_02 AS
select t1.cst_id                                 	--客户号|C20
	,t1.cst_chn_nm                               	--客户姓名|C200
	,case when nvl(t1.sam_rsk_ctrl_id,'')<>'' then t1.sam_rsk_ctrl_id
		else t1.cst_id end as sam_rsk_ctrl_id 		--同一风险控制号|C24
    ,t2.dmnd_dep_bal_year_avg	--活期存款年日均
    ,t2.dep_bal_year_avg	    --存款余额年日均
    ,t4.loan_bal_acs_year_avg	--贷款余额年日均
    ,t3.chm_year_avg	        --理财金额年日均
	,t5.cur_year_ftp_inc		--当年FTP利润收入
	,t5.last_12_mon_own_ftp_ctb	--近12个月我行综合FTP贡献
from edw.dws_cst_bas_inf_dd                 t1 --客户基础信息汇总表
left join adm_pub.adm_csm_cbus_dep_inf_dd 	t2 --存款业务信息表
on t1.cst_id=t2.cst_Id
and t2.dt='20241231'
left join adm_pub.adm_csm_cbus_chm_inf_dd   t3 --客户集市-业务信息-客户理财业务信息表
on t1.cst_id=t3.cst_Id
and t3.dt='20241231'
left join adm_pub.adm_csm_cbus_loan_inf_dd 	t4 --贷款业务信息
on t1.cst_id=t4.cst_Id
and t4.dt='20241231'
left join adm_pub.adm_csm_cbus_ftp_inf_dd	t5 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t5.cst_Id
and t5.dt='20241231'
where t1.dt='20241231'
;
-- 泰惠收我行信用卡收款次数
DROP   TABLE IF     EXISTS SJXQ_SJ20250123141_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250123141_CST_03 AS
select t1.clr_dt                                   --清算日期|C8
	,t1.entr_act_dt                              --入账日期|C8
	,t1.mch_id                                   --商户编号|C32
	,t1.trx_amt                                  --交易金额|DECIMAL
	,t1.stl_act_id                               --结算账号|C64
	,t1.stl_act_nm                               --结算账户户名|C32
	,t1.chnl_int_srl_nbr                         --通道内部流水号|C32
	,t1.pay_bnk_id                               --支付银行id|C50
	,t1.pay_bnk_nm                               --支付银行名|C50
	,t1.pay_acc_id                               --支付账户号|C40
	,case when t3.cr_crd_card_nbr is not null THEN 1 else 0 end as is_our_crd
	,t4.sam_rsk_ctrl_id
from edw.dwd_bus_chnl_ths_entr_act_di 	t1        --泰惠收商户入账明细
INNER JOIN SJXQ_SJ20250123141_CST_01 	t2
on t1.mch_id=t2.mch_id
left join APP_ADO.ADM_SUBL_BUS_CRD_CR_CARD_SMY_INF_DD t3
on t1.pay_acc_id=t3.cr_crd_card_nbr
and t3.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ20250123141_CST_02 	t4
on t2.cst_id=t4.cst_Id
where t1.dt<='20241231'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250123141_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250123141_CST_04 AS
SELECT  t1.col_1   as 商户编号
    ,t1.col_2      as 商户名称
    ,t1.col_3      as 简称
    ,t1.col_4      as 泰惠收状态
    ,t1.col_5      as 管户机构
    ,t1.col_6      as 支行
    ,t1.col_7      as 地址
    ,t1.col_8      as 活动编号
    ,t1.col_9      as 活动名
	,t1.cst_id     as 客户号
    ,t2.dmnd_dep_bal_year_avg	as 活期存款年日均
    ,t2.dep_bal_year_avg	    as 存款余额年日均
    ,t2.loan_bal_acs_year_avg	as 贷款余额年日均
    ,t2.chm_year_avg	        as 理财金额年日均
	,t2.cur_year_ftp_inc		as 当年FTP利润收入
	,t2.last_12_mon_own_ftp_ctb	as 近12个月我行综合FTP贡献
	,t3.is_our_crd 				as 泰惠收我行信用卡收款次数
	,t2.sam_rsk_ctrl_id 		as 同一风险控制号
	,t4.同一风险控制号下活期存款年日均
	,t4.同一风险控制号下存款余额年日均
	,t4.同一风险控制号下贷款余额年日均
	,t4.同一风险控制号下理财金额年日均
	,t4.同一风险控制号下当年FTP利润收入
	,t4.同一风险控制号下近12个月我行综合FTP贡献
	,t5.同一风险控制号下泰惠收我行信用卡收款次数
from SJXQ_SJ20250123141_CST_01 		t1
left join SJXQ_SJ20250123141_CST_02 t2
on t1.cst_id=t2.cst_id
left join(
	SELECT mch_id,sum(is_our_crd) as is_our_crd
	from SJXQ_SJ20250123141_CST_03
	GROUP BY mch_id
) t3 on t1.mch_id=t3.mch_id
left join (
	SELECT sam_rsk_ctrl_id
    	,sum(dmnd_dep_bal_year_avg	) as 同一风险控制号下活期存款年日均
    	,sum(dep_bal_year_avg	    ) as 同一风险控制号下存款余额年日均
    	,sum(loan_bal_acs_year_avg	) as 同一风险控制号下贷款余额年日均
    	,sum(chm_year_avg	        ) as 同一风险控制号下理财金额年日均
		,sum(cur_year_ftp_inc		) as 同一风险控制号下当年FTP利润收入
		,sum(last_12_mon_own_ftp_ctb) as 同一风险控制号下近12个月我行综合FTP贡献
	from SJXQ_SJ20250123141_CST_02
	GROUP BY sam_rsk_ctrl_id
) t4 on t2.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
left join(
	SELECT sam_rsk_ctrl_id,sum(is_our_crd) as 同一风险控制号下泰惠收我行信用卡收款次数
	from SJXQ_SJ20250123141_CST_03
	GROUP BY sam_rsk_ctrl_id
) t5 on t2.sam_rsk_ctrl_id=t5.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ20250123141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250123141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ20250123141_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 商户编号) custs
from SJXQ_SJ20250123141_CST_04
;
/*
01	243	243
02	19147804	19147804
03	17117797	243
04	243	243
*/
***刘斌_SJ2025031816_龙游支行信用卡数据.sql
﻿/*
衢州分行龙游支行的信用卡营收中收数据较好，分行想分析是哪几类客户主要在进行分期/取现/循环，并将其客户画像提取出来；同时找到这类客群的消费喜好、消费特点，进而更好的进行获客。
龙游支行客户基本信息及交易数据
数据需求字段
需求字段：
1、客户号、管户支行、管户客户经理、客户年龄、性别、工作单位、职业类型、年收入、婚姻状态、家庭人数
2、持卡张数、我行卡片额度、卡片月均透支率
3、2024年1月1日至2025年2月28日我行信用卡消费总频次、每位客户消费前五的商户（非线上消费）及其细分行业类型
4、2024年1月1日至2025年2月28日我行信用卡消费总金额、他行信用卡消费总金额
5、2024年1月1日至2025年2月28日信用卡ftp营收
6、2024年1月1日至2025年2月28日分期月日均
7、2024年1月1日至2025年2月28日循环月日均
8、2024年1月1日至2025年2月28日取现月日均
9、消费类别占比：餐饮消费、购物消费、旅游消费
*/
-- 信用卡信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025031816_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031816_CST_01 AS
select t1.cr_crd_card_nbr                          --信用卡卡号|C19
	,t1.card_sts_cd                              --卡片状态代码|C2
    ,c1.cd_val_dscr     AS 卡片状态
	,t1.card_sts_dt                              --卡片状态日期|C8
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.busi_ctr_id                              --业务合同编号|C32
	,t1.busi_apl_id                              --业务申请编号|C32
	,t1.card_actv_dt                             --卡片激活日期|C8
	,t1.late_trx_dt                              --最后交易日期|C8
	,t1.cr_crd_act_id                            --信用卡账号|C10
	,t1.cst_crd_lmt                              --客户信用额度|DECIMAL(21,2)
    ,t2.acs_org_id                               --考核机构编号|c12
	,t2.mgr_typ_cd                               --管护类型代码|c10
	,t2.mgr_nm                                   --管护人名称|c200
	,t2.frs_mgr_nm                               --第一管护人名称|c200
	,t2.scd_mgr_nm                               --第二管护人名称|c200
    ,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_crd_cr_crd_inf_dd          t1 --信用卡卡片信息
left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t2 --信用卡管护信息
on t1.cr_crd_card_nbr=t2.cr_crd_card_nbr	--信用卡卡号|c20
and t2.dt=t1.dt
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t1.card_sts_cd=c1.cd_val
and C1.DT = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t2.acs_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='衢州分行'
and t4.sbr_org_nm regexp '龙游支行'
inner join(
    select distinct cst_id
    from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di  --信用卡交易宽表
    where dt between '20240101' and '20250228'
)t5 on t1.cst_id=t5.cst_id
where t1.dt='20250228'
;
-- 信用卡账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025031816_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031816_CST_02 AS
select t1.cst_id,t1.cr_crd_act_id
    ,t5.acc_int_year_ajust	    as 账户24年累计FTP营收
    ,t6.acc_int_year_ajust	    as 账户25年1_2月累计FTP营收
    ,nvl(t5.acc_int_year_ajust,0) +nvl(t6.acc_int_year_ajust,0) as xyk_ftp_14m
    ,t6.late_6month_ovdr_prcp   --近6个月平均透支本金
from(
    select distinct cst_id,cr_crd_act_id
    from SJXQ_SJ2025031816_CST_01
)t1
left join app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd t5 --信用卡账户信息汇总表
on t1.cr_crd_act_id=t5.cr_crd_act_id
and t5.dt='20241231'
left join app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd t6 --信用卡账户信息汇总表
on t1.cr_crd_act_id=t6.cr_crd_act_id
and t6.dt='20250228'
;
-- 分期月日均,循环月日均,取现月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2025031816_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031816_CST_03 AS
SELECT  t1.dt,t1.cst_id
        ,ROUND(SUM(CASE WHEN t2.ovd_hi_trm = 0 AND t3.mon_acm_csm_bal_acml > 0
            -- 月累计利息收入 本币取现利率
            AND t3.mon_acm_intr_inc * 36000 / substr(t1.dt,7,2) / t5.dms_ccy_csh_intr_rat - t3.mon_acm_csh_bal_acml / substr(t1.dt,7,2) > 0
            THEN t3.mon_acm_intr_inc * 36000 / substr(t1.dt,7,2) / t5.dms_ccy_csh_intr_rat - t3.mon_acm_csh_bal_acml / substr(t1.dt,7,2) END),2) as 循环月日均
        ,ROUND(SUM(CASE WHEN t2.ovd_hi_trm = 0 THEN t3.mon_acm_csh_bal_acml END) /substr(t1.dt,7,2),2)    as 取现月日均     --月累计取现余额积数
        ,ROUND(SUM(CASE WHEN t2.ovd_hi_trm = 0 THEN t3.mon_acm_instl_bal_acml END) /substr(t1.dt,7,2),2)  as 分期月日均     --月累计分期未还本金积数
FROM edw.dim_bus_crd_cr_crd_inf_dd t1 --信用卡卡片信息
INNER JOIN edw.dws_bus_crd_cr_crd_act_inf_dd t2 --信用卡账户汇总信息
ON t1.cr_crd_card_nbr = t2.late_main_card_card_nbr AND t2.DT = t1.dt
LEFT JOIN edw.dws_bus_crd_cr_crd_act_acm_inf_dd t3 --信用卡账户汇总信息
ON t2.cr_crd_act_id = t3.cr_crd_act_id AND t3.dt = t1.dt
LEFT JOIN
(
    SELECT  dt,cr_crd_act_id
            ,SUM(tot_pd_amt) tot_pd_amt
    FROM edw.dwd_bus_crd_cr_crd_instl_dtl_dd
            ,'20240831','20240930','20241031','20241130','20241231','20250131', '20250228')
    AND substr(rcd_dt, 1, 6) = substr(dt,1,6)
    GROUP BY  dt,cr_crd_act_id
) t4
ON t2.cr_crd_act_id = t4.cr_crd_act_id and t2.dt=t4.dt
LEFT JOIN
(
    SELECT  dt,intr_rat_cd
            ,dms_ccy_csh_intr_rat
            ,ROW_NUMBER() OVER ( PARTITION BY dt,lgp_id ,bnk_id ,intr_rat_cd ORDER BY  eft_dt DESC ) AS rn
    FROM edw.dim_bus_crd_cr_crd_intr_rat_cd_parm_dd --信用卡利率代码参数表
            ,'20240831','20240930','20241031','20241130','20241231','20250131', '20250228')
) t5
ON t2.intr_rat_cd = t5.intr_rat_cd and t2.dt=t5.dt
AND t5.rn = 1
    ,'20240831','20240930','20241031','20241130','20241231','20250131', '20250228')
AND substr(t1.cr_crd_card_nbr, 1, 6) <> '622717' --排除准贷记卡
and t1.cst_id in(select distinct cst_id from SJXQ_SJ2025031816_CST_01)
GROUP BY t1.dt,t1.cst_id
;
--信用卡交易宽表
DROP   TABLE IF     EXISTS SJXQ_SJ2025031816_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031816_CST_04 AS
SELECT  t1.cst_id           --客户号
       ,t1.cr_crd_act_id    --信用卡账号
       ,t1.cr_crd_card_nbr  --信用卡卡号
       ,t1.trx_typ_cd       --交易类型代码
       ,t1.trx_typ_dscr     --交易类型描述
       ,t1.onl_ofln_trx_ind	--线上线下交易标识
       ,t1.trx_ccy_cd       --交易币种代码
       ,c1.cd_val_dscr      --交易币种
       ,t1.trx_amt          --交易金额
       ,t1.mch_typ_cd       --商户类型代码
       ,t1.mch_cd           --商户代码
       ,t1.trx_dt           --交易日期
       ,t1.trx_tm           --交易时间
       ,t1.cnt_pty_act_id   --对方账号
       ,t1.cnt_pty_act_nm   --对方户名
       ,t1.trx_dscr_1       --交易描述1
       ,t1.trx_dscr_2       --交易描述2
       ,t1.act_bal          --账户余额
    ,case when t1.trx_typ_cd like '1%' and t1.trx_typ_cd <> '1050'
            or t1.trx_dscr_1 regexp '百货|商场|购物中心|银泰|in77|天街|免税|家电|电器|空调|冰箱|冷柜|洗衣机|油烟机|手机|Apple com|apple授权|电子|apple专卖|电脑|通讯|华为终端|华为商城|华为专卖|华为体验|华为手机|华为旗舰|华为授权|华为京东|OPPO|vivo|荣耀终端|荣耀京东|联想（上海）|联想京东|联想笔记本|戴尔专卖|戴尔电脑|索尼（中国）|佳能影像|佳能数码|佳能相机|手机充值|维修|服装|女装|男装|时装|箱包|鞋|鞋服|服饰|皮具|工艺品|工艺礼品|陶瓷|朱炳仁|眼镜|毛源昌|珠宝|黄金|玉器|翡翠|水晶|钟表|首饰')
        then 1 else 0 end as is_gouwu --信用卡购物消费
    ,case when t1.trx_typ_cd like '1%' and t1.trx_typ_cd <> '1050' then 1 else 0 end as is_csm
from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di t1 --信用卡交易宽表
left join edw.dwd_code_library_dd 				c1
on  t1.trx_ccy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
inner join SJXQ_SJ2025031816_CST_01 t4
on t1.cr_crd_card_nbr=t4.cr_crd_card_nbr
where t1.dt >= '20240101'
and t1.dt <= '20250228'
and t1.wdw_rvs_ind = '0'  --撤销冲正标志
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031816_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031816_CST_05 AS
SELECT  t1.cst_id                      AS 客户编号
    ,t1.cst_nm                         AS 客户名称
    ,t1.管户人名称
    ,t1.管户支行
    ,decode(t3.gdr_cd,'1','男','2','女','未知') AS 性别
    ,t3.age                            AS 年龄
	,decode(t3.mrg_situ_cd,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','') as 婚姻状况
    ,t3.fml_nbr                        AS 家庭人数
    ,t3.anl_inc                        AS 年收入
    ,c1.cd_val_dscr                    AS 职业
    ,t3.job_unt_nm                     AS 工作单位名称
    ,t1.信用卡数
    ,t1.客户信用额度
    ,t2.xyk_ftp_14m                    AS 账户累计FTP营收
    ,t2.late_6month_ovdr_prcp          AS 近6个月平均透支本金
    ,t4.oth_crd_bal                    AS 他行信用卡余额
    ,t4.oth_dbt_card_bal               AS 他行贷记卡用信总额
    ,t4.oth_dbt_card_use_rat           AS 他行贷记卡用信率
    ,t5.分期月日均
    ,t5.循环月日均
    ,t5.取现月日均
    ,t7.cnt_pty_act_nm                 AS 客户消费前五的商户_非线上
    ,t6.trx_cnt                        AS 2024年1月1日至2025年2月28日我行信用卡消费总频次
    ,t6.trx_amt                        AS 2024年1月1日至2025年2月28日我行信用卡消费总金额
    ,round(t6.canyin_amt/t6.trx_amt,4) AS 餐饮消费占比
    ,round(t6.gouwu_amt/t6.trx_amt,4)  AS 购物消费占比
    ,round(t6.lvyou_amt/t6.trx_amt,4)  AS 旅游消费占比
from(
    SELECT cst_id                               --客户编号
        ,cst_nm                                 --客户名称
        ,count(distinct cr_crd_card_nbr)        as 信用卡数
        ,SUM(cst_crd_lmt)                       as 客户信用额度
    from SJXQ_SJ2025031816_CST_01
    group by cst_id,cst_nm
)t1 left join(
    select cst_id
        ,sum(xyk_ftp_14m)           as xyk_ftp_14m
        ,sum(late_6month_ovdr_prcp) as late_6month_ovdr_prcp
    from SJXQ_SJ2025031816_CST_02
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t3 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt='20250228'
left join edw.dwd_code_library_dd c1        --132058 tbl_nm,fld_nm,cd_val 唯一
on t3.ocp_cd = c1.cd_val
and c1.dt='20250228'
left join adm_pub.adm_csm_cbas_oth_ln_inf_dd t4      --客户集市-业务信息-客户他行业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250228'
left join(
    select cst_id
        ,sum(nvl(分期月日均,0))/14 as 分期月日均
        ,sum(nvl(循环月日均,0))/14 as 循环月日均
        ,sum(nvl(取现月日均,0))/14 as 取现月日均
    from SJXQ_SJ2025031816_CST_03
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    select cst_id
        ,count(cst_id)  as trx_cnt
        ,sum(trx_amt)   as trx_amt
        ,sum(case when is_canyin=1 then trx_amt else 0 end) as canyin_amt
        ,sum(case when is_gouwu=1 then trx_amt else 0 end)  as gouwu_amt
        ,sum(case when is_lvyou=1 then trx_amt else 0 end)  as lvyou_amt
    from SJXQ_SJ2025031816_CST_04
    where is_csm=1  --消费
    GROUP BY cst_id
)t6 on t1.cst_id=t6.cst_id
left join(
    select cst_id
    from(
        select *,row_number() over(partition by cst_id order by trx_amt desc) rn
        from(
            select cst_id,cnt_pty_act_nm,sum(trx_amt) as trx_amt
            from SJXQ_SJ2025031816_CST_04
            where is_csm=1  --消费
            and onl_ofln_trx_ind='1'
            group by cst_id,cnt_pty_act_nm
        )t
    )t where rn<=5 group by cst_id
)t7 on t1.cst_id=t7.cst_id
;
-- jgb
SElECT '05' seq, *
from sjxq.SJXQ_SJ2025031816_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025031816_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cr_crd_act_id) custs
from SJXQ_SJ2025031816_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025031816_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025031816_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户编号) custs
from SJXQ_SJ2025031816_CST_05
;
/*
01	3364	3364
02	3364	3362
03	38440	2958
04	307570	2995
05	2999	2999
*/***刘斌_SJ20250408151_信用卡发卡信息.sql
﻿-- 2023年1月至2025年3月31日，衢州分行信用卡发卡清单、包含卡片推荐人，当时所属机构、支行、卡片状态
DROP   TABLE IF     EXISTS SJXQ_SJ20250408151_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250408151_CST_01 AS
select t1.cr_crd_mgr_id                          as 信用卡业务管户人工号
	,t1.cr_crd_mgr_nm                            as 信用卡业务管户人名称
	,t1.cr_crd_brc_org_nm as 信用卡业务管户分行名称
	,t1.cr_crd_sbr_org_nm                        as 信用卡业务管户支行名称
	,t1.cst_brc_org_nm as 客户主管户分行名称
	,t1.cst_sbr_org_nm                           as 客户主管户支行名称
	,t4.frs_mgr_id                               as 推荐人员工号
	,t4.fst_mgr_nm                               as 推荐人员名称
    ,t4.rfer_org_nm              				 as 推荐人机构名称
	,t1.market_no	as	二维码推荐人工号
	,t3.empe_nm as 	二维码推荐人
	,t1.cr_crd_card_nbr                          as 信用卡卡号
	,t1.cr_crd_act_id                            as 信用卡账号
	,t1.cst_id                                   as 客户编号
	,t1.cst_nm                                   as 客户名称
	,t1.cr_crd_pd_id                             as 信用卡产品编号
	,t1.cr_crd_pd_cmt                            as 信用卡产品名称
	,t1.cd_val_dscr                              as 卡状态
	,t1.card_sts_cd                              as 卡状态码值
	,t1.card_sts_dt                              as 卡片状态日期
	,t1.opn_dt                                   as 账户开户日期
	,t1.isu_dt                                   as 发卡日期
	,t1.card_actv_dt                             as 激活日期
from app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd    t1 --信用卡卡片信息汇总表
left join edw.dim_hr_org_mng_org_tree_dd            t2 --考核机构树
on  t1.int_fst_org_id=t2.org_id
and t2.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.market_no=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_bus_crd_cr_crd_act_inf_dd  t4      --信用卡账户信息汇总
on t1.cr_crd_act_id=t4.cr_crd_act_id	--	信用卡账号
and t4.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and (t1.cr_crd_brc_org_nm = '衢州分行' or t1.cst_brc_org_nm = '衢州分行')
and t1.isu_dt between '20230101' and '20250331'
;
-- -- 推荐人
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250408151_CST_02 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250408151_CST_02 AS
-- select t1.信用卡卡号,t1.信用卡账号
-- 	,t2.fst_rcmd_empe_id                         --第一推荐人员工号
-- 	,t2.fst_rcmd_empe_nm                         --第一推荐人员名称
-- 	,t3.frs_mgr_id                               as 第一推荐人工号
-- 	,t3.fst_mgr_nm                               as 第一推荐人姓名
-- 	,t3.scd_mgr_id                               as 第二推荐人工号
-- 	,t3.scd_mgr_nm                               as 第二推荐人姓名
-- 	,t4.frs_mgr_id                               --第一推荐人员工号|C32
-- 	,t4.fst_mgr_nm                               --第一推荐人员名称|C200
-- 	,t4.scd_mgr_id                               --第二推荐人员工号|C32
-- 	,t4.scd_mgr_nm                               --第二推荐人员名称|C200
-- from SJXQ_SJ20250408151_CST_01 t1
-- left join adm_rsk.adm_rsk_ast_card_crdt_acc_inf_dd	t2 --风险集市信用卡账户信息表	1
-- on t1.信用卡账号=t2.crdt_card_acc	--	信用卡账号
-- and t2.dt='@@{yyyyMMdd}'
-- left join app_rpt.adm_pub_bus_cr_crd_inf_dd  t3      --公共应用集市-信用卡明细信息表
-- on t1.信用卡卡号=t3.cr_crd_card_nbr
-- and t3.dt='@@{yyyyMMdd}'
-- left join edw.dws_bus_crd_cr_crd_act_inf_dd  t4      --信用卡账户信息汇总
-- on t1.信用卡账号=t4.cr_crd_act_id	--	信用卡账号
-- and t4.dt='@@{yyyyMMdd}'
-- ;
SElECT '01' seq, *
from lab_sjxq.SJXQ_SJ20250408151_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ20250408151_CST_01
***刘斌_SJ2025061936_衢州分行信用卡业务数据.sql
﻿-- 刘斌_SJ2025061936_衢州分行信用卡业务数据
-- 衢州分行存续信用卡中，信用卡的基本信息、交易数据、业务数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025061936_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061936_CST_01 AS
select t1.cr_crd_card_nbr                          --信用卡卡号|C19
	,t1.main_crd_ind                             --主附卡标志|C1
	,t1.card_sts_cd                              --卡片状态代码|C2
    ,c1.cd_val_dscr     as 卡片状态
	,t1.card_sts_dt                              --卡片状态日期|C8
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.card_actv_dt                             --卡片激活日期|C8
	,t1.late_trx_dt                              --最后交易日期|C8
	,t1.cr_crd_act_id                            --信用卡账号|C10
    ,t2.act_sts_cd	--	信用卡账户状态|C2
    ,t2.acs_org_id	as acs_org_id2 --	考核机构|C12
    ,t3.acs_org_id	    --	考核机构编号|c12
    ,t3.frs_mgr_id	    --	第一管护人编号|c10
    ,t3.scd_mgr_id	    --	第二管护人编号|c10
    ,t3.mgr_typ_cd	    --	管护类型代码|c10
    ,t3.mgr_nm	        --	管护人名称|c200
    ,t3.scd_mgr_nm	    --	第二管护人名称|c200
    ,t3.frs_mgr_nm	    --	第一管护人名称|c200
from edw.dws_bus_crd_cr_crd_inf_dd          t1 --信用卡卡片信息汇总
left join edw.dws_bus_crd_cr_crd_act_inf_dd t2 --信用卡账户信息汇总
on t1.cr_crd_act_id=t2.cr_crd_act_id
and t2.dt=t1.dt
INner join edw.dwd_bus_crd_cr_crd_mgr_inf_dd    t3
on t1.cr_crd_card_nbr=t3.cr_crd_card_nbr
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.acs_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '衢州分行'
left join EDW.DWD_CODE_LIBRARY_DD       c1
on t1.card_sts_cd=c1.cd_val
and C1.DT = t1.dt
where t1.dt='20250622'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025061936_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061936_CST_02 AS
select t1.cr_crd_brc_org_id                        --信用卡业务管户分行号
	,t1.cr_crd_brc_org_nm                        --信用卡业务管户分行名称
	,t1.cr_crd_org_id                            --信用卡业务管户机构号
	,t1.cr_crd_org_nm                            --信用卡业务管户机构名称
	,t1.cr_crd_mgr_id                            --信用卡业务管户人工号
	,t1.cr_crd_mgr_nm                            --信用卡业务管户人名称
	,t1.cst_mgr_id                               --客户主管户客户经理
	,t1.cst_mgr_nm                               --客户主管户客户经理名称
	,t1.cr_crd_card_nbr                          --信用卡卡号
	,t1.cr_crd_act_id                            --信用卡账号
	,t1.cst_id                                   --客户编号
	,t1.cst_nm                                   --客户名称
	,t1.main_card_card_nbr                       --主卡卡号
	,t1.cd_val_dscr                              --卡状态
	,t1.card_sts_cd                              --卡状态码值
	,t1.card_actv_dt                             --激活日期
	,t2.act_sts_cd                               --帐户状态代码
	,t2.act_sts_nm                               --帐户状态名称
from app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd            t1 --信用卡卡片信息汇总表
INNER JOIN    APP_ADO.ADM_SUBL_BUS_CRD_CR_ACCT_SMY_INF_DD   t2
ON   t1.cr_crd_card_nbr = t2.late_main_card_card_nbr
AND  t2.dt = t1.dt
where t1.dt='20250622'
AND   t1.cr_crd_brc_org_nm = '衢州分行'
AND   t1.crd_ctg_nm = '贷记卡'
;
-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025061936_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061936_CST_03 AS
select t1.cr_crd_act_id                            --信用卡账号|C32
	,t1.cr_crd_card_nbr                          --信用卡卡号|C32
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C32
	,t1.trx_amt                                  --交易金额|DECIMAL(20,2)
	,t1.trx_typ_cd                               --交易类型代码|C32
	,t1.trx_typ_dscr                             --交易类型描述|C32
	,t1.act_dt                                   --入帐日期|C8
	,t1.mon_id                                   --月份编号|C32
	,t1.trx_ind                                  --交易标志|C10
	,t1.rtn_gds_trx_id                           --退货交易标识|C32
	,t1.trx_dscr_1                               --交易描述1|C64
	,t1.trx_dscr_2                               --交易描述2|C64
	,t1.wdw_rvs_ind                              --撤销冲正标志|C1
	,t1.trx_hpn_dt                               --交易发生日期|C8
	,t1.actl_trx_tm                              --实际交易时间|C8
    ,case when t1.trx_dscr_1 regexp '财付通|微信' THEN '微信'
        when t1.trx_dscr_1 regexp '支付宝' THEN '支付宝'
        when t1.trx_dscr_1 regexp '云闪付' THEN '云闪付'
        when t1.trx_dscr_1 regexp '抖音' THEN '抖音' when t1.trx_dscr_1 regexp '拼多多' THEN '拼多多'
        when t1.trx_dscr_1 regexp '京东' THEN '京东' when t1.trx_typ_dscr regexp 'ATM' then 'ATM'
        when t1.trx_dscr_1 regexp '美团' THEN '美团' when t1.trx_typ_dscr regexp 'POS消费' then t1.trx_typ_dscr
        else '' end as platform
from edw.dwd_bus_crd_cr_crd_trx_dtl_di  t1        --信用卡客户交易流水
inner join SJXQ_SJ2025061936_CST_02     t2
on t1.cr_crd_card_nbr=t2.cr_crd_card_nbr
WHERE t1.dt <= '20250622'
AND t1.dt > '20250322'
AND t1.trx_typ_cd <> '1050'  --筛选交易类型为消费
AND t1.wdw_rvs_ind <> '1'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025061936_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061936_CST_04 AS
SELECT  t1.cr_crd_org_id                                       AS 信用卡业务管户机构号
       ,t1.cr_crd_org_nm                                       AS 信用卡业务管户机构名称
       ,t1.cr_crd_mgr_id                                       AS 信用卡业务管户人工号
       ,t1.cr_crd_mgr_nm                                       AS 信用卡业务管户人名称
       ,t1.cst_mgr_id                                          AS 客户主管户客户经理
       ,t1.cst_mgr_nm                                          AS 客户主管户客户经理名称
       ,t1.cr_crd_card_nbr                                     AS 信用卡卡号
       ,t1.cr_crd_act_id                                       AS 信用卡账号
       ,t1.cst_id                                              AS 客户编号
       ,t1.cst_nm                                              AS 客户名称
       ,t1.main_card_card_nbr                                  AS 主卡卡号
       ,t1.cd_val_dscr                                         AS 卡状态
       ,t1.card_sts_cd                                         AS 卡状态码值
       ,t1.card_actv_dt                                        AS 激活日期
       ,t1.act_sts_cd                                          AS 帐户状态代码
       ,t1.act_sts_nm                                          AS 帐户状态名称
       ,t2.近90天交易次数_不含还款
       ,t2.近90天消费金额_不含还款
       ,t2.微信渠道交易金额
       ,t2.支付宝渠道交易金额
       ,t2.云闪付渠道交易金额
        ,t2.抖音渠道交易金额
        ,t2.银联POS消费渠道交易金额
        ,t2.本行POS消费渠道交易金额
        ,t2.京东美团拼多多渠道交易金额
       ,t2.最后交易日期
       ,CASE WHEN t3.cst_id is not null THEN '是'  ELSE '否' END AS 是否有我行借记卡
       ,t4.dep_bal                                             AS 存款余额
       ,t5.loan_bal_acs                                        AS 贷款余额
       ,t6.chm_bal                                             AS 理财产品余额
from SJXQ_SJ2025061936_CST_02 t1
left join(
    select cr_crd_card_nbr
        ,count(1)       as 近90天交易次数_不含还款
        ,sum(trx_amt)   as 近90天消费金额_不含还款
        ,sum(case when platform = '微信' then trx_amt else 0 end) as 微信渠道交易金额
        ,sum(case when platform = '支付宝' then trx_amt else 0 end) as 支付宝渠道交易金额
        ,sum(case when platform = '云闪付' then trx_amt else 0 end) as 云闪付渠道交易金额
        ,sum(case when platform = '抖音' then trx_amt else 0 end) as 抖音渠道交易金额
        ,sum(case when platform = '银联POS消费' then trx_amt else 0 end) as 银联POS消费渠道交易金额
        ,sum(case when platform = '本行POS消费' then trx_amt else 0 end) as 本行POS消费渠道交易金额
        ,sum(case when platform regexp '京东|美团|拼多多' then trx_amt else 0 end) as 京东美团拼多多渠道交易金额
        ,max(trx_dt)    as 最后交易日期
     from SJXQ_SJ2025061936_CST_03
    group by cr_crd_card_nbr
)t2 on t1.cr_crd_card_nbr=t2.cr_crd_card_nbr
left join(
    select distinct cst_id
    from edw.dws_bus_dep_act_inf_dd    			--存款账户信息汇总
    where dt='20250622' and act_sts_cd = 'A'
)t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbus_dep_inf_dd t4		--存款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250622'
left join adm_pub.adm_csm_cbus_loan_inf_dd t5		--贷款业务信息
on t1.cst_id=t5.cst_id
and t5.dt='20250622'
left join adm_pub.adm_csm_cbus_chm_inf_dd  t6		--理财业务信息表
on t1.cst_id=t6.cst_id
and t6.dt='20250622'
;
SElECT '01' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025061936_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025061936_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cr_crd_card_nbr,trx_dt,trx_tm) custs
from SJXQ_SJ2025061936_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户编号) custs
from SJXQ_SJ2025061936_CST_04
;
/*
01	68616	68616
02	59860	59860
03	445577	445577
04	59860	54052
*/
SElECT '04' seq, *
from SJXQ_SJ2025061936_CST_04
;
***刘源_SJ20250224106_汝南村行随贷通用信率.sql
-- 截止2.24，汝南村行随贷通卡自办理以来的用信率
DROP   TABLE IF     EXISTS SJXQ_SJ20250224106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224106_CST_01 AS
SELECT  t1.ctr_serno AS 合同流水号
       ,t1.cst_id    AS 客户号
       ,t1.cst_nm    AS 客户名称
       ,t1.ctr_amt   AS 合同金额
       ,t1.ctr_bal   AS 合同余额
       ,t5.bind_lmt  AS 绑定额度
       ,round(t6.cum_ctr_bal/t6.cum_days,2)             AS 自办理以来余额日均
       ,round(t6.cum_ctr_bal/t6.cum_days,2)/t5.bind_lmt AS 自办理以来用信率
       ,t3.empe_nm                                      AS 管户人
       ,t4.org_nm                                       AS 管户机构
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20250224'
and t2.PD_NM regexp '随贷通'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20250224'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20250224'
left join edw.dwd_bus_loan_fnc_crd_lmt_inf_dd T5 --随贷通授信额度信息
ON      T1.CTR_SERNO = T5.bus_ctr_id
AND     T5.lmt_sts_cd IN ( '0' , '3' )
AND     T5.DT = '20250224'
left join(
    select ctr_serno
        ,sum(CTR_BAL)   as cum_ctr_bal
        ,count(distinct dt) as cum_days
    from edw.dim_bus_loan_ctr_bse_inf_dd
    where dt<='20250224'
    and mgr_org_id like '4162%' --汝南村行
    group by ctr_serno
)t6 on t1.ctr_serno=t6.ctr_serno
where t1.dt='20250224'
and t1.mgr_org_id like '4162%' --汝南村行
;
SElECT '01' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250224106_CST_01
;
SElECT *
from SJXQ_SJ20250224106_CST_01
***刘源_SJ20250605136_汝南村行信贷客户交接明细.sql
﻿-- 汝南村行2025年1-5月信贷客户交接明细
-- 信贷客户交接明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250605136_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250605136_CST_01 AS
SELECT a.cst_id
    ,a.bfr_hdv_cst_magr_id	--移交前客户经理工号
    ,t1.empe_nm     as 移交前客户经理
    ,a.bfr_hdv_mgr_org_no	--移交前管户机构编号
    ,t5.org_nm      as 移交前管户机构
    ,a.aft_hdv_cst_magr_id	--移交后客户经理工号
    ,t2.empe_nm     as 移交后客户经理
    ,a.aft_hdv_mgr_org_no	--移交后管户机构编号
    ,t4.org_nm      as 移交后管户机构
    ,a.sys_reg_psn	        --系统登记人
    ,t3.empe_nm     as 系统登记人
    ,substr(REPLACE(a.sys_reg_tm, '-', ''),1,8) as HDV_DT   --交接日期
    ,t4.brc_org_nm
FROM    edw.loan_cst_mgr_hdv_rcd AS a  --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
inner join (
	select distinct  cst_id
	from EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD  t1
	where dt= '20250531'
	and  ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )    OR nvl(t1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
	AND     t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) --剔除信用卡
)ctr on a.cst_id=ctr.cst_id
left join edw.dws_hr_empe_inf_dd    t1 --员工汇总信息
on a.bfr_hdv_cst_magr_id=t1.empe_id
and t1.dt=a.dt
left join edw.dws_hr_empe_inf_dd    t2 --员工汇总信息
on a.aft_hdv_cst_magr_id=t2.empe_id
and t2.dt=a.dt
left join edw.dws_hr_empe_inf_dd    t3 --员工汇总信息
on a.sys_reg_psn=t3.empe_id
and t3.dt=a.dt
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd AS t4 --机构树_考核维度
ON  a.aft_hdv_mgr_org_no = t4.org_id
AND t4.dt = a.dt
and t4.brc_org_nm regexp '汝南'
left JOIN    edw.dim_hr_org_mng_org_tree_dd AS t5 --机构树_考核维度
ON  a.bfr_hdv_mgr_org_no = t5.org_id
AND t5.dt = a.dt
WHERE a.dt = '20250531'
and a.del_ind='0'	--	删除标识
AND REPLACE(a.sys_reg_tm, '-', '') >= '20250101'
AND REPLACE(a.sys_reg_tm, '-', '') <= '20250531'
AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
AND a.hdv_typ = '1'
and a.bfr_hdv_cst_magr_id<>a.aft_hdv_cst_magr_id
;
-- 交接前3个月贷款月日均
DROP   TABLE IF     EXISTS SJXQ_SJ20250605136_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250605136_CST_02 AS
select t1.cst_id
    ,t1.HDV_DT
    ,sum(coalesce(t3.last_90_days_prcp_bal_acml,0))/90 as last_90_days_prcp_bal_avg_bfr
from (
    SELECT DISTINCT cst_id,HDV_DT
    from SJXQ_SJ20250605136_CST_01
)t1 left join edw.dim_bus_loan_ctr_bse_inf_dd   t2
on t1.cst_id = t2.cst_id
and t2.dt = '20250531'
AND     ( t2.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t2.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
AND     t2.PRD_NO NOT IN ( '2002010101001' , '2002010101901' )--剔除信用卡
left join edw.dws_bus_loan_dbil_acm_inf_dd  t3
on t2.ctr_serno = t3.bus_ctr_id
and t3.dt = t1.HDV_DT
and t3.dt between '20250101' and '20250531'
group by t1.cst_id
    ,t1.HDV_DT
;
-- 分行维度
DROP   TABLE IF     EXISTS SJXQ_SJ20250605136_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250605136_CST_03 AS
SELECT  t1.cst_id                     AS 客户号
    ,t4.cst_chn_nm                    AS 客户名称
    ,t1.HDV_DT                        AS 交接日期
    ,t3.last_90_days_prcp_bal_avg_bfr AS 交接前3个月贷款日均
    ,t1.bfr_hdv_cst_magr_id           AS 移交前客户经理工号
    ,t1.移交前客户经理
    ,t1.移交前管户机构
    ,t1.aft_hdv_cst_magr_id           AS 移交后客户经理工号
    ,t1.移交后客户经理
    ,t1.移交后管户机构
    ,case when t2.cust_id is not null then '小鱼管家' else '信贷系统' end as 交接途径
    ,t1.系统登记人
FROM  SJXQ_SJ20250605136_CST_01     t1
LEFT JOIN (
    SELECT distinct cust_id
        ,substr(REPLACE(b.create_times, '-', ''), 1, 6) as hdv_mon
    from edw.xwdt_xw_cust_inven_data_record AS b
    where b.dt = '20250531'
    AND     b.credit_business = 'Y'  -- 信贷业务
    AND     REPLACE(substr(b.create_times, 1, 10), '-', '') >= '20250101'
    AND     REPLACE(substr(b.create_times, 1, 10), '-', '') <= '20250531'
    AND     b.STATUS = '01' --移交状态(00/待移交;01/已移交;02/移交失败(可再次移交);03/已作废(可被再次其他用户发起交接))
)t2 ON t1.cst_id =t2.cust_id
AND     substr(t1.HDV_DT, 1, 6) = t2.hdv_mon
left join SJXQ_SJ20250605136_CST_02 as t3
on t1.cst_id=t3.cst_id
and t1.HDV_DT = t3.HDV_DT
left join edw.dws_cst_bas_inf_dd t4
on t1.cst_id=t4.cst_id
and t4.dt='20250531'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,hdv_dt) custs
from SJXQ_SJ20250605136_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,hdv_dt) custs
from SJXQ_SJ20250605136_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号,交接日期) custs
from SJXQ_SJ20250605136_CST_03
;
/*
01	779	774
02	774	774
03	779	774
*/
SElECT '03' seq, *
from SJXQ_SJ20250605136_CST_03
;
***刘源_SJ20250618116_随贷通日均.sql
-- 刘源_SJ20250618116_随贷通日均
-- 截止6.18，汝南村行随贷通卡自办理以来的用信日均
DROP   TABLE IF     EXISTS SJXQ_SJ20250618116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250618116_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t2.pd_nm
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM regexp '随贷通'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '汝南'
where t1.dt='20250618'
;
select '随贷通授信额度信息' as tbl_nm
	,count(1) cnt
	,count(distinct lmt_id) as 额度编号
	,count(distinct bus_ctr_id) as 业务合同编号
	,count(distinct cst_id) as 客户号
from edw.dwd_bus_loan_fnc_crd_lmt_inf_dd --随贷通授信额度信息
where dt='20250430';
--自办理以来用信日均
DROP   TABLE IF     EXISTS SJXQ_SJ20250618116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250618116_CST_02 AS
SELECT  t1.ctr_serno 									--合同流水号|c32
       ,SUM(t1.amt)               AS fk_amt             --金额|decimal(21,2)
       ,MIN(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt     --出账起始日期|c8
       ,MAX(t1.exec_mtu_dt)       AS exec_mtu_dt        --执行到期日|c8
       ,SUM(t1.prcp_bal)          AS prcp_bal           --本金余额 = 正常余额+逾期金额+呆滞余额+呆账余额
       ,SUM(t1.norm_bal)          AS norm_bal           --正常余额|decimal(22,2)
       ,SUM(t1.ovd_amt)           AS ovd_amt            --逾期金额|decimal(21,2)
       ,SUM(t1.dull_bal)          AS dull_bal           --呆滞余额|decimal(22,2)
       ,SUM(t1.stgn_dbt_bal)      AS stgn_dbt_bal       --呆账余额|decimal(21,2)
       ,SUM(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal  --表内欠息余额|decimal(21,2)
       ,SUM(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal  --表外欠息余额|decimal(21,2)
       ,MAX(t1.tmt_dt)            AS tmt_dt             --终结日期|c8
       ,MAX(t1.prcp_pyf_dt)       AS prcp_pyf_dt        --本金结清日期|c8
       ,MAX(t1.pyf_ind)           AS pyf_ind            --结清标志
       ,COUNT(distinct dbil_id)   AS dbil_cnt
from edw.dim_bus_loan_dbil_inf_dd       t1
inner join SJXQ_SJ20241112121_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt='20240930'
GROUP BY t1.ctr_serno
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250618116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250618116_CST_03 AS
客户号  客户姓名   合同流水号   合同金额   绑定金额     自办理以来用信日均     管户人   管户机构
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250618116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250618116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250618116_CST_03
;
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250618116_CST_03
;
***刘源_SJ2025071526_信贷调查记录监测.sql
-- 刘源_SJ2025071526_信贷调查记录监测
DROP   TABLE IF     EXISTS SJXQ_SJ2025071526_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071526_CST_01 AS
SELECT  t1.svy_rcd_serno         AS 调查记录流水号
       ,t1.cst_id                AS 客户号
       ,t1.cst_nm                AS 客户名称
       ,t1.svy_dt                AS 调查日期
       ,t1.svy_mod_cd            AS 调查方式代码
       ,c1.cd_val_dscr           AS 调查方式 --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
       ,t1.pcp_mnl_no            AS 参与人工号
       ,t1.pcp_psn_nm            AS 参与人姓名
       ,t1.lct_mid_grd_audt_rslt AS 定位中台审核结果
       ,t1.pht_mid_grd_audt_rslt AS 照片中台审核结果
       ,t1.sys_reg_tm            AS 系统登记时间
       ,t1.sys_reg_org_id        AS 系统登记机构编号
       ,t4.org_nm                AS 系统登记机构
       ,t1.sys_reg_psn_id        AS 系统登记人编号
       ,t3.empe_nm               AS 系统登记人
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
left join edw.dws_hr_empe_inf_dd      t3 --员工信息汇总
on  t1.sys_reg_psn_id=t3.empe_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
on  t1.sys_reg_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '汝南'
where t1.dt='20250714'
and t1.svy_dt>='20250401'
;
SElECT '01' seq, count(1) cnt,count(distinct 调查记录流水号) custs
from SJXQ_SJ2025071526_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ2025071526_CST_01
***刘源_SJ20250721116_他行贷款信息.sql
﻿-- 刘源_SJ20250721116_他行贷款信息
-- 截至6月30日，河南汝南村行授信客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250721116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250721116_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as 管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.org_nm          as 管户机构
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '汝南'
where t1.dt='20250630'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 新征信表-个人
DROP   TABLE IF     EXISTS SJXQ_SJ20250721116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250721116_CST_02 AS
SELECT t1.cst_id
    ,t1.report_no                       --报告编号
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as report_dt --报告日期
    ,t1.oth_bank_busi_org_num	        --他行授信机构数(不含未激活)
    ,t1.oth_bank_credit_total_amt	    --他行授信总余额(不含未激活)
    ,t1.oth_bank_loan_org_num	        --他行贷款授信机构数
    ,t1.oth_bank_loan_credit_bal	    --他行贷款授信余额
    ,t1.curr_unsett_fyh_loan_org_num    --当前未结清非银行贷款机构数
    ,t1.curr_unsett_fyh_loan_bal        --当前未结清非银行贷款余额
    ,t2.他行贷款授信机构数
    ,t2.他行贷款有余额机构数
    ,t2.他行贷款余额
    ,t2.他行非银贷款授信机构数
    ,t2.他行非银贷款有余额机构数
    ,t2.他行非银贷款余额
    ,t2.他行贷款逾期机构数
    ,t2.他行贷款逾期金额
    ,t2.他行信用卡逾期机构数
    ,t2.他行信用卡逾期金额
    ,t2.他行非正常贷款家数
    ,t2.他行非正常贷款余额
    ,t3.他行月利率
from edw.dws_cst_ccrc_idv_ind_inf_dd t1
left join(
--他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
SELECT  report_id
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org end)                                                       AS 他行贷款授信机构数
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND ctr_bal > 0 THEN dtrb_org end)                                       AS 他行贷款有余额机构数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ctr_bal else 0 end)                                                            AS 他行贷款余额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND ovd_amt > 0 THEN dtrb_org end)                                       AS 他行贷款逾期机构数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_amt else 0 end)                                                            AS 他行贷款逾期金额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'R2','R3' ) AND ovd_amt > 0 THEN dtrb_org end)                                              AS 他行信用卡逾期机构数
       ,SUM(case WHEN act_typ_cd IN ( 'R2','R3' ) THEN ovd_amt else 0 end)                                                                   AS 他行信用卡逾期金额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN dtrb_org end)                                AS 他行非正常贷款家数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN ctr_bal else 0 end)                                     AS 他行非正常贷款余额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd
    where  dt = '20250630'
	and dtrb_org <> 'ZJTLCB'                   --他行
    group by report_id
)t2 on t1.report_no=t2.report_id
left join(
    select t1.crd_rpt_id	            --	信用报告id|c32
    from   edw.dim_cst_ccrc_idv_dbt_act_rat_dd      t1
    where t1.dt = '20250630'
    and t1.intr_rat is not null and t1.intr_rat<>-9999
    GROUP by t1.crd_rpt_id
)t3 on t1.report_no=t3.crd_rpt_id
where t1.dt='20250630'
and t1.report_dsc_rn=1
;
-- 新征信表-企业
DROP   TABLE IF     EXISTS SJXQ_SJ20250721116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250721116_CST_03 AS
SELECT  t1.cst_id
    ,t1.report_no                   --报告编号
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as report_dt --报告日期
    ,t1.oth_bank_busi_org_num	    --他行授信机构数
    ,t1.un_sett_loan_total_amt      --未结清贷款总额
    ,t2.他行贷款授信机构数
    ,t2.他行贷款有余额机构数
    ,t2.他行贷款余额
    ,t2.他行非银贷款授信机构数
    ,t2.他行非银贷款有余额机构数
    ,t2.他行非银贷款余额
    ,t2.他行贷款逾期机构数
    ,t2.他行贷款逾期金额
    ,t2.他行信用卡逾期机构数
    ,t2.他行信用卡逾期金额
    ,t2.他行非正常贷款家数
    ,t2.他行非正常贷款余额
    ,t3.他行月利率
from edw.dws_cst_ccrc_entp_ind_inf_dd   t1
inner join(
    --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
    SELECT  report_id
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org_cd end)                                                       AS 他行贷款授信机构数
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND loan_bal > 0 THEN dtrb_org_cd end)                                       AS 他行贷款有余额机构数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN loan_bal else 0 end)                                                            AS 他行贷款余额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND ovd_tot_amt > 0 THEN dtrb_org_cd end)                                       AS 他行贷款逾期机构数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_tot_amt else 0 end)                                                            AS 他行贷款逾期金额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'R2','R3' ) AND ovd_tot_amt > 0 THEN dtrb_org_cd end)                                              AS 他行信用卡逾期机构数
        ,SUM(case WHEN act_typ IN ( 'R2','R3' ) THEN ovd_tot_amt else 0 end)                                                                   AS 他行信用卡逾期金额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN dtrb_org_cd end)                                AS 他行非正常贷款家数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN loan_bal else 0 end)                                     AS 他行非正常贷款余额
    from   edw.dim_cst_ccrc_entp_loan_inf_dd a
    where  a.dt = '20250630'
    and    a.dtrb_org_typ_cd <> '00'  ---- 剔除泰隆银行
    group by report_id
)t2 on t1.report_no=t2.report_id
left join(
    --征信企业借贷账户利率计算
    select rpt_no
    from edw.dwd_cst_ccrc_entp_dc_act_intr_rat_clc_dd t2
    WHERE t2.dt = '20250630'
    and     t2.mon_intr_rat is not null
    and     t2.mon_intr_rat <> '-9999'
    group by rpt_no
)t3 on t1.report_no = t3.rpt_no
where t1.dt='20250630'
and t1.report_dsc_rn=1
and not exists(
    select 1
    from SJXQ_SJ20250721116_CST_02 t3
    WHERE t1.cst_id=t3.cst_id
)
;
-- 截至6月30日，河南汝南村行授信客户的所有担保人
DROP   TABLE IF     EXISTS SJXQ_SJ20250721116_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250721116_CST_04 AS
SElECT t1.cst_id,t1.cst_nm,t1.CTR_SERNO
    ,t1.管户人
    ,t1.管户机构
    ,t2.GRNT_CTR_NO
    ,t2.grnt_ctr_typ_cd	    --担保合同类型代码|c3
    ,t3.gtor_no                                  --保证人编号|c20
    ,t3.gtor_nm                                  --保证人名称|c200
    ,t3.with_brwr_rel                            --与借款人关系|c3
    ,c1.cd_val_dscr     as 与借款人关系
    ,t3.eff_sts_cd                               --生效状态代码 0:待生效 1:已生效 2:已失效
	,t4.ln_mgr_nm                                --信贷归属客户经理名称
	,t4.ln_org_nm                                --信贷归属机构名称
from SJXQ_SJ20250721116_CST_01               t1
INNER JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.CTR_SERNO = t2.CTR_SERNO
and t2.dt='20250630'
and t2.BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
INNER JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd   t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='20250630'
LEFT JOIN    edw.dwd_code_library_dd        c1
ON      t3.WITH_BRWR_REL = c1.cd_val
AND     c1.dt = '20250630'
left join adm_pub.adm_csm_cbas_mng_inf_dd   t4 --客户集市-客户基础-客户管户信息
on  t3.gtor_no = t4.cst_id
and t4.dt = '20250630'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20250721116_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250721116_CST_05 AS
SELECT  t1.cst_id as 客户号
       ,t1.cst_nm as 客户名称
       ,t2.report_dt as 征信日期
       ,t2.他行贷款授信机构数
       ,t2.他行贷款授信余额
       ,t2.当前未结清非银行贷款机构数
       ,t2.当前未结清非银行贷款余额
       ,t2.他行月利率
       ,t1.管户人
       ,t1.管户机构
from(
    select distinct cst_id,cst_nm,管户人,管户机构
    from SJXQ_SJ20250721116_CST_01
)t1 left join(
    select cst_id,report_dt
        ,t1.oth_bank_loan_org_num	        as 他行贷款授信机构数
        ,t1.oth_bank_loan_credit_bal	    as 他行贷款授信余额
        ,t1.curr_unsett_fyh_loan_org_num    as 当前未结清非银行贷款机构数
        ,t1.curr_unsett_fyh_loan_bal        as 当前未结清非银行贷款余额
        ,t1.他行月利率
    from SJXQ_SJ20250721116_CST_02 t1
    union all
    select cst_id,report_dt
        ,t1.oth_bank_busi_org_num
        ,t1.他行贷款余额
        ,t1.他行非银贷款有余额机构数
        ,t1.他行非银贷款余额
        ,t1.他行月利率
    from SJXQ_SJ20250721116_CST_03 t1
)t2 on t1.cst_id=t2.cst_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20250721116_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250721116_CST_06 AS
SELECT  t1.gtor_no   AS 担保人编号
       ,t1.gtor_nm   AS 担保人名称
       ,t2.report_dt AS 征信日期
       ,t2.他行贷款授信机构数
       ,t2.他行贷款授信余额
       ,t2.当前未结清非银行贷款机构数
       ,t2.当前未结清非银行贷款余额
       ,t2.他行月利率
       ,t3.age       AS 担保人年龄
       ,t1.与借款人关系
       ,t1.cst_id    AS 借款人客户号
       ,t1.cst_nm    AS 借款人名称
       ,t1.管户人       AS 借款人管户人
       ,t1.管户机构      AS 借款人管户机构
       ,t1.ln_mgr_nm AS 担保人信贷归属客户经理名称
       ,t1.ln_org_nm AS 担保人信贷归属机构名称
from(
    SELECT DISTINCT gtor_no --担保人编号
        ,gtor_nm --担保人名称
        ,与借款人关系
        ,cst_id --借款人客户号
        ,cst_nm --借款人名称
        ,管户人
        ,管户机构
        ,ln_mgr_nm --担保人信贷归属客户经理名称
        ,ln_org_nm --担保人信贷归属机构名称
    from SJXQ_SJ20250721116_CST_04
)t1 left join(
    select cst_id,report_dt
        ,t1.oth_bank_loan_org_num	        as 他行贷款授信机构数
        ,t1.oth_bank_loan_credit_bal	    as 他行贷款授信余额
        ,t1.curr_unsett_fyh_loan_org_num    as 当前未结清非银行贷款机构数
        ,t1.curr_unsett_fyh_loan_bal        as 当前未结清非银行贷款余额
        ,t1.他行月利率
    from SJXQ_SJ20250721116_CST_02 t1
    union all
    select cst_id,report_dt
        ,t1.oth_bank_busi_org_num
        ,t1.他行贷款余额
        ,t1.他行非银贷款有余额机构数
        ,t1.他行非银贷款余额
        ,t1.他行月利率
    from SJXQ_SJ20250721116_CST_03 t1
)t2 on t1.gtor_no=t2.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t3 --客户集市-客户基础-对私客户基础信息
on t1.gtor_no=t3.cst_id
and t3.dt='20250630'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250721116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250721116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250721116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250721116_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250721116_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 担保人编号) custs
from SJXQ_SJ20250721116_CST_06
;
/*
01	6163	5116
02	5877775	5877775
03	242133	242133
04	4469	2377
05	5116	5116
06	3493	3232
*/
SElECT '05' seq, *
from SJXQ_SJ20250721116_CST_05
;
SElECT '06' seq, *
from SJXQ_SJ20250721116_CST_06
;
***刘源_SJ2025072201_汝南交接客户面访情况.sql
﻿-- 刘源_SJ2025072201_汝南交接客户面访情况
-- 截止目前，汝南村行2025年全量交接客户的面访等情况。
--管户交接记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025072201_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072201_CST_01 AS
select distinct t1.aply_serno                               --申请流水号|c32
	,t1.cst_id                                   --客户号|c20
	,t1.bfr_hdv_cst_magr_id                      --移交前客户经理工号|c10
    ,t6.empe_nm     as 移交前客户经理
	,t1.bfr_hdv_mgr_org_no                       --移交前管户机构编号|c12
    ,t7.org_nm      as 移交前管户机构
	,t1.aft_hdv_cst_magr_id                      --移交后客户经理工号|c10
    ,t8.empe_nm     as 移交后客户经理
	,t1.aft_hdv_mgr_org_no                       --移交后管户机构编号|c12
	,t1.hdv_typ_cd                               --移交类型代码|c1
	,t1.dlve_mod_cd                              --移交方式代码|c1
	,t1.aply_dt                                  --申请日期|c8
	,t1.sys_reg_tm                               --系统登记时间|c26
    ,t1.sys_reg_psn_id	    --系统登记人id|c20
    ,t9.empe_nm     as 系统登记人
	,case when t1.aply_dt='18991231' then SUBSTR(REPLACE(t1.sys_reg_tm,'-',''),1,8) else t1.aply_dt end as jj_dt
	,case when t2.cust_id is not null then '是' else '否' end as is_xygj_jj
	,t4.brc_org_nm,t4.sbr_org_nm
    ,t4.org_nm as 移交后管户机构
	,case when t5.cst_id is not null  then '是' else '否' end as is_loan_bus -- 信贷业务
from edw.dwd_cst_mng_loan_mng_hdv_rcd_dd  		t1    --管户交接记录
LEFT JOIN edw.xwdt_xw_cust_inven_data_record 	t2
ON t1.cst_id = t2.cust_id
AND substr(REPLACE(t1.sys_reg_tm, '-', ''), 1, 6) = REPLACE(substr(t2.create_times, 1, 7), '-', '')
AND t2.dt = t1.dt
and t2.credit_business='Y'
AND REPLACE(substr(t2.create_times, 1, 10), '-', '') between '20250101' and '20250722'
AND t2.STATUS = '01' --移交状态(00/待移交;01/已移交;02/移交失败(可再次移交);03/已作废(可被再次其他用户发起交接))
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t1.aft_hdv_mgr_org_no = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '汝南'
left join(
	SELECT  distinct cst_id
	FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1
	WHERE dt = '20250722'
	AND ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' ) OR nvl(t1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
	AND t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) --剔除信用卡
)t5 ON t1.cst_id = t5.cst_id
left join edw.dws_hr_empe_inf_dd            t6 --员工信息汇总
on  t1.bfr_hdv_cst_magr_id=t6.empe_id
and t6.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t7 --考核机构树
on  t1.bfr_hdv_mgr_org_no=t7.org_id
and t7.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t8 --员工信息汇总
on  t1.aft_hdv_cst_magr_id=t8.empe_id
and t8.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t9 --员工信息汇总
on  t1.sys_reg_psn_id=t9.empe_id
and t9.dt=t1.dt
where t1.dt='20250722'
and t1.bfr_hdv_cst_magr_id<>t1.aft_hdv_cst_magr_id
and case when t1.aply_dt='18991231' then SUBSTR(REPLACE(t1.sys_reg_tm,'-',''),1,8)
	else t1.aply_dt end between '20250101' and '20250722' 	--交接日期
;
-- 客户面访时间
DROP   TABLE IF     EXISTS SJXQ_SJ2025072201_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072201_CST_02 AS
SELECT  t1.CST_ID              --客户号
       ,t3.aft_hdv_cst_magr_id --客户经理
       ,SUBSTR(REPLACE(t1.srv_tm, '-', ''), 1, 8) as face_vst_dt  --实际访客时间
FROM edw.xwdt_xw_cst_vst_dtl_di         t1 --客户走访明细表
INNER JOIN edw.xwdt_xw_activity_info    t2 --面访表
ON t2.bus_seq_id = t1.bus_seq_id
AND t2.DT = '20250722'
AND t2.srv_type = '01' --拜访
inner join(
    select distinct cst_id,aft_hdv_cst_magr_id
        ,移交后客户经理
    from SJXQ_SJ2025072201_CST_01
)t3 on t1.cst_id=t3.cst_id
and t1.CREATE_EMP=t3.aft_hdv_cst_magr_id
WHERE t1.DT = '20250722'
AND SUBSTR(REPLACE(t1.srv_tm, '-', ''), 1, 8) >= '20250101' --实际访客时间
AND SUBSTR(REPLACE(t1.srv_tm, '-', ''), 1, 8) <= '20250722'
;
-- 交接前3月日均 近3月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2025072201_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072201_CST_03 AS
SELECT  t1.cst_id
       ,t1.jj_dt
       ,t2.loan_bal_90_avg         AS 交接日近90天贷款余额日均
       ,t3.dep_bal_90_avg          AS 交接日近90天存款余额日均
       ,t4.last_90_ftp_bus_inc_avg AS 交接日近90天FTP营业收入日均
       ,t5.loan_bal_90_avg         AS 当前近90天贷款余额日均
       ,t6.dep_bal_90_avg          AS 当前近90天存款余额日均
       ,t7.last_90_ftp_bus_inc_avg AS 当前近90天FTP营业收入日均
from(
    select distinct cst_id,jj_dt
    from SJXQ_SJ2025072201_CST_01
)t1 left join adm_pub.adm_csm_cbus_loan_inf_dd t2 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t2.cst_id
and t2.dt=t1.jj_dt
and t2.dt>='20250101'
left join adm_pub.adm_csm_cbus_dep_inf_dd   t3 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt=t1.jj_dt
and t3.dt>='20250101'
left join adm_pub.adm_csm_cbus_ftp_inf_dd   t4 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t4.cst_id
and t4.dt=t1.jj_dt
and t4.dt>='20250101'
left join adm_pub.adm_csm_cbus_loan_inf_dd  t5 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250722'
left join adm_pub.adm_csm_cbus_dep_inf_dd   t6 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t6.cst_id
and t6.dt='20250722'
left join adm_pub.adm_csm_cbus_ftp_inf_dd   t7 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t7.cst_id
and t7.dt='20250722'
;
-- 结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025072201_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072201_CST_04 AS
SELECT  t1.cst_id      AS 客户号
       ,t5.cst_chn_nm  AS 客户名称
       ,t1.jj_dt       AS 交接日期
       ,t1.移交前客户经理
       ,t1.移交前管户机构
       ,t1.移交后客户经理
       ,t1.移交后管户机构
       ,t2.face_vst_dt AS 接收人面访日期
       ,t1.is_xygj_jj  AS 是否通过小鱼管家交接
       ,t1.is_loan_bus AS 是否信贷客户
       ,t1.系统登记人
       ,t3.交接日近90天贷款余额日均
       ,t3.交接日近90天存款余额日均
       ,t3.交接日近90天FTP营业收入日均
       ,t3.当前近90天贷款余额日均
       ,t3.当前近90天存款余额日均
       ,t3.当前近90天FTP营业收入日均
from SJXQ_SJ2025072201_CST_01       t1
left join (
    select CST_ID,aft_hdv_cst_magr_id
    from SJXQ_SJ2025072201_CST_02
    group by CST_ID,aft_hdv_cst_magr_id
)t2 on t1.cst_id=t2.cst_id
and t1.aft_hdv_cst_magr_id=t2.aft_hdv_cst_magr_id
left join SJXQ_SJ2025072201_CST_03 t3
on t1.cst_id=t3.cst_id
and t1.jj_dt=t3.jj_dt
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20250722'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,jj_dt) custs
from SJXQ_SJ2025072201_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,aft_hdv_cst_magr_id) custs
from SJXQ_SJ2025072201_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,jj_dt) custs
from SJXQ_SJ2025072201_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072201_CST_04
;
/*
01	3346	3337
02	173	131
04	3346	3145
*/
SElECT '04' seq, *
from SJXQ_SJ2025072201_CST_04
;
***刘璐_SJ2025012151_宁波分行信用卡数据.sql
﻿/*
app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd
app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd
*/
-- 信用卡申请清单更新 --
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_01 as
SELECT  COALESCE(T1.CST_ID, T4.CST_ID) CST_ID
    ,COALESCE(T1.CST_NM, T4.CST_NM) CST_NM
    ,COALESCE(T2.RFER_ID, T6.QR_CODE_RFER_ID) RFER_ID --推荐人/二维码推荐人
    ,COALESCE(T2.RFER_ORG_ID, T6.RFER_ORG_ID) RFER_ORG_ID --推荐人机构
    ,t1.PRD_NO
	,t1.acpt_sts_cd
	,c1.cd_val_dscr 	as acpt_sts_nm
    ,COALESCE(T2.APLY_DT, T4.APL_DT) APLY_DT --申请日期
    ,COALESCE(T2.APLY_CHNL_CD, T4.APL_CHNL_CD) APLY_CHNL_CD --申请渠道代码
    ,COALESCE(T1.APLY_ACPT_TYP_CD, T6.APLY_ACPT_TYP_CD) APLY_ACPT_TYP_CD --受理类型   --01：线上进件，02：续卡续贷，03：商机线索
    ,COALESCE(T1.SYS_REG_ORG_ID, T4.SYS_REG_ORG_ID) SYS_REG_ORG_ID --系统操作机构
    ,COALESCE(T1.SYS_REG_PSN, T4.SYS_REG_PSN_ID) SYS_REG_PSN_ID --系统操作人
    ,COALESCE(T1.SYS_REG_TM, T4.SYS_REG_TM) SYS_REG_TM --系统操作时间
    ,COALESCE(T3.AHN_LTR_APLY_SERNO, T4.AHN_LTR_APLY_SERNO) AHN_LTR_APLY_SERNO --授用信申请流水
    ,COALESCE(T3.USC_APLY_SERNO, T4.USC_APLY_SERNO) USC_APLY_SERNO --用信申请流水
    ,NVL(T4.ONL_IND, '1') ONL_IND --线上标识  --1：线上，0：线下
    ,T4.BSN_APRV_MOD_CD --机批人批标识 --1：机批，2：人批
    ,T2.PRE_FACL_IND --预授信标识 --1：预授信
    ,T4.LATE_UPD_PSN_ID --最后操作人
    ,T4.LATE_UPD_ORG_ID --最后操作机构
    ,T6.CTR_EFF_DT --合同生效日期
    ,T6.MGR_ID --业务管户人工号
    ,T6.MGR_ORG_ID --业务管户机构号
    ,t6.ctr_serno
    ,case when ((t2.PRE_FACL_IND = '1' AND COALESCE(T1.SYS_REG_ORG_ID, T4.SYS_REG_ORG_ID) NOT LIKE '99%')
        OR (NVL(T4.ONL_IND, '1') = '1' AND t4.BSN_APRV_MOD_CD = '2') OR NVL(T4.ONL_IND, '1') = '0') then 1 else 0 end is_strong
FROM(
    SELECT  APLY_ACPT_NO
        ,CST_ID
        ,CST_NM
        ,APLY_ACPT_TYP_CD
        ,SYS_REG_ORG_ID
        ,SYS_REG_PSN
        ,SYS_REG_TM
        ,acpt_sts_cd	--	受理状态代码 进件状态
        ,PRD_NO
    FROM    edw.dwd_bus_loan_aply_acpt_inf_dd	--申请受理信息
    WHERE   DT = '20241231'
    AND     PRD_NO ='2002010101001'  --申请产品为信用卡
) T1 --申请受理表，--无线下申请信息，有续卡申请
LEFT JOIN    EDW.DWD_BUS_LOAN_APLY_ACPT_ONL_DD T2 --线上申请受理表
ON      T2.APLY_ACPT_NO = T1.APLY_ACPT_NO
AND     T2.DT = '20241231'
LEFT JOIN    EDW.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD T3 --受理与授用信申请关系
ON      T3.APLY_ACPT_NO = T1.APLY_ACPT_NO
AND     T3.DT = '20241231'
FULL OUTER JOIN    (
    SELECT  CST_ID
            ,CST_NM
            ,APL_DT
            ,APL_CHNL_CD
            ,SYS_REG_ORG_ID
            ,SYS_REG_PSN_ID
            ,SYS_REG_TM
            ,AHN_LTR_APLY_SERNO
            ,USC_APLY_SERNO
            ,ONL_IND
            ,BSN_APRV_MOD_CD
            ,LATE_UPD_PSN_ID
            ,LATE_UPD_ORG_ID
    FROM    edw.dwd_bus_loan_lmt_aply_biz_dd
    WHERE   DT = '20241231'
    AND     PRD_NO ='2002010101001' --申请产品为信用卡
) T4 --用信方案，这里能找到线下的已完结的申请，无法区分是否续卡申请
ON      T4.USC_APLY_SERNO = T3.USC_APLY_SERNO
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD T6 --合同基本信息表
ON      T6.DT = '20241231'
AND     T6.REL_SERNO = T4.USC_APLY_SERNO
left join edw.dwd_code_library_dd 		c1
on t1.acpt_sts_cd = c1.cd_val
and c1.dt = '20241231'
where COALESCE(T1.APLY_ACPT_TYP_CD, T6.APLY_ACPT_TYP_CD) <> '02'
;
-- 信用卡账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_02 as
select t1.acg_dt                                 --会计日期
	,t1.cst_id                                   --客户编号
	,t1.cst_nm                                   --客户名称
	,t1.cr_crd_card_nbr                          --信用卡卡号
	,t1.cr_crd_act_id                            --信用卡账号
	,t1.acs_org_id                               --信用卡考核机构
	,t1.acs_org_nm                               --信用卡考核机构名称
	,t1.cr_crd_brc_org_id                        --信用卡业务管户分行号
	,t1.cr_crd_brc_org_nm                        --信用卡业务管户分行名称
	,t1.cr_crd_sbr_org_id                        --信用卡业务管户支行号
	,t1.cr_crd_sbr_org_nm                        --信用卡业务管户支行名称
	,t1.cr_crd_org_id                            --信用卡业务管户机构号
	,t1.cr_crd_org_nm                            --信用卡业务管户机构名称
	,t1.cr_crd_mgr_id                            --信用卡业务管户人工号
	,t1.cr_crd_mgr_nm                            --信用卡业务管户人名称
	,t1.applytype                                --申请渠道
	,t1.apl_chnl                                 --进件渠道
	,t1.apl_chnl_ctg                             --进件渠道大类
	,t1.market_no                                --二维码推荐人
	,t5.empe_nm 	as market_nm
	,t7.pos_nm 		as 二维码推荐人职位名称
	,t9.pos_nm		as 开户时二维码推荐人职位名称
	,t1.market_type                              --二维码推荐性质
	,case when t1.market_type='A02' then '微信银行'
		when t1.market_type='A06' then '网页 '
		when t1.market_type='B01' then '支付宝获客'
		when t1.market_type='B04' then '京东进件'
		when t1.market_type='B06' then '网络投融资平台流入'
		when t1.market_type='C01' then '社区'
		when t1.market_type='C04' then '客户经理营销-其他' else t1.market_type end as market_type_nm
	,t1.busi_ctr_id                              --业务合同编号
	,t1.cr_crd_apl_srl_nbr                       --业务申请编号
	,t1.main_crd_ind                             --主卡标志
	,t1.main_crd_nm                              --主卡标志码值
	,t1.cr_crd_pd_id                             --信用卡产品编号
	,t1.cr_crd_pd_cmt                            --信用卡产品名称
	,t1.cd_val_dscr                              --卡状态
	,t1.card_sts_cd                              --卡状态码值
	,t1.opn_dt                                   --账户开户日期
	,t1.off_lin_tra_id_cd	--	线上转线下标识
	,c1.cd_val_dscr 	as off_lin_tra_id_nm
	,t1.auto_aprv_ind		--	自动审批标识
	,t1.rsnd_dt			--续卡日期
	,case when t1.rsnd_dt>=t1.opn_dt then t1.rsnd_dt else t1.opn_dt end as zhunru_dt
	,t2.crd_lmt                                  --信用额度
	,t2.late_bil_amt                             --上期帐单金额
	,t2.last_bil_csm_bal                         --上期帐单的消费余额
	,t2.last_bil_intr_bal                        --上期帐单的利息余额
	,t2.last_bil_cb_bal                          --上期帐单的预借现金余额
	,t2.last_bil_instl_bal                       --上期帐单分期余额
	,t2.wthr_paid_lo_rpay                        --是否已还最低还款
	,t2.ful_rpay_ind                             --已全额还款标志
	,t2.last_rpay_dt                             --上次还款日期
	,t2.bal                                      --信用卡余额
	,t2.ovdr_bal                                 --透支本金含分期付款余额
	,t2.csh_bal                                  --取现本金
	,t2.csm_bal                                  --消费本金(含分期摊销)
	,t2.xfbjbhfthx                               --消费本金(不含分期摊销)
	,t2.ovd_hi_trm                               --逾期期数
	,t2.ovd_amt                                  --逾期金额
    ,t2.acc_int_year_ajust	                      --账户年累计FTP营收
    ,t2.year_mid_bus_inc	                      --账户年累计信用卡中间业务收入（K）
    ,t2.year_acm_tot_inc	                      --年累计收入
    ,t2.acc_year_bus_inc	                      --账户年累计营收（K）
    ,CASE WHEN t1.OPN_DT <= '20240719' AND ( t1.APPLYTYPE NOT IN ( '小鱼bank渠道' , '金融云平台' ) OR t1.WHITE_SRC = '分支机构导入' OR t1.OFF_LIN_TRA_ID_CD = '1' OR ( t2.LMT_ADJ_DIR = '调高' AND t2.LMT_ADJ_SRC = '客户经理' ) ) THEN '强人工'
        --0719之后，新信贷逻辑
        WHEN t1.OPN_DT > '20240719' AND t3.is_strong=1 THEN '强人工'  ELSE '弱人工'
		END REG_TYPE --业务经办模式, S:强人工,W:弱人工
	,t3.acpt_sts_nm
	,t4.dlq_pnp_bal                              --分期付款余额
	,t4.pd_tp_cd                                 --信用卡种类
	,t4.pd_tp_nm                                 --信用卡种类码值
	,case when t6.ONL_IND='1' and t6.BSN_APRV_MOD_CD='1' then '线上机批'
		when t6.ONL_IND='1' and t6.BSN_APRV_MOD_CD = '2' then '线上转线下'
		else '线下' end aprv_way 	--进件状态
FROM    APP_ADO.ADM_SUBL_BUS_CRD_CR_CARD_SMY_INF_DD         t1
LEFT JOIN    APP_ADO.ADM_SUBL_BUS_CRD_CR_ACCT_SMY_INF_DD    t2 --信用卡账户信息汇总表
ON      t2.DT = '20241231'
AND     t1.CR_CRD_CARD_NBR = t2.LATE_MAIN_CARD_CARD_NBR
left join(
    SELECT USC_APLY_SERNO,acpt_sts_nm,max(is_strong) is_strong
    from SJXQ_SJ2025012151_CST_01
    GROUP BY USC_APLY_SERNO,acpt_sts_nm
) t3 ON t3.USC_APLY_SERNO = t1.CR_CRD_APL_SRL_NBR
left join app_ado.fct_cc_ar_dtl_smy_dd            t4  --自助取数-信用卡明细信息汇总表
on t1.cr_crd_card_nbr = t4.cr_crd_ar_id
and t4.dt='20241231'
left join edw.dws_hr_empe_inf_dd 	t5
on substr(t1.market_no,1,6)=t5.empe_id
and t5.dt='20241231'
left join edw.dwd_code_library_dd 	c1
on t1.off_lin_tra_id_cd = c1.cd_val
and c1.dt = '20241231'
left join edw.dwd_bus_loan_lmt_aply_biz_dd 	t6
on t1.CR_CRD_APL_SRL_NBR=t6.USC_APLY_SERNO
and t6.DT = '20241231'
left join edw.dim_hr_org_job_inf_dd 	t7
on t5.pos_enc=t7.POS_ID
and t7.dt='20241231'
left join edw.dws_hr_empe_inf_dd 	t8
on t5.empe_id=t8.empe_id
and t1.opn_dt=t8.dt
and t8.dt<='20241231'
left join edw.dim_hr_org_job_inf_dd 	t9
on t8.pos_enc=t9.POS_ID
and t9.dt='20241231'
WHERE   t1.DT='20241231'
and t1.cr_crd_brc_org_nm='宁波分行'
;
--纯信用卡户
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_03 as
SELECT  DISTINCT t1.cst_id
FROM SJXQ_SJ2025012151_CST_02        t1 --信用卡户
LEFT JOIN edw.dws_bus_dep_act_inf_dd t2 --存款账户信息汇总
ON  t1.cst_id = t2.cst_id
and t2.dt='20241231'
and nvl(t2.cst_act_id,'')<>''
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd t3 --信贷借据信息
ON      t1.cst_id = t3.cst_id
AND     t3.dt = '20241231'
WHERE   t2.cst_id IS NULL
AND     t3.cst_id IS NULL
;
-- 首次逾期日期
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_04 as
select t1.cr_crd_act_id			--信用卡账号
	,t2.cst_id
	,min(t1.ovd_dt) 	as ovd_dt	--逾期日期|C8
from edw.dwd_bus_crd_cr_crd_ovd_dtl_dd	t1 				--信用卡逾期明细
left join app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd t2 --信用卡账户信息汇总表
on t1.cr_crd_act_id=t2.cr_crd_act_id
and t2.dt='20241231'
where t1.dt = '20241231'
group by t1.cr_crd_act_id,t2.cst_id
;
-- 处置类精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_05 as
select distinct t1.cst_Id
from SJXQ_SJ2025012151_CST_04  t1
left join(
	SELECT  T1.cst_id       --客户号
			,T2.tsk_gen_dt  --最近一次触碰精准贷后_处置类时间
	FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
	INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
	ON      T1.btch_serno = T2.btch_serno
	AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
	AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
	AND     T2.DT = '20241231'
	WHERE   T1.DT = '20241231'
)t2 on t1.cst_Id=t2.cst_Id
and t1.ovd_dt>t2.tsk_gen_dt
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_06 as
select t1.cst_id
	,t2.rpt_id,t2.prd_dt,t2.cst_cr_grd_val
	,t3.report_no	--报告编号
	,t3.report_dt	--报告日期
	,t3.idv_crd_sco_val
	,t4.report_id
	,t4.digital_unscr
	,t5.age                                      --年龄
	,case when   t5.reg_adr_dtl_inf LIKE  '%省%'    then   CONCAT(substring_index(t5.reg_adr_dtl_inf, '省', 1),'省')
			WHEN  t5.reg_adr_dtl_inf LIKE  '%市%'    and    t5.reg_adr_dtl_inf  REGEXP '上海|重庆|天津|北京'  then CONCAT(substring_index(t5.reg_adr_dtl_inf, '市', 1),'市')
			WHEN  t5.reg_adr_dtl_inf REGEXP '内蒙古|广西|西藏|宁夏|新疆'    then   CONCAT(substr(t5.reg_adr_dtl_inf, 1,2),'自治区')
			WHEN  t5.reg_adr_dtl_inf REGEXP '内蒙古'    then   CONCAT(substr(t5.reg_adr_dtl_inf, 1,3),'自治区')
			WHEN  t5.reg_adr_dtl_inf LIKE  '%特别行政区%'    and    t5.reg_adr_dtl_inf REGEXP '香港|澳门'    then   CONCAT(substring_index(t5.reg_adr_dtl_inf, '特别行政区', 1),'特别行政区')
			when  t5.reg_adr_dtl_inf LIKE  '%杭州市%'    then   '浙江省'
			WHEN  t5.reg_adr_dtl_inf LIKE  '%武汉市%'    then   '湖北省'
			else  ''  end  AS   户籍省份
		,case when  t5.reg_adr_dtl_inf LIKE  '%市%'    then   CONCAT(substring_index(t5.reg_adr_dtl_inf, '市', 1),'市')
			WHEN  t5.reg_adr_dtl_inf LIKE  '%州%'    and    t5.reg_adr_dtl_inf not LIKE  '%贵州%'  then CONCAT(substring_index(t5.reg_adr_dtl_inf, '州', 1),'州')
			WHEN  t5.reg_adr_dtl_inf LIKE  '%县%'    and    t5.reg_adr_dtl_inf not LIKE  '%州%'    and    t5.reg_adr_dtl_inf not LIKE  '%市%'  then   CONCAT(substring_index(t5.reg_adr_dtl_inf, '县', 1),'县')
			else  ''  end  AS   户籍城市
	,SUBSTR(t5.DOC_NBR,1,6) 	as 身份证前6位
	,c3.cd_val_dscr 			as 身份证前6位省市
	,c4.cd_val_dscr 			as 户籍省
	,c5.cd_val_dscr 			as 户籍市
from(
	select distinct cst_id
	from SJXQ_SJ2025012151_CST_02
)t1 left join (
	SELECT  t.cst_id,rpt_id
		,t.prd_dt
		,t.cst_cr_grd_val
		,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
	FROM
	(
		SELECT  cst_id,rpt_id
			,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
			,cr_sco_val                          AS cst_cr_grd_val
		FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
		WHERE dt <= '20241231'
		UNION
		SELECT  cst_id,''
			,prd_dt
			,cst_cr_grd_val
		FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
		WHERE dt <= '20241231'
	) t
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
left join edw.dws_cst_ccrc_idv_ind_inf_dd t3 --个人征信指标信息表
on t1.cst_id=t3.cst_id
and t3.dt='20241231'
and t3.report_dsc_rn=1
left join (
	select cst_id,report_id
		,digital_unscr	--数字解读 征信分
		,row_number() over(partition by cst_id order by report_id desc) rn
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20241231'
)t4 on t1.cst_id=t4.cst_id
and t4.rn=1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t5 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t5.cst_id
and t5.dt='20241231'
left join EDW.DWD_CODE_LIBRARY_DD 		C3 -- 码值表
on SUBSTR(t5.DOC_NBR,1,6)=c3.cd_val
and  C3.DT = '20241231'
AND  C3.FLD_NM = 'CITY' --区县
AND  C3.TBL_NM = 'CUSTOMER_ADDRESS'
LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD    T6 --客户物理地址信息
ON T1.CST_ID = T6.CST_ID
AND T6.DT = '20241231'
AND T6.PHY_ADR_TYP_CD = '050100' --户籍地址
left join   edw.dwd_code_library_dd   c4 -- 码值表
ON      T6.pvc_lvl_id_cd = c4.cd_val
AND     c4.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND     c4.fld_nm =  'PVC_OR_MNCP_DTRCT_DVD_CD'   --省
AND     c4.dt = '@@{yyyyMMdd}'
left join   edw.dwd_code_library_dd   c5 -- 码值表
ON      T6.cty_lvl_id_cd = c5.cd_val
AND     c5.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND     c5.fld_nm =  'CTY_DTRCT_DVD_CD'   --市
AND     c5.dt = '@@{yyyyMMdd}'
;
-- 准入时征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_06_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_06_1 as
SELECT  t1.cst_id,t1.zhunru_dt
	,t2.prd_dt
	,t2.cst_cr_grd_val
	,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id,t1.zhunru_dt ORDER BY t2.prd_dt DESC ) AS rn
FROM(
	select distinct cst_id,zhunru_dt
	from SJXQ_SJ2025012151_CST_02
)t1 INNER JOIN(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20241231' and nvl(cr_sco_val,'')<>''
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20241231' and nvl(cst_cr_grd_val,'')<>''
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
	from edw.dws_cst_ccrc_idv_ind_inf_dd
	where dt='20241231' and nvl(idv_crd_sco_val,'')<>''
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20241231'
	and nvl(digital_unscr,'')<>''
) t2 on t1.cst_id=t2.cst_id
and t1.zhunru_dt >= t2.prd_dt
;
-- 准入时的高风险客户标签
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_06_2 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_06_2 as
SELECT  distinct t1.cst_id,t1.zhunru_dt
	,t2.modl_rsk_lyr_nm
FROM(
	select distinct cst_id,zhunru_dt
	from SJXQ_SJ2025012151_CST_02
)t1 INNER JOIN(
	SELECT cst_id,dt
		,DECODE(modl_rsk_lyr_cd,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') as modl_rsk_lyr_nm
		,ROW_NUMBER() over(partition by cst_id,dt order by rsk_lyr_afm_tm desc) rn 	--风险分层认定时间
	from edw.dim_cst_asst_rsk_lyr_dd
	where dt <= '20241231'
	and nvl(modl_rsk_lyr_cd,'')<>''
)t2 on t1.cst_id=t2.cst_id
and t1.zhunru_dt=t2.dt
;
--2024年有交易客户，确定首刷
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_07 as
select CR_CRD_ACT_ID,max(TRX_DT) max_trx_dt
from(
	select CR_CRD_ACT_ID,TRX_DT
	from edw.dwd_bus_crd_cr_crd_trx_dtl_di   t1     --信用卡客户交易流水
	where dt<='20241231'
	union
	select CR_CRD_ACT_ID,RCD_DT
	from edw.dwd_bus_crd_cr_crd_instl_dtl_dd      --信用卡分期明细
	where dt='20241231'
)t GROUP BY CR_CRD_ACT_ID
;
-- 发生过非全额还款
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_08 as
select distinct cr_crd_act_id
from APP_ADO.ADM_SUBL_BUS_CRD_CR_ACCT_SMY_INF_DD
where dt<='20241231'
and ful_rpay_ind='0'                             --已全额还款标志 0:否|1:是
;
-- 信贷管户
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_08_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_08_1 as
select t1.cst_id                                 --客户号|c20
	,t1.mgr_id                                   --管户人工号|c10
	,t3.empe_nm 	as loan_mgr_nm
	,t1.mgr_sts_cd                               --管户状态代码|c1
	,DECODE(t1.mgr_sts_cd,'1','临时','2','锁定') as mgr_sts_nm
	,t1.aply_dt                                  --申请日期|c8
	,t1.nvld_dt                                  --失效日期|c8
	,t1.mgr_org_id                               --管户机构号|c12
	,t4.org_nm
from edw.dim_cst_mng_loan_mgr_dd    t1          --信贷客户管户信息
INNER JOIN (
	SELECT DISTINCT cst_id
	from SJXQ_SJ2025012151_CST_02
)t2 on t1.cst_id=t2.cst_id
left join edw.dws_hr_empe_inf_dd 	t3
on t1.mgr_id=t3.empe_id
and t3.dt='20241231'
left join edw.dim_hr_org_mng_org_tree_dd 	t4 -- 机构树_考核维度
on t1.mgr_org_id=t4.org_id
and t4.dt='20241231'
where t1.dt='20241231'
;
-- FTP营收
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_08_2 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_08_2 as
SELECT  tt.cr_crd_act_id
       ,SUM(CASE WHEN substr(t.prod_cd,1,4) = '8101' THEN cust_accint - ftp_accint END) ftp_accint --FTP营收
       ,SUM(cap_cost) cap_cost
       ,SUM(CASE WHEN substr(t.prod_cd,1,4) = '8101' THEN cust_accint END) cust_accint --利息收入
FROM app_iftp.adm_papp_ftp_eva_acct_summ_rst_inf t
LEFT JOIN lab_risk_dev.xyk_all_cr_crd_TS  tt
ON tt.cr_crd_card_nbr = t.t_acct_no
WHERE t.dt ='20241231'
AND t.freq_dt = 'Y'
GROUP BY  tt.cr_crd_act_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025012151_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012151_CST_09 as
select t1.acg_dt                                 as 会计日期
	,t1.cst_id                                   as 客户编号
	,t1.cst_nm                                   as 客户名称
	,t1.cr_crd_card_nbr                          as 信用卡卡号
	,t1.cr_crd_act_id                            as 信用卡账号
	,t2.age  as 年龄
	-- ,t2.户籍省份
	-- ,t2.户籍城市
	-- ,t2.身份证前6位
	-- ,t2.身份证前6位省市
	-- ,t2.户籍省,t2.户籍市
	,case when nvl(t2.户籍省,'')<>'' then t2.户籍省 when nvl(t2.户籍省份,'')<>'' then t2.户籍省份
		else SUBSTR(t2.身份证前6位省市,1,3) end as 户籍省_合并
	,case when nvl(t2.户籍市,'')<>'' then t2.户籍市 when nvl(t2.户籍城市,'')<>'' then t2.户籍城市
		else t2.身份证前6位省市 end as 户籍市_合并
	,t1.crd_lmt                    AS 信用额度
	,t1.ovdr_bal                  AS 透支本金含分期付款余额
	,t1.csh_bal                   AS 取现本金
	,t1.dlq_pnp_bal               AS 分期付款余额
	,t1.pd_tp_nm                  AS 信用卡种类码值
	,t1.main_crd_nm               AS 主卡标志码值
	,t1.card_sts_cd               AS 卡状态
	,t1.opn_dt                    AS 账户开户日期
	,case when t1.rsnd_dt='18991231' then '' else t1.rsnd_dt end as 续卡日期
	,t1.expiry_ym                 AS 卡片到期年月
	,t1.ovd_hi_trm                AS 逾期期数
	,t3.ovd_dt                    AS 首次逾期日期
	,t4.max_trx_dt                AS 最后交易日期
	,t1.late_bil_amt              AS 上期帐单金额
	,t1.wthr_paid_lo_rpay         AS 当前是否已还最低还款
	-- ,''                           AS 历史最低还款次数
	,t1.applytype                 AS 申请渠道
	,t1.apl_chnl                                 as 进件渠道
	,t1.apl_chnl_ctg                             as 进件渠道大类
	,t1.market_no                 AS 二维码推荐人工号
	,t1.market_nm as 二维码推荐人
	,t1.二维码推荐人职位名称
	,t1.开户时二维码推荐人职位名称
	,t1.market_type               AS 二维码推荐性质码值
	,t1.market_type_nm               AS 二维码推荐性质
	,t1.cr_crd_mgr_id             AS 信用卡业务管户人工号
	,t1.cr_crd_mgr_nm             AS 信用卡业务管户人名称
	,t1.cr_crd_sbr_org_nm         AS 信用卡业务管户支行名称
	,t1.cr_crd_org_nm             AS 信用卡业务管户机构名称
	,t1.auto_aprv_ind		 	  as	自动审批标识
	,t1.acpt_sts_nm               AS 受理状态
	,t1.aprv_way as 进件状态
	,t1.REG_TYPE                  AS 业务经办模式_强人工_弱人工
	,t5.acc_int_year_ajust        AS 账户2023年累计FTP营收
	,t1.acc_int_year_ajust        AS 账户2024年累计FTP营收
	,t1.acc_year_bus_inc          AS 账户2024年累计营收
	,t17.ftp_accint 			as 账户2024年FTP营收_累计营收
	,t13.l12m_cr_crd_ftp_intr_inc AS 近12个月信用卡ftp利息收入eva
	,t13.cur_y_cst_val            AS 当年客户客户价值eva
	,t1.year_mid_bus_inc          AS 账户2024年累计信用卡中间业务收入
	,case when t6.cst_id is not null then '是' else '否' end 是否纯信用卡客户
	,case when t7.cst_id is not null then '是' else '否' end 逾期前是否推送处置类精准贷后
	,t8.max_tsk_gen_dt as 最近一次处置类精准贷后触发时间
	,t8.触发规则分类,t8.触发规则,t8.触发原因分析
	,t11.modl_rsk_lyr_nm AS 高风险客户标签
	,t12.modl_rsk_lyr_nm AS 准入时的高风险客户标签
	,case when t10.cst_id is not null then '是' else '否' end as 近1年是否发生过交接
	,t17.cst_cr_grd_val as 准入时征信分
	,case when t2.cst_cr_grd_val is not null then t2.cst_cr_grd_val
		when t2.idv_crd_sco_val is not null  then t2.idv_crd_sco_val
		else t2.digital_unscr end as 最新征信分
	,case when t14.cr_crd_card_nbr is not null then '是' else '否' end as 发生过历史分期的
	,case when t15.cr_crd_act_id   is not null then '是' else '否' end as 发生过非全额还款
	,t16.信贷管户人,t16.信贷管户机构
from SJXQ_SJ2025012151_CST_02  					t1
left join SJXQ_SJ2025012151_CST_06 	t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025012151_CST_04 				t3
on t1.cr_crd_act_id=t3.cr_crd_act_id
left join SJXQ_SJ2025012151_CST_07 				t4
on t1.cr_crd_act_id=t4.cr_crd_act_id
LEFT JOIN    APP_ADO.ADM_SUBL_BUS_CRD_CR_ACCT_SMY_INF_DD    t5 --信用卡账户信息汇总表
ON      t1.CR_CRD_CARD_NBR = t5.LATE_MAIN_CARD_CARD_NBR
AND     t5.DT = '20231231'
left join SJXQ_SJ2025012151_CST_03 	t6
on t1.cst_id=t6.cst_id
left join SJXQ_SJ2025012151_CST_05 	t7
on t1.cst_id=t7.cst_id
left join(
	SELECT  T1.cst_id       --客户号
			,T2.tsk_gen_dt as max_tsk_gen_dt  --最近一次触碰精准贷后_处置类时间
			,t3.触发规则分类,t3.触发规则,t3.触发原因分析
			,ROW_NUMBER() over(partition by t1.cst_id order by T2.tsk_gen_dt desc ) rn
	FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
	INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
	ON      T1.btch_serno = T2.btch_serno
	AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
	AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
	AND     T2.DT = '20241231'
	LEFT JOIN    (
		SELECT  A1.btch_serno
				,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)  AS 触发规则分类
				,A1.rul_nm               AS 触发规则
				,A1.trg_rsn_anls         AS 触发原因分析
				,A1.rul_ctg_nm --规则分类名称
				,A1.rul_sub_clss_nm --规则细类名称
				,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
		FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
		WHERE   A1.DT = '20241231'
	) T3
	ON      T1.btch_serno = T3.btch_serno
	AND     T3.RN = 1
	WHERE   T1.DT = '20241231'
)t8 on t1.cst_Id=t8.cst_Id
and t8.rn=1
left join (
	select b.cst_id,COUNT(1)
	from edw.loan_cst_mgr_hdv_aply 		a
	INNER join edw.loan_cst_mgr_hdv_cst b
	on a.APLY_SERNO = b.APLY_SERNO
	and b.dt='20241231'
	and b.del_ind='0'
	and substr(replace(b.sys_reg_tm,'-',''),1,8)>='20240101' --近1年
	where a.dt='20241231'
	group by b.cst_id
	HAVING COUNT(1)>0
	--是否有发生过交接，判断count > 0
)t10 on t1.cst_id=t10.cst_id
left join(
	SELECT cst_id
		,DECODE(modl_rsk_lyr_cd,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') as modl_rsk_lyr_nm
		,ROW_NUMBER() over(partition by cst_id order by rsk_lyr_afm_tm desc) rn 	--风险分层认定时间
	from edw.dim_cst_asst_rsk_lyr_dd
	where dt = '20241231'
	and nvl(modl_rsk_lyr_cd,'')<>''
)t11 on t1.cst_id=t11.cst_id
and t11.rn=1
left join SJXQ_SJ2025012151_CST_06_2 	t12
on t1.cst_id=t12.cst_id
and t1.zhunru_dt=t12.zhunru_dt
left join adm_ind.ADM_IND_I_CST_FIN_BNFT_OI_AMT_IDX_DD t13
ON      t1.cst_Id = t13.cst_id
AND     t13.dt = '20241231'
left join(
	select distinct cr_crd_card_nbr
	from edw.dwd_bus_crd_cr_crd_instl_dtl_dd	--信用卡分期明细
	where dt='20241231'
)t14 on t1.cr_crd_card_nbr=t14.cr_crd_card_nbr
left join SJXQ_SJ2025012151_CST_08 t15
on t1.cr_crd_act_id=t15.cr_crd_act_id
left join SJXQ_SJ2025012151_CST_06_1 t17
on t1.cst_id=t17.cst_id
and t1.zhunru_dt=t17.zhunru_dt
and t17.rn=1
left join(
	SELECT cst_id
	from SJXQ_SJ2025012151_CST_08_1
	GROUP BY cst_id
)t16 on t1.cst_id=t16.cst_id
left join SJXQ_SJ2025012151_CST_08_2 	t17
on t1.cr_crd_act_id=t17.cr_crd_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct USC_APLY_SERNO) custs
from SJXQ_SJ2025012151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025012151_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012151_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cr_crd_act_id) custs
from SJXQ_SJ2025012151_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012151_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012151_CST_06
union all
SElECT '061' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012151_CST_06_1 where rn=1
union all
SElECT '062' seq, count(1) cnt,count(distinct cst_id,zhunru_dt) custs
from SJXQ_SJ2025012151_CST_06_2
union all
SElECT '07' seq, count(1) cnt,count(distinct CR_CRD_ACT_ID) custs
from SJXQ_SJ2025012151_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cr_crd_act_id) custs
from SJXQ_SJ2025012151_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ2025012151_CST_09
;
SElECT '09' seq, *
from SJXQ_SJ2025012151_CST_09
;
/*
01	41772	41772
02	43394	43394
03	14826	14826
04	35345	35345
05	35123	35123
06	39512	39512
061	23482	22880
062	6725	6725
07	717879	717879
08	284625	284625
09	43394	43394
SELECT  cst_id
       ,cr_crd_act_id
       ,late_main_card_card_nbr
       ,acc_year_bus_inc --账户年累计营收（K）
FROM app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd --信用卡账户信息汇总表 200
WHERE dt = '20241231'
;
SELECT  tt.cr_crd_act_id
       ,t.dt
       ,SUM(CASE WHEN substr(t.prod_cd,1,4) = '8101' THEN cust_accint - ftp_accint END) ftp_accint --FTP营收
       ,SUM(cap_cost) cap_cost
       ,SUM(CASE WHEN substr(t.prod_cd,1,4) = '8101' THEN cust_accint END) cust_accint --利息收入
FROM app_iftp.adm_papp_ftp_eva_acct_summ_rst_inf t
LEFT JOIN lab_risk_dev.xyk_all_cr_crd_TS tt
AND freq_dt = 'Y'
GROUP BY  tt.cr_crd_act_id
         ,t.dt
ORDER BY  tt.cr_crd_act_id
         ,t.dt
*/***卓娅_SJ2025010761_票据业务.sql
﻿/*
需要截止2024.12.31日买入余额清单、2024.12.31日同业客户额度查询、12月卖出明细台账核对票据授信占用准确性
2024.12.31日买入余额清单、2024.12.31日同业客户额度查询、2024.12月卖出明细台账
数据需求字段
截止2024.12.31买入余额清单字段：票据业务编号、票号、子区间、票面金额、贴现行法人名称、承兑行法人名称、占用授信行、占用金额
截止同业客户额度查询：同生产上字段  同业客户查询直接查 edw.nbms_ifb_cred_inf 额度信息表 就好
12月卖出明细台账：票据业务编号、票号、子区间、票面金额、贴现行法人名称、承兑行法人名称、占用授信行、占用金额、转卖时间
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_01 as
select *
from(
    select id                                       --ID
        ,mbr_id                                   --票交所会员代码
        ,ptcp_hvps_bk_no                          --支付行号
        ,cust_nm                                  --客户名称
        ,cust_no                                  --客户号
        ,leg_rep_cust_nm                          --法人客户名称
        ,org_id                                   --客户机构代码
        ,org_sec_clss_cd                          --金融机构类型代码数据字典：CORP_SCALE_ECIF
        ,scale                                    --企业规模CS01：大型CS02：中型CS03：小型CS04：微型CS05：其他（非企业类单位）
        ,lst_upd_tm                               --记录修改日期
        ,ROW_NUMBER() OVER (PARTITION BY org_id ORDER BY lst_upd_tm DESC ) AS rn
    from edw.nbms_ifb_inter_bk_inf                --同业交易承兑和交易对手信息表
    where dt='20241231'
)t where rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_02 as
select t1.id                                       --ID
	,t1.cont_id                                  --协议ID
	,t1.drft_id                                  --票据ID
	-- ,t1.drft_no                                  --票据号码
	,t1.int_amt                                  --利息
	,t1.int_due_dt                               --计息到期日
	,t1.real_amt                                 --实付金额
	,t1.rmk                                      --备注
	,t1.cpes_set_amt                             --结算金额/首期结算金额
	,t1.cpes_set_amt2                            --到期结算金额
	,t1.note                                     --备注
	,t1.cd_range                                 --子票区间
	,t1.dscnt_amt                                --贴现金额
	,t2.drft_no                                  --票据号码
	,t2.isse_amt                                 --票面金额
    ,t2.accptr_nm                                --承兑人名称 商票（出票人企业名称） 银票（通过承兑行开户行ID来查找承兑人名称，与承兑人开户行名称基本一致，个别情况，本字段存放的是承兑人的机构名称）
	,t2.accptr_bk_id                             --承兑人开户行ID
	,t2.accptr_acct                              --承兑人账号
	,t2.accptr_bk_nm                             --承兑人开户行名称
	,t2.accptr_cust_id                           --承兑人客户ID
	,t2.drft_stat                                --票据状态
	,t2.std_amt                                  --标准金额
	,t2.cd_range       as  cd_range2                         --子票区间
	,t2.cd_source                                --票据(包)来源
	,t2.cd_split                                 --票据是否允许分包流转
	,t3.org_no                                   --机构号
	,t3.org_nm                                   --机构名称
	,t4.cont_no                                  --协议编号
    ,t4.buss_typ                                 --业务品种
    ,t4.cust_id                                  --贴出人客户ID
    ,t4.dscnt_typ                                --贴现方式 0-贴现 1-转贴现 2-再贴现
    ,t4.dscnt_dt                                 --贴现日期
    ,t4.int_rate                                 --贴现利率 例如4.3%保存值为4.3
	,t4.rpd_open_dt                              --赎回开放日
	,t4.rpd_due_dt                               --赎回截止日
	-- ,t4.accptr_bk_id                             --承兑人开户行ID
	,t4.mc_org_id                                --法人机构号
    ,t4.cpes_cp_branch                           --对方票交所机构代码
	,t5.bk_no                                    --行号
	,t5.bk_nm                                    --行名
	,t5.lgl_prsn                                 --所属法人
    ,t6.leg_rep_cust_nm                                                       AS cp_leg_rep_cust_nm
    ,t6.scale                                                                 AS cp_scale
    ,t6.ORG_SEC_CLSS_CD                                                       AS CP_ORG_SEC_CLSS_CD
from edw.nbms_ifb_dscnt_buy_list        t1 --买入明细表
inner join edw.nbms_ifb_comm_drft_inf   t2 --票据基本信息
on t1.drft_id=t2.id
and t2.dt='20241231'
AND t2.mc_org_id = '0000'
inner join edw.nbms_ifs_org             t3 --机构表（行内机构信息）
on t2.org_id=t3.id
and t3.dt='20241231'
and t3.org_bln_cd LIKE '999999999%'        --机构归属代码 存储整个层级结构
left join edw.nbms_ifb_dscnt_buy_cont   t4 --买入协议表
on t1.cont_id=t4.id
and t4.dt='20241231'
left join edw.nbms_ifb_cust_bk_inf      t5 --联行信息表
on t2.accptr_bk_id=t5.id
and t5.dt='20241231'
LEFT JOIN SJXQ_SJ2025010761_CST_01      t6
ON t4.cpes_cp_branch=t6.org_id
where t1.dt='20241231'
AND t1.acct_Stat = '1'
;
--截止2024.12.31日买入余额清单
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_03 as
SELECT  t1.cont_id           AS 协议ID
	,t1.drft_id              AS 票据ID
	,t1.drft_no              AS 票据号码
	,t1.cd_range             AS 子票区间
	,t1.isse_amt             AS 票面金额
	,t1.cp_leg_rep_cust_nm   AS 贴现行法人客户名称
    ,t8.leg_rep_cust_nm    	 AS 承兑行法人客户名称
from SJXQ_SJ2025010761_CST_02 		t1
left JOIN edw.nbms_ife_org          t7 --票交所机构信息
on t1.BK_NO=t7.PTCP_HVPS_BK_NO
and t7.dt='20241231'
left JOIN SJXQ_SJ2025010761_CST_01  t8
ON t7.ORG_ID=t8.org_id
;
-- 2024.12.31日同业客户额度查询
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_04 as
select org_id                                   as 机构ID
	,cred_no                                  as 额度编号
	-- ,cred_typ                                 as 额度种类 1-企业额度 2-同业额度
	,DECODE(cred_typ,'1','企业额度','2','同业额度','') as 额度种类
	,credit_prod_id                           as 授信产品ID
	,cust_id                                  as 客户主键
	-- ,use_typ                                  as 使用方式 0-次性（默认） 1-循环
	,DECODE(use_typ,'0','次性','1','循环','') as 使用方式
	-- ,batch_no                                 as 批复号
	-- -- ,batch_type                               as 批复类型 1-综合授信 2-内部批复 3-单笔单批
	-- ,DECODE(batch_type,'1','综合授信','2','内部批复','3','单笔单批','') as 批复类型
	-- ,batch_class                              as 授信类型 1-综合授信（默认） 2-票据池额度
	,DECODE(batch_class,'1','综合授信','2','票据池额度','') as 授信类型
	-- ,cont_no                                  as 综合授信协议号
	,strt_dt                                  as 生效起始日
	,end_dt                                   as 生效截止日
	,amt                                      as 总额度
	,bal_amt                                  as 剩余额度
	,use_amt                                  as 已用额度
	-- ,stat                                     as 状态 0-无效 1-有效
	,old_amt                                  as 原总额度
	,rmk                                      as 备注
	,crt_stf                                  as CRT_STF
	,crt_tm                                   as crt_tm
	,lst_upd_stf                              as lst_upd_stf
	,lst_upd_tm                               as lst_upd_tm
	,serial_no                                as 额度流水号
	,is_control                               as 是否管控
	,ecif_cust_id                             as ECIF客户号
	,status                                   as 额度生效状态
from edw.nbms_ifb_cred_inf                    --额度信息表
where dt='20241231'
and stat='1'
;
-- 202412月卖出明细台账核对票据授信占用准确性
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_05 as
select t1.id                                       --ID
	,t1.cont_id                                  --协议ID
	,t1.drft_id                                  --票据ID
	-- ,t1.int_rate                                 --转卖利率
	,t1.int_amt                                  --利息支出
	,t1.real_amt                                 --实收金额
	,t1.int_due_dt                               --计息到期日
	-- ,t1.cd_range                                 --子票区间
	-- ,t1.cd_source                                --票据来源 CS01-ECDS CS02-金融机构 CS03-供应链平台
	-- ,t1.drft_no                                  --票据号码
    ,t2.drft_no                                  --票据号码
	,t2.src_typ                                  --票据来源类型 01-我行承兑 02-贴现买入 03-转贴现买入 04-代保管 05-我行提供保证 06-我行是质权人 07-同意清偿 08-票据池 09-代客托收
    ,t2.src_cont_id                              --来源协议ID，用于关联来源协议
    ,t2.drft_attr                                --票据介质 1-纸票 2-电票
	,t2.drft_typ                                 --票据种类 AC01-银承 AC02-商承
    ,t2.isse_dt                                  --出票日
	,t2.due_dt                                   --到期日
	,t2.isse_amt                                 --票面金额
    ,t2.drwr_cust_id                             --出票人客户ID
    ,t2.drwr_cmon_id                             --出票人组织机构代码
    ,t2.drwr_nm                                  --出票人名称
    ,t2.accptr_nm                                --承兑人名称 商票（出票人企业名称） 银票（通过承兑行开户行ID来查找承兑人名称，与承兑人开户行名称基本一致，个别情况，本字段存放的是承兑人的机构名称）
	,t2.accptr_bk_id                             --承兑人开户行ID
	,t2.accptr_cust_id                           --承兑人客户ID
    ,t2.pyee_nm                                  --收款人名称
    -- ,t2.org_id                                   --票据所属机构ID（行内机构号）
    ,t2.drft_stat                                --票据状态
	,t2.buss_mode                                --业务模式 1-场外 2-场内
	,t2.std_amt                                  --标准金额
	,t2.cd_range                                 --子票区间
	,t2.cd_source                                --票据(包)来源
	,t2.cd_split                                 --票据是否允许分包流转
	,t3.cont_no                                  --协议编号
	,t3.buss_typ                                 --业务品种
	,t3.dscnt_typ                                --贴现方式 0-贴现 1-转贴现 2-再贴现
	,t3.cust_id                                  --客户ID
	,t3.dscnt_dt                                 --转卖日期
	,t3.int_rate                                 --转卖利率
	,t3.rpd_open_dt                              --赎回开放日
	,t3.rpd_due_dt                               --赎回截止日
	,t3.org_id                                   --机构号
	,t3.mc_org_id                                --法人机构号
	,t3.cpes_cp_branch                           --对方机构代码
	,t4.org_no                                   --机构号
	,t4.org_nm                                   --机构名称
    ,t5.leg_rep_cust_nm                 AS cp_leg_rep_cust_nm
    ,t5.scale                           AS cp_scale
    ,t5.ORG_SEC_CLSS_CD                 AS CP_ORG_SEC_CLSS_CD
	,t6.bk_no                                    --行号
	,t6.bk_nm                                    --行名
	,t6.lgl_prsn                                 --所属法人
from edw.nbms_ifb_dscnt_sell_list       t1 --卖出明细表
left join edw.nbms_ifb_comm_drft_inf    t2 --票据基本信息
on t1.drft_id=t2.id
and t2.dt='20241231'
inner join edw.nbms_ifb_dscnt_sell_cont t3 --转卖协议表
on t1.cont_id=t3.id
and t3.dt='20241231'
AND t3.acct_stat = '1' --记账状态 0-未记账 1-记账中 2-记账成功 3-记账失败
AND t3.DSCNT_DT between '20241201'AND '20241231'
left join edw.nbms_ifs_org              t4 --机构表（行内机构信息）
on t2.org_id=t4.id
and t4.dt='20241231'
left join SJXQ_SJ2025010761_CST_01      t5
on t3.cpes_cp_branch=t5.org_id
left join edw.nbms_ifb_cust_bk_inf      t6 --联行信息表
on t2.accptr_bk_id=t6.id
and t6.dt='20241231'
where t1.dt='20241231'
AND t1.acct_stat = '1'
AND t1.mc_org_id = '0000'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_06 as
select t1.BK_NO
    ,t7.ORG_ID
    ,t8.leg_rep_cust_nm   AS drwr_leg_rep_cust_nm
    ,t8.scale             AS drwr_scale
    ,t8.ORG_SEC_CLSS_CD   AS DRWR_ORG_SEC_CLSS_CD
from (
    select distinct BK_NO
    from SJXQ_SJ2025010761_CST_05
)t1 LEFT JOIN edw.nbms_ife_org          t7 --票交所机构信息
on t1.BK_NO=t7.PTCP_HVPS_BK_NO
and t7.dt='20241231'
LEFT JOIN SJXQ_SJ2025010761_CST_01      t8
ON t7.ORG_ID=t8.org_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025010761_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025010761_CST_07 as
SELECT  t1.cont_id           AS 协议ID
	,t1.drft_id              AS 票据ID
	,t1.drft_no              AS 票据号码
	,t1.cd_range             AS 子票区间
	,t1.isse_amt             AS 票面金额
	,t1.cp_leg_rep_cust_nm   AS 贴现行法人客户名称
	,t2.drwr_leg_rep_cust_nm AS 承兑行法人客户名称
	,t1.dscnt_dt             as 转卖日期
from SJXQ_SJ2025010761_CST_05 t1
left join(
    select BK_NO
    from SJXQ_SJ2025010761_CST_06
    group by BK_NO
)t2 on t1.BK_NO=t2.BK_NO
;
SElECT '01' seq, count(1) cnt,count(distinct org_id) custs
from SJXQ_SJ2025010761_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ2025010761_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 票据ID) custs
from SJXQ_SJ2025010761_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ2025010761_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ2025010761_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct BK_NO) custs
from SJXQ_SJ2025010761_CST_06
;
SELECT *
from SJXQ_SJ2025010761_CST_03
;
SELECT *
from SJXQ_SJ2025010761_CST_04
;
SELECT *
from SJXQ_SJ2025010761_CST_07
;
/*
01	7487	7487
02	6152	6152
03	1996	1996
04	154	154
05	1092	1092
06	718	718
*/***史云_SJ2025061091_超柜IpMac地址.sql
﻿-- 根据附件的泰隆生活订单号，关联虚拟账户和泰惠收的交易信息，生成清单
DROP   TABLE IF     EXISTS SJXQ_SJ2025061091_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061091_CST_01 AS
SELECT  col_1 --订单号
       ,col_2 --渠道
       ,col_3 --支付方式
       ,col_4 --下单时间
       ,SUBSTR(replace(col_4,'-',''),1,8) as ord_dt  --20240801-20250604
       ,col_5 --泰惠收交易流水号
       ,case when col_1=col_5 then 1 else 0 end as is_same
from lab_bigdata_dev.qbi_file_20250617_09_04_52_0
where pt<>''
;
--订单表
DROP   TABLE IF     EXISTS SJXQ_SJ2025061091_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061091_CST_02 AS
SELECT t2.order_id  --泰隆生活订单号
    ,t2.paytime	    --付款时间
    ,t2.msg_code
    ,t3.ord_srl_nbr --泰惠收商户订单号
    ,t3.ord_trx_dt
    ,t3.eqp_no	    --设备号
from SJXQ_SJ2025061091_CST_01   t1
INNER JOIN edw.tlsc_sunyardmall_orderform t2 --订单表
ON      t1.col_1 = t2.order_id
AND     t2.dt = '20250604'
AND     substr(replace(t2.addtime,'-',''),1,8) between '20240801' and '20250604'
LEFT JOIN    edw.dwd_bus_chnl_ths_ord_srl_di t3 --泰惠收订单流水明细
ON      t2.msg_code = t3.ext_sys_ord_srl_nbr
AND     t3.dt <= '20250604'
AND     t3.dt >= '20240801'
;
--支付平台订单信息登记表
DROP   TABLE IF     EXISTS SJXQ_SJ2025061091_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061091_CST_03 AS
select t1.txn_seq_id                               --内部流水号
	,t1.txn_dt                                   --内部交易日期
	,t1.txn_tm                                   --内部交易时间
	,t1.txn_order_id                             --订单号(外部系统流水号)
	,t1.txn_order_time                           --订单生成时间(交易起始时间)，格式:为[yyyyMMddHHmmss] ,如2009年12月25日9点10分10秒,表示为20091225091010
	,t1.txn_order_amt                            --订单金额，单位为分，例:1.23元=123
	,t1.order_body                               --商品描述
	,t1.order_detail                             --商品详细
	,t1.txn_amt                                  --交易支付金额(包含：消费、退货、撤销,交易单位为分，例:1.23元=123)
	,t1.last_upd_time                            --最后更新时间(支付完成时间,格式：yyyyMMddHHmmss)
	,t1.txn_state                                --交易状态：00：交易成功；01:退款；99：失败
	,t1.txn_order_remark                         --订单备注
	,t1.device_no                                --设备号
	,t1.other_desc_info                          --备注
	,t2.trans_ip                                 --交易IP
	,t2.user_mac                                 --用户MAC地址
from edw.dpss_pbs_order_info            t1 --支付平台订单信息登记表
left join edw.dpss_pbs_order_ip_info    t2 --订单IP记录关联表
ON t1.txn_seq_id = t2.txn_seq_id
and t2.dt=t1.dt
INner join (
    SELECT DISTINCT ord_srl_nbr
    from SJXQ_SJ2025061091_CST_02
    where nvl(ord_srl_nbr,'')<>''
)t3 on t1.txn_seq_id=t3.ord_srl_nbr
where t1.dt between '20240801' and '20250604'
;
-- reslut
DROP   TABLE IF     EXISTS SJXQ_SJ2025061091_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061091_CST_04 AS
SELECT  t1.col_1            AS 订单号_泰隆生活订单号
        ,t1.col_2           AS 渠道
        ,t1.col_3           AS 支付方式
        ,t1.col_4           AS 下单时间
        ,t1.col_5           AS 泰惠收交易流水号
        ,t2.ord_srl_nbr     AS 泰惠收商户订单号
        ,t2.paytime         AS 付款时间
        ,t3.device_no       AS 设备号
        ,t3.trans_ip        AS 交易IP
        ,t3.user_mac        AS 用户MAC地址
from SJXQ_SJ2025061091_CST_01       t1
left join SJXQ_SJ2025061091_CST_02  t2
on t1.col_1 = t2.order_id
left join SJXQ_SJ2025061091_CST_03  t3
on t2.ord_srl_nbr=t3.txn_seq_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025061091_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ord_srl_nbr) custs
from SJXQ_SJ2025061091_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct txn_seq_id) custs
from SJXQ_SJ2025061091_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 订单号_泰隆生活订单号) custs
from SJXQ_SJ2025061091_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2025061091_CST_04
;
/*
col_2	col_3	y	is_same	cnt
超柜	新支付	2024	0	418
超柜	新支付	2024	1	201301
超柜	新支付	2025	1	278745
超柜	老支付	2024	1	214
超柜	老支付	2025	1	196
select length(col_1) l1,length(col_5) l2,is_same
    ,count(1) cnt
from SJXQ_SJ2025061091_CST_01
group by l1,l2,is_same
01	480874	480874
02	480874	480874
03	446282	446282
*/
***叶云怡_SJ20250728106_金华分行新增授信客户清单.sql
-- 叶云怡_SJ20250728106_金华分行新增授信客户清单
-- 截止2025年7月31日，金华分行新增授信客户清单，合同起始日：2024年10月1日至2025年7月31日
DROP   TABLE IF     EXISTS SJXQ_SJ20250728106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250728106_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续做') as 发生类型
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,c1.cd_val_dscr     as 合同状态
    ,t1.mgr_id	        --管户人工号
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t3.prm_mgr_id                               --主管户客户经理工号
	,t3.prm_mgr_nm                               --主管户客户经理姓名
    ,t4.brc_org_nm
    ,t4.sbr_org_nm
    ,t4.tem_org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cmn_rsk_ctrl_id
    ,t5.idt_cd                                   --行业代码
    ,c2.cd_val_dscr     as 行业
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join adm_pub.adm_csm_cbas_mng_inf_dd   t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='金华分行'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
ON      t1.ctr_sts_cd = c1.cd_val
AND     c1.DT = t1.dt
LEFT JOIN    edw.dwd_code_library_dd 	c2 --码值表
ON      t5.idt_cd = c2.cd_val
AND     c2.DT = t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
and t1.ctr_bgn_dt between '20241001' and '20250731'     --新增授信客户
;
-- 结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250728106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250728106_CST_02 AS
SELECT  t1.ctr_serno       AS 合同流水号
       ,t1.cst_id          AS 客户号
       ,t1.cst_nm          AS 客户名称
       ,t1.发生类型
       ,t1.ctr_amt         AS 合同金额
       ,t1.ctr_bal         AS 合同余额
       ,t1.ctr_bgn_dt      AS 合同起始日期
       ,t1.ctr_mtu_dt      AS 合同到期日期
       ,t1.合同状态
       ,t1.sbr_org_nm      AS 管户支行名称
       ,t1.tem_org_nm      AS 管户团队名称
       ,t1.prm_mgr_id      AS 主管户客户经理工号
       ,t1.prm_mgr_nm      AS 主管户客户经理姓名
       ,t1.cmn_rsk_ctrl_id AS 同一风险控制号
       ,t1.行业
       ,t2.vld_cst         AS 有效户
       ,t3.vld_loan_act    AS 有效贷款户
       ,t6.sub_cmnt_id     AS 普惠子社区编号
       ,t7.cmnt_nm         AS 普惠子社区名称
from SJXQ_SJ20250728106_CST_01  t1
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t2 --客户规则类通用营销特性表3
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t3 --通用金融行为贷款标签表2
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250728106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250728106_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20250728106_CST_02
***叶灵子_SJ2025052721_所有业务交接统计.sql
﻿/*
2025年5月1日-2025年5月26日
1.各分行所有业务交接中，使用小鱼管家交接数据的占比 ，其中信贷业务使用小鱼管家交接的占比。
2.衢州分行各支行所有业务交接中，使用小鱼管家交接数据的占比 ，其中信贷业务使用小鱼管家交接的占比。
数据需求字段
1.交接分行，交接总数，使用小鱼管家交接数，其中信贷业务交接总数，使用小鱼管家交接数。
2.衢州分行内交接支行，交接总数，使用小鱼管家交接数，其中信贷业务交接总数，使用小鱼管家交接数。
*/
--管户交接记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025052721_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052721_CST_01 AS
select t1.aply_serno                               --申请流水号|c32
	,t1.cst_id                                   --客户号|c20
	,t1.bfr_hdv_cst_magr_id                      --移交前客户经理工号|c10
	,t1.bfr_hdv_mgr_org_no                       --移交前管户机构编号|c12
	,t1.aft_hdv_cst_magr_id                      --移交后客户经理工号|c10
	,t1.aft_hdv_mgr_org_no                       --移交后管户机构编号|c12
	,t1.hdv_typ_cd                               --移交类型代码|c1
	,t1.dlve_mod_cd                              --移交方式代码|c1
	,t1.aply_dt                                  --申请日期|c8
	,t1.sys_reg_tm                               --系统登记时间|c26
	,case when t1.aply_dt='18991231' then SUBSTR(REPLACE(t1.sys_reg_tm,'-',''),1,8) else t1.aply_dt end as jj_dt
	,case when t2.cust_id is not null then 1 else 0 end as is_xygj_jj
	,t4.brc_org_nm,t4.sbr_org_nm
	,case when t5.cst_id is not null and t2.credit_business='Y' then 1 else 0 end as is_loan_bus -- 信贷业务
	,case when t6.aply_serno is not null then 1 else 0 end as is_loan_bus2 -- 信贷业务
	,t6.bfr_hdv_cst_magr_id as bfr_hdv_cst_magr_id2                      --移交前客户经理工号|c10
	,t6.aft_hdv_cst_magr_id as aft_hdv_cst_magr_id2                      --移交后客户经理工号|c10
	,t6.aply_dt             as aply_dt2                      			--申请日期|c8
	,t6.sys_reg_tm          as sys_reg_tm2                      		--系统登记时间|c19
from edw.dwd_cst_mng_loan_mng_hdv_rcd_dd  		t1    --管户交接记录
LEFT JOIN edw.xwdt_xw_cust_inven_data_record 	t2
ON t1.cst_id = t2.cust_id
AND substr(REPLACE(t1.sys_reg_tm, '-', ''), 1, 6) = REPLACE(substr(t2.create_times, 1, 7), '-', '')
AND t2.dt = '20250526'
-- AND t2.credit_business = 'Y' -- 信贷业务
AND REPLACE(substr(t2.create_times, 1, 10), '-', '') between '20250501' and '20250526'
AND t2.STATUS = '01' --移交状态(00/待移交;01/已移交;02/移交失败(可再次移交);03/已作废(可被再次其他用户发起交接))
-- left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
-- on  t1.cst_id = t3.cst_id
-- and t3.dt = '20250526'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t1.bfr_hdv_mgr_org_no = t4.org_id
and t4.dt = '20250526'
and t4.brc_org_nm regexp '分行'
left join(
	SELECT  distinct cst_id
	FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1
	WHERE dt = '20250526'
	AND ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' ) OR nvl(t1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
	AND t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) --剔除信用卡
)t5 ON t1.cst_id = t5.cst_id
left join edw.dwd_cst_mng_loan_mng_hdv_aply_dd t6     --信贷管户交接信息
on t1.aply_serno=t6.aply_serno
and t6.dt=t1.dt
where t1.dt='20250526'
and case when t1.aply_dt='18991231' then SUBSTR(REPLACE(t1.sys_reg_tm,'-',''),1,8)
	else t1.aply_dt end between '20250501' and '20250526' 	--交接日期
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025052721_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052721_CST_02 AS
SELECT  brc_org_nm as 分行
       ,COUNT(1)                                                            AS 交接总数
       ,SUM(case WHEN is_xygj_jj = 1 THEN 1 else 0 end)                     AS 使用小鱼管家交接数
       ,SUM(case WHEN is_loan_bus = 1 THEN 1 else 0 end)                    AS 信贷业务交接总数
       ,SUM(case WHEN is_loan_bus = 1 AND is_xygj_jj = 1 THEN 1 else 0 end) AS 信贷业务使用小鱼管家交接数
from SJXQ_SJ2025052721_CST_01
group by brc_org_nm
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025052721_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052721_CST_03 AS
SELECT  sbr_org_nm as 衢州分行下支行
       ,COUNT(1)                                                            AS 交接总数
       ,SUM(case WHEN is_xygj_jj = 1 THEN 1 else 0 end)                     AS 使用小鱼管家交接数
       ,SUM(case WHEN is_loan_bus = 1 THEN 1 else 0 end)                    AS 信贷业务交接总数
       ,SUM(case WHEN is_loan_bus = 1 AND is_xygj_jj = 1 THEN 1 else 0 end) AS 信贷业务使用小鱼管家交接数
from SJXQ_SJ2025052721_CST_01
where brc_org_nm='衢州分行'
group by sbr_org_nm
;
SElECT '01' seq, count(1) cnt,count(distinct aply_serno) custs
from SJXQ_SJ2025052721_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 分行) custs
from SJXQ_SJ2025052721_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 衢州分行下支行) custs
from SJXQ_SJ2025052721_CST_03
;
SElECT '02' seq, *
from SJXQ_SJ2025052721_CST_02
;
SElECT '03' seq, *
from SJXQ_SJ2025052721_CST_03
;
select '管户交接信贷业务' as tbl_nm
	,count(1) cnt
	,count(distinct cst_id) as 客户号
from edw.dwd_bus_loan_cst_mgr_hdv_loan_bsn_dd --管户交接信贷业务
where dt='20250430';
-- tbl_nm	cnt	客户号
-- 管户交接信贷业务	2219746	464516
select '管户交接记录' as tbl_nm
	,count(1) cnt
	,count(distinct aply_serno) as 申请流水号
	,count(distinct cst_id) as 客户号
from edw.dwd_cst_mng_loan_mng_hdv_rcd_dd --管户交接记录
where dt='20250430';
-- tbl_nm	cnt	客户号
-- 管户交接记录	11605623	4798950
***向炜_SJ2025070206_旬阳村行量化风险等级.sql
-- 向炜_SJ2025070206_旬阳村行量化风险等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025070206_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070206_CST_01 AS
select t1.cst_id                                   --客户号
    ,min(case when ctr_bgn_dt<>'18991231' then t1.ctr_bgn_dt end) as fst_ctr_dt --合同起始日期
    ,sum(case when t1.dt='20250630'  and ((t1.CTR_STS_CD IN ( '2' , '4' ) AND t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0) then ctr_amt else 0 end)             as ctr_amt
    ,sum(case when t1.dt='20250630' then ctr_bal else 0 end)    as ctr_bal
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
where t1.dt<='20250630'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025070206_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070206_CST_02 AS
SELECT  t1.cst_id         AS 客户号
       ,t3.cst_chn_nm     AS 客户名
       ,t6.fst_ctr_dt     AS 首次授信日期
       ,t7.fst_risk_layer AS 准入时量化风险等级
       ,t5.risk_layer     AS 量化风险等级_0630
       ,t6.ctr_amt        AS 合同金额
       ,t6.ctr_bal        AS 合同余额
       ,t1.prm_org_id     AS 主管护机构号
       ,t1.prm_org_nm     AS 主管户机构名称
       ,t1.prm_mgr_id     AS 主管护客户经理工号
       ,t1.prm_mgr_nm     AS 主管护客户经理姓名
from adm_pub.adm_csm_cbas_mng_inf_dd            t1 --客户集市-客户基础-客户管户信息
inner join edw.dim_hr_org_mng_org_tree_dd       t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '陕西旬阳泰隆村镇银行'
inner join edw.DWS_CST_BAS_INF_DD               t3
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as risk_layer
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250630'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250630'
)t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2025070206_CST_01	t6
on t1.cst_id=t6.cst_id
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id,dt
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as fst_risk_layer
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt <='20250630'
    union
    select cst_id,dt
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt <='20250630'
)t7 on t1.cst_id=t7.cst_id
and t1.cst_id=t7.cst_id
and t6.fst_ctr_dt=t7.dt
where t1.dt = '20250630'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070206_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025070206_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025070206_CST_02
;
***吴奇_SJ20250208121_审批退回合同流水号.sql
﻿-- 时间：2025-01-01至2025-01-31期间
-- 信贷业务审批流程经过分行小企业部信审科  罗珊珊（000287）、朱芳（003619）、胡超越（005980）、
-- 沈佳丹（006118）、张佳琪（008180）、王凯文（010639）、倪国锋（018446）且经他们退回的合同流水号。
-- 2025-01-01至2025-01-31期间贷款审批数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250208121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250208121_CST_01 AS
SELECT  instance_id                                 --流程实例id
       ,flow_name                                   --流程名称
       ,flow_starter                                --流程发起者
       ,flow_starter_name                           --发起者名称
       ,replace(start_time,'/','') AS lc_start_time --流程发起时间
       ,org_id                                      --发起人机构id
       ,biz_id                                      --业务流水号|c32
       ,biz_type_cd                                 --业务类型代码|c32
       ,ROW_NUMBER() over(partition by biz_id order by replace(start_time,'/','') desc) rn
from edw.dwd_bus_loan_n_wf_instance_his_dd t1 --流程运行实例历史表
WHERE dt='@@{yyyyMMdd}'
and replace(start_time,'/','') between '20250101' and '20250131'
;
-- 审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ20250208121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250208121_CST_02 AS
SELECT t1.biz_id             --授用信申请流水号_业务流水号
    ,t1.instance_id          --流程实例id
    ,t2.comment_id           --主键|c32
    ,t2.user_id              --用户id|c32
    ,t3.empe_id
    ,t3.empe_nm              --用户名称
    ,t2.comment_sign         --用户结论|c5
    ,t2.start_time           --评论时间|c32
    ,t2.role_id              --审批人角色id|c32
    ,t2.user_comment         --用户评价|c1000
    ,t2.node_nm              --节点名称|c32
    ,t2.org_id AS cmt_org_id --所属机构编号|c32
    ,ROW_NUMBER() over(partition by t1.biz_id order by t2.start_time asc) rn
from SJXQ_SJ20250208121_CST_01 t1
inner join edw.dwd_bus_loan_n_wf_comment_his_dd t2 --流程审批意见历史
on t1.instance_id=t2.instance_id
and t2.dt='@@{yyyyMMdd}'
and t2.user_comment regexp '退回'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  substr(t2.user_id,1,6)=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250208121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250208121_CST_03 AS
SELECT t1.empe_id       as 员工id
    ,t1.empe_nm         as 员工名称
    ,t5.lc_start_time   as 流程发起时间
    ,t1.start_time         as 评论时间
    ,t1.user_comment       as 用户评价
    ,t2.ahn_ltr_aply_serno AS 授用信申请流水号
    ,t2.usc_aply_serno     AS 用信申请流水号
    ,t3.ctr_serno          AS 合同流水号
    ,t4.sbr_org_nm         AS 管户支行
from SJXQ_SJ20250208121_CST_02              t1
INNER JOIN edw.dwd_bus_loan_lmt_aply_biz_dd t2 --用信方案
on t1.biz_id=t2.ahn_ltr_aply_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_bse_inf_dd      t3 --合同基础信息
on t2.usc_aply_serno=t3.rel_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ20250208121_CST_01     t5
on t1.biz_id=t5.biz_id
and t5.rn=1
;
select *
from SJXQ_SJ20250208121_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct biz_id) custs
from SJXQ_SJ20250208121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct biz_id) custs
from SJXQ_SJ20250208121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250208121_CST_03
;
/*
01	151440	151233
02	154	143
03	144	121
*/
***吴小薇_SJ2025012616_台州分行反诈提醒.sql
/*
客户类型：
1.取现5万以上客户；
2.&ldquo;频繁大额转账客户&rdquo;（单笔金额超过人民币10万元、月内转账累计超过50万元的客户）
3..更换银行卡电话绑定客户；
上述3条取数的时间区间：20241215-取数当下；
4.近3个月发生过向陌生账户转账的对公客户
5.45周岁以上、客户价值等级V3的个人；
6.职业为企事业单位负责人的女性客户（数据中需包含是否签约理账）
机构：台州分行辖内支行（含总行营业部）
数据需求字段
账号、户名、开户机构、客户号、地区、手机号码、 业务相关情况（转账日期、转账金额、转账用途、取现金额等）、经办机构、经办人员、客户价值等级、理财签情况
*/
-- 客户价值
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_khjz purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_khjz AS
SELECT  t1.cst_id
    ,t1.cst_val_type as cst_val_l1y
    ,t2.cst_val_type as cst_val_c1m
    ,t3.cst_val_type as cst_val_c3m
    ,t4.cst_val_type as cst_val_c1y
FROM app_ado.adm_subl_cst_bus_inf_dd_khjz       t1
left join app_ado.adm_subl_cst_bus_inf_dd_khjz  t2
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.stat_dim = '当月'
left join app_ado.adm_subl_cst_bus_inf_dd_khjz  t3
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
and t3.stat_dim = '当季'
left join app_ado.adm_subl_cst_bus_inf_dd_khjz  t4
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
and t4.stat_dim = '当年'
WHERE t1.dt = '@@{yyyyMMdd}'
AND t1.stat_dim = '近一年'
;
-- 取现5万以上客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_01 AS
SELECT a.dep_act_id,a.cst_act_id,a.trx_dt
    ,a.trx_amt      --柜面现金交易金额
    ,a.txt_code
    ,a.smr_dscr
    ,a.cmt
    ,a.trx_bus_org	--	交易营业机构|C12
    ,a.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,b.cst_id	--客户号|C20
    ,b.act_nm	--账户名称|C300
    ,b.opn_org	--开户机构编号|C12
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(a.opr_tlr,1,6)=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
where a.dt between '20241215' and '@@{yyyyMMdd}'
AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
and a.crd_and_dbt_ind='D'
and a.csh_ind='0' --0:现金;1:转账
and a.trx_amt > 50000   --5万以上
;
--单笔金额超过人民币10万元
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_02 AS
SELECT a.dep_act_id,a.cst_act_id,a.trx_dt
    ,a.trx_amt      --柜面现金交易金额
    ,a.txt_code
    ,a.smr_dscr
    ,a.cmt
    ,a.trx_bus_org	--	交易营业机构|C12
    ,a.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,b.cst_id	--客户号|C20
    ,b.act_nm	--账户名称|C300
    ,b.opn_org	--开户机构编号|C12
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(a.opr_tlr,1,6)=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
where a.dt between '20241215' and '@@{yyyyMMdd}'
AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
and a.crd_and_dbt_ind='D'
and a.csh_ind='1' --0:现金;1:转账
and a.trx_amt > 100000   --10万以上
;
-- 月内转账累计超过50万元
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_03 AS
SELECT  b.cst_id --客户号|C20
       ,substr(a.trx_dt,1,6) AS trx_mon
       ,SUM(a.trx_amt)       AS trx_amt --柜面现金交易金额
       ,ROW_NUMBER() over(PARTITION BY b.cst_id ORDER BY  SUM(a.trx_amt) DESC) rn
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join(
    select distinct cst_id,dep_act_id
    from SJXQ_SJ2025012616_CST_02   --单笔金额超过人民币10万元
)b on a.dep_act_id=b.dep_act_id
where a.dt between '20241201' and '@@{yyyyMMdd}'
and a.crd_and_dbt_ind='D'
and a.csh_ind='1' --0:现金;1:转账
group by b.cst_id,trx_mon
having sum(a.trx_amt) > 500000
;
-- 客户手机号及地区
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_04 AS
SElECT t1.cst_id,t1.cst_chn_nm	--	客户姓名|C200
    ,t1.CST_TYP_CD
    ,t1.mbl_nbr	    --	手机号码
    ,t1.FML_TEL_NBR --家庭电话
    ,t1.CMP_TEL_NBR --公司电话
    ,SUBSTR(t1.DOC_NBR,1,6) as DOC_NBR_6
    ,t3.region_cd	--	客户所属地区
    ,c3.CD_VAL_DSCR     as 客户所属地区
    ,t1.REG_ADR
    ,concat(substr(regexp_replace(T1.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T1.reg_adr,'\\s|,',''))-6,0)),'******') as reg_adr_jm
from edw.dws_cst_bas_inf_dd 	t1 --客户基础信息汇总表
left join adm_upss.l_cust_all   t3 --全量客户表
on t1.cst_id=t3.cust_id
and t3.dt='@@{yyyyMMdd}'
left join EDW.DWD_CODE_LIBRARY_DD C3 -- 码值表
on case when nvl(t3.region_cd,'')<>'' then t3.region_cd else SUBSTR(t1.DOC_NBR,1,6) end=c3.cd_val
and  C3.DT = '@@{yyyyMMdd}'
AND  C3.FLD_NM = 'CITY' --区县
AND  C3.TBL_NM = 'CUSTOMER_ADDRESS'
where t1.dt='@@{yyyyMMdd}'
;
-- 是否当日存定期
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_04_1 AS
select t1.cst_id,t1.trx_dt,t2.opn_dt
	,t2.int_val_dt                               --起息日期|C8
	,t2.mtu_dt                                   --到期日期|C8
	,t2.dep_trm                                  --存期|C6
    ,t2.opn_amt
	,t2.gl_bal                                   --账户总账余额|DECIMAL(20,2)
    ,t2.cur_act_bal                              --当前账户余额
from(
    select cst_ID,trx_dt
    from SJXQ_SJ2025012616_CST_01
    union
    select cst_ID,trx_dt
    from SJXQ_SJ2025012616_CST_02
)t1 inner join EDW.DWS_BUS_DEP_ACT_INF_DD t2 -- 存款账户信息表
on t1.cst_ID=t2.cst_ID
and t1.trx_dt=t2.int_val_dt
and t2.dt='@@{yyyyMMdd}'
and t2.lbl_prod_typ_cd='1' --,'0','活期','1','定期'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_05 AS
SELECT  t1.cst_act_id           AS 客户账号
       ,t1.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t1.cst_id               AS 客户号
       ,COALESCE(t2.客户所属地区,t2.reg_adr_jm)         AS 客户所属地区
       ,t2.mbl_nbr              AS 手机号码
       ,t2.FML_TEL_NBR          AS 家庭电话
       ,t2.CMP_TEL_NBR          AS 公司电话
       ,decode(t2.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t1.trx_dt               AS 取现日期
       ,t1.trx_amt              AS 现金交易金额
       ,t1.smr_dscr             AS 摘要描述
       ,t1.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t1.opr_tlr,t1.opr_tlr_nm)            AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
    ,case when t8.cst_id is not null then '是' else '' end as 取现日是否存定期存款
    ,t8.opn_amt     as 取现日存定期存款开户金额
    ,t8.gl_bal      as 定期存款当前余额_1217
from SJXQ_SJ2025012616_CST_01       t1
left join SJXQ_SJ2025012616_CST_04  t2
on t1.cst_id=t2.cst_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t1.trx_bus_org = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ2025012616_CST_khjz       t7
on t1.cst_id=t7.cst_id
left join(
    select t1.cst_id,t1.trx_dt
        ,sum(opn_amt) as opn_amt
        ,sum(gl_bal ) as gl_bal
    from SJXQ_SJ2025012616_CST_04_1 t1
    group by t1.cst_id,t1.trx_dt
)t8 on t1.cst_ID=t8.cst_ID
and t1.trx_dt=t8.trx_dt
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_06 AS
SELECT  t2.cst_act_id           AS 客户账号
       ,t2.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t2.cst_id               AS 客户号
       ,COALESCE(t3.客户所属地区,t3.reg_adr_jm)        AS 客户所属地区
       ,t3.mbl_nbr              AS 手机号码
       ,t3.FML_TEL_NBR          AS 家庭电话
       ,t3.CMP_TEL_NBR          AS 公司电话
       ,decode(t3.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t2.trx_dt               AS 转账日期
       ,t2.trx_amt              AS 单笔转账金额
       ,t1.trx_mon              AS 月转账超50万月份
       ,t1.trx_amt              AS 月转账超50万金额
       ,t2.smr_dscr             AS 摘要描述
       ,t2.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t2.opr_tlr,t2.opr_tlr_nm)           AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
    ,case when t8.cst_id is not null then '是' else '' end as 取现日是否存定期存款
    ,t8.opn_amt     as 取现日存定期存款开户金额
    ,t8.gl_bal      as 定期存款当前余额_1217
from SJXQ_SJ2025012616_CST_03       t1
left join SJXQ_SJ2025012616_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025012616_CST_04  t3
on t1.cst_id=t3.cst_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t2.trx_bus_org = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ2025012616_CST_khjz       t7
on t1.cst_id=t7.cst_id
left join(
    select t1.cst_id,t1.trx_dt
        ,sum(opn_amt) as opn_amt
        ,sum(gl_bal ) as gl_bal
    from SJXQ_SJ2025012616_CST_04_1 t1
    group by t1.cst_id,t1.trx_dt
)t8 on t2.cst_ID=t8.cst_ID
and t2.trx_dt=t8.trx_dt
where t1.rn=1
;
-- 更换手机号客户
-- 更换手机号：客户最近一次更新日期在 20241215-@@{yyyyMMdd} 且 有2个手机号
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_07 AS
SELECT t.*
    ,row_number() over(partition by cip_cstno order by cip_phoneupdtime desc) rn
from(
    select distinct t1.cip_cstno                     --客户号
        ,t1.cip_namecn                               --客户姓名
        ,t1.cip_checkmobile                          --绑定手机号码
        ,t1.cip_phoneupdtime                         --绑定手机号修改时间
    from edw.ebnk_pb_cstinf_main   t1               --个人客户信息表
    INNER JOIN (
        SELECT DISTINCT cst_id
        from edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
        where dt='@@{yyyyMMdd}'
        AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
    )t2 on t1.cip_cstno=t2.cst_id
    where t1.dt<='@@{yyyyMMdd}'
    and nvl(t1.cip_checkmobile,'')<>''
)t
;
-- 更换手机号客户所有交易记录 9.30日
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_08 AS
SElECT t1.cip_cstno as cst_id
        ,t1.cip_checkmobile                          --绑定手机号码
        ,t1.cip_phoneupdtime                         --绑定手机号修改时间
from SJXQ_SJ2025012616_CST_07   t1
inner join(
    SElECT cip_cstno
    from SJXQ_SJ2025012616_CST_07
    group by cip_cstno having count(distinct cip_checkmobile)>1
)t2 on t1.cip_cstno=t2.cip_cstno
where t1.rn=1
and substr(t1.cip_phoneupdtime,1,8) between '20241215' and '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_09 AS
SELECT  t1.cst_id                     AS 客户号
       ,t1.cip_checkmobile            AS 绑定手机号码
       ,t1.cip_phoneupdtime           AS 绑定手机号修改时间
       ,t2.cst_act_id                 AS 客户账号
       ,t2.act_nm                     AS 账户名称
       ,t4.sbr_org_nm                 AS 开户支行
       ,t4.org_nm                     AS 开户机构
       ,t3.trx_dt                     AS 交易时间
       ,t3.crd_and_dbt_ind            AS 借贷标志
       ,t3.trx_amt                    AS 交易金额
       ,t3.smr_dscr                   AS 交易摘要
       ,t3.cmt                        AS 备注
       ,t5.org_nm                     AS 交易营业机构
       ,concat(t3.opr_tlr,c1.empe_nm) AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
from SJXQ_SJ2025012616_CST_08          t1
left join edw.dws_bus_dep_act_inf_dd    t2 --存款账户信息汇总
on  t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_dep_bal_chg_dtl_di    t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.dt between '20241215' and '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(t3.opr_tlr,1,6)=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.trx_bus_org = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ2025012616_CST_khjz t7
on t1.cst_id=t7.cst_id
;
-- 4.近3个月发生过向陌生账户转账的对公客户，陌生账户？陌生账号：近两年转账过的账号都不是陌生账号
-- 台州分行近3月对公客户转出明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_10 AS
SElECT t1.cst_id
    ,COALESCE(t1.客户所属地区,t1.reg_adr_jm)        AS 客户所属地区
    ,t1.mbl_nbr              AS 手机号码
    ,t1.FML_TEL_NBR          AS 家庭电话
    ,t1.CMP_TEL_NBR          AS 公司电话
    ,t2.cst_act_id
    ,t2.act_nm,t2.opn_org
    ,t3.dep_act_id
    ,t3.trx_dt,t3.trx_amt
    ,t3.trx_bus_org
    ,t3.cnt_pty_cst_act_id	    --	对方客户账号|C32
    ,t3.cnt_pty_act_nm	        --	对方户名|c200
    ,t3.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,t3.smr_dscr
    ,t3.cmt
from SJXQ_SJ2025012616_CST_04          t1
inner join edw.dws_bus_dep_act_inf_dd   t2 --存款账户信息汇总
on  t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
AND (t2.opn_org like  '3301%' or  t2.opn_org like  '9999%') --台州分行、总行营业部
inner join edw.dwd_bus_dep_bal_chg_dtl_di t3 --存款账户余额发生明细表
on  t2.dep_act_id=t3.dep_act_id
and t3.crd_and_dbt_ind='D'
and t3.csh_ind='1' --0:现金;1:转账
left join edw.dws_hr_empe_inf_dd          c1 --员工信息汇总
on  substr(t3.opr_tlr,1,6)=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
where t1.CST_TYP_CD='2' --'对公'
;
-- 近两年转账过的账号 剔除近3月交易
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_11 AS
select t1.cst_id,t1.dep_act_id,t3.cnt_pty_cst_act_id	    --	对方客户账号|C32
    ,max(t3.trx_dt)     as lst_trx_dt
from(
    SElECT distinct cst_id,dep_act_id
    from SJXQ_SJ2025012616_CST_10
)t1 inner join edw.dwd_bus_dep_bal_chg_dtl_di t3 --存款账户余额发生明细表
on  t1.dep_act_id=t3.dep_act_id
and t3.crd_and_dbt_ind='D'
and t3.csh_ind='1' --0:现金;1:转账
where nvl(t3.cnt_pty_cst_act_id,'')<>''
group by t1.cst_id,t1.dep_act_id,t3.cnt_pty_cst_act_id
;
-- 输出结果4
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_12 AS
SELECT  t1.cst_act_id           AS 客户账号
       ,t1.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t1.cst_id               AS 客户号
       ,t1.客户所属地区
       ,t1.手机号码
       ,t1.家庭电话
       ,t1.公司电话
       ,t1.trx_dt               AS 转账日期
       ,t1.trx_amt              AS 单笔转账金额
       ,t1.cnt_pty_cst_act_id   as 陌生账户_近12月到3月未交易过
       ,t1.smr_dscr             AS 摘要描述
       ,t1.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t1.opr_tlr,t1.opr_tlr_nm)           AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
from SJXQ_SJ2025012616_CST_10       t1
left join SJXQ_SJ2025012616_CST_11  t2
on t1.dep_act_id=t2.dep_act_id
and t1.cnt_pty_cst_act_id=t2.cnt_pty_cst_act_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  T1.trx_bus_org = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ2025012616_CST_khjz       t7
on t1.cst_id=t7.cst_id
where t2.dep_act_id is null     --陌生账户转账
;
-- 5.45周岁以上、客户价值等级V3的个人；V3以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_13 AS
SELECT  t1.cst_id                         AS 客户号
       ,t1.cst_chn_nm                     AS 客户姓名
       ,COALESCE(t1.客户所属地区,t1.reg_adr_jm) AS 客户所属地区
       ,t1.mbl_nbr                        AS 手机号码
       ,t1.FML_TEL_NBR                    AS 家庭电话
       ,t1.CMP_TEL_NBR                    AS 公司电话
       ,t2.age                            AS 年龄
       ,decode(t2.gdr_cd,'1','男','2','女','未知') as 性别
       ,t7.cst_val_c1m                    AS 客户价值等级
       ,t3.prm_mgr_id                     AS 主管户经理ID
       ,t3.prm_mgr_nm                     AS 主管户经理
       ,t4.brc_org_nm                     AS 主管户分行
       ,t4.sbr_org_nm                     AS 主管户支行
from SJXQ_SJ2025012616_CST_04                  t1
inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd  t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.age>=45
inner join SJXQ_SJ2025012616_CST_khjz t7
on t1.cst_id=t7.cst_id
and t7.cst_val_c1m>=3   -- V3以上
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t3.prm_org_id like '3301%' or t3.prm_org_id like  '9999%' --台州分行、总行营业部
;
-- 6.职业为企事业单位负责人的女性客户（数据中需包含是否签约理账）
DROP   TABLE IF     EXISTS SJXQ_SJ2025012616_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012616_CST_14 AS
SELECT  t1.cst_id                         AS 客户号
       ,t1.cst_chn_nm                     AS 客户姓名
       ,COALESCE(t1.客户所属地区,t1.reg_adr_jm) AS 客户所属地区
       ,t1.mbl_nbr                        AS 手机号码
       ,t1.FML_TEL_NBR                    AS 家庭电话
       ,t1.CMP_TEL_NBR                    AS 公司电话
       ,t2.age                            AS 年龄
       ,decode(t2.gdr_cd,'1','男','2','女','未知') as 性别
       ,c1.cd_val_dscr                    AS 职业
       ,t3.prm_mgr_id                     AS 主管户经理ID
       ,t3.prm_mgr_nm                     AS 主管户经理
       ,t4.brc_org_nm                     AS 主管户分行
       ,t4.sbr_org_nm                     AS 主管户支行
       ,t7.cst_val_c1m	            as 客户价值等级
from SJXQ_SJ2025012616_CST_04                  t1
inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd  t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.gdr_cd='2'   --'1','男','2','女'
inner join edw.dws_cst_idv_bas_inf_dd	        t5 --个人客户基本信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
and t5.ocp_cd='10600'   --职业代码 10600企事业单位负责人
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD            c1
ON      t5.ocp_cd = c1.cd_val
AND     c1.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2025012616_CST_khjz t7
on t1.cst_id=t7.cst_id
where t3.prm_org_id like '3301%' or t3.prm_org_id like  '9999%' --台州分行、总行营业部
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2025012616_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2025012616_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012616_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012616_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025012616_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025012616_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cip_cstno) custs
from SJXQ_SJ2025012616_CST_07 where rn=1
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012616_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025012616_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012616_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct dep_act_id,cnt_pty_cst_act_id) custs
from SJXQ_SJ2025012616_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025012616_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025012616_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025012616_CST_14
;
SElECT '05' seq, * from lab_bigdata_dev.SJXQ_SJ2025012616_CST_05;
SElECT '06' seq, * from lab_bigdata_dev.SJXQ_SJ2025012616_CST_06;
SElECT '09' seq, * from lab_bigdata_dev.SJXQ_SJ2025012616_CST_09;
SElECT '12' seq, * from lab_bigdata_dev.SJXQ_SJ2025012616_CST_12;
SElECT '13' seq, * from lab_bigdata_dev.SJXQ_SJ2025012616_CST_13;
SElECT '14' seq, * from lab_bigdata_dev.SJXQ_SJ2025012616_CST_14;
/*
01	9654	8471
02	131700	45544
03	25318	25318
04	19002449	19002449
05	9654	8061
06	115354	32695
07	1097821	1097821
08	493	493
09	10378	997
10	1447859	33845
11	2080639	2080639
12	464211	59627
13	75910	75910
14	2323	2323
*/***吴小薇_SJ2025031746_IP_MAC流水查询.sql
﻿-- 导入
DROP   TABLE IF EXISTS SJXQ_SJ2025031746_CST_00 PURGE;
CREATE TABLE           SJXQ_SJ2025031746_CST_00
(
    seq             string COMMENT ''
    ,card_id        string COMMENT ''
    ,opn_card_nm    string COMMENT ''
    ,opn_card_org   string COMMENT ''
)
;
insert into SJXQ_SJ2025031746_CST_00
values (1,'622***','杜文全','中国农业银行股份有限公司玉环玉城支行'),
;
-- 客户账号
DROP   TABLE IF     EXISTS SJXQ_SJ2025031746_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031746_CST_01 AS
SELECT t1.seq         --序号
    ,t1.card_id       --卡号
    ,t1.opn_card_nm   --开卡人
    ,t1.opn_card_org  --开卡网点
    ,t2.cst_id
    ,t2.cst_act_id
    ,t2.dep_act_id
    ,t2.bal_gl_ind	--	余额总账同步标志|C1
    ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1'   THEN '个人银行结算账户'
        WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
        WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
        WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
        WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END AS 账户类型
from SJXQ_SJ2025031746_CST_00       t1
left join edw.dws_bus_dep_act_inf_dd    t2 --存款账户信息汇总
on t1.card_id=t2.cst_act_id
and t2.dt='@@{yyyyMMdd}'
;
-- 流水
DROP   TABLE IF     EXISTS SJXQ_SJ2025031746_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031746_CST_02 AS
select t1.cst_act_id                               --客户账号|C32
	,t1.sub_act_seq_nbr                          --子账户序号|C8
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
    ,case when t1.crd_and_dbt_ind='D' then t1.trx_amt else 0 end as 借方发生额
    ,case when t1.crd_and_dbt_ind='C' then t1.trx_amt else 0 end as 贷方发生额
    ,t1.trx_amt
	,t1.act_bal                                  --账户余额|DECIMAL(21,2)
	,t1.crd_and_dbt_ind                          --借贷标志|C1
	,t1.txt_code                                 --摘要代码|C10
	,t1.smr_dscr                                 --摘要描述|C512
	,t1.dep_act_id                               --存款账号|C32
	,t1.prod_id                                  --产品编号
    ,t3.pd_cmt	                                 --产品说明
	,t1.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.ext_trx_no                               --外部交易码|C16
	,t1.int_trx_no                               --内部交易码|C16
	,t1.tlr_srl_nbr                              --柜员流水号|C32
	,t1.mtk_act_orig_tlr_srl_nbr                 --错账原柜员流水号|C32
	,t1.trx_bus_org                              --交易营业机构|C12
	,t1.opn_org                                  --开户机构|C12
	,t1.trx_ccy_cd                               --交易币种代码|C3
	,t1.act_cr_ind                               --账户钞汇标志|C1
	,t1.aut_tlr                                  --授权柜员|C10
	,t1.cmt                                      --备注|C200
	,t1.agn_nm                                   --代理人姓名|C200
	,t1.agn_doc_typ_cd                           --代理人证件类型代码|C5
	-- ,t1.agn_doc_nbr                              --代理人证件号码|C60
	,t1.bal_fld_nm                               --余额字段名称|C32
	,t1.vch_cls_cd                               --凭证种类代码|C3
	,t1.vch_bch_nbr                              --凭证批号|C10
	,t1.vch_seq_nbr                              --凭证序号|C8
	,t1.cnt_pty_cst_typ_cd                       --对方客户类型代码|C2
	,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t1.csh_ind                                  --现转标志|C1
	,t1.act_nm                                   --账户名称|C200
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
	,t1.trx_chnl_cd                              --交易渠道代码|C3
    ,t2.bal_gl_ind	        --	余额总账同步标志|C1
    ,t2.账户类型
from edw.dwd_bus_dep_bal_chg_dtl_di     t1        --存款账户余额发生明细
INNER JOIN SJXQ_SJ2025031746_CST_01	    T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
and     nvl(t2.cst_act_id,'')<>''
left join edw.dim_bus_dep_pd_bas_inf_dd	t3 --存款产品基础信息表
on t1.prod_id=t3.pd_id
and t3.dt='@@{yyyyMMdd}'
where t1.dt between '20240318' and '20250318'
;
-- ip and mac
DROP   TABLE IF     EXISTS SJXQ_SJ2025031746_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031746_CST_03 AS
SELECT t1.tlr_srl_nbr,t1.trx_dt
    ,t2.glbl_srl_nbr
    ,CASE
        WHEN t3.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t3.cst_end_ip, '@', 1)
        WHEN t3.cst_end_ip REGEXP ':' AND t3.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t3.cst_end_ip REGEXP '^null:' THEN split_part(t3.cst_end_ip, ':', 1)
        WHEN t3.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t3.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t3.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t3.cst_end_ip, '@', 2, 100)
        WHEN t3.cst_end_ip REGEXP ':' AND t3.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t3.cst_end_ip REGEXP '^null:' THEN split_part(t3.cst_end_ip, ':', 2, 100)
        WHEN t3.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t3.cst_end_ip
        END                                                    AS IP地址
from SJXQ_SJ2025031746_CST_02                   t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di   T2 --核心交易报文信息
ON  T1.tlr_srl_nbr = T2.trx_srl_nbr --柜员流水与交易流水关联
AND T1.trx_dt = T2.trx_dt
AND T2.DT >= '20240318'
INNER join edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t3 --个人网银各渠道汇总流水信息
ON  T2.glbl_srl_nbr = T3.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND T2.trx_dt = SUBSTR(T3.late_upd_tm, 1, 8)
and t3.dt BETWEEN '20240318' and '@@{yyyyMMdd}'
and t3.hst_rtn_err_cd = '000000' --交易成功
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025031746_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031746_CST_03_1 AS
SELECT t1.tlr_srl_nbr,t1.trx_dt
    ,CASE
        WHEN t3.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t3.cst_end_ip, '@', 1)
        WHEN t3.cst_end_ip REGEXP ':' AND t3.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t3.cst_end_ip REGEXP '^null:' THEN split_part(t3.cst_end_ip, ':', 1)
        WHEN t3.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t3.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t3.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t3.cst_end_ip, '@', 2, 100)
        WHEN t3.cst_end_ip REGEXP ':' AND t3.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t3.cst_end_ip REGEXP '^null:' THEN split_part(t3.cst_end_ip, ':', 2, 100)
        WHEN t3.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t3.cst_end_ip
        END                                                    AS IP地址
from SJXQ_SJ2025031746_CST_02                   t1
INNER join edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t3 --个人网银各渠道汇总流水信息
ON  T1.tlr_srl_nbr = T3.core_srl_nbr -- core_srl_nbr 缺失严重，不用。
and t3.dt BETWEEN '20240318' and '@@{yyyyMMdd}'
and t3.hst_rtn_err_cd = '000000' --交易成功
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031746_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031746_CST_04 AS
SELECT  t1.seq                       AS 序号
        ,t1.card_id                  AS 卡号
        ,t1.opn_card_nm              AS 开卡人
        ,t1.opn_card_org             AS 开卡网点
        ,t2.cst_act_id               AS 客户账号
        ,t2.sub_act_seq_nbr          AS 子账户序号
        ,t2.trx_dt                   AS 交易日期
        ,t2.trx_tm                   AS 交易时间
        ,t2.借方发生额
        ,t2.贷方发生额
        ,t2.act_bal                  AS 账户余额
        ,t2.crd_and_dbt_ind          AS 借贷标志
        ,t2.txt_code                 AS 摘要代码
        ,t2.smr_dscr                 AS 摘要描述
        ,t2.dep_act_id               AS 存款账号
        ,t2.prod_id                  AS 产品编号
        ,t2.pd_cmt                   AS 产品说明
        ,t2.cnt_pty_cst_act_id       AS 对方客户账号
        ,t2.cnt_pty_act_nm           AS 对方户名
        ,t2.ext_trx_no               AS 外部交易码
        ,t2.int_trx_no               AS 内部交易码
        ,t2.tlr_srl_nbr              AS 柜员流水号
        ,t2.mtk_act_orig_tlr_srl_nbr AS 错账原柜员流水号
        ,t2.trx_bus_org              AS 交易营业机构
        ,t2.opn_org                  AS 开户机构
        ,t2.trx_ccy_cd               AS 交易币种代码
        ,t2.act_cr_ind               AS 账户钞汇标志
        ,t2.aut_tlr                  AS 授权柜员
        ,t2.账户类型
        ,t2.cmt                      AS 备注
        ,t2.agn_nm                   AS 代理人姓名
        ,t2.agn_doc_typ_cd           AS 代理人证件类型代码
        ,t2.bal_fld_nm               AS 余额字段名称
        ,t2.bal_gl_ind               AS 余额总账同步标志
        ,t2.vch_cls_cd               AS 凭证种类代码
        ,t2.vch_bch_nbr              AS 凭证批号
        ,t2.vch_seq_nbr              AS 凭证序号
        ,t2.cnt_pty_cst_typ_cd       AS 对方客户类型代码
        ,t2.cnt_pty_fin_instt_nm     AS 对方金融机构名称
        ,t2.csh_ind                  AS 现转标志
        ,t2.act_nm                   AS 账户名称
        ,t2.dtl_seq_nbr              AS 明细序号
        ,t2.trx_chnl_cd              AS 交易渠道代码
        ,t3.ip地址
        ,t3.mac或imei地址
from SJXQ_SJ2025031746_CST_01       t1
left join SJXQ_SJ2025031746_CST_02  t2
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
left join SJXQ_SJ2025031746_CST_03  t3
ON      T2.tlr_srl_nbr = T3.tlr_srl_nbr
AND     T2.trx_dt = T3.trx_dt
where nvl(t1.cst_id,'')<>''
;
SELECT *
from SJXQ_SJ2025031746_CST_04;
SElECT '00' seq, count(1) cnt,count(distinct card_id) custs
from SJXQ_SJ2025031746_CST_00
union all
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025031746_CST_01 where nvl(cst_id,'')<>''
union all
SElECT '02' seq, count(1) cnt,count(distinct tlr_srl_nbr,trx_dt) custs
from SJXQ_SJ2025031746_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct tlr_srl_nbr,trx_dt) custs
from SJXQ_SJ2025031746_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 柜员流水号,交易日期) custs
from SJXQ_SJ2025031746_CST_04
;
/*
00	198	198
01	5	5
02	936	936
03	2	2
04	936	936
*/***吴小薇_SJ2025040271_台州分行对公数据.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 于彪
-- 创建日期: 2025-04-07 16:38:58
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 取台州分行辖内（含总行营业部）对公数据
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025040271_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040271_CST_01 AS
select t1.cst_act_id                            --客户账号|C32
	,t1.cst_id                                  --客户号|C20
	,t1.dep_act_id                               --存款账号|C32
	,t1.act_nm                                   --账户名称|C200
	,t1.opn_org                                  --开户机构编号
	,t1.opn_dt	                                --开户日期|C8
	,t1.act_opn_tlr                              --开户柜员编号|C10
    ,t4.empe_nm     as 开户柜员
	,t1.opn_chnl_cd                              --开户渠道|C8
    ,c1.cd_val_dscr  as 开户渠道
    ,CASE WHEN T1.cst_tp = '1' AND T1.stl_act_ind = '1' THEN '个人银行结算账户'
        WHEN T1.cst_tp = '2' AND T1.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
        WHEN T1.cst_tp = '2' AND T1.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
        WHEN T1.cst_tp = '2' AND T1.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
        WHEN T1.cst_tp = '2' AND T1.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END  AS 账户类型
    ,t1.dep_cls_cd                               --存款种类|C4
    ,c3.cd_val_dscr     as 存款种类
    ,t1.act_sts_cd
    ,c4.cd_val_dscr     as 账户状态
    ,t1.bal_gl_ind	--	余额总账同步标志|C1
    ,deocde(t1.bal_gl_ind,'0','虚户','1','实户') as 实虚户
	,t2.reg_adr                                  --户籍地址|注册地址|C256
	,t2.wrk_adr                                  --工作单位地址|经营所在地地址|C256
    ,t3.org_nm  as  opn_org_nm
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END   AS 是否止付
    ,T5.frz_rsn                                                     AS 止付原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是' ELSE '否' END  AS 是否冻结
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END  AS 是否关闭非柜面
    ,T7.close_fg_rsn                                             AS 关闭非柜原因
    -- ,t8.sffydszh	as	虚账户反映到实账户标志
    -- ,t9.virtual_cust_flg	as	虚拟客户标识
from edw.dws_bus_dep_act_inf_dd     t1             --存款账户信息汇总
inner join edw.dws_cst_bas_inf_dd   t2				    --客户基础信息汇总表
on t1.cst_id = t2.cst_id
and t2.dt=t1.dt
and t2.cst_typ_cd='2'   --'对公' 客户类型
left join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t1.opn_org=t3.org_id
and t3.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t1.act_opn_tlr=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           c1
ON t1.opn_chnl_cd = c1.CD_VAL
AND c1.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON t1.dep_cls_cd = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON t1.act_sts_cd = C4.CD_VAL
AND C4.DT = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  t1.cst_act_id
	       ,t1.frz_dt
	       ,t1.frz_rsn
	       ,t1.frz_cls_cd
	       ,c1.cd_val_dscr as frz_cls --止付种类
	       ,t1.ACT_STOP_PMT_TYP_CD
	       ,c2.cd_val_dscr as ACT_STOP_PMT_TYP --止付类型
	       ,ROW_NUMBER() OVER (PARTITION BY cst_act_id ORDER BY  frz_dt DESC) rn
	FROM edw.dwd_bus_dep_frz_inf_dd t1 --账户冻结登记
	LEFT JOIN edw.dwd_code_library_dd c1
	ON t1.frz_cls_cd = c1.cd_val AND c1.tbl_nm = 'DWD_BUS_DEP_FRZ_INF_DD' AND c1.fld_nm = 'FRZ_CLS_CD' AND c1.dt = '@@{yyyyMMdd}'
	LEFT JOIN edw.dwd_code_library_dd c2
	ON t1.frz_cls_cd = c2.cd_val AND c2.tbl_nm = 'DWD_BUS_DEP_FRZ_INF_DD' AND c2.fld_nm = 'ACT_STOP_PMT_TYP_CD' AND c2.dt = '@@{yyyyMMdd}'
	WHERE t1.DT = '@@{yyyyMMdd}'
	AND t1.FRZ_SRC_CD = '2' --止付
	AND t1.NFRZ_IND = '0'
) t5 --止付
ON t1.cst_act_id = t5.cst_act_id AND t5.rn = 1
left join(
    SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr as frz_cls                   --冻结种类
        ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt='@@{yyyyMMdd}'
    WHERE   T1.DT = '@@{yyyyMMdd}'
    AND     T1.FRZ_SRC_CD='1'  --冻结
    AND     T1.NFRZ_IND = '0'
)t6 on t1.cst_act_id=t6.cst_act_id and t6.rn=1
LEFT JOIN
(
	SELECT  cst_act_id
	       ,lmt_eft_dt
	       ,lmt_cmt as close_fg_rsn
	       ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY  lmt_eft_dt DESC ) rn
	FROM edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
	WHERE DT = '@@{yyyyMMdd}'
	AND ACT_THRS_TYP = '2' --暂停非柜面
	AND evt_id = 'DPDRAW'
) t7 --关闭非柜面
ON t1.cst_act_id = t7.cst_act_id AND t7.rn = 1
-- left join edw.core_kdpa_zhxinx	t8 --负债账户信息表
-- on t1.dep_act_id=t8.zhanghao
-- and t8.dt=t1.dt
-- left join adm_upss.l_cust_all	t9 --全量客户表	35
-- on t1.cst_id=t9.cust_id
-- and t9.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.act_sts_cd<>'C'  --剔除销户
AND   (T1.opn_org like  '3301%' or  T1.opn_org like  '9999%') --台州分行、总行营业部
and c3.cd_val_dscr regexp '单位活期存款'
;
-- 非柜额度（开户时非柜额度,最新非柜额度，非柜额度设置原因）
DROP   TABLE IF     EXISTS SJXQ_SJ2025040271_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040271_CST_02 AS
SELECT  t1.cst_act_id
       ,t1.opn_dt
       ,t2.leijiedu     AS 开户时非柜日累计限额
       ,t3.fg_day_lmt   AS 当前非柜日累计限额
       ,t3.edkzleix --额度控制类型
       ,t3.edshming --额度说明
       ,t3.beizhuxx
from (
    select cst_act_id,min(opn_dt) as opn_dt
    from SJXQ_SJ2025040271_CST_01
    group by cst_act_id
)  t1
left join edw.core_kdpa_zheddy t2 -- 负债账户额度定义表
on t1.cst_act_id=t2.cengcgjz
and t1.opn_dt=t2.dt
and t2.dt<= '@@{yyyyMMdd}'
AND     t2.zhxeleix = '2'          --账户限额类型 暂停非柜面
AND     t2.shijbhao = 'FGMXIANE'   --非柜面限额
AND     t2.edkzzhqi = '1D'         --额度控制周期
left join (
    SELECT  cengcgjz    cst_act_id
        ,leijiedu   fg_day_lmt --非柜日累计限额
        ,edkzleix	--	额度控制类型
        ,edshming	--	额度说明
        ,beizhuxx
    FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
    WHERE   dt = '@@{yyyyMMdd}'
    AND     zhxeleix = '2'          --账户限额类型 暂停非柜面
    AND     shijbhao = 'FGMXIANE'   --非柜面限额
    AND     edkzzhqi = '1D'         --额度控制周期
)t3 on t1.cst_act_id=t3.cst_act_id
;
-- 客户交易信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025040271_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040271_CST_03 AS
SELECT  t1.cst_id,t1.cst_act_id
    ,t3.dep_act_id
    ,t3.dtl_seq_nbr
    ,t3.crd_and_dbt_ind	    --借贷标志|C1
    ,t3.trx_dt
    ,t3.trx_amt
    ,t3.trx_chnl_cd	    --交易渠道代码|C3
    ,t3.dt
FROM SJXQ_SJ2025040271_CST_01              t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di  T3
ON  t1.dep_act_id=t3.dep_act_id
AND T3.dt >='20240401'
and t3.trx_dt between '@@{yyyyMMdd-1y}' and '@@{yyyyMMdd}'
and t3.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040271_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040271_CST_04 AS
SELECT  t1.cst_id           AS 客户号
       ,t1.cst_act_id       AS 客户账号
       ,t1.dep_act_id       AS 存款账号
       ,t1.act_nm           AS 账户名称
       ,t1.opn_org_nm       AS 开户机构
       ,t1.opn_dt           AS 开户日期
       ,t1.开户柜员
       ,t1.开户渠道
       ,t1.账户类型
       ,t1.账户状态
       ,t1.实虚户
    --    ,t1.sffydszh         AS 虚账户反映到实账户标志
    --    ,t1.virtual_cust_flg AS 虚拟客户标识
       ,t1.reg_adr          AS 注册地址
       ,t1.wrk_adr          AS 经营所在地地址
       ,t1.是否关闭非柜面
       ,t1.关闭非柜原因
       ,t1.是否止付
       ,t1.止付原因
       ,t1.是否冻结
       ,t1.冻结原因
       ,t2.开户时非柜日累计限额
       ,t2.当前非柜日累计限额
       ,t2.beizhuxx         AS 备注信息
    ,case when t3.cst_id is not null then 'Y' else '' end as 是否理财签约
    ,t4.chm_bal	as	理财产品余额
    ,case when t5.cst_id is not null then 'Y' else '' end as 是否有未结清贷款合同
    ,t5.ctr_bal as 贷款合同余额
    ,t6.cst_val_type as 客户价值等级
    ,t7.近6月非柜最大日累计使用额度
    ,t7.近12月非柜最大日累计使用额度
    ,t8.近6个月借方流水笔数
    ,t8.近6个月贷方流水笔数
    ,t8.近12个月借方流水笔数
    ,t8.近12个月贷方流水笔数
    ,case when t9.cst_id is not null then 'Y' else '' end as 是否开通电子银行
    ,t9.opn_chnl_nm as	开通渠道    -- 0 网上银行 4 手机银行
    ,t9.chnl_opn_tm	as  最近渠道开通时间
from SJXQ_SJ2025040271_CST_01       t1
left join SJXQ_SJ2025040271_CST_02  t2
on t1.cst_act_id=t2.cst_act_id
left join edw.dwd_bus_chm_ctr_inf_dd t3 --	理财客户签约信息
on  t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
and t3.sal_rcd_sts_cd = '0' --未解约
left join adm_pub.adm_csm_cbus_chm_inf_dd t4 --	客户集市-业务信息-客户理财业务信息表
on  t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join(
    select t1.cst_id                                   --客户号
        ,sum(t1.ctr_bal) as ctr_bal                                  --合同余额
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='@@{yyyyMMdd}'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by t1.cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    SELECT  t1.cst_id
        ,t1.cst_val_type
    FROM app_ado.adm_subl_cst_bus_inf_dd_khjz       t1  --客户价值
    WHERE t1.dt = '@@{yyyyMMdd}'
)t6 on t1.cst_id=t6.cst_id
left join (
    select cst_id
        ,max(case when trx_dt>='@@{yyyyMMdd-6m}' then trx_amt else 0 end) as 近6月非柜最大日累计使用额度
        ,max(case when trx_dt>='@@{yyyyMMdd-12m}' then trx_amt else 0 end) as 近12月非柜最大日累计使用额度
    from(
        select cst_id,trx_dt,sum(trx_amt) trx_amt
        from SJXQ_SJ2025040271_CST_03
        where trx_chnl_cd<>'A01'    --柜面
        group by cst_id,trx_dt
    )t group by cst_id
)t7 on t1.cst_id=t7.cst_id
left join(
    select cst_id
        ,count(case when trx_dt>='@@{yyyyMMdd-6m}' and crd_and_dbt_ind='D' then cst_id end) as 近6个月借方流水笔数
        ,count(case when trx_dt>='@@{yyyyMMdd-6m}' and crd_and_dbt_ind='C' then cst_id end) as 近6个月贷方流水笔数
        ,count(case when crd_and_dbt_ind='D' then cst_id end) as 近12个月借方流水笔数
        ,count(case when crd_and_dbt_ind='C' then cst_id end) as 近12个月贷方流水笔数
    from SJXQ_SJ2025040271_CST_03
    group by cst_id
)t8 on t1.cst_id=t8.cst_id
left join(
    SELECT cst_id
        ,max(chnl_opn_tm) as chnl_opn_tm
    from edw.dim_bus_chnl_elec_entp_inf_dd --电子银行企业客户渠道信息表
    where dt='@@{yyyyMMdd}'
    AND chnl_sts = '0'  --渠道状态正常
    GROUP BY  cst_id
)t9 ON  T1.cst_id=T9.cst_id
;
SElECT '04' seq, *
from SJXQ_SJ2025040271_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2025040271_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025040271_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025040271_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ2025040271_CST_04
;
/*
01	1913348	1913348
02	1913348	1913348
03	9305529	9305529
04	1913348	1913348
*/
***吴小薇_SJ2025041441_账号查流水.sql
-- 6214808801034475059、6214808801019075304 自20240411-20250411的交易流水（含IP、MAC电子账单）
-- 1. 账户信息表
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_01 as
select distinct cst_act_id,cst_id
	,act_nm	--	账户名称|C300
from edw.dws_bus_dep_act_inf_dd  	--存款账户信息汇总
where DT = '@@{yyyyMMdd}'
;
-- 银行账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_02 as
select bank_code1                               --开户行代码
	,self_acc_name                            --账户户名
	,acc_state                                --账户状态11：正常；12：其他
	,self_acc_no                              --账号表中每个账号一条记录，不能为空；如果只有卡号无账号，填写卡号，即账号与卡号一致
	,card_no                                  --卡号如开设账户有提供银行卡，应在本字段填写卡号，没有卡号为空。如果存在1个账号对应多个卡号（或多个账号对应1个卡）的情况，应按照账号与卡号的对应关系分多条记录全部列出
	,acc_type                                 --公私标识11：个人；12：单位
	,acc_type1                                --个人账户种类当Acc_type =11时填写：11：代表I类账户；12：代表II类账户；13：代表III类账户；14：代表信用卡账户
	,id_no                                    --身份证件号码个人客户按照表3Id_no字段、单位客户按照表4 License字段
	,cst_no                                   --客户号
	,fixed_flag                               --定活期标识10：活期；11：定期，12：其他
	,ent_cst_type                             --单位账户类型当Acc_type =12时填写，具体规范见附填写数字
	,frg_flag                                 --本外币标识10：仅本币；11：仅外币；12：通用
	,open_time                                --开户日期YYYYMMDD
	,close_time                               --销户日期YYYYMMDD
	,acc_flag                                 --银行卡收单账户标识11：是；12：否
	,credit_flag                              --借贷记卡标识11：借记卡；12：贷记卡；准贷记卡等具有贷记功能的填写12，卡号为空时不填写
	,w_type                                   --账户网银标识11：开通；12：未开通
	,bank_tel                                 --手机银行号码
	,open_type                                --开户标识11：柜面开户；12：非柜面开户
	,open_type1                               --开户标识111：代理；12：本人；13：批量开户（仅公私标识为个人11时填写）
	,agent_name                               --代理人姓名Agency_flag=11，即发生代理关系时填写
	,agent_tel                                --代理人联系方式Agency_flag=11，即发生代理关系时填写
	,agent_type                               --代理人身份证件种类Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,agent_no                                 --代理人身份证件号码Agency_flag=11，即发生代理关系时填写
	,open_type2                               --开户标识
	,acc_state_date                           -- 账户状态日期
	,is_act_same
	,dt
from(
	SELECT T1.*
		,CASE WHEN T1.self_acc_no=T2.cst_act_id then 1 else 0 end as is_act_same
		,ROW_NUMBER() over(partition by t2.cst_act_id order by t1.dt desc) rn
	from adm_upss.aml_t3r_acct   		t1                  --符合特定条件的银行账户信息表
	INNER JOIN SJXQ_SJ2025041441_CST_01 t2
	on T1.self_acc_no=T2.cst_act_id
	where t1.dt>='20241027'
)t1 where t1.rn=1
;
-- 2. 交易明细表 10号调查
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_03 as
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C200
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C200
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	,t1.late_upd_tm	                             --最后更新时间|C20
	,t1.glbl_srl_nbr	                         --全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS IP地址
    ,'个人' as data_src,t1.dt
    ,t1.hst_rtn_err_cd,t1.hst_rtn_err_dscr
from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
inner join SJXQ_SJ2025041441_CST_01 t5
on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20240411' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_dscr regexp '处理成功'
-- union all
-- select t1.chnl_typ_cd                              --渠道类型代码|C2
-- 	,t1.trx_seq                                  --交易流水号|C20
-- 	,t1.cst_id                                   --客户号|C10
-- 	,t1.trx_cd                                   --交易代码|C6
-- 	,t1.pmt_act_id                               --付款方账号|C30
-- 	,t1.pmt_act_nm                               --付款方户名|C300
-- 	-- ,pmt_org_id                               --付款方网点|C10
-- 	,t1.rcv_act_id                               --收款方账号|C32
-- 	,t1.rcv_act_nm                               --收款方户名|C300
-- 	,t1.rcv_opn_bnk                              --收款方开户行|C300
-- 	-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
-- 	,t1.ccy_cd                                   --币种|C3
-- 	,t1.usr_sbm_tm                               --用户提交时间|C14
-- 	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
-- 	-- ,rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
-- 	,t1.usr_cmt                                  --用户备注|C256
-- 	-- ,instr_sts_cd                             --指令状态代码|C2
-- 	,t1.late_upd_tm                              --最后更新时间|C20
-- 	,t1.glbl_srl_nbr	--	全局流水号|C40
-- 	,t1.cst_end_ip                               --客户端ip|C100
-- 	,t1.ovs_ind                                  --境外标志|C1
--     ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
-- 	,t1.cnr_nm                                   --国家名称|C200
-- 	,t1.pvc_nm                                   --省份名称|C200
-- 	,t1.cty_nm                                   --城市名称|C200
--     ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
--     ,CASE
--         WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
--         WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
--         WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
--         END                                                    AS mac
--     ,CASE
--         WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
--         WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
--         WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
--         END                                                    AS ip
--     ,'企业' as data_src,t1.dt
-- from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
-- inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
-- on  t1.cst_id = t3.cst_id
-- and t3.dt ='@@{yyyyMMdd}'
-- inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
-- on  t3.prm_org_id = t4.org_id
-- and t4.dt ='@@{yyyyMMdd}'
-- inner join SJXQ_SJ2025041441_CST_01 t5 on t1.cst_id=t5.cst_id
-- where t1.dt BETWEEN '20240411' and '@@{yyyyMMdd}'
-- and t1.hst_rtn_err_cd = '000000' --交易成功
;
-- 宁波分行 2022以来交易流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_04 as
SELECT  t1.dtl_seq_nbr                                                                                                                             AS 序号
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),1,10)                                                             AS 交易日期
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),11)                                                               AS 交易时间
       ,T11.sbr_org_nm                                                                                                                             AS 交易行名称
       ,CASE WHEN T2.cst_tp = '1' THEN '个人'
             WHEN T2.cst_tp = '2' THEN '单位' END                                                                                                    AS 公私标识
       ,T2.cst_id                                                                                                                                  --客户号
       ,T4.doc_nbr                                                                                                                                 AS 证件号码
       ,T1.cst_act_id                                                                                                                              AS 客户账号
       ,T1.dep_act_id                                                                                                                              AS 存款账号
       ,T1.act_nm                                                                                                                                  AS 账户名称
       ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1' THEN '个人银行结算账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END                                                                AS 账户类型
       ,CASE WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '301' THEN '1类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '302' THEN '2类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '303' THEN '3类账户' END                                                                      AS 账户类别
       ,CASE WHEN T1.cnt_pty_act_nm <> '' AND T1.cnt_pty_fin_instt_nm = '' AND T1.cnt_pty_fin_instt_typ_cd = '' THEN '支付账户等非银行账户'  ELSE '银行账户' END AS 交易对手方账户类别
       ,T1.cnt_pty_fin_instt_cd                                                                                                                    AS 交易对方行代码
       ,T1.cnt_pty_fin_instt_nm                                                                                                                    AS 交易对方行名称
       ,T1.cnt_pty_cst_act_id                                                                                                                      AS 交易对方账号
       ,T1.cnt_pty_act_nm                                                                                                                          AS 交易对方户名
       ,CASE WHEN T1.crd_and_dbt_ind = 'C' THEN '收'
             WHEN T1.crd_and_dbt_ind = 'D' THEN '付' END                                                     AS 资金收付标识
        ,CASE
                WHEN T1.csh_ind = '0' THEN '现金'
                ELSE '转账'
            END                                                                                  AS 现金转账标识
        ,T1.trx_ccy_cd                                                                        AS 币种
        ,T1.trx_amt                                                                           AS 原币种交易金额
        ,T1.trx_amt / 10000                                                                   AS 原币种交易金额万元
        ,T1.trx_amt * T5.usd_exr                                                              AS 折美元交易金额
        ,T1.trx_amt * T5.usd_exr / 10000                                                      AS 折美元交易金额万元
        ,T1.trx_amt * T5.cny_exr                                                              AS 折人民币交易金额
        ,T1.trx_amt * T5.cny_exr / 10000                                                      AS 折人民币交易金额万元
        ,T1.act_bal                                                                           AS 账户余额
        ,T1.act_bal / 10000                                                                   AS 账户余额万元
        ,CASE WHEN T1.agn_nm <> '' THEN '代理' ELSE '本人' END AS 代理交易标识
        ,T1.agn_nm                                                                            AS 代理人姓名
        ,T1.agn_psn_tel                                                                       AS 代理人联系方式
        ,c1.cd_val_dscr                                                                       AS 代理人身份证件种类
        ,T1.agn_doc_nbr                                                                       AS 代理人身份证件号码
        ,T1.tlr_srl_nbr                                                                       AS 业务流水号
        ,T1.opr_tlr                                                                           AS 柜员号
        ,T1.smr_dscr                                                                          AS 业务名称
        , CASE WHEN T1.rvs_ind = '1' THEN '是' ELSE '否' END AS 冲账标识
        ,T1.cmt                                                                               AS 摘要说明
        ,CASE
                WHEN c2.cd_val_dscr RLIKE '网上银行'  THEN '网银'
                WHEN c2.cd_val_dscr RLIKE '手机银行'  THEN '手机银行'
                WHEN c2.cd_val_dscr RLIKE '柜面|柜台' THEN '柜面'
                WHEN c2.cd_val_dscr = 'ATM'       THEN 'ATM机具'
                ELSE '其它'
            END                                                                                  AS 交易方式标识
        ,T9.atm_eqp_id                                                                        AS ATM机具编号
        ,T10.afl_org                                                                          AS ATM机具所属行行号
        ,T1.csh_ind,t1.crd_and_dbt_ind,t1.trx_dt,t1.trx_tm
FROM    edw.dwd_bus_dep_bal_chg_dtl_di    	T1 --存款余额发生明细
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
inner join SJXQ_SJ2025041441_CST_01    t0
on t1.cst_act_id=t0.cst_act_id
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t3.prm_org_id = t6.org_id
and t6.dt ='@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd     	T4 --客户基础信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20240411' and '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd    	c1 -- 码值表
ON      T1.agn_doc_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_CHM_FND_AIP_AGR_INF_DD' -- 基金定投协议信息
AND     c1.fld_nm = 'DOC_TYP_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd 	c2 -- 码值表
ON      T1.trx_chnl_cd = c2.cd_val
AND     c2.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c2.fld_nm = 'TRX_CHNL_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_chnl_atm_trx_srl_di T9 --ATM交易流水
ON      T1.cst_act_id = T9.prm_act_id
AND     T1.tlr_srl_nbr = T9.hst_srl_nbr
AND     T1.trx_dt = T9.trx_loc_dt
AND     T9.DT >= '20240411'
left JOIN (
    SELECT eqp_id,afl_org,dt
        ,ROW_NUMBER() over(partition by eqp_id order by dt desc) rn
    from edw.dim_bus_chnl_atm_eqp_inf_dd --ATM设备基本信息表
    where dt<='@@{yyyyMMdd}'
)T10 ON T9.atm_eqp_id = T10.eqp_id
AND     T10.rn=1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T11
ON      T1.trx_bus_org = T11.org_id
AND     T11.dt = '@@{yyyyMMdd}'
WHERE   T1.dt >= '20240411'
and     t1.trx_dt <='20250411'
AND     T1.trx_amt > 0
and     t1.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 流水关联
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_05 as
SELECT T1.业务流水号,T1.trx_dt,t1.trx_tm,t1.交易对方户名,t1.交易对方行名称,t1.客户账号,t1.原币种交易金额
    ,T6.glbl_srl_nbr
    ,t7.usr_sbm_tm,t7.rcv_act_nm,t7.rcv_opn_bnk,t7.pmt_act_id,t7.trx_amt
    ,t7.跨境交易标识
    ,t7.交易对方所在国家或地区
    ,t7.MAC或IMEI地址
    ,t7.IP地址
from (
    SELECT DISTINCT 业务流水号,trx_dt,trx_tm,交易对方户名
        ,交易对方行名称,客户账号,原币种交易金额
    from SJXQ_SJ2025041441_CST_04
) t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.业务流水号 = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20240411'
INNER join SJXQ_SJ2025041441_CST_03              t7
ON      T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND     T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_06 as
SELECT  DISTINCT 业务流水号
    ,trx_dt
    ,跨境交易标识
    ,交易对方所在国家或地区
    ,MAC或IMEI地址
    ,IP地址
FROM    SJXQ_SJ2025041441_CST_05
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_07 as
SELECT  t1.序号
        ,t1.交易日期
        ,t1.交易时间
        ,t1.交易行名称
        ,t1.公私标识
        ,T1.cst_id AS 客户号
        -- ,t1.证件号码
        ,t1.客户账号
        ,t1.存款账号
        ,t1.账户名称
        ,t1.账户类型
        ,t1.账户类别
        ,t1.交易对手方账户类别
        ,t1.交易对方行代码
        ,t1.交易对方行名称
        ,t1.交易对方账号
        ,t1.交易对方户名
        ,t1.资金收付标识
        ,t1.现金转账标识
        ,t1.币种
        ,t1.原币种交易金额
        ,t1.原币种交易金额万元
        ,t1.折美元交易金额
        ,t1.折美元交易金额万元
        ,t1.折人民币交易金额
        ,t1.折人民币交易金额万元
        ,t1.账户余额
        ,t1.账户余额万元
        ,t1.代理交易标识
        ,t1.代理人姓名
        --,t1.代理人联系方式
        --,t1.代理人身份证件种类
        --,t1.代理人身份证件号码
        ,t1.业务流水号
        ,t1.柜员号
        ,t1.业务名称
        ,t1.冲账标识
        ,t1.摘要说明
        ,t2.跨境交易标识
        ,t2.交易对方所在国家或地区
        ,t1.交易方式标识
        ,t2.IP地址
        ,t1.ATM机具编号
        ,t1.ATM机具所属行行号
        ,t2.MAC或IMEI地址
FROM SJXQ_SJ2025041441_CST_04      T1
left join SJXQ_SJ2025041441_CST_06 t2
on t1.业务流水号=t2.业务流水号
and t1.trx_dt=t2.trx_dt
;
-- 输出结果账户 敏感数据：手机银行号码、联系方式、身份证件种类
DROP   TABLE IF     EXISTS SJXQ_SJ2025041441_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041441_CST_08 as
SELECT  self_acc_name                                               AS 账户户名
        ,self_acc_no                                                AS 账号
        ,decode(w_type, '11','开通', '12','未开通')                  AS 账户网银标识
        -- ,bank_tel 													as 手机银行号码
        ,decode(open_type, '11','柜面开户', '12','非柜面开户')           AS 开户标识
        ,decode(open_type1,'11','代理', '12','本人', '13', '批量开户') AS 开户标识1
        ,agent_name                                                 AS 代理人姓名
        --,agent_tel                                                  AS 代理人联系方式   --Agency_flag=11，即发生代理关系时填写
        ,agent_type                                                 AS 代理人身份证件种类 --Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
        --,agent_no                                                   AS 代理人身份证件号码 --Agency_flag=11，即发生代理关系时填写
from SJXQ_SJ2025041441_CST_02
;
-- result
SElECT '07' seq, *
from lab_sjxq.SJXQ_SJ2025041441_CST_07
;
SElECT '08' seq, *
from lab_sjxq.SJXQ_SJ2025041441_CST_08
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041441_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct self_acc_no) custs
from SJXQ_SJ2025041441_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct glbl_srl_nbr) custs
from SJXQ_SJ2025041441_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ2025041441_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025041441_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025041441_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025041441_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ2025041441_CST_08
;
***吴小薇_SJ2025042871_近一年交易流水.sql
﻿/*
6214808801003400070
6222873300346680  ---这个是信用卡
6214808801035279872
4自20240425-20250425的交易流水（含IP、MAC电子账单）
*/
-- 客户账号交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2025042871_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042871_CST_01 as
select t1.cst_act_id                               --客户账号
	,t1.sub_act_seq_nbr                          --子账户序号
	,t1.trx_dt                                   --交易日期
	,t1.trx_tm                                   --交易时间
	,t1.crd_and_dbt_ind                          --借贷标志
	,t1.trx_amt                                  --交易金额
	,t1.act_bal                                  --账户余额
	,t1.txt_code                                 --摘要代码
	,t1.smr_dscr                                 --摘要描述
	,t1.dep_act_id                               --存款账号
	,t1.prod_id                                  --产品编号
    ,t2.pd_cmt	as	产品说明
	,t1.cnt_pty_cst_act_id                       --对方客户账号
	,t1.cnt_pty_act_nm                           --对方户名
	,t1.ext_trx_no                               --外部交易码
	,t1.int_trx_no                               --内部交易码
	,t1.tlr_srl_nbr                              --柜员流水号
	,t1.mtk_act_orig_tlr_srl_nbr                 --错账原柜员流水号
	,t1.trx_bus_org                              --交易营业机构
	,t1.trx_ccy_cd                               --交易币种代码
	,t1.act_cr_ind                               --账户钞汇标志
	,t1.aut_tlr                                  --授权柜员
    ,decode(t3.lbl_prod_typ_cd,'0','活期','1','定期') AS 存款类型
	,t1.cmt                                      --备注
	,t1.agn_nm                                   --代理人姓名
	,t1.agn_doc_typ_cd                           --代理人证件类型代码
	-- ,t1.agn_doc_nbr                              --代理人证件号码
	,t1.bal_fld_nm                               --余额字段名称
    ,t3.bal_gl_ind	as	余额总账同步标志
	,t1.vch_cls_cd                               --凭证种类代码
	,t1.vch_bch_nbr                              --凭证批号
	,t1.vch_seq_nbr                              --凭证序号
	,t1.cnt_pty_fin_instt_cd                     --对方金融机构代码
	,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称
	,t1.csh_ind                                  --现转标志
	,t1.act_nm                                   --账户名称
	,t1.dtl_seq_nbr                              --明细序号
	,t1.trx_chnl_cd                              --交易渠道代码
    ,t3.cst_id
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细
left join edw.dim_bus_dep_pd_bas_inf_dd	t2 --存款产品基础信息表
on t1.prod_id=t2.pd_id
and t2.dt='20250425'
inner join edw.dws_bus_dep_act_inf_dd  	t3 --存款账户信息汇总
on t1.dep_act_id=t3.dep_act_id
and t1.cst_act_id=t3.cst_act_id
and t3.DT = '20250425'
where t1.dt>='20240425' and t1.dt<='20250425'
;
-- IP mac 核查客户是否均为个人？？？
DROP   TABLE IF     EXISTS SJXQ_SJ2025042871_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042871_CST_02 as
select t1.tlr_srl_nbr,t1.trx_dt
    ,T6.glbl_srl_nbr
    ,t7.MAC地址
    ,t7.IP地址
    ,t7.dt
from(
    select distinct tlr_srl_nbr,trx_dt
    from SJXQ_SJ2025042871_CST_01
)t1 INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.tlr_srl_nbr = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20240425'
INNER join (
    select t1.late_upd_tm	                             --最后更新时间|C20
        ,t1.glbl_srl_nbr	                         --全局流水号|C40
        ,CASE
            WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
            WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
            WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
            END                                                    AS MAC地址
        ,CASE
            WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
            WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
            WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
            END                                                    AS IP地址
        ,t1.dt
    from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di     t1 --个人网银各渠道汇总流水信息
    inner join(
            SELECT DISTINCT cst_id from SJXQ_SJ2025042871_CST_01
    )t2 on t1.cst_id=t2.cst_id
    where t1.dt BETWEEN '20240425' and '20250425'
    and t1.hst_rtn_err_dscr regexp '处理成功'
)t7 ON T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND    T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
-- 信用卡交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2025042871_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042871_CST_03 as
select t1.cr_crd_act_id                            --信用卡账号|C32
	,t1.cr_crd_card_nbr                          --信用卡卡号|C32
	,t1.mch_seq_nbr                              --商户序号|N6
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C32
	,t1.trx_amt                                  --交易金额|DECIMAL(20,2)
	,t1.act_bal                                  --账户余额|DECIMAL(20,2)
	,t1.trx_typ_cd                               --交易类型代码|C32
	,t1.trx_typ_dscr                             --交易类型描述|C32
	,t1.cnt_pty_act_id                           --对方账号|C100
	,t1.cnt_pty_act_nm                           --对方户名|C200
	,t1.srl_nbr                                  --流水号|C32
	,t1.act_bel_org_id                           --账户所属机构号|C20 积分系统新增需求加字段 从20240227又值
	,t1.trx_ccy_cd                               --交易币种代码|C3
	,t1.trx_dscr_1                               --交易描述1|C64
	,t1.trx_dscr_2                               --交易描述2|C64
	,t1.cnt_pty_bnk_no                           --对方行号|C200
	,t1.cnt_pty_bnk_nm                           --对方行名|C200
    ,t2.cst_nm         AS 客户名称
	,t1.trx_chnl_nm                              --交易渠道名称|C100
	,t1.rtn_gds_and_flxb_instl_id                --退货和灵活分期标识|C32
	,t1.chnl_id                                  --渠道标识|C32
	,t1.ip                                       --IP
	,t1.mac                                      --MAC
    ,T3.pd_cd	        --	产品代码|C32
    ,T4.cr_crd_pd_cmt	--	信用卡产品说明|C20
from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di t1 --信用卡交易宽表
left join edw.dws_bus_crd_cr_crd_inf_dd      t2      --信用卡卡片信息汇总
on t1.cr_crd_card_nbr=t2.cr_crd_card_nbr
and t2.dt='20250425'
LEFT JOIN edw.dim_bus_crd_cr_crd_inf_dd     t3
ON T1.cr_crd_card_nbr=t3.cr_crd_card_nbr
and t3.dt='20250425'
LEFT JOIN edw.dim_bus_crd_cr_crd_pd_inf_dd	T4 --信用卡产品信息
ON T3.pd_cd=T4.cr_crd_pd_id
AND T4.DT='20250425'
where t1.dt>='20240425' and t1.dt<='20250425'
and t1.cr_crd_card_nbr='6222873300346680'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025042871_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042871_CST_04 as
select cr_crd_act_id                            --信用卡账号|C32
	,cr_crd_card_nbr                          --信用卡卡号|C32
	,srl_nbr                                  --流水号|C32
	,trx_typ_cd                               --交易类型代码|C32
	,trx_typ_dscr                             --交易类型描述|C32
	,trx_ccy_cd                               --交易币种代码|C3
	,trx_amt                                  --交易金额|DECIMAL(20,2)
	,trx_dt                                   --交易日期|C8
	,trx_tm                                   --交易时间|C32
	,wdw_rvs_ind                              --撤销冲正标志|C1
	,trx_brn                                  --交易网点|C12
	,trx_tlr                                  --交易柜员|C10
	,mon_id                                   --月份编号|C32
	,trx_ind                                  --交易标志|C10
	,chnl_id                                  --渠道标识|C32
	,rtn_gds_trx_id                           --退货交易标识|C32
	,trx_dscr_1                               --交易描述1|C64
	,trx_dscr_2                               --交易描述2|C64
	,mch_seq_nbr                              --商户序号|N6
from edw.dwd_bus_crd_cr_crd_trx_dtl_di   t1     --信用卡客户交易流水
where t1.dt>='20240425' and t1.dt<='20250425'
and t1.cr_crd_card_nbr='6222873300346680'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025042871_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042871_CST_05 as
select t1.cst_act_id                               as 客户账号
	,t1.sub_act_seq_nbr                          as 子账户序号
	,t1.trx_dt                                   as 交易日期
	,t1.trx_tm                                   as 交易时间
	,t1.crd_and_dbt_ind                          as 借贷标志
	,t1.trx_amt                                  as 交易金额
	,t1.act_bal                                  as 账户余额
	,t1.txt_code                                 as 摘要代码
	,t1.smr_dscr                                 as 摘要描述
	,t1.dep_act_id                               as 存款账号
	,t1.prod_id                                  as 产品编号
    ,t1.产品说明
	,t1.cnt_pty_cst_act_id                       as 对方客户账号
	,t1.cnt_pty_act_nm                           as 对方户名
	-- ,t1.ext_trx_no                               as 外部交易码
	,t1.int_trx_no                               as 内部交易码
	,t1.tlr_srl_nbr                              as 柜员流水号
	,t1.mtk_act_orig_tlr_srl_nbr                 as 错账原柜员流水号
	,t1.trx_bus_org                              as 交易营业机构
	,t1.trx_ccy_cd                               as 交易币种代码
	,t1.act_cr_ind                               as 账户钞汇标志
	,t1.aut_tlr                                  as 授权柜员
    ,t1.存款类型
	,t1.cmt                                      as 备注
	,t1.agn_nm                                   as 代理人姓名
	,t1.agn_doc_typ_cd                           as 代理人证件类型代码
	-- ,t1.agn_doc_nbr                              as 代理人证件号码
	,t1.bal_fld_nm                               as 余额字段名称
    ,t1.余额总账同步标志
	,t1.vch_cls_cd                               as 凭证种类代码
	,t1.vch_bch_nbr                              as 凭证批号
	,t1.vch_seq_nbr                              as 凭证序号
	,t1.cnt_pty_fin_instt_cd                     as 对方金融机构代码
	,t1.cnt_pty_fin_instt_nm                     as 对方金融机构名称
	,t1.csh_ind                                  as 现转标志
	,t1.act_nm                                   as 账户名称
	,t1.dtl_seq_nbr                              as 明细序号
	,t1.trx_chnl_cd                              as 交易渠道代码
    ,t2.IP地址
    ,t2.MAC地址
from SJXQ_SJ2025042871_CST_01       t1
left join SJXQ_SJ2025042871_CST_02  t2
on t1.tlr_srl_nbr=t2.tlr_srl_nbr
and t1.trx_dt=t2.tlr_srl_nbr
union all
select cr_crd_card_nbr                          --信用卡卡号
	,''
	,trx_dt                                   --交易日期
	,trx_tm                                   --交易时间
    ,''
	,trx_amt                                  --交易金额
	,act_bal                                  --账户余额
	,trx_typ_cd                               --交易类型代码
	,trx_typ_dscr                             --交易类型描述
    ,cr_crd_act_id                            --信用卡账号
    ,pd_cd	        --	产品代码
    ,cr_crd_pd_cmt	--	信用卡产品说明
	,cnt_pty_act_id                           --对方账号
	,cnt_pty_act_nm                           --对方户名
    ,''
	,srl_nbr                                  --流水号
    ,''
	,act_bel_org_id                           --账户所属机构号
	,trx_ccy_cd                               --交易币种代码
    ,'','',''
	,trx_dscr_1                               --交易描述1
    ,'','','','','','',''
	,cnt_pty_bnk_no                           --对方行号
	,cnt_pty_bnk_nm                           --对方行名
    ,''
    ,客户名称
    ,null
	,trx_chnl_nm                              --交易渠道名称
	,ip                                       --IP
	,mac                                      --MAC
from SJXQ_SJ2025042871_CST_03
;
SElECT '05' seq, *
from SJXQ_SJ2025042871_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025042871_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct tlr_srl_nbr,trx_dt) custs
from SJXQ_SJ2025042871_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025042871_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025042871_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025042871_CST_05
;
/*
01	1395	1395
02	1	1
03	23	1
04	23	1
05	1418	3
*/
***吴文雅_SJ2025041631_庆元村行贷款审批数据.sql
﻿-- 浙江庆元泰隆村镇银行 2025年1月-4月贷款审批数据，详见附件
DROP   TABLE IF     EXISTS SJXQ_SJ2025041631_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041631_CST_01 as
SELECT  t1.usc_aply_serno     AS 用信申请流水号
       ,t1.ahn_ltr_aply_serno AS 授用信申请流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.mgr_org_id         AS 管户机构编号
       ,t2.org_nm             as 管户机构
       ,t4.flow_starter       AS 流程发起者
       ,t4.flow_starter_name  AS 发起者姓名
       ,t4.start_time         AS 流程发起时间
       ,t4.org_id             AS 发起人机构id
       ,t4.biz_id             AS 业务流水号
       ,t9.aprv_id            AS 客户经理工号
       ,t9.aprv_nm            AS 客户经理姓名
       ,t10.aprv_id           AS 团队审查岗工号
       ,t10.aprv_nm           AS 团队审查岗姓名
       ,t10.aprv_drtn_min     AS 团队审查岗审批时长_分
       ,t10.user_comment      AS 团队审查岗审批意见
       ,t10.aprv_cnt          AS 团队审查岗审批次数
       ,t10.back_cnt          AS 团队审查岗退回次数
       ,t11.aprv_id           AS 团队总经理工号
       ,t11.aprv_nm           AS 团队总经理姓名
       ,t11.aprv_drtn_min     AS 团队总经理审批时长_分
       ,t11.user_comment      AS 团队总经理审批意见
       ,t11.aprv_cnt          AS 团队总经理审批次数
       ,t11.back_cnt          AS 团队总经理退回次数
       ,t12.aprv_id           AS 审批支行行长工号
       ,t12.aprv_nm           AS 审批支行行长姓名
       ,t12.aprv_drtn_min     AS 审批支行行长审批时长_分
       ,t12.user_comment      AS 审批支行行长审批意见
       ,t12.aprv_cnt          AS 审批支行行长审批次数
       ,t12.back_cnt          AS 审批支行行长退回次数
       ,t13.aprv_id           AS 市场部审查岗工号
       ,t13.aprv_nm           AS 市场部审查岗姓名
       ,t13.aprv_drtn_min     AS 市场部审查岗审批时长_分
       ,t13.user_comment      AS 市场部审查岗审批意见
       ,t13.aprv_cnt          AS 市场部审查岗审批次数
       ,t13.back_cnt          AS 市场部审查岗退回次数
       ,t14.aprv_id           AS 市场部总经理工号
       ,t14.aprv_nm           AS 市场部总经理姓名
       ,t14.aprv_drtn_min     AS 市场部总经理审批时长_分
       ,t14.user_comment      AS 市场部总经理审批意见
       ,t14.aprv_cnt          AS 市场部总经理审批次数
       ,t14.back_cnt          AS 市场部总经理退回次数
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.mgr_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '浙江庆元泰隆村镇银行'
inner join (
    SELECT t4.instance_id
        ,t4.flow_starter              --流程发起者
       ,t4.flow_starter_name          --发起者姓名
       ,t4.start_time                 --流程发起时间
       ,t4.org_id                     --发起人机构id
       ,t4.biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by t4.biz_id order by t4.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where t4.dt='@@{yyyyMMdd}'
    and SUBSTR(replace(t4.start_time,'/',''),1,8)>='20250101'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t4.rn=1
left join(
    SELECT t1.instance_id,t1.node_nm
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm regexp '客户经理'
    GROUP BY instance_id,node_nm
)t9 on t4.instance_id=t9.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队审查岗'
    GROUP BY instance_id,node_nm
)t10 on t4.instance_id=t10.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队总经理'
    GROUP BY instance_id,node_nm
)t11 on t4.instance_id=t11.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='支行行长'
    GROUP BY instance_id,node_nm
)t12 on t4.instance_id=t12.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='村行市场部审查岗'
    GROUP BY instance_id,node_nm
)t13 on t4.instance_id=t13.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='村行市场部总经理'
    GROUP BY instance_id,node_nm
)t14 on t4.instance_id=t14.instance_id
where t1.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, *
from SJXQ_SJ2025041631_CST_01
;
-- 01	1058	1058
SElECT '01' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from lab_bigdata_dev.SJXQ_SJ2025041631_CST_01
;
***吴文雅_SJ2025041866_庆元村行贷款审批数据.sql
-- 2024年10月-2025年3月贷款审批情况数据需求 庆元村行
-- 同一风险控制号在我行总敞口
DROP   TABLE IF     EXISTS SJXQ_SJ2025041866_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041866_CST_01 AS
SELECT  T1.CST_ID
       ,t1.EPSR_LMT     --客户敞口总额
       ,CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t5.sam_rsk_ctrl_id END AS cmn_rsk_ctrl_id
FROM
(
	SELECT  le.cst_id
	       ,SUM(le.EPSR_LMT) AS EPSR_LMT
	FROM edw.loan_lmt_exmp le
	INNER JOIN edw.loan_cst_bsc cb
	ON le.CST_ID = cb.CST_ID AND cb.DT = '@@{yyyyMMdd}'
	WHERE le.DEL_IND = '0'
	AND ( EXISTS (
	SELECT  1
	FROM edw.loan_lmt_use_rslt_rcd u
	WHERE u.SPLT_LMT_NO = le.SPLT_LMT_NO
	AND INI_OCP_FACL_AMT > ALRY_RSM_FACL_LMT
	AND OCP_STS = '1'
	AND U.DT = '@@{yyyyMMdd}' ) OR le.LMT_STS IN ( '01' , '02' ) ) AND LE.DT = '@@{yyyyMMdd}'
	GROUP BY  le.cst_id
) T1
LEFT JOIN edw.DWS_CST_BAS_INF_DD t5
ON T1.cst_id = t5.cst_id AND t5.dt = '@@{yyyyMMdd}'
;
--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025041866_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041866_CST_02 AS
SELECT  a.ctr_serno
       ,a.grnt_mod_colc
FROM
(
	SELECT  ctr_serno
        ,grnt_mod_colc
        ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc as grnt_mod_colc2
	WHERE dt = '@@{yyyyMMdd}'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.ctr_serno
         ,a.grnt_mod_colc
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041866_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041866_CST_03 AS
SELECT  T1.CST_ID
       ,t1.cst_nm
       ,T1.PRE_ASES_SERNO
       ,t1.aply_org_id        --申请机构号
       ,t1.sys_reg_tm         --系统登记时间
       ,t2.rul_set_rslt_nm    --新预评估结果
       ,t2.PRE_ASES_rul_nm    --预评估触发规则
       ,t2.PRE_ASES_prmpt_msg --预评估提示信息
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
	LEFT JOIN
	(
		SELECT  B1.rul_set_rslt_serno
		FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
		WHERE B1.DT = '@@{yyyyMMdd}'
		GROUP BY  B1.rul_set_rslt_serno
	) T3
	ON T2.rul_set_rslt_serno = T3.rul_set_rslt_serno
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
--流程审批意见
DROP   TABLE IF     EXISTS SJXQ_SJ2025041866_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041866_CST_04 AS
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.mgr_org_id         --管户机构编号
       ,t2.org_nm             --管户机构
       ,t3.ctr_serno          --合同号
       ,t3.ctr_bgn_dt         --合同起始日期
       ,t3.ctr_mtu_dt         --合同到期日期
       ,t3.ctr_amt            --合同金额
       ,t3.ctr_bal            --合同余额
       ,t3.exec_intr_rat      --执行利率
       ,t4.flow_starter       --流程发起者
       ,t4.flow_starter_name  --发起者姓名
       ,t4.start_time         --流程发起时间
       ,t4.org_id             --发起人机构id
       ,t4.biz_id             --业务流水号
       ,CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t5.sam_rsk_ctrl_id END AS cmn_rsk_ctrl_id
       ,t6.empe_id            --最终审批人工号
       ,t6.empe_nm            --最终审批人姓名
       ,t9.aprv_id            --客户经理工号
       ,t9.aprv_nm            --客户经理姓名
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.mgr_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '浙江庆元泰隆村镇银行'
left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD	t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
and t3.dt=t1.dt
inner join (
    SELECT t4.instance_id
        ,t4.flow_starter              --流程发起者
       ,t4.flow_starter_name          --发起者姓名
       ,t4.start_time                 --流程发起时间
       ,t4.org_id                     --发起人机构id
       ,t4.biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by t4.biz_id order by t4.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where t4.dt='@@{yyyyMMdd}'
    and SUBSTR(replace(t4.start_time,'/',''),1,8) between '20241001' and '20250331'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t4.rn=1
LEFT JOIN edw.DWS_CST_BAS_INF_DD t5
ON T1.CST_ID = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}'
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
left join(
    SELECT t1.instance_id,t1.node_nm
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm regexp '客户经理'
    GROUP BY instance_id,node_nm
)t9 on t4.instance_id=t9.instance_id
where t1.dt='@@{yyyyMMdd}'
;
-- 担保人预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041866_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041866_CST_05 AS
select t1.ctr_serno
    ,t2.busi_typ_cd     --1贷款业务
    ,t2.grnt_ctr_no
    ,t3.gtor_no                                  --保证人编号|c20
    ,t3.gtor_nm                                  --保证人名称|c200
    ,t4.rul_set_rslt_nm
from(
    select distinct ctr_serno
    from SJXQ_SJ2025041866_CST_04
)t1 inner join edw.dwd_bus_loan_ctr_rel_grnt_dd     t2       --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
INNER JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd    t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025041866_CST_03  t4
on t3.gtor_no=t4.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041866_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041866_CST_06 AS
SELECT  t1.usc_aply_serno     AS 用信申请流水号
       ,t1.ahn_ltr_aply_serno AS 授用信申请流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.cmn_rsk_ctrl_id    AS 同一风险控制号
       ,t2.同一风险控制号下客户敞口总额
       ,t1.ctr_serno          AS 合同号
       ,t1.ctr_bgn_dt         AS 合同起始日期
       ,t1.ctr_mtu_dt         AS 合同到期日期
       ,t1.ctr_amt            AS 合同金额
       ,t1.ctr_bal            AS 合同余额
       ,t1.exec_intr_rat      AS 合同执行利率
       ,t3.grnt_mod_nm        AS 担保方式
       ,t4.rul_set_rslt_nm    AS 借款人预评估结果
       ,t5.担保人预评估结果
       ,t1.mgr_org_id         AS 管户机构编号
       ,t1.org_nm             AS 管户机构
       ,t1.flow_starter       AS 流程发起者
       ,t1.flow_starter_name  AS 发起者姓名
       ,t1.start_time         AS 流程发起时间
       ,t1.org_id             AS 发起人机构id
       ,t1.biz_id             AS 业务流水号
       ,t1.aprv_id            AS 客户经理工号
       ,t1.aprv_nm            AS 客户经理姓名
       ,t1.empe_id            AS 最终审批人工号
       ,t1.empe_nm            AS 最终审批人姓名
from SJXQ_SJ2025041866_CST_04 t1
left join(
    select cmn_rsk_ctrl_id
        ,sum(EPSR_LMT) as     同一风险控制号下客户敞口总额
    from SJXQ_SJ2025041866_CST_01
    group by cmn_rsk_ctrl_id
)t2 on t1.cmn_rsk_ctrl_id=t2.cmn_rsk_ctrl_id
left join SJXQ_SJ2025041866_CST_02 t3
on t1.ctr_serno=t3.ctr_serno
left join SJXQ_SJ2025041866_CST_03  t4
on t1.cst_id=t4.cst_id
left join(
    select ctr_serno
    from SJXQ_SJ2025041866_CST_05
    group by ctr_serno
)t5 on t1.ctr_serno=t5.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041866_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041866_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041866_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041866_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025041866_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025041866_CST_06
***吴晓玲800141-SJ20240701226-取他行授信家数.sql
--吴晓玲800141-SJ20240701226-取他行授信家数
-- 个人：
-- edw.dws_cst_ccrc_idv_ind_inf_dd  ---- 个人
-- oth_bank_loan_org_num?  他行贷款授信机构数
-- 对公：
-- edw.dws_cst_ccrc_entp_ind_inf_dd --- 企业
-- oth_bank_busi_org_num? 他行授信机构数?
DROP TABLE IF EXISTS lab_bigdata_dev.SJ2024062566_01 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2024062566_01 AS
SELECT  t1.cst_id                 AS 客户号
        ,t1.report_dt             AS 征信报告日期
        ,t1.oth_bank_loan_org_num AS 他行授信家数
FROM    (
            SELECT  cst_id
                    ,report_dt
                    ,report_no
                    ,oth_bank_loan_org_num
                    ,row_number() OVER ( PARTITION BY cst_id ORDER BY report_dt DESC ) AS rn
            FROM    edw.dws_cst_ccrc_idv_ind_inf_dd
            WHERE   dt = '@@{yyyyMMdd}'
            AND     cst_id IN ( '8608529627' , '8607203453' , '7005184056' , '8000563796' , '2601062864' , '1009918109' , '7005240079' , '2609751571' , '7005224367' , '8000564339' , '7005396196' , '7005188797' , '7005318244' , '1003106353' , '7005345349' , '7649224937' , '8600100486' , '7005529873' , '8000564175' , '1018593339' , '7005194806' , '2614623593' , '2000496467' , '8000563455' , '1611241897' , '7005184607' , '1611823862' , '8600229611' , '7005183817' , '7005295466' , '8000563859' , '7005243184' , '8608132225' , '8600307620' , '7005204767' , '7005250230' , '7005206239' , '8000563493' , '8601313282' , '8000564144' , '7005218443' , '7005507934' , '7006352999' , '8000576808' , '8000564067' , '8000563549' , '1030159436' , '7005254522' , '7006276376' , '8000565857' , '8600647064' , '8000564795' , '8602555394' , '8000565415' , '2602335590' , '8600715063' , '2604657066' , '1003257918' , '8604594302' , '8000570981' , '2002628585' )
        ) t1
WHERE   t1.rn = 1
union
SELECT  t2.cst_id                 AS 客户号
        ,t2.report_dt             AS 征信报告日期
        ,t2.oth_bank_busi_org_num AS 他行授信家数
FROM    (
            SELECT  cst_id
                    ,report_dt
                    ,report_no
                    ,oth_bank_busi_org_num
                    ,row_number() OVER ( PARTITION BY cst_id ORDER BY report_dt DESC ) AS rn
            FROM    edw.dws_cst_ccrc_entp_ind_inf_dd
            WHERE   dt = '@@{yyyyMMdd}'
            AND     cst_id IN ( '8608529627' , '8607203453' , '7005184056' , '8000563796' , '2601062864' , '1009918109' , '7005240079' , '2609751571' , '7005224367' , '8000564339' , '7005396196' , '7005188797' , '7005318244' , '1003106353' , '7005345349' , '7649224937' , '8600100486' , '7005529873' , '8000564175' , '1018593339' , '7005194806' , '2614623593' , '2000496467' , '8000563455' , '1611241897' , '7005184607' , '1611823862' , '8600229611' , '7005183817' , '7005295466' , '8000563859' , '7005243184' , '8608132225' , '8600307620' , '7005204767' , '7005250230' , '7005206239' , '8000563493' , '8601313282' , '8000564144' , '7005218443' , '7005507934' , '7006352999' , '8000576808' , '8000564067' , '8000563549' , '1030159436' , '7005254522' , '7006276376' , '8000565857' , '8600647064' , '8000564795' , '8602555394' , '8000565415' , '2602335590' , '8600715063' , '2604657066' , '1003257918' , '8604594302' , '8000570981' , '2002628585' )
        ) t2
WHERE   t2.rn = 1
;
select * from lab_bigdata_dev.SJ2024062566_01
---把原来的字段带出来
--导入：qbi_file_20240704_19_49_13
--
DROP TABLE IF EXISTS lab_bigdata_dev.SJ2024062566_end PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2024062566_end AS
SELECT  t1.col_1   AS 序号
        ,t1.col_2  AS 客户名称
        ,t1.col_3  AS 客户号
        ,t1.col_4  AS 贷款种类
        ,t1.col_5  AS 担保方式
        ,t1.col_6  AS 授信金额万元
        ,t1.col_7  AS 授信期限
        ,t1.col_8  AS 贷款余额万元
        ,t1.col_9  AS 贷款发放日期
        ,t1.col_10 AS 贷款到期日期
        ,t1.col_11 AS 利率
        ,t1.col_12 AS 五级分类
        ,t2.他行授信家数
FROM    qbi_file_20240704_19_49_13 t1
LEFT JOIN    lab_bigdata_dev.SJ2024062566_01 t2
ON      t1.col_3 = t2.客户号
WHERE   t1.pt <> ''
***吴晓玲_SJ20250102261_他行授信家数.sql
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ20250102261_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250102261_CST_01
(
    seq         string COMMENT '序号'
    ,cst_id     string COMMENT '客户号'
)
;
insert into SJXQ_SJ20250102261_CST_01
;
-- 他行授信家数
DROP   TABLE IF EXISTS SJXQ_SJ20250102261_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ20250102261_CST_02 as
SELECT  t1.seq                   AS 序号
       ,t1.cst_id                AS 客户号
       ,t2.cred_busi_org_out_wjq AS 授信机构数_不含未激活
       ,t2.oth_bank_busi_org_num AS 他行授信机构数_不含未激活
       ,t2.oth_bank_loan_org_num AS 他行贷款授信机构数
       ,t2.cred_total_amt        AS 授信总额_信用总额
from SJXQ_SJ20250102261_CST_01 t1
left join (
    SELECT  t1.cst_id
        ,t1.report_no
        ,t1.report_dt                      --报告日期
        ,t1.cred_busi_org_out_wjq          --授信机构数（不含未激活）
        ,t1.oth_bank_busi_org_num          --他行授信机构数(不含未激活)
        ,t1.oth_bank_loan_org_num          --他行贷款授信机构数
        ,t1.cred_total_amt               --授信总额_信用总额
        ,row_number() over(partition by t1.cst_id order by t1.report_no desc) rn
    from edw.dws_cst_ccrc_idv_ind_inf_dd                t1 --个人征信指标信息表
    where t1.dt='@@{yyyyMMdd}'
    and t1.report_dsc_rn=1	--报告降序排序号
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250102261_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20250102261_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20250102261_CST_02
***吴晓玲_SJ20250102261_他行授信家数0107.sql
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ20250102261_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250102261_CST_01
(
    seq         string COMMENT '序号'
    ,cst_id     string COMMENT '客户号'
)
;
insert into SJXQ_SJ20250102261_CST_01
;
-- 他行授信家数
DROP   TABLE IF EXISTS SJXQ_SJ20250102261_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ20250102261_CST_02 as
SELECT  t1.seq                   AS 序号
       ,t1.cst_id                AS 客户号
       ,t2.oth_bank_loan_org_num AS 他行授信家数
from SJXQ_SJ20250102261_CST_01 t1
left join (
    SELECT  cst_id
            ,report_dt
            ,report_no
            ,oth_bank_loan_org_num
    from edw.dws_cst_ccrc_idv_ind_inf_dd                t1 --个人征信指标信息表
    where t1.dt='@@{yyyyMMdd}'
    and t1.report_dsc_rn=1	--报告降序排序号
    union
    SELECT  cst_id
            ,report_dt
            ,report_no
            ,oth_bank_busi_org_num
    FROM    edw.dws_cst_ccrc_entp_ind_inf_dd
    WHERE   dt = '@@{yyyyMMdd}'
    and report_dsc_rn=1	--报告降序排序号
)t2 on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250102261_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20250102261_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20250102261_CST_02
***吴智慧_SJ20250328116_合同担保人信息.sql
﻿--客群
DROP   TABLE IF     EXISTS SJXQ_SJ20250328116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250328116_CST_01 AS
SELECT  t1.nf
       ,t1.bc_no
       ,t1.cst_id
       ,t1.cst_nm
       ,t2.rel_cst_id   as 实控人或法人
       ,t2.rel_typ
from qbi_file_20250331_10_55_56_0   t1
left join(
    select t1.*,row_number() over(partition by t1.cst_id order by t1.rel_typ desc) rn
    from(
        SElECT cst_id,rel_cst_id,rel_typ
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
        union
        SElECT rel_cst_id,cst_id,rel_typ
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
    )t1 inner join edw.dws_cst_bas_inf_dd        t2 --客户基础信息汇总表
    on t1.rel_cst_id=t2.cst_id
    and t2.dt = '@@{yyyyMMdd}'
    and t2.cst_typ_cd='1'   --法人、实控人
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
where t1.pt<>''
;
-- 家人
DROP   TABLE IF     EXISTS SJXQ_SJ20250328116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250328116_CST_02 AS
select cst_id,rel_cst_id
    ,count(1) rel_cnt
from(
    SElECT cst_id,rel_cst_id,rel_typ
        ,decode(rel_typ,'0301','配偶' ,'0302','父母' ,'0303','子女' ,'0307','儿媳或女婿' ,'0308','公婆或岳父母') as rel_typ_nm
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    union
    SElECT rel_cst_id,cst_id,rel_typ
        ,decode(rel_typ,'0301','配偶' ,'0302','父母' ,'0303','子女' ,'0307','儿媳或女婿' ,'0308','公婆或岳父母') as rel_typ_nm
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
)t1 group by cst_id,rel_cst_id
;
-- 探索 关系比较乱
DROP   TABLE IF     EXISTS SJXQ_SJ20250328116_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250328116_CST_02_1 AS
SElECT t1.cst_id,t2.bth_dt
    ,t1.rel_cst_id,t3.bth_dt as bth_dt2
    ,t1.rel_typ
    ,decode(t1.rel_typ,'0301','配偶' ,'0302','父母' ,'0303','子女' ,'0307','儿媳或女婿' ,'0308','公婆或岳父母') as rel_typ_nm
    ,round(DATEDIFF(TO_DATE(t3.bth_dt,'yyyyMMdd'),TO_DATE(t2.bth_dt,'yyyyMMdd'),'dd')/365,1) as diff_y
from edw.loan_cst_rel               t1      --客户关联关系信息
left join edw.dim_cst_idv_bas_inf_dd        t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt = '@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        t3 --客户基础信息汇总表
on t1.rel_cst_id=t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
where t1.DT = '@@{yyyyMMdd}'
;
-- 保证人
DROP   TABLE IF     EXISTS SJXQ_SJ20250328116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250328116_CST_03 AS
SElECT t1.cst_id,t1.bc_no
    ,t1.实控人或法人
    ,t2.GRNT_CTR_NO
    ,t2.grnt_ctr_typ_cd	    --担保合同类型代码|c3
    ,t3.gtor_no                                  --保证人编号|c20
    ,t3.gtor_nm                                  --保证人名称|c200
    ,t3.with_brwr_rel                            --与借款人关系|c3
    ,c1.cd_val_dscr     as with_brwr_rel_nm
    ,t4.rel_typ_nm
    ,t3.eff_sts_cd                               --生效状态代码 0:待生效 1:已生效 2:已失效
    ,case when t5.cst_typ_cd='1' and substr(t5.doc_nbr,1,4)<>'3303' then 1 ELSE 0 END  AS is_out
from SJXQ_SJ20250328116_CST_01               t1
INNER JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.bc_no = t2.CTR_SERNO
and t2.dt='@@{yyyyMMdd}'
and t2.BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
INNER JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd   t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd c1
ON      t3.WITH_BRWR_REL = c1.cd_val
AND     c1.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ20250328116_CST_02     t4
on case when t1.rel_typ is not null then t1.实控人或法人 else t1.cst_id end = t4.cst_id
and t3.gtor_no=t4.rel_cst_id
left join edw.dws_cst_bas_inf_dd        t5 --客户基础信息汇总表
on t3.gtor_no=t5.cst_id
and t5.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250328116_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250328116_CST_04 AS
SELECT  t1.nf     as 年份
    ,t1.bc_no
    ,t1.cst_id
    ,t1.cst_nm
    ,case when t2.cst_typ_cd='1' and substr(t2.doc_nbr,1,4)<>'3303' then '是' ELSE '否' END  AS 借款人是否外地人
    ,case when t3.cst_id is not null then '是' ELSE '否' END  AS 是否第三方担保
    ,case when t3.is_out>0 then '是' ELSE '否' END  AS 第三方担保人是否外地人
    ,t3.with_brwr_rel_nm                            as 与借款人关系
from SJXQ_SJ20250328116_CST_01      t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt = '@@{yyyyMMdd}'
left join(
    select cst_id,bc_no
        ,sum(is_out) as is_out
    from SJXQ_SJ20250328116_CST_03
    where rel_typ_nm is null    --第三方担保
    GROUP BY cst_id,bc_no
) t3 on t1.bc_no=t3.bc_no
and t1.cst_id=t3.cst_id
;
SElECT '04' seq, *
from SJXQ_SJ20250328116_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct bc_no) custs
from SJXQ_SJ20250328116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ20250328116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct bc_no) custs
from SJXQ_SJ20250328116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct bc_no) custs
from SJXQ_SJ20250328116_CST_04
***吴智慧_SJ20250610101_量化风险等级.sql
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ20250610101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610101_CST_01 AS
select distinct t1.cst_id                                   --客户号
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '温州分行'
where t1.dt='20231231'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250610101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610101_CST_02 AS
select *
from(
    select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
        ,case when nvl(scor_rng,'')<>'' then scor_rng
                120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
        ,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
    from(
        SELECT  cst_id
            ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
            ,cr_sco_val                          AS cst_cr_grd_val
            ,'1中征分' sc_src,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20231231' and cr_sco_val<>0
        UNION
        SELECT  cst_id
            ,prd_dt
            ,cst_cr_grd_val
            ,'1中征分' sc_src,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20231231' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
            ,'2指标表' sc_src,scor_rng
        from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
        where dt='20231231' and report_dsc_rn=1
        and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
            ,'3集市表' sc_src
            ,case when cast(digital_unscr as int) <120 then '[0,120)'
                when cast(digital_unscr as int) >=1000 then '[1000,)'
                    120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
        from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
        where dt<='20231231' and nvl(digital_unscr,'')<>''
        and digital_unscr <> '-1'
    )t
)t1 where t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250610101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610101_CST_03 AS
SELECT  t1.cst_id              AS 客户号
       ,t2.scor_rng            AS 中征分段
       ,t3.risk_layer_level_10 AS 量化画像风险等级
from SJXQ_SJ20250610101_CST_01      t1
left join SJXQ_SJ20250610101_CST_02 t2
on t1.cst_id=t2.cst_id
left join(
    select cst_id
        ,risk_layer_level_10         --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20231231'
    union
    select cst_id
        ,RISK_MODEL_LEVEL_TEN       -- COMMENT '信用等级(10级)'
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20231231'
)t3 on t1.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250610101_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20250610101_CST_03
***吴智慧_SJ2025062531_量化风险等级.sql
-- 吴智慧_SJ2025062531_量化风险等级
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025062531_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062531_CST_01 AS
select distinct t1.cst_id   --客户号
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '温州分行'
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025062531_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062531_CST_02 AS
SELECT  t1.cst_id AS 客户号
       ,t2.dt     AS 日期
       ,t2.量化风险等级
from SJXQ_SJ2025062531_CST_01 t1
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id,dt
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    union
    select cst_id,dt
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
)t2 on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025062531_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025062531_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025062531_CST_02
***吴淑媛_SJ2025041686_信贷客户地址社区信息.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025041686_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041686_CST_01 AS
SELECT  col_1 --客户号
       ,col_2 --客户名称
       ,col_3 --合同起始日期
       ,col_4 --合同状态
       ,col_5 --管户机构号
       ,col_6 --管户机构名称
       ,col_7 --管户人工号
       ,col_8 --管户人姓名
from qbi_file_20250418_11_12_29_0
where pt<>''
;
-- 地址
DROP   TABLE IF     EXISTS SJXQ_SJ2025041686_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041686_CST_02 AS
SELECT  t1.cst_id
       ,t2.dtl_addr        AS 信贷经营地址
       ,t3.dtl_addr        AS 信贷户籍地址
       ,t4.dtl_addr        AS 信贷居住地址
       ,t5.dtl_addr        AS 信贷办公地址
       ,t6.dtl_addr        AS 信贷注册地址
       ,t7.dtl_addr        AS 信贷主地址
       ,c1.cd_val_dscr     AS 信贷主地址类型
from(
    select distinct col_1 as cst_id
    from SJXQ_SJ2025041686_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '@@{yyyyMMdd}' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '@@{yyyyMMdd}' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '@@{yyyyMMdd}' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --家庭地址
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}' and t5.del_ind='0' 	--未删除
AND t5.addr_typ = '050400' --办公地址
LEFT JOIN edw.loan_cst_ctc_addr t6
ON t1.cst_id = t6.cst_id and t6.del_ind='0' 	--未删除
AND t6.dt = '@@{yyyyMMdd}'
AND t6.addr_typ = '050800' --注册地址
LEFT JOIN edw.loan_cst_ctc_addr t7
ON t1.cst_id = t7.cst_id and t7.del_ind='0' 	--未删除
AND t7.dt = '@@{yyyyMMdd}'
AND t7.main_addr_ind = '1' --主地址
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t7.addr_typ=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041686_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041686_CST_03 AS
SELECT  t1.col_1                                 AS 客户号
    ,t1.col_2                                 AS 客户名称
    ,t1.col_3                                 AS 合同起始日期
    ,t1.col_4                                 AS 合同状态
    ,t1.col_5                                 AS 管户机构号
    ,t1.col_6                                 AS 管户机构名称
    ,t1.col_7                                 AS 管户人工号
    ,t1.col_8                                 AS 管户人姓名
    ,decode(t5.attach_flag,'0','手动','1','自动') AS 挂靠方式
    ,t6.sub_cmnt_id                           AS 子社区编号
    ,t7.cmnt_nm                               AS 子社区名称
    ,decode(t3.main_add_flag,'1','经营','2','通讯','3','家庭','4','户籍','') as 主地址类型
    ,t3.main_add	as	主地址
    ,t2.信贷主地址
    ,t2.信贷主地址类型
    ,t2.信贷经营地址
    ,t2.信贷户籍地址
    ,t2.信贷居住地址
    ,t2.信贷办公地址
    ,t2.信贷注册地址
from SJXQ_SJ2025041686_CST_01       t1
left join SJXQ_SJ2025041686_CST_02  t2
on t1.col_1=t2.cst_id
left join edw.xwdt_xw_customer      t3
on t1.col_1=t3.cust_no
and t3.dt = '@@{yyyyMMdd}'
left join edw.xwdt_xw_cust_com            t5 -- 客户与社区关联表
on t1.col_1=t5.cust_no
and t5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.col_1 = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025041686_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041686_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025041686_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025041686_CST_03
;
/*
select ' 客户与社区关联表' as tbl_nm
	,count(1) cnt
	,count(distinct cust_no) as 客户号
from edw.xwdt_xw_cust_com -- 客户与社区关联表
where dt='20241231';
*/
***吴雨伦_SJ2025020776_随贷通隐患客户排查.sql
﻿-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2025020776_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020776_CST_01 AS
SELECT  t1.col_1  --序号
       ,t1.col_2  --客户号
       ,t2.cst_id
       ,t2.cst_chn_nm	--客户姓名|C200
       ,t2.cst_typ_cd
from qbi_file_20250208_14_44_48_0 t1
left join edw.dws_cst_bas_inf_dd  t2 --客户基础信息汇总表
on t1.col_2=t2.cst_Id
and t2.dt='@@{yyyyMMdd}'
where t1.pt<>''
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025020776_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020776_CST_02 AS
SELECT  *
from(
	select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
		,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	from(
		SELECT  cst_id
			,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
			,cr_sco_val                          AS cst_cr_grd_val
			,'1中征分' sc_src
		FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
		WHERE dt <= '@@{yyyyMMdd}' and nvl(cr_sco_val,'')<>''
		UNION
		SELECT  cst_id
			,prd_dt
			,cst_cr_grd_val
			,'1中征分' sc_src
		FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
		WHERE dt <= '@@{yyyyMMdd}' and nvl(cst_cr_grd_val,'')<>''
		union
		SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
			,'2指标表' sc_src
		from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
		where dt='@@{yyyyMMdd}' and nvl(idv_crd_sco_val,'')<>''
		union
		SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
			,'3集市表' sc_src
		from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
		where dt<='@@{yyyyMMdd}'
		and nvl(digital_unscr,'')<>''
	)t
)t where rn=1
;
--个人征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025020776_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020776_CST_03 AS
select t1.report_id                                --报告编号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.dtrb_org                                 --发放机构|C60
	,t1.five_ctg_cd                              --五级分类代码|C60
	,t1.ctr_bal                                  --贷款余额|DECIMAL(16,2)
	,t1.ovd_amt                                  --逾期金额|DECIMAL(32,2)
	,t1.act_sts_cd                               --账户状态代码|C60
	,t1.act_typ_cd                               --账户类型代码|C60
from edw.dim_cst_ccrc_idv_loan_inf_dd           t1 --个人征信客户贷款信息
INNER JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd   t2 --个人征信指标信息表
ON      t2.report_no = t1.report_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.report_dsc_rn = 1
inner join SJXQ_SJ2025020776_CST_01             t3
on t1.cst_id=t3.cst_id
where t1.dt='@@{yyyyMMdd}'
-- AND ( ( T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) )
-- OR ( T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) ) )
;
--企业征信 未用到
DROP   TABLE IF     EXISTS SJXQ_SJ2025020776_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020776_CST_04 AS
select t1.cst_id                                   --客户号|C20
	,t1.report_id                                --报告编号|C32
	,t1.ovd_tot_amt                              --逾期总额|DECIMAL(15,2)
	,t1.ovd_prcp                                 --逾期本金|DECIMAL(15,2)
	,t1.dtrb_org_typ_cd                          --发放机构类型代码|C60
	,t1.five_ctg_cd                              --五级分类代码 --3 次级,4 可疑,5 损失
from edw.dim_cst_ccrc_entp_loan_inf_dd          t1 --企业征信客户贷款信息
INNER JOIN edw.dws_cst_ccrc_entp_ind_inf_dd	    t2 --企业征信指标信息表
ON      t2.report_no = t1.report_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.report_dsc_rn = 1
inner join SJXQ_SJ2025020776_CST_01             t3
on t1.cst_id=t3.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025020776_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020776_CST_05 AS
SELECT  t1.col_1  as 序号
       ,t1.col_2  as 客户号
       ,t2.cst_cr_grd_val as 客户最新一期中征分
	--    ,t3.ovd_prcp_bal
	   ,t4.ovd_loan_amt   as 我行逾期贷款金额
	   ,t5.征信我行逾期金额
	   ,t5.征信他行逾期金额
	   ,t5.征信不良贷款余额
from SJXQ_SJ2025020776_CST_01       t1
left join SJXQ_SJ2025020776_CST_02  t2
on t1.cst_id=t2.cst_id
-- left join (
-- 	select t1.cst_id                                   --核心客户编号
-- 		,sum(t1.ovd_prcp_bal) as ovd_prcp_bal          --逾期本金余额
-- 	from adm_rsk.adm_rsk_apl_inter_all          t1 --风险集市应用表-资产质量日常监测源表
-- 	where t1.dt='@@{yyyyMMdd}'
-- 	group by t1.cst_id
-- )t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbus_loan_inf_dd      t4   --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4. dt='@@{yyyyMMdd}'
left join(
	SELECT cst_id
		,sum(case when dtrb_org = 'ZJTLCB' then ovd_amt else 0 end) as 征信我行逾期金额
		,sum(case when dtrb_org <> 'ZJTLCB' then ovd_amt else 0 end) as 征信他行逾期金额
	from SJXQ_SJ2025020776_CST_03
	GROUP BY cst_id
)t5 on t1.cst_id=t5.cst_id
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025020776_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025020776_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025020776_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025020776_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025020776_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2025020776_CST_05
;
/*
01	48943	48943
02	3813310	3813309
03	2198293	48178
04	0	0
05	48943	48943
SELECT act_sts_cd,act_typ_cd                               --账户类型代码|C60、、
    ,count(1) cnt
from SJXQ_SJ2025020776_CST_03
GROUP BY act_sts_cd,act_typ_cd
*/
***吴雨伦_SJ2025030481_随贷通隐患客户排查.sql
﻿-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025030481_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030481_CST_01 AS
SELECT  t1.col_1  --客户号
       ,t1.col_2  --客户名称
       ,t2.cst_id
       ,t2.cst_chn_nm	--客户姓名|C200
       ,t2.cst_typ_cd
from qbi_file_20250304_14_49_11_0 t1
left join edw.dws_cst_bas_inf_dd  t2 --客户基础信息汇总表
on t1.col_1=t2.cst_Id
and t2.dt='@@{yyyyMMdd}'
where t1.pt<>''
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025030481_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030481_CST_02 AS
SELECT  *
from(
	select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
		,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	from(
        SELECT  cst_id
            ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
            ,cr_sco_val                          AS cst_cr_grd_val
            ,'1中征分' sc_src
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
        UNION
        SELECT  cst_id
            ,prd_dt
            ,cst_cr_grd_val
            ,'1中征分' sc_src
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
            ,'2指标表' sc_src
        from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
        where dt='@@{yyyyMMdd}' and report_dsc_rn=1
        and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
            ,'3集市表' sc_src
        from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
        where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
        and digital_unscr <> '-1'
	)t
)t where rn=1
;
--个人征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025030481_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030481_CST_03 AS
select t1.report_id                                --报告编号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.dtrb_org                                 --发放机构|C60
	,t1.five_ctg_cd                              --五级分类代码|C60
	,t1.ctr_bal                                  --贷款余额|DECIMAL(16,2)
	,t1.ovd_amt                                  --逾期金额|DECIMAL(32,2)
	,t1.act_sts_cd                               --账户状态代码|C60
	,t1.act_typ_cd                               --账户类型代码|C60
from edw.dim_cst_ccrc_idv_loan_inf_dd           t1 --个人征信客户贷款信息
INNER JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd   t2 --个人征信指标信息表
ON      t2.report_no = t1.report_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.report_dsc_rn = 1
inner join SJXQ_SJ2025030481_CST_01             t3
on t1.cst_id=t3.cst_id
where t1.dt='@@{yyyyMMdd}'
;
--企业征信 未用到
DROP   TABLE IF     EXISTS SJXQ_SJ2025030481_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030481_CST_04 AS
select t1.cst_id                                   --客户号|C20
	,t1.report_id                                --报告编号|C32
	,t1.ovd_tot_amt                              --逾期总额|DECIMAL(15,2)
	,t1.ovd_prcp                                 --逾期本金|DECIMAL(15,2)
	,t1.dtrb_org_typ_cd                          --发放机构类型代码|C60
	,t1.five_ctg_cd                              --五级分类代码 --3 次级,4 可疑,5 损失
from edw.dim_cst_ccrc_entp_loan_inf_dd          t1 --企业征信客户贷款信息
INNER JOIN edw.dws_cst_ccrc_entp_ind_inf_dd	    t2 --企业征信指标信息表
ON      t2.report_no = t1.report_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.report_dsc_rn = 1
inner join SJXQ_SJ2025030481_CST_01             t3
on t1.cst_id=t3.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030481_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030481_CST_05 AS
SELECT  t1.col_1  as 序号
       ,t1.col_2  as 客户号
       ,t2.prd_dt as 客户最新征信获取日期
       ,t2.cst_cr_grd_val as 客户最新一期中征分
	   ,t4.ovd_loan_amt   as 我行逾期贷款金额
	   ,t5.征信我行逾期金额
	   ,t5.征信他行逾期金额
	   ,t5.征信不良贷款余额
       ,t8.max_tsk_gen_dt as 最近一次处置类精准贷后触发时间
       ,t8.触发规则分类,t8.触发规则,t8.触发原因分析
from SJXQ_SJ2025030481_CST_01       t1
left join SJXQ_SJ2025030481_CST_02  t2
on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbus_loan_inf_dd      t4   --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4. dt='@@{yyyyMMdd}'
left join(
	SELECT cst_id
		,sum(case when dtrb_org = 'ZJTLCB' then ovd_amt else 0 end) as 征信我行逾期金额
		,sum(case when dtrb_org <> 'ZJTLCB' then ovd_amt else 0 end) as 征信他行逾期金额
	from SJXQ_SJ2025030481_CST_03
	GROUP BY cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
	SELECT  T1.cst_id       --客户号
			,T2.tsk_gen_dt as max_tsk_gen_dt  --最近一次触碰精准贷后_处置类时间
			,t3.触发规则分类,t3.触发规则,t3.触发原因分析
			,ROW_NUMBER() over(partition by t1.cst_id order by T2.tsk_gen_dt desc ) rn
	FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
	INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
	ON      T1.btch_serno = T2.btch_serno
	AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
	AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
	AND     T2.DT = '@@{yyyyMMdd}'
	LEFT JOIN    (
		SELECT  A1.btch_serno
				,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)  AS 触发规则分类
				,A1.rul_nm               AS 触发规则
				,A1.trg_rsn_anls         AS 触发原因分析
				,A1.rul_ctg_nm --规则分类名称
				,A1.rul_sub_clss_nm --规则细类名称
				,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
		FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
		WHERE   A1.DT = '@@{yyyyMMdd}'
	) T3
	ON      T1.btch_serno = T3.btch_serno
	AND     T3.RN = 1
	WHERE   T1.DT = '@@{yyyyMMdd}'
)t8 on t1.cst_Id=t8.cst_Id
and t8.rn=1
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025030481_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030481_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030481_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030481_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030481_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2025030481_CST_05
;
/*
01	47352	47352
02	3589560	3589559
03	2144739	46629
04	0	0
05	47352	47352
*/***吴雨伦_SJ2025031926_征信分段.sql
-- 导入
DROP   TABLE IF     EXISTS SJXQ_SJ2025031926_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031926_CST_01 AS
SELECT  col_1  --客户号
       ,col_2  --客户名称
from qbi_file_20250320_14_57_45_0
where pt<>''
;
-- 征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025031926_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031926_CST_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='@@{yyyyMMdd}' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031926_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031926_CST_03 AS
SELECT  t1.col_1            AS 客户号
       ,t1.col_2            AS 客户名称
       ,t2.prd_dt           AS 客户最新征信获取日期
       ,t2.scor_rng         AS 客户最新一期中征分段
       ,T3.RISK_MODEL_LEVEL AS 个人信用风险等级
       ,T4.RISK_MODEL_LEVEL AS 企业信用风险等级
from SJXQ_SJ2025031926_CST_01       t1
left join SJXQ_SJ2025031926_CST_02  t2
on t1.col_1=t2.cst_id
and t2.rn=1
LEFT JOIN    lab_bigdata_dev.quant_portr_upper_idv_cst_credit_score_bas_info T3
ON      T1.col_1 = T3.CST_ID
LEFT JOIN    lab_bigdata_dev.quant_portr_upper_entp_cst_credit_score_bas_info T4
ON      T1.col_1 = T4.CST_ID
;
SElECT '03' seq, *
from SJXQ_SJ2025031926_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025031926_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025031926_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025031926_CST_03
***吴雨伦_SJ20250509106_杭州分行随贷通流失挽回.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250509106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250509106_CST_01 AS
SELECT  t1.col_1 --流失年份
       ,t1.col_2 --流失日期
       ,case when t1.col_3='#N/A' then t5.ctr_serno else t1.col_3 end as col_3 --合同编号
       ,t1.col_4 --客户号
       ,t1.col_5 --客户名称
from lab_bigdata_dev.qbi_file_20250514_09_00_29_0 t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t5 --合同基础信息
on t1.col_4=t5.cst_id
and SUBSTR(REPLACE(t1.col_2,'-',''),1,8)=t5.ctr_mtu_dt
and t5.dt='@@{yyyyMMdd}'
and t5.cst_id in ( '1606789099' , '1019296785' , '1006312201' , '1014813507'
    , '1015123247' , '1023887656' , '1618872933' , '1612875596' )
where t1.pt<>''
;
-- 20170101以来是否有逾期
DROP   TABLE IF     EXISTS SJXQ_SJ20250509106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250509106_CST_02 AS
select t1.DBIL_ID                                  --借据编号|C64
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.OVD_AMT                                  --逾期金额DECIMAL(21,2)
	,t1.ONBS_OVD_INTR_BAL                        --表内欠息余额DECIMAL(21,2)
	,t1.OFBS_OVD_INTR_BAL                        --表外欠息余额DECIMAL(21,2)
	,t1.OVD_DAY                                  --逾期天数
	,t1.OVD_INTR_DAY                             --欠息天数
    ,t1.ovd_dt
    ,t1.ovd_intr_dt
    ,case when t1.OVD_AMT>0 then '1本金逾期'
        when t1.ONBS_OVD_INTR_BAL+t1.OFBS_OVD_INTR_BAL>0 then '2利息逾期'
        when t1.OVD_DAY>0 then '3本金逾期天数非0'
        when t1.OVD_INTR_DAY>0 then '4利息逾期天数非0' else '' end as ovd_type
    ,t1.dt
    ,row_number() over(partition by t1.cst_id order by t1.dt desc,t1.DBIL_ID desc) rn
from edw.dim_bus_loan_dbil_inf_dd       t1 --信贷借据信息
inner join SJXQ_SJ20250509106_CST_01    t2
on t1.CTR_SERNO=t2.col_3
where t1.dt<='@@{yyyyMMdd}' and t1.dt>='20170101'
and (t1.OVD_AMT>0 or t1.ONBS_OVD_INTR_BAL+t1.OFBS_OVD_INTR_BAL>0 or t1.OVD_DAY>0 or t1.OVD_INTR_DAY>0)
;
-- 20170101以来是否触发过处置类精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ20250509106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250509106_CST_03 AS
SELECT  T1.cst_id                       --客户号
        ,MAX(T2.tsk_gen_dt) as prc_pst_dt    --最近一次触碰精准贷后_处置类时间
        ,'new' as tbl_type
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd        T1 --贷后检查批次信息表
INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd   T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
AND     T2.DT = '@@{yyyyMMdd}'
and     T2.tsk_gen_dt >= '20170101'
INNER JOIN(
    SELECT distinct col_4 AS CST_ID FROM SJXQ_SJ20250509106_CST_01
)T3 ON T1.CST_ID=T3.CST_ID
WHERE   T1.DT = '@@{yyyyMMdd}'
GROUP BY T1.CST_ID
UNION ALL
SELECT  T1.cst_id
        ,MAX(T1.start_dt) as lst_czl_jzdt --任务生成日期
        ,'old' as tbl_type
FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd T1 --精准贷后-任务宽表
INNER JOIN(
    SELECT distinct col_4 AS CST_ID FROM SJXQ_SJ20250509106_CST_01
)T3 ON T1.CST_ID=T3.CST_ID
WHERE T1.dt = '20240719'
AND T1.trg_typ = '2处置' --'1预警', '2处置'
and t1.start_dt >= '20170101'
GROUP BY  T1.cst_id
;
--征信分段
DROP   TABLE IF     EXISTS SJXQ_SJ20250509106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250509106_CST_04 AS
select cst_id,prd_year,prd_dt,scor_rng AS zx_score
from(
    select cst_id,substr(prd_dt,1,4) as prd_year
        ,prd_dt ,cst_cr_grd_val,sc_src
        ,case when nvl(scor_rng,'')<>'' then scor_rng
                120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
        ,row_number() over(partition by cst_id,substr(prd_dt,1,4) order by prd_dt desc,sc_src) rn
    from(
        SELECT cst_id,REPLACE(substr(report_dt,1,10),'-','') as prd_dt,idv_crd_sco_val as cst_cr_grd_val
            ,'2指标表' sc_src,scor_rng
        from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
        where dt='@@{yyyyMMdd}'
        and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
            ,'3集市表' sc_src
            ,case when cast(digital_unscr as int) <120 then '[0,120)'
                when cast(digital_unscr as int) >=1000 then '[1000,)'
                    120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
        from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
        where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
        and digital_unscr <> '-1'
    )t
)t where t.rn=1
;
--中征分段
DROP   TABLE IF     EXISTS SJXQ_SJ20250509106_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250509106_CST_05 AS
select cst_id,prd_year,prd_dt,scor_rng AS zz_score
from(
    select cst_id,substr(prd_dt,1,4) as prd_year
        ,prd_dt ,cst_cr_grd_val,sc_src
        ,case when nvl(scor_rng,'')<>'' then scor_rng
                120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
        ,row_number() over(partition by cst_id,substr(prd_dt,1,4) order by prd_dt desc,sc_src) rn
    from(
        SELECT  cst_id
            ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
            ,cr_sco_val                          AS cst_cr_grd_val
            ,'1中征分' sc_src,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
        UNION
        SELECT  cst_id
            ,prd_dt
            ,cst_cr_grd_val
            ,'1中征分' sc_src,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
    )t
)t where t.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250509106_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250509106_CST_06 AS
SELECT  t1.col_1 as 流失年份
       ,t1.col_2 as 流失日期
       ,t1.col_3 as 合同编号
       ,t1.col_4 as 客户号
       ,t1.col_5 as 客户名称
       ,case when t2.cst_id is not null then '是' else '' end as 20170101以来是否有逾期
       ,case when t3.cst_id is not null then '是' else '' end as 20170101以来是否触发过处置类精准贷后
	,decode(t4.gdr_cd,'1','男','2','女','')     as 性别
	,t4.bth_dt                                  as 出生日期
    ,t5.prd_no
    ,e1.empe_nm         as 管户人
    ,e2.empe_nm         as 经办人
    ,t6.sys_reg_tm as 客户最近一次的预评估时间
    ,zx1.zx_score as 2019年征信分段
    ,zx2.zx_score as 2020年征信分段
    ,zx3.zx_score as 2021年征信分段
    ,zx4.zx_score as 2022年征信分段
    ,zx5.zx_score as 2023年征信分段
    ,zx6.zx_score as 2024年征信分段
    ,zx7.zx_score as 2025年征信分段
    ,zz1.zz_score as 2019年中征分段
    ,zz2.zz_score as 2020年中征分段
    ,zz3.zz_score as 2021年中征分段
    ,zz4.zz_score as 2022年中征分段
    ,zz5.zz_score as 2023年中征分段
    ,zz6.zz_score as 2024年中征分段
    ,zz7.zz_score as 2025年中征分段
    ,zx1.prd_dt as 2019年征信分日期
    ,zx2.prd_dt as 2020年征信分日期
    ,zx3.prd_dt as 2021年征信分日期
    ,zx4.prd_dt as 2022年征信分日期
    ,zx5.prd_dt as 2023年征信分日期
    ,zx6.prd_dt as 2024年征信分日期
    ,zx7.prd_dt as 2025年征信分日期
    ,zz1.prd_dt as 2019年中征分日期
    ,zz2.prd_dt as 2020年中征分日期
    ,zz3.prd_dt as 2021年中征分日期
    ,zz4.prd_dt as 2022年中征分日期
    ,zz5.prd_dt as 2023年中征分日期
    ,zz6.prd_dt as 2024年中征分日期
    ,zz7.prd_dt as 2025年中征分日期
from SJXQ_SJ20250509106_CST_01      t1
left join SJXQ_SJ20250509106_CST_02 t2
on t1.col_4=t2.cst_id and t2.rn=1
left join (
    select distinct cst_id
    from SJXQ_SJ20250509106_CST_03
) t3 on t1.col_4=t3.cst_id
left join edw.dim_cst_idv_bas_inf_dd        t4 --个人客户基本信息
on t1.col_4=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_bse_inf_dd   t5 --合同基础信息
on t1.col_3=t5.ctr_serno
and t5.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            e1 --员工信息汇总
on  t5.mgr_id=e1.empe_id
and e1.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            e2 --员工信息汇总
on  t5.hdl_opr_id=e2.empe_id
and e2.dt='@@{yyyyMMdd}'
left join(
	SELECT  CST_ID
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
)t6 on t1.col_4=t6.cst_id and t6.rn=1
left join SJXQ_SJ20250509106_CST_04 zx1 on t1.col_4=zx1.cst_id and zx1.prd_year='2019'
left join SJXQ_SJ20250509106_CST_04 zx2 on t1.col_4=zx2.cst_id and zx2.prd_year='2020'
left join SJXQ_SJ20250509106_CST_04 zx3 on t1.col_4=zx3.cst_id and zx3.prd_year='2021'
left join SJXQ_SJ20250509106_CST_04 zx4 on t1.col_4=zx4.cst_id and zx4.prd_year='2022'
left join SJXQ_SJ20250509106_CST_04 zx5 on t1.col_4=zx5.cst_id and zx5.prd_year='2023'
left join SJXQ_SJ20250509106_CST_04 zx6 on t1.col_4=zx6.cst_id and zx6.prd_year='2024'
left join SJXQ_SJ20250509106_CST_04 zx7 on t1.col_4=zx7.cst_id and zx7.prd_year='2025'
left join SJXQ_SJ20250509106_CST_05 zz1 on t1.col_4=zz1.cst_id and zz1.prd_year='2019'
left join SJXQ_SJ20250509106_CST_05 zz2 on t1.col_4=zz2.cst_id and zz2.prd_year='2020'
left join SJXQ_SJ20250509106_CST_05 zz3 on t1.col_4=zz3.cst_id and zz3.prd_year='2021'
left join SJXQ_SJ20250509106_CST_05 zz4 on t1.col_4=zz4.cst_id and zz4.prd_year='2022'
left join SJXQ_SJ20250509106_CST_05 zz5 on t1.col_4=zz5.cst_id and zz5.prd_year='2023'
left join SJXQ_SJ20250509106_CST_05 zz6 on t1.col_4=zz6.cst_id and zz6.prd_year='2024'
left join SJXQ_SJ20250509106_CST_05 zz7 on t1.col_4=zz7.cst_id and zz7.prd_year='2025'
;
SElECT '01' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ20250509106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250509106_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250509106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,prd_year) custs
from SJXQ_SJ20250509106_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,prd_year) custs
from SJXQ_SJ20250509106_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同编号) custs
from SJXQ_SJ20250509106_CST_06
;
SElECT '06' seq, *
from SJXQ_SJ20250509106_CST_06
***吴雨伦_SJ20250626116_授信客户他行逾期数据.sql
﻿-- 吴雨伦_SJ20250626116_授信客户他行逾期数据
DROP   TABLE IF EXISTS SJXQ_SJ20250626116_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250626116_CST_01
(
    seq         string COMMENT ''
    ,cst_id     string COMMENT ''
)
;
insert into SJXQ_SJ20250626116_CST_01
;
-- 我行逾期或不良贷款余额	客户最新一期征信日期	客户征信中他行逾期或不良贷款余额
DROP   TABLE IF     EXISTS SJXQ_SJ20250626116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250626116_CST_02 AS
SELECT  t1.seq       AS 序号
    ,t1.cst_id       AS 客户号
    ,t2.ovd_loan_amt AS 我行逾期贷款金额
    ,t3.ovd_prcp_bal as 随贷通逾期本金余额
    ,t3.bad_prcp_bal AS 随贷通不良本金余额
    ,t4.report_dt    AS 客户最新一期征信日期
    ,t4.c_od_amt     AS 他行逾期或不良贷款余额
from SJXQ_SJ20250626116_CST_01  t1
left join adm_pub.adm_csm_cbus_loan_inf_dd	t2 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join(
    SELECT cst_id
        ,sum(ovd_prcp_bal) as ovd_prcp_bal
        ,sum(bad_prcp_bal) as bad_prcp_bal
    from edw.dws_bus_loan_fnc_crd_acm_inf_dd
    where dt='@@{yyyyMMdd}'
    GROUP BY cst_id
) t3 --随贷通累计汇总信息
on t1.cst_id=t3.cst_id
left join(
    -- 征信 征信分 dws_cst_ccrc_idv_ind_inf_di
    select cst_id,report_dt	--报告日期
        ,'个人' as cst_type
        ,c_od_amt	--	当前逾期总额
    from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1
    union all
    select cst_id,report_dt	--报告日期
        ,'企业'
        ,un_sett_bad_cl_total_balan	--	未结清不良信贷信用总余额
    from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1
)t4 on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct seq,cst_id) custs
from SJXQ_SJ20250626116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 序号,客户号) custs
from SJXQ_SJ20250626116_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20250626116_CST_02
***周慧美_SJ2025051581_衢州分行合同要素变更.sql
-- 截止2025.5.14衢州分行贷后循环贷款与随贷通合同要素变更，审批状态是已批准，任务状态是未完成清单
--结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025051581_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051581_CST_01 AS
select t1.mdf_serno                                --变更流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_serno                                --合同流水号
	,t1.mdf_sub_clss                             --变更细类
	,t1.pst_loan_mdf_typ_colc                    --贷后变更类型集合
	,t1.prd_no                                   --产品编号
	,c1.pd_nm 			as 产品名称
	,t1.mdf_rsn_dscr                             --变更原因描述
	,t1.aprv_sts                                 --审批状态 01:待提交|02:审批中|03:已退回补充资料|04:已退回|05:已批准|06:已否决|07:已取消|08:已终止
	,t1.tsk_sts                                  --任务状态 0:未完成|1:已完成|2:作废|3:处理中
	,t1.arcv_dt                                  --归档日期
	,t1.rvlg_typ                                 --循环类型
	,t1.lgp_id                                   --法人编号
	,t1.sys_reg_psn                              --系统登记人
	,c2.empe_nm 		as 系统登记人
	,t1.sys_reg_org                              --系统登记机构
	,c3.org_nm 			as 系统登记机构
	,t1.sys_reg_tm                               --系统登记时间
	,substr(replace(t1.sys_reg_tm,'-',''),1,8) 	as 变更申请日期
	,t2.mgr_id                                   --管户人工号
	,c4.empe_nm 		as 管户人
	,t2.mgr_sts                                  --管户状态
	,t2.aply_dt                                  --申请日期
	,t2.nvld_dt                                  --失效日期
	,t2.mgr_org                                  --管户机构
	,t3.org_nm 			as 管户机构
from edw.loan_psp_ctr_mdf_rcd t1 --合同要素变更记录
inner join edw.loan_cst_mgr   t2 --客户管户信息
on t1.cst_id=t2.cst_id
and t1.lgp_id=t2.lgp_id
and t2.dt=t1.dt
and t2.del_ind = '0'
left join edw.dim_bus_loan_prd_frml_dd    c1
on t1.prd_no=c1.prd_no
and c1.dt=t1.dt
left join edw.dws_hr_empe_inf_dd          c2 --员工信息汇总
on  T1.sys_reg_psn=c2.empe_id
and c2.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd  c3 --考核机构树
on  t1.sys_reg_org = c3.org_id
and c3.dt = t1.dt
left join edw.dws_hr_empe_inf_dd          c4 --员工信息汇总
on  T2.mgr_id=c4.empe_id
and c4.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd t3 --考核机构树
on  t2.mgr_org = t3.org_id
and t3.dt = t1.dt
and t3.brc_org_nm = '衢州分行'
where t1.dt='@@{yyyyMMdd}'
and t1.del_ind='0'     --删除标识
-- and t1.rvlg_typ<>'0'   --0:非循环|1:自助循环|2:半自助循环
;
-- 贷后变更类型集合
-- ,'01','利率变更','02','优惠方案变更','03','还款信息变更','04','账户信息变更','05','期限变更','06','金额变更'
-- ,'07','冻结方式变更','08','适用产品变更','09','贸易融资功能变更','10','保函变更','11','信用证变更','12','还款自动止付变更'
DROP   TABLE IF     EXISTS SJXQ_SJ2025051581_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051581_CST_02 AS
SELECT  a.pst_loan_mdf_typ_colc
FROM
(
	SELECT  distinct pst_loan_mdf_typ_colc
	       ,decode(pst_loan_mdf_typ_colc2,'01','利率变更','02','优惠方案变更','03','还款信息变更','04','账户信息变更','05','期限变更'
            ,'06','金额变更','07','冻结方式变更','08','适用产品变更','09','贸易融资功能变更','10','保函变更','11','信用证变更','12','还款自动止付变更') as pst_loan_mdf_typ_colc2
	FROM SJXQ_SJ2025051581_CST_01 LATERAL VIEW explode(split(pst_loan_mdf_typ_colc, ',')) tmp as pst_loan_mdf_typ_colc2
	WHERE nvl(pst_loan_mdf_typ_colc,'')<>''
) a
GROUP BY a.pst_loan_mdf_typ_colc
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025051581_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051581_CST_03 AS
SELECT  t1.mdf_serno                AS 变更流水号
       ,t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t2.pst_loan_mdf_typ_colc_nm AS 贷后变更类型集合
       ,t1.产品名称
       ,t1.ctr_serno                AS 合同流水号
       ,t1.系统登记人
       ,t1.系统登记机构
       ,t1.变更申请日期
       ,t1.管户机构
       ,t1.管户人
from SJXQ_SJ2025051581_CST_01 		t1
left join SJXQ_SJ2025051581_CST_02 	t2
on t1.pst_loan_mdf_typ_colc=t2.pst_loan_mdf_typ_colc
where t1.aprv_sts='05'    --审批状态 05:已批准
and t1.tsk_sts='0'        --任务状态 0:未完成
and t1.变更申请日期 <= '20250514'
and (t1.rvlg_typ<>'0' or t1.产品名称 regexp '随贷通')
;
SElECT '01' seq, count(1) cnt,count(distinct mdf_serno) custs
from SJXQ_SJ2025051581_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct pst_loan_mdf_typ_colc) custs
from SJXQ_SJ2025051581_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 变更流水号) custs
from SJXQ_SJ2025051581_CST_03
;
/*
left join edw.dwd_code_library_dd         c1
on t1.rvlg_typ = c1.cd_val
and c1.dt = t1.dt
SELECT  *
FROM    edw.loan_admin_sm_lookup_dict
AND     UP_LOOKUP_ITEM_ID <> '-1'
AND     DT='20250519'
ORDER BY LOOKUP_ITEM_CODE
*/
***周慧美_SJ2025080206_衢州分行量化风险等级.sql
-- 周慧美_SJ2025080206_衢州分行量化风险等级
-- 客户号、客户名字、主管护机构编号、模型风险等级
DROP   TABLE IF     EXISTS SJXQ_SJ2025080206_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080206_CST_01 AS
SELECT  t1.cst_id     AS 客户号
       ,t3.cst_chn_nm AS 客户名字
       ,t1.prm_org_id AS 主管护机构号
       ,t1.prm_org_nm AS 主管户机构名称
       ,t4.量化风险等级
from adm_pub.adm_csm_cbas_mng_inf_dd        t1 --客户集市-客户基础-客户管户信息
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '衢州分行'
left join edw.dws_cst_bas_inf_dd 	        t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250731'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250731'
)t4 on t1.cst_id=t4.cst_id
where t1.dt = '20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025080206_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ2025080206_CST_01
***周昕东_SJ2025070911_隐患客户排查.sql
﻿-- 周昕东_SJ2025070911_隐患客户排查
-- 截至20250630，福建龙海村行，当前合同有效和冻结的
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.rel_serno	                             --用信申请流水号
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as 发生类型
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,t1.mgr_id	        --管户人工号
    ,t2.pd_nm
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2  --不需要产品名称字段可删除该表
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt=t1.dt
where t1.dt='20250630'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
and t1.mgr_org_id like '3563%'  --龙海村行
;
-- 随贷通
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_02 AS
select t1.cst_id
    ,t2.ctr_serno
	,t1.last_90_days_prcp_bal_acml			--近90天本金余额积数
    ,t1.qtr_acm_prcp_bal_acml              	--季累计本金余额积数
	,round(t1.last_90_days_prcp_bal_acml/90,4) 				as sdt_bal_avg_90d
	,round(t1.last_90_days_prcp_bal_acml/90/t2.ctr_amt,4) 	as sdt_bal_avg_90d_rate
    ,t2.ctr_amt
    ,t2.ctr_bal
from edw.dws_bus_loan_fnc_crd_acm_inf_dd    t1    --随贷通累计汇总信息
inner join SJXQ_SJ2025070911_CST_01         t2
on t1.bus_ctr_id=t2.ctr_serno
where t1.dt='20250630'
;
--贷款客户账户交易明细 一次还款还息还本一条展示
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_03 AS
select t1.DBIL_ID                                --借据编号|C64
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.DTRB_ACT_ID                              --放款客户账号|C32 可通过存款账户判断账户类型
	,t3.dtl_id                                   --明细编号|C32
    ,t3.trx_dt                                   --交易日期|C8
	,t3.entr_act_act_id                          --入账账号|C32
	,t3.dtrb_amt                                 --放款金额|DECIMAL(20,2)
	,t3.norm_prcp                                --正常本金|DECIMAL(20,2)
	,t3.ovd_prcp                                 --逾期本金|DECIMAL(20,2)
	,t3.rpay_rcv_acr_intr					     --归还应收应计利息
	,t3.rpay_act_id                              --还款账号|C32
	,t3.rpay_tot_amt                             --还款总额|DECIMAL(20,2)
	,t3.rpay_sts_cd                              --还款状态代码 	1:提前还款|2:正常还款|3:逾期还款
	,t3.rpay_prcp                                --归还本金|DECIMAL(20,2)
	,t3.trx_evt                                  --交易事件|C10
	,t3.evt_cmt                                  --事件说明|C80
	,t3.trx_no                                   --交易码|C16
	,t3.smr                                      --摘要|C512
	,t3.loan_act_id                              --贷款客户账号|C32
from edw.dim_bus_loan_dbil_inf_dd       t1            --信贷借据信息
INNER JOIN  SJXQ_SJ2025070911_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
INNER join edw.dwd_bus_loan_cst_act_trx_dtl_di 	t3     --贷款客户账户交易明细
on t1.dbil_id=t3.DBIL_ID
and t3.dt<='20250630'
where t1.dt='20250630'
;
--贷款账户交易明细 一次还款还息还本分条展示
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_03_1 AS
select t1.DBIL_ID                                --借据编号|C64
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.DTRB_ACT_ID                              --放款客户账号|C32 可通过存款账户判断账户类型
	,t3.loan_act_id                              --贷款账号|C32
	,t3.loan_dbil_id                             --贷款借据号|C35
	,t3.dtl_seq_nbr                              --明细序号|BIGINT
	,t3.pd_cd                                    --产品代码|C24
	,t3.trx_dt                                   --交易日期|C8
	,t3.trx_dir                                  --交易方向 0放款 1还款
	,t3.trx_amt                                  --交易金额
	,t3.bal                                      --余额
	,t3.loan_bal_fld                             --贷款余额字段|C8
	,t3.bal_fld_cmt                              --余额字段说明|C80
	,t3.trx_evt                                  --交易事件|C10
	,t3.evt_cmt                                  --事件说明|C80
	,t3.trx_no                                   --交易码|C16
	,t3.smr                                      --摘要|C512
	,t3.rcd_sts                                  --记录状态|C1
from edw.dim_bus_loan_dbil_inf_dd       t1            --信贷借据信息
INNER JOIN  SJXQ_SJ2025070911_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
INNER join edw.dwd_bus_loan_act_trx_dtl_di t3         --贷款账户交易明细
on t1.dbil_id=t3.loan_dbil_id
and t3.dt<='20250630'
where t1.dt='20250630'
;
/*
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025070911_CST_03
union all
SElECT '031' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025070911_CST_03_1
;
03	375956	8413
031	578511	8413
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_03_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_03_2 AS
SELECT t1.*,t2.cnt2
	,t2.ffg_cnt2,t2.rpy_cnt2
from(
	SELECT ctr_serno,DBIL_ID,count(1) cnt
		,count(case when smr='贷款发放' then cst_id end) as ffg_cnt
		,count(case when smr='归还贷款' then cst_id end) as rpy_cnt
	from SJXQ_SJ2025070911_CST_03
	GROUP BY ctr_serno,DBIL_ID
)t1 left join(
	SELECT ctr_serno,DBIL_ID,count(1) cnt2
		,count(case when smr='贷款发放' then cst_id end) as ffg_cnt2
		,count(case when smr='归还贷款' then cst_id end) as rpy_cnt2
	from SJXQ_SJ2025070911_CST_03_1
	where loan_bal_fld='ZHCHBJIN'
	GROUP BY ctr_serno,DBIL_ID
)t2 on t1.DBIL_ID=t2.DBIL_ID
and t1.ctr_serno=t2.ctr_serno
;
*/
--精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_04 AS
SELECT  T1.cst_id
    ,t1.cst_lvl_pst_loan_mng_pln_cd              --客户级贷后管理方案代码 ,'03','重组','04','退出','06','预保预报','07','清收','08','诉讼'
    ,c1.cd_val_dscr     		as 客户级贷后管理方案
    ,T2.tsk_gen_dt              AS 精准贷后风险触发时间
    ,T2.pst_loan_chk_tsk_typ_cd AS 贷后检查任务类型代码
    ,mz.cd_val_dscr             AS 贷后检查任务类型
    ,T3.触发规则分类
    ,T3.触发规则
    ,T3.触发原因分析
    ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY t2.tsk_gen_dt DESC ) rn
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd AS T1 --贷后检查批次信息表
INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd AS T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01'  --精准贷后 贷后检查任务来源代码
-- AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03' , '04' ,'12') --01 处置1级, 02 处置2级,12 处置 ,03 预警类, 04 提示类
-- AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02'  ,'12') --01 处置1级, 02 处置2级,12 处置   处置类精准贷后
AND     T2.DT = t1.dt
LEFT JOIN    edw.dwd_code_library_dd mz
ON      T2.pst_loan_chk_tsk_typ_cd = mz.cd_val
AND     mz.dt = t1.dt
LEFT JOIN    (
    SELECT  btch_serno
        ,CONCAT(rul_ctg_nm, '-', rul_sub_clss_nm)                                   AS 触发规则分类
        ,rul_nm                                                                     AS 触发规则
        ,trg_rsn_anls                                                               AS 触发原因分析
        ,rul_ctg_nm                                                                 AS 规则分类名称
        ,rul_sub_clss_nm                                                            AS 规则细类名称
        ,ROW_NUMBER() OVER ( PARTITION BY btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
    FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
    WHERE   DT = '20250630'
) T3
ON      T1.btch_serno = T3.btch_serno
AND     T3.RN = 1
LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
ON      t1.cst_lvl_pst_loan_mng_pln_cd = c1.cd_val
AND     c1.DT = t1.dt
WHERE   T1.DT = '20250630'
-- AND     T2.tsk_gen_dt >= '@@{yyyyMMdd-2y}'  ---精准贷后任务生成日期，一般取近N年，如近一年
;
--征信 一方缺失占比40%
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_05 AS
SELECT t1.cst_id
    ,REPLACE(substr(t3.report_dt,1,10),'-','') as fst_prd_dt
    ,t3.idv_crd_sco_val as fst_zx_score
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as lst_prd_dt
    ,t1.idv_crd_sco_val as lst_zx_score
    ,case when nvl(t1.idv_crd_sco_val,0)<=0 or nvl(t3.idv_crd_sco_val,0)<=0
        then null else t1.idv_crd_sco_val-t3.idv_crd_sco_val end as zx_score_diff
from edw.dws_cst_ccrc_idv_ind_inf_dd t1    --个人征信指标信息表
inner join(
    select distinct cst_id
    from SJXQ_SJ2025070911_CST_01
)t2 on t1.cst_id=t2.cst_id
left join edw.dws_cst_ccrc_idv_ind_inf_dd t3    --个人征信指标信息表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
and t3.report_asc_rn=1  --首次
where t1.dt='20250630'
and t1.report_dsc_rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025070911_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070911_CST_06 AS
SELECT  t1.cst_id               AS 客户号
       ,t1.cst_nm               AS 客户名称
       ,t1.sbr_org_nm           AS 支行名称
       ,t1.tem_org_nm           AS 团队名称
       ,t1.mgr_nm               AS 管户人姓名
       ,t1.合同编号集合
       ,t1.产品名称集合
       ,t2.ctr_amt              AS 随贷通卡授信金额
       ,t2.sdt_bal_avg_90d      AS 随贷通卡余额近90天日均
       ,t2.sdt_bal_avg_90d_rate AS 随贷通卡余额近90天日均与授信金额比
       ,t1.ctr_amt              AS 贷款授信金额
       ,t1.ctr_bal              AS 贷款授信余额
       ,t3.loan_bal_acs_mon_avg AS 贷款余额月日均
       ,nvl(t4.cnt,0)           AS 同日发生贷款发放和归还贷款组合的次数
       ,t5.客户级贷后管理方案
       ,t5.精准贷后风险触发时间
       ,t5.贷后检查任务类型代码
       ,t5.贷后检查任务类型
       ,T5.触发规则分类
       ,T5.触发规则
       ,T5.触发原因分析
       ,t6.fst_prd_dt           AS 首次征信查询时间
       ,t6.lst_prd_dt           AS 最近一次征信查询时间
       ,t6.zx_score_diff        AS 两次征信分变化情况
from(
	SELECT cst_id,cst_nm,sbr_org_nm,tem_org_nm,mgr_nm
		,sum(ctr_amt) 	as ctr_amt
		,sum(ctr_bal) 	as ctr_bal
	from SJXQ_SJ2025070911_CST_01
	GROUP BY cst_id,cst_nm,sbr_org_nm,tem_org_nm,mgr_nm
)t1 left join SJXQ_SJ2025070911_CST_02 	t2
on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbus_loan_inf_dd t3
on t1.cst_id=t3.cst_id
and t3.dt='20250630'
left join(
	SELECT cst_id,count(1) cnt
	from(
		SElECT cst_id,trx_dt
		from SJXQ_SJ2025070911_CST_03
		GROUP BY cst_id,trx_dt having count(distinct smr)>1
	)t1 GROUP BY cst_id
)t4 on t1.cst_id=t4.cst_id
left join SJXQ_SJ2025070911_CST_04 t5
on t1.cst_id=t5.cst_id
and t5.rn=1
left join SJXQ_SJ2025070911_CST_05 t6
on t1.cst_id=t6.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070911_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070911_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct DBIL_ID,dtl_id) custs
from SJXQ_SJ2025070911_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070911_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070911_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025070911_CST_06
;
/*
01	9504	7671
02	2045	2045
03	375956	375834
04	463652	463652
05	7540	7540
06	7671	7671
*/
SElECT '06' seq, *
from SJXQ_SJ2025070911_CST_06
***周昕东_SJ2025072491_龙海授信客户排查.sql
-- 周昕东_SJ2025072491_龙海授信客户排查
-- 截至20250630、福建龙海村行、当前有贷款余额的业务
DROP   TABLE IF     EXISTS SJXQ_SJ2025072491_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072491_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.rel_serno	                             --用信申请流水号
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as 发生类型
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as  管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm
    ,t4.sbr_org_nm
    ,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
where t1.dt='20250630'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
and t1.mgr_org_id like '3563%'          --龙海村行
and t1.ctr_bal > 0
;
--首笔征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025072491_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072491_CST_02 AS
select t1.cst_id,t1.report_dt,t1.report_no,t1.cst_type
	,p1.mar_status                               --婚姻状况
    ,decode(p1.mar_status,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','其他') as 婚姻状况
	,p1.spouse_name                              --配偶姓名
	,p1.work_unit                                --工作单位_最新
    ,CASE
        WHEN p1.is_white_customer = '1'                             THEN '白户'     --是否白户 1-白户 空值-非白户
        WHEN p2.rela_bank_mon_num > 0 AND p2.rela_bank_mon_num <= 6 THEN '类白户'   --与银行建立信贷关系月数
        else '非白户' END AS 征信类型
	-- ,t3.mar_status                               as 婚姻状况
	,t3.spouse_name                              as 配偶姓名
	,t3.last_work_unit                           as 最新工作单位
from(
    select cst_id,report_dt	--报告日期
        ,report_no	--报告编号
        ,qry_rsn	--查询原因
        ,'个人' as cst_type
    from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
    where dt='20250724'
    and report_asc_rn=1     --首笔
    union all
    select cst_id,report_dt	--报告日期
        ,report_no	--报告编号
        ,qry_rsn	--查询原因
        ,'企业'
    from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
    where dt='20250724'
    and report_asc_rn=1     --首笔
)t1 inner join(
    select distinct cst_id
    from SJXQ_SJ2025072491_CST_01
)t2 on t1.cst_id=t2.cst_id
LEFT JOIN edw.NCIP_CP_M_BASIC_INFO  p1
ON t1.report_no = p1.report_id
AND p1.dt <= '20250724'
LEFT JOIN edw.ncip_zx_p_zb_info     p2
ON t1.report_no = p2.report_no
AND p2.dt <= '20250724'
left join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di t3 --客户集市-业务信息-个人征信-基本概要信息
on  t1.report_no=t3.report_id
and t3.dt <= '20250724'
;
--结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025072491_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072491_CST_03 AS
SELECT  t1.ctr_serno  AS 合同流水号
       ,t1.cst_id     AS 客户号
       ,t1.cst_nm     AS 客户名称
       ,t1.rel_serno  AS 用信申请流水号
       ,t1.发生类型
       ,t1.ctr_amt    AS 合同金额
       ,t1.ctr_bal    AS 合同余额
       ,t1.ctr_bgn_dt AS 合同起始日期
       ,t1.ctr_mtu_dt AS 合同到期日期
       ,t1.mgr_id     AS 管户人工号
       ,t1.管户人
       ,t1.mgr_org_id AS 管户机构号
       ,t1.sbr_org_nm
       ,t1.tem_org_nm
       ,t2.report_dt  AS 最早征信日期
       ,t2.cst_type   AS 征信客户类型
       ,t2.征信类型
       ,t2.婚姻状况
       ,t2.配偶姓名
       ,t2.最新工作单位
from SJXQ_SJ2025072491_CST_01       t1
left join SJXQ_SJ2025072491_CST_02  t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025072491_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072491_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025072491_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025072491_CST_03
;
-- 押品过户时间短于6
-- 营业执照申领时间短于6个月
-- 无社保缴纳记录或缴纳短于6个月***喻美华_SJ20250224156_消费贷客户画像分析.sql
﻿-- 截止到2025年2月23日，大冶泰隆村镇银行全量贷款信息补充
-- （产品名称、还款方式、客户工作年收入，年龄、性别、婚姻状态、最新征信分，近1年和近2年未用信标识，贷款用途、侧面打听）
DROP   TABLE IF     EXISTS SJXQ_SJ20250224156_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224156_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.cpt_usg_rmk	    --资金用途备注|c4000
    ,t2.PD_NM
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20250223'
and t2.PD_NM not regexp '信用卡'
where t1.dt='20250223'
and t1.mgr_org_id like '4261%' --大冶泰隆村镇银行
;
--借据号维度是否用信
DROP   TABLE IF     EXISTS SJXQ_SJ20250224156_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224156_CST_03 AS
SELECT CTR_SERNO	--	合同流水号|C32
    ,PRAY_TYP_nm
from(
    SELECT  a.CTR_SERNO,max(a.dt) as use_crdt_dt
    FROM edw.dim_bus_loan_dbil_inf_dd a --信贷借据信息
    inner join (
        SELECT DISTINCT CTR_SERNO from SJXQ_SJ20250224156_CST_01
    )t2 on a.CTR_SERNO=t2.CTR_SERNO
    left join edw.dwd_code_library_dd c1
    on a.PRAY_TYP_CD = c1.cd_val
    and c1.dt = '20250223'
    WHERE a.dt <= '20250223'
    and a.prcp_bal>0    --用信
    group by a.CTR_SERNO
)t1
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250224156_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224156_CST_04 AS
SELECT t1.ctr_srl_no
FROM adm_rsk.adm_rsk_apl_inter_all	t1 --风险集市应用表-资产质量日常监测源表
left join EDW.dwd_code_library_dd   c1
on t1.loan_usg=c1.cd_val
and c1.dt='20250223'
WHERE t1.dt = '20250223'
group by t1.ctr_srl_no
;
-- 侧面打听
DROP   TABLE IF     EXISTS SJXQ_SJ20250224156_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224156_CST_05 AS
select t1.svy_rcd_serno                          --调查记录流水号|C32
	,t1.svy_mod_cd                               --调查方式代码|C2
    ,c1.cd_val_dscr     as svy_mod_nm   --侧面打听
	,t1.svy_dt                                   --调查日期|C8
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.svy_addr_typ_cd                          --调查地址类型代码|C3
    ,c2.cd_val_dscr     as svy_addr_typ_nm
	,t1.adiv                                     --行政区划|C12
	,t1.svy_addr                                 --调查地址|C256
	,t1.svy_ctnt_and_rslt                        --调查内容及结果|C4000
	,t1.rmk                                      --备注|c4000
	,t1.pcp_mnl_no                               --参与人工号|C20
	,t1.pcp_psn_nm                               --参与人姓名|C200
    ,t2.svy_obj_nm	--调查对象名称|c200
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
inner join edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd t2 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t2.rel_serno --关联流水号
and t2.dt='20250223'
and nvl(t2.svy_obj_nm,'')<>''
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt='20250223'
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt='20250223'
where t1.dt='20250223'
and t1.cst_id in(select distinct cst_id from SJXQ_SJ20250224156_CST_01)
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250224156_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224156_CST_06 AS
SELECT  *
from(
	select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
		,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	from(
		SELECT  cst_id
			,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
			,cr_sco_val                          AS cst_cr_grd_val
			,'1中征分' sc_src
		FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
		WHERE dt <= '20250223' and cr_sco_val<>0
		UNION
		SELECT  cst_id
			,prd_dt
			,cst_cr_grd_val
			,'1中征分' sc_src
		FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
		WHERE dt <= '20250223' and cst_cr_grd_val<>0
		union
		SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
			,'2指标表' sc_src
		from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
		where dt='20250223' and nvl(idv_crd_sco_val,0)<>0
		and idv_crd_sco_val<>-1
		union
		SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
			,'3集市表' sc_src
		from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
		where dt<='20250223' and nvl(digital_unscr,'')<>''
		and digital_unscr <>'-1'
	)t
)t where rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250224156_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250224156_CST_07 AS
SELECT  t1.ctr_serno   AS 合同流水号
    ,t1.cst_id      AS 客户号
    ,t1.cst_nm      AS 客户名称
    ,t1.ctr_amt     AS 合同金额
    ,t1.ctr_bal     AS 合同余额
    ,t1.ctr_bgn_dt  AS 合同起始日期
    ,t1.ctr_mtu_dt  AS 合同到期日期
    ,t1.cpt_usg_rmk AS 资金用途备注
    ,t4.loan_usg    AS 贷款用途
    ,t1.PD_NM       AS 产品名称
    ,case when t3.is_use_crdt_1y=1 then '是' else '否' end  AS 近1年是否用信
    ,case when t3.is_use_crdt_2y=1 then '是' else '否' end  AS 近2年是否用信
    ,t3.PRAY_TYP_nm as 还款方式
    ,t5.svy_obj_nm  AS 侧面打听人
    ,t6.age         AS 年龄
    ,t6.anl_inc     AS 年收入
    ,decode(t6.gdr_cd,'1','男','2','女','未知')  as 性别
    ,decode(t6.mrg_situ_cd,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','') as 婚姻状况
    ,t7.cst_cr_grd_val  as 最新征信分
    ,t7.prd_dt          as 最新征信分日期
from SJXQ_SJ20250224156_CST_01       t1
left join SJXQ_SJ20250224156_CST_03  t3
on t1.CTR_SERNO=t3.CTR_SERNO
left join SJXQ_SJ20250224156_CST_04  t4
on t1.ctr_serno=t4.ctr_srl_no
left join (
    select cst_id
    from SJXQ_SJ20250224156_CST_05
    where svy_mod_nm regexp '侧面打听'
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd  t6    --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t6.cst_id
and t6.dt='20250223'
left join SJXQ_SJ20250224156_CST_06  t7
on t1.cst_id=t7.cst_id
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20250224156_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ20250224156_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ20250224156_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20250224156_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250224156_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250224156_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250224156_CST_07
;
/*
01	82660	82660
03	23073	23073
04	863569	863569
05	135249	21331
06	3583861	3583860
07	82660	82660
*/***喻美华_SJ2025042131_大冶村行信贷信息补充.sql
﻿-- 喻美华810206-分析消费贷款的需求客群	SJ2025042131
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025042131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042131_CST_01 AS
SELECT  col_1  --序号
       ,col_2  --客户号
       ,col_3  --客户名称
       ,ROW_NUMBER() over(partition by col_2 order by cast(col_1 as int)) rn
from lab_bigdata_dev.qbi_file_20250422_08_48_48_0
where pt<>''
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025042131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042131_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
--是否用信
DROP   TABLE IF     EXISTS SJXQ_SJ2025042131_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042131_CST_03 AS
SELECT t1.cst_id
    ,max(case when t1.grant_date>='@@{yyyyMMdd-1y}' and t1.grant_amt>0 then 1 else 0 end) as 近1年是否用信
    ,max(case when t1.grant_date>='@@{yyyyMMdd-2y}' and t1.grant_amt>0 then 1 else 0 end) as 近2年是否用信
    ,max(t1.is_rsk_loan) as 是否存在风险贷款
    ,min(dt) as min_dt
from(
    SELECT  t2.cst_id
        ,t2.grant_amt                 --发放金额
        ,t2.grant_date                --发放日期
        ,t2.is_rsk_loan               --是否风险贷款
        ,t2.dt
        ,row_number() over(partition by t2.cst_id,t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ2025042131_CST_01               t1
    inner join adm_rsk.adm_rsk_apl_inter_all    t2 --风险集市应用表-资产质量日常监测源表
    on t1.col_2=t2.cst_id
    and t2.dt<='@@{yyyyMMdd}'
    where t1.rn=1
)t1 where t1.rn=1
group by t1.cst_id
;
-- 征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025042131_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042131_CST_04 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='@@{yyyyMMdd}' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 侧面打听人
DROP   TABLE IF     EXISTS SJXQ_SJ2025042131_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042131_CST_05 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as svy_mod_nm --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t3.调查对象名称
    ,t3.调查对象关系及名称
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
left join(
    SELECT t1.rel_serno
    from edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd    t1
    LEFT JOIN    EDW.dwd_code_library_dd                c1
    ON      T1.with_be_svy_psn_rel_cd = C1.CD_VAL
    and     c1.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and nvl(t1.svy_obj_nm,'')<>''
    GROUP BY t1.rel_serno
) t3 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t3.rel_serno --关联流水号
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025042131_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042131_CST_06 AS
SELECT  t1.col_1                               AS 序号
       ,t1.col_2                               AS 客户号
       ,t1.col_3                               AS 客户名称
       ,t6.age                                 AS 年龄
       ,decode(t6.gdr_cd,'1','男','2','女','未知') AS 性别
       ,c1.cd_val_dscr                         AS 婚姻状况
       ,t6.anl_inc                             AS 年收入
       ,t2.rul_set_rslt_nm                     AS 新预评估结果
       ,t3.近1年是否用信
       ,t3.近2年是否用信
       ,t3.是否存在风险贷款
       ,t4.scor_rng                            AS 最新征信分数段
       ,t5.调查对象名称                         AS 侧面打听人
from SJXQ_SJ2025042131_CST_01      t1
left join SJXQ_SJ2025042131_CST_02 t2
on t1.col_2=t2.cst_id
left join SJXQ_SJ2025042131_CST_03 t3
on t1.col_2=t3.cst_id
left join SJXQ_SJ2025042131_CST_04 t4
on t1.col_2=t4.cst_id and t4.rn=1
left join SJXQ_SJ2025042131_CST_05 t5
on t1.col_2=t5.cst_id
and t5.rn=1
and t5.svy_mod_nm regexp '侧面打听'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t6 --对私客户基础信息
on t1.col_2=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd           c1
ON      T6.MRG_SITU_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND     c1.FLD_NM = 'MRG_SITU_CD'
and     c1.dt = '@@{yyyyMMdd}'
;
SElECT '06' seq, *
from lab_sjxq.SJXQ_SJ2025042131_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2025042131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042131_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042131_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042131_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042131_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042131_CST_06
;
/*
01	12783	9828
02	5705400	5705400
03	8775	8775
04	3645660	3645659
05	1746905	1746905
06	12783	9828
*/***姚瑞帆_SJ20250508121_汝南村行逾期客户清单.sql
﻿/*
截止到2025年4月30日，汝南村行结息逾期连续3次以上的客户清单，盘点隐患客户中需要用到。
合同流水号，借据号、客户名称、客户号，
2025当年利息连续逾期次数、2025当年利息逾期次数，
业务目前状态，1月利息逾期天数，2月利息逾期天数，3月利息逾期天数，4月利息逾期天数
重组标识，管户客户经理名称，管户机构名称，经办客户经理名称，经办机构名称。
结息逾期连续3次以上:利息逾期日期 3次以上，不含3次？ 历史存在连续3个月逾期的客户
2025当年利息连续逾期次数？ 换成 当年利息逾期日期
2025当年利息逾期次数？当年不同利息逾期日期次数
业务目前状态? 借据当前状态？ 当前借据状态
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250508121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508121_CST_01 AS
select cst_id,ovd_mons
	,row_number() over(partition by cst_id order by ovd_mons) as rn
	,replace(add_months(to_date(ovd_mons,'yyyyMMdd'),-row_number() over(partition by cst_id order by ovd_mons)),'-','') as group_mon
from(
	select distinct cst_id,concat(SUBSTR(dt,1,6),'01') as ovd_mons
	from edw.dim_bus_loan_dbil_inf_dd       t1 --信贷借据信息
	where t1.dt<='20250430'
	and nvl(t1.ONBS_OVD_INTR_BAL,0) + nvl(t1.OFBS_OVD_INTR_BAL,0) >0 	--利息逾期
)t1
;
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250508121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508121_CST_02 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as 管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as 经办人
    ,t4.brc_org_nm
    ,t4.org_nm  as 管户机构名称
    ,t6.org_nm  as 经办机构名称
	,t7.max_continue_ovdcnt as 历史最大连续利息逾期月份数
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t1.hdl_org_id = t6.org_id
and t6.dt = t1.dt
inner join(
	select cst_id,max(continue_ovdcnt) as max_continue_ovdcnt
	from(
		select cst_id,group_mon,count(1) as continue_ovdcnt
		from SJXQ_SJ20250508121_CST_01
		group by cst_id,group_mon
	)t1 group by cst_id having max(continue_ovdcnt)>=3 	--最大连续利息逾期月份数3次及以上
)t7 on t1.cst_id=t7.cst_id
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = t1.dt
where t1.dt='20250430'
and t1.mgr_org_id like '4162%' --汝南村行
;
-- --利息逾期借据
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250508121_CST_02_1 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508121_CST_02_1 AS
-- select t1.dbil_srl_no                              --借据流水号
-- 	,t1.ctr_srl_no                               --合同流水号
-- 	,t1.dbil_amt                                 --借据金额
-- 	,t1.dbil_bal                                 --借据余额
-- 	,t1.cny_dbil_bal                             --借据余额(折人民币)
-- 	,t1.nrm_prcp                                 --正常本金
-- 	,t1.ovd_prcp                                 --逾期本金
-- 	,t1.ovd_intr                                 --逾期利息
-- 	,t1.dbil_sts_cd                              --借据状态
-- 	,t1.dbil_grant_date                          --借据发放日期
-- 	,t1.dbil_apnt_end_date                       --借据约定到期日期
-- 	,t1.dbil_actl_stlm_date                      --借据实际结清日期
-- 	,t1.table_intn_debt_intr                     --表内欠息
-- 	,t1.table_extn_debt_intr                     --表外欠息
-- 	,t1.cst_id                                   --客户编号
-- 	,t1.cst_nm                                   --客户名称
-- 	,t1.prcp_ovd_date                            --本金逾期日期
-- 	,t1.intr_ovd_date                            --利息逾期日期
-- 	,t1.is_ovd                                   --是否逾期
-- 	,t1.crrt_ovd_day                             --当前逾期天数
-- 	,t1.opr_empe_id                              --经办人工号
-- 	,t1.opr_org_id                               --经办机构编号
-- 	,t1.mng_empe_id_bsn                          --管户人工号_业务
-- 	,t1.mng_org_id_bsn                           --管户机构编号_业务
-- 	,t1.bsn_type_cd                              --业务品种
--     ,t1.dt
-- from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd   t1 --风险集市信贷业务借据信息表20240101开始有数据 且dt=20241119-20241201 数据缺失
-- inner join SJXQ_SJ20250508121_CST_01        t2
-- on t1.ctr_srl_no=t2.ctr_serno
-- where t1.dt<='20250430'
-- and t1.ovd_intr<>0
-- ;
DROP   TABLE IF     EXISTS SJXQ_SJ20250508121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508121_CST_03 AS
select t1.DBIL_ID                                  --借据编号|C64
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.APNT_MTU_DT                              --约定到期日|C8
	,t1.EXEC_MTU_DT                              --执行到期日|C8
	,t1.PRCP_BAL                                 --本金余额DECIMAL(21,2)
	,t1.NORM_BAL                                 --正常余额DECIMAL(22,2)
	,t1.OVD_AMT                                  --逾期金额DECIMAL(21,2)
	,t1.ONBS_OVD_INTR_BAL                        --表内欠息余额DECIMAL(21,2)
	,t1.OFBS_OVD_INTR_BAL                        --表外欠息余额DECIMAL(21,2)
	,t1.OVD_DAY                                  --逾期天数
	,t1.OVD_INTR_DAY                             --欠息天数
	,t1.OVD_DT                                   --逾期日期|C8
	,t1.OVD_INTR_DT                              --欠息日期|C8
	,t1.HIS_MAX_OVD_DAYS                         --历史最大逾期天数
	,t1.DBIL_STS_CD                              --借据状态代码|C3
	,t1.MGR_ID                                   --管户人工号|C10
	,t1.MGR_ORG_ID                               --管户机构编号|C12
	,t1.PYF_IND                                  --结清标志|C1
    ,t1.dt
from edw.dim_bus_loan_dbil_inf_dd       t1 --信贷借据信息
inner join SJXQ_SJ20250508121_CST_02    t2
on t1.CTR_SERNO=t2.ctr_serno
where t1.dt<='20250430'
and t1.dt>='20250101'
and nvl(t1.ONBS_OVD_INTR_BAL,0) + nvl(t1.OFBS_OVD_INTR_BAL,0) >0
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250508121_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508121_CST_04 AS
SELECT  t1.ctr_serno   AS 合同流水号
       ,t2.DBIL_ID     AS 借据号
       ,t1.cst_id      AS 客户号
       ,t1.cst_nm      AS 客户名称
       ,t1.ctr_amt     AS 合同金额
       ,t1.ctr_bal     AS 合同余额
       ,t1.ctr_bgn_dt  AS 合同起始日期
       ,t1.ctr_mtu_dt  AS 合同到期日期
       ,t1.历史最大连续利息逾期月份数
       ,t2.2025当年利息逾期日期
       ,t2.2025当年利息逾期次数
       ,c1.cd_val_dscr AS 借据状态
       ,t2.1月利息逾期天数
       ,t2.2月利息逾期天数
       ,t2.3月利息逾期天数
       ,t2.4月利息逾期天数
       ,t1.bsn_mark_nm AS 业务标识
       ,t1.管户人
       ,t1.管户机构名称
       ,t1.经办人
       ,t1.经办机构名称
from SJXQ_SJ20250508121_CST_02 t1
left join(
	select CTR_SERNO,DBIL_ID
		,count(distinct OVD_INTR_DT) as 2025当年利息逾期次数
		,count(case when SUBSTR(dt,1,6)='202501' then dt end) as 1月利息逾期天数
		,count(case when SUBSTR(dt,1,6)='202502' then dt end) as 2月利息逾期天数
		,count(case when SUBSTR(dt,1,6)='202503' then dt end) as 3月利息逾期天数
		,count(case when SUBSTR(dt,1,6)='202504' then dt end) as 4月利息逾期天数
	from SJXQ_SJ20250508121_CST_03
	group by CTR_SERNO,DBIL_ID
)t2 on t1.ctr_serno=t2.ctr_serno
left join edw.dim_bus_loan_dbil_inf_dd t3
on t2.DBIL_ID=t3.DBIL_ID
and t3.dt='20250430'
LEFT JOIN    edw.dwd_code_library_dd c1
ON      t3.DBIL_STS_CD = c1.cd_val
AND     c1.dt = '20250430'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,ovd_mons) custs   --合同
from SJXQ_SJ20250508121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250508121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct DBIL_ID,dt) custs
from SJXQ_SJ20250508121_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250508121_CST_04
;
/*
01	2471778	2471778
02	800	800
03	47195	47195
04	1264	800
*/
SElECT '04' seq, *
from lab_bigdata_dev.SJXQ_SJ20250508121_CST_04
;
***姚石清_SJ2025030646_眉县村行企业名单.sql
﻿-- 当前陕西省宝鸡市眉县在注册还未注销的企业,个体工商户名单以及相关信息。
--陕西眉县村镇银行 下辖社区
DROP   TABLE IF     EXISTS SJXQ_SJ2025030646_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030646_CST_01 AS
select t1.id                                     --系统id
	,t1.org_id                                   --所属机构id
	,t1.com_name                                 --社区名称
	,t1.branch_id                                --所属分行
	,t1.subbranch_id                             --所属支行
	,t1.team_id                                  --所属团队
	,t1.com_type                                 --社区类型:01: 综合社区，02：综合社区版块，03子社区，04社区单元，05虚拟子社区
    ,decode(t1.com_type,'01','综合社区','02','综合社区版块','03','子社区','04','社区单元','05','虚拟子社区','') com_type_nm
	,t1.com_vindicate_id                         --主维护人id
	,t3.empe_nm             com_vindicate_name   --主维护人名称
	,t1.com_code                                 --社区编码（社区唯一标识）
	,t1.com_state                                --社区状态：1潜在，2正在开发，3有效，4关闭
	,t1.com_genry                                --社区类型
    ,t2.brc_org_nm,t2.SBR_ORG_NM,t2.TEM_ORG_NM
from edw.xwdt_xw_community                  t1    --社区信息表
inner join edw.dim_hr_org_mng_org_tree_dd   t2    --机构树_考核维度
on  t1.org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm like '%陕西眉县%'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.com_vindicate_id=t3.empe_id
and t3.dt=t1.dt
where t1.dt = '@@{yyyyMMdd}'
;
--村镇银行 下辖企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025030646_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030646_CST_02 AS
select t1.entid                                  --主体唯一键
	,t1.entname                                  --企业名称
	,t1.socialcreditcode                         --统一社会信用代码
	,t1.legalname                                --法人姓名
    ,t1.esdate	--	成立日期
	,t1.regcapital                               --注册资金
	,t1.address         reg_addr                 --注册地址
	,t1.entstatuscode                            --企业状态码值 正常 1、异常 2、其他 3
    ,decode(t1.entstatuscode,'1','正常','2','异常','其他') entstatus_nm
	,t1.tel                                      --企业电话
	,t1.enttype                                  --企业类型
    ,decode(t1.enttype,'1','个体工商户','2','注册企业','其他') enttype_nm
	,t1.industrycode                             --行业类型
    ,c1.cd_val_dscr as idt_nm
	,t1.industryname                             --行业名称
	,t1.entsize                                  --企业规模 (1大型企业2中型企业3小型企业4微型企业)
	,t1.com_id                                   --社区ID
    ,t2.brc_org_nm,t2.SBR_ORG_NM,t2.TEM_ORG_NM
    ,t2.com_type_nm,t2.com_name,t2.com_vindicate_name
    ,decode(t1.custtype,'0','正式客户','1','潜在客户','未建档客户') cst_type
    ,t1.cust_no	    --客户号
	,t4.lgp_nm                                   --对公客户法人客户名称
	,t4.lgp_tel                                  --对公客户法人手机号
from edw.xwdt_xw_com_nearbyent      t1              --社区企业信息表
inner join SJXQ_SJ2025030646_CST_01 t2
on t1.com_id=t2.id
left join edw.dim_cst_entp_lgp_inf_dd t4 --对公客户法人信息表
on t1.cust_no=t4.cst_id
and t4.dt=t1.dt
left join EDW.DWD_CODE_LIBRARY_DD           c1
on substr(t1.industrycode,1,3)=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025030646_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030646_CST_03 AS
SELECT  brc_org_nm         AS 所属分行
       ,SBR_ORG_NM         AS 所属支行
       ,TEM_ORG_NM         AS 所属团队
       ,entname            AS 企业名称
       ,entstatus_nm       AS 企业状态
	,case when nvl(lgp_nm,'')<>'' then lgp_nm else legalname end as 法人客户名称
	,case when nvl(lgp_tel,'')<>'' then lgp_tel else tel end as 法人手机号
       ,socialcreditcode   AS 统一社会信用代码
       ,esdate             AS 成立日期
       ,enttype_nm         AS 企业类型
       ,reg_addr           AS 注册地址
       ,idt_nm       AS 行业类型
       ,industryname       AS 行业名称
       ,cst_type           AS 客户类型
       ,com_type_nm        AS 社区类型
       ,com_name           AS 社区名称
       ,com_vindicate_name AS 主维护人名称
from SJXQ_SJ2025030646_CST_02
;
SElECT *
from SJXQ_SJ2025030646_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ2025030646_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct entid) custs
from SJXQ_SJ2025030646_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 统一社会信用代码) custs
from SJXQ_SJ2025030646_CST_03
;
/*
01	107	107
02	31400	31400
03	31400	31400
*/***姬晨延_SJ20250704146_湖州分行票据中介客户排查.sql
﻿-- 姬晨延_SJ20250704146_湖州分行票据中介客户排查
-- 以客户号为单位（反洗钱系统&ldquo;新一代反洗钱工作平台&rdquo;），取数湖州分行在2022.07.01至2025.07.01期间账户交易总额大于100万元的对私客户以及交易总额大于500万元的对公客户
-- ，将符合条件的客户号放在A列，判断对应的客户号是否符合B、C列条件，统计合D列至O列条件的交易笔数或交易总额，详情见表格。有问题的话麻烦老师联系我下，谢谢！
--2022.07.01至2025.07.01 客户双边交易金额
DROP   TABLE IF     EXISTS SJXQ_SJ20250704146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250704146_CST_01 AS
select t2.cst_id
    ,t2.act_afl_org	    --账户所属机构|C12
    ,t1.dep_act_id                               --存款账号|C32
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
	,t1.crd_and_dbt_ind                          --借贷标志|C1
	,t1.trx_ccy_cd                               --交易币种代码|C3
	,t1.trx_amt                                  --交易金额
	,t1.act_bal                                  --账户余额
	,t1.cst_act_id                               --客户账号|C32
	,t1.trx_chnl_cd                              --交易渠道代码|C3
	,t1.csh_ind                                  --现转标志|C1
	,t1.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t1.cnt_pty_fin_instt_cd                     --对方金融机构代码|C12
	,t1.trx_bus_org                              --交易营业机构|C12
	,t1.cmt                                      --备注|C200
	,t1.act_nm                                   --账户名称|C200
	,t1.txt_code                                 --摘要代码|C10
    ,t1.smr_dscr
    ,t3.job_unt_nm	    --工作单位名称|C200
    ,t4.cst_chn_nm
    ,t4.cst_typ_cd
    ,t5.org_nm
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
left JOIN edw.dim_bus_dep_act_inf_dd  		t2	--存款账户信息
ON t1.dep_act_id = t2.dep_act_id
AND t2.dt = '20250701'
left join edw.dim_cst_idv_bas_inf_dd        t3 --个人客户基本信息
ON t2.cst_id = t3.cst_id
AND t3.dt = '20250701'
inner JOIN edw.dws_cst_bas_inf_dd           t4 --客户基础信息汇总
ON t2.cst_id = t4.cst_id
AND t4.dt = '20250701'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t2.act_afl_org = t5.org_id
and t5.dt = '20250701'
and t5.brc_org_nm regexp '湖州分行' --账户所属机构
where t1.dt between '20220701' and '20250701'
and t1.bal_fld_nm = 'DPLDGBAL' --动账
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250704146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250704146_CST_02 AS
select cst_id,'个人' as 客户类型
    ,job_unt_nm as 工作单位或客户名称
    ,sum(trx_amt) as 近3年交易总额
    ,max(case when job_unt_nm regexp '票' then 1 else 0 end) as 工作单位或客户名称是否含票
    ,count(case when t1.cnt_pty_act_nm regexp '天津金融资产登记结算有限公司' then trx_amt end)        天津金融资产登记结算有限公司交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '天津金融资产登记结算有限公司' then trx_amt else 0 end) 天津金融资产登记结算有限公司交易总额
    ,count(case when t1.cnt_pty_act_nm regexp '易宝支付' then trx_amt end)                  易宝支付交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '易宝支付' then trx_amt else 0 end)           易宝支付交易总额
    ,count(case when t1.cnt_pty_act_nm regexp '浙江网商银行' then trx_amt end)           浙江网商银行交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '浙江网商银行' then trx_amt else 0 end)    浙江网商银行交易总额
    ,count(case when t1.cnt_pty_act_nm regexp '吉林亿联银行' then trx_amt end)           吉林亿联银行交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '吉林亿联银行' then trx_amt else 0 end)    吉林亿联银行交易总额
    ,count(case when t1.cmt regexp '购承兑|买承兑|购买承兑' then trx_amt end)           购买承兑交易笔数
    ,count(case when t1.cmt regexp '卖电子承兑|换承兑|兑换承兑|购电票' then trx_amt end) 兑换承兑交易笔数
from SJXQ_SJ20250704146_CST_01 t1
where cst_typ_cd='1'
group by cst_id,job_unt_nm having sum(trx_amt)>=1000000
union all
select cst_id,'对公' as 客户类型
    ,cst_chn_nm as 工作单位或客户名称
    ,sum(trx_amt) as 近3年交易总额
    ,max(case when cst_chn_nm regexp '票' then 1 else 0 end) as 客户名称是否含票
    ,count(case when t1.cnt_pty_act_nm regexp '天津金融资产登记结算有限公司' then trx_amt end)        天津金融资产登记结算有限公司交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '天津金融资产登记结算有限公司' then trx_amt else 0 end) 天津金融资产登记结算有限公司交易总额
    ,count(case when t1.cnt_pty_act_nm regexp '易宝支付' then trx_amt end)                  易宝支付交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '易宝支付' then trx_amt else 0 end)           易宝支付交易总额
    ,count(case when t1.cnt_pty_act_nm regexp '浙江网商银行' then trx_amt end)           浙江网商银行交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '浙江网商银行' then trx_amt else 0 end)    浙江网商银行交易总额
    ,count(case when t1.cnt_pty_act_nm regexp '吉林亿联银行' then trx_amt end)           吉林亿联银行交易笔数
    ,sum(case   when t1.cnt_pty_act_nm regexp '吉林亿联银行' then trx_amt else 0 end)    吉林亿联银行交易总额
    ,count(case when t1.cmt regexp '购承兑|买承兑|购买承兑' then trx_amt end)           购买承兑交易笔数
    ,count(case when t1.cmt regexp '卖电子承兑|换承兑|兑换承兑|购电票' then trx_amt end) 兑换承兑交易笔数
from SJXQ_SJ20250704146_CST_01 t1
where cst_typ_cd='2'
group by cst_id,cst_chn_nm having sum(trx_amt)>=5000000
;
-- 其他承兑相关交易 547
DROP   TABLE IF     EXISTS SJXQ_SJ20250704146_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250704146_CST_03 AS
SELECT  txt_code     AS 摘要代码
       ,smr_dscr     AS 摘要说明
       ,cmt          AS 备注
       ,COUNT(1)     AS 交易笔数
       ,SUM(trx_amt) AS 交易金额
    ,ROW_NUMBER() over(order by sum(trx_amt) desc) as 交易金额排序
from SJXQ_SJ20250704146_CST_01
where cmt not regexp '购承兑|买承兑|购买承兑|卖电子承兑|换承兑|兑换承兑|购电票'
and cmt regexp '承兑'
GROUP BY txt_code,smr_dscr,cmt
order by 交易金额 desc
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ20250704146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250704146_CST_02
;
/*
01	35147308	35147308
02	39653	39653
*/
SElECT '02' seq, * from SJXQ_SJ20250704146_CST_02;  --结果表
SElECT '03' seq, * from SJXQ_SJ20250704146_CST_03;  --其余承兑汇总***孙佳莹_SJ20250508111_反洗钱支行检查.sql
/*
账户状态为正常的对公客户的活期账户，开户时间取客户正常的账号最早开户日期
交易日期：20240101-20241231
6个机构的机构号：330200100、330205200、330205100、330203900、330201700、330203400
数据需求字段
机构名称、客户名称、客户号、
交易总金额（折合人民币）、交易总笔数、借方交易笔数、借方交易总金额（折合人民币）、贷方交易笔数、贷方交易总金额（折合人民币）
、账户状态为正常、行业、开户时间
客户的主管户机构是这6个机构的机构号：330200100、330205200、330205100、330203900、330201700、330203400
这6个机构号是支行的
*/
---通用表：主管户为台州分行的客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250508111_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508111_CST_01 AS
SELECT  t1.cst_id
    ,t4.cst_chn_nm
    ,t2.sbr_org_nm
    ,t2.org_nm
    ,t3.cst_act_id
    ,t3.dep_act_id
    ,t3.opn_dt	--开户日期|C8
    ,t4.idt_cd	--行业代码|C5
    ,c1.cd_val_dscr     as idt_nm
FROM adm_pub.adm_csm_cbas_mng_inf_dd t1 --客户管户信息
INNER JOIN edw.dim_hr_org_mng_org_tree_dd t2 --机构树
ON t1.prm_org_id = t2.org_id AND t2.dt = '@@{yyyyMMdd}'
INNER JOIN edw.dim_bus_dep_act_inf_dd t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '@@{yyyyMMdd}'
and t3.ACT_STS_CD = 'A' --正常
and t3.LBL_PROD_TYP_CD='0'	--负债产品类型代码	1:定期产品|0:活期产品
INNER JOIN edw.dws_cst_bas_inf_dd   t4
ON t1.cst_id = t4.cst_id AND t4.dt = '@@{yyyyMMdd}'
and t4.cst_typ_cd='2'   --对公客户
left join edw.dwd_code_library_dd c1        --132058 tbl_nm,fld_nm,cd_val 唯一
on t4.idt_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
WHERE t1.dt = '@@{yyyyMMdd}'
;
-- 交易
DROP   TABLE IF     EXISTS SJXQ_SJ20250508111_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508111_CST_02 AS
SELECT t2.cst_id,t1.dep_act_id
    ,t1.dtl_seq_nbr                              --明细序号
    ,t1.trx_dt
    ,t1.trx_amt
    ,t1.crd_and_dbt_ind     --D:借方,C:贷方
	,t1.trx_ccy_cd          --交易币种代码|C3
    ,t5.CNY_EXR*T1.trx_amt  as trx_amt_cny
FROM edw.dwd_bus_dep_bal_chg_dtl_di     t1
inner join SJXQ_SJ20250508111_CST_01    t2
on t1.cst_act_id=t2.cst_act_id
and t1.dep_act_id=t2.dep_act_id
LEFT JOIN    EDW.DIM_BUS_COM_EXR_INF_DD T5 --汇率表 CNY_EXR 折人民币汇率
ON      T1.trx_ccy_cd = T5.CCY_CD
and     t1.trx_dt=t5.dt     --交易日汇率
AND     T5.DT BETWEEN '20240101' and '20241231'
WHERE t1.dt between '20240101' and '20241231'
and t1.bal_fld_nm = 'DPLDGBAL' --动账
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250508111_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250508111_CST_03 AS
SELECT  t1.sbr_org_nm AS 主管户支行
       ,t1.org_nm     AS 机构名称
       ,t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 客户名称
       ,t1.idt_nm     AS 行业
       ,t1.opn_dt     AS
       ,t2.交易总笔数
       ,t2.交易总金额_折人民币
       ,t2.借方交易总笔数
       ,t2.借方交易总金额_折人民币
       ,t2.贷方交易总笔数
       ,t2.贷方交易总金额_折人民币
from(
    select cst_id,cst_chn_nm,idt_nm,sbr_org_nm,org_nm
        ,min(opn_dt) as opn_dt
    from SJXQ_SJ20250508111_CST_01
    group by cst_id,cst_chn_nm,idt_nm,sbr_org_nm,org_nm
) t1 left join(
    select cst_id
        ,count(trx_dt) as 交易总笔数
        ,sum(trx_amt_cny)   as 交易总金额_折人民币
        ,count(case when crd_and_dbt_ind='D' then trx_dt end) as 借方交易总笔数
        ,sum(case when crd_and_dbt_ind='D' then trx_amt_cny else 0 end)   as 借方交易总金额_折人民币
        ,count(case when crd_and_dbt_ind='C' then trx_dt end) as 贷方交易总笔数
        ,sum(case when crd_and_dbt_ind='C' then trx_amt_cny else 0 end)   as 贷方交易总金额_折人民币
    from SJXQ_SJ20250508111_CST_02
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ20250508111_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ20250508111_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250508111_CST_03
***孙彬彬_SJ2025070366_临海支行征信客户.sql
﻿-- 孙彬彬_SJ2025070366_临海支行征信客户
-- 截止2025年6月30日，台州分行台州临海支行数据；针对存量客户有征信记录的，获取有非抵押贷款余额的客户清单。
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025070366_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070366_CST_01 AS
SELECT t1.cst_id,REPLACE(substr(t1.report_dt,1,10),'-','') as prd_dt
    ,t1.all_bank_cred_to_tal_bal	    --	非抵押类贷款授信余额
	,t1.curr_unsett_xfx_loan_amt	    --	当前未结清消费贷款金额_剔除车贷房贷
	,t1.curr_unsett_cred_loan_amt	    --	当前未结清信用贷款金额
	,t2.cst_nm                          --客户名称
	,t2.unsttl_obk_crd_lmt_all	        --	他行贷款金额（主办行）
	,t2.unsttk_obk_mort_crd_lmt_all	    --	他行抵押贷款金额（主办行）
    ,nvl(t2.unsttl_obk_crd_lmt_all,0)-nvl(t2.unsttk_obk_mort_crd_lmt_all,0) as 他行非抵押贷款金额_主办行
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
	,t3.ln_mgr_id                                --信贷归属客户经理
	,t3.ln_mgr_nm                                --信贷归属客户经理名称
	,t3.ln_org_id                                --信贷归属机构
	,t3.ln_org_nm                                --信贷归属机构名称
    ,t4.brc_org_nm,t4.sbr_org_nm
	,t5.crd_amt                                  --授信金额
	,t5.use_crd_bal                              --用信余额
from edw.dws_cst_ccrc_idv_ind_inf_dd            t1 --个人征信指标信息表
left join app_ado.adm_subl_cst_bus_inf_dd       t2 --实验室应用层资产-客户业务信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd      t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd       t4 --考核机构树
on  t3.ln_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm ='台州分行'
and t4.sbr_org_nm = '台州临海支行'
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd  t5 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='20250630'
and t1.report_dsc_rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025070366_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070366_CST_02 AS
SELECT  cst_id                    AS 客户号
       ,cst_nm                    AS 客户名称
       ,prd_dt                    AS 最新征信报告日期
       ,crd_amt                   AS 我行授信金额
       ,use_crd_bal               AS 我行用信余额
       ,他行非抵押贷款金额_主办行
       ,all_bank_cred_to_tal_bal  AS 非抵押类贷款授信余额
       ,curr_unsett_xfx_loan_amt  AS 当前未结清消费贷款金额_剔除车贷房贷
       ,curr_unsett_cred_loan_amt AS 当前未结清信用贷款金额
       ,prm_mgr_id                AS 主管护客户经理工号
       ,prm_mgr_nm                AS 主管护客户经理姓名
       ,prm_org_id                AS 主管护机构号
       ,prm_org_nm                AS 主管户机构名称
       ,ln_mgr_id                 AS 信贷归属客户经理
       ,ln_mgr_nm                 AS 信贷归属客户经理名称
       ,ln_org_id                 AS 信贷归属机构
       ,ln_org_nm                 AS 信贷归属机构名称
from SJXQ_SJ2025070366_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070366_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025070366_CST_02
;
/*
01	21155	21155
02	21155	21155
*/
SElECT '02' seq, *
from SJXQ_SJ2025070366_CST_01
***孙莉丽_SJ2025040956_宁波分行泰惠收信息.sql
﻿-- 孙莉丽002872-宁波分泰惠收商户的法人信息和入账信息
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025040956_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040956_CST_01 AS
SELECT  distinct t1.col_1      AS 商户号
       ,t1.col_2      AS 商户简称
       ,t1.col_3      AS 商户全称
from lab_bigdata_dev.qbi_file_20250410_14_31_23_0           t1
where t1.pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025040956_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040956_CST_02 AS
SELECT t1.*
       ,t2.lgp_nm     AS 法人姓名
       ,t2.stl_act_id AS 结算账户
       ,t2.stl_act_nm AS 结算账户户名
from SJXQ_SJ2025040956_CST_01               t1
left join edw.dws_bus_chnl_ths_mch_inf_dd   t2
on t1.商户号=t2.mch_id
and t2.dt='@@{yyyyMMdd}'
;
SElECT '02' seq, *
from lab_sjxq.SJXQ_SJ2025040956_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct 商户号) custs
from SJXQ_SJ2025040956_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 商户号) custs
from SJXQ_SJ2025040956_CST_02
***宓夏媛_SJ20250218121_大额理财风险监测.sql
﻿-- 导入数据
DROP   TABLE IF EXISTS SJXQ_SJ20250218121_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250218121_CST_01
(
    seq         bigint COMMENT '序号'
    ,cst_id     string COMMENT '客户编号'
    ,cst_nm     string COMMENT '客户名称'
    ,ta_srl     string COMMENT 'TA确认流水号'
    ,srlno      string COMMENT '流水号'
    ,bnk_act_id string COMMENT '银行账号'
    ,trx_dt_num string COMMENT '交易日期'
    ,trx_dt     string COMMENT '交易日期_str'
    ,trx_tm     string COMMENT '交易时间'
)
;
insert into SJXQ_SJ20250218121_CST_01
values (1,'1611503866','*志','20250103830143103948','20241227140100384667','***************0634','45684','20250127','10:43:22'),
    (2,'1676591056','*勇','20250106000189147773','20250106114601332517','***************3056','45679','20250122','10:56:13'),
    (3,'1009502252','*璇','20250106000189147778','20250103134752378954','***************3761','45678','20250121','14:20:57'),
    (4,'1003323875','*萍','20250106000982941317','20250106090804280018','***************6668','45678','20250121','09:51:58'),
    (5,'1045463120','*宁','20250106001108300797','20250102094826302922','***************3930','45672','20250115','09:18:26'),
    (6,'1020304853','*鸣','20250106001218292726','20250106085353276596','************3031','45696','20250208','09:25:49'),
    (7,'1030052788','*玲','20250108830143948029','20241231090157404562','***************0445','45699','20250211','15:30:44'),
    (8,'1004932089','*莉','20250108830143957936','20250106105137315149','***************2811','45695','20250207','11:00:42'),
    (9,'1035298154','*江','20250108830143957942','20241231090248404928','***************8985','45677','20250120','15:32:35'),
    (10,'1009547488','*慧','20250110830144494413','20250107122335376435','***************7449','45663','20250106','10:51:36'),
    (11,'1615737866','*超','20250113000192888454','20250109101748354440','***************1116','45671','20250114','10:40:45'),
    (12,'1674213992','**州','20250113000347084967','20250110145918568153','***************1425','45699','20250211','16:16:46'),
    (13,'1679874017','**珍','20250113001112229330','20250110142955558756','***************8888','45696','20250208','14:42:46'),
    (14,'1695034012','**贞','20250113001112229388','20250107104203350003','***************6768','45660','20250103','13:47:52'),
    (15,'1734033921','**云','20250113001112229450','20250113143228376052','***************4067','45684','20250127','10:11:00'),
    (16,'1012216964','**英','20250115830145310017','20250113134646360211','***************3660','45659','20250102','09:48:26'),
    (17,'1043124302','**英','20250121000209829215','20250118094324279236','***************7519','45678','20250121','09:31:26'),
    (18,'1008226975','**英','20250121000615378398','20250115151840417818','***************2405','45680','20250123','11:54:23'),
    (19,'1004868702','**英','20250121000615378400','20250115143314402550','***************8112','45678','20250121','09:32:34'),
    (20,'1615180350','**英','20250121000891790758','20250120153236435246','***************2420','45696','20250208','14:56:53'),
    (21,'1003309053','**燕','20250121000891791232','20250120165143463072','***************5688','45678','20250121','09:30:25'),
    (22,'1013083077','**燕','20250121830146337306','20250114112948348423','***************5394','45678','20250121','13:47:44'),
    (23,'1013083077','**燕','20250121830146391317','20250118154506332679','****************4163','45679','20250122','16:18:42'),
    (24,'1728628175','**艳','20250121830146413624','20250114104045333117','***************4246','45699','20250211','15:04:47'),
    (25,'1640186099','**香','20250121830146413626','20250114162826427315','***************7449','45671','20250114','11:29:48'),
    (26,'1012025719','**蓉','20250121830146413628','20250114162715426629','***************7449','45693','20250205','11:36:14'),
    (27,'1000072370','**庆','20250121830146421199','20250114135922382927','************9819','45699','20250211','14:02:40'),
    (28,'1042297326','**琴','20250121830146421201','20250115145453409787','****************3094','45678','20250121','15:47:29'),
    (29,'1007151854','**钦','20250121830146421203','20250115091826304366','***************4762','45700','20250212','15:26:37'),
    (30,'1612014682','**强','20250127830147727643','20250121095158362166','************6430','45693','20250205','10:03:23'),
    (31,'1612014682','**强','20250127830147727658','20250121093127352015','***************7852','45684','20250127','10:13:10'),
    (32,'1021457509','**前','20250127830147727668','20250124123316415164','****************3141','45681','20250124','07:03:04'),
    (33,'1733471578','**奇','20250127830147727670','20250122171334483099','************2324','45679','20250122','13:36:29'),
    (34,'1007949048','**其','20250127830147727674','20250121093025351296','************3862','45702','20250214','14:51:42'),
    (35,'1008288689','**宁','20250127830147727691','20250122133630402519','***************7965','45680','20250123','17:13:33'),
    (36,'1014857688','**明','20250127830147727693','20250121134744440573','***************1098','45664','20250107','12:23:35'),
    (37,'1014857688','**明','20250127830147727694','20250121101144370636','***************6417','45671','20250114','16:28:26'),
    (38,'1014857688','**明','20250127830147731277','20250121154729486690','***************9994','45671','20250114','16:27:15'),
    (39,'1000048267','**明','20250127830147745348','20250124070304315139','************4364','45680','20250123','14:02:03'),
    (40,'1013125139','**明','20250127830147745350','20250121144112461201','***************1980','45693','20250205','23:19:19'),
    (41,'1000078931','**龙','20250127830147745354','20250123140203407377','************1698','45672','20250115','15:18:39'),
    (42,'1019754551','**龙','20250127830147745357','20250124101830366910','***************3570','45671','20250114','13:59:21'),
    (43,'1688319147','**林子','20250127830147745381','20250123122116378175','************2568','45700','20250212','09:57:11'),
    (44,'1000042915','**林','20250127830147745383','20250122161843464781','***************1098','45680','20250123','12:21:16'),
    (45,'1015646700','**林','20250127830147745385','20250121140810448006','****************0331','45679','20250122','17:40:30'),
    (46,'1613901192','**林','20250127830147745387','20250123115423371028','***************1541','45678','20250121','14:03:21'),
    (47,'1718625451','**良','20250127830147745443','20250121093235352662','************9875','45677','20250120','09:43:24'),
    (48,'1000040626','**良','20250206000103619487','20250126111335344750','************7888','45702','20250214','09:24:25'),
    (49,'1688546783','**丽','20250206000220360439','20250127145113401348','***************7348','45663','20250106','09:08:03'),
    (50,'1004019764','**力','20250206000220360787','20250127103547338467','***************8888','45684','20250127','14:51:13'),
    (51,'1033816073','**军','20250206000362812172','20250121121505415592','***************0089','45681','20250124','10:18:30'),
    (52,'1688069215','**军','20250206000362812233','20250121142058452720','***************0129','45699','20250211','13:33:28'),
    (53,'1008192641','**娟','20250206000445467647','20250121164553508641','************2703','45667','20250110','14:29:54'),
    (54,'1606359996','**娟','20250206000445468356','20250121174030526418','************4159','45684','20250127','08:57:08'),
    (55,'1606359996','**娟','20250206000445468537','20250127085708307731','***************4338','45684','20250127','10:23:22'),
    (56,'1607593921','**娇','20250206000445468609','20250127102322333801','***************4338','45678','20250121','10:11:44'),
    (57,'1024703364','**建','20250206000536879304','20250126110752342769','****************7100','45670','20250113','13:46:46'),
    (58,'1007532596','**惠','20250206000626046142','20250124145137464043','***************6510','45693','20250205','11:58:48'),
    (59,'1727994122','**辉','20250206000626046216','20250121140322446107','***************9470','45667','20250110','14:59:18'),
    (60,'1017785577','**华','20250206000626046688','20250124111445390435','***************3726','45678','20250121','16:45:53'),
    (61,'1004927683','**华','20250206000708640359','20250122105613357177','***************7777','45695','20250207','15:37:19'),
    (62,'1642879284','**红','20250207830148592400','20250127101101329885','***************6873','45657','20241231','09:01:57'),
    (63,'1020497166','**红','20250207830148635912','20250127100832329065','***************0805','45698','20250210','13:31:59'),
    (64,'1600751941','**红','20250207830148635913','20250127101012329634','***************0805','45696','20250208','14:49:25'),
    (65,'1630002107','**恒','20250207830148635916','20250205115849336640','************2688','45681','20250124','14:51:36'),
    (66,'1651423733','**贵','20250207830148635918','20250127100559328396','****************1627','45666','20250109','10:17:48'),
    (67,'1018097657','**刚','20250207830148635919','20250205100323304131','***************1592','45684','20250127','10:35:46'),
    (68,'1012818371','**芬','20250207830148635920','20250201152224276916','***************4247','45693','20250205','13:37:57'),
    (69,'1009984746','**飞','20250207830148640990','20250127104322339986','***************1069','45663','20250106','08:53:52'),
    (70,'1030178051','**飞','20250207830148640992','20250127101311331052','***************1592','45698','20250210','17:17:06'),
    (71,'1024359710','**芳','20250207830148640994','20250127231919025566','***************6448','45693','20250205','15:22:24'),
    (72,'1690269402','**东','20250210000361409751','20250207110042329490','***************6434','45700','20250212','18:25:41'),
    (73,'1629999227','**弟','20250210000361409788','20250208101714300411','***************9999','45681','20250124','11:14:44'),
    (74,'1005793951','**丹','20250210000758374393','20250205113614331701','***************2737','45657','20241231','09:02:48'),
    (75,'1019576742','**丹','20250210001128287200','20250209133159300419','***************9998','45699','20250211','11:09:34'),
    (76,'1710014359','**朝','20250210001128287224','20250205133757358216','************7245','45678','20250121','12:15:04'),
    (77,'1009251468','**钗','20250210001238402947','20250207153719419258','************5598','45683','20250126','11:13:34'),
    (78,'1733812016','**波','20250210001644343987','20250208171706419144','***************0803','45672','20250115','14:33:14'),
    (79,'1017123740','**波','20250214830150208306','20250208144247383912','***************2799','45698','20250210','10:17:14'),
    (80,'2000965479','********公司','20250214830150208308','20250211153044440528','***************8131','45664','20250107','10:42:03'),
    (81,'2607517460','********公司','20250214830150208310','20250211110934365784','***************0786','45672','20250115','14:54:53'),
    (82,'2000557461','********公司','20250214830150208312','20250211140240411161','************8960','45678','20250121','14:41:12'),
    (83,'2605658250','********公司','20250214830150208313','20250212095712319362','***************8704','45699','20250211','12:36:55'),
    (84,'2604759191','********公司','20250214830150208316','20250212160009422437','****************4336','45705','20250217','16:01:54'),
    (85,'2000433879','*********公司','20250214830150208317','20250208144925385316','***************7969','45653','20241227','14:00:59'),
    (86,'2602668165','*********公司','20250214830150208320','20250212152637411342','***************8262','45681','20250124','12:33:16'),
    (87,'2629761452','*********公司','20250214830150208321','20250211150447431571','***************9989','45684','20250127','10:05:59'),
    (88,'2000526137','**********公司','20250214830150208322','20250208092550287102','***************8868','45670','20250113','14:32:28'),
    (89,'2002952226','**********公司','20250214830150208326','20250208135402371077','****************5425','45677','20250120','15:45:05'),
    (90,'2001351251','**********公司','20250214830150224610','20250211133328401863','***************5596','45678','20250121','14:08:09'),
    (91,'2001325441','**********公司','20250214830150224611','20250211123655389231','****************2746','45683','20250126','11:07:52'),
    (92,'2603093159','**********公司','20250214830150224614','20250211182542000711','***************2999','45700','20250212','16:00:09'),
    (93,'2605548332','**********公司','20250214830150240466','20250208145654386895','***************9434','45699','20250211','09:46:28'),
    (94,'2611000757','***********公司','20250217000112314054','20250214092425303023','***************5400','45696','20250208','13:54:01'),
    (95,'2002697004','************公司','20250217000875730007','20250217160154423204','****************7405','45677','20250120','16:51:43'),
    (96,'2002039569','************公司','20250217000875730039','20250211091353320974','***************5688','45684','20250127','10:08:32'),
    (97,'2002039569','************公司','20250217001561787586','20250211161647455622','***************0378','45684','20250127','10:10:12'),
    (98,'2002697004','************公司','20250217001561787599','20250211094628333260','****************2845','45699','20250211','09:13:53'),
    (99,'2000900504','*************公司','20250217001561787774','20250214145143392892','***************6268','45663','20250106','11:46:01')
;
--按TA确认流水号或者流水号从表里找到客户交易的银行账号
DROP   TABLE IF     EXISTS SJXQ_SJ20250218121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218121_CST_02 AS
select t1.ta_srl
    ,t2.cfm_dt                                   --确认日期|C8
    ,t2.trx_dt                                   --交易日期|C8
    ,t2.trx_tm                                   --交易时间|C6
    ,t2.srl_nbr                                  --流水号|C32
    ,t2.trx_cd                                   --交易代码|C6
    ,t2.bus_cd                                   --业务代码|C6
    ,t2.cst_id                                   --客户编号|C2
    ,t2.bnk_act_id                               --银行账号|C32
    ,t2.trx_amt                                  --交易金额
	,t2.cfm_amt                                  --确认金额|DECIMAL(20,2)
from SJXQ_SJ20250218121_CST_01              t1
inner join edw.dwd_bus_chm_trx_cfm_dtl_di   t2 --理财交易确认流水明细
on t1.ta_srl = t2.tacfm_srl_nbr
and t2.dt >='20241227'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250218121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218121_CST_03 AS
SELECT  t1.seq                      AS 序号
       ,t1.cst_id                   AS 客户编号
       ,t1.cst_nm                   AS 客户名称
       ,t3.efe_loan_cst_ind         AS 有效贷款户标识
       ,t1.trx_dt                   AS 财富交易日期
       ,t1.trx_tm                   AS 财富交易时间
       ,t2.bnk_act_id               AS 财富银行账号
       ,t4.dtl_seq_nbr              AS 明细序号
       ,t4.trx_dt                   AS 交易日期
       ,t4.trx_tm                   AS 交易时间
       ,t4.crd_and_dbt_ind          AS 借贷标志
       ,t4.trx_ccy_cd               AS 交易币种代码
       ,t4.act_cr_ind               AS 账户钞汇标志
       ,t4.trx_amt                  AS 交易金额
       ,t4.act_bal                  AS 账户余额
       ,t4.cst_act_id               AS 客户账号
       ,t4.txt_code                 AS 摘要代码
       ,t4.smr_dscr                 AS 摘要描述
       ,t4.trx_chnl_cd              AS 交易渠道代码
       ,t4.csh_ind                  AS 现转标志
       ,t4.cnt_pty_cst_act_id       AS 对方客户账号
       ,t4.cnt_pty_sub_act_seq_nbr  AS 对方子账户序号
       ,t4.cnt_pty_sys_act_id       AS 对方系统账号
       ,t4.cnt_pty_act_nm           AS 对方户名
       ,t4.cnt_pty_cst_typ_cd       AS 对方客户类型代码
       ,t4.cnt_pty_fin_instt_nm     AS 对方金融机构名称
       ,t4.cnt_pty_fin_instt_typ_cd AS 对方金融机构类型代码
       ,t4.cnt_pty_fin_instt_cd     AS 对方金融机构代码
       ,t4.agn_nm                   AS 代理人姓名
       ,t4.agn_doc_typ_cd           AS 代理人证件类型代码
       ,t4.agn_doc_nbr              AS 代理人证件号码
       ,t4.agn_ntn_cd               AS 代理人国籍代码
       ,t4.tlr_srl_nbr              AS 柜员流水号
       ,t4.trx_bus_org              AS 交易营业机构
       ,t4.opn_org                  AS 开户机构
       ,t4.opr_tlr                  AS 操作柜员
from SJXQ_SJ20250218121_CST_01              t1
inner join SJXQ_SJ20250218121_CST_02        t2
on t1.ta_srl = t2.ta_srl
left join adm_pub.adm_csm_cbas_ind_inf_dd   t3 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_dep_bal_chg_dtl_di    t4 --存款账户余额发生明细
on T2.bnk_act_id=t4.cst_act_id
and t4.dt>='20241220'
and t4.trx_dt between to_char(dateadd(to_date(t1.trx_dt,'yyyyMMdd'),-7,'dd'),'yyyyMMdd') and t1.trx_dt
;
SElECT '01' seq, count(1) cnt,count(distinct ta_srl) custs
from SJXQ_SJ20250218121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct bnk_act_id) custs
from SJXQ_SJ20250218121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 财富银行账号) custs
from SJXQ_SJ20250218121_CST_03
;
SElECT *
from SJXQ_SJ20250218121_CST_03
order by 序号,明细序号
;
/*
01	99	99
02	99	92
03	1099	92
*/***宓夏媛_SJ2025070881_基金业务半年度适当性评估.sql
﻿-- 宓夏媛_SJ2025070881_基金业务半年度适当性评估
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_01 AS
SELECT '非货基金' BUS_TYPE,T1.BUS_CD
    ,DECODE(T1.BUS_CD,'020','认购','022','申购','039','定投') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.cst_id          --cst_id
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        cst_id
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='20250709'
    and T1.CHANNEL_DATE between '20250101' and '20250630'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        cst_id
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20250101' and '20250709'
    and T1.CHANNEL_DATE between '20250101' and '20250630'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='20250630' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_02 AS
SELECT  cst_id
       ,lst_rsk_lvl
       ,lst_rsk_ases_dt
       ,lst_fnd_rsk_chnl
FROM
(
	SELECT  a.cst_id
	       ,a.cst_rsk_grd_cd    AS lst_rsk_lvl
	       ,a.ases_dt           AS lst_rsk_ases_dt
	       ,c1.cd_val_dscr      AS lst_fnd_rsk_chnl
           ,ROW_NUMBER() over(PARTITION BY a.cst_id ORDER BY a.ases_dt DESC) rn
	FROM (
        select distinct cst_id,cst_rsk_grd_cd,ases_dt,chnl_typ_cd
        from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd
        where dt <= '20250630'
    ) a
	INNER JOIN
	(
		SELECT  distinct cst_id
		FROM lab_bigdata_dev.SJXQ_SJ2025070881_CST_01
	)b
	ON a.cst_id = b.cst_id
	LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1
	ON a.chnl_typ_cd = C1.CD_VAL
    AND C1.DT = '20250630'
)a where rn=2
;
-- 客户交易时基金风险评测
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_03 AS
SELECT  a.srl_nbr
       ,a.trx_dt
       ,b.cst_rsk_grd_cd AS trx_rsk_lvl     --客户交易日风险等级
       ,b.ases_dt        AS trx_rsk_ases_dt --客户交易日风险测评时间
       ,c1.cd_val_dscr   AS trx_fnd_rsk_chnl
FROM lab_bigdata_dev.SJXQ_SJ2025070881_CST_01 a
LEFT JOIN edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd b
ON a.cst_id = b.cst_id AND a.trx_dt = b.dt
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1
ON b.chnl_typ_cd = C1.CD_VAL
AND C1.DT = '20250630'
WHERE b.dt BETWEEN '20250101' AND '20250630';
--基金
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_04 AS
SELECT  T1 . *
       ,T4.cst_rsk_grd_cd                                  AS cur_fnd_rsk_grd
       ,T4.ases_dt                                         AS cur_fnd_rsk_dt
       ,c1.cd_val_dscr                                     AS cur_fnd_rsk_chnl
       ,CASE WHEN T2.cst_id is null THEN '是'  ELSE '否' END AS 是否初评
       ,t2.lst_rsk_lvl
       ,t2.lst_rsk_ases_dt
       ,t2.lst_fnd_rsk_chnl
       ,T3.trx_rsk_lvl      --客户交易日风险等级
       ,T3.trx_rsk_ases_dt  --客户交易日风险测评时间
       ,T3.trx_fnd_rsk_chnl
FROM    lab_bigdata_dev.SJXQ_SJ2025070881_CST_01        T1 --基金交易
LEFT JOIN    lab_bigdata_dev.SJXQ_SJ2025070881_CST_02   T2 --上次基金风评
ON      T1.cst_id = t2.cst_id
LEFT JOIN    lab_bigdata_dev.SJXQ_SJ2025070881_CST_03   T3 --交易时基金风评
ON      T1.srl_nbr = t3.srl_nbr
AND     t1.trx_dt = t3.trx_dt
LEFT JOIN    edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd     T4 --基金风评表
ON      t1.cst_id = t4.cst_id
AND     t4.dt = '20250630'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON t4.chnl_typ_cd = C1.CD_VAL
AND C1.DT = '20250630'
;
--主表
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_05 AS
SElECT T1.*
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    -- ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    -- ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    -- ,T9.aum_avg_360d
    -- ,T10.aum_bal TRX_aum_bal
    -- ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ2025070881_CST_04   T1
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_id=T3.cst_id and T3.dt='20250630'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_id=T4.cst_id and T4.dt='20250630'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='20250630'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='20250630'
-- left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.cst_id=T8.cst_id and T8.dt='20250630'
-- left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.cst_id=T9.cst_id and T9.dt='20250630'
-- left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
-- on T1.cst_id=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20250101' and '20250630'
-- left join (
--     SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
--     from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
--     inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '20250630'
--     WHERE a.dt between '20250101' and '20250630' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
--     group by a.cst_id, a.dt
-- ) t11 on T1.cst_id=t11.cst_id and T1.trx_dt=t11.dt
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025070881_CST_06 AS
SELECT  cst_id                                                AS 客户号
       ,cst_nm                                                AS 客户名称
       ,age                                                   AS 客户年龄
       ,decode(trx_rsk_ases_dt,'18991231','',trx_rsk_ases_dt) AS 交易日风险测评时间
       ,trx_fnd_rsk_chnl                                      AS 交易日风险测评渠道
       ,trx_rsk_lvl                                           AS 交易日风险等级
       ,是否初评
       ,decode(cur_fnd_rsk_dt,'18991231','',cur_fnd_rsk_dt)   AS 最新结果测评时间
       ,cur_fnd_rsk_chnl                                      AS 最新结果测评渠道
       ,cur_fnd_rsk_grd                                       AS 最新风险测评结果
       ,decode(lst_rsk_ases_dt,'18991231','',lst_rsk_ases_dt) AS 上一次风险测评时间
       ,lst_fnd_rsk_chnl                                      AS 上一次风险测评渠道
       ,lst_rsk_lvl                                           AS 上一次风险测评结果
       ,concat(trx_dt,' ',trx_tm)                             AS 交易日期
       ,cfm_dt                                                AS 确认日期
       ,trx_amt                                               AS 交易金额
       ,cfm_amt                                               AS 确认金额
       ,srl_nbr                                               AS 交易流水号
       ,trx_type                                              AS 交易类型
       ,BUS_CD                                                AS 交易代码
       ,prod_type                                             AS 产品类型
       ,pd_cd                                                 AS 产品代码
       ,pd_nm                                                 AS 产品名称
       ,pd_rsk_grd                                            AS 产品风险等级
       ,trx_chnl                                              AS 交易渠道
       ,sale_empe_id                                          AS 销售人员工号
       ,sale_empe_nm                                          AS 销售人员姓名
       ,trx_sts                                               AS 交易状态
       ,brc_org_nm                                            AS 所属分行
       ,sbr_org_nm                                            AS 所属支行
FROM lab_bigdata_dev.SJXQ_SJ2025070881_CST_05
;
SELECT *
from SJXQ_SJ2025070881_CST_06
***常晓艺_SJ2025040166_舟山分行全量信贷数据.sql
﻿-- 舟山分行全量未结清客户 续贷及不续贷原因分析，流失及挽回数据分析
DROP   TABLE IF     EXISTS SJXQ_SJ2025040166_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040166_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no,t2.PD_NM
    ,case when t2.PD_NM regexp '流动资金|个人经营|个人消费|随贷通|贸e贷' then 1 else 0 end as is_select
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.hpn_typ_cd	        --	发生类型代码
    ,t1.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_id,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm
    ,t4.tem_org_id,t4.tem_org_nm,t4.org_nm
    ,t5.ctr_amt     as ctr_amt_2024
    ,t6.own_emp_id	        --	本行员工号
    ,t6.own_empe_ind	    --	本行员工标志|C1
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡|保函|承兑汇票|e票通'
-- and t2.PD_NM regexp '流动资金|个人经营|个人消费|随贷通|贸e贷'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '舟山分行'
left join edw.dim_bus_loan_ctr_bse_inf_dd   t5
on t1.ctr_serno=t5.ctr_serno
and t5.dt = '20241231'
left join edw.dws_cst_idv_bas_inf_dd	t6 --个人客户基本信息汇总表	30	|C10
on t1.cst_id=t6.cst_id
and t6.dt=t1.dt
where t1.dt='20250331'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
and t6.own_empe_ind<>'1'    --剔除员工贷款
;
-- 借据发放金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025040166_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040166_CST_02 AS
select t1.DBIL_ID                                  --借据编号|C6
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.PRCP_BAL                                 --本金余额DECIMAL(21,2)
	,t1.TMT_DT                                   --终结日期|C8
	,t1.PRCP_PYF_DT                              --本金结清日期|C8
	,t1.PYF_IND                                  --结清标志|C1
	,t1.CUR_DTRB_AMT                             --已发放金额DECIMAL(21,2)
	,t1.RMN_DTRB_AMT                             --可发放金额DECIMAL(21,2)
from edw.dim_bus_loan_dbil_inf_dd   t1          --信贷借据信息
inner join SJXQ_SJ2025040166_CST_01 t2
on t1.CTR_SERNO=t2.CTR_SERNO
where t1.dt='20250331'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040166_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040166_CST_03 AS
SELECT  t1.cst_id
       ,'是'                      AS 是否当前仍有未结清贷款
       ,t2.vld_cst_ind           AS 当前有效户标识
       ,t2.forml_cst_ind         AS 当前正式客户标识
       ,t2.vld_ln_cst_ind        AS 当前有效贷款户标识
       ,t4.rsk_hidden_cst_ind    AS 当前是否风险隐患客户
       ,t2.prm_mgr_id            AS 主管户客户经理
       ,t2.prm_mgr_nm            AS 主管户客户经理名称
       ,t2.prm_org_id            AS 主管户机构
       ,t2.prm_org_nm            AS 主管户机构名称
       ,t1.brc_org_id            AS 管户分行编号
       ,t1.brc_org_nm            AS 管户分行
       ,t1.sbr_org_id            AS 管户支行编号
       ,t1.sbr_org_nm            AS 管户支行
       ,t1.tem_org_id            AS 管户团队编号
       ,t1.tem_org_nm            AS 管户团队
       ,t5.out_amt_2024          AS 截止上年末发放金额
       ,t6.loan_bal_acs_mon_avg  AS 贷款余额月日均_上年末
       ,t3.oth_bnk_ln_bal        AS 他行贷款余额_上年末
       ,t1.ctr_amt_2024          AS 授信额度_上年末
       ,t3.dep_ftp_12m_acm       AS 近1年存款FTP营收_上年末
       ,t3.loan_ftp_12m_acm      AS 近1年贷款FTP营收_上年末
       ,t3.whth_fee_12m          AS 近1年财富业务中间业务收入_上年末
       ,t3.inter_bus_inc_12m_acm AS 近1年国际业务收入_上年末
       ,t5.out_amt               AS 截止当前发放金额
       ,t7.loan_bal_acs_mon_avg  AS 贷款余额月日均_当前
       ,t2.oth_bnk_ln_bal        AS 他行贷款余额_当前
       ,t1.ctr_amt               AS 授信额度_当前
       ,t2.dep_ftp_12m_acm       AS 近1年存款FTP营收_当前
       ,t2.loan_ftp_12m_acm      AS 近1年贷款FTP营收_当前
       ,t2.whth_fee_12m          AS 近1年财富业务中间业务收入_当前
       ,t2.inter_bus_inc_12m_acm AS 近1年国际业务收入_当前
       ,t9.主管户客户经理交接次数
from(
    select cst_id
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_amt_2024) as ctr_amt_2024
    from SJXQ_SJ2025040166_CST_01
    group by cst_id
)t1 left join app_ado.adm_subl_cst_bus_inf_dd   t2        --实验室应用层资产-客户业务信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250331'
left join app_ado.adm_subl_cst_bus_inf_dd       t3        --实验室应用层资产-客户业务信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20241231'
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd t4 --客户集市-风险信息-基础风险标签信息
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
left join(
    select cst_id
        ,sum(case when LVE_ACT_BGN_DT<='20241231' then amt else 0 end) as out_amt_2024
        ,sum(AMT)   as out_amt  --发放金额
    from SJXQ_SJ2025040166_CST_02
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join adm_pub.adm_csm_cbus_loan_inf_dd t6 --贷款业务信息
on t1.cst_id=t6.cst_id
and t6.dt='20241231'
left join adm_pub.adm_csm_cbus_loan_inf_dd t7 --贷款业务信息
on t1.cst_id=t7.cst_id
and t7.dt='20250331'
left join(
    SELECT  cst_id
            ,count(DISTINCT prm_mgr_id) - 1 AS 主管户客户经理交接次数
    FROM    adm_pub.adm_csm_cbas_mng_inf_dd --客户集市-客户基础-客户管户信息
    WHERE   dt >= '20250101'
    GROUP BY cst_id
)t9 on t1.cst_id=t9.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025040166_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ2025040166_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040166_CST_03
;
/*
01	8578	8578
02	88751	88751
*/***常晓艺_SJ2025052606_群组客户清单.sql
﻿-- 截止5.25日，舟山分行小鱼管家公共群组【舟山分行】促用信客户20250416及【舟山分行】金塘支行流失挽回群组20250416客户清单数据
-- 数据需求字段
-- 客户号，客户名称，管户客户经理工号，管户客户经理名称，管护团队，管护支行
-- 客户群组
DROP   TABLE IF     EXISTS SJXQ_SJ2025052606_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052606_CST_01 AS
SELECT  t1.group_name  AS 群组名称
        ,t2.cst_id     AS 客户编号
        ,t4.cst_chn_nm AS 客户名称
        ,t5.prm_mgr_id AS 主管护客户经理工号
        ,t5.prm_mgr_nm AS 主管护客户经理姓名
        ,t6.sbr_org_nm AS 主管户支行
        ,t6.tem_org_nm AS 主管户团队
FROM    edw.xwdt_xw_cst_group t1 --客户群组
LEFT JOIN    edw.xwdt_xw_cst_group_x_customer t2 --客户群组用户关联信息表
ON      t1.id = t2.group_id
AND     t1.dt = t2.dt
inner JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T1.org_code = T3.org_id
AND     t1.dt = t3.dt
and     t3.brc_org_nm='舟山分行'
LEFT JOIN    edw.dws_cst_bas_inf_dd t4 --客户基础信息汇总表
ON      t2.cst_id = t4.cst_id
AND     t1.dt = t4.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd           t5 --客户集市-客户基础-客户管户信息
on  t2.cst_id = t5.cst_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t5.prm_org_id = t6.org_id
and t6.dt = '@@{yyyyMMdd}'
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.del_flg = '0' --剔除已经删除的群组
;
SElECT '01' seq, count(1) cnt,count(distinct 客户编号) custs
from SJXQ_SJ2025052606_CST_01
;
SElECT '01' seq, *
from lab_bigdata_dev.SJXQ_SJ2025052606_CST_01
;
/*
01	1079	1028
*/***常晓艺_SJ2025061231_授信流失客户盘点.sql
﻿-- 常晓艺_SJ2025061231_授信流失客户盘点
-- 截止2024年12月末，舟山分行开业以来，前期有授信业务但2025年5月底全部结清的授信流失客户清单
--1. 舟山分行 流失客户筛选
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_01 AS
SELECT  T1.cst_id      AS cst_id
        ,T1.cst_nm     AS 客户名称
        ,t3.brc_org_nm as 主管户分行名称
        ,T3.sbr_org_id AS 主管户支行编号
        ,T3.sbr_org_nm AS 主管户支行名称
        ,T1.prm_org_id AS 主管户机构编号
        ,T1.prm_org_nm AS 主管户机构名称
        ,T1.prm_mgr_id AS 主管户客户经理工号
        ,T1.prm_mgr_nm AS 主管户客户经理姓名
        ,T2.客户首次在我行发生信贷业务的时间
        ,T2.客户我行最后一笔信贷业务结清的时间
        ,T2.客户在我行最高授信额度
        ,T2.客户目前我行是否有信贷业务
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1
LEFT JOIN (
           SELECT  A1.cst_id
                   ,MIN(A1.ctr_bgn_dt) AS 客户首次在我行发生信贷业务的时间
                   ,MAX(CASE WHEN A1.tmt_dt <> '18991231' THEN A1.tmt_dt ELSE A1.ctr_mtu_dt END)           AS 客户我行最后一笔信贷业务结清的时间
                   ,MAX(A1.ctr_amt)    AS 客户在我行最高授信额度
                   ,MAX(CASE
                         WHEN ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') ) OR A1.CTR_BAL > 0 ) THEN '是'
                         ELSE '否'
                        END)           AS 客户目前我行是否有信贷业务
           FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
           WHERE   A1.DT = '20250531'
           AND     SUBSTR(A1.prd_no,1,4) IN ( '1001' , '2001' ) --贷款1001、贷款2001、随贷通（消费）2001010101003、随贷通（经营）2001020101003
           GROUP BY A1.cst_id
           ) T2
ON      T1.cst_id = T2.cst_id
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树考核维度
ON      T1.prm_org_id = T3.org_id
AND     T3.DT = '20250531'
WHERE   T1.DT = '20250531'
AND     T3.brc_org_nm = '舟山分行'
AND     T2.客户目前我行是否有信贷业务 = '否'
;
--2. 客户业务指标信息加工
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_02 AS
SELECT  T1.cst_id
       ,T5.客户最早开户日期
       ,T5.客户2025年5月底我行存款余额
       ,T2.aum_bal                                                 AS 客户2025年5月底AUM余额
       ,t2.aum_mon_avg                              --AUM月日均
	,t4.ln_mgr_id                                --信贷归属客户经理
	,t4.ln_mgr_nm                                --信贷归属客户经理名称
	,t4.ln_org_id                                --信贷归属机构
	,t4.ln_org_nm                                --信贷归属机构名称
       ,CASE WHEN T4.forml_cst_ind = '1' THEN '是'  ELSE '否' END    AS 客户2025年5月底是否正式客户
       ,CASE WHEN T3.efe_dep_cst_ind = '1' THEN '是'  ELSE '否' END  AS 客户2025年5月底是否有效存款户
       ,CASE WHEN T3.efe_wlth_cst_ind = '1' THEN '是'  ELSE '否' END AS 客户2025年5月底是否有效财富户
       ,CASE WHEN T6.cst_id IS NOT NULL THEN '是'  ELSE '否' END     AS 客户在我行是否有信用卡
FROM SJXQ_SJ2025061231_CST_01 T1
LEFT JOIN adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd T2 --客户集市-业务信息-客户金融资产信息表
ON T1.cst_id = T2.cst_id AND T2.DT = '20250531'
LEFT JOIN adm_pub.adm_csm_cbas_ind_inf_dd T3 --客户集市-基础信息-客户基础标识信息
ON T1.cst_id = T3.cst_id AND T3.DT = '20250531'
LEFT JOIN adm_pub.adm_csm_cbas_mng_inf_dd T4 --客户集市-客户基础-客户管户信息
ON T1.cst_id = T4.cst_id AND T4.DT = '20250531'
LEFT JOIN
(
	SELECT  A1.cst_id
	       ,SUM(A1.gl_bal) AS 客户2025年5月底我行存款余额
	       ,MIN(A1.opn_dt) AS 客户最早开户日期
	FROM edw.dws_bus_dep_act_inf_dd A1
	WHERE A1.DT = '20250531'
	GROUP BY  A1.cst_id
) T5
ON T1.cst_id = T5.cst_id
LEFT JOIN
(
	SELECT  A1.cst_id
	FROM edw.dim_bus_crd_cr_crd_inf_dd A1 --信用卡卡片信息
	WHERE A1.DT = '20250531'
	AND A1.card_sts_cd NOT IN ( 'Q' , 'V' , '2' ) --销户申请, 核销, 过期未续卡片
	GROUP BY  A1.cst_id
) T6
ON T1.cst_id = T6.cst_id
;
--3. 客户基本信息加工
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_03 AS
SELECT  T1.cst_id
,decode(t2.cst_typ_cd,'1','对私','2','对公') as 客户类型
       ,concat(substr(regexp_replace(T2.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T2.reg_adr,'\\s|,','')) - 6,0)),'******') AS 户籍_注册地址脱敏
       ,concat(substr(regexp_replace(T2.fml_adr,'\\s|,',''),1,greatest(length(regexp_replace(T2.fml_adr,'\\s|,','')) - 6,0)),'******') AS 居住地址脱敏
       ,concat(substr(regexp_replace(T2.wrk_adr,'\\s|,',''),1,greatest(length(regexp_replace(T2.wrk_adr,'\\s|,','')) - 6,0)),'******') AS 工作单位_经营地址脱敏
       ,T2.sub_cmnt_id                           AS 客户所属子社区编号
       ,T3.cmnt_nm                               AS 客户所属子社区名称
       ,T4.job_unt_nm                            AS 客户单位名称
       ,SUBSTR(REPLACE(T5.report_dt,'-',''),1,8) AS 客户最近一次征信报告时间
       ,T5.scor_rng                              AS 分数区间
       ,T7.empe_nm      as 子社区主维护人
       ,T8.EMPLOY_NO    as 子社区定人
FROM SJXQ_SJ2025061231_CST_01               T1
LEFT JOIN edw.dws_cst_bas_inf_dd            T2 --客户基础信息汇总表
ON T1.cst_id = T2.cst_id
AND T2.DT = '20250531'
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd       T3 --社区信息 edw.dwd_cst_mng_cmnt_rel_dd.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
ON T2.sub_cmnt_id = T3.cmnt_enc
AND T3.DT = '20250531'
LEFT JOIN edw.dws_cst_idv_bas_inf_dd        T4 --个人客户基本信息汇总表
ON T1.cst_id = T4.cst_id
AND T4.DT = '20250531'
LEFT JOIN edw.dws_cst_ccrc_idv_ind_inf_dd   T5 --个人征信指标信息表
ON T1.cst_id = T5.cst_id
AND T5.report_dsc_rn = 1
AND T5.DT = '20250531'
LEFT JOIN    edw.XWDT_ETL_XW_COMMUNITY_PER T6 --普惠社区定人信息表
ON      t2.SUB_CMNT_ID = T6.COMMUNITY_CODE --社区编号
AND     T6.IS_MAIN_PERSON = '1' --主维护人
AND     T6.DT = '20250531'
left join edw.dws_hr_empe_inf_dd            t7 --员工信息汇总
on  T6.EMPLOY_NO=t7.empe_id
and t7.dt='20250531'
LEFT JOIN
(
	SELECT  T1.COMMUNITY_CODE
	FROM edw.XWDT_ETL_XW_COMMUNITY_PER t1 --普惠社区定人信息表
    left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
    on  T1.EMPLOY_NO=t2.empe_id
    and t2.dt='20250531'
	WHERE T1.dt = '20250531'
	AND T1.IS_MAIN_PERSON = '2' ---- 1主维护人，2社区定人
	GROUP BY  T1.COMMUNITY_CODE
) T8
ON T2.SUB_CMNT_ID = T8.COMMUNITY_CODE --社区编号
;
-- &quot;客户流失前2年内交接次数&quot;
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_04 AS
select t1.cst_id,t1.loss_dt
     ,count(1) cnt
from(
     select distinct cst_id,客户我行最后一笔信贷业务结清的时间 as loss_dt
     from SJXQ_SJ2025061231_CST_01
)t1 left join edw.loan_cst_mgr_hdv_rcd t2 --有贷款合同的客户交接
on t1.cst_id=t2.cst_id
and t2.dt='20250531'
and t2.del_ind='0'	--	删除标识
AND REPLACE(t2.sys_reg_tm, '-', '') >= replace(add_months(to_date(t1.loss_dt,'yyyyMMdd'),-12),'-','')
AND REPLACE(t2.sys_reg_tm, '-', '') <= t1.loss_dt
AND t2.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
AND t2.hdv_typ = '1'
and t2.bfr_hdv_cst_magr_id<>t2.aft_hdv_cst_magr_id
group by t1.cst_id,t1.loss_dt,loss_mons
;
-- 客户最后一笔合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_05 AS
select t1.cst_id
    ,t1.ctr_serno
    ,t1.ctr_bgn_dt,t1.ctr_mtu_dt,t1.tmt_dt
    ,CASE WHEN t1.tmt_dt <> '18991231' THEN t1.tmt_dt ELSE t1.ctr_mtu_dt END  as jq_dt
    ,t1.ctr_amt
    ,t1.exec_intr_rat                            --执行利率
    ,t1.prd_no
    ,t2.pd_nm
    ,t1.hdl_opr_id	    --经办人工号
    ,t4.empe_nm     as 经办人
    ,t4.LBR_TP_STS
    ,decode(t4.LBR_TP_STS,'1','实习期','2','试用期','3','已转正','4','已上岗','5','派遣期','6','退岗','7','试岗期','8','返聘') as 在职状态
    ,row_number() over(partition by t1.cst_id order by t1.ctr_bgn_dt desc) rn
    ,row_number() over(partition by t1.cst_id order by t1.ctr_bgn_dt asc) rn_asc
    ,row_number() over(partition by t1.cst_id order by CASE WHEN t1.tmt_dt <> '18991231' THEN t1.tmt_dt ELSE t1.ctr_mtu_dt END desc) rn2
FROM    edw.dim_bus_loan_ctr_bse_inf_dd      t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='20250531'
inner join SJXQ_SJ2025061231_CST_01          t3
on t1.cst_id=t3.cst_id
left join edw.dws_hr_empe_inf_dd             t4 --员工信息汇总
on  t1.hdl_opr_id=t4.empe_id
and t4.dt='20250531'
WHERE   t1.DT = '20250531'
AND     SUBSTR(t1.prd_no,1,4) IN ( '1001' , '2001' ) --贷款1001、贷款2001、随贷通（消费）2001010101003、随贷通（经营）2001020101003
;
-- 最后一次发放借据
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_06 AS
select t1.DBIL_ID                                  --借据编号|C64
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.USC_APLY_SERNO                           --用信申请流水号|C32
	,t1.CST_ID                                   --cst_id|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.APNT_MTU_DT                              --约定到期日|C8
	,t1.EXEC_MTU_DT                              --执行到期日|C8
	,t1.EXEC_INTR_RAT                            --执行利率DECIMAL(13,7)
	,t1.PRCP_PYF_DT                              --本金结清日期|C8
	,t1.PYF_IND                                  --结清标志|C1
	,t1.CTR_AMT                                  --合同金额DECIMAL(21,2)
	,t1.MTU_DT                                   --到期日期|C8
     ,row_number() over(partition by t1.cst_id order by t1.LVE_ACT_BGN_DT desc) rn
from edw.dim_bus_loan_dbil_inf_dd t1            --信贷借据信息
inner join SJXQ_SJ2025061231_CST_01          t3
on t1.cst_id=t3.cst_id
where t1.dt='20250531'
;
-- 行内近90天交易笔数\金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_07 AS
select t1.cst_id
     ,count(1)      as 行内近90天交易笔数
     ,sum(trx_amt)  as 行内近90天交易金额
from SJXQ_SJ2025061231_CST_01           t1
inner join edw.dim_bus_dep_act_inf_dd   t2 			--存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250531'
inner join edw.dwd_bus_dep_bal_chg_dtl_di     t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.dt<='20250531'
and t3.dt>='20250301'
and t3.bal_fld_nm = 'DPLDGBAL' --动账
group by t1.cst_id
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_08 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,case when cst_cr_grd_val<500 then '<500'
        when cst_cr_grd_val>=500 and cst_cr_grd_val<=600 then '[500,600]'
        when cst_cr_grd_val>600 and cst_cr_grd_val<=700 then '(600,700]'
        when cst_cr_grd_val>700 and cst_cr_grd_val<=800 then '(700,800]'
        when cst_cr_grd_val>800 and cst_cr_grd_val<=900 then '(800,900]'
        when cst_cr_grd_val>900  then '>900' else '' end as scor_rng_100
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250531' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250531' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20250531' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20250531' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_09 AS
SELECT  t1.cst_id
       ,t2.crd_amt                                          AS crd_amt_250531
       ,t3.crd_amt                                          AS crd_amt_241130
       ,nvl(t2.crd_amt,0) - nvl(t3.crd_amt,0)               AS 近6个月行内新增授信金额
       ,t4.report_dt    as 最近一笔征信数据时间
       ,t4.cred_total_amt                                   AS cred_total_amt_250531
       ,t4.late_hly_loan_count                              AS 最近6个月贷款审核查询记录
       ,t5.cred_total_amt                                   AS cred_total_amt_241130
       ,nvl(t4.cred_total_amt,0) - nvl(t5.cred_total_amt,0) AS 近6个月行外新增授信金额
    ,t6.dep_bal_mon_avg	as	存款余额月日均
	,t6.dep_bal                                 as 存款余额
    ,case when t7.cst_id is not null then '是' else '否' end as 是否风险隐患客户
    ,t7.隐患名单加入原因
    ,t8.scor_rng_100        as 中征分
    ,t9.risk_model_level_ten as  量化风险等级_C1逾期概率大
from SJXQ_SJ2025061231_CST_01 t1
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	t2 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t2.cst_id
and t2.dt='20250531'
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	t3 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t3.cst_id
and t3.dt='20241130'
left join(
    -- 征信 征信分 dws_cst_ccrc_idv_ind_inf_di
    select cst_id,report_dt	--报告日期
        ,cred_total_amt	        --decimal	授信总额（信用总额）
        ,late_hly_loan_count	--bigint	最近6个月贷款审核查询记录
    from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
    where dt='20250531'
    and report_dsc_rn=1
    union all
    select cst_id,report_dt	--报告日期
        ,cred_total_amt	        --decimal	信用总发生额
        ,late_6mon_org_pass_num	--bigint	近6个月金融机构审批通过家数
    from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
    where dt='20250531'
    and report_dsc_rn=1
)t4 on t1.cst_id=t4.cst_id
left join(
    -- 征信 征信分 dws_cst_ccrc_idv_ind_inf_di
    select cst_id,report_dt	--报告日期
        ,cred_total_amt	        --decimal	授信总额（信用总额）
    from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
    where dt='20241130'
    and report_dsc_rn=1
    union all
    select cst_id,report_dt	--报告日期
        ,cred_total_amt	        --decimal	信用总发生额
    from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
    where dt='20241130'
    and report_dsc_rn=1
)t5 on t1.cst_id=t5.cst_id
left join adm_pub.adm_csm_cbus_dep_inf_dd t6		--存款业务信息表
on t1.cst_id=t6.cst_id
and t6.dt='20250531'
left join(
    select cst_id                                   --客户号|c20
    from edw.dwd_bus_loan_rsk_hid_dngr_cst_list_dd --风险隐患客户清单
    where dt='20250531'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ2025061231_CST_08  t8
on t1.cst_id=t8.cst_id
and t8.rn=1
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as risk_model_level_ten
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250531'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组') AS risk_model_level_ten
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250531'
)t9 on t1.cst_id=t9.cst_id
;
--4. 结果表汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025061231_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061231_CST_10 AS
SELECT  T1.cst_id as 客户号
       ,T1.客户名称
       ,T1.主管户分行名称
       ,T1.主管户支行编号
       ,T1.主管户支行名称
       ,T1.主管户机构编号
       ,T1.主管户机构名称
       ,T1.主管户客户经理工号
       ,T1.主管户客户经理姓名
       ,t2.ln_org_id AS 信贷归属机构
       ,t2.ln_org_nm AS 信贷归属机构名称
       ,t2.ln_mgr_id AS 信贷归属客户经理
       ,t2.ln_mgr_nm AS 信贷归属客户经理名称
       ,t4.age       AS 年龄
       ,decode(t4.gdr_cd,'1','男','2','女','未知') AS 性别
    ,decode(t5.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','') as 客群标签
       ,t6.cnt           AS 客户流失前2年内交接次数
       ,T1.客户我行最后一笔信贷业务结清的时间
    --    ,t7.jq_dt         AS 客户最后一笔结清合同结清日期
       ,t7.ctr_amt       AS 客户最后一笔结清合同合同金额
       ,t7.exec_intr_rat AS 客户最后一笔结清合同执行利率
       ,t7.pd_nm         AS 客户最后一笔结清合同产品名称
       ,t8.EXEC_INTR_RAT AS 最后一次发放借据执行利率
       ,t8.AMT           AS 最后一次发放借据金额
       ,t8.EXEC_MTU_DT   AS 最后一次发放借据结清日期
       ,t6.loss_mons     AS 客户流失时长_月
       ,t9.行内近90天交易金额
       ,t9.行内近90天交易笔数
       ,t11.近6个月行内新增授信金额
       ,t11.近6个月行外新增授信金额
       ,t11.最近6个月贷款审核查询记录
       ,t11.最近一笔征信数据时间
--    ,T3.客户最近一次征信报告时间
       ,t11.存款余额月日均 as 2025年5月客户存款月日均
        ,t2.aum_mon_avg as 2025年5月客户综合金融资产aum月日均
       ,T3.客户所属子社区编号
       ,T3.客户所属子社区名称
       ,T3.子社区主维护人
       ,T3.子社区定人
    ,case when t8.cst_id is not null then '是' else '否' end as 我行历史是否用信
       ,t3.客户类型
       ,t11.中征分
       ,t11.量化风险等级_C1逾期概率大
       ,t11.是否风险隐患客户
       ,t11.隐患名单加入原因
       ,t7.hdl_opr_id  AS 最近一笔经办人工号
       ,t7.在职状态        AS 最近一笔经办人经办人在职状态
       ,t10.hdl_opr_id AS 最早一笔经办人工号
       ,t10.在职状态       AS 最早一笔经办人经办人在职状态
       ,T2.客户最早开户日期
       ,T1.客户首次在我行发生信贷业务的时间
       ,T2.客户2025年5月底我行存款余额
       ,T2.客户2025年5月底AUM余额
       ,T2.客户2025年5月底是否正式客户
       ,T2.客户2025年5月底是否有效存款户
       ,T2.客户2025年5月底是否有效财富户
       ,T2.客户在我行是否有信用卡
       ,T3.户籍_注册地址脱敏
       ,T3.居住地址脱敏
       ,T3.工作单位_经营地址脱敏
       ,T3.客户单位名称
FROM SJXQ_SJ2025061231_CST_01       T1
LEFT JOIN SJXQ_SJ2025061231_CST_02  T2
ON T1.cst_id = T2.cst_id
LEFT JOIN SJXQ_SJ2025061231_CST_03  T3
ON T1.cst_id = T3.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t4	--对私客户基础信息
on t1.cst_id=t4.cst_id
and t4.dt='20250531'
left join adm_pub.adm_csm_clab_cst_jc_inf_dd  t5   --客户标签信息
on t1.cst_id=t5.cst_id
and t5.dt='20250531'
left join SJXQ_SJ2025061231_CST_04  t6
on t1.cst_id=t6.cst_id
and t1.客户我行最后一笔信贷业务结清的时间=t6.loss_dt
left join SJXQ_SJ2025061231_CST_05  t7
on t1.cst_id=t7.cst_id and t7.rn=1
left join SJXQ_SJ2025061231_CST_06  t8
on t1.cst_id=t8.cst_id and t8.rn=1
left join SJXQ_SJ2025061231_CST_07 t9
on t1.cst_id=t9.cst_id
left join SJXQ_SJ2025061231_CST_05  t10     --最早一笔合同
on t1.cst_id=t10.cst_id and t10.rn_asc=1
left join SJXQ_SJ2025061231_CST_09 t11
on t1.cst_id=t11.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,loss_dt) custs
from SJXQ_SJ2025061231_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_08 where rn=1
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061231_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061231_CST_10
;
SElECT *
from lab_sjxq.SJXQ_SJ2025061231_CST_10
***常晓艺_SJ2025061956_客户地址.sql
-- 常晓艺_SJ2025061956_客户地址
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025061956_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061956_CST_01 AS
SELECT  col_1  --客户号
       ,col_2  --客户名称
from lab_bigdata_dev.qbi_file_20250619_15_33_31_0
where pt<>''
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025061956_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061956_CST_02 AS
SELECT  t1.col_1       AS 客户号
       ,t1.col_2       AS 客户名称
       ,t2.reg_adr     AS 户籍地址_注册地址
       ,t2.fml_adr     AS 家庭地址
       ,t2.wrk_adr     AS 工作单位地址_经营所在地地址
       ,t2.doc_nbr     AS 证件号码
       ,t2.doc_typ_cd  AS 证件类型代码
       ,c1.cd_val_dscr AS 证件类型
       ,t2.mbl_nbr     AS 手机
       ,t2.fml_tel_nbr AS 家庭电话
       ,t2.cmp_tel_nbr AS 公司电话
from SJXQ_SJ2025061956_CST_01       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表 证件号及到期日
ON t1.col_1 = t2.cst_id
AND t2.dt = '20250618'
left join edw.dwd_code_library_dd  c1
on t2.doc_typ_cd = c1.cd_val
and c1.dt = '20250618'
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025061956_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061956_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025061956_CST_02
***应宸宇_SJ2025073181_台州分行量化画像.sql
-- 应宸宇_SJ2025073181_台州分行量化画像
DROP   TABLE IF     EXISTS SJXQ_SJ2025073181_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025073181_CST_01 AS
SELECT  t1.cst_id     AS 客户号
       ,t3.cst_chn_nm AS 客户名字
       ,t4.量化风险等级
       ,t1.prm_mgr_id AS 主管户客户经理工号
       ,t1.prm_mgr_nm AS 主管户客户经理姓名
from adm_pub.adm_csm_cbas_mng_inf_dd        t1 --客户集市-客户基础-客户管户信息
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '台州分行'
and t2.sbr_org_nm regexp '路桥卖芝桥'
left join edw.dws_cst_bas_inf_dd 	        t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250731'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250731'
)t4 on t1.cst_id=t4.cst_id
where t1.dt = '20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025073181_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ2025073181_CST_01
;
***庞琴芳_SJ2025022641_随贷通客户信息.sql
﻿-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025022641_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022641_CST_01 AS
select t1.col_1 as cst_id
    ,t1.col_2 as cst_nm
	,t2.gdr_cd                                   --性别代码
    ,decode(t2.gdr_cd,'1','男','2','女','未知') gdr_nm
	,t2.age                                      --年龄
	,t2.idt_cd                                   --行业代码
    ,c1.cd_val_dscr     as idt_nm
from qbi_file_20250228_13_47_16_0               t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t2 --对私客户基础信息
on t1.col_1=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd               c1
on t2.idt_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
WHERE t1.pt<>''
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025022641_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022641_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
)t1 inner JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
inner join  SJXQ_SJ2025022641_CST_01        t5
on t1.cst_id=t5.cst_id
where t1.rn=1
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025022641_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022641_CST_03 AS
select t1.*
from(
    select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
        ,case when nvl(scor_rng,'')<>'' then scor_rng
                120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
        ,rpt_id
        ,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
        ,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
    from(
        SELECT  cst_id
            ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
            ,cr_sco_val                          AS cst_cr_grd_val
            ,'1中征分' sc_src,scor_rng,rpt_id	--	报告编号|c32
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
        UNION
        SELECT  cst_id
            ,prd_dt
            ,cst_cr_grd_val
            ,'1中征分' sc_src,scor_rng,''
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
            ,'2指标表' sc_src,scor_rng,report_no	--报告编号
        from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
        where dt='@@{yyyyMMdd}' and report_dsc_rn=1
        and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
        union
        SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
            ,'3集市表' sc_src
            ,case when cast(digital_unscr as int) <120 then '[0,120)'
                when cast(digital_unscr as int) >=1000 then '[1000,)'
                    120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
            ,report_id	--	报告编号
        from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
        where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
        and digital_unscr <> '-1'
    )t
)t1 inner join SJXQ_SJ2025022641_CST_01 t2
on t1.cst_id=t2.cst_id
where t1.rn=1
;
-- 小额贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2025022641_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022641_CST_04 AS
SElECT t1.cst_id,t1.rpt_id
    ,t2.贷款融资家数
    ,t2.贷款融资余额
    ,t2.小额贷款融资家数
    ,t2.小贷公司授信金额
    ,t2.小贷公司贷款余额
    ,t2.有余额小贷公司数
from SJXQ_SJ2025022641_CST_03 t1
left join(
      select cst_id
            ,report_id
            ,count(distinct dtrb_org)  贷款融资家数
            ,sum(ctr_bal)              贷款融资余额
            -- 21:信托公司 24:消费金融公司 25:贷款公司 51:小额贷款公司
      from   edw.dim_cst_ccrc_idv_loan_inf_dd
      where  dt = '@@{yyyyMMdd}'
      and    act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) --贷款
      -- and    (ctr_bal > 0 OR rmn_rpay_trm > 0 )  ---- 未结清
      group by cst_id ,report_id
    --   union all
    --   select cst_id
    --         ,report_id
    --         ,count(distinct dtrb_org_cd)  贷款融资家数
    --         ,sum(loan_bal)                贷款融资余额
    --   from   edw.dim_cst_ccrc_entp_loan_inf_dd
    --   where  dt = '@@{yyyyMMdd}'
    --   and    act_typ IN ( 'D1' , 'R1' , 'R4' ) --贷款
    --   -- and    (ctr_bal > 0 OR rmn_rpay_trm > 0 )  ---- 未结清
    --   group by cst_id ,report_id
)t2 on t1.rpt_id=t2.report_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025022641_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022641_CST_05 AS
SELECT  t1.cst_id          AS 客户号
    ,t1.cst_nm          AS 客户名称
    ,t1.gdr_nm          AS 性别
    ,t1.age             AS 年龄
    ,t1.idt_nm          AS 行业
    ,t2.rul_set_rslt_nm AS 新预评估结果
    ,t3.prd_dt          AS 最新征信时间
    ,t3.scor_rng        AS 征信分区间
    ,t4.贷款融资家数
    ,t4.贷款融资余额
    ,t4.小额贷款融资家数
    ,t4.小贷公司授信金额
    ,t4.小贷公司贷款余额
    ,t4.有余额小贷公司数
    ,t5.cred_biz_bank_num	as	有信用业务的银行数
    ,t5.curr_loan_bank_num	as	现有贷款授信银行数
    ,t5.oth_bank_busi_org_num	as	他行授信机构数_不含未激活
    ,t5.cred_busi_org_out_wjq	as	授信机构数_不含未激活
    ,t5.oth_bank_loan_org_num	as	他行贷款授信机构数
from SJXQ_SJ2025022641_CST_01       t1
left join SJXQ_SJ2025022641_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025022641_CST_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025022641_CST_04  t4
on t1.cst_id=t4.cst_id
left join edw.dws_cst_ccrc_idv_ind_inf_dd t5 --个人征信指标信息表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
and t5.report_dsc_rn=1
;
SElECT '05' seq, *
from SJXQ_SJ2025022641_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022641_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022641_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022641_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022641_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025022641_CST_05
;
/*
01	10636	10636
02	6951	6951
03	10540	10540
04	10540	10540
05	10636	10636
*/***张丹妮_SJ2025052771_反洗钱排查.sql
-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025052771_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052771_CST_01 AS
select t2.cst_id
    ,t1.dep_act_id                               --存款账号|C32
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
	,t1.trx_amt                                  --交易金额
    ,t4.cst_chn_nm
    ,t4.cst_typ_cd
    ,case when concat(t1.act_nm,t4.cst_chn_nm) regexp '李挺志|唐小华|马奇|唐华|秦华|杨阳|郭红岩|高晓波|杨丽|李雨韩|李蕾'
            and t1.cmt regexp '保证金|本金|投资|理财|分红|利息|返利|收益|搜了' then '一'
        when t1.cmt regexp '保证金|本金|投资|理财|分红|利息|返利|收益|搜了'
            and t1.cnt_pty_act_nm regexp '李挺志|唐小华|马奇|唐华|秦华|杨阳|郭红岩|高晓波|杨丽|李雨韩|李蕾' then '二'
        when t1.cnt_pty_act_nm regexp '搜了' then '三' else '' end as mz_cls
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
left JOIN edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
ON t1.cst_act_id = t2.cst_act_id
AND t2.dt = '20250526'
left JOIN edw.dws_cst_bas_inf_dd            t4 --客户基础信息汇总
ON t2.cst_id = t4.cst_id
AND t4.dt = '20250526'
where t1.dt>='20230101'
AND t1.dt <= '20250526'
;
-- 命中客户交易金额累计
DROP   TABLE IF     EXISTS SJXQ_SJ2025052771_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052771_CST_02 AS
select t1.dep_act_id                             --存款账号|C32
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
	,t1.crd_and_dbt_ind                          --借贷标志|C1
	,t1.trx_ccy_cd                               --交易币种代码|C3
    ,c1.cd_val_dscr     as 交易币种
	,t1.trx_amt                                  --交易金额
	,t1.act_bal                                  --账户余额
	,t1.cst_act_id                               --客户账号|C32
	,t1.trx_chnl_cd                              --交易渠道代码|C3
	,decode(t1.csh_ind,'0','现金','1','转账') as 现转标志
	,t1.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.cnt_pty_cst_typ_cd                       --对方客户类型代码|C2
	,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t1.cnt_pty_fin_instt_cd                     --对方金融机构代码|C12
	,t1.tlr_srl_nbr                              --柜员流水号|C32
	,t1.trx_bus_org                              --交易营业机构|C12
    ,t3.org_nm  as 交易营业机构
	,t1.opn_org                                  --开户机构|C12
    ,t4.org_nm  as 开户机构
	,t1.opr_tlr                                  --操作柜员|C10
	,t1.cmt                                      --备注|C200
	,t1.act_nm                                   --账户名称|C200
	,t1.bal_fld_nm                               --余额字段名称 DPLDGBAL --动账
	,t1.txt_code                                 --摘要代码|C10
    ,t1.smr_dscr                                 --摘要描述
    ,t2.cst_id,t2.cst_chn_nm
    ,t2.mz_cls
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细
inner join SJXQ_SJ2025052771_CST_01     t2
on t1.dep_act_id=t2.dep_act_id
and t1.dtl_seq_nbr=t2.dtl_seq_nbr
and t2.mz_cls<>''
left join edw.dwd_code_library_dd 		c1
on  t1.trx_ccy_cd = c1.cd_val
and c1.dt = '20250526'
left join edw.dim_hr_org_mng_org_tree_dd            t3 --考核机构树
on  t1.trx_bus_org = t3.org_id
and t3.dt = '20250526'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '20250526'
where t1.dt>='20230101'
AND t1.dt <= '20250526'
;
-- 输出表1 汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025052771_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052771_CST_03 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_chn_nm  AS 客户名称
       ,c1.cd_val_dscr AS 职业
       ,t5.age         AS 年龄
       ,t3.prm_mgr_id  AS 主管护客户经理工号
       ,t3.prm_mgr_nm  AS 主管护客户经理姓名
       ,t4.brc_org_id  AS 主管户分行ID
       ,t4.brc_org_nm  AS 主管户分行
       ,t4.sbr_org_id  AS 主管户支行ID
       ,t4.sbr_org_nm  AS 主管户支行
       ,t1.mz_cls      AS 触发情形
       ,t1.trx_dt      AS 命中交易日期
       ,t1.cmt         AS 命中交易备注
       ,t1.trx_cnt     AS 命中交易笔数
       ,t1.trx_amt     AS 命中交易金额
       ,t2.trx_cnt     AS 2023年以来交易笔数
       ,t2.trx_amt     AS 2023年以来交易金额
from (
    select cst_id,cst_chn_nm
        ,count(trx_dt)  as trx_cnt
        ,sum(trx_amt)   as trx_amt
    from SJXQ_SJ2025052771_CST_02
    group by cst_id,cst_chn_nm
)t1 left join(
    select cst_id
        ,count(trx_dt)  as trx_cnt
        ,sum(trx_amt)   as trx_amt
    from SJXQ_SJ2025052771_CST_01
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250526'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250526'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t5	--对私客户基础信息
on t1.cst_id=t5.cst_id
and t5.dt='20250526'
left join edw.dwd_code_library_dd 		c1
on  t5.ocp_cd = c1.cd_val
and c1.dt = '20250526'
;
-- 输出表2 明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025052771_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052771_CST_04 AS
SELECT  dep_act_id           AS 存款账号
       ,dtl_seq_nbr          AS 明细序号
       ,cst_id
       ,cst_chn_nm
       ,mz_cls as 触发情形
       ,trx_dt               AS 交易日期
       ,trx_tm               AS 交易时间
       ,crd_and_dbt_ind      AS 借贷标志
       ,trx_ccy_cd           AS 交易币种代码
       ,交易币种
       ,trx_amt              AS 交易金额
       ,act_bal              AS 账户余额
       ,cst_act_id           AS 客户账号
       ,trx_chnl_cd          AS 交易渠道代码
       ,现转标志
       ,cnt_pty_cst_act_id   AS 对方客户账号
       ,cnt_pty_act_nm       AS 对方户名
       ,cnt_pty_cst_typ_cd   AS 对方客户类型代码
       ,cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,cnt_pty_fin_instt_cd AS 对方金融机构代码
       ,tlr_srl_nbr          AS 柜员流水号
       ,交易营业机构
       ,开户机构
       ,opr_tlr              AS 操作柜员
       ,cmt                  AS 备注
       ,act_nm               AS 账户名称
       ,bal_fld_nm           AS 余额字段名称
       ,txt_code             AS 摘要代码
       ,smr_dscr             AS 摘要描述
from SJXQ_SJ2025052771_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025052771_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025052771_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052771_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025052771_CST_04
;
SElECT '03' seq,*
from SJXQ_SJ2025052771_CST_03
;
SElECT '04' seq,*
from SJXQ_SJ2025052771_CST_04
***张丹妮_SJ2025072456_嘉兴分行风险排查.sql
﻿-- 张丹妮_SJ2025072456_嘉兴分行风险排查
-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_01 AS
select t2.cst_id
    ,t2.cst_act_id
    ,t2.act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     as 账户状态
    ,t1.dep_act_id                               --存款账号|C32
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
    ,t1.crd_and_dbt_ind                          --借贷标志 C:贷 D:借
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
	,t1.trx_amt                                  --交易金额
	,t1.cnt_pty_cst_act_id	--对方客户账号|C32
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.txt_code                                 --摘要代码|C10
    ,t1.smr_dscr
    ,t1.cmt
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
    ,t4.brc_org_nm
    ,t4.sbr_org_nm
    ,t4.tem_org_nm
    ,coalesce(t5.cst_chn_nm,t6.cst_nm) 	    as 客户名称
    ,case when t5.cst_chn_nm is not null then '对私' when t6.cst_nm is not null then '对公' else '' end as 客户类型
    ,t5.job_unt_nm	    --工作单位名称|C200
	,t5.ocp_cd                                   --职业代码|C5
    ,c2.cd_val_dscr     as 职业
    ,t6.opr_scp_dscr	--经营范围描述|C3000
    ,t6.reg_cpt	        --注册资本|DECIMAL(20,2)
    ,case when (t5.job_unt_nm regexp '黄金|珠宝|金店|贵金属|首饰|投资'
            or concat(t6.cst_nm,t6.opr_scp_dscr) regexp '黄金|珠宝|金店|贵金属|首饰|投资')
        and t1.cmt regexp '黄金|充值|定投|分红|收益|金子|投资|理财' then 1 else 0 end as is_cf1_1
    ,case when t1.cmt regexp '黄金投资|黄金充值|黄金定投|黄金分红|黄金收益|黄金理财' then 1 else 0 end as is_cf1_2
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
inner JOIN edw.dim_bus_dep_cst_act_inf_dd   t2 --客户存款账户信息
ON t1.cst_act_id = t2.cst_act_id
AND t2.dt = '20250720'
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t2.cst_id = t3.cst_id
and t3.dt = '20250720'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250720'
and t4.brc_org_nm='嘉兴分行'
left JOIN edw.dim_cst_idv_bas_inf_dd    t5 --个人客户基本信息
ON t2.cst_id = t5.cst_id
AND t5.dt = '20250720'
left JOIN edw.dim_cst_entp_bas_inf_dd  	t6 --企业客户基本信息
ON t2.cst_id = t6.cst_id
AND t6.dt = '20250720'
left join edw.dwd_code_library_dd   c1
on t2.act_sts_cd = c1.cd_val
and c1.dt = '20250720'
left join edw.dwd_code_library_dd   c2
on t5.ocp_cd = c2.cd_val
and c2.dt = '20250720'
where t1.dt between '20240101' and '20250720'
and t1.bal_fld_nm='DPLDGBAL'    --动账
;
--非柜面限额
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_02 AS
SELECT  cengcgjz      AS cst_act_id
       ,MAX(danciedu) AS fg_per_lmt
       ,MAX(leijiedu) AS fg_day_lmt
FROM edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE dt = '20250720'
AND zhxeleix = '2'
AND shijbhao = 'FGMXIANE' -- 非柜面限额
AND edkzzhqi = '1D'
GROUP BY cengcgjz
;
-- 公安机关查冻扣记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_03 AS
SELECT t1.cst_id
    ,max(qry_ctrl_dt) as lst_cdk_dt
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd t1 --司法查冻扣汇总信息
WHERE t1.dt = '20250720'
-- AND qry_ctrl_dt between '20240101' and '20250720'
AND ( t1.instt_typ_cd IN ( '04' , '05' ) OR ( ( t1.instt_nm LIKE '%法院%' OR t1.instt_typ_cd = '01' ) AND t1.LAW_DOC_ID LIKE '%刑%' ) )
group by t1.cst_id
;
-- 结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_RES01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_RES01 AS
SELECT  t1.cst_id     AS 客户号
    ,t1.客户名称
    ,t1.job_unt_nm AS 工作单位名称
    ,t1.cst_act_id AS 客户账号
    ,t1.账户状态
    ,t2.fg_per_lmt AS 非柜单笔限额
    ,t2.fg_day_lmt AS 非柜日累计限额
    ,t1.prm_mgr_id AS 主管护客户经理工号
    ,t1.prm_mgr_nm AS 主管护客户经理姓名
    ,t1.prm_org_nm AS 主管户机构名称
    ,t1.brc_org_nm AS 主管户分行
    ,t1.sbr_org_nm AS 主管户支行
    ,t1.tem_org_nm AS 主管户团队
    ,case when t3.cst_id is not null then '是' else '否' end as 客户本人是否有查冻扣记录
    ,t3.lst_cdk_dt as 最近一次查冻扣日期
    ,t1.贷方交易金额
    ,t1.借方交易金额
    ,t1.贷方交易笔数
    ,t1.借方交易笔数
    ,t1.贷方交易对手个数
    ,t1.借方交易对手个数
    ,case when t1.is_cf1_1 + t1.is_cf1_2=2 then '一、二'
        when t1.is_cf1_1=1 then '一' when t1.is_cf1_2=1 then '二'
        else '' end as 触发条件
    ,t1.命中交易摘要
    ,t1.命中交易备注
from(
    select cst_id
        ,客户名称
        ,job_unt_nm	            --工作单位名称|C200
        ,cst_act_id
        ,账户状态
        ,prm_mgr_id                               --主管护客户经理工号
        ,prm_mgr_nm                               --主管护客户经理姓名
        ,prm_org_nm                               --主管户机构名称
        ,brc_org_nm
        ,sbr_org_nm
        ,tem_org_nm
        ,sum(case when crd_and_dbt_ind='C' then trx_amt else 0 end) as 贷方交易金额
        ,sum(case when crd_and_dbt_ind='D' then trx_amt else 0 end) as 借方交易金额
        ,count(case when crd_and_dbt_ind='C' then dep_act_id end) as 贷方交易笔数
        ,count(case when crd_and_dbt_ind='D' then dep_act_id end) as 借方交易笔数
        ,count(distinct case when crd_and_dbt_ind='C' then cnt_pty_cst_act_id end) as 贷方交易对手个数
        ,count(distinct case when crd_and_dbt_ind='D' then cnt_pty_cst_act_id end) as 借方交易对手个数
        ,max(is_cf1_1) as is_cf1_1
        ,max(is_cf1_2) as is_cf1_2
    from SJXQ_SJ2025072456_CST_01
    group by cst_id,客户名称,job_unt_nm,cst_act_id,账户状态
        ,prm_mgr_id,prm_mgr_nm,prm_org_nm,brc_org_nm,sbr_org_nm,tem_org_nm
)t1
left join SJXQ_SJ2025072456_CST_02 t2
on t1.cst_act_id=t2.cst_act_id
left join SJXQ_SJ2025072456_CST_03  t3
on t1.cst_id=t3.cst_id
where t1.is_cf1_1 + t1.is_cf1_2>0
;
-- 在我行购买黄金交易金额合计大于等于10万元客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_04 AS
SELECT cst_id               --客户号
    ,sum(cmdt_pay_unt_prc)  as trx_amt  --商品应付现金总额
FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di --贵金属交易整合表
WHERE dt between '20240101' and '20250720'
-- and SUBSTR(replace(pmt_tm,'-',''), 1, 8) between '20240101' and '20250720'   --付款时间
group by cst_id having trx_amt>=100000
;
-- 客户在泰隆金店购买黄金，收件人地址在浙江省嘉兴市外的，或收件人联系电话与客户本人联系电话不一样的
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_05 AS
select t1.ord_id                                   --订单号
	,t1.ord_tm                                   --订单时间
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.usr_nm                                   --用户名
	,t1.pst_mth                                  --邮寄方式
	,t1.pmt_tm                                   --付款时间
	,t1.cmdt_pay_unt_prc                         --商品应付现金总额
	,t1.pmt_mth                                  --支付方式
	,t1.chnl_nm                                  --渠道
	,t1.data_src                                 --数据来源
	,t1.acct_id                                  --交易账号
    ,t2.gds_rcver_dtl_addr
    ,concat(substr(regexp_replace(T2.gds_rcver_dtl_addr,'\\s|,',''),1,greatest(length(regexp_replace(T2.gds_rcver_dtl_addr,'\\s|,',''))-6,0)),'******') as 收货地址脱敏
    ,concat(substr(t2.gds_rcver_mphon_no,1,3),'****',substr(t2.gds_rcver_mphon_no,8,4)) as 收货人手机号脱敏
    ,concat(substr(t2.mbl_nbr,1,3),'****',substr(t2.mbl_nbr,8,4)) as 客户联系电话脱敏
    ,t2.gds_rcver_mphon_no	    --收货人手机号码
    ,t2.mbl_nbr
    ,case when t2.gds_rcver_dtl_addr regexp '嘉兴' then 1 else 0 end as is_local_adr
from adm_pub.adm_pub_cst_nob_met_trx_dtl_di t1
inner join (
    SELECT distinct t1.ord_no     --订单号|c255
        -- ,t1.cst_id             --客户号|c255
        -- ,t1.plc_ord_tm         --下单时间|c21
        -- ,t1.pay_tm             --付款时间|c21
        -- ,t1.chnl_cd            --渠道代码|c255
        -- ,t1.ord_tot_prc        --订单总价
        -- ,t1.ord_sts_cd         --订单状态代码|c2
        -- ,t1.cmdty_tot_prc      --商品总价
        -- ,t1.plc_ord_dt         --下单日期|c8
        -- ,t1.pay_dt             --付款日期|c8
        ,t1.gds_rcver_nm       --收货人姓名|c255|数据起始日期20241015
        ,t1.gds_rcver_mphon_no --收货人手机号|c255|数据起始日期20241015
        ,t1.gds_rcver_dtl_addr --收货人详细地址|c255|数据起始日期20241015
        ,t2.mbl_nbr
    from edw.dws_bus_cmpn_pnt_pm_ord_inf_dd	t1 --贵金属订单信息
    left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
    on t1.cst_id=t2.cst_id
    and t2.dt=t1.dt
    where t1.dt='20250720'
    and length(t1.gds_rcver_nm)+length(t1.gds_rcver_mphon_no)+length(t1.gds_rcver_dtl_addr)>0  --收货信息非空
    and t1.plc_ord_dt >='20240101'
)t2 on t1.ord_id=t2.ord_no
where t1.dt between '20240101' and '20250720'
and t1.data_src='泰隆金店'
;
-- 月交易金额大于500万元
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_06 AS
select cst_id,substr(trx_dt,1,6) as trx_mon
    ,sum(trx_amt) as mon_trx_amt
from SJXQ_SJ2025072456_CST_01
group by cst_id,trx_mon
having mon_trx_amt>=5000000
;
-- 日终账户余额低于1万元的天数/账户有交易的天数
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_07 AS
select t1.cst_act_id
    ,t1.trx_days,t2.bal_less_1w_days
    ,round(t2.bal_less_1w_days/t1.trx_days,4) as bal_trx_rate
    ,case when t2.bal_less_1w_days/t1.trx_days between 0.9 and 1.1 then 1 else 0 end as is_select_act
from(
    select cst_act_id,count(distinct trx_dt) as trx_days
    from SJXQ_SJ2025072456_CST_01
    where trx_amt<>0
    group by cst_act_id
)t1 left join (
    select cst_act_id,count(dt) as bal_less_1w_days
    from(
        select cst_act_id,dt	        --客户账号
        from edw.dim_bus_dep_act_inf_dd	    --存款账户信息
        where dt between '20240101' and '20250720'
        group by cst_act_id,dt having sum(gl_bal)<10000
    )t1 group by cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
;
--客群2
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_08 AS
select t1.cst_id
    ,t1.cst_act_id
    ,1 as is_cf2_1
    ,0 as is_cf2_2
    ,0 as is_cf2_3
from SJXQ_SJ2025072456_CST_01       t1
left join SJXQ_SJ2025072456_CST_04  t2 on t1.cst_id=t2.cst_id
where t1.客户类型='对私'
and t1.职业 regexp '批发零售人员|社会生产和服务人员|退休人员|自由职业|无业人员'
and t1.job_unt_nm not regexp '黄金|珠宝|金店|贵金属|首饰'
and (t1.cnt_pty_act_nm regexp '黄金|珠宝|金店' or t2.cst_id is not null)
union
select t1.cst_id,t1.cst_act_id,0,1,0
from(
    select distinct cst_id,cst_act_id
    from SJXQ_SJ2025072456_CST_01
)t1 inner join(
    select distinct cst_id
    from SJXQ_SJ2025072456_CST_05
    where is_local_adr=0 or gds_rcver_mphon_no<>mbl_nbr
)t2 on t1.cst_id=t2.cst_id
union
select t1.cst_id
    ,t1.cst_act_id
    ,0 as is_cf2_1
    ,0 as is_cf2_2
    ,1 as is_cf2_3
from SJXQ_SJ2025072456_CST_01       t1
inner join (
    select distinct cst_id
    from SJXQ_SJ2025072456_CST_06   --月交易金额大于500万元
)  t2 on t1.cst_id=t2.cst_id
inner join SJXQ_SJ2025072456_CST_07 t3 on t1.cst_act_id=t3.cst_act_id
and t3.is_select_act=1
where t1.客户类型='对公'
and concat(t1.客户名称,t1.opr_scp_dscr) regexp '黄金|珠宝|金店|贵金属|首饰'
and nvl(t1.reg_cpt,0)<1000000
;
--结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_RES02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_RES02 AS
SELECT  t2.cst_id     AS 客户号
    ,t2.客户名称
    ,t2.职业
    ,t2.job_unt_nm AS 工作单位名称
    ,t2.reg_cpt as 注册资本
    ,t2.cst_act_id AS 客户账号
    ,t2.账户状态
    ,t3.fg_per_lmt AS 非柜单笔限额
    ,t3.fg_day_lmt AS 非柜日累计限额
    ,t2.prm_mgr_id AS 主管护客户经理工号
    ,t2.prm_mgr_nm AS 主管护客户经理姓名
    ,t2.prm_org_nm AS 主管户机构名称
    ,t2.brc_org_nm AS 主管户分行
    ,t2.sbr_org_nm AS 主管户支行
    ,t2.tem_org_nm AS 主管户团队
    ,case when t4.cst_id is not null then '是' else '否' end as 客户本人是否有查冻扣记录
    ,t4.lst_cdk_dt as 最近一次查冻扣日期
    ,t5.trx_amt     as 我行购买黄金金额
    ,t6.收货地址脱敏
    ,t6.客户联系电话脱敏
    ,t6.收货人手机号脱敏
    ,t2.贷方交易金额
    ,t2.贷方交易笔数
    ,t2.借方交易金额
    ,t2.借方交易笔数
    ,t2.贷方交易对手个数
    ,t2.借方交易对手个数
    ,case when t1.is_cf2_1 + t1.is_cf2_2 +t1.is_cf2_3=3 then '一、二、三'
        when t1.is_cf2_1 + t1.is_cf2_2=2 then '一、二'
        when t1.is_cf2_1 + t1.is_cf2_3=3 then '一、三'
        when t1.is_cf2_2 +t1.is_cf2_3=3 then '二、三'
        when t1.is_cf2_1=1 then '一' when t1.is_cf2_2=1 then '二' when t1.is_cf2_3=1 then '三'
        else '' end as 触发条件
from(
    select cst_act_id
        ,max(is_cf2_1) as is_cf2_1
        ,max(is_cf2_2) as is_cf2_2
        ,max(is_cf2_3) as is_cf2_3
    from SJXQ_SJ2025072456_CST_08
    group by cst_act_id
)t1 left join(
    select cst_id
        ,客户名称,职业
        ,job_unt_nm	            --工作单位名称|C200
        ,reg_cpt
        ,cst_act_id
        ,账户状态
        ,prm_mgr_id                               --主管护客户经理工号
        ,prm_mgr_nm                               --主管护客户经理姓名
        ,prm_org_nm                               --主管户机构名称
        ,brc_org_nm
        ,sbr_org_nm
        ,tem_org_nm
        ,sum(case when crd_and_dbt_ind='C' then trx_amt else 0 end) as 贷方交易金额
        ,sum(case when crd_and_dbt_ind='D' then trx_amt else 0 end) as 借方交易金额
        ,count(case when crd_and_dbt_ind='C' then dep_act_id end) as 贷方交易笔数
        ,count(case when crd_and_dbt_ind='D' then dep_act_id end) as 借方交易笔数
        ,count(distinct case when crd_and_dbt_ind='C' then cnt_pty_cst_act_id end) as 贷方交易对手个数
        ,count(distinct case when crd_and_dbt_ind='D' then cnt_pty_cst_act_id end) as 借方交易对手个数
        ,max(is_cf1_1) as is_cf1_1
        ,max(is_cf1_2) as is_cf1_2
    from SJXQ_SJ2025072456_CST_01
    group by cst_id,客户名称,职业,job_unt_nm,reg_cpt,cst_act_id,账户状态
        ,prm_mgr_id,prm_mgr_nm,prm_org_nm,brc_org_nm,sbr_org_nm,tem_org_nm
)t2 on t1.cst_act_id=t2.cst_act_id
left join SJXQ_SJ2025072456_CST_02 t3
on t1.cst_act_id=t3.cst_act_id
left join SJXQ_SJ2025072456_CST_03  t4
on t2.cst_id=t4.cst_id
left join(
    SELECT cst_id               --客户号
        ,sum(cmdt_pay_unt_prc)  as trx_amt  --商品应付现金总额
    FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di --贵金属交易整合表
    WHERE dt between '20240101' and '20250720'
    -- and SUBSTR(replace(pmt_tm,'-',''), 1, 8) between '20240101' and '20250720'   --付款时间
    group by cst_id
)t5 on t2.cst_id=t5.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025072456_CST_05
    group by cst_id
)t6 on t2.cst_id=t6.cst_id
where t1.is_cf2_1 + t1.is_cf2_2 +t1.is_cf2_3>0
;
-- 历史全部交易记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_09 AS
select t2.cst_id
    ,t2.cst_act_id
    ,t2.act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     as 账户状态
    ,t1.dep_act_id                               --存款账号|C32
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
    ,t1.crd_and_dbt_ind                          --借贷标志 C:贷 D:借
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
	,t1.trx_amt                                  --交易金额
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.txt_code                                 --摘要代码|C10
    ,t1.smr_dscr
    ,t1.cmt
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
    ,t4.brc_org_nm
    ,t4.sbr_org_nm
    ,t4.tem_org_nm
    ,coalesce(t5.cst_chn_nm,t6.cst_nm) 	    as 客户名称
    ,t5.job_unt_nm	    --工作单位名称|C200
    ,case when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '流金岁月|上海思庆|上海琴联|上海博恩|上海礼仁|上海米黍|上海尚智|沃购供应链管理|艾悦电子|艾心|浙江米黍|北京米黍数科|新疆华凌纤连|艾米文化|惜艾健康' then 1 else 0 end as is_cf3_1
    ,case when t5.job_unt_nm regexp '流金岁月|上海思庆|上海琴联|上海博恩|上海礼仁|上海米黍|上海尚智|沃购供应链管理|艾悦电子|艾心|浙江米黍|北京米黍数科|新疆华凌纤连|艾米文化|惜艾健康' then 1 else 0 end as is_cf3_2
    ,case when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '流金岁月' then '流金岁月'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '上海思庆' then '上海思庆'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '上海琴联' then '上海琴联'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '上海博恩' then '上海博恩'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '上海礼仁' then '上海礼仁'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '上海米黍' then '上海米黍'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '上海尚智' then '上海尚智'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '沃购供应链管理' then '沃购供应链管理'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '艾悦电子' then '艾悦电子'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '艾心' then '艾心'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '浙江米黍' then '浙江米黍'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '北京米黍数科' then '北京米黍数科'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '新疆华凌纤连' then '新疆华凌纤连'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '艾米文化' then '艾米文化'
        when concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '惜艾健康' then '惜艾健康' else '' end  as key_word_1
    ,case when t5.job_unt_nm regexp '流金岁月' then '流金岁月'
        when t5.job_unt_nm regexp '上海思庆' then '上海思庆'
        when t5.job_unt_nm regexp '上海琴联' then '上海琴联'
        when t5.job_unt_nm regexp '上海博恩' then '上海博恩'
        when t5.job_unt_nm regexp '上海礼仁' then '上海礼仁'
        when t5.job_unt_nm regexp '上海米黍' then '上海米黍'
        when t5.job_unt_nm regexp '上海尚智' then '上海尚智'
        when t5.job_unt_nm regexp '沃购供应链管理' then '沃购供应链管理'
        when t5.job_unt_nm regexp '艾悦电子' then '艾悦电子'
        when t5.job_unt_nm regexp '艾心' then '艾心'
        when t5.job_unt_nm regexp '浙江米黍' then '浙江米黍'
        when t5.job_unt_nm regexp '北京米黍数科' then '北京米黍数科'
        when t5.job_unt_nm regexp '新疆华凌纤连' then '新疆华凌纤连'
        when t5.job_unt_nm regexp '艾米文化' then '艾米文化'
        when t5.job_unt_nm regexp '惜艾健康' then '惜艾健康' else '' end  as key_word_2
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
inner JOIN edw.dim_bus_dep_cst_act_inf_dd   t2 --客户存款账户信息
ON t1.cst_act_id = t2.cst_act_id
AND t2.dt = '20250720'
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t2.cst_id = t3.cst_id
and t3.dt = '20250720'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250720'
and t4.brc_org_nm='嘉兴分行'
left JOIN edw.dim_cst_idv_bas_inf_dd    t5 --个人客户基本信息
ON t2.cst_id = t5.cst_id
AND t5.dt = '20250720'
left JOIN edw.dim_cst_entp_bas_inf_dd  	t6 --企业客户基本信息
ON t2.cst_id = t6.cst_id
AND t6.dt = '20250720'
left join edw.dwd_code_library_dd   c1
on t2.act_sts_cd = c1.cd_val
and c1.dt = '20250720'
left join edw.dwd_code_library_dd   c2
on t5.ocp_cd = c2.cd_val
and c2.dt = '20250720'
where t1.dt <='20250720'
and t1.bal_fld_nm='DPLDGBAL'    --动账
and (
    concat(t1.cnt_pty_act_nm,t1.smr_dscr,t1.cmt) regexp '流金岁月|上海思庆|上海琴联|上海博恩|上海礼仁|上海米黍|上海尚智|沃购供应链管理|艾悦电子|艾心|浙江米黍|北京米黍数科|新疆华凌纤连|艾米文化|惜艾健康'
    or t5.job_unt_nm regexp '流金岁月|上海思庆|上海琴联|上海博恩|上海礼仁|上海米黍|上海尚智|沃购供应链管理|艾悦电子|艾心|浙江米黍|北京米黍数科|新疆华凌纤连|艾米文化|惜艾健康'
)
;
--结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2025072456_CST_RES03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072456_CST_RES03 AS
SELECT  t1.cst_id     AS 客户号
    ,t1.客户名称
    ,t1.job_unt_nm AS 工作单位名称
    ,t1.cst_act_id AS 客户账号
    ,t1.账户状态
    ,t2.fg_per_lmt AS 非柜单笔限额
    ,t2.fg_day_lmt AS 非柜日累计限额
    ,t1.prm_mgr_id AS 主管护客户经理工号
    ,t1.prm_mgr_nm AS 主管护客户经理姓名
    ,t1.prm_org_nm AS 主管户机构名称
    ,t1.brc_org_nm AS 主管户分行
    ,t1.sbr_org_nm AS 主管户支行
    ,t1.tem_org_nm AS 主管户团队
    ,case when t3.cst_id is not null then '是' else '否' end as 客户本人是否有查冻扣记录
    ,t3.lst_cdk_dt as 最近一次查冻扣日期
    ,case when t1.is_cf3_1 + t1.is_cf3_2=2 then '一、二'
        when t1.is_cf3_1=1 then '一' when t1.is_cf3_2=1 then '二'
        else '' end as 触发条件
    ,t1.命中关键字
    ,t1.命中交易金额
    ,t1.命中交易笔数
    ,t1.最早一次出现相关交易日期
    ,t1.最近一次出现相关交易日期
from(
    select cst_id
        ,客户名称
        ,job_unt_nm	            --工作单位名称|C200
        ,cst_act_id
        ,账户状态
        ,prm_mgr_id                               --主管护客户经理工号
        ,prm_mgr_nm                               --主管护客户经理姓名
        ,prm_org_nm                               --主管户机构名称
        ,brc_org_nm
        ,sbr_org_nm
        ,tem_org_nm
        ,max(is_cf3_1) as is_cf3_1
        ,max(is_cf3_2) as is_cf3_2
        ,sum(trx_amt)   as 命中交易金额
        ,count(1)       as 命中交易笔数
        ,min(trx_dt)    as 最早一次出现相关交易日期
        ,max(trx_dt)    as 最近一次出现相关交易日期
    from SJXQ_SJ2025072456_CST_09
    where is_cf3_1+is_cf3_2>0
    group by cst_id,客户名称,job_unt_nm,cst_act_id,账户状态
        ,prm_mgr_id,prm_mgr_nm,prm_org_nm,brc_org_nm,sbr_org_nm,tem_org_nm
)t1
left join SJXQ_SJ2025072456_CST_02 t2
on t1.cst_act_id=t2.cst_act_id
left join SJXQ_SJ2025072456_CST_03  t3
on t1.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025072456_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025072456_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072456_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072456_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ord_id) custs
from SJXQ_SJ2025072456_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072456_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025072456_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025072456_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025072456_CST_09
;
/*
01	31381199	31381199
03	124389	124389
06	33474	8647
07	616216	616216
09	3393	3393
*/
SElECT '01' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025072456_CST_RES01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025072456_CST_RES02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025072456_CST_RES03
;
/*
01	127	127
03	346	346
select chnl_nm,count(1) cnt
from adm_pub.adm_pub_cst_nob_met_trx_dtl_di   --贵金属交易明细表
where dt between '20240101' and '20250720'
group by chnl_nm ORDER BY CNT DESC
;
select chnl_nm,count(1) cnt
from adm_pub.adm_pub_cst_nob_met_trx_hand_di  --贵金属柜面或退款交易手工表
where dt between '20240101' and '20250720'
group by chnl_nm order by cnt desc
;
select data_src,sum(cmdt_pay_unt_prc) as sale, sum(mid_inc_tot_amt) as inc
from adm_pub.adm_pub_cst_nob_met_trx_dtl_di
where dt between '20240101' and '20250720'
GROUP BY data_src   -- '泰隆金店'
;
*/
SElECT * from SJXQ_SJ2025072456_CST_RES01;
SElECT * from SJXQ_SJ2025072456_CST_RES02;
SElECT * from SJXQ_SJ2025072456_CST_RES03;
***张依宁_SJ2025020631_合同预评估结果.sql
﻿-- 截止2025年01月31日，嘉兴分行全量清单业务对应的预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST_01 AS
SELECT  col_1  as ctr_serno
from qbi_file_20250210_11_34_45_0
where pt<>''
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST_02 AS
SELECT  B1.cst_id              AS 客户号
       ,B1.ctr_serno           AS 合同流水号
       ,t2.pd_nm    as 产品名称
       ,B1.rel_serno           AS 用信申请流水号
       ,B1.ctr_bgn_dt          AS 合同起始日期
       ,B2.app_cst_rol_cd      AS 预评估客户角色代码
       ,B4.cd_val_dscr         AS 预评估客户角色
       ,B2.cst_id              AS 预评估客户号
       ,B2.pre_ases_rslt_serno AS 预评估结果流水号
       ,B2.rul_set_rslt_cd     AS 预评估结果代码
       ,B3.cd_val_dscr         AS 预评估结果
       ,case when  ( ( B1.CTR_STS_CD IN ( '2' , '4' ) AND B1.TMT_DT = '18991231' AND to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )
         OR B1.CTR_BAL > 0 ) THEN '未到期未终结' else '到期或终结' end as 合同状态
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B1 --合同基础信息
LEFT JOIN edw.dim_bus_loan_prd_frml_dd     t2
on b1.prd_no=t2.prd_no
and t2.dt='20250131'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_rel_ases_dd B2 --授信关联预评估信息表
ON      B1.rel_serno = B2.usc_aply_serno
AND     B2.DT = '20250131'
LEFT JOIN    edw.dwd_code_library_dd B3 -- 码值表
ON      B2.rul_set_rslt_cd = B3.cd_val
AND     B3.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     B3.fld_nm = 'RUL_SET_RSLT_CD'
AND     B3.DT = '20250131'
LEFT JOIN    edw.dwd_code_library_dd B4 -- 码值表
ON      B2.APP_CST_ROL_CD = B4.cd_val
AND     B4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     B4.fld_nm = 'APP_CST_ROL_CD'
AND     B4.DT = '20250131'
WHERE   B1.dt = '20250131'
and b1.ctr_serno in (select ctr_serno from SJXQ_SJ2025020631_CST_01)
-- AND     SUBSTR(B1.mgr_org_id, 1, 4) = '3309'  --管护机构 嘉兴分行
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( B1.CTR_STS_CD IN ( '2' , '4' ) AND B1.TMT_DT = '18991231' AND to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )
--          OR B1.CTR_BAL > 0 )
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST_03 AS
SELECT  t1.ctr_serno AS 合同流水号
        ,t2.客户号
        ,t2.用信申请流水号
        ,t2.合同起始日期
        ,t2.预评估客户角色代码
        ,t2.预评估客户角色
        ,t2.预评估客户号
        ,t2.预评估结果流水号
        ,t2.预评估结果代码
        ,t2.预评估结果
        ,t2.合同状态
        ,t2.产品名称
from SJXQ_SJ2025020631_CST_01       t1
left join SJXQ_SJ2025020631_CST_02  t2
on t1.ctr_serno=t2.合同流水号
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST_04 AS
SELECT  B1.cst_id              AS 客户号
       ,B1.ctr_serno           AS 合同流水号
       ,t2.pd_nm    as 产品名称
       ,B1.rel_serno           AS 用信申请流水号
       ,B1.ctr_bgn_dt          AS 合同起始日期
       ,B2.app_cst_rol_cd      AS 预评估客户角色代码
       ,B4.cd_val_dscr         AS 预评估客户角色
       ,B2.cst_id              AS 预评估客户号
       ,B2.pre_ases_rslt_serno AS 预评估结果流水号
       ,B2.rul_set_rslt_cd     AS 预评估结果代码
       ,B3.cd_val_dscr         AS 预评估结果
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B1 --合同基础信息
LEFT JOIN edw.dim_bus_loan_prd_frml_dd     t2
on b1.prd_no=t2.prd_no
and t2.dt='20250131'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_rel_ases_dd B2 --授信关联预评估信息表
ON      B1.rel_serno = B2.usc_aply_serno
AND     B2.DT = '20250131'
LEFT JOIN    edw.dwd_code_library_dd B3 -- 码值表
ON      B2.rul_set_rslt_cd = B3.cd_val
AND     B3.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     B3.fld_nm = 'RUL_SET_RSLT_CD'
AND     B3.DT = '20250131'
LEFT JOIN    edw.dwd_code_library_dd B4 -- 码值表
ON      B2.APP_CST_ROL_CD = B4.cd_val
AND     B4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     B4.fld_nm = 'APP_CST_ROL_CD'
AND     B4.DT = '20250131'
WHERE   B1.dt = '20250131'
AND     SUBSTR(B1.mgr_org_id, 1, 4) = '3309'  --管护机构 嘉兴分行
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( B1.CTR_STS_CD IN ( '2' , '4' ) AND B1.TMT_DT = '18991231' AND to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )
         OR B1.CTR_BAL > 0 )
;
-- 根据名单匹配，600多合同号疑似客户号
SELECT * from lab_bigdata_dev.SJXQ_SJ2025020631_CST_03;
-- 直接取嘉兴分行所有合同预评估结果
SELECT * from lab_bigdata_dev.SJXQ_SJ2025020631_CST_04;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025020631_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025020631_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025020631_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025020631_CST_04
;
/*
01	32155	32155
02	77878	31552
03	78481	32155
04	140333	64512
*/***张家洪_SJ2025031281_现场走访.sql
﻿-- 客群
DROP   TABLE IF EXISTS SJXQ_SJ2025031281_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025031281_CST_01
(
    seq         string COMMENT ''
    ,cst_id     string COMMENT ''
)
;
insert into SJXQ_SJ2025031281_CST_01
values (1,'1038699688'),
    (2,'1602322597'),
    (3,'1605756954'),
    (4,'1623678453'),
    (5,'1644141527'),
    (6,'1645930103'),
    (7,'1651400404'),
    (8,'1655810229'),
    (9,'1732281576'),
    (10,'1733023740'),
    (11,'1734631005'),
    (12,'2000891680'),
    (13,'2604915154'),
    (14,'2609300676'),
    (15,'2616940942'),
    (16,'2628241492'),
    (17,'2628452548'),
    (18,'2629003039'),
    (19,'2629189512'),
    (20,'2630904947'),
    (21,'7005428547'),
    (22,'7005655268'),
    (23,'7638558538'),
    (24,'7644790290'),
    (25,'7687995692'),
    (26,'7711751412'),
    (27,'7723731911'),
    (28,'8000564834'),
    (29,'8601881794'),
    (30,'8602023692'),
    (31,'8603566174'),
    (32,'8606563221'),
    (33,'8609253922'),
    (34,'8609503500'),
    (35,'8614924991'),
    (36,'8629494415'),
    (101,'1603927806'),
    (102,'1604177296'),
    (103,'1605608201'),
    (104,'1611240296'),
    (105,'1613484210'),
    (106,'1614675517'),
    (107,'1615885552'),
    (108,'1619404612'),
    (109,'1622758493'),
    (110,'1632158344'),
    (111,'1636446011'),
    (112,'1643612485'),
    (113,'1649428713'),
    (114,'1651750494'),
    (115,'1656388156'),
    (116,'1675326112'),
    (117,'1678448584'),
    (118,'1679465243'),
    (119,'1683847572'),
    (120,'2600265670'),
    (121,'2600992331'),
    (122,'2602570127'),
    (123,'2602626602'),
    (124,'2603624770'),
    (125,'2604705923'),
    (126,'2605057295'),
    (127,'2605144553'),
    (128,'2605287083'),
    (129,'2606930902'),
    (130,'2606963377'),
    (131,'2609526875'),
    (132,'2613245711'),
    (133,'2614387078'),
    (134,'2616332187'),
    (135,'7615991439'),
    (136,'7626393934'),
    (137,'7627863910'),
    (138,'7642693378'),
    (139,'7642743728'),
    (140,'7673879937'),
    (141,'7684651458'),
    (142,'7685782838'),
    (143,'7687202030'),
    (144,'7688106851'),
    (145,'7690019230'),
    (146,'7694764776'),
    (147,'7694973027'),
    (148,'7712912250'),
    (149,'8000564175'),
    (150,'8000564339'),
    (151,'8601072677'),
    (152,'8601142250'),
    (153,'8601859598'),
    (154,'8601994933'),
    (155,'8602075445'),
    (156,'8602260587'),
    (157,'8602748644'),
    (158,'8604739620'),
    (159,'8605832755'),
    (160,'8606671384'),
    (161,'8607152581'),
    (162,'8609462393')
;
-- 客户调查记录信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025031281_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031281_CST_02 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as svy_mod_nm
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.cst_rol_cd               --客户角色代码|C2
    ,t1.adiv                     --行政区划|C12
    ,t1.svy_addr                 --调查地址
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c2.cd_val_dscr          as svy_addr_typ_nm
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t2.参与人岗位姓名
    ,t1.svy_ctnt_and_rslt        --调查内容及结果|C4000
    ,t1.rmk                      --备注|c4000
    ,t1.lct_nd_mid_grd_audt_ind  --定位需中台审核标志|C1
    ,t1.sys_reg_tm
    ,t3.调查对象名称
    ,t3.调查对象关系及名称
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join(
    SELECT rel_serno
    from edw.loan_svy_rcd_rel_pcpt_inf  --调查记录关联参与人信息
    where dt='@@{yyyyMMdd}'
    and del_ind='0'
    GROUP BY rel_serno
)t2 on t1.svy_rcd_serno=t2.rel_serno
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt=t1.dt
left join(
    SELECT t1.rel_serno
    from edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd    t1
    LEFT JOIN    EDW.dwd_code_library_dd                c1
    ON      T1.with_be_svy_psn_rel_cd = C1.CD_VAL
    and     c1.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and nvl(t1.svy_obj_nm,'')<>''
    GROUP BY t1.rel_serno
) t3 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t3.rel_serno --关联流水号
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
select *
from(
    SElECT t1.seq,t1.cst_id
        ,t2.pcp_psn_nm               --参与人姓名|C200
        ,t3.max_svy_dt
        ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.sys_reg_tm DESC ) AS rn --最近一次调查
    from SJXQ_SJ2025031281_CST_01 t1
    left join SJXQ_SJ2025031281_CST_02 t2
    on t1.cst_id=t2.cst_Id
    and t2.svy_dt>='20250101'
    and t2.svy_mod_cd = '01'    --现场（实地）
    left join(
        SELECT cst_id,max(svy_dt) max_svy_dt
        from SJXQ_SJ2025031281_CST_02
        where svy_mod_cd = '01'    --现场（实地）
        GROUP BY cst_id
    )t3 on t1.cst_id=t3.cst_Id
)t where rn=1
order by seq
;
***张家洪_SJ20250519111_现场实地参与调查人.sql
/*
1.附表清单内客户在信贷系统&ldquo;客户基本信息&mdash;&mdash;接触历史&rdquo;模块，调查日期为2025年的现场（实地）&ldquo;参与调查人&rdquo;信息；
2.抓取的信息烦请在附件清单&rdquo;参与调查人&ldquo;一列填入即可；
20241101-20250430 现场（实地）&ldquo;参与调查人&rdquo;信息
*/
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250519111_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250519111_CST_01 AS
SELECT  col_1  --客户号
       ,col_2  --客户名称
       ,col_3  --所属机构
       ,col_4  --合同金额
       ,col_5  --名单类型
from lab_bigdata_dev.qbi_file_20250521_09_12_04_0
where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250519111_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250519111_CST_02 AS
select t1.cst_id,t1.svy_dt
from(
    SELECT  t1.svy_mod_cd               --调查方式代码|C2
        ,c1.cd_val_dscr          as svy_mod_nm --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
        ,t1.svy_dt                   --调查日期|C8
        ,t1.cst_id                   --客户号|C20
        ,t1.pcp_mnl_no               --参与人工号|C20
        ,t1.pcp_psn_nm               --参与人姓名|C200
        ,t1.rmk                      --备注|c4000
        ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
    from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
    LEFT JOIN    EDW.dwd_code_library_dd  c1
    ON      T1.SVY_MOD_CD = c1.CD_VAL
    AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
    AND     c1.FLD_NM = 'SVY_MOD_CD'
    and     c1.dt=t1.dt
    inner join(
        select distinct col_1 as cst_id
        from SJXQ_SJ20250519111_CST_01
    )t2 on t1.cst_id=t2.cst_id
    where t1.dt='@@{yyyyMMdd}'
    and T1.SVY_MOD_CD='01'  --01:现场（实地）
    and t1.svy_dt between '20241101' and '20250430'
)t1 group by t1.cst_id,t1.svy_dt
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250519111_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250519111_CST_03 AS
SELECT  t1.col_1  as 客户号
       ,t1.col_2  as 客户名称
       ,t1.col_3  as 所属机构
       ,t1.col_4  as 合同金额
       ,t1.col_5  as 名单类型
       ,t2.pcp_psn_nm   as 参与调查人
from SJXQ_SJ20250519111_CST_01      t1
left join (
    select cst_id
    from SJXQ_SJ20250519111_CST_02
    group by cst_id
) t2 on t1.col_1=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ20250519111_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250519111_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250519111_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20250519111_CST_03
;
SELECT  *
FROM    edw.loan_admin_sm_lookup_dict --数据字典内容表
AND     UP_LOOKUP_ITEM_ID <> '-1'
AND     DT='20250519'
ORDER BY LOOKUP_ITEM_CODE***张文文_SJ2025040711_信贷客户地址.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 于彪
-- 创建日期: 2025-04-09 15:27:35
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 截至2025年3月31日，舟山分行他行有贷款我行无贷款客户根据客户号筛选对应数据。
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025040711_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040711_CST_01 AS
SELECT  col_1  as cst_id --客户号
       ,col_2  as cst_nm --客户名称
from lab_bigdata_dev.qbi_file_20250409_09_02_46_0
where pt<>''
;
-- 地址
DROP   TABLE IF     EXISTS SJXQ_SJ2025040711_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040711_CST_02 AS
SELECT  t1.cst_id
       ,t2.dtl_addr        AS 信贷经营地址
       ,t3.dtl_addr        AS 信贷户籍地址
       ,t4.dtl_addr        AS 信贷居住地址
       ,t5.dtl_addr        AS 信贷办公地址
       ,t6.dtl_addr        AS 信贷注册地址
       ,t7.dtl_addr        AS 信贷主地址
       ,c1.cd_val_dscr     AS 信贷主地址类型
from(
    select distinct cst_id
    from SJXQ_SJ2025040711_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250331' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250331' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '20250331' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --家庭地址
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '20250331' and t5.del_ind='0' 	--未删除
AND t5.addr_typ = '050400' --办公地址
LEFT JOIN edw.loan_cst_ctc_addr t6
ON t1.cst_id = t6.cst_id and t6.del_ind='0' 	--未删除
AND t6.dt = '20250331'
AND t6.addr_typ = '050800' --注册地址
LEFT JOIN edw.loan_cst_ctc_addr t7
ON t1.cst_id = t7.cst_id and t7.del_ind='0' 	--未删除
AND t7.dt = '20250331'
AND t7.main_addr_ind = '1' --主地址
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t7.addr_typ=c1.cd_val
and C1.DT = '20250331'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040711_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040711_CST_03 AS
SELECT  t1.cst_id AS 客户号
       ,t1.cst_nm AS 客户名称
       ,t2.信贷主地址类型
       ,t2.信贷居住地址
       ,t2.信贷户籍地址
       ,t2.信贷办公地址
       ,t2.信贷经营地址
       ,t2.信贷注册地址
       --, t3.prm_mgr_id, t3.prm_mgr_nm, t3.prm_org_id
       ,t6.sub_cmnt_id                                                   AS 子社区编号
       ,t7.cmnt_nm                                                       AS 子社区名称
       ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND T3.PRM_MGR_ID = T8.EMPLOY_NO THEN 'Y'          --子社区主维护人是否等于客户管护人
             WHEN COALESCE(T6.SUB_CMNT_ID,'') = '' THEN ''  ELSE '' END AS 是否为主维护人子社区
       ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND T3.PRM_MGR_ID REGEXP T10.EMPLOY_NO THEN 'Y'    --客户管护人是否是子社区的定人之一
             WHEN COALESCE(T6.SUB_CMNT_ID,'') = '' THEN ''  ELSE '' END AS 是否为定人子社区
       ,t4.file_dt                                                       AS 建档日期
       ,CASE WHEN t5.cst_id is not null THEN 'Y'  ELSE '' END            AS 是否正式客户
    --最大终结日期在6个月内且最小终结日期不等于18991231：6个月内终结且无未终结合同
    and t12.tmt_dt_max<='@@{yyyyMMdd}' and t12.ctr_mtu_dt_max<='@@{yyyyMMdd}'
    and t12.tmt_dt_min<>'18991231' then '1' else '0' end 是否为6个月内流失客户
from SJXQ_SJ2025040711_CST_01       t1
left join SJXQ_SJ2025040711_CST_02  t2
on t1.cst_id=t2.cst_id
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250331'
left join edw.dws_cst_bas_inf_dd	t4 --客户基础信息汇总表
on  t1.cst_id = t4.cst_id
and t4.dt = '20250331'
left join adm_pub.adm_csm_cbas_mng_inf_dd	t5 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t5.cst_id
and t5.dt = '20250331'
and t5.forml_cst_ind = '1'	--正式客户标识
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20250331'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
LEFT JOIN    edw.XWDT_ETL_XW_COMMUNITY_PER T8 --普惠社区定人信息表
ON      t6.SUB_CMNT_ID = T8.COMMUNITY_CODE --社区编号
AND     T8.IS_MAIN_PERSON = '1' --主维护人
AND     T8.DT = t6.dt
LEFT JOIN
(
	SELECT  COMMUNITY_CODE
	FROM edw.XWDT_ETL_XW_COMMUNITY_PER --普惠社区定人信息表
	WHERE dt = '20250331'
	AND IS_MAIN_PERSON = '2' ---- 1主维护人，2社区定人
	GROUP BY  COMMUNITY_CODE
) T10
ON T6.SUB_CMNT_ID = T10.COMMUNITY_CODE --社区编号
left join(
    SELECT cst_id
        ,max(tmt_dt)  tmt_dt_max
        ,min(tmt_dt)  tmt_dt_min
        ,max(ctr_mtu_dt)  ctr_mtu_dt_max
    from edw.dim_bus_loan_ctr_bse_inf_dd
    where dt='20250331'
    GROUP BY cst_id
) t12 on t1.cst_id = t12.cst_id --信贷合同信息
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040711_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040711_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025040711_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025040711_CST_03
;
/*
01	8093	8093
02	8093	8093
03	8093	8093
*/
***张文文_SJ20250708161_存款流失客户.sql
﻿-- 张文文_SJ20250708161_存款流失客户
-- 2020年8月3日-2025年7月8日，舟山分行城南支行存款数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250708161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250708161_CST_01 AS
select t1.dep_act_id                               --存款账号|C8
	,t1.act_nm                                   --账户名称|C200
	,t1.cst_act_id                               --客户账号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.ccy_cd                                   --货币代码|C3
	,t1.prod_id                                  --产品编号|C24
    ,t2.pd_cmt                                   --产品说明
	,t1.act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     as 账户状态
	,t1.bal_itm_id                               --余额科目编号|C12
	,t1.dep_trm                                  --存期|C6
	,t1.mtu_dt                                   --到期日期|C8
	,t1.act_afl_org                              --账户所属机构|C12
	,t1.opn_org                                  --开户机构|C12
    ,t4.sbr_org_nm
    ,t4.org_nm as 开户机构
	,t1.opn_dt                                   --开户日期|C8
	,t1.opn_amt                                  --开户金额
	,t1.act_dstr_act_dt                          --账户销户日期|C8
	,t1.cur_act_bal                              --当前账户余额
	,t1.gl_bal                                   --总账余额
	,t1.bal_late_upd_dt                          --余额最近更新日期
	,t1.frs_dep_dt                               --首次存入日期|C8
	,t1.lbl_prod_typ_cd                          --负债产品类型代码|C1
    ,decode(t1.lbl_prod_typ_cd,'0','活期','1','定期') as 负债产品类型
from edw.dim_bus_dep_act_inf_dd             t1 --存款账户信息
left join edw.dim_bus_dep_pd_bas_inf_dd	    t2 --存款产品基础信息表
on t1.prod_id=t2.pd_id
and t2.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='舟山分行'
and t4.sbr_org_nm regexp '城南'
left join edw.dwd_code_library_dd   c1
on t1.act_sts_cd = c1.cd_val
and c1.dt = t1.dt
where t1.dt='20250708'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250708161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250708161_CST_02 AS
select t1.cst_id                                   as 客户号
	,t1.act_nm                                   as 账户名称
	,t1.cst_act_id                               as 客户账号
    ,t1.dep_act_id                               as 存款账号
	,t1.prod_id                                  as 产品编号
    ,t1.pd_cmt                                   as 产品说明
	,t1.act_sts_cd                               as 账户状态代码
    ,t1.账户状态
	,t1.bal_itm_id                               as 余额科目编号
	,t1.dep_trm                                  as 存期
	,t1.act_afl_org                              as 账户所属机构号
    ,t1.开户机构
	,t1.opn_dt                                   as 开户日期
	,t1.opn_amt                                  as 开户金额
	,t1.mtu_dt                                   as 到期日期
	,t1.act_dstr_act_dt                          as 账户销户日期
	,t1.cur_act_bal                              as 当前账户余额
	,t1.gl_bal                                   as 总账余额
	,t1.bal_late_upd_dt                          as 余额最近更新日
	,t1.frs_dep_dt                               as 首次存入日期
    ,t1.负债产品类型
    ,t2.mgr_id                                   as 账户管护人编号
    ,t3.empe_nm     as 账户管护人
	,t2.mgr_rto                                  as 管护比例
	,t2.acs_org_id                               as 账户管护机构编号
    ,t4.org_nm      as 账户管护机构
from SJXQ_SJ20250708161_CST_01                  t1
left join edw.dwd_bus_dep_cst_act_mgr_inf_dd    t2 --客户存款账户管护信息
on t1.cst_act_id=t2.cst_act_id
and t2.dt='20250708'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  t2.mgr_id=t3.empe_id
and t3.dt='20250708'
left join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树
on  t2.acs_org_id = t4.org_id
and t4.dt = '20250708'
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ20250708161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250708161_CST_02
;
/*
01	24720	24720
02	24756	8118
*/
SElECT '02' seq, *
from SJXQ_SJ20250708161_CST_02
***张星星_SJ2025053001_票据中介客户背书转让.sql
-- 2.取客户截至当前的最新管控措施信息：非柜面限制设置（暂停非柜面），具体非柜面限额控制、止付状态（不收不付、只收不付等）
-- 账户状态（销户、正常等）、冻结状态、信贷业务状态（终止、未结清等）
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_01 AS
SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,ACT_STOP_PMT_TYP --止付类型
from(
    SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
        ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
        ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.dt
    left join edw.dwd_code_library_dd   c2
    on t1.frz_cls_cd = c2.cd_val
    and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
    and c2.dt=t1.dt
    WHERE   t1.DT = '20250529'
    AND     t1.FRZ_SRC_CD='2'  --止付
    AND     t1.NFRZ_IND = '0'
)t1 where t1.rn=1
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_02 AS
select cst_act_id,frz_dt,frz_rsn
    ,frz_cls_cd,frz_cls
from(
    SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
        ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.dt
    WHERE   T1.DT = '20250529'
    AND     T1.FRZ_SRC_CD='1'  --冻结
    AND     T1.NFRZ_IND = '0'
)t1 where t1.rn=1
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_03 AS
select cst_act_id,lmt_eft_dt,close_fg_rsn
from(
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '20250529'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t1 where t1.rn=1
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_04 AS
SELECT  cengcgjz    cst_act_id
    ,max(danciedu)   fg_per_lmt
    ,max(leijiedu)   fg_day_lmt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '20250529'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
group by cengcgjz
;
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_05 AS
SELECT  col_1  as cst_id --客户号
       ,col_2  as cst_nm --客户名称
from lab_bigdata_dev.qbi_file_20250530_11_22_36_0
where pt<>''
;
-- 信贷业务状态（终止、未结清等）
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_06 AS
select cst_id,max(is_wjq) as is_wjq
from(
    SELECT  t1.cst_id --客户号|C20
        ,CASE WHEN ( ( t1.CTR_STS_CD IN ( '2' ,'4' ) AND t1.TMT_DT = '18991231' AND to_date(t1.CTR_MTU_DT,'yyyyMMdd') >= to_date(t1.dt,'yyyyMMdd') )
            OR t1.CTR_BAL > 0 ) THEN 1  ELSE 0 END AS is_wjq
        ,c1.cd_val_dscr AS CTR_STS
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    left join edw.dwd_code_library_dd           C1
    ON  T1.CTR_STS_CD = C1.CD_VAL
    AND C1.FLD_NM='CTR_STS_CD'
    AND C1.DT = '20250529'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250529'
)t1 group by t1.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025053001_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053001_CST_07 AS
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_nm     AS 客户名称
       ,t2.cst_act_id AS 客户账号
       ,t2.act_sts_cd AS 账户状态
    ,CASE WHEN T8.cst_act_id IS NULL     THEN '否'
           WHEN T8.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,T8.fg_per_lmt                      AS 非柜单笔限额
    ,T8.fg_day_lmt                      AS 非柜日累计限额
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,case when t3.is_wjq=1 then '是' when t3.is_wjq=0 then '否' else null end as 是否未结清
    ,case when t3.is_wjq=1 then t3.wjq_CTR_STS else t3.jq_CTR_STS end as 合同状态
from SJXQ_SJ2025053001_CST_05               t1
left join edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250529'
left join SJXQ_SJ2025053001_CST_06  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025053001_CST_01 t5 --止付
on t2.cst_act_id=t5.cst_act_id
left join SJXQ_SJ2025053001_CST_02 t6 --冻结
on t2.cst_act_id=t6.cst_act_id
left join SJXQ_SJ2025053001_CST_03 t7 --关闭非柜面
on t2.cst_act_id=t7.cst_act_id
left join SJXQ_SJ2025053001_CST_04 t8 --非柜面限额
on t2.cst_act_id=t8.cst_act_id
left join edw.dwd_code_library_dd           C1
ON  T2.act_sts_cd = C1.CD_VAL
AND C1.FLD_NM='ACT_STS_CD'
AND C1.DT = '20250529'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025053001_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025053001_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025053001_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025053001_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025053001_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025053001_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025053001_CST_07
;
SElECT '07' seq, *
from SJXQ_SJ2025053001_CST_07
***张星星_SJ20250609126_对公身份识别.sql
-- ①对公客户，证件类型非&ldquo;A0500-营业执照&rdquo;&ldquo;A0200-组织机构代码证&rdquo;、&ldquo;A0100-统一社会信用代码证&rdquo;的；
-- ②客户账户未管控的，需剔除已销户、只收不付、不收不付、不动户、转营业外收入等；（暂停非柜不算）
-- ③时间：截至20250530的存量客户，覆盖分村行；
DROP   TABLE IF     EXISTS SJXQ_SJ20250609126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250609126_CST_01 AS
SELECT  t4.brc_org_id    AS 主管户分行
       ,t4.brc_org_nm    AS 主管户分行名称
       ,A.PARTY_ID       AS 客户号
       ,A.PARTY_CHN_NAME AS 客户名称
       ,A.CARD_TYPE      AS 证件类型
       ,A.CARD_NO        AS 证件号码
       ,G.ORG_ORG_TYP_CD AS 组织机构类型
       ,B.ACCT_NUM       AS 客户账号
       ,c1.org_nm       AS 开户机构
       ,b.open_dt        AS 开户时间
       ,B.HX_STATUS_CD   AS 账户状态 --A:正常 C:销户 E:封闭冻结 H:待启用 Y:预销户 B:不动户 D:久悬户 F:金额冻结 G:未启用 I:转营业外收入
       ,B.CTRL_STS_CD    AS 控制状态 --1暂停非柜、2只收不付、3不收不付、4只付不收
       ,CASE WHEN COALESCE(C.PARTY_ID,'') = '' THEN '否'  ELSE '是' END as 是否有未结清贷款
       ,D.LAST_OCCUR_DT       as 最近动账日期_客户级
       ,B.AMT_VAL             as 账户余额
       ,D.SUM_BAL             as 总账余额_客户级
       ,E.CST_CNT_CTC_CTC_MTH as 客户柜面联系人联系方式
       ,A1.LEGAL_TEL          as 客户法定代表人联系方式
       ,F.PRM_MGR_ID          as 主管户客户经理
       ,F.PRM_MGR_NM          as 主管户客户经理名称
       ,F.PRM_ORG_ID          as 主管户机构
       ,F.PRM_ORG_NM          as 主管户机构名称
FROM adm_upss.ADM_UPSS_AML_T47_PARTY            A --反洗钱客户表
INNER JOIN adm_upss.ADM_UPSS_AML_T47_CORPORATION A1
ON A.PARTY_ID = A1.PARTY_ID
AND A1.DT = '20250531'
INNER JOIN adm_upss.ADM_UPSS_AML_T47_CP_DEPOSIT B --反洗钱对公账户表
ON A.PARTY_ID = B.PARTY_ID
AND B.DT = '20250531'
AND B.HX_STATUS_CD NOT IN ( 'C' , 'B' , 'I' )   --剔除销户、不动户、转营业外收入
AND B.CTRL_STS_CD NOT IN ( '2' , '3' )          --剔除管控账户
AND B.ACCT_TYPE_CD = 'DEP' --核心账户
LEFT JOIN
(
	SELECT  DISTINCT PARTY_ID
	FROM adm_upss.ADM_UPSS_AML_T47_LOAN_ACCT
	WHERE DT = '20250531'
	AND ACCT_STATUS_CD <> '1' --未结清
) C ON A.PARTY_ID = C.PARTY_ID
LEFT JOIN
(
	SELECT  PARTY_ID
	       ,LAST_OCCUR_DT --上笔发生日期
	       ,SUM(COALESCE(AMT_VAL,0)) OVER ( PARTITION BY PARTY_ID )                 AS SUM_BAL --总账余额
	       ,ROW_NUMBER() OVER ( PARTITION BY PARTY_ID ORDER BY LAST_OCCUR_DT DESC ) AS RN
	FROM adm_upss.ADM_UPSS_AML_T47_CP_DEPOSIT --反洗钱对公账户表
	WHERE DT = '20250531'
	AND ACCT_TYPE_CD = 'DEP' --核心账户
) D ON A.PARTY_ID = D.PARTY_ID AND D.RN = 1
LEFT JOIN
(
	SELECT  A.CST_ID                  AS CST_ID --客户号
	FROM edw.DIM_CST_ENTP_BAS_INF_DD A --企业客户基本信息
	LEFT JOIN edw.DIM_CST_REL_INF_DD B --客户关联关系信息
	ON A.CST_ID = B.CST_ID
    AND B.REL_TYP_CD = '0801'   --柜面联系人
    AND B.DT = '20250531'
	LEFT JOIN
	(
		SELECT  CST_ID  AS CST_ID
		       ,TEL_NBR AS TEL_NBR --电话号码
		FROM edw.DIM_CST_BAS_TEL_INF_DD --客户电话信息
		WHERE TEL_TYP_CD = '010000' --电话类型代码 010000:手机号
		AND DT = '20250531'
		UNION
		SELECT  REL_CST_ID AS CST_ID --关系客户编号
		       ,CTC_MTH    AS TEL_NBR --联系方式
		FROM edw.DIM_CST_REL_IDV_INF_DD --客户行外个人关系人信息
		WHERE DT = '20250531'
	) C
	ON b.rel_cst_id = C.CST_ID
	WHERE A.DT = '20250531'
	GROUP BY  A.CST_ID
) E
ON SUBSTR(A.PARTY_ID, 3) = E.CST_ID
LEFT JOIN adm_pub_app.ADM_PBLC_CST_PRM_MNG_INF_DD F --客户管户信息
ON SUBSTR(A.PARTY_ID, 3) = F.CST_ID
AND F.DT = '20250531'
inner join edw.dim_hr_org_mng_org_tree_dd         t4 --考核机构树
on  F.prm_org_id = t4.org_id
and t4.dt = '20250531'
and t4.brc_org_nm regexp '分行|村镇银行'
LEFT JOIN
(
	SELECT  T1.CST_ID
	    ,CONCAT(Z1.code_sou,'-',Z1.code_sou_des) AS ORG_ORG_TYP_CD
	FROM edw.DIM_CST_ENTP_BAS_INF_DD        T1
	LEFT JOIN adm_upss.AML_T87_ETL_CODE_MAP Z1
	ON Z1.CODE_SOU = T1.ORG_ORG_TYP_CD
    AND Z1.CODE_TYPE = '8097' --单位性质
    AND Z1.DT = '20250531'
	WHERE T1.DT = '20250531'
) G
ON SUBSTR(A.PARTY_ID, 3) = G.CST_ID
inner join edw.dim_hr_org_mng_org_tree_dd            c1 --考核机构树
on  b.organkey = c1.org_id
and c1.dt = '20250531'
WHERE A.DT = '20250531'
AND A.PARTY_CLASS_CD = 'C' --对公客户
AND A.CARD_TYPE NOT IN ( '610099' , '610001' , '610047' ) --610099-统一社会信用代码（五证合一号码）、610001-全国组织机构代码、610047-企业营业执照号码
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250609126_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ20250609126_CST_01
***张星星_SJ2025062656_反洗钱问题整改评估.sql
﻿-- 张星星_SJ2025062656_反洗钱问题整改评估
/*
数据日期：截至目前；
数据范围：分村行；
口径维度：①对私客户证件过期6个月以上；②判断客户账户为正常状态；
③筛选未管控的情形：（1）账户无止付；（2）账户已止付了，但是&ldquo;止付种类&rdquo;都不是&ldquo;47-证件到期控制&rdquo;或&ldquo;01-证件到期止付&rdquo;的；
（3）账户已止付了，且当前有效的&ldquo;止付种类&rdquo;有多种情形，且其中一种为&ldquo;47-证件到期控制&rdquo;或&ldquo;01-证件到期止付&rdquo;，
但是证件到期止付的止付日期开启日期 晚于 其他止付种类的 止付开启日期，且证件到期止付对应的轮候标志为&ldquo;否&rdquo;。
备注：1.涉及表 客户账户表、止付明细表 等；2.判断止付有效，通过止付到期日来判断，未到期即有效。
数据需求字段
输出字段：
客户号、客户账号、证件到期日、证件过期月份或天数、账户状态、当前账户止付情况（是，否）、当前账户止付种类、
当前账户止付轮候标志、止付原因、止付开始日期、止付到期日期、所属分行、开户机构、开户日期；
*/
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ2025062656_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062656_CST_01 AS
select distinct t1.cst_act_id                    --客户账号
    ,t1.lbl_act_id	                             --负债账号
    ,t1.frz_opr_cd                               --冻结操作代码
    ,t1.frz_scp_cd                               --冻结范围代码
    ,c3.cd_val_dscr     as 止付范围
    ,t1.frz_src_cd                               --冻结来源代码
    ,t1.frz_cls_cd                               --冻结种类代码 47-证件到期控制
    ,c1.cd_val_dscr     as 止付种类
    ,t1.frz_dt                                   --冻结日期
    ,t1.frz_bgn_dt                               --冻结起始日期
    ,t1.frz_tmn_dt                               --冻结终止日期
    ,t1.frz_rsn                                  --冻结原因
    ,t1.trx_org_id                               --交易机构编号
    ,t1.act_stop_pmt_typ_cd                      --账户止付类型 01-证件到期止付
    ,c2.cd_val_dscr     as 止付类型
    ,t2.is_wat_ind                               --是否轮候标志|c1
    ,t2.frz_wat_seq	    --冻结轮候序号
    ,case when t1.frz_cls_cd='47' then 1
        when t1.act_stop_pmt_typ_cd='01' then 2
        when (t1.frz_rsn regexp '证件' and t1.frz_rsn regexp '过期|止付') then 3
        when (t1.frz_rsn regexp '证件到期|身份证到期' and t1.frz_rsn not regexp '到期日') then 4 else 0 end as is_zj_mtu
FROM    edw.dwd_bus_dep_frz_inf_dd      t1  --账户冻结登记
left join edw.dwd_bus_dep_frz_masf_dd   t2 --存款账户冻结主档
on t1.frz_id=t2.frz_id
and t1.lbl_act_id=t2.lbl_act_id
and t2.dt=t1.dt
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt=t1.dt
left join edw.dwd_code_library_dd   c2
on t1.ACT_STOP_PMT_TYP_CD = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt=t1.dt
left join edw.dwd_code_library_dd   c3
on t1.frz_scp_cd = c3.cd_val
and c3.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c3.dt=t1.dt
WHERE   t1.DT = '@@{yyyyMMdd}'
AND t1.FRZ_SRC_CD='2'   --止付
AND t1.NFRZ_IND = '0'   --解冻标志 0否|1是 未解冻
and t1.frz_tmn_dt > '@@{yyyyMMdd}'  --止付有效
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025062656_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062656_CST_02 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.doc_mtu_dt                               --证件到期日期|C8
    ,t2.cst_act_id
	,t2.act_sts_cd                               --账户状态代码|C1
	,t2.opn_org_id                               --开户机构编号|C12
    ,t3.brc_org_nm  as 开户分行
    ,t3.org_nm      as 开户机构
	,t2.opn_dt                                   --开户日期|C8
    ,case when t4.cst_act_id is not null then '是' else '否' end as 是否止付
    ,t4.is_zj_mtu
    ,t4.止付种类,t4.止付类型
    ,t4.是否轮候标志,t4.止付轮候序号
    ,t4.止付原因
    ,t4.止付起始日期
    ,t4.止付终止日期
    ,t4.frz_custs
    ,t4.证件到期止付起始日期
    ,t4.其他止付起始日期
    ,t4.证件到期轮候标志为否
from edw.dws_cst_bas_inf_dd                 t1 --客户基础信息汇总表
inner join edw.dim_bus_dep_cst_act_inf_dd   t2 --客户存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
and t2.act_sts_cd='A'   --客户账户为正常状态
left join edw.dim_hr_org_mng_org_tree_dd    t3 --考核维度_机构树
on t2.opn_org_id=t3.org_id
and t3.dt=t1.dt
left join(
    SELECT cst_act_id
        ,max(is_zj_mtu) as is_zj_mtu
        ,min(frz_bgn_dt)                     as 止付起始日期
        ,max(frz_tmn_dt)                     as 止付终止日期
        ,count(DISTINCT frz_cls_cd) as frz_custs
        ,min(case when is_zj_mtu<>0 then frz_bgn_dt end) as 证件到期止付起始日期
        ,min(case when is_zj_mtu=0 then frz_bgn_dt end) as 其他止付起始日期
        ,max(case when is_zj_mtu<>0 and  is_wat_ind='0' then 1 else 0 end)  as 证件到期轮候标志为否
    from SJXQ_SJ2025062656_CST_01
    GROUP BY cst_act_id
) t4 on t2.cst_act_id=t4.cst_act_id
where t1.dt='@@{yyyyMMdd}'
and t1.cst_typ_cd='1'  --个人
and t1.doc_mtu_dt<='@@{yyyyMMdd-6m}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025062656_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062656_CST_03 AS
select t1.cst_id                                 as 客户号
	,t1.cst_chn_nm                               as 客户姓名
    ,t1.cst_act_id as 客户账号
	,t1.doc_mtu_dt                               as 证件到期日期
    ,t1.证件过期天数
    ,'正常' as 账户状态
    ,t1.是否止付
    ,case when t1.doc_mtu_dt='18991231' then '证件到期日期缺失'
        when t1.是否止付='否' then '账户未止付-情形1'
        when t1.是否止付='是' and t1.is_zj_mtu=0 then '止付非证件到期-情形2'
        when t1.是否止付='是' and t1.frz_custs>1 and t1.is_zj_mtu<>0
            and 证件到期止付起始日期 > 其他止付起始日期
            and 证件到期轮候标志为否=1 then '止付证件到期-情形3'
        when t1.是否止付='是' and is_zj_mtu<>0 then '止付证件到期'
        else '其他' end as 未管控情形
    ,t2.账户类型
    ,t1.止付种类,t1.止付类型
    ,t1.止付原因
    ,t1.是否轮候标志
    ,t1.止付轮候序号
    ,t1.止付起始日期
    ,t1.止付终止日期
    ,t1.开户分行
    ,t1.开户机构
	,t1.opn_dt                                   as 开户日期
from SJXQ_SJ2025062656_CST_02           t1
left join(
    select cst_act_id
    from edw.dws_bus_dep_act_inf_dd     --存款账户信息汇总
    where dt='@@{yyyyMMdd}'
    GROUP BY cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id,lbl_act_id) custs
from SJXQ_SJ2025062656_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025062656_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025062656_CST_03
;
/*
01	3038890	2987487
02	844849	844849
03	844849	844849
止付证件到期	511218
证件到期日期缺失	183933
止付非证件到期-情形2	139407
账户未止付-情形1	10170
止付证件到期-情形3	121
SELECT '存款账户冻结登记簿' ind
    ,count(1) as cnt
    ,count(DISTINCT lbl_act_id) as lbl_act_id
    ,count(DISTINCT frz_id) as frz_id
    ,count(DISTINCT lbl_act_id,frz_id) lbl_act_id_frz_id
from edw.dwd_bus_dep_frz_inf_dd
where dt='@@{yyyyMMdd}'
;
-- 存款账户冻结登记簿	20937504	8184325	12070171	12070448
SELECT '存款账户冻结主档' ind
    ,count(1) as cnt
    ,count(DISTINCT lbl_act_id) as lbl_act_id
    ,count(DISTINCT frz_id) as frz_id
    ,count(DISTINCT lbl_act_id,frz_id) lbl_act_id_frz_id
from edw.dwd_bus_dep_frz_masf_dd
where dt='@@{yyyyMMdd}'
;
-- ind	cnt	lbl_act_id	frz_id	lbl_act_id_frz_id
-- 存款账户冻结主档	12070448	8184325	12070171	12070448
select *
from edw.dwd_bus_dep_frz_masf_dd   t2 --存款账户冻结主档
where  t2.dt='20250630'
and lbl_act_id='6214800609000007337'
*/
from SJXQ_SJ2025062656_CST_03
where 未管控情形='止付证件到期-情形3'
;
***张杰_SJ20250318131_客户盘点.sql
DROP   TABLE IF     EXISTS SJXQ_SJ20250318131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318131_CST_01 AS
SELECT  col_1  --合同号
       ,col_2  --客户号
       ,col_3  --客户名称
from qbi_file_20250320_15_02_28_0
where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250318131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318131_CST_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='@@{yyyyMMdd}' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250318131_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318131_CST_03 AS
SELECT  t1.col_1       AS 合同号
       ,t1.col_2       AS 客户号
       ,t1.col_3       AS 客户名称
       ,t2.scor_rng    AS 最新征信分段
       ,t3.ast_amt     AS 资产总额
       ,t3.lbl_tot_amt AS 负债总额
       ,t3.ast_lbl_rat AS 资产负债率
       ,t4.sal_amt     AS 销售额
from SJXQ_SJ20250318131_CST_01 t1
left join SJXQ_SJ20250318131_CST_02 t2
on t1.col_2=t2.cst_id
and t2.rn=1
left join(
	select cst_id                                   --客户号|c20
		,rcd_tm                                   --记录时间|c20
		,ast_amt                                  --资产总额|decimal(21,2)
		,lbl_tot_amt                              --负债总额|decimal(21,2)
		,ast_lbl_rat                              --资产负债率|decimal(10,6)
		,slf_ast_amt                              --本人资产总额|decimal(21,2)
		,slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
		,slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
		,last_upd_tm                              --最后更新时间|C19
		,row_number() over(partition by cst_id order by rcd_tm desc) rn
	from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
	where dt='@@{yyyyMMdd}'
)t3 on t1.col_2=t3.cst_id
and t3.rn=1
left join(
	select svy_rpt_no                               --调查报告编号|c(32)
		,cst_id                                   --客户号|c(20)
		,sal_amt                                  --销售额|decimal(21,2)
		,sys_reg_tm                               --系统登记时间|c19
		,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	from edw.dwd_bus_loan_svy_cst_opr_sal_amt_and_npft_dd --调查报告-经营信息销售额及净利润信息
	where dt='@@{yyyyMMdd}'
)t4 on t1.col_2=t4.cst_id
and t4.rn=1
;
SElECT '03' seq, *
from SJXQ_SJ20250318131_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ20250318131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250318131_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250318131_CST_03
***徐倩倩_SJ2025021156_泰惠券活动产效.sql
﻿-- 绍兴分行，已参与并使用泰惠券的客户，2024月10月底的产效和2025年1月底的产效情况
-- 活动名称为&ldquo;泰隆新春活动&rdquo;&ldquo;烟火-绍兴分行-泰隆请你逛商超&rdquo;&ldquo;烟火-绍兴分行-泰隆请你逛菜场&rdquo;&ldquo;烟火-绍兴分行-泰隆请你吃早餐&rdquo;
DROP   TABLE IF     EXISTS SJXQ_SJ2025021156_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021156_CST_01 AS
SELECT t1.id act_id                              --主键Id
	,t1.activity_name                            --营销活动名称
	,t1.begin_time                               --营销开始时间
	,t1.end_time                                 --营销结束时间
    ,t1.createtime
	,t1.activity_initiator                       --营销活动发起人
	,t1.activity_initiator_name                  --营销活动发起人名称
	,t1.activity_initial_org                     --营销发起机构
	,t1.activity_initial_org_name                --营销发起机构名称
	-- ,t1.community_name                           --社区活动名称
	-- ,t1.community_code                           --社区编码
	-- ,t1.act_site                                 --活动地点
	-- ,t1.activity_parent_org                      --营销发起分行机构
	,t1.activity_parent_org_name                 --营销发起分行机构名称
	,t1.act_leader                               --活动负责人
	,t1.act_leader_name                          --活动负责人名称
	,t1.act_leader_org_code                      --活动负责人机构
	,t1.websites_org                             --线下活动所属机构
	,t1.websites_org_name                        --线下活动所属机构名称
	,t1.on_line_act                              --1 线上 2 线下 3 全民营销 4白名单5定向推送6.营销用例
	,t1.create_src                               --活动创建来源 mp营销平台 xw小微
    -- ,t2.cst_id
	-- ,t2.is_favorite                              --感兴趣
	-- ,t2.is_attend                                --参与次数
    -- ,t2.create_time	    --创建时间
from   edw.qmyx_marketing_base              t1
-- inner join edw.qmyx_act_x_cst_record        t2 --营销结果客户反馈表
-- on  t1.id = t2.act_id
-- and t2.dt='@@{yyyyMMdd}'
-- AND t2.IS_ATTEND>0
-- AND LENGTH(t2.cst_id)>0
where t1.dt = '@@{yyyyMMdd}'
and t1.activity_initial_org like '3307%'    --绍兴分行
and t1.AWARD_FLAG = '1'     --是否赠送奖励，1是，0否
-- and t1.community_flag='1'     --社区活动
and substr(t1.createtime,1,7) >= '2024-11'
;
select cst_id                                   --客户号
	,acm_ftp_inc                              --当日FTP利润
	,acm_dep_ftp_inc                          --当日FTP存款利润
	,acm_loan_ftp_inc                         --当日FTP贷款利润
	,acm_fnc_ftp_inc                          --当日FTP理财利润
	,cur_mon_ftp_inc                          --当月FTP利润收入
	,cur_mon_dep_ftp_inc                      --当月存款FTP利润收入
	,cur_mon_loan_ftp_inc                     --当月贷款FTP利润收入
	,cur_mon_fnc_ftp_inc                      --当月理财FTP利润收入
	,cur_year_ftp_inc                         --当年FTP利润收入
	,cur_year_dep_ftp_inc                     --当年存款FTP利润收入
	,cur_year_loan_ftp_inc                    --当年贷款FTP利润收入
	,cur_year_fnc_ftp_inc                     --当年理财FTP利润收入
	,last_12_mon_own_ftp_ctb                  --近12个月我行综合FTP贡献
	,last_90_loan_ftp_bus_inc_avg             --近90天贷款FTP营收日均
	,last_90_dep_ftp_bus_inc_avg              --近90天存款FTP营收日均
from adm_pub.adm_csm_cbus_ftp_inf_dd          --客户集市-业务信息-客户FTP业务
where dt='@@{yyyyMMdd}'
;
dep_bal_mon_avg	decimal	存款余额月日均
adm_pub.adm_csm_cbus_dep_inf_dd 		--存款业务信息表
loan_bal_acs_mon_avg	decimal	贷款余额月日均
adm_pub.adm_csm_cbus_loan_inf_dd 		--贷款业务信息
chm_mon_avg	decimal	理财月日均
adm_pub.adm_csm_cbus_chm_inf_dd	客户集市-业务信息-客户理财业务信息表
***徐舒月_SJ2024122786_电子合同送达地址.sql
﻿--合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024122786_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122786_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t4.org_nm
    ,t5.custs
    ,t5.cst_id as ctc_addr_cst_id
    ,t5.ctc_addr
    ,t5.sbst_coll_psn_addr
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm = '福建长乐泰隆村镇银行'
left join(
    SElECT ctr_serno
        ,count(DISTINCT cst_id)                 as custs
    from  edw.loan_ctr_arv_addr --合同送达地址信息
    where dt='20241230'
    and del_ind='0'
    group by ctr_serno
)t5 on t1.ctr_serno=t5.ctr_serno
where t1.dt='@@{yyyyMMdd}'
and t1.ctr_bal > 0
;
-- 结果表
DROP   TABLE IF     EXISTS SJXQ_SJ2024122786_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122786_CST_02 AS
SELECT  ctr_serno           AS 合同流水号
        ,cst_id             AS 客户号
        ,cst_nm             AS 客户名称
        ,ctr_amt            AS 合同金额
        ,ctr_bal            AS 合同余额
        ,org_nm             as 管户机构
        ,custs              AS 合同送达客户数
        ,ctc_addr_cst_id    AS 合同送达客户号
        ,ctc_addr           AS 联系地址
FROM    SJXQ_SJ2024122786_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024122786_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024122786_CST_02
;
SElECT count(ctr_serno) as 合同数
    ,count(custs)   as 有送达客户合同数
    ,sum(case when nvl(ctc_addr,'')<>'' then 1 else 0 end) as 客户送达地址不为空合同数
    ,sum(case when nvl(ctc_addr,'')='' then 1 else 0 end) as 客户送达地址为空合同数
    ,sum(case when nvl(ctc_addr,'')='' and nvl(sbst_coll_psn_addr,'')<>'' then 1 else 0 end) as 客户送达地址为空且代收人不为空合同数
from SJXQ_SJ2024122786_CST_01
;
***徐舒月_SJ20250103141_长乐村行贷款清收及重组.sql
﻿DROP   TABLE IF EXISTS SJXQ_SJ20250103141_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250103141_CST_01
(
    seq         string COMMENT '序号'
    ,cst_id     string COMMENT '客户号'
)
;
insert into SJXQ_SJ20250103141_CST_01
values
;
-- 最近一次清收日期 不是业务想要的
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_02_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_02_1 as
SELECT  t1.seq         AS 序号
       ,t1.cst_id      AS 客户号
       ,MAX(t3.trx_dt) AS 最近一次清收日期
from SJXQ_SJ20250103141_CST_01              t1
inner join edw.dwd_bus_loan_act_trx_dtl_di  t3 --贷款账户交易明细，余额字段bal_fld_cmt
ON  t1.cst_id = t3.cst_id
AND t3.dt <= '20241231'
and t3.trx_dir='1'  --归还贷款
and t3.trx_amt > 0
group by t1.seq,t1.cst_id
;
-- 最近一次催收日期
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_02 as
SELECT  t1.seq                    AS 序号
       ,t1.cst_id                 AS 客户号
       ,MAX(t2.coln_date)         AS 最近一次催收日期
       ,COUNT(DISTINCT coln_date) AS 催收次数
from SJXQ_SJ20250103141_CST_01              t1
inner join edw.zcbq_risk_collect_record     t2 --催收痕迹
ON  t1.cst_id = t2.cust_no
AND t2.dt = '20241231'
group by t1.seq,t1.cst_id
;
-- 2024重组合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_03 as
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no,t2.pd_nm
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.mgr_id	        --管户人工号
    ,t1.RPAY_PRCP_SETL_INTR_MOD_CD     --还本结息方式代码
    ,c1.cd_val_dscr     as RPAY_PRCP_SETL_INTR_MOD_nm --还本结息方式
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
LEFT JOIN edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241231'
-- and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20241231'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20241231'
and t4.brc_org_nm regexp '福建长乐泰隆村镇'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20241231'
left join edw.dwd_code_library_dd               c1
on t1.RPAY_PRCP_SETL_INTR_MOD_CD = c1.cd_val
and c1.dt = '20241231'
where t1.dt='20241231'
and NVL(T1.bsn_mark_cd,'') = '04'   --重组
;
--信贷借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_04 as
select t1.CTR_SERNO                           --合同流水号
    ,t1.RPAY_PRCP_SETL_INTR_MOD_nm
	,t2.DBIL_ID                               --借据编号|C64
    ,t2.AMT	                                  --金额
	,t2.LVE_ACT_BGN_DT                        --出账起始日期|C8
	,t2.DBT_RSTC_TMS                          --债务重组次数
	,t2.PRCP_BAL                              --本金余额
	,t2.PRAY_TYP_CD                           --还款方式代码|C1
    ,c1.cd_val_dscr     as PRAY_TYP_nm
	,t2.FCLS_RSLT_CD	                      --五级分类结果代码|C2
    ,c2.cd_val_dscr     as FCLS_RSLT_nm
from SJXQ_SJ20250103141_CST_03          t1
left join edw.dim_bus_loan_dbil_inf_dd  t2 --信贷借据信息
on t1.CTR_SERNO=t2.CTR_SERNO
and t2.dt='20241231'
left join EDW.DWD_CODE_LIBRARY_DD       c1
on t2.PRAY_TYP_CD=c1.cd_val
and C1.DT = '20241231'
left join EDW.DWD_CODE_LIBRARY_DD       c2
on t2.FCLS_RSLT_CD=c2.cd_val
and C2.DT = '20241231'
;
--贷款被重组成贷款
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_05 as
SELECT  'LOAN_TO_LOAN'          AS RFIN_TYPE_CD             --重组类型
    ,T2.LVE_ACT_BGN_DT       AS RFIN_DATE                --重组日期 --被重组成贷款时需要生成借据表，以借据表的发放日期为准；被重组成信用卡时以信用卡的发卡日期为准
    ,T1.DBIL_SERNO           AS BE_RFIN_DBIL_SRL_NO      --被重组借据号
    ,T1.CTR_SERNO            AS BE_RFIN_CTR_SRL_NO       --被重组合同号
    ,T1.CST_ID               AS BE_RFIN_CST_ID           --被重组客户号
    ,CASE WHEN T3.BSN_MARK_CD RLIKE '04' THEN 1  ELSE 0 END AS BE_RFIN_CTR_RFIN_LABEL  --被重组合同是否重组标识
    ,t3.CUR_RSK_CTG_RSLT_CD	--当前风险分类结果代码 五级分类代码 '01 正常一级02 正常二级03 正常三级04 正常四级05 正常五级06 正常六级07 关注一级08 关注二级09 次级一级10 次级二级11 可疑12 损失
    ,c1.cd_val_dscr          as CUR_RSK_CTG_RSLT_nm
    ,T1.THS_TM_REL_AMT       AS BE_RFIN_AMT              --关联金额
    ,T1.USE_CR_APLY_SERNO    AS RFIN_AFT_APL_SRL_NO      --重组后申请号
    ,T2.CTR_SERNO            AS RFIN_AFT_CTR_SRL_NO      --重组后合同号
    ,T2.CST_ID               AS RFIN_AFT_CST_ID          --重组后客户号
    ,T2.CTR_AMT              AS RFIN_AFT_CTR_SRL_AMT     --重组后合同金额
FROM    EDW.DWD_BUS_LOAN_PLN_BIL_REL_INF_DD     T1 -- 被重组与重组关联关系
INNER JOIN    (
    SELECT  A.CTR_SERNO ,A.REL_SERNO ,A.CST_ID ,A.CTR_AMT
        ,MIN(DECODE(B.LVE_ACT_BGN_DT,'18991231','NULL',B.LVE_ACT_BGN_DT)) AS LVE_ACT_BGN_DT     --合同最早出账日期
    FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD A
    INNER JOIN EDW.DIM_BUS_LOAN_DBIL_INF_DD B
    ON A.CTR_SERNO = B.CTR_SERNO AND B.DT = '20241231'
    INNER JOIN SJXQ_SJ20250103141_CST_03 t4 --考核机构树
    ON a.CTR_SERNO = t4.CTR_SERNO
    WHERE A.DT = '20241231'
    group by  a.ctr_serno ,a.rel_serno ,a.cst_id ,a.ctr_amt
) T2 ON      T2.REL_SERNO = T1.USE_CR_APLY_SERNO
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD T3
ON      T1.CTR_SERNO = T3.CTR_SERNO
AND     T3.DT = '20241231' --重组前合同信息
left join edw.dwd_code_library_dd            c1
on t3.CUR_RSK_CTG_RSLT_CD = c1.cd_val
and c1.dt = '20241231'
WHERE   T1.DT = '20241231'
;
-- 重组后逾期记录
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_06 as
select DBIL_ID
    ,concat(ovd_dt,'-',dt,',逾期金额：',ovd_amt,',逾期天数:',OVD_DAY) as ovd_cmt
    ,row_number() over(partition by dbil_id order by ovd_dt asc) rn
from(
    select t2.DBIL_ID                               --借据编号
        ,t2.ovd_dt
        ,t2.OVD_AMT                                  --逾期金额
        ,t2.OVD_DAY                                  --逾期天数
        ,t2.dt
        ,row_number() over(partition by t2.DBIL_ID,t2.ovd_dt order by t2.dt desc) rn
    from SJXQ_SJ20250103141_CST_04          t1
    inner join edw.dim_bus_loan_dbil_inf_dd t2 --信贷借据信息
    on t1.DBIL_ID=t2.DBIL_ID
    and t2.dt<='20241231'
    and t2.ovd_dt<>'18991231'
    where nvl(t1.DBIL_ID,'')<>''
)t1 where rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250103141_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103141_CST_07 as
SELECT t1.cst_id       AS 客户号
    ,t1.cst_nm         AS 客户名称
    ,t1.ctr_serno      AS 合同流水号
    ,t2.DBIL_ID        AS 借据编号
    ,t1.ctr_amt        AS 重组资产合同金额
    ,t1.ctr_bal        AS 重组资产合同余额
    ,t1.ctr_bgn_dt     AS 重组资产合同起始日期
    ,t1.ctr_mtu_dt     AS 重组资产合同到期日期
    ,t2.PRAY_TYP_nm    AS 还款方式
    ,t2.RPAY_PRCP_SETL_INTR_MOD_nm as 还本结息方式
    ,t2.FCLS_RSLT_nm   AS 2024年末五级分类结果
    ,t2.AMT            AS 重组资产借据金额
    ,t2.PRCP_BAL       AS 重组资产借据本金余额
    ,t2.LVE_ACT_BGN_DT AS 重组起始日期
    ,case when t3.BE_RFIN_CTR_RFIN_LABEL>=1 then 'Y' else '' end as 是否再次重组
    ,t3.CUR_RSK_CTG_RSLT_nm as 重组前五级分类结果
    ,t4.ovd_cmt        as 重组后逾期记录
from SJXQ_SJ20250103141_CST_03      t1
left join SJXQ_SJ20250103141_CST_04 t2
on t1.ctr_serno=t2.ctr_serno
left join(
    SELECT RFIN_AFT_CTR_SRL_NO
        ,sum(BE_RFIN_CTR_RFIN_LABEL) as BE_RFIN_CTR_RFIN_LABEL
    from SJXQ_SJ20250103141_CST_05
    GROUP BY RFIN_AFT_CTR_SRL_NO
)t3 on t1.ctr_serno=t3.RFIN_AFT_CTR_SRL_NO
left join(
    select DBIL_ID
    from SJXQ_SJ20250103141_CST_06
    group by DBIL_ID
)t4 on t2.DBIL_ID=t4.DBIL_ID
where t2.DBIL_ID is not null
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250103141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250103141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250103141_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250103141_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct RFIN_AFT_CTR_SRL_NO) custs
from SJXQ_SJ20250103141_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ20250103141_CST_06
;
SElECT '07' seq, *
from SJXQ_SJ20250103141_CST_07
;
/*
01	142	91
02	142	91
03	250	250
04	250	250
05	1368	239
06	350	109
*/
***徐舒月_SJ2025043091_管户交易记录.sql
﻿/*
关于使用合同流水号：出险日期按借据算的，会出现同一客户号有多个合同流水号，每个合同流水号有不同的出险日期。以及会用到贷款办理时间。
管户机构交接记录：办理贷款(合同起始日期)前6个月至&ldquo;当前出险日期&rdquo;的全量管户机构变更情况
当前出险日期前最近的一次交接情况（客户经理）
如前手管户超过6个月，输出客户全量交接记录：先按&ldquo;当前出险日期&rdquo;取最近一次的客户经理交接。如前手管户超过6个月，则停止取数，如管户不到6个月，因管户时间较短，所以需要再前取交接记录，直至前手管户满6个月。
初始合同号1、2：用于重组贷款的重组前合同交接情况取数。取数逻辑与前面一致
*/
-- 导入数据 同一合同出险日期是否一致？不一致
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_01 AS
SELECT  col_1  --合同流水号
       ,col_2  --借据流水号
       ,col_3  --核心客户编号
       ,col_4  --客户名称
       ,col_5  --余额
       ,col_6  --业务标识
       ,col_7  --当前出险日期2
       ,col_8  --初始合同号1
       ,col_9  --初始借据号1
       ,col_10 --初始客户名称1
       ,col_11 --初始合同号2
       ,col_12 --初始借据号2
       ,col_13 --初始客户名称2
from lab_bigdata_dev.qbi_file_20250507_16_58_58_0
where pt<>''
and nvl(col_7,'')<>''
;
-- 客户+出险日期
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_02 AS
select t1.col_1     as ctr_serno
    ,t1.col_3       as cst_id
    ,t1.col_7       as hpn_rsk_date
    ,t2.ctr_bgn_dt
from SJXQ_SJ2025043091_CST_01               t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
on t1.col_1=t2.ctr_serno
and t2.dt = '@@{yyyyMMdd}'
union
select t1.col_8
    ,t2.cst_id
    ,t1.col_7   as hpn_rsk_date
    ,t2.ctr_bgn_dt
from SJXQ_SJ2025043091_CST_01               t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
on t1.col_8=t2.ctr_serno
and t2.dt = '@@{yyyyMMdd}'
where nvl(t1.col_8,'')<>''
union
select t1.col_11
    ,t2.cst_id
    ,t1.col_7   as hpn_rsk_date
    ,t2.ctr_bgn_dt
from SJXQ_SJ2025043091_CST_01               t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
on t1.col_11=t2.ctr_serno
and t2.dt = '@@{yyyyMMdd}'
where nvl(t1.col_11,'')<>''
;
-- 管户天数 cst_id,aply_dt 是否唯一
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_03 AS
select t1.serno,t1.cst_id
    ,t1.dlve_dt
    ,t2.aft_dlve_dt
    ,case when datediff(to_date(t2.aft_dlve_dt,'yyyyMMdd'),to_date(t1.dlve_dt,'yyyyMMdd'),'dd') >=180 then 1
        else 0 end as is_more_6m
from(
    select cst_id
    ,case when aply_dt='18991231' then SUBSTR(REPLACE(sys_reg_tm,'-',''),1,8) else aply_dt end as dlve_dt
    ,hdv_typ_cd,dlve_mod_cd,serno
        ,row_number() over(partition by cst_id order by case when aply_dt='18991231' then SUBSTR(REPLACE(sys_reg_tm,'-',''),1,8) else aply_dt end asc) rn
    from edw.dwd_cst_mng_loan_mng_hdv_rcd_dd --管户交接记录
    -- and hdv_typ_cd='1'	    --	移交类型代码 1管户权交接  2协办业务交接
    -- and dlve_mod_cd='2'	    --	移交方式代码 1认领  2移交
    where dt='@@{yyyyMMdd}'
    and bfr_hdv_cst_magr_id<>aft_hdv_cst_magr_id     --剔除自交
)t1 left join(
    select cst_id
        ,case when aply_dt='18991231' then SUBSTR(REPLACE(sys_reg_tm,'-',''),1,8) else aply_dt end as aft_dlve_dt
        ,row_number() over(partition by cst_id order by case when aply_dt='18991231' then SUBSTR(REPLACE(sys_reg_tm,'-',''),1,8) else aply_dt end asc) rn
    from edw.dwd_cst_mng_loan_mng_hdv_rcd_dd --管户交接记录
    where dt='@@{yyyyMMdd}'
    and bfr_hdv_cst_magr_id<>aft_hdv_cst_magr_id
)t2 on t1.cst_id=t2.cst_id
and t1.rn+1=t2.rn
where t1.cst_id in(
    select cst_id
    from SJXQ_SJ2025043091_CST_02
)
;
--管户交接记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_04 AS
select t1.ctr_serno,t1.cst_id
    ,t1.hpn_rsk_date
    ,t1.ctr_bgn_dt
    ,t2.serno
    ,t5.dlve_dt
    ,t5.aft_dlve_dt
    ,concat(case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end
        ,',',t2.bfr_hdv_mgr_org_no,'到',t2.aft_hdv_mgr_org_no) as hdv_mgr_org_no --管户机构交接记录
    ,concat(case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end
        ,COALESCE(t3.empe_nm,t2.bfr_hdv_cst_magr_id),'交给',t4.empe_nm) as hdv_cst_magr
    ,coalesce(t5.is_more_6m,0) as is_more_6m
    ,row_number() over(partition by t1.ctr_serno,t1.hpn_rsk_date
        order by case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end) rn
    ,row_number() over(partition by t1.ctr_serno,t1.hpn_rsk_date
        order by case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end desc) desc_rn
from SJXQ_SJ2025043091_CST_02                   t1
inner join edw.dwd_cst_mng_loan_mng_hdv_rcd_dd  T2 --管户交接记录
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.bfr_hdv_cst_magr_id<>t2.aft_hdv_cst_magr_id
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t2.bfr_hdv_cst_magr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t2.aft_hdv_cst_magr_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025043091_CST_03          t5
on t2.serno=t5.serno
where case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end >= replace(add_months(to_date(t1.ctr_bgn_dt,'yyyyMMdd'),-6),'-','')
and case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end<=t1.hpn_rsk_date
;
--管户交接记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_04_1 AS
SELECT  ctr_serno
		,hpn_rsk_date
from(
	select t1.ctr_serno
		,t1.hpn_rsk_date
		,concat(case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end
			,',',t2.bfr_hdv_mgr_org_no,'到',t2.aft_hdv_mgr_org_no) as hdv_mgr_org_no --管户机构交接记录
		,row_number() over(partition by t1.ctr_serno,t1.hpn_rsk_date
			order by case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end) rn
	from SJXQ_SJ2025043091_CST_02                   t1
	inner join edw.dwd_cst_mng_loan_mng_hdv_rcd_dd  T2 --管户交接记录
	on t1.cst_id=t2.cst_id
	and t2.dt='@@{yyyyMMdd}'
	and t2.bfr_hdv_mgr_org_no<>t2.aft_hdv_mgr_org_no
	where case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end >= replace(add_months(to_date(t1.ctr_bgn_dt,'yyyyMMdd'),-6),'-','')
	and case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end<=t1.hpn_rsk_date
)t1 GROUP BY  ctr_serno
	,hpn_rsk_date
;
--全量管户交接记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_05 AS
select t1.ctr_serno,t1.cst_id
    ,t1.hpn_rsk_date
    ,t1.ctr_bgn_dt
    ,t2.serno
    ,t2.bfr_hdv_cst_magr_id
    ,t2.aft_hdv_cst_magr_id
    ,case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end as dlve_dt
    ,concat(case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end
        ,COALESCE(t3.empe_nm,t2.bfr_hdv_cst_magr_id),'交给',t4.empe_nm) as hdv_cst_magr
    ,row_number() over(partition by t1.ctr_serno,t1.hpn_rsk_date
        order by case when t2.aply_dt='18991231' then SUBSTR(REPLACE(t2.sys_reg_tm,'-',''),1,8) else t2.aply_dt end) rn
from SJXQ_SJ2025043091_CST_02                   t1
inner join edw.dwd_cst_mng_loan_mng_hdv_rcd_dd  T2 --管户交接记录
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.bfr_hdv_cst_magr_id<>t2.aft_hdv_cst_magr_id
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t2.bfr_hdv_cst_magr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t2.aft_hdv_cst_magr_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025043091_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043091_CST_06 AS
SELECT  t1.col_1        AS 合同流水号
       ,t1.col_2        AS 借据流水号
       ,t1.col_3        AS 核心客户编号
       ,t1.col_4        AS 客户名称
       ,t1.col_5        AS 余额
       ,t1.col_6        AS 业务标识
       ,t11.ctr_bgn_dt  as 合同起始日期
       ,t1.col_7        AS 当前出险日期2
       ,ta2.管户机构交接记录
       ,t3.hdv_cst_magr AS 当前出险日期前最近的一次交接情况
       ,CASE WHEN t2.is_more_6m = 1 THEN '是'  ELSE '' END AS 前手是否管户超过6个月
       ,t4.hdv_cst_magr                                   AS 全量交接记录
       ,t1.col_8                                          AS 初始合同号1
       ,t1.col_9                                          AS 初始借据号1
       ,t1.col_10                                         AS 初始客户名称1
       ,ta5.管户机构交接记录 as 初始合同号1管户机构交接记录
       ,t6.hdv_cst_magr AS 初始合同号1当前出险日期前最近的一次交接情况
       ,CASE WHEN t5.is_more_6m = 1 THEN '是'  ELSE '' END AS 初始合同号1前手是否管户超过6个月
       ,t7.hdv_cst_magr                                   AS 初始合同号1全量交接记录
       ,t1.col_11                                         AS 初始合同号2
       ,t1.col_12                                         AS 初始借据号2
       ,t1.col_13                                         AS 初始客户名称2
       ,ta8.管户机构交接记录 as 初始合同号2管户机构交接记录
       ,t9.hdv_cst_magr AS 初始合同号2当前出险日期前最近的一次交接情况
       ,CASE WHEN t8.is_more_6m = 1 THEN '是'  ELSE '' END AS 初始合同号2前手是否管户超过6个月
       ,t10.hdv_cst_magr                                   AS 初始合同号2全量交接记录
FROM SJXQ_SJ2025043091_CST_01 t1
LEFT JOIN
(
	SELECT  ctr_serno
	       ,hpn_rsk_date
	       ,MAX(is_more_6m)                             AS is_more_6m
	FROM SJXQ_SJ2025043091_CST_04
	GROUP BY  ctr_serno
	         ,hpn_rsk_date
) t2
ON t1.col_1 = t2.ctr_serno AND t1.col_7 = t2.hpn_rsk_date
LEFT JOIN SJXQ_SJ2025043091_CST_04 t3
ON t1.col_1 = t3.ctr_serno AND t1.col_7 = t3.hpn_rsk_date AND t3.desc_rn = 1
LEFT JOIN
(
	SELECT  ctr_serno
	       ,hpn_rsk_date
	FROM SJXQ_SJ2025043091_CST_05
	GROUP BY  ctr_serno
	         ,hpn_rsk_date
) t4
ON t1.col_1 = t4.ctr_serno AND t1.col_7 = t4.hpn_rsk_date
left join SJXQ_SJ2025043091_CST_04_1 ta2
ON t1.col_1 = ta2.ctr_serno AND t1.col_7 = ta2.hpn_rsk_date
LEFT JOIN
(
	SELECT  ctr_serno
	       ,hpn_rsk_date
	       ,MAX(is_more_6m)                             AS is_more_6m
	FROM SJXQ_SJ2025043091_CST_04
	GROUP BY  ctr_serno
	         ,hpn_rsk_date
) t5
ON t1.col_8 = t5.ctr_serno AND t1.col_7 = t5.hpn_rsk_date
LEFT JOIN SJXQ_SJ2025043091_CST_04 t6
ON t1.col_8 = t6.ctr_serno AND t1.col_7 = t6.hpn_rsk_date AND t6.desc_rn = 1
LEFT JOIN
(
	SELECT  ctr_serno
	       ,hpn_rsk_date
	FROM SJXQ_SJ2025043091_CST_05
	GROUP BY  ctr_serno
	         ,hpn_rsk_date
) t7
ON t1.col_8 = t7.ctr_serno AND t1.col_7 = t7.hpn_rsk_date
left join SJXQ_SJ2025043091_CST_04_1 ta5
ON t1.col_8 = ta5.ctr_serno AND t1.col_7 = ta5.hpn_rsk_date
LEFT JOIN
(
	SELECT  ctr_serno
	       ,hpn_rsk_date
	       ,MAX(is_more_6m)                             AS is_more_6m
	FROM SJXQ_SJ2025043091_CST_04
	GROUP BY  ctr_serno
	         ,hpn_rsk_date
) t8
ON t1.col_11 = t8.ctr_serno AND t1.col_7 = t8.hpn_rsk_date
LEFT JOIN SJXQ_SJ2025043091_CST_04 t9
ON t1.col_11 = t9.ctr_serno AND t1.col_7 = t9.hpn_rsk_date AND t9.desc_rn = 1
LEFT JOIN
(
	SELECT  ctr_serno
	       ,hpn_rsk_date
	FROM SJXQ_SJ2025043091_CST_05
	GROUP BY  ctr_serno
	         ,hpn_rsk_date
) t10
ON t1.col_11 = t10.ctr_serno AND t1.col_7 = t10.hpn_rsk_date
left join SJXQ_SJ2025043091_CST_02  t11
ON t1.col_1 = t11.ctr_serno AND t1.col_7 = t11.hpn_rsk_date
left join SJXQ_SJ2025043091_CST_04_1 ta8
ON t1.col_11 = ta8.ctr_serno AND t1.col_7 = ta8.hpn_rsk_date
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025043091_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno,hpn_rsk_date) custs
from SJXQ_SJ2025043091_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct serno) custs
from SJXQ_SJ2025043091_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,hpn_rsk_date,serno) custs
from SJXQ_SJ2025043091_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno,hpn_rsk_date,serno) custs
from SJXQ_SJ2025043091_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025043091_CST_06
;
/*
01	751	486
02	840	840
03	1493	1493
04	761	761
05	2614	2614
06	751	486
*/
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025043091_CST_06
***徐舒月_SJ20250625106_旧信贷系统借还款记录.sql
﻿-- 徐舒月_SJ20250625106_旧信贷系统借还款记录
DROP   TABLE IF     EXISTS SJXQ_SJ20250625106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250625106_CST_01 AS
select DBIL_ID                                  --借据编号|C64
	,CTR_SERNO                                --合同流水号|C32
	,USC_APLY_SERNO                           --用信申请流水号|C32
	,CST_ID                                   --客户号|C20
	,CST_NM                                   --客户名称|C200
	,AMT                                      --金额DECIMAL(21,2)
	,LVE_ACT_BGN_DT                           --出账起始日期|C8
	,APNT_MTU_DT                              --约定到期日|C8
	,EXEC_MTU_DT                              --执行到期日|C8
	,PRCP_BAL                                 --本金余额DECIMAL(21,2)
	,NORM_BAL                                 --正常余额DECIMAL(22,2)
	,OVD_AMT                                  --逾期金额DECIMAL(21,2)
from edw.dim_bus_loan_dbil_inf_dd             --信贷借据信息
where dt='@@{yyyyMMdd}'
and CTR_SERNO='BC2021012700000022'
;
--贷款客户账户交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250625106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250625106_CST_02 AS
SELECT  t2.loan_act_id    --贷款账号
    ,t1.CTR_SERNO
    ,t1.DBIL_ID         --贷款借据号
    ,t2.dtl_seq_nbr   --明细序号
    ,t2.cst_id        --客户号
    ,t2.cst_nm        --客户名称
    ,t2.ccy_cd        --货币代号
    ,t2.trx_dt        --交易日期
    ,t2.trx_dir       --交易方向
    ,t2.trx_amt       --交易金额
    ,t2.bal           --余额
    ,t2.loan_bal_fld  --贷款余额字段
    ,t2.bal_fld_cmt   --余额字段说明
    ,t2.trx_srl       --交易流水
    ,t2.trx_evt       --交易事件
    ,t2.evt_cmt       --事件说明
    ,t2.trx_no        --交易码
    ,t2.smr           --摘要
    ,t2.rvs_ind       --冲正标志
    ,t2.rvsd_ind      --被冲正标志
    ,t2.loan_rpay_mth --贷款归还方式
from SJXQ_SJ20250625106_CST_01  t1
inner join edw.dwd_bus_loan_act_trx_dtl_di	t2 --贷款账户交易明细
on t1.DBIL_ID=t2.loan_dbil_id
and t2.dt<='@@{yyyyMMdd}'
and t2.dt>='20210127'
;
--贷款客户账户交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250625106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250625106_CST_03 AS
select t2.dbil_id                                  --借据号|C50
	,t2.dtl_id                                   --明细编号|C32
    ,t1.CTR_SERNO
    ,t2.entr_act_act_id	--	入账账号|C32
	,t2.trx_dt                                   --交易日期|C8
	,t2.dtrb_amt                                 --放款金额|DECIMAL(20,2)
	,t2.norm_prcp                                --正常本金|DECIMAL(20,2)
	,t2.ovd_prcp                                 --逾期本金|DECIMAL(20,2)
    ,t2.rpay_act_id	    --	还款账号|C32
	,t2.rpay_tot_amt                             --还款总额|DECIMAL(20,2)
	,t2.rpay_sts_cd                              --还款状态代码|C1
	,t2.trx_srl                                  --交易流水|C32
	,t2.trx_evt                                  --交易事件|C10
	,t2.evt_cmt                                  --事件说明|C80
	,t2.smr                                      --摘要|C512
	,t2.loan_rpay_mth_cd                         --贷款归还方式代码|C2
	,t2.rpay_cmt                                 --还款备注|C1000
from SJXQ_SJ20250625106_CST_01  t1
inner join edw.dwd_bus_loan_cst_act_trx_dtl_di t2 --贷款客户账户交易明细
on t1.DBIL_ID=t2.DBIL_ID
and t2.dt<='@@{yyyyMMdd}'
and t2.dt>='20210127'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250625106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250625106_CST_04 AS
SELECT  t1.trx_srl       AS 交易流水
        ,t1.CTR_SERNO    AS 合同号
        ,t1.dbil_id      AS 借据号
        ,CASE
           WHEN t1.rpay_sts_cd = '' THEN '发放'
           ELSE '回收'
         END             AS 台账类型
        ,t1.trx_dt       AS 交易日期
        ,t1.dtrb_amt     AS 放款金额
        ,t1.rpay_tot_amt AS 还款总额
        ,t1.rpay_sts_cd  AS 还款状态代码
        ,t1.evt_cmt      AS 交易描述
        ,t1.smr          AS 摘要
from SJXQ_SJ20250625106_CST_03      t1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250625106_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250625106_CST_05 AS
SELECT trx_srl       as 交易流水
    ,CTR_SERNO  as 合同号
    ,DBIL_ID         as 借据号
    ,decode(trx_dir,'0','发放','1','回收')      as 交易方向
    ,trx_dt        as 交易日期
    ,case when trx_dir='0'  then trx_amt else 0 end as 发放金额
    ,case when trx_dir='1'  then trx_amt else 0 end as 回收金额
    ,bal_fld_cmt   as 交易事件 --余额字段说明
    ,evt_cmt       as 交易描述 --事件说明
from SJXQ_SJ20250625106_CST_02
where trx_evt<>'LN_NHBG'    --销项税征收变更
;
SElECT '01' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ20250625106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ20250625106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ20250625106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 借据号) custs
from SJXQ_SJ20250625106_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 借据号) custs
from SJXQ_SJ20250625106_CST_05
;
/*
01	45	45
02	1770	45
03	682	45
04	682	45
05	1758	45
SELECT *
from edw.core_klnl_dkzhmx t2
where t2.dkjiejuh='SXK202101270009869699'
and t2.dt<='@@{yyyyMMdd}'
and t2.dt>='20210127'
SELECT  t1.serialno           AS 信息流水号
       ,t1.relativecontractno AS 合同流水号
       ,t2.cst_nm             AS 客户姓名
       ,t1.relativeserialno   AS 借据流水号
       ,t2.cst_id             AS 客户号
       ,t1.occurdate          AS 账务发生日期
       ,CASE WHEN t1.occurdirection = '0' THEN '发放'  ELSE '回收' END AS 台账类型
       ,t1.actualdebitsum     AS 发放金额
       ,t1.actualcreditsum    AS 回收金额
       ,t1.businessdesc
       ,t2.lve_act_bgn_dt     AS 借据发放日期
       ,t2.mtu_dt             AS 借据到期日期
FROM edw.old_sys_loan_business_wastebook        t1 --业务流水账 20240719停止更新 Table not found
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd  t2 --信贷借据信息
ON t2.dt = '20240719'
AND t1.relativeserialno = t2.dbil_id
where t1.dt='20240522'
and t1.relativecontractno='BC2021012700000022'
*/
-- 结果表
***徐莎莎_SJ20250318181_信用卡流水.sql
﻿-- 信用卡6227171606541103在2014年1月1日至2015年12月31日的交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ20250318181_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318181_CST_01 AS
SELECT  cr_crd_act_id           AS 信用卡账号
       ,cr_crd_card_nbr         AS 信用卡卡号
       ,trx_typ_cd              AS 交易类型代码
       ,trx_typ_dscr            AS 交易类型描述
       ,trx_ccy_cd              AS 交易币种代码
       ,trx_amt                 AS 交易金额
       ,trx_dt                  AS 交易日期
       ,trx_tm                  AS 交易时间
       ,act_dt                  AS 入帐日期
       ,rtn_gds_trx_id          AS 退货交易标识
       ,trx_dscr_1              AS 交易描述1
       ,trx_dscr_2              AS 交易描述2
       ,acq_mch_enc             AS 收单商户编码
       ,acq_org_id              AS 收单机构码
       ,mch_seq_nbr             AS 商户序号
FROM edw.dwd_bus_crd_cr_crd_trx_dtl_di --信用卡客户交易流水
WHERE dt between '20140101' and '20151231'
AND cr_crd_card_nbr = '6227171606541103'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250318181_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318181_CST_02 AS
select t1.cst_id                                   --客户号|C20
	,t1.cr_crd_act_id                            --信用卡账号|C32
	,t1.cr_crd_card_nbr                          --信用卡卡号|C32
	,t1.srl_nbr									 --流水号
	,t1.trx_typ_cd                               --交易类型代码|C32
	,t1.trx_typ_dscr                             --交易类型描述|C32
	,t1.trx_ccy_cd                               --交易币种代码|C3
	,c1.cd_val_dscr 	as trx_ccy_nm
	,t1.trx_amt                                  --交易金额|DECIMAL(20,2)
	,t1.mch_typ_cd                               --商户类型代码|C32
	,t1.mch_cd                                   --商户代码|C32
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C32
	,t1.act_dt                                   --入帐日期|C8
	,t1.trx_hpn_dt                               --交易发生日期|C8
	,t1.actl_trx_tm                              --实际交易时间|C8
	,t1.cnt_pty_act_id                           --对方账号|C100
	,t1.cnt_pty_act_nm                           --对方户名|C200
	,t1.trx_dscr_1                               --交易描述1|C64
	,t1.trx_dscr_2                               --交易描述2|C6
	,t1.acq_mch_enc                              --收单商户编码|C15
	,t1.acq_org_id                               --收单机构码|N11
	,t1.mch_seq_nbr                              --商户序号|N6
	,t1.act_bal                                  --账户余额|DECIMAL(20,2)
	,t1.ip                                       --IP
	,t1.mac                                      --MAC
from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di t1 --信用卡交易宽表
left join edw.dwd_code_library_dd 				c1
on  t1.trx_ccy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
WHERE t1.dt between '20140101' and '20151231'
AND t1.cr_crd_card_nbr = '6227171606541103'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250318181_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318181_CST_03 AS
select cst_id                                 as 客户号
	,cr_crd_act_id                            as 信用卡账号
	,cr_crd_card_nbr                          as 信用卡卡号
	,trx_dt                                   as 交易日期
	,trx_tm                                   as 交易时间
	,act_dt                                   as 入帐日期
	,trx_typ_dscr                             as 交易类型描述
	,trx_ccy_nm                               as 交易币种
	,trx_amt                                  as 交易金额
	,cnt_pty_act_id                           as 对方账号
	,cnt_pty_act_nm                           as 对方户名
from SJXQ_SJ20250318181_CST_02
-- where cnt_pty_act_nm='王一君' or cnt_pty_act_id='6226622906077645'
;
SElECT '03' seq, *
from SJXQ_SJ20250318181_CST_03
order by 交易日期,交易时间
;
SElECT '01' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ20250318181_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ20250318181_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ20250318181_CST_03
***徐莎莎_SJ2025041096_企业主手机号.sql
/*
问题1：
1. 客群是什么？全行客户？宁波分行企业主客户
2. 主营企业 ？待定
3. 业务 不区分是否有效？有效
4. 是否触发、未通过 ？暂定2年
*/
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_01 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='@@{yyyyMMdd}' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 同一风险控制号在我行总敞口
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_02 AS
SELECT  T1.CST_ID
       ,t1.客户敞口总额
       ,CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t5.sam_rsk_ctrl_id END AS sam_rsk_ctrl_id
FROM
(
	SELECT  le.cst_id
	       ,SUM(le.EPSR_LMT) AS 客户敞口总额
	FROM edw.loan_lmt_exmp le
	INNER JOIN edw.loan_cst_bsc cb
	ON le.CST_ID = cb.CST_ID AND cb.DT = '@@{yyyyMMdd}'
	WHERE le.DEL_IND = '0'
	AND ( EXISTS (
	SELECT  1
	FROM edw.loan_lmt_use_rslt_rcd u
	WHERE u.SPLT_LMT_NO = le.SPLT_LMT_NO
	AND INI_OCP_FACL_AMT > ALRY_RSM_FACL_LMT
	AND OCP_STS = '1'
	AND U.DT = '@@{yyyyMMdd}' ) OR le.LMT_STS IN ( '01' , '02' ) ) AND LE.DT = '@@{yyyyMMdd}'
	GROUP BY  le.cst_id
) T1
LEFT JOIN edw.DWS_CST_BAS_INF_DD t5
ON T1.cst_id = t5.cst_id AND t5.dt = '@@{yyyyMMdd}'
;
-- 信贷客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_03 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,max(CASE WHEN t1.prd_no IN ( '2001010101003' ,'2001020101003') THEN 1  ELSE 0 END) AS is_sdt
    ,max(case when t2.PD_NM regexp '泰e贷' or T1.prd_no  IN ( '2001010101002' , '2001020101002' ) then 1 else 0 end) as is_tyd
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
group by t1.cst_id,t1.cst_nm
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_04 AS
select t1.cst_id                                   --客户号
	,t1.cst_seg_flg                              --客群标签:1企业主,2个体户,3企事业高管,4非持牌个体户,5工薪族,6退休养老,7持家女性
    ,t2.cst_chn_nm	    --	客户中文名称
    ,t2.age,decode(t2.gdr_cd,'1','男','2','女','未知') as gdr_nm
    ,case when length(t2.m_tel_no)>=length(t2.f_tel_no) then t2.m_tel_no else t2.f_tel_no end as 手机号码
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.scor_rng,t5.cst_cr_grd_val
    ,t5.prd_dt
    ,case when t6.cst_id is not null then 'Y' else 'N' end as 是否法定代表人
    ,case when t7.cst_id is not null then 'Y' else 'N' end as 是否实际控制人
    ,t7.rel_cst_id  as 主营企业客户号
    ,CASE WHEN nvl(t8.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t8.sam_rsk_ctrl_id END AS cmn_rsk_ctrl_id
    ,t9.cst_nm	--客户名称
    ,t9.emp_nbr	--职工人数
    ,t10.pdval	--产值
from adm_pub.adm_csm_clab_cst_jc_inf_dd         t1 --客户集市-客户标签信息-客户信息-决策
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='宁波分行'
left join SJXQ_SJ2025041096_CST_01  t5
on t1.cst_id=t5.cst_id
and t5.rn=1
left join(
    SElECT cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0101' --法人
    union
    SElECT rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0101' --法人
    union
    select lgp_cst_id                             --对公客户法人客户号
    from edw.dim_cst_entp_lgp_inf_dd              --对公客户法人信息表
    where dt='@@{yyyyMMdd}'
)t6 on t1.cst_id=t6.cst_id
left join(
    SElECT cst_id,rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0109' --实际控制人
)t7 on t1.cst_id=t7.cst_id
LEFT JOIN edw.DWS_CST_BAS_INF_DD t8
ON T1.CST_ID = t8.cst_id
AND t8.dt = '@@{yyyyMMdd}'
left join edw.dim_cst_entp_bas_inf_dd	t9 --企业客户基本信息
ON T7.rel_cst_id = t9.cst_id
AND t9.dt = t1.dt
left join edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd	t10 --信贷客户经营信息销售额及净利润信息
ON T7.rel_cst_id = t10.cst_id
AND t10.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.cst_seg_flg='1'     --'企业主'
;
-- 同一风险控制号是否触发我行精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_05 AS
SELECT distinct CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN COALESCE(t2.cst_id,t3.cst_id) ELSE t5.sam_rsk_ctrl_id END AS cmn_rsk_ctrl_id
from(
    SELECT btch_serno
        ,tsk_gen_dt   --任务生成日期 精准贷后风险触发时间
        ,ROW_NUMBER() over(PARTITION BY btch_serno ORDER BY tsk_gen_dt aSC) rn_asc
    from edw.dwd_bus_loan_psp_chk_tsk_inf_dd --贷后检查任务信息
    where DT = '@@{yyyyMMdd}'
    AND pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
    AND tsk_gen_dt between '20240317' and '@@{yyyyMMdd}'     --近1年
)t1 left JOIN (
    SELECT t1.btch_serno,t1.cst_id
    from edw.dwd_bus_loan_psp_chk_btch_inf_dd AS T1 --贷后检查批次信息表
    where t1.DT = '@@{yyyyMMdd}'
)t2 on t1.btch_serno=t2.btch_serno
left join(
    SELECT t.*
    from (
        SELECT t1.btch_serno,t2.cst_id
            ,ROW_NUMBER() over(PARTITION BY t1.btch_serno ORDER BY t1.sys_reg_tm desc) rn
        from edw.dwd_bus_loan_bsn_mng_pln_dd        t1 --业务贷后管理方案
        left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
        on t1.ctr_serno=t2.ctr_serno
        and t2.dt=t1.dt
        where t1.DT = '@@{yyyyMMdd}'
    )t where t.rn=1
)t3 on t1.btch_serno=t3.btch_serno
inner JOIN edw.DWS_CST_BAS_INF_DD t5
ON COALESCE(t2.cst_id,t3.cst_id) = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}'
where t1.rn_asc=1
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_06 AS
SELECT  distinct CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t5.sam_rsk_ctrl_id END AS cmn_rsk_ctrl_id
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
    and substr(REPLACE(SYS_REG_TM, '-', ''), 1, 8) between '20240317' and '@@{yyyyMMdd}'     --近1年
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
LEFT JOIN edw.DWS_CST_BAS_INF_DD t5
ON T1.CST_ID = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}'
where t2.rul_set_rslt_nm regexp '未通过|不通过'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041096_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041096_CST_07 AS
SELECT  t1.cst_id     AS 客户号
    ,t1.cst_chn_nm AS 客户中文名称
    ,t1.gdr_nm     AS 性别
    ,t1.age        AS 年龄
    ,md5(t1.手机号码)    as 手机号码_md5加密
    -- ,t1.scor_rng   AS 征信分段
    -- ,t1.prd_dt     AS 最近一次征信查询时间
    ,decode(t2.is_sdt,0,'否',1,'是')  AS 我行是否有未结清随贷通业务
    ,decode(t2.is_ryd,0,'否',1,'是')  AS 我行是否有未结清融e贷业务
    ,decode(t2.is_tyd,0,'否',1,'是')  AS 我行是否有未结清泰e贷业务
    ,t1.是否法定代表人
    ,t1.是否实际控制人
    ,t1.cst_nm	as 主营企业名称
    ,t1.emp_nbr	as 主营企业员工数
    ,t1.pdval	as 主营企业年产值
    ,t3.同一风险控制号在我行总敞口
    ,CASE WHEN t4.cmn_rsk_ctrl_id is not null THEN 'Y'  ELSE 'N' END AS 同一风险控制号近1年是否触发我行精准贷后
    ,CASE WHEN t5.cmn_rsk_ctrl_id is not null THEN 'Y'  ELSE 'N' END AS 同一风险控制号近1年是否预评估未通过
from SJXQ_SJ2025041096_CST_04       t1
left join SJXQ_SJ2025041096_CST_03  t2
on t1.cst_id=t2.cst_id
left join(
    select sam_rsk_ctrl_id
           ,sum(客户敞口总额) as 同一风险控制号在我行总敞口
    from SJXQ_SJ2025041096_CST_02
    group by sam_rsk_ctrl_id
)t3 on t1.cmn_rsk_ctrl_id=t3.sam_rsk_ctrl_id
left join SJXQ_SJ2025041096_CST_05 t4
on t1.cmn_rsk_ctrl_id=t4.cmn_rsk_ctrl_id
left join SJXQ_SJ2025041096_CST_06 t5
on t1.cmn_rsk_ctrl_id=t5.cmn_rsk_ctrl_id
where t1.cst_cr_grd_val>760  --征信评分760分以上的客户
;
SElECT '07' seq, *
from SJXQ_SJ2025041096_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041096_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041096_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041096_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041096_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cmn_rsk_ctrl_id) custs
from SJXQ_SJ2025041096_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cmn_rsk_ctrl_id) custs
from SJXQ_SJ2025041096_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025041096_CST_07
;
***方利利_SJ2025032601_福清村行征信数据.sql
﻿-- 截至2025/3/26、2024/12/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,round(DATEDIFF(to_date(t6.dt, 'yyyymmdd'), to_date(T6.bth_dt, 'yyyymmdd'), 'dd')/365,1) as age
    ,c1.cd_val_dscr     as 婚姻状况
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '福建福清泰隆村镇'
left join edw.dws_cst_idv_bas_inf_dd	t6 --个人客户基本信息汇总表
on  t1.cst_id=t6.cst_id
and t6.dt=t1.dt
LEFT JOIN    edw.dwd_code_library_dd    c1
ON      T6.mrg_situ_cd = c1.CD_VAL
AND     c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND     c1.FLD_NM = 'MRG_SITU_CD'
and     c1.dt = t1.dt
where t1.dt='20241231'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--标准代码块：最新的中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20241231' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20241231' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20241231' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20241231' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_03 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20241231'
)t1 inner JOIN (
    SElECT t1.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t1 --预评估规则集关系
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t1.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t1.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t1.DT = '20241231'
    AND DATEDIFF(to_date(t1.DT, 'yyyymmdd'), to_date(substr(REPLACE(T1.SYS_REG_TM, '-', ''), 1, 8), 'yyyymmdd'), 'MM') <= 12 --近12个月内的数据
    group by t1.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20241231'
where t1.rn=1
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_04 AS
SELECT  cst_id
       ,REPLACE(substr(report_dt,1,10),'-','') as report_dt --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
       ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
       ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
       ,cred_card_num                --信用卡张数
       ,cred_card_total_amt          --信用卡总授信额度
       ,cred_card_total_balan        --信用卡总余额
       ,late_year_enqu_count         --最近一年内的查询次数
       ,late_3mon_enqu_count         --最近3个月审批查询次数
       ,late_6mon_enqu_count         --最近6个月审批查询次数
       ,scor_rng              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20241231'
and report_dsc_rn='1'
union all
SELECT  cst_id
       ,REPLACE(substr(report_dt,1,10),'-','')	 --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,OTH_BANK_BUSI_ORG_NUM        --他行贷款授信机构数
       ,NUll
       ,un_sett_loan_rzbank_num	 	--未结清贷款授信机构数
       ,un_sett_loan_total_amt
       ,0                --信用卡张数
       ,0          	--信用卡总授信额度
       ,0        	--信用卡总余额
       ,NUll         --最近一年内的查询次数
       ,NUll         --最近3个月审批查询次数
       ,NUll         --最近6个月审批查询次数
       ,NUll              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_entp_ind_inf_dd
where dt='20241231'
and report_dsc_rn='1'
and cst_id not in(
    SELECT cst_id
    from edw.dws_cst_ccrc_idv_ind_inf_dd
    where dt='20241231' and report_dsc_rn='1'
)
;
--客户办理该笔业务时预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_05 AS
select t1.REL_SERNO,t1.cst_id,t1.ctr_serno
    ,t1.ctr_bgn_dt,t1.pd_nm
    ,t2.USC_APLY_SERNO
    ,t3.APLY_ACPT_NO
    ,t4.PRE_ASES_SERNO
    ,t4.rul_set_rslt_nm
from SJXQ_SJ2025032601_CST_01                       t1
LEFT JOIN edw.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD    t2
ON t2.USC_APLY_SERNO = t1.REL_SERNO
AND t2.DT = '20241231'
left join EDW.DWD_BUS_LOAN_APLY_ACPT_INF_DD         t3 --申请受理信息
ON t3.APLY_ACPT_NO = t2.APLY_ACPT_NO
AND t3.DT = '20241231'
left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t2.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20241231'
    group by t2.PRE_ASES_SERNO
)T4 ON T3.PRE_ASES_SERNO = T4.PRE_ASES_SERNO
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_05_1 AS
select t1.REL_SERNO,t1.cst_id,t1.ctr_serno
    ,t1.ctr_bgn_dt,t1.pd_nm
    ,t2.USC_APLY_SERNO
    ,t4.PRE_ASES_SERNO
    ,t4.rul_set_rslt_nm
    ,t2.sys_reg_tm
    ,ROW_NUMBER() over(partition by t1.REL_SERNO order by t2.sys_reg_tm desc) rn
from SJXQ_SJ2025032601_CST_01                       t1
LEFT JOIN (
    SELECT distinct USC_APLY_SERNO,pre_ases_serno,sys_reg_tm
    from  edw.dwd_bus_loan_lmt_aply_rel_ases_dd
    where dt='20241231'
)t2 ON t2.USC_APLY_SERNO = t1.REL_SERNO
left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t2.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20241231'
    group by t2.PRE_ASES_SERNO
)T4 ON T2.PRE_ASES_SERNO = T4.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST_06 AS
SELECT  t1.cst_id                       AS 客户号
       ,t1.cst_nm                       AS 客户名
        ,t1.年龄段
        ,t1.婚姻状况
       ,t1.org_nm                       AS 管户机构
       ,t1.mgr_nm                       AS 管户人
       ,t1.ctr_amt                      AS 客户授信总金额
       ,t1.ctr_bal                      AS 客户授信总余额
       ,t1.lst_mtu_dt                   AS 合同最近到期日
       ,t2.prd_dt                       AS 中征分日期
       ,t2.scor_rng                     AS 中征分段
       ,t4.report_dt                    AS 征信报告日期
       ,t4.scor_rng                     AS 征信分段
       ,t4.oth_bank_loan_org_num        AS 他行贷款授信机构数
       ,t4.oth_bank_loan_credit_bal     AS 他行贷款授信余额
       ,t4.curr_unsett_fyh_loan_org_num AS 当前未结清非银行贷款机构数
       ,t4.curr_unsett_fyh_loan_bal     AS 当前未结清非银行贷款余额
       ,t4.cred_card_num                AS 信用卡张数
       ,t4.cred_card_total_amt          AS 信用卡总授信额度
       ,t4.cred_card_total_balan        AS 信用卡总余额
       ,t4.late_year_enqu_count         AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count         AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count         AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm              AS 客户预评估结果
       ,nvl(t5.rul_set_rslt_nm,t7.rul_set_rslt_nm) as 客户办理该笔业务时预评估结果
       ,t1.sdt_amt                      AS 我行随贷通额度
       ,t1.sdt_bal                      AS 我行随贷通余额
from(
    SELECT cst_id,cst_nm
            when age >=20 and age<=50  then '[20,50]' when age>50 then '50岁以上' else '' end)) as 年龄段
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2025032601_CST_01
    group by cst_id,cst_nm
)t1 left join SJXQ_SJ2025032601_CST_02  t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ2025032601_CST_03      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025032601_CST_04      t4
on t1.cst_id=t4.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025032601_CST_05
    where rul_set_rslt_nm is not null
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    select cst_id
    from(
        SELECT REL_SERNO,cst_id,ctr_bgn_dt,pd_nm
        from SJXQ_SJ2025032601_CST_05_1
        where rul_set_rslt_nm is not null
        GROUP BY REL_SERNO,cst_id,ctr_bgn_dt,pd_nm
    )t group by cst_id
)t7 on t1.cst_id=t7.cst_id
;
SElECT '06' seq, *
from SJXQ_SJ2025032601_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032601_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032601_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032601_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032601_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032601_CST_05 where pre_ases_serno is not null
union all
SElECT '051' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032601_CST_05_1 where pre_ases_serno is not null
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025032601_CST_06
;
/*
01	4222	4222
02	3555095	3555094
03	1451474	1451474
04	6239799	6239799
05	1848	1848
051	9031	4183
06	3900	3900
*/***方利利_SJ2025032601_福清村行征信数据20250326.sql
﻿-- 截至2025/3/26、2024/12/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,round(DATEDIFF(to_date(t6.dt, 'yyyymmdd'), to_date(T6.bth_dt, 'yyyymmdd'), 'dd')/365,1) as age
    ,c1.cd_val_dscr     as 婚姻状况
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '福建福清泰隆村镇'
left join edw.dws_cst_idv_bas_inf_dd	t6 --个人客户基本信息汇总表
on  t1.cst_id=t6.cst_id
and t6.dt=t1.dt
LEFT JOIN    edw.dwd_code_library_dd    c1
ON      T6.mrg_situ_cd = c1.CD_VAL
AND     c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND     c1.FLD_NM = 'MRG_SITU_CD'
and     c1.dt = t1.dt
where t1.dt='20250326'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--标准代码块：最新的中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250326' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250326' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20250326' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20250326' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_03 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250326'
)t1 inner JOIN (
    SElECT t1.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t1 --预评估规则集关系
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t1.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t1.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t1.DT = '20250326'
    AND DATEDIFF(to_date(t1.DT, 'yyyymmdd'), to_date(substr(REPLACE(T1.SYS_REG_TM, '-', ''), 1, 8), 'yyyymmdd'), 'MM') <= 12 --近12个月内的数据
    group by t1.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20250326'
where t1.rn=1
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_04 AS
SELECT  cst_id
       ,REPLACE(substr(report_dt,1,10),'-','') as report_dt --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
       ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
       ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
       ,cred_card_num                --信用卡张数
       ,cred_card_total_amt          --信用卡总授信额度
       ,cred_card_total_balan        --信用卡总余额
       ,late_year_enqu_count         --最近一年内的查询次数
       ,late_3mon_enqu_count         --最近3个月审批查询次数
       ,late_6mon_enqu_count         --最近6个月审批查询次数
       ,scor_rng              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20250326'
and report_dsc_rn='1'
union all
SELECT  cst_id
       ,REPLACE(substr(report_dt,1,10),'-','')	 --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,OTH_BANK_BUSI_ORG_NUM        --他行贷款授信机构数
       ,NUll
       ,un_sett_loan_rzbank_num	 	--未结清贷款授信机构数
       ,un_sett_loan_total_amt
       ,0                --信用卡张数
       ,0          	--信用卡总授信额度
       ,0        	--信用卡总余额
       ,NUll         --最近一年内的查询次数
       ,NUll         --最近3个月审批查询次数
       ,NUll         --最近6个月审批查询次数
       ,NUll              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_entp_ind_inf_dd
where dt='20250326'
and report_dsc_rn='1'
and cst_id not in(
    SELECT cst_id
    from edw.dws_cst_ccrc_idv_ind_inf_dd
    where dt='20250326' and report_dsc_rn='1'
)
;
--客户办理该笔业务时预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_05 AS
select t1.REL_SERNO,t1.cst_id,t1.ctr_serno
    ,t1.ctr_bgn_dt,t1.pd_nm
    ,t2.USC_APLY_SERNO
    ,t3.APLY_ACPT_NO
    ,t4.PRE_ASES_SERNO
    ,t4.rul_set_rslt_nm
from SJXQ_SJ2025032601_CST2_01                       t1
LEFT JOIN edw.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD    t2
ON t2.USC_APLY_SERNO = t1.REL_SERNO
AND t2.DT = '20250326'
left join EDW.DWD_BUS_LOAN_APLY_ACPT_INF_DD         t3 --申请受理信息
ON t3.APLY_ACPT_NO = t2.APLY_ACPT_NO
AND t3.DT = '20250326'
left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t2.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250326'
    group by t2.PRE_ASES_SERNO
)T4 ON T3.PRE_ASES_SERNO = T4.PRE_ASES_SERNO
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_05_1 AS
select t1.REL_SERNO,t1.cst_id,t1.ctr_serno
    ,t1.ctr_bgn_dt,t1.pd_nm
    ,t2.USC_APLY_SERNO
    ,t4.PRE_ASES_SERNO
    ,t4.rul_set_rslt_nm
    ,t2.sys_reg_tm
    ,ROW_NUMBER() over(partition by t1.REL_SERNO order by t2.sys_reg_tm desc) rn
from SJXQ_SJ2025032601_CST2_01                       t1
LEFT JOIN (
    SELECT distinct USC_APLY_SERNO,pre_ases_serno,sys_reg_tm
    from  edw.dwd_bus_loan_lmt_aply_rel_ases_dd
    where dt='20250326'
)t2 ON t2.USC_APLY_SERNO = t1.REL_SERNO
left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t2.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250326'
    group by t2.PRE_ASES_SERNO
)T4 ON T2.PRE_ASES_SERNO = T4.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032601_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032601_CST2_06 AS
SELECT  t1.cst_id                       AS 客户号
       ,t1.cst_nm                       AS 客户名
        ,t1.年龄段
        ,t1.婚姻状况
       ,t1.org_nm                       AS 管户机构
       ,t1.mgr_nm                       AS 管户人
       ,t1.ctr_amt                      AS 客户授信总金额
       ,t1.ctr_bal                      AS 客户授信总余额
       ,t1.lst_mtu_dt                   AS 合同最近到期日
       ,t2.prd_dt                       AS 中征分日期
       ,t2.scor_rng                     AS 中征分段
       ,t4.report_dt                    AS 征信报告日期
       ,t4.scor_rng                     AS 征信分段
       ,t4.oth_bank_loan_org_num        AS 他行贷款授信机构数
       ,t4.oth_bank_loan_credit_bal     AS 他行贷款授信余额
       ,t4.curr_unsett_fyh_loan_org_num AS 当前未结清非银行贷款机构数
       ,t4.curr_unsett_fyh_loan_bal     AS 当前未结清非银行贷款余额
       ,t4.cred_card_num                AS 信用卡张数
       ,t4.cred_card_total_amt          AS 信用卡总授信额度
       ,t4.cred_card_total_balan        AS 信用卡总余额
       ,t4.late_year_enqu_count         AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count         AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count         AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm              AS 客户预评估结果
       ,nvl(t5.rul_set_rslt_nm,t7.rul_set_rslt_nm) as 客户办理该笔业务时预评估结果
       ,t1.sdt_amt                      AS 我行随贷通额度
       ,t1.sdt_bal                      AS 我行随贷通余额
from(
    SELECT cst_id,cst_nm
            when age >=20 and age<=50  then '[20,50]' when age>50 then '50岁以上' else '' end)) as 年龄段
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2025032601_CST2_01
    group by cst_id,cst_nm
)t1 left join SJXQ_SJ2025032601_CST2_02  t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ2025032601_CST2_03      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025032601_CST2_04      t4
on t1.cst_id=t4.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025032601_CST2_05
    where rul_set_rslt_nm is not null
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    select cst_id
    from(
        SELECT REL_SERNO,cst_id,ctr_bgn_dt,pd_nm
        from SJXQ_SJ2025032601_CST2_05_1
        where rul_set_rslt_nm is not null
        GROUP BY REL_SERNO,cst_id,ctr_bgn_dt,pd_nm
    )t group by cst_id
)t7 on t1.cst_id=t7.cst_id
;
SElECT '06' seq, *
from SJXQ_SJ2025032601_CST2_06
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032601_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032601_CST2_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032601_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032601_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032601_CST2_05 where pre_ases_serno is not null
union all
SElECT '051' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025032601_CST2_05_1 where pre_ases_serno is not null
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025032601_CST2_06
;
/*
01	4258	4258
02	54359855	3626597
03	1461540	1461540
04	6305677	6305677
05	1897	1897
051	9086	4220
06	3952	3952
*/***方利利_SJ2025071621_福清村行征信数据.sql
﻿-- 方利利_SJ2025071621_福清村行征信数据
-- 截至2025/7/15、2025/3/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的对公、对私客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,round(DATEDIFF(to_date(t6.dt, 'yyyymmdd'), to_date(T6.bth_dt, 'yyyymmdd'), 'dd')/365,1) as age
    ,c1.cd_val_dscr     as 婚姻状况
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '福建福清泰隆村镇'
left join edw.dws_cst_idv_bas_inf_dd	t6 --个人客户基本信息汇总表
on  t1.cst_id=t6.cst_id
and t6.dt=t1.dt
LEFT JOIN    edw.dwd_code_library_dd    c1
ON      T6.mrg_situ_cd = c1.CD_VAL
AND     c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND     c1.FLD_NM = 'MRG_SITU_CD'
and     c1.dt = t1.dt
where t1.dt='20250331'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250331'
)t1 inner JOIN (
    SElECT t1.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t1 --预评估规则集关系
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t1.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t1.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t1.DT = '20250331'
    AND DATEDIFF(to_date(t1.DT, 'yyyymmdd'), to_date(substr(REPLACE(T1.SYS_REG_TM, '-', ''), 1, 8), 'yyyymmdd'), 'MM') <= 12 --近12个月内的数据
    group by t1.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20250331'
where t1.rn=1
;
-- 新征信表-个人
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST_03 AS
SELECT t1.cst_id
    ,t1.report_no                                --报告编号
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as report_dt --报告日期
    ,t1.oth_bank_loan_org_num        --他行贷款授信机构数_参考
    ,t1.oth_bank_loan_credit_bal     --他行贷款授信余额_参考
    ,t1.curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数_参考
    ,t1.curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额_参考
    ,t1.cred_card_num                --信用卡张数
    ,t1.cred_card_total_amt          --信用卡总授信额度
    ,t1.cred_card_total_balan        --信用卡总余额
    ,t1.late_year_enqu_count         --最近一年内的查询次数
    ,t1.late_3mon_enqu_count         --最近3个月审批查询次数
    ,t1.late_6mon_enqu_count         --最近6个月审批查询次数
    ,t1.scor_rng              		 --个人信用评分分值
    ,t2.他行贷款授信机构数
    ,t2.他行贷款有余额机构数
    ,t2.他行贷款余额
    ,t2.非银行贷款授信机构数
    ,t2.非银行贷款有余额机构数
    ,t2.非银行贷款余额
    ,t2.他行贷款逾期机构数
    ,t2.他行贷款逾期金额
    ,t2.他行信用卡逾期机构数
    ,t2.他行信用卡逾期金额
    ,t2.他行非正常贷款家数
    ,t2.他行非正常贷款余额
from edw.dws_cst_ccrc_idv_ind_inf_dd t1
left join(
--他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
SELECT  report_id
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org end)                                                       AS 他行贷款授信机构数
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND ctr_bal > 0 THEN dtrb_org end)                                       AS 他行贷款有余额机构数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ctr_bal else 0 end)                                                            AS 他行贷款余额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND ovd_amt > 0 THEN dtrb_org end)                                       AS 他行贷款逾期机构数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_amt else 0 end)                                                            AS 他行贷款逾期金额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'R2','R3' ) AND ovd_amt > 0 THEN dtrb_org end)                                              AS 他行信用卡逾期机构数
       ,SUM(case WHEN act_typ_cd IN ( 'R2','R3' ) THEN ovd_amt else 0 end)                                                                   AS 他行信用卡逾期金额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN dtrb_org end)                                AS 他行非正常贷款家数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN ctr_bal else 0 end)                                     AS 他行非正常贷款余额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd
    where  dt = '20250331'
	and dtrb_org <> 'ZJTLCB'                   --他行
    group by report_id
)t2 on t1.report_no=t2.report_id
where t1.dt='20250331'
and t1.report_dsc_rn='1'
;
-- 新征信表-企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST_04 AS
SELECT  t1.cst_id
    ,t1.report_no                              --报告编号
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as report_dt --报告日期
    ,t1.OTH_BANK_BUSI_ORG_NUM                  --他行贷款授信机构数
    ,t1.un_sett_loan_rzbank_num                --未结清贷款授信机构数
    ,t1.un_sett_loan_total_amt                 --未结清贷款总额
    ,t1.late_12mon_org_pass_num                --最近12个月金融机构审批通过家数
    ,t1.late_6mon_org_pass_num                 --近6个月金融机构审批通过家数
    ,t2.他行贷款授信机构数
    ,t2.他行贷款有余额机构数
    ,t2.他行贷款余额
    ,t2.非银行贷款授信机构数
    ,t2.非银行贷款有余额机构数
    ,t2.非银行贷款余额
    ,t2.他行贷款逾期机构数
    ,t2.他行贷款逾期金额
    ,t2.他行信用卡逾期机构数
    ,t2.他行信用卡逾期金额
    ,t2.他行非正常贷款家数
    ,t2.他行非正常贷款余额
from edw.dws_cst_ccrc_entp_ind_inf_dd   t1
inner join(
    --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
    SELECT  report_id
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org_cd end)                                                       AS 他行贷款授信机构数
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND loan_bal > 0 THEN dtrb_org_cd end)                                       AS 他行贷款有余额机构数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN loan_bal else 0 end)                                                            AS 他行贷款余额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND ovd_tot_amt > 0 THEN dtrb_org_cd end)                                       AS 他行贷款逾期机构数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_tot_amt else 0 end)                                                            AS 他行贷款逾期金额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'R2','R3' ) AND ovd_tot_amt > 0 THEN dtrb_org_cd end)                                              AS 他行信用卡逾期机构数
        ,SUM(case WHEN act_typ IN ( 'R2','R3' ) THEN ovd_tot_amt else 0 end)                                                                   AS 他行信用卡逾期金额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN dtrb_org_cd end)                                AS 他行非正常贷款家数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN loan_bal else 0 end)                                     AS 他行非正常贷款余额
    from   edw.dim_cst_ccrc_entp_loan_inf_dd a
    where  a.dt = '20250331'
    and    a.dtrb_org_typ_cd <> '00'  ---- 剔除泰隆银行
    group by report_id
)t2 on t1.report_no=t2.report_id
where t1.dt='20250331'
and t1.report_dsc_rn='1'
and not exists(
    select 1
    from SJXQ_SJ2025071621_CST_03 t3
    WHERE t1.cst_id=t3.cst_id
)
;
--客户办理该笔业务时预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST_05 AS
select t1.REL_SERNO,t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt,t1.pd_nm
    ,t2.PRE_ASES_SERNO
    ,t4.rul_set_rslt_nm
from SJXQ_SJ2025071621_CST_01                       t1
INNER JOIN(
	SELECT t1.USC_APLY_SERNO
		,t2.PRE_ASES_SERNO
	from edw.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD    t1 --申请受理与授信表关联关系
	left join EDW.DWD_BUS_LOAN_APLY_ACPT_INF_DD    t2 --申请受理信息
	ON t2.APLY_ACPT_NO = t1.APLY_ACPT_NO
	AND t2.DT = t1.dt
	where t1.dt='20250331'
	union
	SELECT USC_APLY_SERNO,pre_ases_serno
	from  edw.dwd_bus_loan_lmt_aply_rel_ases_dd --授信关联预评估信息表
	where dt='20250331'
)t2 on t1.REL_SERNO=t2.USC_APLY_SERNO
INNER JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t2.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250331'
    group by t2.PRE_ASES_SERNO
)T4 ON t2.PRE_ASES_SERNO = T4.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST_06 AS
SELECT  t1.cst_id                AS 客户号
       ,t1.cst_nm                AS 客户名
       ,t1.年龄段
       ,t1.婚姻状况
       ,t1.org_nm                AS 管户机构
       ,t1.mgr_nm                AS 管户人
       ,t1.ctr_amt               AS 客户授信总金额
       ,t1.ctr_bal               AS 客户授信总余额
       ,t1.lst_mtu_dt            AS 合同最近到期日
       ,t6.借据最近到期日
       ,t2.prd_dt                AS 中征分日期
       ,t2.scor_rng              AS 中征分段
       ,t4.report_dt             AS 征信报告日期
       ,t4.scor_rng              AS 征信分段
       ,t4.他行贷款授信机构数
       ,t4.他行贷款有余额机构数
       ,t4.他行贷款余额
       ,t4.非银行贷款授信机构数
       ,t4.非银行贷款有余额机构数
       ,t4.非银行贷款余额
       ,t4.cred_card_num         AS 信用卡张数
       ,t4.cred_card_total_amt   AS 信用卡总授信额度
       ,t4.cred_card_total_balan AS 信用卡总余额
       ,t4.他行贷款逾期机构数
       ,t4.他行贷款逾期金额
       ,t4.他行信用卡逾期机构数
       ,t4.他行信用卡逾期金额
       ,t4.他行非正常贷款家数
       ,t4.他行非正常贷款余额
       ,t4.late_year_enqu_count  AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count  AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count  AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm       AS 客户最新预评估结果
       ,t5.rul_set_rslt_nm       AS 客户办理该笔业务时预评估结果
       ,t1.sdt_amt               AS 我行随贷通额度
       ,t1.sdt_bal               AS 我行随贷通余额
from(
    SELECT cst_id,cst_nm
            when age>=20 and age<30 then '[20,30)'
            when age>=30 and age<40 then '[30,40)'
            when age>=40 and age<50 then '[40,50)'
            when age>=50 and age<60 then '[50,60)'
            when age>=60 then '60岁及以上' else '' end)) as 年龄段
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2025071621_CST_01
    group by cst_id,cst_nm
)t1 left join(
    -- 中征分
    select cst_id,prd_dt,cst_cr_grd_val
        ,nvl(cst_cr_grd_val,0) as zz_score
        ,scor_rng
        ,row_number() over(partition by cst_id order by prd_dt desc) rn
    from(
        SELECT cst_id,prd_dt,cst_cr_grd_val,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20250331'
        union
        SELECT cst_id
            ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
            ,cr_sco_val                          AS cst_cr_grd_val
            ,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20250331'
    )t where nvl(cst_id,'')<>''
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ2025071621_CST_02      t3
on t1.cst_id=t3.cst_id
left join(
    select cst_id,report_dt
        ,cred_card_num                --信用卡张数
        ,cred_card_total_amt          --信用卡总授信额度
        ,cred_card_total_balan        --信用卡总余额
        ,late_year_enqu_count         --最近一年内的查询次数
        ,late_3mon_enqu_count         --最近3个月审批查询次数
        ,late_6mon_enqu_count         --最近6个月审批查询次数
        ,scor_rng              		 --个人信用评分分值
        ,他行贷款授信机构数
        ,他行贷款有余额机构数
        ,他行贷款余额
        ,非银行贷款授信机构数
        ,非银行贷款有余额机构数
        ,非银行贷款余额
        ,他行贷款逾期机构数
        ,他行贷款逾期金额
        ,他行信用卡逾期机构数
        ,他行信用卡逾期金额
        ,他行非正常贷款家数
        ,他行非正常贷款余额
    from SJXQ_SJ2025071621_CST_03
    union all
    select cst_id,report_dt
        ,null,null,null,null,null,null,null
        ,他行贷款授信机构数
        ,他行贷款有余额机构数
        ,他行贷款余额
        ,非银行贷款授信机构数
        ,非银行贷款有余额机构数
        ,非银行贷款余额
        ,他行贷款逾期机构数
        ,他行贷款逾期金额
        ,他行信用卡逾期机构数
        ,他行信用卡逾期金额
        ,他行非正常贷款家数
        ,他行非正常贷款余额
    from SJXQ_SJ2025071621_CST_04
)t4
on t1.cst_id=t4.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025071621_CST_05
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    select t1.cst_id
        ,max(t2.MTU_DT)  as 借据最近到期日
    from SJXQ_SJ2025071621_CST_01               t1
    inner join edw.dim_bus_loan_dbil_inf_dd     t2 --信贷借据信息
    on t1.ctr_serno=t2.CTR_SERNO
    and t2.dt='20250331'
    group by t1.cst_id
)t6 on t1.cst_id=t6.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025071621_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071621_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071621_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071621_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct PRE_ASES_SERNO) custs
from SJXQ_SJ2025071621_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071621_CST_06
;
/*
01	4264	4264
02	1455526	1455526
03	5814244	5814244
04	230288	230288
05	9351	9095
06	3958	3958
*/
SElECT '06' seq, *
from SJXQ_SJ2025071621_CST_06
***方利利_SJ2025071621_福清村行征信数据20250715.sql
﻿-- 方利利_SJ2025071621_福清村行征信数据
-- 截至2025/7/15、2025/3/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的对公、对私客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST2_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,round(DATEDIFF(to_date(t6.dt, 'yyyymmdd'), to_date(T6.bth_dt, 'yyyymmdd'), 'dd')/365,1) as age
    ,c1.cd_val_dscr     as 婚姻状况
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '福建福清泰隆村镇'
left join edw.dws_cst_idv_bas_inf_dd	t6 --个人客户基本信息汇总表
on  t1.cst_id=t6.cst_id
and t6.dt=t1.dt
LEFT JOIN    edw.dwd_code_library_dd    c1
ON      T6.mrg_situ_cd = c1.CD_VAL
AND     c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND     c1.FLD_NM = 'MRG_SITU_CD'
and     c1.dt = t1.dt
where t1.dt='20250715'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST2_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250715'
)t1 inner JOIN (
    SElECT t1.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t1 --预评估规则集关系
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t1.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t1.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t1.DT = '20250715'
    AND DATEDIFF(to_date(t1.DT, 'yyyymmdd'), to_date(substr(REPLACE(T1.SYS_REG_TM, '-', ''), 1, 8), 'yyyymmdd'), 'MM') <= 12 --近12个月内的数据
    group by t1.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20250715'
where t1.rn=1
;
-- 新征信表-个人
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST2_03 AS
SELECT t1.cst_id
    ,t1.report_no                                --报告编号
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as report_dt --报告日期
    ,t1.oth_bank_loan_org_num        --他行贷款授信机构数_参考
    ,t1.oth_bank_loan_credit_bal     --他行贷款授信余额_参考
    ,t1.curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数_参考
    ,t1.curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额_参考
    ,t1.cred_card_num                --信用卡张数
    ,t1.cred_card_total_amt          --信用卡总授信额度
    ,t1.cred_card_total_balan        --信用卡总余额
    ,t1.late_year_enqu_count         --最近一年内的查询次数
    ,t1.late_3mon_enqu_count         --最近3个月审批查询次数
    ,t1.late_6mon_enqu_count         --最近6个月审批查询次数
    ,t1.scor_rng              		 --个人信用评分分值
    ,t2.他行贷款授信机构数
    ,t2.他行贷款有余额机构数
    ,t2.他行贷款余额
    ,t2.非银行贷款授信机构数
    ,t2.非银行贷款有余额机构数
    ,t2.非银行贷款余额
    ,t2.他行贷款逾期机构数
    ,t2.他行贷款逾期金额
    ,t2.他行信用卡逾期机构数
    ,t2.他行信用卡逾期金额
    ,t2.他行非正常贷款家数
    ,t2.他行非正常贷款余额
from edw.dws_cst_ccrc_idv_ind_inf_dd t1
left join(
--他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
SELECT  report_id
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org end)                                                       AS 他行贷款授信机构数
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND ctr_bal > 0 THEN dtrb_org end)                                       AS 他行贷款有余额机构数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ctr_bal else 0 end)                                                            AS 他行贷款余额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND ovd_amt > 0 THEN dtrb_org end)                                       AS 他行贷款逾期机构数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_amt else 0 end)                                                            AS 他行贷款逾期金额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'R2','R3' ) AND ovd_amt > 0 THEN dtrb_org end)                                              AS 他行信用卡逾期机构数
       ,SUM(case WHEN act_typ_cd IN ( 'R2','R3' ) THEN ovd_amt else 0 end)                                                                   AS 他行信用卡逾期金额
       ,COUNT(distinct CASE WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN dtrb_org end)                                AS 他行非正常贷款家数
       ,SUM(case WHEN act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN ctr_bal else 0 end)                                     AS 他行非正常贷款余额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd
    where  dt = '20250715'
	and dtrb_org <> 'ZJTLCB'                   --他行
    group by report_id
)t2 on t1.report_no=t2.report_id
where t1.dt='20250715'
and t1.report_dsc_rn='1'
;
-- 新征信表-企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST2_04 AS
SELECT  t1.cst_id
    ,t1.report_no                              --报告编号
    ,REPLACE(substr(t1.report_dt,1,10),'-','') as report_dt --报告日期
    ,t1.OTH_BANK_BUSI_ORG_NUM                  --他行贷款授信机构数
    ,t1.un_sett_loan_rzbank_num                --未结清贷款授信机构数
    ,t1.un_sett_loan_total_amt                 --未结清贷款总额
    ,t1.late_12mon_org_pass_num                --最近12个月金融机构审批通过家数
    ,t1.late_6mon_org_pass_num                 --近6个月金融机构审批通过家数
    ,t2.他行贷款授信机构数
    ,t2.他行贷款有余额机构数
    ,t2.他行贷款余额
    ,t2.非银行贷款授信机构数
    ,t2.非银行贷款有余额机构数
    ,t2.非银行贷款余额
    ,t2.他行贷款逾期机构数
    ,t2.他行贷款逾期金额
    ,t2.他行信用卡逾期机构数
    ,t2.他行信用卡逾期金额
    ,t2.他行非正常贷款家数
    ,t2.他行非正常贷款余额
from edw.dws_cst_ccrc_entp_ind_inf_dd   t1
inner join(
    --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
    SELECT  report_id
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org_cd end)                                                       AS 他行贷款授信机构数
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND loan_bal > 0 THEN dtrb_org_cd end)                                       AS 他行贷款有余额机构数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN loan_bal else 0 end)                                                            AS 他行贷款余额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND ovd_tot_amt > 0 THEN dtrb_org_cd end)                                       AS 他行贷款逾期机构数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_tot_amt else 0 end)                                                            AS 他行贷款逾期金额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'R2','R3' ) AND ovd_tot_amt > 0 THEN dtrb_org_cd end)                                              AS 他行信用卡逾期机构数
        ,SUM(case WHEN act_typ IN ( 'R2','R3' ) THEN ovd_tot_amt else 0 end)                                                                   AS 他行信用卡逾期金额
        ,COUNT(distinct CASE WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN dtrb_org_cd end)                                AS 他行非正常贷款家数
        ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN loan_bal else 0 end)                                     AS 他行非正常贷款余额
    from   edw.dim_cst_ccrc_entp_loan_inf_dd a
    where  a.dt = '20250715'
    and    a.dtrb_org_typ_cd <> '00'  ---- 剔除泰隆银行
    group by report_id
)t2 on t1.report_no=t2.report_id
where t1.dt='20250715'
and t1.report_dsc_rn='1'
and not exists(
    select 1
    from SJXQ_SJ2025071621_CST2_03 t3
    WHERE t1.cst_id=t3.cst_id
)
;
--客户办理该笔业务时预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST2_05 AS
select t1.REL_SERNO,t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt,t1.pd_nm
    ,t2.PRE_ASES_SERNO
    ,t4.rul_set_rslt_nm
from SJXQ_SJ2025071621_CST2_01                       t1
INNER JOIN(
	SELECT t1.USC_APLY_SERNO
		,t2.PRE_ASES_SERNO
	from edw.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD    t1 --申请受理与授信表关联关系
	left join EDW.DWD_BUS_LOAN_APLY_ACPT_INF_DD    t2 --申请受理信息
	ON t2.APLY_ACPT_NO = t1.APLY_ACPT_NO
	AND t2.DT = t1.dt
	where t1.dt='20250715'
	union
	SELECT USC_APLY_SERNO,pre_ases_serno
	from  edw.dwd_bus_loan_lmt_aply_rel_ases_dd --授信关联预评估信息表
	where dt='20250715'
)t2 on t1.REL_SERNO=t2.USC_APLY_SERNO
INNER JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = t2.DT
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250715'
    group by t2.PRE_ASES_SERNO
)T4 ON t2.PRE_ASES_SERNO = T4.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071621_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071621_CST2_06 AS
SELECT  t1.cst_id                AS 客户号
       ,t1.cst_nm                AS 客户名
       ,t1.年龄段
       ,t1.婚姻状况
       ,t1.org_nm                AS 管户机构
       ,t1.mgr_nm                AS 管户人
       ,t1.ctr_amt               AS 客户授信总金额
       ,t1.ctr_bal               AS 客户授信总余额
       ,t1.lst_mtu_dt            AS 合同最近到期日
       ,t6.借据最近到期日
       ,t2.prd_dt                AS 中征分日期
       ,t2.scor_rng              AS 中征分段
       ,t4.report_dt             AS 征信报告日期
       ,t4.scor_rng              AS 征信分段
       ,t4.他行贷款授信机构数
       ,t4.他行贷款有余额机构数
       ,t4.他行贷款余额
       ,t4.非银行贷款授信机构数
       ,t4.非银行贷款有余额机构数
       ,t4.非银行贷款余额
       ,t4.cred_card_num         AS 信用卡张数
       ,t4.cred_card_total_amt   AS 信用卡总授信额度
       ,t4.cred_card_total_balan AS 信用卡总余额
       ,t4.他行贷款逾期机构数
       ,t4.他行贷款逾期金额
       ,t4.他行信用卡逾期机构数
       ,t4.他行信用卡逾期金额
       ,t4.他行非正常贷款家数
       ,t4.他行非正常贷款余额
       ,t4.late_year_enqu_count  AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count  AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count  AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm       AS 客户最新预评估结果
       ,t5.rul_set_rslt_nm       AS 客户办理该笔业务时预评估结果
       ,t1.sdt_amt               AS 我行随贷通额度
       ,t1.sdt_bal               AS 我行随贷通余额
from(
    SELECT cst_id,cst_nm
            when age>=20 and age<30 then '[20,30)'
            when age>=30 and age<40 then '[30,40)'
            when age>=40 and age<50 then '[40,50)'
            when age>=50 and age<60 then '[50,60)'
            when age>=60 then '60岁及以上' else '' end)) as 年龄段
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2025071621_CST2_01
    group by cst_id,cst_nm
)t1 left join(
    -- 中征分
    select cst_id,prd_dt,cst_cr_grd_val
        ,nvl(cst_cr_grd_val,0) as zz_score
        ,scor_rng
        ,row_number() over(partition by cst_id order by prd_dt desc) rn
    from(
        SELECT cst_id,prd_dt,cst_cr_grd_val,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20250715'
        union
        SELECT cst_id
            ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
            ,cr_sco_val                          AS cst_cr_grd_val
            ,scor_rng
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20250715'
    )t where nvl(cst_id,'')<>''
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ2025071621_CST2_02      t3
on t1.cst_id=t3.cst_id
left join(
    select cst_id,report_dt
        ,cred_card_num                --信用卡张数
        ,cred_card_total_amt          --信用卡总授信额度
        ,cred_card_total_balan        --信用卡总余额
        ,late_year_enqu_count         --最近一年内的查询次数
        ,late_3mon_enqu_count         --最近3个月审批查询次数
        ,late_6mon_enqu_count         --最近6个月审批查询次数
        ,scor_rng              		 --个人信用评分分值
        ,他行贷款授信机构数
        ,他行贷款有余额机构数
        ,他行贷款余额
        ,非银行贷款授信机构数
        ,非银行贷款有余额机构数
        ,非银行贷款余额
        ,他行贷款逾期机构数
        ,他行贷款逾期金额
        ,他行信用卡逾期机构数
        ,他行信用卡逾期金额
        ,他行非正常贷款家数
        ,他行非正常贷款余额
    from SJXQ_SJ2025071621_CST2_03
    union all
    select cst_id,report_dt
        ,null,null,null,null,null,null,null
        ,他行贷款授信机构数
        ,他行贷款有余额机构数
        ,他行贷款余额
        ,非银行贷款授信机构数
        ,非银行贷款有余额机构数
        ,非银行贷款余额
        ,他行贷款逾期机构数
        ,他行贷款逾期金额
        ,他行信用卡逾期机构数
        ,他行信用卡逾期金额
        ,他行非正常贷款家数
        ,他行非正常贷款余额
    from SJXQ_SJ2025071621_CST2_04
)t4
on t1.cst_id=t4.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025071621_CST2_05
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    select t1.cst_id
        ,max(t2.MTU_DT)  as 借据最近到期日
    from SJXQ_SJ2025071621_CST2_01               t1
    inner join edw.dim_bus_loan_dbil_inf_dd     t2 --信贷借据信息
    on t1.ctr_serno=t2.CTR_SERNO
    and t2.dt='20250715'
    group by t1.cst_id
)t6 on t1.cst_id=t6.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025071621_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071621_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071621_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071621_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct PRE_ASES_SERNO) custs
from SJXQ_SJ2025071621_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071621_CST2_06
;
/*
01	4593	4593
02	1468816	1468816
03	5889297	5889297
04	244188	244188
05	9829	9539
06	4263	4263
*/
SElECT '06' seq, *
from SJXQ_SJ2025071621_CST2_06
***方安君_SJ20250206131_综合积分.sql
﻿
DROP   TABLE IF EXISTS SJXQ_SJ20250206131_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250206131_CST_01
(
    cst_id      string COMMENT '客户号'
    ,cst_nm     string COMMENT '姓名'
)
;
insert into SJXQ_SJ20250206131_CST_01
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250206131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250206131_CST_02 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_nm      AS 客户姓名
       ,t2.mbl_nbr     AS 手机
       ,t2.FML_TEL_NBR as 家庭电话
       ,t3.pnt_bal_sum AS 客户当前综合积分余额
from SJXQ_SJ20250206131_CST_01          t1
left join edw.dws_cst_idv_bas_inf_dd	t2 --个人客户基本信息汇总表	43	|C32
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left JOIN (
	 select  cst_id
	        ,sum(pnt_bal)  as pnt_bal_sum
	 from   edw.dim_bus_cmpn_pnt_act_inf_dd
	 WHERE  dt='@@{yyyyMMdd}'
	 AND    pnt_typ_cd='0001'   --综合积分
	 GROUP BY cst_id
)T3  on  T1.cst_id=T3.cst_id
-- left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t4 同 t2
-- on t1.cst_id=t4.cst_id
-- and t4.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250206131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250206131_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20250206131_CST_02
;
***方安君_SJ20250414131_杭州分行双录数据.sql
﻿--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ20250414131_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250414131_CST_01 as
SELECT  a.ctr_serno
       ,a.grnt_mod_colc
FROM
(
	SELECT  ctr_serno
        ,grnt_mod_colc
        ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc as grnt_mod_colc2
	WHERE dt = '@@{yyyyMMdd}'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.ctr_serno
         ,a.grnt_mod_colc
;
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250414131_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250414131_CST_02 as
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd
    ,c1.cd_val_dscr     as ctr_sts_nm
    ,t1.grnt_mod_colc	    --担保方式集合
    ,t2.grnt_mod_nm
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,t5.sgn_ctr_mod_nm
    ,t6.dbl_rcd_ind
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t
on t1.prd_no=t.prd_no
and t.dt=t1.dt
and t.PD_NM not regexp '信用卡'
left join SJXQ_SJ20250414131_CST_01         t2
on t1.ctr_serno=t2.ctr_serno
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  ctr_serno
	       ,sgn_ctr_mod     --签约方式
           ,decode(sgn_ctr_mod,'1','纸质合同（手写）','2','纸质合同（机打）','3','电子合同（自助）','4','电子合同（面签）','5','混搭') as sgn_ctr_mod_nm
	       ,ROW_NUMBER() OVER ( PARTITION BY ctr_serno ORDER BY  last_upd_tm DESC ) AS RN
	FROM edw.loan_ctr_sgn_tsk
	WHERE dt = '@@{yyyyMMdd}'
)t5 ON t1.ctr_serno = t5.ctr_serno AND t5.rn = 1
left join(
    select ctr_serno                                --合同流水号|c32
        ,sgn_ctr_obj_typ_cd                       --签约对象类型代码|c2
        ,decode(sgn_ctr_obj_typ_cd,'01','借款人','02','保证人','03','共同还款承诺人','04','共同借款人','05','押品所有权人') as sgn_ctr_obj_typ_nm
        ,dbl_rcd_ind                              --双录标志|c1
        ,sgn_ctr_psn_cst_id                       --签约人客户号|c200
        ,last_upd_tm                              --最后更新时间|c20
        ,row_number() over(partition by ctr_serno,sgn_ctr_psn_cst_id order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_ctr_dbl_rcd_inf_dd      --合同双录信息
    where dt='@@{yyyyMMdd}'
)t6 on t1.ctr_serno = t6.ctr_serno and t1.cst_id=t6.sgn_ctr_psn_cst_id
AND t6.rn = 1
LEFT JOIN edw.dwd_code_library_dd c1 --码值表
ON t1.ctr_sts_cd = c1.cd_val
AND c1.DT = t1.dt
where t1.dt='@@{yyyyMMdd}'
and t4.brc_org_nm='杭州分行'
and t1.ctr_bgn_dt between '20250101' and '20250413'
;
-- --信贷借据信息
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250414131_CST_03 PURGE;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250414131_CST_03 as
-- select t1.DBIL_ID                                  --借据编号|C64
-- 	,t1.CTR_SERNO                                --合同流水号|C32
-- 	,t1.AMT                                      --金额DECIMAL(21,2)
-- 	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
-- 	,t1.MTU_DT                                   --到期日期|C8
-- 	,t1.APNT_MTU_DT                              --约定到期日|C8
-- 	,t1.EXEC_MTU_DT                              --执行到期日|C8
-- from edw.dim_bus_loan_dbil_inf_dd       t1           --信贷借据信息
-- inner join SJXQ_SJ20250414131_CST_02    t2
-- on t1.CTR_SERNO=t2.CTR_SERNO
-- where t1.dt='@@{yyyyMMdd}'
-- and t1.LVE_ACT_BGN_DT between '20250101' and '20250413'
-- ;
--担保合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250414131_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250414131_CST_04 as
select t1.ctr_serno                                --合同流水号|c32
	,t1.grnt_ctr_no                              --担保合同编号|c32
	,t1.eff_sts_cd                               --生效状态代码|c1
    ,decode(t1.eff_sts_cd,'0','待生效','1','已生效','2','已失效') as eff_sts_nm
	,t3.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
	,t3.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
from edw.dwd_bus_loan_ctr_rel_grnt_dd  t1        --主合同、担保合同关系
inner join SJXQ_SJ20250414131_CST_02   t2
on t1.CTR_SERNO=t2.CTR_SERNO
left join edw.dim_bus_loan_ctr_grnt_inf_dd  t3   --担保合同信息
on t1.grnt_ctr_no=t3.grnt_ctr_no
and t3.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
;
--担保合同保证人信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250414131_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250414131_CST_05 as
select t1.grnt_ctr_no                            --担保合同编号|c32
	,t1.gtor_no                                  --保证人编号|c20
	,t1.gtor_nm                                  --保证人名称|c200
    ,t2.ctr_serno
    ,t6.dbl_rcd_ind
    ,row_number() over(partition by t2.ctr_serno,t1.grnt_ctr_no order by t1.gtor_no) rn
from edw.dim_bus_loan_grnt_ctr_gtor_inf_dd  t1   --担保合同保证人信息
inner join SJXQ_SJ20250414131_CST_04        t2
on t1.grnt_ctr_no=t2.grnt_ctr_no
left join(
    select ctr_serno                                --合同流水号|c32
        ,sgn_ctr_obj_typ_cd                       --签约对象类型代码|c2
        ,decode(sgn_ctr_obj_typ_cd,'01','借款人','02','保证人','03','共同还款承诺人','04','共同借款人','05','押品所有权人') as sgn_ctr_obj_typ_nm
        ,dbl_rcd_ind                              --双录标志|c1
        ,sgn_ctr_psn_cst_id                       --签约人客户号|c200
        ,last_upd_tm                              --最后更新时间|c20
        ,row_number() over(partition by ctr_serno,sgn_ctr_psn_cst_id order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_ctr_dbl_rcd_inf_dd      --合同双录信息
    where dt='@@{yyyyMMdd}'
)t6 on t2.ctr_serno = t6.ctr_serno and t1.gtor_no=t6.sgn_ctr_psn_cst_id
and t6.rn=1
where t1.dt='@@{yyyyMMdd}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250414131_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250414131_CST_06 as
SELECT  t1.ctr_serno       AS 合同流水号
       ,t1.cst_id          AS 客户号
       ,t1.cst_nm          AS 客户名称
       ,t1.ctr_amt         AS 合同金额
       ,t1.ctr_bal         AS 合同余额
       ,t1.ctr_bgn_dt      AS 合同起始日期
       ,t1.ctr_mtu_dt      AS 合同到期日期
       ,t1.ctr_sts_nm as 合同状态
       ,t1.sbr_org_nm      AS 管户支行
       ,t1.mgr_id          AS 管户人工号
       ,t1.mgr_nm          AS 管户人
       ,t1.是否纸质合同
       ,t1.sgn_ctr_mod_nm  AS 签约方式
       ,t1.dbl_rcd_ind     AS 是否双录
       ,t1.grnt_mod_nm     AS 担保方式集合
	   ,t3.grnt_ctr_no     as 担保合同编号
       ,t3.eff_sts_nm      AS 生效状态
       ,t3.grnt_ctr_bgn_dt AS 担保合同起始日期
       ,t3.grnt_ctr_mtu_dt AS 担保合同到期日期
       ,c1.gtor_no         AS 保证人1编号
       ,c1.gtor_nm         AS 保证人1名称
       ,c1.dbl_rcd_ind     AS 保证人1是否双录
       ,c2.gtor_no         AS 保证人2编号
       ,c2.gtor_nm         AS 保证人2名称
       ,c2.dbl_rcd_ind     AS 保证人2是否双录
       ,c3.gtor_no         AS 保证人3编号
       ,c3.gtor_nm         AS 保证人3名称
       ,c3.dbl_rcd_ind     AS 保证人3是否双录
       ,c4.gtor_no         AS 保证人4编号
       ,c4.gtor_nm         AS 保证人4名称
       ,c4.dbl_rcd_ind     AS 保证人4是否双录
       ,c5.gtor_no         AS 保证人5编号
       ,c5.gtor_nm         AS 保证人5名称
       ,c5.dbl_rcd_ind     AS 保证人5是否双录
from SJXQ_SJ20250414131_CST_02      t1
-- INNER JOIN SJXQ_SJ20250414131_CST_03 t2
-- on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20250414131_CST_04 t3
on t1.ctr_serno=t3.ctr_serno
left join SJXQ_SJ20250414131_CST_05 c1
on t1.ctr_serno=c1.ctr_serno
and t3.grnt_ctr_no=c1.grnt_ctr_no
and c1.rn=1
left join SJXQ_SJ20250414131_CST_05 c2
on t1.ctr_serno=c2.ctr_serno
and t3.grnt_ctr_no=c2.grnt_ctr_no
and c2.rn=2
left join SJXQ_SJ20250414131_CST_05 c3
on t1.ctr_serno=c3.ctr_serno
and t3.grnt_ctr_no=c3.grnt_ctr_no
and c3.rn=3
left join SJXQ_SJ20250414131_CST_05 c4
on t1.ctr_serno=c4.ctr_serno
and t3.grnt_ctr_no=c4.grnt_ctr_no
and c4.rn=4
left join SJXQ_SJ20250414131_CST_05 c5
on t1.ctr_serno=c5.ctr_serno
and t3.grnt_ctr_no=c5.grnt_ctr_no
and c5.rn=5
;
SElECT '06' seq,*
from SJXQ_SJ20250414131_CST_06
where 担保方式集合<>'信用'
and 担保合同编号 is null
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250414131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250414131_CST_02
-- union all
-- SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
-- from SJXQ_SJ20250414131_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ20250414131_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ20250414131_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号,担保合同编号) custs
from SJXQ_SJ20250414131_CST_06 where 担保合同编号 is not null
;
/*
01	7624208	7624208
02	15629	15629
04	15125	15125
05	25961	12973
06	17879	15125
非信用且无担保合同共459个合同，其中生效5个其余终止，生效均为客户 2600169350，担保方式 保证|抵押 ，查不到担保合同。
*/
***於挺_SJ2025021171_人行报送机构评估.sql
﻿-- lab_bigdata_dev.TMP_T47_PARTY_STS
-- 44.f.最近一次自查存量客户信息完整率（法定基本信息全部具备的客户/全部客户）的时间，法规规定的个人客户要素信息完整和对公客户要素信息完整的客户比例分别是？
-- （计算完整率时，名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、个人客户完整：客户名称、客户名称、证件类型、证件类型、证件号码、证件到期日、客户国籍、性别、客户职业均有值，且居住地址/户籍地址任已一项有值,手机号码/联系电话任已一项有值。
-- 名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 2、个人客户：截至2022年底，开立账户的自然人客户及办理过网贷的自然人客户，名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.fct_idv_dep_act_inf_dd  个人存量账户信息表
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
--odps.adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD  客户集市-客户基础-对私客户基础信息
--odps.adm_pub.adm_csm_cbas_org_bas_inf_dd  客户集市客户基础属性字段处理
-- 暂停非柜
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_00 AS
SELECT  distinct cst_act_id
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '20241231'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_01 AS
SELECT  t0.cst_id           --客户号
       ,t0.cst_chn_nm       --客户名称
       ,t00.doc_typ_cd      --证件类型
       ,t00.doc_nbr         --证件号
       ,t00.doc_mtu_dt      --证件到期日
       ,t0.ntn_cd           --客户国籍
       ,t0.gdr_cd           --性别
       ,t0.ocp_cd           --职业
	,case when length(t00.fml_adr)<length(t00.reg_adr) then t00.reg_adr else t00.fml_adr end AS adr --家庭地址_户籍地址
	,case when length(t00.mbl_nbr)<length(t00.fml_tel_nbr) then t00.fml_tel_nbr else t00.mbl_nbr end AS tel --手机_家庭电话
       ,t1.是否全部销户
       ,t2.网贷余额
       ,t3.不收不付标识
       ,t4.只收不付标志
       ,t5.暂停非柜面
FROM edw.dim_cst_idv_bas_inf_dd t0 -- 个人客户基本信息 gdr_cd性别ocp_cd职业ntn_cd国籍
INNER JOIN edw.dws_cst_bas_inf_dd t00 --客户基础信息汇总表 证件号及到期日
ON t0.cst_id = t00.cst_id AND t00.dt = '20241231'
LEFT JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM edw.dim_cst_idv_bas_inf_dd a
	-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息 账户状态不准 下同 2000005133
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	WHERE a.dt = '20241231'
	GROUP BY  a.cst_id
) t1 -- t1判断是否全部销户
ON t0.cst_id = t1.cst_id
LEFT JOIN
(
	SELECT  a.cst_id
	       ,SUM(b.ctr_bal) AS 网贷余额
	FROM edw.dim_cst_idv_bas_inf_dd a
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd b -- 信贷合同信息
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	LEFT JOIN edw.dim_bus_loan_pd_inf_dd c -- 信贷产品信息
	ON b.pd_cd = c.pd_cd AND c.dt = '20241231'
	WHERE c.pd_nm IN ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
	AND a.dt = '20241231'
	GROUP BY  a.cst_id
) t2 -- t2判断互联网贷款余额
ON t0.cst_id = t2.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM edw.dim_cst_idv_bas_inf_dd a
			-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
			WHERE a.dt = '20241231'
			UNION
			SELECT  a.cst_id
			       ,'1' AS act_cls_frz_ind -- 封闭冻结
			FROM edw.dim_cst_idv_bas_inf_dd a
			INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
            AND (b.card_sts_cd IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) or b.LATE_CARD_IND <> '1')
            AND b.dt = '20241231'
			WHERE a.dt = '20241231'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = '1'
	AND min_ = '1' -- 只保留所有账户都不收不付的客户
) t3
ON t0.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20241231'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t0.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join SJXQ_SJ2025021171_CST_00  t2  --暂停非柜
        on t1.cst_act_id=t2.cst_act_id
        where t1.dt='20241231'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INner join(
    SELECT DISTINCT cst_id
    -- from edw.dim_bus_dep_cst_act_inf_dd
	from edw.dws_bus_dep_act_inf_dd
    where dt='20241231' and act_sts_cd='A'
)t6 on t1.cst_id=t6.cst_id
WHERE t0.dt = '20241231'
;
--44-1
SELECT  '44-1 个人客户完整数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_01 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where nvl(cst_chn_nm,'')<>''
and   nvl(doc_typ_cd,'')<>''
and   nvl(doc_nbr   ,'')<>''
and   nvl(doc_mtu_dt,'')<>''
and   nvl(ntn_cd    ,'')<>''
and   nvl(gdr_cd    ,'')<>''
and   nvl(ocp_cd    ,'')<>''
and   nvl(adr       ,'')<>''
and   nvl(tel       ,'')<>''
and   是否全部销户 = '否'
and   (网贷余额 > 0 or 网贷余额 is null)
and   (不收不付标识 is null or 不收不付标识 = '')
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
;
--44-2
SELECT  '44-2 个人客户数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_01 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE 是否全部销户 = '否'
AND (网贷余额 > 0 or 网贷余额 is null) --5245667
AND (不收不付标识 is null or 不收不付标识 = '') --5189441
and (只收不付标志 is null or 只收不付标志 = '')
and (暂停非柜面 is null or 暂停非柜面 = '')
;
-- 3、对公客户：客户名称、证件类型、证件号码、证件到期日、客户国籍、经营范围、组织机构类型、注册地址、法定代表人、法定代表人证件类型、法定代表人证件号、
-- 法定代表人证件到期日、实际控制人名称、实际控制人证件类型、实际控制人证件号码、实际控制人证件到期日、受益所有人名称、受益所有人证件类型、
-- 受益所有人证件号码、受益所有人证件到期日、受益所有人地址。名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 4、截至2022年底，开立账户的对公客户，名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_02 AS
SELECT  t0.cst_id                              --客户号
       ,t0.cst_chn_nm                          --客户名称
       ,t0.doc_typ_cd                          --证件类型
       ,t0.doc_nbr                             --证件号
       ,t0.doc_mtu_dt                          --证件到期日
       ,t00.opr_scp_dscr                       --经营范围
       ,COALESCE(t000.reg_adr,t000.wrk_adr) AS adr --地址
       ,b1.cst_chn_nm     AS fr_cst_chn_nm 		--法定代表人
       ,b1.prm_doc_typ_cd AS fr_prm_doc_typ_cd  --法人证件类型
       ,b1.prm_doc_nbr    AS fr_prm_doc_nbr     --法人证件号
       ,b1.prm_doc_mtu_dt AS fr_prm_doc_mtu_dt  --法人证件到期日
       ,b2.cst_chn_nm     AS sk_cst_chn_nm      --实控人名称
       ,b2.prm_doc_typ_cd AS sk_prm_doc_typ_cd  --法人证件类型
       ,b2.prm_doc_nbr    AS sk_prm_doc_nbr     --实控人证件号码
       ,b2.prm_doc_mtu_dt AS sk_prm_doc_mtu_dt  --实控人证件到期日
       ,b3.cst_chn_nm     AS sy_cst_chn_nm      --受益人名称
       ,b3.prm_doc_typ_cd AS sy_prm_doc_typ_cd  --受益人证件类型
       ,b3.prm_doc_nbr    AS sy_prm_doc_nbr     --受益人证件号码
       ,b3.prm_doc_mtu_dt AS sy_prm_doc_mtu_dt  --受益人证件到期日
       ,t1.是否全部销户
       ,t2.网贷余额
       ,t3.不收不付标识
       ,t4.只收不付标志
       ,t5.暂停非柜面
FROM adm_pub.adm_csm_cbas_org_bas_inf_dd t0 -- 客户集市客户基础属性字段处理
LEFT JOIN edw.dim_cst_entp_bas_inf_dd t00 --企业客户表
ON t0.cst_id = t00.cst_id AND t00.dt = '20241231'
LEFT JOIN edw.dws_cst_bas_inf_dd t000
ON t0.cst_id = t000.cst_id AND t000.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a1 --客户关联关系信息
ON t0.cst_id = a1.cst_id AND a1.dt = '20241231' AND a1.rel_typ_cd = '0101' --法人
and LENGTH(a1.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b1 --客户基本信息
ON a1.rel_cst_id = b1.cst_id AND b1.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a2 --客户关联关系信息
ON t0.cst_id = a2.cst_id AND a2.dt = '20241231' AND a2.rel_typ_cd = '0109' --实控人
and LENGTH(a2.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b2 --客户基本信息
ON a2.rel_cst_id = b2.cst_id AND b2.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a3 --客户关联关系信息
ON t0.cst_id = a3.cst_id AND a3.dt = '20241231' AND a3.rel_typ_cd LIKE '09%' --受益人
and LENGTH(a3.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b3 --客户基本信息
ON a3.rel_cst_id = b3.cst_id AND b3.dt = '20241231'
LEFT JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	WHERE a.dt = '20241231'
	GROUP BY  a.cst_id
) t1 -- t1判断是否全部销户
ON t0.cst_id = t1.cst_id
LEFT JOIN
(
	SELECT  a.cst_id
	       ,SUM(b.ctr_bal) AS 网贷余额
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd b -- 信贷合同信息
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	LEFT JOIN edw.dim_bus_loan_pd_inf_dd c -- 信贷产品信息
	ON b.pd_cd = c.pd_cd AND c.dt = '20241231'
	WHERE c.pd_nm IN ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
	AND a.dt = '20241231'
	GROUP BY  a.cst_id
) t2 -- t2判断互联网贷款余额
ON t0.cst_id = t2.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
			-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
			WHERE a.dt = '20241231'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = 1
	AND min_ = 1 -- 只保留所有账户都不收不付的客户
) t3
ON t1.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		FROM  edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20241231'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t0.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join SJXQ_SJ2025021171_CST_00  t2  --暂停非柜
        on t1.cst_act_id=t2.cst_act_id
        where t1.dt='20241231'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INner join(
    SELECT DISTINCT cst_id
    -- from edw.dim_bus_dep_cst_act_inf_dd
	from edw.dws_bus_dep_act_inf_dd
    where dt='20241231' and act_sts_cd='A'
)t6 on t1.cst_id=t6.cst_id
WHERE t0.dt = '20241231'
;
--44-3
SELECT  '44-3 对公客户完整数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_02 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where nvl(cst_chn_nm       ,'')<>''
and   nvl(doc_typ_cd       ,'')<>''
and   nvl(doc_nbr          ,'')<>''
and   nvl(doc_mtu_dt       ,'')<>''
and   nvl(opr_scp_dscr     ,'')<>''
and   nvl(adr              ,'')<>''
and   nvl(fr_cst_chn_nm    ,'')<>''
and   nvl(fr_prm_doc_typ_cd,'')<>''
and   nvl(fr_prm_doc_nbr   ,'')<>''
and   nvl(fr_prm_doc_mtu_dt,'')<>''
and   nvl(sk_cst_chn_nm    ,'')<>''
and   nvl(sk_prm_doc_typ_cd,'')<>''
and   nvl(sk_prm_doc_nbr   ,'')<>''
and   nvl(sk_prm_doc_mtu_dt,'')<>''
and   nvl(sy_cst_chn_nm    ,'')<>''
and   nvl(sy_prm_doc_typ_cd,'')<>''
and   nvl(sy_prm_doc_nbr   ,'')<>''
and   nvl(sy_prm_doc_mtu_dt,'')<>''
and   是否全部销户 = '否'
and   (网贷余额 > 0 or 网贷余额 is null)
and   (不收不付标识 is null or 不收不付标识 = '') --36127  --36209 --280744
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
;
--44-4
SELECT  '44-4 对公客户数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_02 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE 是否全部销户 = '否'
AND (网贷余额 > 0 or 网贷余额 is null)
AND (不收不付标识 is null or 不收不付标识 = '') --384902
and (只收不付标志 is null or 只收不付标志 = '')
and (暂停非柜面 is null or 暂停非柜面 = '')
;
/*
-- 剔除 只收不付 暂停非柜面
-- 限制账户状态正常
-- 换表 edw.dws_bus_dep_act_inf_dd
44-1 个人客户完整数	3543016
44-2 个人客户数	3547881 完整率 99.9%
44-3 对公客户完整数	356144
44-4 对公客户数	358689-356144=2545 完整率 99.3%
*/
-- 45.h.客户洗钱风险分类划分的级别和各级别数量、占比
-- 1、在2024年12月31日时点，最终人工认定为高风险、较高风险、一般风险、较低风险、低风险的客户有多少
/*
levelkey _c1
1002 6920147
1004 23663
1005 2191
1001 92711 低风险
1003 745060
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_03 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','') AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T
) S
WHERE S.RN <= 2
;
SELECT  '45-h1 洗钱风险' id_nm
       ,S.LEVELKEY
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	       ,A.LEVELKEY
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND A.DT = '20241231'
	UNION
	SELECT  T.PARTY_ID
	       ,T.LEVELKEY
	FROM
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		AND NOT EXISTS (
		SELECT  1
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
		WHERE A.PARTY_ID = B.PARTY_ID
		AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND B.DT = '20241231')
	) T
	WHERE RN = 1
) S
GROUP BY  S.LEVELKEY
;
-- 2、在2024年12月31日时点，名下账户均已销户或互联网贷款客户借款余额已为0的客户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- 2190014
SELECT '45-h2 洗钱风险' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	       ,A.LEVELKEY
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A, lab_bigdata_dev.TMP_T47_PARTY_STS B
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	UNION
	SELECT  T.PARTY_ID
	       ,T.LEVELKEY
	FROM
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A, lab_bigdata_dev.TMP_T47_PARTY_STS B
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.PARTY_ID = B.PARTY_ID
		AND A.DT = '20241231'
		AND NOT EXISTS (
		SELECT  1
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
		WHERE A.PARTY_ID = B.PARTY_ID
		AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND B.DT = '20241231')
	) T
	WHERE RN = 1
) S
;
select STS,count(1) cnt
from lab_bigdata_dev.TMP_T47_PARTY_STS
group by STS
;
-- -- 46.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比
-- -- 1196867
-- select count(distinct aa.cst_id) num
-- from edw.dim_bus_dep_act_inf_dd aa -- 存款账户信息
--     inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
--     on aa.cst_id = bb.cst_id and bb.dt = '20241231'
--     inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
--     on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
-- where aa.dt = '20241231'
-- and aa.opn_dt >= '20240101'  --开户日期
-- and aa.opn_dt <= '20241231'  --开户日期
-- select S.LEVELKEY, COUNT(distinct s.cst_id)
-- from
--     (select aa.cst_id,dd.LEVELKEY
--     from edw.dim_bus_dep_act_inf_dd aa -- 存款账户信息
--     inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
--     on aa.cst_id = bb.cst_id and bb.dt = '20241231'
--     inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
--     on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
--     left join
--     (
--               SELECT A.PARTY_ID, A.LEVELKEY
--               FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
--             WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2024-12-31'
--               AND A.DT = '20241231'
--             UNION
--             SELECT T.PARTY_ID, T.LEVELKEY
--               FROM (SELECT A.PARTY_ID,
--                           A.LEVELKEY,
--                           RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY A.RCHECK_DT DESC) AS RN
--                       FROM adm_upss.AML_T37_PARTY_RESULT_UH A
--                     WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2024-12-31'
--                       AND A.DT = '20241231'
--                       AND NOT EXISTS
--                     (SELECT 1
--                               FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
--                             WHERE A.PARTY_ID = B.PARTY_ID
--                               AND SUBSTR(B.RCHECK_DT,1,10) <= '2024-12-31'
--                               AND B.DT = '20241231')) T
--             WHERE RN = 1 ) dd on aa.cst_id = substr(dd.party_id,3)
--     where aa.dt = '20241231'
--     and aa.opn_dt >= '20240101'  --开户日期
--     and aa.opn_dt <= '20241231'  --开户日期
-- ) s
-- group by s.LEVELKEY
-- 46.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比 (少了部分新开户客户没有评级)
--账户均已销户的客户
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2025021171_CST_16 PURGE;
create table IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025021171_CST_16  as
select  customer_id
       ,count(1)    AS  CLOSE_ACCT_SM
from adm_upss.aml_t47_agreement    -- 反洗钱账户表
group by customer_id
having  count(1)=sum( case when acct_status_cd='1' then 1 else 0 end )
;
SELECT  '46-i 近一年建立业务关系客户数' id_nm
       ,COUNT(distinct SUBSTR(aa.PARTY_ID,3)) num
FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
INNER JOIN edw.dws_cst_bas_inf_dd SS
ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
WHERE aa.dt = '20241231'
AND SS.file_dt >= '20240101' --开户日期
AND SS.file_dt <= '20241231' --开户日期
AND aa.CUST_KIND <> '3'
AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ2025021171_CST_16 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID
)
;
SELECT  '46-i 近一年建立业务关系客户数' id_nm
       ,S.LEVELKEY
       ,COUNT(SUBSTR(S.PARTY_ID,3))
FROM
(
	SELECT  aa.PARTY_ID
	       ,CASE WHEN DD.LEVELKEY IS NULL THEN '1001'  ELSE DD.LEVELKEY END AS LEVELKEY
	FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	INNER JOIN edw.dws_cst_bas_inf_dd SS
	ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
	LEFT JOIN
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
		AND A.DT = '20250115'
		UNION
		SELECT  T.PARTY_ID
		       ,T.LEVELKEY
		FROM
		(
			SELECT  A.PARTY_ID
			       ,A.LEVELKEY
			       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
			FROM adm_upss.AML_T37_PARTY_RESULT_UH A
			WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND A.DT = '20250115'
			AND NOT EXISTS (
			SELECT  1
			FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
			WHERE A.PARTY_ID = B.PARTY_ID
			AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND B.DT = '20250115')
		) T
		WHERE RN = 1
	) dd
	ON AA.PARTY_ID = dd.party_id
	WHERE aa.dt = '20241231'
	AND SS.file_dt >= '20240101' --开户日期
	AND SS.file_dt <= '20241231' --开户日期
	AND aa.CUST_KIND <> '3'
	AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ2025021171_CST_16 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID)
) s
GROUP BY  s.LEVELKEY
;
/*
levelkey	_c1
\N	6656
1003	56383
1004	3740
1002	1000253
1005	321
1001	4694
*/
-- 49.m.近一年内，因信息不完整而未予解付的跨境汇款笔数
-- (1)表名：Irmt_Master,日期：remit_Date 处理类型为退汇：deal_Type='RETURN'
-- 2851
SELECT  '49-h1 未解付跨境汇款笔数' id_nm
       ,COUNT(distinct ir_no)
FROM edw.niss_irmt_master a
INNER JOIN edw.dim_hr_org_mng_org_tree_dd b --机构树
ON a.trans_org_id = b.org_id AND b.dt = '20241231' AND b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE a.dt = '20241231'
AND SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20240101'
AND SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20241231'
AND deal_Type = 'RETURN' --处理类型为退汇
;
-- 50.d.近一年内发现个人身份证件过期的数量，因身份证件过期且无合理理由未更新而中止业务关系的客户数量
-- 121618
SELECT  '50-d1 近半年证件过期数' id_nm
       ,COUNT(distinct party_id) as 客户数
FROM
(
	SELECT  a.party_id
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240701'
	AND b.card_end_dt <= '20241231'
	--AND (a.party_status_cd = '0' or b.flag = '0')
) T
union all
SELECT  '50-d2 近半年证件过期中止业务数' id_nm
       ,COUNT(distinct party_id)
FROM
(
	SELECT  a.party_id
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	       ,SUBSTR(a.host_cust_id,3) AS cst_id
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240701'
	AND b.card_end_dt <= '20241231'
) T
inner JOIN
(
	SELECT  cst_id
	       ,MAX(zf) AS max_zf
	FROM
	(
		SELECT  cst_act_id
		       ,cst_id
		       ,CASE WHEN act_cls_frz_ind = '1' or act_rcv_oly_ind = '1' THEN 0  ELSE 1 END AS zf
		-- FROM edw.dim_bus_dep_cst_act_inf_dd --客户存款账户信息
		WHERE dt = '20241231'
	) AS a1
	GROUP BY  cst_id
	HAVING max_zf = 0
) AS t1
ON t.cst_id = t1.cst_id
;
/*
select count(t.cst_id) custs
from edw.dws_cst_bas_inf_dd	t --客户基础信息汇总表	14	doc_mtu_dt	string	证件到期日期|C8
inner JOIN
(
	SELECT  cst_id
	       ,MAX(zf) AS max_zf
	FROM
	(
		SELECT  cst_act_id
		       ,cst_id
		       ,CASE WHEN act_cls_frz_ind = '1' or act_rcv_oly_ind = '1' THEN 0  ELSE 1 END AS zf
		FROM edw.dim_bus_dep_cst_act_inf_dd --客户存款账户信息
		WHERE dt = '20241231'
	) AS a1
	GROUP BY  cst_id
	HAVING max_zf = 0
) AS t1
ON t.cst_id = t1.cst_id
where t.dt='20241231'
and t.doc_mtu_dt between '20240101' and '20241231'
*/
-- 51.f.近一年内发现客户身份注销的数量及终止业务关系的数量，从发现注销到完成终止业务关系流程的最长时间
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_04 AS
SELECT  dt             --查询日期
       ,geb_creditcode --统一信用代码
       ,geb_entname    --企业名称
       ,geb_entstatus  --经营状态 --工商状态
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
FROM
(
	SELECT  dt
	       ,geb_creditcode
	       ,geb_entname
	       ,geb_entstatus
	       ,geb_candate
	       ,geb_revdate
	       ,geb_orgcodes
	       ,geb_regno
	       ,ROW_NUMBER() OVER ( PARTITION BY geb_entname ORDER BY  dt DESC ) rnk
	FROM edw.outd_gs_entinfo_basic
	WHERE dt >= '20240101'
	AND dt <= '20241231'
) t
WHERE t.rnk = 1
;
-- 新口径
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_04_1 AS
SELECT *
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC) AS RN
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY is_abnormal desc,GEB_HOSTSENDTIME ASC) AS RN2
FROM    (
    SELECT  GEB_ENTNAME             --客户名称
        ,GEB_CREDITCODE             --统一社会信用代码
        ,GEB_ENTTYPE                --企业机构类型
        ,GEB_FRNAME                 --法定代表人负责人执行事务合伙人
        ,GEB_ENTSTATUS              --经营状态
        ,GEB_RECCAP                 --实收资本万元
        ,GEB_REGCAPCUR              --注册资本币种
        ,GEB_REGORGCITY             --所在城市
        ,GEB_REGORGDISTRICT         --所在区县
        ,GEB_ZSOPSCOPE              --经营业务范围
        ,GEB_DOM                    --住所
        ,GEB_INDUSTRYCONAME         --国民经济代码名称
        ,geb_esdate                 --成立日期
        ,geb_othertel               --其他电话
        ,GEB_HOSTSENDTIME           --geb_hostsendtime 交易发送主机时间
        ,geb_regorgprovince         --所在省份
        ,geb_regorgcode             --注册地址行政编号
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
	   ,dt
    FROM    edw.OUTD_GS_ENTINFO_BASIC   --工商企业-企业基本信息
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(GEB_CREDITCODE,'')<>''
    UNION ALL
    SELECT  dt_entname         AS GEB_ENTNAME
        ,dt_creditcode         AS GEB_CREDITCODE
        ,dt_enttype            AS GEB_ENTTYPE
        ,dt_frname             AS GEB_FRNAME
        ,dt_entstatus          AS GEB_ENTSTATUS
        ,dt_reccap             AS GEB_RECCAP
        ,dt_regcapcur          AS GEB_REGCAPCUR
        ,dt_regorgcity         AS GEB_REGORGCITY
        ,dt_regorgdistrict     AS GEB_REGORGDISTRICT
        ,dt_zsopscope          AS GEB_ZSOPSCOPE
        ,dt_dom                AS GEB_DOM
        ,dt_industryconame     AS GEB_INDUSTRYCONAME
        ,dt_esdate             AS geb_esdate
        ,dt_othertel           AS geb_othertel
        ,insert_time_chinadaas AS GEB_HOSTSENDTIME
        ,dt_regorgprovince     AS geb_regorgprovince
        ,dt_regorgcode         AS geb_regorgcode
       ,dt_candate    --注销日期
       ,dt_revdate    --吊销日期
       ,dt_orgcodes   --组织机构代码
       ,dt_regno      --注册号
	   ,dt
    FROM    edw.nout_zs_ent_basic
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(dt_creditcode,'')<>''
)a
;
--步骤二：对公账户工商注销后，其在我行开立的结算账户状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_05 AS
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep --存款账户信息
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.cst_chn_nm = B.geb_entname
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            AS 客户号
       ,A.cst_chn_nm        AS 客户名称
       ,A.prm_doc_typ_cd    AS 主证件类型代码
       ,A.prm_doc_nbr       AS 主证件号码
       ,dep.cst_act_id      AS 客户账号
       ,dep.dep_act_id      AS 负债账号
       ,dep.act_nm          AS 账户名称
       ,dep.act_sts_cd      AS 账户状态
       ,dep.act_dstr_act_dt AS 账户销户日期
       ,B.geb_entstatus     AS 工商状态
       ,B.geb_candate       AS 注销日期
       ,B.geb_revdate       AS 吊销日期
       ,B.DT                AS 查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.prm_doc_nbr = B.geb_creditcode
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            AS 客户号
       ,A.cst_chn_nm        AS 客户名称
       ,A.prm_doc_typ_cd    AS 主证件类型代码
       ,A.prm_doc_nbr       AS 主证件号码
       ,dep.cst_act_id      AS 客户账号
       ,dep.dep_act_id      AS 负债账号
       ,dep.act_nm          AS 账户名称
       ,dep.act_sts_cd      AS 账户状态
       ,dep.act_dstr_act_dt AS 账户销户日期
       ,B.geb_entstatus     AS 工商状态
       ,B.geb_candate       AS 注销日期
       ,B.geb_revdate       AS 吊销日期
       ,B.DT                AS 查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.prm_doc_nbr = B.geb_orgcodes
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            AS 客户号
       ,A.cst_chn_nm        AS 客户名称
       ,A.prm_doc_typ_cd    AS 主证件类型代码
       ,A.prm_doc_nbr       AS 主证件号码
       ,dep.cst_act_id      AS 客户账号
       ,dep.dep_act_id      AS 负债账号
       ,dep.act_nm          AS 账户名称
       ,dep.act_sts_cd      AS 账户状态
       ,dep.act_dstr_act_dt AS 账户销户日期
       ,B.geb_entstatus     AS 工商状态
       ,B.geb_candate       AS 注销日期
       ,B.geb_revdate       AS 吊销日期
       ,B.DT                AS 查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.prm_doc_nbr = B.geb_regno
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
;
-- 近一年内发现客户身份注销的数量 --99145
SELECT  '51-1 身份注销客户数' id_nm
       ,COUNT(distinct cst_id) num
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_05 t
union all
-- 近一年内发现客户身份注销的数量及终止业务关系的数量
-- 94572
SELECT  '51-2 身份注销终止业务客户数' id_nm
       ,COUNT(distinct cst_id) num
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_05
WHERE act_sts_cd <> 'A' --账户状态异常
;
-- 从发现注销到完成终止业务关系流程的最长时间
SELECT  '51-3 最长时间' id_nm
       ,MAX(tt.dateminus) max_days
FROM
(
	SELECT  cst_id
	       ,CASE WHEN act_dstr_act_dt >= dt THEN DATEDIFF(to_date(act_dstr_act_dt,'yyyymmdd'),to_date(dt,'yyyymmdd'),'dd')  ELSE 0 END AS dateminus
	FROM
	(
		SELECT  cst_id
		       ,act_dstr_act_dt
		       ,dt
		FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_05
		WHERE act_sts_cd <> 'A'
	) t
) tt
;
-- 52.g.近一年内，根据机构客户风险等级划分设定，应当及实际开展到期重评客户风险等级的客户数量
-- 2022年，存量客户月底到期重评的客户数量，2021年12月-2022年11月预警的客户。
-- 2374463
SELECT  '52' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
) T;
-- 53.h.近一年内，经持续尽调认为业务关系不符合客户身份，需开展强化尽职调查和重新评定客户风险等级的客户数量（不包含以上定期重评、因外部查冻扣开展强化尽调客户）及占全部客户数量比例（名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、2024年完成人工人工评定的客户，不含新开客户评级、PKG99、PKG51、CXD11两个公式。
SELECT  '53-1' id_nm
       ,count(DISTINCT A.PARTY_ID) as num
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_03 A
WHERE   ( ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
AND     A.STATISTIC_DT >= '20240101'
AND     A.STATISTIC_DT <= '20241231' )
    OR ( A.LEVELKEY IN ( '1004' , '1005' )
AND     A.RCHECK_DT >= '20240101'
AND     A.RCHECK_DT <= '20241231' ) )
AND     ORGANKEY IN (
                        SELECT  B.ORGANKEY
                        FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                        WHERE   B.report_organkey = 'C1092933000014'
                        AND     B.DT = '20241231'
                    )
AND A.TEMPCATEGORY = '2'
;
-- 945254
SELECT  '53-2' id_nm
       ,COUNT(1) AS num
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
) T;
-- 2、在2024年12月31日时点，名下账户均已销户或互联网贷款客户借款余额已为0的客户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- 180969
SELECT  '53-2' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A , lab_bigdata_dev.TMP_T47_PARTY_STS B
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A , lab_bigdata_dev.TMP_T47_PARTY_STS B
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
) T;
-- 54.i.近一年内，经尽职调查后，调升、调降客户风险等级的客户数量，调升至最高等级和由最高风险等级调降的客户数量（以上分别统计）
-- 1、调升：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次高，且系统初评等级不是低风险、较低风险、一般风险。
-- 2013
SELECT  '54-1' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY < A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 2、调降：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次低，且系统初评等级不是低风险、较低风险、一般风险。
-- 1360
SELECT  '54-2' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY > A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 3、调升至最高等级：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级是高风险，前一次风险等级不是高风险。
-- 216
SELECT  '54-3' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY = '1005'
	AND B.LEVELKEY != '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 4、由最高风险等级调降的客户：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次低，且前一次风险等级是高风险。
-- 534
SELECT  '54-4' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY != '1005'
	AND B.LEVELKEY = '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
--55 近一年内，经强化尽职调查后，采取业务与交易限制措施的客户数量
-- 1、2022年底，客户风险等级是较高风险、高风险客户数量
-- 2、2022年底，客户风险等级是较高风险、高风险，且在2022年被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付的客户。
-- 55	1004	22728
-- 55	1005	8610
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_06 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T
) S
WHERE S.RN <= 2
;
--迭代版代码
--2、取2022年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，关联2022年暂停非柜面、账户只收不付、不收不付的客户
--1、取2022年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，去重。
SELECT  '55-1'                     AS ind
       ,COUNT(DISTINCT A.PARTY_ID) AS val
FROM SJXQ_SJ2025021171_CST_06 A
WHERE (
    ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
        AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2024-01-01'
        AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-12-31'
    ) OR
    ( A.LEVELKEY IN ( '1004' , '1005' )
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
    )
)
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
)
UNION ALL
SELECT  '55-2'                     AS ind
       ,COUNT(DISTINCT S.party_id) AS val
FROM SJXQ_SJ2025021171_CST_06 S
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
    AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
--56 k.近一年内，经强化尽职调查后，终止业务关系的客户数量，以及占全部强化尽职调查客户的比例和占全部客户数量的比例
--2022年底，客户风险等级是较高风险、高风险，且在2022年账户不收不付、销户的客户。
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_15 AS
--账户全部销户
SELECT  A.PARTY_ID --客户号
       ,'1' AS STS --客户状态
FROM adm_upss.ADM_UPSS_AML_T47_PARTY A
WHERE NOT EXISTS (
SELECT  1
FROM adm_upss.ADM_UPSS_AML_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.ACCT_STATUS_CD = '0'
AND B.dt = '20241231') AND A.DT = '20241231'
UNION
--互联网贷款客户借款余额已为0
SELECT  A.PARTY_ID
       ,'2' AS STS
FROM adm_upss.adm_upss_aml_t47_loan_acct A
WHERE A.LTYPEKEY = '201050101040319'
AND AMT_VAL = '0'
AND NOT EXISTS (
SELECT  1
FROM adm_upss.adm_upss_aml_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.DT = '20241231') AND A.DT = '20241231'
UNION
--采取不收不付
SELECT  C.CST_ACT_ID
       ,'3'
FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
WHERE A.DT = '20241231'
AND A.FRZ_SCP_CD = '2'
AND A.NFRZ_IND = '0'
AND A.LMT_TYP IN ( '1' , '2' )
AND B.FRZ_ID IS NULL
AND LMT_TYP = '2'
AND C.CST_ACT_ID IS NOT NULL
;
--9380
SELECT  '56'              AS ind
       ,COUNT(A.PARTY_ID) AS val -- 客户数
FROM SJXQ_SJ2025021171_CST_06 A
WHERE A.LEVELKEY IN ( '1004' , '1005' )
AND A.PARTY_ID LIKE 'ZH%'
AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
AND EXISTS (
    SELECT  1
    FROM SJXQ_SJ2025021171_CST_15 B
    WHERE A.PARTY_ID = B.PARTY_ID
    AND B.STS IN ( '1' , '3' )
)
;
--57 反洗钱 1587
-- 1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
-- 2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且2022年第一次冻扣前已被划分为高风险、较高风险的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_07 AS
SELECT  aa.cst_id
       ,aa.qry_ctrl_dt
       ,aa.qry_ctrl_tm
       ,aa.frz_bgn_dt
       ,aa.frz_tmn_dt
       ,ROW_NUMBER() OVER ( PARTITION BY aa.cst_id ORDER BY  aa.qry_ctrl_dt ,aa.qry_ctrl_tm ) AS rn
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE aa.dt = '20241231'
AND qry_ctrl_dt >= '20240101'
AND qry_ctrl_dt <= '20241231'
AND qry_ctrl_typ_nm IN ( '冻结' , '划扣' )
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) );
--57关联高风险客群
-- 10692
-- 1587
SELECT  '57-1'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025021171_CST_07 t
UNION ALL
SELECT  '57-2' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ2025021171_CST_07 t
INNER JOIN SJXQ_SJ2025021171_CST_06 A
ON T.cst_id = substr(A.party_id, 3)
AND TO_CHAR(DATEADD(TO_DATE(t.qry_ctrl_dt, 'yyyyMMdd'), - 1, 'dd'), 'yyyyMMdd') = REPLACE(substr(A.STATISTIC_DT, 1, 10), '-', '')
WHERE A.LEVELKEY IN ( '1004' , '1005' )
AND A.party_id LIKE 'ZH%'
UNION ALL
SELECT  '57-2-self' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ2025021171_CST_07 t
INNER JOIN (
	SELECT party_id,min(STATISTIC_DT) as min_STATISTIC_DT
	from SJXQ_SJ2025021171_CST_06
	where LEVELKEY IN ( '1004' , '1005' )
	AND party_id LIKE 'ZH%'
	group by party_id
) A ON T.cst_id = substr(A.party_id, 3)
and t.qry_ctrl_dt>a.min_STATISTIC_DT
WHERE t.rn=1
;
--58、b.近一年内，机构上报大额交易报告笔数、份数
--20459858	12342
SELECT  '58' AS ind
       ,COUNT(B.TICD) --大额交易笔数
       ,COUNT(DISTINCT A.REPORTKEY) --份数
FROM adm_upss.AML_T07_MSG_UH A , adm_upss.aml_t3a_tsdt_n_hst B
WHERE A.REPORTORGANKEY = 'C1092933000014'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
AND A.REPORTKEY = B.RPT_ID
AND B.cust_id LIKE 'ZH%'
;
--59 c.近一年内，大额交易报告交易对手为空（包括填写替代符&ldquo;@N&rdquo;）、为内部过渡账户的比例（按笔计）分别是？（不包括机构自身与客户之间发生的交易，如贷款、付息等）
/*大额现转标志是转账，交易对手账号是空或者交易对手名称是空的；*/
--6373
--538218
SELECT  '59-1' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A , adm_upss.AML_T3A_TSDT_N_HST B
WHERE A.REPORTORGANKEY = 'C1092933000014'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND A.REPORT_TYPE_CD = 'BH'
AND A.REPORTKEY = B.RPT_ID
AND B.IS_CASH = '01'
AND (B.TCAC = '@N' OR B.TCNM = '@N')
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
;
/*大额现转标志是转账，交易对手账号是内部账户；*/
SELECT  '59-2' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A , adm_upss.AML_T3A_TSDT_N_HST B
WHERE A.REPORTORGANKEY = 'C1092933000014'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
AND A.REPORTKEY = B.RPT_ID
AND B.IS_CASH = '01'
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
AND EXISTS (
    SELECT  1
    FROM adm_upss.ADM_UPSS_AML_T47_AGREEMENT_ACCT C
    WHERE B.TCAC = C.ACCT_NUM
    AND C.TXN_DSC = 'NBZH'
    AND C.DT = '20250110'
);
--60 d.近一年内，大额交易报告报送超时的笔数及比例
--大额交易回执是警告回执，且回执内容含有逾期报送
--273402
SELECT  '60'                   AS ind
       ,COUNT(DISTINCT D.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B, adm_upss.AML_T3A_FDCF_FCER C , adm_upss.AML_T3A_TSDT_N_HST D
WHERE C.ERRS LIKE '%逾期%'
AND B.RCPT_ID = C.RCPT_ID
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = D.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND D.DT = '20250110'
AND A.REPORTORGANKEY = 'C1092933000014'
AND A.REPORT_TYPE_CD = 'BH'
;
--61 e.近一年内，反洗钱监测分析中心校验不合格、要求更正或补录的笔数及比例
--大额交易回执是错误回执、系统补正回执、通用错误回执
--367698
SELECT  '61'                   AS ind
       ,COUNT(DISTINCT C.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B , adm_upss.AML_T3A_TSDT_N_HST C
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = C.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND A.REPORTORGANKEY = 'C1092933000014'
AND A.REPORT_TYPE_CD = 'BH'
;
--62 f.近一年内，人工填报大额交易报告涉及的业务类型、笔数、比例（人工填报大额交易报告笔数/所有大额交易报告笔数）
--大额案例类型是人工新增
--2516
SELECT  '62'                   AS ind
       ,COUNT(DISTINCT B.TICD) AS val
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A, adm_upss.AML_T3A_TSDT_N_HST B
WHERE A.CAST_TYPE = '1'
AND A.DATE_STATUS_CD = '1'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20250110'
)
;
--65 f.可疑交易预警延后2年实现率：近2年内产生可疑交易预警的客户，在预警后受到司法机关查冻扣、人民银行反洗钱调查或税务机立案调查的客户数量和占比
-- 651	34881
-- 652	283
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_08 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2023-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
SELECT  '65-1'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM SJXQ_SJ2025021171_CST_08
UNION ALL
--65 2、2022年至2024年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '65-2'                    AS ind
       ,COUNT(DISTINCT p.PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST_08 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.cst_id
	       ,aa.qry_ctrl_dt
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON aa.cst_id = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	WHERE aa.dt = '20250101'
	AND qry_ctrl_dt >= '20230101'
	AND qry_ctrl_dt <= '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_09 AS
SELECT  DISTINCT PARTY_ID AS 客户号
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST_08 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.cst_id
	       ,aa.qry_ctrl_dt
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON aa.cst_id = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	WHERE aa.dt = '20250101'
	AND qry_ctrl_dt >= '20230101'
	AND qry_ctrl_dt <= '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
SELECT  '65-2-1' AS ind
       ,COUNT(1) AS N
FROM SJXQ_SJ2025021171_CST_09;
--66 g.查冻扣客户3年历史预警率：评估时点近三年内受到司法机关新增查冻扣（不含已有冻扣客户新增轮候冻扣）、人民银行反洗钱调查或税务机立案调查的客户中
-- 在接受调查或冻扣前已产生可疑交易预警的客户数量和占比
--49940
--277
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_10 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2' 	--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_11 AS
SELECT  DISTINCT aa.cst_id
       ,aa.qry_ctrl_dt
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE aa.dt = '20250101'
AND qry_ctrl_dt >= '20220101'
AND qry_ctrl_dt <= '20241231'
;
SELECT  '66-1'                  AS ind
       ,COUNT(DISTINCT cst_id) AS val
FROM SJXQ_SJ2025021171_CST_11
UNION ALL
--66 2、2020年至2022年被可疑预警的主客户，且在2022年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '66-2'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST_10 t
	WHERE t.rn = 1
) p
INNER JOIN SJXQ_SJ2025021171_CST_11 s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--67 f.近一年内，向反洗钱中心报送可疑交易报告数量，向人民银行分支机构直接报送重点可疑交易报告数量，向侦查、监察机关和税务部门报案数量
--2022年，上报可疑案例的报告数量
--2047
SELECT  '67'     AS ind
       ,COUNT(*) AS val
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
)
;
--68 g.近一年内，可疑交易报告涉及客户数量，以及因上报可疑交易而对客户采取强化尽职调查、调整风险等级、采取管控措施、中止业务关系的客户数量（以上分别统计）
--1、2022年上报可疑案例的主客户数量
--1769
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_12 AS
SELECT  DISTINCT A.PARTY_ID
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
SELECT  '68-1' AS ind
       ,COUNT(DISTINCT PARTY_ID)
FROM SJXQ_SJ2025021171_CST_12
--2、被上报可疑案例后，风险等级是高风险、较高风险、被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付、不收不付、销户的客户
--786
UNION ALL
SELECT  '68-2' AS ind
       ,COUNT(DISTINCT aaa.party_id)
FROM SJXQ_SJ2025021171_CST_12 aaa
INNER JOIN SJXQ_SJ2025021171_CST_06 S
ON aaa.PARTY_ID = S.PARTY_ID
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
	AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
--69 i.近一年内司法机关新增冻扣客户（不含已有冻扣客户新增轮候冻扣）中，已在近年内（不超过5年）被提交可疑交易报告的客户数量与占比
--1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
--2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且在2020-2024年被上报可疑案例的主客户
-- 10692
-- 413
SELECT  '69-1'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025021171_CST_07 t
UNION ALL
SELECT  '69-2' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025021171_CST_07 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2020-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2' 		--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
--70 j.近一年内被提交可疑交易报告的客户中，已被司法机关查冻扣、人民银行反洗钱调查、涉诈通报客户数量与占比
--2022年上报可疑案例的主客户，且在上报前，已被司法查冻扣、预警人行黑名单的客户
--200
SELECT  '70' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025021171_CST_07 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01' --近1年
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND REPLACE(substr(A.APP_DT, 1, 10), '-', '') > s.frz_bgn_dt --查扣时间小于预警时间
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
-- 71
-- d.（银行）交易对手方通过其他机构（如第三方支付机构）间接与本机构客户发生交易的，是否能够获取到对手方实际名称（包括以支付机构名称添加后缀方式获取）？
-- （非银行）通过代销渠道销售产品的，是否能够获取客户核心身份信息（客户名称、证件类型、证件号码）
-- 请列举与本机构交易笔数最多的5家机构的客户名称获取率及名称，以及获取率最低的5家机构的比率及名称。
-- 1.用反洗钱交易流水表，筛选非信用卡的交易里 bank_pay_cd 不为空且不为@的交易，取交易笔数。
-- 2.将第一点筛选出的交易流水的 opp_organname 去重统计交易笔数，取明细。
-- 3.用反洗钱交易流水表，筛选信用卡的交易里交易对手是 999999915613007000400002 和 473331083984444 的交易，取交易笔数。
-- 4.将第一点筛选出的交易流水的opp_name，取出来，将-前面的文字取出来去重统计交易，取出明细。
--总行交易
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_13 AS
SELECT  '泰隆银行'   AS zh
       ,COUNT(*) AS 总笔数
       ,SUM(t.cny_amt) 总金额
FROM adm_upss.aml_t47_transaction t
AND t.dt <= '20241231'
AND t.dt >= '20240101'
;
select * from SJXQ_SJ2025021171_CST_13;
-- zh	总笔数	总金额
-- 泰隆银行	236639274	566803181093.82
--交易对手排名
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_14 AS
SELECT  s . *
       ,CASE WHEN R.交易银行 IS NOT NULL THEN r.笔数  ELSE 0 END 总笔数交易对手
       ,CASE WHEN R.交易银行 IS NOT NULL THEN r.总金额  ELSE 0 END 总金额交易对手
FROM
(
	SELECT  t.opp_organname 交易银行 	--财付通
	       ,COUNT(*) 笔数
	       ,SUM(t.cny_amt) 总金额
	FROM adm_upss.aml_t47_transaction t
	WHERE t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
	AND t.opp_organname is not null
	AND t.dt <= '20241231'
	AND t.dt >= '20240101'
	GROUP BY  t.opp_organname
) s
LEFT JOIN
(
	SELECT  t.opp_organname 交易银行
	       ,COUNT(*) 笔数
	       ,SUM(t.cny_amt) 总金额
	FROM adm_upss.aml_t47_transaction t
	WHERE t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
	AND t.dt <= '20241231'
	AND t.dt >= '20240101'
	AND t.opp_organname is not null
	AND t.opp_name = t.opp_organname
	GROUP BY  t.opp_organname
) r
ON s.交易银行 = r.交易银行;
SELECT  *
FROM SJXQ_SJ2025021171_CST_14;
-- 扫二维码付款	36745822	10663138226.65
-- 微信转账	28309319	68627357629.88
-- 财付通支付科技有限公司	8089180	42527808619.52
SELECT  T.opp_name
       ,COUNT(*)     AS 笔数
       ,SUM(cny_amt) AS 金额
FROM adm_upss.aml_t47_transaction t
WHERE t.dt >= '20240101'
AND t.dt <= '20241231'
AND t.opp_organname LIKE '%财付通%'
AND t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
GROUP BY  T.opp_name
ORDER BY  COUNT(*) desc;
--支付宝（中国）网络技术有限公司	7900205	55092851722.11
--还款	2293251	5850925074.57
SELECT  T.opp_name
       ,COUNT(*)     AS 笔数
       ,SUM(cny_amt) AS 金额
FROM adm_upss.aml_t47_transaction t
WHERE t.dt >= '20240101'
AND t.dt <= '20241231'
AND t.opp_organname LIKE '%支付宝%'
AND t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
GROUP BY  T.opp_name
ORDER BY  COUNT(*) desc;
-- 1、2024年全部第三方支付机构收付金额：网联 epcc_paysrl 表+ wk_jrnl 表 限制trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')，2024年收付金额。
-- 197427.396284000000140099
SELECT  SUM(trans_at)/10000 AS val
FROM edw.frhd_wk_jrnl --无卡交易流水
WHERE dt >= '20240101'
AND dt <= '20241231'
--  and trans_st = '0'
;
-- 50508156.85435102
SELECT  SUM(trxamt)/10000 AS val
FROM edw.epcc_epcc_paysrl --支付流水表
WHERE dt >= '20240101'
AND dt <= '20241231'
AND epccstatus = '00'
;
-- 2、2024年各第三方支付机构交易笔数：网联 epcc_paysrl_attachl 表按 instgid 支付机构编码统计交易笔数
-- + wk_jrnl 表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')按 snd_ins_id_cd 统计交易笔数。
-- 取支付机构编码、名称、笔数。
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_17 AS
SELECT  t1.instgid AS 支付机构编码
       ,t2.instgnm AS 名称
       ,COUNT(1)   AS 笔数
FROM edw.epcc_epcc_paysrl AS t1 --支付流水表
LEFT JOIN edw.epcc_epcc_instgidinf AS t2 --网联支付机构信息
ON t1.instgid = t2.instgid AND t2.dt = '20241231'
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
AND t1.epccstatus = '00'
GROUP BY  t1.instgid
         ,t2.instgnm
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_18 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_18 AS
SELECT  t1.snd_ins_id_cd AS 支付机构编码
       ,COUNT(1)                                            AS 笔数
FROM edw.frhd_wk_jrnl AS t1 --无卡交易流水
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
GROUP BY  t1.snd_ins_id_cd
;
-- 3、2024年各第三方支付机构商户实际名称获取率： 网联 epcc_paysrl_attach 按instgid统计mkinfo6 不为空的笔数/对应支付机构笔数，
-- 银联 wk_jrnl 表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101') 按 snd_ins_id_cd 统计 snd_ins_id_cd 不为空的笔数/对应支付机构限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')的笔数。
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_19 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_19 AS
SELECT  t1.instgid AS 支付机构编码
       ,t2.instgnm AS 名称
       ,SUM(case WHEN nvl(t3.mkinfo6,'') <> '' AND t3.mkinfo6 NOT IN ( '上海寻梦信息技术有限公司' ,'微信红包' ,'扫二维码付款'
            ,'信用卡还款' ,'北京三快在线科技有限公司' ,'中移动金融科技有限公司' ,'成都所见所得科技有限公司' ,'微信转账'
             ,'高德信息技术有限公司' ,'上海格物致品网络科技有限公司' ,'上海拉扎斯信息科技有限公司' ,'特约商户' ) THEN 1
             else 0 end) /COUNT(1) AS 获取率
FROM edw.epcc_epcc_paysrl AS t1 --支付流水表
LEFT JOIN edw.epcc_epcc_instgidinf AS t2 --网联支付机构信息
ON t1.instgid = t2.instgid AND t2.dt = '20241231'
LEFT JOIN edw.epcc_epcc_paysrl_attach AS t3 --支付流水表附表
ON t1.trxid = t3.trxid AND t1.instgid = t3.instgid
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
AND t3.dt >= '20240101'
AND t3.dt <= '20241231'
AND t1.epccstatus = '00'
GROUP BY  t1.instgid
         ,t2.instgnm
;
-- 46个机构均为1
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_20 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_20 AS
SELECT  t1.snd_ins_id_cd                                                     AS 支付机构编码
       ,SUM(case WHEN nvl(t1.mchnt_nm,'') <> '' THEN 1 else 0 end) /COUNT(1) AS 获取率
FROM edw.frhd_wk_jrnl AS t1 --无卡交易流水
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
GROUP BY  t1.snd_ins_id_cd
;
Select '71-网联-交易笔数前5' AS ind
    ,t1.支付机构编码
    ,t1.名称
    ,t2.获取率
from(
    select 支付机构编码,名称,笔数
    from SJXQ_SJ2025021171_CST_17 	--网联
    order by 笔数 desc limit 5
)t1 left join SJXQ_SJ2025021171_CST_19  t2
on t1.支付机构编码=t2.支付机构编码
union all
Select '71-网联-获取率后5' AS ind
    ,支付机构编码
    ,名称
    ,获取率
from SJXQ_SJ2025021171_CST_19
order by 获取率 limit 5
;
Select '71-银联-交易笔数前5' AS ind
    ,t1.支付机构编码
    ,t2.获取率
from(
    select 支付机构编码,笔数
    from SJXQ_SJ2025021171_CST_18 	--网联
    order by 笔数 desc limit 5
)t1 left join SJXQ_SJ2025021171_CST_20  t2
on t1.支付机构编码=t2.支付机构编码
union all
Select '71-银联-获取率后5' AS ind
    ,支付机构编码
    ,获取率
from SJXQ_SJ2025021171_CST_20
order by 获取率 limit 5
;-- lab_bigdata_dev.TMP_T47_PARTY_STS
-- 44.f.最近一次自查存量客户信息完整率（法定基本信息全部具备的客户/全部客户）的时间，法规规定的个人客户要素信息完整和对公客户要素信息完整的客户比例分别是？
-- （计算完整率时，名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、个人客户完整：客户名称、客户名称、证件类型、证件类型、证件号码、证件到期日、客户国籍、性别、客户职业均有值，且居住地址/户籍地址任已一项有值,手机号码/联系电话任已一项有值。
-- 名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 2、个人客户：截至2022年底，开立账户的自然人客户及办理过网贷的自然人客户，名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.fct_idv_dep_act_inf_dd  个人存量账户信息表
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
--odps.adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD  客户集市-客户基础-对私客户基础信息
--odps.adm_pub.adm_csm_cbas_org_bas_inf_dd  客户集市客户基础属性字段处理
-- 暂停非柜
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_00 AS
SELECT  distinct cst_act_id
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '20241231'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_01 AS
SELECT  t0.cst_id           --客户号
       ,t0.cst_chn_nm       --客户名称
       ,t00.doc_typ_cd      --证件类型
       ,t00.doc_nbr         --证件号
       ,t00.doc_mtu_dt      --证件到期日
       ,t0.ntn_cd           --客户国籍
       ,t0.gdr_cd           --性别
       ,t0.ocp_cd           --职业
	,case when length(t00.fml_adr)<length(t00.reg_adr) then t00.reg_adr else t00.fml_adr end AS adr --家庭地址_户籍地址
	,case when length(t00.mbl_nbr)<length(t00.fml_tel_nbr) then t00.fml_tel_nbr else t00.mbl_nbr end AS tel --手机_家庭电话
       ,t1.是否全部销户
       ,t2.网贷余额
       ,t3.不收不付标识
       ,t4.只收不付标志
       ,t5.暂停非柜面
FROM edw.dim_cst_idv_bas_inf_dd t0 -- 个人客户基本信息 gdr_cd性别ocp_cd职业ntn_cd国籍
INNER JOIN edw.dws_cst_bas_inf_dd t00 --客户基础信息汇总表 证件号及到期日
ON t0.cst_id = t00.cst_id AND t00.dt = '20241231'
LEFT JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM edw.dim_cst_idv_bas_inf_dd a
	-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息 账户状态不准 下同 2000005133
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	WHERE a.dt = '20241231'
	GROUP BY  a.cst_id
) t1 -- t1判断是否全部销户
ON t0.cst_id = t1.cst_id
LEFT JOIN
(
	SELECT  a.cst_id
	       ,SUM(b.ctr_bal) AS 网贷余额
	FROM edw.dim_cst_idv_bas_inf_dd a
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd b -- 信贷合同信息
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	LEFT JOIN edw.dim_bus_loan_pd_inf_dd c -- 信贷产品信息
	ON b.pd_cd = c.pd_cd AND c.dt = '20241231'
	WHERE c.pd_nm IN ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
	AND a.dt = '20241231'
	GROUP BY  a.cst_id
) t2 -- t2判断互联网贷款余额
ON t0.cst_id = t2.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM edw.dim_cst_idv_bas_inf_dd a
			-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
			WHERE a.dt = '20241231'
			UNION
			SELECT  a.cst_id
			       ,'1' AS act_cls_frz_ind -- 封闭冻结
			FROM edw.dim_cst_idv_bas_inf_dd a
			INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
            AND (b.card_sts_cd IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) or b.LATE_CARD_IND <> '1')
            AND b.dt = '20241231'
			WHERE a.dt = '20241231'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = '1'
	AND min_ = '1' -- 只保留所有账户都不收不付的客户
) t3
ON t0.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20241231'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t0.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join SJXQ_SJ2025021171_CST_00  t2  --暂停非柜
        on t1.cst_act_id=t2.cst_act_id
        where t1.dt='20241231'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INner join(
    SELECT DISTINCT cst_id
    -- from edw.dim_bus_dep_cst_act_inf_dd
	from edw.dws_bus_dep_act_inf_dd
    where dt='20241231' and act_sts_cd='A'
)t6 on t1.cst_id=t6.cst_id
WHERE t0.dt = '20241231'
;
--44-1
SELECT  '44-1 个人客户完整数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_01 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where nvl(cst_chn_nm,'')<>''
and   nvl(doc_typ_cd,'')<>''
and   nvl(doc_nbr   ,'')<>''
and   nvl(doc_mtu_dt,'')<>''
and   nvl(ntn_cd    ,'')<>''
and   nvl(gdr_cd    ,'')<>''
and   nvl(ocp_cd    ,'')<>''
and   nvl(adr       ,'')<>''
and   nvl(tel       ,'')<>''
and   是否全部销户 = '否'
and   (网贷余额 > 0 or 网贷余额 is null)
and   (不收不付标识 is null or 不收不付标识 = '')
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
;
--44-2
SELECT  '44-2 个人客户数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_01 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE 是否全部销户 = '否'
AND (网贷余额 > 0 or 网贷余额 is null) --5245667
AND (不收不付标识 is null or 不收不付标识 = '') --5189441
and (只收不付标志 is null or 只收不付标志 = '')
and (暂停非柜面 is null or 暂停非柜面 = '')
;
-- 3、对公客户：客户名称、证件类型、证件号码、证件到期日、客户国籍、经营范围、组织机构类型、注册地址、法定代表人、法定代表人证件类型、法定代表人证件号、
-- 法定代表人证件到期日、实际控制人名称、实际控制人证件类型、实际控制人证件号码、实际控制人证件到期日、受益所有人名称、受益所有人证件类型、
-- 受益所有人证件号码、受益所有人证件到期日、受益所有人地址。名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 4、截至2022年底，开立账户的对公客户，名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_02 AS
SELECT  t0.cst_id                              --客户号
       ,t0.cst_chn_nm                          --客户名称
       ,t0.doc_typ_cd                          --证件类型
       ,t0.doc_nbr                             --证件号
       ,t0.doc_mtu_dt                          --证件到期日
       ,t00.opr_scp_dscr                       --经营范围
       ,COALESCE(t000.reg_adr,t000.wrk_adr) AS adr --地址
       ,b1.cst_chn_nm     AS fr_cst_chn_nm 		--法定代表人
       ,b1.prm_doc_typ_cd AS fr_prm_doc_typ_cd  --法人证件类型
       ,b1.prm_doc_nbr    AS fr_prm_doc_nbr     --法人证件号
       ,b1.prm_doc_mtu_dt AS fr_prm_doc_mtu_dt  --法人证件到期日
       ,b2.cst_chn_nm     AS sk_cst_chn_nm      --实控人名称
       ,b2.prm_doc_typ_cd AS sk_prm_doc_typ_cd  --法人证件类型
       ,b2.prm_doc_nbr    AS sk_prm_doc_nbr     --实控人证件号码
       ,b2.prm_doc_mtu_dt AS sk_prm_doc_mtu_dt  --实控人证件到期日
       ,b3.cst_chn_nm     AS sy_cst_chn_nm      --受益人名称
       ,b3.prm_doc_typ_cd AS sy_prm_doc_typ_cd  --受益人证件类型
       ,b3.prm_doc_nbr    AS sy_prm_doc_nbr     --受益人证件号码
       ,b3.prm_doc_mtu_dt AS sy_prm_doc_mtu_dt  --受益人证件到期日
       ,t1.是否全部销户
       ,t2.网贷余额
       ,t3.不收不付标识
       ,t4.只收不付标志
       ,t5.暂停非柜面
FROM adm_pub.adm_csm_cbas_org_bas_inf_dd t0 -- 客户集市客户基础属性字段处理
LEFT JOIN edw.dim_cst_entp_bas_inf_dd t00 --企业客户表
ON t0.cst_id = t00.cst_id AND t00.dt = '20241231'
LEFT JOIN edw.dws_cst_bas_inf_dd t000
ON t0.cst_id = t000.cst_id AND t000.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a1 --客户关联关系信息
ON t0.cst_id = a1.cst_id AND a1.dt = '20241231' AND a1.rel_typ_cd = '0101' --法人
and LENGTH(a1.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b1 --客户基本信息
ON a1.rel_cst_id = b1.cst_id AND b1.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a2 --客户关联关系信息
ON t0.cst_id = a2.cst_id AND a2.dt = '20241231' AND a2.rel_typ_cd = '0109' --实控人
and LENGTH(a2.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b2 --客户基本信息
ON a2.rel_cst_id = b2.cst_id AND b2.dt = '20241231'
LEFT JOIN edw.dim_cst_rel_inf_dd a3 --客户关联关系信息
ON t0.cst_id = a3.cst_id AND a3.dt = '20241231' AND a3.rel_typ_cd LIKE '09%' --受益人
and LENGTH(a3.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b3 --客户基本信息
ON a3.rel_cst_id = b3.cst_id AND b3.dt = '20241231'
LEFT JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	WHERE a.dt = '20241231'
	GROUP BY  a.cst_id
) t1 -- t1判断是否全部销户
ON t0.cst_id = t1.cst_id
LEFT JOIN
(
	SELECT  a.cst_id
	       ,SUM(b.ctr_bal) AS 网贷余额
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd b -- 信贷合同信息
	ON a.cst_id = b.cst_id AND b.dt = '20241231'
	LEFT JOIN edw.dim_bus_loan_pd_inf_dd c -- 信贷产品信息
	ON b.pd_cd = c.pd_cd AND c.dt = '20241231'
	WHERE c.pd_nm IN ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
	AND a.dt = '20241231'
	GROUP BY  a.cst_id
) t2 -- t2判断互联网贷款余额
ON t0.cst_id = t2.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
			-- LEFT JOIN edw.DIM_BUS_DEP_CST_ACT_INF_DD b -- 客户存款账户信息
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20241231'
			WHERE a.dt = '20241231'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = 1
	AND min_ = 1 -- 只保留所有账户都不收不付的客户
) t3
ON t1.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		FROM  edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20241231'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t0.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
        -- from edw.dim_bus_dep_cst_act_inf_dd t1
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join SJXQ_SJ2025021171_CST_00  t2  --暂停非柜
        on t1.cst_act_id=t2.cst_act_id
        where t1.dt='20241231'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INner join(
    SELECT DISTINCT cst_id
    -- from edw.dim_bus_dep_cst_act_inf_dd
	from edw.dws_bus_dep_act_inf_dd
    where dt='20241231' and act_sts_cd='A'
)t6 on t1.cst_id=t6.cst_id
WHERE t0.dt = '20241231'
;
--44-3
SELECT  '44-3 对公客户完整数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_02 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where nvl(cst_chn_nm       ,'')<>''
and   nvl(doc_typ_cd       ,'')<>''
and   nvl(doc_nbr          ,'')<>''
and   nvl(doc_mtu_dt       ,'')<>''
and   nvl(opr_scp_dscr     ,'')<>''
and   nvl(adr              ,'')<>''
and   nvl(fr_cst_chn_nm    ,'')<>''
and   nvl(fr_prm_doc_typ_cd,'')<>''
and   nvl(fr_prm_doc_nbr   ,'')<>''
and   nvl(fr_prm_doc_mtu_dt,'')<>''
and   nvl(sk_cst_chn_nm    ,'')<>''
and   nvl(sk_prm_doc_typ_cd,'')<>''
and   nvl(sk_prm_doc_nbr   ,'')<>''
and   nvl(sk_prm_doc_mtu_dt,'')<>''
and   nvl(sy_cst_chn_nm    ,'')<>''
and   nvl(sy_prm_doc_typ_cd,'')<>''
and   nvl(sy_prm_doc_nbr   ,'')<>''
and   nvl(sy_prm_doc_mtu_dt,'')<>''
and   是否全部销户 = '否'
and   (网贷余额 > 0 or 网贷余额 is null)
and   (不收不付标识 is null or 不收不付标识 = '') --36127  --36209 --280744
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
;
--44-4
SELECT  '44-4 对公客户数' id_nm
       ,COUNT(distinct aa.cst_id)
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_02 aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
ON aa.cst_id = bb.cst_id AND bb.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON bb.prm_org_id = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE 是否全部销户 = '否'
AND (网贷余额 > 0 or 网贷余额 is null)
AND (不收不付标识 is null or 不收不付标识 = '') --384902
and (只收不付标志 is null or 只收不付标志 = '')
and (暂停非柜面 is null or 暂停非柜面 = '')
;
/*
-- 剔除 只收不付 暂停非柜面
-- 限制账户状态正常
-- 换表 edw.dws_bus_dep_act_inf_dd
44-1 个人客户完整数	3543016
44-2 个人客户数	3547881 完整率 99.9%
44-3 对公客户完整数	356144
44-4 对公客户数	358689-356144=2545 完整率 99.3%
*/
-- 45.h.客户洗钱风险分类划分的级别和各级别数量、占比
-- 1、在2024年12月31日时点，最终人工认定为高风险、较高风险、一般风险、较低风险、低风险的客户有多少
/*
levelkey _c1
1002 6920147
1004 23663
1005 2191
1001 92711 低风险
1003 745060
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_03 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','') AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T
) S
WHERE S.RN <= 2
;
SELECT  '45-h1 洗钱风险' id_nm
       ,S.LEVELKEY
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	       ,A.LEVELKEY
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND A.DT = '20241231'
	UNION
	SELECT  T.PARTY_ID
	       ,T.LEVELKEY
	FROM
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		AND NOT EXISTS (
		SELECT  1
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
		WHERE A.PARTY_ID = B.PARTY_ID
		AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND B.DT = '20241231')
	) T
	WHERE RN = 1
) S
GROUP BY  S.LEVELKEY
;
-- 2、在2024年12月31日时点，名下账户均已销户或互联网贷款客户借款余额已为0的客户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- 2190014
SELECT '45-h2 洗钱风险' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	       ,A.LEVELKEY
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A, lab_bigdata_dev.TMP_T47_PARTY_STS B
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	UNION
	SELECT  T.PARTY_ID
	       ,T.LEVELKEY
	FROM
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A, lab_bigdata_dev.TMP_T47_PARTY_STS B
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.PARTY_ID = B.PARTY_ID
		AND A.DT = '20241231'
		AND NOT EXISTS (
		SELECT  1
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
		WHERE A.PARTY_ID = B.PARTY_ID
		AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND B.DT = '20241231')
	) T
	WHERE RN = 1
) S
;
select STS,count(1) cnt
from lab_bigdata_dev.TMP_T47_PARTY_STS
group by STS
;
-- -- 46.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比
-- -- 1196867
-- select count(distinct aa.cst_id) num
-- from edw.dim_bus_dep_act_inf_dd aa -- 存款账户信息
--     inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
--     on aa.cst_id = bb.cst_id and bb.dt = '20241231'
--     inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
--     on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
-- where aa.dt = '20241231'
-- and aa.opn_dt >= '20240101'  --开户日期
-- and aa.opn_dt <= '20241231'  --开户日期
-- select S.LEVELKEY, COUNT(distinct s.cst_id)
-- from
--     (select aa.cst_id,dd.LEVELKEY
--     from edw.dim_bus_dep_act_inf_dd aa -- 存款账户信息
--     inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
--     on aa.cst_id = bb.cst_id and bb.dt = '20241231'
--     inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
--     on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
--     left join
--     (
--               SELECT A.PARTY_ID, A.LEVELKEY
--               FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
--             WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2024-12-31'
--               AND A.DT = '20241231'
--             UNION
--             SELECT T.PARTY_ID, T.LEVELKEY
--               FROM (SELECT A.PARTY_ID,
--                           A.LEVELKEY,
--                           RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY A.RCHECK_DT DESC) AS RN
--                       FROM adm_upss.AML_T37_PARTY_RESULT_UH A
--                     WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2024-12-31'
--                       AND A.DT = '20241231'
--                       AND NOT EXISTS
--                     (SELECT 1
--                               FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
--                             WHERE A.PARTY_ID = B.PARTY_ID
--                               AND SUBSTR(B.RCHECK_DT,1,10) <= '2024-12-31'
--                               AND B.DT = '20241231')) T
--             WHERE RN = 1 ) dd on aa.cst_id = substr(dd.party_id,3)
--     where aa.dt = '20241231'
--     and aa.opn_dt >= '20240101'  --开户日期
--     and aa.opn_dt <= '20241231'  --开户日期
-- ) s
-- group by s.LEVELKEY
-- 46.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比 (少了部分新开户客户没有评级)
--账户均已销户的客户
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2025021171_CST_16 PURGE;
create table IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2025021171_CST_16  as
select  customer_id
       ,count(1)    AS  CLOSE_ACCT_SM
from adm_upss.aml_t47_agreement    -- 反洗钱账户表
group by customer_id
having  count(1)=sum( case when acct_status_cd='1' then 1 else 0 end )
;
SELECT  '46-i 近一年建立业务关系客户数' id_nm
       ,COUNT(distinct SUBSTR(aa.PARTY_ID,3)) num
FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
INNER JOIN edw.dws_cst_bas_inf_dd SS
ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
WHERE aa.dt = '20241231'
AND SS.file_dt >= '20240101' --开户日期
AND SS.file_dt <= '20241231' --开户日期
AND aa.CUST_KIND <> '3'
AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ2025021171_CST_16 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID
)
;
SELECT  '46-i 近一年建立业务关系客户数' id_nm
       ,S.LEVELKEY
       ,COUNT(SUBSTR(S.PARTY_ID,3))
FROM
(
	SELECT  aa.PARTY_ID
	       ,CASE WHEN DD.LEVELKEY IS NULL THEN '1001'  ELSE DD.LEVELKEY END AS LEVELKEY
	FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' AND cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	INNER JOIN edw.dws_cst_bas_inf_dd SS
	ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
	LEFT JOIN
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
		AND A.DT = '20250115'
		UNION
		SELECT  T.PARTY_ID
		       ,T.LEVELKEY
		FROM
		(
			SELECT  A.PARTY_ID
			       ,A.LEVELKEY
			       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
			FROM adm_upss.AML_T37_PARTY_RESULT_UH A
			WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND A.DT = '20250115'
			AND NOT EXISTS (
			SELECT  1
			FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
			WHERE A.PARTY_ID = B.PARTY_ID
			AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND B.DT = '20250115')
		) T
		WHERE RN = 1
	) dd
	ON AA.PARTY_ID = dd.party_id
	WHERE aa.dt = '20241231'
	AND SS.file_dt >= '20240101' --开户日期
	AND SS.file_dt <= '20241231' --开户日期
	AND aa.CUST_KIND <> '3'
	AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ2025021171_CST_16 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID)
) s
GROUP BY  s.LEVELKEY
;
/*
levelkey	_c1
\N	6656
1003	56383
1004	3740
1002	1000253
1005	321
1001	4694
*/
-- 49.m.近一年内，因信息不完整而未予解付的跨境汇款笔数
-- (1)表名：Irmt_Master,日期：remit_Date 处理类型为退汇：deal_Type='RETURN'
-- 2851
SELECT  '49-h1 未解付跨境汇款笔数' id_nm
       ,COUNT(distinct ir_no)
FROM edw.niss_irmt_master a
INNER JOIN edw.dim_hr_org_mng_org_tree_dd b --机构树
ON a.trans_org_id = b.org_id AND b.dt = '20241231' AND b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE a.dt = '20241231'
AND SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20240101'
AND SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20241231'
AND deal_Type = 'RETURN' --处理类型为退汇
;
-- 50.d.近一年内发现个人身份证件过期的数量，因身份证件过期且无合理理由未更新而中止业务关系的客户数量
-- 121618
SELECT  '50-d1 近半年证件过期数' id_nm
       ,COUNT(distinct party_id) as 客户数
FROM
(
	SELECT  a.party_id
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240701'
	AND b.card_end_dt <= '20241231'
	--AND (a.party_status_cd = '0' or b.flag = '0')
) T
union all
SELECT  '50-d2 近半年证件过期中止业务数' id_nm
       ,COUNT(distinct party_id)
FROM
(
	SELECT  a.party_id
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	       ,SUBSTR(a.host_cust_id,3) AS cst_id
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240701'
	AND b.card_end_dt <= '20241231'
) T
inner JOIN
(
	SELECT  cst_id
	       ,MAX(zf) AS max_zf
	FROM
	(
		SELECT  cst_act_id
		       ,cst_id
		       ,CASE WHEN act_cls_frz_ind = '1' or act_rcv_oly_ind = '1' THEN 0  ELSE 1 END AS zf
		-- FROM edw.dim_bus_dep_cst_act_inf_dd --客户存款账户信息
		WHERE dt = '20241231'
	) AS a1
	GROUP BY  cst_id
	HAVING max_zf = 0
) AS t1
ON t.cst_id = t1.cst_id
;
/*
select count(t.cst_id) custs
from edw.dws_cst_bas_inf_dd	t --客户基础信息汇总表	14	doc_mtu_dt	string	证件到期日期|C8
inner JOIN
(
	SELECT  cst_id
	       ,MAX(zf) AS max_zf
	FROM
	(
		SELECT  cst_act_id
		       ,cst_id
		       ,CASE WHEN act_cls_frz_ind = '1' or act_rcv_oly_ind = '1' THEN 0  ELSE 1 END AS zf
		FROM edw.dim_bus_dep_cst_act_inf_dd --客户存款账户信息
		WHERE dt = '20241231'
	) AS a1
	GROUP BY  cst_id
	HAVING max_zf = 0
) AS t1
ON t.cst_id = t1.cst_id
where t.dt='20241231'
and t.doc_mtu_dt between '20240101' and '20241231'
*/
-- 51.f.近一年内发现客户身份注销的数量及终止业务关系的数量，从发现注销到完成终止业务关系流程的最长时间
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_04 AS
SELECT  dt             --查询日期
       ,geb_creditcode --统一信用代码
       ,geb_entname    --企业名称
       ,geb_entstatus  --经营状态 --工商状态
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
FROM
(
	SELECT  dt
	       ,geb_creditcode
	       ,geb_entname
	       ,geb_entstatus
	       ,geb_candate
	       ,geb_revdate
	       ,geb_orgcodes
	       ,geb_regno
	       ,ROW_NUMBER() OVER ( PARTITION BY geb_entname ORDER BY  dt DESC ) rnk
	FROM edw.outd_gs_entinfo_basic
	WHERE dt >= '20240101'
	AND dt <= '20241231'
) t
WHERE t.rnk = 1
;
-- 新口径
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_04_1 AS
SELECT *
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC) AS RN
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY is_abnormal desc,GEB_HOSTSENDTIME ASC) AS RN2
FROM    (
    SELECT  GEB_ENTNAME             --客户名称
        ,GEB_CREDITCODE             --统一社会信用代码
        ,GEB_ENTTYPE                --企业机构类型
        ,GEB_FRNAME                 --法定代表人负责人执行事务合伙人
        ,GEB_ENTSTATUS              --经营状态
        ,GEB_RECCAP                 --实收资本万元
        ,GEB_REGCAPCUR              --注册资本币种
        ,GEB_REGORGCITY             --所在城市
        ,GEB_REGORGDISTRICT         --所在区县
        ,GEB_ZSOPSCOPE              --经营业务范围
        ,GEB_DOM                    --住所
        ,GEB_INDUSTRYCONAME         --国民经济代码名称
        ,geb_esdate                 --成立日期
        ,geb_othertel               --其他电话
        ,GEB_HOSTSENDTIME           --geb_hostsendtime 交易发送主机时间
        ,geb_regorgprovince         --所在省份
        ,geb_regorgcode             --注册地址行政编号
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
	   ,dt
    FROM    edw.OUTD_GS_ENTINFO_BASIC   --工商企业-企业基本信息
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(GEB_CREDITCODE,'')<>''
    UNION ALL
    SELECT  dt_entname         AS GEB_ENTNAME
        ,dt_creditcode         AS GEB_CREDITCODE
        ,dt_enttype            AS GEB_ENTTYPE
        ,dt_frname             AS GEB_FRNAME
        ,dt_entstatus          AS GEB_ENTSTATUS
        ,dt_reccap             AS GEB_RECCAP
        ,dt_regcapcur          AS GEB_REGCAPCUR
        ,dt_regorgcity         AS GEB_REGORGCITY
        ,dt_regorgdistrict     AS GEB_REGORGDISTRICT
        ,dt_zsopscope          AS GEB_ZSOPSCOPE
        ,dt_dom                AS GEB_DOM
        ,dt_industryconame     AS GEB_INDUSTRYCONAME
        ,dt_esdate             AS geb_esdate
        ,dt_othertel           AS geb_othertel
        ,insert_time_chinadaas AS GEB_HOSTSENDTIME
        ,dt_regorgprovince     AS geb_regorgprovince
        ,dt_regorgcode         AS geb_regorgcode
       ,dt_candate    --注销日期
       ,dt_revdate    --吊销日期
       ,dt_orgcodes   --组织机构代码
       ,dt_regno      --注册号
	   ,dt
    FROM    edw.nout_zs_ent_basic
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(dt_creditcode,'')<>''
)a
;
--步骤二：对公账户工商注销后，其在我行开立的结算账户状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_05 AS
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep --存款账户信息
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.cst_chn_nm = B.geb_entname
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            AS 客户号
       ,A.cst_chn_nm        AS 客户名称
       ,A.prm_doc_typ_cd    AS 主证件类型代码
       ,A.prm_doc_nbr       AS 主证件号码
       ,dep.cst_act_id      AS 客户账号
       ,dep.dep_act_id      AS 负债账号
       ,dep.act_nm          AS 账户名称
       ,dep.act_sts_cd      AS 账户状态
       ,dep.act_dstr_act_dt AS 账户销户日期
       ,B.geb_entstatus     AS 工商状态
       ,B.geb_candate       AS 注销日期
       ,B.geb_revdate       AS 吊销日期
       ,B.DT                AS 查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.prm_doc_nbr = B.geb_creditcode
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            AS 客户号
       ,A.cst_chn_nm        AS 客户名称
       ,A.prm_doc_typ_cd    AS 主证件类型代码
       ,A.prm_doc_nbr       AS 主证件号码
       ,dep.cst_act_id      AS 客户账号
       ,dep.dep_act_id      AS 负债账号
       ,dep.act_nm          AS 账户名称
       ,dep.act_sts_cd      AS 账户状态
       ,dep.act_dstr_act_dt AS 账户销户日期
       ,B.geb_entstatus     AS 工商状态
       ,B.geb_candate       AS 注销日期
       ,B.geb_revdate       AS 吊销日期
       ,B.DT                AS 查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.prm_doc_nbr = B.geb_orgcodes
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            AS 客户号
       ,A.cst_chn_nm        AS 客户名称
       ,A.prm_doc_typ_cd    AS 主证件类型代码
       ,A.prm_doc_nbr       AS 主证件号码
       ,dep.cst_act_id      AS 客户账号
       ,dep.dep_act_id      AS 负债账号
       ,dep.act_nm          AS 账户名称
       ,dep.act_sts_cd      AS 账户状态
       ,dep.act_dstr_act_dt AS 账户销户日期
       ,B.geb_entstatus     AS 工商状态
       ,B.geb_candate       AS 注销日期
       ,B.geb_revdate       AS 吊销日期
       ,B.DT                AS 查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_04_1 B
ON A.prm_doc_nbr = B.geb_regno
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
;
-- 近一年内发现客户身份注销的数量 --99145
SELECT  '51-1 身份注销客户数' id_nm
       ,COUNT(distinct cst_id) num
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_05 t
union all
-- 近一年内发现客户身份注销的数量及终止业务关系的数量
-- 94572
SELECT  '51-2 身份注销终止业务客户数' id_nm
       ,COUNT(distinct cst_id) num
FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_05
WHERE act_sts_cd <> 'A' --账户状态异常
;
-- 从发现注销到完成终止业务关系流程的最长时间
SELECT  '51-3 最长时间' id_nm
       ,MAX(tt.dateminus) max_days
FROM
(
	SELECT  cst_id
	       ,CASE WHEN act_dstr_act_dt >= dt THEN DATEDIFF(to_date(act_dstr_act_dt,'yyyymmdd'),to_date(dt,'yyyymmdd'),'dd')  ELSE 0 END AS dateminus
	FROM
	(
		SELECT  cst_id
		       ,act_dstr_act_dt
		       ,dt
		FROM LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_05
		WHERE act_sts_cd <> 'A'
	) t
) tt
;
-- 52.g.近一年内，根据机构客户风险等级划分设定，应当及实际开展到期重评客户风险等级的客户数量
-- 2022年，存量客户月底到期重评的客户数量，2021年12月-2022年11月预警的客户。
-- 2374463
SELECT  '52' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
) T;
-- 53.h.近一年内，经持续尽调认为业务关系不符合客户身份，需开展强化尽职调查和重新评定客户风险等级的客户数量（不包含以上定期重评、因外部查冻扣开展强化尽调客户）及占全部客户数量比例（名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、2024年完成人工人工评定的客户，不含新开客户评级、PKG99、PKG51、CXD11两个公式。
SELECT  '53-1' id_nm
       ,count(DISTINCT A.PARTY_ID) as num
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2025021171_CST_03 A
WHERE   ( ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
AND     A.STATISTIC_DT >= '20240101'
AND     A.STATISTIC_DT <= '20241231' )
    OR ( A.LEVELKEY IN ( '1004' , '1005' )
AND     A.RCHECK_DT >= '20240101'
AND     A.RCHECK_DT <= '20241231' ) )
AND     ORGANKEY IN (
                        SELECT  B.ORGANKEY
                        FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                        WHERE   B.report_organkey = 'C1092933000014'
                        AND     B.DT = '20241231'
                    )
AND A.TEMPCATEGORY = '2'
;
-- 945254
SELECT  '53-2' id_nm
       ,COUNT(1) AS num
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
) T;
-- 2、在2024年12月31日时点，名下账户均已销户或互联网贷款客户借款余额已为0的客户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- 180969
SELECT  '53-2' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A , lab_bigdata_dev.TMP_T47_PARTY_STS B
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A , lab_bigdata_dev.TMP_T47_PARTY_STS B
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') between '20240101' and '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
) T;
-- 54.i.近一年内，经尽职调查后，调升、调降客户风险等级的客户数量，调升至最高等级和由最高风险等级调降的客户数量（以上分别统计）
-- 1、调升：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次高，且系统初评等级不是低风险、较低风险、一般风险。
-- 2013
SELECT  '54-1' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY < A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 2、调降：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次低，且系统初评等级不是低风险、较低风险、一般风险。
-- 1360
SELECT  '54-2' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY > A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 3、调升至最高等级：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级是高风险，前一次风险等级不是高风险。
-- 216
SELECT  '54-3' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY = '1005'
	AND B.LEVELKEY != '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
-- 4、由最高风险等级调降的客户：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次低，且前一次风险等级是高风险。
-- 534
SELECT  '54-4' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 A , lab_bigdata_dev.SJXQ_SJ2025021171_CST_03 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY != '1005'
	AND B.LEVELKEY = '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
--55 近一年内，经强化尽职调查后，采取业务与交易限制措施的客户数量
-- 1、2022年底，客户风险等级是较高风险、高风险客户数量
-- 2、2022年底，客户风险等级是较高风险、高风险，且在2022年被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付的客户。
-- 55	1004	22728
-- 55	1005	8610
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_06 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T
) S
WHERE S.RN <= 2
;
--迭代版代码
--2、取2022年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，关联2022年暂停非柜面、账户只收不付、不收不付的客户
--1、取2022年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，去重。
SELECT  '55-1'                     AS ind
       ,COUNT(DISTINCT A.PARTY_ID) AS val
FROM SJXQ_SJ2025021171_CST_06 A
WHERE (
    ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
        AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2024-01-01'
        AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-12-31'
    ) OR
    ( A.LEVELKEY IN ( '1004' , '1005' )
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
    )
)
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
)
UNION ALL
SELECT  '55-2'                     AS ind
       ,COUNT(DISTINCT S.party_id) AS val
FROM SJXQ_SJ2025021171_CST_06 S
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
    AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
--56 k.近一年内，经强化尽职调查后，终止业务关系的客户数量，以及占全部强化尽职调查客户的比例和占全部客户数量的比例
--2022年底，客户风险等级是较高风险、高风险，且在2022年账户不收不付、销户的客户。
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_15 AS
--账户全部销户
SELECT  A.PARTY_ID --客户号
       ,'1' AS STS --客户状态
FROM adm_upss.ADM_UPSS_AML_T47_PARTY A
WHERE NOT EXISTS (
SELECT  1
FROM adm_upss.ADM_UPSS_AML_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.ACCT_STATUS_CD = '0'
AND B.dt = '20241231') AND A.DT = '20241231'
UNION
--互联网贷款客户借款余额已为0
SELECT  A.PARTY_ID
       ,'2' AS STS
FROM adm_upss.adm_upss_aml_t47_loan_acct A
WHERE A.LTYPEKEY = '201050101040319'
AND AMT_VAL = '0'
AND NOT EXISTS (
SELECT  1
FROM adm_upss.adm_upss_aml_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.DT = '20241231') AND A.DT = '20241231'
UNION
--采取不收不付
SELECT  C.CST_ACT_ID
       ,'3'
FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
WHERE A.DT = '20241231'
AND A.FRZ_SCP_CD = '2'
AND A.NFRZ_IND = '0'
AND A.LMT_TYP IN ( '1' , '2' )
AND B.FRZ_ID IS NULL
AND LMT_TYP = '2'
AND C.CST_ACT_ID IS NOT NULL
;
--9380
SELECT  '56'              AS ind
       ,COUNT(A.PARTY_ID) AS val -- 客户数
FROM SJXQ_SJ2025021171_CST_06 A
WHERE A.LEVELKEY IN ( '1004' , '1005' )
AND A.PARTY_ID LIKE 'ZH%'
AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
AND EXISTS (
    SELECT  1
    FROM SJXQ_SJ2025021171_CST_15 B
    WHERE A.PARTY_ID = B.PARTY_ID
    AND B.STS IN ( '1' , '3' )
)
;
--57 反洗钱 1587
-- 1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
-- 2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且2022年第一次冻扣前已被划分为高风险、较高风险的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_07 AS
SELECT  aa.cst_id
       ,aa.qry_ctrl_dt
       ,aa.qry_ctrl_tm
       ,aa.frz_bgn_dt
       ,aa.frz_tmn_dt
       ,ROW_NUMBER() OVER ( PARTITION BY aa.cst_id ORDER BY  aa.qry_ctrl_dt ,aa.qry_ctrl_tm ) AS rn
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE aa.dt = '20241231'
AND qry_ctrl_dt >= '20240101'
AND qry_ctrl_dt <= '20241231'
AND qry_ctrl_typ_nm IN ( '冻结' , '划扣' )
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) );
--57关联高风险客群
-- 10692
-- 1587
SELECT  '57-1'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025021171_CST_07 t
UNION ALL
SELECT  '57-2' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ2025021171_CST_07 t
INNER JOIN SJXQ_SJ2025021171_CST_06 A
ON T.cst_id = substr(A.party_id, 3)
AND TO_CHAR(DATEADD(TO_DATE(t.qry_ctrl_dt, 'yyyyMMdd'), - 1, 'dd'), 'yyyyMMdd') = REPLACE(substr(A.STATISTIC_DT, 1, 10), '-', '')
WHERE A.LEVELKEY IN ( '1004' , '1005' )
AND A.party_id LIKE 'ZH%'
UNION ALL
SELECT  '57-2-self' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ2025021171_CST_07 t
INNER JOIN (
	SELECT party_id,min(STATISTIC_DT) as min_STATISTIC_DT
	from SJXQ_SJ2025021171_CST_06
	where LEVELKEY IN ( '1004' , '1005' )
	AND party_id LIKE 'ZH%'
	group by party_id
) A ON T.cst_id = substr(A.party_id, 3)
and t.qry_ctrl_dt>a.min_STATISTIC_DT
WHERE t.rn=1
;
--58、b.近一年内，机构上报大额交易报告笔数、份数
--20459858	12342
SELECT  '58' AS ind
       ,COUNT(B.TICD) --大额交易笔数
       ,COUNT(DISTINCT A.REPORTKEY) --份数
FROM adm_upss.AML_T07_MSG_UH A , adm_upss.aml_t3a_tsdt_n_hst B
WHERE A.REPORTORGANKEY = 'C1092933000014'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
AND A.REPORTKEY = B.RPT_ID
AND B.cust_id LIKE 'ZH%'
;
--59 c.近一年内，大额交易报告交易对手为空（包括填写替代符&ldquo;@N&rdquo;）、为内部过渡账户的比例（按笔计）分别是？（不包括机构自身与客户之间发生的交易，如贷款、付息等）
/*大额现转标志是转账，交易对手账号是空或者交易对手名称是空的；*/
--6373
--538218
SELECT  '59-1' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A , adm_upss.AML_T3A_TSDT_N_HST B
WHERE A.REPORTORGANKEY = 'C1092933000014'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND A.REPORT_TYPE_CD = 'BH'
AND A.REPORTKEY = B.RPT_ID
AND B.IS_CASH = '01'
AND (B.TCAC = '@N' OR B.TCNM = '@N')
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
;
/*大额现转标志是转账，交易对手账号是内部账户；*/
SELECT  '59-2' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A , adm_upss.AML_T3A_TSDT_N_HST B
WHERE A.REPORTORGANKEY = 'C1092933000014'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
AND A.REPORTKEY = B.RPT_ID
AND B.IS_CASH = '01'
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
AND EXISTS (
    SELECT  1
    FROM adm_upss.ADM_UPSS_AML_T47_AGREEMENT_ACCT C
    WHERE B.TCAC = C.ACCT_NUM
    AND C.TXN_DSC = 'NBZH'
    AND C.DT = '20250110'
);
--60 d.近一年内，大额交易报告报送超时的笔数及比例
--大额交易回执是警告回执，且回执内容含有逾期报送
--273402
SELECT  '60'                   AS ind
       ,COUNT(DISTINCT D.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B, adm_upss.AML_T3A_FDCF_FCER C , adm_upss.AML_T3A_TSDT_N_HST D
WHERE C.ERRS LIKE '%逾期%'
AND B.RCPT_ID = C.RCPT_ID
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = D.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND D.DT = '20250110'
AND A.REPORTORGANKEY = 'C1092933000014'
AND A.REPORT_TYPE_CD = 'BH'
;
--61 e.近一年内，反洗钱监测分析中心校验不合格、要求更正或补录的笔数及比例
--大额交易回执是错误回执、系统补正回执、通用错误回执
--367698
SELECT  '61'                   AS ind
       ,COUNT(DISTINCT C.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B , adm_upss.AML_T3A_TSDT_N_HST C
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = C.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND A.REPORTORGANKEY = 'C1092933000014'
AND A.REPORT_TYPE_CD = 'BH'
;
--62 f.近一年内，人工填报大额交易报告涉及的业务类型、笔数、比例（人工填报大额交易报告笔数/所有大额交易报告笔数）
--大额案例类型是人工新增
--2516
SELECT  '62'                   AS ind
       ,COUNT(DISTINCT B.TICD) AS val
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A, adm_upss.AML_T3A_TSDT_N_HST B
WHERE A.CAST_TYPE = '1'
AND A.DATE_STATUS_CD = '1'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20250110'
)
;
--65 f.可疑交易预警延后2年实现率：近2年内产生可疑交易预警的客户，在预警后受到司法机关查冻扣、人民银行反洗钱调查或税务机立案调查的客户数量和占比
-- 651	34881
-- 652	283
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_08 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2023-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
SELECT  '65-1'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM SJXQ_SJ2025021171_CST_08
UNION ALL
--65 2、2022年至2024年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '65-2'                    AS ind
       ,COUNT(DISTINCT p.PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST_08 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.cst_id
	       ,aa.qry_ctrl_dt
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON aa.cst_id = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	WHERE aa.dt = '20250101'
	AND qry_ctrl_dt >= '20230101'
	AND qry_ctrl_dt <= '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_09 AS
SELECT  DISTINCT PARTY_ID AS 客户号
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST_08 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.cst_id
	       ,aa.qry_ctrl_dt
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON aa.cst_id = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	WHERE aa.dt = '20250101'
	AND qry_ctrl_dt >= '20230101'
	AND qry_ctrl_dt <= '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
SELECT  '65-2-1' AS ind
       ,COUNT(1) AS N
FROM SJXQ_SJ2025021171_CST_09;
--66 g.查冻扣客户3年历史预警率：评估时点近三年内受到司法机关新增查冻扣（不含已有冻扣客户新增轮候冻扣）、人民银行反洗钱调查或税务机立案调查的客户中
-- 在接受调查或冻扣前已产生可疑交易预警的客户数量和占比
--49940
--277
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_10 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2' 	--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_11 AS
SELECT  DISTINCT aa.cst_id
       ,aa.qry_ctrl_dt
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE aa.dt = '20250101'
AND qry_ctrl_dt >= '20220101'
AND qry_ctrl_dt <= '20241231'
;
SELECT  '66-1'                  AS ind
       ,COUNT(DISTINCT cst_id) AS val
FROM SJXQ_SJ2025021171_CST_11
UNION ALL
--66 2、2020年至2022年被可疑预警的主客户，且在2022年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '66-2'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST_10 t
	WHERE t.rn = 1
) p
INNER JOIN SJXQ_SJ2025021171_CST_11 s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--67 f.近一年内，向反洗钱中心报送可疑交易报告数量，向人民银行分支机构直接报送重点可疑交易报告数量，向侦查、监察机关和税务部门报案数量
--2022年，上报可疑案例的报告数量
--2047
SELECT  '67'     AS ind
       ,COUNT(*) AS val
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
)
;
--68 g.近一年内，可疑交易报告涉及客户数量，以及因上报可疑交易而对客户采取强化尽职调查、调整风险等级、采取管控措施、中止业务关系的客户数量（以上分别统计）
--1、2022年上报可疑案例的主客户数量
--1769
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_12 AS
SELECT  DISTINCT A.PARTY_ID
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
SELECT  '68-1' AS ind
       ,COUNT(DISTINCT PARTY_ID)
FROM SJXQ_SJ2025021171_CST_12
--2、被上报可疑案例后，风险等级是高风险、较高风险、被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付、不收不付、销户的客户
--786
UNION ALL
SELECT  '68-2' AS ind
       ,COUNT(DISTINCT aaa.party_id)
FROM SJXQ_SJ2025021171_CST_12 aaa
INNER JOIN SJXQ_SJ2025021171_CST_06 S
ON aaa.PARTY_ID = S.PARTY_ID
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
	AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
--69 i.近一年内司法机关新增冻扣客户（不含已有冻扣客户新增轮候冻扣）中，已在近年内（不超过5年）被提交可疑交易报告的客户数量与占比
--1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
--2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且在2020-2024年被上报可疑案例的主客户
-- 10692
-- 413
SELECT  '69-1'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025021171_CST_07 t
UNION ALL
SELECT  '69-2' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025021171_CST_07 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2020-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2' 		--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
--70 j.近一年内被提交可疑交易报告的客户中，已被司法机关查冻扣、人民银行反洗钱调查、涉诈通报客户数量与占比
--2022年上报可疑案例的主客户，且在上报前，已被司法查冻扣、预警人行黑名单的客户
--200
SELECT  '70' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025021171_CST_07 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01' --近1年
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND REPLACE(substr(A.APP_DT, 1, 10), '-', '') > s.frz_bgn_dt --查扣时间小于预警时间
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
-- 71
-- d.（银行）交易对手方通过其他机构（如第三方支付机构）间接与本机构客户发生交易的，是否能够获取到对手方实际名称（包括以支付机构名称添加后缀方式获取）？
-- （非银行）通过代销渠道销售产品的，是否能够获取客户核心身份信息（客户名称、证件类型、证件号码）
-- 请列举与本机构交易笔数最多的5家机构的客户名称获取率及名称，以及获取率最低的5家机构的比率及名称。
-- 1.用反洗钱交易流水表，筛选非信用卡的交易里 bank_pay_cd 不为空且不为@的交易，取交易笔数。
-- 2.将第一点筛选出的交易流水的 opp_organname 去重统计交易笔数，取明细。
-- 3.用反洗钱交易流水表，筛选信用卡的交易里交易对手是 999999915613007000400002 和 473331083984444 的交易，取交易笔数。
-- 4.将第一点筛选出的交易流水的opp_name，取出来，将-前面的文字取出来去重统计交易，取出明细。
--总行交易
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_13 AS
SELECT  '泰隆银行'   AS zh
       ,COUNT(*) AS 总笔数
       ,SUM(t.cny_amt) 总金额
FROM adm_upss.aml_t47_transaction t
AND t.dt <= '20241231'
AND t.dt >= '20240101'
;
select * from SJXQ_SJ2025021171_CST_13;
-- zh	总笔数	总金额
-- 泰隆银行	236639274	566803181093.82
--交易对手排名
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_14 AS
SELECT  s . *
       ,CASE WHEN R.交易银行 IS NOT NULL THEN r.笔数  ELSE 0 END 总笔数交易对手
       ,CASE WHEN R.交易银行 IS NOT NULL THEN r.总金额  ELSE 0 END 总金额交易对手
FROM
(
	SELECT  t.opp_organname 交易银行 	--财付通
	       ,COUNT(*) 笔数
	       ,SUM(t.cny_amt) 总金额
	FROM adm_upss.aml_t47_transaction t
	WHERE t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
	AND t.opp_organname is not null
	AND t.dt <= '20241231'
	AND t.dt >= '20240101'
	GROUP BY  t.opp_organname
) s
LEFT JOIN
(
	SELECT  t.opp_organname 交易银行
	       ,COUNT(*) 笔数
	       ,SUM(t.cny_amt) 总金额
	FROM adm_upss.aml_t47_transaction t
	WHERE t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
	AND t.dt <= '20241231'
	AND t.dt >= '20240101'
	AND t.opp_organname is not null
	AND t.opp_name = t.opp_organname
	GROUP BY  t.opp_organname
) r
ON s.交易银行 = r.交易银行;
SELECT  *
FROM SJXQ_SJ2025021171_CST_14;
-- 扫二维码付款	36745822	10663138226.65
-- 微信转账	28309319	68627357629.88
-- 财付通支付科技有限公司	8089180	42527808619.52
SELECT  T.opp_name
       ,COUNT(*)     AS 笔数
       ,SUM(cny_amt) AS 金额
FROM adm_upss.aml_t47_transaction t
WHERE t.dt >= '20240101'
AND t.dt <= '20241231'
AND t.opp_organname LIKE '%财付通%'
AND t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
GROUP BY  T.opp_name
ORDER BY  COUNT(*) desc;
--支付宝（中国）网络技术有限公司	7900205	55092851722.11
--还款	2293251	5850925074.57
SELECT  T.opp_name
       ,COUNT(*)     AS 笔数
       ,SUM(cny_amt) AS 金额
FROM adm_upss.aml_t47_transaction t
WHERE t.dt >= '20240101'
AND t.dt <= '20241231'
AND t.opp_organname LIKE '%支付宝%'
AND t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
GROUP BY  T.opp_name
ORDER BY  COUNT(*) desc;
-- 1、2024年全部第三方支付机构收付金额：网联 epcc_paysrl 表+ wk_jrnl 表 限制trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')，2024年收付金额。
-- 197427.396284000000140099
SELECT  SUM(trans_at)/10000 AS val
FROM edw.frhd_wk_jrnl --无卡交易流水
WHERE dt >= '20240101'
AND dt <= '20241231'
--  and trans_st = '0'
;
-- 50508156.85435102
SELECT  SUM(trxamt)/10000 AS val
FROM edw.epcc_epcc_paysrl --支付流水表
WHERE dt >= '20240101'
AND dt <= '20241231'
AND epccstatus = '00'
;
-- 2、2024年各第三方支付机构交易笔数：网联 epcc_paysrl_attachl 表按 instgid 支付机构编码统计交易笔数
-- + wk_jrnl 表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')按 snd_ins_id_cd 统计交易笔数。
-- 取支付机构编码、名称、笔数。
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_17 AS
SELECT  t1.instgid AS 支付机构编码
       ,t2.instgnm AS 名称
       ,COUNT(1)   AS 笔数
FROM edw.epcc_epcc_paysrl AS t1 --支付流水表
LEFT JOIN edw.epcc_epcc_instgidinf AS t2 --网联支付机构信息
ON t1.instgid = t2.instgid AND t2.dt = '20241231'
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
AND t1.epccstatus = '00'
GROUP BY  t1.instgid
         ,t2.instgnm
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_18 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_18 AS
SELECT  t1.snd_ins_id_cd AS 支付机构编码
       ,COUNT(1)                                            AS 笔数
FROM edw.frhd_wk_jrnl AS t1 --无卡交易流水
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
GROUP BY  t1.snd_ins_id_cd
;
-- 3、2024年各第三方支付机构商户实际名称获取率： 网联 epcc_paysrl_attach 按instgid统计mkinfo6 不为空的笔数/对应支付机构笔数，
-- 银联 wk_jrnl 表限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101') 按 snd_ins_id_cd 统计 snd_ins_id_cd 不为空的笔数/对应支付机构限制 trans_tp in ( &lsquo;1001&rsquo; ,'1002','1101')的笔数。
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_19 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_19 AS
SELECT  t1.instgid AS 支付机构编码
       ,t2.instgnm AS 名称
       ,SUM(case WHEN nvl(t3.mkinfo6,'') <> '' AND t3.mkinfo6 NOT IN ( '上海寻梦信息技术有限公司' ,'微信红包' ,'扫二维码付款'
            ,'信用卡还款' ,'北京三快在线科技有限公司' ,'中移动金融科技有限公司' ,'成都所见所得科技有限公司' ,'微信转账'
             ,'高德信息技术有限公司' ,'上海格物致品网络科技有限公司' ,'上海拉扎斯信息科技有限公司' ,'特约商户' ) THEN 1
             else 0 end) /COUNT(1) AS 获取率
FROM edw.epcc_epcc_paysrl AS t1 --支付流水表
LEFT JOIN edw.epcc_epcc_instgidinf AS t2 --网联支付机构信息
ON t1.instgid = t2.instgid AND t2.dt = '20241231'
LEFT JOIN edw.epcc_epcc_paysrl_attach AS t3 --支付流水表附表
ON t1.trxid = t3.trxid AND t1.instgid = t3.instgid
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
AND t3.dt >= '20240101'
AND t3.dt <= '20241231'
AND t1.epccstatus = '00'
GROUP BY  t1.instgid
         ,t2.instgnm
;
-- 46个机构均为1
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST_20 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST_20 AS
SELECT  t1.snd_ins_id_cd                                                     AS 支付机构编码
       ,SUM(case WHEN nvl(t1.mchnt_nm,'') <> '' THEN 1 else 0 end) /COUNT(1) AS 获取率
FROM edw.frhd_wk_jrnl AS t1 --无卡交易流水
WHERE t1.dt >= '20240101'
AND t1.dt <= '20241231'
GROUP BY  t1.snd_ins_id_cd
;
Select '71-网联-交易笔数前5' AS ind
    ,t1.支付机构编码
    ,t1.名称
    ,t2.获取率
from(
    select 支付机构编码,名称,笔数
    from SJXQ_SJ2025021171_CST_17 	--网联
    order by 笔数 desc limit 5
)t1 left join SJXQ_SJ2025021171_CST_19  t2
on t1.支付机构编码=t2.支付机构编码
union all
Select '71-网联-获取率后5' AS ind
    ,支付机构编码
    ,名称
    ,获取率
from SJXQ_SJ2025021171_CST_19
order by 获取率 limit 5
;
Select '71-银联-交易笔数前5' AS ind
    ,t1.支付机构编码
    ,t2.获取率
from(
    select 支付机构编码,笔数
    from SJXQ_SJ2025021171_CST_18 	--网联
    order by 笔数 desc limit 5
)t1 left join SJXQ_SJ2025021171_CST_20  t2
on t1.支付机构编码=t2.支付机构编码
union all
Select '71-银联-获取率后5' AS ind
    ,支付机构编码
    ,获取率
from SJXQ_SJ2025021171_CST_20
order by 获取率 limit 5
***於挺_SJ2025021171_人行报送机构评估0224.sql
﻿/*
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.AML_T3R_QRY_FRZ_DDCT_LST_ZH
(
    RECE_CHANNEL     STRING COMMENT '查冻扣函件接收渠道'
    ,JUDICIAL_BRANCH STRING COMMENT '查冻扣单位类别'
    ,QFD_CAUSE       STRING COMMENT '查冻扣事由(涉罪类型)'
    ,INSTT_PRO       STRING COMMENT '有权机关省份'
    ,INSTT_NAME      STRING COMMENT '有权机关名称'
    ,DOCUMENT_NUMBER STRING COMMENT '查冻扣文书编号'
    ,RECE_DT         STRING COMMENT '查冻扣函件接收日期'
    ,DOCUMENT_TYPE   STRING COMMENT '要求采取的措施类型(查询/冻结/划扣)'
    ,CUSTOMER_ID     STRING COMMENT '客户号'
    ,CUSTOMER_NAME   STRING COMMENT '客户名称'
    ,ID_NO           STRING COMMENT '客户身份证件号码'
    ,SELF_ACC_NO     STRING COMMENT '查冻扣涉及客户账号'
    ,ORGANKEY        STRING COMMENT '归属机构'
)
COMMENT
'涉及刑事查冻扣客户清单'
PARTITIONED BY
(
    DT STRING COMMENT '日期分区'
)
LIFECYCLE 36000;
*/
--57 反洗钱 1587
-- 1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
-- 2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且2022年第一次冻扣前已被划分为高风险、较高风险的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST2_07 AS
SELECT  aa.RECE_DT       as qry_ctrl_dt --查冻扣函件接收日期
       ,aa.DOCUMENT_TYPE --要求采取的措施类型(查询/冻结/划扣)
       ,substr(aa.CUSTOMER_ID,3,12)   as cst_id --客户号
       ,aa.CUSTOMER_NAME --客户名称
	,ROW_NUMBER() OVER ( PARTITION BY aa.CUSTOMER_ID ORDER BY  aa.RECE_DT asc) AS rn
FROM LAB_BIGDATA_DEV.AML_T3R_QRY_FRZ_DDCT_LST_ZH aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON substr(aa.CUSTOMER_ID,3,12) = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE aa.dt = '20241231'
AND aa.JUDICIAL_BRANCH = '公安机关'
AND aa.DOCUMENT_TYPE IN ( '冻结' , '划扣' )
AND aa.RECE_DT BETWEEN '20240101' AND '20241231'
;
--57关联高风险客群
-- 10692
-- 1587
SELECT  '57-1'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025021171_CST2_07 t
UNION ALL
SELECT  '57-2' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ2025021171_CST2_07 t
INNER JOIN (
	SELECT party_id,min(STATISTIC_DT) as min_STATISTIC_DT
	from SJXQ_SJ2025021171_CST_06
	where LEVELKEY IN ( '1004' , '1005' )
	AND party_id LIKE 'ZH%'
	group by party_id
) A ON T.cst_id = substr(A.party_id, 3)
and t.qry_ctrl_dt>a.min_STATISTIC_DT
WHERE t.rn=1
;
--65 f.可疑交易预警延后2年实现率：近2年内产生可疑交易预警的客户，在预警后受到司法机关查冻扣、人民银行反洗钱调查或税务机立案调查的客户数量和占比
-- 651	34881
-- 652	283
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST2_08 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2023-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
SELECT  '65-1'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM SJXQ_SJ2025021171_CST2_08
UNION ALL
--65 2、2022年至2024年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '65-2'                    AS ind
       ,COUNT(DISTINCT p.PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST2_08 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.RECE_DT    as qry_ctrl_dt --查冻扣函件接收日期
		,substr(aa.CUSTOMER_ID,3,12)   as cst_id --客户号
	FROM LAB_BIGDATA_DEV.AML_T3R_QRY_FRZ_DDCT_LST_ZH aa
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON substr(aa.CUSTOMER_ID,3,12) = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
	WHERE aa.dt = '20241231'
	AND aa.JUDICIAL_BRANCH = '公安机关' 	--司法机关查冻扣、人民银行反洗钱调查或税务机
	AND aa.RECE_DT BETWEEN '20230101' AND '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--66 g.查冻扣客户3年历史预警率：评估时点近三年内受到司法机关新增查冻扣（不含已有冻扣客户新增轮候冻扣）、人民银行反洗钱调查或税务机立案调查的客户中
-- 在接受调查或冻扣前已产生可疑交易预警的客户数量和占比
--49940
--277
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST2_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST2_10 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2' 	--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1092933000014'
    AND B.DT = '20241231'
);
DROP   TABLE IF     EXISTS SJXQ_SJ2025021171_CST2_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021171_CST2_11 AS
SELECT DISTINCT  aa.RECE_DT    as qry_ctrl_dt --查冻扣函件接收日期
	,substr(aa.CUSTOMER_ID,3,12)   as cst_id --客户号
FROM LAB_BIGDATA_DEV.AML_T3R_QRY_FRZ_DDCT_LST_ZH aa
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON substr(aa.CUSTOMER_ID,3,12) = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE aa.dt = '20241231'
AND aa.JUDICIAL_BRANCH = '公安机关' 	--司法机关查冻扣、人民银行反洗钱调查或税务机
AND aa.RECE_DT BETWEEN '20220101' AND '20241231'
;
SELECT  '66-1'                  AS ind
       ,COUNT(DISTINCT cst_id) AS val
FROM SJXQ_SJ2025021171_CST2_11
UNION ALL
--66 2、2020年至2022年被可疑预警的主客户，且在2022年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '66-2'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025021171_CST2_10 t
	WHERE t.rn = 1
) p
INNER JOIN SJXQ_SJ2025021171_CST2_11 s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--69 i.近一年内司法机关新增冻扣客户（不含已有冻扣客户新增轮候冻扣）中，已在近年内（不超过5年）被提交可疑交易报告的客户数量与占比
--1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
--2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且在2020-2024年被上报可疑案例的主客户
-- 10692
-- 413
SELECT  '69-1'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025021171_CST2_07 t
UNION ALL
SELECT  '69-2' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025021171_CST2_07 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2020-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2' 		--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
--70 j.近一年内被提交可疑交易报告的客户中，已被司法机关查冻扣、人民银行反洗钱调查、涉诈通报客户数量与占比
--2022年上报可疑案例的主客户，且在上报前，已被司法查冻扣、预警人行黑名单的客户
--200
SELECT  '70' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025021171_CST2_07 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01' --近1年
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5'
AND A.CAST_TYPE = '2'
AND A.DT = '20241231'
AND REPLACE(substr(A.APP_DT, 1, 10), '-', '') > s.qry_ctrl_dt --查扣时间小于预警时间
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1092933000014'
    AND     B.DT = '20241231'
);
***於挺_SJ20250218106_票据中介客户.sql
﻿-- 客户号 注册资本 经营范围 客户名称 交易笔数_2324两年 交易金额_2324两年
-- 公安查询次数_2324两年 公安查询渠道数_2324两年 公安查询机构数_2324两年
-- 当前评级风险等级 最后评级时间 是否历史上报可疑
-- 主管户分行 主管户支行 主管户支行名称 主管户人工号 主管户人姓名
-- 是否有未结清信贷业务 当前月日均存款
/*
SELECT LENGTH(party_id) l,count(1)
from SJXQ_SJ20250218106_CST_01
GROUP BY l
;
7	1
8	5
9	16
12	9489177
18	1103    --证件号
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_01 AS
SELECT  A.party_id      --DY1005609827
        ,A.objorgankey
        ,A.manager_no
        ,A.manager_name
FROM    ADM_UPSS.adm_upss_aml_t47_individual A
WHERE   A.DT = '@@{yyyyMMdd}'
UNION
SELECT  A.party_id
        ,A.objorgankey
        ,A.manager_no
        ,A.manager_name
FROM    ADM_UPSS.adm_upss_aml_t47_corporation A
WHERE   A.DT = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_02 AS
SELECT  party_id    --DY1602431737
       ,COUNT(DISTINCT A.transactionkey) AS 交易笔数
       ,SUM(CNY_amt)                     AS 交易金额
FROM ADM_UPSS.ADM_UPSS_AML_T47_TRANSACTION A
WHERE DT <= '20241231'
AND DT >= '20230101'
GROUP BY  party_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_03 AS
SELECT  A.cst_no                     AS 客户号  --ZH1035346798
       ,COUNT(DISTINCT A.JUDICIAL_BRANCH) AS 公安查询渠道数
       ,''      AS 公安查询机构数
       ,COUNT(1)                          AS 公安查询次数
       ,max(a.qfd_date) as max_qfd_date
FROM adm_upss.AML_T3R_QRY_FRZ_DDCT_LST A
WHERE A.DT = '@@{yyyyMMdd-3d}'
AND A.qfd_date <= '20241231'
AND A.qfd_date >= '20230101'
GROUP BY A.cst_no
;
/*
SELECT  T1.qry_ctrl_chnl_nm AS 查控渠道名称
        ,T4.cd_val_dscr     AS 有权机关类型
        ,T1.exe_rsn          AS 执行原因
        ,T1.instt_nm         AS 有权机关名称
        ,T1.law_doc_id       AS 法律文书编号
        ,T1.law_doc_nm       AS 法律文书名称
        ,T1.qry_ctrl_dt      AS 查控日期
        ,T1.qry_ctrl_tm      AS 查控时间
        ,T1.qry_ctrl_typ_nm  AS 查控类型代码
        ,T1.cst_id           AS 客户号
        ,T1.cst_nm           AS 客户名称
        ,CASE
           WHEN T1.CST_TYP_CD = '1' THEN '对私'
           WHEN T1.CST_TYP_CD = '2' THEN '对公'
         END                 AS 公私标识
        ,T1.cst_doc_typ_cd   AS 客户证件类型
        ,T1.cst_doc_nbr      AS 客户证件号码
        ,T1.cst_act_id       AS 客户账号
        ,T2.prm_org_id       AS 客户归属机构ID
        ,T2.prm_org_nm       AS 客户归属机构
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd T1
WHERE   T1.dt = '@@{yyyyMMdd}'
AND     T1.qry_ctrl_dt between '20230101' and '20241231'
AND     T1.qry_ctrl_typ_nm IN ( '查询' , '冻结' , '划扣' )
AND     ( T1.instt_typ_cd IN ( '04' , '05' )
    OR ( ( T1.instt_nm LIKE '%法院%'
    OR T1.instt_typ_cd = '01' )
AND     T1.LAW_DOC_ID LIKE '%刑%' ) )
;
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_04 AS
SELECT  cst_no          --ZH1013290679
       ,self_acc_name
       ,id_no
       ,risk_code
       ,dt_time AS time
FROM adm_upss.AML_T3R_RISK_NEW
WHERE DT = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_05 AS
SELECT  B.PARTY_ID
       ,CASE WHEN A.CSNM IS NOT NULL THEN 'Y'  ELSE '' END AS IS_KY
FROM ADM_UPSS.ADM_UPSS_AML_T47_CP_DEPOSIT B
LEFT JOIN ADM_UPSS.AML_T3B_SEIF_N_HST A
ON A.CSNM = B.PARTY_ID AND A.DT = '@@{yyyyMMdd}'
WHERE B.DT = '@@{yyyyMMdd}'
GROUP BY  B.PARTY_ID
         ,A.CSNM
UNION
SELECT  B.PARTY_ID
       ,CASE WHEN A.CSNM IS NOT NULL THEN 'Y'  ELSE '' END AS IS_KY
FROM ADM_UPSS.ADM_UPSS_AML_T47_ID_DEPOSIT B
LEFT JOIN ADM_UPSS.AML_T3B_SEIF_N_HST A
ON A.CSNM = B.PARTY_ID AND A.DT = '@@{yyyyMMdd}'
WHERE B.DT = '@@{yyyyMMdd}'
GROUP BY  B.PARTY_ID
         ,A.CSNM
;
/*
SELECT LENGTH(party_id) l,count(1)
from SJXQ_SJ20250218106_CST_05
GROUP BY l
;
0	1
2	1
7	3
8	47
9	36
12	9160402
18	1103
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_06 AS
SELECT  substr(a.party_id,3)      AS 客户号
       ,t3.reg_cpt       AS 注册资本
       ,t3.opr_scp_dscr  AS 经营范围描述
       ,C.self_acc_name AS 客户名称
       ,a.交易笔数
       ,a.交易金额
       ,b.公安查询次数
       ,b.公安查询渠道数
       ,b.公安查询机构数
       ,c.risk_code     AS 评级风险等级CD
       ,CASE WHEN c.risk_code = '10' THEN '高风险'
             WHEN c.risk_code = '11' THEN '较高风险'
             WHEN c.risk_code = '12' THEN '一般风险'
             WHEN c.risk_code = '13' THEN '较低风险'
             WHEN c.risk_code = '14' THEN '低风险' END 评级风险等级
       ,c.time                                                   AS 最后评级时间
       ,D.IS_KY                                                  AS 是否报可疑
       ,D.ORGANKEY                                               AS 账户所属机构
       ,t4.brc_org_nm                                            AS 账户所属分行
       ,t4.sbr_org_nm                                            AS 账户所属支行
       ,F.objorgankey                                            AS 所属支行
       ,F.manager_no                                             AS 管护工号
       ,F.manager_name                                           AS 管护姓名
       ,CASE WHEN t5.party_id IS NOT NULL THEN '是'  ELSE '否' END AS 是否有未结清信贷业务
       ,t6.DEP_BAL_MON_AVG                                       AS 当前月日均存款
FROM SJXQ_SJ20250218106_CST_02 a
LEFT JOIN SJXQ_SJ20250218106_CST_03 b
ON a.party_id = b.客户号
LEFT JOIN SJXQ_SJ20250218106_CST_04 c
ON a.party_id = c.cst_no
LEFT JOIN SJXQ_SJ20250218106_CST_05 D
ON A.party_id = D.PARTY_ID
LEFT JOIN edw.dim_cst_entp_bas_inf_dd t3 --企业客户基本信息
ON substr(a.party_id,3) = t3.cst_id AND t3.dt = '@@{yyyyMMdd}'
LEFT JOIN SJXQ_SJ20250218106_CST_01 F
ON A.party_id = F.party_id
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
ON F.objorgankey = t4.org_id AND t4.dt = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  DISTINCT PARTY_ID
	FROM adm_upss.ADM_UPSS_AML_T47_LOAN_ACCT
	WHERE DT = '@@{yyyyMMdd}'
	AND ( CLOSE_DT <> '' OR ACCT_STATUS_CD = '1' )
) t5
ON a.party_id = t5.party_id
LEFT JOIN adm_pub.ADM_CSM_CBUS_DEP_INF_DD t6
ON substr(a.party_id,3) = t6.CST_ID
AND t6.DT = '@@{yyyyMMdd}'
WHERE substr(a.party_id,3) in(
    SELECT  cst_id
    FROM qbi_file_20250219_16_07_24_0
    WHERE pt <> ''
)
;
-- 客户号	结算账户	账户状态（正常\销户\不动户\转营业外等）	账户管控状态（暂停非柜、止付等）	日累计非柜额度
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST_07 AS
SELECT  t1.cst_id      AS 客户号
       ,t2.cst_act_id  AS 客户账号
       ,t2.dep_act_id  as 存款账号
       ,t2.act_sts_cd  AS 账户状态代码
       ,c1.cd_val_dscr AS 账户状态
       ,CASE WHEN t3.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否账户止付
       ,CASE WHEN t4.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否账户冻结
       ,CASE WHEN t5.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否暂停非柜面
       ,t6.fg_day_lmt                                             AS 日累计非柜限额
FROM (
    SELECT DISTINCT cst_id
    from qbi_file_20250219_16_07_24_0
    WHERE pt <> ''
)t1
left join edw.dim_bus_dep_act_inf_dd    t2 --存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.stl_act_ind='1'   --结算账户
left join edw.dwd_code_library_dd   c1
on t2.act_sts_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
left join(
    SELECT  distinct t1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='2'  --账户止付
    AND     t1.NFRZ_IND = '0'
)t3 on t2.cst_act_id=t3.cst_act_id
left join(
    SELECT  distinct t1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='1'  --账户冻结
    AND     t1.NFRZ_IND = '0'
)t4 on t2.cst_act_id=t4.cst_act_id
left join(
    SELECT  distinct cst_act_id
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '@@{yyyyMMdd}'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t5 on t2.cst_act_id=t5.cst_act_id
left join(
    SELECT  cengcgjz    cst_act_id
        ,leijiedu   fg_day_lmt
    FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
    WHERE   dt = '@@{yyyyMMdd}'
    AND     zhxeleix = '2'
    AND     shijbhao = 'FGMXIANE' -- 非柜面限额
    AND     edkzzhqi = '1D'
)t6 on t2.cst_act_id=t6.cst_act_id
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20250218106_CST_06
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20250218106_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ20250218106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ20250218106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250218106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_no) custs
from SJXQ_SJ20250218106_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ20250218106_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250218106_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ20250218106_CST_07
;
/*
01	9490302	9490302
02	5432918	5432918
03	61125	61125
04	9467392	9467392
05	9161593	9161593
06	41238	41209
07	461711	461693
*/***於挺_SJ20250218106_票据中介客户0228.sql
﻿-- 补充人行清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_08
(
    seq     bigint COMMENT ''
    ,cst_id      string COMMENT ''
)
;
insert into SJXQ_SJ20250218106_CST2_08
values (1,'1009261124'),
    (2,'1018926245'),
    (3,'1628698917'),
    (4,'1007178185'),
    (5,'1636942569'),
    (6,'1673519763'),
    (7,'1000065542'),
    (8,'1006564363'),
    (9,'1647195993'),
    (10,'1627496410'),
    (11,'2609140249'),
    (12,'1032025333'),
    (13,'1006233472'),
    (14,'1032917355'),
    (15,'1619400105'),
    (16,'1601307999'),
    (17,'1003916710'),
    (18,'1004682162'),
    (19,'2607060437'),
    (20,'2603449617'),
    (21,'2605041214'),
    (22,'2605737015'),
    (23,'1608393718'),
    (24,'2612564796'),
    (25,'1000058464'),
    (26,'2605263465'),
    (27,'2602138225'),
    (28,'1681457962'),
    (29,'1651655936'),
    (30,'7632432003'),
    (31,'1603571627'),
    (32,'2611648868'),
    (33,'2612712280'),
    (34,'2606409274'),
    (35,'1004472905'),
    (36,'1689967158'),
    (37,'2001399439'),
    (38,'2601470716'),
    (39,'2612710349'),
    (40,'2610024789'),
    (41,'1616554982'),
    (42,'2607288765'),
    (43,'1024119684'),
    (44,'1686659612'),
    (45,'1689971823'),
    (46,'1621386023'),
    (47,'1635031428'),
    (48,'1682527771'),
    (49,'1634114845'),
    (50,'1000125942'),
    (51,'1681458581'),
    (52,'2603918494'),
    (53,'1033988592'),
    (54,'2618632554'),
    (55,'2600045208'),
    (56,'1684008645'),
    (57,'2601998920'),
    (58,'1683673261'),
    (59,'1677740088'),
    (60,'1614229055'),
    (61,'1627027366'),
    (62,'1018389866'),
    (63,'1012047386'),
    (64,'1033815687'),
    (65,'1637444041'),
    (66,'2608005256'),
    (67,'1027314125'),
    (68,'1007982858'),
    (69,'1647160993'),
    (70,'1602342037'),
    (71,'1695916909'),
    (72,'1656462609'),
    (73,'1008254860'),
    (74,'1613367629'),
    (75,'1650662364'),
    (76,'1636367414'),
    (77,'1646734925'),
    (78,'1680916492'),
    (79,'2604371489'),
    (80,'2608231314'),
    (81,'1004842122'),
    (82,'1008282748'),
    (83,'1673064486'),
    (84,'1627445555'),
    (85,'2605338463'),
    (86,'1000197722'),
    (87,'1006932506'),
    (88,'1005961097'),
    (89,'1008585092'),
    (90,'1650860788'),
    (91,'2612564119'),
    (92,'1703348476'),
    (93,'1673515865'),
    (94,'1042297326'),
    (95,'2609032467'),
    (96,'1009240145'),
    (97,'2000002275'),
    (98,'1015048490'),
    (99,'2607979750'),
    (100,'1711477457'),
    (101,'1027114244'),
    (102,'2600233848'),
    (103,'1004528109'),
    (104,'2600602237'),
    (105,'1679214363'),
    (106,'1688822556'),
    (107,'1674832360'),
    (108,'1611854143'),
    (109,'2603094269'),
    (110,'1688078623'),
    (111,'1007497848'),
    (112,'1687683874'),
    (113,'2000471172'),
    (114,'1004785117'),
    (115,'1015136241'),
    (116,'2602145491'),
    (117,'1033098390'),
    (118,'1682475483'),
    (119,'1681382066'),
    (120,'2606562540'),
    (121,'1019223703'),
    (122,'1632287057'),
    (123,'1027638256'),
    (124,'1669033402'),
    (125,'2605014145'),
    (126,'1008348521'),
    (127,'1642400890'),
    (128,'1629914152'),
    (129,'1013747401'),
    (130,'1031349991'),
    (131,'1652611007'),
    (132,'2603627498'),
    (133,'2002781594'),
    (134,'1679955272'),
    (135,'2603031369'),
    (136,'1032153238'),
    (137,'1016861355'),
    (138,'2609476053'),
    (139,'1602133415'),
    (140,'1680593714'),
    (141,'1652058731'),
    (142,'1640099560'),
    (143,'1000029199'),
    (144,'1607803333'),
    (145,'1639055525'),
    (146,'1606362152'),
    (147,'2001540073'),
    (148,'1004781609'),
    (149,'1681617871'),
    (150,'1004939897'),
    (151,'1670839539'),
    (152,'1018090988'),
    (153,'1675207359'),
    (154,'1039784633'),
    (155,'1020872929'),
    (156,'2602705664'),
    (157,'1609101417'),
    (158,'1689083743'),
    (159,'2605349586'),
    (160,'1020253382'),
    (161,'1695770300'),
    (162,'2605390264'),
    (163,'2600371030'),
    (164,'1684503931'),
    (165,'2606780529'),
    (166,'1609210878'),
    (167,'1010710385'),
    (168,'1015849020'),
    (169,'1021923381'),
    (170,'1028658172'),
    (171,'1636596550'),
    (172,'1633152310'),
    (173,'1004594157'),
    (174,'1690687077'),
    (175,'1036598974'),
    (176,'2622847359'),
    (177,'2600552253'),
    (178,'1696890188'),
    (179,'2601292094'),
    (180,'1004403772'),
    (181,'1668777295'),
    (182,'1009418654'),
    (183,'1614317305'),
    (184,'1005779177'),
    (185,'1600084359'),
    (186,'1690665335'),
    (187,'1008945731'),
    (188,'1627240337'),
    (189,'1627542598'),
    (190,'1642058610'),
    (191,'1684503982'),
    (192,'1005649166'),
    (193,'1005465980'),
    (194,'1610213000'),
    (195,'7634979296'),
    (196,'2000990949'),
    (197,'1045655110'),
    (198,'1647956860'),
    (199,'1000066737'),
    (200,'1042592560'),
    (201,'1000125936'),
    (202,'1690485824'),
    (203,'1656546033'),
    (204,'1029913812'),
    (205,'1043646215'),
    (206,'1028566572'),
    (207,'1021964908'),
    (208,'1018830485'),
    (209,'1656688688'),
    (210,'1011612086'),
    (211,'1004427361'),
    (212,'1683598827'),
    (213,'1017300846'),
    (214,'1650644934'),
    (215,'1000022216'),
    (216,'2000985822'),
    (217,'1003472076'),
    (218,'1008265037'),
    (219,'1656319302'),
    (220,'1004175802'),
    (221,'1656512311'),
    (222,'1686327256'),
    (223,'1629420834'),
    (224,'1011574449'),
    (225,'1642863035'),
    (226,'2001837148'),
    (227,'1608990080'),
    (228,'1019004663'),
    (229,'2605296534'),
    (230,'1011290518'),
    (231,'2604688847'),
    (232,'2600548045'),
    (233,'1011153639'),
    (234,'1646329888'),
    (235,'1670380640'),
    (236,'1694782324'),
    (237,'1003870607'),
    (238,'1041022923'),
    (239,'1000148677'),
    (240,'1683825057'),
    (241,'1693993024'),
    (242,'1688631586'),
    (243,'1643501770'),
    (244,'1015186772'),
    (245,'1654920954'),
    (246,'1015579914'),
    (247,'1010431048'),
    (248,'1010159975'),
    (249,'1681965784'),
    (250,'1000120991'),
    (251,'1688858437'),
    (252,'2002253914'),
    (253,'1673273733'),
    (254,'1013199639'),
    (255,'2604452753'),
    (256,'1013301678'),
    (257,'1683436689'),
    (258,'2000517704'),
    (259,'1000134004'),
    (260,'1687185359'),
    (261,'1613771053'),
    (262,'1683917723'),
    (263,'1688889226'),
    (264,'1015794065'),
    (265,'1614135702'),
    (266,'2000601566'),
    (267,'1015147766'),
    (268,'1688250779'),
    (269,'1668977488'),
    (270,'1000023404'),
    (271,'1676252077'),
    (272,'2607182648'),
    (273,'1005015224'),
    (274,'2610109595'),
    (275,'1652825922'),
    (276,'1689208728'),
    (277,'2604531949'),
    (278,'1007684321'),
    (279,'1687278812'),
    (280,'1010033936'),
    (281,'1614331779'),
    (282,'1006547924'),
    (283,'1015136823'),
    (284,'1630078407'),
    (285,'1000119182'),
    (286,'1015792586'),
    (287,'1037639454'),
    (288,'1602834117'),
    (289,'2000390958'),
    (290,'2000998174'),
    (291,'1636689549'),
    (292,'1711207570'),
    (293,'1679894690'),
    (294,'1620961077'),
    (295,'1689419822'),
    (296,'1669342276'),
    (297,'2604663968'),
    (298,'2612574274'),
    (299,'1679448194'),
    (300,'1013456208'),
    (301,'1614306845'),
    (302,'1683233724'),
    (303,'1632719695'),
    (304,'2605490619'),
    (305,'1643184619'),
    (306,'1679015811'),
    (307,'1015414589'),
    (308,'1000128083'),
    (309,'1680786803'),
    (310,'2000485339'),
    (311,'1003637752'),
    (312,'1611847961'),
    (313,'2608338746'),
    (314,'2607109001'),
    (315,'1655928061'),
    (316,'1683621958'),
    (317,'1015437388'),
    (318,'2001582295'),
    (319,'1042306442'),
    (320,'1638306105'),
    (321,'1607698471'),
    (322,'1024050068'),
    (323,'1695031900'),
    (324,'1609364060'),
    (325,'2608321751'),
    (326,'2603594734'),
    (327,'2605111359'),
    (328,'1023023072'),
    (329,'1026042795'),
    (330,'1007236175'),
    (331,'1008885589'),
    (332,'1000090667'),
    (333,'1005212083'),
    (334,'1651276791'),
    (335,'1688004112'),
    (336,'2602880561'),
    (337,'1614127274'),
    (338,'1000054306'),
    (339,'1000090786'),
    (340,'1007206213'),
    (341,'2601147273'),
    (342,'1610590650'),
    (343,'1677419815'),
    (344,'1024029253'),
    (345,'1005358381'),
    (346,'1683631171'),
    (347,'1004856505'),
    (348,'2001582132'),
    (349,'2605850570'),
    (350,'1006504772'),
    (351,'1000049094'),
    (352,'1008237128'),
    (353,'2603726810'),
    (354,'1622506011'),
    (355,'1036508856'),
    (356,'1605745639'),
    (357,'1005860172'),
    (358,'1626447176'),
    (359,'1669486356'),
    (360,'1041824785'),
    (361,'1024495986'),
    (362,'2602510295'),
    (363,'1004985687'),
    (364,'1012232900'),
    (365,'1024376616'),
    (366,'2003018743'),
    (367,'1678266160'),
    (368,'1684492173'),
    (369,'1008089699'),
    (370,'2601080583'),
    (371,'2002158961'),
    (372,'2603299961'),
    (373,'1002958368'),
    (374,'1690369385'),
    (375,'1012804309'),
    (376,'1612762815'),
    (377,'1622027401'),
    (378,'1000171324'),
    (379,'1632286303'),
    (380,'1674855874'),
    (381,'1691026252'),
    (382,'1019656570'),
    (383,'1665262184'),
    (384,'2000747408'),
    (385,'1022610349'),
    (386,'1010738817'),
    (387,'2608862026'),
    (388,'2000828095'),
    (389,'2001326510'),
    (390,'2608186018'),
    (391,'1013077292'),
    (392,'1021928463'),
    (393,'1042641653'),
    (394,'2601699532'),
    (395,'1669111021'),
    (396,'1000045696'),
    (397,'2612574257'),
    (398,'2000384786'),
    (399,'1030902209'),
    (400,'1009769671'),
    (401,'1600750687'),
    (402,'1674971170'),
    (403,'1688920971'),
    (404,'1012095648'),
    (405,'1022128660'),
    (406,'1013832743'),
    (407,'1009282110'),
    (408,'1627893978'),
    (409,'1622340008'),
    (410,'2600724159'),
    (411,'1633770871'),
    (412,'1669548240'),
    (413,'1683890258'),
    (414,'2604673877'),
    (415,'1027553384'),
    (416,'1640258910'),
    (417,'2604320616'),
    (418,'1684963787'),
    (419,'2606781249'),
    (420,'1028959334'),
    (421,'1634664928'),
    (422,'2601345316'),
    (423,'1640111840'),
    (424,'1673980251'),
    (425,'1716918266'),
    (426,'1019026850'),
    (427,'1694709670'),
    (428,'1602597687'),
    (429,'1005796749'),
    (430,'1685797312'),
    (431,'2615662569'),
    (432,'2604399603'),
    (433,'1687569859'),
    (434,'1683078127'),
    (435,'1000047012'),
    (436,'1004392766'),
    (437,'2000427429'),
    (438,'1641583417'),
    (439,'1647752285'),
    (440,'1004167579'),
    (441,'1682960520'),
    (442,'1679206149'),
    (443,'1004302749'),
    (444,'1041644428'),
    (445,'1002945078'),
    (446,'1613647180'),
    (447,'1000069928'),
    (448,'2002845797'),
    (449,'1626791311'),
    (450,'1000200696'),
    (451,'1638862493'),
    (452,'1000048126'),
    (453,'1653793115'),
    (454,'1009649249'),
    (455,'1654864737'),
    (456,'1026086890'),
    (457,'1698489257'),
    (458,'1000202096'),
    (459,'1643910500'),
    (460,'1675152579'),
    (461,'1708904534'),
    (462,'1043929433'),
    (463,'2000824013'),
    (464,'1635014402'),
    (465,'1007887502'),
    (466,'2608962584'),
    (467,'1679378408'),
    (468,'1041834148'),
    (469,'2602296846'),
    (470,'2000630397'),
    (471,'1672149769'),
    (472,'1000057014'),
    (473,'1680350093'),
    (474,'2601742009'),
    (475,'1682621712'),
    (476,'1008554218'),
    (477,'1605863239'),
    (478,'1004576593'),
    (479,'1651728180'),
    (480,'1683028644'),
    (481,'1689761627'),
    (482,'1038931753'),
    (483,'1640782436'),
    (484,'1003637790'),
    (485,'2606518811'),
    (486,'1018129301'),
    (487,'2608468754'),
    (488,'1004446070'),
    (489,'1681427496'),
    (490,'1644312629'),
    (491,'1031166396'),
    (492,'1627588535'),
    (493,'1614068204'),
    (494,'1036021915'),
    (495,'1006339121'),
    (496,'1685960803'),
    (497,'2603073533'),
    (498,'1615068827'),
    (499,'1634199439'),
    (500,'1685997990'),
    (501,'2600291259'),
    (502,'1691927446'),
    (503,'1644940940'),
    (504,'1610472492'),
    (505,'1020643015'),
    (506,'1011686618'),
    (507,'1668629719'),
    (508,'2000711333'),
    (509,'1008816882'),
    (510,'1028731642'),
    (511,'1651547417'),
    (512,'1605627370'),
    (513,'1013157169'),
    (514,'1669532890'),
    (515,'1712652196'),
    (516,'1690560234'),
    (517,'1004258606'),
    (518,'1042897898'),
    (519,'1010963592'),
    (520,'1640163627'),
    (521,'2603829405'),
    (522,'1636555445'),
    (523,'1042947207'),
    (524,'2603283443'),
    (525,'1042409396'),
    (526,'1000214933'),
    (527,'1000081633'),
    (528,'1012238524'),
    (529,'1003316907'),
    (530,'1027294630'),
    (531,'2602101954'),
    (532,'1605719882'),
    (533,'2606169200'),
    (534,'1691420523'),
    (535,'2600006313'),
    (536,'1032767570'),
    (537,'1642272557'),
    (538,'1020187805'),
    (539,'1689467126'),
    (540,'1676230520'),
    (541,'1652175255'),
    (542,'1016874955'),
    (543,'1015842717'),
    (544,'1011252006'),
    (545,'1000023586'),
    (546,'1004685277'),
    (547,'1680587795'),
    (548,'1635702660'),
    (549,'1633803647'),
    (550,'1669367232'),
    (551,'1020465314'),
    (552,'1003317881'),
    (553,'2600291104'),
    (554,'2603661452'),
    (555,'1610638800'),
    (556,'2000476386'),
    (557,'1015957806'),
    (558,'1000026163'),
    (559,'1628702160'),
    (560,'1676042735'),
    (561,'1041843920'),
    (562,'1678324502'),
    (563,'1000202649'),
    (564,'1003520014'),
    (565,'1005209469'),
    (566,'1638439258'),
    (567,'1600424186'),
    (568,'2002653288'),
    (569,'2602937934'),
    (570,'1693849855'),
    (571,'2611119588'),
    (572,'1004903171'),
    (573,'1008346600'),
    (574,'1000051834'),
    (575,'1011154227'),
    (576,'1677698085'),
    (577,'1033114719'),
    (578,'1011384402'),
    (579,'1636679105'),
    (580,'1009602370'),
    (581,'1680831296'),
    (582,'1003197160'),
    (583,'1607662828'),
    (584,'1004934119'),
    (585,'1028649314'),
    (586,'1010139212'),
    (587,'1015526501'),
    (588,'1654051931'),
    (589,'1681034577'),
    (590,'1021719058'),
    (591,'1670374757'),
    (592,'1644768489'),
    (593,'1668887051'),
    (594,'2603963992'),
    (595,'1035610660'),
    (596,'1636296755'),
    (597,'1000029641'),
    (598,'1012346432'),
    (599,'1673771730'),
    (600,'1684626590'),
    (601,'1682427815'),
    (602,'2606134581'),
    (603,'1000258461'),
    (604,'2609681292'),
    (605,'1687635544'),
    (606,'1615944328'),
    (607,'1006078075'),
    (608,'1680696357'),
    (609,'2001604391'),
    (610,'1005013093'),
    (611,'1018921163'),
    (612,'1030322298'),
    (613,'1012832395'),
    (614,'2606366057'),
    (615,'1656559443'),
    (616,'1609471294'),
    (617,'1671243677'),
    (618,'1688689541'),
    (619,'2001980910'),
    (620,'1035157318'),
    (621,'1639055908'),
    (622,'1650582633'),
    (623,'1696816423'),
    (624,'2600672268'),
    (625,'1005595100'),
    (626,'1690140135'),
    (627,'1638282283'),
    (628,'1644909010'),
    (629,'1040846795'),
    (630,'2601363035'),
    (631,'1684767720'),
    (632,'1689505174'),
    (633,'1609029227'),
    (634,'1694371583'),
    (635,'1038591133'),
    (636,'1676416613'),
    (637,'1000117840'),
    (638,'1685933303'),
    (639,'1026504954'),
    (640,'1004701122'),
    (641,'2603578219'),
    (642,'2002417747'),
    (643,'1000050930'),
    (644,'1682735706'),
    (645,'2002552798'),
    (646,'2600216724'),
    (647,'1600369385'),
    (648,'1000099068'),
    (649,'1000078206'),
    (650,'1691018240'),
    (651,'1690460047'),
    (652,'1045263542'),
    (653,'1000248123'),
    (654,'2601205558'),
    (655,'1018573481'),
    (656,'1009272740'),
    (657,'1028861963'),
    (658,'1687190303'),
    (659,'1039846845'),
    (660,'1696472460'),
    (661,'1634020705'),
    (662,'1670575417'),
    (663,'2604379547'),
    (664,'1000199337'),
    (665,'2001460740'),
    (666,'1680607305'),
    (667,'1690379270'),
    (668,'1017947605'),
    (669,'2003168169'),
    (670,'1610412178'),
    (671,'1631510697'),
    (672,'1003213091'),
    (673,'1644648481'),
    (674,'1681463804'),
    (675,'1011203884'),
    (676,'2612629716'),
    (677,'1009234175'),
    (678,'1000090544'),
    (679,'1645478135'),
    (680,'1037534898'),
    (681,'1005654966'),
    (682,'1004675650'),
    (683,'1000023610'),
    (684,'1697674873'),
    (685,'1042237007'),
    (686,'1000023087'),
    (687,'1652412480'),
    (688,'1669656523'),
    (689,'1005774590'),
    (690,'1041942830'),
    (691,'1024387580'),
    (692,'1681610364'),
    (693,'1673608921'),
    (694,'1673882048'),
    (695,'1038686569'),
    (696,'1689207524'),
    (697,'1006723610'),
    (698,'2600703702'),
    (699,'1696688030'),
    (700,'1010600169'),
    (701,'1015137327'),
    (702,'1000056469'),
    (703,'1633336022'),
    (704,'1622248949'),
    (705,'1009850063'),
    (706,'1679605257'),
    (707,'1633726933'),
    (708,'1041692874'),
    (709,'1000026995'),
    (710,'1006141454'),
    (711,'1612179269'),
    (712,'1687482968'),
    (713,'1612175811'),
    (714,'1022162835'),
    (715,'1026864979'),
    (716,'2002173542'),
    (717,'1612498121'),
    (718,'1031948091'),
    (719,'2609959264'),
    (720,'1684697492'),
    (721,'1610498016'),
    (722,'1684871029'),
    (723,'1691415716'),
    (724,'1697673874'),
    (725,'1004045675'),
    (726,'2610273762'),
    (727,'1651491527'),
    (728,'1650065199'),
    (729,'1022074224'),
    (730,'1043737676'),
    (731,'1668828745'),
    (732,'1008459753'),
    (733,'1006812554'),
    (734,'1671833045'),
    (735,'1013342257'),
    (736,'1006244175'),
    (737,'1033029299'),
    (738,'1004167029'),
    (739,'1638016065'),
    (740,'1008328983'),
    (741,'1007221971'),
    (742,'1643847187'),
    (743,'1019662780'),
    (744,'1684503898'),
    (745,'1685533863'),
    (746,'1025558420'),
    (747,'1655397678'),
    (748,'1677807844'),
    (749,'1005370460'),
    (750,'1641721151'),
    (751,'2000551847'),
    (752,'1639022906'),
    (753,'1034926926'),
    (754,'1693394914'),
    (755,'1684971818'),
    (756,'1004529557'),
    (757,'1634635374'),
    (758,'1612538093'),
    (759,'2610070636'),
    (760,'1637745134'),
    (761,'1645847513'),
    (762,'1641750137'),
    (763,'2600958504'),
    (764,'1004302167'),
    (765,'1616148343'),
    (766,'1004564815'),
    (767,'1000122231'),
    (768,'1006757059'),
    (769,'1005070656'),
    (770,'1024992047'),
    (771,'1672290759'),
    (772,'2002743378'),
    (773,'1642718611'),
    (774,'1003408691'),
    (775,'1630432876'),
    (776,'1621567125'),
    (777,'1006546420'),
    (778,'1609496062'),
    (779,'1613647765'),
    (780,'1607827550'),
    (781,'1627266131'),
    (782,'1654999541'),
    (783,'1007667292'),
    (784,'1021929417'),
    (785,'1003822244'),
    (786,'1637158106'),
    (787,'2000953380'),
    (788,'1655326097'),
    (789,'1008271292'),
    (790,'1680794052'),
    (791,'1603808511'),
    (792,'1024716490'),
    (793,'1613722885'),
    (794,'1606955936'),
    (795,'1656061907'),
    (796,'1005863434'),
    (797,'1000044997'),
    (798,'1636409558'),
    (799,'1653735432'),
    (800,'1043315108'),
    (801,'1000288004'),
    (802,'1672209604'),
    (803,'1000083363'),
    (804,'2607263700'),
    (805,'1044447015'),
    (806,'1009905352'),
    (807,'1673197087'),
    (808,'1606117891'),
    (809,'1004839591'),
    (810,'1668905584'),
    (811,'1680834794'),
    (812,'1033076521'),
    (813,'1022990995'),
    (814,'1008322631'),
    (815,'2600420853'),
    (816,'1010566643'),
    (817,'1042681839'),
    (818,'1677856046'),
    (819,'1679399736'),
    (820,'1000246027'),
    (821,'1689824934'),
    (822,'2602143711'),
    (823,'2601685802'),
    (824,'1602645697'),
    (825,'1000168348'),
    (826,'1007753317'),
    (827,'1707777991'),
    (828,'1035178188'),
    (829,'1000051716'),
    (830,'1018110194'),
    (831,'1650726827'),
    (832,'1007909886'),
    (833,'1012006550'),
    (834,'2000590459'),
    (835,'1022886920'),
    (836,'1656385570'),
    (837,'1651906903'),
    (838,'1023052548'),
    (839,'1673499875'),
    (840,'1000062616'),
    (841,'1693400844'),
    (842,'2602231514')
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_01 AS
SELECT  A.party_id      --DY1005609827
        ,A.objorgankey
        ,A.manager_no
        ,A.manager_name
FROM    ADM_UPSS.adm_upss_aml_t47_individual A
WHERE   A.DT = '@@{yyyyMMdd}'
UNION
SELECT  A.party_id
        ,A.objorgankey
        ,A.manager_no
        ,A.manager_name
FROM    ADM_UPSS.adm_upss_aml_t47_corporation A
WHERE   A.DT = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_02 AS
SELECT  party_id    --DY1602431737
       ,COUNT(DISTINCT A.transactionkey) AS 交易笔数
       ,SUM(CNY_amt)                     AS 交易金额
FROM ADM_UPSS.ADM_UPSS_AML_T47_TRANSACTION A
WHERE DT <= '20241231'
AND DT >= '20230101'
and substr(a.party_id,3) in(
    SELECT cst_id
    FROM SJXQ_SJ20250218106_CST2_08
)
GROUP BY  party_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_03 AS
SELECT  A.cst_no                     AS 客户号  --ZH1035346798
       ,COUNT(DISTINCT A.JUDICIAL_BRANCH) AS 公安查询渠道数
       ,''      AS 公安查询机构数
       ,COUNT(1)                          AS 公安查询次数
       ,max(a.qfd_date) as max_qfd_date
FROM adm_upss.AML_T3R_QRY_FRZ_DDCT_LST A
WHERE A.DT = '@@{yyyyMMdd-3d}'
AND A.qfd_date <= '20241231'
AND A.qfd_date >= '20230101'
GROUP BY A.cst_no
;
/*
SELECT  T1.qry_ctrl_chnl_nm AS 查控渠道名称
        ,T4.cd_val_dscr     AS 有权机关类型
        ,T1.exe_rsn          AS 执行原因
        ,T1.instt_nm         AS 有权机关名称
        ,T1.law_doc_id       AS 法律文书编号
        ,T1.law_doc_nm       AS 法律文书名称
        ,T1.qry_ctrl_dt      AS 查控日期
        ,T1.qry_ctrl_tm      AS 查控时间
        ,T1.qry_ctrl_typ_nm  AS 查控类型代码
        ,T1.cst_id           AS 客户号
        ,T1.cst_nm           AS 客户名称
        ,CASE
           WHEN T1.CST_TYP_CD = '1' THEN '对私'
           WHEN T1.CST_TYP_CD = '2' THEN '对公'
         END                 AS 公私标识
        ,T1.cst_doc_typ_cd   AS 客户证件类型
        ,T1.cst_doc_nbr      AS 客户证件号码
        ,T1.cst_act_id       AS 客户账号
        ,T2.prm_org_id       AS 客户归属机构ID
        ,T2.prm_org_nm       AS 客户归属机构
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd T1
WHERE   T1.dt = '@@{yyyyMMdd}'
AND     T1.qry_ctrl_dt between '20230101' and '20241231'
AND     T1.qry_ctrl_typ_nm IN ( '查询' , '冻结' , '划扣' )
AND     ( T1.instt_typ_cd IN ( '04' , '05' )
    OR ( ( T1.instt_nm LIKE '%法院%'
    OR T1.instt_typ_cd = '01' )
AND     T1.LAW_DOC_ID LIKE '%刑%' ) )
;
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_04 AS
SELECT  cst_no          --ZH1013290679
       ,self_acc_name
       ,id_no
       ,risk_code
       ,dt_time AS time
FROM adm_upss.AML_T3R_RISK_NEW
WHERE DT = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_05 AS
SELECT  B.PARTY_ID
       ,CASE WHEN A.CSNM IS NOT NULL THEN 'Y'  ELSE '' END AS IS_KY
FROM ADM_UPSS.ADM_UPSS_AML_T47_CP_DEPOSIT B
LEFT JOIN ADM_UPSS.AML_T3B_SEIF_N_HST A
ON A.CSNM = B.PARTY_ID AND A.DT = '@@{yyyyMMdd}'
WHERE B.DT = '@@{yyyyMMdd}'
GROUP BY  B.PARTY_ID
         ,A.CSNM
UNION
SELECT  B.PARTY_ID
       ,CASE WHEN A.CSNM IS NOT NULL THEN 'Y'  ELSE '' END AS IS_KY
FROM ADM_UPSS.ADM_UPSS_AML_T47_ID_DEPOSIT B
LEFT JOIN ADM_UPSS.AML_T3B_SEIF_N_HST A
ON A.CSNM = B.PARTY_ID AND A.DT = '@@{yyyyMMdd}'
WHERE B.DT = '@@{yyyyMMdd}'
GROUP BY  B.PARTY_ID
         ,A.CSNM
;
/*
SELECT LENGTH(party_id) l,count(1)
from SJXQ_SJ20250218106_CST2_05
GROUP BY l
;
0	1
2	1
7	3
8	47
9	36
12	9160402
18	1103
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_06 AS
SELECT  substr(a.party_id,3)      AS 客户号
       ,t3.reg_cpt       AS 注册资本
       ,t3.opr_scp_dscr  AS 经营范围描述
       ,C.self_acc_name AS 客户名称
       ,a.交易笔数
       ,a.交易金额
       ,b.公安查询次数
       ,b.公安查询渠道数
       ,b.公安查询机构数
       ,c.risk_code     AS 评级风险等级CD
       ,CASE WHEN c.risk_code = '10' THEN '高风险'
             WHEN c.risk_code = '11' THEN '较高风险'
             WHEN c.risk_code = '12' THEN '一般风险'
             WHEN c.risk_code = '13' THEN '较低风险'
             WHEN c.risk_code = '14' THEN '低风险' END 评级风险等级
       ,c.time                                                   AS 最后评级时间
       ,D.IS_KY                                                  AS 是否报可疑
       ,D.ORGANKEY                                               AS 账户所属机构
       ,t4.brc_org_nm                                            AS 账户所属分行
       ,t4.sbr_org_nm                                            AS 账户所属支行
       ,F.objorgankey                                            AS 所属支行
       ,F.manager_no                                             AS 管护工号
       ,F.manager_name                                           AS 管护姓名
       ,CASE WHEN t5.party_id IS NOT NULL THEN '是'  ELSE '否' END AS 是否有未结清信贷业务
       ,t6.DEP_BAL_MON_AVG                                       AS 当前月日均存款
       ,t7.own_empe_ind	as 	本行员工标志
FROM SJXQ_SJ20250218106_CST2_02 a
LEFT JOIN SJXQ_SJ20250218106_CST2_03 b
ON a.party_id = b.客户号
LEFT JOIN SJXQ_SJ20250218106_CST2_04 c
ON a.party_id = c.cst_no
LEFT JOIN SJXQ_SJ20250218106_CST2_05 D
ON A.party_id = D.PARTY_ID
LEFT JOIN edw.dim_cst_entp_bas_inf_dd t3 --企业客户基本信息
ON substr(a.party_id,3) = t3.cst_id AND t3.dt = '@@{yyyyMMdd}'
LEFT JOIN SJXQ_SJ20250218106_CST2_01 F
ON A.party_id = F.party_id
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
ON F.objorgankey = t4.org_id AND t4.dt = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  DISTINCT PARTY_ID
	FROM adm_upss.ADM_UPSS_AML_T47_LOAN_ACCT
	WHERE DT = '@@{yyyyMMdd}'
	AND ( CLOSE_DT <> '' OR ACCT_STATUS_CD = '1' )
) t5
ON a.party_id = t5.party_id
LEFT JOIN adm_pub.ADM_CSM_CBUS_DEP_INF_DD t6
ON substr(a.party_id,3) = t6.CST_ID
AND t6.DT = '@@{yyyyMMdd}'
left join edw.dws_cst_idv_bas_inf_dd    t7 --个人客户基本信息汇总表
on substr(a.party_id,3)=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
-- 客户号	结算账户	账户状态（正常\销户\不动户\转营业外等）	账户管控状态（暂停非柜、止付等）	日累计非柜额度
DROP   TABLE IF     EXISTS SJXQ_SJ20250218106_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250218106_CST2_07 AS
SELECT  t1.cst_id      AS 客户号
       ,t2.cst_act_id  AS 客户账号
       ,t2.dep_act_id  as 存款账号
       ,t2.act_sts_cd  AS 账户状态代码
       ,c1.cd_val_dscr AS 账户状态
       ,CASE WHEN t3.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否账户止付
       ,CASE WHEN t4.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否账户冻结
       ,CASE WHEN t5.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否暂停非柜面
       ,t6.fg_day_lmt                                             AS 日累计非柜限额
        ,t7.own_empe_ind	as 	本行员工标志
FROM (
    SELECT DISTINCT cst_id
    from SJXQ_SJ20250218106_CST2_08
)t1
left join edw.dim_bus_dep_act_inf_dd    t2 --存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.stl_act_ind='1'   --结算账户
left join edw.dwd_code_library_dd   c1
on t2.act_sts_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
left join(
    SELECT  distinct t1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='2'  --账户止付
    AND     t1.NFRZ_IND = '0'
)t3 on t2.cst_act_id=t3.cst_act_id
left join(
    SELECT  distinct t1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='1'  --账户冻结
    AND     t1.NFRZ_IND = '0'
)t4 on t2.cst_act_id=t4.cst_act_id
left join(
    SELECT  distinct cst_act_id
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '@@{yyyyMMdd}'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t5 on t2.cst_act_id=t5.cst_act_id
left join(
    SELECT  cengcgjz    cst_act_id
        ,leijiedu   fg_day_lmt
    FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
    WHERE   dt = '@@{yyyyMMdd}'
    AND     zhxeleix = '2'
    AND     shijbhao = 'FGMXIANE' -- 非柜面限额
    AND     edkzzhqi = '1D'
)t6 on t2.cst_act_id=t6.cst_act_id
left join edw.dws_cst_idv_bas_inf_dd    t7 --个人客户基本信息汇总表
on t1.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20250218106_CST2_06
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20250218106_CST2_07
;
SElECT '01' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ20250218106_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ20250218106_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250218106_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_no) custs
from SJXQ_SJ20250218106_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct party_id) custs
from SJXQ_SJ20250218106_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250218106_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ20250218106_CST2_07
;
/*
01	9508878	9508878
02	845	845
03	61119	61119
04	9486705	9486705
05	9180214	9180214
06	845	842
07	8475	8474
*/
***於挺_SJ2025041711_产品洗钱风险评估.sql
﻿-- 於挺010805-产品洗钱风险评估
-- SJ2025041711
/*
1. 客户数不含村行？不含
2. 交易金额是否为客户交易表交易金额？单位万？不是
3. 信息不完善需要剔除 不收不付标识，只收不付标志，暂停非柜面，销户？客户维度，不用剔
*/
-- 截至20250529日查冻扣客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025041711_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041711_CST_00 AS
SELECT distinct aa.cst_id
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
WHERE aa.dt = '20250529'
-- AND qry_ctrl_dt between '20240529' and '20250529'
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) )
;
--通用：主管户为泰隆银行的客户，对应的客户账号、存款账号
DROP   TABLE IF     EXISTS SJXQ_SJ2025041711_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041711_CST_01 AS
SELECT  t1.cst_id
        ,t4.cst_typ_cd --	客户类型|C1
        ,t1.prm_mgr_id
        ,t1.prm_mgr_nm
        ,t1.prm_org_id
        ,t1.prm_org_nm
FROM    adm_pub.adm_csm_cbas_mng_inf_dd         t1 --客户管户信息
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd    t2 --机构树
ON      t1.prm_org_id = t2.org_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
LEFT JOIN    edw.dws_cst_bas_inf_dd             t4
ON      t1.cst_id = t4.cst_id
AND     t4.dt = '@@{yyyyMMdd}'
WHERE   t1.dt = '@@{yyyyMMdd}'
;
-- 截至目前，较高风险、高风险客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025041711_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041711_CST_02 AS
select cst_id
from(
    SELECT substr(t2.party_id,3,12)  AS cst_id
        ,t2.levelkey
        ,t2.rcheck_dt
        ,ROW_NUMBER() OVER ( PARTITION BY substr(t2.party_id,3,12) ORDER BY  t2.statistic_dt DESC ) AS rn
        ,t2.statistic_dt
    FROM adm_upss.aml_t37_party_result_curr t2
    WHERE t2.dt = '@@{yyyyMMdd}'
)t1 where rn=1
;
-- 国籍、名称、性别、证件类型、证件号码、证件有效期、职业、联系方式（联系电话手机号码均无）、地址（户籍地址、居住地址、单位地址均无）
-- 个人客户身份信息不完善的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025041711_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041711_CST_03 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户中文名称|C200
	,t1.gdr_cd                                   --性别代码|C1
	,t1.ntn_cd                                   --国籍代码|C3
	,t1.ocp_cd                                   --职业代码|C5
	,t2.doc_nbr                                  --证件号码|C60
	,t2.doc_typ_cd                               --证件类型代码|C5
	,t2.doc_mtu_dt                               --证件到期日期|C8
	,t2.mbl_nbr                                  --手机|C32
	,t2.fml_tel_nbr                              --家庭电话|C32
	,t2.reg_adr                                  --户籍地址|注册地址|C256
	,t2.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t2.fml_adr                                  --家庭地址|C256
    ,case when length(t2.mbl_nbr) + length(t2.fml_tel_nbr) = 0 then '联系方式为空'
        when length(t2.reg_adr) + length(t2.wrk_adr) + length(t2.fml_adr) = 0 then '地址为空'
        when nvl(t1.ocp_cd,'')='' then '职业为空'
        else '' end as null_type
from edw.dim_cst_idv_bas_inf_dd     t1 --个人客户基本信息
INNER JOIN edw.dws_cst_bas_inf_dd   t2 --客户基础信息汇总表 证件号及到期日
ON t1.cst_id = t2.cst_id
AND t2.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
AND (nvl(t1.ntn_cd,'')='' or nvl(t1.cst_chn_nm,'')='' or nvl(t1.gdr_cd,'')='' or nvl(t2.doc_typ_cd,'')='' or nvl(t2.doc_nbr,'')=''
    or nvl(t2.doc_mtu_dt,'')='' or nvl(t1.ocp_cd,'')='' or length(t2.mbl_nbr) + length(t2.fml_tel_nbr) = 0
    or length(t2.reg_adr) + length(t2.wrk_adr) + length(t2.fml_adr) = 0)
;
-- 名称、住所、经营范围、可证明该客户依法设立或者可依法开展经营、社会活动的执照、证件或者文件的名称、号码和有效期限；
-- 法定代表人或负责人和授权办理业务人员的姓名、身份证件或者身份证明文件的种类、号码、有效期限；
-- 受益所有人的姓名、地址、身份证件或者身份证明文件的种类、号码、有效期限，有一项缺失的。
-- 鲤想财资客户包括主管客户和成员客户。
-- 公司客户身份信息不完善的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025041711_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041711_CST_04 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.opr_scp_dscr                             --经营范围描述|C3000
	-- ,t1.lctax_cert_no                            --地税证件号|C60
	,t2.doc_nbr                                  --证件号码|C60
	,t2.doc_typ_cd                               --证件类型代码|C5
	,t2.doc_mtu_dt                               --证件到期日期|C8
	,t2.reg_adr                                  --户籍地址|注册地址|C256
	,t2.wrk_adr                                  --工作单位地址|经营所在地地址|C256
    ,b1.cst_chn_nm     AS fr_cst_chn_nm      --法定代表人
    ,b1.prm_doc_typ_cd AS fr_prm_doc_typ_cd  --法人证件类型
    ,b1.prm_doc_nbr    AS fr_prm_doc_nbr     --法人证件号
    ,b1.prm_doc_mtu_dt AS fr_prm_doc_mtu_dt  --法人证件到期日
    -- ,b2.cst_chn_nm     AS sk_cst_chn_nm      --实控人名称
    -- ,b2.prm_doc_typ_cd AS sk_prm_doc_typ_cd  --法人证件类型
    -- ,b2.prm_doc_nbr    AS sk_prm_doc_nbr     --实控人证件号码
    -- ,b2.prm_doc_mtu_dt AS sk_prm_doc_mtu_dt  --实控人证件到期日
    -- ,t3.sy_cst_chn_nm      --受益人名称
    -- ,t3.sy_prm_doc_typ_cd  --受益人证件类型
    -- ,t3.sy_prm_doc_nbr     --受益人证件号码
    -- ,t3.sy_prm_doc_mtu_dt  --受益人证件到期日
    ,t3.sy_isnull
    ,case when t3.sy_isnull=1 then '受益人为空' else '' end as isnull_type
from edw.dim_cst_entp_bas_inf_dd    t1 --企业客户基本信息
INNER JOIN edw.dws_cst_bas_inf_dd   t2 --客户基础信息汇总表 证件号及到期日
ON t1.cst_id = t2.cst_id
AND t2.dt = t1.dt
LEFT JOIN edw.dim_cst_rel_inf_dd a1 --客户关联关系信息
ON t1.cst_id = a1.cst_id AND a1.dt = t1.dt AND a1.rel_typ_cd = '0101' --法人 唯一
and LENGTH(a1.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b1 --客户基本信息
ON a1.rel_cst_id = b1.cst_id AND b1.dt = t1.dt
-- LEFT JOIN edw.dim_cst_rel_inf_dd a2 --客户关联关系信息
-- ON t1.cst_id = a2.cst_id AND a2.dt = t1.dt AND a2.rel_typ_cd = '0109' --实控人
-- and LENGTH(a2.rel_cst_id)=10
-- LEFT JOIN edw.dim_cst_bas_inf_dd b2 --客户基本信息
-- ON a2.rel_cst_id = b2.cst_id AND b2.dt = t1.dt
LEFT JOIN (
    SELECT a3.cst_id
        -- ,b3.cst_chn_nm     AS sy_cst_chn_nm
        -- ,b3.prm_doc_typ_cd AS sy_prm_doc_typ_cd
        -- ,b3.prm_doc_nbr    AS sy_prm_doc_nbr
        -- ,b3.prm_doc_mtu_dt AS sy_prm_doc_mtu_dt
        ,min(case when nvl(b3.cst_chn_nm,'')='' or nvl(b3.prm_doc_typ_cd,'')='' or nvl(b3.prm_doc_nbr,'')='' or nvl(b3.prm_doc_mtu_dt,'')='' then 1
            else 0 end) as sy_isnull
    from edw.dim_cst_rel_inf_dd         a3 --客户关联关系信息
    LEFT JOIN edw.dim_cst_bas_inf_dd    b3 --客户基本信息
    ON a3.rel_cst_id = b3.cst_id
    AND b3.dt = a3.dt
    where a3.dt = '@@{yyyyMMdd}'
    AND a3.rel_typ_cd LIKE '09%' --受益人
    and LENGTH(a3.rel_cst_id)=10
    GROUP BY a3.cst_id
)t3 ON t1.cst_id = t3.cst_id
where t1.dt='@@{yyyyMMdd}'
AND (nvl(t1.cst_nm,'')='' or nvl(t1.opr_scp_dscr,'')='' or nvl(t2.doc_typ_cd,'')='' or nvl(t2.doc_nbr,'')=''
    or nvl(t2.doc_mtu_dt,'')='' or length(t2.reg_adr) + length(t2.wrk_adr) = 0
    or nvl(b1.cst_chn_nm,'')='' or nvl(b1.prm_doc_typ_cd,'')='' or nvl(b1.prm_doc_nbr,'')='' or nvl(b1.prm_doc_mtu_dt,'')=''
    or t3.sy_isnull=1)  --一个受益人4要素非空，则受益人要素完整
;
-- 1. 大宗商品现货清算 未入仓
-- 2. 鲤想财资	小企业部
SELECT '鲤想财资-截至2023年底' as ind,count(DISTINCT t1.cust_id) as 客户数
FROM    app_rpt.fct_bus_whl_ctms_cust_info_dd t1 --鲤想财资客户信息表
INNER JOIN    SJXQ_SJ2025041711_CST_01 t2
ON      t1.cust_id = t2.cst_id
WHERE   t1.dt = '20241231'
and t1.corp_sign_dt<='20231231'
union all
SELECT '鲤想财资-截至2024年底' as ind,count(DISTINCT t1.cust_id) as 客户数
    ,count(t3.cst_id)   as 截至20250529日查冻扣客户
FROM    app_rpt.fct_bus_whl_ctms_cust_info_dd t1 --鲤想财资客户信息表
INNER JOIN    SJXQ_SJ2025041711_CST_01 t2
ON      t1.cust_id = t2.cst_id
left join SJXQ_SJ2025041711_CST_00 t3
on t1.cust_id=t3.cst_id
WHERE   t1.dt = '20241231'
and t1.corp_sign_dt<='20241231'
;
SELECT '鲤想财资-2023年' as ind,sum(t4.trx_amt) as 交易金额
FROM app_rpt.fct_bus_whl_ctms_cust_info_dd  t1 --鲤想财资客户信息表
INNER JOIN    SJXQ_SJ2025041711_CST_01      t2
ON      t1.cust_id = t2.cst_id
inner join edw.dws_bus_dep_act_inf_dd       t3 --存款账户信息汇总
on t2.cst_id=t3.cst_id
and t3.dt=t1.dt
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细表
on  t3.dep_act_id=t4.dep_act_id
and t4.dt between '20230101' and '20231231'
and t4.bal_fld_nm = 'DPLDGBAL' --动账
WHERE t1.dt = '20241231'
and t1.corp_sign_dt<='20231231'
union all
SELECT '鲤想财资-2024年' as ind,sum(t4.trx_amt) as 交易金额
FROM app_rpt.fct_bus_whl_ctms_cust_info_dd  t1 --鲤想财资客户信息表
INNER JOIN    SJXQ_SJ2025041711_CST_01      t2
ON      t1.cust_id = t2.cst_id
inner join edw.dws_bus_dep_act_inf_dd       t3 --存款账户信息汇总
on t2.cst_id=t3.cst_id
and t3.dt=t1.dt
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细表
on  t3.dep_act_id=t4.dep_act_id
and t4.dt between '20240101' and '20241231'
and t4.bal_fld_nm = 'DPLDGBAL' --动账
WHERE t1.dt = '20241231'
;
-- 截至目前，较高风险、高风险客户在客户总量中的占比
SELECT '鲤想财资' as ind
    ,count(DISTINCT t3.cst_id) as 截至目前较高风险及以上客户数
    ,count(DISTINCT t3.cst_id)/count(t2.cst_id) as 截至目前较高风险及以上客户数占比
    ,count(DISTINCT t4.cst_id) as 截至目前个人客户身份信息不完善的客户数
    ,count(DISTINCT t5.cst_id) as 截至目前公司客户身份信息不完善的客户数
FROM app_rpt.fct_bus_whl_ctms_cust_info_dd t1 --鲤想财资客户信息表
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cust_id = t2.cst_id
left join SJXQ_SJ2025041711_CST_02      t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2025041711_CST_03      t4
on t2.cst_id=t4.cst_id
left join SJXQ_SJ2025041711_CST_04      t5
on t2.cst_id=t5.cst_id
WHERE   t1.dt = '@@{yyyyMMdd}'
;
-- 3. 外汇衍生品
-- 分子：xfunds系统中外汇远期、掉期、期权交易客户数。
-- 先把清单取出来，关键字段为：客户号、交易日期、折美元金额，检查是否要折人民币？
DROP   TABLE IF     EXISTS SJXQ_SJ2025041711_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041711_CST_05 AS
SELECT  customerid AS CST_ID
        ,usdamount AS JE
        ,tradedate AS RQ
        ,cnyamt	    --	折人民币金额
FROM    edw.xfunds_xfunds_forex_fwdtrade --代客远期交易表
WHERE   DT = '@@{yyyyMMdd}'
AND     tradestatus = 0 --交易状态(0-正常 1-撤消)
UNION
SELECT  customerid    AS CST_ID
        ,rptusdamount AS JE
        ,tradedate    AS RQ
        ,cnyamt	    --	折人民币金额
FROM    edw.xfunds_xfunds_forex_swaptrade --代客掉期交易表
WHERE   DT = '@@{yyyyMMdd}'
AND     tradestatus = 0 --交易状态(0-正常 1-撤消)
;
select '外汇衍生品' as ind
    ,count(distinct case when rq<=20231231 then t1.cst_id end) as 截至2023年底客户数
    ,count(distinct case when rq<=20241231 then t1.cst_id end) as 截至2024年底客户数
    ,count(distinct case when rq<=20241231 then t3.cst_id end) as 截至20250529日查冻扣客户
    ,sum(case when rq between 20230101 and 20231231 then t1.je else 0 end) as 2023年交易金额_折美元金额
    ,sum(case when rq between 20240101 and 20241231 then t1.je else 0 end) as 2024年交易金额_折美元金额
from SJXQ_SJ2025041711_CST_05       t1
INNER JOIN SJXQ_SJ2025041711_CST_01 t2
ON t1.CST_ID = t2.cst_id
left join SJXQ_SJ2025041711_CST_00 t3
on t1.cst_id=t3.cst_id
;
-- 截至目前，较高风险、高风险客户在客户总量中的占比
SELECT '外汇衍生品' as ind
    ,count(DISTINCT t3.cst_id) as 截至目前较高风险及以上客户数
    ,count(DISTINCT t3.cst_id)/count(t2.cst_id) as 截至目前较高风险及以上客户数占比
    ,count(DISTINCT t4.cst_id) as 截至目前个人客户身份信息不完善的客户数
    ,count(DISTINCT t5.cst_id) as 截至目前公司客户身份信息不完善的客户数
FROM (
    select distinct cst_id
    from SJXQ_SJ2025041711_CST_05
) t1
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
left join SJXQ_SJ2025041711_CST_02      t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2025041711_CST_03      t4
on t2.cst_id=t4.cst_id
left join SJXQ_SJ2025041711_CST_04      t5
on t2.cst_id=t5.cst_id
;
-- 4. 个人存款联名账户
SELECT  '个人存款联名账户-截至2023年底' as ind
    ,COUNT(DISTINCT t2.cst_id) as 客户数
FROM edw.core_kcpb_lmzhzb            t1
INNER JOIN SJXQ_SJ2025041711_CST_01  t2
ON      t1.kehuhaoo = t2.cst_id
WHERE   t1.DT = '20231231'
AND     t1.qyueztai = '1' --签约状态
union all
SELECT  '个人存款联名账户-截至2024年底' as ind
    ,COUNT(DISTINCT t2.cst_id) as 客户数
    ,COUNT(DISTINCT t3.cst_id) as 截至20250529日查冻扣客户
FROM edw.core_kcpb_lmzhzb            t1
INNER JOIN SJXQ_SJ2025041711_CST_01  t2
ON      t1.kehuhaoo = t2.cst_id
left join SJXQ_SJ2025041711_CST_00 t3
on t1.kehuhaoo=t3.cst_id
WHERE   t1.DT = '20241231'
AND     t1.qyueztai = '1' --签约状态
;
SELECT  '个人存款联名账户-2023年' as ind,sum(t4.trx_amt) as 交易金额
FROM edw.core_kcpb_lmzhzb            t1     --kehuzhao 要检查是否唯一？
INNER JOIN SJXQ_SJ2025041711_CST_01  t2
ON      t1.kehuhaoo = t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细表
on  t1.kehuzhao=t4.cst_act_id
and t4.dt between '20230101' and '20231231'
and t4.bal_fld_nm = 'DPLDGBAL' --动账
WHERE   t1.DT = '20231231'
AND     t1.qyueztai = '1' --签约状态
union all
SELECT  '个人存款联名账户-2024年' as ind,sum(t4.trx_amt) as 交易金额
FROM edw.core_kcpb_lmzhzb            t1
INNER JOIN SJXQ_SJ2025041711_CST_01  t2
ON      t1.kehuhaoo = t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细表
on  t1.kehuzhao=t4.cst_act_id
and t4.dt between '20240101' and '20241231'
and t4.bal_fld_nm = 'DPLDGBAL' --动账
WHERE   t1.DT = '20241231'
AND     t1.qyueztai = '1' --签约状态
;
-- 截至目前，较高风险、高风险客户在客户总量中的占比
SELECT '个人存款联名账户' as ind
    ,count(DISTINCT t3.cst_id) as 截至目前较高风险及以上客户数
    ,count(DISTINCT t3.cst_id)/count(t2.cst_id) as 截至目前较高风险及以上客户数占比
    ,count(DISTINCT t4.cst_id) as 截至目前个人客户身份信息不完善的客户数
    ,count(DISTINCT t5.cst_id) as 截至目前公司客户身份信息不完善的客户数
FROM (
    select distinct kehuhaoo as cst_id
    from edw.core_kcpb_lmzhzb
    WHERE DT = '@@{yyyyMMdd}'
    AND   qyueztai = '1' --签约状态
) t1
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
left join SJXQ_SJ2025041711_CST_02      t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2025041711_CST_03      t4
on t2.cst_id=t4.cst_id
left join SJXQ_SJ2025041711_CST_04      t5
on t2.cst_id=t5.cst_id
;
--5. 备用金贷款
SELECT  '备用金贷款-截至2023年底' as ind,count(DISTINCT t1.cst_id) as 客户数
FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD    t1 --合同基础信息
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
WHERE t1.dt = '20231231'
AND t1.PRD_NO IN ( '2001010101004' , '2001020101004' )
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
SELECT  '备用金贷款-截至2024年底' as ind,count(DISTINCT t1.cst_id) as 客户数
    ,count(DISTINCT t3.cst_id) as 截至20250529日查冻扣客户
FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD    t1 --合同基础信息
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
left join SJXQ_SJ2025041711_CST_00 t3
on t1.cst_id=t3.cst_id
WHERE t1.dt = '20241231'
AND t1.PRD_NO IN ( '2001010101004' , '2001020101004' )
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
SELECT  '备用金贷款-2023年' as ind,sum(t3.amt) as 交易金额
FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD    t1 --合同基础信息
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
inner join edw.dim_bus_loan_dbil_inf_dd t3 --信贷借据信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt = t1.dt
and t3.LVE_ACT_BGN_DT between '20230101' and '20231231'
WHERE t1.dt = '20231231'
AND t1.PRD_NO IN ( '2001010101004' , '2001020101004' )
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
union all
SELECT  '备用金贷款-2024年' as ind,sum(t3.amt) as 交易金额
FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD    t1 --合同基础信息
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
inner join edw.dim_bus_loan_dbil_inf_dd t3 --信贷借据信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt = t1.dt
and t3.LVE_ACT_BGN_DT between '20240101' and '20241231'
WHERE t1.dt = '20241231'
AND t1.PRD_NO IN ( '2001010101004' , '2001020101004' )
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 截至目前，较高风险、高风险客户在客户总量中的占比
SELECT '备用金贷款' as ind
    ,count(DISTINCT t3.cst_id) as 截至目前较高风险及以上客户数
    ,count(DISTINCT t3.cst_id)/count(t2.cst_id) as 截至目前较高风险及以上客户数占比
    ,count(DISTINCT t4.cst_id) as 截至目前个人客户身份信息不完善的客户数
    ,count(DISTINCT t5.cst_id) as 截至目前公司客户身份信息不完善的客户数
FROM (
    select distinct t1.cst_id
    from edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t1
    WHERE t1.DT = '@@{yyyyMMdd}'
    AND t1.PRD_NO IN ( '2001010101004' , '2001020101004' )
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
) t1
INNER JOIN    SJXQ_SJ2025041711_CST_01  t2
ON      t1.cst_id = t2.cst_id
left join SJXQ_SJ2025041711_CST_02      t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2025041711_CST_03      t4
on t2.cst_id=t4.cst_id
left join SJXQ_SJ2025041711_CST_04      t5
on t2.cst_id=t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041711_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041711_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041711_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041711_CST_04
;
/*
01	17464075	17464075
02	39462	39462
03	6690148	6690148
04	2633303	2632559
*/***於挺_SJ2025052211_洗钱风险排查.sql
﻿-- 标准化代码
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_01 AS
SElECT *
from(
    SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
        ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
        ,ROW_NUMBER() over (partition by t1.cst_act_id order by t1.frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.DT
    left join edw.dwd_code_library_dd   c2
    on t1.frz_cls_cd = c2.cd_val
    and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
    and c2.dt=t1.DT
    WHERE   t1.DT = '@@{yyyyMMdd}'
    AND     t1.FRZ_SRC_CD='2'  --止付
    AND     t1.NFRZ_IND = '0'
)t1 where t1.rn=1
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_02 AS
select *
from(
    SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
        ,ROW_NUMBER() over(partition by t1.cst_act_id order by t1.frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.DT
    WHERE   T1.DT = '@@{yyyyMMdd}'
    AND     T1.FRZ_SRC_CD='1'  --冻结
    AND     T1.NFRZ_IND = '0'
)t1 where t1.rn=1
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_03 AS
select *
from(
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt as 关闭非柜面原因
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '@@{yyyyMMdd}'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t1 where t1.rn=1
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_04 AS
SELECT  cengcgjz      AS cst_act_id
        ,max(edsxriqi) as  额度生效日期
       ,MAX(danciedu) AS fg_per_lmt
       ,MAX(leijiedu) AS fg_day_lmt
       ,count(1) cnt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
group by cengcgjz
;
/*
SELECT  cengcgjz      AS cst_act_id
        ,edsxriqi as  额度生效日期
       ,danciedu AS fg_per_lmt
       ,leijiedu AS fg_day_lmt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
and cengcgjz in(
    select cst_act_id from SJXQ_SJ2025052211_CST_04 where cnt>1
);
*/
--法定代表人	实际控制人	受益所有人
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_05 AS
select t1.cst_id
    ,t2.lgp_nm                                   as 法定代表人
    ,t3.实际控制人
    ,t4.受益所有人
from edw.dim_cst_entp_bas_inf_dd        t1 --企业客户基本信息
left join edw.dim_cst_entp_lgp_inf_dd   t2 --对公客户法人信息表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join(
    select t1.cst_id
    from(
        select cst_id,rel_cst_id
        from edw.loan_cst_rel
        where dt = '@@{yyyyMMdd}'
        AND rel_typ = '0109' --实控人
        union
        select rel_cst_id,cst_id
        from edw.loan_cst_rel
        where dt = '@@{yyyyMMdd}'
        AND rel_typ = '0109' --实控人
    ) t1 --客户关联关系信息
    inner JOIN edw.dim_cst_idv_bas_inf_dd t2 --客户基本信息
    ON t1.rel_cst_id = t2.cst_id
    AND t2.dt = '@@{yyyyMMdd}'
    group by t1.cst_id
)t3 on t1.cst_id=t3.cst_id
left join(
    select substr(party_id, 3, 10)  as cst_id
    from adm_upss.adm_upss_aml_t47_beneficiary    --对公客户受益所有人表
    where dt='@@{yyyyMMdd}'
    group by substr(party_id, 3, 10)
)t4 on t1.cst_id=t4.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 当前风险评级	当前风险评级编辑岗意见
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_06 AS
SELECT  t1.cst_id
        ,t1.levelkey           AS 当前风险评级
        ,t1.ADJUST_REASON AS 当前风险评级编辑岗意见
FROM    (
            SELECT  SUBSTR(a.party_id, 3, 10)                                                                  AS cst_id
                    ,a.party_id
                    ,a.levelkey --最终风险等级
                    ,B.ADJUST_REASON
                    ,B.last_upd_dt --	调整日期
                    ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(a.party_id, 3, 10) ORDER BY a.statistic_dt DESC ) AS rn
            FROM    adm_upss.aml_t37_party_result_curr a --评级当前结果表
            LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR B
            ON      A.RESULEKEY = B.RSLTKEY
            AND     A.PARTY_ID = B.PARTY_ID
            AND     B.POST_ID = 'P2001' --编辑岗
            AND     B.DT = '@@{yyyyMMdd}'
            WHERE   a.dt = '@@{yyyyMMdd}'
        ) T1
WHERE   t1.rn = 1;
-- 1.公司名称含&ldquo;贸易&rdquo;，注册资金本0或小于10万元，且既开立人民账户又开立外币账户，且年收汇量折人民币＞100万元     收汇量指近一年的跨境、贷方总金额
-- 客群1
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_07 AS
select t1.cst_id
	,t1.cst_nm                                   --客户名称
    ,t1.reg_cpt                                  --注册资本
	,t1.idt_ctg_cd                               --行业分类代码
    ,c1.cd_val_dscr     as 行业
    ,t4.近一年跨境收汇金额_元
from edw.dim_cst_entp_bas_inf_dd  t1             --企业客户基本信息
inner join(
    select distinct cst_id
    from edw.dim_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    and ccy_cd = '156'  -- 人民币元
)t2 on t1.cst_id=t2.cst_id
inner join(
    select distinct cst_id
    from edw.dim_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    and ccy_cd <> '156' -- 外币账户
)t3 on t1.cst_id=t3.cst_id
inner join(
    select SUBSTR(PARTY_ID,3,10) as cst_id
        ,sum(cny_amt) as 近一年跨境收汇金额_元
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt>='@@{yyyyMMdd-1y}'
    and tx_dt>='@@{yyyyMMdd-1y}'
    and overarea_ind='1'    --是否跨境交易
    and debit_credit='C'    --借贷标志
    group by cst_id having sum(cny_amt)>1000000
)t4 on t1.cst_id=t4.cst_id
left join edw.dwd_code_library_dd   c1
on t1.idt_ctg_cd = c1.cd_val
and c1.dt=t1.DT
where t1.dt='@@{yyyyMMdd}'
and t1.cst_nm regexp '贸易'
and t1.reg_cpt<100000
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_08 AS
SELECT  t1.cst_id      AS 客户号
    ,t1.cst_nm      AS 客户名称
    ,t1.行业
    ,t2.法定代表人
    ,t2.实际控制人
    ,t2.受益所有人
    ,t3.cst_act_id  AS 客户账号
    ,t3.账户类别
    ,t3.ccy_nm AS 币种
    ,t1.近一年跨境收汇金额_元
    ,t4.opn_dt      AS 开户日期
    ,t3.账户余额
    ,c1.cd_val_dscr AS 账户状态
    ,t4.dstr_act_dt AS 销户日期
    ,t5.当前风险评级
    ,t5.当前风险评级编辑岗意见
    ,t6.ky_cnt as 可疑案例历史上报次数
    ,t8.brc_org_id as 分行机构号
    ,t8.brc_org_nm as 分行机构名称
    ,t4.opn_org_id  as 开户机构号
    ,t9.org_nm      as 开户机构名称
	,t7.prm_org_id                               as 主管护机构号
	,t7.prm_org_nm                               as 主管户机构名称
	,t7.prm_mgr_id                               as 主管护客户经理工号
	,t7.prm_mgr_nm                               as 主管护客户经理姓名
    ,CASE WHEN T11.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T11.frz_dt                      AS 止付日期
    ,T11.act_stop_pmt_typ            AS 止付类型
    ,T11.frz_cls                     AS 止付种类
    ,T11.frz_rsn                     AS 止付原因
    ,CASE WHEN T12.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T12.frz_dt                       AS 冻结日期
    ,T12.frz_cls                      AS 冻结种类
    ,T12.frz_rsn                      AS 冻结原因
    ,CASE WHEN T13.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T13.关闭非柜面原因
    ,CASE WHEN T14.cst_act_id IS NULL     THEN '否'
           WHEN T14.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,t14.额度生效日期
    ,T14.fg_per_lmt                      AS 非柜单笔限额
    ,T14.fg_day_lmt                      AS 非柜日累计限额
    ,t3.上次动户日期
from SJXQ_SJ2025052211_CST_07       t1
left join SJXQ_SJ2025052211_CST_05  t2
on t1.cst_id=t2.cst_id
left join (
    select t1.cst_id,t1.cst_act_id
        ,sum(t1.gl_bal)            as 账户余额
        ,max(t1.bal_late_upd_dt)   as 上次动户日期
    from edw.dws_bus_dep_act_inf_dd  t1			--存款账户信息
    left join edw.dwd_code_library_dd   c2
    on t1.ccy_cd = c2.cd_val
    and c2.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    group by t1.cst_id,t1.cst_act_id
)t3 on t1.cst_id=t3.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t4 --客户存款账户信息
on t3.cst_act_id=t4.cst_act_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1
on t4.act_sts_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_06  t5
on t1.cst_id=t5.cst_id
left join(
    SELECT substr(party_id, 3, 12) AS cst_id,count(1) as ky_cnt
    FROM    adm_upss.aml_t07_case_application_uh
    WHERE   dt = '@@{yyyyMMdd}'
    AND     cast_type = '2' --案例类型:1:大额 2:可疑
    AND     app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t7 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t7.cst_id
and t7.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t8 --考核机构树
on  t7.prm_org_id = t8.org_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t4.opn_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_01              t11 --止付
on t3.cst_act_id=t11.cst_act_id
left join SJXQ_SJ2025052211_CST_02              t12 --冻结
on t3.cst_act_id=t12.cst_act_id
left join SJXQ_SJ2025052211_CST_03              t13 --关闭非柜面
on t3.cst_act_id=t13.cst_act_id
left join SJXQ_SJ2025052211_CST_04              t14 --非柜面限额
on t3.cst_act_id=t14.cst_act_id
;
-- 2.同注册地址企业/同联系电话企业/同法定代表人或实际控制人或控股股东、授权办理业务人员（开户代理人，踢掉开户时客户16周岁以下的账户）、受益所有人的企业。
-- 相同数量达到3个及以上。
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_09 AS
select t1.cst_id                                   --客户号|C20
	,t1.mbl_nbr                                  --手机|C32
	,t1.reg_adr                                  --注册地址|C256
    ,t2.lgp_cst_id                               --对公客户法人客户号
from edw.dws_cst_bas_inf_dd             t1 --客户基础信息汇总表
left join edw.dim_cst_entp_lgp_inf_dd   t2 --对公客户法人信息表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.cst_typ_cd='2'     --'对公'
;
--实控人
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_10 AS
select t1.cst_id,rel_cst_id
from(
    select cst_id,rel_cst_id
    from edw.loan_cst_rel --客户关联关系信息
    where dt = '@@{yyyyMMdd}'
    AND rel_typ = '0109' --实控人
    union
    select rel_cst_id,cst_id
    from edw.loan_cst_rel --客户关联关系信息
    where dt = '@@{yyyyMMdd}'
    AND rel_typ = '0109' --实控人
)t1 inner join edw.dws_cst_bas_inf_dd t2
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.cst_typ_cd='2'
;
--客群2
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_11 AS
select t2.cst_id,'同注册地址企业' as cst_cls
from(
    select reg_adr
    from SJXQ_SJ2025052211_CST_09
    where nvl(reg_adr,'')<>''
    group by reg_adr having count(distinct cst_id)>=3
)t1 inner join SJXQ_SJ2025052211_CST_09 t2
on t1.reg_adr=t2.reg_adr
union all
select t2.cst_id,'同联系电话企业'
from(
    select mbl_nbr
    from SJXQ_SJ2025052211_CST_09
    where nvl(mbl_nbr,'')<>''
    group by mbl_nbr having count(distinct cst_id)>=3
)t1 inner join SJXQ_SJ2025052211_CST_09 t2
on t1.mbl_nbr=t2.mbl_nbr
union all
select t2.cst_id,'同法定代表人企业'
from(
    select lgp_cst_id
    from SJXQ_SJ2025052211_CST_09
    where nvl(lgp_cst_id,'')<>''
    group by lgp_cst_id having count(distinct cst_id)>=3
)t1 inner join SJXQ_SJ2025052211_CST_09 t2
on t1.lgp_cst_id=t2.lgp_cst_id
union all
select t2.cst_id,'同实际控制人企业'
from(
    select rel_cst_id
    from SJXQ_SJ2025052211_CST_10
    where nvl(rel_cst_id,'')<>''
    group by rel_cst_id having count(distinct cst_id)>=3
)t1 inner join SJXQ_SJ2025052211_CST_10 t2
on t1.rel_cst_id=t2.rel_cst_id
union all
select substr(t2.party_id, 3, 10),'同受益所有人企业'
from(
    select bfi_id
    from adm_upss.adm_upss_aml_t47_beneficiary    --对公客户受益所有人表
    where dt='@@{yyyyMMdd}'
    and nvl(bfi_id,'')<>''
    group by bfi_id
    having count(distinct substr(party_id, 3, 10))>=3
)t1 inner join adm_upss.adm_upss_aml_t47_beneficiary t2
on t1.bfi_id=t2.bfi_id
and t2.dt='@@{yyyyMMdd}'
union all
select t2.cst_id,'同开户代理人企业'
from(
    select t1.agn_doc_nbr
    from edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd t1 --代理业务交易登记簿
    where t1.dt='@@{yyyyMMdd}'
    AND t1.agn_bus_typ = '1' --代理业务类型代码:代理开户
    and nvl(t1.agn_doc_nbr,'')<>''
    group by t1.agn_doc_nbr
    having count(distinct t1.cst_id)>=3
)t1 inner join edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd t2 --代理业务交易登记簿
on t1.agn_doc_nbr=t2.agn_doc_nbr
and t2.dt='@@{yyyyMMdd}'
AND t2.agn_bus_typ = '1' --代理业务类型代码:代理开户
inner join edw.dws_cst_bas_inf_dd   t3
on t2.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
and  t3.cst_typ_cd='2'
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_12 AS
SELECT  t1.cst_id      AS 客户号
    ,t21.cst_nm      AS 客户名称
    ,t1.相同关系类型
    ,c3.cd_val_dscr as  行业
    ,t2.法定代表人
    ,t2.实际控制人
    ,t2.受益所有人
    ,t3.cst_act_id  AS 客户账号
    ,t3.账户类别
    ,t3.ccy_nm AS 币种
    ,t22.近一年跨境收汇金额_元
    ,t4.opn_dt      AS 开户日期
    ,t3.账户余额
    ,c1.cd_val_dscr AS 账户状态
    ,t4.dstr_act_dt AS 销户日期
    ,t5.当前风险评级
    ,t5.当前风险评级编辑岗意见
    ,t6.ky_cnt as 可疑案例历史上报次数
    ,t8.brc_org_id as 分行机构号
    ,t8.brc_org_nm as 分行机构名称
    ,t4.opn_org_id  as 开户机构号
    ,t9.org_nm      as 开户机构名称
	,t7.prm_org_id                               as 主管护机构号
	,t7.prm_org_nm                               as 主管户机构名称
	,t7.prm_mgr_id                               as 主管护客户经理工号
	,t7.prm_mgr_nm                               as 主管护客户经理姓名
    ,CASE WHEN T11.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T11.frz_dt                      AS 止付日期
    ,T11.act_stop_pmt_typ            AS 止付类型
    ,T11.frz_cls                     AS 止付种类
    ,T11.frz_rsn                     AS 止付原因
    ,CASE WHEN T12.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T12.frz_dt                       AS 冻结日期
    ,T12.frz_cls                      AS 冻结种类
    ,T12.frz_rsn                      AS 冻结原因
    ,CASE WHEN T13.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T13.关闭非柜面原因
    ,CASE WHEN T14.cst_act_id IS NULL     THEN '否'
           WHEN T14.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,t14.额度生效日期
    ,T14.fg_per_lmt                      AS 非柜单笔限额
    ,T14.fg_day_lmt                      AS 非柜日累计限额
    ,t3.上次动户日期
from (
    select cst_id
    from SJXQ_SJ2025052211_CST_11
    group by cst_id
)t1 left join edw.dim_cst_entp_bas_inf_dd  t21             --企业客户基本信息
on  t1.cst_id=t21.cst_id
and t21.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c3
on t21.idt_ctg_cd = c3.cd_val
and c3.dt='@@{yyyyMMdd}'
left join(
    select SUBSTR(PARTY_ID,3,10) as cst_id
        ,sum(cny_amt) as 近一年跨境收汇金额_元
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt>='@@{yyyyMMdd-1y}'
    and tx_dt>='@@{yyyyMMdd-1y}'
    and overarea_ind='1'    --是否跨境交易
    and debit_credit='C'    --借贷标志
    group by cst_id
)t22 on t1.cst_id=t22.cst_id
left join SJXQ_SJ2025052211_CST_05  t2
on t1.cst_id=t2.cst_id
INner join (
    select t1.cst_id,t1.cst_act_id
        ,sum(t1.gl_bal)            as 账户余额
        ,max(t1.bal_late_upd_dt)   as 上次动户日期
    from edw.dws_bus_dep_act_inf_dd  t1			--存款账户信息
    left join edw.dwd_code_library_dd   c2
    on t1.ccy_cd = c2.cd_val
    and c2.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    group by t1.cst_id,t1.cst_act_id
)t3 on t1.cst_id=t3.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t4 --客户存款账户信息
on t3.cst_act_id=t4.cst_act_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1
on t4.act_sts_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_06  t5
on t1.cst_id=t5.cst_id
left join(
    SELECT substr(party_id, 3, 12) AS cst_id,count(1) as ky_cnt
    FROM    adm_upss.aml_t07_case_application_uh
    WHERE   dt = '@@{yyyyMMdd}'
    AND     cast_type = '2' --案例类型:1:大额 2:可疑
    AND     app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t7 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t7.cst_id
and t7.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t8 --考核机构树
on  t7.prm_org_id = t8.org_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t4.opn_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_01              t11 --止付
on t3.cst_act_id=t11.cst_act_id
left join SJXQ_SJ2025052211_CST_02              t12 --冻结
on t3.cst_act_id=t12.cst_act_id
left join SJXQ_SJ2025052211_CST_03              t13 --关闭非柜面
on t3.cst_act_id=t13.cst_act_id
left join SJXQ_SJ2025052211_CST_04              t14 --非柜面限额
on t3.cst_act_id=t14.cst_act_id
;
-- 3.存在个人客户的联系电话或地址与他人相同，且既开立人民账户又开立外币账户，且年收汇量折人民币＞10万元。相同数量达到3个及以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_13 AS
select t1.cst_id
	,t1.cst_chn_nm                               --客户名称
	,t1.mbl_nbr                                  --手机|C32
	,t1.reg_adr                                  --户籍地址
	,t1.wrk_adr                                  --工作单位地址
	,t1.fml_adr                                  --家庭地址|C256
	,t1.idt_cd                               --行业分类代码
    ,c1.cd_val_dscr     as 行业
	,t2.gdr_cd                                   --性别代码|C1
    ,decode(t2.gdr_cd,'1','男','2','女','未知') as 性别
	,t2.bth_dt                                   --出生日期|C8
	,t2.ind_bus_ind                              --个体工商户标志|C1
	,t2.mic_entp_own_ind                         --小微企业主标志|C1
    ,t2.job_unt_nm                               --工作单位名称
    ,t2.ocp_cd                                   --职业代码
    ,c2.cd_val_dscr     as 职业
from edw.dws_cst_bas_inf_dd         t1
left join edw.dwd_code_library_dd   c1
on t1.idt_cd = c1.cd_val
and c1.dt=t1.DT
left join edw.dim_cst_idv_bas_inf_dd t2 --个人客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join edw.dwd_code_library_dd   c2
on t2.ocp_cd = c2.cd_val
and c2.dt=t1.DT
where t1.dt='@@{yyyyMMdd}'
and t1.cst_typ_cd='1' --'对私'
;
-- 客群3
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_14 AS
select t1.cst_id
    ,t1.相同关系类型
    ,t4.近一年跨境收汇金额_元
from(
    select cst_id
    from(
        select t2.cst_id,'个人同联系电话' as cst_cls
        from(
            select mbl_nbr
            from SJXQ_SJ2025052211_CST_13
            where nvl(mbl_nbr,'')<>''
            group by mbl_nbr having count(distinct cst_id)>=3
        )t1 inner join SJXQ_SJ2025052211_CST_13 t2
        on t1.mbl_nbr=t2.mbl_nbr
        union all
        select t2.cst_id,'个人同户籍地址' as cst_cls
        from(
            select reg_adr
            from SJXQ_SJ2025052211_CST_13
            where nvl(reg_adr,'')<>''
            group by reg_adr having count(distinct cst_id)>=3
        )t1 inner join SJXQ_SJ2025052211_CST_13 t2
        on t1.reg_adr=t2.reg_adr
        union all
        select t2.cst_id,'个人同工作单位地址' as cst_cls
        from(
            select wrk_adr
            from SJXQ_SJ2025052211_CST_13
            where nvl(wrk_adr,'')<>''
            group by wrk_adr having count(distinct cst_id)>=3
        )t1 inner join SJXQ_SJ2025052211_CST_13 t2
        on t1.wrk_adr=t2.wrk_adr
        union all
        select t2.cst_id,'个人同家庭地址' as cst_cls
        from(
            select fml_adr
            from SJXQ_SJ2025052211_CST_13
            where nvl(fml_adr,'')<>''
            group by fml_adr having count(distinct cst_id)>=3
        )t1 inner join SJXQ_SJ2025052211_CST_13 t2
        on t1.fml_adr=t2.fml_adr
    )t1 group by cst_id
)t1
inner join(
    select distinct cst_id
    from edw.dim_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    and ccy_cd = '156'  -- 人民币元
)t2 on t1.cst_id=t2.cst_id
inner join(
    select distinct cst_id
    from edw.dim_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    and ccy_cd <> '156' -- 外币账户
)t3 on t1.cst_id=t3.cst_id
inner join(
    select SUBSTR(PARTY_ID,3,10) as cst_id
        ,sum(cny_amt) as 近一年跨境收汇金额_元
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt>='@@{yyyyMMdd-1y}'
    and tx_dt>='@@{yyyyMMdd-1y}'
    and overarea_ind='1'    --是否跨境交易
    and debit_credit='C'    --借贷标志 C:贷
    group by cst_id having sum(cny_amt)>100000
)t4 on t1.cst_id=t4.cst_id
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_15 AS
select t1.cst_id as 客户号
    ,t2.cst_chn_nm      AS 客户名称
    ,t1.相同关系类型
    ,t3.cst_act_id  AS 客户账号
    ,CASE WHEN t3.ccy_cd = '156' THEN '本币'  ELSE '外币' END AS 账户类别
    ,c2.cd_val_dscr AS 币种
    ,t1.近一年跨境收汇金额_元
    ,t4.opn_dt      AS 开户日期
    ,t3.账户余额
    ,c1.cd_val_dscr AS 账户状态
    ,t4.dstr_act_dt AS 销户日期
    ,t5.当前风险评级
    ,t5.当前风险评级编辑岗意见
    ,t6.ky_cnt as 可疑案例历史上报次数
    ,t8.brc_org_id as 分行机构号
    ,t8.brc_org_nm as 分行机构名称
    ,t4.opn_org_id  as 开户机构号
    ,t9.org_nm      as 开户机构名称
	,t7.prm_org_id                               as 主管护机构号
	,t7.prm_org_nm                               as 主管户机构名称
	,t7.prm_mgr_id                               as 主管护客户经理工号
	,t7.prm_mgr_nm                               as 主管护客户经理姓名
    ,CASE WHEN T11.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T11.frz_dt                      AS 止付日期
    ,T11.act_stop_pmt_typ            AS 止付类型
    ,T11.frz_cls                     AS 止付种类
    ,T11.frz_rsn                     AS 止付原因
    ,CASE WHEN T12.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T12.frz_dt                       AS 冻结日期
    ,T12.frz_cls                      AS 冻结种类
    ,T12.frz_rsn                      AS 冻结原因
    ,CASE WHEN T13.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T13.关闭非柜面原因
    ,CASE WHEN T14.cst_act_id IS NULL     THEN '否'
           WHEN T14.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,t14.额度生效日期
    ,T14.fg_per_lmt                      AS 非柜单笔限额
    ,T14.fg_day_lmt                      AS 非柜日累计限额
    ,t3.上次动户日期
	,t2.bth_dt                                   as 出生日期
    ,t2.性别
	,t2.ind_bus_ind                              as 个体工商户标志
	,t2.mic_entp_own_ind                         as 小微企业主标志
    ,t2.行业
    ,t2.职业
    ,t2.job_unt_nm                               as 工作单位名称
	,t2.wrk_adr                                  as 工作单位地址
	,t2.fml_adr                                  as 家庭地址
from  SJXQ_SJ2025052211_CST_14          t1
left join SJXQ_SJ2025052211_CST_13      t2
on  t1.cst_id=t2.cst_id
inner join (
    select cst_id,cst_act_id
        ,sum(gl_bal)            as 账户余额
        ,max(bal_late_upd_dt)   as 上次动户日期
    from edw.dws_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    group by cst_id,cst_act_id
)t3 on t1.cst_id=t3.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t4 --客户存款账户信息
on t3.cst_act_id=t4.cst_act_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1
on t4.act_sts_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t3.ccy_cd = c2.cd_val
and c2.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_06  t5
on t1.cst_id=t5.cst_id
left join(
    SELECT substr(party_id, 3, 12) AS cst_id,count(1) as ky_cnt
    FROM    adm_upss.aml_t07_case_application_uh
    WHERE   dt = '@@{yyyyMMdd}'
    AND     cast_type = '2' --案例类型:1:大额 2:可疑
    AND     app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t7 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t7.cst_id
and t7.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t8 --考核机构树
on  t7.prm_org_id = t8.org_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t4.opn_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_01              t11 --止付
on t3.cst_act_id=t11.cst_act_id
left join SJXQ_SJ2025052211_CST_02              t12 --冻结
on t3.cst_act_id=t12.cst_act_id
left join SJXQ_SJ2025052211_CST_03              t13 --关闭非柜面
on t3.cst_act_id=t13.cst_act_id
left join SJXQ_SJ2025052211_CST_04              t14 --非柜面限额
on t3.cst_act_id=t14.cst_act_id
;
-- 4.2024年至今有被公安查冻扣的客户
-- 输出结果4
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_16 AS
select t1.*
from(
    SELECT  t1.cst_id                                                       AS 客户号
        ,t1.cst_nm                                                       AS 客户名称
        ,t1.cst_act_id	as	客户账号
        ,COUNT(case WHEN t1.qry_ctrl_typ_nm = '查询' THEN qry_ctrl_dt end) AS 公安机关查询次数
        ,COUNT(case WHEN t1.qry_ctrl_typ_nm = '冻结' THEN qry_ctrl_dt end) AS 公安机关冻结次数
        ,COUNT(distinct instt_nm)                                        AS 涉及不同公安机关数量
        ,MAX(frz_bgn_dt)                                                 AS 最新一条冻结起始日期
        ,MAX(frz_tmn_dt)                                                 AS 最新一条冻结终止日期
    FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd t1 --司法查冻扣汇总信息
    WHERE t1.dt = '@@{yyyyMMdd}'
    AND t1.qry_ctrl_dt >= '20240101'
    AND ( t1.instt_typ_cd IN ( '04' , '05' ) OR ( ( t1.instt_nm LIKE '%法院%' OR t1.instt_typ_cd = '01' ) AND t1.LAW_DOC_ID LIKE '%刑%' ) )
    and (nvl(t1.cst_id,'')<>'' or nvl(t1.cst_act_id,'')<>'')
    GROUP BY  t1.cst_id,t1.cst_nm,t1.cst_act_id
)t1 left join (
    select distinct cst_act_id
    from edw.dws_bus_dep_act_inf_dd  	--存款账户信息
    where dt='@@{yyyyMMdd}'
)t2 on t1.客户账号=t2.cst_act_id
where nvl(t1.客户号,'')<>'' or t2.cst_act_id is not null
;
-- 5.个人外汇开户后有30天未使用账户，30天后开始交易，且1个月收汇交易金额达10万以上。1个月指开始交易后30天
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_17 AS
select t1.cst_id,t1.cst_act_id
    ,t2.opn_dt                                   --开户日期
    ,t3.fst_tx_dt
    ,datediff(to_date(t3.fst_tx_dt,'yyyyMMdd'),to_date(t2.opn_dt,'yyyyMMdd'),'dd') as diff_days
    ,to_char(dateadd(to_date(t3.fst_tx_dt,'yyyyMMdd'),30,'dd'),'yyyyMMdd') as fst_tx_dt_30d
from(
    select distinct t1.cst_id,t1.cst_act_id
    from edw.dim_bus_dep_act_inf_dd         t1 			--存款账户信息
    inner join edw.dim_cst_idv_bas_inf_dd   t2 --个人客户基本信息
    ON T1.CST_ID=T2.CST_ID
    AND T2.DT=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.ccy_cd <> '156' -- 外币账户
)T1 left join edw.dim_bus_dep_cst_act_inf_dd t2 --客户存款账户信息
on t1.cst_act_id=t2.cst_act_id
and t2.dt='@@{yyyyMMdd}'
inner join(
    SELECT ACCT_NUM,min(tx_dt) as fst_tx_dt
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt<='@@{yyyyMMdd}'
    group by acct_num
)t3 on t1.cst_act_id=t3.ACCT_NUM
;
-- 交易后30天收汇交易金额达10万以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_18 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_18 AS
select t1.cst_act_id
    ,sum(cny_amt) as 交易后30天跨境收汇金额_元
from SJXQ_SJ2025052211_CST_17           t1
inner join adm_upss.adm_upss_aml_t47_transaction t2 --反洗钱交易流水表
on t1.cst_act_id=t2.acct_num
and t2.tx_dt >= t1.fst_tx_dt
and t2.tx_dt <= t1.fst_tx_dt_30d
and t2.dt<='@@{yyyyMMdd}'
and t2.overarea_ind='1'    --是否跨境交易
and t2.debit_credit='C'    --借贷标志
where t1.diff_days > 30 --30天后
group by t1.cst_act_id
having sum(cny_amt)>100000
;
-- 输出结果5
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_19 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_19 AS
select t3.cst_id    as 客户号
    ,t2.cst_chn_nm      AS 客户名称
    ,t1.cst_act_id  AS 客户账号
    ,CASE WHEN t3.ccy_cd = '156' THEN '本币'  ELSE '外币' END AS 账户类别
    ,c2.cd_val_dscr AS 币种
    ,t21.近一年跨境收汇金额_元
    ,t4.opn_dt      AS 开户日期
    ,t3.账户余额
    ,c1.cd_val_dscr AS 账户状态
    ,t4.dstr_act_dt AS 销户日期
    ,t5.当前风险评级
    ,t5.当前风险评级编辑岗意见
    ,t6.ky_cnt as 可疑案例历史上报次数
    ,t8.brc_org_id as 分行机构号
    ,t8.brc_org_nm as 分行机构名称
    ,t4.opn_org_id  as 开户机构号
    ,t9.org_nm      as 开户机构名称
	,t7.prm_org_id                               as 主管护机构号
	,t7.prm_org_nm                               as 主管户机构名称
	,t7.prm_mgr_id                               as 主管护客户经理工号
	,t7.prm_mgr_nm                               as 主管护客户经理姓名
    ,CASE WHEN T11.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T11.frz_dt                      AS 止付日期
    ,T11.act_stop_pmt_typ            AS 止付类型
    ,T11.frz_cls                     AS 止付种类
    ,T11.frz_rsn                     AS 止付原因
    ,CASE WHEN T12.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T12.frz_dt                       AS 冻结日期
    ,T12.frz_cls                      AS 冻结种类
    ,T12.frz_rsn                      AS 冻结原因
    ,CASE WHEN T13.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T13.关闭非柜面原因
    ,CASE WHEN T14.cst_act_id IS NULL     THEN '否'
           WHEN T14.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,t14.额度生效日期
    ,T14.fg_per_lmt                      AS 非柜单笔限额
    ,T14.fg_day_lmt                      AS 非柜日累计限额
    ,t3.上次动户日期
	,t2.bth_dt                                   as 出生日期
    ,t2.性别
	,t2.ind_bus_ind                              as 个体工商户标志
	,t2.mic_entp_own_ind                         as 小微企业主标志
    ,t2.行业
    ,t2.职业
    ,t2.job_unt_nm                               as 工作单位名称
	,t2.wrk_adr                                  as 工作单位地址
	,t2.fml_adr                                  as 家庭地址
from  SJXQ_SJ2025052211_CST_18          t1
inner join (
    select cst_id,cst_act_id
        ,sum(gl_bal)            as 账户余额
        ,max(bal_late_upd_dt)   as 上次动户日期
    from edw.dws_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    group by cst_id,cst_act_id
)t3 on t1.cst_act_id=t3.cst_act_id
left join SJXQ_SJ2025052211_CST_13      t2
on  t3.cst_id=t2.cst_id
left join(
    select SUBSTR(PARTY_ID,3,10) as cst_id
        ,sum(cny_amt) as 近一年跨境收汇金额_元
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt>='@@{yyyyMMdd-1y}'
    and tx_dt>='@@{yyyyMMdd-1y}'
    and overarea_ind='1'    --是否跨境交易
    and debit_credit='C'    --借贷标志
    group by cst_id
)t21 on t3.cst_id=t21.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t4 --客户存款账户信息
on t3.cst_act_id=t4.cst_act_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1
on t4.act_sts_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t3.ccy_cd = c2.cd_val
and c2.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_06  t5
on t3.cst_id=t5.cst_id
left join(
    SELECT substr(party_id, 3, 12) AS cst_id,count(1) as ky_cnt
    FROM    adm_upss.aml_t07_case_application_uh
    WHERE   dt = '@@{yyyyMMdd}'
    AND     cast_type = '2' --案例类型:1:大额 2:可疑
    AND     app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
    group by cst_id
)t6 on t3.cst_id=t6.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t7 --客户集市-客户基础-客户管户信息
on  t3.cst_id = t7.cst_id
and t7.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t8 --考核机构树
on  t7.prm_org_id = t8.org_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t4.opn_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_01              t11 --止付
on t3.cst_act_id=t11.cst_act_id
left join SJXQ_SJ2025052211_CST_02              t12 --冻结
on t3.cst_act_id=t12.cst_act_id
left join SJXQ_SJ2025052211_CST_03              t13 --关闭非柜面
on t3.cst_act_id=t13.cst_act_id
left join SJXQ_SJ2025052211_CST_04              t14 --非柜面限额
on t3.cst_act_id=t14.cst_act_id
;
-- 6.公司外汇开户后有30天未使用账户，30天后开始交易，且1个月收汇交易金额达100万以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_20 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_20 AS
select t1.cst_id,t1.cst_act_id
    ,t2.opn_dt                                   --开户日期
    ,t3.fst_tx_dt
    ,datediff(to_date(t3.fst_tx_dt,'yyyyMMdd'),to_date(t2.opn_dt,'yyyyMMdd'),'dd') as diff_days
    ,to_char(dateadd(to_date(t3.fst_tx_dt,'yyyyMMdd'),30,'dd'),'yyyyMMdd') as fst_tx_dt_30d
from(
    select distinct t1.cst_id,t1.cst_act_id
    from edw.dim_bus_dep_act_inf_dd         t1 			--存款账户信息
    inner join edw.dim_cst_entp_bas_inf_dd  t2 --企业客户基本信息
    ON T1.CST_ID=T2.CST_ID
    AND T2.DT=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.ccy_cd <> '156' -- 外币账户
)T1 left join edw.dim_bus_dep_cst_act_inf_dd t2 --客户存款账户信息
on t1.cst_act_id=t2.cst_act_id
and t2.dt='@@{yyyyMMdd}'
inner join(
    SELECT ACCT_NUM,min(tx_dt) as fst_tx_dt
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt<='@@{yyyyMMdd}'
    group by acct_num
)t3 on t1.cst_act_id=t3.ACCT_NUM
;
-- 交易后30天收汇交易金额达10万以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_21 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_21 AS
select t1.cst_act_id
    ,sum(cny_amt) as 交易后30天跨境收汇金额_元
from SJXQ_SJ2025052211_CST_20           t1
inner join adm_upss.adm_upss_aml_t47_transaction t2 --反洗钱交易流水表
on t1.cst_act_id=t2.acct_num
and t2.tx_dt >= t1.fst_tx_dt
and t2.tx_dt <= t1.fst_tx_dt_30d
and t2.dt<='@@{yyyyMMdd}'
and t2.overarea_ind='1'    --是否跨境交易
and t2.debit_credit='C'    --借贷标志
where t1.diff_days > 30 --30天后
group by t1.cst_act_id
having sum(cny_amt)>1000000
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025052211_CST_22 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052211_CST_22 AS
SELECT  t3.cst_id      AS 客户号
    ,t21.cst_nm      AS 客户名称
    ,c3.cd_val_dscr as  行业
    ,t2.法定代表人
    ,t2.实际控制人
    ,t2.受益所有人
    ,t3.cst_act_id  AS 客户账号
    ,CASE WHEN t3.ccy_cd = '156' THEN '本币'  ELSE '外币' END AS 账户类别
    ,c2.cd_val_dscr AS 币种
    ,t22.近一年跨境收汇金额_元
    ,t4.opn_dt      AS 开户日期
    ,t3.账户余额
    ,c1.cd_val_dscr AS 账户状态
    ,t4.dstr_act_dt AS 销户日期
    ,t5.当前风险评级
    ,t5.当前风险评级编辑岗意见
    ,t6.ky_cnt as 可疑案例历史上报次数
    ,t8.brc_org_id as 分行机构号
    ,t8.brc_org_nm as 分行机构名称
    ,t4.opn_org_id  as 开户机构号
    ,t9.org_nm      as 开户机构名称
	,t7.prm_org_id                               as 主管护机构号
	,t7.prm_org_nm                               as 主管户机构名称
	,t7.prm_mgr_id                               as 主管护客户经理工号
	,t7.prm_mgr_nm                               as 主管护客户经理姓名
    ,CASE WHEN T11.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T11.frz_dt                      AS 止付日期
    ,T11.act_stop_pmt_typ            AS 止付类型
    ,T11.frz_cls                     AS 止付种类
    ,T11.frz_rsn                     AS 止付原因
    ,CASE WHEN T12.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T12.frz_dt                       AS 冻结日期
    ,T12.frz_cls                      AS 冻结种类
    ,T12.frz_rsn                      AS 冻结原因
    ,CASE WHEN T13.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T13.关闭非柜面原因
    ,CASE WHEN T14.cst_act_id IS NULL     THEN '否'
           WHEN T14.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,t14.额度生效日期
    ,T14.fg_per_lmt                      AS 非柜单笔限额
    ,T14.fg_day_lmt                      AS 非柜日累计限额
    ,t3.上次动户日期
from  SJXQ_SJ2025052211_CST_21 t1
inner join (
    select cst_id,cst_act_id
        ,sum(gl_bal)            as 账户余额
        ,max(bal_late_upd_dt)   as 上次动户日期
    from edw.dws_bus_dep_act_inf_dd  			--存款账户信息
    where dt='@@{yyyyMMdd}'
    group by cst_id,cst_act_id
)t3 on t1.cst_act_id=t3.cst_act_id
left join edw.dim_cst_entp_bas_inf_dd  t21             --企业客户基本信息
on  t3.cst_id=t21.cst_id
and t21.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c3
on t21.idt_ctg_cd = c3.cd_val
and c3.dt='@@{yyyyMMdd}'
left join(
    select SUBSTR(PARTY_ID,3,10) as cst_id
        ,sum(cny_amt) as 近一年跨境收汇金额_元
    from adm_upss.adm_upss_aml_t47_transaction    --反洗钱交易流水表
    where dt>='@@{yyyyMMdd-1y}'
    and tx_dt>='@@{yyyyMMdd-1y}'
    and overarea_ind='1'    --是否跨境交易
    and debit_credit='C'    --借贷标志
    group by cst_id
)t22 on t3.cst_id=t22.cst_id
left join SJXQ_SJ2025052211_CST_05  t2
on t3.cst_id=t2.cst_id
left join edw.dim_bus_dep_cst_act_inf_dd t4 --客户存款账户信息
on t3.cst_act_id=t4.cst_act_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1
on t4.act_sts_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t3.ccy_cd = c2.cd_val
and c2.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_06  t5
on t3.cst_id=t5.cst_id
left join(
    SELECT substr(party_id, 3, 12) AS cst_id,count(1) as ky_cnt
    FROM    adm_upss.aml_t07_case_application_uh
    WHERE   dt = '@@{yyyyMMdd}'
    AND     cast_type = '2' --案例类型:1:大额 2:可疑
    AND     app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
    group by cst_id
)t6 on t3.cst_id=t6.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t7 --客户集市-客户基础-客户管户信息
on  t3.cst_id = t7.cst_id
and t7.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t8 --考核机构树
on  t7.prm_org_id = t8.org_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t4.opn_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2025052211_CST_01              t11 --止付
on t3.cst_act_id=t11.cst_act_id
left join SJXQ_SJ2025052211_CST_02              t12 --冻结
on t3.cst_act_id=t12.cst_act_id
left join SJXQ_SJ2025052211_CST_03              t13 --关闭非柜面
on t3.cst_act_id=t13.cst_act_id
left join SJXQ_SJ2025052211_CST_04              t14 --非柜面限额
on t3.cst_act_id=t14.cst_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs --结果1
from SJXQ_SJ2025052211_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct 客户号) custs --结果2
from SJXQ_SJ2025052211_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052211_CST_14
union all
SElECT '15' seq, count(1) cnt,count(distinct 客户号) custs --结果3
from SJXQ_SJ2025052211_CST_15
union all
SElECT '16' seq, count(1) cnt,count(distinct 客户号) custs --结果4
from SJXQ_SJ2025052211_CST_16
union all
SElECT '17' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_17
union all
SElECT '18' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_18
union all
SElECT '19' seq, count(1) cnt,count(distinct 客户号) custs --结果5
from SJXQ_SJ2025052211_CST_19
union all
SElECT '20' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_20
union all
SElECT '21' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052211_CST_21
union all
SElECT '22' seq, count(1) cnt,count(distinct 客户号) custs --结果6
from SJXQ_SJ2025052211_CST_22
;
SElECT * --结果1
from lab_sjxq.SJXQ_SJ2025052211_CST_08
SElECT * --结果2
from lab_sjxq.SJXQ_SJ2025052211_CST_12
limit 1000
SElECT * --结果3
from lab_sjxq.SJXQ_SJ2025052211_CST_15
SElECT * --结果4
from lab_sjxq.SJXQ_SJ2025052211_CST_16
SElECT * --结果5
from lab_sjxq.SJXQ_SJ2025052211_CST_19
SElECT * --结果6
from lab_sjxq.SJXQ_SJ2025052211_CST_22
/*
01	2949111	2949111
02	69460	69460
03	4128013	4128013
04	4769282	4769282
05	3268035	3268035
06	9636142	9636142
07	50	50
08	155	50
09	3268035	3268035
10	424477	413377
11	674449	524267
12	1840335	235810
13	16519206	16519206
14	689	689
15	1724	689
16	65895	59478
17	21488	21488
18	2248	2248
19	2248	2205
20	34654	34654
21	4463	4463
22	4463	4244
*/
***於挺_SJ20250610116_反洗钱业务评估与排查.sql
﻿-- 於挺_SJ20250610116_反洗钱业务评估与排查
/*
1. 客户数不含村行？不含
2. 交易金额是否为客户交易表交易金额？单位万？不是
3. 信息不完善需要剔除 不收不付标识，只收不付标志，暂停非柜面，销户？客户维度，不用剔
and   是否全部销户 = '否'
and   (不收不付标识 is null or 不收不付标识 = '')
and   (只收不付标志 is null or 只收不付标志 = '')
and   (暂停非柜面 is null or 暂停非柜面 = '')
*/
-- 截至20250617日查冻扣客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_01 AS
SELECT distinct aa.cst_id
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
WHERE aa.dt = '20250617'
-- AND qry_ctrl_dt between '20240529' and '20250617'
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) )
;
-- 截至目前，较高风险、高风险客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_02 AS
select cst_id
from(
    SELECT substr(t2.party_id,3,12)  AS cst_id
        ,t2.levelkey
        ,t2.rcheck_dt
        ,ROW_NUMBER() OVER ( PARTITION BY substr(t2.party_id,3,12) ORDER BY  t2.statistic_dt DESC ) AS rn
        ,t2.statistic_dt
    FROM adm_upss.aml_t37_party_result_curr t2
    WHERE t2.dt = '20250617'
)t1 where rn=1
;
-- 国籍、名称、性别、证件类型、证件号码、证件有效期、职业、联系方式（联系电话手机号码均无）、地址（户籍地址、居住地址、单位地址均无）
-- 个人客户身份信息不完善的客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_03 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户中文名称|C200
	,t1.gdr_cd                                   --性别代码|C1
	,t1.ntn_cd                                   --国籍代码|C3
	,t1.ocp_cd                                   --职业代码|C5
	,t2.doc_nbr                                  --证件号码|C60
	,t2.doc_typ_cd                               --证件类型代码|C5
	,t2.doc_mtu_dt                               --证件到期日期|C8
	,t2.mbl_nbr                                  --手机|C32
	,t2.fml_tel_nbr                              --家庭电话|C32
	,t2.reg_adr                                  --户籍地址|注册地址|C256
	,t2.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t2.fml_adr                                  --家庭地址|C256
    ,case when nvl(t1.ntn_cd,'')='' then '国籍'
        when nvl(t1.cst_chn_nm,'')='' then '客户名称'
        when nvl(t1.gdr_cd,'')='' then '性别'
        when nvl(t2.doc_typ_cd,'')='' then '证件类型'
        when nvl(t2.doc_nbr,'')='' then '证件号'
        when nvl(t2.doc_mtu_dt,'')='' then '证件到期日'
        when nvl(t1.ocp_cd,'')='' then '职业'
        when length(t2.mbl_nbr) + length(t2.fml_tel_nbr) = 0 then '联系方式'
        when length(t2.reg_adr) + length(t2.wrk_adr) + length(t2.fml_adr) = 0 then '地址'
        else '' end as null_type
from edw.dim_cst_idv_bas_inf_dd     t1 --个人客户基本信息
INNER JOIN edw.dws_cst_bas_inf_dd   t2 --客户基础信息汇总表 证件号及到期日
ON t1.cst_id = t2.cst_id
AND t2.dt = t1.dt
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM edw.dim_cst_idv_bas_inf_dd a
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20250617'
			WHERE a.dt = '20250617'
			UNION
			SELECT  a.cst_id
			       ,'1' AS act_cls_frz_ind -- 封闭冻结
			FROM edw.dim_cst_idv_bas_inf_dd a
			INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd b
			ON a.cst_id = b.cst_id AND b.dt = '20250617'
            AND (b.card_sts_cd IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) or b.LATE_CARD_IND <> '1')
            AND b.dt = '20250617'
			WHERE a.dt = '20250617'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = '1'
	AND min_ = '1' -- 只保留所有账户都不收不付的客户
) t3
ON t1.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
		from edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20250617'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t1.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join (
            SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
                    ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
            FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
            WHERE   DT = '20250617'
            AND     ACT_THRS_TYP = '2' --暂停非柜面
            AND     evt_id = 'DPDRAW'
        )t2 on t1.cst_act_id=t2.cst_act_id
        and t2.rn=1
        where t1.dt='20250617'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
INNER JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM edw.dim_cst_idv_bas_inf_dd         a
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id
    AND b.dt = '20250617'
    LEFT JOIN    (
        SELECT  t1.cst_act_id
                ,T1.lbl_act_id
        FROM    edw.dwd_bus_dep_frz_inf_dd t1
        LEFT JOIN    edw.dwd_code_library_dd t4
        ON      t1.frz_cls_cd = t4.cd_val
        AND     t4.dt = '20250617'
        WHERE   t1.dt = '20250617'
        AND     t1.nfrz_ind = 0
        GROUP BY t1.cst_act_id , T1.lbl_act_id
    ) T8
    ON      b.cst_act_id = t8.cst_act_id
    AND     b.dep_act_id = T8.lbl_act_id
	WHERE a.dt = '20250617'
    and t8.cst_act_id is null   --剔除冻结登记簿账户
	GROUP BY  a.cst_id
) t6 -- t6判断是否全部销户
ON t1.cst_id = t6.cst_id
and t6.是否全部销户='否'
where t1.dt='20250617'
AND (nvl(t1.ntn_cd,'')='' or nvl(t1.cst_chn_nm,'')='' or nvl(t1.gdr_cd,'')='' or nvl(t2.doc_typ_cd,'')='' or nvl(t2.doc_nbr,'')=''
    or nvl(t2.doc_mtu_dt,'')='' or nvl(t1.ocp_cd,'')='' or length(t2.mbl_nbr) + length(t2.fml_tel_nbr) = 0
    or length(t2.reg_adr) + length(t2.wrk_adr) + length(t2.fml_adr) = 0)
and   t3.cst_id is null
and   t4.cst_id is null
and   t5.cst_id is null
;
-- 名称、住所、经营范围、可证明该客户依法设立或者可依法开展经营、社会活动的执照、证件或者文件的名称、号码和有效期限；
-- 法定代表人或负责人和授权办理业务人员的姓名、身份证件或者身份证明文件的种类、号码、有效期限；
-- 受益所有人的姓名、地址、身份证件或者身份证明文件的种类、号码、有效期限，有一项缺失的。
-- 鲤想财资客户包括主管客户和成员客户。
-- 公司客户身份信息不完善的客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_04 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.opr_scp_dscr                             --经营范围描述|C3000
	,t2.doc_nbr                                  --证件号码|C60
	,t2.doc_typ_cd                               --证件类型代码|C5
	,t2.doc_mtu_dt                               --证件到期日期|C8
	,t2.reg_adr                                  --户籍地址|注册地址|C256
	,t2.wrk_adr                                  --工作单位地址|经营所在地地址|C256
    ,b1.cst_chn_nm     AS fr_cst_chn_nm      --法定代表人
    ,b1.prm_doc_typ_cd AS fr_prm_doc_typ_cd  --法人证件类型
    ,b1.prm_doc_nbr    AS fr_prm_doc_nbr     --法人证件号
    ,b1.prm_doc_mtu_dt AS fr_prm_doc_mtu_dt  --法人证件到期日
    ,t3.sy_isnull
    ,case when nvl(t1.cst_nm,'')='' then '客户名称'
        when nvl(t1.opr_scp_dscr,'')='' then '经营范围描述'
        when nvl(t2.doc_typ_cd,'')='' then '证件类型'
        when nvl(t2.doc_nbr,'')='' then '证件号'
        when nvl(t2.doc_mtu_dt,'')='' then '证件到期日'
        when length(t2.reg_adr) + length(t2.wrk_adr) = 0 then '地址'
        when nvl(b1.cst_chn_nm,'')='' then '法人名称'
        when nvl(b1.prm_doc_typ_cd,'')='' then '法人证件类型'
        when nvl(b1.prm_doc_nbr,'')='' then '法人证件号'
        when nvl(b1.prm_doc_mtu_dt,'')='' then '法人证件到期日'
        when t3.sy_isnull=1 then '受益人'
        else '' end as null_type
from edw.dim_cst_entp_bas_inf_dd    t1 --企业客户基本信息
INNER JOIN edw.dws_cst_bas_inf_dd   t2 --客户基础信息汇总表 证件号及到期日
ON t1.cst_id = t2.cst_id
AND t2.dt = t1.dt
LEFT JOIN edw.dim_cst_rel_inf_dd a1 --客户关联关系信息
ON t1.cst_id = a1.cst_id AND a1.dt = t1.dt AND a1.rel_typ_cd = '0101' --法人 唯一
and LENGTH(a1.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b1 --客户基本信息
ON a1.rel_cst_id = b1.cst_id AND b1.dt = t1.dt
LEFT JOIN (
    SELECT a3.cst_id
        ,min(case when nvl(b3.cst_chn_nm,'')='' or nvl(b3.prm_doc_typ_cd,'')='' or nvl(b3.prm_doc_nbr,'')='' or nvl(b3.prm_doc_mtu_dt,'')='' then 1
            else 0 end) as sy_isnull
    from edw.dim_cst_rel_inf_dd         a3 --客户关联关系信息
    LEFT JOIN edw.dim_cst_bas_inf_dd    b3 --客户基本信息
    ON a3.rel_cst_id = b3.cst_id
    AND b3.dt = a3.dt
    where a3.dt = '20250617'
    AND a3.rel_typ_cd LIKE '09%' --受益人
    and LENGTH(a3.rel_cst_id)=10
    GROUP BY a3.cst_id
)t3 ON t1.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
		FROM  edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20250617'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t1.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join (
            SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
                    ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
            FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
            WHERE   DT = '20250617'
            AND     ACT_THRS_TYP = '2' --暂停非柜面
            AND     evt_id = 'DPDRAW'
        )t2 on t1.cst_act_id=t2.cst_act_id
        and t2.rn=1
        where t1.dt='20250617'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20250617'
			WHERE a.dt = '20250617'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = 1
	AND min_ = 1 -- 只保留所有账户都不收不付的客户
) t6
ON t1.cst_id = t6.cst_id
inner JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM adm_pub.adm_csm_cbas_org_bas_inf_dd a
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id AND b.dt = '20250617'
    LEFT JOIN    (
        SELECT  t1.cst_act_id
                ,T1.lbl_act_id
        FROM    edw.dwd_bus_dep_frz_inf_dd t1   --存款账户冻结登记簿
        LEFT JOIN    edw.dwd_code_library_dd t4
        ON      t1.frz_cls_cd = t4.cd_val
        AND     t4.dt = '20250617'
        WHERE   t1.dt = '20250617'
        AND     t1.nfrz_ind = 0
        GROUP BY t1.cst_act_id , T1.lbl_act_id
    ) T8
    ON      b.cst_act_id = t8.cst_act_id
    AND     b.dep_act_id = T8.lbl_act_id
	WHERE a.dt = '20250617'
    and t8.cst_act_id is null   --剔除冻结登记簿账户
	GROUP BY  a.cst_id
) t7 -- t7判断是否全部销户
ON t1.cst_id = t7.cst_id
and t7.是否全部销户='否'
where t1.dt='20250617'
AND (nvl(t1.cst_nm,'')='' or nvl(t1.opr_scp_dscr,'')='' or nvl(t2.doc_typ_cd,'')='' or nvl(t2.doc_nbr,'')=''
    or nvl(t2.doc_mtu_dt,'')='' or length(t2.reg_adr) + length(t2.wrk_adr) = 0
    or nvl(b1.cst_chn_nm,'')='' or nvl(b1.prm_doc_typ_cd,'')='' or nvl(b1.prm_doc_nbr,'')='' or nvl(b1.prm_doc_mtu_dt,'')=''
    or t3.sy_isnull=1)  --一个受益人4要素非空，则受益人要素完整
and   t4.cst_id is null
and   t5.cst_id is null
and   t6.cst_id is null
;
--通用：主管户为泰隆银行的客户，对应的客户账号、存款账号
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_05 AS
SELECT  t1.cst_id
    ,t3.cst_typ_cd  --客户类型
    ,t1.prm_mgr_id
    ,t1.prm_mgr_nm
    ,t1.prm_org_id
    ,t1.prm_org_nm
    ,case when t4.cst_ID is not null then 1 else 0 end as is_cdk_cst
    ,case when t5.cst_ID is not null then 1 else 0 end as is_high_rsk_cst
    ,case when t6.cst_ID is not null then 1 else 0 end as is_indv_empty_cst
    ,case when t7.cst_ID is not null then 1 else 0 end as is_entp_empty_cst
FROM    adm_pub.adm_csm_cbas_mng_inf_dd         t1 --客户管户信息
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd    t2 --机构树
ON      t1.prm_org_id = t2.org_id
AND     t2.dt = '20250617'
AND     t2.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
LEFT JOIN    edw.dws_cst_bas_inf_dd             t3
ON      t1.cst_id = t3.cst_id
AND     t3.dt = '20250617'
left join SJXQ_SJ20250610116_CST_01     t4
on t1.cst_id=t4.cst_ID
left join SJXQ_SJ20250610116_CST_02     t5
on t1.cst_id=t5.cst_ID
left join SJXQ_SJ20250610116_CST_03     t6
on t1.cst_id=t6.cst_ID
left join SJXQ_SJ20250610116_CST_04     t7
on t1.cst_id=t7.cst_ID
WHERE   t1.dt = '20250617'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_15 AS
--1.保险金信托
SELECT  '1.保险金信托' ind
       ,COUNT(t1.cst_id)                                  AS 客户数
       ,SUM(t2.is_cdk_cst)                                AS 被公安查冻扣的客户数
       ,round(SUM(t2.is_cdk_cst)/COUNT(t1.cst_id),4)      AS 查冻扣占比
       ,SUM(t2.is_high_rsk_cst)                           AS 较高风险及以上客户数
       ,round(SUM(t2.is_high_rsk_cst)/COUNT(t1.cst_id),4) AS 较高风险占比
       ,SUM(t2.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
       ,SUM(t2.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
    --    ,sum(case when t2.cst_id is null then 1 else 0 end) as 异常数
from(
    SELECT distinct col_2 as cst_id --客户统一编号
    from lab_bigdata_dev.qbi_file_20250618_11_10_44_0
    where pt<>''
)t1 inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
union all
-- 2.供应链客户清单-241231
SELECT  '2.供应链客户清单' ind
       ,COUNT(t1.cst_id)                                  AS 客户数
       ,SUM(t2.is_cdk_cst)                                AS 被公安查冻扣的客户数
       ,round(SUM(t2.is_cdk_cst)/COUNT(t1.cst_id),4)      AS 查冻扣占比
       ,SUM(t2.is_high_rsk_cst)                           AS 较高风险及以上客户数
       ,round(SUM(t2.is_high_rsk_cst)/COUNT(t1.cst_id),4) AS 较高风险占比
       ,SUM(t2.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
       ,SUM(t2.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
    --    ,sum(case when t2.cst_id is null then 1 else 0 end) as 异常数
from(
    SELECT col_13 as cst_id --客户号
    from lab_bigdata_dev.qbi_file_20250618_11_16_14_0
    where pt<>''
    union
    SELECT col_13 as cst_id --客户号
    from lab_bigdata_dev.qbi_file_20250618_11_17_18_0
    where pt<>''
)t1 inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
;
--电子银行客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_06 AS
SElECT  t1.cst_id
    ,t1.opn_chnl_cd --开通渠道
    ,t1.opn_chnl_nm
    ,t1.chnl_dt     --渠道开通日期
    ,t2.is_cdk_cst
    ,t2.is_high_rsk_cst
    ,t2.is_indv_empty_cst
    ,t2.is_entp_empty_cst
from(
    SELECT cst_id
        ,opn_chnl_cd
        ,decode(opn_chnl_cd,'0','个人网上银行','2','个人手机银行') as opn_chnl_nm
        ,min(substr(chnl_opn_tm,1,8))    chnl_dt --渠道开通时间
    FROM    edw.dim_bus_chnl_elec_idv_inf_dd --电子银行个人客户渠道信息表
    WHERE   dt = '20250617'
    AND     chnl_sts = '0'--渠道状态正常
    GROUP BY cst_id,opn_chnl_cd,opn_chnl_nm
    union all
    SELECT cst_id
        ,opn_chnl_cd
        ,decode(opn_chnl_cd,'0','企业网上银行','4','企业手机银行') as opn_chnl_nm
        ,min(substr(chnl_opn_tm,1,8))    sign_dt --渠道开通时间
    FROM    edw.dim_bus_chnl_elec_entp_inf_dd --电子银行企业客户渠道信息表
    WHERE   dt = '20250617'
    AND     chnl_sts = '0'--渠道状态正常
    GROUP BY cst_id,opn_chnl_cd,opn_chnl_nm
)t1 inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
;
--电子银行客户交易金额
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_07 AS
select t1.cst_id
    ,substr(t3.dt,1,4)  as trx_year
    ,sum(t3.trx_amt)    as trx_amt
from(
    select distinct cst_id
    from SJXQ_SJ20250610116_CST_06
)t1 inner join edw.dim_bus_dep_act_inf_dd t2
on t1.cst_id=t2.cst_id
and t2.dt='20250617'
inner join edw.dwd_bus_dep_bal_chg_dtl_di t3
on t2.dep_act_id=t3.dep_act_id
and t3.dt between '20230101' and '20241231'
and t3.bal_fld_nm = 'DPLDGBAL'
group by t1.cst_id,trx_year
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_16 AS
-- 3.个人网上银行
select '3.个人网上银行' as ind
    ,count(case when t1.chnl_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.chnl_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.chnl_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.chnl_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t1.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t1.is_cdk_cst)/COUNT(t1.cst_id),4)      AS 查冻扣占比
    ,SUM(t1.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t1.is_high_rsk_cst)/COUNT(t1.cst_id),4) AS 较高风险占比
    ,SUM(t1.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t1.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_06      t1
left join SJXQ_SJ20250610116_CST_07 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_07 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
where t1.opn_chnl_nm='个人网上银行'
union all
-- 4.企业网上银行
select '4.企业网上银行' as ind
    ,count(case when t1.chnl_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.chnl_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.chnl_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.chnl_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t1.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t1.is_cdk_cst)/COUNT(t1.cst_id),4)      AS 查冻扣占比
    ,SUM(t1.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t1.is_high_rsk_cst)/COUNT(t1.cst_id),4) AS 较高风险占比
    ,SUM(t1.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t1.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_06      t1
left join SJXQ_SJ20250610116_CST_07 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_07 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
where t1.opn_chnl_nm='企业网上银行'
union all
-- 5.个人手机银行
select '5.个人手机银行' as ind
    ,count(case when t1.chnl_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.chnl_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.chnl_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.chnl_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t1.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t1.is_cdk_cst)/COUNT(t1.cst_id),4)      AS 查冻扣占比
    ,SUM(t1.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t1.is_high_rsk_cst)/COUNT(t1.cst_id),4) AS 较高风险占比
    ,SUM(t1.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t1.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_06      t1
left join SJXQ_SJ20250610116_CST_07 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_07 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
where t1.opn_chnl_nm='个人手机银行'
union all
-- 6.企业手机银行
select '6.企业手机银行' as ind
    ,count(case when t1.chnl_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.chnl_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.chnl_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.chnl_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t1.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t1.is_cdk_cst)/COUNT(t1.cst_id),4)      AS 查冻扣占比
    ,SUM(t1.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t1.is_high_rsk_cst)/COUNT(t1.cst_id),4) AS 较高风险占比
    ,SUM(t1.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t1.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_06      t1
left join SJXQ_SJ20250610116_CST_07 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_07 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
where t1.opn_chnl_nm='企业手机银行'
;
-- 7.自助银行：ATM、CRS C01:ATM|CC1:自助机具渠道
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_08 AS
select t1.cst_ID,min(t3.dt)  as fst_zz_trx_dt   --首次自助交易日期
from SJXQ_SJ20250610116_CST_05          t1
inner join edw.dim_bus_dep_act_inf_dd   t2
on t1.cst_ID=t2.cst_ID
and t2.dt='20250617'
inner join edw.dwd_bus_dep_bal_chg_dtl_di t3
on t2.dep_act_id=t3.dep_act_id
and t3.dt<='20241231'
and t3.bal_fld_nm = 'DPLDGBAL'
AND t3.trx_chnl_cd IN ( 'C01' , 'CC1' )
group by t1.cst_id
;
-- 交易金额
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_09 AS
select t1.cst_id
    ,substr(t3.dt,1,4)  as trx_year
    ,sum(t3.trx_amt)    as trx_amt
from SJXQ_SJ20250610116_CST_08              t1
inner join edw.dim_bus_dep_act_inf_dd       t2
on t1.cst_id=t2.cst_id
and t2.dt='20250617'
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3
on t2.dep_act_id=t3.dep_act_id
and t3.dt between '20230101' and '20241231'
and t3.bal_fld_nm = 'DPLDGBAL'
group by t1.cst_id,trx_year
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_17 AS
select '7.自助银行' as ind
    ,count(case when t1.fst_zz_trx_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.fst_zz_trx_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.fst_zz_trx_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.fst_zz_trx_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t4.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t4.is_cdk_cst)/COUNT(t4.cst_id),4)      AS 查冻扣占比
    ,SUM(t4.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t4.is_high_rsk_cst)/COUNT(t4.cst_id),4) AS 较高风险占比
    ,SUM(t4.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t4.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_08      t1
left join SJXQ_SJ20250610116_CST_09 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_09 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
inner join SJXQ_SJ20250610116_CST_05 t4
on t1.cst_id=t4.cst_id
;
-- 8.人民币协定存款
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_10 AS
SELECT t1.cst_id
    ,min(t2.jiaoyirq) as fst_xdck_dt --首次协定存款交易日期
FROM edw.dws_bus_dep_act_inf_dd t1
INNER JOIN edw.core_kdpb_xdckdj t2 --协定存款登记簿
ON t1.dep_act_id = t2.zhanghao
AND t2.xiedckbz = '1'       --协定存款标志
AND t2.yllvbhao = 'HN002'   --原利率编号
AND t2.dt = t1.dt
WHERE t1.dt = '20250617'
AND t1.ccy_cd = '156' ----币种&ldquo;人民币&rdquo;
AND t1.gl_bal > 0 ---余额 > 0
group by t1.cst_id
;
-- 协定存款客户-交易金额
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_11 AS
select t1.cst_id
    ,substr(t3.dt,1,4)  as trx_year
    ,sum(t3.trx_amt)    as trx_amt
from SJXQ_SJ20250610116_CST_10          t1
inner join edw.dim_bus_dep_act_inf_dd   t2
on t1.cst_id=t2.cst_id
and t2.dt='20250617'
inner join edw.dwd_bus_dep_bal_chg_dtl_di t3
on t2.dep_act_id=t3.dep_act_id
and t3.dt between '20230101' and '20241231'
and t3.bal_fld_nm = 'DPLDGBAL'
group by t1.cst_id,trx_year
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_18 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_18 AS
select '8.人民币协定存款' as ind
    ,count(case when t1.fst_xdck_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.fst_xdck_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.fst_xdck_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.fst_xdck_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t4.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t4.is_cdk_cst)/COUNT(t4.cst_id),4)      AS 查冻扣占比
    ,SUM(t4.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t4.is_high_rsk_cst)/COUNT(t4.cst_id),4) AS 较高风险占比
    ,SUM(t4.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t4.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_10      t1
left join SJXQ_SJ20250610116_CST_11 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_11 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
inner join SJXQ_SJ20250610116_CST_05 t4
on t1.cst_id=t4.cst_id
;
-- 9.实物贵金属代销
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_12 AS
SELECT cst_id              --客户号
    ,min(SUBSTR(replace(pmt_tm,'-',''), 1, 8))    as fst_pay_dt   --首次付款时间
    ,sum(case when SUBSTR(replace(pmt_tm,'-',''), 1, 8) between '20230101' and '20231231' then cmdt_pay_unt_prc else 0 end) as trx_amt_2023
    ,sum(case when SUBSTR(replace(pmt_tm,'-',''), 1, 8) between '20240101' and '20241231' then cmdt_pay_unt_prc else 0 end) as trx_amt_2024
FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di --贵金属交易整合表
WHERE dt <= '20250617'
group by cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_19 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_19 AS
select '9.实物贵金属代销' as ind
    ,count(case when t1.fst_pay_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.fst_pay_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(t1.trx_amt_2023) as 2023年交易金额
    ,sum(t1.trx_amt_2024) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t2.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t2.is_cdk_cst)/COUNT(t2.cst_id),4)      AS 查冻扣占比
    ,SUM(t2.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t2.is_high_rsk_cst)/COUNT(t2.cst_id),4) AS 较高风险占比
    ,SUM(t2.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t2.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_12       t1
inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
;
-- 10.银行承兑汇票（含E票通）：包含承兑、贴现
-- 201	银行承兑汇票承兑	小企业部
-- 1002010101002	e票通-线上承兑
-- 1002010101001	银行承兑汇票承兑
-- 202	银行承兑汇票贴现	小企业部
-- 1002020101002	e票通-线上秒贴
-- 1002020101001	银行承兑汇票贴现
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_13 AS
select t1.cst_id
    ,min(t1.CTR_BGN_DT) as fst_ctr_dt
FROM    edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同基础信息
AND     t1.PRD_NO IN ( '1002010101002' , '1002010101001','1002020101002' , '1002020101001')
group by t1.cst_id
;
-- 发放金额
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_14 AS
select t1.cst_id
    ,substr(t2.LVE_ACT_BGN_DT,1,4)  as trx_year
    ,sum(t2.amt)                    as trx_amt
from SJXQ_SJ20250610116_CST_13          t1
INNER JOIN edw.DIM_BUS_LOAN_DBIL_INF_DD t2
ON  t1.cst_id=t2.cst_id
AND t2.dt = '@@{yyyyMMdd}'
AND t2.LVE_ACT_BGN_DT >= '20230101'
AND t2.LVE_ACT_BGN_DT <= '20241231'
group by t1.cst_id,trx_year
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_20 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_20 AS
select '10.银行承兑汇票' as ind
    ,count(case when t1.fst_ctr_dt<='20231231' then t1.cst_id end) as 截至2023年客户数
    ,count(case when t1.fst_ctr_dt<='20241231' then t1.cst_id end) as 截至2024年客户数
    ,sum(case when t1.fst_ctr_dt<='20231231' then t2.trx_amt end) as 2023年交易金额
    ,sum(case when t1.fst_ctr_dt<='20241231' then t3.trx_amt end) as 2024年交易金额
    ,count(t1.cst_id)  as 截至目前客户数
    ,SUM(t4.is_cdk_cst)                                AS 被公安查冻扣的客户数
    ,round(SUM(t4.is_cdk_cst)/COUNT(t4.cst_id),4)      AS 查冻扣占比
    ,SUM(t4.is_high_rsk_cst)                           AS 较高风险及以上客户数
    ,round(SUM(t4.is_high_rsk_cst)/COUNT(t4.cst_id),4) AS 较高风险占比
    ,SUM(t4.is_indv_empty_cst)                         AS 个人客户身份信息不完善的客户数
    ,SUM(t4.is_entp_empty_cst)                         AS 公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_13      t1
left join SJXQ_SJ20250610116_CST_14 t2
on t1.cst_id=t2.cst_id
and t2.trx_year='2023'
left join SJXQ_SJ20250610116_CST_14 t3
on t1.cst_id=t3.cst_id
and t3.trx_year='2024'
inner join SJXQ_SJ20250610116_CST_05 t4
on t1.cst_id=t4.cst_id
;
-- 输出结果表
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_21 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_21 AS
select * from SJXQ_SJ20250610116_CST_16
union all
select * from SJXQ_SJ20250610116_CST_17
union all
select * from SJXQ_SJ20250610116_CST_18
union all
select * from SJXQ_SJ20250610116_CST_19
union all
select * from SJXQ_SJ20250610116_CST_20
union all
SELECT ind,null,null,null,null
    ,客户数
    ,被公安查冻扣的客户数
    ,查冻扣占比
    ,较高风险及以上客户数
    ,较高风险占比
    ,个人客户身份信息不完善的客户数
    ,公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_15
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_22 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_22 AS
SELECT ind,截至2023年客户数,截至2024年客户数
    ,2023年交易金额/10000 as 2023年交易金额_万
    ,2024年交易金额/10000 as 2024年交易金额_万
    ,截至目前客户数,被公安查冻扣的客户数,查冻扣占比,较高风险及以上客户数
    ,较高风险占比,个人客户身份信息不完善的客户数,公司客户身份信息不完善的客户数
from SJXQ_SJ20250610116_CST_21
;
-- 个人不完整名单
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_23 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_23 AS
SElECT '9.实物贵金属代销' as ind,t3.*
from SJXQ_SJ20250610116_CST_12       t1
inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
and t2.is_indv_empty_cst=1
inner join SJXQ_SJ20250610116_CST_03 t3
on t1.cst_id=t3.cst_id
union all
select '7.自助银行' as ind,t3.*
from SJXQ_SJ20250610116_CST_08       t1
inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
and t2.is_indv_empty_cst=1
inner join SJXQ_SJ20250610116_CST_03 t3
on t1.cst_id=t3.cst_id
union all
select '3.个人网上银行' as ind,t3.*
from SJXQ_SJ20250610116_CST_06       t1
inner join SJXQ_SJ20250610116_CST_03 t3
on t1.cst_id=t3.cst_id
where t1.opn_chnl_nm='个人网上银行'
and t1.is_indv_empty_cst=1
union all
select '5.个人手机银行' as ind,t3.*
from SJXQ_SJ20250610116_CST_06       t1
inner join SJXQ_SJ20250610116_CST_03 t3
on t1.cst_id=t3.cst_id
where t1.opn_chnl_nm='个人手机银行'
and t1.is_indv_empty_cst=1
;
-- 对公不完整名单
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_24 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_24 AS
SElECT '9.实物贵金属代销' as ind,t3.*
from SJXQ_SJ20250610116_CST_12       t1
inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
and t2.is_entp_empty_cst=1
inner join SJXQ_SJ20250610116_CST_04 t3
on t1.cst_id=t3.cst_id
union all
select '10.银行承兑汇票' as ind,t3.*
from SJXQ_SJ20250610116_CST_13       t1
inner join SJXQ_SJ20250610116_CST_05 t2
on t1.cst_id=t2.cst_id
and t2.is_entp_empty_cst=1
inner join SJXQ_SJ20250610116_CST_04 t3
on t1.cst_id=t3.cst_id
union all
select '4.企业网上银行' as ind,t3.*
from SJXQ_SJ20250610116_CST_06       t1
inner join SJXQ_SJ20250610116_CST_04 t3
on t1.cst_id=t3.cst_id
where t1.opn_chnl_nm='企业网上银行'
and t1.is_entp_empty_cst=1
union all
select '6.企业手机银行' as ind,t3.*
from SJXQ_SJ20250610116_CST_06       t1
inner join SJXQ_SJ20250610116_CST_04 t3
on t1.cst_id=t3.cst_id
where t1.opn_chnl_nm='企业手机银行'
and t1.is_entp_empty_cst=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250610116_CST_25 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250610116_CST_25 AS
SELECT  ind       AS 产品业务名称
       ,cst_id    AS 客户号
       ,'个人'      as 客户类型
       ,cst_chn_nm AS 客户中文名称
       ,null_type  AS 缺失类型
from SJXQ_SJ20250610116_CST_23
union all
SELECT  ind       AS 产品业务名称
       ,cst_id    AS 客户号
       ,'企业'      as 客户类型
       ,cst_nm    AS 客户名称
       ,null_type AS 缺失类型
from SJXQ_SJ20250610116_CST_24
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,opn_chnl_nm) custs
from SJXQ_SJ20250610116_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id,trx_year) custs
from SJXQ_SJ20250610116_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id,trx_year) custs
from SJXQ_SJ20250610116_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_id,trx_year) custs
from SJXQ_SJ20250610116_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250610116_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct cst_id,trx_year) custs
from SJXQ_SJ20250610116_CST_14
;
/*
01	120827	120827
02	40641	40641
03	6802943	6802943
04	2393485	2393485
05	17791744	17791744
06	5951036	5951036
07	5765710	5765710
08	1296188	1296188
09	1997681	1997681
10	11750	11750
11	20706	20706
12	81336	81336
13	47255	47255
14	46001	46001
*/
-- 结果表
SElECT '22' seq, * from SJXQ_SJ20250610116_CST_22;
SElECT '25' seq, * from SJXQ_SJ20250610116_CST_25;
***於挺_SJ2025072841_反洗钱需求.sql
﻿-- 於挺010805-SJ2025072841-检查客户信息有效性
-- 於挺_SJ2025072841_反洗钱需求
-- 1	客户身份信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES01_1 AS
select t1.head_no                                as 报告机构编码
	,t1.bank_code1                               as 客户号归属机构网点代码  --对应TB_BANK表中的BANK_CODE1
	,t1.cst_no                                   as 客户号
	,t1.open_time                                as 创建日期    --年月日格式YYYYMMDD
	,t1.close_time                               as 结束日期    --年月日格式YYYYMMDD
	,t1.acc_name                                 as 客户名称
	,t1.decode(cst_sex,'11','男','12','女')      as 性别    --按如下格式：11：男 12：女
	,t1.nation                                   as 国籍   --(地区)按照GB_T 2659-2000世界各国和地区名称代码标准填写，英文缩写，如CHN、HK
    ,t1.id_type    as 身份证件种类代码
	,decode(t1.id_type,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 身份证件种类   --按如下填写列 11 居民身份证或临时身份证12 军人或武警身份证件13 港澳居民往来内地通行证；台湾居民来往大陆通行证或其他有效旅行证件14 外国公民护照19 其他类个人身份有效证件
	-- ,id_no                                    as 身份证件号码
	,t1.id_deadline                              as 身份证件到期日     --YYYYMMDD，长期用99991231表示
	,t1.occupation                               as 职业   --填写文字，如采用代码记录的，需转换成文字
	,t1.income                                   as 年收入_元  --，保留2位小数
	-- ,contact1                                 as 联系方式
	-- ,contact2                                 as 其他联系方式1
	-- ,contact3                                 as 其他联系方式2客户不止1个联系方式时先填CONTACT1，CONTACT2，再填写本字段，即不能出现CONTACT1，CONTACT2为空，只填写CONTACT3的情况，客户不止3个联系方式的，只需导入3中联系方式即可
	-- ,address1                                 as 住所地或工作单位地址客户不止1个联系方式时先填CONTACT1，CONTACT2，再填写本字段，即不能出现CONTACT1，CONTACT2为空，只填写CONTACT3的情况，客户不止3个联系方式的，只需导入3中联系方式即可
	-- ,address2                                 as 其他住所地或工作单位地址1客户有多个住所或工作单位地址时先填写ADDRESS1，再填写本字段
	-- ,address3                                 as 其他住所地或工作单位地址2客户有多个住所或工作单位地址时先填写ADDRESS1、ADDRESS2，再填写本字段
	,t1.company                                  as 工作单位名称
	,t1.sys_name                                 as 系统名称   --如涉及多个系统，逐一全部列出，用;分割
	,t1.occupation1                              as 职业1
	,t1.cst_state                                as 客户号状态
	,t1.cst_state_date                           as 客户号状态认定日期
	,t1.cst_state1                               as 客户状态
	,t1.risk_code                                as 当前风险等级
	,t1.risk_time                                as 当前风险等级划分日期
	,t1.id_type3                                 as 3号令身份证件种类
	,t1.dml_date                                 as 数据维护日期
	,t1.dml_code                                 as 数据维护机构代码
	,t1.cst_yn                                   as 本机构客户标识
	,t1.open_time2                               as 建立业务关系日期
	,t1.close_time2                              as 结束业务关系日期
	,t1.is_tskh                                  as 名下是否只有II类或III类账户
	,t1.is_ybsbkh                                as 名下是否仅为医保或社保账户
	,t1.is_smkh                                  as 名下账户是否均为处于睡眠状态
	,t1.is_wjhke                                 as 名下账户是否均未激活
	,t1.id_start_day                             as 证件起始日期
    ,t3.cst_id
	,t3.prm_mgr_id                               as 主管护客户经理工号
	,t3.prm_mgr_nm                               as 主管护客户经理姓名
	,t3.prm_org_id                               as 主管护机构号
	,t3.prm_org_nm                               as 主管户机构名称
    ,t4.brc_org_nm  as 主管户分行
    ,t4.sbr_org_nm  as 主管户支行
from adm_upss.aml_t3r_cst_pers t1               --存量个人客户身份信息表
INNER JOIN (
	SELECT DISTINCT party_id
	from adm_upss.adm_upss_aml_t47_id_deposit t1
    WHERE   t1.dt = '20250731'
    AND t1.ACCT_TYPE_CD = 'DEP'
	and t1.open_dt between '20240101' and '20250731'
)t2 on t1.cst_no=t2.party_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  substr(t1.cst_no,3,10) = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
where t1.dt='20250731'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES01_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES01_2 AS
select t1.head_no                               as 报告机构编码
	,t1.bank_code1                              as 客户号归属机构网点代码   --对应Tb_bank表中的Bank_code1
	,t1.cst_no                                  as 客户号
	,t1.open_time                               as 创建日期     --YYYYMMDD
	,t1.close_time                              as 结束日期     --年月日格式YYYYMMDD
	,t1.acc_name                                as 客户名称
	-- ,t1.address                                 as 住所地
	,t1.operate                                 as 经营范围
	,decode(t1.set_file,'11','营业执照','12','其他') as 依法设立或经营的执照名称     --按如下填写。11：营业执照；12：其他。对于多证合一的机构，填写11
	,t1.license                                 as 依法设立或经营的执照号码         --对应Set_file的号码，对于多证合一的机构填写统一社会信用代码
	,t1.id_deadline                             as 依法设立或经营的执照到期日       --YYYYMMDD，长期用99991231表示
	,t1.org_no                                  as 组织机构代码
	,t1.tax_no                                  as 税务登记证号码
	,t1.rep_name                                as 法定代表人或负责人姓名
	,t1.id_type2                                as 法定代表人或负责人身份证件类型代码   --按如下填列。11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,decode(t1.id_type2,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 法定代表人或负责人身份证件类型
    -- ,t1.id_no2                                  as 法定代表人或负责人身份证件号码
	,t1.id_start_day2                           as 法定代表人或负责人身份证起始日期
	,t1.id_deadline2                            as 法定代表人或负责人身份证件到期日     --YYYYMMDD，长期用99991231表示
	,t1.man_name                                as 控股股东或者实际控制人姓名
	,t1.id_type3                                as 控股股东或者实际控制人身份证件类型代码   --按如下填列。11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件；20：单位证件类型填写数字
    ,decode(t1.id_type3,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 控股股东或者实际控制人身份证件类型
    -- ,t1.id_no3                                  as 控股股东或者实际控制人身份证件号码
	,t1.id_start_day3                           as 控股股东或者实际控制人身份证起始日期
	,t1.id_deadline3                            as 控股股东或者实际控制人身份证件到期日 --YYYYMMDD，长期用99991231表示
	,t1.ope_name                                as 授权办理业务人员姓名
	,t1.id_type4                                as 授权办理业务人员身份证件类型代码 --按如下填列。11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,decode(t1.id_type4,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 授权办理业务人员身份证件类型
    -- ,t1.id_no4                                  as 授权办理业务人员身份证件号码
	,t1.id_start_day4                           as 授权办理业务人员身份证起始日期
	,t1.id_deadline4                            as 授权办理业务人员身份证件到期日   --YYYYMMDD，长期用99991231表示
	,t1.industry                                as 行业 --填写文字；如采用代码记录的，需转化为文字
	,t1.reg_amt                                 as 注册资本金       --不带货币符号和+-号，保留2位小数
	,t1.code                                    as 注册资本金币种   --采用国标，如RMB、USD等；下同
	,t1.sys_name                                as 系统名称         --如涉及多个系统，逐一全部列出，用;分隔
	,t1.cst_state                               as 客户号状态
	,t1.cst_state_date                          as 客户号状态认定日期
	,t1.risk_code                               as 当前风险等级
	,t1.risk_time                               as 当前风险等级划分日期
	,t1.aml3_id_type                            as 3号令身份证件种类
	,t1.dml_date                                as 数据维护日期
	,t1.dml_code                                as 数据维护机构代码
	,t1.cst_yn                                  as 本机构客户标识
	,t1.open_time2                              as 建立业务关系日期
	,t1.close_time2                             as 结束业务关系日期
	,t1.is_smkh                                 as 名下账户是否均为处于睡眠状态
	,t1.is_wjhke                                as 名下账户是否均未激活
	,t1.is_jxkh                                 as 名下账户是否均处于久悬状态
	-- ,t1.contact                                 as 联系方式
	,t1.real_amt                                as 实缴资本金
	-- ,t1.address2                                as 实际经营地
	,t1.bo_name1                                as 受益所有人1姓名
	,t1.bo_idtype1                              as 受益所有人1身份证件类型代码
    ,decode(t1.bo_idtype1,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 受益所有人1身份证件类型
	-- ,t1.bo_idno1                                as 受益所有人1身份证件号码
	,t1.bo_iddeadline1                          as 受益所有人1身份证件到期日
	,t1.bo_name2                                as 受益所有人2姓名
	,t1.bo_idtype2                              as 受益所有人2身份证件类型代码
    ,decode(t1.bo_idtype2,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 受益所有人2身份证件类型
	-- ,t1.bo_idno2                                as 受益所有人2身份证件号码
	,t1.bo_iddeadline2                          as 受益所有人2身份证件到期日
    ,t3.cst_id
	,t3.prm_mgr_id                               as 主管护客户经理工号
	,t3.prm_mgr_nm                               as 主管护客户经理姓名
	,t3.prm_org_id                               as 主管护机构号
	,t3.prm_org_nm                               as 主管户机构名称
    ,t4.brc_org_nm  as 主管户分行
    ,t4.sbr_org_nm  as 主管户支行
from adm_upss.aml_t3r_cst_unit              t1 --存量单位客户身份信息表
INNER JOIN (
	SELECT DISTINCT party_id
	from adm_upss.adm_upss_aml_t47_cp_deposit t1
    WHERE   t1.dt = '20250731'
    AND t1.ACCT_TYPE_CD = 'DEP'
	and t1.open_dt between '20240101' and '20250731'
)t2 on t1.cst_no=t2.party_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  substr(t1.cst_no,3,10) = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
where t1.dt='20250731'
;
-- 2	截至取数日，分行高风险客户分布
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES02_1 AS
SELECT  t2.*
       ,t3.acct_num         AS 客户账号
       ,t3.账户状态
       ,t4.application_num    AS 可疑案例编号
       ,t4.application_advice AS 案例意见
       ,t4.action_explain     AS 可疑行为处理说明
from adm_upss.aml_t3r_risk_new              t1              --存量客户最新风险等级表
inner join SJXQ_SJ2025072841_CST_RES01_1    t2
on t1.cst_no=t2.客户号
left join(
    SELECT  t1.party_id,t1.acct_num,t1.HX_STATUS_CD
        ,c1.cd_val_dscr     as 账户状态
    FROM    adm_upss.adm_upss_aml_t47_id_deposit t1
    left join edw.dwd_code_library_dd   c1
    on  T1.HX_STATUS_CD = c1.cd_val
    and c1.dt=t1.dt
    WHERE   t1.dt = '20250731'
    AND t1.ACCT_TYPE_CD = 'DEP'
)t3 on t1.cst_no=t3.party_id
left join adm_upss.aml_t07_case_application_uh  t4
on t1.cst_no=t4.party_id
and t4.dt=t1.dt
and t4.cast_type = '2' --案例类型:1:大额 2:可疑
where t1.dt='20250731'
and t1.risk_code='10'   --高风险
and t1.acc_type='11'    --公私标识  11：个人；12：单位
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES02_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES02_2 AS
SELECT  t2.*
       ,t3.acct_num         AS 客户账号
       ,t3.账户状态
       ,t4.application_num    AS 可疑案例编号
       ,t4.application_advice AS 案例意见
       ,t4.action_explain     AS 可疑行为处理说明
from adm_upss.aml_t3r_risk_new              t1              --存量客户最新风险等级表
inner join SJXQ_SJ2025072841_CST_RES01_2    t2
on t1.cst_no=t2.客户号
left join(
    SELECT  t1.party_id,t1.acct_num,t1.HX_STATUS_CD
        ,c1.cd_val_dscr     as 账户状态
    FROM    adm_upss.adm_upss_aml_t47_cp_deposit t1
    left join edw.dwd_code_library_dd   c1
    on  T1.HX_STATUS_CD = c1.cd_val
    and c1.dt=t1.dt
    WHERE   t1.dt = '20250731'
    AND t1.ACCT_TYPE_CD = 'DEP'
)t3 on t1.cst_no=t3.party_id
left join adm_upss.aml_t07_case_application_uh  t4
on t1.cst_no=t4.party_id
and t4.dt=t1.dt
and t4.cast_type = '2' --案例类型:1:大额 2:可疑
where t1.dt='20250731'
and t1.risk_code='10'   --高风险
and t1.acc_type='12'    --公私标识  11：个人；12：单位
;
-- 3	2024年至2025年6月30日，分行可疑案例报送表
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES03 AS
select t1.aosp                                   as 疑点分析
	,t1.bptc                                     as 银行与支付机构之间的业务交易编码
	,t1.catm                                     as 客户账户销户时间
	,t1.catp                                     as 客户账户类型
	,t1.cbcn                                     as 客户银行卡号码
	,t1.cbct                                     as 客户银行卡类型
	,t1.cfct                                     as 对方金融机构网点代码类型
	,t1.cfic                                     as 对方金融机构网点代码
	,t1.cfin                                     as 对方金融机构网点名称
	,t1.cfrc                                     as 对方金融机构网点行政区划代码
	,t1.citp                                     as 客户身份证件_证明文件类型
	,t1.crat                                     as 交易金额
	,t1.crsp                                     as 资金来源与用途
	,t1.crtp                                     as 交易币种
	,t1.csnm                                     as 客户号
	,t1.ctac                                     as 客户账号
	-- ,t1.ctid                                     as 客户身份证件_证明文件号码
	,t1.ctnm                                     as 客户姓名_名称
	,t1.detr                                     as 可疑交易报告紧急程度
	,t1.dorp                                     as 报送方向
	,t1.finc                                     as 金融机构网点代码
	,t1.mirs                                     as 人工补正标识
	,t1.oatm                                     as 客户账户开立时间
	,t1.ocbt                                     as 客户银行卡其他类型
	,t1.ocec                                     as 非柜台交易方式的设备代码
	,t1.ocit                                     as 可疑主体控股股东其他身份证件_证明文件类型
	,t1.octt                                     as 非柜台交易方式
	,t1.odrp                                     as 其他报送方向
	,t1.oitp                                     as 其他身份证件_证明文件类型
	,t1.ooct                                     as 其他非柜台交易方式
	,t1.orit                                     as 可疑主体法定代表人其他身份证件_证明文件类型
	,t1.orxn                                     as 初次报送的可疑交易报告报文名称
	,t1.otpr                                     as 其他可疑交易报告触发点
	,t1.ricd                                     as 报告机构编码
	,t1.rlfc                                     as 金融机构与客户的关系
	,t1.rotf                                     as 交易信息备注
	,t1.rpmn                                     as 收付款方匹配号
	,t1.rpnm                                     as 可疑交易报告填报人员
	,t1.rpmt                                     as 收付款方匹配号类型
	,t1.rpnc                                     as 上报网点代码
	-- ,t1.scid                                     as 可疑主体控股股东或实际控制人身份证件_证明文件号码
	,t1.scit                                     as 可疑主体控股股东或实际控制人身份证件_证明文件类型
	,t1.scnm                                     as 可疑主体控股股东或实际控制人名称
	-- ,t1.sctl                                     as 可疑主体联系电话
	-- ,t1.sear                                     as 可疑主体住址_经营地址
	-- ,t1.seei                                     as 可疑主体其他联系方式
	-- ,t1.seid                                     as 可疑主体身份证件_证明文件号码
	,t1.senm                                     as 可疑主体姓名_名称
	,t1.setn                                     as 可疑主体总数
	,t1.setp                                     as 可疑主体身份证件_证明文件类型
	,t1.sevc                                     as 可疑主体职业或行业
	-- ,t1.srid                                     as 可疑主体法定代表人身份证件号码
	,t1.srit                                     as 可疑主体法定代表人身份证件类型
	,t1.srnm                                     as 可疑主体法定代表人姓名
	,t1.stcb                                     as 资金交易及客户行为情况
	,t1.stcr                                     as 可疑交易特征代码
	,t1.stnm                                     as 可疑交易总数
	,t1.stnt                                     as 可疑主体国籍
	-- ,t1.tbid                                     as 交易代办人身份证件_证明文件号码
	,t1.tbit                                     as 交易代办人身份证件_证明文件类型
	,t1.tbnm                                     as 交易代办人姓名
	,t1.tbnt                                     as 交易代办人国籍
	,t1.tcac                                     as 交易对手账号
	,t1.tcat                                     as 交易对手账户类型
	-- ,t1.tcid                                     as 交易对手身份证件_证明文件号码
	,t1.tcit                                     as 交易对手身份证件_证明文件类型
	,t1.tcnm                                     as 交易对手姓名_名称
	,t1.ticd                                     as 业务标识号
	,t1.torp                                     as 报送次数标志
	,t1.tosc                                     as 疑似涉罪类型
	,t1.tptr                                     as 可疑交易报告触发点
	-- ,t1.trcd                                     as 交易发生地
	,t1.tsdr                                     as 资金收付标志
	,t1.tstm                                     as 交易时间
	,t1.tstp                                     as 交易方式
	,t1.tsct                                     as 涉外收支交易分类与代码
	,t1.org_id                                   as 机构号
	,t1.sbsj                                     as 上报时间 --格式为&ldquo;年年年年月月日日&rdquo;
	,t1.rept                                     as 报文回执
	,t1.bwhcmc                                   as 报文回执名称
	,t1.bwmc                                     as 报文名称
	,t1.rpt_id                                   as 报告号
    ,t3.cst_id
	,t3.prm_mgr_id                               as 主管护客户经理工号
	,t3.prm_mgr_nm                               as 主管护客户经理姓名
	,t3.prm_org_id                               as 主管护机构号
	,t3.prm_org_nm                               as 主管户机构名称
    ,t4.brc_org_nm  as 主管户分行
    ,t4.sbr_org_nm  as 主管户支行
from adm_upss.aml_t3r_sus_report            t1 --可疑交易报告明细表
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  substr(t1.csnm,3,10) = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
where t1.dt='20250731'
and t1.sbsj between '20240101' and '20250630'
;
-- 4	2024年至2025年6月30日，分行曾初评或人工评为较高风险以上的客户的历次评级记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES04 AS
select t1.bank_code1                             as 机构网点代码    --,客户号归属机构网点代码
	,t1.cst_no                                   as 客户号
	,t1.self_acc_name                            as 客户名称
	-- ,t1.id_no                                    as 身份证件号码
	,decode(t1.acc_type,'11','个人','12','单位')  as 公私标识       --11：个人；12：单位
	,decode(t1.risk_code,'10','高','11','中高')   as 风险等级    --如采取三级分类：10：高；11：中；12：低。如采取五级分类：10：高；11：中高；12：中；13：中低；14：低。依此类推，按等级从高到低依次升序填写，用数字代表等级
	,t1.dt_time                                  as 等级划分日期 --如果评定流程为系统先评，再人工确认的，应填写人工确认日期
	,t1.norm                                     as 划分依据    --评分分值（无分值的填写评定理由）
	,t1.first_risk                               as 是否为首次风险等级划分
	,t1.man_audit                                as 是否进行人工调整
	,t1.per_audit                                as 是否为定期审核
	,t1.fcheck                                   as 初评理由
	,t1.scheck                                   as 复评理由
from adm_upss.aml_t3r_risk_his              t1 --存量客户最新风险等级表
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  substr(t1.cst_no,3,10) = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
where t1.dt = '20250731'
AND t1.dt_time between '20240101' and '20250630'
;
-- 5	2024年至2025年6月30日，分行查冻扣客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES05 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_nm      AS 客户名称
       ,t1.qry_ctrl_dt AS 查控日期
       ,t1.qry_ctrl_tm AS 查控时间
       ,t1.exe_rsn     AS 执行原因
       ,t1.instt_nm    AS 有权机关名称
       ,t1.nfrz_ind    AS 解冻标志
       ,t1.frz_bgn_dt  AS 冻结起始日期
       ,t1.frz_tmn_dt  AS 冻结终止日期
       ,t3.prm_mgr_id  AS 主管护客户经理工号
       ,t3.prm_mgr_nm  AS 主管护客户经理姓名
       ,t3.prm_org_id  AS 主管护机构号
       ,t3.prm_org_nm  AS 主管户机构名称
       ,t4.brc_org_nm  AS 主管户分行
       ,t4.sbr_org_nm  AS 主管户支行
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd t1 --司法查冻扣汇总信息
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
WHERE t1.dt = '20250731'
AND t1.qry_ctrl_dt between '20240101' and '20250630'
AND ( t1.instt_typ_cd IN ( '04' , '05' ) OR ( ( t1.instt_nm LIKE '%法院%' OR t1.instt_typ_cd = '01' ) AND t1.LAW_DOC_ID LIKE '%刑%' ) )
;
-- 7	当前仍在执行中的泰惠收商户明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES07 AS
select t1.prof_type                                as 商户种类ID    --特约商户所属的业务种类包括网络支付、条码支付、银行卡POS收单3类 10：POS收单；11：条码支付；12：线上收单；13：其它。用数字代表，如果属于多种业务种类的，分别创建多条记录
    ,decode(t1.prof_type,'10','POS收单','11','条码支付','12','线上收单','13','其它') as 商户种类
    ,t1.cst_no                                   as 收单机构系统内部商户识别号_客户号
	,t1.join_code                                as 商户内部编码        --银行根据不同业务种类设置的商户内部编码。	对应业务类型创建多条记录。例如，客户作为银行卡线下收单商户的商户内部编码，作为扫码支付商户的商户内部编码等。
	,t1.clearing_name                            as 上送清算机构名称    --例如：银联、网联等。同时上送多个清算机构则据实填列，用英文半角逗号分隔。如交易不上送清算机构则填@N。
	,t1.join_code1                               as 上送银联的商户编码  --如交易信息可上送银联，填写上送银联交易信息中的商户编码；如交易信息不上送银联，则填@N
	,t1.join_code2                               as 上送网联的商户编码  --如交易信息可上送网联，填写上送网联交易信息中的商户编码；如交易信息不上送网联，则填@N
	,t1.join_code3                               as 上送其他清算机构的商户编码  --如交易信息可上送除银联、网联外的其他清算机构，填写上送其他清算机构交易信息中的商户编码。如同时上送多个除银联、网联外的清算机构，且相应有多个商户编码，则据实填列，用英文半角逗号分隔，填写顺序与clearing_name一致。如交易信息不上送其他清算机构，则填@N
	,t1.acc_name                                 as 特约商户名称    --依法设立或经营登记的证件上的名称，如为企业法人、个体工商户，则填报营业执照名称；如为学校、医疗机构等事业单位，则填报事业单位法人证书、医疗机构执业许可证登记名称等；如为免予工商登记的小微商户填写自然人姓名
	,t1.acc_name1                                as 经营名称
	,t1.acc_type                                 as 商户类型ID    --10：对公商户；11：个体工商户；12：免予工商登记的小微商户；19：其他。
    ,decode(t1.acc_type,'10','对公商户','11','个体工商户','12','免予工商登记的小微商户','19','其他') as 商户类型
	,t1.acc_ind1                                 as 商户所属行业1  --填报上送银联的商户行业编码。 如无，则填@N
	,t1.acc_ind2                                 as 商户所属行业2  --填报上送网联的商户行业编码。 如无，则填@N
	,t1.acc_ind3                                 as 商户所属行业3  --填报上送其他清算机构的商户行业编码。 如无，则填@N
	,t1.bord_flag                                as 商户境内外标识ID --11：境内商户；12：境外商户
    ,decode(t1.bord_flag,'11','境内商户','12','境外商户') as 商户境内外标识
	,t1.cross_border                             as 境内商户开展跨境业务标识ID  --11：是；12：否。Bord_flag=11：境内商户时填写
    ,decode(t1.cross_border,'11','是','12','否') as 境内商户开展跨境业务标识
	,t1.nation                                   as 境外商户所属国家或地区  --按照 GB/T 2659-2000 世界各国和地区名称代码标准填写。英文缩写，如 CHN、HK。Bord_flag=12：境外商户时填写
	,t1.open_time                                as 建立业务关系日期        --入网时间 YYYYMMDD
	,t1.close_time                               as 撤销日期_终止业务关系   --  YYYYMMDD
	,t1.coo_state                                as 合作状态ID    --10：在用；11：冻结；12：终止合作。
    ,decode(t1.coo_state,'10','在用','11','冻结','12','终止合作') as 合作状态
	,t1.id_type                                  as 自然人证件种类ID      --按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民来往内地通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字,Acc_type为12时填写
    ,decode(t1.id_type,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 自然人证件种类
    -- ,t1.id_no                                    as 自然人身份证件号码 按上述种类填写号码,Acc_type为12时填写
	,t1.id_deadline                              as 自然人身份证件有效期截止日  --YYYYMMDD，长期用99991231表示；下同。Acc_type为12时填写
	,t1.nation1                                  as 自然人国籍  --按照 GB/T 2659-2000 世界各国和地区名称代码标准填写。英文缩写，最大三位字母，如CHN、HK。Acc_type为12时填写
	,t1.cst_sex                                  as 自然人性别ID  --11：男；12：女。按照 GB/T 2659-2000 世界各国和地区名称代码标准填写。
    ,decode(t1.cst_sex,'11','男','12','女')     as 自然人性别
	,t1.occupation                               as 自然人职业  --Acc_type为12时不填
	-- ,t1.contact                                  as 自然人联系方式 Acc_type为12时不填
	-- ,t1.address                                  as 地址 Acc_type为10、11时填写实际经营地址，Acc_type为12时填写住所地。超出200字符截断处理。
	,t1.add_code                                 as 所属地区代码    --按照《中华人民共和国行政区划代码》（GB/T2260-2007）填写6位数字码。
	,t1.operate                                  as 经营范围    --Acc_type为12时不填
	,t1.org_no                                   as 组织机构代码 --Acc_type为12时不填
	,decode(t1.set_file,'11','营业执照','') as 依法设立或经营的执照名称 --11：营业执照；12：其他。Acc_type为12时不填
	,t1.license                                  as 依法设立或经营的执照号码 --对应执照号码或成立文件的文号,Acc_type为12时不填
	,t1.license_deadline                         as 依法设立或经营的执照有效期截止日 --YYYYMMDD
	,t1.man_name                                 as 控股股东或实际控制人姓名或名称  --Acc_type为12时不填
	,t1.id_type1                                 as 控股股东或实际控制人证件种类ID --按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民来往内地通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件；20：单位证件。填写数字,Acc_type为12时不填
	,decode(t1.id_type1,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 控股股东或实际控制人证件种类
    -- ,t1.id_no1                                   as 控股股东或实际控制人证件号码
	,t1.id_deadline1                             as 控股股东或实际控制人证件有效期截止日 --YYYYMMDD,Acc_type为12时不填
	,t1.rep_legal                                as 法定代表人或负责人姓名 --Acc_type为12时不填
	,t1.id_type2                                 as 法定代表人或负责人证件种类ID    -- 按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民来往内地通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字,Acc_type为12时不填
	,decode(t1.id_type2,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 法定代表人或负责人证件种类
    -- ,t1.id_no2                                   as 法定代表人或负责人证件号码
	,t1.id_deadline2                             as 法定代表人或负责人证件有效期截止日 --YYYYMMD,Acc_type为12时不填
	,t1.handler_name                             as 授权办理业务人员姓名 --Acc_type为12时不填
	,t1.id_type3                                 as 授权办理业务人员证件种类ID    -- 按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民来往内地通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件。填写数字,Acc_type为12时不填
	,decode(t1.id_type3,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 授权办理业务人员证件种类
    -- ,t1.id_no3                                   as 授权办理业务人员证件号码
	,t1.id_deadline3                             as 授权办理业务人员证件有效期截止日 --YYYYMMDD，Acc_type为12时不填
	,t1.reg_amt                                  as 注册资本金 --不带货币符号和+-号，Acc_type为12时不填，保留2位小数
	,t1.code                                     as 注册资本金币种 --采用国标，如RMB、USD等；下同
	,t1.self_acc_type                            as 商户收单结算账户类型ID  --  10：单位银行账户；11：个人银行账户；12：其他账户；19：未约定收单结算账户。
    ,decode(t1.self_acc_type,'10','单位银行账户','11','个人银行账户','12','其他账户','19','未约定收单结算账户') as 商户收单结算账户类型
	-- ,t1.self_acc_type1                           as 特约商户收单账户类型  11：支付账户；12：银行账户；13：其他
	,t1.self_acc_no                              as 商户收单结算账户账号  --如商户有多个收单结算账户，应填写多个账号，不同账号用英文半角逗号分隔。Self_acc_type为19时填@N。
	,t1.self_acc_name                            as 商户收单结算账户名称  --如商户有多个收单结算账户，应填写多个户名，不同户名用英文半角逗号分隔，填写顺序与Self_acc_no保持一致。Self_acc_type为19时填@N。
	,t1.set_bank_hq                              as 收单结算账户开户机构  --填写开户银行法人的营业执照上的名称。如商户有多个收单结算账户，应填写多个开户机构名称，用英文半角逗号分隔，填写顺序与Self_acc_no保持一致。Self_acc_type为19时填@N。
	-- ,t1.self_bank_name                           as 特约商户收单账户开户银行名称
	,decode(t1.is_checked_bank_acc,'11','是','12','否')                      as 收单结算账户归属单位标识 --11：是；12：否。如商户有多个收单结算账户，应填写多个标识，不同标识用英文半角逗号分隔。Self_acc_type为19时填@N。
	,decode(t1.opening_checked_bank_acc,'11','是','12','否')                 as 被查单位结算账户开立标识 --11：是；12：否
	,decode(t1.dept_type,'11','自行拓展','12','外包服务机构拓展')              as 商户拓展方式  --11：自行拓展；12：外包服务机构拓展。
	,decode(t1.agents_type,'10','企业','11','个体工商户','12','个人','13','其他') as 外包服务机构类型  --10：企业；11：个体工商户；12：个人；13：其他；Dept_type为11时填写。
	,t1.agents_name                              as 外包服务机构名称 --Dept_type为12时填写
	,t1.agents_license                           as 外包服务机构编码 --Dept_type为12时填写
	,t1.acc_add                                  as 商户登记网址 --网络特约商户及线上扫码特约商户填写。填写网络商户登记网址或微信公众号ID，App上架备案信息等。
	,t1.acc_ip                                   as 商户登记IP --网络特约商户及线上扫码特约商户填写。
	,t1.acc_icp_no                               as 商户ICP备案_许可证号 --网络特约商户及线上扫码特约商户填写。
	,decode(t1.settle_type,'10','T+0','11','T+1','12','D+0','13','D+1','14','其他') as 交易资金结算周期    --10：T+0；11:T+1；12：D+0；13:D+1；14：其他
	,t5.trx_tot_cnt 	as 检查期间交易总次数
	,t5.trx_tot_amt 	as 检查期间交易总金额
    ,t6.levelkey as 反洗钱风险等级
    ,t6.statistic_dt as 反洗钱风险等级评定时间
    ,t3.prm_mgr_id  AS 主管护客户经理工号
    ,t3.prm_mgr_nm  AS 主管护客户经理姓名
    ,t3.prm_org_id  AS 主管护机构号
    ,t3.prm_org_nm  AS 主管户机构名称
    ,t4.brc_org_nm  AS 主管户分行
    ,t4.sbr_org_nm  AS 主管户支行
from adm_upss.aml_t3r_mch_inf               t1  --特约商户信息表
inner join edw.dim_bus_chnl_ths_mch_inf_dd  t2 --泰惠收商户基本信息
on t1.join_code=t2.mch_id
and t2.dt=t1.dt
and t2.mch_sts_cd='00'     --00:执行中|16:注销|99:中止
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  SUBSTR(t1.cst_no,3,10) = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
left join(
	select join_code                                --商户内部编码 银行为扫码支付特约商户设置的商户内部编码
		,count(1) 	as trx_tot_cnt
		,sum(nvl(rmb_amt,0))  as trx_tot_amt            --折人民币交易金额 以元为单位，不带货币符号和+-号，外币交易金额按交易当日汇率折算为人民币，保留2位小数
	from adm_upss.aml_t3r_qrc_mch_trx_dtl_inf     --条码特约商户交易明细表
	where dt between '20240101' and '20250630'
	GROUP BY join_code
)t5 on t1.join_code=t5.join_code
left join adm_upss.aml_t37_party_result_curr t6
on t1.cst_no=t6.party_id
and t6.dt=t1.dt
where t1.dt='20250731'
;
-- 用上表，此表非反洗钱用表
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES07_1 AS
select t1.mch_id                                   as 商户编号
	,t1.mch_typ_cd                               as 商户类型代码
	,t1.mch_sht_nm                               as 商户简称
	,t1.mch_nm                                   as 商户名称
	,t1.mch_area_cd                              as 商户所属地区代码
	,t1.con_nm                                   as 联系人姓名
	-- ,t1.con_tel_nbr                              as 联系电话
	-- ,t1.con_adr                                  as 联系地址
	-- ,t1.afl_org_id                               as 所属机构
	-- ,t1.mgr_id                                   as 客户经理工号
	,t1.bus_lcn_typ_cd                           as 营业执照类型代码
	,t1.bus_lcn_nbr                              as 营业执照号码
	,t1.bus_lcn_nvld_dt                          as 营业执照失效日期
	-- ,t1.mch_reg_adr                              as 商户注册地址
	,t1.lgp_nm                                   as 法人姓名
	-- ,t1.lgp_tel_nbr                              as 法人联系电话
	,t1.lgp_doc_typ_cd                           as 法人证件类型代码
	-- ,t1.lgp_doc_nbr                              as 法人证件号码
	,t1.lgp_doc_nvld_dt                          as 法人证件有效期
	,t1.reg_dt                                   as 注册日期
	,t1.mcc_yl                                   as MCC组别
	,t1.mcc_sub_yl                               as MCC类别
	,t1.chnl_no                                  as 渠道号
	,t1.apl_chnl_no                              as 商户进件渠道
	,t1.actv_ind                                 as 参与活动标识
	,t1.actv_no                                  as 满减活动编号
	-- ,t1.longitude                                as 经度
	-- ,t1.latitude                                 as 纬度
	,t1.vrf_typ_cd                               as 核实类型代码
	,t1.vrf_sts_cd                               as 核实状态代码
	,t1.blst_mch_mrk                             as 黑名单商户标记
	,t1.blst_rsn                                 as 黑名单原因
	,t1.mch_opr_xcp_rsn                          as 商户经营异常原因
	,t1.prm_apl_ind                              as 主动申请标志
	,t1.atn_nm                                   as 代办人姓名
	,t1.atn_doc_typ                              as 代办人证件类型
	-- ,t1.atn_id_card_id                           as 代办人身份证号
	,t1.hdl_mnl_id                               as 经办人工号
	,t1.opr_nm                                   as 经办人姓名
	-- ,t1.opr_ctc_tel                              as 经办人联系电话
	,t1.cst_id                                   as 客户号
	-- ,t1.mgr_nm                                   as 管护客户经理名称
	,t1.rpt_ind                                  as 特殊业务办理报备标志
	,t1.prcs_rsn                                 as 特殊业务办理事由
	,t1.door_ind                                 as 上传门头照标志
	,t1.wrt_ind                                  as 证明材料手写标识
	,t1.bus_typ_cd                               as 业务类型代码
	,t1.cmsn_ind                                 as 代办标志
	,t1.shop_id                                  as 店铺号
	,t1.entp_lgp_cst_id                          as 企业法人客户号
	,t1.entp_cst_id                              as 企业客户号
	,t1.lgp_ocp_cd                               as 法人职业代码
	,t1.last_upd_tm                              as 最后更新时间
	,t1.lgtd_latd_inf_src                        as 经纬度信息来源
	,t1.lgtd_latd_addr_cnr                       as 经纬度地址_国家名称
	,t1.lgtd_latd_addr_pvc                       as 经纬度地址_省份名称
	,t1.lgtd_latd_addr_city                      as 经纬度地址_市名称
	,t1.lgtd_latd_addr_dist                      as 经纬度地址_区名称
	,t1.vrf_dt                                   as 核实日期
	,t1.chg_chnl_ind                             as 存量切渠道标志   --(20250121开始有数据)|C1
	,t1.chg_chnl_tm                              as 渠道切换时间 --(20250121开始有数据)|C14
       ,t3.prm_mgr_id  AS 主管护客户经理工号
       ,t3.prm_mgr_nm  AS 主管护客户经理姓名
       ,t3.prm_org_id  AS 主管护机构号
       ,t3.prm_org_nm  AS 主管户机构名称
       ,t4.brc_org_nm  AS 主管户分行
       ,t4.sbr_org_nm  AS 主管户支行
from edw.dim_bus_chnl_ths_mch_inf_dd        t1 --泰惠收商户基本信息
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
where t1.dt='20250731'
and t1.mch_sts_cd='00'     --00:执行中|16:注销|99:中止
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES08_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES08_1 AS
select t1.clr_dt                                   --清算日期|C8
	,t1.entr_act_dt                              --入账日期|C8
	,t1.mch_id                                   --商户编号|C32
	,t1.trx_amt                                  --交易金额|DECIMAL
	,t1.clr_amt                                  --清算金额|DECIMAL
	,t1.stl_act_id                               --结算账号|C64
	,t1.stl_act_nm                               --结算账户户名|C32
    ,t1.dt
    ,t2.客户号
from edw.dwd_bus_chnl_ths_entr_act_di   t1        --泰惠收商户入账明细
inner join SJXQ_SJ2025072841_CST_RES07  t2
on t1.mch_id=t2.商户编号
where t1.dt between '20240101' and '20250731'
and t1.clr_dt between '20240101' and '20250630'
;
-- SELECT * FROM SJXQ_SJ2025072841_CST_RES08_1
-- 8	2024年至2025年6月30日，仍在执行中的商户，月笔均收款金额达到5万以上的月份占4个月以上的。
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES08 AS
SELECT  t2.客户号
    ,t2.商户编号
    ,substr(t1.clr_dt,1,6)      AS 交易月份
    ,round(AVG(t1.trx_amt),4)   AS 笔均交易金额
    ,case when avg(t1.trx_amt)>50000 then '是' else '' end as 当月是否达标
from edw.dwd_bus_chnl_ths_entr_act_di   t1        --泰惠收商户入账明细
inner join SJXQ_SJ2025072841_CST_RES07  t2
on t1.mch_id=t2.商户编号
where t1.dt between '20240101' and '20250731'
and t1.clr_dt between '20240101' and '20250630'
group by t2.客户号,t2.商户编号,交易月份
;
-- 9	2024年至2025年6月30日，仍在执行中的商户，月交易金额达100万以上的。
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES09 AS
SELECT  t2.客户号
       ,t2.商户编号
       ,substr(t1.clr_dt,1,6)       AS 交易月份
       ,round(SUM(trx_amt)/10000,4) AS 月交易金额_万
from edw.dwd_bus_chnl_ths_entr_act_di   t1        --泰惠收商户入账明细
inner join SJXQ_SJ2025072841_CST_RES07  t2
on t1.mch_id=t2.商户编号
where t1.dt between '20240101' and '20250731'
and t1.clr_dt between '20240101' and '20250630'
group by t2.客户号,t2.商户编号,交易月份
having sum(trx_amt)>1000000
;
-- 11	现金结售汇明细
-- edw.dwd_bus_ibiz_idv_fx_stl_dtl_dd	国结个人结售汇明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES11 AS
SELECT  t1.TICD           AS 业务流水号
       ,t1.COUNTER_NO     AS 柜员号
       ,t1.TX_DT          AS 交易日期
       ,t1.DT_TIME        AS 交易时间
       ,t1.SELF_BANK_CODE AS 交易行代码
       ,t1.ACC_NAME       AS 客户姓名
       ,t1.OUT_CUR        AS 付出币种
       ,t1.OUT_ORG_AMT    AS 付出原币种金额
       ,t1.OUT_USD_AMT    AS 付出折美元金额
       ,t1.IN_CUR         AS 收入币种
       ,t1.IN_ORG_AMT     AS 收入原币种金额
       ,t1.IN_USD_AMT     AS 收入折美元金额
       ,t1.SETTLE_TYPE    AS 业务类型
       ,t1.dt             AS 日期分区
       ,t2.cst_id         AS 客户号
       ,t3.prm_mgr_id     AS 主管护客户经理工号
       ,t3.prm_mgr_nm     AS 主管护客户经理姓名
       ,t3.prm_org_id     AS 主管护机构号
       ,t3.prm_org_nm     AS 主管户机构名称
       ,t4.brc_org_nm     AS 主管户分行
       ,t4.sbr_org_nm     AS 主管户支行
FROM adm_upss.adm_upss_aml_t3r_cash_convert_mid t1 --现钞兑换交易明细表
left join edw.dws_cst_bas_inf_dd 	t2
on t1.id_no=t2.doc_nbr
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  t2.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
WHERE t1.DT <= '20250728' 	--t-3
and t1.DT >= '20250628'
;
-- 12	代理办理业务
DROP   TABLE IF     EXISTS SJXQ_SJ2025072841_CST_RES12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072841_CST_RES12 AS
select t1.*
    ,t3.prm_mgr_id  AS 主管护客户经理工号
    ,t3.prm_mgr_nm  AS 主管护客户经理姓名
    ,t3.prm_org_id  AS 主管护机构号
    ,t3.prm_org_nm  AS 主管户机构名称
    ,t4.brc_org_nm  AS 主管户分行
    ,t4.sbr_org_nm  AS 主管户支行
from(
	SELECT head_no                                  as 报告机构编码
        ,bank_code1                               as 开户行代码
        ,self_acc_name                            as 账户户名
        ,decode(acc_state,'11','正常','12','其他') as 账户状态   --11：正常；12：其他
        ,self_acc_no                              as 账号   --表中每个账号一条记录，不能为空；如果只有卡号无账号，填写卡号，即账号与卡号一致
        ,card_no                                  as 卡号   --如开设账户有提供银行卡，应在本字段填写卡号，没有卡号为空。如果存在1个账号对应多个卡号（或多个账号对应1个卡）的情况，应按照账号与卡号的对应关系分多条记录全部列出
        ,decode(acc_type,'11','个人','12','单位')  as 公私标识       --11：个人；12：单位
        ,acc_type1                                as 个人账户种类代码   --当Acc_type =11时填写：11：代表I类账户；12：代表II类账户；13：代表III类账户；14：代表信用卡账户
        ,decode(acc_type1,'11','I类账户','12','II类账户','13','III类账户','14','信用卡账户') as 个人账户种类
        -- ,id_no                                    as 身份证件号码个人客户按照表3Id_no字段、单位客户按照表4 License字段
        ,cst_no                                   as 客户号
        ,decode(fixed_flag,'10','活期','11','定期','') as 定活期标识    --10：活期；11：定期，12：其他
        ,ent_cst_type                             as 单位账户类型   --当Acc_type =12时填写，具体规范见附填写数字
        ,decode(frg_flag,'10','仅本币','11','仅外币','12','通用') as 本外币标识     --10：仅本币；11：仅外币；12：通用
        ,open_time                                as 开户日期   --YYYYMMDD
        ,close_time                               as 销户日期   --YYYYMMDD
        ,decode(acc_flag,'11','是','12','否','')  as 银行卡收单账户标识     --11：是；12：否
        ,decode(credit_flag,'11','借记卡','12','贷记卡','') as 借贷记卡标识   --11：借记卡；12：贷记卡；准贷记卡等具有贷记功能的填写12，卡号为空时不填写
        ,decode(w_type,'11','开通','12','未开通','') as 账户网银标识        --11：开通；12：未开通
        -- ,bank_tel                                 as 手机银行号码
        ,decode(open_type,'11','柜面','12','非柜面','') as 开户标识     --11：柜面开户；12：非柜面开户
        ,decode(open_type1,'11','代理','12','本人','13','批量')  as 开户标识1    --11：代理；12：本人；13：批量开户（仅公私标识为个人11时填写）
        ,agent_name                               as 代理人姓名     --Agency_flag=11，即发生代理关系时填写
        -- ,agent_tel                                as 代理人联系方式Agency_flag=11，即发生代理关系时填写
        ,agent_type                               as 代理人身份证件种类代码     --Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
        ,decode(agent_type,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳台等有效旅行证件','14','外国公民护照','19','其他') as 代理人身份证件种类
        -- ,agent_no                                 as 代理人身份证件号码Agency_flag=11，即发生代理关系时填写
        ,open_type2                               as 开户标识2
        ,acc_state_date                           as 账户状态日期
        ,dt as 最新数据日期
        ,ROW_NUMBER() over(partition by self_acc_no order by dt desc) rn
		-- SELECT count(DISTINCT self_acc_no)
	from adm_upss.aml_t3r_acct   		                 --符合特定条件的银行账户信息表
	where dt='20250728' 	--t-3
	and acc_state='11'
	and open_type1='11'
	and open_time >='20240101'
)t1
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  substr(t1.客户号,3,10) = t3.cst_id
and t3.dt = '20250731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250731'
and t4.brc_org_nm regexp '丽水|衢州|宁波|上海|泾阳|英德|福清|长乐'
where t1.rn=1
;
SElECT '011' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES01_1
union all
SElECT '012' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES01_2
union all
SElECT '021' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES02_1
union all
SElECT '022' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES02_2
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES05
-- union all
-- SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
-- from SJXQ_SJ2025072841_CST_RES06
union all
SElECT '07' seq, count(1) cnt,count(distinct 商户内部编码) custs
from SJXQ_SJ2025072841_CST_RES07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES09
-- union all
-- SElECT '10' seq, count(1) cnt,count(distinct 客户号) custs
-- from SJXQ_SJ2025072841_CST_RES10
union all
SElECT '11' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072841_CST_RES11
union all
SElECT '12' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ2025072841_CST_RES12
;
/*
011	2388902	2388902
012	405286	405286
021	1573	614
022	1064	259
03	311102	774
04	20400	12339
05	89260	23847
07	117968	104946
08	520694	47926
09	13191	2070
11	13	13
12	10461001	2771144
*/
SElECT '011' seq, * from lab_sjxq.SJXQ_SJ2025072841_CST_RES01_1 LIMIT 1000;
SElECT '012' seq, * from lab_sjxq.SJXQ_SJ2025072841_CST_RES01_2 LIMIT 1000;
SElECT '021' seq, * from lab_sjxq.SJXQ_SJ2025072841_CST_RES02_1 LIMIT 1000;
SElECT '022' seq, * from lab_sjxq.SJXQ_SJ2025072841_CST_RES02_2 LIMIT 1000;
SElECT '03' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES03 LIMIT 1000;
SElECT '04' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES04 LIMIT 1000;
SElECT '05' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES05 LIMIT 1000;
SElECT '07' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES07 LIMIT 1000;
SElECT '08' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES08 LIMIT 1000;
SElECT '09' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES09 LIMIT 1000;
SElECT '11' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES11 LIMIT 1000;
SElECT '12' seq, * from  lab_sjxq.SJXQ_SJ2025072841_CST_RES12 LIMIT 1000;
***施源_SJ2025070961_分行社区数据分析.sql
-- 施源_SJ2025070961_分行社区数据分析
-- 截止2025年6月30日，金华分行正式客户清单（取正式客户标识为1）
DROP   TABLE IF     EXISTS SJXQ_SJ2025070961_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070961_CST_01 AS
SELECT  t1.cst_id               AS 客户号
       ,t4.cst_chn_nm           AS 客户名称
       ,t1.prm_mgr_id           AS 主管护客户经理工号
       ,t1.prm_mgr_nm           AS 主管护客户经理姓名
       ,t1.prm_org_id           AS 主管护机构号
       ,t1.prm_org_nm           AS 主管户机构名称
       ,t2.brc_org_nm           AS 主管户分行
       ,t2.sbr_org_nm           AS 主管户支行
       ,t1.forml_cst_ind        AS 正式客户标识
       ,t3.vld_cst              AS 有效户
       ,t6.sub_cmnt_id          AS 普惠子社区编号
       ,t7.cmnt_nm              AS 普惠子社区名称
       ,t6.dpd_tm               AS 普惠子社区挂靠时间
       ,t5.客户最早开户日期
       ,t8.dep_bal_mon_avg      AS 存款余额月日均
       ,t9.loan_bal_acs_mon_avg AS 贷款余额月日均
from adm_pub.adm_csm_cbas_mng_inf_dd           t1 --客户集市-客户基础-客户管户信息
inner join edw.dim_hr_org_mng_org_tree_dd      t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '金华分行'
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t3 --客户规则类通用营销特性表3
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
left join edw.dws_cst_bas_inf_dd 		t4 		    --客户基础信息汇总表
on  t1.cst_id = t4.cst_id
and t4.dt = t1.dt
left join(
	SELECT  A1.cst_id
	       ,MIN(A1.opn_dt) AS 客户最早开户日期
	FROM edw.dim_bus_dep_act_inf_dd A1
	WHERE A1.DT = '20250630'
	GROUP BY  A1.cst_id
)t5 on t1.cst_id=t5.cst_id
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = t1.dt
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t1.dt
left join adm_pub.adm_csm_cbus_dep_inf_dd 	t8	--存款业务信息表
ON      t1.cst_id = t8.cst_id
AND     t8.dt = t1.dt
left join adm_pub.adm_csm_cbus_loan_inf_dd 	t9	--贷款业务信息
ON      t1.cst_id = t9.cst_id
AND     t9.dt = t1.dt
where t1.dt = '20250630'
and t1.forml_cst_ind = '1'  --限制正式客户
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025070961_CST_01
;
select *
from SJXQ_SJ2025070961_CST_01
***曹春晖_SJ2025031991_现场实地走访.sql
-- 客户调查记录信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025031991_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031991_CST_01 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as svy_mod_nm
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c2.cd_val_dscr          as svy_addr_typ_nm
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t2.参与人岗位姓名
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join(
    SELECT rel_serno
    from edw.loan_svy_rcd_rel_pcpt_inf  --调查记录关联参与人信息
    where dt='@@{yyyyMMdd}'
    and del_ind='0'
    GROUP BY rel_serno
)t2 on t1.svy_rcd_serno=t2.rel_serno
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.sys_reg_org_id like '3202%'	--系统登记机构编号 苏州分行
and t1.svy_dt between '20250101' and '20250319' --2025年1月1日-2025年3月19日
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031991_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031991_CST_02 AS
SELECT  svy_rcd_serno   AS 调查记录流水号
       ,cst_id          AS 客户号
       ,cst_nm          AS 客户名称
       ,svy_dt          AS 调查日期
       ,svy_mod_nm      AS 调查方式
       ,svy_addr_typ_nm AS 调查地址类型
       ,pcp_mnl_no      AS 参与人工号
       ,pcp_psn_nm      AS 参与人姓名
       ,参与人岗位姓名
       ,rn              AS 序号
from SJXQ_SJ2025031991_CST_01
where svy_mod_cd='01' --'现场实地'
;
SElECT '02' seq, *
from SJXQ_SJ2025031991_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025031991_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025031991_CST_02
***曹春晖_SJ20250408146_苏州分行实地走访.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 于彪
-- 创建日期: 2025-04-09 15:31:05
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 苏州分行2025年1月1日-2025年4月8日，信贷系统现场实地走访记录
-- 数据需求字段
-- 客户号，客户名称，调查日期，调查方式，调查人，调查地址类型，参与调查人
-- 客户调查记录信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250408146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250408146_CST_01 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as svy_mod_nm
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c2.cd_val_dscr          as svy_addr_typ_nm
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t2.参与人岗位姓名
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join(
    SELECT rel_serno
    from edw.loan_svy_rcd_rel_pcpt_inf  --调查记录关联参与人信息
    where dt='@@{yyyyMMdd}'
    and del_ind='0'
    GROUP BY rel_serno
)t2 on t1.svy_rcd_serno=t2.rel_serno
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.sys_reg_org_id like '3202%'	--系统登记机构编号 苏州分行
and t1.svy_dt between '20250101' and '20250408' --2025年1月1日-2025年3月19日
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250408146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250408146_CST_02 AS
SELECT  svy_rcd_serno   AS 调查记录流水号
       ,cst_id          AS 客户号
       ,cst_nm          AS 客户名称
       ,svy_dt          AS 调查日期
       ,svy_mod_nm      AS 调查方式
       ,svy_addr_typ_nm AS 调查地址类型
       ,pcp_mnl_no      AS 参与人工号
       ,pcp_psn_nm      AS 参与人姓名
       ,参与人岗位姓名
       ,rn              AS 序号
from SJXQ_SJ20250408146_CST_01
where svy_mod_cd='01' --'现场实地'
;
SElECT '02' seq, *
from SJXQ_SJ20250408146_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250408146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250408146_CST_02
;
/*
01	10319	6172
02	5712	5147
*/***朱文文_SJ2025072226_湖州分行合同担保人信息.sql
﻿-- 朱文文_SJ2025072226_湖州分行合同担保人信息
-- 2025.3.25-2025.7.21期间，针对湖州分行担保人签署纸质合同、混搭合同，是否签署承担连带保证责任重要事项前置告知书情况
DROP   TABLE IF     EXISTS SJXQ_SJ2025072226_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072226_CST_01 AS
select 	t1.ctr_sgn_dt                               --合同签收日期|c8
    ,t1.grnt_ctr_no                              --担保合同编号|c32
	,t1.grnt_ctr_typ_cd                          --担保合同类型代码|c3
    ,c1.cd_val_dscr as 担保合同类型
    ,t1.grnt_mod_cd                              --担保方式代码 005:信用|050:资产池|010:保证|020:抵押|040:质押
	,t1.wrat_cst_id                              --被担保人客户号|c20
	,t1.wrat_nm                                  --被担保人名称|c200
	,t1.sgn_ctr_mod_cd                           --签约方式代码|c1
    ,c2.cd_val_dscr as 签约方式
	,t1.sys_reg_psn_id                           --系统登记人编号|c20
	,t1.sys_reg_org_id                           --系统登记机构号|c20
	,t1.sys_reg_dt                               --系统登记日期|c8
    ,nvl(t2.gtor_no,t6.OBG_ID) as 保证人编号
    ,nvl(t2.gtor_nm,t6.OBG_NM) as 保证人名称
	,t3.ln_org_id                                --信贷归属机构
	,t3.ln_org_nm                                --信贷归属机构名称
	,t3.ln_mgr_id                                --信贷归属客户经理
	,t3.ln_mgr_nm                                --信贷归属客户经理名称
from edw.dim_bus_loan_ctr_grnt_inf_dd           t1      --担保合同信息
left JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t2 --担保合同保证人信息
on  t1.GRNT_CTR_NO=t2.GRNT_CTR_NO
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd      t3 --客户集市-客户基础-客户管户信息
on  t1.wrat_cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd       t4 --考核机构树
on  t3.ln_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm ='湖州分行'
LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
ON      t1.grnt_ctr_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     c1.DT = t1.dt
LEFT JOIN    edw.dwd_code_library_dd 	c2 --码值表
ON      t1.sgn_ctr_mod_cd = c2.cd_val
AND     c2.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     c2.DT = t1.dt
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20250722'
) t6 on t1.GRNT_CTR_NO=t6.GRNT_CTR_NO
where t1.dt='20250722'
and t1.ctr_sgn_dt between '20250325' and '20250721'
;
-- 结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025072226_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072226_CST_02 AS
SELECT  ctr_sgn_dt  AS 合同签收日期
       ,grnt_ctr_no AS 担保合同编号
       ,保证人编号
       ,保证人名称
       ,wrat_cst_id AS 被担保人客户号
       ,wrat_nm     AS 被担保人名称
       ,担保合同类型
       ,签约方式
       ,ln_org_id   AS 被担保人信贷归属机构
       ,ln_org_nm   AS 被担保人信贷归属机构名称
       ,ln_mgr_id   AS 被担保人信贷归属客户经理
       ,ln_mgr_nm   AS 被担保人信贷归属客户经理名称
from SJXQ_SJ2025072226_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct grnt_ctr_no) custs
from SJXQ_SJ2025072226_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 担保合同编号,保证人编号) custs
from SJXQ_SJ2025072226_CST_02
;
/*
01	6245	3796
02	6245	6104
*/
SElECT '02' seq, *
from SJXQ_SJ2025072226_CST_02
;
***朱晓雨_SJ2025063056_客户IP查询.sql
﻿-- 朱晓雨_SJ2025063056_客户IP查询
-- 账号：6235350093088808，2023年7月1日-2025年6月12日期间与对方户名为：戴均领 的客户所发生的全量交易IP地址。
DROP   TABLE IF     EXISTS SJXQ_SJ2025063056_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025063056_CST_01 as
select dep_act_id                               --存款账号|C32
	,cst_act_id                               --客户账号|C32
	,cst_id                                   --客户号|C20
	,act_nm                                   --账户名称|C300
from edw.dws_bus_dep_act_inf_dd               --存款账户信息汇总
where dt='@@{yyyyMMdd}'
and cst_act_id ='6235350093088808'
;
-- 2. 交易明细表 10号调查
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025063056_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025063056_CST_02 as
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C200
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C200
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	,t1.late_upd_tm	                             --最后更新时间|C20
	,t1.glbl_srl_nbr	                         --全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS IP地址
    ,'个人' as data_src,t1.dt
    ,t1.hst_rtn_err_cd,t1.hst_rtn_err_dscr
from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
inner join(
    select distinct cst_id
    from SJXQ_SJ2025063056_CST_01
) t5 on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20230701' and '20250612'
and t1.hst_rtn_err_dscr regexp '处理成功'
-- union all
-- select t1.chnl_typ_cd                              --渠道类型代码|C2
-- 	,t1.trx_seq                                  --交易流水号|C20
-- 	,t1.cst_id                                   --客户号|C10
-- 	,t1.trx_cd                                   --交易代码|C6
-- 	,t1.pmt_act_id                               --付款方账号|C30
-- 	,t1.pmt_act_nm                               --付款方户名|C300
-- 	-- ,pmt_org_id                               --付款方网点|C10
-- 	,t1.rcv_act_id                               --收款方账号|C32
-- 	,t1.rcv_act_nm                               --收款方户名|C300
-- 	,t1.rcv_opn_bnk                              --收款方开户行|C300
-- 	-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
-- 	,t1.ccy_cd                                   --币种|C3
-- 	,t1.usr_sbm_tm                               --用户提交时间|C14
-- 	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
-- 	-- ,rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
-- 	,t1.usr_cmt                                  --用户备注|C256
-- 	-- ,instr_sts_cd                             --指令状态代码|C2
-- 	,t1.late_upd_tm                              --最后更新时间|C20
-- 	,t1.glbl_srl_nbr	--	全局流水号|C40
-- 	,t1.cst_end_ip                               --客户端ip|C100
-- 	,t1.ovs_ind                                  --境外标志|C1
--     ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
-- 	,t1.cnr_nm                                   --国家名称|C200
-- 	,t1.pvc_nm                                   --省份名称|C200
-- 	,t1.cty_nm                                   --城市名称|C200
--     ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
--     ,CASE
--         WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
--         WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
--         WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
--         END                                                    AS mac
--     ,CASE
--         WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
--         WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
--         WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
--         END                                                    AS ip
--     ,'企业' as data_src,t1.dt
-- from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
-- inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
-- on  t1.cst_id = t3.cst_id
-- and t3.dt ='@@{yyyyMMdd}'
-- inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
-- on  t3.prm_org_id = t4.org_id
-- and t4.dt ='@@{yyyyMMdd}'
-- inner join SJXQ_SJ2025063056_CST_01 t5 on t1.cst_id=t5.cst_id
-- where t1.dt BETWEEN '20220101' and '@@{yyyyMMdd}'
-- and t1.hst_rtn_err_cd = '000000' --交易成功
;
--交易流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025063056_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025063056_CST_03 as
SELECT  t1.dtl_seq_nbr                                                                                                                             AS 序号
    ,t1.trx_dt
    ,t1.trx_tm
       ,T11.sbr_org_nm                                                                                                                             AS 交易行名称
       ,CASE WHEN T2.cst_tp = '1' THEN '个人'
             WHEN T2.cst_tp = '2' THEN '单位' END                                                                                                    AS 公私标识
       ,T2.cst_id                                                                                                                                  --客户号
    --    ,T4.doc_nbr                                                                                                                                 AS 证件号码
       ,T1.cst_act_id                                                                                                                              AS 客户账号
       ,T1.dep_act_id                                                                                                                              AS 存款账号
       ,T1.act_nm                                                                                                                                  AS 账户名称
       ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1' THEN '个人银行结算账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END                                                                AS 账户类型
       ,CASE WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '301' THEN '1类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '302' THEN '2类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '303' THEN '3类账户' END                                                                      AS 账户类别
       ,CASE WHEN T1.cnt_pty_act_nm <> '' AND T1.cnt_pty_fin_instt_nm = '' AND T1.cnt_pty_fin_instt_typ_cd = '' THEN '支付账户等非银行账户'  ELSE '银行账户' END AS 交易对手方账户类别
       ,T1.cnt_pty_fin_instt_cd                                                                                                                    AS 交易对方行代码
       ,T1.cnt_pty_fin_instt_nm                                                                                                                    AS 交易对方行名称
       ,T1.cnt_pty_cst_act_id                                                                                                                      AS 交易对方账号
       ,T1.cnt_pty_act_nm                                                                                                                          AS 交易对方户名
       ,CASE WHEN T1.crd_and_dbt_ind = 'C' THEN '收'
             WHEN T1.crd_and_dbt_ind = 'D' THEN '付' END                                                     AS 资金收付标识
        ,CASE
                WHEN T1.csh_ind = '0' THEN '现金'
                ELSE '转账'
            END                                                                                  AS 现金转账标识
        ,T1.trx_ccy_cd                                                                        AS 币种
        ,T1.trx_amt                                                                           AS 原币种交易金额
        ,T1.trx_amt / 10000                                                                   AS 原币种交易金额万元
        ,T1.trx_amt * T5.usd_exr                                                              AS 折美元交易金额
        ,T1.trx_amt * T5.usd_exr / 10000                                                      AS 折美元交易金额万元
        ,T1.trx_amt * T5.cny_exr                                                              AS 折人民币交易金额
        ,T1.trx_amt * T5.cny_exr / 10000                                                      AS 折人民币交易金额万元
        ,T1.act_bal                                                                           AS 账户余额
        ,T1.act_bal / 10000                                                                   AS 账户余额万元
        ,CASE WHEN T1.agn_nm <> '' THEN '代理' ELSE '本人' END AS 代理交易标识
        -- ,T1.agn_nm                                                                            AS 代理人姓名
        -- ,T1.agn_psn_tel                                                                       AS 代理人联系方式
        -- ,c1.cd_val_dscr                                                                       AS 代理人身份证件种类
        -- ,T1.agn_doc_nbr                                                                       AS 代理人身份证件号码
        ,T1.tlr_srl_nbr                                                                       AS 业务流水号
        ,T1.opr_tlr                                                                           AS 柜员号
        ,T1.smr_dscr                                                                          AS 业务名称
        , CASE WHEN T1.rvs_ind = '1' THEN '是' ELSE '否' END AS 冲账标识
        ,T1.cmt                                                                               AS 摘要说明
        ,CASE
                WHEN c2.cd_val_dscr RLIKE '网上银行'  THEN '网银'
                WHEN c2.cd_val_dscr RLIKE '手机银行'  THEN '手机银行'
                WHEN c2.cd_val_dscr RLIKE '柜面|柜台' THEN '柜面'
                WHEN c2.cd_val_dscr = 'ATM'       THEN 'ATM机具'
                ELSE '其它'
            END                                                                                  AS 交易方式标识
        ,T9.atm_eqp_id                                                                        AS ATM机具编号
        ,T10.afl_org                                                                          AS ATM机具所属行行号
        ,T1.csh_ind,t1.crd_and_dbt_ind
FROM    edw.dwd_bus_dep_bal_chg_dtl_di    	T1 --存款余额发生明细
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T2.DT = '@@{yyyyMMdd}'
inner join SJXQ_SJ2025063056_CST_01    t0
on t1.dep_act_id=t0.dep_act_id
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t3.prm_org_id = t6.org_id
and t6.dt ='@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd     	T4 --客户基础信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20230701' and '20250612'
LEFT JOIN    edw.dwd_code_library_dd    	c1 -- 码值表
ON      T1.agn_doc_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_CHM_FND_AIP_AGR_INF_DD' -- 基金定投协议信息
AND     c1.fld_nm = 'DOC_TYP_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd 	c2 -- 码值表
ON      T1.trx_chnl_cd = c2.cd_val
AND     c2.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c2.fld_nm = 'TRX_CHNL_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_chnl_atm_trx_srl_di T9 --ATM交易流水
ON      T1.cst_act_id = T9.prm_act_id
AND     T1.tlr_srl_nbr = T9.hst_srl_nbr
AND     T1.trx_dt = T9.trx_loc_dt
AND     T9.DT >= '20230701'
left JOIN (
    SELECT eqp_id,afl_org,dt
        ,ROW_NUMBER() over(partition by eqp_id order by dt desc) rn
    from edw.dim_bus_chnl_atm_eqp_inf_dd --ATM设备基本信息表
    where dt<='@@{yyyyMMdd}'
)T10 ON T9.atm_eqp_id = T10.eqp_id
AND     T10.rn=1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T11
ON      T1.trx_bus_org = T11.org_id
AND     T11.dt = '@@{yyyyMMdd}'
WHERE   T1.dt between '20230701' and '20250612'
;
-- 流水关联
DROP   TABLE IF     EXISTS SJXQ_SJ2025063056_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025063056_CST_04 as
SELECT T1.业务流水号,T1.trx_dt,t1.trx_tm,t1.交易对方户名,t1.交易对方行名称,t1.客户账号,t1.原币种交易金额
    ,T6.glbl_srl_nbr
    ,t7.usr_sbm_tm,t7.rcv_act_nm,t7.rcv_opn_bnk,t7.pmt_act_id,t7.trx_amt
    ,t7.跨境交易标识
    ,t7.交易对方所在国家或地区
    ,t7.MAC或IMEI地址
    ,t7.IP地址
from (
    SELECT DISTINCT 业务流水号,trx_dt,trx_tm,交易对方户名
        ,交易对方行名称,客户账号,原币种交易金额
    from SJXQ_SJ2025063056_CST_03
) t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.业务流水号 = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20230701'
INNER join SJXQ_SJ2025063056_CST_02              t7
ON      T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND     T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025063056_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025063056_CST_05 as
SELECT  t1.序号
        ,t1.trx_dt as 交易日期
        ,t1.trx_tm as 交易时间
        ,t1.交易行名称
        ,t1.公私标识
        ,T1.cst_id AS 客户号
        -- ,t1.证件号码
        ,t1.客户账号
        ,t1.存款账号
        ,t1.账户名称
        ,t1.账户类型
        ,t1.账户类别
        ,t1.交易对手方账户类别
        ,t1.交易对方行代码
        ,t1.交易对方行名称
        ,t1.交易对方账号
        ,t1.交易对方户名
        ,t1.资金收付标识
        ,t1.现金转账标识
        ,t1.币种
        ,t1.原币种交易金额
        ,t1.原币种交易金额万元
        ,t1.折美元交易金额
        ,t1.折美元交易金额万元
        ,t1.折人民币交易金额
        ,t1.折人民币交易金额万元
        ,t1.账户余额
        ,t1.账户余额万元
        ,t1.代理交易标识
        -- ,t1.代理人姓名
        --,t1.代理人联系方式
        --,t1.代理人身份证件种类
        --,t1.代理人身份证件号码
        ,t1.业务流水号
        ,t1.柜员号
        ,t1.业务名称
        ,t1.冲账标识
        ,t1.摘要说明
        ,t2.跨境交易标识
        ,t2.交易对方所在国家或地区
        ,t1.交易方式标识
        ,t2.IP地址
        ,t1.ATM机具编号
        ,t1.ATM机具所属行行号
        ,t2.MAC或IMEI地址
FROM SJXQ_SJ2025063056_CST_03      T1
left join (
    SELECT  DISTINCT 业务流水号
        ,trx_dt
        ,跨境交易标识
        ,交易对方所在国家或地区
        ,MAC或IMEI地址
        ,IP地址
    FROM    SJXQ_SJ2025063056_CST_04
) t2
on t1.业务流水号=t2.业务流水号
and t1.trx_dt=t2.trx_dt
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025063056_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025063056_CST_06 as
SELECT  客户账号
       ,交易日期
       ,交易时间
       ,交易对方账号
       ,交易对方户名
       ,资金收付标识
       ,原币种交易金额 as 交易金额
       ,IP地址
       ,MAC或IMEI地址
from SJXQ_SJ2025063056_CST_05
where 交易对方户名='戴均领'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025063056_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct glbl_srl_nbr) custs
from SJXQ_SJ2025063056_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ2025063056_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025063056_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025063056_CST_05
;
/*
*/
-- result
SElECT '06' seq, *
from SJXQ_SJ2025063056_CST_06
;
***李传锋_SJ20250213146_政和村行信贷调查.sql
﻿-- 20240801 以来，政和村行经办的业务现场调查记录
--当前合同 20241031
DROP   TABLE IF     EXISTS SJXQ_SJ20250213146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250213146_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.rel_serno	                             --用信申请流水号
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as hpn_typ_nm --发生类型
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.mgr_org_id	    --管户机构号
    ,t1.mgr_id	        --管户人工号
    ,t1.hdl_org_id	    --经办机构编号
    ,t1.hdl_opr_id	    --经办人工号
    ,t1.sys_reg_dt      --系统登记日期
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
where t1.dt='@@{yyyyMMdd}'
and t1.mgr_org_id like '3561%' --政和村行
and t1.sys_reg_dt >='20240801' --系统登记日期
;
-- 侧面打听
DROP   TABLE IF     EXISTS SJXQ_SJ20250213146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250213146_CST_02 AS
select t1.svy_rcd_serno                          --调查记录流水号|C32
	,t1.svy_mod_cd                               --调查方式代码|C2
    ,c1.cd_val_dscr     as svy_mod_nm
	,t1.svy_dt                                   --调查日期|C8
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.svy_addr_typ_cd                          --调查地址类型代码|C3
    ,c2.cd_val_dscr     as svy_addr_typ_nm
	,t1.pcp_mnl_no                               --参与人工号|C20
	,t1.pcp_psn_nm                               --参与人姓名|C200
    ,t2.参与人姓名
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join(
    SELECT rel_serno
    from edw.loan_svy_rcd_rel_pcpt_inf
    where dt='@@{yyyyMMdd}'
    and del_ind='0'
    GROUP BY rel_serno
)t2 on t1.svy_rcd_serno=t2.rel_serno
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt='@@{yyyyMMdd}'
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.cst_id in(select distinct cst_id from SJXQ_SJ20250213146_CST_01)
and t1.svy_mod_cd = '01'    --现场（实地）
and t1.svy_dt >='20240801'  --一个客户存在多次调查，按业务要求设置
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250213146_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250213146_CST_03 AS
SELECT  t1.ctr_serno        AS 合同流水号
        ,t1.cst_id          AS 客户号
        ,t1.cst_nm          AS 客户名称
        ,t1.rel_serno       AS 用信申请流水号
        ,t1.hpn_typ_nm      AS 发生类型
        ,t1.ctr_amt         AS 合同金额
        ,t1.ctr_bal         AS 合同余额
        ,t1.ctr_bgn_dt      AS 合同起始日期
        ,t1.ctr_mtu_dt      AS 合同到期日期
        ,t1.mgr_org_id      AS 管户机构号
        ,t1.mgr_id          AS 管户人工号
        ,t1.hdl_org_id      AS 经办机构编号
        ,t1.hdl_opr_id      AS 经办人工号
        ,t2.svy_rcd_serno   AS 调查记录流水号
        ,t2.svy_dt          AS 调查日期
        ,t2.svy_mod_nm      AS 调查方式代码
        ,t2.svy_addr_typ_nm AS 调查地址类型
        ,t2.参与人姓名
from SJXQ_SJ20250213146_CST_01          t1
inner join SJXQ_SJ20250213146_CST_02    t2
on t1.cst_Id=t2.cst_Id
;
SELECT *
from SJXQ_SJ20250213146_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250213146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250213146_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250213146_CST_03
;
/*
01	1745	1518
02	1663	1347
03	1919	1347
*/***李佳俊_SJ2025052406_配偶关联公司.sql
﻿-- 李佳俊_SJ2025052406_配偶关联公司
-- 客户首次与我行开展信贷业务的时间
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_01 AS
select t1.cst_id,min(t1.ctr_bgn_dt)     as ctr_fst_dt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join(
    SELECT distinct ctr_srl_no
    from adm_rsk.adm_rsk_apl_inter_all            --风险集市应用表-资产质量日常监测源表
    where dt='@@{yyyyMMdd}'
    AND TRIM(bsn_line) = '网申' --条线
)t2 on t1.ctr_serno=t2.ctr_srl_no
where t1.dt='@@{yyyyMMdd}'
and t2.ctr_srl_no is null   --剔除网申
GROUP BY t1.cst_id
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_02 AS
SElECT t1.cst_id
from(
    SElECT cst_id,rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
group by t1.cst_id
;
--客户担任法人的企业 关联企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_03 AS
select t.*
    ,row_number() over(partition by cst_id,entp_cst_id order by priority) rn
from(
    select t1.cst_id
        ,t2.cst_chn_nm                               --客户中文名称
        ,t1.rel_cst_id  as entp_cst_id
        ,t3.cst_chn_nm  as entp_cst_nm
        ,'1' as priority
    from(
        SElECT cst_id,rel_cst_id
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
        and rel_typ='0101' --0101:法定代表人
        union
        SElECT rel_cst_id,cst_id
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
        and rel_typ='0101' --0101:法定代表人
    )t1 inner join edw.dim_cst_idv_bas_inf_dd   t2 --个人客户基本信息
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    left join edw.dws_cst_bas_inf_dd 		    t3 --客户基础信息汇总表
    on t1.rel_cst_id=t3.cst_id
    and t3.dt='@@{yyyyMMdd}'
    union all
    select lgp_cst_id                               --对公客户法人客户号
        ,lgp_nm                                   --对公客户法人客户名称
        ,cst_id                                   --客户号
        ,cst_nm                                   --客户名称
        ,'2' as priority
    from edw.dim_cst_entp_lgp_inf_dd              --对公客户法人信息表
    where dt='@@{yyyyMMdd}'
    and nvl(lgp_cst_id,'')<>''
)t
;
--客户担任实际控制人的企业 关联企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_04 AS
select distinct t1.cst_id
    ,t2.cst_chn_nm                               --客户中文名称
    ,t1.rel_cst_id  as entp_cst_id
    ,t3.cst_chn_nm  as entp_cst_nm
from(
    SElECT cst_id,rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0109' --实际控制人
)t1 inner join edw.dim_cst_idv_bas_inf_dd   t2 --个人客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd 		    t3 --客户基础信息汇总表
on t1.rel_cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
-- 输出结果 20221231
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_05 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_chn_nm  AS 客户名称
       ,t2.ctr_fst_dt  AS 客户首次与我行开展信贷业务的时间
       ,t3.rel_cst_id  AS 配偶
       ,t3.rel_cst_nm  AS 配偶名称
       ,t4.rel_typ     AS 关联关系
       ,t4.entp_cst_id AS 客户关联公司的客户编号
       ,t4.entp_cst_nm AS 客户关联公司的客户名称
from(
    select distinct t1.cst_id                                   --客户号
        ,t2.cst_chn_nm
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dws_cst_bas_inf_dd 	        t2 --客户基础信息汇总表
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
    on  t1.mgr_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm='台州分行'
    where t1.dt='20221231'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t1 left join SJXQ_SJ2025052406_CST_01 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025052406_CST_02 t3
on t1.cst_id=t3.cst_id
left join(
    select cst_id,entp_cst_id,entp_cst_nm
    from(
        select cst_id,entp_cst_id,entp_cst_nm
            ,'法人' as rel_typ
        from SJXQ_SJ2025052406_CST_03
        where rn=1
        union all
        select cst_id,entp_cst_id,entp_cst_nm
            ,'实控人'
        from SJXQ_SJ2025052406_CST_04
    )t group by cst_id,entp_cst_id,entp_cst_nm
)t4 on t1.cst_id=t4.cst_id
;
-- 输出结果 20231231
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_06 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_chn_nm  AS 客户名称
       ,t2.ctr_fst_dt  AS 客户首次与我行开展信贷业务的时间
       ,t3.rel_cst_id  AS 配偶
       ,t3.rel_cst_nm  AS 配偶名称
       ,t4.rel_typ     AS 关联关系
       ,t4.entp_cst_id AS 客户关联公司的客户编号
       ,t4.entp_cst_nm AS 客户关联公司的客户名称
from(
    select distinct t1.cst_id                                   --客户号
        ,t2.cst_chn_nm
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dws_cst_bas_inf_dd 	        t2 --客户基础信息汇总表
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
    on  t1.mgr_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm='台州分行'
    where t1.dt='20231231'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t1 left join SJXQ_SJ2025052406_CST_01 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025052406_CST_02 t3
on t1.cst_id=t3.cst_id
left join(
    select cst_id,entp_cst_id,entp_cst_nm
    from(
        select cst_id,entp_cst_id,entp_cst_nm
            ,'法人' as rel_typ
        from SJXQ_SJ2025052406_CST_03
        where rn=1
        union all
        select cst_id,entp_cst_id,entp_cst_nm
            ,'实控人'
        from SJXQ_SJ2025052406_CST_04
    )t group by cst_id,entp_cst_id,entp_cst_nm
)t4 on t1.cst_id=t4.cst_id
;
-- 输出结果 20241231
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_07 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_chn_nm  AS 客户名称
       ,t2.ctr_fst_dt  AS 客户首次与我行开展信贷业务的时间
       ,t3.rel_cst_id  AS 配偶
       ,t3.rel_cst_nm  AS 配偶名称
       ,t4.rel_typ     AS 关联关系
       ,t4.entp_cst_id AS 客户关联公司的客户编号
       ,t4.entp_cst_nm AS 客户关联公司的客户名称
from(
    select distinct t1.cst_id                                   --客户号
        ,t2.cst_chn_nm
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dws_cst_bas_inf_dd 	        t2 --客户基础信息汇总表
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
    on  t1.mgr_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm='台州分行'
    where t1.dt='20241231'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t1 left join SJXQ_SJ2025052406_CST_01 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025052406_CST_02 t3
on t1.cst_id=t3.cst_id
left join(
    select cst_id,entp_cst_id,entp_cst_nm
    from(
        select cst_id,entp_cst_id,entp_cst_nm
            ,'法人' as rel_typ
        from SJXQ_SJ2025052406_CST_03
        where rn=1
        union all
        select cst_id,entp_cst_id,entp_cst_nm
            ,'实控人'
        from SJXQ_SJ2025052406_CST_04
    )t group by cst_id,entp_cst_id,entp_cst_nm
)t4 on t1.cst_id=t4.cst_id
;
-- 输出结果 20250430
DROP   TABLE IF     EXISTS SJXQ_SJ2025052406_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052406_CST_08 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_chn_nm  AS 客户名称
       ,t2.ctr_fst_dt  AS 客户首次与我行开展信贷业务的时间
       ,t3.rel_cst_id  AS 配偶
       ,t3.rel_cst_nm  AS 配偶名称
       ,t4.rel_typ     AS 关联关系
       ,t4.entp_cst_id AS 客户关联公司的客户编号
       ,t4.entp_cst_nm AS 客户关联公司的客户名称
from(
    select distinct t1.cst_id                                   --客户号
        ,t2.cst_chn_nm
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dws_cst_bas_inf_dd 	        t2 --客户基础信息汇总表
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
    on  t1.mgr_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm='台州分行'
    where t1.dt='20250430'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t1 left join SJXQ_SJ2025052406_CST_01 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025052406_CST_02 t3
on t1.cst_id=t3.cst_id
left join(
    select cst_id,entp_cst_id,entp_cst_nm
    from(
        select cst_id,entp_cst_id,entp_cst_nm
            ,'法人' as rel_typ
        from SJXQ_SJ2025052406_CST_03
        where rn=1
        union all
        select cst_id,entp_cst_id,entp_cst_nm
            ,'实控人'
        from SJXQ_SJ2025052406_CST_04
    )t group by cst_id,entp_cst_id,entp_cst_nm
)t4 on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052406_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052406_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052406_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052406_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052406_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052406_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052406_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052406_CST_08
;
/*
01	2406964	2406964
02	2284024	2283406
03	1140455	941548
04	424513	358718
05	209434	196397
06	211742	198651
07	291143	276944
08	289194	275303
*/
***李佳俊_SJ20250611151_内部超额增额分析.sql
﻿-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_01 AS
SELECT t1.ctr_serno,t1.REL_SERNO,t1.cst_id
	,t2.USC_APLY_SERNO,t2.AHN_LTR_APLY_SERNO
	,t3.SVY_RPT_NO
	,t3.eff_ind        --生效标志|c1
	,t3.sys_reg_psn_id --系统登记人编号|c20
	,t3.sys_reg_org_id --系统登记机构编号|c12
	,t3.sys_reg_tm     --系统登记时间|c20
FROM edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同基础信息
LEFT JOIN edw.dwd_bus_loan_lmt_aply_biz_dd t2 --用信方案
ON t1.REL_SERNO = t2.USC_APLY_SERNO
AND t2.dt = t1.dt
LEFT JOIN edw.dwd_bus_loan_svy_rpt_inf_dd t3 --调查报告信息
ON t3.REL_SERNO = t2.AHN_LTR_APLY_SERNO
AND t3.dt = t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd T4 --客户集市-客户基础-客户管户信息
ON T1.cst_id = T4.cst_id
AND T4.DT = t1.dt
and t4.prm_org_id LIKE '3301%' --台州分行
WHERE t1.dt = '20250531'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--调查报告&mdash;资产负债详情-资产-不动产
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_02 AS
select t1.cst_id,t1.mnl_ases_val,t1.svy_rpt_no,t1.svy_rpt_dt
	,t1.sys_reg_tm,t1.cnt,t1.max_sys_dt,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,t2.svy_rpt_no                               --调查报告编号|c32
		,case when length(t2.svy_rpt_no)=20 then SUBSTR(t2.svy_rpt_no,5,8)
			else SUBSTR(t2.svy_rpt_no,4,8) end as svy_rpt_dt
		-- ,t2.rcd_no                                   --记录编号|c32
		-- ,t2.owr_cst_id                               --产权人客户号|c20
		-- ,t2.owr_nm                                   --产权人名称|c200
		-- ,t2.actl_owr_cst_id                          --实际产权人客户号|c20
		-- ,t2.actl_owr                                 --实际产权人|c200
		-- ,t2.rel_typ_cd                               --关联类型代码|c5
		-- ,t2.buyi_tm                                  --购入时间|c10
		-- ,t2.prch_val                                 --购买价值|c24
		,sum(t2.mnl_ases_val) as mnl_ases_val           --人工评估价值|c24
		-- ,t2.now_nav                                  --现净值|c2
		-- ,t2.rmk                                      --备注|c512
		,count(distinct t2.sys_reg_tm) as cnt
		,max(t2.sys_reg_tm) as max_sys_dt
	from(
		select distinct cst_id
		from SJXQ_SJ20250611151_CST_01
	)t1 inner join edw.dwd_bus_loan_svy_fnc_stat_dtl_data_ass_rl_est_dd	t2 --调查报告&mdash;资产负债详情-资产-不动产
	on t1.cst_id=t2.cst_id
	and t2.dt='20250531' and nvl(t2.svy_rpt_no,'')<>''
	group by t1.cst_id,t2.svy_rpt_no
)t1
;
--调查报告&mdash;资产负债详情-资产-车辆情况
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_03 AS
select t1.cst_id,t1.mnl_ases_val,t1.svy_rpt_no,t1.svy_rpt_dt
	,t1.sys_reg_tm,t1.cnt,t1.max_sys_dt,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,case when length(t3.svy_rpt_no)=20 then SUBSTR(t3.svy_rpt_no,5,8)
			else SUBSTR(t3.svy_rpt_no,4,8) end as svy_rpt_dt
		,t3.svy_rpt_no                               --调查报告编号|c32
		-- ,t3.rcd_no                                   --记录编号|c32
		-- ,t3.owr_cst_id                               --产权人客户号|c20
		-- ,t3.owr_nm                                   --产权人名称|c200
		-- ,t3.actl_owr_nm                              --实际产权人名称|c200
		-- ,t3.actl_owr_cst_id                          --实际产权人客户号|c20
		-- ,t3.rel_typ_cd                               --关联类型代码|c5
		-- ,t3.buyi_tm                                  --购入时间|c10
		-- ,t3.prch_val                                 --购买价值|c24
		,sum(t3.mnl_ases_val) as mnl_ases_val           --人工评估价值|c24
		-- ,t3.now_nav                                  --现净值|c2
		-- ,t3.rmk                                      --备注|c512
		,count(distinct t3.sys_reg_tm) as cnt
		,max(t3.sys_reg_tm) as max_sys_dt
	from(
		select distinct cst_id
		from SJXQ_SJ20250611151_CST_01
	)t1 inner join edw.dim_bus_loan_svy_fnc_stat_detail_data_ass_vhcl_dd	t3 --调查报告&mdash;资产负债详情-资产-车辆情况
	on t1.cst_id=t3.cst_id
	and t3.dt='20250531' and nvl(t3.svy_rpt_no,'')<>''
	group by t1.cst_id,t3.svy_rpt_no
)t1
;
--调查报告&mdash;资产负债详情-资产-现金
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_04 AS
select t1.cst_id,t1.csh_amt,t1.svy_rpt_no,t1.svy_rpt_dt
	,t1.sys_reg_tm,t1.cnt,t1.max_sys_dt,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,case when length(t4.svy_rpt_no)=20 then SUBSTR(t4.svy_rpt_no,5,8)
			else SUBSTR(t4.svy_rpt_no,4,8) end as svy_rpt_dt
		,t4.svy_rpt_no                          --调查报告编号|c32
		,sum(t4.csh_amt) as csh_amt        		--现金金额
		,count(distinct t4.sys_reg_tm) as cnt
		,max(t4.sys_reg_tm) as max_sys_dt
	from(
		select distinct cst_id
		from SJXQ_SJ20250611151_CST_01
	)t1 inner join edw.dwd_bus_loan_svy_fnc_stat_detail_data_ass_cash_dd	t4 --调查报告&mdash;资产负债详情-资产-现金
	on t1.cst_id=t4.cst_id
	and t4.dt='20250531' and nvl(t4.svy_rpt_no,'')<>''
	group by t1.cst_id,t4.svy_rpt_no
)t1
;
-- 资产负债概况
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_05 AS
select t1.cst_id,t1.svy_rpt_no,t1.svy_rpt_dt
	,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,t1.slf_ast_amt
	,t1.slf_lbl_tot_amt
	,t1.slf_ast_lbl_rat		--本人资产负债率
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,t5.svy_rpt_no                          --调查报告编号|c32
		,case when length(t5.svy_rpt_no)=20 then SUBSTR(t5.svy_rpt_no,5,8)
			else SUBSTR(t5.svy_rpt_no,4,8) end as svy_rpt_dt
		,t5.slf_ast_amt                         --本人资产总额|decimal(21,2)
		,t5.slf_lbl_tot_amt                     --本人负债总额|decimal(21,2)
		,t5.slf_ast_lbl_rat		--本人资产负债率
	from(
		select distinct cst_id
		from SJXQ_SJ20250611151_CST_01
	)t1 inner join edw.dwd_bus_loan_svy_fnc_stat_cus_ass_lib_ovew_dd 	t5 --资产负债概况
	on t1.cst_id=t5.cst_id
	and t5.dt='20250531' and nvl(t5.svy_rpt_no,'')<>''
)t1
;
--销售额
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_06 AS
select t1.cst_id,t1.sal_amt,t1.svy_rpt_no,t1.svy_rpt_dt
	,t1.sys_reg_tm,t1.cnt,t1.max_sys_dt,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,t6.svy_rpt_no                          --调查报告编号|c32
		,case when length(t6.svy_rpt_no)=20 then SUBSTR(t6.svy_rpt_no,5,8)
			else SUBSTR(t6.svy_rpt_no,4,8) end as svy_rpt_dt
		,sum(t6.sal_amt)     		as sal_amt                         --本人资产总额|decimal(21,2)
		,count(distinct t6.sys_reg_tm) as cnt
		,max(t6.sys_reg_tm) as max_sys_dt
	from(
		select distinct cst_id
		from SJXQ_SJ20250611151_CST_01
	)t1 inner join edw.dwd_bus_loan_svy_cst_opr_sal_amt_and_npft_dd		t6 --调查报告-经营信息销售额及净利润信息
	on t1.cst_id=t6.cst_id
	and t6.dt='20250531' and nvl(t6.svy_rpt_no,'')<>''
	group by t1.cst_id,t6.svy_rpt_no
)t1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_07 AS
select t1.cst_id
	,round(0.7*nvl(t2.mnl_ases_val,0) + 0.7*nvl(t3.mnl_ases_val,0) + nvl(t4.csh_amt,0),2)  as can_var_cash_amt
	,nvl(t5.slf_ast_amt,0)     as slf_ast_amt           --本人资产总额|decimal(21,2)
	,nvl(t5.slf_lbl_tot_amt,0) as slf_lbl_tot_amt       --本人负债总额|decimal(21,2)
	,nvl(t5.slf_ast_lbl_rat,0) as slf_ast_lbl_rat		--本人资产负债率
	,nvl(t6.sal_amt,0)		   as sal_amt 				--销售额
	,case when nvl(t7.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t7.sam_rsk_ctrl_id end sam_rsk_ctrl_id
	,nvl(t8.cred_total_amt ,0) as cred_total_amt
	,nvl(t81.cred_total_amt,0) as cred_total_amt_24
	,nvl(t82.cred_total_amt,0) as cred_total_amt_22
	,nvl(t9.crd_tot_amt	,0) as crd_tot_amt	--授信总额
	,nvl(t91.crd_tot_amt,0)	as crd_tot_amt_24
	,nvl(t92.crd_tot_amt,0)	as crd_tot_amt_22
from(
	select distinct cst_id
	from SJXQ_SJ20250611151_CST_01
)t1
left join SJXQ_SJ20250611151_CST_02		t2 --调查报告&mdash;资产负债详情-资产-不动产
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ20250611151_CST_03		t3 --调查报告&mdash;资产负债详情-资产-车辆情况
on t1.cst_id=t3.cst_id
and t3.rn=1
left join SJXQ_SJ20250611151_CST_04		t4 --调查报告&mdash;资产负债详情-资产-现金
on t1.cst_id=t4.cst_id
and t4.rn=1
left join SJXQ_SJ20250611151_CST_05 	t5 --资产负债概况
on t1.cst_id=t5.cst_id
and t5.rn=1
left join SJXQ_SJ20250611151_CST_06		t6 --调查报告-经营信息销售额及净利润信息
on t1.cst_id=t6.cst_id
and t6.rn=1
LEFT JOIN edw.dws_cst_bas_inf_dd 	t7 --客户基础信息汇总表
ON      t1.cst_id = t7.cst_id
AND     t7.DT = '20250531'
left join(
	select cst_id,cred_total_amt		--	信用总发生额
	from edw.dws_cst_ccrc_entp_ind_inf_dd	--企业征信指标信息表
	where dt='20250531'
	and report_dsc_rn=1
	union all
	select cst_id,oth_cred_total_amt	--	他行授信总额
	from edw.dws_cst_ccrc_idv_ind_inf_dd	--个人征信指标信息表
	where dt='20250531'
	and report_dsc_rn=1
)t8 on t1.cst_id=t8.cst_id
left join(
	select cst_id,cred_total_amt		--	信用总发生额
	from edw.dws_cst_ccrc_entp_ind_inf_dd	--企业征信指标信息表
	where dt='20240531'
	and report_dsc_rn=1
	union all
	select cst_id,oth_cred_total_amt	--	他行授信总额
	from edw.dws_cst_ccrc_idv_ind_inf_dd	--个人征信指标信息表
	where dt='20240531'
	and report_dsc_rn=1
)t81 on t1.cst_id=t81.cst_id
left join(
	select cst_id,cred_total_amt		--	信用总发生额
	from edw.dws_cst_ccrc_entp_ind_inf_dd	--企业征信指标信息表
	where dt='20220531'
	and report_dsc_rn=1
	union all
	select cst_id,oth_cred_total_amt	--	他行授信总额
	from edw.dws_cst_ccrc_idv_ind_inf_dd	--个人征信指标信息表
	where dt='20220531'
	and report_dsc_rn=1
)t82 on t1.cst_id=t82.cst_id
left join adm_pub.adm_csm_clab_ln_inf_dd	t9 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t9.cst_id
and t9.dt='20250531'
left join adm_pub.adm_csm_clab_ln_inf_dd	t91 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t91.cst_id
and t91.dt='20240531'
left join adm_pub.adm_csm_clab_ln_inf_dd	t92 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t92.cst_id
and t92.dt='20220531'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250611151_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250611151_CST_08 AS
SELECT  t1.cst_id           AS 客户号
	,t1.sam_rsk_ctrl_id  AS 同一风险控制号
	,t1.can_var_cash_amt AS 可变现资产价值
	,t1.slf_ast_amt      AS 本人资产总额
	,t1.slf_lbl_tot_amt  AS 本人负债总额
	,t1.sal_amt          AS 销售额
	,case when t1.slf_lbl_tot_amt>0 then round(t1.can_var_cash_amt/t1.slf_lbl_tot_amt,4)
		else null end as 敞口可变现资产比
	,case when t1.slf_lbl_tot_amt>0 then round(t1.sal_amt/t1.slf_lbl_tot_amt,4)
		else null end as 销贷比
	,case when t1.slf_ast_amt>0 then round(t1.slf_lbl_tot_amt/t1.slf_ast_amt,4) else null end as 资产负债率
	,t1.slf_ast_lbl_rat		as 本人资产负债率
	,case when sum(t1.slf_lbl_tot_amt) over(partition by t1.sam_rsk_ctrl_id) >0 then round(sum(t1.can_var_cash_amt) over(partition by t1.sam_rsk_ctrl_id)/sum(t1.slf_lbl_tot_amt) over(partition by t1.sam_rsk_ctrl_id),4)
		else null end as 同一风险控制号敞口可变现资产比
	,case when sum(t1.slf_lbl_tot_amt) over(partition by t1.sam_rsk_ctrl_id) >0 then round(sum(t1.sal_amt) over(partition by t1.sam_rsk_ctrl_id)/sum(t1.slf_lbl_tot_amt) over(partition by t1.sam_rsk_ctrl_id),4)
		else null end as 同一风险控制号销贷比
	,case when sum(t1.slf_ast_amt) over(partition by t1.sam_rsk_ctrl_id) >0 then round(sum(t1.slf_lbl_tot_amt) over(partition by t1.sam_rsk_ctrl_id)/sum(t1.slf_ast_amt) over(partition by t1.sam_rsk_ctrl_id),4)
		else null end as 同一风险控制号资产负债率
	,t1.cred_total_amt    AS 当前他行授信额度
	,t1.cred_total_amt_24 AS 一年前他行授信额度
	,t1.cred_total_amt_22 AS 三年前他行授信额度
	,t1.crd_tot_amt       AS 当前我行授信额度
	,t1.crd_tot_amt_24    AS 一年前我行授信额度
	,t1.crd_tot_amt_22    AS 三年前我行授信额度
	,t1.cred_total_amt - t1.cred_total_amt_24 as 他行额度变化_1年前
	,t1.crd_tot_amt - t1.crd_tot_amt_24 as 我行额度变化_1年前
	,t1.cred_total_amt - t1.cred_total_amt_22 as 他行额度变化_3年前
	,t1.crd_tot_amt - t1.crd_tot_amt_22 as 我行额度变化_3年前
	,t2.量化风险等级
from SJXQ_SJ20250611151_CST_07 	t1
left join(
	-- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
	select cst_id
		,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
		--'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
	from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
	where dt = '20250531'
	union
	select cst_id
		,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
	from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
	where dt = '20250531'
)t2 on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250611151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250611151_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250611151_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250611151_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250611151_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250611151_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250611151_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250611151_CST_08
;
/*
01	268170	257627
02	89889	89889
03	8557	8557
04	13461	13461
05	132814	132814
06	47003	47003
07	180651	180651
08	180651	180651
*/
SElECT '08' seq, *
from SJXQ_SJ20250611151_CST_08
***李初昀_SJ2025041056_高交易额个人客户数量.sql
-- 1.高交易额个人客户数量及金额
-- 客户名下所有账户全年全口径收付双边交易额（包括同名账户转账、账户内资产形态变化、理财类产品的交易金额）超过1亿元的个人客户数量，剔除理财、同名账户转账
-- 2. 高交易额个人客户交易额：客户全年交易总额，剔除理财及资管类产品申购赎回、银证转账、同名账户互转
SELECT  '1'                    AS ind
       ,SUM(trx_amt_tot)/10000 AS 高交易额个人客户交易额
       ,COUNT(distinct cst_id) AS 高交易额个人客户数量
FROM
(
	SELECT  c.cst_id
	       ,SUM(a.trx_amt) trx_amt_tot
	FROM edw.dwd_bus_dep_bal_chg_dtl_di a --存款余额发生明细
	INNER JOIN edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
	ON a.cst_act_id = b.cst_act_id AND b.dt = '20231231' AND b.act_sts_cd <> 'C' --未销户客户
	INNER JOIN edw.dws_cst_bas_inf_dd c --客户基础信息汇总
	ON b.cst_id = c.cst_id AND c.dt = '20231231' AND c.cst_typ_cd = '1'
	LEFT JOIN adm_pub.adm_csm_cbas_mng_inf_dd t2
	ON c.CST_ID = T2.CST_ID AND T2.DT = '20231231'
	LEFT JOIN edw.dim_hr_org_mng_org_tree_dd t3
	ON t2.prm_org_id = t3.org_id AND T3.DT = '20231231'
	-- 同名账户互转
	LEFT JOIN
	(
		SELECT  dep_act_id
		       ,dtl_seq_nbr
		FROM edw.dwd_bus_dep_bal_chg_dtl_di AS a1
		LEFT JOIN edw.dim_bus_dep_cst_act_inf_dd AS a2
		ON a1.cst_act_id = a2.cst_act_id AND a2.DT = '20231231'
		LEFT JOIN edw.dim_bus_dep_cst_act_inf_dd AS a3
		ON a1.cnt_pty_cst_act_id = a3.cst_act_id AND a3.DT = '20231231'
		WHERE a1.dt >= '20230101'
		AND a1.dt <= '20231231'
		AND a2.cst_id = a3.cst_id
	) AS t4
	ON a.dep_act_id = t4.dep_act_id AND a.dtl_seq_nbr = t4.dtl_seq_nbr
	WHERE a.dt >= '20230101'
	AND a.dt <= '20231231'
	AND t3.brc_org_id like '3563%' --福建龙海泰隆村镇银行
		, 'FD0011', 'FD0012', 'FD0013', 'FD0014', 'FD0015', 'FD0016', 'FD0017', 'FD0018', 'FD0019', 'FD0020'
		, 'LC0001', 'LC0002', 'LC0003', 'LC0004', 'LC0005', 'LC0006'
		, 'TY0046', 'TY0047', 'TY0048', 'TY0049', 'TY0159', 'TY0160', 'TY0161', 'TY0162', 'TY0163', 'TY5059', 'TY5060'
		, 'ZHB001', 'ZHB002')
	AND t4.dep_act_id is null
	GROUP BY  c.cst_id having SUM(a.trx_amt)>100000000
) d
WHERE d.trx_amt_tot >= 100000000
;
***李初昀_SJ2025080546_对公客户信息补充.sql
﻿-- 李初昀_SJ2025080546_对公客户信息补充
-- 李初昀_SJ2025080546_对公客户信息补充
-- 李初昀028505-国有企业账户
--  '3563%' --福建龙海泰隆村镇银行
-- 在本机构开立基本存款账户的存量主体数量
-- 合计
-- 其中：1.国有公司
-- 2.外国公司分支机构
-- 3.久悬、管控等异常或睡眠账户
-- 国有公司基本存款账户清单
-- t1.act_sts_cd AS 存款账户状态代码
-- A 正常
-- B 不动户
-- C 销户
-- D 久悬户
-- E 封闭冻结
-- F 金额冻结
-- G 未启用
-- H 待启用
-- I 转营业外收入
-- Y 预销户
-- t1.act_sts_cd NOT IN ( 'B' , 'C' , 'D' , 'I' , 'Y' )
DROP TABLE IF EXISTS SJXQ_SJ2025080546_CSTLIST PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080546_CSTLIST AS
SELECT  t1.cst_id           AS 客户号
       ,INFO.cst_chn_nm     AS 客户名称
       ,t1.opn_org          AS 开户机构ID
       ,khjg.org_nm         AS 开户机构
       ,khjg.brc_org_nm     AS 开户分行
       ,t1.opn_dt           AS 开户日期
       ,t1.cst_act_id       AS 客户账户
       ,t1.dep_act_id       AS 存款账号
       ,t1.act_sts_cd       AS 存款账户状态代码
       ,mz.cd_val_dscr      AS 存款账户状态
       ,'基本户'               AS 账户分类代码
       ,TQY.entp_ecn_typ_cd AS 企业类型码值
       ,tqy.lctax_cert_no 	as 统一社会信用代码
       ,mz_QYLX.cd_val_dscr AS 企业类型
       ,c1.cd_val_dscr      AS 组织机构类型
       ,t4.prm_mgr_id       AS 主管护客户经理工号
       ,t4.prm_mgr_nm       AS 主管护客户经理姓名
       ,t4.prm_org_id       AS 主管护机构号
       ,t4.prm_org_nm       AS 主管户机构名称
FROM edw.dws_bus_dep_act_inf_dd t1
LEFT JOIN edw.dwd_code_library_dd mz
ON t1.act_sts_cd = mz.cd_val
AND mz.dt = '20250804'
LEFT JOIN app_ado.dim_hr_org_mng_org_tree_dd khjg
ON t1.opn_org = khjg.org_id
AND khjg.dt = '20250804'
LEFT JOIN edw.dim_cst_entp_bas_inf_dd TQY
ON T1.cst_id = TQY.CST_ID
AND TQY.DT = '20250804'
LEFT JOIN edw.dwd_code_library_dd mz_QYLX
ON TQY.entp_ecn_typ_cd = mz_QYLX.cd_val
AND mz_QYLX.dt = '20250804'
LEFT JOIN edw.dwd_code_library_dd c1
ON TQY.ORG_ORG_TYP_CD = c1.cd_val
AND c1.dt = '20250804'
LEFT JOIN edw.dws_cst_bas_inf_dd INFO
ON T1.CST_ID = INFO.CST_ID
AND INFO.DT = '20250804'
LEFT JOIN adm_pub.adm_csm_cbas_mng_inf_dd t4 --客户集市-客户基础-客户管户信息
ON t1.cst_id = t4.cst_id
AND t4.dt = '20250804'
WHERE t1.dt = '20250804'
AND t1.opn_org LIKE '3563%'
AND t1.cst_tp = '2' -- 所属客户类型代码 对公 2 对私1
AND T1.act_ctg_cd_1 = '0001'
;
-- desc edw.dim_cst_entp_bas_inf_dd
----加管控措施
DROP TABLE IF EXISTS SJXQ_SJ2025080546_CSTLIST_ADD PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080546_CSTLIST_ADD AS
SELECT  T2.*
    ,CASE WHEN t3.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END AS 是否账户止付
    ,CASE WHEN t4.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END AS 是否账户冻结
    ,CASE WHEN t5.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END AS 是否暂停非柜面
    -- , t6.fg_day_lmt
FROM lab_sjxq.SJXQ_SJ2025080546_CSTLIST T2
LEFT JOIN
(
	SELECT  DISTINCT t1.cst_act_id
	FROM edw.dwd_bus_dep_frz_inf_dd t1 --账户冻结登记
	WHERE t1.DT = '20250804'
	AND t1.FRZ_SRC_CD = '2' --账户止付
	AND t1.NFRZ_IND = '0'
) t3
ON t2.客户账户 = t3.cst_act_id
LEFT JOIN
(
	SELECT  DISTINCT t1.cst_act_id
	FROM edw.dwd_bus_dep_frz_inf_dd t1 --账户冻结登记
	WHERE t1.DT = '20250804'
	AND t1.FRZ_SRC_CD = '1' --账户冻结
	AND t1.NFRZ_IND = '0'
) t4
ON t2.客户账户 = t4.cst_act_id
LEFT JOIN
(
	SELECT  DISTINCT cst_act_id
	FROM edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
	WHERE DT = '20250804'
	AND ACT_THRS_TYP = '2' --暂停非柜面
	AND evt_id = 'DPDRAW'
) t5
ON t2.客户账户 = t5.cst_act_id
-- LEFT JOIN
-- (
-- 	SELECT  cengcgjz cst_act_id
-- 	       ,leijiedu fg_day_lmt
-- 	FROM edw.core_kdpa_zheddy -- 负债账户额度定义表
-- 	WHERE dt = '20250804'
-- 	AND zhxeleix = '2'
-- 	AND shijbhao = 'FGMXIANE' -- 非柜面限额
-- 	AND edkzzhqi = '1D'
-- ) t6
-- ON t2.客户账户 = t6.cst_act_id
;
-- 输出结果
DROP TABLE IF EXISTS SJXQ_SJ2025080546_CSTLIST_RES PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080546_CSTLIST_RES AS
select t1.*
	,t4.lgl_rprs_psn_nm                          as 法定代表人名称
	,t4.rgst_cpt_amt                             as 注册资本金额_万元
	,t4.rgst_cpt_ccy_nm                          as 注册资本币种名称
	,t4.fd_dt                                    as 成立日期
	,t2.受益人
	,t3.合伙人
	,t5.股东名称及出资比例
from SJXQ_SJ2025080546_CSTLIST_ADD t1
left join(
	SElECT t1.cst_id
	from(
		SElECT cst_id,rel_cst_id,REL_TYP_CD
		from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
		where DT = '20250804'
		and REL_TYP_CD LIKE '09%' --受益人
		union
		SElECT rel_cst_id,cst_id,REL_TYP_CD
		from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
		where DT = '20250804'
		and REL_TYP_CD LIKE '09%' --受益人
	)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
	on t1.rel_cst_id=t2.cst_id
	and t2.dt='20250804'
	and t2.cst_typ_cd='1'   --个人客户
	group by t1.cst_id
)t2 on t1.客户号=t2.cst_id
left join(
	SElECT t1.cst_id
	from(
		SElECT cst_id,rel_cst_id,REL_TYP_CD
		from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
		where DT = '20250804'
		union
		SElECT rel_cst_id,cst_id,REL_TYP_CD
		from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
		where DT = '20250804'
	)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
	on t1.rel_cst_id=t2.cst_id
	and t2.dt='20250804'
	and t2.cst_typ_cd='1'   --个人客户
	group by t1.cst_id
)t3 on t1.客户号=t3.cst_id
left join edw.nout_gsk_zs_ent_out_geb_entp_bsc_inf t4 --外部企业基本信息
on t1.统一社会信用代码=t4.usc_no
and nvl(t4.usc_no,'')<>''
and t4.dt='20250803'
left join(
	select cst_id
	from edw.dim_cst_out_geb_shh_inf_dd t1 --工商企业股东及出资信息
	where dt='20250804'
	group by cst_id
)t5 on t1.客户号=t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025080546_CSTLIST_RES
;
from SJXQ_SJ2025080546_CSTLIST_RES
***李捷_SJ2025020891_四会村行开销户数据.sql
﻿-- 2023年5月29日-2024年7月31日，广东四会泰隆村镇银行高新区支行对私客户开销户数据
-- 03003.人行对私账户报送
DROP   TABLE IF     EXISTS SJXQ_SJ2025020891_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020891_CST_01 AS
SELECT   ORG_ID
        ,BNK_ORG_CD  as BNK_ORG_NO
        ,BANKNO      as AGN_BNK_ORG_NO
FROM    edw.DIM_HR_ORG_BAS_INF_DD A        -- 机构基本信息
LEFT JOIN    (
                 SELECT  DISTINCT  A.BRNO
                                  ,B.BANKNO
                 FROM    edw.SPMT_T_BPIM_PXYBRANCH A  -- 机构代理信息表
                 ,       edw.SPMT_T_BPIM_BRANCHMAP B     -- 行内机构行号映射表
                 WHERE   A.PRODUCTCODE = '1002'
                 AND     B.PRODUCTCODE = '1002'
                 AND     A.PXYBRNO = B.BRNO
                 AND     A.DT = '@@{yyyyMMdd}'
                 AND     B.DT = '@@{yyyyMMdd}'
             ) B
ON      A.ORG_ID = B.BRNO
WHERE   A.DT = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020891_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020891_CST_02 AS
SELECT  DISTINCT T2.cst_chn_nm                                                                                          AS 存款人名称
       ,COALESCE(T2.REG_ADR,T2.CMN_ADR,T2.WRK_ADR)                                                                      AS 地址
       ,T3.pst_cd                                                                                                       AS 邮政编码
       ,T2.mbl_nbr                                                                                                      AS 电话
       ,CASE WHEN T2.DOC_TYP_CD = 'B0101' THEN '1' --身份证
             WHEN T2.DOC_TYP_CD = 'B0200' THEN '8' --户口簿
             WHEN T2.DOC_TYP_CD IN ( 'B0301' ,'B0302' ) THEN '6' --护照
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '7' --港澳台
             WHEN T2.DOC_TYP_CD = 'B1000' THEN '5' --士兵证
             WHEN T2.DOC_TYP_CD = 'B1100' THEN '2' --军官证
             WHEN T2.DOC_TYP_CD = 'B1200' THEN '3' --解放军文职
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '4' --警官
             ELSE '1' END                                                                                               AS 身份证件种类代码
       ,CASE WHEN T2.DOC_TYP_CD = 'B0101' THEN '身份证' --身份证
             WHEN T2.DOC_TYP_CD = 'B0200' THEN '户口簿 ' --户口簿
             WHEN T2.DOC_TYP_CD IN ( 'B0301' ,'B0302' ) THEN '护照' --护照
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '港澳台' --港澳台
             WHEN T2.DOC_TYP_CD = 'B1000' THEN '士兵证' --士兵证
             WHEN T2.DOC_TYP_CD = 'B1100' THEN '军官证' --军官证
             WHEN T2.DOC_TYP_CD = 'B1200' THEN '解放军文职' --解放军文职
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '警官' --警官
             ELSE '身份证' END                                                                                               AS 身份证件种类
       ,T2.doc_nbr AS 身份证件编号
       ,CASE WHEN C.ORG_ID IS NOT NULL THEN CASE
             WHEN COALESCE(C.BNK_ORG_NO,'') = '' THEN COALESCE(C.AGN_BNK_ORG_NO,'')  ELSE C.BNK_ORG_NO END  ELSE '' END AS 开户银行机构代码
       ,T1.cst_act_id                                                                                                   AS 账号
       ,CASE WHEN T1.CST_ACT_TYP_CD = 'Z' THEN '1'
             WHEN T1.CST_ACT_TYP_CD = '1' THEN '2'
             WHEN T1.CST_ACT_TYP_CD IN ( '2' ,'4' ) THEN '4' END                                                        AS 账户类型代码
       ,CASE WHEN T1.CST_ACT_TYP_CD = 'Z' THEN '支票账户'
             WHEN T1.CST_ACT_TYP_CD = '1' THEN '卡'
             WHEN T1.CST_ACT_TYP_CD IN ( '2' ,'4' ) THEN '活期账户' END                                                  AS 账户类型
       ,T1.opn_dt                                                                                                       AS 开户日期
       ,' '                                                                                                             AS 有效日期
       ,CASE WHEN T2.DOC_TYP_CD IN ( 'B0101' ,'B0200' ,'B0301' ) THEN '1'
             WHEN T2.DOC_TYP_CD IN ( 'B1000' ,'B1100' ,'B1200' ) THEN '2'
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '3'
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '4'
             WHEN T2.DOC_TYP_CD = 'B0302' THEN '5'  ELSE '1' END                                                        AS 存款人身份类别代码
       ,CASE WHEN T2.DOC_TYP_CD IN ( 'B0101' ,'B0200' ,'B0301' ) THEN '身份证'
             WHEN T2.DOC_TYP_CD IN ( 'B1000' ,'B1100' ,'B1200' ) THEN '军人'
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '武警'
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '港澳台'
             WHEN T2.DOC_TYP_CD = 'B0302' THEN '外国护照'  ELSE '身份证' END                                            AS 存款人身份类别
       ,CASE WHEN T4.doc_isu_org_id is not null THEN T4.doc_isu_org_id  ELSE SUBSTR(TRIM(T2.doc_nbr),1,4) END           AS 证件签发机构编号
       ,CASE WHEN T1.act_sts_cd = 'C' THEN '2'  ELSE '0' END                                                            AS 信息类型_2销户
FROM edw.dim_bus_dep_cst_act_inf_dd T1
INNER JOIN edw.dws_cst_bas_inf_dd T2
ON T1.cst_id = T2.cst_id AND T2.dt = '@@{yyyyMMdd}' AND T2.CST_TYP_CD = '1'
LEFT JOIN edw.dim_cst_bas_phy_adr_dtl_dd T3
ON T1.cst_id = T3.cst_id AND T3.dt = '@@{yyyyMMdd}' AND T3.phy_adr_typ_cd = '050200'
LEFT JOIN
(
	SELECT  CST_ID
	       ,SUBSTR(DOC_ISU_ORG_ID,11,4) AS DOC_ISU_ORG_ID
	       ,ROW_NUMBER() OVER ( PARTITION BY CST_ID ) RNM
	FROM edw.dim_cst_bas_doc_inf_dd --客户证件信息
	WHERE LENGTH(TRIM(DOC_ISU_ORG_ID)) = 14
	AND SUBSTR(DOC_ISU_ORG_ID, 11, 4) >= '0000'
	AND SUBSTR(DOC_ISU_ORG_ID, 11, 4) <= '9999'
	AND DT = '@@{yyyyMMdd}'
) T4
ON T1.cst_id = T4.cst_id
LEFT JOIN
(
	SELECT  cd_val
	       ,cd_val_dscr
	FROM edw.dwd_code_library_dd
	WHERE dt = '@@{yyyyMMdd}'
) A2
ON T2.doc_typ_cd = A2.cd_val
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2025020891_CST_01 C
ON T1.OPN_ORG_ID = C.ORG_ID
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.opn_org_id LIKE '4462005%'  --广东四会泰隆村镇银行高新区支行
and t1.opn_dt between '20230529' and '20240731'
AND T1.CST_ACT_TYP_CD IN ( '1' , '2' , '4' , 'Z' )
-- and T1.act_sts_cd<>'C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020891_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020891_CST_03 AS
select T2.存款人名称
    ,T2.地址
    ,T2.邮政编码
    ,T2.电话
    ,T2.身份证件种类
    ,T2.身份证件编号
    ,T2.开户银行机构代码
    ,T2.账号
    ,T2.账户类型
    ,T2.开户日期
    ,T2.有效日期
    ,T2.存款人身份类别
    ,T2.证件签发机构编号
    ,T2.信息类型_2销户
    ,concat(T2.存款人名称,'|',T2.地址,'|',T2.邮政编码,'|',T2.电话,'|',T2.身份证件种类,'|',T2.身份证件编号,'|',T2.开户银行机构代码,'|',T2.账号,'|',T2.账户类型,'|',T2.开户日期,'|',T2.有效日期,'|',T2.存款人身份类别,'|',T2.证件签发机构编号,'|',T2.信息类型_2销户)  as  合并
from  lab_bigdata_dev.SJXQ_SJ2025020891_CST_02  T2
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020891_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020891_CST_04 AS
SELECT  DISTINCT T2.cst_chn_nm                                                                                AS 存款人名称
       ,COALESCE(T2.REG_ADR,T2.CMN_ADR,T2.WRK_ADR)                                                            AS 地址
       ,T2.pst_cd                                                                                             AS 邮政编码
       ,T2.mbl_nbr                                                                                            AS 电话
       ,CASE WHEN T2.DOC_TYP_CD = 'B0101' THEN '1' --身份证
             WHEN T2.DOC_TYP_CD = 'B0200' THEN '8' --户口簿
             WHEN T2.DOC_TYP_CD IN ( 'B0301' ,'B0302' ) THEN '6' --护照
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '7' --港澳台
             WHEN T2.DOC_TYP_CD = 'B1000' THEN '5' --士兵证
             WHEN T2.DOC_TYP_CD = 'B1100' THEN '2' --军官证
             WHEN T2.DOC_TYP_CD = 'B1200' THEN '3' --解放军文职
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '4' --警官
             ELSE '1' END                                                                                     AS 身份证件种类代码
       ,CASE WHEN T2.DOC_TYP_CD = 'B0101' THEN '身份证' --身份证
             WHEN T2.DOC_TYP_CD = 'B0200' THEN '户口簿 ' --户口簿
             WHEN T2.DOC_TYP_CD IN ( 'B0301' ,'B0302' ) THEN '护照' --护照
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '港澳台' --港澳台
             WHEN T2.DOC_TYP_CD = 'B1000' THEN '士兵证' --士兵证
             WHEN T2.DOC_TYP_CD = 'B1100' THEN '军官证' --军官证
             WHEN T2.DOC_TYP_CD = 'B1200' THEN '解放军文职' --解放军文职
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '警官' --警官
             ELSE '身份证' END                                                                                   AS 身份证件种类
       ,T2.doc_nbr                                                                                            AS 身份证件编号
       ,T7.pay_bnk_no                                                                                         AS 开户银行机构代码
       ,T1.cst_act_id                                                                                         AS 账号
       ,CASE WHEN T8.CST_ACT_TYP_CD = 'Z' THEN '1'
             WHEN T8.CST_ACT_TYP_CD = '1' THEN '2'
             WHEN T8.CST_ACT_TYP_CD IN ( '2' ,'4' ) THEN '4' END                                              AS 账户类型代码
       ,CASE WHEN T8.CST_ACT_TYP_CD = 'Z' THEN '支票账户'
             WHEN T8.CST_ACT_TYP_CD = '1' THEN '卡'
             WHEN T8.CST_ACT_TYP_CD IN ( '2' ,'4' ) THEN '活期账户' END                                           AS 账户类型
       ,T1.opn_dt AS 开户日期
       ,CASE WHEN T1.ac_vld_prd_dt = '18991231' THEN ''  ELSE T1.ac_vld_prd_dt END                            AS 有效日期
       ,CASE WHEN T2.DOC_TYP_CD IN ( 'B0101' ,'B0200' ,'B0301' ) THEN '1'
             WHEN T2.DOC_TYP_CD IN ( 'B1000' ,'B1100' ,'B1200' ) THEN '2'
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '3'
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '4'
             WHEN T2.DOC_TYP_CD = 'B0302' THEN '5'  ELSE '1' END                                              AS 存款人身份类别代码
       ,CASE WHEN T2.DOC_TYP_CD IN ( 'B0101' ,'B0200' ,'B0301' ) THEN '身份证'
             WHEN T2.DOC_TYP_CD IN ( 'B1000' ,'B1100' ,'B1200' ) THEN '军人'
             WHEN T2.DOC_TYP_CD IN ( 'B1700' ,'B1800' ) THEN '武警'
             WHEN T2.DOC_TYP_CD IN ( 'B0400' ,'B0500' ,'B0600' ) THEN '港澳台'
             WHEN T2.DOC_TYP_CD = 'B0302' THEN '外国护照'  ELSE '身份证' END                                  AS 存款人身份类别
       ,CASE WHEN T4.doc_isu_org_id is not null THEN T4.doc_isu_org_id  ELSE SUBSTR(TRIM(T2.doc_nbr),1,4) END AS 证件签发机构编号
       ,CASE WHEN T1.act_sts_cd = 'C' THEN '2'  ELSE '0' END                                                  AS 信息类型_2销户
FROM edw.dws_bus_dep_act_inf_dd T1
LEFT JOIN
(
	SELECT  cd_val
	       ,cd_val_dscr
	FROM edw.dwd_code_library_dd
	WHERE dt = '@@{yyyyMMdd}'
) A1
ON T1.act_ctg_cd_2 = A1.cd_val
LEFT JOIN edw.dws_cst_bas_inf_dd T2
ON T1.cst_id = T2.cst_id AND T2.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_cst_bas_phy_adr_dtl_dd T3
ON T1.cst_id = T3.cst_id AND T3.dt = '@@{yyyyMMdd}' AND T3.phy_adr_typ_cd = '050200'
LEFT JOIN
(
	SELECT  CST_ID
	       ,SUBSTR(DOC_ISU_ORG_ID,11,4) AS DOC_ISU_ORG_ID
	       ,ROW_NUMBER() OVER ( PARTITION BY CST_ID ) RNM
	FROM edw.dim_cst_bas_doc_inf_dd --客户证件信息
	WHERE LENGTH(TRIM(DOC_ISU_ORG_ID)) = 14
	AND SUBSTR(DOC_ISU_ORG_ID, 11, 4) >= '0000'
	AND SUBSTR(DOC_ISU_ORG_ID, 11, 4) <= '9999'
	AND DT = '@@{yyyyMMdd}'
) T4
ON T1.cst_id = T4.cst_id
LEFT JOIN
(
	SELECT  cd_val
	       ,cd_val_dscr
	FROM edw.dwd_code_library_dd
	WHERE dt = '@@{yyyyMMdd}'
) A2
ON T2.doc_typ_cd = A2.cd_val
LEFT JOIN
(
	SELECT  DISTINCT brno
	       ,bankno
	FROM edw.spmt_t_bpim_branchmap -- 行内机构行号映射表
	WHERE dt = '@@{yyyyMMdd}'
) T6
ON T1.opn_org = T6.brno
LEFT JOIN
(
	SELECT  *
	FROM edw.dim_bus_chnl_fr_cbcg_bnk_inf_dd
	WHERE dt = '@@{yyyyMMdd}'
	AND bnk_nm LIKE '%泰隆%'
) T7
ON T6.bankno = T7.pay_bnk_no
LEFT JOIN edw.dim_bus_dep_cst_act_inf_dd T8
ON T1.cst_act_id = T8.cst_act_id AND T8.dt = '@@{yyyyMMdd}'
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.STL_ACT_IND = '1' --结算账户
AND T1.cst_tp = '1'
AND T1.opn_org LIKE '4462005%'  --广东四会泰隆村镇银行高新区支行
and t1.opn_dt between '20230529' and '20240731'
AND T8.CST_ACT_TYP_CD IN ( '1' , '2' , '4' , 'Z' )
-- and T7.pay_bnk_no='320593200052'
;
SElECT '01' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ2025020891_CST_03
union all
SElECT '02' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ2025020891_CST_04
;
/*
01	962	962
02	918	918
*/
***李捷_SJ2025020891_四会村行开销户数据2.sql
-- 2023年5月29日-2024年7月31日，广东四会泰隆村镇银行高新区支行对私客户开销户数据
select cst_act_id                               --客户账号|C32
	,cst_id                                   --客户号|C20
	,act_nm                                   --账户名称|C300
	,int_val_dt                               --起息日期|C8
	,mtu_dt                                   --到期日期|C8
	,opn_org                                  --开户机构编号|C12
	,opn_dt                                   --开户日期|C8
	,act_dstr_act_dt                          --销户日期|C8
	,act_sts_cd                               --存款账户状态代码|C1
	,act_ctg_cd_1                             --账户分类代码1|C32
	,act_ctg_cd_2                             --账户分类代码2|C32
	,act_ctg_cd_3                             --账户分类代码3|C110
from edw.dws_bus_dep_act_inf_dd               --存款账户信息汇总
where dt='@@{yyyyMMdd}'
and stl_act_ind='1'  --结算账户标志
;
select cst_id                                   --客户号|C20
	,doc_nbr                                  --证件号码|C60
	,doc_typ_cd                               --证件类型代码|C5
	,mbl_nbr                                  --手机|C32
	,fml_tel_nbr                              --家庭电话|C32
	,reg_adr                                  --户籍地址|注册地址|C256
	,cmn_adr                                  --通讯地址|C256
	,wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,fml_adr                                  --家庭地址|C256
	,pst_cd                                   --通讯地址邮编|通讯地址邮编|C6
from edw.dws_cst_bas_inf_dd                   --客户基础信息汇总表
where dt='@@{yyyyMMdd}'
;
***李磊_SJ2025021176_挂钩理财销售信息.sql
﻿-- 截至2025年1月末，我行自主管理及代销的挂钩型理财产品投资者结构信息
DROP   TABLE IF EXISTS SJXQ_SJ2025021176_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025021176_CST_01
(
    pd_cd      string COMMENT ''
    ,pd_nm     string COMMENT ''
)
;
insert into SJXQ_SJ2025021176_CST_01
;
-- 客户首次购买理财日期
DROP   TABLE IF     EXISTS SJXQ_SJ2025021176_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021176_CST_02_1 AS
select cst_id,min(SUBSTR(t1.srl_nbr,1,8)) as fst_trx_dt
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI               T1 --理财交易确认流水明细
where T1.DT<='20250131'
AND t1.trx_sts_cd = '8'         --交易成功
group by cst_id
;
-- 挂钩型理财产品交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025021176_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021176_CST_02 AS
SELECT distinct t1.srl_nbr,T1.CST_ID
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,T1.pd_cd                                    --产品代码|C20
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,t1.trx_chnl_cd	--	交易渠道代码|C1
    ,c1.cd_val_dscr     as trx_chnl_nm
    ,t1.mgr_id    as mgr_id2
    ,case when t1.mgr_id<>'000000' then t1.mgr_id else t6.mgr_id end as mgr_id
    ,t3.empe_nm     as mgr_nm
    ,t4.brc_org_nm,t4.org_nm
    ,t2.pd_nm
    ,case when t5.cst_id is not null then 'Y' else '' end as is_new_cst
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI               T1 --理财交易确认流水明细
INNER JOIN SJXQ_SJ2025021176_CST_01               t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
left join edw.dwd_code_library_dd                 c1
on t1.trx_chnl_cd=c1.cd_val
and c1.dt='20250131'
left join edw.dws_bus_chm_act_mgr_inf_dd    t6 --理财考核汇总信息
on t1.cst_id=t6.cst_id
and t1.pd_cd=t6.pd_cd
and t1.bnk_act_id=t6.bnk_act_id
and t6.dt='20250131'
and t6.mng_typ_cd = '2'  --`管户`类型 1考核 2销售
and t6.pd_tp_cd='1'      --理财类型：0基金 1理财
and t6.mgr_id<>'000000'
LEFT JOIN    edw.dws_hr_empe_inf_dd         t3 --员工汇总信息
ON      case when t1.mgr_id<>'000000' then t1.mgr_id else t6.mgr_id end = t3.empe_id
AND     t3.dt = '20250131'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd    t4
ON      t3.org_id = t4.org_id
AND     t4.dt = '20250131'
left join SJXQ_SJ2025021176_CST_02_1        t5
on t1.cst_id=t5.cst_id
and SUBSTR(t1.srl_nbr,1,8)=t5.fst_trx_dt
where T1.DT<='20250131'
AND t1.trx_sts_cd = '8'         --交易成功
;
-- 客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025021176_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021176_CST_03 AS
select t1.cst_id
    ,t2.cst_chn_nm
    ,t2.cst_typ_cd	--客户类型|C1
    ,decode(t2.cst_typ_cd,'1','个人','2','机构','') as cst_typ_nm
    ,t3.ocp_cd	--	职业代码
    ,c1.cd_val_dscr     as ocp_nm
    ,t3.age
    ,t4.rsk_lvl_cd	    as 理财风险等级
    ,decode(t5.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星','') as aum_grd
	,t6.kehuzhwm                                 --客户中文名
	,t6.shifouyg                                 --是否员工标志
	,t6.sfygqins                                 --是否员工亲属
	,t6.zhiyeeee                                 --职业
	,t6.guishjig                                 --归属机构
    ,t7.ctr_dt	--	签约日期|C8
    ,t8.fnc_amt
    , CASE WHEN t14.cst_id IS NOT NULL THEN '是' ELSE '' END AS 是否行内员工
    , CASE WHEN t15.cst_id IS NOT NULL THEN '是' ELSE '' END AS 是否行内员工亲属
from(
    select distinct cst_id
    from SJXQ_SJ2025021176_CST_02
)t1 left join edw.dws_cst_bas_inf_dd t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250131'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t3 --对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt='20250131'
left join edw.dwd_code_library_dd             c1
on t3.OCP_CD=c1.cd_val
and c1.dt='20250131'
LEFT JOIN  edw.dwd_bus_chm_cst_rsk_ases_dd t4
on  t1.cst_id=t4.cst_id
and t4.dt='20250131'
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd t5 --客户等级信息
on  t1.cst_id=t5.cst_id
and t5.dt='20250131'
left join edw.core_kcfb_cfdsjc                t6     --对私客户基本信息表
on  t1.cst_id=t6.kehuhaoo
and t6.dt='20250131'
left join edw.dwd_bus_chm_ctr_inf_dd 		  t7      --理财客户签约信息
on  t1.cst_id=t7.cst_id
and t7.dt='20250131'
left join(
    SELECT  cst_id
        ,SUM(fnc_amt)   as fnc_amt
    FROM edw.dws_bus_chm_act_acm_inf_dd --理财账户份额汇总信息
    WHERE dt = '20250131'
    AND pd_tp_cd = '1' --理财
    GROUP BY  cst_id
)t8 on  t1.cst_id=t8.cst_id
LEFT JOIN
(
	SELECT  DISTINCT cst_id
	FROM edw.dws_cst_idv_bas_inf_dd
	WHERE dt = '20250131'
	AND own_emp_id IN ( SELECT empe_id FROM edw.dws_hr_empe_inf_dd WHERE dt = '20250131' AND empe_sts_cd <> '3' )
) t14 --行内员工
ON t1.cst_id = t14.cst_id
LEFT JOIN
(
	SELECT  DISTINCT a2.cst_id
	FROM edw.dim_hr_empe_invl_pty_inf_dd a1
	INNER JOIN edw.dws_cst_idv_bas_inf_dd a2
	ON a1.invl_pty_id_card_id = a2.doc_nbr AND a2.dt = '20250131'
	WHERE a1.dt = '20250131'
	AND a1.empe_id IN ( SELECT empe_id FROM edw.dws_hr_empe_inf_dd WHERE dt = '20250131' AND empe_sts_cd <> '3' )
) t15
ON t1.cst_id = t15.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025021176_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021176_CST_04 AS
SELECT  T1.pd_cd        AS 产品代码
       ,t1.pd_nm        AS 产品名称
       ,T1.CST_ID       AS 客户号
       ,t2.cst_chn_nm   AS 客户名称
       ,t2.cst_typ_nm   AS 客户类型
       ,t2.ocp_nm       AS 职业
       ,t2.age          AS 年龄
       ,t2.理财风险等级
       ,t2.aum_grd      AS 客户星级
       ,t1.is_new_cst   as 是否新客
       ,t2.shifouyg     AS 是否员工标志
       ,t2.sfygqins     AS 是否员工亲属
       ,T1.trx_amt      AS 交易金额
       ,t1.trx_dt       AS 交易日期
       ,t1.trx_chnl_nm  AS 交易渠道
       ,t2.ctr_dt       AS 理财签约日期
       ,t2.fnc_amt      AS 理财保有量_20250131
       , CASE WHEN t3.cst_id is not null THEN 'Y' ELSE '' END AS 是否信贷建档客户
       ,t4.loan_bal_acs AS 贷款余额_20250131
       ,t1.mgr_id       AS 客户经理工号
       ,t1.mgr_nm       AS 客户经理名称
       ,t1.brc_org_nm   AS 所在分行
       ,t1.org_nm       AS 所在机构
       ,t5.cnt_2023     AS 违规处罚问题数_2023年
       ,t5.pnt_sum_2023 AS 认定积分_2023年
       ,t5.cnt_2024     AS 违规处罚问题数_2024年
       ,t5.pnt_sum_2024 AS 认定积分_2024年
        ,t5.cnt as 违规处罚问题数
        ,t5.pnt_sum as 认定积分
from SJXQ_SJ2025021176_CST_02       t1
left join SJXQ_SJ2025021176_CST_03  t2
on t1.cst_id=t2.cst_id
LEFT JOIN    edw.loan_CST_INDIV_BSC t3
ON      t1.cst_id = t3.cst_id
AND     t3.DEL_IND = '0'
AND     t3.dt = '20250131'
left join adm_pub.adm_csm_cbus_loan_inf_dd t4		--贷款业务信息
on t1.cst_id=t4.cst_id
and t4.dt= '20250131'
LEFT JOIN
(
	SELECT  vlt_mnl_id
	       ,COUNT(case when inpt_dt between '20230101' and '20231231' then pnt_id end) cnt_2023
	       ,SUM(case when inpt_dt between '20230101' and '20231231' then pnt_id else 0 end) pnt_sum_2023
	       ,COUNT(case when inpt_dt between '20240101' and '20241231' then pnt_id end) cnt_2024
	       ,SUM(case when inpt_dt between '20240101' and '20241231' then pnt_id else 0 end) pnt_sum_2024
            ,count(1) cnt
            ,sum(pnt_id) pnt_sum
	FROM edw.dwd_hr_empe_vlt_pnt_id_inf_dd --行内违规处罚信息
	WHERE dt = '20250131'
	GROUP BY  vlt_mnl_id
) t5 ON t1.mgr_id = t5.vlt_mnl_id
;
SElECT '04' seq, *
from SJXQ_SJ2025021176_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2025021176_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct srl_nbr) custs
from SJXQ_SJ2025021176_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025021176_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025021176_CST_04
;
/*
01	292	292
02	84898	84898
03	55595	55595
04	84898	55595
*/***李静_SJ2025043021_丽水莲都支行客户营销.sql
-- 截止2025.4.30，管户行莲都支行，2024.4.30-2025.4.29存款年日均4万（不含）以下客户
-- 2024.4.30-2025.4.29存款年日均4万（不含）以下客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025043021_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043021_CST_01 AS
select cst_id                                   --客户编号
	,sum(dep_bal)/count(dt) as dep_bal_year_avg                               --存款余额
from adm_pub.adm_csm_cbus_dep_inf_dd          --客户集市-业务信息-客户存款业务信息表
where dt between '20240430' and '20250429'
group by cst_id
having sum(dep_bal)/count(dt) < 40000
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025043021_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025043021_CST_02 AS
SELECT  t1.cst_id
       ,t1.cst_chn_nm       AS 客户姓名
       ,t2.dep_bal_year_avg AS 20240430_20250429存款年日均
       ,t1.reg_adr          AS 户籍地址
       ,t1.wrk_adr          AS 工作单位地址
       ,t1.fml_adr          AS 家庭地址
	,case when length(t1.mbl_nbr)>=7 or length(t1.fml_tel_nbr)<=3 then t1.mbl_nbr
        else t1.fml_tel_nbr end as 手机
    ,t3.prm_mgr_id as 管户客户经理工号
    ,t3.prm_mgr_nm as 管户客户经理姓名
	,t3.prm_org_nm as 主管户机构名称
    ,t4.sbr_org_nm as 主管户支行
from edw.dws_cst_bas_inf_dd 		    t1 --客户基础信息汇总表
inner join SJXQ_SJ2025043021_CST_01 	t2 --存款业务信息表
on t1.cst_id=t2.cst_id
and t2.dep_bal_year_avg < 40000
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.sbr_org_nm regexp '莲都支行'
where t1.dt='20250430'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025043021_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025043021_CST_02
***杨燕_SJ2025071161_隐患业务排查.sql
﻿-- 杨燕_SJ2025071161_隐患业务排查
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_01 AS
SELECT  t1.col_1 --合同流水号
       ,t1.col_2 --管户机构号
       ,t1.col_3 --客户号
       ,t1.col_4 --客户名称
       ,t1.col_5 --余额
       ,t1.col_6 --是否预保预报
	   ,t2.dtrb_cst_act_id                          --放款客户账号|c32
	   ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cum_rsk_ctrl_id
from lab_bigdata_dev.qbi_file_20250711_14_36_11_0 	t1
left join edw.dim_bus_loan_ctr_bse_inf_dd        	t2 --合同基础信息
on t1.col_1=t2.ctr_serno
and t2.dt='20250713'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.col_3=t5.cst_id
and t5.dt='20250713'
where t1.pt<>''
;
--初始合同号
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_02 AS
select t1.ctr_srl_no                               --合同流水号
	,t1.dbil_srl_no                              --借据流水号
	,t1.cst_id                                   --核心客户编号
	,t1.cst_nm                                   --客户名称
	,t1.dbil_bal_cny                             --余额
	,t1.ovd_day                                  --逾期天数
	,t1.prcp_ovd_date                            --本金逾期日期
	,t1.intr_ovd_date                            --利息逾期日期
	,t1.ovd_prcp_bal                             --逾期本金余额
	,t1.start_ctr_srl_no_1                       --初始合同号1
	,t1.start_cst_nm_1                           --初始客户名称1
	,t1.start_ctr_srl_no_2                       --初始合同号2
	,t1.start_cst_nm_2                           --初始客户名称2
	,t1.rfin_ctg                                 --重组分类
	,t2.col_6 as 是否预保预报
from adm_rsk.adm_rsk_apl_inter_all  t1 --风险集市应用表-资产质量日常监测源表
INNER JOIN SJXQ_SJ2025071161_CST_01 t2
on t1.ctr_srl_no=t2.col_1
where t1.dt='20250713'
;
-- 合同最大逾期天数
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_03 AS
select t1.ctr_serno
	,case when max(本金逾期天数)>=max(利息逾期天数) then max(本金逾期天数) else max(利息逾期天数) end as 历史最大逾期天数
	,max(本金逾期天数) as 本金历史最大逾期天数
from(
	select t1.DBIL_ID                                  --借据编号|C64
		,t1.CTR_SERNO                                --合同流水号|C32
		,t1.PRCP_BAL                                 --本金余额
		,t1.OVD_DT                                   --逾期日期|C8
		,t1.OVD_INTR_DT                              --欠息日期|C8
		,t1.OVD_DAY                                  --逾期天数
		,t1.OVD_INTR_DAY                             --欠息天数
		,case when t1.OVD_DT<>'18991231' then t1.OVD_DAY else 0 end as 本金逾期天数
		,case when t1.OVD_INTR_DT<>'18991231' then t1.OVD_INTR_DAY else 0 end as 利息逾期天数
	from edw.dim_bus_loan_dbil_inf_dd   t1 --信贷借据信息
	INNER JOIN (
		select ctr_srl_no
		from SJXQ_SJ2025071161_CST_02
		where nvl(ctr_srl_no,'')<>''
		union
		select start_ctr_srl_no_1
		from SJXQ_SJ2025071161_CST_02
		where nvl(start_ctr_srl_no_1,'')<>''
		union
		select start_ctr_srl_no_2
		from SJXQ_SJ2025071161_CST_02
		where nvl(start_ctr_srl_no_2,'')<>''
	) t2 on t1.CTR_SERNO=t2.ctr_srl_no
	where t1.dt<='20250713'
)t1 group by t1.CTR_SERNO
;
-- 资产\负债
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_04 AS
select t1.cst_id                                   --客户号|c20
	,t1.slf_ast_amt                              --本人资产总额|decimal(21,2)
	,t1.slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
	,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cum_rsk_ctrl_id
from(
	select cst_id                                   --客户号|c20
		,slf_ast_amt                              --本人资产总额|decimal(21,2)
		,slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
		,row_number() over(partition by cst_id order by rcd_tm desc) rn
	from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
	where dt='20250713'
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20250713'
where t1.rn=1
;
-- 不动产
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_05 AS
select t1.*
	,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cum_rsk_ctrl_id
from(
	select t1.cst_id,t1.mnl_ases_val,t1.svy_rpt_no,t1.svy_rpt_dt
		,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
		,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
	from(
		select t2.cst_id
			,t2.svy_rpt_no                               --调查报告编号|c32
			,case when length(t2.svy_rpt_no)=20 then SUBSTR(t2.svy_rpt_no,5,8)
				else SUBSTR(t2.svy_rpt_no,4,8) end as svy_rpt_dt
			,sum(t2.mnl_ases_val) as mnl_ases_val           --人工评估价值|c24
		from edw.dwd_bus_loan_svy_fnc_stat_dtl_data_ass_rl_est_dd	t2 --调查报告&mdash;资产负债详情-资产-不动产
		WHERE t2.dt='20250713' and nvl(t2.svy_rpt_no,'')<>''
		group by t2.cst_id,t2.svy_rpt_no
	)t1
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20250713'
where t1.rn=1
;
--放款客户账号资金流入流出
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_06 AS
select t1.dtrb_cst_act_id
	,sum(case when T2.CRD_AND_DBT_IND = 'C' then trx_amt else 0 end) as 近3个月贷款账户资金流入金额
	,sum(case when T2.CRD_AND_DBT_IND = 'D' then trx_amt else 0 end) as 近3个月贷款账户资金流出金额
from (
	select distinct dtrb_cst_act_id
	from SJXQ_SJ2025071161_CST_01
)t1 inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细
on t1.dtrb_cst_act_id=t2.cst_act_id
and t2.dt between '20250414' and '20250713' 	--近3个月
and t2.bal_fld_nm = 'DPLDGBAL'
group by t1.dtrb_cst_act_id
;
-- 征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_07 AS
SELECT  a.cst_id
       ,b.curr_unsett_od_balan                        AS 当前未结清逾期金额
       ,nvl(b.cred_total_amt,c.征信贷款总额)                AS 授信总额_信用总额
       ,b.oth_cred_total_amt                          AS 他行授信总额
       ,nvl(c.征信贷款家数,b.oth_bank_busi_org_num)         AS 征信贷款家数
       ,nvl(b.curr_unsett_xe_loan_amt,c.小贷公司贷款余额)     AS 当前未结清小额信贷公司贷款金额
       ,nvl(b.curr_unsett_xe_loan_org_num,c.小额贷款融资家数) AS 当前未结清小额信贷公司贷款机构数
       ,b.cred_card_total_amt                         AS 信用卡总授信额度
       ,nvl(b.cc_l_6_mon_aver_use_amt,c.最近6个月使用金额)    AS 最近6个月使用金额
       ,nvl(c.近6个月逾期次数,b.wdil6m)                      AS 近6个月逾期次数
       ,c.近6个月逾期机构数
       ,b.late_hly_loan_count                         AS 最近6个月贷款审核查询记录
       ,b.guar_contr_amt                              AS 对外担保金额
       ,b.curr_bad_extguan_loan_amt                   AS 当前非正常对外贷款担保金额
from(
	select distinct col_3 as cst_id
	from SJXQ_SJ2025071161_CST_01
)a
left join
(
	SELECT  report_no
		,report_dt
		,cst_id
		,curr_unsett_od_balan        	--当前未结清逾期金额
		,cred_total_amt              	--授信总额_信用总额
		,oth_cred_total_amt          	--他行授信总额
		,oth_bank_busi_org_num       	--他行融资家数
		,curr_unsett_xe_loan_amt     	--当前未结清小额信贷公司贷款金额
		,curr_unsett_xe_loan_org_num 	--当前未结清小额信贷公司贷款机构数
		,cred_card_total_amt         	--信用卡总授信额度
		,cc_l_6_mon_aver_use_amt     	--最近6个月使用金额
		,wdil6m                      	--近6个月的最大逾期期数
		,late_hly_loan_count         	--最近6个月贷款审核查询记录
		,guar_contr_amt              	--对外担保金额
		,curr_bad_extguan_loan_amt   	--当前非正常对外贷款担保金额
    from   edw.dws_cst_ccrc_idv_ind_inf_dd
    where  dt = '@@{yyyyMMdd}'
    and    report_dsc_rn = 1
    union all
	SELECT  report_no
		,report_dt
		,cst_id
		,un_sett_bad_loan_amt    	--当前未结清逾期金额
		,cred_total_amt          	--信用总发生额
		,null
		,oth_bank_busi_org_num   	--他行融资家数
		,null
		,null
		,0
		,null
		,null
		,late_6mon_org_pass_num  	--近6个月金融机构审批通过家数
		,guar_contr_amt          	--对外担保金额
		,unnm_loan_guar_amt      	--对外担保五级分类为非正常的余额
    from   edw.dws_cst_ccrc_entp_ind_inf_dd
    where  dt = '@@{yyyyMMdd}'
    and    report_dsc_rn = 1
)b on a.cst_id = b.cst_id
left join
(
    ---- 他行贷款信息
    select a.cst_id
          ,a.report_id
          ,count(distinct dtrb_org) as 征信贷款家数
          ,sum(ctr_amt)  征信贷款总额
			,null as 小额贷款融资家数 ,null  as 小贷公司贷款余额,null as 最近6个月使用金额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd a
    where  a.dt = '@@{yyyyMMdd}'
    -- and    a.dtrb_org not like '%ZJTLCB%'
    and    (a.ctr_bal > 0 OR a.rmn_rpay_trm > 0 )  ---- 未结清
    group by  a.cst_id
          ,a.report_id
    union all
    select cst_id
		,report_id
		,count(distinct dtrb_org_cd) as 征信贷款家数
		,sum(loan_amt)  征信贷款总额
    from   edw.dim_cst_ccrc_entp_loan_inf_dd a
    where  a.dt = '@@{yyyyMMdd}'
    -- and    a.dtrb_org_typ_cd <> '00'  ---- 剔除泰隆银行
    and    (loan_bal > 0 OR rmn_rpay_mon > 0 )  ---- 未结清
    group by cst_id
           ,report_id
)c on a.cst_id = c.cst_id and b.report_no = c.report_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071161_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071161_CST_08 AS
SELECT  t1.col_1              AS 合同流水号
       ,t1.col_2              AS 管户机构号
       ,t1.col_3              AS 客户号
       ,t1.col_4              AS 客户名称
       ,t1.col_5              AS 余额
       ,t1.col_6              AS 是否预保预报
       ,t3.历史最大逾期天数
       ,t3.本金历史最大逾期天数
       ,t2.start_ctr_srl_no_1 AS 初始合同号1
       ,t2.start_cst_nm_1     AS 初始客户名称1
       ,t31.历史最大逾期天数          AS 初始合同号1历史最大逾期天数
       ,t31.本金历史最大逾期天数        AS 初始合同号1本金历史最大逾期天数
       ,t2.start_ctr_srl_no_2 AS 初始合同号2
       ,t2.start_cst_nm_2     AS 初始客户名称2
       ,t32.历史最大逾期天数          AS 初始合同号2历史最大逾期天数
       ,t32.本金历史最大逾期天数        AS 初始合同号2本金历史最大逾期天数
       ,t4.量化风险等级
       ,t1.cum_rsk_ctrl_id    AS 同一风险控制号
       ,t5.同一风险控制号下资产总额
       ,t5.同一风险控制号下负债总额
       ,t51.同一风险控制号下房产总额
       ,t7.当前未结清逾期金额
       ,t7.授信总额_信用总额
       ,t7.他行授信总额
       ,t7.征信贷款家数
       ,t7.当前未结清小额信贷公司贷款金额
       ,t7.当前未结清小额信贷公司贷款机构数
       ,t7.信用卡总授信额度
       ,t7.最近6个月使用金额
       ,t7.近6个月逾期次数
       ,t7.近6个月逾期机构数
       ,t7.最近6个月贷款审核查询记录
       ,t7.对外担保金额
       ,t7.当前非正常对外贷款担保金额
       ,t6.近3个月贷款账户资金流入金额
       ,t6.近3个月贷款账户资金流出金额
       ,t8.dep_bal_90_avg     AS 近90天存款余额日均
from SJXQ_SJ2025071161_CST_01  t1
left join(
	select distinct ctr_srl_no
		,t1.start_ctr_srl_no_1                       --初始合同号1
		,t1.start_cst_nm_1                           --初始客户名称1
		,t1.start_ctr_srl_no_2                       --初始合同号2
		,t1.start_cst_nm_2                           --初始客户名称2
	from SJXQ_SJ2025071161_CST_02 t1
)t2 on t1.col_1=t2.ctr_srl_no
left join SJXQ_SJ2025071161_CST_03 t3
on t1.col_1=t3.ctr_serno
left join SJXQ_SJ2025071161_CST_03 t31
on t2.start_ctr_srl_no_1=t31.ctr_serno
left join SJXQ_SJ2025071161_CST_03 t32
on t2.start_ctr_srl_no_2=t32.ctr_serno
left join(
	-- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
	select cst_id
		,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
		--'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
	from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
	where dt = '20250713'
	union
	select cst_id
		,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
	from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
	where dt = '20250713'
)t4 on t1.col_3=t4.cst_id
left join(
	select cum_rsk_ctrl_id
		,sum(slf_ast_amt    ) as 同一风险控制号下资产总额
		,sum(slf_lbl_tot_amt) as 同一风险控制号下负债总额
	from SJXQ_SJ2025071161_CST_04
	group by cum_rsk_ctrl_id
)t5 on t1.cum_rsk_ctrl_id=t5.cum_rsk_ctrl_id
left join(
	select cum_rsk_ctrl_id
		,sum(mnl_ases_val) as 同一风险控制号下房产总额
	from SJXQ_SJ2025071161_CST_05
	group by cum_rsk_ctrl_id
)t51 on t1.cum_rsk_ctrl_id=t51.cum_rsk_ctrl_id
left join SJXQ_SJ2025071161_CST_06 t6
on t1.dtrb_cst_act_id=t6.dtrb_cst_act_id
left join SJXQ_SJ2025071161_CST_07 t7
on t1.col_3=t7.cst_id
left join adm_pub.adm_csm_cbus_dep_inf_dd  t8 --客户集市-业务信息-客户存款业务信息表
on t1.col_3=t8.cst_id
and t8.dt=''
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025071161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071161_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025071161_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071161_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071161_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct dtrb_cst_act_id) custs
from SJXQ_SJ2025071161_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071161_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025071161_CST_08
;
/*
01	2114	2114
03	29961819	54087
*/
***杨苗_SJ20250801236_嘉兴分行细分客群.sql
-- 杨苗_SJ20250801236_嘉兴分行细分客群
-- 截止2025年7月15日，嘉兴分行所有子社区里面的细分客群对应的客户清单（已建档部分）
DROP   TABLE IF     EXISTS SJXQ_SJ20250801236_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250801236_CST_01 AS
SELECT  t1.cst_id         AS 客户号
       ,t5.cst_chn_nm     AS 客户名称
       ,t5.file_dt        as 建档日期
       ,t2.brc_org_nm     AS 主管户分行
       ,t2.sbr_org_nm     AS 主管户支行
       ,t2.tem_org_nm     AS 主管户团队
       ,t6.sub_cmnt_id    AS 子社区编号
       ,t7.cmnt_nm        AS 子社区名称
       ,t3.com_cst_grp_id AS 细分客群id
       ,t4.cst_group_name AS 细分客群名称
       ,t4.segment_type   AS 细分客群分类 --行业类或其他
       ,t4.remark         AS 细分客群备注
       ,t8.主维护人
from adm_pub.adm_csm_cbas_mng_inf_dd        t1 --客户集市-客户基础-客户管户信息
INNER JOIN edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm='嘉兴分行'
INNER join edw.xwdt_xw_com_csts_by_grp      t3 --社区细分客群客户表
on t1.cst_id=t3.cust_no
and t3.dt=t1.dt
left join edw.xwdt_xw_community_cst_group	t4 --细分客群信息表
on t3.com_cst_grp_id=t4.id
and t4.dt=t1.dt
inner join edw.dws_cst_bas_inf_dd	        t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
INNER JOIN    edw.dwd_cst_mng_cmnt_rel_dd   t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = t1.dt
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd    t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
LEFT JOIN
(
	SELECT  t1.COMMUNITY_CODE
	FROM edw.XWDT_ETL_XW_COMMUNITY_PER t1 --普惠社区定人信息表
    left join edw.dws_hr_empe_inf_dd   t2 --员工信息汇总
    on  t1.EMPLOY_NO=t2.empe_id
    and t2.dt='20250803'
	WHERE t1.dt = '20250803'
	AND t1.IS_MAIN_PERSON = '1' ---- 1主维护人，2社区定人
	GROUP BY  t1.COMMUNITY_CODE
) T8 ON T6.SUB_CMNT_ID = T8.COMMUNITY_CODE --社区编号
where t1.dt = '20250803'
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250801236_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ20250801236_CST_01
;
***杨菲_SJ20250716311_理财流失情况分析.sql
﻿-- 杨菲_SJ20250716311_理财流失情况分析
-- 2025年1-6月理财产品到期清单
DROP   TABLE IF EXISTS SJXQ_SJ20250716311_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250716311_CST_01
(
    PD_CD       string COMMENT ''
    ,PD_nm      string COMMENT ''
    ,mtu_dt     string COMMENT ''
)
;
insert into SJXQ_SJ20250716311_CST_01
;
-- 汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20250716311_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250716311_CST_02 AS
SELECT  t1.CST_ID      --客户号
       ,T1.PD_CD       --产品代码
       ,t2.pd_nm       --产品名称
       ,t1.trx_dt
       ,t2.mtu_dt      --投资到期日
       ,t1.trx_amt
       ,t1.cfm_amt     --到期金额
       ,t1.dt
       ,to_char(dateadd(to_date(t2.mtu_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd') as 到期日前一日
       ,to_char(dateadd(to_date(t2.mtu_dt,'yyyyMMdd'),7,'dd'),'yyyyMMdd') as 到期日plus7
       ,t3.dep_bal	as 	dep_bal_m1
       ,t4.dep_bal	as 	dep_bal_p7
       ,t5.aum_bal	as 	aum_bal_m1
       ,t6.aum_bal	as 	aum_bal_p7
FROM EDW.dwd_bus_chm_trx_cfm_dtl_di     T1  --理财交易确认流水明细
inner JOIN SJXQ_SJ20250716311_CST_01    T2
ON  T1.PD_CD = T2.PD_CD
left join adm_pub.adm_csm_cbus_dep_inf_dd t3 --存款业务信息表
on  t1.cst_id=t3.cst_id
and t3.dt>='20250101'
and t3.dt=to_char(dateadd(to_date(t2.mtu_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd')
left join adm_pub.adm_csm_cbus_dep_inf_dd t4 --存款业务信息表
on  t1.cst_id=t4.cst_id
and t4.dt>='20250101'
and t4.dt=to_char(dateadd(to_date(t2.mtu_dt,'yyyyMMdd'),7,'dd'),'yyyyMMdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd t5 --客户集市-业务信息-客户金融资产信息表
on  t1.cst_id=t5.cst_id
and t5.dt>='20250101'
and t5.dt=to_char(dateadd(to_date(t2.mtu_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd t6 --客户集市-业务信息-客户金融资产信息表
on  t1.cst_id=t6.cst_id
and t6.dt>='20250101'
and t6.dt=to_char(dateadd(to_date(t2.mtu_dt,'yyyyMMdd'),7,'dd'),'yyyyMMdd')
where T1.dt<='20250717'
and T1.CFM_AMT>0    --确认金额
AND t1.bus_cd IN ( '120' , '122' , '130' , '134' , '139' ) --认购、申购、基金成立、非交易过户入、定期定额申购
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250716311_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250716311_CST_03 AS
SELECT  t1.CST_ID     AS 客户号
       ,T1.PD_CD      AS 产品代码
       ,t1.pd_nm      AS 产品名称
       ,t1.mtu_dt     AS 投资到期日
       ,t1.cfm_amt    AS 到期金额
       ,t1.aum_bal_m1 AS 到期日前1日AUM
       ,t1.aum_bal_p7 AS 到期日后7日AUM
       ,CASE WHEN t1.aum_bal_p7 < t1.aum_bal_m1 AND t1.dep_bal_p7 >= t1.dep_bal_m1 THEN t1.cfm_amt  ELSE 0 END AS 理财流失金额
       ,t4.tem_org_nm AS 客户主管户团队机构名称
       ,t4.sbr_org_nm AS 客户主管户支行机构名称
       ,t4.brc_org_nm AS 客户主管户分行机构名称
       ,t3.prm_mgr_id AS 主管护客户经理工号
       ,t3.prm_mgr_nm AS 主管护客户经理姓名
from SJXQ_SJ20250716311_CST_02 t1
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250717'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250717'
where t1.aum_bal_p7 is not null --剔除未到期数据
;
SElECT '01' seq, count(1) cnt,count(distinct PD_CD) custs
from SJXQ_SJ20250716311_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250716311_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250716311_CST_03
;
/*
01	88	88
02	10498	8453
03	5163	3983
*/
SElECT '03' seq, *
from SJXQ_SJ20250716311_CST_03
;
***林小素_SJ2025071586_地址信息.sql
-- 林小素_SJ2025071586_地址信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025071586_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071586_CST_01 AS
SELECT  t1.col_1                          AS 客户号
       ,t1.col_2                          AS 客户名称
       ,t1.col_3                          AS 信贷合同流水号
       ,t1.col_4                          AS 产品编号码值
       ,t1.col_5                          AS 业务标识
       ,t1.col_6                          AS 合同金额
       ,t1.col_7                          AS 合同余额
       ,t1.col_8                          AS 发生类型码值
       ,t1.col_9                          AS 到期日期
       ,t1.col_10                         AS 管户机构号
       ,t1.col_11                         AS 管户机构名称
       ,t1.col_12                         AS 管户客户经理工号
       ,t1.col_13                         AS 管户客户经理名称
       ,t1.col_14                         AS 合同起始日
       ,t1.col_15                         AS 终结日期
       ,t1.col_16                         AS 冻结状态代码码值
       ,t23.area_name                     AS 省
       ,t22.area_name                     AS 市
       ,t21.area_name                     AS 区_县
       ,concat(t24.area_name,t2.dtl_addr) AS 经营详细地址
from lab_bigdata_dev.qbi_file_20250717_11_05_57_0 t1
LEFT JOIN edw.loan_cst_ctc_addr     t2
ON t1.col_1 = t2.cst_id
AND t2.dt = '20250716'
and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
left join edw.loan_admin_sm_area t21
ON      concat(substr(t2.adiv, 1, 6), '000000') = t21.area_code and t21.dt='20250716'
left join edw.loan_admin_sm_area t22
ON      concat(substr(t2.adiv, 1, 4), '00000000') = t22.area_code and t22.dt='20250716'
left join edw.loan_admin_sm_area t23
ON      concat(substr(t2.adiv, 1, 2), '0000000000') = t23.area_code and t23.dt='20250716'
left join edw.loan_admin_sm_area t24
ON     t2.adiv = t24.area_code   and t24.dt='20250716'
where t1.pt<>''
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071586_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ2025071586_CST_01
***林小素_SJ2025071666_同一风险控制号场口金额.sql
-- 林小素_SJ2025071666_同一风险控制号敞口金额
-- 截止20250716
DROP   TABLE IF     EXISTS SJXQ_SJ2025071666_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071666_CST_01 AS
SELECT  t1.col_1  --序号
       ,t1.col_2  --客户号
       ,t1.col_3  --客户名称
       ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cum_rsk_ctrl_id
from lab_bigdata_dev.qbi_file_20250717_11_01_43_0 t1
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20250716'
where t1.pt<>''
;
-- 同一风险控制号敞口金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025071666_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071666_CST_02 AS
select t1.cst_id
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end cum_rsk_ctrl_id
    ,t1.ctr_serno
	,t1.ctr_epsr_amt                             --合同敞口金额
	,t1.ctr_epsr_bal                             --合同敞口余额
from edw.dim_bus_loan_ctr_bse_inf_dd    t1 --合同基础信息
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='20250716'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071666_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071666_CST_03 AS
SELECT  t1.col_1           AS 序号
       ,t1.col_2           AS 客户号
       ,t1.col_3           AS 客户名称
       ,t1.cum_rsk_ctrl_id AS 同一风险控制号
       ,t3.ctr_epsr_amt    AS 同一风险控制号下合同敞口金额
       ,t3.ctr_epsr_amt    AS 同一风险控制号下合同敞口余额
from SJXQ_SJ2025071666_CST_01   t1
left join(
    select cum_rsk_ctrl_id
        ,sum(ctr_epsr_amt) as ctr_epsr_amt                             --合同敞口金额
        ,sum(ctr_epsr_bal) as ctr_epsr_bal                             --合同敞口余额
    from SJXQ_SJ2025071666_CST_02
    group by cum_rsk_ctrl_id
)t3 on t1.cum_rsk_ctrl_id=t3.cum_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025071666_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025071666_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2025071666_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025071666_CST_03
***林杰_SJ20250709166_长乐村行贷款合同.sql
-- 林杰_SJ20250709166_长乐村行贷款合同
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250709166_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250709166_CST_01 AS
select t1.cst_id                                 --客户号
    ,t1.cst_nm                                   --客户名称
    ,t1.合同号集合
    ,t2.fm_ind	    --农户标志
	,t3.doc_nbr                                  --证件号码
	,case when length(t3.mbl_nbr)>=7 or length(t3.fml_tel_nbr)<=3 then t3.mbl_nbr
        else t3.fml_tel_nbr end as mbl_nbr_mod   --手机
	,t3.reg_adr                                  --户籍地址
	,t3.wrk_adr                                  --经营所在地地址
	,t3.fml_adr                                  --家庭地址
from(
    select t1.cst_id                                 --客户号
        ,t1.cst_nm                                   --客户名称
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    where t1.dt='20250709'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    and t1.mgr_org_id like '3562%' --长乐村行
    group by t1.cst_id,t1.cst_nm
)t1 left join edw.dws_cst_idv_bas_inf_dd	t2 --个人客户基本信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250709'
left join edw.dws_cst_bas_inf_dd 			t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20250709'
;
--地址
DROP   TABLE IF     EXISTS SJXQ_SJ20250709166_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250709166_CST_02 AS
SELECT  t1.cst_id
    ,t23.area_name  as 经营一级地址
    ,t22.area_name  as 经营二级地址
    ,t21.area_name  as 经营三级地址
    ,t24.area_name  as 经营四级地址
    ,t2.dtl_addr    AS 经营详细地址
    ,concat(t23.area_name,t22.area_name,t21.area_name,t24.area_name,t2.dtl_addr)    as 经营地址
    ,t33.area_name  as 户籍一级地址
    ,t32.area_name  as 户籍二级地址
    ,t31.area_name  as 户籍三级地址
    ,t34.area_name  as 户籍四级地址
    ,t3.dtl_addr    AS 户籍详细地址
    ,concat(t33.area_name,t32.area_name,t31.area_name,t34.area_name,t3.dtl_addr)    as 户籍地址
    ,t43.area_name as 居住一级地址
    ,t42.area_name as 居住二级地址
    ,t41.area_name as 居住三级地址
    ,t44.area_name as 居住四级地址
    ,t4.dtl_addr   AS 居住详细地址
    ,concat(t43.area_name,t42.area_name,t41.area_name,t44.area_name,t4.dtl_addr)    as 居住地址
    ,t53.area_name as 办公一级地址
    ,t52.area_name as 办公二级地址
    ,t51.area_name as 办公三级地址
    ,t54.area_name as 办公四级地址
    ,t5.dtl_addr   AS 办公详细地址
    ,concat(t53.area_name,t52.area_name,t51.area_name,t54.area_name,t5.dtl_addr)    as 办公地址
from SJXQ_SJ20250709166_CST_01  t1
LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250709'
and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
left join edw.loan_admin_sm_area t21
ON      concat(substr(t2.adiv, 1, 6), '000000') = t21.area_code and t21.dt='20250709'
left join edw.loan_admin_sm_area t22
ON      concat(substr(t2.adiv, 1, 4), '00000000') = t22.area_code and t22.dt='20250709'
left join edw.loan_admin_sm_area t23
ON      concat(substr(t2.adiv, 1, 2), '0000000000') = t23.area_code and t23.dt='20250709'
left join edw.loan_admin_sm_area t24
ON     t2.adiv = t24.area_code   and t24.dt='20250709'
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250709'
and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
left join edw.loan_admin_sm_area t31
ON      concat(substr(t3.adiv, 1, 6), '000000') = t31.area_code and t31.dt='20250709'
left join edw.loan_admin_sm_area t32
ON      concat(substr(t3.adiv, 1, 4), '00000000') = t32.area_code and t32.dt='20250709'
left join edw.loan_admin_sm_area t33
ON      concat(substr(t3.adiv, 1, 2), '0000000000') = t33.area_code and t33.dt='20250709'
left join edw.loan_admin_sm_area t34
ON     t3.adiv = t34.area_code   and t34.dt='20250709'
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '20250709' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --居住地址
left join edw.loan_admin_sm_area t41
ON      concat(substr(t4.adiv, 1, 6), '000000') = t41.area_code and t41.dt='20250709'
left join edw.loan_admin_sm_area t42
ON      concat(substr(t4.adiv, 1, 4), '00000000') = t42.area_code and t42.dt='20250709'
left join edw.loan_admin_sm_area t43
ON      concat(substr(t4.adiv, 1, 2), '0000000000') = t43.area_code and t43.dt='20250709'
left join edw.loan_admin_sm_area t44
ON     t4.adiv = t44.area_code   and t44.dt='20250709'
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '20250709' and t5.del_ind='0' 	--未删除
AND t5.addr_typ = '050400' --办公地址
left join edw.loan_admin_sm_area t51
ON      concat(substr(t5.adiv, 1, 6), '000000') = t51.area_code and t51.dt='20250709'
left join edw.loan_admin_sm_area t52
ON      concat(substr(t5.adiv, 1, 4), '00000000') = t52.area_code and t52.dt='20250709'
left join edw.loan_admin_sm_area t53
ON      concat(substr(t5.adiv, 1, 2), '0000000000') = t53.area_code and t53.dt='20250709'
left join edw.loan_admin_sm_area t54
ON     t5.adiv = t54.area_code   and t54.dt='20250709'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250709166_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250709166_CST_03 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_nm      AS 客户名称
       ,t1.合同号集合
       ,t1.fm_ind      AS 农户标志
       ,t2.居住地址
       ,t2.居住一级地址
       ,t2.居住二级地址
       ,t2.居住三级地址
       ,t2.居住四级地址
       ,t2.居住详细地址
       ,t2.经营地址
       ,t2.经营一级地址
       ,t2.经营二级地址
       ,t2.经营三级地址
       ,t2.经营四级地址
       ,t2.经营详细地址
       ,t2.户籍地址
       ,t2.户籍一级地址
       ,t2.户籍二级地址
       ,t2.户籍三级地址
       ,t2.户籍四级地址
       ,t2.户籍详细地址
       ,t2.办公地址
       ,t2.办公一级地址
       ,t2.办公二级地址
       ,t2.办公三级地址
       ,t2.办公四级地址
       ,t2.办公详细地址
       ,t1.doc_nbr     AS 证件号码
       ,t1.mbl_nbr_mod AS 手机
from SJXQ_SJ20250709166_CST_01      t1
left join SJXQ_SJ20250709166_CST_02 t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250709166_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250709166_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250709166_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20250709166_CST_03
***柳青_SJ2025041761_庆元村行信贷营销走访.sql
﻿/*
个人：
基本信息：edw.loan_cst_indiv_bsc
经营信息：edw.loan_cst_opr_bsc
对公：
基本信息：edw.loan_cst_corp_bsc
经营信息： cst_opr_bsc
-- 如果对私客户的客户类型是05对私其他或者03个体经营户非持牌的，就要查cst_opr_bsc表用客户号关联
-- 如果是其他对私客户就查cst_rel表里rel_psn_typ = '6'的
客户类型是05对私其他或者03个体经营户非持牌的，客户经营信息里面对应的就是他自己
*/
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_01 AS
SELECT  t1.col_1 --客户编号
       ,t1.col_2 --客户名称
       ,t1.col_3 --行业投向小类
       ,t1.col_4 --行内十二级分类
       ,t1.col_5 --管户机构号
       ,t1.col_6 --管户机构名称
       ,t1.col_7 --管户人工号
       ,t1.col_8 --管户人姓名
       ,t1.col_9 --发放人机构
       ,t2.cst_id
       ,t2.VLD_CST --有效户：0否1是
       ,t3.age,t4.cst_typ,t4.cst_nm
       ,CASE WHEN nvl(t5.SAM_RSK_CTRL_ID,'') = '' THEN t5.cst_id  ELSE t5.sam_rsk_ctrl_id END AS cmn_rsk_ctrl_id
       ,t5.LOAN_CST_TYP_CD	--客户类型
       ,t6.is_risk_cst	--	是否风险客户
from lab_bigdata_dev.qbi_file_20250421_16_07_16_0   t1
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t2 --客户规则类通用营销特性表
on t1.col_1 = t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	    t3 --对私客户基础信息
on t1.col_1 = t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.loan_cst_indiv_bsc    t4 --个人客户基本信息
on t1.col_1=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
and t4.DEL_IND = '0'
LEFT JOIN edw.DWS_CST_BAS_INF_DD    t5
ON T1.col_1 = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd t6 --客户集市-风险信息-基础风险标签信息
ON T1.col_1 = t6.cst_id
AND t6.dt = '@@{yyyyMMdd}'
where T1.pt<>''
;
-- 关联企业 经营企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_02 AS
select DISTINCT t1.cst_id
    ,t2.rel_cst_id
    ,t3.cst_nm                         --客户名称
from SJXQ_SJ2025041761_CST_01       t1
inner join edw.loan_cst_rel         t2 --客户关联关系信息
on t1.cst_id=t2.cst_id
and t2.DT = '@@{yyyyMMdd}'
and t2.rel_psn_typ = '6'    --经营企业
and t2.DEL_IND ='0'
LEFT JOIN edw.loan_cst_corp_bsc     T3 --企业基本信息
ON      T2.rel_cst_id = T3.cst_id
AND     T3.dt = '@@{yyyyMMdd}'
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_03 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
    ,case when t3.cst_id is not null then 'Y' else 'N' end as 配偶我行是否有授信业务
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
-- 关联客户是否有未结清的授信业务（除信用卡）
left join
(
    SELECT  distinct t1.cst_id
    FROM edw.dim_bus_loan_ctr_bse_inf_dd t1
    INNER JOIN edw.dim_bus_loan_prd_frml_dd t2
    ON t1.prd_no = t2.prd_no AND t2.dt = t1.dt AND t2.PD_NM not regexp '信用卡'
    WHERE t1.dt = '@@{yyyyMMdd}'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t3 on t1.rel_cst_id = t3.cst_id
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_04 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '@@{yyyyMMdd}' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='@@{yyyyMMdd}' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 最新征信信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_05 AS
-- 个人
SELECT  t1.cst_id
    ,t1.report_no
    ,t1.report_dt                --报告日期
    ,t1.oth_bank_loan_credit_bal --他行贷款授信余额
    ,t2.他行贷款余额
    ,t2.oth_bnk_RATE
from edw.dws_cst_ccrc_idv_ind_inf_dd  t1 --个人征信指标信息表
left join(
    SELECT  t1.report_id
        ,SUM(CASE WHEN t1.act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN t1.ctr_bal END)             AS 他行贷款余额
    FROM edw.dim_cst_ccrc_idv_loan_inf_dd       t1 --个人征信客户贷款信息
    left join    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t2 --个人征信借贷账户利率计算
    on      t1.report_id = t2.crd_rpt_id
    and     t1.act_id = t2.act_id
    and     t2.act_id <> ''
    and     coalesce(t2.intr_rat, '') <> ''
    and     t2.intr_rat <> '-9999'
    and     t2.dt = '@@{yyyyMMdd}'
    WHERE t1.DT = '@@{yyyyMMdd}'
    AND t1.dtrb_org not LIKE '%ZJTLCB%' --剔除本机构
    AND t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
    GROUP BY t1.report_id
)t2 on t2.report_id=t1.report_no
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1
union all
--企业
SELECT  t1.cst_id
    ,t1.report_no
    ,t1.report_dt                --报告日期
    ,t1.cred_total_balan    --信用总余额
    ,t2.他行贷款余额
    ,t2.oth_bnk_RATE
from edw.dws_cst_ccrc_entp_ind_inf_dd  t1       --企业征信指标信息表
left join(
    SELECT  t1.report_id
        ,SUM(t1.loan_bal)             AS 他行贷款余额
    FROM edw.dim_cst_ccrc_entp_loan_inf_dd       t1 --个人征信客户贷款信息
    ---- 征信企业借贷账户利率计算
    left join edw.dwd_cst_ccrc_entp_dc_act_intr_rat_clc_dd t2
    on      t1.report_id = t2.rpt_no
    and     t1.act_id = t2.act_id
    and     t2.act_id <> ''
    and     coalesce(t2.mon_intr_rat, '') <> ''
    and     t2.mon_intr_rat <> '-9999'
    and     t2.dt = '@@{yyyyMMdd}'
    WHERE t1.DT = '@@{yyyyMMdd}'
    AND ( t1.loan_mtu_dt >= t1.DT AND t1.loan_bal > 0 ) --未到期
    AND t1.bus_pd_cls_cd = '11' --业务产品种类代码贷款
    AND t1.act_typ NOT IN ( 'D2' , 'C1' ) ---- 剔除催收账户和贴现账户
    AND t1.dtrb_org_typ_cd <> '' --剔除泰隆
    AND t1.dtrb_org_typ_cd <> '00' --剔除本机构
    AND t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
    and t1.dtrb_org_cd != '00'
    GROUP BY t1.report_id
)t2 on t2.report_id=t1.report_no
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1
;
-- 精准贷后 取2024年最近一次触发精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_06 AS
SELECT t2.cst_id
    ,t2.cst_rsk_dgr_nm
    ,t2.cst_lvl_pst_loan_mng_pln_nm     --客户级贷后管理方案
    ,ROW_NUMBER() OVER(PARTITION BY t2.cst_id ORDER BY T2.sys_reg_tm DESC) RN
from(
    SELECT btch_serno
        ,tsk_gen_dt   --任务生成日期 精准贷后风险触发时间
        ,ROW_NUMBER() over(PARTITION BY btch_serno ORDER BY tsk_gen_dt deSC) rn_desc
    from edw.dwd_bus_loan_psp_chk_tsk_inf_dd  AS T2 --贷后检查任务信息
    where DT = '@@{yyyyMMdd}'
    AND pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
    AND tsk_gen_dt <= '@@{yyyyMMdd}'
)t1 inner JOIN (
    SELECT t1.btch_serno,t1.cst_id
        ,t1.cst_rsk_dgr_cd	    --	客户风险程度代码|c2
        ,c2.cd_val_dscr     as cst_rsk_dgr_nm
        ,t1.cst_lvl_pst_loan_mng_pln_cd              --客户级贷后管理方案代码 ,'03','重组','04','退出','06','预保预报','07','清收','08','诉讼'
        ,c1.cd_val_dscr     as cst_lvl_pst_loan_mng_pln_nm
        ,t1.chk_cpl_dt	    --检查完成日期|c8
        ,T1.sys_reg_tm	--	系统登记时间
    from edw.dwd_bus_loan_psp_chk_btch_inf_dd AS T1 --贷后检查批次信息表
    LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
    ON      t1.cst_lvl_pst_loan_mng_pln_cd = c1.cd_val
    AND     c1.DT = t1.dt
    LEFT JOIN    edw.dwd_code_library_dd 	c2 --码值表
    ON      t1.CST_RSK_DGR_CD = c2.cd_val
    AND     c2.DT = t1.dt
    where t1.DT = '@@{yyyyMMdd}'
)t2 on t1.btch_serno=t2.btch_serno
where t1.rn_desc=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041761_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041761_CST_07 AS
SELECT  t1.col_1                                               AS 客户编号
       ,t1.col_2                                               AS 客户名称
       ,t1.col_3                                               AS 行业投向小类
       ,t1.col_4                                               AS 行内十二级分类
       ,t1.col_5                                               AS 管户机构号
       ,t1.col_6                                               AS 管户机构名称
       ,t1.col_7                                               AS 管户人工号
       ,t1.col_8                                               AS 管户人姓名
       ,t1.col_9                                               AS 发放人机构
       ,t1.VLD_CST                                             AS 有效户标识
       ,t1.cmn_rsk_ctrl_id                                     AS 同一风险控制号
       ,t1.age                                                 AS 年龄
       ,t2.rel_cst_id                                          AS 配偶客户号
       ,t2.cst_chn_nm                                          AS 配偶姓名
       ,t2.配偶我行是否有授信业务
       ,coalesce(t3.rel_cst_id,t1.cst_id)                      AS 关联企业客户号
       ,coalesce(t3.cst_nm,t1.cst_nm)                          AS 关联企业名称
       ,CASE WHEN t4.cst_id is not null THEN 'Y'  ELSE 'N' END AS 关联企业我行是否有授信业务
       ,t5.scor_rng                                            AS 征信分数段
       ,t6.report_dt as 最近一次征信查询时间
       ,t6.他行贷款余额
       ,t6.oth_bnk_RATE                                        AS 他行利率
       ,t1.is_risk_cst                                         AS 是否风险客户
    ,t7.cst_rsk_dgr_nm as 客户风险程度
    ,t7.cst_lvl_pst_loan_mng_pln_nm     as 客户级贷后管理方案
from SJXQ_SJ2025041761_CST_01 t1
left join SJXQ_SJ2025041761_CST_03 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025041761_CST_02 t3
on t1.cst_id=t3.cst_id
-- 关联客户是否有未结清的授信业务（除信用卡）
left join
(
    SELECT  distinct t1.cst_id
    FROM edw.dim_bus_loan_ctr_bse_inf_dd t1
    INNER JOIN edw.dim_bus_loan_prd_frml_dd t2
    ON t1.prd_no = t2.prd_no AND t2.dt = t1.dt AND t2.PD_NM not regexp '信用卡'
    WHERE t1.dt = '@@{yyyyMMdd}'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t4 on coalesce(t3.rel_cst_id,t1.cst_id) = t4.cst_id
left join SJXQ_SJ2025041761_CST_04 t5
on t1.cst_id=t5.cst_id and t5.rn=1
left join SJXQ_SJ2025041761_CST_05 t6
on t1.cst_id=t6.cst_id
left join (
    SELECT CST_iD
    FROM SJXQ_SJ2025041761_CST_06
    WHERE RN=1
    GROUP BY CST_ID
) t7
on t1.cst_id=t7.cst_id
;
SElECT '07' seq, *
from SJXQ_SJ2025041761_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041761_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041761_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041761_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041761_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041761_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041761_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户编号) custs
from SJXQ_SJ2025041761_CST_07
;
/*
01	8025	8025
02	752	736
03	2274794	2274241
04	3644721	3644720
05	6327540	6327538
06	724159	445747
07	8042	8025
*/
***柳青_SJ2025051701_配偶客户营销.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025051701_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051701_CST_01 AS
SELECT  col_1 --客户号
       ,col_2 --客户名称
       ,col_3 --管户客户经理工号
       ,col_4 --管户客户经理名称
       ,col_5 --子社区名称
from lab_bigdata_dev.qbi_file_20250520_09_10_24_0
where pt<>''
;
--客户担任法人的企业 关联企业
DROP   TABLE IF     EXISTS SJXQ_SJ2025051701_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051701_CST_02 AS
select t.*
    ,row_number() over(partition by cst_id,entp_cst_id order by priority) rn
from(
    select t1.cst_id
        ,t2.cst_chn_nm                               --客户中文名称
        ,t1.rel_cst_id  as entp_cst_id
        ,t3.cst_chn_nm  as entp_cst_nm
        ,'1' as priority
    from(
        SElECT cst_id,rel_cst_id
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
        and rel_typ='0101' --0101:法定代表人
        union
        SElECT rel_cst_id,cst_id
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
        and rel_typ='0101' --0101:法定代表人
    )t1 inner join edw.dim_cst_idv_bas_inf_dd   t2 --个人客户基本信息
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    left join edw.dws_cst_bas_inf_dd 		    t3 --客户基础信息汇总表
    on t1.rel_cst_id=t3.cst_id
    and t3.dt='@@{yyyyMMdd}'
    union all
    select lgp_cst_id                               --对公客户法人客户号
        ,lgp_nm                                   --对公客户法人客户名称
        ,cst_id                                   --客户号
        ,cst_nm                                   --客户名称
        ,'2' as priority
    from edw.dim_cst_entp_lgp_inf_dd              --对公客户法人信息表
    where dt='@@{yyyyMMdd}'
    union all
    select t2.cst_id
        ,t1.legal_name                               --对公客户法定代表人客户姓名
        ,t1.cst_id                                   --客户号
        ,t1.cst_chn_nm                               --客户姓名
        ,'3' as priority
    from adm_pub.adm_csm_cbas_org_inf_dd t1 --客户集市-客户基础-对公客户基础信息
    inner join edw.dws_cst_bas_inf_dd 	 t2 --客户基础信息汇总表
    on t1.legal_card_no=t2.doc_nbr
    and t1.legal_card_type=t2.doc_typ_cd
    and t2.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
)t
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2025051701_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051701_CST_03 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join(
    select distinct col_1 as cst_id
    from SJXQ_SJ2025051701_CST_01
)t3 on t1.cst_id=t3.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025051701_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051701_CST_04 AS
SELECT  t1.col_1                       AS 客户号
       ,t1.col_2                       AS 客户名称
       ,t1.col_3                       AS 管户客户经理工号
       ,t1.col_4                       AS 管户客户经理名称
       ,t1.col_5                       AS 子社区名称
       ,t2.rel_cst_id                  AS 配偶名称
       ,t2.cst_chn_nm                  AS 配偶客户号
       ,t3.entp_cst_nm                 AS 客户的关联企业名称
       ,t4.entp_cst_nm                 AS 客户配偶的关联企业名称
       ,t5.report_dt                   AS 配偶征信报告日期
       ,t5.oth_cred_total_amt          AS 配偶他行授信总额
       ,t5.othr_bnk_mngmt_loan_org_num AS 配偶他行经营性贷款授信机构数
       ,t5.oth_bank_busi_org_num       AS 配偶他行授信机构数_不含未激活
       ,t5.oth_bank_credit_total_amt   AS 配偶他行授信总余额_不含未激活
       ,t5.oth_bank_loan_org_num       AS 配偶他行贷款授信机构数
       ,t5.oth_bank_loan_credit_bal    AS 配偶他行贷款授信余额
       ,t6.vld_dep_act                 AS 配偶是否我行有效存款户
       ,t7.vld_loan_act                AS 配偶是否我行有效贷款户
from SJXQ_SJ2025051701_CST_01       t1
left join SJXQ_SJ2025051701_CST_03  t2
on t1.col_1=t2.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025051701_CST_02
    where rn=1
    group by cst_id
)t3 on t1.col_1=t3.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025051701_CST_02
    where rn=1
    group by cst_id
)t4 on t2.rel_cst_id=t4.cst_id
left join edw.dws_cst_ccrc_idv_ind_inf_dd t5 --个人征信指标信息表
on t2.rel_cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
and t5.report_dsc_rn=1     --最新报告
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd t6 --规则通用金融行为存款标签
on t2.rel_cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t7 --通用金融行为贷款标签2表
on t2.rel_cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025051701_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051701_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051701_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025051701_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2025051701_CST_04
***梁俊杰_SJ2025032536_洗钱风险评估.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 于彪
-- 创建日期: 2025-03-19 18:17:03
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- report_organkey = 'C1406244000019' 	四会
-- organkey LIKE '4462%' 	四会
-- brc_org_nm = '广东四会泰隆村镇银行'
/*5.1客户尽职调查（初次识别）、风险等级划分、身份资料保存情况
1.对建立业务关系的客户与符合条件的一次性交易客户开展尽职调查，准确了解客户及代理人、受益所有人身份信息，并完整保存；
2.客户洗钱风险分类管理机制完善，风险等级划分方法、流程或指标合理，能够及时划分和调整客户洗钱风险等级；
3.全面、准确保存客户身份识别所获取的身份资料及客户尽职调查工作记录，能够以客户为单位实现统一查询、更新和管理，身份资料便于客户尽职调查、可疑交易监测与反洗钱调查使用；
（保险、支付等行业客户尽调以达到法规要求起点金额或其他条件为前提）
*/
-- 5.1.h.客户洗钱风险分类划分的级别和各级别数量、占比
-- 1、在2024年12月31日时点，最终人工认定为高风险、较高风险、一般风险、较低风险、低风险的客户有多少
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_01 AS
SELECT  '5.1.h 洗钱风险等级' id_nm
       ,S.LEVELKEY
       ,COUNT(distinct bb.cst_id) as 客户数
FROM
(
	SELECT  A.PARTY_ID
	       ,A.LEVELKEY
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND A.DT = '20241231'
	UNION
	SELECT  T.PARTY_ID
	       ,T.LEVELKEY
	FROM
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		AND NOT EXISTS (
		SELECT  1
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
		WHERE A.PARTY_ID = B.PARTY_ID
		AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND B.DT = '20241231')
	) T
	WHERE RN = 1
) S inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on substr(s.party_id,3) = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
GROUP BY  S.LEVELKEY
;
select t1.id_nm
       ,t1.LEVELKEY
       ,t1.客户数
       ,round(t1.客户数/t2.total_custs,4) as 占比
from SJXQ_SJ2025032536_CST_01 t1
left join(
    select id_nm,sum(客户数) as total_custs
    from SJXQ_SJ2025032536_CST_01
    GROUP BY id_nm
)t2 on  t1.id_nm=t2.id_nm
;
-- 5.1.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比 (少了部分新开户客户没有评级)
--账户均已销户的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_02 PURGE;
create table IF NOT EXISTS SJXQ_SJ2025032536_CST_02  as
select  customer_id     --12位
       ,count(1)    AS  CLOSE_ACCT_SM
from adm_upss.aml_t47_agreement    -- 反洗钱账户表
group by customer_id
having  count(1)=sum( case when acct_status_cd='1' then 1 else 0 end )
;
SELECT  '5.1.i1 近一年建立业务关系客户数' id_nm
       ,COUNT(distinct SUBSTR(aa.PARTY_ID,3)) num
FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
INNER JOIN edw.dws_cst_bas_inf_dd SS
ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
WHERE aa.dt = '20241231'
AND SS.file_dt >= '20240101' --开户日期
AND SS.file_dt <= '20241231' --开户日期
AND aa.CUST_KIND <> '3'     --1有账户的客户 2无账户的客户 3一次性金融服务客户 4境外卡客户
AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ2025032536_CST_02 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID
)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_03 AS
SELECT  '5.1.i2 近一年建立业务关系客户数' id_nm
       ,S.LEVELKEY
       ,COUNT(SUBSTR(S.PARTY_ID,3)) as 客户数
FROM
(
	SELECT  aa.PARTY_ID
	       ,CASE WHEN DD.LEVELKEY IS NULL THEN '1001'  ELSE DD.LEVELKEY END AS LEVELKEY
	FROM ADM_UPSS.ADM_UPSS_AML_T47_PARTY aa
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON AA.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
	INNER JOIN edw.dws_cst_bas_inf_dd SS
	ON SUBSTR(aa.PARTY_ID, 3) = SS.cst_id AND SS.DT = '20241231'
	LEFT JOIN
	(
		SELECT  A.PARTY_ID
		       ,A.LEVELKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
		AND A.DT = '20250115'
		UNION
		SELECT  T.PARTY_ID
		       ,T.LEVELKEY
		FROM
		(
			SELECT  A.PARTY_ID
			       ,A.LEVELKEY
			       ,RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY  A.RCHECK_DT DESC) AS RN
			FROM adm_upss.AML_T37_PARTY_RESULT_UH A
			WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND A.DT = '20250115'
			AND NOT EXISTS (
			SELECT  1
			FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
			WHERE A.PARTY_ID = B.PARTY_ID
			AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20250115'
			AND B.DT = '20250115')
		) T
		WHERE RN = 1
	) dd
	ON AA.PARTY_ID = dd.party_id
	WHERE aa.dt = '20241231'
	AND SS.file_dt >= '20240101' --开户日期
	AND SS.file_dt <= '20241231' --开户日期
	AND aa.CUST_KIND <> '3'
	AND NOT EXISTS(
	SELECT  1
	FROM SJXQ_SJ2025032536_CST_02 ZZ
	WHERE ZZ.customer_id = AA.PARTY_ID)
) s
GROUP BY  s.LEVELKEY
;
select t1.*,round(t1.客户数/t2.total_custs,4) as 占比
from SJXQ_SJ2025032536_CST_03 t1
left join(
    select id_nm,sum(客户数) as total_custs
    from SJXQ_SJ2025032536_CST_03
    group by id_nm
)t2 on t1.id_nm=t2.id_nm
;
/*5.2持续尽职调查与高风险客户强化尽调
1.建立专门部门或指定部门、岗位开展强化客户尽职调查和风险管控工作，并确保岗位人员能够全面获取客户有关身份、交易信息，直接或通过业务部门向客户补充了解资金来源、交易目的等信息；
2.根据客户尽职调查和风险等级划分结果，对高风险客户包括外国政治公众人物等采取报请高管层审批等强化尽调措施，及时对超出风险接受程度的客户采取管控措施，使本机构相关产品、业务被客户利用与洗钱的风险显著降低；
3.风险管控措施与客户或交易的风险程度相匹配，避免一刀切或&ldquo;去风险化&rdquo;。
*/
-- 5.2.d.近一年内发现个人身份证件过期的数量，因身份证件过期且无合理理由未更新而中止业务关系的客户数量
-- 121618
SELECT  '5.2.d1 近一年证件过期数' id_nm
       ,COUNT(distinct party_id) as 客户数
FROM
(
	SELECT  a.party_id,a.ORGANKEY
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240101'
	AND b.card_end_dt <= '20241231'
	--AND (a.party_status_cd = '0' or b.flag = '0')
) T INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON t.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
union all
SELECT  '5.2.d2 近一年证件过期中止业务数' id_nm
       ,COUNT(distinct party_id)
FROM
(
	SELECT  a.party_id,a.ORGANKEY
	       ,b.card_end_dt
	       ,a.party_status_cd --当事人状态:0：正常1：销户2：未开户4：删除X：未知
	       ,b.flag --0禁用1启用
	       ,SUBSTR(a.host_cust_id,3) AS cst_id
	FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND A.DT = '20241231'
	AND B.DT = '20241231'
	AND b.card_end_dt >= '20240101'
	AND b.card_end_dt <= '20241231'
) T INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
ON t.ORGANKEY = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
inner JOIN
(
	SELECT  cst_id
	       ,MAX(zf) AS max_zf
	FROM
	(
		SELECT  cst_act_id
		       ,cst_id
		       ,CASE WHEN act_cls_frz_ind = '1' or act_rcv_oly_ind = '1' THEN 0  ELSE 1 END AS zf
		FROM edw.dim_bus_dep_cst_act_inf_dd --客户存款账户信息
		WHERE dt = '20241231'
	) AS a1
	GROUP BY  cst_id
	HAVING max_zf = 0
) AS t1
ON t.cst_id = t1.cst_id
;
-- 5.2.f.近一年内发现客户身份注销的数量及终止业务关系的数量，从发现注销到完成终止业务关系流程的最长时间
-- 新口径
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_08 AS
SELECT *
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC) AS RN
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY is_abnormal desc,GEB_HOSTSENDTIME ASC) AS RN2
FROM    (
    SELECT  GEB_ENTNAME             --客户名称
        ,GEB_CREDITCODE             --统一社会信用代码
        ,GEB_ENTTYPE                --企业机构类型
        ,GEB_FRNAME                 --法定代表人负责人执行事务合伙人
        ,GEB_ENTSTATUS              --经营状态
        ,GEB_RECCAP                 --实收资本万元
        ,GEB_REGCAPCUR              --注册资本币种
        ,GEB_REGORGCITY             --所在城市
        ,GEB_REGORGDISTRICT         --所在区县
        ,GEB_ZSOPSCOPE              --经营业务范围
        ,GEB_DOM                    --住所
        ,GEB_INDUSTRYCONAME         --国民经济代码名称
        ,geb_esdate                 --成立日期
        ,geb_othertel               --其他电话
        ,GEB_HOSTSENDTIME           --geb_hostsendtime 交易发送主机时间
        ,geb_regorgprovince         --所在省份
        ,geb_regorgcode             --注册地址行政编号
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
	   ,dt
    FROM    edw.OUTD_GS_ENTINFO_BASIC   --工商企业-企业基本信息
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(GEB_CREDITCODE,'')<>''
    UNION ALL
    SELECT  dt_entname         AS GEB_ENTNAME
        ,dt_creditcode         AS GEB_CREDITCODE
        ,dt_enttype            AS GEB_ENTTYPE
        ,dt_frname             AS GEB_FRNAME
        ,dt_entstatus          AS GEB_ENTSTATUS
        ,dt_reccap             AS GEB_RECCAP
        ,dt_regcapcur          AS GEB_REGCAPCUR
        ,dt_regorgcity         AS GEB_REGORGCITY
        ,dt_regorgdistrict     AS GEB_REGORGDISTRICT
        ,dt_zsopscope          AS GEB_ZSOPSCOPE
        ,dt_dom                AS GEB_DOM
        ,dt_industryconame     AS GEB_INDUSTRYCONAME
        ,dt_esdate             AS geb_esdate
        ,dt_othertel           AS geb_othertel
        ,insert_time_chinadaas AS GEB_HOSTSENDTIME
        ,dt_regorgprovince     AS geb_regorgprovince
        ,dt_regorgcode         AS geb_regorgcode
       ,dt_candate    --注销日期
       ,dt_revdate    --吊销日期
       ,dt_orgcodes   --组织机构代码
       ,dt_regno      --注册号
	   ,dt
    FROM    edw.nout_zs_ent_basic
    WHERE   dt between '20240101' and '20241231' 	--近一年
	and nvl(dt_creditcode,'')<>''
)a
;
--步骤二：对公账户工商注销后，其在我行开立的结算账户状态
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_09 AS
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep --存款账户信息
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ2025032536_CST_08 B
ON A.cst_chn_nm = B.geb_entname
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ2025032536_CST_08 B
ON A.prm_doc_nbr = B.geb_creditcode
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ2025032536_CST_08 B
ON A.prm_doc_nbr = B.geb_orgcodes
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
UNION
SELECT  A.cst_id            --客户号
       ,A.cst_chn_nm        --客户名称
       ,A.prm_doc_typ_cd    --主证件类型代码
       ,A.prm_doc_nbr       --主证件号码
       ,dep.cst_act_id      --客户账号
       ,dep.dep_act_id      --负债账号
       ,dep.act_nm          --账户名称
       ,dep.act_sts_cd      --账户状态
       ,dep.act_dstr_act_dt --账户销户日期
       ,B.geb_entstatus     --工商状态
       ,B.geb_candate       --注销日期
       ,B.geb_revdate       --吊销日期
       ,B.DT                --查询日期
FROM edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN edw.dim_bus_dep_act_inf_dd dep
ON A.cst_id = dep.cst_id AND dep.stl_act_ind = '1' --结算账户标志
 AND dep.dt = '20241231'
INNER JOIN SJXQ_SJ2025032536_CST_08 B
ON A.prm_doc_nbr = B.geb_regno
LEFT JOIN edw.dwd_code_library_dd C
ON A.prm_doc_typ_cd = C.cd_val AND C.dt = '20241231' AND C.tbl_nm = 'DIM_CST_BAS_INF_DD' AND C.fld_nm = 'PRM_DOC_TYP_CD'
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on a.cst_id = bb.cst_id and bb.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.dt = '20241231'
AND substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND B.is_abnormal=1   --经营状态异常
and b.rn=1
;
-- 近一年内发现客户身份注销的数量 --99145
SELECT  '5.2.f1 身份注销客户数' id_nm
       ,COUNT(distinct cst_id) as 客户数
FROM SJXQ_SJ2025032536_CST_09 t
union all
-- 近一年内发现客户身份注销的数量及终止业务关系的数量
-- 94572
SELECT  '5.2.f2 身份注销终止业务客户数' id_nm
       ,COUNT(distinct cst_id) as 客户数
FROM SJXQ_SJ2025032536_CST_09
WHERE act_sts_cd <> 'A' --账户状态异常
;
-- 从发现注销到完成终止业务关系流程的最长时间
SELECT  '5.2.f3 最长时间' id_nm
       ,MAX(tt.dateminus) max_days
FROM
(
	SELECT  cst_id
	       ,CASE WHEN act_dstr_act_dt >= dt THEN DATEDIFF(to_date(act_dstr_act_dt,'yyyymmdd'),to_date(dt,'yyyymmdd'),'dd')  ELSE 0 END AS dateminus
	FROM
	(
		SELECT  cst_id
		       ,act_dstr_act_dt
		       ,dt
		FROM SJXQ_SJ2025032536_CST_09
		WHERE act_sts_cd <> 'A'
	) t
) tt
;
-- 5.2.g.近一年内，根据机构客户风险等级划分设定，应当及实际开展到期重评客户风险等级的客户数量
-- 2024年，存量客户月底到期重评的客户数量，2023年12月-2024年11月预警的客户。
SELECT  '5.2.g 到期重评的客户数量' id_nm
       ,COUNT(distinct t.party_id) as 客户数
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON a.organkey = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON a.organkey = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2023-12-01'
	AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-11-30'
	AND A.DT = '20241231'
) T;
-- 5.2.h.近一年内，经持续尽调认为业务关系不符合客户身份，需开展强化尽职调查和重新评定客户风险等级的客户数量（不包含以上定期重评、因外部查冻扣开展强化尽调客户）及占全部客户数量比例（名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、2024年完成人工评定的客户，不含新开客户评级、PKG99、PKG51、CXD11两个公式。
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_10 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','') AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T
) S
WHERE S.RN <= 2
;
SELECT  '5.2.h1 重评客户数' id_nm
       ,COUNT(DISTINCT A.PARTY_ID) AS 客户数
FROM SJXQ_SJ2025032536_CST_10 A
WHERE ( ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' ) --初评等级
 AND A.STATISTIC_DT between '20240101' AND '20241231' ) OR ( A.LEVELKEY IN ( '1004' , '1005' ) --最终风险等级
 AND A.RCHECK_DT between '20240101' AND '20241231' ) )
AND ORGANKEY IN ( SELECT B.ORGANKEY FROM adm_upss.adm_upss_aml_t07_report_organ_rel B WHERE B.report_organkey = 'C1406244000019' AND B.DT = '20241231' )
AND A.TEMPCATEGORY = '2' --模板类别（ 1：新开户 2：定期核查）
AND A.organkey LIKE '4462%'
union all
SELECT  '5.2.h2 全部客户数' id_nm
       ,COUNT(1) AS num
FROM
(
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
	WHERE replace(SUBSTR(A.RCHECK_DT, 1, 10), '-', '') BETWEEN '20240101' AND '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
	AND A.organkey LIKE '4462%'
	UNION
	SELECT  A.PARTY_ID
	FROM adm_upss.AML_T37_PARTY_RESULT_UH A
	WHERE replace(SUBSTR(A.RCHECK_DT, 1, 10), '-', '') BETWEEN '20240101' AND '20241231'
	AND A.TEMPCATEGORY = '2'
	AND A.DT = '20241231'
	AND A.organkey LIKE '4462%'
) T
;
-- 5.2.i.近一年内，经尽职调查后，调升、调降客户风险等级的客户数量，调升至最高等级和由最高风险等级调降的客户数量（以上分别统计）
-- 1、调升：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级比前一次高，且系统初评等级不是低风险、较低风险、一般风险。
-- 2013
SELECT  '5.2.i1-调升' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ2025032536_CST_10 A , SJXQ_SJ2025032536_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY < A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T union all
-- 2、调降：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级比前一次低，且系统初评等级不是低风险、较低风险、一般风险。
-- 1360
SELECT  '5.2.i2-调降' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ2025032536_CST_10 A , SJXQ_SJ2025032536_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND B.LEVELKEY > A.LEVELKEY
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.RN = 1
	AND B.RN = 2
) T union all
-- 3、调升至最高等级：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级是高风险，前一次风险等级不是高风险。
-- 216
SELECT  '5.2.i3-调升至最高等级' id_nm,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ2025032536_CST_10 A , SJXQ_SJ2025032536_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY = '1005'
	AND B.LEVELKEY != '1005'
	AND A.RN = 1
	AND B.RN = 2
) T union all
-- 4、由最高风险等级调降的客户：2024年内有过人工评定等级的记录，且2024年内评定时间最晚的一次风险等级比前一次低，且前一次风险等级是高风险。
-- 534
SELECT  '5.2.i4-由最高风险等级调降的客户' id_nm
       ,COUNT(1)
FROM
(
	SELECT  A.PARTY_ID
	FROM SJXQ_SJ2025032536_CST_10 A , SJXQ_SJ2025032536_CST_10 B
	WHERE A.PARTY_ID = B.PARTY_ID
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
	AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
	AND A.LEVELKEY != '1005'
	AND B.LEVELKEY = '1005'
	AND A.RN = 1
	AND B.RN = 2
) T;
--5.2.j 近一年内，经强化尽职调查后，采取业务与交易限制措施的客户数量
-- 1、2024年底，客户风险等级是较高风险、高风险客户数量
-- 2、2024年底，客户风险等级是较高风险、高风险，且在2024年被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付的客户。
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_11 AS
SELECT  S.TEMPLATEKEY     --模板编码
       ,S.GSKEY           --公式编号
       ,S.PARTY_ID        --客户号
       ,S.LEVELKEY        --最终风险等级
       ,S.FRISTAPPRALEVEL --初评等级
       ,S.STATISTIC_DT    --评级日期
       ,S.RCHECK_DT       --审批日期
       ,S.TEMPCATEGORY    --模板类别
       ,S.ORGANKEY        --客户机构
       ,S.RN              --序号
FROM
(
	SELECT  T.TEMPLATEKEY
	       ,T.GSKEY
	       ,T.PARTY_ID
	       ,T.LEVELKEY
	       ,T.FRISTAPPRALEVEL
	       ,T.STATISTIC_DT
	       ,T.RCHECK_DT
	       ,T.TEMPCATEGORY
	       ,T.ORGANKEY
	       ,RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY  T.RCHECK_DT DESC) AS RN
	FROM
	(
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
		UNION
		SELECT  A.TEMPLATEKEY
		       ,A.GSKEY
		       ,A.PARTY_ID
		       ,A.LEVELKEY
		       ,A.FRISTAPPRALEVEL
		       ,replace(SUBSTR(A.STATISTIC_DT,1,10),'-','') AS STATISTIC_DT
		       ,replace(SUBSTR(A.RCHECK_DT,1,10),'-','')    AS RCHECK_DT
		       ,A.TEMPCATEGORY
		       ,A.ORGANKEY
		FROM adm_upss.AML_T37_PARTY_RESULT_UH A
		WHERE replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
		AND A.DT = '20241231'
	) T INNER JOIN edw.dim_hr_org_mng_org_tree_dd cc --机构树
	ON t.organkey = cc.org_id AND cc.dt = '20241231' and cc.brc_org_nm = '广东四会泰隆村镇银行'
) S
WHERE S.RN <= 2
;
--迭代版代码
--2、取2024年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，关联2024年暂停非柜面、账户只收不付、不收不付的客户
--1、取2024年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，去重。
SELECT  '5.2.j1 2024年底较高风险及以上客户数'  AS ind
       ,COUNT(DISTINCT A.PARTY_ID) AS val
FROM SJXQ_SJ2025032536_CST_11 A
WHERE (
    ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
        AND SUBSTR(A.STATISTIC_DT, 1, 10) >= '2024-01-01'
        AND SUBSTR(A.STATISTIC_DT, 1, 10) <= '2024-12-31'
    ) OR
    ( A.LEVELKEY IN ( '1004' , '1005' )
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') >= '20240101'
        AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
    )
)
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406244000019'
    AND B.DT = '20241231'
)
UNION ALL
SELECT  '5.2.j2 2024年底较高风险及以上且交易限制客户数' AS ind
       ,COUNT(DISTINCT S.party_id) AS val
FROM SJXQ_SJ2025032536_CST_11 S
INNER JOIN adm_upss.aml_t47_agreement T
ON S.PARTY_ID = T.customer_id
INNER JOIN
(
	SELECT  CST_ACT_ID
	FROM edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
	WHERE DT = '20241231'
    AND LMT_LVL = '30'
	AND ACT_THRS_TYP = '2'
	AND EVT_ID = 'DPDRAW'
	AND LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
	GROUP BY  CST_ACT_ID
	UNION
	SELECT  C.CST_ACT_ID
	FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
	LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
	ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
	LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
	ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
	WHERE A.DT = '20241231'
	AND A.FRZ_SCP_CD = '2'
	AND A.NFRZ_IND = '0'
	AND A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
	AND B.FRZ_ID IS NULL
	AND C.CST_ACT_ID IS NOT NULL
) M
ON T.acct_num = M.CST_ACT_ID
WHERE ( ( S.fristappralevel IN ( '1004' , '1005' )
AND substr(S.statistic_dt, 1, 10) >= '2024-01-01'
AND substr(S.statistic_dt, 1, 10) <= '2024-12-31' ) OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND substr(S.rcheck_dt, 1, 10) >= '2024-01-01'
AND substr(S.rcheck_dt, 1, 10) <= '2024-12-31' ) )
AND ORGANKEY IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406244000019'
    AND B.DT = '20241231'
);
--5.2.k.近一年内，经强化尽职调查后，终止业务关系的客户数量，以及占全部强化尽职调查客户的比例和占全部客户数量的比例
--2024年底，客户风险等级是较高风险、高风险，且在2024年账户不收不付、销户的客户。
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_12 AS
--账户全部销户
SELECT  A.PARTY_ID --客户号
       ,'1' AS STS --客户状态
FROM adm_upss.ADM_UPSS_AML_T47_PARTY A
WHERE NOT EXISTS (
SELECT  1
FROM adm_upss.ADM_UPSS_AML_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.ACCT_STATUS_CD = '0'
AND B.dt = '20241231') AND A.DT = '20241231'
UNION
--互联网贷款客户借款余额已为0
SELECT  A.PARTY_ID
       ,'2' AS STS
FROM adm_upss.adm_upss_aml_t47_loan_acct A
WHERE A.LTYPEKEY = '201050101040319'
AND AMT_VAL = '0'
AND NOT EXISTS (
SELECT  1
FROM adm_upss.adm_upss_aml_T47_ID_DEPOSIT B
WHERE A.PARTY_ID = B.PARTY_ID
AND B.DT = '20241231') AND A.DT = '20241231'
UNION
--采取不收不付
SELECT  C.CST_ACT_ID
       ,'3'
FROM edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
LEFT JOIN edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
ON A.FRZ_ID = B.FRZ_ID AND B.DT = '20241231' AND b.FRZ_SRC_CD = '1'
LEFT JOIN edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
ON A.LBL_ACT_ID = C.DEP_ACT_ID AND C.DT = '20241231'
WHERE A.DT = '20241231'
AND A.FRZ_SCP_CD = '2'
AND A.NFRZ_IND = '0'
AND A.LMT_TYP IN ( '1' , '2' )
AND B.FRZ_ID IS NULL
AND LMT_TYP = '2'
AND C.CST_ACT_ID IS NOT NULL
;
--9380
SELECT  '5.2.k 2024年底较高风险及以上且账户不收不付销户的客户数'              AS ind
       ,COUNT(distinct A.PARTY_ID) AS val -- 客户数
FROM SJXQ_SJ2025032536_CST_11 A
WHERE A.LEVELKEY IN ( '1004' , '1005' )
AND A.PARTY_ID LIKE 'ZH%'
AND replace(SUBSTR(A.RCHECK_DT,1,10),'-','') <= '20241231'
AND EXISTS (
    SELECT  1
    FROM SJXQ_SJ2025032536_CST_12 B
    WHERE A.PARTY_ID = B.PARTY_ID
    AND B.STS IN ( '1' , '3' )
)
;
--5.2.n 反洗钱 1587
-- 1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
-- 2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且2024年第一次冻扣前已被划分为高风险、较高风险的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_13 AS
SELECT  aa.cst_id
       ,aa.qry_ctrl_dt
       ,aa.qry_ctrl_tm
       ,aa.frz_bgn_dt
       ,aa.frz_tmn_dt
       ,ROW_NUMBER() OVER ( PARTITION BY aa.cst_id ORDER BY  aa.qry_ctrl_dt ,aa.qry_ctrl_tm ) AS rn
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.brc_org_nm = '广东四会泰隆村镇银行'
WHERE aa.dt = '20241231'
AND qry_ctrl_dt >= '20240101'
AND qry_ctrl_dt <= '20241231'
AND qry_ctrl_typ_nm IN ( '冻结' , '划扣' )
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) );
--57关联高风险客群
-- 10692
-- 1587
SELECT  '5.2.n1 2024年度被公安机关冻结扣划客户数'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025032536_CST_13 t
UNION ALL
SELECT  '5.2.n2 2024年度被公安机关冻结扣划客户数且冻扣前已被划分为较高风险以上客户数' AS ind
       ,COUNT(DISTINCT t.cst_id)
FROM SJXQ_SJ2025032536_CST_13 t
INNER JOIN (
	SELECT party_id,min(STATISTIC_DT) as min_STATISTIC_DT
	from SJXQ_SJ2025032536_CST_11
	where LEVELKEY IN ( '1004' , '1005' )
	AND party_id LIKE 'ZH%'
	group by party_id
) A ON T.cst_id = substr(A.party_id, 3)
and t.qry_ctrl_dt>a.min_STATISTIC_DT
WHERE t.rn=1
;
/*6.1大额交易监测
1.大额交易监测系统全面覆盖各项金融业务。包括开立账户等建立持续业务关系的客户、以及未开立账户但办理达到识别金额起点的一次性金融服务的客户；
2.系统设定的大额交易监测标准完全覆盖规定的情形，对同时符合两项以上大额交易标准的交易，能够分别提交大额交易报告；
3.能够在大额交易发生之日起5个工作日内以电子方式提交大额交易报告。
*/
--6.1.b、b.近一年内，机构上报大额交易报告笔数、份数
SELECT  '6.1.b' AS ind
       ,COUNT(B.TICD) as 大额交易笔数
       ,COUNT(DISTINCT A.REPORTKEY) as 大额交易份数
FROM adm_upss.AML_T07_MSG_UH A
inner join adm_upss.aml_t3a_tsdt_n_hst B
on A.REPORTKEY = B.RPT_ID AND B.DT = '20250110'
-- AND B.cust_id LIKE 'ZH%' 	--政和
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON b.tr_org_id = d.org_id --交易机构
AND d.dt = '20241231' AND d.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.REPORTORGANKEY = 'C1406244000019'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
;
--6.1.c.近一年内，大额交易报告交易对手为空（包括填写替代符&ldquo;@N&rdquo;）、为内部过渡账户的比例（按笔计）分别是？（不包括机构自身与客户之间发生的交易，如贷款、付息等）
/*大额现转标志是转账，交易对手账号是空或者交易对手名称是空的；*/
--6373
--538218
SELECT  '6.1.c1 近一年内交易对手为空笔数' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A
inner join adm_upss.AML_T3A_TSDT_N_HST B
on A.REPORTKEY = B.RPT_ID
AND B.DT = '20250110'
AND B.IS_CASH = '01'
AND (B.TCAC = '@N' OR B.TCNM = '@N')
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON b.tr_org_id = d.org_id --交易机构
AND d.dt = '20241231' AND d.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.REPORTORGANKEY = 'C1406244000019'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND A.REPORT_TYPE_CD = 'BH'
union all
/*大额现转标志是转账，交易对手账号是内部账户；*/
SELECT  '6.1.c2 近一年内交易对手为内部过渡账户笔数' AS ind
       ,COUNT(B.TICD)
FROM adm_upss.AML_T07_MSG_UH A
inner join adm_upss.AML_T3A_TSDT_N_HST B
on A.REPORTKEY = B.RPT_ID
AND B.DT = '20250110'
AND B.IS_CASH = '01'
AND B.CRPP NOT LIKE '%贷款发放%'
AND B.CRPP NOT LIKE '%归还贷款%'
AND B.CRPP NOT LIKE '%付息%'
AND B.CRPP NOT LIKE '%结息%'
AND B.cust_id LIKE 'ZH%'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON b.tr_org_id = d.org_id --交易机构
AND d.dt = '20241231' AND d.brc_org_nm = '广东四会泰隆村镇银行'
WHERE A.REPORTORGANKEY = 'C1406244000019'
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND A.REPORT_TYPE_CD = 'BH'
AND EXISTS (
    SELECT  1
    FROM adm_upss.ADM_UPSS_AML_T47_AGREEMENT_ACCT C
    WHERE B.TCAC = C.ACCT_NUM
    AND C.TXN_DSC = 'NBZH'
    AND C.DT = '20250110'
);
--6.1.d.近一年内，大额交易报告报送超时的笔数及比例
--大额交易回执是警告回执，且回执内容含有逾期报送
--273402
SELECT  '6.1.d 近一年报送超时的笔数'                   AS ind
       ,COUNT(DISTINCT D.TICD) AS val
FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B, adm_upss.AML_T3A_FDCF_FCER C , adm_upss.AML_T3A_TSDT_N_HST D
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON d.tr_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东四会泰隆村镇银行'
WHERE C.ERRS LIKE '%逾期%'
AND B.RCPT_ID = C.RCPT_ID
AND A.MSGKEY = B.MSG_ID
AND A.REPORTKEY = D.RPT_ID
AND A.SENDDATE_CH >= '20240101'
AND A.SENDDATE_CH <= '20241231'
AND A.DT = '20250110'
AND B.DT = '20250110'
AND C.DT = '20250110'
AND D.DT = '20250110'
AND A.REPORTORGANKEY = 'C1406244000019'
AND A.REPORT_TYPE_CD = 'BH'
;
/*6.2可疑交易监测覆盖范围与模型优化
1.可疑交易监测系统全面覆盖所有业务、客户和交易，包括开立账户等建立持续业务关系的客户，以及未开立账户但办理达到识别金额起点的一次性金融服务的客户；
2.定期对交易监测标准的有效性进行评估，并根据评估结果和监管部门、司法机关下发的风险提示、洗钱类型分析报告和风险评估报告等持续优化完善监测模型；
3.交易监测模型有效性较高，对非法资金交易的监测预警命中率较高、误报率较低。
*/
--6.2.c.由监测系统形成的可疑交易预警数量，经复核后排除可疑的数量
-- 近一年
SELECT  '6.2.c 系统可疑复核排除可疑的数量' AS ind
    ,count(A.PARTY_ID) as 数量
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东四会泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
and a.date_status_cd='2' --数据来源1：手工新增2：系统生成
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑   --案例类型:1:大额 2:可疑
and a.app_state_cd='4'	--1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406244000019'
    AND B.DT = '20241231'
);
--6.2.d.在监测系统之外，由人工识别触发（如业务人员识别发现）的可疑预警数量
-- 近一年
SELECT  '6.2.d 人工识别可疑预警数量' AS ind
    ,count(A.PARTY_ID) as 可疑预警数量
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东四会泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2024-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
and a.date_status_cd='1' --数据来源1：手工新增2：系统生成
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406244000019'
    AND B.DT = '20241231'
);
--6.2.e.运用创新技术，改进可疑交易监测系统功能的有益做法及成效
--6.2.f.可疑交易预警延后2年实现率：近2年内产生可疑交易预警的客户，在预警后受到司法机关查冻扣、人民银行反洗钱调查或税务机立案调查的客户数量和占比
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_14 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东四会泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2023-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406244000019'
    AND B.DT = '20241231'
);
SELECT  '6.2.f1 近2年可疑客户数'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM SJXQ_SJ2025032536_CST_14
UNION ALL
--6.2.f2、近2年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '6.2.f2 近2年可疑且之后被查冻扣客户数'                    AS ind
       ,COUNT(DISTINCT p.PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025032536_CST_14 t
	WHERE t.rn = 1
) p
INNER JOIN
(
	SELECT  aa.cst_id
	       ,aa.qry_ctrl_dt
	FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
	INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
	ON aa.cst_id = c.cst_id AND c.dt = '20241231'
	INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
	ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.brc_org_nm = '广东四会泰隆村镇银行'
	WHERE aa.dt = '20250101'
	AND qry_ctrl_dt >= '20230101'
	AND qry_ctrl_dt <= '20241231'
) s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
--6.2.g.查冻扣客户3年历史预警率：评估时点近三年内受到司法机关新增查冻扣（不含已有冻扣客户新增轮候冻扣）、人民银行反洗钱调查或税务机立案调查的客户中
-- 在接受调查或冻扣前已产生可疑交易预警的客户数量和占比
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_15 AS
SELECT  A.PARTY_ID
       ,A.APP_DT
       ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY  a.APP_DT ) AS rn
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东四会泰隆村镇银行'
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑 	--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE B.report_organkey = 'C1406244000019'
    AND B.DT = '20241231'
);
DROP   TABLE IF     EXISTS SJXQ_SJ2025032536_CST_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032536_CST_16 AS
SELECT  DISTINCT aa.cst_id
       ,aa.qry_ctrl_dt
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON aa.cst_id = c.cst_id AND c.dt = '20241231'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd d --机构树
ON c.prm_org_id = d.org_id AND d.dt = '20241231' AND d.brc_org_nm = '广东四会泰隆村镇银行'
WHERE aa.dt = '20250101'
AND qry_ctrl_dt >= '20220101'
AND qry_ctrl_dt <= '20241231'
;
SELECT  '6.2.g1 近三年查冻扣客户数'                  AS ind
       ,COUNT(DISTINCT cst_id) AS val
FROM SJXQ_SJ2025032536_CST_16
UNION ALL
--66 2、2020年至2024年被可疑预警的主客户，且在2024年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '6.2.g2 近三年查冻扣且之前可疑预警客户数'                    AS ind
       ,COUNT(DISTINCT PARTY_ID) AS val
FROM
(
	SELECT  t . *
	FROM SJXQ_SJ2025032536_CST_15 t
	WHERE t.rn = 1
) p
INNER JOIN SJXQ_SJ2025032536_CST_16 s
ON substr(p.PARTY_ID, 3) = s.cst_id AND REPLACE(substr(p.APP_DT, 1, 10), '-', '') <= s.qry_ctrl_dt
;
/*6.3可疑交易监测分析与上报机制和流程
1.根据机构规模和风险，建立专业化的可疑交易监测部门或设置相对固定的监测岗位，监测分析人员熟悉本机构业务和洗钱风险特征，从事监测分析工作的平均年限达到一定水平；
2.可疑交易监测人员能够及时、全面获取有关可疑主体的身份背景信息和关联交易情况，必要时从业务或客户部门（基层网点）获取补充信息，或收集外部信息，在全面考量的基础上作出合理判断；
3.可疑交易分析与报告及时性、准确性、有效性较高，具有较高的情报价值，无严重的遗漏或过度防御性报告的倾向。
4.针对重大、紧急案件线索，及时向当地人民银行报送重点可疑交易报告。
*/
--6.3.i.近一年内司法机关新增冻扣客户（不含已有冻扣客户新增轮候冻扣）中，已在近年内（不超过5年）被提交可疑交易报告的客户数量与占比
--1、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户
--2、2024年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且在2020-2024年被上报可疑案例的主客户
-- 10692
-- 413
SELECT  '6.3.i1 2024年被公安机关冻扣客户数'                   AS ind
       ,COUNT(DISTINCT t.cst_id) AS val
FROM SJXQ_SJ2025032536_CST_13 t
UNION ALL
SELECT  '6.3.i2 2024年被公安机关冻扣且近5年被上报可疑客户数' AS ind
       ,COUNT(DISTINCT A.PARTY_ID)
FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN edw.dim_hr_org_mng_org_tree_dd dd --机构树
ON a.app_org_id = dd.org_id --交易机构
AND dd.dt = '20241231' AND dd.brc_org_nm = '广东四会泰隆村镇银行'
INNER JOIN
(
	SELECT  r . *
	FROM SJXQ_SJ2025032536_CST_13 r
	WHERE r.rn = 1
) s
ON substr(a.PARTY_ID, 3) = s.cst_id
WHERE SUBSTR(A.APP_DT, 1, 10) >= '2020-01-01'
AND SUBSTR(A.APP_DT, 1, 10) <= '2024-12-31'
AND A.APP_STATE_CD = '5' 	--上报
AND A.CAST_TYPE = '2'   --案例类型:1:大额 2:可疑 		--可疑
AND A.DT = '20241231'
AND A.APP_ORG_ID IN (
    SELECT  B.ORGANKEY
    FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
    WHERE   B.report_organkey = 'C1406244000019'
    AND     B.DT = '20241231'
);
***梁俊杰_SJ2025051256_四会村行信贷准入分析.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_01 AS
SELECT  col_1  --序号
       ,col_2  --客户名称
       ,col_3  --客户号
       ,col_4  --合同登记流水号
       ,col_5  --合同金额
       ,col_6  --合同余额
       ,col_7  --管户机构号
       ,col_8  --管户人名称
       ,col_9  --产品名称
       ,col_10 --还本结息方式
       ,col_11 --发生类型
from lab_bigdata_dev.qbi_file_20250513_09_24_51_0
where pt<>''
;
-- 合同申请时预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_02 AS
SELECT t2.ctr_serno
	,t2.CST_ID                                   --客户号|C20
	,t2.CST_NM                                   --客户名称
    ,t2.grnt_mod_colc                            --担保方式集合
    ,t2.cpt_usg_rmk                              --资金用途备注
	,t3.USC_APLY_SERNO
	,t4.aply_acpt_no
	,t4.PRE_ASES_SERNO                           --预评估流水号|C32
	,c1.cd_val_dscr                              as 受理状态
	,t4.SYS_REG_TM                               --系统登记时间|C19
    ,t5.rul_set_rslt_nm 	--新预评估结果
from SJXQ_SJ2025051256_CST_01 				t1
INNER JOIN edw.DIM_BUS_LOAN_CTR_BSE_INF_DD 	t2
ON t1.col_4 = t2.ctr_serno
AND t2.DT = '@@{yyyyMMdd}'
left join edw.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD t3
ON t3.USC_APLY_SERNO = t2.REL_SERNO
and t3.DT = '@@{yyyyMMdd}'
left join EDW.DWD_BUS_LOAN_APLY_ACPT_INF_DD      t4 --申请受理信息
on t3.aply_acpt_no=t4.aply_acpt_no
and t4.dt='@@{yyyyMMdd}'
left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T5 ON T4.PRE_ASES_SERNO = T5.PRE_ASES_SERNO
LEFT JOIN    edw.dwd_code_library_dd    c1 --码值表
ON      t4.ACPT_STS_CD = c1.cd_val
AND     c1.dt = '@@{yyyyMMdd}'
AND     c1.tbl_nm = 'DWD_BUS_LOAN_APLY_ACPT_INF_DD'
;
--合同预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_02_1 AS
SELECT t2.ctr_serno
	,t2.CST_ID                                   --客户号|C20
	,t2.CST_NM                                   --客户名称
    ,t2.grnt_mod_colc                            --担保方式集合
    ,t2.cpt_usg_rmk                              --资金用途备注
	,t3.USC_APLY_SERNO
    ,t3.cst_id                                   as 预评估客户号
	,t3.PRE_ASES_SERNO                           --预评估流水号|C32
    ,t3.rul_set_no
    ,t3.rul_set_rslt_cd
    ,c1.cd_val_dscr 	as pre_ases_rslt --预评估结果
    ,t3.app_cst_rol_cd
    ,c2.cd_val_dscr     as 客户角色
	,t4.cst_id                                   as pre_cst_id
	,t4.mbrwr_cst_id                             --主借款人客户号|c20
from SJXQ_SJ2025051256_CST_01 				t1
INNER JOIN edw.DIM_BUS_LOAN_CTR_BSE_INF_DD 	t2
ON t1.col_4 = t2.ctr_serno
AND t2.DT = '@@{yyyyMMdd}'
left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd  t3   --授信关联预评估信息表
ON t3.USC_APLY_SERNO = t2.REL_SERNO
and t3.DT = '@@{yyyyMMdd}'
left join edw.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD     t4
on t3.PRE_ASES_SERNO=t4.PRE_ASES_SERNO
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd               c1
ON  t3.RUL_SET_RSLT_CD = c1.cd_val
AND c1.DT = '@@{yyyyMMdd}'
AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND c1.fld_nm = 'RUL_SET_RSLT_CD'
LEFT JOIN edw.dwd_code_library_dd               c2
ON  t3.app_cst_rol_cd = c2.cd_val
AND c2.DT = '@@{yyyyMMdd}'
AND c2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
;
-- 老信贷预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_02_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_02_2 AS
SELECT  bc.SERIALNO     AS 合同流水号
       ,bc.customerid   AS 客户编号
       ,bc.customername AS 客户名称
       ,bc.occurdate    AS 申请日
       ,A21.cd_val_dscr AS 预评估结果
FROM    edw.loan_business_contract bc --业务合同表 没权限
LEFT JOIN edw.dwd_bus_loan_pre_ases_rsl_dd     A2      --预评估最终结果信息
ON   bc.PREPARESERIALNO = A2.srl_nbr
AND  A2.dt = '20240719'
LEFT JOIN edw.dwd_code_library_dd     A21
ON   A2.pre_ases_rsl = A21.cd_val
AND   A21.fld_nm='PRE_ASES_RSL'
AND   A21.tbl_nm='DWD_BUS_LOAN_PRE_ASES_RSL_DD'
AND  A21.dt = '20240719'
INner join SJXQ_SJ2025051256_CST_01 t1
on bc.SERIALNO=t1.col_4
WHERE   bc.dt = '20240719'
;
--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_03 AS
SELECT  a.ctr_serno
       ,a.grnt_mod_colc
FROM
(
	SELECT  ctr_serno
	       ,grnt_mod_colc
	       ,grnt_mod_colc2
	FROM SJXQ_SJ2025051256_CST_02 LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.ctr_serno
         ,a.grnt_mod_colc
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025051256_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051256_CST_04 AS
SELECT  t1.col_1  as 序号
       ,t1.col_2  as 客户名称
       ,t1.col_3  as 客户号
       ,t1.col_4  as 合同登记流水号
       ,t1.col_5  as 合同金额
       ,t1.col_6  as 合同余额
       ,t1.col_7  as 管户机构号
       ,t1.col_8  as 管户人名称
       ,t1.col_9  as 产品名称
       ,t1.col_10 as 还本结息方式
       ,t1.col_11 as 发生类型
       ,decode(t4.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') as 客群标签
       ,t3.grnt_mod_nm     AS 担保方式集合
       ,t2.cpt_usg_rmk     AS 资金用途备注
       ,t7.pre_ases_rslt   AS 合同预评估结果
       ,c1.cd_val_dscr     AS 户籍地址行政区划
       ,t5.age             AS 年龄
       ,c2.cd_val_dscr     as 婚姻状况
       ,t5.anl_inc         AS 年收入
       ,c3.cd_val_dscr	   as 居住情况
from SJXQ_SJ2025051256_CST_01   t1
left join SJXQ_SJ2025051256_CST_02 t2 on t1.col_4=t2.ctr_serno
left join SJXQ_SJ2025051256_CST_03 t3 on t1.col_4=t3.ctr_serno
left join adm_pub.adm_csm_clab_cst_jc_inf_dd t4 --客户标签信息
ON T1.col_3=T4.CST_ID
AND T4.DT='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t5   --客户集市-客户基础-对私客户基础信息
on t1.col_3=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_ctc_addr                 t6
ON t1.col_3 = t6.cst_id
AND t6.dt = '@@{yyyyMMdd}' and t6.del_ind='0' 	--未删除
AND t6.addr_typ = '050100' --户籍地址
left join   edw.dwd_code_library_dd     c1 -- 码值表
ON  substr(t6.adiv,1,6) = c1.cd_val
AND c1.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND c1.fld_nm = 'AREA_OR_CNR_DTRCT_DVD_CD'     --区县
AND c1.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd       c2
ON t5.MRG_SITU_CD = c2.CD_VAL
AND c2.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND c2.FLD_NM = 'MRG_SITU_CD'
AND c2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd    c3 --码值表
ON      t5.rsd_situ_cd = c3.cd_val
AND     c3.dt = '@@{yyyyMMdd}'
AND     c3.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
left join(
    SELECT  ctr_serno
    from SJXQ_SJ2025051256_CST_02_1
    where nvl(mbrwr_cst_id,'')<>''
    GROUP BY ctr_serno
)t7 on t1.col_4=t7.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct col_4) custs
from SJXQ_SJ2025051256_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051256_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051256_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同登记流水号) custs
from SJXQ_SJ2025051256_CST_04
;
/*
01	900	900
02	900	900
03	900	900
04	900	900
dwd_bus_loan_lmt_aply_rel_ases_dd	授信关联预评估信息表 用信申请流水号\预评估流水号 一个合同对应多个共同借款人，每个人都有预评估结果
DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD	预评估业务申请  客户号、预评估流水号、客户号、预评估时间 sys_reg_tm
DIM_BUS_LOAN_PRE_ASES_RSLT_INF_DD	预评估结果信息  预评估结果流水号 预评估流水号 客户号
DIM_BUS_LOAN_PRE_ASES_REL_INF_DD	预评估关联信息  预评估结果流水号
DWD_BUS_LOAN_pre_ases_rul_dtl_DD	预评估规则明细  预评估结果流水号、预评估触发规则、预评估提示信息
DIM_BUS_LOAN_pre_ases_rul_set_rel_DD	预评估规则集关系 预评估流水号 关联出结果
*/
SElECT '04' seq, *
from SJXQ_SJ2025051256_CST_04
;
***梁燕_SJ20250102286_旬阳村行审批数据.sql
﻿/*
截止2024年12月31日，旬阳村行审批数据
1.团队总、支行长、市场部老总、副行长、行长授权范围内审批的业务笔数、金额（分敞口、额度）
2.剔除利率因素后各层级授权范围内审批的业务笔数、金额（分敞口、额度）
3.消费性贷款、卡业务的审批量
人员清单详见附件
*/
-- 人员清单
DROP   TABLE IF EXISTS SJXQ_SJ20250102286_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250102286_CST_01
(
     empe_id    string COMMENT '工号'
    ,empe_nm    string COMMENT '姓名'
    ,pos_nm     string COMMENT '职位'
)
;
insert into SJXQ_SJ20250102286_CST_01
;
-- 最终审批人
DROP   TABLE IF     EXISTS SJXQ_SJ20250102286_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102286_CST_02 as
select t1.ctr_srl_no                             --合同流水号
	,t1.mng_empe_id                              --管户人工号
	,t1.mng_org_id                               --管户机构号
	,t1.cst_nm                                   --客户名称
	,t1.cst_id                                   --核心客户编号
	,t1.dbil_bal_cny                             --余额
	,t1.grant_amt                                --发放金额
	,t1.apl_srl_no                               --申请流水号
	,t1.opr_empe_id                              --经办客户经理
	,t1.opr_dept_lead_empe_id                    --经办部门负责人
	,t1.opr_sub_brch_prsd_empe_id                --经办支行行长
	,t1.rvw_empe_id                              --经办审查人
	,t1.final_aprv_empe_id                       --最终审批人
	,t1.hpn_typ_cd                               --发生类型
	,t1.ctr_start_dt                             --合同生效日期
	,t1.ctr_mtu_dt                               --合同到期日期
	,t1.pd_typ                                   --产品类型 随贷通、垫款、分期贷款、非分期贷款、信用卡
    ,t2.empe_id
from adm_rsk.adm_rsk_apl_inter_all      t1 --风险集市应用表-资产质量日常监测源表
inner join SJXQ_SJ20250102286_CST_01    t2
on substr(t1.final_aprv_empe_id,1,6)=t2.empe_id
where t1.dt='20241231'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250102286_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102286_CST_03 as
select t1.ctr_srl_no
	,t2.cst_id                                   --客户号|C20
	,t2.cst_nm                                   --客户名称|C200
    ,t2.prd_no
    ,t3.PD_NM
    ,case when t3.PD_NM regexp '随贷通' then'是' else '' end is_sdt
    ,case when (t2.prd_no LIKE '200101%' OR ( t2.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t2.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
	,t2.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t2.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t2.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t2.exec_intr_rat	                         --执行利率
from(
    select distinct ctr_srl_no
    from SJXQ_SJ20250102286_CST_02
)t1 inner join edw.dim_bus_loan_ctr_bse_inf_dd        t2 --合同基础信息
on t1.ctr_srl_no=t2.ctr_serno
and t2.dt='20241231'
left join edw.dim_bus_loan_prd_frml_dd      t3
on t2.prd_no=t3.prd_no
and t3.dt='20240930'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250102286_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102286_CST_04 as
SELECT  t1.ctr_srl_no    AS 合同流水号
       ,t1.cst_id        AS 客户号
       ,t1.cst_nm        AS 客户名称
       ,T1.PD_NM         AS 业务品种
       ,T1.is_sdt        AS 是否随贷通
       ,T1.is_xfd        AS 是否消费性贷款
       ,t1.ctr_amt       AS 合同金额
       ,t1.ctr_epsr_amt  AS 合同敞口金额
       ,t1.ctr_bal       AS 合同余额
       ,t1.exec_intr_rat AS 执行利率
       ,t3.empe_id       AS 工号
       ,t3.empe_nm       AS 姓名
       ,t3.pos_nm        AS 职位
from SJXQ_SJ20250102286_CST_03      t1
left join(
    select ctr_srl_no,empe_id
    from SJXQ_SJ20250102286_CST_02
    group by ctr_srl_no,empe_id
)t2 on t1.ctr_srl_no=t2.ctr_srl_no
left join SJXQ_SJ20250102286_CST_01 t3
on t2.empe_id=t3.empe_id
;
***江慧芳_SJ2025051541_信贷流失客户挽回.sql
/*
衢州分行历史信贷流失客户共计43335户客户，申请按照客户经营地址为主地址，回归到对应的子社区，并将主管护权回归到社区的主维护人（同步回归信贷管护权）
若无经营地址则按照 经营＞居住＞户籍的地址顺序分配子社区。
*/
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025051541_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051541_CST_01 AS
SELECT  col_1  --序号
       ,col_2  --客户号
       ,col_3  --客户名称
       ,col_4  --主管户机构号
       ,col_5  --主管户机构名称
from lab_bigdata_dev.qbi_file_20250519_15_20_30_0
where pt<>''
;
--地址
DROP   TABLE IF     EXISTS SJXQ_SJ2025051541_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051541_CST_02 AS
SELECT  t1.cst_id
    ,t2.dtl_addr        AS 信贷经营地址
    ,concat(t23.area_name,t22.area_name,t21.area_name,t24.area_name,t2.dtl_addr)    as 完整经营地址
    ,t3.dtl_addr        AS 信贷户籍地址
    ,concat(t33.area_name,t32.area_name,t31.area_name,t34.area_name,t3.dtl_addr)    as 完整户籍地址
    ,t4.dtl_addr        AS 信贷居住地址
    ,concat(t43.area_name,t42.area_name,t41.area_name,t44.area_name,t4.dtl_addr)    as 完整居住地址
    ,case when nvl(t2.dtl_addr,'')<>'' then concat(t23.area_name,t22.area_name,t21.area_name,t24.area_name,t2.dtl_addr)
        when nvl(t4.dtl_addr,'')<>'' then concat(t43.area_name,t42.area_name,t41.area_name,t44.area_name,t4.dtl_addr)
        when nvl(t3.dtl_addr,'')<>'' then concat(t33.area_name,t32.area_name,t31.area_name,t34.area_name,t3.dtl_addr)
        else '' end as 经营居住户籍顺序地址
from(
    select distinct col_2 as cst_id
    from SJXQ_SJ2025051541_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '@@{yyyyMMdd}' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
left join edw.loan_admin_sm_area t21
ON      concat(substr(t2.adiv, 1, 6), '000000') = t21.area_code and t21.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t22
ON      concat(substr(t2.adiv, 1, 4), '00000000') = t22.area_code and t22.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t23
ON      concat(substr(t2.adiv, 1, 2), '0000000000') = t23.area_code and t23.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t24
ON     t2.adiv = t24.area_code   and t24.dt='@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '@@{yyyyMMdd}' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
left join edw.loan_admin_sm_area t31
ON      concat(substr(t3.adiv, 1, 6), '000000') = t31.area_code and t31.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t32
ON      concat(substr(t3.adiv, 1, 4), '00000000') = t32.area_code and t32.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t33
ON      concat(substr(t3.adiv, 1, 2), '0000000000') = t33.area_code and t33.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t34
ON     t3.adiv = t34.area_code   and t34.dt='@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '@@{yyyyMMdd}' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --居住地址
left join edw.loan_admin_sm_area t41
ON      concat(substr(t4.adiv, 1, 6), '000000') = t41.area_code and t41.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t42
ON      concat(substr(t4.adiv, 1, 4), '00000000') = t42.area_code and t42.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t43
ON      concat(substr(t4.adiv, 1, 2), '0000000000') = t43.area_code and t43.dt='@@{yyyyMMdd}'
left join edw.loan_admin_sm_area t44
ON     t4.adiv = t44.area_code   and t44.dt='@@{yyyyMMdd}'
;
-- 结果表
DROP   TABLE IF     EXISTS SJXQ_SJ2025051541_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051541_CST_03 AS
SELECT  t1.col_1      AS 序号
       ,t1.col_2      AS 客户号
       ,t1.col_3      AS 客户名称
       ,t1.col_4      AS 主管户机构号
       ,t1.col_5      AS 主管户机构名称
       ,t3.prm_mgr_id AS 主管护客户经理工号
       ,t3.prm_mgr_nm AS 主管护客户经理姓名
       ,t3.ln_mgr_id  AS 信贷归属客户经理
       ,t3.ln_mgr_nm  AS 信贷归属客户经理名称
       ,t4.当前存款管护人
       ,t2.完整经营地址
       ,t2.完整户籍地址
       ,t2.完整居住地址
       ,t2.经营居住户籍顺序地址
from SJXQ_SJ2025051541_CST_01       t1
left join SJXQ_SJ2025051541_CST_02  t2
on t1.col_2=t2.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd t3 --客户集市-客户基础-客户管户信息
on t1.col_2=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join(
    select t1.cst_id
    from edw.dwd_bus_dep_cst_act_mgr_inf_dd t1 --客户存款账户管护信息
    left join edw.dws_hr_empe_inf_dd        t2 --员工信息汇总
    on  t1.mgr_id=t2.empe_id
    and t2.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    group by t1.cst_id
)t4 on t1.col_2=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2025051541_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051541_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025051541_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025051541_CST_03
***江长征_SJ2025020736_上海分行个体工商户信息.sql
﻿
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST1_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST1_01 AS
SELECT  t1.sub_brn_org_id                          AS 支行机构编号
       ,t1.sub_brn_org_nm                          AS 支行机构名称
       ,t1.cst_id                                  AS 客户号
       ,t1.cst_nm                                  AS 客户名称
       ,decode(t2.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t1.prm_mgr_id                              AS 主管户客户经理
       ,t1.prm_mgr_nm                              AS 主管户客户经理名称
       ,t1.prm_org_id                              AS 主管户机构
       ,t1.prm_org_nm                              AS 主管户机构名称
       ,''                                         AS 所属子社区
       ,t1.job_unt_nm                              AS 单位名称
       ,t3.job_unt_afl_idt                         AS 工作单位所属行业代码
       ,c1.cd_val_dscr                             as 工作单位所属行业
       ,t1.ln_mgr_id                               AS 信贷归属客户经理
       ,t1.ln_mgr_nm                               AS 信贷归属客户经理名称
       ,t1.ln_org_id                               AS 信贷归属机构
       ,t1.ln_org_nm                               AS 信贷归属机构名称
       ,t1.vld_cst_ind                             AS 有效户标识
       ,t1.vld_dep_cst_ind                         AS 有效存款户标识
       ,t1.vld_ln_cst_ind                          AS 有效贷款户标识
       ,t1.vld_chm_cst_ind                         AS 有效理财户标识
       ,t1.dep_mon_avg_bal                         AS 存款月日均
       ,t1.dep_bal_mon_avg                         AS 存款余额月日均
       ,t1.dep_bal                                 AS 各项存款余额
       ,t1.chm_bal                                 AS 理财余额
       ,t1.loan_bal_all                            AS 行内贷款余额_主办行
       ,t1.all_loan_bal                            AS 所有银行余额_主办行
       ,t1.own_all_loan_bal_pct                    AS 我行贷款余额占比_主办行
       ,t1.ln_mon_avg_bal                          AS 本行贷款当月月日均
       ,t1.vld_pd_cnt                              AS 有效产品持有数
       ,t1.com_sub_cmnt_cd                         AS 普惠子社区编号
       ,t1.com_sub_cmnt_nm                         AS 普惠子社区名称
       ,t1.entp_sub_cmnt_cd                        AS 小企业子社区编号
       ,t1.entp_sub_cmnt_nm                        AS 小企业子社区名称
       ,t1.only_crd_ind                            AS 是否仅持有信用卡客户
       ,t1.efe_wlth_cst_ind                        AS 有效财富户标识
       ,t1.is_exis_loan_cst                        AS 是否有贷户
       ,t1.cprh_contri_12m                         AS 近1年客户价值
       ,t1.cprh_contri_cur_qtr                     AS 当季客户价值
       ,t1.cprh_contri_cur_mon                     AS 当月客户价值
       ,t1.com_synthetical_no                      AS 普惠综合社区编号
       ,t1.com_synthetical_nm                      AS 普惠综合社区名称
       ,t1.com_synthetical_forum_no                AS 普惠综合社区板块编号
       ,t1.com_synthetical_forum_nm                AS 普惠综合社区板块名称
       ,t1.corp_efe_inter_stl_cst_ind              AS 国际业务有效户
       ,t1.cr_crd_vld_cst_ind                      AS 信用卡有效户标识
from app_ado.adm_subl_cst_bus_inf_dd    t1 --实验室应用层资产-客户业务信息汇总表
left join edw.dws_cst_bas_inf_dd        t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join edw.dws_cst_idv_bas_inf_dd	t3 --个人客户基本信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join EDW.DWD_CODE_LIBRARY_DD       c1
on t3.job_unt_afl_idt=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
inner join(
            SELECT  distinct A.cst_id
            FROM    adm_ind.ADM_IND_L_CO_FTR_CSTGRP_DD A --个体户
            inner JOIN    adm_pub.adm_csm_cbas_ind_inf_dd C --有效户
            ON      A.cst_id = C.cst_id
            AND     C.DT = '20241231'
            and      C.efe_cst_ind='1' --有效户标签
            WHERE   a.gld_indiv_bsn <> '0'
            AND     A.DT = '20241231'
)t4 on t1.cst_id=t4.cst_id
where t1.dt='20241231'
and t1.brn_org_nm ='上海分行'
-- and t1.vld_cst_ind='1' --有效户标识
-- and t1.cst_seg_flg='个体工商户'
;
SElECT '01' seq, *
from SJXQ_SJ2025020631_CST1_01
;
-- 01	7306	7306
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025020631_CST1_01
;
***江长征_SJ2025020736_上海分行个体工商户信息2.sql
-- 上海分行截至2024年12月31日存量的所有为有效户的个体工商户信息，包括以下字段
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST2_01 AS
SELECT  t1.cst_id
    ,t1.efe_cst_ind                AS 有效户标识
    ,t1.efe_dep_cst_ind            AS 有效存款户标识
    ,t1.efe_loan_cst_ind           AS 有效贷款户标识
    ,t1.efe_chm_cst_ind            AS 有效理财户标识
    ,t1.efe_wlth_cst_ind           AS 有效财富户标识
    ,t1.corp_efe_inter_stl_cst_ind AS 国际业务有效户
    ,t2.cst_seg_flg
    ,decode(t2.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户'
        ,'5','工薪族','6','退休养老','7','持家女性','未知') as cst_seg_flg_nm
    ,t3.ind_bus_ind     --个体工商户标志
    ,t4.cst_chn_nm      --客户中文名称|C200
    ,t4.ind_bus_ind     --个体工商户标志|C1
    ,t4.job_unt_nm      --工作单位名称|C200
    ,t4.job_unt_afl_idt --工作单位所属行业|C5
    ,t5.cst_typ_cd      --客户类型|C1
    ,decode(t5.CST_TYP_CD,'1','对私','2','对公','') AS CST_TYP_nm --客户类型
    ,t6.prm_mgr_id,t6.prm_mgr_nm,t6.prm_org_id
    ,t7.brc_org_nm,t7.sbr_org_nm,t7.tem_org_nm,t7.org_nm
    ,t1.dt
from adm_pub.adm_csm_cbas_ind_inf_dd            t1 --客户集市-基础信息-客户基础标识信息
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t2 --客户标签信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t3 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join edw.dws_cst_idv_bas_inf_dd	        t4 --个人客户基本信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt=t1.dt
left join edw.dws_cst_bas_inf_dd 				t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t6 --客户`主管户`信息
on  t1.cst_id = t6.cst_id
and t6.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.prm_org_id = t7.org_id
and t7.dt = '20241231'
and t7.brc_org_nm='上海分行'
where t1.dt='20241231'
and t1.efe_cst_ind='1'  --有效户标识
and t2.cst_seg_flg='2'  --个体工商户
;
--
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST2_02 AS
select t1.cst_id
	,t2.dep_bal_mon_avg                          --存款余额月日均
	,t2.dep_bal                                  --存款余额
	,t2.dmnd_dep_bal                             --活期存款余额
	,t2.advs_dep_bal                             --通知存款余额
	,t2.tm_dep_bal                               --定期存款余额
	,t2.ntm_dep_bal                              --不定期存款余额
	,t2.mrgn_dep_bal                             --保证金存款余额
	,t2.agr_dep_bal                              --协议存款余额
	,t2.chm_dep_bal                              --理财存款余额
	,t2.strc_dep_bal                             --结构性存款余额
	,t5.mgr_id                                   --管户人工号|c10
    ,c1.empe_nm     as loan_mgr_nm
	,t5.mgr_org_id                               --管户机构号|c12
    ,c2.org_nm      as loan_org_nm
    ,t6.sub_cmnt_id           as 普惠子社区编号
    ,t7.cmnt_nm               as 普惠子社区名称
from SJXQ_SJ2025020631_CST2_01               t1
left join adm_pub.adm_csm_cbus_dep_inf_dd   t2 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_mng_loan_mgr_dd       t5 --信贷客户管户信息
on t1.cst_id=t5.cst_id
and t5.dt = '20241231'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20241231'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd    t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20241231'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t5.mgr_id=c1.empe_id
and c1.dt='20241231'
left join edw.dim_hr_org_mng_org_tree_dd    c2 --考核机构树
on  t5.mgr_org_id=c2.org_id
and c2.dt='20241231'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020631_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020631_CST2_03 AS
SELECT  t1.cst_id
       ,t2.chm_bal                  AS 理财产品余额
       ,t3.loan_bal_acs             AS 贷款余额
       ,t3.loan_bal_acs_mon_avg     AS 贷款余额月日均
       ,t4.vld_pd_cnt               AS 有效产品持有数
       ,t4.only_crd_ind             AS 是否仅持有信用卡客户
       ,t4.is_exis_loan_cst         AS 是否有贷户
       ,t4.cr_crd_vld_cst_ind       AS 信用卡有效户标识
       ,t4.com_synthetical_no       AS 普惠综合社区编号
       ,t4.com_synthetical_nm       AS 普惠综合社区名称
       ,t4.com_synthetical_forum_no AS 普惠综合社区板块编号
       ,t4.com_synthetical_forum_nm AS 普惠综合社区板块名称
       ,t4.cprh_contri_12m          AS 近1年客户价值
       ,t4.cprh_contri_cur_qtr      AS 当季客户价值
       ,t4.cprh_contri_cur_mon      AS 当月客户价值
       ,t6.sub_cmnt_id              AS 小企业子社区编号
       ,t7.cmnt_nm                  AS 小企业子社区名称
from SJXQ_SJ2025020631_CST2_01               t1
left join adm_pub.adm_csm_cbus_chm_inf_dd	t2 --客户集市-业务信息-客户理财业务信息表
on t1.cst_id=t2.cst_id
and t2.dt='20241231'
left join adm_pub.adm_csm_cbus_loan_inf_dd 	t3 --贷款业务信息
on t1.cst_id=t3.cst_id
and t3.dt='20241231'
left join app_ado.adm_subl_cst_bus_inf_dd	t4 --实验室应用层资产-客户业务信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20241231'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20241231'
AND     t6.dpd_typ_cd = '2' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20241231'
;
select count(distinct t1.cst_id) cnt
from adm_pub.adm_csm_cbas_ind_inf_dd            t1 --客户集市-基础信息-客户基础标识信息
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t2 --客户标签信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t6 --客户`主管户`信息
on  t1.cst_id = t6.cst_id
and t6.dt = '20241231'
inner join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.prm_org_id = t7.org_id
and t7.dt = '20241231'
and t7.brc_org_nm='上海分行'
where t1.dt='20241231'
and t1.efe_cst_ind='1'  --有效户标识
and t2.cst_seg_flg='2'  --个体工商户
***汪雅清_SJ20250701176_对外介绍材料.sql
﻿-- 汪雅清_SJ20250701176_对外介绍材料
/*
1.泰隆银行1993年以来服务过的正式客户数（1993年至2025年6月30日，产生过业务的客户，也包括有过业务但退出的）
2.截至2025年6月30日，我行200万元以下贷款余额、200万元以下贷款占比（200万元以下贷款户数/全量贷款余额）、200万元以下贷款户数、200万元以下户数占比（200万元以下贷款户数/全量贷款户数）
以后每个月都需要200万元以下贷款余额及占比、户数及占比，能否每月都帮忙取该组数据
口径：
数据1：口径为在我行开过户、有客户号的正式客户（含对公+对私）
数据2：分子分母的口径均为全部贷款，且合同未结清、未终结或合同余额>0
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250701176_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250701176_CST_01 AS
select t1.cst_id,t1.opn_dt
    ,t2.max_form_dt
    ,t4.brc_org_nm
    ,case when t4.brc_org_nm regexp '村镇银行' then 1 else 0 end as is_cun_bnk
from(
    select cst_id,min(opn_dt) as opn_dt
    from edw.dim_bus_dep_act_inf_dd  --存款账户信息
    where dt='20250630'
    and opn_dt>='19930101'  --1993年以来
    GROUP BY cst_id
)t1 left join(
    SELECT cst_id,max(dt) as max_form_dt
    from adm_pub.adm_csm_cbas_mng_inf_dd t1  --客户集市-客户基础-客户管户信息
    where dt<='20250630'
    and forml_cst_ind ='1'                           --正式客户标识 8829537
    GROUP BY cst_id
) t2 on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250630'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250630'
;
-- 01	8802848	8802848
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250701176_CST_01
;
select '需求1' ind,count(cst_id)  as 1993年以来开户客户数
    ,count(max_form_dt)  as 1993年以来开户历史为正式客户数
    ,count(case when is_cun_bnk=0 then max_form_dt end)  as 1993年以来开户历史为正式客户数_不含村行
    ,count(case when max_form_dt='20250630' then cst_id end)  as 1993年以来开户当前为正式客户数
from SJXQ_SJ20250701176_CST_01
;
-- 贷款余额
DROP   TABLE IF     EXISTS SJXQ_SJ20250701176_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250701176_CST_02 AS
select t1.*
    ,case when t4.brc_org_nm regexp '村镇银行' then 1 else 0 end as is_cun_bnk
from(
    select t1.cst_id                                   --客户号|C20
        ,sum(t1.ctr_bal) as ctr_bal                    --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250630'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by t1.cst_id
)t1 left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250630'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250630'
;
select round(sum(case when ctr_bal<2000000 then ctr_bal else 0 end)/10000,4) as 200万元以下贷款余额_万
    ,round(sum(case when ctr_bal<2000000 then ctr_bal else 0 end)/sum(ctr_bal),4) as 200万元以下贷款余额占比
    ,count(case when ctr_bal<2000000 then cst_id end) as 200万元以下贷款户数
    ,round(count(case when ctr_bal<2000000 then cst_id end)/count(cst_id),4) as 200万元以下贷款户数占比
from SJXQ_SJ20250701176_CST_02
;
-- 200万元以下贷款余额_万	200万元以下贷款余额占比	200万元以下贷款户数	200万元以下贷款户数占比
-- 14952237.1322	0.3692	668702	0.9352
select round(sum(case when ctr_bal<2000000 then ctr_bal else 0 end)/10000,4) as 200万元以下贷款余额_万_不含村行
    ,round(sum(case when ctr_bal<2000000 then ctr_bal else 0 end)/sum(ctr_bal),4) as 200万元以下贷款余额占比_不含村行
    ,count(case when ctr_bal<2000000 then cst_id end) as 200万元以下贷款户数_不含村行
    ,round(count(case when ctr_bal<2000000 then cst_id end)/count(cst_id),4) as 200万元以下贷款户数占比_不含村行
from SJXQ_SJ20250701176_CST_02
where is_cun_bnk=0
;
***沈红璐_SJ2025080486_维艺口腔客户清单.sql
﻿-- 沈红璐_SJ2025080486_维艺口腔客户清单
-- 舟山维艺口腔门诊部有限公司 浙江省,舟山市,定海区
-- 截止2025年7月31日，舟山分行全量维艺口腔单位信贷业务客户清单。
/*
要求1：客户工作单位、居住地址等有&ldquo;维艺&rdquo;、&ldquo;口腔&rdquo;等字眼。
要求2：区分结清业务、当前授信业务。如为泰e贷客户，标注进件方式。
要求3：标注业务的经办人、管护人、审查人、审批人。
要求4：标注风险客户等级、风险隐患、是否触犯精准贷后等标识。
要求5：标注是否为代发工资客户。
要求6：清单内标注客户的户籍地址、居住地址和工作单位。
select apl_methon                               --进件方式
	,cst_id                                   --客户号
	,cst_nm                                   --客户名称
	,orig_ctr_srl_nbr                         --合同流水号
from app_ado.fct_zzqs_ted_apl_list            --泰e贷进件清单
where dt='20250731'
;
*/
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025080486_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080486_CST_01 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t1.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t1.fml_adr                                  --家庭地址|C256
    ,t2.job_unt_nm                               --工作单位名称|C200
from edw.dws_cst_bas_inf_dd             t1 --客户基础信息汇总表
left join edw.dim_cst_idv_bas_inf_dd    t2 --个人客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '舟山分行'
where t1.dt='20250731'
and (concat(t1.reg_adr,t1.wrk_adr,t1.fml_adr) regexp '维艺|口腔'
    or t2.job_unt_nm regexp '维艺|口腔')
;
DROP   TABLE IF EXISTS SJXQ_SJ2025080486_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2025080486_CST_02
(
    ACG_DT                  STRING  COMMENT '数据日期'
    ,CST_ID                 STRING  COMMENT '客户号'
    ,CST_NM                 STRING  COMMENT '客户名称'
    ,ctr_serno              STRING  COMMENT '信贷合同流水号'
    ,PD_CD                  STRING  COMMENT '产品编号'
    ,BUS_CD                 STRING  COMMENT '业务标识'
    ,BUS_LAB_CD             STRING  COMMENT '营销标签代码'
    ,CCY_CD                 STRING  COMMENT '币种'
    ,CTR_AMT                DECIMAL COMMENT '合同金额'
    ,CTR_BAL                DECIMAL COMMENT '合同余额'
    ,CTR_AMT_CNY            DECIMAL COMMENT '合同金额折人民币'
    ,CTR_BAL_CNY            DECIMAL COMMENT '合同余额折人民币'
    ,INTR_RAT               DECIMAL COMMENT '执行月利率'
    ,HPN_DT                 STRING  COMMENT '发生日期'
    ,HPN_TYP_CD             STRING  COMMENT '发生类型'
    ,APNT_MTU_DT            STRING  COMMENT '到期日期'
    ,CRC_IND                STRING  COMMENT '循环贷款方式'
    ,IS_SLF_CRC             STRING  COMMENT '是否自助'
    ,CYC_TYP_CD             STRING  COMMENT '自助循环类型代码'
    ,MAIN_GRNT_MTH_CD       STRING  COMMENT '主要担保方式代码'
    ,PRM_ORG_ID             STRING  COMMENT '管户机构号'
    ,PRM_ORG_NM             STRING  COMMENT '管户机构名称'
    ,PRM_MGR_ID             STRING  COMMENT '管户客户经理工号'
    ,PRM_MGR_NM             STRING  COMMENT '管户客户经理名称'
    ,APNT_START_DT          STRING  COMMENT '合同起始日'
    ,END_DT                 STRING  COMMENT '终结日期'
    ,LOAN_BAL_ACS_YEAR_AVG  DECIMAL COMMENT '贷款年日均'
    ,CST_AMT                DECIMAL COMMENT '客户合同总金额'
    ,CST_AMT_CNY            DECIMAL COMMENT '客户合同总金额折人民币'
    ,LOAN_USG_CD            STRING  COMMENT '贷款用途代码'
    ,FRZ_STS_CD             STRING  COMMENT '冻结状态代码'
    ,SUB_CMNT_ID            STRING  COMMENT '子社区编号'
    ,SUB_CMNT_NM            STRING  COMMENT '子社区名称'
    ,CST_AMT_CNY_LM         DECIMAL COMMENT '客户合同总金额折人民币（上月）'
    ,IF_CSM_LOAN_ID         STRING  COMMENT '消费贷款标识'
    ,AST_POOL_IND           STRING  COMMENT '资产池标识'
    ,COOP_FACL              STRING  COMMENT '合作方授信'
    ,ACTL_START_USE_CRD_LMT DECIMAL COMMENT '启用额度'
    ,BUS_LAB_NM             STRING  COMMENT '营销标签名称'
    ,REG_TYP_NM             STRING  COMMENT '登记类型'
    ,PRD_USG_MARK           STRING  COMMENT '产品标识用途'
    ,SPCL_CPT_SRC_NM        STRING  COMMENT '专项资金来源'
    ,DIF_PLC_BSN_IND        STRING  COMMENT '是否异地'
    ,LMT_PD_IND             STRING  COMMENT '是否框架下子合同'
    ,rel_serno              STRING  COMMENT '申请流水号'
    ,hdl_opr_id             STRING  COMMENT '经办人工号'
    ,hdl_opr_NM             STRING  COMMENT '经办人名称'
    ,bsn_typ_nm             STRING  COMMENT '业务类型'
) COMMENT '普惠金融-小额贷款业务清单-临时表'
;
-- 客户合同信息
INSERT INTO SJXQ_SJ2025080486_CST_02
SELECT  '@@{yyyy-MM-dd}'                                                                           AS ACG_DT
       ,T.CST_ID                                                                                   AS CST_ID
       ,T.CST_NM                                                                                   AS CST_NM
       ,T.CTR_SERNO                                                                                AS ctr_serno --信贷改造 BUSI_CTR_ID 换成 CTR_SERNO
       ,T.PRD_NO                                                                                   AS PD_CD --信贷改造 PD_CD 换成 PRD_NO
       ,T.BSN_MARK_CD                                                                              AS BUS_CD --信贷改造 BUS_CD 换成 BSN_MARK_CD
       ,T.PRD_TAG                                                                                  AS BUS_LAB_CD --信贷改造 BUS_LAB_CD 换成 PRD_TAG
       ,T.BSN_CCY_CD                                                                               AS CCY_CD --信贷改造 CCY_CD 换成 BSN_CCY_CD
       ,T.CTR_AMT                                                                                  AS CTR_AMT
       ,T.CTR_BAL                                                                                  AS CTR_BAL
       ,T.CTR_AMT * COALESCE(T9.AVG_PRC,100) / COALESCE(T9.QUO_UNT,100)                            AS CTR_AMT_CNY
       ,T.CTR_BAL * COALESCE(T9.AVG_PRC,100) / COALESCE(T9.QUO_UNT,100)                            AS CTR_BAL_CNY
       ,T.EXEC_INTR_RAT                                                                            AS INTR_RAT --信贷改造 INTR_RAT 换成 EXEC_INTR_RAT
       ,CONCAT(SUBSTR(T.ctr_Bgn_Dt,1,4),'-',SUBSTR(T.ctr_Bgn_Dt,5,2),'-',SUBSTR(T.ctr_Bgn_Dt,7,2)) AS HPN_DT --信贷改造 字段废弃 3890215
       ,T.HPN_TYP_CD                                                                               AS HPN_TYP_CD --信贷改造 HPN_TYP_CD 换成 HPN_TYP_CD
       ,CONCAT(SUBSTR(T.CTR_MTU_DT,1,4),'-',SUBSTR(T.CTR_MTU_DT,5,2),'-',SUBSTR(T.CTR_MTU_DT,7,2)) AS APNT_MTU_DT --信贷改造 APNT_MTU_DT 换成 CTR_MTU_DT
       ,CASE WHEN T.RVLG_TYP_CD IN ( '1' ,'2' ) THEN '1'  ELSE '0' END                             AS CRC_IND --信贷改造 CRC_IND 换成 RVLG_TYP_CD
       ,CASE WHEN T.RVLG_TYP_CD IN ( '1' ,'2' ) THEN '1'  ELSE '0' END                             AS IS_SLF_CRC --信贷改造 IS_SLF_CRC 换成 RVLG_TYP_CD 1自助循环, 2半自助循环
       ,T.RVLG_TYP_CD                                                                              AS CYC_TYP_CD --自助循环类型代码 信贷改造 CYC_TYP_CD 换成 RVLG_TYP_CD
       ,T.GRNT_MOD_COLC                                                                            AS MAIN_GRNT_MTH_CD --信贷改造 MAIN_GRNT_MTH_CD 换成 GRNT_MOD_COLC 担保方式发生变化，新信贷是担保方式集合形式
       ,COALESCE(T10.PRM_ORG_ID,'')                                                                AS PRM_ORG_ID
       ,COALESCE(T10.PRM_ORG_NM,'')                                                                AS PRM_ORG_NM
       ,COALESCE(T10.PRM_MGR_ID,'')                                                                AS PRM_MGR_ID
       ,COALESCE(T10.PRM_MGR_NM,'')                                                                AS PRM_MGR_NM
       ,CONCAT(SUBSTR(T.CTR_BGN_DT,1,4),'-',SUBSTR(T.CTR_BGN_DT,5,2),'-',SUBSTR(T.CTR_BGN_DT,7,2)) AS APNT_START_DT --信贷改造 APNT_START_DT 换成 CTR_BGN_DT
       ,CONCAT(SUBSTR(T.TMT_DT,1,4),'-',SUBSTR(T.TMT_DT,5,2),'-',SUBSTR(T.TMT_DT,7,2))             AS END_DT --信贷改造 END_DT 换成 TMT_DT
       ,COALESCE(T6.LOAN_BAL_ACS_YEAR_AVG,0)                                                       AS LOAN_BAL_ACS_YEAR_AVG
       ,COALESCE(T1.CST_AMT,0)                                                                     AS CST_AMT -- 客户合同总金额
       ,COALESCE(T1.CST_AMT_CNY,0)                                                                 AS CST_AMT_CNY -- 客户合同总金额折人民币
       ,T.CPT_USG_CD --信贷改造 LOAN_USG_CD 换成 CPT_USG_CD
       ,T.CTR_STS_CD --信贷改造 FRZ_STS_CD 换成 CTR_STS_CD
       ,COALESCE(T7.SUB_CMNT_ID,'')
       ,COALESCE(T8.CMNT_NM,'')
       ,COALESCE(T2.CST_AMT_CNY,0) -- 客户合同总金额折人民币（上月）
       ,CASE WHEN T.PRD_NO LIKE '200101%' THEN '1' --信贷改造 PD_CD 换成 PRD_NO，LOAN_USG_CD 换成 CPT_USG_CD
             ELSE '0' END                                                                          AS IF_CSM_LOAN_ID --消费贷款标识
       ,T.AST_POOL_IND
       ,CASE WHEN T12.CTR_SERNO IS NOT NULL THEN '1'  ELSE '0' END
       ,T.STRT_USE_AMT                                                                             AS ACTL_START_USE_CRD_LMT --启用金额
       ,REPLACE(T.PRD_TAG_NM,',','|') --营销标签名称
       ,COALESCE(T13.CD_VAL_DSCR,T.REG_TYP_CD) --登记类型
       ,COALESCE(T14.CD_VAL_DSCR,T.PRD_USG_MARK) --产品标识用途
       ,COALESCE(T15.CD_VAL_DSCR,T.SPCL_CPT_SRC_CD) --专项资金来源
       ,CASE WHEN T.DIF_PLC_BSN_IND = '1' THEN '是'  ELSE '否' END                                   AS DIF_PLC_BSN_IND --是否异地
       ,CASE WHEN T16.LMT_PD_IND = '0' THEN '是'  ELSE '否' END                                      AS LMT_PD_IND --是否框架下子合同 1是主合同 ，0是子合同
    ,t.rel_serno
    ,t.hdl_opr_id	    --经办人工号
    ,t3.empe_nm         as hdl_opr_nm   --经办人
    ,case when ( ( t.CTR_STS_CD IN ( '2' , '4' )
        AND     t.TMT_DT = '18991231'
        AND     to_date(t.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t.dt, 'yyyyMMdd') )
            OR t.CTR_BAL > 0 ) then '当前授信业务' else '结清业务' end as bsn_typ_nm    --业务类型
FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD        T --信贷改造 DIM_BUS_LOAN_CTR_INF_DD 换成 DIM_BUS_LOAN_CTR_BSE_INF_DD
LEFT JOIN app_ado.FCT_SML_LOAN_AMT_CST_MID_DD T1 -- 小额贷款业务客户授信额度 -- 2023-08-10
ON T.CST_ID = T1.CST_ID
AND T1.DT = '20250731'
LEFT JOIN app_ado.FCT_SML_LOAN_AMT_CST_MID_DD T2 -- 小额贷款业务客户授信额度上月末
ON T.CST_ID = T2.CST_ID
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t.hdl_opr_id=t3.empe_id
and t3.dt=t1.dt
inner join SJXQ_SJ2025080486_CST_01 t4
on t.cst_id=t4.cst_id
INNER JOIN edw.DWS_CST_BAS_INF_DD T5
ON T.CST_ID = T5.CST_ID
AND T5.DT = '20250731'
LEFT JOIN
(
	SELECT  A.BUS_CTR_ID                                                                                AS BUSI_CTR_ID
	       ,SUM(A.YEAR_ACM_PRCP_BAL_ACML * C.AVG_PRC / C.QUO_UNT / B.DAYS_IN_YEAR)                      AS LOAN_BAL_ACS_YEAR_AVG
	       ,SUM(A.MON_ACM_PRCP_BAL_ACML * COALESCE(C.AVG_PRC,100) / COALESCE(C.QUO_UNT,100))            AS CTR_BAL_CNY
	       ,SUM(A.MON_ACM_PRCP_BAL_ACML * COALESCE(C.AVG_PRC,100) / COALESCE(C.QUO_UNT,100)) / 31 AS CTR_BAL_CNY_AVG
	FROM edw.DWS_BUS_LOAN_DBIL_INF_DD A     --贷款借据信息汇总 信贷改造没有改动
	INNER JOIN edw.DIM_BUS_COM_EXR_INF_DD C --汇率参数表
	ON C.CCY_CD = A.CCY_CD
    AND C.DT = '20250731'
	INNER JOIN edw.DIM_BUS_COM_DATE_ST B
	ON A.DT = B.DT
    AND B.DT = '20250731'
	WHERE A.DT = '20250731'
    AND A.YEAR_ACM_PRCP_BAL_ACML > 0
	GROUP BY  A.BUS_CTR_ID
) T6
ON T.CTR_SERNO = T6.BUSI_CTR_ID --信贷改造 BUSI_CTR_ID 换成 CTR_SERNO
LEFT JOIN edw.DWD_CST_MNG_CMNT_REL_DD T7 --客户社区信息表
ON T.CST_ID = T7.CST_ID
AND T7.DPD_TYP_CD = '1'
AND T7.DT = '20250731'
LEFT JOIN edw.DIM_CST_MNG_CMNT_INF_DD T8 --社区信息表
ON T7.SUB_CMNT_ID = T8.CMNT_ENC
AND T8.DT = '20250731'
AND T8.cmnt_typ_cd = '03' ----社区类型：子社区
LEFT JOIN edw.DIM_BUS_COM_EXR_INF_DD T9 --汇率参数表
ON T9.CCY_CD = T.BSN_CCY_CD
AND T9.DT = '20250731'
LEFT JOIN adm_pub_app.ADM_PBLC_CST_PRM_MNG_INF_DD T10 --客户主管户信息 涉及信贷改造
ON T.CST_ID = T10.CST_ID
AND T10.DT = '20250731'
LEFT JOIN edw.DIM_BUS_LOAN_CTR_COOP_FACL_DD T12
ON T.CTR_SERNO = T12.CTR_SERNO
AND T12.DT = '20250731'
LEFT JOIN edw.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t11 --合同其它明细信息 信贷改造 新增 取申请渠道代码
ON T.CTR_SERNO = T11.CTR_SERNO
AND T11.DT = '20250731'
LEFT JOIN edw.DWD_CODE_LIBRARY_DD T13 --码值表
ON T13.CD_VAL = T.REG_TYP_CD
AND T13.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND T13.FLD_NM = 'REG_TYP_CD'
AND T13.DT = '20250731'
LEFT JOIN edw.DWD_CODE_LIBRARY_DD T14 --码值表
ON T14.CD_VAL = T.PRD_USG_MARK
AND T14.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND T14.FLD_NM = 'PRD_USG_MARK'
AND T14.DT = '20250731'
LEFT JOIN edw.DWD_CODE_LIBRARY_DD T15 --码值表
ON T15.CD_VAL = T.SPCL_CPT_SRC_CD
AND T15.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND T15.FLD_NM = 'SPCL_CPT_SRC_CD'
AND T15.DT = '20250731'
LEFT JOIN edw.DIM_BUS_LOAN_PRD_FRML_DD T16 --产品信息表
ON T16.PRD_NO = T.PRD_NO
AND T16.DT = '20250731'
WHERE T.DT = '20250731'
and t.PRD_NO not like '2002010101%'    --剔除信用卡
;
-- 审查人、审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2025080486_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080486_CST_03 as
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t3.ctr_serno          --合同号
       ,t4.biz_id             AS 业务流水号
       ,t6.empe_id            as 最终审批人工号
       ,t6.empe_nm            as 最终审批人姓名
       ,t10.aprv_id           as 团队审查岗工号
       ,t10.aprv_nm           as 团队审查岗姓名
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join SJXQ_SJ2025080486_CST_02	        t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join (
    SELECT instance_id              --流程实例id|c32
        ,flow_starter               --流程发起者
        ,flow_starter_name          --发起者姓名
        ,start_time                 --流程发起时间
        ,org_id                     --发起人机构id
        ,biz_id                     --业务流水号
        ,flow_id                                  --流程id|c32
        ,flow_name                                --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='20250731'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t2.sys_reg_psn_id=t4.flow_starter
and t4.rn=1
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='20250731'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
left join(
    SELECT t1.instance_id,t1.node_nm
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='20250731'
    and t1.node_nm='团队审查岗'
    GROUP BY instance_id,node_nm
)t10 on t4.instance_id=t10.instance_id
where t1.dt='20250731'
;
-- 普惠金融-小额贷款业务清单
DROP   TABLE IF     EXISTS SJXQ_SJ2025080486_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080486_CST_04 as
SELECT  A1.CST_ID
       ,A1.VLD_CST      AS EFE_CST_IND
       ,A1.VLD_DEP_ACT  AS EFE_DEP_CST_IND
       ,A1.VLD_LOAN_ACT AS EFE_LOAN_CST_IND
       ,A2.ENTP_SIZ_CD
       ,COALESCE(A2.SAM_RSK_CTRL_ID,A3.SAM_RSK_CTRL_ID) AS SAM_RSK_CTRL_ID
       ,COALESCE(A2.IDT_CD,A3.IDT_CD)                   AS IDT_CD
       ,A3.MIC_ENTP_OWN_IND
       ,A3.IND_BUS_IND
       ,COALESCE(A2.CST_TYP_CD,A3.CST_TYP_CD)           AS CST_TYP_CD
       ,A3.FM_IND
       ,A4.LOAN_BAL_ACS_MON_AVG --贷款余额月日均（K）
       ,A4.CR_CR_CRD_MON_AVG --信用卡余额月日均
       ,A3.JOB_UNT_NM
FROM app_ado.FCT_ZZQS_CST_BAS_IND_INFO A1
LEFT JOIN adm_pub.ADM_CSM_CBAS_ORG_BAS_INF_DD A2
ON A1.CST_ID = A2.CST_ID
AND A2.DT = '20250731'
LEFT JOIN adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD A3
ON A1.CST_ID = A3.CST_ID
AND A3.DT = '20250731'
LEFT JOIN adm_pub.ADM_CSM_CBUS_LOAN_INF_DD A4 -- 客户集市-业务信息-客户贷款业务信息表
ON A1.CST_ID = A4.CST_ID
AND A4.DT = '20250731'
WHERE A1.DT = '20250731'
;
-- 客户信贷系统信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025080486_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080486_CST_05 as
SELECT  T1.CST_ID
       ,CASE WHEN T1.CERT_TYP = 'A0500' THEN COALESCE(T1.CERT_NO,'')  ELSE '' END AS USC_NO
       ,COALESCE(T6.AREA_NAME,'')                                                 AS BEL_QX
FROM edw.LOAN_CST_BSC T1
LEFT JOIN edw.LOAN_CST_CTC_ADDR T2
ON T2.DT = '20250731'
AND T2.CST_ID = T1.CST_ID
AND T2.ADDR_TYP = '050900'
AND T2.NVLD_IND = '0'
AND T2.DEL_IND = '0'
LEFT JOIN edw.LOAN_ADMIN_SM_AREA T3
ON T3.DT = '20250731'
AND T3.AREA_CODE = T2.ADIV
LEFT JOIN edw.LOAN_ADMIN_SM_AREA T6
ON T6.DT = '20250731'
AND SUBSTR(T3.PATH, 27, 12) = T6.AREA_CODE
WHERE T1.DT = '20250731'
;
DROP TABLE IF EXISTS FCT_SML_LOAN_AMT_LIST_DD_tmp;
CREATE TABLE IF NOT EXISTS FCT_SML_LOAN_AMT_LIST_DD_tmp
(
    ACG_DT                     STRING  COMMENT '数据日期'
    ,LGP_ID                    STRING  COMMENT '法人编号'
    ,GRP_ORG_ID                STRING  COMMENT '集团编号'
    ,LGL_ORG_ID                STRING  COMMENT '总行机构编号'
    ,LGL_ORG_NM                STRING  COMMENT '总行机构名称'
    ,BRN_ORG_ID                STRING  COMMENT '分行机构编号'
    ,BRN_ORG_NM                STRING  COMMENT '分行机构名称'
    ,SUB_BRN_ORG_ID            STRING  COMMENT '支行机构编号'
    ,SUB_BRN_ORG_NM            STRING  COMMENT '支行机构名称'
    ,CST_ID                    STRING  COMMENT '客户号'
    ,CST_NM                    STRING  COMMENT '客户名称'
    ,ctr_serno               STRING  COMMENT '信贷合同流水号'
    ,PD_CD                     STRING  COMMENT '产品编号'
    ,PD_NM                     STRING  COMMENT '产品编号码值'
    ,BUS_CD                    STRING  COMMENT '业务标识'
    ,BUS_NM                    STRING  COMMENT '业务标识码值'
    ,BUS_LAB_CD                STRING  COMMENT '营销标签代码'
    ,CTR_AMT                   DECIMAL COMMENT '合同金额'
    ,CTR_BAL                   DECIMAL COMMENT '合同余额'
    ,INTR_RAT                  DECIMAL COMMENT '执行月利率'
    ,HPN_DT                    STRING  COMMENT '发生日期'
    ,HPN_TYP_CD                STRING  COMMENT '发生类型'
    ,HPN_TYP_NM                STRING  COMMENT '发生类型码值'
    ,APNT_MTU_DT               STRING  COMMENT '到期日期'
    ,CRC_IND                   STRING  COMMENT '循环贷款方式'
    ,IS_SLF_CRC                STRING  COMMENT '是否自助'
    ,CYC_TYP_CD                STRING  COMMENT '自助循环类型代码'
    ,MAIN_GRNT_MTH_CD          STRING  COMMENT '主要担保方式代码'
    ,MAIN_GRNT_MTH_NM          STRING  COMMENT '主要担保方式代码码值'
    ,PRM_ORG_ID                STRING  COMMENT '管户机构号'
    ,PRM_ORG_NM                STRING  COMMENT '管户机构名称'
    ,PRM_MGR_ID                STRING  COMMENT '管户客户经理工号'
    ,PRM_MGR_NM                STRING  COMMENT '管户客户经理名称'
    ,APNT_START_DT             STRING  COMMENT '合同起始日'
    ,END_DT                    STRING  COMMENT '终结日期'
    ,LOAN_BAL_ACS_YEAR_AVG     DECIMAL COMMENT '贷款年日均'
    ,CST_AMT                   DECIMAL COMMENT '客户合同总金额'
    ,LOAN_USG_CD               STRING  COMMENT '贷款用途代码'
    ,LOAN_USG_NM               STRING  COMMENT '贷款用途代码码值'
    ,FRZ_STS_CD                STRING  COMMENT '冻结状态代码'
    ,FRZ_STS_NM                STRING  COMMENT '冻结状态代码码值'
    ,SUB_CMNT_ID               STRING  COMMENT '子社区编号'
    ,SUB_CMNT_NM               STRING  COMMENT '子社区名称'
    ,EFE_CST_IND               STRING  COMMENT '是否有效户'
    ,ENTP_SIZ_CD               STRING  COMMENT '企业规模代码'
    ,ENTP_SIZ_NM               STRING  COMMENT '企业规模码值'
    ,CST_TYP_CD                STRING  COMMENT '客户类型代码'
    ,CST_TYP_NM                STRING  COMMENT '客户类型码值'
    ,FM_IND                    STRING  COMMENT '是否农户'
    ,SAM_RSK_CTRL_ID           STRING  COMMENT '同一风险控制号'
    ,IDT_CD                    STRING  COMMENT '行业投向代码'
    ,IDT_NM                    STRING  COMMENT '行业投向码值'
    ,MIC_ENTP_OWN_IND          STRING  COMMENT '是否小微企业主'
    ,IND_BUS_IND               STRING  COMMENT '是否个体工商户主'
    ,CCY_CD                    STRING  COMMENT '币种'
    ,CTR_AMT_CNY               DECIMAL COMMENT '合同金额折人民币'
    ,CTR_BAL_CNY               DECIMAL COMMENT '合同余额折人民币'
    ,CST_AMT_CNY               DECIMAL COMMENT '客户合同总金额折人民币'
    ,EFE_DEP_CST_IND           STRING  COMMENT '有效存款户标识'
    ,EFE_LOAN_CST_IND          STRING  COMMENT '有效信贷户标识'
    ,CTR_BAL_CNY_AVG           DECIMAL COMMENT '合同余额月日均折人民币'
    ,LOAN_BAL_ACS_MON_AVG      DECIMAL COMMENT '客户贷款月日均折人民币'
    ,COM_LOAN_BAL_ACS_MON_AVG  DECIMAL COMMENT '客户贷款月日均折人民币(不包含信用卡)'
    ,CST_AMT_CNY_LM            DECIMAL COMMENT '客户合同总金额折人民币（上月）'
    ,BIND_LMT                  DECIMAL COMMENT '绑定额度'
    ,ACTL_START_USE_CRD_LMT    DECIMAL COMMENT '启用额度'
    ,IF_CSM_LOAN_ID            STRING  COMMENT '消费贷款标识:1（是）0（否）'
    ,JOB_UNT_NM                STRING  COMMENT '工作单位名称'
    ,BUS_LAB_NM                STRING  COMMENT '营销标签名称'
    ,REG_TYP_NM                STRING  COMMENT '登记类型'
    ,PRD_USG_MARK              STRING  COMMENT '产品标识用途'
    ,SPCL_CPT_SRC_NM           STRING  COMMENT '专项资金来源'
    ,DIF_PLC_BSN_IND           STRING  COMMENT '是否异地'
    ,LMT_PD_IND                STRING  COMMENT '是否框架下子合同'
    ,SML_AMT_LOAN_NEW_CST      STRING  COMMENT '小额贷款纯新客1是0否'
    ,SML_AMT_LOAN_LOS_RTRV_CST STRING  COMMENT '小额贷款流失挽回客户1是0否'
    -- ,CST_ADDR                  STRING  COMMENT '客户地址'
    ,USC_NO                    STRING  COMMENT '统一社会信用代码'
    ,BEL_QX                    STRING  COMMENT '所属区县'
    ,hdl_opr_id             STRING  COMMENT '经办人工号'
    ,hdl_opr_NM             STRING  COMMENT '经办人名称'
    ,bsn_typ_nm             STRING  COMMENT '业务类型'
) COMMENT '机构授信客户清单（考核）'
;
INSERT INTO FCT_SML_LOAN_AMT_LIST_DD_tmp
SELECT  A.ACG_DT
       ,'9999' --'法人编号'
       ,'777777777'                                                                                                         AS GRP_ORG_ID --集团
       ,COALESCE(O.ORG_ID_R,'')                                                                                             AS LGL_ORG_ID --总行机构编号
       ,COALESCE(O.ORG_NM_R,'')                                                                                             AS LGL_ORG_NM --总行机构名称
       ,COALESCE(O.ORG_ID_F,'')                                                                                             AS BRN_ORG_ID --分行机构编号
       ,COALESCE(O.ORG_NM_F,'')                                                                                             AS BRN_ORG_NM --分行机构名称
       ,COALESCE(O.ORG_ID_Z,'')                                                                                             AS SUB_BRN_ORG_ID --支行机构编号
       ,COALESCE(O.ORG_NM_Z,'')                                                                                             AS SUB_BRN_ORG_NM --支行机构名称
       ,A.CST_ID --客户号
       ,A.CST_NM --客户名称
       ,A.ctr_serno --信贷合同流水号
       ,A.PD_CD --产品编号
       ,CASE WHEN A.AST_POOL_IND = '1' THEN '资产池'
             WHEN A.COOP_FACL = '1' THEN '合作方授信'  ELSE COALESCE(B.PD_NM,'') END --产品编号码值
       ,REPLACE(A.BUS_CD,',',' ') --业务标识
       ,COALESCE(G.CD_VAL_DSCR,'')                                                                                          AS BUS_NM --业务标识码值
       ,REPLACE(A.BUS_LAB_CD,',',' ') --营销标签代码
       ,A.CTR_AMT --合同金额
       ,CASE WHEN B.LMT_PD_IND = '1' THEN COALESCE(CTR.PRCP_BAL,0)  ELSE A.CTR_BAL END --合同余额
       ,A.INTR_RAT --执行月利率
       ,A.HPN_DT --发生日期
       ,A.HPN_TYP_CD --发生类型
       ,COALESCE(G1.CD_VAL_DSCR,'')                                                                                         AS HPN_TYP_NM --发生类型码值
       ,A.APNT_MTU_DT --到期日期
       ,A.CRC_IND --循环贷款方式
       ,A.IS_SLF_CRC --是否自助
       ,A.CYC_TYP_CD --自助循环类型代码
       ,REPLACE(A.MAIN_GRNT_MTH_CD,',','|') --主要担保方式代码
       ,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(A.MAIN_GRNT_MTH_CD,'010','保证'),'020','抵押'),'040','质押'),'005','信用'),',','|') AS MAIN_GRNT_MTH_NM --主要担保方式代码码值
       ,A.PRM_ORG_ID --管户机构号
       ,A.PRM_ORG_NM --管户机构名称
       ,A.PRM_MGR_ID --管户客户经理工号
       ,A.PRM_MGR_NM --管户客户经理名称
       ,A.APNT_START_DT --合同起始日
       ,A.END_DT --终结日期
       ,A.LOAN_BAL_ACS_YEAR_AVG --贷款年日均
       ,A.CST_AMT --客户合同总金额
       ,A.LOAN_USG_CD --贷款用途代码
       ,COALESCE(G3.CD_VAL_DSCR,A.LOAN_USG_CD)                                                                              AS LN_USG_NM --'用途代码码值'
       ,A.FRZ_STS_CD --冻结状态代码
       ,COALESCE(G4.CD_VAL_DSCR,A.FRZ_STS_CD)                                                                               AS FRZ_STS_NM --冻结状态代码码值
       ,A.SUB_CMNT_ID --'子社区编号'
       ,A.SUB_CMNT_NM --'子社区名称'
       ,CASE WHEN A1.EFE_CST_IND = '1' THEN '是'  ELSE '否' END
       ,COALESCE(A1.ENTP_SIZ_CD,'')
       ,COALESCE(A5.CD_VAL_DSCR,'')
       ,A1.CST_TYP_CD
       ,COALESCE(A6.CD_MEAN,'')
       ,CASE WHEN COALESCE(A1.FM_IND,'') = '1' THEN '是'  ELSE '否' END
       ,A1.SAM_RSK_CTRL_ID
       ,A1.IDT_CD
       ,COALESCE(A4.CD_MEAN,'')
       ,CASE WHEN COALESCE(A1.MIC_ENTP_OWN_IND,'') = '1' THEN '是'  ELSE '否' END
       ,CASE WHEN COALESCE(A1.IND_BUS_IND,'') = '1' THEN '是'  ELSE '否' END
       ,A.CCY_CD
       ,A.CTR_AMT_CNY --合同金额折人民币
       ,CASE WHEN B.LMT_PD_IND = '1' THEN COALESCE(CTR.PRCP_BAL_CNY,0)  ELSE A.CTR_BAL_CNY END                              AS CTR_BAL_CNY --合同余额折人民币
       ,A.CST_AMT_CNY --客户合同总金额折人民币
       ,CASE WHEN A1.EFE_DEP_CST_IND = '1' THEN 1  ELSE 0 END --有效存款户标识
       ,CASE WHEN A1.EFE_LOAN_CST_IND = '1' THEN 1  ELSE 0 END --有效信贷户标识
       ,CTR.CTR_BAL_CNY_AVG -- 合同月日均折人民币
       ,A1.LOAN_BAL_ACS_MON_AVG                                                                                             AS LOAN_BAL_ACS_MON_AVG --客户贷款月日均折人民币
       ,COALESCE(A1.LOAN_BAL_ACS_MON_AVG,0) - COALESCE(A1.CR_CR_CRD_MON_AVG,0)                                              AS COM_LOAN_BAL_ACS_MON_AVG --贷款余额月日均（不含信用卡）（K）
       ,A.CST_AMT_CNY_LM -- '客户合同总金额折人民币（上月）'
       ,COALESCE(A7.BIND_LMT,0) -- '绑定额度'
       ,COALESCE(A.ACTL_START_USE_CRD_LMT,0) --实际启用授信额度
       ,A.IF_CSM_LOAN_ID --消费贷款标识
       ,COALESCE(A1.JOB_UNT_NM,'')
       ,A.BUS_LAB_NM
       ,A.REG_TYP_NM
       ,A.PRD_USG_MARK
       ,A.SPCL_CPT_SRC_NM
       ,A.DIF_PLC_BSN_IND
       ,A.LMT_PD_IND
       ,COALESCE(REPLACE(REPLACE(T1.SML_AMT_LOAN_NEW_CST,'1','是'),'0','否'),'否')
       ,COALESCE(REPLACE(REPLACE(T1.SML_AMT_LOAN_LOS_RTRV_CST,'1','是'),'0','否'),'否')
    --    ,T2.CST_ADDR
       ,T2.USC_NO
       ,T2.BEL_QX
       ,a.hdl_opr_id --经办人工号
       ,a.hdl_opr_NM --经办人名称
       ,a.bsn_typ_nm --业务类型
FROM SJXQ_SJ2025080486_CST_02 A
LEFT JOIN
(
	SELECT  A.BUS_CTR_ID
	       ,SUM(PRCP_BAL)                                                                               AS PRCP_BAL
	       ,SUM(PRCP_BAL * COALESCE(B.AVG_PRC,0) / COALESCE(B.QUO_UNT,0))                               AS PRCP_BAL_CNY
	       ,SUM(A.MON_ACM_PRCP_BAL_ACML * COALESCE(B.AVG_PRC,100) / COALESCE(B.QUO_UNT,100)) / 31 AS CTR_BAL_CNY_AVG
	FROM edw.DWS_BUS_LOAN_DBIL_ACM_INF_DD A --
	LEFT JOIN edw.DIM_BUS_COM_EXR_INF_DD B --汇率参数表
	ON A.CCY_CD = B.CCY_CD
    AND B.DT = '20250731'
	WHERE A.DT = '20250731'
	GROUP BY  A.BUS_CTR_ID
) CTR
ON A.ctr_serno = CTR.BUS_CTR_ID
LEFT JOIN edw.DIM_BUS_LOAN_PRD_FRML_DD B -- 信贷改造 DIM_BUS_LOAN_PD_INF_DD 换成 DIM_BUS_LOAN_PRD_FRML_DD
ON A.PD_CD = B.PRD_NO
AND B.DT = '20250731'
LEFT JOIN edw.DWD_CODE_LIBRARY_DD G
ON A.BUS_CD = G.CD_VAL --业务标识
AND G.DT = '20250731'
AND G.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND G.FLD_NM = 'BSN_MARK_CD' --业务标识
LEFT JOIN edw.DWD_CODE_LIBRARY_DD G1
ON A.HPN_TYP_CD = G1.CD_VAL --发生类型
AND G1.DT = '20250731'
AND G1.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND G1.FLD_NM = 'HPN_TYP_CD' --发生类型
LEFT JOIN edw.DWD_CODE_LIBRARY_DD G3
ON A.LOAN_USG_CD = G3.CD_VAL
AND G3.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND G3.DT = '20250731'
AND G3.FLD_NM = 'CPT_USG_CD' --资金用途
LEFT JOIN edw.DWD_CODE_LIBRARY_DD G4
ON A.FRZ_STS_CD = G4.CD_VAL
AND G4.DT = '20250731'
AND G4.TBL_NM = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND G4.FLD_NM = 'CTR_STS_CD' --冻结标识
LEFT JOIN app_ado.FCT_ORG_PATH_INF O
ON A.PRM_ORG_ID = O.ORG_ID
AND O.DT = '20250731'
AND O.ORG_RLTN_DIM_CD = 'WD3'
LEFT JOIN SJXQ_SJ2025080486_CST_04 A1
ON A.CST_ID = A1.CST_ID
LEFT JOIN edw.DWD_BUS_COM_ALL_SYS_CODE_SMY_DD A4
ON A1.IDT_CD = A4.CD_VAL --行业投向代码
AND A4.DT = '20250731'
AND A4.NO_VAL_GRP_ID = 'INV_IN_INDY' --行业投向代码
AND A4.SRC_SYS_NM = '新信贷系统'
LEFT JOIN edw.DWD_CODE_LIBRARY_DD A5
ON COALESCE(A1.ENTP_SIZ_CD, '') = A5.CD_VAL
AND A5.DT = '20250731'
AND A5.TBL_NM = 'DIM_CST_ENTP_BAS_INF_DD'
AND A5.FLD_NM = 'ENTP_SIZ_CD'
LEFT JOIN edw.DWD_BUS_COM_ALL_SYS_CODE_SMY_DD A6
ON A1.CST_TYP_CD = A6.CD_VAL --客户类型
AND A6.DT = '20250731'
AND A6.NO_VAL_GRP_ID = 'CST_TYP' --客户类型
AND A6.SRC_SYS_NM = '新信贷系统'
LEFT JOIN edw.DWD_BUS_LOAN_FNC_CRD_LMT_INF_DD A7 -- 随贷通授信额度信息
ON A.ctr_serno = A7.BUS_CTR_ID
AND A7.DT = '20250731'
LEFT JOIN adm_ind.ADM_IND_L_RUL_UNVS_FIN_BHV_LOAN_DD T1 --通用金融行为贷款标签表
ON T1.DT = '20250731'
AND T1.CST_ID = A.CST_ID
LEFT JOIN SJXQ_SJ2025080486_CST_05 T2
ON T2.CST_ID = A.CST_ID
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025080486_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080486_CST_06 as
SELECT t1.cst_id                  AS 客户号
    ,t1.cst_chn_nm                AS 客户姓名
    ,t3.最终审批人工号
    ,t3.最终审批人姓名
    ,t3.团队审查岗工号
    ,t3.团队审查岗姓名
    ,t2.acg_dt                    AS 数据日期
    ,t2.lgp_id                    AS 法人编号
    ,t2.grp_org_id                AS 集团编号
    ,t2.lgl_org_id                AS 总行机构编号
    ,t2.lgl_org_nm                AS 总行机构名称
    ,t2.brn_org_id                AS 分行机构编号
    ,t2.brn_org_nm                AS 分行机构名称
    ,t2.sub_brn_org_id            AS 支行机构编号
    ,t2.sub_brn_org_nm            AS 支行机构名称
    ,t2.ctr_serno               AS 信贷合同流水号
    ,t2.pd_cd                     AS 产品编号
    ,t2.pd_nm                     AS 产品编号码值
    ,t9.apl_methon                AS 进件方式
    ,t2.bus_cd                    AS 业务标识
    ,t2.bus_nm                    AS 业务标识码值
    ,t2.ctr_amt                   AS 合同金额
    ,t2.ctr_bal                   AS 合同余额
    ,t2.intr_rat                  AS 执行月利率
    ,t2.hpn_dt                    AS 发生日期
    ,t2.hpn_typ_cd                AS 发生类型
    ,t2.hpn_typ_nm                AS 发生类型码值
    ,t2.apnt_mtu_dt               AS 到期日期
    ,t2.crc_ind                   AS 循环贷款方式
    ,t2.is_slf_crc                AS 是否自助
    ,t2.cyc_typ_cd                AS 自助循环类型代码
    ,t2.main_grnt_mth_cd          AS 主要担保方式代码
    ,t2.main_grnt_mth_nm          AS 主要担保方式代码码值
    ,t2.prm_org_id                AS 管户机构号
    ,t2.prm_org_nm                AS 管户机构名称
    ,t2.prm_mgr_id                AS 管户客户经理工号
    ,t2.prm_mgr_nm                AS 管户客户经理名称
    ,t2.hdl_opr_NM as 经办人
    ,t2.bsn_typ_nm as 业务类型
    ,t2.apnt_start_dt             AS 合同起始日
    ,t2.end_dt                    AS 终结日期
    ,t2.loan_bal_acs_year_avg     AS 贷款年日均
    ,t2.cst_amt                   AS 客户合同总金额
    ,t2.loan_usg_cd               AS 贷款用途代码
    ,t2.loan_usg_nm               AS 贷款用途代码码值
    ,t2.frz_sts_cd                AS 冻结状态代码
    ,t2.frz_sts_nm                AS 冻结状态代码码值
    ,t2.sub_cmnt_id               AS 子社区编号
    ,t2.sub_cmnt_nm               AS 子社区名称
    ,t2.efe_cst_ind               AS 是否有效户
    ,t2.entp_siz_cd               AS 企业规模代码
    ,t2.entp_siz_nm               AS 企业规模码值
    ,t2.cst_typ_cd                AS 客户类型代码
    ,t2.cst_typ_nm                AS 客户类型码值
    ,t2.fm_ind                    AS 是否农户
    ,t2.sam_rsk_ctrl_id           AS 同一风险控制号
    ,t2.idt_cd                    AS 行业投向代码
    ,t2.idt_nm                    AS 行业投向码值
    ,t2.mic_entp_own_ind          AS 是否小微企业主
    ,t2.ind_bus_ind               AS 是否个体工商户主
    ,t2.ccy_cd                    AS 币种
    ,t2.ctr_amt_cny               AS 合同金额折人民币
    ,t2.ctr_bal_cny               AS 合同余额折人民币
    ,t2.cst_amt_cny               AS 客户合同总金额折人民币
    ,t2.efe_dep_cst_ind           AS 有效存款户标识
    ,t2.efe_loan_cst_ind          AS 有效信贷户标识
    ,t2.ctr_bal_cny_avg           AS 合同余额月日均折人民币
    ,t2.loan_bal_acs_mon_avg      AS 客户贷款月日均折人民币
    ,t2.com_loan_bal_acs_mon_avg  AS 客户贷款月日均折人民币_不包含信用卡
    ,t2.cst_amt_cny_lm            AS 客户合同总金额折人民币_上月
    ,t2.bind_lmt                  AS 绑定额度
    ,t2.actl_start_use_crd_lmt    AS 启用额度
    ,t2.if_csm_loan_id            AS 消费贷款标识1是0否
    ,t2.job_unt_nm                AS 工作单位名称
    ,t2.bus_lab_nm                AS 营销标签名称
    ,t2.bus_lab_cd                AS 营销标签代码
    ,t2.reg_typ_nm                AS 登记类型
    ,t2.prd_usg_mark              AS 产品标识用途
    ,t2.spcl_cpt_src_nm           AS 专项资金来源
    ,t2.dif_plc_bsn_ind           AS 是否异地
    ,t2.lmt_pd_ind                AS 是否框架下子合同
    ,t2.sml_amt_loan_new_cst      AS 小额贷款纯新客1是0否
    ,t2.sml_amt_loan_los_rtrv_cst AS 小额贷款流失挽回客户1是0否
    ,t2.usc_no                    AS 统一社会信用代码
    ,t2.bel_qx                    AS 所属区县
    ,t4.rsk_hidden_cst_ind        AS 是否风险隐患客户
    ,case when t6.cst_id is not null then '是' else '否' end as 是否代发工资客户
    ,t7.量化风险等级
    ,case when t8.cst_id is not null then '是' else '否' end as 是否触发精准贷后
from SJXQ_SJ2025080486_CST_01       t1
left join fct_sml_loan_amt_list_dd_tmp t2 --普惠金融-小额贷款业务清单
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025080486_CST_03  t3
on t2.ctr_serno=t3.ctr_serno
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd    t4 --客户集市-风险信息-基础风险标签信息
on t1.cst_id=t4.cst_id
and t4.dt='20250731'
left join (
    SELECT  DISTINCT T2.CST_ID
    FROM    EDW.CORE_KDPL_ZHMINX                T1
    INNER JOIN    EDW.DWS_BUS_DEP_ACT_INF_DD    T2
    ON      T2.DEP_ACT_ID = T1.ZHANGHAO
    AND     T1.dt = T2.dt
    AND     T2.DT = '20250731'
    WHERE   T1.DT <= '20250731'
    AND     T1.ZHAIYODM = 'IB0047' --代发工资
)t6 on t1.cst_id=t6.cst_id
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        ,risk_model_score as 泰隆分
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250731'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
        ,risk_model_score as 泰隆分
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250731'
)t7 on t1.cst_id=t7.cst_id
left join(
    SELECT  distinct T1.cst_id       --客户号
    FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
    INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
    ON      T1.btch_serno = T2.btch_serno
    AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
    AND     T2.DT = '20250731'
    WHERE   T1.DT = '20250731'
)t8 on t1.cst_id=t8.cst_id
left join app_ado.fct_zzqs_ted_apl_list     t9 --泰e贷进件清单
on t2.ctr_serno=t9.orig_ctr_srl_nbr
and t9.dt='20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080486_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080486_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080486_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080486_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080486_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 信贷合同流水号) custs
from SJXQ_SJ2025080486_CST_06
;
/*
01	140	140
02	98	98
03	84	84
04	20414785	20414785
05	8688479	8688479
*/
SElECT '06' seq, * from lab_sjxq.SJXQ_SJ2025080486_CST_06;
***滑茹瑶_SJ2025053071_近海捕捞疑点数据.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_01 AS
SELECT  col_1  --数据日期
       ,col_2  --支行机构名称
       ,col_3  --客户号
       ,col_4  --客户名称
       ,col_5  --有效贷款户
       ,col_6  --信贷合同流水号
       ,col_7  --产品编号
       ,col_8  --产品编号码值
       ,col_9  --业务标识
       ,col_10 --业务标识码值
       ,col_11 --合同金额
       ,col_12 --合同余额
       ,col_13 --执行月利率
       ,col_14 --发生日期
       ,col_15 --发生类型
       ,col_16 --发生类型码值
       ,col_17 --到期日期
       ,col_18 --循环贷款方式
       ,col_19 --是否自助
       ,col_20 --自助循环类型代码
       ,col_21 --主要担保方式代码
       ,col_22 --主要担保方式代码码值
       ,col_23 --管户机构号
       ,col_24 --管户机构名称
       ,col_25 --管户客户经理工号
       ,col_26 --管户客户经理名称
       ,col_27 --合同起始日
       ,col_28 --终结日期
       ,col_29 --贷款年日均
       ,col_30 --客户合同总金额
       ,col_31 --贷款用途代码
       ,col_32 --贷款用途代码码值
       ,col_33 --冻结状态代码
       ,col_34 --冻结状态代码码值
       ,col_35 --子社区编号
       ,col_36 --子社区名称
       ,col_37 --是否有效户
       ,col_38 --企业规模代码
       ,col_39 --企业规模码值
       ,col_40 --客户类型代码
       ,col_41 --客户类型码值
       ,col_42 --是否农户
       ,col_43 --同一风险控制号
       ,col_44 --行业投向代码
       ,col_45 --行业投向码值
       ,col_46 --是否小微企业主
       ,col_47 --是否个体工商户主
       ,col_48 --币种
       ,col_49 --合同金额折人民币
       ,col_50 --合同余额折人民币
       ,col_51 --客户合同总金额折人民币
       ,col_52 --有效存款户标识
       ,col_53 --有效信贷户标识
       ,col_54 --合同余额月日均折人民币
       ,col_55 --客户贷款月日均折人民币
       ,col_56 --客户贷款月日均折人民币2
       ,col_57 --客户合同总金额折人民币2
       ,col_58 --绑定额度
       ,col_59 --启用额度
       ,col_60 --消费贷款标识
       ,col_61 --担保方式
from lab_bigdata_dev.qbi_file_20250604_11_04_18_0
where pt<>''
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_02 AS
select *
from(
	select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
		,case when nvl(scor_rng,'')<>'' then scor_rng
				120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
		,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	from(
		SELECT  cst_id
			,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
			,cr_sco_val                          AS cst_cr_grd_val
			,'1中征分' sc_src,scor_rng
		FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
		WHERE dt <= '20250531' and cr_sco_val<>0
		UNION
		SELECT  cst_id
			,prd_dt
			,cst_cr_grd_val
			,'1中征分' sc_src,scor_rng
		FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
		WHERE dt <= '20250531' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
		union
		SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
			,'2指标表' sc_src,scor_rng
		from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
		where dt='20250531' and report_dsc_rn=1
		and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
		union
		SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
			,'3集市表' sc_src
			,case when cast(digital_unscr as int) <120 then '[0,120)'
				when cast(digital_unscr as int) >=1000 then '[1000,)'
					120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
		from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
		where dt<='20250531' and nvl(digital_unscr,'')<>''
		and digital_unscr <> '-1'
	)t
)t1 where rn=1
;
-- 20241231征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_03 AS
select *
from(
	select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
		,case when nvl(scor_rng,'')<>'' then scor_rng
				120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
		,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	from(
		SELECT  cst_id
			,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
			,cr_sco_val                          AS cst_cr_grd_val
			,'1中征分' sc_src,scor_rng
		FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
		WHERE dt <= '20241231' and cr_sco_val<>0
		UNION
		SELECT  cst_id
			,prd_dt
			,cst_cr_grd_val
			,'1中征分' sc_src,scor_rng
		FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
		WHERE dt <= '20241231' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
		union
		SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
			,'2指标表' sc_src,scor_rng
		from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
		where dt='20241231' and report_dsc_rn=1
		and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
		union
		SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
			,'3集市表' sc_src
			,case when cast(digital_unscr as int) <120 then '[0,120)'
				when cast(digital_unscr as int) >=1000 then '[1000,)'
					120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
		from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
		where dt<='20241231' and nvl(digital_unscr,'')<>''
		and digital_unscr <> '-1'
	)t
)t1 where rn=1
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_04 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
	,t2.PRE_ASES_rul_nm  --预评估触发规则
	,t2.PRE_ASES_prmpt_msg  --预评估提示信息
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250531'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20250531'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
	LEFT JOIN
	(
		SELECT  B1.rul_set_rslt_serno
		FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
		WHERE B1.DT = '20250531'
		GROUP BY  B1.rul_set_rslt_serno
	) T3
	ON T2.rul_set_rslt_serno = T3.rul_set_rslt_serno
    where t2.DT = '20250531'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
--精准贷后类型
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_05 AS
select *
from(
	SELECT  T1.cst_id       		--客户号
		,t1.cst_lvl_pst_loan_mng_pln_cd --客户级贷后管理方案代码 	--精准贷后反馈结果
		,c2.cd_val_dscr 	as 精准贷后反馈结果
		,T2.tsk_gen_dt  			--最近一次触碰精准贷后_处置类时间
		,T2.pst_loan_chk_tsk_typ_cd
		,c1.cd_val_dscr 	as 贷后检查任务类型 	--精准贷后类型
		,ROW_NUMBER() over(PARTITION BY T1.cst_id ORDER BY t2.tsk_gen_dt desc) rn
	FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
	INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
	ON      T1.btch_serno = T2.btch_serno
	AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
	-- AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
	AND     T2.DT = '20250531'
	left join edw.dwd_code_library_dd c1
	on t2.pst_loan_chk_tsk_typ_cd = c1.cd_val
	and c1.dt = t1.dt
    LEFT JOIN    edw.dwd_code_library_dd 	c2 --码值表
    ON      t1.cst_lvl_pst_loan_mng_pln_cd = c2.cd_val
    AND     c2.DT = t1.dt
	WHERE   T1.DT = '20250531'
)t1 where t1.rn=1
;
--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_06 AS
SELECT  a.grnt_mod_colc
FROM
(
	SELECT  distinct grnt_mod_colc
	       ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE dt = '20250531'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '20250531'
GROUP BY  a.grnt_mod_colc
;
-- 担保人明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_07 AS
select t1.ctr_serno								 --合同流水号
	,t1.eff_sts_cd                               --生效状态代码|c1
	,t2.grnt_ctr_no                              --担保合同编号|c32
	,t2.gtor_no                                  --保证人编号|c20
	,t2.gtor_nm                                  --保证人名称|c200
	,t2.eff_sts_cd   as eff_sts_cd2              --生效状态代码|c2
from edw.dwd_bus_loan_ctr_rel_grnt_dd			t1 --主合同、担保合同关系
left join edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t2
on t1.grnt_ctr_no=t2.grnt_ctr_no
and t2.dt=t1.dt
inner join (
	select distinct col_6 as ctr_serno
	from SJXQ_SJ2025053071_CST_01
)t3 on t1.ctr_serno=t3.ctr_serno
where t1.dt='20250531'
-- and t1.busi_typ_cd='1' 	--1贷款业务2信用卡业务
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025053071_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025053071_CST_08 AS
SELECT  col_1              AS 数据日期
	,col_2                 AS 支行机构名称
	,col_3                 AS 客户号
	,col_4                 AS 客户名称
	,col_5                 AS 有效贷款户
	,col_6                 AS 信贷合同流水号
	,col_7                 AS 产品编号
	,col_8                 AS 产品编号码值
	,col_9                 AS 业务标识
	,col_10                AS 业务标识码值
	,col_11                AS 合同金额
	,col_12                AS 合同余额
	,col_13                AS 执行月利率
	,col_14                AS 发生日期
	,col_15                AS 发生类型
	,col_16                AS 发生类型码值
	,col_17                AS 到期日期
	,col_18                AS 循环贷款方式
	,col_19                AS 是否自助
	,col_20                AS 自助循环类型代码
	,col_21                AS 主要担保方式代码
	,col_22                AS 主要担保方式代码码值
	,col_23                AS 管户机构号
	,col_24                AS 管户机构名称
	,col_25                AS 管户客户经理工号
	,col_26                AS 管户客户经理名称
	,col_27                AS 合同起始日
	,col_28                AS 终结日期
	,col_29                AS 贷款年日均
	,col_30                AS 客户合同总金额
	,col_31                AS 贷款用途代码
	,col_32                AS 贷款用途代码码值
	,col_33                AS 冻结状态代码
	,col_34                AS 冻结状态代码码值
	,col_35                AS 子社区编号
	,col_36                AS 子社区名称
	,col_37                AS 是否有效户
	,col_38                AS 企业规模代码
	,col_39                AS 企业规模码值
	,col_40                AS 客户类型代码
	,col_41                AS 客户类型码值
	,col_42                AS 是否农户
	,col_43                AS 同一风险控制号
	,col_44                AS 行业投向代码
	,col_45                AS 行业投向码值
	,col_46                AS 是否小微企业主
	,col_47                AS 是否个体工商户主
	,col_48                AS 币种
	,col_49                AS 合同金额折人民币
	,col_50                AS 合同余额折人民币
	,col_51                AS 客户合同总金额折人民币
	,col_52                AS 有效存款户标识
	,col_53                AS 有效信贷户标识
	,col_54                AS 合同余额月日均折人民币
	,col_55                AS 客户贷款月日均折人民币
	,col_56                AS 客户贷款月日均折人民币2
	,col_57                AS 客户合同总金额折人民币2
	,col_58                AS 绑定额度
	,col_59                AS 启用额度
	,col_60                AS 消费贷款标识
	,col_61                AS 担保方式
	,t2.scor_rng           AS 最新征信评分
	,t3.scor_rng           AS 2024年12月征信评分
	,t4.sys_reg_tm         AS 新预评时间
	,t4.rul_set_rslt_nm    AS 新预评估结果
	,t4.PRE_ASES_rul_nm    AS 预评估触发规则
	,t4.PRE_ASES_prmpt_msg AS 预评估提示信息
	,t5.tsk_gen_dt         AS 最近一次触碰精准贷后时间
	,t5.贷后检查任务类型 		 as 精准贷后类型
	,t5.精准贷后反馈结果
	,t6.gtor_nm 			as 担保人明细
	,case when t7.bsn_mark_cd regexp '03|04' then '是' else '否' end as 是否为预保预报或重组贷款
	,t8.grnt_mod_nm 		as 担保方式集合
	,t9.ast_lbl_rat         as 资产负债率
	,t9.lbl_tot_amt         as 最近一次负债总额
	,t91.lbl_tot_amt        as 上上次负债总额
    ,t11.idtc_rsk_ctrl_no_loan_facl_tot_amt as 同一风险控制号贷款类授信金额求和_征信
	,t10.rsk_hidden_cst_ind AS 是否风险隐患客户
	,t12.cur_day_loan_not_cls_non_tl_bnk_org_num	as 他行融资家数_贷款未关闭非泰隆银行机构数
	,t12.cur_day_rel_rpay_bal				as	对外担保金额_相关还款余额
	,t12.cur_day_rel_rpay_lvl5_non_norm_bal	as	对外担保是否有异常_相关还款五级非正常余额
from SJXQ_SJ2025053071_CST_01  		t1
left join SJXQ_SJ2025053071_CST_02 	t2
on t1.col_3=t2.cst_id
left join SJXQ_SJ2025053071_CST_03 	t3
on t1.col_3=t3.cst_id
left join SJXQ_SJ2025053071_CST_04 	t4
on t1.col_3=t4.cst_id
left join SJXQ_SJ2025053071_CST_05 	t5
on t1.col_3=t5.cst_id
left join (
	select ctr_serno
	from SJXQ_SJ2025053071_CST_07
	group by ctr_serno
)t6 on t1.col_6=t6.ctr_serno
left join edw.dim_bus_loan_ctr_bse_inf_dd        t7 --合同基础信息
on t1.col_6=t7.ctr_serno
and t7.dt='20250531'
left join SJXQ_SJ2025053071_CST_06 	t8
on t7.grnt_mod_colc=t8.grnt_mod_colc
left join(
	select cst_id                                   --客户号|c20
		,rcd_tm                                   --记录时间|c20
		,ast_amt                                  --资产总额|decimal(21,2)
		,lbl_tot_amt                              --负债总额|decimal(21,2)
		,ast_lbl_rat                              --资产负债率|decimal(10,6)
		,slf_ast_amt                              --本人资产总额|decimal(21,2)
		,slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
		,slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
		,last_upd_tm                              --最后更新时间|C19
		,row_number() over(partition by cst_id order by rcd_tm desc) rn
	from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
	where dt='20250531'
)t9 on t1.col_3=t9.cst_id
and t9.rn=1
left join(
	select cst_id                                   --客户号|c20
		,rcd_tm                                   --记录时间|c20
		,lbl_tot_amt                              --负债总额|decimal(21,2)
		,ast_lbl_rat                              --资产负债率|decimal(10,6)
		,row_number() over(partition by cst_id order by rcd_tm desc) rn
	from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
	where dt='20250531'
)t91 on t1.col_3=t91.cst_id
and t91.rn=2 	--上上次
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd 	t10 --客户集市-风险信息-基础风险标签信息
on t1.col_3=t10.cst_id
and t10.dt='20250531'
-- 负债报告中同控号授信金额
left join adm_ind.adm_ind_i_crdt_rpt_rsk_idx_dd			t11 --征信报告风险指标表
on t1.col_3=t11.cst_id
and t11.dt='20250531'
left join adm_pub_app.adm_pblc_cst_crdt_indiv_cst_idx_dd t12
on t11.crdt_rpt_no=t12.crdt_rpt_no
and t12.dt='20250531'
;
SElECT '01' seq, count(1) cnt,count(distinct col_6) custs
from SJXQ_SJ2025053071_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025053071_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025053071_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025053071_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025053071_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct grnt_mod_colc) custs
from SJXQ_SJ2025053071_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025053071_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 信贷合同流水号) custs
from SJXQ_SJ2025053071_CST_08
;
***滑茹瑶_SJ2025060931_审批退回次数.sql
﻿-- 舟山分行2025年1-5月已发放业务中，退件情况。
-- 详见附件标黄字段：审批人、退回次数、退回人
-- 导入数据
DROP   TABLE IF EXISTS SJXQ_SJ2025060931_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025060931_CST_01
(
    cst_id          string COMMENT '客户号'
    ,ctr_serno      string COMMENT '合同号'
)
;
insert into SJXQ_SJ2025060931_CST_01
;
--审批结果
DROP   TABLE IF EXISTS SJXQ_SJ2025060931_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2025060931_CST_02 as
SELECT  t1.usc_aply_serno     as 用信申请流水号
       ,t1.cst_id             as 客户号
       ,t1.cst_nm             as 客户名称
       ,t1.cst_typ_cd         as 客户类型代码
       ,t1.prd_no             as 产品编号
       ,t1.pd_nm              as 产品名称
       ,t1.hpn_typ_cd         as 发生类型代码
       ,t1.apl_amt            as 申请金额
       ,t1.aply_epsr_amt      as 申请敞口金额
       ,t1.grnt_mod_colc_cd   as 担保方式集合代码
       ,t1.apl_dt             as 申请日期
       ,t1.rmk                as 备注
       ,t1.mgr_id             as 管户人工号
       ,t1.mgr_org_id         as 管户机构编号
       ,t1.exec_intr_rat      as 执行利率
       ,t2.sam_rsk_ctrl_no    as 同一风险控制号
       ,t2.csld_cr_lmt        as 统一授信额度
       ,t2.csld_cr_xpos       as 统一授信敞口
       ,t2.sys_reg_psn_id     as 系统登记人
       ,t3.ctr_serno          as 合同号
       ,t3.rel_serno
       ,t4.flow_starter       as 流程发起者
       ,t4.flow_starter_name  as 发起者姓名
       ,t4.start_time         as 流程发起时间
       ,t4.org_id             as 发起人机构id
       ,t4.biz_id             as 业务流水号
       ,t5.back_cnt          AS 退回次数
       ,t5.back_psn          as 退回人
       ,t6.empe_nm            AS 最终审批人
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
right join(
    select t1.cst_id
        ,t2.ctr_serno
        ,t2.rel_serno
    from SJXQ_SJ2025060931_CST_01               t1
    inner join edw.dim_bus_loan_ctr_bse_inf_dd  t2
    on t1.ctr_serno=t2.ctr_serno
    and t2.dt='@@{yyyyMMdd}'
)t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
left join (
    SELECT instance_id              --流程实例id|c32
        ,flow_starter               --流程发起者
        ,flow_starter_name          --发起者姓名
        ,start_time                 --流程发起时间
        ,org_id                     --发起人机构id
        ,biz_id                     --业务流水号
        ,flow_id                                  --流程id|c32
        ,flow_name                                --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='@@{yyyyMMdd}'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t2.sys_reg_psn_id=t4.flow_starter
and t4.rn=1
left join(
    select t1.instance_id
        ,count(1) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd t1
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.user_comment regexp '退回'
    group by t1.instance_id
)t5 on t4.instance_id=t5.instance_id
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ2025060931_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ2025060931_CST_03 as
SELECT t2.客户号
    ,t2.客户名称
    ,t2.合同号
    ,t2.产品名称
    ,t2.申请日期
    ,t2.最终审批人
    ,t2.退回次数
    ,t2.退回人
from SJXQ_SJ2025060931_CST_02  t2
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025060931_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct rel_serno) custs
from SJXQ_SJ2025060931_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025060931_CST_03
;
/*
01	1589	1589
02	1589	1589
03	1589	1589
*/
SElECT *
from lab_bigdata_dev.SJXQ_SJ2025060931_CST_03
where 最终审批人 is null
;
***滑茹瑶_SJ2025073141_舟山分行风险贷款分析.sql
-- 滑茹瑶_SJ2025073141_舟山分行风险贷款分析
-- 1.截止2025年6月，舟山分行所有支行社区内近一年新发生风险高于社区外的支行有哪些？分别是哪些社区？这些高风险社区里近一年新发生风险的客户清单帮忙拉取以下（分社区拉取），并帮忙区分每个社区高风险的前三大客群类型、高风险的产品类型是什么？另外，帮我拉取非主推社区风险高主要是哪写社区、哪家支行
-- 2.截止2025.6，舟山分行(0,50万]业务近一年新发生率6.17%，本年新发生风险贷款率为2.66%，排名第一高，需要帮我取数：50万及以下近一年出险业务中，城南支行和金塘支行主要是什么产品、什么客群、经营性贷款还是消费性贷款
-- 3.截止2025.6，舟山分行消费性出险贷款中，主要是什么类型的产品，主要是哪个社区，管户机构和管户人是谁
-- 4.截止2025.6，舟山分行泰e贷业务出险主要集中在哪些行业、哪个社区、哪个管户人（前三大）；随贷通卡出险主要集中在哪个行业、行个社区、哪个管户人（前三大）
支行社区内近一年新发生风险高于社区外的支行?
有哪些？分别是哪些社区？
高风险社区
近一年新发生风险的客户?出险日期?
客群类型:八大客群
产品类型？产品名称？
非主推社区？
(0,50万]业务？当前授信客户的授信金额？
出险业务？借据
select is_yr_new_hpn                            --是否年度新发生
	,substr(hpn_rsk_date,1,4) as year_                             --出险日期
	,is_rsk_loan                              --是否风险贷款
    ,count(1) cnt
from adm_rsk.adm_rsk_apl_inter_all  t1 --风险集市应用表-资产质量日常监测源表
where t1.dt='20250731'
group by is_yr_new_hpn,year_,is_rsk_loan***滕超_SJ2025032026_账户资料检查.sql
﻿/*
明确数据日期，数据范围，以及取数口径等；例如，截止xx日期，xx分行xx数据；
对公活期开户清单（账户状态：所有，剔除销户状态），剔除保证金等虚户
区间：19930101--﹣至今
开户机构：台州分行营业部
数据需求字段
开户日期、开户机构、开户柜员、账户名称、客户账号、子账户序号、负债账号、客户号、客户账号类型、存款种类、开销户标志、主附标识
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2025032026_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032026_CST_01 AS
select t1.dep_act_id                               --存款账号|C32
	,t1.cst_act_id                               --客户账号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.act_nm                                   --账户名称|C300
	,t1.opn_org                                  --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
	,t1.act_opn_tlr                              --开户柜员编号|C10
    ,t4.empe_nm as act_opn_tlr_nm
	,t1.act_dstr_act_dt                          --销户日期|C8
	,t1.prod_id                                  --存款产品代码|C24
	,t1.cst_tp                                   --所属客户类型代码|C1
	,t1.lbl_prod_typ_cd                          --存款产品类型代码|C1
	,t1.dep_cls_cd                               --存款种类|C4
    ,c2.cd_val_dscr     as dep_cls_nm
	,t1.act_sts_cd                               --存款账户状态代码|C1
	,t1.stl_act_ind                              --结算账户标志|C1
	,t1.act_ctg_cd_1                             --账户分类代码1|C32
	,t1.act_ctg_cd_2                             --账户分类代码2|C32
	,t1.act_ctg_cd_3                             --账户分类代码3|C110
    ,c1.pd_cmt
    ,decode(T1.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结' ,'F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
    ,decode(t1.ACT_CTG_CD_2,'301','I类户','302','II类户','303','III类户') act_typ
        WHEN T2.mrgn_act_id IS not NULL THEN 2 --承兑保证金
        when t1.ACT_CTG_CD_1 IN ( '0501' , '0508' , '0509' , '0512' , '0513' , '0601' , '0602' , '0603' , '0606' , '0607' , '0610' , '0612' , '0903' , '0909' , '0502' , '0503' , '0504' , '0505' , '0506' , '0507' , '0510' , '0514' , '0604' , '0605' , '0608' , '0609' , '0905' , '0907' ) then 4 --剔除保证金
        when t1.ACT_CTG_CD_2 IN ( '014' , '037' , '038' , '039' , '040' , '035' , '036' , '041' , '042' ) then 5
        ELSE 0 END AS is_bzj_act --存款账户类型：1活期，2定期，3保证金，4靠档类，5发行类，6通知类，7其他
    ,t3.brc_org_nm
    ,t3.sbr_org_nm
    ,t3.org_nm
from edw.dws_bus_dep_act_inf_dd             T1  --存款账户信息汇总
LEFT join edw.dim_bus_dep_pd_bas_inf_dd     c1 --存款产品基础信息表
on t1.prod_id=c1.pd_id
and c1.dt=t1.dt
LEFT JOIN edw.dwd_bus_bill_acc_mrgn_inf_dd  T2
ON t1.cst_act_id = T2.mrgn_act_id
AND T1.DT = T2.dt -- 承兑保证金信息
left join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t1.opn_org=t3.org_id
and t3.dt=t1.dt
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C2
ON t1.dep_cls_cd = C2.CD_VAL
AND C2.DT = t1.dt
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t1.act_opn_tlr=t4.empe_id
and t4.dt=t1.dt
where T1.dt = '@@{yyyyMMdd}'
and t1.lbl_prod_typ_cd='0'  --活期
and t1.ACT_STS_CD<>'C' --剔除销户
-- and t1.opn_org = '330107400'    --开户机构编号  台州分行营业部
and t3.sbr_org_nm='台州分行营业部'
AND T1.OPN_DT between '19930101' AND '@@{yyyyMMdd}'     --开户日期
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032026_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032026_CST_02 AS
SELECT  t1.dep_act_id      AS 存款账号
       ,t1.cst_act_id      AS 客户账号
       ,t3.sub_act_seq_nbr AS 子账户序号
       ,t3.main_act_id_ind AS 主账号标志
       ,t1.cst_id          AS 客户号
       ,t2.cst_chn_nm      AS 客户姓名
       ,t1.act_nm          AS 账户名称
       ,t1.org_nm          AS 开户机构
       ,t1.opn_dt          AS 开户日期
       ,t1.act_opn_tlr_nm  AS 开户柜员
       ,t1.act_dstr_act_dt AS 销户日期
       ,t1.dep_cls_nm      AS 存款种类
       ,t1.stl_act_ind     AS 结算账户标志
       ,t1.pd_cmt          AS 存款产品说明
       ,t1.act_sts         AS 存款账户状态
       ,t1.act_typ         AS 账户分类2
       ,c1.cd_val_dscr     AS 客户账户类型
       ,t1.brc_org_nm
       ,t1.sbr_org_nm
from SJXQ_SJ2025032026_CST_01       t1
left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_dep_act_cst_act_rel_dd    t3 --客户账户存款账户关联信息
on t1.cst_act_id=t3.cst_act_id
and t1.dep_act_id=t3.dep_act_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_bus_dep_cst_act_inf_dd	    t4  --客户存款账户信息
on t1.cst_act_id=t4.cst_act_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON t4.cst_act_typ_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.is_bzj_act=0  --剔除保证金账户
;
SElECT '02' seq, *
from SJXQ_SJ2025032026_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2025032026_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ2025032026_CST_02
;
/*
01	2094	2094
02	1487	1487
*/***潘滔_SJ20250306141_卡获取客户号.sql
﻿-- 管护机构	客户名称	客户经理	联系方式
DROP   TABLE IF EXISTS SJXQ_SJ20250306141_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250306141_CST_01
(
    seq          bigint COMMENT ''
    ,card_id      string COMMENT ''
    ,card_nm     string COMMENT ''
)
;
insert into SJXQ_SJ20250306141_CST_01
values (1,'6214800800020000509','靓号成长乐卡'),
    (2,'6214800800820190117','靓号成长乐卡'),
    (3,'6214800801019650703','靓号成长乐卡2'),
    (4,'6214800801020190522','靓号成长乐卡2'),
    (5,'6214800801120120604','靓号成长乐卡2'),
    (6,'6214800801820190113','靓号成长乐卡2'),
    (7,'6214800801820210413','靓号成长乐卡2'),
    (8,'6214806601001398132','泰隆借记IC卡(上海)'),
    (9,'6214808801002461792','泰隆借记IC卡(浙江)'),
    (10,'6214808801002462683','泰隆借记IC卡(浙江)'),
    (11,'6214808801002474464','泰隆借记IC卡(浙江)'),
    (12,'6214808801002475073','泰隆借记IC卡(浙江)'),
    (13,'6214808801002475628','泰隆借记IC卡(浙江)'),
    (14,'6214808801002475917','泰隆借记IC卡(浙江)'),
    (15,'6214808801002477723','泰隆借记IC卡(浙江)'),
    (16,'6214808801002478242','泰隆借记IC卡(浙江)'),
    (17,'6214808801002489348','泰隆借记IC卡(浙江)'),
    (18,'6214808801002490338','泰隆借记IC卡(浙江)'),
    (19,'6214808801002490445','泰隆借记IC卡(浙江)'),
    (20,'6214808801002491567','泰隆借记IC卡(浙江)'),
    (21,'6214808801002492292','泰隆借记IC卡(浙江)'),
    (22,'6214808801002492680','泰隆借记IC卡(浙江)'),
    (23,'6214808801002492995','泰隆借记IC卡(浙江)'),
    (24,'6214808801002493639','泰隆借记IC卡(浙江)'),
    (25,'6214808801002493654','泰隆借记IC卡(浙江)'),
    (26,'6214808801002508519','泰隆借记IC卡(浙江)'),
    (27,'6214808801002508915','泰隆借记IC卡(浙江)'),
    (28,'6214808801002509897','泰隆借记IC卡(浙江)'),
    (29,'6214808801002509970','泰隆借记IC卡(浙江)'),
    (30,'6214808801002511372','泰隆借记IC卡(浙江)'),
    (31,'6214808801002511703','泰隆借记IC卡(浙江)'),
    (32,'6214808801002512305','泰隆借记IC卡(浙江)'),
    (33,'6214808801002513378','泰隆借记IC卡(浙江)'),
    (34,'6214808801002513451','泰隆借记IC卡(浙江)'),
    (35,'6214808801002513519','泰隆借记IC卡(浙江)'),
    (36,'6214808801002522692','泰隆借记IC卡(浙江)'),
    (37,'6214808801002527576','泰隆借记IC卡(浙江)'),
    (38,'6214808801002529499','泰隆借记IC卡(浙江)'),
    (39,'6214808801005358268','泰隆借记IC卡(浙江)'),
    (40,'6214808801005360306','泰隆借记IC卡(浙江)'),
    (41,'6214808801005360371','泰隆借记IC卡(浙江)'),
    (42,'6214808801005360520','泰隆借记IC卡(浙江)'),
    (43,'6214808801005360967','泰隆借记IC卡(浙江)'),
    (44,'6214808801005361304','泰隆借记IC卡(浙江)'),
    (45,'6214808801005390386','泰隆借记IC卡(浙江)'),
    (46,'6214808801005391012','泰隆借记IC卡(浙江)'),
    (47,'6214808801005391202','泰隆借记IC卡(浙江)'),
    (48,'6214808801009028230','泰隆借记IC卡(浙江)'),
    (49,'6214808801010660815','泰隆借记IC卡(浙江)'),
    (50,'6214808801011179237','泰隆借记IC卡(浙江)'),
    (51,'6214808801011180094','泰隆借记IC卡(浙江)'),
    (52,'6214808801011180706','泰隆借记IC卡(浙江)'),
    (53,'6214808801016683142','泰隆借记IC卡(浙江)'),
    (54,'6214808811000037312','梦想卡(蓝色借记IC)'),
    (55,'6214808811000038179','梦想卡(蓝色借记IC)'),
    (56,'6214808811000038567','梦想卡(蓝色借记IC)'),
    (57,'6214808811000038625','梦想卡(蓝色借记IC)'),
    (58,'6214808811000038732','梦想卡(蓝色借记IC)'),
    (59,'6214808888008886666','泰隆靓号借记卡'),
    (60,'6214808888586617766','泰隆靓号借记卡'),
    (61,'6214808888858810058','泰隆靓号借记卡'),
    (62,'6214808888883028888','泰隆靓号借记卡'),
    (63,'6214809801000251343','存贷卡'),
    (64,'6214809801000251590','存贷卡'),
    (65,'6214809801001290589','存贷卡'),
    (66,'6214809801001291363','存贷卡'),
    (67,'6214809801001291785','存贷卡'),
    (68,'6214809801001291793','存贷卡'),
    (69,'6214809801003193450','存贷卡'),
    (70,'6214809803000281056','随贷通卡'),
    (71,'6214809803000283011','随贷通卡'),
    (72,'6214809804000034040','随贷通卡'),
    (73,'6214809938000234885','随贷通卡'),
    (74,'6214809938000364401','随贷通卡')
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250306141_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250306141_CST_02 AS
SELECT distinct t1.cst_id,t1.cst_act_id
from edw.dim_bus_dep_cst_act_inf_dd  t1	--客户存款账户信息
INNER JOIN SJXQ_SJ20250306141_CST_01 t2
on t1.cst_act_id=t2.card_id
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250306141_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250306141_CST_03 AS
SELECT  t1.seq                            AS 顺序号
    ,t1.card_id                           AS 卡号
    ,t1.card_nm                           AS 产品描述
    ,t2.cst_id                            AS 客户号
    ,t5.cst_chn_nm                        AS 客户名称
    ,concat(t3.prm_mgr_id, t3.prm_mgr_nm) AS 主管户经理
    ,t4.org_nm                            AS 主管户机构
    ,t5.mbl_nbr                           AS 手机
    ,t5.fml_tel_nbr                       AS 家庭电话
from SJXQ_SJ20250306141_CST_01      t1
left join SJXQ_SJ20250306141_CST_02 t2
on t1.card_id=t2.cst_act_id
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            t5 --客户基础信息汇总表 证件号及到期日
ON t2.cst_id = t5.cst_id
AND t5.dt ='@@{yyyyMMdd}'
;
from SJXQ_SJ20250306141_CST_03
order by 顺序号
;
SElECT '01' seq, count(1) cnt,count(distinct card_id) custs
from SJXQ_SJ20250306141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20250306141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 卡号) custs
from SJXQ_SJ20250306141_CST_03
;
/*
01	74	74
02	74	74
03	74	74
select t1.ctr_serno                                --合同流水号|c32
     ,t1.sdt_crd_no                               --随贷通卡号|c20
     ,t1.sdt_crd_typ_no                           --随贷通卡卡种编号|c32
     ,t1.crd_typ_nm                               --卡种名称|c200
     ,t2.*
from edw.dim_bus_loan_ctr_sdt_loan_dd   t1      --合同随贷通贷款信息
left join edw.dim_bus_loan_ctr_bse_inf_dd  t2
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
where dt='@@{yyyyMMdd}'
and t1.sdt_crd_no='6214809938000364401'
;
*/***王善民_SJ2025031471_合同审批信息.sql
﻿-- 标准化代码
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_01 as
SELECT  t1.usc_aply_serno     AS 用信申请流水号
       ,t1.ahn_ltr_aply_serno AS 授用信申请流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.cst_typ_cd         AS 客户类型代码
       ,t1.prd_no             AS 产品编号
       ,t1.pd_nm              AS 产品名称
       ,t1.hpn_typ_cd         AS 发生类型代码
       ,t1.apl_amt            AS 申请金额
       ,t1.aply_epsr_amt      AS 申请敞口金额
       ,t1.grnt_mod_colc_cd   AS 担保方式集合代码
       ,t1.apl_dt             AS 申请日期
       ,t1.rmk                AS 备注
       ,t1.mgr_id             AS 管户人工号
       ,t1.mgr_org_id         AS 管户机构编号
       ,t1.exec_intr_rat      AS 执行利率
       ,t2.sam_rsk_ctrl_no    AS 同一风险控制号
       ,t2.csld_cr_lmt        AS 统一授信额度
       ,t2.csld_cr_xpos       AS 统一授信敞口
       ,t2.sys_reg_psn_id     AS 系统登记人
       ,t3.ctr_serno          AS 合同号
       ,t3.ctr_bgn_dt         AS 合同起始日期
       ,t3.ctr_mtu_dt         AS 合同到期日期
       ,t3.ctr_amt            AS 合同金额
       ,t3.ctr_bal            AS 合同余额
       ,h1.empe_nm            AS 经办人
       ,h2.pos_nm             AS 经办人职位
       ,t4.flow_starter       AS 流程发起者
       ,t4.flow_starter_name  AS 发起者姓名
       ,t4.start_time         AS 流程发起时间
       ,t4.org_id             AS 发起人机构id
       ,t4.biz_id             AS 业务流水号
       ,t5.back_cnt           AS 流程退回次数
       ,t6.empe_id            AS 最终审批人工号
       ,t6.empe_nm            AS 最终审批人姓名
       ,t6.node_nm            AS 最终审批人岗位
       ,t6.user_comment       AS 最终审批人用户评价
       ,t6.aprv_drtn          AS 最终审批人审批时长
       ,t6.cmt_tm             AS 最终审批人审批时间
       ,t9.aprv_id            AS 客户经理工号
       ,t9.aprv_nm            AS 客户经理姓名
       ,t10.aprv_id           AS 团队审查岗工号
       ,t10.aprv_nm           AS 团队审查岗姓名
       ,t10.aprv_drtn_min     AS 团队审查岗审批时长_分
       ,t10.user_comment      AS 团队审查岗审批意见
       ,t10.aprv_cnt          AS 团队审查岗审批次数
       ,t10.back_cnt          AS 团队审查岗退回次数
       ,t11.aprv_id           AS 团队总经理工号
       ,t11.aprv_nm           AS 团队总经理姓名
       ,t11.aprv_drtn_min     AS 团队总经理审批时长_分
       ,t11.user_comment      AS 团队总经理审批意见
       ,t11.aprv_cnt          AS 团队总经理审批次数
       ,t11.back_cnt          AS 团队总经理退回次数
       ,t12.aprv_id           AS 审批支行行长工号
       ,t12.aprv_nm           AS 审批支行行长姓名
       ,t12.aprv_drtn_min     AS 审批支行行长审批时长_分
       ,t12.user_comment      AS 审批支行行长审批意见
       ,t12.aprv_cnt          AS 审批支行行长审批次数
       ,t12.back_cnt          AS 审批支行行长退回次数
       ,t13.aprv_id           AS 市场部审查岗工号
       ,t13.aprv_nm           AS 市场部审查岗姓名
       ,t13.aprv_drtn_min     AS 市场部审查岗审批时长_分
       ,t13.user_comment      AS 市场部审查岗审批意见
       ,t13.aprv_cnt          AS 市场部审查岗审批次数
       ,t13.back_cnt          AS 市场部审查岗退回次数
       ,t14.aprv_id           AS 市场部总经理工号
       ,t14.aprv_nm           AS 市场部总经理姓名
       ,t14.aprv_drtn_min     AS 市场部总经理审批时长_分
       ,t14.user_comment      AS 市场部总经理审批意见
       ,t14.aprv_cnt          AS 市场部总经理审批次数
       ,t14.back_cnt          AS 市场部总经理退回次数
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD	t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
and t3.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            h1 --员工信息汇总
on  t3.hdl_opr_id=h1.empe_id
and h1.dt=t1.dt
left join edw.dim_hr_org_job_inf_dd	        h2 --职位信息
on  h1.pos_enc=h2.pos_id
and h2.dt=t1.dt
inner join (
    SELECT t4.instance_id
        ,t4.flow_starter              --流程发起者
       ,t4.flow_starter_name          --发起者姓名
       ,t4.start_time                 --流程发起时间
       ,t4.org_id                     --发起人机构id
       ,t4.biz_id                     --业务流水号
       ,ROW_NUMBER() over(partition by t4.biz_id order by t4.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where t4.dt='@@{yyyyMMdd}'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t4.rn=1
left join(
    select instance_id
        ,sum(case when user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd
    where dt='@@{yyyyMMdd}'
    group by instance_id
)t5 on t4.instance_id=t5.instance_id
left join(
    select t1.instance_id
        ,t3.empe_id                                  --用户id
        ,t3.empe_nm
        ,t1.node_nm                                  --节点名称
        ,t1.user_comment                             --用户评价|c1000
        ,t1.aprv_drtn	            --审批时长
        ,t1.start_time  as cmt_tm
        ,row_number() over(partition by t1.instance_id order by t1.start_time desc) rn
    from edw.dwd_bus_loan_n_wf_comment_his_dd   t1
    left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
)t6 on t4.instance_id=t6.instance_id
and t6.rn=1     --实例最终审批人
left join(
    SELECT t1.instance_id,t1.node_nm
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm regexp '客户经理'
    GROUP BY instance_id,node_nm
)t9 on t4.instance_id=t9.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队审查岗'
    GROUP BY instance_id,node_nm
)t10 on t4.instance_id=t10.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='团队总经理'
    GROUP BY instance_id,node_nm
)t11 on t4.instance_id=t11.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='支行行长'
    GROUP BY instance_id,node_nm
)t12 on t4.instance_id=t12.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='村行市场部审查岗'
    GROUP BY instance_id,node_nm
)t13 on t4.instance_id=t13.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='@@{yyyyMMdd}'
    and t1.node_nm='村行市场部总经理'
    GROUP BY instance_id,node_nm
)t14 on t4.instance_id=t14.instance_id
where t1.dt='@@{yyyyMMdd}'
;
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_02 as
select col_1    as cst_id
    ,col_2      as cst_nm
    ,col_3      as ctr_serno
from qbi_file_20250317_14_28_55_0
where pt<>''
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_03 as
SELECT  t1.cst_id    AS 客户号
       ,t1.cst_nm    AS 客户名称
       ,t1.ctr_serno AS 合同号
       ,t2.经办人
       ,t2.经办人职位
       ,t2.最终审批人工号
       ,t2.最终审批人姓名
       ,t2.最终审批人岗位
       ,t2.客户经理工号
       ,t2.客户经理姓名
       ,t2.团队审查岗工号
       ,t2.团队审查岗姓名
       ,t2.团队总经理工号
       ,t2.团队总经理姓名
       ,t2.审批支行行长工号
       ,t2.审批支行行长姓名
       ,t2.市场部审查岗工号
       ,t2.市场部审查岗姓名
       ,t2.市场部总经理工号
       ,t2.市场部总经理姓名
from SJXQ_SJ2025031471_CST_02       t1
left join SJXQ_SJ2025031471_CST_01  t2
on t1.cst_id=t2.客户号
and t1.ctr_serno=t2.合同号
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_04 as
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_nm     AS 客户名称
       ,t1.ctr_serno  AS 合同号
       ,h1.empe_nm    AS 经办人
       ,h2.pos_nm     AS 经办人职位
       ,t3.ahn_ltr_aply_serno
       ,t4.biz_id
       ,t4.flow_id
       ,t4.flow_name  AS 流程名称
       ,t4.start_time AS 流程发起时间
       ,t4.instance_id
        ,ROW_NUMBER() over(partition by t3.ahn_ltr_aply_serno order by t4.start_time desc) rn
from SJXQ_SJ2025031471_CST_02               t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            h1 --员工信息汇总
on  t2.hdl_opr_id=h1.empe_id
and h1.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_job_inf_dd	        h2 --职位信息
on  h1.pos_enc=h2.pos_id
and h2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_lmt_aply_biz_dd  t3 --用信方案
on t2.rel_serno=t3.usc_aply_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
on t3.ahn_ltr_aply_serno=t4.biz_id
and t4.dt='@@{yyyyMMdd}'
;
-- 审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_05 as
SELECT t1.*
    ,ROW_NUMBER() over(partition by t1.instance_id order by t1.start_time asc) rn_asc
from(
    SELECT t4.instance_id
            ,t5.user_id         --用户id
            ,t6.empe_nm         --审批人名称
            ,t5.node_nm         --审批节点
            ,t5.start_time	    --审批时间
            ,t5.user_comment	--用户评价
            ,ROW_NUMBER() over(partition by t4.instance_id,t5.node_nm order by t5.start_time desc) rn
    from SJXQ_SJ2025031471_CST_04                   t4
    INNER JOIN edw.dwd_bus_loan_n_wf_comment_his_dd t5 --流程审批意见历史
    on  t4.instance_id=t5.instance_id
    and t5.dt='@@{yyyyMMdd}'
    left join edw.dws_hr_empe_inf_dd                t6 --员工信息汇总
    on  substr(t5.user_id,1,6)=t6.empe_id
    and t6.dt='@@{yyyyMMdd}'
    where t4.rn=1   --业务最新实例流程
)t1 where t1.rn=1   --最后审批流
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031471_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031471_CST_06 as
SELECT  t4.客户号
       ,t4.客户名称
       ,t4.合同号
       ,t4.经办人
       ,t4.经办人职位
       ,t4.流程名称
       ,t5.user_id    AS 用户id
       ,t5.empe_nm    AS 审批人名称
       ,t5.node_nm    AS 审批节点
       ,t5.start_time AS 审批时间
       ,t5.rn_asc     AS 审批顺序
from SJXQ_SJ2025031471_CST_04       t4
left join SJXQ_SJ2025031471_CST_05  t5
on  t4.instance_id=t5.instance_id
where t4.rn=1
;
select *
from SJXQ_SJ2025031471_CST_03
;
from SJXQ_SJ2025031471_CST_06
order by 合同号,审批顺序
;
SElECT '01' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025031471_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025031471_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025031471_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025031471_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025031471_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2025031471_CST_06
;
/*
01	597428	573310
02	3377	3377
03	3377	3377
04	3378	3377
05	12632	3108
06	12901	3377
结果表3：SJXQ_SJ2025031471_CST_03 标准化代码跑的合同维度，只包含 客户经理、团队审查岗、团队总经理、支行行长、村行市场部审查岗、村行市场部总经理
结果表6：SJXQ_SJ2025031471_CST_06 合同+审批人维度 比较全
*/
***王晗_SJ2025021371_合同担保人信息.sql
﻿-- 合同+担保人维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025021371_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021371_CST_01 AS
SELECT  T1.CST_ID
       ,T1.cst_nm           --客户名称
       ,T1.ctr_serno        --合同流水号
       ,t1.ctr_amt          --合同金额
       ,t1.ctr_bal          --合同余额
       ,t1.mgr_org_id       --管户机构号
       ,t5.reg_adr          --户籍地址
       ,t2.担保合同数
       ,T2.WRNT_CST_ID      --担保人客户号
       ,T2.WRNT_CST_NM      --担保人客户名称
       ,T3.rel_typ_MZ       --担保人与借款人关系
       ,CASE WHEN T5.sam_rsk_ctrl_id <> '' AND T5.sam_rsk_ctrl_id = T6.sam_rsk_ctrl_id THEN '是'  ELSE '否' END AS 担保人是否纳入同一风险控制号
       ,CASE WHEN T5.sam_rsk_ctrl_id <> '' THEN T5.sam_rsk_ctrl_id ELSE T5.CST_ID END                        AS 同一风险控制号
       ,PO.rel_cst_id                                                                                         AS 配偶客户号
       ,T7.cst_chn_nm                                                                                             AS 配偶客户名称
       ,case when T2.WRNT_CST_ID=PO.rel_cst_id and nvl(t2.wrnt_cst_id,'')<>'' then '是'  ELSE '否' END AS 配偶是否担保人
FROM edw.dim_bus_loan_ctr_bse_inf_dd T1
INNER JOIN (
    SELECT BUS_CTR_ID
        ,count(distinct grnt_ctr_id)     as 担保合同数
       ,WRNT_CST_ID      --担保人客户号
       ,WRNT_CST_NM      --担保人客户名称
    from edw.dws_bus_grnt_prsn_inf_dd
    where DT = '@@{yyyyMMdd}'
    GROUP BY BUS_CTR_ID,WRNT_CST_ID,WRNT_CST_NM
) T2 --担保人汇总信息
ON T1.ctr_serno = T2.BUS_CTR_ID
LEFT JOIN
(
	SELECT  TT.CST_ID
	       ,TT.rel_cst_id
	FROM
	(
		SELECT  T1.cst_id
		       ,T1.rel_cst_id
		       ,T1.rel_typ
		       ,T4.cd_val_dscr AS rel_typ_MZ
		FROM edw.loan_cst_rel T1
		LEFT JOIN edw.dwd_code_library_dd T4 -- 码值表
		ON T1.rel_typ = T4.cd_val
        AND T4.tbl_nm = 'DIM_BUS_LOAN_FNC_STAT_DETAIL_DATA_ASS_INTDGBL_DD'
        AND T4.fld_nm = 'REL_TYP'
        AND T4.DT = '@@{yyyyMMdd}'
		WHERE T1.DT = '@@{yyyyMMdd}'
		AND T1.del_ind <> '1' --删除标识
		AND T1.vld_ind <> '0' --有效标识
	) TT
	GROUP BY  TT.CST_ID
	         ,TT.rel_cst_id
) T3 --关系人信息
ON T1.cst_id = T3.cst_id
AND T2.WRNT_CST_ID = T3.rel_cst_id
LEFT JOIN edw.dws_cst_bas_inf_dd T5 --客户基础信息汇总表
ON T1.cst_id = T5.cst_id
AND T5.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dws_cst_bas_inf_dd T6 --客户基础信息汇总表
ON T2.WRNT_CST_ID = T6.cst_id
AND T6.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_rel PO
ON T1.cst_id = PO.cst_id
AND PO.rel_typ = '0301' --配偶
AND PO.DT = '@@{yyyyMMdd}'
AND PO.del_ind <> '1' --删除标识
AND PO.vld_ind <> '0' --有效标识
LEFT JOIN edw.dws_cst_bas_inf_dd T7 --客户基础信息汇总表
ON PO.rel_cst_id = T7.cst_id
AND T7.DT = '@@{yyyyMMdd}'
WHERE T1.DT = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 合同维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025021371_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021371_CST_02 AS
SELECT  T1.CST_ID
       ,T1.cst_nm     --客户名称
       ,T1.ctr_serno  --合同流水号
       ,t1.ctr_amt    --合同金额
       ,t1.ctr_bal    --合同余额
       ,t1.mgr_org_id --管户机构号
       ,t5.reg_adr    --户籍地址
       ,T2.担保人
       ,CASE WHEN T5.sam_rsk_ctrl_id <> '' THEN T5.sam_rsk_ctrl_id  ELSE T5.CST_ID END AS 同一风险控制号
       ,PO.rel_cst_id                                                                  AS 配偶客户号
       ,T7.cst_chn_nm                                                                      AS 配偶客户名称
FROM edw.dim_bus_loan_ctr_bse_inf_dd T1
INNER JOIN (
    select BUS_CTR_ID
    from edw.dws_bus_grnt_prsn_inf_dd t1
    where DT = '@@{yyyyMMdd}'
    group by BUS_CTR_ID
) T2 --担保人汇总信息
ON T1.ctr_serno = T2.BUS_CTR_ID
LEFT JOIN edw.dws_cst_bas_inf_dd T5 --客户基础信息汇总表
ON T1.cst_id = T5.cst_id
AND T5.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_rel PO
ON T1.cst_id = PO.cst_id
AND PO.rel_typ = '0301' --配偶
AND PO.DT = '@@{yyyyMMdd}'
AND PO.del_ind <> '1' --删除标识
AND PO.vld_ind <> '0' --有效标识
LEFT JOIN edw.dws_cst_bas_inf_dd T7 --客户基础信息汇总表
ON PO.rel_cst_id = T7.cst_id
AND T7.DT = '@@{yyyyMMdd}'
WHERE T1.DT = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 输出结果
-- 客户号  客户姓名  合同流水号  贷款金额  贷款余额  客户户籍地   对应合同项下担保人客户号  对应合同项下担保人姓名
DROP   TABLE IF     EXISTS SJXQ_SJ2025021371_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021371_CST_03 AS
SELECT  CST_ID    AS 客户号
       ,cst_nm    AS 客户名称
       ,ctr_serno AS 合同流水号
       ,ctr_amt   AS 合同金额
       ,ctr_bal   AS 合同余额
       ,reg_adr   AS 户籍地址
       ,担保人
FROM SJXQ_SJ2025021371_CST_02
WHERE mgr_org_id LIKE '6162%' --陕西眉县泰隆村镇银行
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025021371_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno,wrnt_cst_id) custs
from SJXQ_SJ2025021371_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025021371_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025021371_CST_03
;
/*
01	1222270	1222270
02	735371	735371
03	3001	2256
*/***王晗_SJ20250427136_眉县村行e账簿客户信息采集情况.sql
/*
眉县村行全量e账簿客户的信息采集情况
全量e账簿客户：
个人客户：个人10要素：姓名、证件类型、证件号码、证件到期日、客户国籍、性别、客户职业、居住地址、户籍地址、手机号码；
企业客户：企业22要素：客户名称、证件类型、证件号码、证件到期日、客户国籍、经营范围、注册地址、
法定代表人、法定代表人证件类型、法定代表人证件号、法定代表人证件到期日、
实际控制人名称、实际控制人证件类型、实际控制人证件号码、实际控制人证件到期日、
受益所有人名称、受益所有人证件类型、受益所有人证件号码、受益所有人证件到期日、受益所有人地址、受益所有人关系类型、受益所有人直接持股比例。
联网核查、人脸识别、绑定一类户、连续6/12/24个月无交易的e账簿是否被管控、证件已过期的e账簿是否被管控；
是否持续对企业注销、法人变更的客户进行管控；e账簿客户已在ECIF建档；
资金交易的IP、MAC地址数据登记是否完整。同一证件开立e账簿数量。
*/
-- 截止统计日 E账簿
DROP   TABLE IF     EXISTS SJXQ_SJ20250427136_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250427136_CST_01 AS
SELECT distinct t2.cst_id
FROM edw.DIM_BUS_CHNL_VTL_ACT_INF_DD        t1 -- 虚拟平台账户信息
inner JOIN edw.dim_cst_bas_inf_dd           T2
ON  t1.doc_nbr = T2.prm_doc_nbr
AND T2.dt = t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  t2.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='陕西眉县泰隆村镇银行'
WHERE t1.DT = '@@{yyyyMMdd}'
;
-- 个人10要素
DROP   TABLE IF     EXISTS SJXQ_SJ20250427136_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250427136_CST_02 AS
select t1.cst_id
    ,t1.cst_chn_nm                               --客户姓名|C200
	,t1.doc_nbr                                  --证件号码|C60
	,t1.doc_typ_cd                               --证件类型代码|C5
    ,c1.cd_val_dscr     as doc_typ_nm
	,t1.doc_mtu_dt                               --证件到期日期|C8
	,t1.mbl_nbr                                  --手机|C32
	,t1.fml_tel_nbr                              --家庭电话|C32
	,case when length(t1.mbl_nbr)>=7 or length(t1.fml_tel_nbr)<=3 then t1.mbl_nbr
        else t1.fml_tel_nbr end as mbl_nbr_mod   --手机|C32
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t1.fml_adr                                  --家庭地址|C256
	,decode(t3.gdr_cd,'1','男','2','女','未知') as gdr_nm --性别代码|C1
	,t3.ntn_cd                                   --国籍代码|C3
    ,c2.cd_val_dscr     as ntn_nm
	,t3.ocp_cd                                   --职业代码|C5
    ,c3.cd_val_dscr     as ocp_nm
    ,t3.mbl_nbr         as mbl_nbr2                --手机|C32
	,t3.fml_tel_nbr     as fml_tel_nbr2            --家庭电话|C32
	,t3.reg_adr         as reg_adr2                --户籍地址|注册地址|C256
	,t3.fml_adr         as fml_adr2                --家庭地址|C256
from edw.dws_cst_bas_inf_dd             t1 --客户基础信息汇总表
inner join SJXQ_SJ20250427136_CST_01    t2
on t1.cst_id=t2.cst_id
left join edw.dws_cst_idv_bas_inf_dd    t3 --个人客户基本信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join edw.dwd_code_library_dd       c1
on t1.doc_typ_cd = c1.cd_val
and c1.dt=t1.dt
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C2
ON  t3.ntn_cd = C2.CD_VAL
AND C2.DT = t1.dt
LEFT JOIN edw.dwd_code_library_dd       C3
ON T3.ocp_cd = C3.cd_val
AND C3.dt= t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.cst_typ_cd='1'   --'对私'
;
-- 企业22要素
DROP   TABLE IF     EXISTS SJXQ_SJ20250427136_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250427136_CST_03 AS
select t1.cst_id
    ,t1.cst_chn_nm                               --客户姓名|C200
	,t1.doc_nbr                                  --证件号码|C60
	,t1.doc_typ_cd                               --证件类型代码|C5
    ,c1.cd_val_dscr     as doc_typ_nm
	,t1.doc_mtu_dt                               --证件到期日期|C8
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t3.reg_cnr_cd                               --注册国家代码|C3
    ,c2.cd_val_dscr     as reg_cnr_nm
	,t3.opr_scp_dscr                             --经营范围描述|C3000
	,t4.lgp_cst_id                               --对公客户法人客户号
	,t4.lgp_nm                                   --对公客户法人客户名称
	,t4.lgp_doc_typ_cd                           --对公客户法人证件类型
    ,c3.cd_val_dscr     as lgp_doc_typ_nm
	,t4.lgp_doc_id                               --对公客户法人证件号
	,t4.lgp_doc_mtu_dt                           --对公客户法人证件到期日
from edw.dws_cst_bas_inf_dd             t1 --客户基础信息汇总表
inner join SJXQ_SJ20250427136_CST_01    t2
on t1.cst_id=t2.cst_id
left join edw.dim_cst_entp_bas_inf_dd   t3 --企业客户基本信息
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join edw.dim_cst_entp_lgp_inf_dd   t4 --对公客户法人信息表
on t1.cst_id=t4.cst_id
and t4.dt=t1.dt
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON  t1.doc_typ_cd = C1.CD_VAL
AND C1.DT = t1.dt
left join edw.dwd_code_library_dd       c2
on t3.reg_cnr_cd = c2.cd_val
and c2.dt=t1.dt
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C3
ON  t4.lgp_doc_typ_cd = C3.CD_VAL
AND C3.DT = t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.cst_typ_cd='2'   --'对公'
;
-- 输出结果 个人
DROP   TABLE IF     EXISTS SJXQ_SJ20250427136_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250427136_CST_04 AS
SELECT  cst_id
       ,cst_chn_nm AS 客户姓名
       ,doc_nbr    AS 证件号码
       ,doc_typ_nm AS 证件类型
       ,doc_mtu_dt AS 证件到期日期
       ,gdr_nm     AS 性别
       ,ntn_nm     AS 国籍
       ,ocp_nm     AS 职业
       ,reg_adr    AS 户籍地址
       ,fml_adr    AS 家庭地址
       ,mbl_nbr_mod   AS 手机
from SJXQ_SJ20250427136_CST_02
;
-- 输出结果 对公
DROP   TABLE IF     EXISTS SJXQ_SJ20250427136_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250427136_CST_05 AS
SELECT  t1.cst_id
       ,t1.cst_chn_nm      AS 客户姓名
       ,t1.doc_nbr         AS 证件号码
       ,t1.doc_typ_nm      AS 证件类型
       ,t1.doc_mtu_dt      AS 证件到期日期
       ,t1.reg_cnr_nm      AS 注册国家
       ,t1.opr_scp_dscr    AS 经营范围描述
       ,t1.reg_adr         AS 注册地址
       ,t1.lgp_nm          AS 对公客户法人客户名称
       ,t1.lgp_doc_typ_nm  AS 对公客户法人证件类型
       ,t1.lgp_doc_id      AS 对公客户法人证件号
       ,t1.lgp_doc_mtu_dt  AS 对公客户法人证件到期日
       ,b2.cst_chn_nm      AS 实控人名称
       ,b2.prm_doc_typ_cd  AS 实控人证件类型
       ,b2.prm_doc_nbr     AS 实控人证件号码
       ,b2.prm_doc_mtu_dt  AS 实控人证件到期日
       ,t3.BFI_NAME        AS 受益所有人姓名
       ,t3.CARD_TYPE       AS 受益所有人证件类型
       ,t3.CARD_NO         AS 受益所有人证件号码
       ,t3.CARD_END_DT     AS 受益所有人证件到期日
       ,t3.addr            AS 受益所有人联系地址
       ,c1.cd_val_dscr     AS 受益所有人关系类型
       ,t3.dir_hld_shr_rto AS 受益所有人直接持股比例
from SJXQ_SJ20250427136_CST_03  t1
LEFT JOIN edw.loan_cst_rel a2 --客户关联关系信息
ON t1.cst_id = a2.cst_id
AND a2.dt = '@@{yyyyMMdd}'
AND a2.rel_typ = '0109' --实控人
and LENGTH(a2.rel_cst_id)=10
LEFT JOIN edw.dim_cst_bas_inf_dd b2 --客户基本信息
ON a2.rel_cst_id = b2.cst_id
AND b2.dt = '@@{yyyyMMdd}'
left join adm_upss.adm_upss_aml_t47_beneficiary	t3 --对公客户受益所有人表
on t1.cst_id=substr(t3.party_id, 3, 10)
and t3.dt='@@{yyyyMMdd}'
left join edw.loan_cst_rel    t4
on t1.cst_id=t4.cst_id
and t3.bfi_id=t4.rel_cst_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON  cast(t4.rel_typ as int) = cast(C1.CD_VAL as int)
AND C1.DT = '@@{yyyyMMdd}'
;
-- 个人
SElECT '04' seq, *
from SJXQ_SJ20250427136_CST_04
;
-- 对公
SElECT '05' seq, *
from SJXQ_SJ20250427136_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250427136_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250427136_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250427136_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250427136_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250427136_CST_05
***王梦娜_SJ20250220151_宁波分行反洗钱排查.sql
﻿/*
医药领域腐败问题排查
规则一
1.筛选区间：客户归属为宁波分行的自2023年1月1日开始的交易。
2.交易附言中有&ldquo;随访费&rdquo;或&ldquo;科研费&rdquo;或&ldquo;讲课费&rdquo;或&ldquo;礼金&rdquo;或&ldquo;回扣&rdquo;或&ldquo;返点&rdquo;或&ldquo;推广费&rdquo;或&ldquo;咨询费&rdquo;或&ldquo;服务费&rdquo;或&ldquo;医院&rdquo;或&ldquo;医生&rdquo;或&ldquo;提成&rdquo;或&ldquo;市场管理服务费&rdquo;或&ldquo;药物及医疗设备采购&rdquo;或&ldquo;医疗卫生设施建设&rdquo;或&ldquo;差旅费&rdquo;或&ldquo;赞助费&rdquo;。
规则二
1.筛选区间：客户归属为宁波分行的且账户未全部销户的对私客户。
2.登记的工作单位包含&ldquo;医院&rdquo;或&ldquo;医疗&rdquo;的对私客户。
规则三
1.筛选区间：客户归属为宁波分行的且账户未全部销户的对公客户。
2.2023年1月1日开始同一人代为办理3个以上（含3）公司账户开立业务，这些客户的清单。
规则四
2023年1月1日开始，每年的存现累计金额或取现累计金额大于等于50万元人民币的客户清单（包括已销户的客户）及取现交易流水。
注释：以上4个规则每个规则分别跑数，提取后的数据分别建立文件夹，客户信息放入对公客户表或对私客户表，交易流水格式见EXCL表格。
问题
1. 折美元、人民币 按哪天汇率折算？交易日当天
2. 卡号 是否 同 账号？ 给 存款账号、客户账号
账户类别 i,II类户？ 是的
*资金收付标识 是否是 借贷标志？是的
冲账标识 是否 冲正标志？是
业务名称 空着
以下 匹配网银表 可能会存在缺失？是
业务流水号 匹配 交易流水号、全局流水号 ？ 交易流水号
*/
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_01 as
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C200
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C200
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	,t1.late_upd_tm	                             --最后更新时间|C20
	,t1.glbl_srl_nbr	                         --全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS IP地址
    ,'个人' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
and t4.brc_org_nm = '宁波分行'
where t1.dt BETWEEN '20240101' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_cd = '000000' --交易成功
union all
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C300
	-- ,pmt_org_id                               --付款方网点|C10
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C300
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	-- ,rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	-- ,instr_sts_cd                             --指令状态代码|C2
	,t1.late_upd_tm                              --最后更新时间|C20
	,t1.glbl_srl_nbr	--	全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS mac
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS ip
    ,'企业' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
and t4.brc_org_nm = '宁波分行'
where t1.dt BETWEEN '20240101' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_cd = '000000' --交易成功
;
-- 宁波分行 2023以来交易流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_02 as
SELECT  t1.dtl_seq_nbr                                                                                                                             AS 序号
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),1,10)                                                             AS 交易日期
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),11)                                                               AS 交易时间
       ,T11.sbr_org_nm                                                                                                                             AS 交易行名称
       ,CASE WHEN T2.cst_tp = '1' THEN '个人'
             WHEN T2.cst_tp = '2' THEN '单位' END                                                                                                    AS 公私标识
       ,T2.cst_id                                                                                                                                  --客户号
       ,T4.doc_nbr                                                                                                                                 AS 证件号码
       ,T1.cst_act_id                                                                                                                              AS 客户账号
       ,T1.dep_act_id                                                                                                                              AS 存款账号
       ,T1.act_nm                                                                                                                                  AS 账户名称
       ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1' THEN '个人银行结算账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END                                                                AS 账户类型
       ,CASE WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '301' THEN '1类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '302' THEN '2类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '303' THEN '3类账户' END                                                                      AS 账户类别
       ,CASE WHEN T1.cnt_pty_act_nm <> '' AND T1.cnt_pty_fin_instt_nm = '' AND T1.cnt_pty_fin_instt_typ_cd = '' THEN '支付账户等非银行账户'  ELSE '银行账户' END AS 交易对手方账户类别
       ,T1.cnt_pty_fin_instt_cd                                                                                                                    AS 交易对方行代码
       ,T1.cnt_pty_fin_instt_nm                                                                                                                    AS 交易对方行名称
       ,T1.cnt_pty_cst_act_id                                                                                                                      AS 交易对方账号
       ,T1.cnt_pty_act_nm                                                                                                                          AS 交易对方户名
       ,CASE WHEN T1.crd_and_dbt_ind = 'C' THEN '收'
             WHEN T1.crd_and_dbt_ind = 'D' THEN '付' END                                                     AS 资金收付标识
        ,CASE
                WHEN T1.csh_ind = '0' THEN '现金'
                ELSE '转账'
            END                                                                                  AS 现金转账标识
        ,T1.trx_ccy_cd                                                                        AS 币种
        ,T1.trx_amt                                                                           AS 原币种交易金额
        ,T1.trx_amt / 10000                                                                   AS 原币种交易金额万元
        ,T1.trx_amt * T5.usd_exr                                                              AS 折美元交易金额
        ,T1.trx_amt * T5.usd_exr / 10000                                                      AS 折美元交易金额万元
        ,T1.trx_amt * T5.cny_exr                                                              AS 折人民币交易金额
        ,T1.trx_amt * T5.cny_exr / 10000                                                      AS 折人民币交易金额万元
        ,T1.act_bal                                                                           AS 账户余额
        ,T1.act_bal / 10000                                                                   AS 账户余额万元
        ,CASE WHEN T1.agn_nm <> '' THEN '代理' ELSE '本人' END AS 代理交易标识
        ,T1.agn_nm                                                                            AS 代理人姓名
        ,T1.agn_psn_tel                                                                       AS 代理人联系方式
        ,c1.cd_val_dscr                                                                       AS 代理人身份证件种类
        ,T1.agn_doc_nbr                                                                       AS 代理人身份证件号码
        ,T1.tlr_srl_nbr                                                                       AS 业务流水号
        ,T1.opr_tlr                                                                           AS 柜员号
        ,T1.smr_dscr                                                                          AS 业务名称
        , CASE WHEN T1.rvs_ind = '1' THEN '是' ELSE '否' END AS 冲账标识
        ,T1.cmt                                                                               AS 摘要说明
        ,case when concat(t1.smr_dscr,t1.cmt) regexp '随访费|科研费|讲课费|推广费|医院|医生|市场管理服务费|药物及医疗设备采购|医疗卫生设施建设'
            then 1 else 0 end as is_select
        ,CASE
                WHEN c2.cd_val_dscr RLIKE '网上银行'  THEN '网银'
                WHEN c2.cd_val_dscr RLIKE '手机银行'  THEN '手机银行'
                WHEN c2.cd_val_dscr RLIKE '柜面|柜台' THEN '柜面'
                WHEN c2.cd_val_dscr = 'ATM'       THEN 'ATM机具'
                ELSE '其它'
            END                                                                                  AS 交易方式标识
        ,T9.atm_eqp_id                                                                        AS ATM机具编号
        ,T10.afl_org                                                                          AS ATM机具所属行行号
        ,T1.csh_ind,t1.crd_and_dbt_ind,t1.trx_dt,t1.trx_tm
FROM    edw.dwd_bus_dep_bal_chg_dtl_di    	T1 --存款余额发生明细
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t3.prm_org_id = t6.org_id
and t6.dt ='@@{yyyyMMdd}'
and t6.brc_org_nm = '宁波分行'
LEFT JOIN    edw.dws_cst_bas_inf_dd     	T4 --客户基础信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20240101' and '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd    	c1 -- 码值表
ON      T1.agn_doc_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_CHM_FND_AIP_AGR_INF_DD' -- 基金定投协议信息
AND     c1.fld_nm = 'DOC_TYP_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd 	c2 -- 码值表
ON      T1.trx_chnl_cd = c2.cd_val
AND     c2.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c2.fld_nm = 'TRX_CHNL_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_chnl_atm_trx_srl_di T9 --ATM交易流水
ON      T1.cst_act_id = T9.prm_act_id
AND     T1.tlr_srl_nbr = T9.hst_srl_nbr
AND     T1.trx_dt = T9.trx_loc_dt
AND     T9.DT >= '20240101'
left JOIN (
    SELECT eqp_id,afl_org,dt
        ,ROW_NUMBER() over(partition by eqp_id order by dt desc) rn
    from edw.dim_bus_chnl_atm_eqp_inf_dd --ATM设备基本信息表
    where dt<='@@{yyyyMMdd}'
)T10 ON T9.atm_eqp_id = T10.eqp_id
AND     T10.rn=1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T11
ON      T1.trx_bus_org = T11.org_id
AND     T11.dt = '@@{yyyyMMdd}'
WHERE   T1.dt >= '20240101'
AND     T1.trx_amt > 0
and     t1.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 流水关联
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_03 as
SELECT T1.业务流水号,T1.trx_dt,t1.trx_tm,t1.交易对方户名,t1.交易对方行名称,t1.客户账号,t1.原币种交易金额
    ,T6.glbl_srl_nbr
    ,t7.usr_sbm_tm,t7.rcv_act_nm,t7.rcv_opn_bnk,t7.pmt_act_id,t7.trx_amt
    ,t7.跨境交易标识
    ,t7.交易对方所在国家或地区
    ,t7.MAC或IMEI地址
    ,t7.IP地址
from (
    SELECT DISTINCT 业务流水号,trx_dt,trx_tm,交易对方户名
        ,交易对方行名称,客户账号,原币种交易金额
    from SJXQ_SJ20250220151_CST_02
) t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.业务流水号 = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20240101'
INNER join SJXQ_SJ20250220151_CST_01              t7
ON      T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND     T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_04 as
SELECT  DISTINCT 业务流水号
    ,trx_dt
    ,跨境交易标识
    ,交易对方所在国家或地区
    ,MAC或IMEI地址
    ,IP地址
FROM    SJXQ_SJ20250220151_CST_03
;
-- 规则一
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_05 as
SELECT  t1.序号
        ,t1.交易日期
        ,t1.交易时间
        ,t1.交易行名称
        ,t1.公私标识
        ,T1.cst_id AS 客户号
        ,t1.证件号码
        ,t1.客户账号
        ,t1.存款账号
        ,t1.账户名称
        ,t1.账户类型
        ,t1.账户类别
        ,t1.交易对手方账户类别
        ,t1.交易对方行代码
        ,t1.交易对方行名称
        ,t1.交易对方账号
        ,t1.交易对方户名
        ,t1.资金收付标识
        ,t1.现金转账标识
        ,t1.币种
        ,t1.原币种交易金额
        ,t1.原币种交易金额万元
        ,t1.折美元交易金额
        ,t1.折美元交易金额万元
        ,t1.折人民币交易金额
        ,t1.折人民币交易金额万元
        ,t1.账户余额
        ,t1.账户余额万元
        ,t1.代理交易标识
        ,t1.代理人姓名
        ,t1.代理人联系方式
        ,t1.代理人身份证件种类
        ,t1.代理人身份证件号码
        ,t1.业务流水号
        ,t1.柜员号
        ,t1.业务名称
        ,t1.冲账标识
        ,t1.摘要说明
        ,t2.跨境交易标识
        ,t2.交易对方所在国家或地区
        ,t1.交易方式标识
        ,t2.IP地址
        ,t1.ATM机具编号
        ,t1.ATM机具所属行行号
        ,t2.MAC或IMEI地址
FROM SJXQ_SJ20250220151_CST_02      T1
left join SJXQ_SJ20250220151_CST_04 t2
on t1.业务流水号=t2.业务流水号
and t1.trx_dt=t2.trx_dt
WHERE t1.is_select = 1
;
-- 规则四
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_08 as
select t2.序号
       ,t2.交易日期
       ,t2.交易时间
       ,t2.交易行名称
       ,t2.公私标识
       ,T2.cst_id AS 客户号
       ,t2.证件号码
       ,t2.客户账号
       ,t2.存款账号
       ,t2.账户名称
       ,t2.账户类型
       ,t2.账户类别
       ,t2.交易对手方账户类别
       ,t2.交易对方行代码
       ,t2.交易对方行名称
       ,t2.交易对方账号
       ,t2.交易对方户名
       ,t2.资金收付标识
       ,t2.现金转账标识
       ,t2.币种
       ,t2.原币种交易金额
       ,t2.原币种交易金额万元
       ,t2.折美元交易金额
       ,t2.折美元交易金额万元
       ,t2.折人民币交易金额
       ,t2.折人民币交易金额万元
       ,t2.账户余额
       ,t2.账户余额万元
       ,t2.代理交易标识
       ,t2.代理人姓名
       ,t2.代理人联系方式
       ,t2.代理人身份证件种类
       ,t2.代理人身份证件号码
       ,t2.业务流水号
       ,t2.柜员号
       ,t2.业务名称
       ,t2.冲账标识
       ,t2.摘要说明
        ,t3.跨境交易标识
        ,t3.交易对方所在国家或地区
        ,t2.交易方式标识
        ,t3.IP地址
        ,t2.ATM机具编号
        ,t2.ATM机具所属行行号
        ,t3.MAC或IMEI地址
from(
    select distinct cst_id
    from(
        select cst_id,substr(trx_dt,1,4) as trx_year
            ,sum(case when t1.crd_and_dbt_ind='C' then 折人民币交易金额 else 0 end) as c_cny_amt
            ,sum(case when t1.crd_and_dbt_ind='D' then 折人民币交易金额 else 0 end) as d_cny_amt
        from SJXQ_SJ20250220151_CST_02 t1
        where csh_ind = '0'
        group by cst_id,trx_year
    )t1 where c_cny_amt>=1000000 or d_cny_amt>=1000000
)t1 inner join SJXQ_SJ20250220151_CST_02 t2
on t1.cst_id=t2.cst_id
and t2.crd_and_dbt_ind='D'  --取
and t2.csh_ind = '0'        --现
left join SJXQ_SJ20250220151_CST_04 t3
on t2.业务流水号=t3.业务流水号
and t2.trx_dt=t3.trx_dt
;
-- 规则二
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_06 as
SELECT  T1.cst_id      AS 客户号
    ,t3.cst_chn_nm  AS 客户名称
    ,T2.dep_act_id  AS 存款账号
    ,T2.cst_act_id  AS 客户账号
    ,t1.org_nm      AS 管户机构
    ,t1.prm_mgr_id  AS 管户人工号
    ,t1.prm_mgr_nm  AS 管户人名称
    ,t3.job_unt_nm  AS 工作单位名称
    ,c1.cd_val_dscr AS 职业
    ,datediff(to_date(t3.dt, 'yyyymmdd'), to_date(t3.bth_dt, 'yyyymmdd'), 'yyyy') AS 年龄
    ,T2.opn_dt      AS 开户日期
    ,DECODE(T2.ACT_STS_CD,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结','F','金额冻结'
        ,'G','未启用','H','待启用','I','转营业外收入','Y','预销户')  AS 账户状态
from(
    -- 宁波分行 非全部销户对私客户
    select distinct t1.cst_id                        --客户号|C20
        ,t3.prm_mgr_id,t3.prm_mgr_nm,t4.org_nm
    from edw.dim_bus_dep_act_inf_dd     t1          --存款账户信息
    inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
    on  t1.cst_id = t3.cst_id
    and t3.dt ='@@{yyyyMMdd}'
    inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
    on  t3.prm_org_id = t4.org_id
    and t4.dt ='@@{yyyyMMdd}'
    and t4.brc_org_nm = '宁波分行'
    where t1.dt='@@{yyyyMMdd}'
    and t1.act_sts_cd <> 'c'   --非销户
)t1 inner join edw.dim_bus_dep_act_inf_dd t2 --存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dim_cst_idv_bas_inf_dd     t3 --个人客户基本信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd         c1
on t3.ocp_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
where t3.job_unt_nm regexp '医院|医疗'
;
-- 规则三
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_07 as
SELECT  T1.cst_id             AS 客户号
    ,t3.cst_chn_nm            AS 客户名称
    ,T2.dep_act_id            AS 存款账号
    ,T2.cst_act_id            AS 客户账号
    ,t1.org_nm                AS 管户机构
    ,t1.prm_mgr_id            AS 管户人工号
    ,t1.prm_mgr_nm            AS 管户人名称
    ,t3.borrower_product_desc AS 经营范围
    ,t3.wrk_adr_dtl_inf       AS 工作单位地址或经营所在地地址
    ,t3.m_tel_no              AS 手机
    ,t3.f_tel_no              AS 家庭电话
    ,t3.c_tel_no              AS 公司电话
    ,T2.opn_dt                AS 开户日期
    ,DECODE(T2.ACT_STS_CD,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结','F','金额冻结'
        ,'G','未启用','H','待启用','I','转营业外收入','Y','预销户')  AS 账户状态
    ,t4.代理人名称
    ,t4.代理人证件号码
from(
    -- 宁波分行 非全部销户对私客户
    select distinct t1.cst_id                        --客户号|C20
        ,t3.prm_mgr_id,t3.prm_mgr_nm,t4.org_nm
    from edw.dim_bus_dep_act_inf_dd        t1       --存款账户信息
    inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
    on  t1.cst_id = t3.cst_id
    and t3.dt ='@@{yyyyMMdd}'
    inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
    on  t3.prm_org_id = t4.org_id
    and t4.dt ='@@{yyyyMMdd}'
    and t4.brc_org_nm = '宁波分行'
    where t1.dt='@@{yyyyMMdd}'
    and t1.act_sts_cd <> 'c'   --非销户
)t1 inner join edw.dim_bus_dep_act_inf_dd t2 --存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner JOIN    adm_pub.adm_csm_cbas_org_inf_dd t3 --客户集市-客户基础-对公客户基础信息
ON      t1.cst_id = t3.cst_id
AND     t3.dt = '@@{yyyyMMdd}'
inner join(
    SELECT  t1.cst_act_id
    FROM edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd t1 --代理业务交易登记簿
    inner join(
        select agn_doc_nbr,agn_nm,count(distinct cst_id) custs
        from edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd t1 --代理业务交易登记簿
        where dt = '@@{yyyyMMdd}'
        and trx_dt>='20230101'  --交易日期|c8
        AND agn_bus_typ = '1'   --代理业务类型代码:代理开户
        group by agn_doc_nbr,agn_nm having custs>=3
    )t2 on t1.agn_doc_nbr=t2.agn_doc_nbr and t1.agn_nm=t2.agn_nm
    WHERE t1.dt = '@@{yyyyMMdd}'
    AND t1.agn_bus_typ = '1' --代理业务类型代码:代理开户
    GROUP BY  t1.cst_act_id
)t4 on t2.cst_act_id=t4.cst_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct glbl_srl_nbr) custs
from SJXQ_SJ20250220151_CST_01
where glbl_srl_nbr<>''
union all
SElECT '02' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ20250220151_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 业务流水号,trx_dt) custs
from SJXQ_SJ20250220151_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 业务流水号,trx_dt) custs
from SJXQ_SJ20250220151_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ20250220151_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ20250220151_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ20250220151_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ20250220151_CST_08
;
/*
01	4876069	4876069
02	40226230	40226230
03	5511475	4847885
04	4847885	4847885
05	91144	91144
06	4029	4029
07	323	323
08	15720	15720
*/***王梦娜_SJ20250313121_账户流水调查.sql
-- 客群
DROP   TABLE IF EXISTS SJXQ_SJ20250313121_CST_00 PURGE;
CREATE TABLE           SJXQ_SJ20250313121_CST_00
(
    cst_act_id      string COMMENT ''
)
;
insert into SJXQ_SJ20250313121_CST_00
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250313121_CST_00_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250313121_CST_00_1 as
select distinct t1.cst_act_id,t2.cst_id
from SJXQ_SJ20250313121_CST_00              t1
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
;
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250313121_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250313121_CST_01 as
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C200
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C200
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	,t1.late_upd_tm	                             --最后更新时间|C20
	,t1.glbl_srl_nbr	                         --全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS IP地址
    ,'个人' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
and t4.brc_org_nm = '宁波分行'
inner join SJXQ_SJ20250313121_CST_00_1 t5 on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20100101' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_cd = '000000' --交易成功
union all
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C300
	-- ,pmt_org_id                               --付款方网点|C10
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C300
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	-- ,rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	-- ,instr_sts_cd                             --指令状态代码|C2
	,t1.late_upd_tm                              --最后更新时间|C20
	,t1.glbl_srl_nbr	--	全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS mac
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS ip
    ,'企业' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
and t4.brc_org_nm = '宁波分行'
inner join SJXQ_SJ20250313121_CST_00_1 t5 on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20100101' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_cd = '000000' --交易成功
;
-- 宁波分行 2023以来交易流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250313121_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250313121_CST_02 as
SELECT  t1.dtl_seq_nbr                                                                                                                             AS 序号
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),1,10)                                                             AS 交易日期
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),11)                                                               AS 交易时间
       ,T11.sbr_org_nm                                                                                                                             AS 交易行名称
       ,CASE WHEN T2.cst_tp = '1' THEN '个人'
             WHEN T2.cst_tp = '2' THEN '单位' END                                                                                                    AS 公私标识
       ,T2.cst_id                                                                                                                                  --客户号
       ,T4.doc_nbr                                                                                                                                 AS 证件号码
       ,T1.cst_act_id                                                                                                                              AS 客户账号
       ,T1.dep_act_id                                                                                                                              AS 存款账号
       ,T1.act_nm                                                                                                                                  AS 账户名称
       ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1' THEN '个人银行结算账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END                                                                AS 账户类型
       ,CASE WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '301' THEN '1类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '302' THEN '2类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '303' THEN '3类账户' END                                                                      AS 账户类别
       ,CASE WHEN T1.cnt_pty_act_nm <> '' AND T1.cnt_pty_fin_instt_nm = '' AND T1.cnt_pty_fin_instt_typ_cd = '' THEN '支付账户等非银行账户'  ELSE '银行账户' END AS 交易对手方账户类别
       ,T1.cnt_pty_fin_instt_cd                                                                                                                    AS 交易对方行代码
       ,T1.cnt_pty_fin_instt_nm                                                                                                                    AS 交易对方行名称
       ,T1.cnt_pty_cst_act_id                                                                                                                      AS 交易对方账号
       ,T1.cnt_pty_act_nm                                                                                                                          AS 交易对方户名
       ,CASE WHEN T1.crd_and_dbt_ind = 'C' THEN '收'
             WHEN T1.crd_and_dbt_ind = 'D' THEN '付' END                                                     AS 资金收付标识
        ,CASE
                WHEN T1.csh_ind = '0' THEN '现金'
                ELSE '转账'
            END                                                                                  AS 现金转账标识
        ,T1.trx_ccy_cd                                                                        AS 币种
        ,T1.trx_amt                                                                           AS 原币种交易金额
        ,T1.trx_amt / 10000                                                                   AS 原币种交易金额万元
        ,T1.trx_amt * T5.usd_exr                                                              AS 折美元交易金额
        ,T1.trx_amt * T5.usd_exr / 10000                                                      AS 折美元交易金额万元
        ,T1.trx_amt * T5.cny_exr                                                              AS 折人民币交易金额
        ,T1.trx_amt * T5.cny_exr / 10000                                                      AS 折人民币交易金额万元
        ,T1.act_bal                                                                           AS 账户余额
        ,T1.act_bal / 10000                                                                   AS 账户余额万元
        ,CASE WHEN T1.agn_nm <> '' THEN '代理' ELSE '本人' END AS 代理交易标识
        ,T1.agn_nm                                                                            AS 代理人姓名
        ,T1.agn_psn_tel                                                                       AS 代理人联系方式
        ,c1.cd_val_dscr                                                                       AS 代理人身份证件种类
        ,T1.agn_doc_nbr                                                                       AS 代理人身份证件号码
        ,T1.tlr_srl_nbr                                                                       AS 业务流水号
        ,T1.opr_tlr                                                                           AS 柜员号
        ,T1.smr_dscr                                                                          AS 业务名称
        , CASE WHEN T1.rvs_ind = '1' THEN '是' ELSE '否' END AS 冲账标识
        ,T1.cmt                                                                               AS 摘要说明
        ,CASE
                WHEN c2.cd_val_dscr RLIKE '网上银行'  THEN '网银'
                WHEN c2.cd_val_dscr RLIKE '手机银行'  THEN '手机银行'
                WHEN c2.cd_val_dscr RLIKE '柜面|柜台' THEN '柜面'
                WHEN c2.cd_val_dscr = 'ATM'       THEN 'ATM机具'
                ELSE '其它'
            END                                                                                  AS 交易方式标识
        ,T9.atm_eqp_id                                                                        AS ATM机具编号
        ,T10.afl_org                                                                          AS ATM机具所属行行号
        ,T1.csh_ind,t1.crd_and_dbt_ind,t1.trx_dt,t1.trx_tm
FROM    edw.dwd_bus_dep_bal_chg_dtl_di    	T1 --存款余额发生明细
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
inner join SJXQ_SJ20250313121_CST_00    t0
on t1.cst_act_id=t0.cst_act_id
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t3.prm_org_id = t6.org_id
and t6.dt ='@@{yyyyMMdd}'
and t6.brc_org_nm = '宁波分行'
LEFT JOIN    edw.dws_cst_bas_inf_dd     	T4 --客户基础信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20100101' and '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd    	c1 -- 码值表
ON      T1.agn_doc_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_CHM_FND_AIP_AGR_INF_DD' -- 基金定投协议信息
AND     c1.fld_nm = 'DOC_TYP_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd 	c2 -- 码值表
ON      T1.trx_chnl_cd = c2.cd_val
AND     c2.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c2.fld_nm = 'TRX_CHNL_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_chnl_atm_trx_srl_di T9 --ATM交易流水
ON      T1.cst_act_id = T9.prm_act_id
AND     T1.tlr_srl_nbr = T9.hst_srl_nbr
AND     T1.trx_dt = T9.trx_loc_dt
AND     T9.DT >= '20100101'
left JOIN (
    SELECT eqp_id,afl_org,dt
        ,ROW_NUMBER() over(partition by eqp_id order by dt desc) rn
    from edw.dim_bus_chnl_atm_eqp_inf_dd --ATM设备基本信息表
    where dt<='@@{yyyyMMdd}'
)T10 ON T9.atm_eqp_id = T10.eqp_id
AND     T10.rn=1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T11
ON      T1.trx_bus_org = T11.org_id
AND     T11.dt = '@@{yyyyMMdd}'
WHERE   T1.dt >= '20100101'
AND     T1.trx_amt > 0
and     t1.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 流水关联
DROP   TABLE IF     EXISTS SJXQ_SJ20250313121_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250313121_CST_03 as
SELECT T1.业务流水号,T1.trx_dt,t1.trx_tm,t1.交易对方户名,t1.交易对方行名称,t1.客户账号,t1.原币种交易金额
    ,T6.glbl_srl_nbr
    ,t7.usr_sbm_tm,t7.rcv_act_nm,t7.rcv_opn_bnk,t7.pmt_act_id,t7.trx_amt
    ,t7.跨境交易标识
    ,t7.交易对方所在国家或地区
    ,t7.MAC或IMEI地址
    ,t7.IP地址
from (
    SELECT DISTINCT 业务流水号,trx_dt,trx_tm,交易对方户名
        ,交易对方行名称,客户账号,原币种交易金额
    from SJXQ_SJ20250313121_CST_02
) t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.业务流水号 = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20100101'
INNER join SJXQ_SJ20250313121_CST_01              t7
ON      T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND     T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250313121_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250313121_CST_04 as
SELECT  DISTINCT 业务流水号
    ,trx_dt
    ,跨境交易标识
    ,交易对方所在国家或地区
    ,MAC或IMEI地址
    ,IP地址
FROM    SJXQ_SJ20250313121_CST_03
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250313121_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250313121_CST_05 as
SELECT  t1.序号
        ,t1.交易日期
        ,t1.交易时间
        ,t1.交易行名称
        ,t1.公私标识
        ,T1.cst_id AS 客户号
        ,t1.证件号码
        ,t1.客户账号
        ,t1.存款账号
        ,t1.账户名称
        ,t1.账户类型
        ,t1.账户类别
        ,t1.交易对手方账户类别
        ,t1.交易对方行代码
        ,t1.交易对方行名称
        ,t1.交易对方账号
        ,t1.交易对方户名
        ,t1.资金收付标识
        ,t1.现金转账标识
        ,t1.币种
        ,t1.原币种交易金额
        ,t1.原币种交易金额万元
        ,t1.折美元交易金额
        ,t1.折美元交易金额万元
        ,t1.折人民币交易金额
        ,t1.折人民币交易金额万元
        ,t1.账户余额
        ,t1.账户余额万元
        ,t1.代理交易标识
        ,t1.代理人姓名
        ,t1.代理人联系方式
        ,t1.代理人身份证件种类
        ,t1.代理人身份证件号码
        ,t1.业务流水号
        ,t1.柜员号
        ,t1.业务名称
        ,t1.冲账标识
        ,t1.摘要说明
        ,t2.跨境交易标识
        ,t2.交易对方所在国家或地区
        ,t1.交易方式标识
        ,t2.IP地址
        ,t1.ATM机具编号
        ,t1.ATM机具所属行行号
        ,t2.MAC或IMEI地址
FROM SJXQ_SJ20250313121_CST_02      T1
left join SJXQ_SJ20250313121_CST_04 t2
on t1.业务流水号=t2.业务流水号
and t1.trx_dt=t2.trx_dt
;
***王梦娜_SJ20250317151_信用卡流水.sql
﻿-- 信用卡账户6222878805982103自20200101开始的交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ20250317151_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317151_CST_01 AS
SELECT  cr_crd_card_nbr AS 信用卡卡号
        ,card_sts_cd    AS 卡片状态代码
        ,c1.cd_val_dscr AS 卡片状态
        ,card_sts_dt    AS 卡片状态日期
        ,cst_id         AS 客户编号
        ,cst_nm         AS 客户名称
        ,isu_dt         AS 发卡日期
        ,rsnd_dt        AS 重发卡日期
        ,card_actv_dt   AS 卡片激活日期
        ,late_trx_dt    AS 最后交易日期
        ,cr_crd_act_id  AS 信用卡账号
        ,late_card_ind  AS 最新卡标志
from edw.dws_bus_crd_cr_crd_inf_dd      t1      --信用卡卡片信息汇总
left join EDW.DWD_CODE_LIBRARY_DD       c1
on t1.card_sts_cd=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.cr_crd_card_nbr='6222878805982103'
;
-- 信用卡卡号	信用卡产品编号	卡片状态代码	卡片状态	卡片状态日期	客户编号	客户名称	发卡日期	重发卡日期	卡片激活日期	最后交易日期	信用卡账号	最新卡标志
-- 6222878805982103	0002	Q	销户申请	20120704	1004194535	周先明	20090531	18991231	20090609	20120702	0028805982	1
DROP   TABLE IF     EXISTS SJXQ_SJ20250317151_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317151_CST_02 AS
SELECT  cr_crd_act_id           AS 信用卡账号
       ,cr_crd_card_nbr         AS 信用卡卡号
       ,srl_nbr                 AS 流水号
       ,trx_typ_cd              AS 交易类型代码
       ,trx_typ_dscr            AS 交易类型描述
       ,trx_ccy_cd              AS 交易币种代码
       ,trx_amt                 AS 交易金额
       ,mch_typ                 AS 商户类型
       ,mch_cd                  AS 商户代码
       ,tmn_id_no               AS 受卡机终端标识码
       ,idx_ref                 AS 检索参考号
       ,aut_rsp_no              AS 授权应答码
       ,trx_dt                  AS 交易日期
       ,trx_tm                  AS 交易时间
       ,act_dt                  AS 入帐日期
       ,clr_dt                  AS 清算日期
       ,wdw_rvs_ind             AS 撤销冲正标志
       ,trx_brn                 AS 交易网点
       ,trx_tlr                 AS 交易柜员
       ,mon_id                  AS 月份编号
       ,ini_amt                 AS 原始金额
       ,ini_ccy_cd              AS 原始币种代码
       ,trx_src                 AS 交易来源
       ,acc_id_no               AS 受理方标识码
       ,trx_amt_ovp_part_amt    AS 交易金额溢缴款部分金额
       ,trx_ind                 AS 交易标志
       ,chnl_id                 AS 渠道标识
       ,agn_fwd_isu_org_cd      AS 代理转发发卡机构代码
       ,cnr_cd                  AS 国家代码
       ,clr_amt                 AS 清算金额
       ,clr_ccy_cd              AS 清算币种代码
       ,rtn_gds_trx_id          AS 退货交易标识
       ,trx_dscr_1              AS 交易描述1
       ,trx_dscr_2              AS 交易描述2
       ,idx_ref_new             AS 新检索参考号
       ,frs_strk_onl_aut_trx_id AS 首笔联机授权交易标识
       ,pos_inpt_mth            AS POS输入方式
       ,acq_mch_enc             AS 收单商户编码
       ,tbs_fee_amt             AS 可选费用金额
       ,acq_org_id              AS 收单机构码
       ,mch_seq_nbr             AS 商户序号
       ,cur_un_intr_bal         AS 当前不含利息余额
       ,trx_into_whs_dt         AS 交易入库时的自然日期
       ,insd_and_otsd_trx_ind   AS 境内外交易标志
       ,trx_hpn_dt              AS 交易发生日期
       ,actl_trx_tm             AS 实际交易时间
       ,pbc_chnl_ind            AS 人行渠道标识
       ,call_bil_ref            AS 调单参考号
       ,out_card_trx_ind        AS 外卡交易标志
       ,saf_ctrl_hbr_cd         AS 安控层级代码
FROM edw.dwd_bus_crd_cr_crd_trx_dtl_di --信用卡客户交易流水
WHERE dt >= '20100101'
AND cr_crd_act_id = '0028805982'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250317151_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317151_CST_03 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cr_crd_act_id   AS 信用卡账号
       ,t1.cr_crd_card_nbr AS 信用卡卡号
       ,t1.srl_nbr         AS 流水号
       ,t1.trx_typ_cd      AS 交易类型代码
       ,t1.trx_typ_dscr    AS 交易类型描述
       ,t1.trx_ccy_cd      AS 交易币种代码
       ,c1.cd_val_dscr     AS 交易币种
       ,t1.trx_amt         AS 交易金额
       ,t1.mch_typ_cd      AS 商户类型代码
       ,t1.mch_cd          AS 商户代码
       ,t1.trx_dt          AS 交易日期
       ,t1.trx_tm          AS 交易时间
       ,t1.act_dt          AS 入帐日期
       ,t1.trx_hpn_dt      AS 交易发生日期
       ,t1.actl_trx_tm     AS 实际交易时间
       ,t1.cnt_pty_act_id  AS 对方账号
       ,t1.cnt_pty_act_nm  AS 对方户名
       ,t1.trx_dscr_1      AS 交易描述1
       ,t1.trx_dscr_2      AS 交易描述2
       ,t1.acq_mch_enc     AS 收单商户编码
       ,t1.acq_org_id      AS 收单机构码
       ,t1.mch_seq_nbr     AS 商户序号
       ,t1.act_bal         AS 账户余额
       ,t1.ip              AS IP
       ,t1.mac             AS MAC
from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di t1 --信用卡交易宽表
left join edw.dwd_code_library_dd 				c1
on  t1.trx_ccy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
WHERE t1.dt >= '20100101'
AND t1.cr_crd_card_nbr = '6222878805982103'
;
from SJXQ_SJ20250317151_CST_02
;
from SJXQ_SJ20250317151_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ20250317151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ20250317151_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ20250317151_CST_03
***王梦娜_SJ2025032177_反洗钱交易流水.sql
﻿-- 王梦娜_SJ2025032177_反洗钱交易流水
-- 1. 账户信息表
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_01 as
select distinct cst_act_id,cst_id
	,act_nm	--	账户名称|C300
from edw.dws_bus_dep_act_inf_dd  	--存款账户信息汇总
where DT = '@@{yyyyMMdd}'
,'6214808801003974678'
,'6221410012220837'
,'6214809801001873368'
,'6214808801012058943'
,'6214808817000044711'
,'6214800602003219165')
;
-- 银行账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_02 as
select bank_code1                               --开户行代码
	,self_acc_name                            --账户户名
	,acc_state                                --账户状态11：正常；12：其他
	,self_acc_no                              --账号表中每个账号一条记录，不能为空；如果只有卡号无账号，填写卡号，即账号与卡号一致
	,card_no                                  --卡号如开设账户有提供银行卡，应在本字段填写卡号，没有卡号为空。如果存在1个账号对应多个卡号（或多个账号对应1个卡）的情况，应按照账号与卡号的对应关系分多条记录全部列出
	,acc_type                                 --公私标识11：个人；12：单位
	,acc_type1                                --个人账户种类当Acc_type =11时填写：11：代表I类账户；12：代表II类账户；13：代表III类账户；14：代表信用卡账户
	,id_no                                    --身份证件号码个人客户按照表3Id_no字段、单位客户按照表4 License字段
	,cst_no                                   --客户号
	,fixed_flag                               --定活期标识10：活期；11：定期，12：其他
	,ent_cst_type                             --单位账户类型当Acc_type =12时填写，具体规范见附填写数字
	,frg_flag                                 --本外币标识10：仅本币；11：仅外币；12：通用
	,open_time                                --开户日期YYYYMMDD
	,close_time                               --销户日期YYYYMMDD
	,acc_flag                                 --银行卡收单账户标识11：是；12：否
	,credit_flag                              --借贷记卡标识11：借记卡；12：贷记卡；准贷记卡等具有贷记功能的填写12，卡号为空时不填写
	,w_type                                   --账户网银标识11：开通；12：未开通
	,bank_tel                                 --手机银行号码
	,open_type                                --开户标识11：柜面开户；12：非柜面开户
	,open_type1                               --开户标识111：代理；12：本人；13：批量开户（仅公私标识为个人11时填写）
	,agent_name                               --代理人姓名Agency_flag=11，即发生代理关系时填写
	,agent_tel                                --代理人联系方式Agency_flag=11，即发生代理关系时填写
	,agent_type                               --代理人身份证件种类Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,agent_no                                 --代理人身份证件号码Agency_flag=11，即发生代理关系时填写
	,open_type2                               --开户标识
	,acc_state_date                           -- 账户状态日期
	,is_act_same
	,dt
from(
	SELECT T1.*
		,CASE WHEN T1.self_acc_no=T2.cst_act_id then 1 else 0 end as is_act_same
		,ROW_NUMBER() over(partition by t2.cst_act_id order by t1.dt desc) rn
	from adm_upss.aml_t3r_acct   		t1                  --符合特定条件的银行账户信息表
	INNER JOIN SJXQ_SJ2025032177_CST_01 t2
	on T1.self_acc_no=T2.cst_act_id
	-- and t2.cst_id like '1%'     --需检查
	where t1.dt>='20241027'
)t1 where t1.rn=1
;
-- 2. 交易明细表 10号调查
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_03 as
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C200
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C200
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	,t1.late_upd_tm	                             --最后更新时间|C20
	,t1.glbl_srl_nbr	                         --全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS IP地址
    ,'个人' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
-- and t4.brc_org_nm = '宁波分行'
inner join SJXQ_SJ2025032177_CST_01 t5 on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20220101' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_cd = '000000' --交易成功
union all
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C300
	-- ,pmt_org_id                               --付款方网点|C10
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C300
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	-- ,rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	-- ,instr_sts_cd                             --指令状态代码|C2
	,t1.late_upd_tm                              --最后更新时间|C20
	,t1.glbl_srl_nbr	--	全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS mac
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS ip
    ,'企业' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
-- and t4.brc_org_nm = '宁波分行'
inner join SJXQ_SJ2025032177_CST_01 t5 on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20220101' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_cd = '000000' --交易成功
;
-- 宁波分行 2022以来交易流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_04 as
SELECT  t1.dtl_seq_nbr                                                                                                                             AS 序号
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),1,10)                                                             AS 交易日期
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),11)                                                               AS 交易时间
       ,T11.sbr_org_nm                                                                                                                             AS 交易行名称
       ,CASE WHEN T2.cst_tp = '1' THEN '个人'
             WHEN T2.cst_tp = '2' THEN '单位' END                                                                                                    AS 公私标识
       ,T2.cst_id                                                                                                                                  --客户号
       ,T4.doc_nbr                                                                                                                                 AS 证件号码
       ,T1.cst_act_id                                                                                                                              AS 客户账号
       ,T1.dep_act_id                                                                                                                              AS 存款账号
       ,T1.act_nm                                                                                                                                  AS 账户名称
       ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1' THEN '个人银行结算账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END                                                                AS 账户类型
       ,CASE WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '301' THEN '1类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '302' THEN '2类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '303' THEN '3类账户' END                                                                      AS 账户类别
       ,CASE WHEN T1.cnt_pty_act_nm <> '' AND T1.cnt_pty_fin_instt_nm = '' AND T1.cnt_pty_fin_instt_typ_cd = '' THEN '支付账户等非银行账户'  ELSE '银行账户' END AS 交易对手方账户类别
       ,T1.cnt_pty_fin_instt_cd                                                                                                                    AS 交易对方行代码
       ,T1.cnt_pty_fin_instt_nm                                                                                                                    AS 交易对方行名称
       ,T1.cnt_pty_cst_act_id                                                                                                                      AS 交易对方账号
       ,T1.cnt_pty_act_nm                                                                                                                          AS 交易对方户名
       ,CASE WHEN T1.crd_and_dbt_ind = 'C' THEN '收'
             WHEN T1.crd_and_dbt_ind = 'D' THEN '付' END                                                     AS 资金收付标识
        ,CASE
                WHEN T1.csh_ind = '0' THEN '现金'
                ELSE '转账'
            END                                                                                  AS 现金转账标识
        ,T1.trx_ccy_cd                                                                        AS 币种
        ,T1.trx_amt                                                                           AS 原币种交易金额
        ,T1.trx_amt / 10000                                                                   AS 原币种交易金额万元
        ,T1.trx_amt * T5.usd_exr                                                              AS 折美元交易金额
        ,T1.trx_amt * T5.usd_exr / 10000                                                      AS 折美元交易金额万元
        ,T1.trx_amt * T5.cny_exr                                                              AS 折人民币交易金额
        ,T1.trx_amt * T5.cny_exr / 10000                                                      AS 折人民币交易金额万元
        ,T1.act_bal                                                                           AS 账户余额
        ,T1.act_bal / 10000                                                                   AS 账户余额万元
        ,CASE WHEN T1.agn_nm <> '' THEN '代理' ELSE '本人' END AS 代理交易标识
        ,T1.agn_nm                                                                            AS 代理人姓名
        ,T1.agn_psn_tel                                                                       AS 代理人联系方式
        ,c1.cd_val_dscr                                                                       AS 代理人身份证件种类
        ,T1.agn_doc_nbr                                                                       AS 代理人身份证件号码
        ,T1.tlr_srl_nbr                                                                       AS 业务流水号
        ,T1.opr_tlr                                                                           AS 柜员号
        ,T1.smr_dscr                                                                          AS 业务名称
        , CASE WHEN T1.rvs_ind = '1' THEN '是' ELSE '否' END AS 冲账标识
        ,T1.cmt                                                                               AS 摘要说明
        ,CASE
                WHEN c2.cd_val_dscr RLIKE '网上银行'  THEN '网银'
                WHEN c2.cd_val_dscr RLIKE '手机银行'  THEN '手机银行'
                WHEN c2.cd_val_dscr RLIKE '柜面|柜台' THEN '柜面'
                WHEN c2.cd_val_dscr = 'ATM'       THEN 'ATM机具'
                ELSE '其它'
            END                                                                                  AS 交易方式标识
        ,T9.atm_eqp_id                                                                        AS ATM机具编号
        ,T10.afl_org                                                                          AS ATM机具所属行行号
        ,T1.csh_ind,t1.crd_and_dbt_ind,t1.trx_dt,t1.trx_tm
FROM    edw.dwd_bus_dep_bal_chg_dtl_di    	T1 --存款余额发生明细
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
inner join SJXQ_SJ2025032177_CST_01    t0
on t1.cst_act_id=t0.cst_act_id
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t3.prm_org_id = t6.org_id
and t6.dt ='@@{yyyyMMdd}'
-- and t6.brc_org_nm = '宁波分行'
LEFT JOIN    edw.dws_cst_bas_inf_dd     	T4 --客户基础信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20220101' and '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd    	c1 -- 码值表
ON      T1.agn_doc_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_CHM_FND_AIP_AGR_INF_DD' -- 基金定投协议信息
AND     c1.fld_nm = 'DOC_TYP_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd 	c2 -- 码值表
ON      T1.trx_chnl_cd = c2.cd_val
AND     c2.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c2.fld_nm = 'TRX_CHNL_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_chnl_atm_trx_srl_di T9 --ATM交易流水
ON      T1.cst_act_id = T9.prm_act_id
AND     T1.tlr_srl_nbr = T9.hst_srl_nbr
AND     T1.trx_dt = T9.trx_loc_dt
AND     T9.DT >= '20220101'
left JOIN (
    SELECT eqp_id,afl_org,dt
        ,ROW_NUMBER() over(partition by eqp_id order by dt desc) rn
    from edw.dim_bus_chnl_atm_eqp_inf_dd --ATM设备基本信息表
    where dt<='@@{yyyyMMdd}'
)T10 ON T9.atm_eqp_id = T10.eqp_id
AND     T10.rn=1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T11
ON      T1.trx_bus_org = T11.org_id
AND     T11.dt = '@@{yyyyMMdd}'
WHERE   T1.dt >= '20220101'
AND     T1.trx_amt > 0
and     t1.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 流水关联
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_05 as
SELECT T1.业务流水号,T1.trx_dt,t1.trx_tm,t1.交易对方户名,t1.交易对方行名称,t1.客户账号,t1.原币种交易金额
    ,T6.glbl_srl_nbr
    ,t7.usr_sbm_tm,t7.rcv_act_nm,t7.rcv_opn_bnk,t7.pmt_act_id,t7.trx_amt
    ,t7.跨境交易标识
    ,t7.交易对方所在国家或地区
    ,t7.MAC或IMEI地址
    ,t7.IP地址
from (
    SELECT DISTINCT 业务流水号,trx_dt,trx_tm,交易对方户名
        ,交易对方行名称,客户账号,原币种交易金额
    from SJXQ_SJ2025032177_CST_04
) t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.业务流水号 = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20220101'
INNER join SJXQ_SJ2025032177_CST_03              t7
ON      T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND     T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_06 as
SELECT  DISTINCT 业务流水号
    ,trx_dt
    ,跨境交易标识
    ,交易对方所在国家或地区
    ,MAC或IMEI地址
    ,IP地址
FROM    SJXQ_SJ2025032177_CST_05
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_07 as
SELECT  t1.序号
        ,t1.交易日期
        ,t1.交易时间
        ,t1.交易行名称
        ,t1.公私标识
        ,T1.cst_id AS 客户号
        -- ,t1.证件号码
        ,t1.客户账号
        ,t1.存款账号
        ,t1.账户名称
        ,t1.账户类型
        ,t1.账户类别
        ,t1.交易对手方账户类别
        ,t1.交易对方行代码
        ,t1.交易对方行名称
        ,t1.交易对方账号
        ,t1.交易对方户名
        ,t1.资金收付标识
        ,t1.现金转账标识
        ,t1.币种
        ,t1.原币种交易金额
        ,t1.原币种交易金额万元
        ,t1.折美元交易金额
        ,t1.折美元交易金额万元
        ,t1.折人民币交易金额
        ,t1.折人民币交易金额万元
        ,t1.账户余额
        ,t1.账户余额万元
        ,t1.代理交易标识
        ,t1.代理人姓名
        --,t1.代理人联系方式
        --,t1.代理人身份证件种类
        --,t1.代理人身份证件号码
        ,t1.业务流水号
        ,t1.柜员号
        ,t1.业务名称
        ,t1.冲账标识
        ,t1.摘要说明
        ,t2.跨境交易标识
        ,t2.交易对方所在国家或地区
        ,t1.交易方式标识
        ,t2.IP地址
        ,t1.ATM机具编号
        ,t1.ATM机具所属行行号
        ,t2.MAC或IMEI地址
FROM SJXQ_SJ2025032177_CST_04      T1
left join SJXQ_SJ2025032177_CST_06 t2
on t1.业务流水号=t2.业务流水号
and t1.trx_dt=t2.trx_dt
;
-- 输出结果账户 敏感数据：手机银行号码、联系方式、身份证件种类
DROP   TABLE IF     EXISTS SJXQ_SJ2025032177_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032177_CST_08 as
SELECT  self_acc_name                                               AS 账户户名
        ,self_acc_no                                                AS 账号
        ,decode(w_type, '11','开通', '12','未开通')                  AS 账户网银标识
        -- ,bank_tel 													as 手机银行号码
        ,decode(open_type, '11','柜面开户', '12','非柜面开户')           AS 开户标识
        ,decode(open_type1,'11','代理', '12','本人', '13', '批量开户') AS 开户标识1
        ,agent_name                                                 AS 代理人姓名
        --,agent_tel                                                  AS 代理人联系方式   --Agency_flag=11，即发生代理关系时填写
        ,agent_type                                                 AS 代理人身份证件种类 --Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
        --,agent_no                                                   AS 代理人身份证件号码 --Agency_flag=11，即发生代理关系时填写
from SJXQ_SJ2025032177_CST_02
;
-- result
SElECT '07' seq, *
from lab_sjxq.SJXQ_SJ2025032177_CST_07
;
SElECT '08' seq, *
from lab_sjxq.SJXQ_SJ2025032177_CST_08
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025032177_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct self_acc_no) custs
from SJXQ_SJ2025032177_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct glbl_srl_nbr) custs
from SJXQ_SJ2025032177_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ2025032177_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025032177_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025032177_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025032177_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ2025032177_CST_08
;
/*
01	6	5
02	6	6
03	0	0
04	8	8
05	0	0
06	0	0
*/***王梦娜_SJ2025040831_反洗钱交易流水.sql
-- 1. 账户信息表
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_01 as
select distinct cst_act_id,cst_id
	,act_nm	--	账户名称|C300
from edw.dws_bus_dep_act_inf_dd  	--存款账户信息汇总
where DT = '@@{yyyyMMdd}'
;
-- 银行账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_02 as
select bank_code1                               --开户行代码
	,self_acc_name                            --账户户名
	,acc_state                                --账户状态11：正常；12：其他
	,self_acc_no                              --账号表中每个账号一条记录，不能为空；如果只有卡号无账号，填写卡号，即账号与卡号一致
	,card_no                                  --卡号如开设账户有提供银行卡，应在本字段填写卡号，没有卡号为空。如果存在1个账号对应多个卡号（或多个账号对应1个卡）的情况，应按照账号与卡号的对应关系分多条记录全部列出
	,acc_type                                 --公私标识11：个人；12：单位
	,acc_type1                                --个人账户种类当Acc_type =11时填写：11：代表I类账户；12：代表II类账户；13：代表III类账户；14：代表信用卡账户
	,id_no                                    --身份证件号码个人客户按照表3Id_no字段、单位客户按照表4 License字段
	,cst_no                                   --客户号
	,fixed_flag                               --定活期标识10：活期；11：定期，12：其他
	,ent_cst_type                             --单位账户类型当Acc_type =12时填写，具体规范见附填写数字
	,frg_flag                                 --本外币标识10：仅本币；11：仅外币；12：通用
	,open_time                                --开户日期YYYYMMDD
	,close_time                               --销户日期YYYYMMDD
	,acc_flag                                 --银行卡收单账户标识11：是；12：否
	,credit_flag                              --借贷记卡标识11：借记卡；12：贷记卡；准贷记卡等具有贷记功能的填写12，卡号为空时不填写
	,w_type                                   --账户网银标识11：开通；12：未开通
	,bank_tel                                 --手机银行号码
	,open_type                                --开户标识11：柜面开户；12：非柜面开户
	,open_type1                               --开户标识111：代理；12：本人；13：批量开户（仅公私标识为个人11时填写）
	,agent_name                               --代理人姓名Agency_flag=11，即发生代理关系时填写
	,agent_tel                                --代理人联系方式Agency_flag=11，即发生代理关系时填写
	,agent_type                               --代理人身份证件种类Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,agent_no                                 --代理人身份证件号码Agency_flag=11，即发生代理关系时填写
	,open_type2                               --开户标识
	,acc_state_date                           -- 账户状态日期
	,is_act_same
	,dt
from(
	SELECT T1.*
		,CASE WHEN T1.self_acc_no=T2.cst_act_id then 1 else 0 end as is_act_same
		,ROW_NUMBER() over(partition by t2.cst_act_id order by t1.dt desc) rn
	from adm_upss.aml_t3r_acct   		t1                  --符合特定条件的银行账户信息表
	INNER JOIN SJXQ_SJ2025040831_CST_01 t2
	on T1.self_acc_no=T2.cst_act_id
	where t1.dt>='20241027'
)t1 where t1.rn=1
;
-- 2. 交易明细表 10号调查
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_03 as
select t1.chnl_typ_cd                              --渠道类型代码|C2
	,t1.trx_seq                                  --交易流水号|C20
	,t1.cst_id                                   --客户号|C10
	,t1.trx_cd                                   --交易代码|C6
	,t1.pmt_act_id                               --付款方账号|C30
	,t1.pmt_act_nm                               --付款方户名|C200
	,t1.rcv_act_id                               --收款方账号|C32
	,t1.rcv_act_nm                               --收款方户名|C200
	,t1.rcv_opn_bnk                              --收款方开户行|C300
	,t1.ccy_cd                                   --币种|C3
	,t1.usr_sbm_tm                               --用户提交时间|C14
	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
	,t1.usr_cmt                                  --用户备注|C256
	,t1.late_upd_tm	                             --最后更新时间|C20
	,t1.glbl_srl_nbr	                         --全局流水号|C40
	,t1.cst_end_ip                               --客户端ip|C100
	,t1.ovs_ind                                  --境外标志|C1
    ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
	,t1.cnr_nm                                   --国家名称|C200
	,t1.pvc_nm                                   --省份名称|C200
	,t1.cty_nm                                   --城市名称|C200
    ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
        WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
        END                                                    AS MAC或IMEI地址
    ,CASE
        WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
        WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
        WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
        END                                                    AS IP地址
    ,'个人' as data_src,t1.dt
from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt ='@@{yyyyMMdd}'
-- and t4.brc_org_nm = '宁波分行'
inner join SJXQ_SJ2025040831_CST_01 t5 on t1.cst_id=t5.cst_id
where t1.dt BETWEEN '20160112' and '@@{yyyyMMdd}'
and t1.hst_rtn_err_dscr regexp '处理成功'
-- union all
-- select t1.chnl_typ_cd                              --渠道类型代码|C2
-- 	,t1.trx_seq                                  --交易流水号|C20
-- 	,t1.cst_id                                   --客户号|C10
-- 	,t1.trx_cd                                   --交易代码|C6
-- 	,t1.pmt_act_id                               --付款方账号|C30
-- 	,t1.pmt_act_nm                               --付款方户名|C300
-- 	-- ,pmt_org_id                               --付款方网点|C10
-- 	,t1.rcv_act_id                               --收款方账号|C32
-- 	,t1.rcv_act_nm                               --收款方户名|C300
-- 	,t1.rcv_opn_bnk                              --收款方开户行|C300
-- 	-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
-- 	,t1.ccy_cd                                   --币种|C3
-- 	,t1.usr_sbm_tm                               --用户提交时间|C14
-- 	,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
-- 	-- ,rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
-- 	,t1.usr_cmt                                  --用户备注|C256
-- 	-- ,instr_sts_cd                             --指令状态代码|C2
-- 	,t1.late_upd_tm                              --最后更新时间|C20
-- 	,t1.glbl_srl_nbr	--	全局流水号|C40
-- 	,t1.cst_end_ip                               --客户端ip|C100
-- 	,t1.ovs_ind                                  --境外标志|C1
--     ,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
-- 	,t1.cnr_nm                                   --国家名称|C200
-- 	,t1.pvc_nm                                   --省份名称|C200
-- 	,t1.cty_nm                                   --城市名称|C200
--     ,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
--     ,CASE
--         WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
--         WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
--         WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
--         END                                                    AS mac
--     ,CASE
--         WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
--         WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
--         WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
--         END                                                    AS ip
--     ,'企业' as data_src,t1.dt
-- from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
-- inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
-- on  t1.cst_id = t3.cst_id
-- and t3.dt ='@@{yyyyMMdd}'
-- inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
-- on  t3.prm_org_id = t4.org_id
-- and t4.dt ='@@{yyyyMMdd}'
-- -- and t4.brc_org_nm = '宁波分行'
-- inner join SJXQ_SJ2025040831_CST_01 t5 on t1.cst_id=t5.cst_id
-- where t1.dt BETWEEN '20160112' and '@@{yyyyMMdd}'
-- and t1.hst_rtn_err_cd = '000000' --交易成功
;
-- 宁波分行 2022以来交易流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_04 as
SELECT  t1.dtl_seq_nbr                                                                                                                             AS 序号
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),1,10)                                                             AS 交易日期
       ,SUBSTR(TO_DATE(CONCAT(T1.trx_dt,substr(T1.trx_tm,1,6)),'yyyymmddhhmiss'),11)                                                               AS 交易时间
       ,T11.sbr_org_nm                                                                                                                             AS 交易行名称
       ,CASE WHEN T2.cst_tp = '1' THEN '个人'
             WHEN T2.cst_tp = '2' THEN '单位' END                                                                                                    AS 公私标识
       ,T2.cst_id                                                                                                                                  --客户号
       ,T4.doc_nbr                                                                                                                                 AS 证件号码
       ,T1.cst_act_id                                                                                                                              AS 客户账号
       ,T1.dep_act_id                                                                                                                              AS 存款账号
       ,T1.act_nm                                                                                                                                  AS 账户名称
       ,CASE WHEN T2.cst_tp = '1' AND T2.stl_act_ind = '1' THEN '个人银行结算账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0001' THEN '单位元基本存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0002' THEN '单位元一般存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0004' THEN '单位专用存款账户'
             WHEN T2.cst_tp = '2' AND T2.act_ctg_cd_1 = '0003' THEN '单位元临时存款账户' END                                                                AS 账户类型
       ,CASE WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '301' THEN '1类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '302' THEN '2类账户'
             WHEN T2.cst_tp = '1' AND T2.act_ctg_cd_2 = '303' THEN '3类账户' END                                                                      AS 账户类别
       ,CASE WHEN T1.cnt_pty_act_nm <> '' AND T1.cnt_pty_fin_instt_nm = '' AND T1.cnt_pty_fin_instt_typ_cd = '' THEN '支付账户等非银行账户'  ELSE '银行账户' END AS 交易对手方账户类别
       ,T1.cnt_pty_fin_instt_cd                                                                                                                    AS 交易对方行代码
       ,T1.cnt_pty_fin_instt_nm                                                                                                                    AS 交易对方行名称
       ,T1.cnt_pty_cst_act_id                                                                                                                      AS 交易对方账号
       ,T1.cnt_pty_act_nm                                                                                                                          AS 交易对方户名
       ,CASE WHEN T1.crd_and_dbt_ind = 'C' THEN '收'
             WHEN T1.crd_and_dbt_ind = 'D' THEN '付' END                                                     AS 资金收付标识
        ,CASE
                WHEN T1.csh_ind = '0' THEN '现金'
                ELSE '转账'
            END                                                                                  AS 现金转账标识
        ,T1.trx_ccy_cd                                                                        AS 币种
        ,T1.trx_amt                                                                           AS 原币种交易金额
        ,T1.trx_amt / 10000                                                                   AS 原币种交易金额万元
        ,T1.trx_amt * T5.usd_exr                                                              AS 折美元交易金额
        ,T1.trx_amt * T5.usd_exr / 10000                                                      AS 折美元交易金额万元
        ,T1.trx_amt * T5.cny_exr                                                              AS 折人民币交易金额
        ,T1.trx_amt * T5.cny_exr / 10000                                                      AS 折人民币交易金额万元
        ,T1.act_bal                                                                           AS 账户余额
        ,T1.act_bal / 10000                                                                   AS 账户余额万元
        ,CASE WHEN T1.agn_nm <> '' THEN '代理' ELSE '本人' END AS 代理交易标识
        ,T1.agn_nm                                                                            AS 代理人姓名
        ,T1.agn_psn_tel                                                                       AS 代理人联系方式
        ,c1.cd_val_dscr                                                                       AS 代理人身份证件种类
        ,T1.agn_doc_nbr                                                                       AS 代理人身份证件号码
        ,T1.tlr_srl_nbr                                                                       AS 业务流水号
        ,T1.opr_tlr                                                                           AS 柜员号
        ,T1.smr_dscr                                                                          AS 业务名称
        , CASE WHEN T1.rvs_ind = '1' THEN '是' ELSE '否' END AS 冲账标识
        ,T1.cmt                                                                               AS 摘要说明
        ,CASE
                WHEN c2.cd_val_dscr RLIKE '网上银行'  THEN '网银'
                WHEN c2.cd_val_dscr RLIKE '手机银行'  THEN '手机银行'
                WHEN c2.cd_val_dscr RLIKE '柜面|柜台' THEN '柜面'
                WHEN c2.cd_val_dscr = 'ATM'       THEN 'ATM机具'
                ELSE '其它'
            END                                                                                  AS 交易方式标识
        ,T9.atm_eqp_id                                                                        AS ATM机具编号
        ,T10.afl_org                                                                          AS ATM机具所属行行号
        ,T1.csh_ind,t1.crd_and_dbt_ind,t1.trx_dt,t1.trx_tm
FROM    edw.dwd_bus_dep_bal_chg_dtl_di    	T1 --存款余额发生明细
INNER JOIN    edw.dws_bus_dep_act_inf_dd  	T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
inner join SJXQ_SJ2025040831_CST_01    t0
on t1.cst_act_id=t0.cst_act_id
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t2.cst_id = t3.cst_id
and t3.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t3.prm_org_id = t6.org_id
and t6.dt ='@@{yyyyMMdd}'
-- and t6.brc_org_nm = '宁波分行'
LEFT JOIN    edw.dws_cst_bas_inf_dd     	T4 --客户基础信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t1.trx_dt=t5.dt     --交易日汇率
AND     t5.DT BETWEEN '20160112' and '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd    	c1 -- 码值表
ON      T1.agn_doc_typ_cd = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_CHM_FND_AIP_AGR_INF_DD' -- 基金定投协议信息
AND     c1.fld_nm = 'DOC_TYP_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd 	c2 -- 码值表
ON      T1.trx_chnl_cd = c2.cd_val
AND     c2.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c2.fld_nm = 'TRX_CHNL_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_chnl_atm_trx_srl_di T9 --ATM交易流水
ON      T1.cst_act_id = T9.prm_act_id
AND     T1.tlr_srl_nbr = T9.hst_srl_nbr
AND     T1.trx_dt = T9.trx_loc_dt
AND     T9.DT >= '20160112'
left JOIN (
    SELECT eqp_id,afl_org,dt
        ,ROW_NUMBER() over(partition by eqp_id order by dt desc) rn
    from edw.dim_bus_chnl_atm_eqp_inf_dd --ATM设备基本信息表
    where dt<='@@{yyyyMMdd}'
)T10 ON T9.atm_eqp_id = T10.eqp_id
AND     T10.rn=1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T11
ON      T1.trx_bus_org = T11.org_id
AND     T11.dt = '@@{yyyyMMdd}'
WHERE   T1.dt >= '20160112'
AND     T1.trx_amt > 0
and     t1.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 流水关联
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_05 as
SELECT T1.业务流水号,T1.trx_dt,t1.trx_tm,t1.交易对方户名,t1.交易对方行名称,t1.客户账号,t1.原币种交易金额
    ,T6.glbl_srl_nbr
    ,t7.usr_sbm_tm,t7.rcv_act_nm,t7.rcv_opn_bnk,t7.pmt_act_id,t7.trx_amt
    ,t7.跨境交易标识
    ,t7.交易对方所在国家或地区
    ,t7.MAC或IMEI地址
    ,t7.IP地址
from (
    SELECT DISTINCT 业务流水号,trx_dt,trx_tm,交易对方户名
        ,交易对方行名称,客户账号,原币种交易金额
    from SJXQ_SJ2025040831_CST_04
) t1
INNER JOIN edw.dwd_bus_com_core_trx_msg_inf_di    T6 --核心交易报文信息
ON      T1.业务流水号 = T6.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T6.trx_dt
AND     T6.DT >= '20160112'
INNER join SJXQ_SJ2025040831_CST_03              t7
ON      T6.glbl_srl_nbr = T7.glbl_srl_nbr --全局流水号与网银交易流水号关联
AND     T6.trx_dt = SUBSTR(T7.late_upd_tm, 1, 8)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_06 as
SELECT  DISTINCT 业务流水号
    ,trx_dt
    ,跨境交易标识
    ,交易对方所在国家或地区
    ,MAC或IMEI地址
    ,IP地址
FROM    SJXQ_SJ2025040831_CST_05
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_07 as
SELECT  t1.序号
        ,t1.交易日期
        ,t1.交易时间
        ,t1.交易行名称
        ,t1.公私标识
        ,T1.cst_id AS 客户号
        -- ,t1.证件号码
        ,t1.客户账号
        ,t1.存款账号
        ,t1.账户名称
        ,t1.账户类型
        ,t1.账户类别
        ,t1.交易对手方账户类别
        ,t1.交易对方行代码
        ,t1.交易对方行名称
        ,t1.交易对方账号
        ,t1.交易对方户名
        ,t1.资金收付标识
        ,t1.现金转账标识
        ,t1.币种
        ,t1.原币种交易金额
        ,t1.原币种交易金额万元
        ,t1.折美元交易金额
        ,t1.折美元交易金额万元
        ,t1.折人民币交易金额
        ,t1.折人民币交易金额万元
        ,t1.账户余额
        ,t1.账户余额万元
        ,t1.代理交易标识
        ,t1.代理人姓名
        ,t1.代理人联系方式
        ,t1.代理人身份证件种类
        ,t1.代理人身份证件号码
        ,t1.业务流水号
        ,t1.柜员号
        ,t1.业务名称
        ,t1.冲账标识
        ,t1.摘要说明
        ,t2.跨境交易标识
        ,t2.交易对方所在国家或地区
        ,t1.交易方式标识
        ,t2.IP地址
        ,t1.ATM机具编号
        ,t1.ATM机具所属行行号
        ,t2.MAC或IMEI地址
FROM SJXQ_SJ2025040831_CST_04      T1
left join SJXQ_SJ2025040831_CST_06 t2
on t1.业务流水号=t2.业务流水号
and t1.trx_dt=t2.trx_dt
;
-- 输出结果账户 敏感数据：手机银行号码、联系方式、身份证件种类
DROP   TABLE IF     EXISTS SJXQ_SJ2025040831_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040831_CST_08 as
SELECT  self_acc_name                                               AS 账户户名
        ,self_acc_no                                                AS 账号
        ,decode(w_type, '11','开通', '12','未开通')                  AS 账户网银标识
        ,bank_tel 													as 手机银行号码
        ,decode(open_type, '11','柜面开户', '12','非柜面开户')           AS 开户标识
        ,decode(open_type1,'11','代理', '12','本人', '13', '批量开户') AS 开户标识1
        ,agent_name                                                 AS 代理人姓名
        ,agent_tel                                                  AS 代理人联系方式   --Agency_flag=11，即发生代理关系时填写
        ,agent_type                                                 AS 代理人身份证件种类 --Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
        ,agent_no                                                   AS 代理人身份证件号码 --Agency_flag=11，即发生代理关系时填写
from SJXQ_SJ2025040831_CST_02
;
-- result
SElECT '07' seq, *
from lab_sjxq.SJXQ_SJ2025040831_CST_07
;
SElECT '08' seq, *
from lab_sjxq.SJXQ_SJ2025040831_CST_08
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040831_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct self_acc_no) custs
from SJXQ_SJ2025040831_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct glbl_srl_nbr) custs
from SJXQ_SJ2025040831_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 存款账号,序号) custs
from SJXQ_SJ2025040831_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025040831_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 业务流水号) custs
from SJXQ_SJ2025040831_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025040831_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ2025040831_CST_08
;
/*
*/***王梦娜_SJ2025081311_宁波分行反洗钱检查.sql
-- 王梦娜_SJ2025081311_宁波分行反洗钱检查
DROP   TABLE IF     EXISTS SJXQ_SJ2025081311_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025081311_CST_01 AS
select cst_id                                   --客户号|C20
	,cst_nm                                   --客户名称|C200
	,opr_scp_dscr                             --经营范围描述|C3000
	,idt_ctg_cd                               --行业分类代码|C10
	,reg_cnr_cd                               --注册国家代码|C3
	,lctax_cert_no                            --地税证件号|C60
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
from edw.dim_cst_entp_bas_inf_dd t1             --企业客户基本信息
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250731'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250731'
and t4.brc_org_nm='宁波分行'
where t1.dt='@@{yyyyMMdd}'
***王洋_SJ2025030421_嘉兴分行泰e贷进件信息.sql
﻿-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025030421_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030421_CST_01 AS
SELECT t1.dt,t1.APLY_ACPT_NO                             --申请受理编号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.CST_TYP_CD                               --客户类型代码|C4
	,t1.PRD_NO                                   --产品编号|C32
	,t1.PRD_NM                                   --产品名称|C200
    ,t1.APLY_ACPT_SUB_CLSS_CD
    ,c2.cd_val_dscr     as APLY_ACPT_SUB_CLSS_nm --申请受理细类
	,t1.MGR_ID                                   --管户人工号|C10
    ,t5.empe_nm     as mgr_nm
	,t1.MGR_ORG_ID                               --管户机构编号|C12
	,t1.PRE_ASES_SERNO                           --预评估流水号|C32
	,t1.ACPT_STS_CD                              --受理状态代码|C2
    ,c1.cd_val_dscr     as ACPT_STS_nm
	,t1.SYS_REG_TM                               --系统登记时间|C19
    ,t3.ctr_serno,t3.prd_no 	as ctr_prd_no
	,t6.pd_nm 	as ctr_pd_nm
FROM EDW.DWD_BUS_LOAN_APLY_ACPT_INF_DD              t1 --申请受理信息
LEFT JOIN edw.DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD    t2
ON t1.APLY_ACPT_NO = t2.APLY_ACPT_NO
AND t2.DT = '20250228'
LEFT JOIN edw.DIM_BUS_LOAN_CTR_BSE_INF_DD           t3
ON t2.USC_APLY_SERNO = t3.REL_SERNO
AND t3.DT = '20250228'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.MGR_ORG_ID = t4.org_id
and t4.dt = '20250228'
and t4.brc_org_nm='嘉兴分行'
left join edw.dwd_code_library_dd           c1
on t1.ACPT_STS_CD = c1.cd_val
and c1.dt = '20250228'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.mgr_id=t5.empe_id
and t5.dt='20250228'
left join edw.dwd_code_library_dd           c2
on t1.APLY_ACPT_SUB_CLSS_CD = c2.cd_val
and c2.dt = '20250228'
left join edw.dim_bus_loan_prd_frml_dd     t6
on t3.prd_no=t6.prd_no
and t6.dt='20250228'
WHERE t1.DT = '20250228'
AND t1.APLY_ACPT_SUB_CLSS_CD = '015' --泰e贷
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030421_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030421_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
	,t2.PRE_ASES_rul_nm  --预评估触发规则
	,t2.PRE_ASES_prmpt_msg  --预评估提示信息
	,t1.rn2
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
		,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn2
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
	and cst_id in(select CST_ID from SJXQ_SJ2025030421_CST_01)
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
	LEFT JOIN
	(
		SELECT  B1.rul_set_rslt_serno
		FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
		WHERE B1.DT = '20250228'
		GROUP BY  B1.rul_set_rslt_serno
	) T3
	ON T2.rul_set_rslt_serno = T3.rul_set_rslt_serno
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
-- 新预评估信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025030421_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030421_CST_02_1 AS
SELECT  A1.cst_id,a2.pre_ases_serno
       ,A2.最近一次预评估结果
       ,A2.最近一次预评估时间
       ,A2.预评估触发规则
       ,A2.预评估提示信息
       ,a2.rn2
FROM
(
	SELECT  DISTINCT cst_id
	FROM lab_bigdata_dev.SJXQ_SJ2025030421_CST_01
) A1
LEFT JOIN
(
    SELECT  T1.aplc_no      AS cst_id
		,t1.pre_ases_serno
        ,c1.cd_val_dscr     AS 最近一次预评估结果
        ,T1.gen_tm          AS 最近一次预评估时间
        ,T3.预评估触发规则
        ,T3.预评估提示信息
	    ,ROW_NUMBER() OVER ( PARTITION BY T1.aplc_no ORDER BY  T1.pre_ases_rslt_serno DESC,t1.pre_ases_rslt_serno desc) AS RN
        ,ROW_NUMBER() OVER ( PARTITION BY T1.aplc_no ORDER BY  T1.sys_reg_tm DESC,t1.pre_ases_rslt_serno desc) AS RN2
	FROM edw.DIM_BUS_LOAN_PRE_ASES_RSLT_INF_DD          T1 --预评估结果信息 pre_ases_rslt_serno 唯一
	LEFT JOIN edw.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2 --预评估规则集关系 rul_set_rslt_serno 唯一
	ON T1.pre_ases_rslt_serno = T2.rul_set_rslt_serno
    AND T2.DT = '20250228'
	LEFT JOIN edw.dwd_code_library_dd c1 -- 码值表
	ON T2.rul_set_rslt_cd = c1.cd_val
    AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND c1.fld_nm = 'RUL_SET_RSLT_CD'
    AND c1.DT = '20250228'
	LEFT JOIN
	(
		SELECT  B1.rul_set_rslt_serno
		FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
		WHERE B1.DT = '20250228'
		GROUP BY  B1.rul_set_rslt_serno
	) T3
	ON T2.rul_set_rslt_serno = T3.rul_set_rslt_serno
	WHERE T1.DT = '20250228'
) A2
ON A1.cst_id = A2.cst_id
AND A2.RN = 1
;
-- 地址
DROP   TABLE IF     EXISTS SJXQ_SJ2025030421_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030421_CST_03 AS
SELECT  t1.cst_id
       ,c1.cd_val_dscr     AS loan_madr_type
       ,t4.dtl_addr        AS 信贷居住地址
       ,t2.dtl_addr        AS 信贷经营地址
       ,t3.dtl_addr        AS 信贷户籍地址
       ,t5.dtl_addr        AS 信贷办公地址
       ,t6.dtl_addr        AS 信贷注册地址
       ,t7.dtl_addr        AS 信贷主地址
       ,t8.svy_dt          AS 最近一次调查日期
       ,t8.svy_addr        AS 最近一次调查地址
       ,t8.svy_addr_typ_nm AS 最近一次调查地址类型
from(
    select distinct cst_id
    from SJXQ_SJ2025030421_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250228' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250228' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '20250228' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --家庭地址
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '20250228' and t5.del_ind='0' 	--未删除
AND t5.addr_typ = '050400' --办公地址
LEFT JOIN edw.loan_cst_ctc_addr t6
ON t1.cst_id = t6.cst_id and t6.del_ind='0' 	--未删除
AND t6.dt = '20250228'
AND t6.addr_typ = '050800' --注册地址
LEFT JOIN edw.loan_cst_ctc_addr t7
ON t1.cst_id = t7.cst_id and t7.del_ind='0' 	--未删除
AND t7.dt = '20250228'
AND t7.main_addr_ind = '1' --主地址
LEFT JOIN
(
	SELECT  t1.cst_id,t1.svy_dt,t1.svy_addr,t1.svy_addr_typ_cd
        ,c1.cd_val_dscr     as svy_addr_typ_nm
	    ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id ORDER BY  t1.svy_dt DESC ) AS rn
	FROM edw.DWD_BUS_LOAN_CST_SVY_RCD_DD    t1 --客户调查记录信息, 一个客户会有多个调查记录
    left join EDW.DWD_CODE_LIBRARY_DD       c1
    on t1.svy_addr_typ_cd=c1.cd_val
    and C1.DT = '@@{yyyyMMdd}'
	WHERE t1.dt = '20250228'
) t8 ON t1.cst_id = t8.cst_id AND t8.rn = 1
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t7.addr_typ=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030421_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030421_CST_04 AS
SELECT  t1.dt                    AS 数据日期
       ,t1.CST_ID                AS 客户号
       ,t1.CST_NM                AS 客户名称
       ,t1.APLY_ACPT_SUB_CLSS_nm AS 申请受理细类
       ,t1.PRD_NM                AS 申请产品名称
       ,t1.ACPT_STS_nm           AS 受理状态
       ,t1.ctr_pd_nm             AS 合同产品名称
       ,t6.ted_fst_vld_dt        AS 首笔泰e贷合同生效日期
       ,t1.MGR_ORG_ID            AS 管户机构编号
       ,t1.MGR_ID                AS 管户人工号
       ,t1.mgr_nm                AS 管户人
       ,t2.PRE_ASES_SERNO        AS 最近一次预评估流水号
       ,t2.PRE_ASES_prmpt_msg    AS 最近一次预评估提示信息
       ,t3.loan_madr_type as 信贷主地址类型
       ,t3.信贷经营地址
       ,t3.信贷居住地址
       ,t3.信贷办公地址
       ,t3.信贷户籍地址
       ,t3.信贷注册地址
       ,t3.信贷主地址
       ,t3.最近一次调查日期
       ,t3.最近一次调查地址
       ,t3.最近一次调查地址类型
from SJXQ_SJ2025030421_CST_01       t1
left join SJXQ_SJ2025030421_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025030421_CST_03  t3
on t1.cst_id=t3.cst_id
left join(
    select t1.cst_id,min(ctr_eff_dt)   ted_fst_vld_dt  --合同生效日期
    from edw.DIM_BUS_LOAN_CTR_BSE_INF_DD  t1
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20250228'
    and t2.pd_nm regexp '泰e贷'
    where t1.dt='20250228'
	and ctr_eff_dt<>'18991231'
    group by t1.cst_id
)t6 on t1.cst_id=t6.cst_id
;
SElECT '04' seq, *
from SJXQ_SJ2025030421_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct APLY_ACPT_NO) custs
from SJXQ_SJ2025030421_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030421_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030421_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025030421_CST_04
;
/*
01	34248	34248
02	29014	29014
03	29014	29014
04	34248	29014
*/***王玉婷_SJ2025062331_反洗钱季度考核.sql
-- 王玉婷_SJ2025062331_反洗钱季度考核
DROP   TABLE IF     EXISTS SJXQ_SJ2025062331_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062331_CST_01 AS
SELECT  SUBSTR(t1.party_id,3,10)  as cst_id      --客户号
    ,t1.party_chn_name                           --客户名称
    ,t1.levelkey                                 --最终风险等级
    ,t1.fristappralevel                          --初评等级
    ,t1.statistic_dt                             --评级日期
    ,t1.organkey                                 --客户机构
    ,decode(t1.status_cd,'0','系统初评','1','上报未审核','2','审核不通过','3','审核通过','4','不需上报已处理','5','审批不通过','6','审批通过') as 评级结果状态
    ,decode(t1.tempcategory,'1','新开户','2','定期核查') as 模板类别
    ,t1.audit_user                               --提交人
    ,t1.audit_dt                                 --提交日期
    ,t2.AUDIT_NO    --调整序号
    ,t2.level_before_adjust                      --调整前风险等级
    ,t2.level_after_adjust                       --调整后风险等级
    ,t2.adjust_reason                            --编辑岗处理意见
    ,t2.res_post_id                              --接收岗位
    ,t2.post_id                                  --提交岗位
    ,t2.last_upd_dt                              --调整日期
    ,RANK() OVER (PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t2.AUDIT_NO DESC) AS rn
FROM adm_upss.aml_t37_party_result_curr         t1 --评级当前结果表
LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2 --评级等级调整当前表
ON      t1.RESULEKEY = t2.RSLTKEY
AND     t1.PARTY_ID = t2.PARTY_ID
AND     t2.POST_ID = 'P2001' --编辑岗
and     t1.dt=t2.dt
WHERE t1.dt = '20250612'
and t1.organkey like '4261%' --湖北大冶泰隆村镇银行
and substr(replace(t1.statistic_dt,'-',''),1,8) between '20250325' and '20250623'   --评级日期
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025062331_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062331_CST_02 AS
SELECT  cst_id              AS 客户号
       ,party_chn_name      AS 客户名称
       ,levelkey            AS 最终风险等级
       ,fristappralevel     AS 初评等级
       ,statistic_dt        AS 评级日期
       ,organkey            AS 客户机构
       ,评级结果状态
       ,模板类别
       ,audit_user          AS 提交人
       ,audit_dt            AS 提交日期
       ,level_before_adjust AS 调整前风险等级
       ,level_after_adjust  AS 调整后风险等级
       ,adjust_reason       AS 编辑岗处理意见
       ,res_post_id         AS 接收岗位
       ,post_id             AS 提交岗位
       ,last_upd_dt         AS 调整日期
from SJXQ_SJ2025062331_CST_01
where rn=1
order by statistic_dt
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025062331_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025062331_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025062331_CST_02
***王玉婷_SJ2025071731_风险客户评级情况.sql
-- 王玉婷_SJ2025071731_风险客户评级情况
DROP   TABLE IF     EXISTS SJXQ_SJ2025071731_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071731_CST_01 AS
select *
from(
    SELECT  SUBSTR(t1.party_id,3,10)  as cst_id      --客户号
        ,t1.party_chn_name                           --客户名称
        ,t1.levelkey                                 --最终风险等级
        ,t1.fristappralevel                          --初评等级
        ,t1.gskey	    --公式编号
        ,t3.gsname
        ,t1.statistic_dt                             --评级日期
        ,t1.organkey                                 --客户机构
        ,t4.org_nm
        ,decode(t1.status_cd,'0','系统初评','1','上报未审核','2','审核不通过','3','审核通过','4','不需上报已处理','5','审批不通过','6','审批通过') as 评级结果状态
        ,decode(t1.tempcategory,'1','新开户','2','定期核查') as 模板类别
        ,t1.audit_user                               --提交人
        ,t1.audit_dt                                 --提交日期
        ,t2.AUDIT_NO    --调整序号
        ,t2.level_before_adjust                      --调整前风险等级
        ,t2.level_after_adjust                       --调整后风险等级
        ,t2.adjust_reason                            --编辑岗处理意见
        ,t2.res_post_id                              --接收岗位
        ,t2.post_id                                  --提交岗位
        ,t2.last_upd_dt                              --调整日期
        ,RANK() OVER (PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t2.AUDIT_NO DESC) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1 --评级当前结果表
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2 --评级等级调整当前表
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    LEFT JOIN    adm_upss.aml_t31_def_gs        t3
    ON  t1.gskey = t3.gskey
    AND t3.dt = t1.dt
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t1.organkey = t4.org_id
    and t4.dt = t1.dt
    WHERE t1.dt = '20250717'
    and t1.organkey like '4261%' --湖北大冶泰隆村镇银行
)t1 where t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071731_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071731_CST_02 AS
SELECT  cst_id              AS 客户号
       ,party_chn_name      AS 客户名称
       ,levelkey            AS 最终风险等级
       ,fristappralevel     AS 初评等级
       ,gsname              AS 评级公式名称
       ,statistic_dt        AS 评级日期
       ,org_nm              AS 客户机构
       ,评级结果状态
       ,模板类别
       ,audit_user          AS 提交人
       ,audit_dt            AS 提交日期
       ,level_before_adjust AS 调整前风险等级
       ,level_after_adjust  AS 调整后风险等级
       ,adjust_reason       AS 编辑岗处理意见
       ,res_post_id         AS 接收岗位
       ,'编辑岗'               AS 提交岗位
       ,last_upd_dt         AS 调整日期
       ,row_number() over(order by statistic_dt asc) as 序号
from SJXQ_SJ2025071731_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071731_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071731_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025071731_CST_02
***王玉婷_SJ20250724111_内部数据治理.sql
﻿-- 王玉婷_SJ20250724111_内部数据治理
-- 未做只收不付、不收不付控制
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_01 AS
SELECT t1.cst_id
	,t1.cst_act_id
	,t1.card_type
from(
	select cst_id
		,cst_act_id                    		      --客户账号|C32
		-- ,act_cls_frz_ind                          --账户封闭冻结标志 不收不付
		-- ,act_stop_pmt_ind                         --账户只收不付标志|c1
		,'jjk' as card_type
	from edw.dws_bus_dep_act_inf_dd               --存款账户信息汇总
	where dt='20250728'
	and act_sts_cd='A'                               --存款账户状态 A:正常
	-- and (act_cls_frz_ind<>'1' or act_stop_pmt_ind<>'1') 	--不准
	union
	SELECT  a.cst_id
		,b.cr_crd_card_nbr 		--信用卡卡号
		-- ,'0' AS act_cls_frz_ind 	--封闭冻结
		-- ,null
		,'xyk' as card_type
	FROM edw.dim_cst_idv_bas_inf_dd a
	INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd b
	ON a.cst_id = b.cst_id
	AND b.dt = a.dt
	AND b.card_sts_cd NOT IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) 	--Q:销户申请
	AND b.LATE_CARD_IND = '1' 	--最新卡标志
	WHERE a.dt = '20250728'
)t1 left join(
	--关闭非柜面
    SELECT  distinct cst_act_id
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '20250728'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t2 on t1.cst_act_id=t2.cst_act_id
left join(
	--冻结,控制
    SELECT T1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    WHERE   T1.DT = '20250728'
    AND     T1.NFRZ_IND = '0'   --未解冻 0否|1是
)t3 on t1.cst_act_id=t3.cst_act_id
where t2.cst_act_id is null 	--剔除暂停非柜面
and t3.cst_act_id is null 		--剔除冻结,控制
;
-- 表1：对公客户受益所有人信息录入缺失
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_02 AS
SELECT  cst_id
       ,SUM(is_syr_nm_null)  AS 受益人空的个数
       ,SUM(is_doc_typ_null) AS 受益人证件类型空的个数
       ,SUM(is_doc_nbr_null) AS 受益人证件号空的个数
from(
	select substr(party_id,3,10) as cst_id        --客户号
		,bfi_name                                 --受益人名称
		,card_type                                --证件类型代码
		,card_no                                  --证件号码
		,case when length(bfi_name)<=1 then 1 else 0 end as is_syr_nm_null
		,case when length(card_type)<=1 then 1 else 0 end as is_doc_typ_null
		,case when length(card_no)<=1 then 1 else 0 end as is_doc_nbr_null
	from adm_upss.adm_upss_aml_t47_beneficiary    --对公客户受益所有人表
	where dt='20250728'
	and (length(bfi_name)<=1 or length(card_type)<=1 or length(card_no)<=1)
)t1 group by cst_id
;
-- 结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_RES01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_RES01 AS
SELECT  t1.cst_id     AS 客户号
       ,t3.cst_chn_nm AS 客户名称
       ,t4.prm_mgr_id AS 主管护客户经理工号
       ,t4.prm_mgr_nm AS 主管护客户经理姓名
       ,t4.prm_org_id AS 主管护机构号
       ,t4.prm_org_nm AS 主管户机构名称
       ,t2.cst_act_id AS 正常客户账号
       ,t1.受益人空的个数
       ,t1.受益人证件类型空的个数
       ,t1.受益人证件号空的个数
from SJXQ_SJ20250724111_CST_02 			t1
inner join SJXQ_SJ20250724111_CST_01 	t2
on t1.cst_id=t2.cst_id
left join edw.DWS_CST_BAS_INF_DD        t3
on t1.cst_id=t3.cst_id
and t3.dt='20250728'
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt = '20250728'
and t4.prm_org_id like '4261%' 	--湖北大冶村镇银行
;
-- SELECT * from SJXQ_SJ20250724111_CST_03
-- 外部工商数据 edw.NOUT_COMPANY_BASE   ---工商信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_03 AS
SELECT  t1.company_id     --主体唯一键
       ,t1.company_name   --企业名称
       ,t1.company_status --登记状态
       ,t1.cancel_date    --注销日期
       ,t1.revoke_date    --吊销日期
       ,t3.cst_id         --客户号|C20
       ,t3.cst_nm         --客户名称|C200
	   ,t4.n_company_status
from edw.nout_company_base              t1 --企业基本信息表
inner join edw.dim_cst_entp_bas_inf_dd	t3 --企业客户基本信息
on t1.credit_no=t3.lctax_cert_no	--地税证件号
and t3.dt='20250728'
inner JOIN edw.nout_company_base_clean  t4
on t1.company_id=t4.company_id
and t4.dt='20250728'
and t4.use_flag<>'10'  --10废弃数据
and t4.n_company_status regexp '吊销|注销|迁入|迁出|停业|清算'
where t1.dt='20250728'
and nvl(t1.credit_no,'')<>''
;
-- 结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_RES02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_RES02 AS
SELECT  t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户名称
       ,t4.prm_mgr_id       AS 主管护客户经理工号
       ,t4.prm_mgr_nm       AS 主管护客户经理姓名
       ,t4.prm_org_id       AS 主管护机构号
       ,t4.prm_org_nm       AS 主管户机构名称
       ,t2.cst_act_id       AS 正常客户账号
       ,t1.n_company_status AS 登记状态
from SJXQ_SJ20250724111_CST_03 			t1
inner join SJXQ_SJ20250724111_CST_01 	t2
on t1.cst_id=t2.cst_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt = '20250728'
and t4.prm_org_id like '4261%' 	--湖北大冶村镇银行
;
-- SELECT * FROM SJXQ_SJ20250724111_CST_04
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_04 AS
select cst_id                                   --客户号|C20
	,cst_chn_nm                               --客户姓名|C200
	,mbl_nbr                                  --手机|C32
	,fml_tel_nbr                              --家庭电话|C32
	,case when length(mbl_nbr)<>11 or mbl_nbr not like '1%'
		or mbl_nbr regexp '0000000|1111111|2222222|3333333|4444444|5555555|6666666|7777777|8888888|9999999|1234567|7654321'
		then 1 else 0 end as is_mbl_abnormal
	,case when length(fml_tel_nbr)=0 THEN '空'
		WHEN length(fml_tel_nbr)=11 and fml_tel_nbr like '1%'
		and fml_tel_nbr regexp '0000000|1111111|2222222|3333333|4444444|5555555|6666666|7777777|8888888|9999999|1234567|7654321'
		then '家庭电话异常1'
		when length(fml_tel_nbr)<>11 and fml_tel_nbr like '1%' and (length(fml_tel_nbr)<7
			or fml_tel_nbr regexp '0000000|1111111|2222222|3333333|4444444|5555555|6666666|7777777|8888888|9999999|1234567|7654321')
		then '家庭电话异常2' else '正常' end as is_fml_abnormal
from edw.dws_cst_bas_inf_dd                   --客户基础信息汇总表
where dt='20250728'
and cst_typ_cd='1'                               --客户类型
and (
		(
			length(mbl_nbr)<>11 or mbl_nbr not like '1%'
			or mbl_nbr regexp '0000000|1111111|2222222|3333333|4444444|5555555|6666666|7777777|8888888|9999999|1234567|7654321'
		)
		or
		(
			length(fml_tel_nbr)=11 and fml_tel_nbr like '1%'
			and fml_tel_nbr regexp '0000000|1111111|2222222|3333333|4444444|5555555|6666666|7777777|8888888|9999999|1234567|7654321'
		) or(
			length(fml_tel_nbr)<>11 and fml_tel_nbr like '1%' and (length(fml_tel_nbr)<7
			or fml_tel_nbr regexp '0000000|1111111|2222222|3333333|4444444|5555555|6666666|7777777|8888888|9999999|1234567|7654321')
		)
	)
;
-- 结果3
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_RES03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_RES03 AS
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 客户名称
       ,t4.prm_mgr_id AS 主管护客户经理工号
       ,t4.prm_mgr_nm AS 主管护客户经理姓名
       ,t4.prm_org_id AS 主管护机构号
       ,t4.prm_org_nm AS 主管户机构名称
       ,t2.cst_act_id AS 正常客户账号
	-- ,case when t1.is_mbl_abnormal=1 then t1.mbl_nbr else null end as 异常手机号
	-- ,case when t1.is_fml_abnormal<>'正常' then t1.fml_tel_nbr else null end as 异常家庭电话
from SJXQ_SJ20250724111_CST_04 			t1
inner join SJXQ_SJ20250724111_CST_01 	t2
on t1.cst_id=t2.cst_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt = '20250728'
and t4.prm_org_id like '4261%' 	--湖北大冶村镇银行
;
-- 结果4
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_RES04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_RES04 AS
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 客户姓名
       ,t4.prm_mgr_id AS 主管护客户经理工号
       ,t4.prm_mgr_nm AS 主管护客户经理姓名
       ,t4.prm_org_id AS 主管护机构号
       ,t4.prm_org_nm AS 主管户机构名称
       ,t2.cst_act_id AS 正常客户账号
       ,CASE WHEN t1.doc_mtu_dt='18991231' THEN '' ELSE t1.doc_mtu_dt END as 证件到期日
from edw.dws_cst_bas_inf_dd  			t1                 --客户基础信息汇总表
inner join SJXQ_SJ20250724111_CST_01 	t2
on t1.cst_id=t2.cst_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt = '20250728'
and t4.prm_org_id like '4261%' 	--湖北大冶村镇银行
where t1.dt='20250728'
and t1.doc_mtu_dt<'20250728'  	--证件到期日期
;
-- 结果5
DROP   TABLE IF     EXISTS SJXQ_SJ20250724111_CST_RES05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250724111_CST_RES05 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_chn_nm  AS 客户中文名称
       ,t4.prm_mgr_id  AS 主管护客户经理工号
       ,t4.prm_mgr_nm  AS 主管护客户经理姓名
       ,t4.prm_org_id  AS 主管护机构号
       ,t4.prm_org_nm  AS 主管户机构名称
       ,t1.job_unt_nm  AS 工作单位名称
       ,t2.cst_act_id  AS 正常客户账号
       ,t1.ocp_cd      AS 职业代码
       ,c1.cd_val_dscr AS 职业
from edw.dim_cst_idv_bas_inf_dd         t1          --个人客户基本信息
inner join SJXQ_SJ20250724111_CST_01 	t2
on t1.cst_id=t2.cst_id
inner join adm_pub.adm_csm_cbas_mng_inf_dd t4 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t4.cst_id
and t4.dt = '20250728'
and t4.prm_org_id like '4261%' 	--湖北大冶村镇银行
left join edw.dwd_code_library_dd   c1
on t1.ocp_cd = c1.cd_val
and c1.dt = '20250728'
where t1.dt='20250728'
and length(t1.job_unt_nm)>1
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250724111_CST_RES01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250724111_CST_RES02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250724111_CST_RES03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250724111_CST_RES04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250724111_CST_RES05
;
/*
04	174	168
05	2340	2053
*/
SElECT '01' seq, * from lab_sjxq.SJXQ_SJ20250724111_CST_RES01;
SElECT '02' seq, * from lab_sjxq.SJXQ_SJ20250724111_CST_RES02;
SElECT '03' seq, * from lab_sjxq.SJXQ_SJ20250724111_CST_RES03;
SElECT '04' seq, * from lab_sjxq.SJXQ_SJ20250724111_CST_RES04;
SElECT '05' seq, * from lab_sjxq.SJXQ_SJ20250724111_CST_RES05;
***王玲英_SJ2025020521_客户盘点.sql
﻿DROP   TABLE IF EXISTS SJXQ_SJ2025020521_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025020521_CST_01
(
    seq      string COMMENT '工号'
    ,entp_nm string COMMENT '客户姓名'
)
;
insert into SJXQ_SJ2025020521_CST_01
values (1,'浙江国远建设有限公司'),
    (2,'浙江台州华业建设工程有限公司'),
    (3,'浙江良九园林建设有限公司'),
    (4,'台州弘丰建设有限公司'),
    (5,'浙江百川新型建材有限公司'),
    (6,'浙江虹升建设工程有限公司'),
    (7,'江西洪明建筑工程有限公司'),
    (8,'温州市伟业装饰有限公司'),
    (9,'浙江辉志建设有限公司'),
    (10,'浙江汇力建设有限公司'),
    (11,'浙江名禹工程建设有限公司'),
    (12,'宁夏建工集团有限公司'),
    (13,'台州市富搏建设有限公司'),
    (14,'浙江喻鼎建设有限公司'),
    (15,'徐州市水利工程建设有限公司'),
    (16,'绍兴市公用工程建设有限公司'),
    (17,'杭州迈卓建设有限公司'),
    (18,'台州国丰建设有限公司'),
    (19,'深圳市卓艺建设装饰工程股份有限公司'),
    (20,'安徽水安建设集团股份有限公司'),
    (21,'方远建设集团股份有限公司'),
    (22,'鼎天建设集团有限公司'),
    (23,'浙江泽国建设有限公司'),
    (24,'台州市金港建设工程有限公司'),
    (25,'台州豪鑫建设有限公司'),
    (26,'台州昊恺建设工程有限公司'),
    (27,'台州市名久市政工程有限公司'),
    (28,'中建港航局集团有限公司'),
    (29,'台州鑫宸建设有限公司'),
    (30,'玉环汇通建设有限公司'),
    (31,'浙江国力建设工程有限公司'),
    (32,'广州市第二市政工程有限公司'),
    (33,'华神建设集团有限公司'),
    (34,'宏信建设有限公司'),
    (35,'台州大丰建设有限公司'),
    (36,'浙江佳日建设工程有限公司'),
    (37,'温州鹏遥建设工程有限公司'),
    (38,'台州春秋水利水电建设有限公司'),
    (39,'临海市第四建筑工程公司'),
    (40,'台州市泰辉市政工程有限公司'),
    (41,'浙江金业建设有限公司'),
    (42,'浙江九渊塑业有限公司'),
    (43,'浙江新南北物业管理集团有限公司'),
    (44,'浙江一方建筑装饰实业有限公司'),
    (45,'帝豪建设有限公司'),
    (46,'浙江宝业建设集团有限公司'),
    (47,'浙江华冠工程项目管理有限公司'),
    (48,'美华建设有限公司'),
    (49,'浙江祥生建设工程有限公司'),
    (50,'浙江振冲岩土工程有限公司'),
    (51,'浙江鑫宇装饰工业有限公司'),
    (52,'浙江一诚工程咨询有限公司'),
    (53,'浙江天禹水电建设有限公司'),
    (54,'台州市康程建设工程有限公司'),
    (55,'浙江驰丰建设有限公司'),
    (56,'浙江水曜园林工程有限公司'),
    (57,'温州祥钰建设有限公司'),
    (58,'浙江宏冠建设有限公司'),
    (59,'台州垚森建设有限公司'),
    (60,'台州威锋建设有限公司'),
    (61,'浙江领海建设有限公司'),
    (62,'台州通达建设有限公司'),
    (63,'浙江亚烶园林绿化有限公司'),
    (64,'浙江城峰建设工程有限公司'),
    (65,'嘉兴中业建设工程有限公司'),
    (66,'宁波建工工程集团有限公司'),
    (67,'台州万港建设有限公司'),
    (68,'浙江工诚建设有限公司'),
    (69,'浙江路川交通科技有限公司'),
    (70,'浙江五联建设有限公司'),
    (71,'临海市宸通建设工程有限公司'),
    (72,'台州市森磊环境建设有限公司'),
    (73,'浙江台州富强平安建设工程有限公司'),
    (74,'浙江宣星建设有限公司'),
    (75,'浙江联扬建设有限公司'),
    (76,'国强建设集团有限公司'),
    (77,'台州耀达环境工程有限公司'),
    (78,'浙江宇洋建设有限公司'),
    (79,'浙江国邺建设有限公司'),
    (80,'浙江铖峰建设有限公司'),
    (81,'三门中诚建设有限公司'),
    (82,'台州市四方交通建设工程有限公司'),
    (83,'浙江方圆市政工程有限公司'),
    (84,'浙江春禾生态建设有限公司'),
    (85,'浙江荣合建设有限公司'),
    (86,'浙江宏润建设有限公司'),
    (87,'台州国鑫市政建设工程有限公司'),
    (88,'浙江大经建设集团股份有限公司'),
    (89,'台州市人民水利水电工程有限公司'),
    (90,'中力建设集团有限公司'),
    (91,'浙江宏汭地基基础工程有限公司'),
    (92,'台州市建乐建设有限公司'),
    (93,'浙江鑫洋建设有限公司'),
    (94,'浙江启富建设有限公司'),
    (95,'浙江珠匠智慧能源科技有限公司'),
    (96,'浙江国腾建设集团有限公司'),
    (97,'台州市玮宏建设有限公司'),
    (98,'台州旭升市政工程有限公司'),
    (99,'台州市云达建设工程有限公司'),
    (100,'浙江西陆建筑有限公司'),
    (101,'浙江万诺建设有限公司'),
    (102,'锐博新能源集团有限公司'),
    (103,'台州远信建设工程有限公司'),
    (104,'温岭市环球市政工程有限公司'),
    (105,'温岭市胜途建设有限公司'),
    (106,'浙江景春装饰工程有限公司'),
    (107,'浙江广聚建设有限公司'),
    (108,'台州市鸿途环境建设有限公司'),
    (109,'浙江建盛建设集团有限公司'),
    (110,'博崛建设有限公司'),
    (111,'台州万达建筑工程有限公司'),
    (112,'浙江森禾集团股份有限公司'),
    (113,'台州华广工程管理有限公司'),
    (114,'台州市铭泰建设有限公司'),
    (115,'浙江中泰市政园林工程有限公司'),
    (116,'浙江豪业建设有限公司'),
    (117,'中铠建设集团有限公司'),
    (118,'浙江宏核建筑工程有限公司'),
    (119,'隆嘉建设集团有限公司'),
    (120,'宇杰集团股份有限公司'),
    (121,'台州市邦达建设有限公司'),
    (122,'浙江特安检测科技有限公司'),
    (123,'浙江天一交通建设有限公司'),
    (124,'中珒工程咨询有限公司'),
    (125,'杭州宏旭建设有限公司'),
    (126,'浙江金棕榈建设有限公司'),
    (127,'台州大顺建设有限公司'),
    (128,'台州银鸿建设有限公司'),
    (129,'台州市中驰建设工程有限公司'),
    (130,'浙江和立机电工程有限公司'),
    (131,'浙江新中环建设集团有限公司'),
    (132,'台州市祎航建设有限公司'),
    (133,'济南城建集团有限公司'),
    (134,'台州绿茵市政园林有限公司'),
    (135,'浙江三门兴港建设有限公司'),
    (136,'宁波甬晟路桥建设有限公司'),
    (137,'浙江伟星环境建设有限公司'),
    (138,'浙江宝立建设有限公司'),
    (139,'龙元建设集团股份有限公司'),
    (140,'台州标邦建设有限公司'),
    (141,'浙江青蓝湾工程建设有限公司'),
    (142,'浙江宝昱建设有限公司'),
    (143,'洪城控股集团有限公司'),
    (144,'浙江昌新交通建设有限公司'),
    (145,'浙江东星消防工程有限公司'),
    (146,'台州创园工程管理有限公司'),
    (147,'浙江东旺工程管理有限公司'),
    (148,'嘉林建设集团有限公司'),
    (149,'杭州申昊科技股份有限公司'),
    (150,'浙江宏图科技有限公司'),
    (151,'浙江旭瑞建设有限公司'),
    (152,'浙江亿通建设有限公司'),
    (153,'深圳市科源建设集团股份有限公司'),
    (154,'浙江森海建设有限公司'),
    (155,'浙江中业信息科技有限公司'),
    (156,'浙江百晓生节能科技有限公司'),
    (157,'台州市海康水电建设有限公司'),
    (158,'浙江赞颂建设有限公司'),
    (159,'浙江省三门建安工程有限公司'),
    (160,'温岭市第一建筑工程有限公司'),
    (161,'浙江利菲膜结构工程有限公司'),
    (162,'台州森远建设有限公司'),
    (163,'浙江景天园林工程有限公司'),
    (164,'浙江安洲建设有限公司'),
    (165,'台州市绿石建设有限公司'),
    (166,'浙江大地钢结构有限公司'),
    (167,'台州立创建设有限公司'),
    (168,'中磐建设集团有限公司'),
    (169,'浙江垚坤建设有限公司'),
    (170,'温州泰洲建设有限公司'),
    (171,'台州市金地园林市政工程有限公司'),
    (172,'天颂建设集团有限公司'),
    (173,'曙光控股集团有限公司'),
    (174,'浙江智晟科技有限公司'),
    (175,'浙江环宇建设集团有限公司'),
    (176,'台州市华广建设有限公司'),
    (177,'宏远建设有限公司'),
    (178,'天翔建设集团有限公司'),
    (179,'浙江亚超建设股份有限公司'),
    (180,'标力建设集团有限公司'),
    (181,'玉环经纬市政园林工程有限公司'),
    (182,'浙江国和建设有限公司'),
    (183,'浙江博星化工涂料有限公司'),
    (184,'台州鑫安建设有限公司'),
    (185,'浙江万里建设工程有限公司'),
    (186,'浙江唐臣空间设计工程有限公司'),
    (187,'浙江万兴建设有限公司'),
    (188,'台州市东晨建设工程有限公司'),
    (189,'台州友顺建设有限公司'),
    (190,'中垭建设集团有限公司'),
    (191,'龙邦建设股份有限公司'),
    (192,'临海市交通工程建设有限公司'),
    (193,'台州市金鼎建设工程有限公司'),
    (194,'中化学曙光建设有限公司'),
    (195,'台州博呈建设有限公司'),
    (196,'河南龙业环建工程有限公司'),
    (197,'浙江康远国际旅行社有限公司'),
    (198,'杭州宝鑫装饰有限公司'),
    (199,'台州荣星建设有限公司'),
    (200,'浙江中远工程管理有限公司'),
    (201,'台州多广建设有限公司'),
    (202,'杭州水电建筑集团有限公司'),
    (203,'浙江方舟建设有限公司'),
    (204,'台州忠恒交通工程有限公司'),
    (205,'浙江中天智汇安装工程有限公司'),
    (206,'台州市安利建筑劳务有限公司'),
    (207,'台州市浩海水利工程有限公司'),
    (208,'台州新联康建设有限公司'),
    (209,'新天一集团有限公司'),
    (210,'浙江金路交通工程有限公司'),
    (211,'台州豪成园林市政工程有限公司'),
    (212,'浙江海邦建筑工程有限公司'),
    (213,'临海市大昌市政建设有限公司'),
    (214,'浙江新馥电梯有限公司'),
    (215,'浙江中久消防工程有限公司'),
    (216,'浙江皓童建设工程有限公司'),
    (217,'浙江鼎鑫路桥养护工程有限公司'),
    (218,'腾达建设集团股份有限公司'),
    (219,'浙江鑫泰工程建设有限公司'),
    (220,'浙江扬天建设有限公司'),
    (221,'浙江宝伦流体智控设备有限公司'),
    (222,'台州宏丰建设有限公司'),
    (223,'台州市椒江万泓人力资源有限公司'),
    (224,'浙江润方建设有限公司'),
    (225,'浙江鼎丰建设有限公司'),
    (226,'杭州滨江区市政园林工程有限公司'),
    (227,'浙江汪洋建设有限公司'),
    (228,'台州辰远建设有限公司'),
    (229,'梅州市威华水利水电建设工程有限公司'),
    (230,'上海新置建筑工程有限公司'),
    (231,'河南昼曼建筑工程有限公司'),
    (232,'浙江省正邦水电建设有限公司'),
    (233,'温岭市市政环境工程公司'),
    (234,'台州市海江水利工程有限公司'),
    (235,'浙江永顺机械工程有限公司'),
    (236,'浙江新启源城市文化发展有限公司'),
    (237,'浙江庞氏塑业有限公司'),
    (238,'台州市中义建设有限公司'),
    (239,'浙江宏桥建设有限公司'),
    (240,'浙江铭宏照明工程有限公司'),
    (241,'浙江广鑫建设集团有限公司'),
    (242,'浙江立欣交通工程有限公司'),
    (243,'浙江省温岭市第五建筑工程有限公司'),
    (244,'中营晨旭建设有限公司'),
    (245,'台州巨元建筑工程有限公司'),
    (246,'杭州夏邦建设有限公司'),
    (247,'台州台盛建设有限公司'),
    (248,'浙江拓宇建设有限公司'),
    (249,'浙江乐达家居有限公司'),
    (250,'台州市东南汽摩配件有限公司'),
    (251,'浙江中星安全设施有限公司'),
    (252,'台州市特益塑料制造有限公司'),
    (253,'台州美晶进出口有限公司'),
    (254,'公元股份有限公司'),
    (255,'西诺控股集团有限公司'),
    (256,'浙江旭日工贸有限公司'),
    (257,'台州市黄岩双鱼科技有限公司'),
    (258,'浙江欢诺工贸有限公司'),
    (259,'浙江铭匠科技有限公司'),
    (260,'台州市康森装饰材料有限公司'),
    (261,'临海奥韦科技有限公司'),
    (262,'台州睿思进出口有限公司'),
    (263,'临海市术源眼镜有限公司'),
    (264,'浙江恒源洁具股份有限公司'),
    (265,'台州中际汽车零部件有限公司'),
    (266,'斯贝乐电器(浙江)股份有限公司'),
    (267,'临海市缘和休闲用品有限公司'),
    (268,'浙江陈洁泵业有限公司'),
    (269,'温岭市尤拉电子商务有限公司'),
    (270,'富岭科技股份有限公司'),
    (271,'台州美丽宝鞋业股份有限公司'),
    (272,'台州市丰利莱科技股份有限公司'),
    (273,'台州鼎越鞋业股份有限公司'),
    (274,'浙江久旺麻世纪科技股份有限公司'),
    (275,'台州市国人温控卫浴科技有限公司'),
    (276,'爱仕达股份有限公司'),
    (277,'浙江瑞格铜业有限公司'),
    (278,'浙江三乐塑业有限公司'),
    (279,'台州华帅汽车配件股份有限公司'),
    (280,'浙江美亚第流体智控有限公司'),
    (281,'天台协力工贸有限公司'),
    (282,'浙江新族汽车用品股份有限公司'),
    (283,'海啊集团有限公司'),
    (284,'台州黄岩宇隆科技有限公司'),
    (285,'天台州好好汽车用品有限公司'),
    (286,'仙居县喜乐工艺礼品厂'),
    (287,'台州市俞悦宠物用品有限公司'),
    (288,'临海市泰丰针织股份有限公司'),
    (289,'台州雅森生物科技有限公司'),
    (290,'浙江台州黄岩金冠塑业有限公司'),
    (291,'台州市美乐日用塑料制品有限公司'),
    (292,'台州九橙商贸有限公司'),
    (293,'临海市绿茵硅胶科技有限公司'),
    (294,'台州天时利塑业有限公司'),
    (295,'台州越帆灯饰有限公司'),
    (296,'台州市椒江天宇科技有限公司'),
    (297,'台州市隆鸿塑业有限公司'),
    (298,'仙居县通远洗车用品有限公司'),
    (299,'台州市鑫韵家居用品有限公司'),
    (300,'仙居东恒工艺礼品有限公司'),
    (301,'浙江台州蕾成工贸有限公司'),
    (302,'台州市黄岩玖久塑料电子厂'),
    (303,'台州三鼎科技有限公司'),
    (304,'台州市信长塑业有限公司'),
    (305,'台州泓泰塑业有限公司'),
    (306,'台州丰蔚家居用品有限公司'),
    (307,'台州市台艺工艺品有限公司'),
    (308,'台州启程电子科技有限公司'),
    (309,'临海市乐林家居用品有限公司'),
    (310,'浙江台州昌利纺织科技有限公司'),
    (311,'浙江临海市天晨休闲用品有限公司'),
    (312,'台州市天时利塑业有限公司'),
    (313,'台州市黄岩伶凯塑料制品厂'),
    (314,'台州俞悦宠物用品有限公司'),
    (315,'台州市昇汉塑模有限公司'),
    (316,'台州路桥区康香塑料制品有限公司'),
    (317,'路桥金鸿达钢板制丝厂'),
    (318,'台州安莱达贸易'),
    (319,'台州香蕉工贸有限公司'),
    (320,'台州市大峰橡塑制品有限公司'),
    (321,'浙江台州黄岩和兴塑模有限公司'),
    (322,'临海班莎商贸有限公司'),
    (323,'台州森野力新能源科技有限公司'),
    (324,'台州精能精密器械有限公司'),
    (325,'台州好省科技有限公司'),
    (326,'台州奥颂有限公司'),
    (327,'可为塑业'),
    (328,'海口环自強食品有限公司'),
    (329,'台州市美亮眼镜有限公司'),
    (330,'亿海'),
    (331,'台州市沃图贸易有限公司'),
    (332,'浙江鲸狮盾知识产权有限公司'),
    (333,'浙江普鲁士厨卫有限公司'),
    (334,'福田机械有限公司'),
    (335,'台州的德诺鑫科技有限公司'),
    (336,'台州卓磊工具有限公司'),
    (337,'维熙'),
    (338,'台州市可劲造电子商务有限公司'),
    (339,'坤朋'),
    (340,'谷雨'),
    (341,'兴隆多贸'),
    (342,'浙江久生堂电子商务有限公司'),
    (343,'金飞装饰工程有限公司'),
    (344,'台州市得力佳文具有限公司'),
    (345,'馨缘广告'),
    (346,'台州苹柯工贸有限公司'),
    (347,'罗文进出口有限公司'),
    (348,'雅格品牌设计有限公司'),
    (349,'浙江合赢科技'),
    (350,'台州常鑫工艺品有限公司'),
    (351,'大木'),
    (352,'泛太国际'),
    (353,'台州诚奕机械'),
    (354,'台州天正'),
    (355,'台州市鼎韵电子商务有限公司'),
    (356,'达学笙电子商务'),
    (357,'浙江恒时'),
    (358,'华儿思进出口有限公司'),
    (359,'逸迅'),
    (360,'盖聂箱包'),
    (361,'腾晟塑模'),
    (362,'顺口科技有限公司'),
    (363,'晨昊塑料制品公司'),
    (364,'台州市博万罗机电有限公司'),
    (365,'台州捷跃机电有限公司'),
    (366,'鲲鹏云上'),
    (367,'安速国际货运代理有限公司（义乌分公司）'),
    (368,'台州天正灯饰'),
    (369,'台州市健丰帽业'),
    (370,'台州晨友'),
    (371,'南杭贸易'),
    (372,'恬恬黛制帽'),
    (373,'浦江禾叶贸易有限公司'),
    (374,'大鲸供应链'),
    (375,'温州寰宇物流科技有限公司'),
    (376,'宁波坤泽国际物流'),
    (377,'宁波汇吉科技'),
    (378,'台州市椒江川泽电子商务有限责任公司'),
    (379,'浙江亚思迈科技有限公司'),
    (380,'台州静创有限公司'),
    (381,'杭州税税易网络科技有限公司'),
    (382,'浙江黄岩金字塔塑料厂'),
    (383,'温州艾略特国际贸易有限公司'),
    (384,'台州市世野电子商务有限责任公司'),
    (385,'浙江省临海市上易灯饰有限公司'),
    (386,'经源'),
    (387,'上易燈飾'),
    (388,'浙江艾诺凡供应链管理有限公司'),
    (389,'乐享户外'),
    (390,'合肥希图科技'),
    (391,'台州市驰恩贸易有限公司'),
    (392,'台州好猫有限公司'),
    (393,'台州台牛贸易有限公司'),
    (394,'台州逸泰贸易有限公司'),
    (395,'宁波豪科'),
    (396,'台州贝煜电子商务有限公司'),
    (397,'浙江台州市军强机械有限公司'),
    (398,'台州黛幂贸易有限公司'),
    (399,'台州市黛幂贸易有限公司'),
    (400,'浙江芮阳'),
    (401,'钓嗨尼户外用品有限公司'),
    (402,'台州钓嗨尼户外有限公司'),
    (403,'台州钓嗨尼户外用品有限公司'),
    (404,'台州钓嗨尼'),
    (405,'九叶贸易有限公司'),
    (406,'宁波亮剑'),
    (407,'台州叁樟贸易有限公司'),
    (408,'温州寰宇供应链股份有限公司'),
    (409,'上海芬飞国际贸易有限公司'),
    (410,'台州全仓电子'),
    (411,'台州云疆贸易有限公司'),
    (412,'台州威普网络科技有限公司'),
    (413,'以初电商'),
    (414,'台州市黄岩南晨电子商务商行'),
    (415,'宁波荣兴'),
    (416,'台州星创国际经贸有限公司'),
    (417,'浙江泰禾家居用品有限公司'),
    (418,'弘达'),
    (419,'元维公司'),
    (420,'洁泥卡进出口有限公司'),
    (421,'台州敦阳'),
    (422,'台州速博泰精密机械股份有限公司'),
    (423,'银进'),
    (424,'青科'),
    (425,'宁波择世贸易有限公司'),
    (426,'余心智能'),
    (427,'乐清市速兴商贸店'),
    (428,'台州梵盛园林机械有限公司'),
    (429,'台州彩韵电子商务有限公司'),
    (430,'台州君瑞进出口有限公司'),
    (431,'珍和宝燕商贸有限公司'),
    (432,'深圳明创赛特贸易有限公司'),
    (433,'胜利'),
    (434,'台州融创机电'),
    (435,'耀煌贸易'),
    (436,'宁波庚成'),
    (437,'贵州创舒户外家具有限公司'),
    (438,'台州宜创电子商务有限公司'),
    (439,'台州市桑木旭禾电子商务有限公司'),
    (440,'台州家百道电子商务有限公司'),
    (441,'台州三鼎科技'),
    (442,'台州金色火星贸易有限公司'),
    (443,'西脉科技'),
    (444,'波士洁'),
    (445,'宁波驰创万迪商务咨询有限公司'),
    (446,'台州思湃贸易有限公司'),
    (447,'台州佰狮'),
    (448,'台州佰狮进出口有限公司'),
    (449,'浙江乐众'),
    (450,'台州市冠卓生活用品有限公司'),
    (451,'台州益楠贸易有限公司'),
    (452,'鸿翼国际物流'),
    (453,'宁波可心家居有限公司'),
    (454,'台州集航国际货运代理'),
    (455,'台州艾碧贸易有限公司'),
    (456,'台州盛戴服饰有限公司'),
    (457,'麦趣尔'),
    (458,'天台县老缝匠垫业有限公司'),
    (459,'杭州佛灯网络科技有限公司'),
    (460,'美沙'),
    (461,'宁波普罗斯电子商务有限公司'),
    (462,'台州市乐信科技股份有限公司'),
    (463,'台州市申洲玩具科技股份有限公司'),
    (464,'浙江公元新能源科技股份有限公司'),
    (465,'台州黄岩奥通宠物用品有限公司'),
    (466,'台州市国泰安全防护用品有限公司'),
    (467,'台州市泰诺电子商务有限公司'),
    (468,'永源集团有限公司'),
    (469,'浙江逗哈科技股份有限公司'),
    (470,'台州恒新汽车配件股份有限公司'),
    (471,'浙江德众汽车零部件制造有限公司'),
    (472,'玉环凯立汽车配件股份有限公司'),
    (473,'台州裕轩进出口有限公司'),
    (474,'浙江世元科技股份有限公司'),
    (475,'台州市椒江中泰眼镜配件厂'),
    (476,'台州市佳信婴童用品有限公司'),
    (477,'台州市多米乐农业机械厂'),
    (478,'临海市协成工艺品有限公司'),
    (479,'浙江元博休闲用品股份有限公司'),
    (480,'临海市大洋伞业股份有限公司'),
    (481,'临海市宇诺休闲用品有限公司'),
    (482,'浙江九牛工艺品有限公司'),
    (483,'浙江安露'),
    (484,'浙江荣鹏气动工具股份有限公司'),
    (485,'铃本机电'),
    (486,'博民机电'),
    (487,'艾克电器'),
    (488,'朔翔科技'),
    (489,'诺赛特工'),
    (490,'浙江美日智能装备有限公司'),
    (491,'华龙巨水')
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_02 AS
select t1.entid                                    --主体唯一键
	,t1.legalname                                --法人姓名
	,t1.socialcreditcode                         --统一社会信用代码
	,t1.entname                                  --企业名称
	,t1.address                                  --注册地址
	,t1.entnameold                               --曾用名
	,t1.regcapitalcurrency                       --注册币种
	,t1.entstatuscode                            --企业状态码值
	,t1.isoperationnormal                        --是否有经营异常
	,t1.is_e_commerce                            --是否是跨境电商
	,t1.is_amazon_commerce                       --是否是跨境亚马逊电商
	,t1.use_flag                                 --使用标志
from edw.nout_gs_label_total_sub        t1       --企业标签总表
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.entname=t2.entp_nm
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_03 AS
select t1.entid                                    --主体唯一键
	,t1.entname                                  --企业名称
	,t1.socialcreditcode                         --统一社会信用代码
	,t1.legalname                                --法人姓名
	,t1.address                                  --注册地址
	,t1.entstatuscode                            --企业状态码值 正常 1、异常 2、其他 3
    ,DECODE(t1.entstatuscode,'1','正常','2','异常','3','其他') as entstatus
	,t1.isoperationnormal                        --是否有经营异常 1是0否
	,t1.custtype                                 --客户状态 0：正式1潜在3未建档
	,t1.cust_no                                  --客户号
	,t1.main_address                             --客户主地址
	,t1.is_e_commerce                            --是否是跨境电商
	,t1.is_amazon_commerce                       --是否是跨境亚马逊电商
from edw.xwdt_xw_com_nearbyent          t1      --社区企业信息表
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.entname=t2.entp_nm
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_04 AS
SELECT t1.qymc                                     --企业名称
	,t1.dh                                       --联系方式
	,t1.tyshxydm                                 --统一社会信用代码
	,t1.zzjgdm                                   --组织机构代码
	,t1.zt                                       --经营状态
	,t1.fddbr                                    --法人代表
	,t1.jyfw                                     --经营范围
from edw.dcip_ent_basic_info            t1      --企业基本信息
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.qymc=t2.entp_nm
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_05 AS
SELECT t1.company_id                               --主体唯一键
	,t1.company_name                             --企业名称
	,t1.company_code                             --注册号
	,t1.credit_no                                --统一信用代码
	,t1.org_code                                 --组织机构代码
	,t1.tax_code                                 --税务号
	,t1.establish_date                           --成立日期
	,t1.legal_person                             --法定代表人
	,t1.legal_person_caption                     --法人头衔
	,t1.company_status                           --登记状态
	,t1.company_address                          --地址
	,t1.business_scope                           --经营范围
from edw.nout_company_base              t1      --企业基本信息表
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.company_name=t2.entp_nm
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_06 AS
SELECT t1.geb_creditcode                           --统一信用代码
	,t1.geb_dom                                  --住址
	,t1.geb_entname                              --企业名称
	,t1.geb_entstatus                            --经营状态
	,t1.geb_frname                               --法定代表人/负责人/执行事务合伙人
	,t1.geb_id                                   --企业ID
	,t1.geb_orgcodes                             --组织机构代码
	,t1.geb_zsopscope                            --经营业务范围
from edw.outd_gs_entinfo_basic          t1      --工商企业-企业基本信息
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.geb_entname=t2.entp_nm
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_07 AS
SELECT t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.opr_situ_cd                              --经营状况代码|C4
    ,c1.cd_val_dscr     as opr_situ_nm
	,t1.opr_scp_dscr                             --经营范围描述|C3000
	,t1.lctax_cert_no                            --地税证件号|C60
from edw.dim_cst_entp_bas_inf_dd        t1      --企业客户基本信息
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.cst_nm=t2.entp_nm
left join EDW.DWD_CODE_LIBRARY_DD       c1
on t1.opr_situ_cd=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_08 AS
SELECT  t1.cust_no        --客户号(灰色客户CN开头)
       ,t1.cust_name      --客户名称
       ,t1.scope_business --经营范围
       ,t1.contact_number --联系电话
       ,t1.home_phone     --家庭电话
       ,t1.regist_adr     --注册地址
       ,t1.entp_org_cd    --企业组织机构代码
from edw.xwdt_xw_customer               t1      --客户表(正潜灰)
inner join SJXQ_SJ2025020521_CST_01     t2
on t1.cust_name=t2.entp_nm
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025020521_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025020521_CST_09 AS
SELECT  t1.seq                                           AS 序号
    ,t1.entp_nm                                      AS 企业名称
    ,case when nvl(t3.cst_id,'')<>'' then t3.cst_id else t2.cust_no end AS 我行客户号
    ,t5.entp_org_cd    as 企业组织机构代码
    ,case when t4.DOC_TYP_CD='A0500' and nvl(t4.DOC_NBR,'')<>'' then t4.DOC_NBR
        when nvl(t3.lctax_cert_no,'')<>'' then t3.lctax_cert_no else t2.socialcreditcode end AS 统一社会信用代码
    ,case when nvl(t3.opr_scp_dscr,'')='' then t6.borrower_product_desc else t3.opr_scp_dscr end AS 经营范围
    ,case when nvl(t4.REG_ADR,'')<>'' then t4.REG_ADR else t2.address end AS 注册地址
    ,case when nvl(t7.lgp_nm,'')<>'' then t7.lgp_nm else t2.legalname end AS 法人姓名
    ,case when nvl(t7.lgp_tel,'')<>'' then t7.lgp_tel
    when nvl(t4.MBL_NBR,'')<>'' then t4.MBL_NBR else t4.FML_TEL_NBR end as 法人手机号
    ,case when nvl(t3.opr_situ_nm,'')<>'' then t3.opr_situ_nm else t2.entstatus end AS 经营状况
    ,t2.is_e_commerce                                AS 是否是跨境电商
    ,t2.is_amazon_commerce                           AS 是否是跨境亚马逊电商
from SJXQ_SJ2025020521_CST_01       t1
LEFT JOIN SJXQ_SJ2025020521_CST_03  t2
on t1.entp_nm=t2.entname
left join SJXQ_SJ2025020521_CST_07  t3
on t1.entp_nm=t3.cst_nm
left join edw.DWS_CST_BAS_INF_DD    t4
on case when nvl(t3.cst_id,'')<>'' then t3.cst_id else t2.cust_no end=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_customer      t5
on t4.cst_id=t5.cust_no
and t5.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_org_inf_dd   t6         --客户集市-客户基础-对公客户基础信息
on t4.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dim_cst_entp_lgp_inf_dd       t7      --对公客户法人信息表
on t4.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025020521_CST_09
ORDER BY 序号
;
SElECT '01' seq, count(1) cnt,count(distinct entp_nm) custs
from SJXQ_SJ2025020521_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct entname) custs
from SJXQ_SJ2025020521_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct entname) custs
from SJXQ_SJ2025020521_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct qymc) custs
from SJXQ_SJ2025020521_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct company_name) custs
from SJXQ_SJ2025020521_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct geb_entname) custs
from SJXQ_SJ2025020521_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_nm) custs
from SJXQ_SJ2025020521_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cust_name) custs
from SJXQ_SJ2025020521_CST_08
;
/*
01	491	491
02	0	0
03	351	351
04	0	0
05	0	0
06	0	0
07	346	346
08	416	349
*/***王雯_SJ20250102291_衢州分行百年好合卡.sql
--截止2024年12月底，衢州分行百年好合卡发卡客户的产效情况（存款、贷款、理财、aum）。
--注：百年好合卡分为定制卡面款、通用卡面款两种
-- 衢州分行百年好合卡发卡客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250102291_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102291_CST_01 as
SELECT  t1.cst_id               --客户编号|C20
    ,t1.cst_nm                  --客户名称|C200
    ,t1.busi_ctr_id             --业务合同编号|C32
    ,t1.isu_dt                  --发卡日期|C8
    ,t1.cr_crd_card_nbr
    ,t1.cr_crd_pd_id
    ,t2.crd_no
    ,t4.cr_crd_brc_org_nm       --信用卡业务管户分行名称
    ,case when t1.cr_crd_pd_id = '0054' then '定制版'
        when t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12' then '通用版'
        else '' end  as card_type
FROM edw.dim_bus_crd_cr_crd_inf_dd  t1 --信用卡卡片信息
INNER JOIN    edw.loan_ctr_crd_face t2
ON      t1.cr_crd_card_nbr = t2.crd_no
AND     t2.dt = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  DISTINCT cst_id,cr_crd_brc_org_nm
    from app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd
	WHERE dt = '20241231'
	AND cr_crd_brc_org_nm = '衢州分行'
)T4 ON T1.cst_id = T4.cst_id
WHERE t1.dt = '20241231'
and (t1.cr_crd_pd_id = '0054' --百年好合卡定制卡
    OR (t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12') --百年好合卡通用版
)
;
-- 信用卡 经办人	经办团队	经办支行
DROP   TABLE IF     EXISTS SJXQ_SJ20250102291_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102291_CST_02 as
SElECT t1.busi_ctr_id
    ,t2.hdl_org_id	    --经办机构编号|c10
    ,t2.hdl_opr_id	    --经办人工号|c12
    ,t3.empe_nm     as hdl_opr_nm
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from SJXQ_SJ20250102291_CST_01               t1
left join EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD   t2 --合同基础信息
on t1.busi_ctr_id=t2.ctr_serno
and t2.dt='20241231'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  t2.hdl_opr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树
on  t2.hdl_org_id=t4.org_id
and t4.dt='@@{yyyyMMdd}'
;
-- 当前是否为有效户 存款	贷款	信用卡	财富
DROP   TABLE IF     EXISTS SJXQ_SJ20250102291_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102291_CST_03 as
SElECT t1.cst_id
	,t2.efe_dep_cst_ind         --有效存款户标识
	,t2.efe_loan_cst_ind        --有效贷款户标识
	,t2.efe_wlth_cst_ind        --有效财富户标识
    ,t3.cr_crd_vld_cst_ind	    --信用卡有效户标识:0否1是
from SJXQ_SJ20250102291_CST_01                   t1
left join adm_pub.adm_csm_cbas_ind_inf_dd 		t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='20241231'
left join adm_pub.adm_csm_clab_cr_crd_bas_lab_inf_dd    t3 --客户集市-客户标签信息-信用卡-基本标签信息
on t1.cst_id=t3.cst_id
and t3.dt='20241231'
;
-- 理财	保险	基金	贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ20250102291_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102291_CST_04 as
SELECT  t1.cst_id           --客户编号
    ,t2.xyk_act_cnt     --信用卡账号数
    ,t2.xyk_bal         --信用卡余额
    ,case when nvl(t3.sam_rsk_ctrl_id,'')<>'' then t3.sam_rsk_ctrl_id else t1.cst_id end sam_rsk_ctrl_id    --同一风险控制号
    ,t4.fnc_amt          --理财金额
    ,t4.fnc_mon_avg_amt  --理财金额月日均
    ,t4.insu_amt         --保险保费
    ,t4.insu_mon_avg_amt --保险保费月日均
    ,t4.fund_amt         --基金金额
    ,t4.fund_mon_avg_amt --基金金额月日均
    ,t4.gold_amt         --贵金属近一年金额
    ,t4.gold_mon_avg_amt --贵金属金额月日均
    ,t5.dep_bal          --存款余额
    ,t5.dep_bal_mon_avg  --存款余额月日均
    ,t6.综合授信          --授信金额
    ,t6.贷款余额          --用信余额
    ,t6.贷款合同金额
    ,t6.贷款合同余额
    ,t6.信用卡合同金额
    ,t6.信用卡合同余额
from SJXQ_SJ20250102291_CST_03                       t1
left join(
    SElECT cst_id
        ,count(distinct cr_crd_act_id)  as xyk_act_cnt
        ,sum(bal)                       as xyk_bal --信用卡余额
    from app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd	--信用卡账户信息汇总表
    where dt='20241231'
    group by cst_id
)t2 on  t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd 				    t3 --客户基础信息汇总表
on  t1.cst_id=t3.cst_id
and t3.dt='20241231'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t4 --客户金融资产信息表
on  t1.cst_id=t4.cst_id
and t4.dt='20241231'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t5 --存款业务信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20241231'
left join(
    select cst_id
    ,sum(nvl(ctr_amt,0)) as 综合授信
    ,sum(nvl(ctr_bal,0)) as 贷款余额
    ,SUM(CASE WHEN t1.PRD_NO NOT IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_amt ELSE 0 END) AS 贷款合同金额
    ,SUM(CASE WHEN t1.PRD_NO NOT IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_bal ELSE 0 END) AS 贷款合同余额
    ,SUM(CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_amt ELSE 0 END)     AS 信用卡合同金额
    ,SUM(CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_bal ELSE 0 END)     AS 信用卡合同余额
    from edw.dim_bus_loan_ctr_bse_inf_dd    t1
    where t1.dt='20241231'
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
;
-- 同一风险控制号下全部客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250102291_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102291_CST_05 as
SELECT  sam_rsk_ctrl_id
       ,SUM(nvl(dep_bal,0))          AS 存款余额
       ,SUM(nvl(dep_bal_mon_avg,0))  AS 存款余额月日均
       ,SUM(nvl(贷款合同金额,0))      AS 贷款合同授信金额
       ,SUM(nvl(贷款合同余额,0))      AS 贷款合同用信余额
       ,SUM(nvl(xyk_act_cnt,0))      AS 信用卡账号数
       ,SUM(nvl(xyk_bal,0))          AS 信用卡余额
       ,SUM(nvl(fnc_amt,0))          AS 理财金额
       ,SUM(nvl(fnc_mon_avg_amt,0))  AS 理财金额月日均
       ,SUM(nvl(insu_amt,0))         AS 保险保费
       ,SUM(nvl(insu_mon_avg_amt,0)) AS 保险保费月日均
       ,SUM(nvl(fund_amt,0))         AS 基金金额
       ,SUM(nvl(fund_mon_avg_amt,0)) AS 基金金额月日均
       ,SUM(nvl(gold_amt,0))         AS 贵金属近一年金额
       ,SUM(nvl(gold_mon_avg_amt,0)) AS 贵金属金额月日均
from SJXQ_SJ20250102291_CST_04
group by sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250102291_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250102291_CST_06 as
SELECT  t1.cst_id               AS 客户号
       ,t1.cst_nm               AS 客户名称
       ,t1.card_type            AS 卡片类型
       ,t1.cr_crd_card_nbr      AS 卡号
       ,t1.isu_dt               AS 发卡日期
       ,coalesce(t5.hdl_opr_nm,t5.hdl_opr_id) AS 信用卡经办人
       ,t5.brc_org_nm           AS 信用卡经办分行
       ,t5.sbr_org_nm           AS 信用卡经办支行
       ,t5.tem_org_nm           AS 信用卡经办团队
       ,t1.cr_crd_brc_org_nm    AS 信用卡业务管户分行
       ,t2.efe_dep_cst_ind      AS 有效存款户标识
       ,t2.efe_loan_cst_ind     AS 有效贷款户标识
       ,t2.cr_crd_vld_cst_ind   AS 信用卡有效户标识
       ,t2.efe_wlth_cst_ind     AS 有效财富户标识
       ,t3.dep_bal              AS 单客户_存款余额
       ,t3.dep_bal_mon_avg      AS 单客户_存款余额月日均
       ,t3.贷款合同金额          AS 单客户_贷款合同授信金额
       ,t3.贷款合同余额          AS 单客户_贷款合同用信余额
       ,t3.xyk_act_cnt          AS 单客户_信用卡账号数
       ,t3.xyk_bal              AS 单客户_信用卡余额
       ,t3.fnc_amt              AS 单客户_理财金额
       ,t3.fnc_mon_avg_amt      AS 单客户_理财金额月日均
       ,t3.insu_amt             AS 单客户_保险保费
       ,t3.insu_mon_avg_amt     AS 单客户_保险保费月日均
       ,t3.fund_amt             AS 单客户_基金金额
       ,t3.fund_mon_avg_amt     AS 单客户_基金金额月日均
       ,t3.gold_amt             AS 单客户_贵金属近一年金额
       ,t3.gold_mon_avg_amt     AS 单客户_贵金属金额月日均
       ,t4.存款余额                 AS 同一风险控制号下_存款余额
       ,t4.存款余额月日均            AS 同一风险控制号下_存款余额月日均
       ,t4.贷款合同授信金额          AS 同一风险控制号下_贷款合同授信金额
       ,t4.贷款合同用信余额          AS 同一风险控制号下_贷款合同用信余额
       ,t4.信用卡账号数             AS 同一风险控制号下_信用卡账号数
       ,t4.信用卡余额                AS 同一风险控制号下_信用卡余额
       ,t4.理财金额                 AS 同一风险控制号下_理财金额
       ,t4.理财金额月日均            AS 同一风险控制号下_理财金额月日均
       ,t4.保险保费                 AS 同一风险控制号下_保险保费
       ,t4.保险保费月日均            AS 同一风险控制号下_保险保费月日均
       ,t4.基金金额                 AS 同一风险控制号下_基金金额
       ,t4.基金金额月日均            AS 同一风险控制号下_基金金额月日均
       ,t4.贵金属近一年金额           AS 同一风险控制号下_贵金属近一年金额
       ,t4.贵金属金额月日均           AS 同一风险控制号下_贵金属金额月日均
from SJXQ_SJ20250102291_CST_01           t1
left join SJXQ_SJ20250102291_CST_03      t2
on t1.cst_id=T2.cst_id
left join SJXQ_SJ20250102291_CST_04      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20250102291_CST_05      t4
on t3.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
left join SJXQ_SJ20250102291_CST_02      t5
on t1.busi_ctr_id=t5.busi_ctr_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250102291_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250102291_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250102291_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ20250102291_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250102291_CST_06
;
-- 543
SElECT '06' seq, *
from lab_bigdata_dev.SJXQ_SJ20250102291_CST_06
***王雯_SJ2025022116_衢州百年好合卡产效.sql
﻿--截止2024年12月底，衢州分行百年好合卡发卡客户的产效情况（存款、贷款、理财、aum）。
--注：百年好合卡分为定制卡面款、通用卡面款两种
-- 衢州分行百年好合卡发卡客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025022116_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022116_CST_01 as
SELECT  t1.cst_id               --客户编号|C20
    ,t1.cst_nm                  --客户名称|C200
    ,t1.busi_ctr_id             --业务合同编号|C32
    ,t1.isu_dt                  --发卡日期|C8
    ,t1.cr_crd_card_nbr
    ,t1.cr_crd_pd_id
    ,t2.crd_no
    ,t4.cr_crd_brc_org_nm       --信用卡业务管户分行名称
    ,case when t1.cr_crd_pd_id = '0054' then '定制版'
        when t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12' then '通用版'
        else '' end  as card_type
FROM edw.dim_bus_crd_cr_crd_inf_dd  t1 --信用卡卡片信息
INNER JOIN    edw.loan_ctr_crd_face t2
ON      t1.cr_crd_card_nbr = t2.crd_no
AND     t2.dt = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  DISTINCT cst_id,cr_crd_brc_org_nm
    from app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd
	WHERE dt = '20250131'
	AND cr_crd_brc_org_nm = '衢州分行'
)T4 ON T1.cst_id = T4.cst_id
WHERE t1.dt = '20250131'
and (t1.cr_crd_pd_id = '0054' --百年好合卡定制卡
    OR (t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12') --百年好合卡通用版
)
;
-- 信用卡 经办人	经办团队	经办支行
DROP   TABLE IF     EXISTS SJXQ_SJ2025022116_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022116_CST_02 as
SElECT t1.busi_ctr_id
    ,t2.hdl_org_id	    --经办机构编号|c10
    ,t2.hdl_opr_id	    --经办人工号|c12
    ,t3.empe_nm     as hdl_opr_nm
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from SJXQ_SJ2025022116_CST_01               t1
left join EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD   t2 --合同基础信息
on t1.busi_ctr_id=t2.ctr_serno
and t2.dt='20250131'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  t2.hdl_opr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树
on  t2.hdl_org_id=t4.org_id
and t4.dt='@@{yyyyMMdd}'
;
-- 当前是否为有效户 存款	贷款	信用卡	财富
DROP   TABLE IF     EXISTS SJXQ_SJ2025022116_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022116_CST_03 as
SElECT t1.cst_id
	,t2.efe_dep_cst_ind         --有效存款户标识
	,t2.efe_loan_cst_ind        --有效贷款户标识
	,t2.efe_wlth_cst_ind        --有效财富户标识
    ,t3.cr_crd_vld_cst_ind	    --信用卡有效户标识:0否1是
from SJXQ_SJ2025022116_CST_01                   t1
left join adm_pub.adm_csm_cbas_ind_inf_dd 		t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='20250131'
left join adm_pub.adm_csm_clab_cr_crd_bas_lab_inf_dd    t3 --客户集市-客户标签信息-信用卡-基本标签信息
on t1.cst_id=t3.cst_id
and t3.dt='20250131'
;
-- 理财	保险	基金	贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ2025022116_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022116_CST_04 as
SELECT  t1.cst_id           --客户编号
    ,t2.xyk_act_cnt     --信用卡账号数
    ,t2.xyk_bal         --信用卡余额
    ,case when nvl(t3.sam_rsk_ctrl_id,'')<>'' then t3.sam_rsk_ctrl_id else t1.cst_id end sam_rsk_ctrl_id    --同一风险控制号
    ,t4.fnc_amt          --理财金额
    ,t4.fnc_mon_avg_amt  --理财金额月日均
    ,t4.insu_amt         --保险保费
    ,t4.insu_mon_avg_amt --保险保费月日均
    ,t4.fund_amt         --基金金额
    ,t4.fund_mon_avg_amt --基金金额月日均
    ,t4.gold_amt         --贵金属近一年金额
    ,t4.gold_mon_avg_amt --贵金属金额月日均
    ,t5.dep_bal          --存款余额
    ,t5.dep_bal_mon_avg  --存款余额月日均
    ,t6.综合授信          --授信金额
    ,t6.贷款余额          --用信余额
    ,t6.贷款合同金额
    ,t6.贷款合同余额
    ,t6.信用卡合同金额
    ,t6.信用卡合同余额
from SJXQ_SJ2025022116_CST_03                       t1
left join(
    SElECT cst_id
        ,count(distinct cr_crd_act_id)  as xyk_act_cnt
        ,sum(bal)                       as xyk_bal --信用卡余额
    from app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd	--信用卡账户信息汇总表
    where dt='20250131'
    group by cst_id
)t2 on  t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd 				    t3 --客户基础信息汇总表
on  t1.cst_id=t3.cst_id
and t3.dt='20250131'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t4 --客户金融资产信息表
on  t1.cst_id=t4.cst_id
and t4.dt='20250131'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t5 --存款业务信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20250131'
left join(
    select cst_id
    ,sum(nvl(ctr_amt,0)) as 综合授信
    ,sum(nvl(ctr_bal,0)) as 贷款余额
    ,SUM(CASE WHEN t1.PRD_NO NOT IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_amt ELSE 0 END) AS 贷款合同金额
    ,SUM(CASE WHEN t1.PRD_NO NOT IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_bal ELSE 0 END) AS 贷款合同余额
    ,SUM(CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_amt ELSE 0 END)     AS 信用卡合同金额
    ,SUM(CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_bal ELSE 0 END)     AS 信用卡合同余额
    from edw.dim_bus_loan_ctr_bse_inf_dd    t1
    where t1.dt='20250131'
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
;
-- 同一风险控制号下全部客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025022116_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022116_CST_05 as
SELECT  sam_rsk_ctrl_id
       ,SUM(nvl(dep_bal,0))          AS 存款余额
       ,SUM(nvl(dep_bal_mon_avg,0))  AS 存款余额月日均
       ,SUM(nvl(贷款合同金额,0))      AS 贷款合同授信金额
       ,SUM(nvl(贷款合同余额,0))      AS 贷款合同用信余额
       ,SUM(nvl(xyk_act_cnt,0))      AS 信用卡账号数
       ,SUM(nvl(xyk_bal,0))          AS 信用卡余额
       ,SUM(nvl(fnc_amt,0))          AS 理财金额
       ,SUM(nvl(fnc_mon_avg_amt,0))  AS 理财金额月日均
       ,SUM(nvl(insu_amt,0))         AS 保险保费
       ,SUM(nvl(insu_mon_avg_amt,0)) AS 保险保费月日均
       ,SUM(nvl(fund_amt,0))         AS 基金金额
       ,SUM(nvl(fund_mon_avg_amt,0)) AS 基金金额月日均
       ,SUM(nvl(gold_amt,0))         AS 贵金属近一年金额
       ,SUM(nvl(gold_mon_avg_amt,0)) AS 贵金属金额月日均
from SJXQ_SJ2025022116_CST_04
group by sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025022116_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022116_CST_06 as
SELECT  t1.cst_id               AS 客户号
       ,t1.cst_nm               AS 客户名称
       ,t1.card_type            AS 卡片类型
       ,t1.cr_crd_card_nbr      AS 卡号
       ,t1.isu_dt               AS 发卡日期
       ,coalesce(t5.hdl_opr_nm,t5.hdl_opr_id) AS 信用卡经办人
       ,t5.brc_org_nm           AS 信用卡经办分行
       ,t5.sbr_org_nm           AS 信用卡经办支行
       ,t5.tem_org_nm           AS 信用卡经办团队
       ,t1.cr_crd_brc_org_nm    AS 信用卡业务管户分行
       ,t2.efe_dep_cst_ind      AS 有效存款户标识
       ,t2.efe_loan_cst_ind     AS 有效贷款户标识
       ,t2.cr_crd_vld_cst_ind   AS 信用卡有效户标识
       ,t2.efe_wlth_cst_ind     AS 有效财富户标识
       ,t3.dep_bal              AS 单客户_存款余额
       ,t3.dep_bal_mon_avg      AS 单客户_存款余额月日均
       ,t3.贷款合同金额          AS 单客户_贷款合同授信金额
       ,t3.贷款合同余额          AS 单客户_贷款合同用信余额
       ,t3.xyk_act_cnt          AS 单客户_信用卡账号数
       ,t3.xyk_bal              AS 单客户_信用卡余额
       ,t3.fnc_amt              AS 单客户_理财金额
       ,t3.fnc_mon_avg_amt      AS 单客户_理财金额月日均
       ,t3.insu_amt             AS 单客户_保险保费
       ,t3.insu_mon_avg_amt     AS 单客户_保险保费月日均
       ,t3.fund_amt             AS 单客户_基金金额
       ,t3.fund_mon_avg_amt     AS 单客户_基金金额月日均
       ,t3.gold_amt             AS 单客户_贵金属近一年金额
       ,t3.gold_mon_avg_amt     AS 单客户_贵金属金额月日均
       ,t4.存款余额                 AS 同一风险控制号下_存款余额
       ,t4.存款余额月日均            AS 同一风险控制号下_存款余额月日均
       ,t4.贷款合同授信金额          AS 同一风险控制号下_贷款合同授信金额
       ,t4.贷款合同用信余额          AS 同一风险控制号下_贷款合同用信余额
       ,t4.信用卡账号数             AS 同一风险控制号下_信用卡账号数
       ,t4.信用卡余额                AS 同一风险控制号下_信用卡余额
       ,t4.理财金额                 AS 同一风险控制号下_理财金额
       ,t4.理财金额月日均            AS 同一风险控制号下_理财金额月日均
       ,t4.保险保费                 AS 同一风险控制号下_保险保费
       ,t4.保险保费月日均            AS 同一风险控制号下_保险保费月日均
       ,t4.基金金额                 AS 同一风险控制号下_基金金额
       ,t4.基金金额月日均            AS 同一风险控制号下_基金金额月日均
       ,t4.贵金属近一年金额           AS 同一风险控制号下_贵金属近一年金额
       ,t4.贵金属金额月日均           AS 同一风险控制号下_贵金属金额月日均
from SJXQ_SJ2025022116_CST_01           t1
left join SJXQ_SJ2025022116_CST_03      t2
on t1.cst_id=T2.cst_id
left join SJXQ_SJ2025022116_CST_04      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025022116_CST_05      t4
on t3.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
left join SJXQ_SJ2025022116_CST_02      t5
on t1.busi_ctr_id=t5.busi_ctr_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022116_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025022116_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2025022116_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025022116_CST_06
;
-- 543
SElECT '06' seq, *
from lab_bigdata_dev.SJXQ_SJ2025022116_CST_06
;
/*
01	547	547
03	547	547
04	547	547
05	536	536
06	547	547
*/***王雯_SJ20250317161_泰惠收商户信息.sql
﻿-- 王雯005556-衢州分行已注销泰惠收商户信息
-- SJ20250317161
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250317161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317161_CST_01 AS
SELECT  col_1  --管户所属机构号
       ,col_2  --管户机构名称
       ,col_3  --管户支行号
       ,col_4  --管户支行机构名称
       ,col_5  --客户经理姓名
       ,col_6  --客户经理工号
       ,col_7  --核心客户号
       ,col_8  --店铺级别
       ,col_9  --商户号
       ,col_10 --商户简称
       ,col_11 --商户全称
       ,col_12 --商户类型
       ,col_13 --MCC类型
       ,col_14 --商户状态名称
       ,col_15 --结算账号开户日期
       ,col_16 --法人客户号
       ,col_17 --开户行
       ,col_18 --营业执照号
from lab_bigdata_dev.qbi_file_20250321_08_55_34_0
where pt<>''
;
--商户注销原因 泰惠收注销原因
DROP   TABLE IF     EXISTS SJXQ_SJ20250317161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317161_CST_02 AS
SELECT  A.CRT_DATE_TIME
       ,A.MCHT_ID
       ,CASE WHEN A.BUSINESS_TYPE = '01' THEN '结算业务'
             WHEN A.BUSINESS_TYPE = '02' THEN '支付业务-微信'
             WHEN A.BUSINESS_TYPE = '03' THEN '支付业务-支付宝'
             WHEN A.BUSINESS_TYPE = '04' THEN '支付业务-手机银行'
             WHEN A.BUSINESS_TYPE = '05' THEN '支付业务-银联'
             WHEN A.BUSINESS_TYPE = '06' THEN '提现业务'
             WHEN A.BUSINESS_TYPE = '07' THEN '信用卡支付'
             WHEN A.BUSINESS_TYPE = '08' THEN '商户中止'
             WHEN A.BUSINESS_TYPE = '09' THEN '商户恢复'
             WHEN A.BUSINESS_TYPE = '10' THEN '商户注销'
             WHEN A.BUSINESS_TYPE = '11' THEN '智慧经营'
             WHEN A.BUSINESS_TYPE = '12' THEN '储值协议'  ELSE '' END BUSINESS_TYPE
       ,CASE WHEN A.BUSINESS_STATE = '00' THEN '已禁用'
             WHEN A.BUSINESS_STATE = '01' THEN '已开启'
             WHEN A.BUSINESS_STATE = '02' THEN '中止'
             WHEN A.BUSINESS_STATE = '03' THEN '恢复'
             WHEN A.BUSINESS_STATE = '04' THEN '注销'  ELSE '' END BUSINESS_STATE
       ,A.MSG --原因
       ,A.CRT_TLR
       ,A.BLACK_LIST
       ,ROW_NUMBER() OVER (PARTITION BY A.MCHT_ID,A.BUSINESS_STATE ORDER BY  A.CRT_DATE_TIME DESC) AS rn
FROM EDW.DPSS_PBS_MCHT_BUSIN_MOD_RECORD A
WHERE A.BUSINESS_STATE = '04' --'注销'
and A.DT = '@@{yyyyMMdd}'
;
-- 同一风险控制号下我行授信总额（授信还在有效期）
DROP   TABLE IF     EXISTS SJXQ_SJ20250317161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317161_CST_03 AS
SELECT  T1.CST_ID
        ,t5.cst_chn_nm AS 客户名称
        ,T1.客户授信总额
        ,t1.客户敞口总额
        ,t1.客户可用授信总额
        ,t1.客户可用敞口总额
        ,CASE
             WHEN nvl(t5.SAM_RSK_CTRL_ID, '') = '' THEN t1.cst_id
             ELSE t5.sam_rsk_ctrl_id
           END AS sam_rsk_ctrl_id
FROM    (
            SELECT  le.cst_id
                    ,sum(FACL_LMT)                                                                            AS 客户授信总额
                    ,sum(EPSR_LMT)                                                                            AS 客户敞口总额
                    ,sum(IF(le.LMT_STS = '03', IF(le.avl_facl_lmt > 0, 0, le.avl_facl_lmt), le.avl_facl_lmt)) AS 客户可用授信总额
                    ,sum(IF(le.LMT_STS = '03', IF(le.avl_epsr_lmt > 0, 0, le.avl_epsr_lmt), le.avl_epsr_lmt)) AS 客户可用敞口总额
            FROM    edw.loan_lmt_exmp le
            INNER JOIN    edw.loan_cst_bsc cb
            ON      le.CST_ID = cb.CST_ID
            AND     cb.DT = '@@{yyyyMMdd}'
            WHERE   le.DEL_IND = '0'
            AND     ( EXISTS (
                                 SELECT  1
                                 FROM    edw.loan_lmt_use_rslt_rcd u
                                 WHERE   u.SPLT_LMT_NO = le.SPLT_LMT_NO
                                 AND     INI_OCP_FACL_AMT > ALRY_RSM_FACL_LMT
                                 AND     OCP_STS = '1'
                                 AND     U.DT = '@@{yyyyMMdd}'
                             )
                OR le.LMT_STS IN ( '01' , '02' ) )
            AND     LE.DT = '@@{yyyyMMdd}'
            GROUP BY le.cst_id
        ) T1
LEFT JOIN    edw.DWS_CST_BAS_INF_DD t5
ON      T1.cst_id = t5.cst_id
AND     t5.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250317161_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250317161_CST_04 AS
SELECT  t1.col_1                 AS 管户所属机构号
       ,t1.col_2                 AS 管户机构名称
       ,t1.col_3                 AS 管户支行号
       ,t1.col_4                 AS 管户支行机构名称
       ,t1.col_5                 AS 客户经理姓名
       ,t1.col_6                 AS 客户经理工号
       ,t1.col_7                 AS 核心客户号
       ,t1.col_8                 AS 店铺级别
       ,t1.col_9                 AS 商户号
       ,t1.col_10                AS 商户简称
       ,t1.col_11                AS 商户全称
       ,t1.col_12                AS 商户类型
       ,t1.col_13                AS MCC类型
       ,t1.col_14                AS 商户状态名称
       ,t1.col_15                AS 结算账号开户日期
       ,t1.col_16                AS 法人客户号
       ,t1.col_17                AS 开户行
       ,t1.col_18                AS 营业执照号
       ,t3.bus_lcn_nbr           AS 营业执照号码
       ,t3.bus_lcn_nvld_dt       AS 营业执照失效日期
       ,t3.mch_opr_xcp_rsn       AS 商户经营异常原因
       ,t2.MSG                   AS 商户注销原因
       ,t4.mch_addr              AS 商户经营地址
       ,t5.loan_bal_acs          AS 贷款余额
       ,t5.loan_bal_acs_mon_avg  AS 贷款余额月日均
       ,t5.loan_bal_acs_year_avg AS 贷款余额年日均
       ,t7.同一风险控制号下我行授信总额
from SJXQ_SJ20250317161_CST_01      t1
left join SJXQ_SJ20250317161_CST_02 t2
on t1.col_9=t2.MCHT_ID
and t2.rn=1
left join edw.dws_bus_chnl_ths_mch_inf_dd   t3 --泰惠收商户汇总信息
on t1.col_9=t3.mch_id
and t3.dt='@@{yyyyMMdd}'
left join app_rpt.fct_ths_mch_inf_ceshi     t4 --泰惠收商户信息表
on t1.col_7=t4.cst_id
and t1.col_9=t4.mch_id
and t4.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_loan_inf_dd  t5 --客户集市-业务信息-客户贷款业务信息表
on t1.col_7=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20250317161_CST_03       t6
on t1.col_7=t6.cst_id
left join(
    select sam_rsk_ctrl_id,sum(客户授信总额) as 同一风险控制号下我行授信总额
    from SJXQ_SJ20250317161_CST_03
    group by sam_rsk_ctrl_id
)t7 on t6.sam_rsk_ctrl_id=t7.sam_rsk_ctrl_id
;
SElECT '04' seq, *
from SJXQ_SJ20250317161_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct col_9) custs
from SJXQ_SJ20250317161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct MCHT_ID) custs
from SJXQ_SJ20250317161_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250317161_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 商户号) custs
from SJXQ_SJ20250317161_CST_04
;
/*
01	16553	16553
02	94272	94272
03	1024966	1024966
04	16553	16553
*/
***王雯_SJ2025050746_信用卡客户画像.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025050746_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025050746_CST_01 AS
SELECT  col_1 --机构号
       ,col_2 --机构名称
       ,col_3 --机构名称
       ,col_4 --卡号
       ,col_5 --业务管户人工号
       ,col_6 --业务管户人姓名
       ,col_7 --客户号
       ,col_8 --姓名
from lab_bigdata_dev.qbi_file_20250507_10_38_00_0
where pt<>''
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025050746_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025050746_CST_02 AS
SELECT  t1.col_1                               AS 机构号
       ,t1.col_2                               AS 机构名称1
       ,t1.col_3                               AS 机构名称2
       ,t1.col_4                               AS 卡号
       ,t1.col_5                               AS 业务管户人工号
       ,t1.col_6                               AS 业务管户人姓名
       ,t1.col_7                               AS 客户号
       ,t1.col_8                               AS 姓名
       ,t2.age                                 AS 年龄
       ,decode(t2.gdr_cd,'1','男','2','女','未知') AS 性别
       ,t2.fm_ind                              AS 农户标志
       ,c1.cd_val_dscr                         AS 婚姻状况
       ,t2.fml_mon_inc                         AS 家庭月收入
       ,t2.anl_inc                             AS 年收入
       ,substr(t2.doc_nbr,1,6)                 AS 证件号码
       ,c2.cd_val_dscr                         AS 职业
       ,t2.job_unt_nm                          AS 工作单位名称
    ,case when t2.wrk_adr_dtl_inf regexp '县' then CONCAT(substring_index(t2.wrk_adr_dtl_inf, '县', 1),'县')
        when t2.wrk_adr_dtl_inf regexp '区' then CONCAT(substring_index(t2.wrk_adr_dtl_inf, '区', 1),'区')
        when t2.wrk_adr_dtl_inf regexp '市' then CONCAT(substring_index(t2.wrk_adr_dtl_inf, '市', 1),'市')
        else substr(t2.wrk_adr_dtl_inf,1,6) end as 工作单位地址_前缀
from SJXQ_SJ2025050746_CST_01                   t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2   --客户集市-客户基础-对私客户基础信息
on t1.col_7=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1
on t2.mrg_situ_cd = c1.cd_val
and c1.dt ='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C2
ON  t2.ocp_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct col_7) custs
from SJXQ_SJ2025050746_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025050746_CST_02
***田朋飞_SJ2025060341_信贷管户交接.sql
-- 截止2025年5月31日，小鱼管家信贷客户交接占比情况，分行以及支行层面数据（当月、当年）
-- 信贷客户交接总数 使用小鱼管家客户交接流程的信贷客户数（取数口径与总行普惠金融部经营支持中心王莎莎保持一致）
-- 分行维度 各月
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_01 AS
SELECT  d.brc_org_nm                             AS 分行机构
       ,substr(REPLACE(a.sys_reg_tm,'-',''),1,6) AS 月份
       ,COUNT(DISTINCT a.cst_id)                 AS 信贷客户交接总数
       ,COUNT(DISTINCT b.cust_id)                AS 使用小鱼管家客户交接流程的信贷客户数
FROM edw.loan_cst_mgr_hdv_rcd AS a --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
INNER JOIN
(
	SELECT  distinct cst_id
	FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1
	WHERE dt = '20250531'
	AND ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' ) OR nvl(t1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
	AND t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) --剔除信用卡
)ctr
ON a.cst_id = ctr.cst_id
LEFT JOIN edw.xwdt_xw_cust_inven_data_record AS b
ON a.cst_id = b.cust_id
AND substr(REPLACE(a.sys_reg_tm, '-', ''), 1, 6) = REPLACE(substr(b.create_times, 1, 7), '-', '')
AND b.dt = '20250531'
AND b.credit_business = 'Y' -- 信贷业务
AND REPLACE(substr(b.create_times, 1, 10), '-', '') >= '20250101'
AND REPLACE(substr(b.create_times, 1, 10), '-', '') <= '20250531'
AND b.STATUS = '01' --移交状态(00/待移交;01/已移交;02/移交失败(可再次移交);03/已作废(可被再次其他用户发起交接))
INNER JOIN edw.dim_hr_org_mng_org_tree_dd AS d --机构树_考核维度
ON a.aft_hdv_mgr_org_no = d.org_id AND d.dt = '20250531'
WHERE a.dt = '20250531'
AND REPLACE(a.sys_reg_tm, '-', '') >= '20250101'
AND REPLACE(a.sys_reg_tm, '-', '') <= '20250531'
AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
AND a.hdv_typ = '1'     --2:协办业务交接|1:管户权交接
AND bfr_hdv_cst_magr_id <> aft_hdv_cst_magr_id  --剔除交给自己记录
GROUP BY  d.brc_org_nm
         ,substr(REPLACE(a.sys_reg_tm,'-',''),1,6)
;
-- 分行维度 当年
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_02 AS
select 分行机构
    ,sum(信贷客户交接总数) as 信贷客户交接总数
    ,sum(使用小鱼管家客户交接流程的信贷客户数) as 使用小鱼管家客户交接流程的信贷客户数
from lab_sjxq.SJXQ_SJ2025060341_CST_01
group by 分行机构
;
-- 支行维度
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_03 AS
SELECT  d.brc_org_nm                             AS 分行机构
       ,d.sbr_org_nm                             AS 支行机构
       ,substr(REPLACE(a.sys_reg_tm,'-',''),1,6) AS 月份
       ,COUNT(DISTINCT a.cst_id)                 AS 信贷客户交接总数
       ,COUNT(DISTINCT b.cust_id)                AS 使用小鱼管家客户交接流程的信贷客户数
FROM edw.loan_cst_mgr_hdv_rcd AS a --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
INNER JOIN
(
	SELECT  distinct cst_id
	FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1
	WHERE dt = '20250531'
	AND ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' ) OR nvl(t1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
	AND t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) --剔除信用卡
)ctr
ON a.cst_id = ctr.cst_id
LEFT JOIN edw.xwdt_xw_cust_inven_data_record AS b
ON a.cst_id = b.cust_id AND substr(REPLACE(a.sys_reg_tm, '-', ''), 1, 6) = REPLACE(substr(b.create_times, 1, 7), '-', '')
AND b.dt = '20250531'
AND b.credit_business = 'Y' -- 信贷业务
AND REPLACE(substr(b.create_times, 1, 10), '-', '') >= '20250101'
AND REPLACE(substr(b.create_times, 1, 10), '-', '') <= '20250531'
AND b.STATUS = '01' --移交状态(00/待移交;01/已移交;02/移交失败(可再次移交);03/已作废(可被再次其他用户发起交接))
INNER JOIN edw.dim_hr_org_mng_org_tree_dd AS d --机构树_考核维度
ON a.aft_hdv_mgr_org_no = d.org_id AND d.dt = '20250531'
WHERE a.dt = '20250531'
AND REPLACE(a.sys_reg_tm, '-', '') >= '20250101'
AND REPLACE(a.sys_reg_tm, '-', '') <= '20250531'
AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
AND a.hdv_typ = '1'
AND bfr_hdv_cst_magr_id <> aft_hdv_cst_magr_id
GROUP BY  d.brc_org_nm
         ,substr(REPLACE(a.sys_reg_tm,'-',''),1,6)
         ,d.sbr_org_nm
;
-- 支行维度 当年
DROP TABLE IF EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS lab_sjxq.SJXQ_SJ2025060341_CST_04 AS
select 分行机构,支行机构
    ,sum(信贷客户交接总数) as 信贷客户交接总数
    ,sum(使用小鱼管家客户交接流程的信贷客户数) as 使用小鱼管家客户交接流程的信贷客户数
from lab_sjxq.SJXQ_SJ2025060341_CST_03
group by 分行机构,支行机构
;
SElECT '01' seq, count(1) cnt,count(distinct 分行机构) custs    --分行各月
from SJXQ_SJ2025060341_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 分行机构) custs    --分行当年
from SJXQ_SJ2025060341_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 分行机构,支行机构) custs --支行各月
from SJXQ_SJ2025060341_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 分行机构,支行机构) custs --支行当年
from SJXQ_SJ2025060341_CST_04
;
/*
*/
***田朋飞_SJ20250801161_苏州分行量化画像.sql
-- 田朋飞_SJ20250801161_苏州分行量化画像
-- 截止7月31日，客户量化画像，苏州分行信用风险等级全量清单、泰隆分
-- 数据需求字段
-- 客户号  客户名称 泰隆分  信用风险等级 支行名称 团队名称  主管户客户经理工号 主管户客户经理姓名
DROP   TABLE IF     EXISTS SJXQ_SJ20250801161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250801161_CST_01 AS
SELECT  t1.cst_id     AS 客户号
       ,t3.cst_chn_nm AS 客户名字
       ,t5.泰隆分
       ,t4.量化风险等级
       ,t2.sbr_org_nm AS 主管户支行
       ,t2.tem_org_nm AS 主管户团队
       ,t1.prm_mgr_id AS 主管户客户经理工号
       ,t1.prm_mgr_nm AS 主管户客户经理姓名
from adm_pub.adm_csm_cbas_mng_inf_dd        t1 --客户集市-客户基础-客户管户信息
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '苏州分行'
left join edw.dws_cst_bas_inf_dd 	        t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250731'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250731'
)t4 on t1.cst_id=t4.cst_id
left join(
    SELECT client_no
        ,score as 泰隆分
        ,ROW_NUMBER() OVER (PARTITION BY client_no ORDER BY  insert_time DESC) AS rn
    FROM edw.jcsj_dx23_3p3b_col_anly_rslt --三品三表总模型评分结果集表 min(dt) 20201229
    WHERE dt >= '20201229'
)t5 on t1.cst_id=t5.client_no
and t5.rn=1
where t1.dt = '20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250801161_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ20250801161_CST_01
;
***白璐_SJ20250318126_合同明细.sql
-- 附件中空白字段：最后一笔结清的合同流水号、合同金额、执行利率、发生类型 010-首笔 011-续做、发生日期、到期日期
-- 、终结日期字段协助补充，谢谢。
-- 数据需求字段
-- 最后一笔结清的合同流水号、合同金额、执行利率、发生类型 010-首笔 011-续做、发生日期、到期日期、终结日期等字段
-- 导入
DROP   TABLE IF     EXISTS SJXQ_SJ20250318126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318126_CST_01 AS
SELECT  col_1  --部门
       ,col_2  --管户人
       ,col_3  --客户号
       ,col_4  --客户名称
       ,col_5  --2025年3月17日合同金额
from qbi_file_20250320_14_52_21_0
where pt<>''
;
-- 未到期未终结合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250318126_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318126_CST_02 AS
select t1.*
    ,row_number() over(partition by cst_id order by ctr_bgn_dt desc,ctr_serno desc) rn
from(
    SELECT  t1.ctr_serno                             --合同流水号
        ,t1.cst_id                                   --客户号
        ,t1.cst_nm                                   --客户名称
        ,t1.rel_serno                                --用信申请流水号
        ,decode(t1.hpn_typ_cd,'010','首笔','011','续做') as hpn_typ_nm --发生类型
        ,t1.ctr_amt                                  --合同金额
        ,t1.exec_intr_rat                            --执行利率
        ,t1.usc_aply_dt                              --用信申请日期
        ,t1.ctr_eff_dt                               --合同生效日期
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,t1.TMT_DT                                   --终结日期
        ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' ) AND     t1.TMT_DT = '18991231'
            AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
                OR t1.CTR_BAL > 0 )  then 0 else 1 end as is_jq --未到期未终结口径
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    where t1.dt='@@{yyyyMMdd}'
)t1 where is_jq=1   --结清的合同
;
-- 最后一笔结清的合同流水号
DROP   TABLE IF     EXISTS SJXQ_SJ20250318126_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250318126_CST_03 AS
SELECT  t1.col_1         AS 部门
       ,t1.col_2         AS 管户人
       ,t1.col_3         AS 客户号
       ,t1.col_4         AS 客户名称
       ,t1.col_5         AS 2025年3月17日合同金额
       ,t2.ctr_serno     AS 最后一笔结清的合同流水号
       ,t2.ctr_amt       AS 合同金额
       ,t2.exec_intr_rat AS 执行利率
       ,hpn_typ_nm       AS 发生类型
       ,t2.usc_aply_dt   AS 用信申请日期
       ,t2.ctr_eff_dt    AS 合同生效日期
       ,t2.ctr_bgn_dt    AS 合同起始日期
       ,t2.ctr_mtu_dt    AS 合同到期日期
       ,t2.TMT_DT        AS 终结日期
from SJXQ_SJ20250318126_CST_01       t1
left join SJXQ_SJ20250318126_CST_02 t2
on t1.col_3=t2.cst_id
and t2.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ20250318126_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250318126_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250318126_CST_03
***盛楠_SJ2025070771_钱潮理财新老客销量情况.sql
﻿-- 盛楠_SJ2025070771_钱潮理财新老客销量情况
-- 钱潮理财
DROP   TABLE IF     EXISTS SJXQ_SJ2025070771_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070771_CST_01 AS
SELECT T1.CST_ID,t4.brc_org_nm
    ,min(SUBSTR(t1.srl_nbr,1,8)) as fst_trx_dt               --交易日期|C8
    ,max(case when SUBSTR(t1.srl_nbr,1,8)>='20250101' then 1 else 0 end) as is_25y_buy
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI     T1 --理财交易确认流水明细
INNER JOIN edw.dim_bus_chm_pd_inf_dd    t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
and t2.pd_nm REGEXP '钱潮|优加'
and t2.pd_sts_cd<>'3'              --发行失败
INNER join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250630'
INNER join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250630'
where T1.DT<='@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8)<='20250630'
group by T1.CST_ID,t4.brc_org_nm
;
-- 2025上半年 钱潮理财交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025070771_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070771_CST_02 AS
SELECT t1.srl_nbr,T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,t1.trx_dt  as trx_dt2
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,C1.cd_val_dscr     as bus_nm
    ,T1.pd_cd                                    --产品代码|C20
	,t2.pd_nm                                    --产品名称|C256
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
    ,t1.trx_sts_cd
	,t2.pd_found_dt                              --产品成立日期|C8
	,t2.pd_end_dt                                --产品结束日期|C8
    ,t3.brc_org_nm
    ,case when t3.fst_trx_dt>='20250101' then 1 else 0 end as is_new_cst
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI     T1 --理财交易确认流水明细
INNER JOIN edw.dim_bus_chm_pd_inf_dd    t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
and t2.pd_nm REGEXP '钱潮|优加'
and t2.pd_sts_cd<>'3'              --发行失败
INNER join SJXQ_SJ2025070771_CST_01     t3
on t1.CST_ID=t3.cst_id
left join edw.dwd_code_library_dd       c1
on t1.bus_cd=c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where T1.DT<='@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8)>='20250101'
and SUBSTR(t1.srl_nbr,1,8)<='20250630'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025070771_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070771_CST_03 AS
SELECT  t1.brc_org_nm                            AS 主管户分行
       ,t2.new_amt                               AS 今年新客钱潮理财销量
       ,t1.new_custs                             AS 今年新客户数
       ,case when t1.new_custs>0 then round(t2.new_amt/t1.new_custs,4) else 0 end AS 今年新客户均
       ,t2.old_amt                               AS 今年老客复购销量
       ,t1.old_rebuy_custs                       AS 今年老客复购客户数
       ,case when t1.old_rebuy_custs>0 then round(t2.old_amt/t1.old_rebuy_custs,4) else 0 end  AS 今年老客复购户均
       ,t1.old_custs                             AS 存量老客客户数
       ,case when t1.old_custs>0 then round(t1.old_rebuy_custs/t1.old_custs,4) else 0 end AS 老客复购率
from(
    select brc_org_nm
        ,count(case when fst_trx_dt>='20250101' then cst_id end) as new_custs
        ,count(case when fst_trx_dt< '20250101' and is_25y_buy=1 then cst_id end) as old_rebuy_custs
        ,count(case when fst_trx_dt< '20250101' then cst_id end) as old_custs
    from SJXQ_SJ2025070771_CST_01
	where brc_org_nm not regexp '村镇'
    group by brc_org_nm
)t1 left join(
    select brc_org_nm
        ,sum(case when is_new_cst=1 then cfm_amt else 0 end)    as new_amt
        ,sum(case when is_new_cst=0 then cfm_amt else 0 end)    as old_amt
    from SJXQ_SJ2025070771_CST_02
    group by brc_org_nm
)t2 on t1.brc_org_nm=t2.brc_org_nm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070771_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct srl_nbr) custs
from SJXQ_SJ2025070771_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 主管户分行) custs
from SJXQ_SJ2025070771_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025070771_CST_03
***盛楠_SJ20250709146_理财促活期存款留存分析.sql
﻿-- 盛楠_SJ20250709146_理财促活期存款留存分析
-- 1、封闭式理财
DROP   TABLE IF     EXISTS SJXQ_SJ20250709146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250709146_CST_01 AS
SELECT  T1.PD_CD       AS 产品代码
       ,t2.pd_nm       AS 产品名称
       ,t1.CST_ID      AS 客户号
       ,t1.TRX_DT      AS 购买日期
       ,t2.pd_found_dt AS 产品成立日期
       ,t1.CFM_AMT     AS 确认金额
    ,datediff(to_date(t2.pd_found_dt,'yyyyMMdd'),to_date(t1.TRX_DT,'yyyyMMdd'),'dd')*t1.CFM_AMT as 活期存款留存
FROM EDW.dwd_bus_chm_trx_cfm_dtl_di     T1  --理财交易确认流水明细
inner JOIN    EDW.DIM_BUS_CHM_PD_INF_DD  T2
ON  T1.PD_CD = T2.PD_CD
AND T2.DT = '20250630'
and T2.TRX_MTH_CD='2'   --'封闭式理财'
where T1.dt<='@@{yyyyMMdd}'
and t1.TRX_DT between '20250101' and '20250630'
and T1.CFM_AMT>0    --确认金额
AND t1.bus_cd IN ( '120' , '122' , '130' , '134' , '139' ) --认购、申购、基金成立、非交易过户入、定期定额申购
-- and T1.trx_cd<>'100200'    --100200购买
;
-- 2、开放式理财（除封闭式、天添宝以外所有产品）
DROP   TABLE IF     EXISTS SJXQ_SJ20250709146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250709146_CST_02 AS
SELECT  T1.PD_CD       AS 产品代码
       ,t2.pd_nm       AS 产品名称
       ,t1.CST_ID      AS 客户号
       ,t1.TRX_DT      AS 购买日期
       ,t1.cfm_dt 		AS 确认日期
       ,t1.CFM_AMT     AS 确认金额
    ,datediff(to_date(t1.cfm_dt,'yyyyMMdd'),to_date(t1.TRX_DT,'yyyyMMdd'),'dd')*t1.CFM_AMT as 活期存款留存
FROM EDW.dwd_bus_chm_trx_cfm_dtl_di     T1  --理财交易确认流水明细
left JOIN    EDW.DIM_BUS_CHM_PD_INF_DD  T2
ON  T1.PD_CD = T2.PD_CD
AND T2.DT = '20250630'
left JOIN edw.dwd_bus_chm_ptfl_cpn_pd_rel_inf_dd   t3 --组合宝成分产品信息映射表
ON      t1.pd_cd = t3.pd_cd
and     t3.DVD_GRP_CD = 'TTB001'     --分组代码 天添宝 代销理财
AND     t3.dt = '20250630'
where T1.dt<='@@{yyyyMMdd}'
and t1.TRX_DT between '20250101' and '20250630'
and T1.CFM_AMT>0    --确认金额
AND t1.bus_cd IN ( '120' , '122' , '130' , '134' , '139' ) --认购、申购、基金成立、非交易过户入、定期定额申购
and T2.TRX_MTH_CD<>'2'   	--剔除封闭式理财
and t3.pd_cd is null    	--剔除天添宝
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号,购买日期) custs
from SJXQ_SJ20250709146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号,购买日期) custs
from SJXQ_SJ20250709146_CST_02
;
/*
01	45476	43846
02	188061	164095
*/***祝凌静_SJ2025060666_衢州分行存款客户清单.sql
-- 截至20250531 衢州分行所有存款客户
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2025060666_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060666_CST_01 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    -- ,t2.cst_chn_nm	--客户姓名|C200
    -- ,t1.rel_typ
    -- ,c1.cd_val_dscr as rel_typ_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '20250531' and del_ind='0'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '20250531' and del_ind='0'
    and rel_typ='0301' --配偶
)t1
-- left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
-- on t1.rel_cst_id=t2.cst_id
-- and t2.dt='20250531'
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '20250531'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025060666_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060666_CST_02 AS
SELECT  t1.cst_id     AS 客户号
       ,t2.cst_chn_nm AS 客户名称
       ,t1.mgr_id     AS 管护人工号
       ,t3.empe_nm    AS 管护人姓名
       ,t1.prm_org_id AS 考核机构编号
       ,t1.prm_org_nm AS 考核机构名称
       ,t5.rel_cst_id AS 配偶客户号
    ,CASE WHEN nvl(t2.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t2.sam_rsk_ctrl_id END AS 同一风险控制号
from(
    select distinct t1.cst_id,t1.dt
        ,t1.mgr_id                                   --管护人编号|C200
        ,t1.acs_org_id                               --考核机构编号|C12
        ,t4.org_nm
    from edw.dwd_bus_dep_cst_act_mgr_inf_dd     t1 --存款客户账户管户信息
    inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
    on  t1.acs_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm = '衢州分行'
    where t1.dt='20250531'
    and t1.frs_ctc_ind='1'	--第一联系人标志
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join edw.dws_hr_empe_inf_dd        t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2025060666_CST_01      t5
on t1.cst_id=t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025060666_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060666_CST_02
***程义平_SJ2025040836_村行信贷高风险清单.sql
-- 2025年1月1日以后新发放信贷业务
-- 踢掉信用卡
-- 已生效、冻结、中止
-- 只要个人客户
-- -- 同一风险控制号下我行授信总额（授信还在有效期）
-- DROP   TABLE IF     EXISTS SJXQ_SJ2025040836_CST_01 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040836_CST_01 AS
-- SELECT  T1.CST_ID
--        ,T1.客户授信总额
--        ,t1.客户可用授信总额
--        ,t2.cst_chn_nm
--        ,CASE WHEN nvl(t2.SAM_RSK_CTRL_ID,'') = '' THEN t1.cst_id  ELSE t2.sam_rsk_ctrl_id END AS sam_rsk_ctrl_id
-- FROM
-- (
-- 	SELECT  le.cst_id
-- 	       ,SUM(FACL_LMT)                                                                        AS 客户授信总额
-- 	       ,SUM(IF(le.LMT_STS = '03',IF(le.avl_facl_lmt > 0,0,le.avl_facl_lmt),le.avl_facl_lmt)) AS 客户可用授信总额
-- 	FROM edw.loan_lmt_exmp le
-- 	INNER JOIN edw.loan_cst_bsc cb
-- 	ON le.CST_ID = cb.CST_ID AND cb.DT = '@@{yyyyMMdd}'
-- 	WHERE le.DEL_IND = '0'
-- 	AND ( EXISTS (
-- 	SELECT  1
-- 	FROM edw.loan_lmt_use_rslt_rcd u
-- 	WHERE u.SPLT_LMT_NO = le.SPLT_LMT_NO
-- 	AND INI_OCP_FACL_AMT > ALRY_RSM_FACL_LMT
-- 	AND OCP_STS = '1'
-- 	AND U.DT = '@@{yyyyMMdd}' ) OR le.LMT_STS IN ( '01' , '02' ) ) AND LE.DT = '@@{yyyyMMdd}'
-- 	GROUP BY  le.cst_id
-- ) T1
-- LEFT JOIN edw.DWS_CST_BAS_INF_DD t2
-- ON T1.cst_id = t2.cst_id AND t2.dt = '@@{yyyyMMdd}'
-- ;
DROP   TABLE IF     EXISTS SJXQ_SJ2025040836_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040836_CST_02 AS
SELECT  t1.ctr_serno --合同流水号
       ,t1.cst_id --客户号
       ,t1.ctr_sts_cd --合同状态原始值
--合同状态：1-未生效；2-已生效；3-终止；4-冻结；5-作废
       ,CASE WHEN coalesce(t1.ctr_sts_cd,'') = '' THEN '0-无数据'
             WHEN coalesce(t1.ctr_sts_cd,'') = '1' THEN '1-未生效'
             WHEN coalesce(t1.ctr_sts_cd,'') = '2' THEN '2-已生效'
             WHEN coalesce(t1.ctr_sts_cd,'') = '3' THEN '3-终止'
             WHEN coalesce(t1.ctr_sts_cd,'') = '4' THEN '4-冻结'
             WHEN coalesce(t1.ctr_sts_cd,'') = '5' THEN '5-作废'  ELSE '6-其他' END                 AS ctr_sts_tag
       ,t1.ctr_bgn_dt --合同起始日
       ,t1.ctr_mtu_dt --合同到期日
       ,t1.sys_reg_dt --系统登记日期|c8
       ,t1.pctr_dtrb_dt	--预约放款日期|c8
       ,t1.usc_aply_dt	--用信申请日期|c8
       ,t1.ctr_eff_dt	--合同生效日期|c8
       ,t1.ctr_amt --合同金额
       ,t1.ctr_bal --合同余额
	   ,case when t1.ctr_bal>0 then 1 else 0 end as 是否有余额
       ,t3.sam_rsk_ctrl_id --同一风险控制号
    --    ,t2.同一风险控制号下客户授信总额
       ,CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN 'Y'  ELSE 'N' END       AS 是否信用卡
       ,CASE WHEN t4.cst_id is not null THEN 'N'  ELSE 'Y' END                                  AS is_new_cst
--本笔业务重组标签
       ,CASE WHEN t1.bsn_mark_cd = '04' THEN 'Y'  ELSE 'N' END                                      AS is_cur_cz
--本笔业务预保预报标签
       ,CASE WHEN t1.bsn_mark_cd = '03' THEN 'Y'  ELSE 'N' END                                      AS is_cur_ybyb
--业务类型：经营（对公经营性贷款+个人一般经营性贷款、经营用途随贷通）、消费（个人消费性贷款、消费用途随贷通）
       ,CASE WHEN ( t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003' AND SUBSTR(t1.cpt_usg_cd,1,2) IN ( '03' ) ) ) THEN '消费'
             WHEN ( ( SUBSTR(t1.prd_no,1,1) IN ( '1' ,'4' ) AND SUBSTR(t1.prd_no,1,4) <> '1002' ) OR t1.prd_no LIKE '200102%' OR ( t1.prd_no REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.cpt_usg_cd,1,2) IN ( '01' ,'02' ) ) ) THEN '经营'
             WHEN t1.prd_no IN ( '2002010101001' ,'2002010101901' ) THEN '信用卡' ELSE '其他' END                     AS yw_jy_gx_tag
--客群类型：经营、消费
       ,CASE WHEN t3.loan_cst_typ_cd IN ( '04' ,'08' ,'09' ) THEN '工薪'
             WHEN t3.loan_cst_typ_cd = '05' THEN '其他'  ELSE '经营' END                            AS cst_jy_gx_tag
--随贷通
       ,CASE WHEN t1.prd_no IN ( '2001010101003' ,'2001020101003' ) THEN '随贷通'  ELSE '非随贷通' END AS is_sdt
       ,t6.brc_org_nm --分行名称
       ,t6.sbr_org_nm --支行名称
FROM edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同信息表（含新信贷）
inner join edw.dim_bus_loan_prd_frml_dd     c1
on t1.prd_no=c1.prd_no
and c1.dt=t1.dt
and c1.PD_NM not regexp '信用卡'
INNER JOIN edw.dws_cst_bas_inf_dd 	c2 --客户基础信息汇总
ON t1.cst_id = c2.cst_id AND c2.dt = t1.dt
AND c2.cst_typ_cd = '1'
--同一风险控制号
LEFT JOIN
(
	SELECT  dt
	       ,CASE WHEN nvl(SAM_RSK_CTRL_ID,'') = '' THEN cst_id  ELSE sam_rsk_ctrl_id END AS sam_rsk_ctrl_id
	       ,cst_id
	       ,loan_cst_typ_cd
	FROM edw.dws_cst_bas_inf_dd --客户基本信息表（包含新信贷）
	WHERE dt = '@@{yyyyMMdd}'
	GROUP BY  dt
	         ,sam_rsk_ctrl_id
	         ,cst_id
	         ,loan_cst_typ_cd
) t3
ON t1.cst_id = t3.cst_id
-- left join(
--     select sam_rsk_ctrl_id,sum(客户授信总额) as 同一风险控制号下客户授信总额
--     from SJXQ_SJ2025040836_CST_01
--     group by sam_rsk_ctrl_id
-- )t2 on t3.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
LEFT JOIN
(
	SELECT  distinct cst_id
	FROM edw.dim_bus_loan_ctr_bse_inf_dd --合同信息表（含新信贷）
	WHERE dt = '20241231'
) t4 ON t1.cst_id = t4.cst_id
LEFT JOIN
(
	SELECT  cst_id
	       ,mgr_id
	       ,mgr_org_id AS org_id
	FROM
	(
		SELECT  cst_id
		       ,mgr_id
		       ,mgr_org_id
		       ,last_upd_tm
		       ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  last_upd_tm DESC ) AS rn
		FROM edw.dim_cst_mng_loan_mgr_dd
		WHERE dt = '@@{yyyyMMdd}'
	) a
	WHERE a.rn = 1
) t5
ON t1.cst_id = t5.cst_id
--管户机构信息
LEFT JOIN
(
	SELECT  dt
	       ,brc_org_id
	       ,brc_org_nm
	       ,sbr_org_id
	       ,sbr_org_nm
	       ,tem_org_id
	       ,tem_org_nm
	       ,org_id
	       ,org_nm
	FROM edw.dim_hr_org_mng_org_tree_dd --机构树_考核维度（包含新信贷）
	WHERE dt = '@@{yyyyMMdd}'
	GROUP BY  dt
	         ,brc_org_id
	         ,brc_org_nm
	         ,sbr_org_id
	         ,sbr_org_nm
	         ,tem_org_id
	         ,tem_org_nm
	         ,org_id
	         ,org_nm
) t6 ON t5.org_id = t6.org_id
where t1.dt = '@@{yyyyMMdd}'
and t1.ctr_bgn_dt >= '20250101'
and t6.brc_org_nm regexp '村镇银行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040836_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040836_CST_03 AS
SELECT  ctr_serno       AS 合同流水号
       ,cst_id          AS 客户号
       ,ctr_sts_tag     AS 合同状态
       ,ctr_bgn_dt      AS 合同起始日
       ,ctr_mtu_dt      AS 合同到期日
       ,ctr_amt         AS 合同金额
       ,ctr_bal         AS 合同余额
	   ,是否有余额
       ,sam_rsk_ctrl_id AS 同一风险控制号
       ,是否信用卡
       ,is_new_cst      AS 客户级新老客标签
       ,is_cur_cz       AS 本笔合同是否重组
       ,is_cur_ybyb     AS 本笔合同是否预保预报
       ,yw_jy_gx_tag    AS 业务类型
       ,cst_jy_gx_tag   AS 客群类型
       ,is_sdt          AS 是否随贷通
       ,brc_org_nm      AS 分行名称
       ,sbr_org_nm      AS 支行名称
FROM SJXQ_SJ2025040836_CST_02
;
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025040836_CST_03
;
/*
*/***程义平_SJ20250520106_村行贷款规模分析.sql
﻿/*
口径说明：
1.当年新增：指首次信贷合同发生日期在当年的客户，统计时间节点贷款余额
2.流失挽回：当前时间节点有贷款余额（余额大于0），上年末贷款结清（指合同已结清），但首次信贷合同发生日期是2025年1月1日前。
3.当年流失：指上年末属于我行授信客户（指有未到期未终结的合同），截止统计时间节点无有效授信合同（指合同已结清），较上年末时点的减少值（贷款余额）
4.存量增额、减额、原额：统计时间节点与上年末均是我行客户（指有未到期未终结的合同），贷款余额=统计时间节点-上年末，若大于0，增额；若小于0，减额；若等于0，原额。
5.（0,50]等额度区间。。。。取的是单个客户授信总金额额度
*/
-- 客户首次信贷合同发生日期
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_01 AS
select t1.cst_id,min(t1.ctr_bgn_dt)     as ctr_fst_dt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
where t1.dt>='20240101'     --客户 7685614790	林勤 在20241231前有合同，但在 20250223后丢失
and t1.ctr_bgn_dt<>'18991231'   --去除异常值
GROUP BY t1.cst_id
;
-- 20250525全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_02_1 AS
select t1.cst_id                                   --客户号
    ,t1.ctr_amt                                  --合同金额
    ,t1.ctr_bal                                  --合同余额
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' )
        AND     t1.TMT_DT = '18991231'
        AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
            OR t1.CTR_BAL > 0 ) --未到期未终结口径
        then 1 else 0 end as is_wjq_25
    ,t5.brc_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
-- left join edw.dim_bus_loan_ctr_oth_dtl_inf_dd	t3 --合同其它明细信息
-- on t1.ctr_serno=t3.ctr_serno
-- and t3.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t4 --主管户
on t1.cst_id=t4.cst_id
and t4.dt='20250525'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.prm_org_id = t5.org_id
and t5.dt='20250525'
and t5.brc_org_nm regexp '村镇银行'
where t1.dt='20250525'
-- AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
-- AND     ( t3.APLY_CHNL_CD <> 'L08'  --L08     场景金融平台
--     OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
-- AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
-- AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
-- AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
--     OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
;
-- 20241231全行合同 存在43个客户51个合同丢失 合同余额均为0
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_02_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_02_2 AS
select t1.cst_id                                   --客户号
    ,t1.ctr_amt                                  --合同金额
    ,t1.ctr_bal                                  --合同余额
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' )
        AND     t1.TMT_DT = '18991231'
        AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
            OR t1.CTR_BAL > 0 ) --未到期未终结口径
        then 1 else 0 end as is_wjq_24
    ,t5.brc_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
-- left join edw.dim_bus_loan_ctr_oth_dtl_inf_dd t3 --合同其它明细信息
-- on t1.ctr_serno=t3.ctr_serno
-- and t3.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t4 --主管户
on t1.cst_id=t4.cst_id
and t4.dt='20250525'
inner join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.prm_org_id = t5.org_id
and t5.dt='20250525'
and t5.brc_org_nm regexp '村镇银行'
where t1.dt='20241231'
-- AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
-- AND     ( t3.APLY_CHNL_CD <> 'L08'  --L08     场景金融平台
--     OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
-- AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
-- AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
-- AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
--     OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_02 AS
select t1.brc_org_nm
    ,t1.cst_id
    ,case when t1.ctr_amt >0     and t1.ctr_amt<=500000  then '1'
        when t1.ctr_amt >500000  and t1.ctr_amt<=1000000 then '2'
        when t1.ctr_amt >1000000 and t1.ctr_amt<=3000000 then '3'
        when t1.ctr_amt >3000000 then '4' else 'else' end ctr_amt_25_lvl
    ,t1.ctr_amt         as ctr_amt_25
    ,t1.ctr_bal         as ctr_bal_25
    ,t1.is_wjq_25
    ,case when t2.ctr_amt >0     and t2.ctr_amt<=500000  then '1'
        when t2.ctr_amt >500000  and t2.ctr_amt<=1000000 then '2'
        when t2.ctr_amt >1000000 and t2.ctr_amt<=3000000 then '3'
        when t2.ctr_amt >3000000 then '4' else 'else' end ctr_amt_24_lvl
    ,nvl(t2.ctr_amt,0)      as ctr_amt_24
    ,nvl(t2.ctr_bal,0)      as ctr_bal_24
    ,nvl(t2.is_wjq_24,0)    as is_wjq_24
    ,case when t3.ctr_fst_dt>='20250101' then 1 else 0 end as is_new_cst
    ,t3.ctr_fst_dt
    ,t4.vld_loan_act    as vld_loan_act_24
    ,t5.vld_loan_act    as vld_loan_act_25
from(
    SELECT brc_org_nm,cst_id
        ,sum(case when is_wjq_25=1 then ctr_amt else 0 end) as ctr_amt --合同金额
        ,sum(ctr_bal)   as ctr_bal                                  --合同余额
        ,max(is_wjq_25) as is_wjq_25
    from SJXQ_SJ20250520106_CST_02_1
    GROUP BY brc_org_nm,cst_id
)t1 left join(
    SELECT cst_id
        ,sum(case when is_wjq_24=1 then ctr_amt else 0 end) as ctr_amt --合同金额
        ,sum(ctr_bal)   as ctr_bal                                  --合同余额
        ,max(is_wjq_24) as is_wjq_24
    from SJXQ_SJ20250520106_CST_02_2
    GROUP BY cst_id
)t2 on t1.cst_id=t2.cst_id
inner join SJXQ_SJ20250520106_CST_01         t3
on  t1.cst_id=t3.cst_id
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd	t4 --通用金融行为贷款标签2表
on t1.cst_id=t4.cst_id
and t4.dt='20241231'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd	t5 --通用金融行为贷款标签2表
on t1.cst_id=t5.cst_id
and t5.dt='20250525'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_03 AS
SELECT  coalesce(brc_org_nm,'合计')                                                                                                                     AS 村行
       ,round(SUM(ctr_bal_25)/10000,4)                                                                                                                AS 20250525贷款余额
       ,round(SUM(ctr_bal_24)/10000,4)                                                                                                                AS 上年末贷款余额
       ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,4)                                                                                                   AS 贷款余额_较年初净增
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_24_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_24_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_24_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_24_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_300以上
FROM SJXQ_SJ20250520106_CST_02
GROUP BY  brc_org_nm
GROUPING SETS((brc_org_nm),())
;
-- 不区分授信总金额额度区间
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_04 AS
SELECT  coalesce(brc_org_nm,'合计')                                                                                                  AS 村行
    ,round(SUM(ctr_bal_25)/10000,2)                                                                                                  AS 当年贷款余额
    ,round(SUM(ctr_bal_24)/10000,2)                                                                                                  AS 上年末贷款余额
    ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,2)                                                                                     AS 贷款余额_较年初净增
    ,COUNT(case WHEN is_new_cst = 1 THEN cst_id else 0 end)                                                                          AS 当年新增客户数
    ,COUNT(case WHEN is_new_cst = 1 AND vld_loan_act_25 = '1' THEN cst_id else 0 end)                                                AS 当年新增有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,2)                                                         AS 当年新增贷款余额
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN cst_id else 0 end)                                                        AS 流失挽回客户数
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 AND vld_loan_act_25 = '1' THEN cst_id else 0 end)                              AS 流失挽回有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,2)                                       AS 流失挽回贷款余额
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN cst_id else 0 end)                                                         AS 当年流失客户数
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 AND vld_loan_act_24 = '1' THEN cst_id else 0 end)                               AS 当年流失有效贷款户数
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2)                             AS 当年流失贷款余额
    ,COUNT(case WHEN vld_loan_act_24 = '1' AND vld_loan_act_25 <> '1' THEN cst_id else 0 end)                                        AS 有效转非有效
    ,COUNT(case WHEN vld_loan_act_24 <> '1' AND vld_loan_act_25 = '1' THEN cst_id else 0 end)                                        AS 非有效转有效
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量增额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量减额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,2)            AS 存量原额贷款余额
FROM SJXQ_SJ20250520106_CST_02
GROUP BY  brc_org_nm
GROUPING SETS((brc_org_nm),())
;
-- DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_05 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_05 AS
-- SELECT  brc_org_nm
--         ,is_new_cst
--         ,is_wjq_24
--         ,is_wjq_25
--         ,CASE
--            WHEN ctr_bal_25 > ctr_bal_24 THEN '+'
--            WHEN ctr_bal_25 < ctr_bal_24 THEN '-'
--            WHEN ctr_bal_25 = ctr_bal_24 THEN '='
--            ELSE ''
--          END                          AS cst_cls
--         ,sum(ctr_bal_25)              AS 当年贷款余额
--         ,sum(ctr_bal_24)              AS 上年末贷款余额
--         ,SUM(ctr_bal_25 - ctr_bal_24) AS 贷款余额_较年初净增
-- FROM    SJXQ_SJ20250520106_CST_02
-- GROUP BY brc_org_nm,is_new_cst,is_wjq_24,is_wjq_25,cst_cls
-- ;
-- 流失的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST_06 AS
SELECT  brc_org_nm      AS 主管户分行
       ,cst_id          AS 客户号
       ,ctr_amt_24      AS 24年底授信额度
       ,ctr_bal_24      AS 24年底贷款余额
       ,ctr_fst_dt      AS 首次信贷合同起始日期
       ,vld_loan_act_24 AS 24年底是否有效贷款户
FROM SJXQ_SJ20250520106_CST_02
WHERE is_wjq_24 = 1
AND is_wjq_25 = 0
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST_02
union all
SElECT '021' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST_02_1
union all
SElECT '022' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST_02_2
union all
SElECT '03' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250520106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250520106_CST_04
;
/*
01	2407430	2407430
02	119315	119315
021	316249	119315
022	300844	113668
03	13	13
04	13	13
*/
-- 结果表1
SELECT *
from SJXQ_SJ20250520106_CST_03
;
-- 结果表2
SELECT *
from SJXQ_SJ20250520106_CST_04
;
-- 结果表3 流失的客户清单
SELECT *
from SJXQ_SJ20250520106_CST_06
;
***程义平_SJ20250520106_村行贷款规模分析0529.sql
﻿/*
口径说明：
1.当年新增：指首次信贷合同发生日期在当年的客户，统计时间节点贷款余额
2.流失挽回：当前时间节点有贷款余额（余额大于0），上年末贷款结清（指合同已结清），但首次信贷合同发生日期是2025年1月1日前。
3.当年流失：指上年末属于我行授信客户（指有未到期未终结的合同），截止统计时间节点无有效授信合同（指合同已结清），较上年末时点的减少值（贷款余额）
4.存量增额、减额、原额：统计时间节点与上年末均是我行客户（指有未到期未终结的合同），贷款余额=统计时间节点-上年末，若大于0，增额；若小于0，减额；若等于0，原额。
5.（0,50]等额度区间。。。。取的是单个客户授信总金额额度
*/
-- 按业务口径统计，不然数据总会存在误差
-- 客户首次信贷合同发生日期
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_01 AS
select t1.cst_id,min(t1.ctr_bgn_dt)     as ctr_fst_dt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
where t1.dt>='20240101'     --客户 7685614790	林勤 在20241231前有合同，但在 20250223后丢失
and t1.ctr_bgn_dt<>'18991231'   --去除异常值
GROUP BY t1.cst_id
;
-- 20250525全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_02_1 AS
select t1.brn_org_nm                             --分行机构名称
	,t1.cst_id                                   --客户号
	,sum(ctr_amt)          as ctr_amt                         --合同金额
	,sum(ctr_bal)          as ctr_bal                         --合同余额
	,max(efe_loan_cst_ind) as efe_loan_cst_ind                --有效信贷户标识
from app_ado.fct_sml_loan_amt_list_dd       t1 --普惠金融-小额贷款业务清单
INNER JOIN app_ado.adm_hr_org_path_inf_kh   t2 --多维度机构关系信息-考核
ON t1.PRM_ORG_ID = t2.ORG_ID
AND t2.DT = t1.dt
where t1.dt='20250525'
and t1.BRN_ORG_NM regexp '村镇银行'
group by t1.brn_org_nm,t1.cst_id
;
-- 20241231全行合同 存在43个客户51个合同丢失 合同余额均为0
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_02_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_02_2 AS
select t1.brn_org_nm                             --分行机构名称
	,t1.cst_id                                   --客户号
	,sum(ctr_amt)          as ctr_amt                         --合同金额
	,sum(ctr_bal)          as ctr_bal                         --合同余额
	,max(efe_loan_cst_ind) as efe_loan_cst_ind                --有效信贷户标识
from app_ado.fct_sml_loan_amt_list_dd       t1 --普惠金融-小额贷款业务清单
INNER JOIN app_ado.adm_hr_org_path_inf_kh   t2 --多维度机构关系信息-考核
ON t1.PRM_ORG_ID = t2.ORG_ID
AND t2.DT = t1.dt
where t1.dt='20241231'
and t1.BRN_ORG_NM regexp '村镇银行'
group by t1.brn_org_nm,t1.cst_id
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_02 AS
select t1.brn_org_nm
    ,t1.cst_id
    ,case when t1.ctr_amt >0     and t1.ctr_amt<=500000  then '1'
        when t1.ctr_amt >500000  and t1.ctr_amt<=1000000 then '2'
        when t1.ctr_amt >1000000 and t1.ctr_amt<=3000000 then '3'
        when t1.ctr_amt >3000000 then '4' else 'else' end ctr_amt_25_lvl
    ,nvl(t1.ctr_amt,0)         as ctr_amt_25
    ,nvl(t1.ctr_bal,0)         as ctr_bal_25
    ,t1.efe_loan_cst_ind as vld_loan_act_25
    ,case when t1.cst_id is not null then 1 else 0 end as is_wjq_25
    ,case when t2.ctr_amt >0     and t2.ctr_amt<=500000  then '1'
        when t2.ctr_amt >500000  and t2.ctr_amt<=1000000 then '2'
        when t2.ctr_amt >1000000 and t2.ctr_amt<=3000000 then '3'
        when t2.ctr_amt >3000000 then '4' else 'else' end ctr_amt_24_lvl
    ,nvl(t2.ctr_amt,0)      as ctr_amt_24
    ,nvl(t2.ctr_bal,0)      as ctr_bal_24
    ,t2.efe_loan_cst_ind as vld_loan_act_24
    ,case when t2.cst_id is not null then 1 else 0 end as is_wjq_24
    ,case when t3.ctr_fst_dt>='20250101' or t3.ctr_fst_dt is null then 1 else 0 end as is_new_cst
    ,t3.ctr_fst_dt
from(
    select brn_org_nm,cst_id
    from SJXQ_SJ20250520106_CST2_02_1   --2025
    union
    select brn_org_nm,cst_id
    from SJXQ_SJ20250520106_CST2_02_2   --2024
)t
left join SJXQ_SJ20250520106_CST2_02_1  t1 on t.cst_id=t1.cst_id
left join SJXQ_SJ20250520106_CST2_02_2  t2 on t.cst_id=t2.cst_id
left join SJXQ_SJ20250520106_CST2_01    t3 on t.cst_id=t3.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_03 AS
SELECT  coalesce(brn_org_nm,'合计')                                                                                                                     AS 村行
       ,round(SUM(ctr_bal_25)/10000,4)                                                                                                                AS 20250525贷款余额
       ,round(SUM(ctr_bal_24)/10000,4)                                                                                                                AS 上年末贷款余额
       ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,4)                                                                                                   AS 贷款余额_较年初净增
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_24_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_24_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_24_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_24_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_300以上
FROM SJXQ_SJ20250520106_CST2_02
GROUP BY  brn_org_nm
GROUPING SETS((brn_org_nm),())
;
-- 不区分授信总金额额度区间
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_04 AS
SELECT  coalesce(brn_org_nm,'合计')                                                                                                  AS 村行
    ,round(SUM(ctr_bal_25)/10000,2)                                                                                                  AS 当年贷款余额
    ,round(SUM(ctr_bal_24)/10000,2)                                                                                                  AS 上年末贷款余额
    ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,2)                                                                                     AS 贷款余额_较年初净增
    ,COUNT(case WHEN is_new_cst = 1 THEN cst_id end)                                                                          AS 当年新增客户数
    ,COUNT(case WHEN is_new_cst = 1 AND vld_loan_act_25 = '1' THEN cst_id end)                                                AS 当年新增有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,2)                                                         AS 当年新增贷款余额
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN cst_id end)                                                        AS 流失挽回客户数
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 AND vld_loan_act_25 = '1' THEN cst_id end)                              AS 流失挽回有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,2)                                       AS 流失挽回贷款余额
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN cst_id end)                                                         AS 当年流失客户数
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 AND vld_loan_act_24 = '1' THEN cst_id end)                               AS 当年流失有效贷款户数
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2)                             AS 当年流失贷款余额
    ,COUNT(case WHEN vld_loan_act_24 = '1' AND vld_loan_act_25 = '0' THEN cst_id end)                                        AS 有效转非有效
    ,COUNT(case WHEN vld_loan_act_24 = '0' AND vld_loan_act_25 = '1' THEN cst_id end)                                        AS 非有效转有效
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量增额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量减额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,2)            AS 存量原额贷款余额
FROM SJXQ_SJ20250520106_CST2_02
GROUP BY  brn_org_nm
GROUPING SETS((brn_org_nm),())
;
-- 流失的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250520106_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250520106_CST2_05 AS
SELECT  brn_org_nm      AS 主管户分行
       ,cst_id          AS 客户号
       ,ctr_amt_24      AS 24年底授信额度
       ,ctr_bal_24      AS 24年底贷款余额
       ,ctr_fst_dt      AS 首次信贷合同起始日期
       ,vld_loan_act_24 AS 24年底是否有效贷款户
FROM SJXQ_SJ20250520106_CST2_02
WHERE is_wjq_24 = 1
AND is_wjq_25 = 0
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST2_02
union all
SElECT '021' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST2_02_1
union all
SElECT '022' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250520106_CST2_02_2
union all
SElECT '03' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250520106_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250520106_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250520106_CST2_05
;
/*
01	2407430	2407430
02	119315	119315
021	316249	119315
022	300844	113668
03	13	13
04	13	13
*/
-- 结果表1
SELECT *
from SJXQ_SJ20250520106_CST2_03
;
-- 结果表2
SELECT *
from SJXQ_SJ20250520106_CST2_04
;
-- 结果表3 流失的客户清单
SELECT *
from SJXQ_SJ20250520106_CST2_05
;
***程义平_SJ20250707111_村行贷款余额分析.sql
﻿-- 程义平_SJ20250707111_村行贷款余额分析
-- 程义平_SJ20250707111_村行贷款余额分析
-- 截至2025年6月30日，村行贷款余额较年初减少3.44亿元，数据取自01015报表，下面字段拆分当年新增、当年流失挽回、当年流失、存量增减额来进行具体分析。
/*
口径说明：
1.当年新增：指首次信贷合同发生日期在2025年的未结清信贷业务客户，取当前时间节点贷款余额
2.当年流失挽回：当前时间节点有未结清信贷业务，上年末无未结清信贷业务（贷款结清），但首次信贷合同发生日期是2024年12月31日前。
3.当年流失：指上年末有未结清信贷业务，当前时间节点无未结清信贷业务，取较2024年末时点的减少值（贷款余额）
4.存量增额、减额、原额：统计时间节点与上年末均有未结清信贷业务，贷款余额=统计时间节点-上年末，若大于0，增额；若小于0，减额；若等于0，原额。
5.（0,50]等额度区间。。。。取的是单个客户授信总金额额度（该代码详见附件，判断当前时点未结清客户的单户授信额度分层）
6.标黄的部分，存量原额取得是当前时间节点的贷款余额
PRD_NO not like '2002010101%'
*/
-- 按业务口径统计，不然数据总会存在误差
-- 客户首次信贷合同发生日期
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_01 AS
select t1.cst_id,min(case when t1.ctr_bgn_dt<>'18991231' then t1.ctr_bgn_dt end) as ctr_fst_dt
    ,sum(case when t1.dt='20250630'  and ((t1.CTR_STS_CD IN ( '2' , '4' ) AND t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0) then ctr_amt else 0 end)             as ctr_amt
    ,sum(case when t1.dt='20250630' then ctr_bal else 0 end)    as ctr_bal
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
LEFT JOIN   EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD T2 --合同其他明细信息
ON  T1.CTR_SERNO  =  T2.CTR_SERNO
AND T2.DT  = '20250630'
where t1.dt>='20240101'     --客户 7685614790	林勤 在20241231前有合同，但在 20250223后丢失
AND T1.BSN_MARK_CD <> '01'  --剔除  员工贷款
AND (T2.APLY_CHNL_CD  <>  'L08' OR  T1.PRD_NO  <>  '2001010101007')  --剔除  小鱼分期
AND T1.PRD_NO  <>  '2001010101008'  --剔除  蚂蚁借呗
AND T1.PRD_NO  <>  '2001010101010'  --剔除百度分期贷
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
GROUP BY t1.cst_id
;
-- 20250630全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_02 AS
select t1.brn_org_nm                             --分行机构名称
	,t1.cst_id                                   --客户号
	,sum(ctr_amt)          as ctr_amt                         --合同金额
	,sum(ctr_bal)          as ctr_bal                         --合同余额
	,max(efe_loan_cst_ind) as efe_loan_cst_ind                --有效信贷户标识
from app_ado.fct_sml_loan_amt_list_dd       t1 --普惠金融-小额贷款业务清单
INNER JOIN app_ado.adm_hr_org_path_inf_kh   t2 --多维度机构关系信息-考核
ON t1.PRM_ORG_ID = t2.ORG_ID
AND t2.DT = t1.dt
where t1.dt='20250630'
and t1.BRN_ORG_NM regexp '村镇银行'
group by t1.brn_org_nm,t1.cst_id
;
-- 20241231全行合同 存在43个客户51个合同丢失 合同余额均为0
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_03 AS
select t1.brn_org_nm                             --分行机构名称
	,t1.cst_id                                   --客户号
	,sum(ctr_amt)          as ctr_amt                         --合同金额
	,sum(ctr_bal)          as ctr_bal                         --合同余额
	,max(efe_loan_cst_ind) as efe_loan_cst_ind                --有效信贷户标识
from app_ado.fct_sml_loan_amt_list_dd       t1 --普惠金融-小额贷款业务清单
INNER JOIN app_ado.adm_hr_org_path_inf_kh   t2 --多维度机构关系信息-考核
ON t1.PRM_ORG_ID = t2.ORG_ID
AND t2.DT = t1.dt
where t1.dt='20241231'
and t1.BRN_ORG_NM regexp '村镇银行'
group by t1.brn_org_nm,t1.cst_id
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_04 AS
select t.brn_org_nm
    ,t.cst_id
    ,case when t2.ctr_amt >0     and t2.ctr_amt<=500000  then '1'
        when t2.ctr_amt >500000  and t2.ctr_amt<=1000000 then '2'
        when t2.ctr_amt >1000000 and t2.ctr_amt<=3000000 then '3'
        when t2.ctr_amt >3000000 then '4' else 'else' end ctr_amt_25_lvl
    ,nvl(t2.ctr_amt,0)         as ctr_amt_25
    ,nvl(t2.ctr_bal,0)         as ctr_bal_25
    ,t2.efe_loan_cst_ind as vld_loan_act_25
    ,case when t2.cst_id is not null then 1 else 0 end as is_wjq_25
    ,case when t3.ctr_amt >0     and t3.ctr_amt<=500000  then '1'
        when t3.ctr_amt >500000  and t3.ctr_amt<=1000000 then '2'
        when t3.ctr_amt >1000000 and t3.ctr_amt<=3000000 then '3'
        when t3.ctr_amt >3000000 then '4' else 'else' end ctr_amt_24_lvl
    ,nvl(t3.ctr_amt,0)      as ctr_amt_24
    ,nvl(t3.ctr_bal,0)      as ctr_bal_24
    ,t3.efe_loan_cst_ind as vld_loan_act_24
    ,case when t3.cst_id is not null then 1 else 0 end as is_wjq_24
    ,case when t1.ctr_fst_dt>='20250101' or t1.ctr_fst_dt is null then 1 else 0 end as is_new_cst
    ,t1.ctr_fst_dt
    ,t1.cst_id as cst_id2
from(
    select brn_org_nm,cst_id
    from SJXQ_SJ20250707111_CST_02   --2025
    union
    select brn_org_nm,cst_id
    from SJXQ_SJ20250707111_CST_03   --2024
)t inner join SJXQ_SJ20250707111_CST_01  t1
on t.cst_id=t1.cst_id
left join SJXQ_SJ20250707111_CST_02  t2
on t.cst_id=t2.cst_id
left join SJXQ_SJ20250707111_CST_03  t3
on t.cst_id=t3.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_05 AS
SELECT  nvl(brn_org_nm,'合计')                                                                                                                     AS 村行
       ,round(SUM(ctr_bal_25)/10000,4)                                                                                                                AS 20250630贷款余额
       ,round(SUM(ctr_bal_24)/10000,4)                                                                                                                AS 上年末贷款余额
       ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,4)                                                                                                   AS 贷款余额_较年初净增
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_24_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_24_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_24_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_24_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_300以上
FROM SJXQ_SJ20250707111_CST_04
GROUP BY brn_org_nm GROUPING SETS((brn_org_nm),())
;
-- 不区分授信总金额额度区间
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_06 AS
SELECT  nvl(brn_org_nm,'合计')                                                                                                  AS 村行
    ,round(SUM(ctr_bal_25)/10000,2)                                                                                                  AS 当年贷款余额
    ,round(SUM(ctr_bal_24)/10000,2)                                                                                                  AS 上年末贷款余额
    ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,2)                                                                                     AS 贷款余额_较年初净增
    ,COUNT(case WHEN is_new_cst = 1 THEN cst_id end)                                                                          AS 当年新增客户数
    ,COUNT(case WHEN is_new_cst = 1 AND vld_loan_act_25 = '1' THEN cst_id end)                                                AS 当年新增有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,2)                                                         AS 当年新增贷款余额
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN cst_id end)                                                        AS 流失挽回客户数
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 AND vld_loan_act_25 = '1' THEN cst_id end)                              AS 流失挽回有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,2)                                       AS 流失挽回贷款余额
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN cst_id end)                                                         AS 当年流失客户数
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 AND vld_loan_act_24 = '1' THEN cst_id end)                               AS 当年流失有效贷款户数
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2)                             AS 当年流失贷款余额
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND vld_loan_act_24 = '1' AND vld_loan_act_25 = '0' THEN cst_id end)     AS 有效转非有效
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND vld_loan_act_24 = '0' AND vld_loan_act_25 = '1' THEN cst_id end)     AS 非有效转有效
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量增额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量减额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,2)            AS 存量原额贷款余额
FROM SJXQ_SJ20250707111_CST_04
GROUP BY brn_org_nm GROUPING SETS((brn_org_nm),())
;
-- 流失的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_07 AS
SELECT  brn_org_nm      AS 主管户分行
       ,cst_id          AS 客户号
       ,ctr_amt_24      AS 24年底授信额度
       ,ctr_bal_24      AS 24年底贷款余额
       ,ctr_fst_dt      AS 首次信贷合同起始日期
       ,vld_loan_act_24 AS 24年底是否有效贷款户
FROM SJXQ_SJ20250707111_CST_04
WHERE is_wjq_24 = 1 AND is_wjq_25 = 0
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250707111_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250707111_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250707111_CST_07
;
/*
01	1592880	1592880
02	72374	72374
03	69257	69257
04	77782	77782
05	14	14
06	14	14
07	5560	5560
*/
-- 结果表1
from lab_sjxq.SJXQ_SJ20250707111_CST_05
;
-- 结果表2
from lab_sjxq.SJXQ_SJ20250707111_CST_06
;
-- 结果表3 流失的客户清单
from lab_sjxq.SJXQ_SJ20250707111_CST_07
***程义平_SJ20250707111_村行贷款余额分析0715.sql
-- 程义平_SJ20250707111_村行贷款余额分析
-- 截至2025年6月30日，村行贷款余额较年初减少3.44亿元，数据取自01015报表，下面字段拆分当年新增、当年流失挽回、当年流失、存量增减额来进行具体分析。
/*
口径说明：
1.当年新增：指首次信贷合同发生日期在2025年的未结清信贷业务客户，取当前时间节点贷款余额
2.当年流失挽回：当前时间节点有未结清信贷业务，上年末无未结清信贷业务（贷款结清），但首次信贷合同发生日期是2024年12月31日前。
3.当年流失：指上年末有未结清信贷业务，当前时间节点无未结清信贷业务，取较2024年末时点的减少值（贷款余额）
4.存量增额、减额、原额：统计时间节点与上年末均有未结清信贷业务，贷款余额=统计时间节点-上年末，若大于0，增额；若小于0，减额；若等于0，原额。
5.（0,50]等额度区间。。。。取的是单个客户授信总金额额度（该代码详见附件，判断当前时点未结清客户的单户授信额度分层）
6.标黄的部分，存量原额取得是当前时间节点的贷款余额
PRD_NO not like '2002010101%'
*/
-- 按业务口径统计，不然数据总会存在误差
-- 客户首次信贷合同发生日期
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_01 AS
select t1.cst_id,min(case when t1.ctr_bgn_dt<>'18991231' then t1.ctr_bgn_dt end) as ctr_fst_dt
    ,sum(case when t1.dt='20250630'  and ((t1.CTR_STS_CD IN ( '2' , '4' ) AND t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0) then T1.CTR_AMT * T3.AVG_PRC / T3.QUO_UNT else 0 end)             as ctr_amt
    ,sum(case when t1.dt='20250630' then T1.ctr_bal* T3.AVG_PRC / T3.QUO_UNT else 0 end)     as ctr_bal
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
LEFT JOIN   EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD T2 --合同其他明细信息
ON  T1.CTR_SERNO  =  T2.CTR_SERNO
AND T2.DT  = '20250630'
INNER JOIN EDW.DIM_BUS_COM_EXR_INF_DD T3 --汇率信息表
ON T1.BSN_CCY_CD = T3.CCY_CD --币种代码
AND T3.DT = '20250630'
where t1.dt>='20240101'     --客户 7685614790	林勤 在20241231前有合同，但在 20250223后丢失
and t1.dt<='20250630'
AND T1.BSN_MARK_CD <> '01'  --剔除  员工贷款
AND (T2.APLY_CHNL_CD  <>  'L08' OR  T1.PRD_NO  <>  '2001010101007')  --剔除  小鱼分期
AND T1.PRD_NO  <>  '2001010101008'  --剔除  蚂蚁借呗
AND T1.PRD_NO  <>  '2001010101010'  --剔除百度分期贷
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
GROUP BY t1.cst_id
;
-- 20250630全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_02 AS
select t3.brn_org_nm,t1.cst_id
	,sum(t1.ctr_amt* T5.AVG_PRC / T5.QUO_UNT)          as ctr_amt                         --合同金额
	,sum(t1.ctr_bal* T5.AVG_PRC / T5.QUO_UNT)          as ctr_bal                         --合同余额
    ,max(t4.efe_loan_cst_ind) as efe_loan_cst_ind
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
LEFT JOIN   EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD T2 --合同其他明细信息
ON  T1.CTR_SERNO  =  T2.CTR_SERNO
AND T2.DT  = t1.dt
inner join(
    select distinct cst_id,brn_org_nm
    from app_ado.fct_sml_loan_amt_list_dd
    where dt='20250630'
    and brn_org_nm regexp '村镇银行'
)t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd   t4
on t1.cst_id=t4.cst_id
and t4.dt=t1.dt
INNER JOIN EDW.DIM_BUS_COM_EXR_INF_DD T5 --汇率信息表
ON T1.BSN_CCY_CD = T5.CCY_CD --币种代码
AND T5.DT = '20250630'
where t1.dt='20250630'
AND T1.BSN_MARK_CD <> '01'  --剔除  员工贷款
AND (T2.APLY_CHNL_CD  <>  'L08' OR  T1.PRD_NO  <>  '2001010101007')  --剔除  小鱼分期
AND T1.PRD_NO  <>  '2001010101008'  --剔除  蚂蚁借呗
AND T1.PRD_NO  <>  '2001010101010'  --剔除百度分期贷
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
GROUP BY t3.brn_org_nm,t1.cst_id
;
-- 20241231全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_03 AS
select t3.brn_org_nm,t1.cst_id
	,sum(t1.ctr_amt* T5.AVG_PRC / T5.QUO_UNT)          as ctr_amt                         --合同金额
	,sum(t1.ctr_bal* T5.AVG_PRC / T5.QUO_UNT)          as ctr_bal                         --合同余额
    ,max(t4.efe_loan_cst_ind) as efe_loan_cst_ind
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
LEFT JOIN   EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD T2 --合同其他明细信息
ON  T1.CTR_SERNO  =  T2.CTR_SERNO
AND T2.DT  = t1.dt
inner join(
    select distinct cst_id,brn_org_nm
    from app_ado.fct_sml_loan_amt_list_dd
    where dt='20241231'
    and brn_org_nm regexp '村镇银行'
)t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd   t4
on t1.cst_id=t4.cst_id
and t4.dt=t1.dt
INNER JOIN EDW.DIM_BUS_COM_EXR_INF_DD T5 --汇率信息表
ON T1.BSN_CCY_CD = T5.CCY_CD --币种代码
AND T5.DT = '20250630'
where t1.dt='20241231'
AND T1.BSN_MARK_CD <> '01'  --剔除  员工贷款
AND (T2.APLY_CHNL_CD  <>  'L08' OR  T1.PRD_NO  <>  '2001010101007')  --剔除  小鱼分期
AND T1.PRD_NO  <>  '2001010101008'  --剔除  蚂蚁借呗
AND T1.PRD_NO  <>  '2001010101010'  --剔除百度分期贷
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
GROUP BY t3.brn_org_nm,t1.cst_id
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_04 AS
select t.brn_org_nm
    ,t.cst_id
    ,case when t2.ctr_amt >0     and t2.ctr_amt<=500000  then '1'
        when t2.ctr_amt >500000  and t2.ctr_amt<=1000000 then '2'
        when t2.ctr_amt >1000000 and t2.ctr_amt<=3000000 then '3'
        when t2.ctr_amt >3000000 then '4' else 'else' end ctr_amt_25_lvl
    ,nvl(t2.ctr_amt,0)         as ctr_amt_25
    ,nvl(t2.ctr_bal,0)         as ctr_bal_25
    ,t2.efe_loan_cst_ind as vld_loan_act_25
    ,case when t2.cst_id is not null then 1 else 0 end as is_wjq_25
    ,case when t3.ctr_amt >0     and t3.ctr_amt<=500000  then '1'
        when t3.ctr_amt >500000  and t3.ctr_amt<=1000000 then '2'
        when t3.ctr_amt >1000000 and t3.ctr_amt<=3000000 then '3'
        when t3.ctr_amt >3000000 then '4' else 'else' end ctr_amt_24_lvl
    ,nvl(t3.ctr_amt,0)      as ctr_amt_24
    ,nvl(t3.ctr_bal,0)      as ctr_bal_24
    ,t3.efe_loan_cst_ind as vld_loan_act_24
    ,case when t3.cst_id is not null then 1 else 0 end as is_wjq_24
    ,case when t1.ctr_fst_dt>='20250101' or t1.ctr_fst_dt is null then 1 else 0 end as is_new_cst
    ,t1.ctr_fst_dt
from(
    select brn_org_nm,cst_id
    from SJXQ_SJ20250707111_CST2_02   --2025
    union
    select brn_org_nm,cst_id
    from SJXQ_SJ20250707111_CST2_03   --2024
)t inner join SJXQ_SJ20250707111_CST2_01  t1
on t.cst_id=t1.cst_id
left join SJXQ_SJ20250707111_CST2_02  t2
on t.cst_id=t2.cst_id
left join SJXQ_SJ20250707111_CST2_03  t3
on t.cst_id=t3.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST_05 AS
SELECT  nvl(brn_org_nm,'合计')                                                                                                                     AS 村行
       ,round(SUM(ctr_bal_25)/10000,4)                                                                                                                AS 20250630贷款余额
       ,round(SUM(ctr_bal_24)/10000,4)                                                                                                                AS 上年末贷款余额
       ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,4)                                                                                                   AS 贷款余额_较年初净增
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,4)                                              AS 当年新增贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,4)                            AS 流失挽回贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_24_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_24_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_24_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_24_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4)                  AS 当年流失贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量增额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,4) AS 存量减额贷款余额_300以上
       ,round(SUM(case WHEN ctr_amt_25_lvl = '1' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_0_50
       ,round(SUM(case WHEN ctr_amt_25_lvl = '2' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_50_100
       ,round(SUM(case WHEN ctr_amt_25_lvl = '3' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_100_300
       ,round(SUM(case WHEN ctr_amt_25_lvl = '4' AND is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,4) AS 存量原额贷款余额_300以上
FROM SJXQ_SJ20250707111_CST_04
GROUP BY brn_org_nm GROUPING SETS((brn_org_nm),())
;
-- 不区分授信总金额额度区间
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_06 AS
SELECT  nvl(brn_org_nm,'合计')                                                                                                  AS 村行
    ,round(SUM(ctr_bal_25)/10000,2)                                                                                                  AS 当年贷款余额
    ,round(SUM(ctr_bal_24)/10000,2)                                                                                                  AS 上年末贷款余额
    ,round(SUM(ctr_bal_25 - ctr_bal_24)/10000,2)                                                                                     AS 贷款余额_较年初净增
    ,COUNT(case WHEN is_new_cst = 1 THEN cst_id end)                                                                          AS 当年新增客户数
    ,COUNT(case WHEN is_new_cst = 1 AND vld_loan_act_25 = '1' THEN cst_id end)                                                AS 当年新增有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 1 THEN ctr_bal_25 else 0 end)/10000,2)                                                         AS 当年新增贷款余额
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN cst_id end)                                                        AS 流失挽回客户数
    ,COUNT(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 AND vld_loan_act_25 = '1' THEN cst_id end)                              AS 流失挽回有效贷款户数
    ,round(SUM(case WHEN is_new_cst = 0 AND is_wjq_24 = 0 THEN ctr_bal_25 else 0 end)/10000,2)                                       AS 流失挽回贷款余额
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN cst_id end)                                                         AS 当年流失客户数
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 AND vld_loan_act_24 = '1' THEN cst_id end)                               AS 当年流失有效贷款户数
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 0 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2)                             AS 当年流失贷款余额
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND vld_loan_act_24 = '1' AND vld_loan_act_25 = '0' THEN cst_id end)     AS 有效转非有效
    ,COUNT(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND vld_loan_act_24 = '0' AND vld_loan_act_25 = '1' THEN cst_id end)     AS 非有效转有效
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 > ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量增额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 < ctr_bal_24 THEN ctr_bal_25-ctr_bal_24 else 0 end)/10000,2) AS 存量减额贷款余额
    ,round(SUM(case WHEN is_wjq_24 = 1 AND is_wjq_25 = 1 AND ctr_bal_25 = ctr_bal_24 THEN ctr_bal_25 else 0 end)/10000,2)            AS 存量原额贷款余额
FROM SJXQ_SJ20250707111_CST2_04
GROUP BY brn_org_nm GROUPING SETS((brn_org_nm),())
;
-- 流失的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_07 AS
SELECT  brn_org_nm      AS 主管户分行
       ,cst_id          AS 客户号
       ,ctr_amt_24      AS 24年底授信额度
       ,ctr_bal_24      AS 24年底贷款余额
       ,ctr_fst_dt      AS 首次信贷合同起始日期
       ,vld_loan_act_24 AS 24年底是否有效贷款户
FROM SJXQ_SJ20250707111_CST2_04
WHERE is_wjq_24 = 1 AND is_wjq_25 = 0
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250707111_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250707111_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 村行) custs
from SJXQ_SJ20250707111_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250707111_CST2_07
;
/*
01	1592880	1592880
02	72374	72374
03	69257	69257
04	77782	77782
05	14	14
06	14	14
07	5560	5560
*/
-- 结果表1
from lab_sjxq.SJXQ_SJ20250707111_CST2_05
;
-- 结果表2
from lab_sjxq.SJXQ_SJ20250707111_CST2_06
;
-- 结果表3 流失的客户清单
from lab_sjxq.SJXQ_SJ20250707111_CST2_07
;
-- 管户核对
DROP   TABLE IF     EXISTS SJXQ_SJ20250707111_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250707111_CST2_08 AS
select t1.dt,t1.cst_id,t1.brn_org_nm
    ,t4.brc_org_nm  as prm_brc_nm
    ,t5.brc_org_nm  as ln_brc_nm
from(
    select distinct cst_id,brn_org_nm,dt
    from app_ado.fct_sml_loan_amt_list_dd
    and brn_org_nm regexp '村镇银行'
)t1
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t3.ln_org_id = t5.org_id
and t5.dt = t1.dt
;
select dt,brn_org_nm,prm_brc_nm,ln_brc_nm,count(1) custs
from SJXQ_SJ20250707111_CST2_08
group by dt,brn_org_nm,prm_brc_nm,ln_brc_nm
order by dt,brn_org_nm,prm_brc_nm,ln_brc_nm
;
-- 有效贷款户核对
select dt,efe_loan_cst_ind,VLD_LOAN_ACT,count(1) custs
from(
    SELECT  t1.dt
        ,t1.cst_id           --客户号
        ,t1.efe_loan_cst_ind --有效贷款户标识
        ,t2.VLD_LOAN_ACT     --有效贷款户：0否1是
    from adm_pub.adm_csm_cbas_ind_inf_dd  t1        --客户集市-基础信息-客户基础标识信息
    left join adm_ind.ADM_IND_L_RUL_UNVS_FIN_BHV_LOAN_L2_DD t2
    on t1.cst_id=t2.cst_id
    and t1.dt=t2.dt
)t1 group by dt,efe_loan_cst_ind,VLD_LOAN_ACT
order by dt,efe_loan_cst_ind,VLD_LOAN_ACT
;
***程彩艳_SJ2025012706_龙海村行客户信息.sql
﻿-- 统计周期：截止2025年1月31日龙海村行所有客户。
-- 所属机构号、管户客户经理、客户号、客户名称、年龄、征信分、授信总额、授信余额、是否随贷通卡客户、所属子社区、他行贷款机构家数、他行贷款金额、
-- 他行贷款余额、他行信用卡张数、他行办信用卡机构数、他行信用卡授信金额、他行信用卡用信金额、他行经营性贷款金额、他行经营性贷款余额、经营行业、客群标签(经营、消费、农民、市民)。
--个人征信贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2025012706_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012706_CST_01 AS
SELECT  A1.cst_id
       ,A1.report_id
       ,COUNT(DISTINCT CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN dtrb_org END) AS 他行贷款机构家数
       ,SUM(CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ctr_bal END)             AS 他行贷款余额
       ,SUM(CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN ctr_amt END)             AS 他行贷款金额
       ,SUM(CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' ,'R3' ) THEN 1 ELSE 0 END)                  AS 他行信用卡张数
       ,COUNT(DISTINCT CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' ,'R3' ) THEN dtrb_org END)       AS 他行办信用卡机构数
       ,SUM(CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' ,'R3' ) THEN ctr_amt END)                   AS 他行信用卡授信金额
       ,SUM(CASE WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' ,'R3' ) THEN ctr_bal END)                   AS 他行信用卡用信金额
	   ,COUNT(DISTINCT CASE WHEN dtrb_org <> 'ZJTLCB' AND pd_cd IN ( '41' ,'42' ,'52' ) THEN dtrb_org END)      as 他行经营性贷款机构家数
       ,SUM(DISTINCT CASE WHEN dtrb_org <> 'ZJTLCB' AND pd_cd IN ( '41' ,'42' ,'52' ) THEN ctr_amt END)         AS 他行经营性贷款金额
       ,SUM(DISTINCT CASE WHEN dtrb_org <> 'ZJTLCB' AND pd_cd IN ( '41' ,'42' ,'52' ) THEN ctr_bal END)         AS 他行经营性贷款余额
FROM edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE A1.DT = '@@{yyyyMMdd}'
AND A1.cls_dt >= '@@{yyyyMMdd}' --未关闭
AND LENGTH(NVL(A1.cst_id, '')) > 0
GROUP BY  A1.cst_id
         ,A1.report_id;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025012706_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012706_CST_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
    ,row_number() over(partition by cst_id order by prd_dt desc) rn
from(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                          AS cst_cr_grd_val
        ,'中征分' sc_src
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20250131' and nvl(cr_sco_val,'')<>''
    UNION
    SELECT  cst_id
        ,prd_dt
        ,cst_cr_grd_val
        ,'中征分' sc_src
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20250131' and nvl(cst_cr_grd_val,'')<>''
    union
    SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
        ,'指标表' sc_src
    from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
    where dt='20250131' and nvl(idv_crd_sco_val,'')<>''
    union
    SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
        ,'集市表' sc_src
    from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
    where dt<='20250131'
    and nvl(digital_unscr,'')<>''
)t
;
--结果表
DROP   TABLE IF     EXISTS SJXQ_SJ2025012706_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012706_CST_03 AS
SELECT  T1.ln_org_id                                                                  AS 所属机构号
       ,T1.ln_org_nm                                                                  AS 所属机构
       ,T1.ln_mgr_id                                                                  AS 管户客户经理工号
       ,T1.ln_mgr_nm                                                                  AS 管户客户经理
       ,T1.cst_id                                                                     AS 客户号
       ,T2.cst_chn_nm                                                                 AS 客户名称
       ,greatest(T3.idv_crd_sco_val,T3.idv_crd_sco_val2)                              AS 征信分
       ,T4.授信总额
       ,T4.授信余额
       ,CASE WHEN T4.是否随贷通卡客户 = 1 THEN '是'  ELSE '否' END                      AS 是否随贷通卡客户
       ,T2.sub_cmnt_id                                                                AS 所属子社区编号
       ,T5.cmnt_nm                                                                    AS 所属子社区
       ,T7.他行贷款机构家数
       ,T7.他行贷款金额
       ,T7.他行贷款余额
	   ,T7.他行经营性贷款机构家数
       ,T7.他行经营性贷款金额
       ,T7.他行经营性贷款余额
       ,T7.他行信用卡张数
       ,T7.他行办信用卡机构数
       ,T7.他行信用卡授信金额
       ,T7.他行信用卡用信金额
       ,T6.cd_val_dscr                                                                 AS 经营行业_工作单位所属行业
    --    ,CASE WHEN T8.two_people_ind = '1' THEN '市民'
    --          WHEN T8.two_people_ind = '2' THEN '农民' END                               AS 农民_市民
    --    ,CASE WHEN T9.opr_cst = '1' THEN '是'  ELSE '否' END                             AS 是否经营性客户
    --    ,CASE WHEN T9.csm_cst = '1' THEN '是'  ELSE '否' END                             AS 是否消费性客户
FROM adm_pub.adm_csm_cbas_mng_inf_dd T1 --客户集市-客户基础-客户管户信息
INNER JOIN edw.dws_cst_idv_bas_inf_dd T2 --个人客户基本信息汇总表
ON T1.cst_id = T2.cst_id
AND T2.DT = '20250131'
LEFT JOIN edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
ON T1.cst_id = T3.cst_id
AND T3.report_dsc_rn = '1'
AND T3.DT = '20250131'
LEFT JOIN
(
	SELECT  t1.cst_id
	       ,SUM(ctr_amt)                                           AS 授信总额
	       ,SUM(CTR_BAL)                                           AS 授信余额
	       ,MAX(case WHEN t2.PD_NM regexp '随贷通' THEN 1 else 0 end) AS 是否随贷通卡客户
	FROM edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同基础信息
	INNER JOIN edw.dim_bus_loan_prd_frml_dd t2
	ON t1.prd_no = t2.prd_no
    AND t2.dt = '20250131'
    AND t2.PD_NM not regexp '信用卡'
	WHERE t1.DT = '20250131'
	GROUP BY  t1.cst_id
) T4
ON T1.cst_id = T4.cst_id
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd T5 --社区信息
ON T2.sub_cmnt_id = T5.cmnt_enc
AND T5.DT = '20250131'
LEFT JOIN edw.dwd_code_library_dd T6 -- 码值表
ON T2.job_unt_afl_idt = T6.cd_val
AND T6.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND T6.fld_nm = 'IDT_CD'
AND T6.DT = '20250131'
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2025012706_CST_01 T7
ON T1.cst_id = T7.cst_id
AND T3.report_no = T7.report_id
LEFT JOIN adm_pub.adm_csm_clab_cst_inf_cmpn_idv_inf_dd T8 --客户集市-客户标签信息-客户信息-营销-对私客户
ON T1.cst_id = T8.cst_id
AND T8.DT = '20250131'
LEFT JOIN adm_pub.adm_csm_clab_ln_inf_dd T9 --客户集市-标签层-信贷客户标签信息表
ON T1.cst_id = T9.cst_id
AND T9.DT = '20250131'
WHERE T1.DT = '20250131'
AND T1.ln_org_id LIKE '3563%' --龙海村行
;
SELECT * from lab_bigdata_dev.SJXQ_SJ2025012706_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012706_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012706_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025012706_CST_03
;
/*
01	18798445	3493726
02	3811588	3811587
03	34026	34026
*/***程彩艳_SJ2025012706_龙海村行客户信息_self.sql
-- 截止20250131 龙海村行所有客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025012706_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012706_CST2_01 AS
select t1.cst_id
	,t1.cst_nm                                   --客户姓名|C200
    ,t1.prm_mgr_id,t1.prm_mgr_nm,t1.prm_org_id
    ,t2.brc_org_nm,t2.sbr_org_nm,t2.tem_org_nm,t2.org_nm
    ,t3.age
    ,t4.crd_tot_amt	    --	授信总额
    ,t4.crd_bal	        --	授信余额
    ,t5.is_hld_sdt	    --	持有随贷通
    ,t5.sdt_nbr	        --	持有存量随贷通卡
    ,t6.sub_cmnt_id           as 子社区编号
    ,t7.cmnt_nm               as 子社区名称
from adm_pub_app.adm_pblc_cst_prm_mng_inf_dd    t1 --客户`主管户`信息
inner join edw.dim_hr_org_mng_org_tree_dd       t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = '20250131'
and t2.brc_org_nm like '福建龙海泰隆村镇%'       --龙海村行
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t3 --对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt='20250131'
left join adm_pub.adm_csm_clab_ln_inf_dd 		t4 	--信贷客户标签信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250131'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd	t5 --客户集市-标签信息-客户持有产品信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250131'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20250131'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20250131'
where t1.dt = '20250131'
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025012706_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012706_CST2_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
    ,row_number() over(partition by cst_id order by prd_dt desc) rn
from(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                          AS cst_cr_grd_val
        ,'中征分' sc_src
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20250131' and nvl(cr_sco_val,'')<>''
    UNION
    SELECT  cst_id
        ,prd_dt
        ,cst_cr_grd_val
        ,'中征分' sc_src
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20250131' and nvl(cst_cr_grd_val,'')<>''
    union
    SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
        ,'指标表' sc_src
    from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
    where dt='20250131' and nvl(idv_crd_sco_val,'')<>''
    union
    SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
        ,'集市表' sc_src
    from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
    where dt<='20250131'
    and nvl(digital_unscr,'')<>''
)t
;
所属机构号
管户客户经理
客户号
客户名称
年龄
中征信评分
授信总额
授信余额
是否随贷通卡客户
所属子社区
他行贷款机构家数
他行贷款金额
他行贷款余额
他行经营性贷款机构家数
他行经营性贷款金额
他行经营性贷款余额
他行信用卡张数
他行办信用卡机构数
他行信用卡授信金额
他行信用卡用信金额
经营行业
***程钰_SJ2025062787_全行未落实批复意见.sql
﻿-- 程钰_SJ2025062787_全行未落实批复意见
/*
数据日期：截止到2025年6月27日数据
数据范围：信贷系统全行的待落实批复意见
查询条件：
批复意见控制类型为强控类 且 批复意见落实状态不为已落实
*/
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025062787_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062787_CST_01 AS
select t1.cst_id                                 --客户号
	,t1.cst_nm                                   --客户名称
	,t1.bsn_serno                                --业务流水号
	,t1.reply_opnn_serno                         --批复意见流水号
	,t1.reply_opnn_app_stg                       --批复意见应用阶段
	,t1.reply_opnn_typ                           --批复意见类型
    ,decode(t1.reply_opnn_typ,'01','补充资料','02','下笔退出','03','下笔缩额','04','贷后关注','其他') as 批复意见类型
    ,c1.cd_val_dscr
	,t1.reply_opnn_ctrl_typ                      --批复意见控制类型
	,t1.reply_opnn_dtl                           --批复意见详情
    ,regexp_replace(regexp_replace(t1.reply_opnn_dtl,'\\s',''),',','|') as 批复意见详情
	,t1.reply_opnn_app_obj                       --批复意见应用对象
	,t1.reply_opnn_ltst_impl_dt                  --批复意见最迟落实日期
    ,case when t1.reply_opnn_ltst_impl_dt = '18991231' then null else t1.reply_opnn_ltst_impl_dt end as 批复意见最迟落实日期
	,t1.reply_aprv_hier                          --批复审批层级
	,t1.sys_reg_tm                               --系统登记时间_批复意见签署日期
	,t1.alry_impl_ind                            --已落实标志
	,t1.ahn_ltr_aply_serno                       --授用信申请流水号
	,t1.sys_reg_psn                              --系统登记人
	,t1.sys_reg_org                              --系统登记机构
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
	,t3.ln_mgr_id                                --信贷归属客户经理
	,t3.ln_mgr_nm                                --信贷归属客户经理名称
	,t3.ln_org_id                                --信贷归属机构
	,t3.ln_org_nm                                --信贷归属机构名称
from edw.loan_reply_opnn_inf_rcd            t1 --批复意见信息记录表
left join adm_pub.adm_csm_cbas_mng_inf_dd   t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
left join edw.dwd_code_library_dd c1
on t1.reply_opnn_typ = c1.cd_val
and c1.dt = t1.dt
where t1.dt='20250627'
and t1.del_ind='0'     --未删除
and t1.alry_impl_ind<>'1'  --不为已落实
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025062787_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025062787_CST_02 AS
select cst_id                                 as 客户号
	,cst_nm                                   as 客户名称
	,bsn_serno                                as 业务流水号
	,reply_opnn_serno                         as 批复意见流水号
	,reply_opnn_app_stg                       as 批复意见应用阶段
    ,批复意见类型
	,reply_opnn_ctrl_typ                      as 批复意见控制类型
    ,批复意见详情
	,reply_opnn_app_obj                       as 批复意见应用对象
    ,批复意见最迟落实日期
	,reply_aprv_hier                          as 批复审批层级
	,sys_reg_tm                               as 系统登记时间_批复意见签署日期
	,ln_mgr_id                                as 信贷归属客户经理
	,ln_mgr_nm                                as 信贷归属客户经理名称
	,ln_org_nm                                as 信贷归属机构名称
	,prm_mgr_id                               as 主管护客户经理工号
	,prm_mgr_nm                               as 主管护客户经理姓名
	,prm_org_nm                               as 主管户机构名称
from SJXQ_SJ2025062787_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025062787_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025062787_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025062787_CST_02
***程雯_SJ2025080751_大冶村行流动员工业务盘点.sql
﻿-- 程雯_SJ2025080751_大冶村行流动员工业务盘点
/*
【关于表格&ldquo;近2年入职人员&rdquo;】:
1.统计2023年、2024年、2025年首笔新增全量贷款月日均、有价值贷款客户数以及期间相关指标的交接量，以上数据一并申请对应客户清单，并麻烦附上对应的类型标签；
2.统计对应人员全量(管户口径）新发生风险率、自有业务新发生风险率
【关于表格&ldquo;近2年离职人员&rdquo;】：
1.统计2021年-2025年期间分别的首笔新增全量贷款月日均、有价值贷款客户数以及期间相关指标的交接量，以上数据一并申请对应客户清单，并麻烦附上对应的类型标签；
2.统计对应人员全量(管户口径）新发生风险率、自有业务新发生风险率。
*/
DROP   TABLE IF EXISTS SJXQ_SJ2025080751_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025080751_CST_01
(   mgr_id       string COMMENT ''
    ,mgr_nm      string COMMENT ''
    ,start_dt    string COMMENT ''
    ,mtu_dt      string COMMENT ''
    ,curr_status string COMMENT ''
)
;
insert into SJXQ_SJ2025080751_CST_01
;
--离职前3月日期
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_02 AS
select *
    ,replace(add_months(to_date(mod_mtu_dt,'yyyyMMdd'),-3),'-','') as quit_3m_dt
from(
    select *,case when substr(mtu_dt,7,2)<='15' then to_char(dateadd(to_date(concat(SUBSTR(mtu_dt,1,6),'01'),'yyyyMMdd'),-1,'dd'),'yyyyMMdd')
                else to_char(lastday(to_date(mtu_dt,'yyyyMMdd')),'yyyyMMdd') end as mod_mtu_dt
    from SJXQ_SJ2025080751_CST_01
    where mtu_dt<>''
    union all
    select *,'20251031'
    from SJXQ_SJ2025080751_CST_01
    where mtu_dt=''
)t1 WHERE start_dt<replace(add_months(to_date(mod_mtu_dt,'yyyyMMdd'),-3),'-','')
;
-- 截止离职前3月 村行所有合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_03 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
    ,t1.hpn_typ_cd
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as 发生类型
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as 管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,t1.dt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2  --不需要产品名称字段可删除该表
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
where t1.dt in(
    select distinct quit_3m_dt
    from SJXQ_SJ2025080751_CST_02
) and t1.dt>='20221031'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
and t1.mgr_org_id like '4261%' --大冶村行
;
-- 客户是否发生交接
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_04 AS
select cst_id
from(
    SELECT a.cst_id
        ,a.bfr_hdv_cst_magr_id	--移交前客户经理工号
        ,a.aft_hdv_cst_magr_id	--移交后客户经理工号
        ,substr(REPLACE(a.sys_reg_tm, '-', ''),1,8) as HDV_DT   --交接日期
    FROM    edw.loan_cst_mgr_hdv_rcd AS a  --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
    inner join(
        select distinct cst_id
        from SJXQ_SJ2025080751_CST_03
    )t2 on a.cst_id=t2.cst_id
    WHERE a.dt = '20250731'
    and a.del_ind='0'	--	删除标识
    -- AND REPLACE(a.sys_reg_tm, '-', '') >= '20250101'
    AND REPLACE(a.sys_reg_tm, '-', '') <= '20250731'
    AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
    AND a.hdv_typ = '1'
    and a.bfr_hdv_cst_magr_id<>a.aft_hdv_cst_magr_id
)t1 group by cst_id
;
-- 截止0731村行所有借据
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_05 AS
select t1.cst_id,t1.ctr_serno,t1.hpn_typ_cd
	,t1.ctr_bgn_dt                               --合同起始日期
    ,t1.mgr_id	        --管户人工号
    ,t1.dt
	,t2.mng_empe_id                              --管户人工号
	,t2.dbil_srl_no                              --借据流水号
	,t2.dbil_bal_cny                             --余额
	,t2.grant_amt                                --发放金额
	,t2.grant_date                               --发放日期
	,t2.end_date                                 --到期日期
	,t2.ovd_day                                  --逾期天数
	,t2.prcp_ovd_date                            --本金逾期日期
	,t2.intr_ovd_date                            --利息逾期日期
	,t2.ovd_prcp_bal                             --逾期本金余额
	,t2.is_yr_new_hpn                            --是否年度新发生
	,t2.hpn_rsk_date                             --出险日期
	,t2.is_rsk_loan                              --是否风险贷款
    ,case when t2.prcp_ovd_date<>'18991231' or t2.intr_ovd_date<>'18991231' then 1 else 0 end as is_ovd_loan
    ,case when t3.cst_id is not null then 1 else 0 end as is_yh_cst
    ,case when t4.mgr_id_all regexp t1.mgr_id then 1 else 0 end as is_hdv_cst
    ,t4.mgr_id_all
from SJXQ_SJ2025080751_CST_03               t1
inner join adm_rsk.adm_rsk_apl_inter_all    t2 --风险集市-资产质量监测表
on t1.ctr_serno=t2.ctr_srl_no
and t1.dt=t2.dt
and t2.dt>='20221031'
LEFT JOIN
(
	SELECT  DISTINCT cst_id,dt
	FROM edw.dwd_bus_loan_rsk_hid_dngr_cst_list_dd
	WHERE dt >='20221031'
) t3 ON t1.cst_id = t3.cst_id
and t1.dt=t3.dt
left join SJXQ_SJ2025080751_CST_04 t4
on t1.cst_id=t4.cst_id
;
-- 结果1 近2年入职人员
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_06 AS
SELECT  t1.mgr_id                                                                                                                             AS 工号
       ,t2.mgr_nm                                                                                                                             AS 姓名
       ,t2.start_dt                                                                                                                           AS 入行日期
       ,t2.mtu_dt                                                                                                                             AS 离职日期
       ,t2.quit_3m_dt                                                                                                                         AS 数据日期_离职前3月
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20230101' AND '20231231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2023年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20240101' AND '20241231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2024年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20250101' AND '20251231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2025年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 THEN t1.grant_amt else 0 end)/10000,4)                               AS 全量交接客户借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 0 AND t1.is_ovd_loan = 0 THEN t1.grant_amt else 0 end)/10000,4) AS 正常业务借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 1 THEN t1.grant_amt else 0 end)/10000,4)          AS 隐患业务借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_ovd_loan = 1 THEN t1.grant_amt else 0 end)/10000,4)        AS 逾期业务借据发放金额
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20230101' AND '20231231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2023年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20240101' AND '20241231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2024年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20250101' AND '20251231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2025年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 THEN t1.cst_id end)                                             AS 全量交接客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 0 AND t1.is_ovd_loan = 0 THEN t1.cst_id end) AS 正常业务交接客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 1 THEN t1.cst_id end)                        AS 隐患业务交接客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_ovd_loan = 1 THEN t1.cst_id end)                      AS 逾期业务交接客户数
       ,SUM(case WHEN t1.is_rsk_loan = 'Y' THEN 1 else 0 end)/COUNT(1)                                                                        AS 全量风险借据占比
       ,SUM(case WHEN t1.is_hdv_cst = 0 AND t1.is_rsk_loan = 'Y' THEN 1 else 0 end)/SUM(case WHEN t1.is_hdv_cst = 0 THEN 1 else 0 end)        AS 非交接风险借据占比
FROM SJXQ_SJ2025080751_CST_05         t1
INNER JOIN SJXQ_SJ2025080751_CST_02   t2
ON t1.mgr_id = t2.mgr_id
AND t1.dt = t2.quit_3m_dt
AND t2.curr_status = '入职'
GROUP BY  t1.mgr_id
    ,t2.mgr_nm
    ,t2.start_dt
    ,t2.mtu_dt
    ,t2.quit_3m_dt
;
-- 结果2 近2年离职人员
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_07 AS
SELECT  t1.mgr_id                                                                                                                             AS 工号
       ,t2.mgr_nm                                                                                                                             AS 姓名
       ,t2.start_dt                                                                                                                           AS 入行日期
       ,t2.mtu_dt                                                                                                                             AS 离职日期
       ,t2.quit_3m_dt                                                                                                                         AS 数据日期_离职前3月
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20210101' AND '20211231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2021年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20220101' AND '20221231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2022年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20230101' AND '20231231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2023年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20240101' AND '20241231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2024年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.ctr_bgn_dt BETWEEN '20250101' AND '20251231' AND t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)  AS 2025年首笔合同的借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 THEN t1.grant_amt else 0 end)/10000,4)                               AS 全量交接客户借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 0 AND t1.is_ovd_loan = 0 THEN t1.grant_amt else 0 end)/10000,4) AS 正常业务借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 1 THEN t1.grant_amt else 0 end)/10000,4)          AS 隐患业务借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_ovd_loan = 1 THEN t1.grant_amt else 0 end)/10000,4)        AS 逾期业务借据发放金额
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20210101' AND '20211231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2021年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20220101' AND '20221231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2022年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20230101' AND '20231231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2023年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20240101' AND '20241231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2024年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.ctr_bgn_dt BETWEEN '20250101' AND '20251231' AND t1.hpn_typ_cd = '010' THEN t1.cst_id end)                AS 2025年首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 THEN t1.cst_id end)                                             AS 全量交接客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 0 AND t1.is_ovd_loan = 0 THEN t1.cst_id end) AS 正常业务交接客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_yh_cst = 1 THEN t1.cst_id end)                        AS 隐患业务交接客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 AND t1.is_ovd_loan = 1 THEN t1.cst_id end)                      AS 逾期业务交接客户数
       ,SUM(case WHEN t1.is_rsk_loan = 'Y' THEN 1 else 0 end)/COUNT(1)                                                                        AS 全量风险借据占比
       ,SUM(case WHEN t1.is_hdv_cst = 0 AND t1.is_rsk_loan = 'Y' THEN 1 else 0 end)/SUM(case WHEN t1.is_hdv_cst = 0 THEN 1 else 0 end)        AS 非交接风险借据占比
FROM SJXQ_SJ2025080751_CST_05 t1
INNER JOIN SJXQ_SJ2025080751_CST_02 t2
ON t1.mgr_id = t2.mgr_id
AND t1.dt = t2.quit_3m_dt
AND t2.curr_status = '离职'
GROUP BY  t1.mgr_id
    ,t2.mgr_nm
    ,t2.start_dt
    ,t2.mtu_dt
    ,t2.quit_3m_dt
;
-- 20221231 客户管户及余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_08 AS
select t1.cst_id                                   --客户号
	,sum(t1.ctr_bal) as cst_bal --合同余额
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2  --不需要产品名称字段可删除该表
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
where t1.dt='20221231'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
and t1.mgr_org_id like '4261%' --大冶村行
group bY t1.cst_id
;
-- 结果3 近2年离职人员2
DROP   TABLE IF     EXISTS SJXQ_SJ2025080751_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080751_CST_09 AS
SELECT  t1.mgr_id                                                                                                         AS 工号
       ,t2.mgr_nm                                                                                                         AS 姓名
       ,t2.start_dt                                                                                                       AS 入行日期
       ,t2.mtu_dt                                                                                                         AS 离职日期
       ,t2.quit_3m_dt                                                                                                     AS 数据日期_离职前3月
       ,round(SUM(case WHEN t1.hpn_typ_cd = '010' THEN t1.grant_amt else 0 end)/10000,4)                                  AS 全量首笔合同借据发放金额
       ,round(SUM(case WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 THEN t1.grant_amt else 0 end)/10000,4)           AS 交接合同借据发放金额
       ,round(SUM(case WHEN t3.mgr_id_2022 not regexp t1.mgr_id AND t3.cst_bal = 0 THEN t1.grant_amt else 0 end)/10000,4) AS 流失挽回合同借据发放金额
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd = '010' THEN t1.cst_id end)                                                AS 全量首笔合同客户数
       ,COUNT(distinct CASE WHEN t1.hpn_typ_cd <> '010' AND t1.is_hdv_cst = 1 THEN t1.cst_id end)                         AS 交接合同客户数
       ,COUNT(distinct CASE WHEN t3.mgr_id_2022 not regexp t1.mgr_id AND t3.cst_bal = 0 THEN t1.cst_id end)               AS 流失挽回合同客户数
FROM SJXQ_SJ2025080751_CST_05         t1
INNER JOIN SJXQ_SJ2025080751_CST_02   t2
ON t1.mgr_id = t2.mgr_id
AND t1.dt = t2.quit_3m_dt
AND t2.curr_status = '离职'
left join SJXQ_SJ2025080751_CST_08      t3
on t1.cst_id=t3.cst_id
GROUP BY  t1.mgr_id
    ,t2.mgr_nm
    ,t2.start_dt
    ,t2.mtu_dt
    ,t2.quit_3m_dt
;
SElECT '01' seq, count(1) cnt,count(distinct mgr_id) custs
from SJXQ_SJ2025080751_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct mgr_id) custs
from SJXQ_SJ2025080751_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno,dt) custs
from SJXQ_SJ2025080751_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080751_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct dbil_srl_no,dt) custs
from SJXQ_SJ2025080751_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 工号) custs
from SJXQ_SJ2025080751_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 工号) custs
from SJXQ_SJ2025080751_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080751_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 工号) custs
from SJXQ_SJ2025080751_CST_09
;
/*
01	60	56
02	57	53
-- sheet1/sheet2
数据日期_离职前3月：未离职员工数据截至20250731，离职员工取离职前3月末（四舍五入）
2023年首笔合同的借据发放金额：管户人在2023年办理的首笔合同，在数据日期前的借据发放总金额
2024年首笔合同的借据发放金额：管户人在2024年办理的首笔合同，在数据日期前的借据发放总金额
2025年首笔合同的借据发放金额：管户人在2025年办理的首笔合同，在数据日期前的借据发放总金额
全量交接客户借据发放金额：数据日期前交接给管户人的非首笔合同所有借据，在数据日期前的借据发放总金额
正常业务借据发放金额：数据日期前交接给管户人的非首笔合同且正常借据，在数据日期前的借据发放总金额
隐患业务借据发放金额：数据日期前交接给管户人的非首笔合同且客户为隐患客户，在数据日期前的借据发放总金额
逾期业务借据发放金额：数据日期前交接给管户人的非首笔合同且逾期借据，在数据日期前的借据发放总金额
2023年首笔合同客户数：管户人在2023年办理的首笔合同的客户数
2024年首笔合同客户数：管户人在2024年办理的首笔合同的客户数
2025年首笔合同客户数：管户人在2025年办理的首笔合同的客户数
全量交接客户数：数据日期前交接给管户人非首笔合同的客户数
正常业务交接客户数：数据日期前交接给管户人非首笔合同且非隐患客户非逾期客户的客户数
隐患业务交接客户数：数据日期前交接给管户人非首笔合同且为隐患客户数
逾期业务交接客户数：数据日期前交接给管户人非首笔合同且借据逾期的客户数
全量风险借据占比：数据日期管户人名下所有风险贷款借据比名下所有借据
非交接风险借据占比：数据日期管户人名下所有非交接客户风险贷款借据比名下所有非交接客户借据
-- sheet3
数据日期_离职前3月：离职前3月末（四舍五入），未转正忽略
全量首笔合同借据发放金额：数据日期前客户经理办理首笔合同对应借据发放金额
交接合同借据发放金额：数据日期前交接给该客户经理的合同对应借据发放金额
流失挽回合同借据发放金额：20221231不在该客户经理名下且客户余额为0，数据日期客户经理管户，合同对应借据发放总金额
全量首笔合同客户数：数据日期前客户经理办理首笔合同客户数
交接合同客户数：数据日期前交接给该客户经理的合同客户数
流失挽回合同客户数：20221231不在该客户经理名下且客户余额为0，数据日期为该客户经理管户客户数
*/
SElECT '06' seq, * from SJXQ_SJ2025080751_CST_06;
SElECT '07' seq, * from SJXQ_SJ2025080751_CST_07;
SElECT '09' seq, * from SJXQ_SJ2025080751_CST_09;
***罗寒雪_SJ20250623156_人行检查.sql
﻿-- 罗寒雪_SJ20250623156_人行检查
/*
1、2024年1月1日至2025年6月22日开立账户,现金汇款的交易金额在1万元以上清单全量数据（取300号文中的个人和单位信息表，以及添加一个单位受益所有人信息）
咨询总行反洗钱部，说提取300号文中，大数据部知道是什么，除了300号文在加一条受益所有人信息
----找黄思瑶确认下
1：取数一两个表需关联下面取数7用到的表（300号文现金汇款交易流水表）
--300号文存量个人客户身份信息表
${adm_upss}.AML_T3R_CST_PERS
--300号文存量单位客户身份信息表
${adm_upss}.AML_T3R_CST_UNIT
--300号文现金汇款交易流水表
${adm_upss}.ADM_UPSS_AML_T3R_CASH_REMIT_MID
2、主管户为陕西泾阳村行的客户中，5个以上客户联系地址或电话相同（需剔除销户、管控客户）
字段：客户号、户籍地址、家庭地址、居住地址、电话、客户名称、管户人工号和名称、管户机构
3、主管户为陕西泾阳村行的全量对公客户组织机构类型、注册资本、电子银行限额
字段：客户号、客户名称、管户人工号和名称、管户机构、组织机构类型、注册资本、电子银行限额
4、主管户为陕西泾阳村行的客户，全量未联网核查客户清单+联网核查证件号码不存在客户清单
字段：客户号、客户名称、管户人工号和名称、管户机构、
5、主管户为陕西泾阳村行的个人客户，证件超期6个月仍发生交易，未及时管控清单
字段：客户号、客户名称、管户人工号和名称、管户机构、证件到期日期、超期天数、交易日期、客户账号、账户状态、是否限制非柜面、账户冻结情况
6、主管户为陕西泾阳村行的个人客户，年龄大于70岁，并且70岁以后的交易备注中含有丧葬费客户清单
字段：客户号、客户名称、主管户人工号和名称、主管户机构、年龄
7、300号文中的大额报送清单提取数据，2024年1月1日至今，要求字段为对方账号、名称、机构名称、IP和MAC地址
----找黄思瑶确认下
8、反洗钱系统中较高风险、高风险客户未管控名单（评级意见+核心系统管控措施）
8.1 主管户为陕西泾阳村行的客户，反洗钱系统中较高风险、高风险客户的账户管控情况
字段：客户号、客户名称、管户人工号和名称、管户机构、客户账号、账户状态、是否限制非柜面、账户冻结情况
8.1 客户机构为陕西泾阳村行的客户，反洗钱系统中较高风险、高风险客户的账户管控情况
字段：客户号、客户名称、开户机构、管户人工号和名称、管户机构、客户账号、账户状态、是否限制非柜面、账户冻结情况
9、主管户为陕西泾阳村行的客户，办理5万元以上的现金存取业务，未联网核查清单
字段：客户号、客户名称、管户人工号和名称、管户机构、现金存取日期、金额
10、主管户为陕西泾阳村行的客户，代理存取款5万元以上，代理人名称、证件类型、号码、到期日、联系方式中任意一项为空的清单
字段：代理人名称、证件类型、号码、证件到期日、联系方式
11、主管户为陕西泾阳村行的客户，近5年的转账交易中，对手账号、对手名称、对手机构名称任意要素为空
字段：客户号、客户名称、管户人工号和名称、管户机构、客户账号、交易日期、对手账号、对手名称、对手机构名称
12、主管户为陕西泾阳村行的客户，近5年，交易渠道手机银行、网上银行的借方交易，IP或MAC地址为空
字段：客户号、客户名称、管户人工号和名称、管户机构、客户账号、交易日期、交易渠道
2. 联系地址? 家庭、户籍？ 家庭地址、居住地址，管控客户？
5. 交易日期？最近一次？对
8. 未管控名单（评级意见+核心系统管控措施）？不管未管控
*/
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_01 AS
SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,ACT_STOP_PMT_TYP --止付类型
from(
    SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
        ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
        ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.dt
    left join edw.dwd_code_library_dd   c2
    on t1.frz_cls_cd = c2.cd_val
    and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
    and c2.dt=t1.dt
    WHERE   t1.DT = '20250625'
    AND     t1.FRZ_SRC_CD='2'  --止付
    AND     t1.NFRZ_IND = '0'
)t1 where t1.rn=1
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_02 AS
select cst_act_id,frz_dt,frz_rsn
    ,frz_cls_cd,frz_cls
from(
    SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
        ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
        ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
    FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
    left join edw.dwd_code_library_dd   c1
    on t1.frz_cls_cd = c1.cd_val
    and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    and c1.fld_nm='FRZ_CLS_CD'
    and c1.dt=t1.dt
    WHERE   T1.DT = '20250625'
    AND     T1.FRZ_SRC_CD='1'   --冻结
    AND     T1.NFRZ_IND = '0'   --0:否|1:是
)t1 where t1.rn=1
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_03 AS
select cst_act_id,lmt_eft_dt,close_fg_rsn
from(
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '20250625'
    AND     ACT_THRS_TYP = '2'  --暂停非柜面 2:非柜面限额|0:通用限额|1:二三类限额|3:外汇限额|4:其他
    AND     evt_id = 'DPDRAW'   --关闭非柜面
)t1 where t1.rn=1
;
-- 主管户为陕西泾阳村行
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_04 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.cst_typ_cd                               --客户类型|C1
	,t1.doc_nbr                                  --证件号码|C60
	,t1.doc_typ_cd                               --证件类型代码|C5
	,t1.doc_mtu_dt                               --证件到期日期|C8
	,t1.doc_upd_dt                               --证件更新日期|C8
	,t1.mbl_nbr                                  --手机|C32
	,t1.fml_tel_nbr                              --家庭电话|C32
	,case when length(t1.mbl_nbr)>=7 or length(t1.fml_tel_nbr)<=3 then t1.mbl_nbr
        else t1.fml_tel_nbr end as mbl_nbr_mod   --手机|C32
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t1.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t1.fml_adr                                  --家庭地址|C256
    ,case when t2.id_no is not null then 1 else 0 end as is_lwhc
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,case when t6.cst_id is not null then 1 else 0 end as is_high_rsk_cst
from edw.dws_cst_bas_inf_dd t1                  --客户基础信息汇总表
LEFT JOIN
(
	SELECT  id_no --AS 居民身份证件号码
	       ,MIN(checkdate)                     AS min_checkdate
	FROM adm_upss.AML_T3R_LWHC_LOG
	WHERE dt <= '20250625'  -- min(dt)='20240812'
	-- AND checkdate BETWEEN '20220101' AND '20240831'
    and nvl(id_no,'')<>''
    and result <> '15' --号码不存在
	GROUP BY  id_no
) t2 on t1.doc_nbr = t2.id_no
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '陕西泾阳'
-- 洗钱风险评级等级
left join(
    SELECT  cst_id
    FROM
    (
        SELECT  SUBSTR(party_id,3,10) AS cst_id
            ,levelkey
            ,statistic_dt
            ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY  statistic_dt DESC ) AS rn
        FROM adm_upss.aml_t37_party_result_curr
        WHERE dt = '20250625'
    ) t
    WHERE t.levelkey IN ( '1004' , '1005' )
    AND t.rn = 1
)t6 on t1.cst_id=t6.cst_id
where t1.dt='20250625'
;
-- 账户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_05 AS
select t1.cst_id,t1.doc_nbr
	,t2.cst_act_id                               --客户账号|C32
	,t2.cst_act_typ_cd                           --客户账户类型代码|C1
	,t2.cst_act_nm                               --客户账户名称|C200
	,t2.act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     as 账户状态
	,t2.opn_org_id                               --开户机构编号|C12
	,t2.opn_dt                                   --开户日期|C8
	,t2.act_cls_frz_ind                          --账户封闭冻结标志
	,t2.act_rcv_oly_ind                          --账户只收不付标志
	,t2.act_amt_frz_ind                          --账户金额冻结标志
	,t2.act_pay_oly_ind                          --账户只付不收标志
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
from SJXQ_SJ20250623156_CST_04              t1
inner join edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250625'
left join edw.dwd_code_library_dd       c1
on  T2.act_sts_cd = c1.cd_val
and c1.dt='20250625'
left join SJXQ_SJ20250623156_CST_01 t5 --止付
on t2.cst_act_id=t5.cst_act_id
left join SJXQ_SJ20250623156_CST_02 t6 --冻结
on t2.cst_act_id=t6.cst_act_id
left join SJXQ_SJ20250623156_CST_03 t7 --关闭非柜面
on t2.cst_act_id=t7.cst_act_id
;
--现金汇款交易流水表
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_06 AS
select t1.tx_dt                                    --交易日期
	,t1.dt_time                                  --交易时间
	,t1.self_bank_code                           --交易行代码
	,t1.acc_name                                 --客户姓名
	,t1.id_no                                    --身份证件号码
	,t1.cur                                      --币种
	,t1.org_amt                                  --原币种金额
	,t1.usd_amt                                  --折美元金额
	,t1.rmb_amt                                  --折人民币金额
	,t1.inside_acc_no                            --银行内部账户账号
	,t1.part_bank_code                           --交易对方行代码
	,t1.part_bank_name                           --交易对方行名称
	,t1.part_acc_no                              --交易对方账号
	,t1.part_acc_name                            --交易对方户名
	,t1.ticd                                     --业务流水号
	,t1.counter_no                               --柜员号
	,t1.settle_type                              --业务类型
	,t1.tb_id                                    --提取编号
    ,t2.cst_id
from adm_upss.adm_upss_aml_t3r_cash_remit_mid t1 --现金汇款交易流水表
inner join (
    SELECT DISTINCT cst_id,doc_nbr
    from SJXQ_SJ20250623156_CST_05
    where opn_dt between '20240101' and '20250622' --2024年1月1日至2025年6月22日开立账户
)    t2
on t2.doc_nbr=t1.id_no
where t1.dt between '20240101' and '20250625'
and t1.tx_dt between '20240101' and '20250625'
and t1.rmb_amt > 10000
and t1.self_bank_code like '6163%' --陕西泾阳
;
-- 输出结果1 ：个人客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res1_gr purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res1_gr AS
select t1.head_no                                as 报告机构编码
	,t1.bank_code1                               as 客户号归属机构网点代码 --对应TB_BANK表中的BANK_CODE1
	,t1.cst_no                                   as 客户号
	,t1.open_time                                as 创建日期 --年月日格式YYYYMMDD
	,t1.close_time                               as 结束日期 --年月日格式YYYYMMDD
	,t1.acc_name                                 as 客户名称
	,decode(t1.cst_sex,'11','男','12','女','')   as 性别    --按如下格式：11：男 12：女
	,t1.nation                                   as 国籍    --(地区)按照GB/T 2659-2000世界各国和地区名称代码标准填写，英文缩写，如CHN、HK
    ,t1.id_type as 身份证件种类代码
    ,decode(t1.id_type,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳居民往来内地通行证；台湾居民来往大陆通行证或其他有效旅行证件','14','外国公民护照','19','其他类个人身份有效证件','') as 身份证件种类
	,t1.id_no                                    as 身份证件号码
	,t1.id_deadline                              as 身份证件有效期限 --到期日YYYYMMDD，长期用99991231表示
	,t1.occupation                               as 职业    --填写文字，如采用代码记录的，需转换成文字
	,t1.income                                   as 年收入  --单位为元，保留2位小数
	,t1.contact1                                 as 联系方式
	,t1.contact2                                 as 其他联系方式1
	,t1.contact3                                 as 其他联系方式2              --客户不止1个联系方式时先填CONTACT1，CONTACT2，再填写本字段，即不能出现CONTACT1，CONTACT2为空，只填写CONTACT3的情况，客户不止3个联系方式的，只需导入3中联系方式即可
	,t1.address1                                 as 住所地或工作单位地址        --客户不止1个联系方式时先填CONTACT1，CONTACT2，再填写本字段，即不能出现CONTACT1，CONTACT2为空，只填写CONTACT3的情况，客户不止3个联系方式的，只需导入3中联系方式即可
	,t1.address2                                 as 其他住所地或工作单位地址1   --客户有多个住所或工作单位地址时先填写ADDRESS1，再填写本字段
	,t1.address3                                 as 其他住所地或工作单位地址2   --客户有多个住所或工作单位地址时先填写ADDRESS1、ADDRESS2，再填写本字段
	,t1.company                                  as 工作单位名称
	,t1.sys_name                                 as 系统名称    --如涉及多个系统，逐一全部列出，用;分割
	,t1.occupation1                              as 职业1
	,t1.cst_state                                as 客户号状态
	,t1.cst_state_date                           as 客户号状态认定日期
	,t1.cst_state1                               as 客户状态
	,t1.risk_code                                as 当前风险等级
	,t1.risk_time                                as 当前风险等级划分日期
	,t1.id_type3                                 as 3号令身份证件种类
	,t1.dml_date                                 as 数据维护日期
	,t1.dml_code                                 as 数据维护机构代码
	,t1.cst_yn                                   as 本机构客户标识
	,t1.open_time2                               as 建立业务关系日期
	,t1.close_time2                              as 结束业务关系日期
	,t1.is_tskh                                  as 名下是否只有II类或III类账户
	,t1.is_ybsbkh                                as 名下是否仅为医保或社保账户
	,t1.is_smkh                                  as 名下账户是否均为处于睡眠状态
	,t1.is_wjhke                                 as 名下账户是否均未激活
	,t1.id_start_day                             as 证件起始日期
    ,t2.trx_dtl     as 现金汇款1万以上明细
from adm_upss.aml_t3r_cst_pers t1               --存量个人客户身份信息表
inner join (
    select cst_id
    from SJXQ_SJ20250623156_CST_06
    group by cst_id
)t2 on substr(t1.cst_no,3,10)=t2.cst_id
where t1.dt='20250625'
;
-- 输出结果1 ：单位信息表
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res1_dw purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res1_dw AS
select t1.head_no                                  as 报告机构编码
	,t1.bank_code1                               as 客户号归属机构网点代码 --对应Tb_bank表中的Bank_code1
	,t1.cst_no                                   as 客户号
	,t1.open_time                                as 创建日期    --YYYYMMDD
	,t1.close_time                               as 结束日期    --年月日格式YYYYMMDD
	,t1.acc_name                                 as 客户名称
	,t1.address                                  as 住所地
	,t1.operate                                  as 经营范围
	,t1.set_file                                 as 执照名称_11营业执照
	,t1.license                                  as 执照号码_统一社会信用代码
	,t1.id_deadline                              as 执照有效期限到期日  --YYYYMMDD，长期用99991231表示
	,t1.org_no                                   as 组织机构代码
	,t1.tax_no                                   as 税务登记证号码
	,t1.rep_name                                 as 法定代表人或负责人姓名
	,t1.id_type2                                 as 法定代表人或负责人身份证件类型代码 --按如下填列。11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,decode(t1.id_type2,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳居民往来内地通行证；台湾居民来往大陆通行证或其他有效旅行证件','14','外国公民护照','19','其他类个人身份有效证件','') as 法定代表人或负责人身份证件类型
    ,t1.id_no2                                   as 法定代表人或负责人身份证件号码
	,t1.id_start_day2                            as 法定代表人或负责人身份证起始日期
	,t1.id_deadline2                             as 法定代表人或负责人身份证件有效期限到期日    --YYYYMMDD，长期用99991231表示
	,t1.man_name                                 as 控股股东或者实际控制人姓名
	,t1.id_type3                                 as 控股股东或者实际控制人身份证件类型代码  --按如下填列。11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件；20：单位证件类型填写数字
	,decode(t1.id_type3,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳居民往来内地通行证；台湾居民来往大陆通行证或其他有效旅行证件','14','外国公民护照','19','其他类个人身份有效证件','') as 控股股东或者实际控制人身份证件类型
    ,t1.id_no3                                   as 控股股东或者实际控制人身份证件号码
	,t1.id_start_day3                            as 控股股东或者实际控制人身份证起始日期
	,t1.id_deadline3                             as 控股股东或者实际控制人身份证件有效期限到期日    --YYYYMMDD，长期用99991231表示
	,t1.ope_name                                 as 授权办理业务人员姓名
	,t1.id_type4                                 as 授权办理业务人员身份证件类型代码    --按如下填列。11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,decode(t1.id_type4,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳居民往来内地通行证；台湾居民来往大陆通行证或其他有效旅行证件','14','外国公民护照','19','其他类个人身份有效证件','') as 授权办理业务人员身份证件类型
    ,t1.id_no4                                   as 授权办理业务人员身份证件号码
	,t1.id_start_day4                            as 授权办理业务人员身份证起始日期
	,t1.id_deadline4                             as 授权办理业务人员身份证件有效期限到期日  --YYYYMMDD，长期用99991231表示
	,t1.industry                                 as 行业    --填写文字；如采用代码记录的，需转化为文字
	,t1.reg_amt                                  as 注册资本金  --不带货币符号和+-号，保留2位小数
	,t1.code                                     as 注册资本金币种  --采用国标，如RMB、USD等；下同
	,t1.sys_name                                 as 系统名称    --如涉及多个系统，逐一全部列出，用;分隔
	,t1.cst_state                                as 客户号状态
	,t1.cst_state_date                           as 客户号状态认定日期
	,t1.risk_code                                as 当前风险等级
	,t1.risk_time                                as 当前风险等级划分日期
	,t1.aml3_id_type                             as 3号令身份证件种类
	,t1.dml_date                                 as 数据维护日期
	,t1.dml_code                                 as 数据维护机构代码
	,t1.cst_yn                                   as 本机构客户标识
	,t1.open_time2                               as 建立业务关系日期
	,t1.close_time2                              as 结束业务关系日期
	,t1.is_smkh                                  as 名下账户是否均为处于睡眠状态
	,t1.is_wjhke                                 as 名下账户是否均未激活
	,t1.is_jxkh                                  as 名下账户是否均处于久悬状态
	,t1.contact                                  as 联系方式
	,t1.real_amt                                 as 实缴资本金
	,t1.address2                                 as 实际经营地
    ,t2.trx_dtl     as 现金汇款1万以上明细
    ,t3.受益所有人
from adm_upss.aml_t3r_cst_unit   t1             --存量单位客户身份信息表
inner join (
    select cst_id
    from SJXQ_SJ20250623156_CST_06
    group by cst_id
)t2 on substr(t1.cst_no,3,10)=t2.cst_id
left join(
    -- 受益所有人
    SELECT substr(party_id,3,10) as cst_id
    from adm_upss.adm_upss_aml_t47_beneficiary     --对公客户受益所有人表
    where dt='20250625'
    GROUP BY cst_id
)t3 on substr(t1.cst_no,3,10)=t3.cst_id
where t1.dt='20250625'
;
-- 剔除管控客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_09 AS
select t1.*
from SJXQ_SJ20250623156_CST_04  t1
LEFT JOIN
(
	SELECT  d.cst_id
	       ,'是' AS 不收不付标识
	FROM
	(
		SELECT  c.cst_id
		       ,MAX(c.act_cls_frz_ind) max_ -- 客户层级。若max和min都为1，则所有账户均为不收不付
		       ,MIN(c.act_cls_frz_ind) min_
		FROM
		(
			SELECT  a.cst_id
			       ,b.act_cls_frz_ind -- 封闭冻结（不收不付）
			FROM edw.dim_cst_idv_bas_inf_dd a
			LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
			ON a.cst_id = b.cst_id AND b.dt = '20250625'
			WHERE a.dt = '20250625'
			UNION
			SELECT  a.cst_id
			       ,'1' AS act_cls_frz_ind -- 封闭冻结
			FROM edw.dim_cst_idv_bas_inf_dd a
			INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd b
			ON a.cst_id = b.cst_id AND b.dt = '20250625'
            AND (b.card_sts_cd IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) or b.LATE_CARD_IND <> '1')
            AND b.dt = '20250625'
			WHERE a.dt = '20250625'
		) c
		GROUP BY  c.cst_id
	) d
	WHERE max_ = '1'
	AND min_ = '1' -- 只保留所有账户都不收不付的客户
) t3
ON t1.cst_id = t3.cst_id
left join (
    -- 所有账户均 只收不付
    SELECT cst_id,'是' as 只收不付标志
    from(
        select cst_id
            ,max(t1.act_stop_pmt_ind) max_   --账户只收不付标志 剔除
            ,min(t1.act_stop_pmt_ind) min_
		from edw.dws_bus_dep_act_inf_dd 	t1
        where t1.dt = '20250625'
        GROUP BY cst_id
    )t1 where max_='1' and min_='1'
)t4 on t1.cst_Id=t4.cst_id
left join(
    -- 所有账户均 暂停非柜
    SELECT cst_id,'是' as 暂停非柜面
    from(
        SELECT t1.cst_id
            ,max(case when t2.cst_act_id is not null then 1 else 0 end) as max_
            ,min(case when t2.cst_act_id is not null then 1 else 0 end) as min_
		from edw.dws_bus_dep_act_inf_dd 	t1
        left join (
            SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
                    ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
            FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
            WHERE   DT = '20250625'
            AND     ACT_THRS_TYP = '2' --暂停非柜面
            AND     evt_id = 'DPDRAW'
        )t2 on t1.cst_act_id=t2.cst_act_id
        and t2.rn=1
        where t1.dt='20250625'
        GROUP BY t1.cst_id
    )t1 where max_=1 and min_=1
)t5 on t1.cst_id=t5.cst_id
inner JOIN
(
	SELECT  a.cst_id
	       ,MIN(b.act_dstr_act_dt) act_dstr_act_dt
	       ,CASE WHEN MIN(b.act_dstr_act_dt) = '18991231' THEN '否'
                ELSE '是' END AS 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.act_dstr_act_dt) = 18991231，则该客户存在未销户账户
	FROM edw.dim_cst_idv_bas_inf_dd         a
	LEFT JOIN edw.dws_bus_dep_act_inf_dd 	b
	ON a.cst_id = b.cst_id
    AND b.dt = '20250625'
    LEFT JOIN    (
        SELECT  t1.cst_act_id
                ,T1.lbl_act_id
        FROM    edw.dwd_bus_dep_frz_inf_dd t1
        LEFT JOIN    edw.dwd_code_library_dd t4
        ON      t1.frz_cls_cd = t4.cd_val
        AND     t4.dt = '20250625'
        WHERE   t1.dt = '20250625'
        AND     t1.nfrz_ind = 0
        GROUP BY t1.cst_act_id , T1.lbl_act_id
    ) T8
    ON      b.cst_act_id = t8.cst_act_id
    AND     b.dep_act_id = T8.lbl_act_id
	WHERE a.dt = '20250625'
    and t8.cst_act_id is null   --剔除冻结登记簿账户
	GROUP BY  a.cst_id
) t6 -- t6判断是否全部销户
ON t1.cst_id = t6.cst_id
and t6.是否全部销户='否'
where t3.cst_id is null
and   t4.cst_id is null
and   t5.cst_id is null
;
--结果2：5个以上客户联系地址或电话相同
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res2 AS
select t1.cst_id                                 as 客户号
	,t1.cst_chn_nm                               as 客户姓名
	,t1.cst_typ_cd                               as 客户类型
	,t1.mbl_nbr_mod                              as 手机
	,t1.reg_adr                                  as 户籍地址_注册地址
	,t1.wrk_adr                                  as 工作单位地址_经营所在地地址
	,t1.fml_adr                                  as 家庭地址
	,t1.prm_mgr_id                               as 主管护客户经理工号
	,t1.prm_mgr_nm                               as 主管护客户经理姓名
	,t1.prm_org_id                               as 主管护机构号
	,t1.prm_org_nm                               as 主管户机构名称
    ,'户籍地址_注册地址' as 相同类别
from SJXQ_SJ20250623156_CST_09 t1
inner join(
    select reg_adr
    from SJXQ_SJ20250623156_CST_09
    where nvl(reg_adr,'')<>''
    group by reg_adr having count(distinct cst_id)>5
)t2 on t1.reg_adr=t2.reg_adr
union
select t1.cst_id                                   --客户号
	,t1.cst_chn_nm                               --客户姓名
	,t1.cst_typ_cd                               --客户类型
	,t1.mbl_nbr_mod                              --手机
	,t1.reg_adr                                  --户籍地址_注册地址
	,t1.wrk_adr                                  --工作单位地址_经营所在地地址
	,t1.fml_adr                                  --家庭地址
	,t1.prm_mgr_id                               --主管护客户经理工号
	,t1.prm_mgr_nm                               --主管护客户经理姓名
	,t1.prm_org_id                               --主管护机构号
	,t1.prm_org_nm                               --主管户机构名称
    ,'工作单位地址_经营所在地地址' as 相同类别
from SJXQ_SJ20250623156_CST_09 t1
inner join(
    select wrk_adr
    from SJXQ_SJ20250623156_CST_09
    where nvl(wrk_adr,'')<>''
    group by wrk_adr having count(distinct cst_id)>5
)t2 on t1.wrk_adr=t2.wrk_adr
union
select t1.cst_id                                   --客户号
	,t1.cst_chn_nm                               --客户姓名
	,t1.cst_typ_cd                               --客户类型
	,t1.mbl_nbr_mod                              --手机
	,t1.reg_adr                                  --户籍地址_注册地址
	,t1.wrk_adr                                  --工作单位地址_经营所在地地址
	,t1.fml_adr                                  --家庭地址
	,t1.prm_mgr_id                               --主管护客户经理工号
	,t1.prm_mgr_nm                               --主管护客户经理姓名
	,t1.prm_org_id                               --主管护机构号
	,t1.prm_org_nm                               --主管户机构名称
    ,'家庭地址' as 相同类别
from SJXQ_SJ20250623156_CST_09 t1
inner join(
    select fml_adr
    from SJXQ_SJ20250623156_CST_09
    where nvl(fml_adr,'')<>''
    group by fml_adr having count(distinct cst_id)>5
)t2 on t1.fml_adr=t2.fml_adr
union
select t1.cst_id                                   --客户号
	,t1.cst_chn_nm                               --客户姓名
	,t1.cst_typ_cd                               --客户类型
	,t1.mbl_nbr_mod                              --手机
	,t1.reg_adr                                  --户籍地址_注册地址
	,t1.wrk_adr                                  --工作单位地址_经营所在地地址
	,t1.fml_adr                                  --家庭地址
	,t1.prm_mgr_id                               --主管护客户经理工号
	,t1.prm_mgr_nm                               --主管护客户经理姓名
	,t1.prm_org_id                               --主管护机构号
	,t1.prm_org_nm                               --主管户机构名称
    ,'手机' as 相同类别
from SJXQ_SJ20250623156_CST_09 t1
inner join(
    select mbl_nbr_mod
    from SJXQ_SJ20250623156_CST_09
    where nvl(mbl_nbr_mod,'')<>''
    group by mbl_nbr_mod having count(distinct cst_id)>5
)t2 on t1.mbl_nbr_mod=t2.mbl_nbr_mod
;
-- 结果3：对公客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res3 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res3 AS
SELECT  t1.cst_id                AS 客户号
       ,t2.cst_chn_nm            AS 客户姓名
       ,t2.prm_mgr_id            AS 主管护客户经理工号
       ,t2.prm_mgr_nm            AS 主管护客户经理姓名
       ,t2.prm_org_id            AS 主管护机构号
       ,t2.prm_org_nm            AS 主管户机构名称
       ,t1.org_org_typ_cd        AS 组织机构类型代码
       ,c1.cd_val_dscr           AS 组织机构类型
       ,t1.reg_cpt               AS 注册资本
       ,t3.lgp_id           as 多法人标识位
       ,c2.cd_val_dscr      as 开通渠道
       ,t3.ext_trsf_sng_thrs     AS 对外转帐单笔限额_电子银行限额
       ,t3.ext_trsf_day_acm_thrs AS 对外转帐日累计限额_电子银行限额
from edw.dim_cst_entp_bas_inf_dd  	    t1		--企业客户基本信息
inner join SJXQ_SJ20250623156_CST_04    t2
on t1.cst_id=t2.cst_id
left join edw.dim_bus_chnl_elec_entp_inf_dd t3 --电子银行企业客户渠道信息表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
and t3.chnl_sts = '0'--渠道状态正常
left join edw.dwd_code_library_dd       c1
on  T1.org_org_typ_cd = c1.cd_val
and c1.dt=t1.dt
left join edw.dwd_code_library_dd       c2
on  t3.opn_chnl_cd = c2.cd_val
and c2.dt=t1.dt
where t1.dt='20250625'
;
-- 结果4：未联网核查客户清单+联网核查证件号码不存在客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res4 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res4 AS
SELECT  cst_id                AS 客户号
       ,cst_chn_nm            AS 客户姓名
       ,prm_mgr_id            AS 主管护客户经理工号
       ,prm_mgr_nm            AS 主管护客户经理姓名
       ,prm_org_id            AS 主管护机构号
       ,prm_org_nm            AS 主管户机构名称
from SJXQ_SJ20250623156_CST_04
where is_lwhc=0     --未联网核查
;
-- 结果5：证件超期6个月仍发生交易，未及时管控清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res5 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res5 AS
SELECT  t3.cst_id     AS 客户号
       ,t3.cst_chn_nm AS 客户姓名
       ,t3.prm_mgr_id AS 主管护客户经理工号
       ,t3.prm_mgr_nm AS 主管护客户经理姓名
       ,t3.prm_org_id AS 主管护机构号
       ,t3.prm_org_nm AS 主管户机构名称
       ,t3.doc_mtu_dt AS 证件到期日期
    ,t2.lst_trx_dt as 最近一次交易日期
    ,t1.cst_act_id as 客户账号
    ,t1.账户状态
    ,t1.是否关闭非柜面
    ,t1.是否止付
    ,t1.是否冻结
from SJXQ_SJ20250623156_CST_05  t1
inner join (
    select t1.cst_act_id
        ,max(t2.trx_dt) as lst_trx_dt
    from SJXQ_SJ20250623156_CST_05              t1
    inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细
    on t1.cst_act_id=t2.cst_act_id
    and t2.dt<='20250625'
    and t2.bal_fld_nm = 'DPLDGBAL'
    group by t1.cst_act_id
)t2 on  t1.cst_act_id=t2.cst_act_id
inner join SJXQ_SJ20250623156_CST_04 t3
on t1.cst_id=t3.cst_id
and t3.doc_mtu_dt<>'18991231'
and t3.doc_mtu_dt<='@@{yyyyMMdd-6m}'    --证件超期6个月
where t2.lst_trx_dt > t3.doc_mtu_dt     --超期交易
;
-- 结果6：70岁以后的交易备注中含有丧葬费
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res6 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res6 AS
SELECT  t2.cst_id     AS 客户号
       ,t2.cst_chn_nm AS 客户姓名
       ,t2.prm_mgr_id AS 主管护客户经理工号
       ,t2.prm_mgr_nm AS 主管护客户经理姓名
       ,t2.prm_org_id AS 主管护机构号
       ,t2.prm_org_nm AS 主管户机构名称
       ,t1.age        AS 年龄
       ,t1.bth_dt     AS 出生日期
       ,t1.cmt        AS 交易备注
from(
    select t1.cst_id,t2.age,t2.bth_dt
    from SJXQ_SJ20250623156_CST_04 t1
    inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd t2	--对私客户基础信息
    on t1.cst_id=t2.cst_id
    and t2.dt='20250625'
    and t2.age>70
    inner join edw.dim_bus_dep_act_inf_dd t3 --存款账户信息
    on t1.cst_id=t3.cst_id
    and t3.dt='20250625'
    inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细
    on t3.dep_act_id=t4.dep_act_id
    and t4.dt<='20250625'
    and t4.bal_fld_nm = 'DPLDGBAL'
    and t4.cmt regexp '丧葬'  --交易备注中含有丧葬费
    where t4.trx_dt > to_char(dateadd(to_date(t2.bth_dt, 'yyyyMMdd'),70,'yyyy'),'yyyyMMdd')
    group by t1.cst_id,t2.age,t2.bth_dt
)t1 inner join SJXQ_SJ20250623156_CST_04 t2
on t1.cst_id=t2.cst_id
;
-- 结果7：大额报送清单？？？
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res7 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res7 AS
SELECT  t1.csnm   AS 客户号
       ,t1.ctac   AS 客户账号
       ,t1.crmb   AS 交易金额_折人民币
       ,t1.htdt   AS 大额交易发生日期
       ,t1.tstm   AS 交易时间
       ,t1.org_id AS 机构号
       ,t4.org_nm AS 机构名称
       ,t1.ticd   AS 业务标识号
	,t2.part_acc_no                              as 交易对方账号    --（卡号）当tsf_flag为10，即存取现金时，对方为空值
	,t2.part_acc_name                            as 交易对方户名    --当tsf_flag为10，即存取现金时，对方为空值
	,t2.ip_code                                  as ip地址          --bank_flag=11，客户通过网上银行端发起交易时填写ip地址
	,t2.mac_info                                 as mac或imei地址   --网银交易或手机交易时填写：pc机填写mac，移动终端填写imei，以实际获取为准
from adm_upss.aml_t3r_lar_report        t1 --大额交易报告明细表
inner join adm_upss.aml_t3r_acct_txn    t2 --基于客户账户的交易明细表
on t1.ticd=t2.ticd
and t2.dt between '20240101' and '20250625'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t1.org_id = t4.org_id
and t4.dt = '20250625'
and t4.brc_org_nm regexp '陕西泾阳'
where t1.dt between '20240101' and '20250625'
;
-- 结果8：主管户
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res8_zgh purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res8_zgh AS
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 客户姓名
       ,t1.prm_mgr_id AS 主管护客户经理工号
       ,t1.prm_mgr_nm AS 主管护客户经理姓名
       ,t1.prm_org_id AS 主管护机构号
       ,t1.prm_org_nm AS 主管户机构名称
    ,t2.cst_act_id as 客户账号
    ,t2.账户状态
    ,t2.是否关闭非柜面
    ,t2.是否止付
    ,t2.是否冻结
from SJXQ_SJ20250623156_CST_04      t1
left join SJXQ_SJ20250623156_CST_05 t2
on t1.cst_Id=t2.cst_Id
where t1.is_high_rsk_cst=1
;
-- 结果8：开户机构
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res8_kh purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res8_kh AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_act_nm      AS 客户账户名称
       ,t1.opn_org_id      AS 开户机构编号
       ,t4.org_nm          AS 开户机构
       ,t3.prm_mgr_id      AS 主管护客户经理工号
       ,t3.prm_mgr_nm      AS 主管护客户经理姓名
       ,t3.prm_org_id      AS 主管护机构号
       ,t3.prm_org_nm      AS 主管户机构名称
       ,t1.cst_act_id      AS 客户账号
       ,t1.act_sts_cd      AS 账户状态代码
       ,c1.cd_val_dscr     AS 账户状态
       ,t1.opn_dt          AS 开户日期
       ,t1.opn_tlr_id      AS 开户柜员编号
       ,t1.dstr_act_dt     AS 销户日期
       ,t1.act_cls_frz_ind AS 账户封闭冻结标志
       ,t1.act_rcv_oly_ind AS 账户只收不付标志
       ,t1.act_amt_frz_ind AS 账户金额冻结标志
       ,t1.act_pay_oly_ind AS 账户只付不收标志
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
from edw.dim_bus_dep_cst_act_inf_dd         t1 --客户存款账户信息
inner join(
    SELECT  cst_id
    FROM
    (
        SELECT  SUBSTR(party_id,3,10) AS cst_id
            ,levelkey
            ,statistic_dt
            ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY  statistic_dt DESC ) AS rn
        FROM adm_upss.aml_t37_party_result_curr -- 洗钱风险评级等级
        WHERE dt = '20250625'
    ) t
    WHERE t.levelkey IN ( '1004' , '1005' )     --风险客户
    AND t.rn = 1
)t2 on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd   t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.opn_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '陕西泾阳'
left join SJXQ_SJ20250623156_CST_01 t5 --止付
on t1.cst_act_id=t5.cst_act_id
left join SJXQ_SJ20250623156_CST_02 t6 --冻结
on t1.cst_act_id=t6.cst_act_id
left join SJXQ_SJ20250623156_CST_03 t7 --关闭非柜面
on t1.cst_act_id=t7.cst_act_id
left join edw.dwd_code_library_dd           c1
on  T1.act_sts_cd = c1.cd_val
and c1.dt= t1.dt
where t1.dt='20250625'
;
-- 结果9：办理5万元以上的现金存取业务，未联网核查清单
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res9 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res9 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户姓名
       ,t1.prm_mgr_id      AS 主管护客户经理工号
       ,t1.prm_mgr_nm      AS 主管护客户经理姓名
       ,t1.prm_org_id      AS 主管护机构号
       ,t1.prm_org_nm      AS 主管户机构名称
       ,t2.cst_act_id      AS 客户账号
       ,t2.dep_act_id      AS 存款账号
       ,t3.dtl_seq_nbr as 交易序号
       ,t3.CRD_AND_DBT_IND AS 借贷标志
       ,t3.trx_dt          AS 现金存取日期
        ,t3.trx_tm   as 交易时间
       ,t3.trx_amt         AS 金额
from SJXQ_SJ20250623156_CST_04          t1
inner join edw.dim_bus_dep_act_inf_dd   t2 			--存款账户信息
on t1.cst_Id=t2.cst_Id
and t2.dt='20250625'
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3 --存款账户余额发生明细
on t2.dep_act_id=t3.dep_act_id
and t3.dt<='20250625'
and t3.bal_fld_nm = 'DPLDGBAL'
and t3.CSH_IND='0'  --现金
and t3.trx_amt>=50000
left join(
    select id_no,checkdate
    from adm_upss.AML_T3R_LWHC_LOG
	WHERE dt <= '20250625'
	-- AND checkdate BETWEEN '20220101' AND '20240831'
    and nvl(id_no,'')<>''
    and result <> '15' --号码不存在
    GROUP BY id_no,checkdate
)t4 on t1.doc_nbr = t4.id_no
and t3.trx_dt=t4.checkdate  --当天核查
where t4.id_no is null  --剔除联网核查记录
;
-- 结果10：代理存取款5万元以上
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res10 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户姓名
       ,t1.prm_mgr_id      AS 主管护客户经理工号
       ,t1.prm_mgr_nm      AS 主管护客户经理姓名
       ,t1.prm_org_id      AS 主管护机构号
       ,t1.prm_org_nm      AS 主管户机构名称
	,t2.self_acc_no                              as 账号       --（不能为空）定义与表5一致
	,t2.self_acc_name                            as 账户名称
	,decode(t2.acc_type,'11','个人','12','单位','')  as 公私标识    --11：个人；12：单位
    ,t2.tx_dt                                    as 交易日期    --yyyymmdd，以实际会计日期为准
	,t2.dt_time                                  as 交易时间    --hhmmss以实际会计时间为准
    ,t2.rmb_amt as 折人民币交易金额
	,t2.agent_name                               as 代理人姓名  --agency_flag=11，即发生代理关系时填写
	,t2.agent_tel                                as 代理人联系方式  --agency_flag=11，即发生代理关系时填写
	,t2.agent_type                               as 代理人身份证件种类代码  --agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证;12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件
    ,decode(t2.agent_type,'11','居民身份证或临时身份证','12','军人或武警身份证件','13','港澳居民往来内地通行证；台湾居民来往大陆通行证或其他有效旅行证件','14','外国公民护照','19','其他类个人身份有效证件','') as 代理人身份证件种类
    ,t2.agent_no                                 as 代理人身份证件号码  --agency_flag=11，即发生代理关系时填写
	,t3.doc_mtu_dt                               as 证件到期日期
	,t2.purpose                                  as 摘要说明
from SJXQ_SJ20250623156_CST_04          t1
inner join adm_upss.aml_t3r_acct_txn    t2 --基于客户账户的交易明细表
on t1.cst_id=substr(t2.cst_no,3,10)
and t2.dt<='20250625'
and t2.agency_flag='11' --11：代理；12：本人
and t2.tsf_flag='10'    --现金、转账标识10：现金；11：转账
and t2.rmb_amt>50000
left join edw.dws_cst_bas_inf_dd    t3                  --客户基础信息汇总表
on t2.agent_no=t3.doc_nbr
and t3.dt='20250625'
where nvl(t2.agent_name,'')='' or nvl(t2.agent_tel,'')='' or nvl(t2.agent_type,'')=''
or nvl(t2.agent_no,'')='' or nvl(t3.doc_mtu_dt,'')=''
;
-- 结果11：近5年的转账交易中，对手账号、对手名称、对手机构名称任意要素为空
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res11 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户姓名
       ,t1.prm_mgr_id      AS 主管护客户经理工号
       ,t1.prm_mgr_nm      AS 主管护客户经理姓名
       ,t1.prm_org_id      AS 主管护机构号
       ,t1.prm_org_nm      AS 主管户机构名称
       ,t2.cst_act_id      AS 客户账号
       ,t2.dep_act_id      AS 存款账号
       ,t3.dtl_seq_nbr as 交易序号
       ,t3.CRD_AND_DBT_IND AS 借贷标志
       ,t3.trx_dt          AS 交易日期
       ,t3.trx_amt         AS 金额
	,t3.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t3.cnt_pty_act_nm                           --对方户名|c200
	,t3.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
from SJXQ_SJ20250623156_CST_04          t1
inner join edw.dim_bus_dep_act_inf_dd   t2 			--存款账户信息
on t1.cst_Id=t2.cst_Id
and t2.dt='20250625'
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3 --存款账户余额发生明细
on t2.dep_act_id=t3.dep_act_id
and t3.dt<='20250625'
and t3.dt>='@@{yyyyMMdd-5y}'
and t3.bal_fld_nm = 'DPLDGBAL'
and t3.CSH_IND<>'0'  --0现金
where nvl(t3.cnt_pty_cst_act_id,'')='' or nvl(t3.cnt_pty_act_nm,'')=''
or nvl(t3.cnt_pty_fin_instt_nm,'')=''
;
-- 结果12：交易渠道手机银行、网上银行的借方交易，IP或MAC地址为空
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res12 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户姓名
       ,t1.prm_mgr_id      AS 主管护客户经理工号
       ,t1.prm_mgr_nm      AS 主管护客户经理姓名
       ,t1.prm_org_id      AS 主管护机构号
       ,t1.prm_org_nm      AS 主管户机构名称
	-- ,t2.self_acc_no                              as 账号　
	-- ,t2.self_acc_name                            as 账户名称
	-- ,decode(t2.acc_type,'11','个人','12','单位')  as 公私标识    --11：个人；12：单位
    -- ,t2.tx_dt                                    as 交易日期    --yyyymmdd，以实际会计日期为准
	-- ,t2.dt_time                                  as 交易时间    --hhmmss以实际会计时间为准
	-- ,decode(t2.lend_flag,'10','收','11','付') 　  as 资金收付标识 --10：收；11：付（客户角度）
    -- ,t2.rmb_amt as 折人民币交易金额
	-- ,t2.purpose                                  as 摘要说明
	-- ,decode(t2.bank_flag,'11','网银','12','手机银行') 　as 交易方式标识   --11：网银；12：手机银行；13：柜面；14：atm机具；15：其他
	-- ,t2.ip_code                                  as ip地址　    --bank_flag=11，客户通过网上银行端发起交易时填写ip地址
    -- ,t2.mac_info                                 as mac或imei地址　 --网银交易或手机交易时填写：pc机填写mac，移动终端填写imei，以实际获取为准
from SJXQ_SJ20250623156_CST_04          t1
inner join adm_upss.aml_t3r_acct_txn    t2 --基于客户账户的交易明细表
on t1.cst_id=substr(t2.cst_no,3,10)
and t2.dt<='20250625'
and t2.dt>='@@{yyyyMMdd-5y}'
and t2.lend_flag='11'   --D:借方,C:贷方
where nvl(t2.ip_code,'')='' or nvl(t2.mac_info,'')=''
;
--初评1004' , '1005
DROP   TABLE IF     EXISTS SJXQ_SJ20250623156_CST_res13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250623156_CST_res13 AS
SELECT t.cst_id as 客户号
    ,t.levelkey         as 最终风险等级
    ,t.fristappralevel	as 初评等级
    ,t.ADJUST_REASON    AS 调查结论_编辑岗处理意见
FROM
(
    SELECT  SUBSTR(t1.party_id,3,10) AS cst_id
        ,t1.levelkey
        ,t1.fristappralevel	--	初评等级
        ,t1.statistic_dt
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(t1.party_id,3,10) ORDER BY t1.statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr         t1
    LEFT JOIN    adm_upss.AML_T37_LEVEL_AUDIT_CURR  t2
    ON      t1.RESULEKEY = t2.RSLTKEY
    AND     t1.PARTY_ID = t2.PARTY_ID
    AND     t2.POST_ID = 'P2001' --编辑岗
    and     t1.dt=t2.dt
    WHERE t1.dt = '20250625'
) t
WHERE t.rn = 1
and ((t.fristappralevel='1005' and t.levelkey<>'1005')
or (t.fristappralevel='1004' and t.levelkey<'1004'))
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20250623156_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20250623156_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20250623156_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250623156_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20250623156_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250623156_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res1_gr
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res1_dw
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250623156_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res2
union all
SElECT '11' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res3
union all
SElECT '12' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res4
union all
SElECT '13' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res5
union all
SElECT '14' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res6
union all
SElECT '15' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res7
union all
SElECT '16' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20250623156_CST_res8_zgh
union all
SElECT '17' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20250623156_CST_res8_kh
union all
SElECT '18' seq, count(1) cnt,count(distinct 存款账号,交易序号) custs
from SJXQ_SJ20250623156_CST_res9
union all
SElECT '19' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res10
union all
SElECT '20' seq, count(1) cnt,count(distinct 存款账号,交易序号) custs
from SJXQ_SJ20250623156_CST_res11
union all
SElECT '21' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res12
union all
SElECT '22' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250623156_CST_res13
;
/*
01	2972431	2972431
02	70583	70583
03	4167158	4167158
04	133301	133301
05	48073	48073
06	34	26
07	28	28
08	0	0
09	17018	17018
10	2018	2018
11	13328	12408
12	15401	15401
13	124	122
14	1	1
15	31070	2689
16	213	211
17	213	213
18	692	692
19	41	24
20	1369644	1369644
21	0	0
22	81495	81495
*/
-- 结果表
SElECT '07' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res1_gr;  --需求1-个人
-- SElECT '08' seq, * from SJXQ_SJ20250623156_CST_res1_dw;  --需求1-单位 无数据
SElECT '10' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res2;  --需求2
SElECT '11' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res3;  --需求3
SElECT '12' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res4;  --需求4
SElECT '13' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res5;  --需求5
SElECT '14' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res6;  --需求6
SElECT '15' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res7;  --需求7
SElECT '16' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res8_zgh;  --需求8-主管户
SElECT '17' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res8_kh;  --需求8-开户机构
SElECT '18' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res9;  --需求9
SElECT '19' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res10;  --需求10
SElECT '20' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res11;  --需求11
-- SElECT '21' seq, * from SJXQ_SJ20250623156_CST_res12;  --需求12 无数据
SElECT '22' seq, * from lab_sjxq.SJXQ_SJ20250623156_CST_res13;  --需求13***耿波_SJ20250103161_外审数据.sql
﻿-- 需要我行客户同一风险控制号下授信、用信情况,剔除村行
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250103161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103161_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,t5.cst_typ_cd
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
-- and t4.brc_org_nm not regexp '村镇银行'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='20241231'
where t1.dt='@@{yyyyMMdd}'
and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250103161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103161_CST_02 AS
select cst_id                                   --客户编号
	,cst_chn_nm                               --客户中文名称
	,mng_org_id                               --管户机构编号
	,mng_org_nm                               --管户机构名称
	,cmn_rsk_ctrl_id                          --同一风险控制号
	,cprh_crdt_authr_crdt_amt                 --统一授信授信金额
	,cprh_crdt_exps_amt                       --统一授信敞口金额
	,authr_crdt_amt                           --授信金额 客户级
	,sbmt_authr_crdt_amt                      --报送授信金额
	,authr_crdt_bal                           --授信余额 客户级
	,use_crdt_bal                             --用信余额 客户级
	,crdt_card_exps_amt                       --信用卡敞口金额
	,not_crdt_card_exps_amt                   --不含信用卡敞口金额
	,exps_amt                                 --敞口金额
	,exps_bal                                 --敞口余额
	,cprh_crdt_not_use_authr_crdt_amt         --统一授信未用授信金额
	,cprh_crdt_not_use_exps_amt               --统一授信未用敞口金额
	,rcyc_bsn_not_use_authr_crdt_amt          --循环业务未用授信金额
	,crdt_card_not_use_authr_crdt_amt         --信用卡未用授信金额
	,frm_agr_not_use_authr_crdt_amt           --框架协议未用授信金额
	,avl_authr_crdt_amt                       --尚可使用授信额度
	,mrgn_amt                                 --保证金金额
from adm_rsk.adm_rsk_apl_cst_use_crdt_cst_info_dd --风险集市客户-集团授信用信情况表
where dt='@@{yyyyMMdd}'
and cst_id in (select cst_id from SJXQ_SJ20250103161_CST_01)
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250103161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103161_CST_03 AS
SELECT  t1.cst_id               AS 客户号
        ,t1.cst_typ_cd          AS 客户类型
        ,t1.sam_rsk_ctrl_id     AS 同一风险控制号_客户基本信息
        ,t1.ctr_amt             AS 客户合同金额
        ,t1.ctr_epsr_amt        AS 客户合同敞口金额
        ,t1.ctr_bal             AS 客户合同余额
        ,t2.sam_rsk_custs       AS 同一风险控制号下客户数
        ,t2.ctr_amt             AS 同一风险控制号下合同金额
        ,t2.ctr_epsr_amt        AS 同一风险控制号下合同敞口金额
        ,t2.ctr_bal             AS 同一风险控制号下合同余额
        ,t3.cmn_rsk_ctrl_id     AS 同一风险控制号_风险集市
        ,t3.authr_crdt_amt      AS 授信金额
        ,t3.sbmt_authr_crdt_amt AS 报送授信金额
        ,t3.authr_crdt_bal      AS 授信余额
        ,t3.use_crdt_bal        AS 用信余额
        ,t3.exps_amt            AS 敞口金额
        ,t3.exps_bal            AS 敞口余额
from(
    select cst_id,sam_rsk_ctrl_id,cst_typ_cd
        ,sum(ctr_amt     ) as ctr_amt        --合同金额DECIMAL(21,2)
        ,sum(ctr_epsr_amt) as ctr_epsr_amt	 --合同敞口金额|decimal(21,2)
        ,sum(ctr_bal     ) as ctr_bal        --合同余额
    from SJXQ_SJ20250103161_CST_01
    group by cst_id,sam_rsk_ctrl_id,cst_typ_cd
)t1 left join(
    select sam_rsk_ctrl_id
        ,count(DISTINCT cst_id)     as sam_rsk_custs
        ,sum(ctr_amt     ) as ctr_amt        --合同金额DECIMAL(21,2)
        ,sum(ctr_epsr_amt) as ctr_epsr_amt	 --合同敞口金额|decimal(21,2)
        ,sum(ctr_bal     ) as ctr_bal        --合同余额
    from SJXQ_SJ20250103161_CST_01
    group by sam_rsk_ctrl_id
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
left join SJXQ_SJ20250103161_CST_02 t3
on t1.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250103161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250103161_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250103161_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20250103161_CST_03
;
-- 问题：
-- 1. 未到期未终结
-- 2. 同一风险控制号下***耿波_SJ20250103161_外审数据0107.sql
﻿-- 需要我行客户同一风险控制号下授信、用信情况,剔除村行
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250103161_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103161_CST2_01 AS
SELECT t1.cst_id               --客户编号
    ,t1.cst_chn_nm          --客户中文名称
    ,t1.mng_org_id          --管户机构编号
    ,t1.mng_org_nm          --管户机构名称
    ,t1.cmn_rsk_ctrl_id     --同一风险控制号
    ,t1.authr_crdt_amt      --授信金额
    ,t1.sbmt_authr_crdt_amt --报送授信金额
    ,t1.authr_crdt_bal      --授信余额
    ,t1.use_crdt_bal        --用信余额
    ,t1.exps_amt            --敞口金额
    ,t1.exps_bal            --敞口余额
    ,t2.brc_org_nm
from adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t1 --风险集市客户-单法人授信用信情况表
INNER JOIN(
    SELECT DISTINCT t1.cst_id,t4.brc_org_nm
    from edw.dim_cst_mng_loan_mgr_dd            t1 --信贷客户管户信息
    INNER join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t1.mgr_org_id = t4.org_id
    and t4.dt = '@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    and t4.brc_org_nm not regexp '村镇银行'
)t2 on t1.cst_id=t2.cst_id
where t1.dt='@@{yyyyMMdd}'
and t1.legal_person_org_id='999999998'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250103161_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250103161_CST2_02 AS
SELECT  t1.cst_id               AS 客户号
        ,t1.authr_crdt_amt      AS 授信金额
        ,t1.sbmt_authr_crdt_amt AS 报送授信金额
        ,t1.authr_crdt_bal      AS 授信余额
        ,t1.use_crdt_bal        AS 用信余额
        ,t1.exps_amt            AS 敞口金额
        ,t1.exps_bal            AS 敞口余额
        ,t1.cmn_rsk_ctrl_id     AS 同一风险控制号
        ,t2.sam_rsk_custs       AS 同一风险控制号下客户数
        ,t2.authr_crdt_amt      AS 同一风险控制号下授信金额
        ,t2.sbmt_authr_crdt_amt AS 同一风险控制号下报送授信金额
        ,t2.authr_crdt_bal      AS 同一风险控制号下授信余额
        ,t2.use_crdt_bal        AS 同一风险控制号下用信余额
        ,t2.exps_amt            AS 同一风险控制号下敞口金额
        ,t2.exps_bal            AS 同一风险控制号下敞口余额
from SJXQ_SJ20250103161_CST2_01 t1
left join(
    select cmn_rsk_ctrl_id
        ,count(DISTINCT cst_id) as sam_rsk_custs
        ,sum(nvl(authr_crdt_amt     ,0)) AS authr_crdt_amt      --授信金额
        ,sum(nvl(sbmt_authr_crdt_amt,0)) AS sbmt_authr_crdt_amt --报送授信金额
        ,sum(nvl(authr_crdt_bal     ,0)) AS authr_crdt_bal      --授信余额
        ,sum(nvl(use_crdt_bal       ,0)) AS use_crdt_bal        --用信余额
        ,sum(nvl(exps_amt           ,0)) AS exps_amt            --敞口金额
        ,sum(nvl(exps_bal           ,0)) AS exps_bal            --敞口余额
    from SJXQ_SJ20250103161_CST2_01
    group by cmn_rsk_ctrl_id
)t2 on t1.cmn_rsk_ctrl_id=t2.cmn_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250103161_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250103161_CST2_02
;
SElECT '02' seq, *
from SJXQ_SJ20250103161_CST2_02
;
***耿波_SJ2025030766_押品信息.sql
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.rel_serno	                             --用信申请流水号
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as 发生类型
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20250228'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20250228'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20250228'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20250228'
where t1.dt='20250228'
;
-- 担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_02 AS
select t1.grnt_ctr_no                              --担保合同编号|c32
	,t1.grnt_ctr_typ_cd                          --担保合同类型代码|c3
	,t1.colc_grnt_ind                            --集合型担保标志|c1
	,t1.wrat_cst_id                              --被担保人客户号|c20
	,t1.wrat_nm                                  --被担保人名称|c200
	,t1.grnt_mod_cd                              --担保方式代码|c3
	,t1.ast_pool_ind                             --资产池标志|c1
	,t1.ast_pool_no                              --资产池编号|c32
	,t1.ofln_grnt_ind                            --线下担保标志|c1
	,t1.ccy_cd                                   --币种代码|c3
	,t1.exr                                      --汇率|decimal
	,t1.grnt_ctr_amt                             --担保合同金额|decimal
	,t1.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
	,t1.rvlg_ind                                 --循环标志|c1
	,t1.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
	,t1.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
	,t1.ofln_grnt_rsn                            --线下担保原因|c512
	,t1.sgn_ctr_mod_cd                           --签约方式代码|c1
	,t1.dbl_rcd_ind                              --双录标志|c1
	,t1.dbl_rcd_mod_cd                           --双录模式代码|c1
	,t1.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,t2.cd_val_dscr     as grnt_ctr_sts_nm
	,t1.ctr_crcl_sts_cd                          --合同流转状态代码|c1
	,t1.aprv_sts_cd                              --审批状态代码|c2
	,t1.colc_typ_grnt_ctr_no                     --集合型担保合同编号|c32
	,t1.sys_reg_psn_id                           --系统登记人编号|c20
	,t1.sys_reg_org_id                           --系统登记机构号|c20
	,t1.sys_reg_dt                               --系统登记日期|c8
	,t1.last_upd_dt                              --最后更新日期|c8
	,t1.ctr_sgn_dt                               --合同签收日期|c8
from edw.dim_bus_loan_ctr_grnt_inf_dd   t1      --担保合同信息
LEFT JOIN    edw.dwd_code_library_dd 	t2 --码值表
ON      t1.GRNT_CTR_STS_CD = t2.cd_val
AND     t2.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     t2.fld_nm = 'GRNT_CTR_STS_CD'
AND     t2.DT = t1.dt
where t1.dt='20250228'
;
-- 押品信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_03 AS
select t1.cltr_no                                  --押品编号|c32
	,t1.cltr_typ_cd                              --押品类型代码|c7
	,t1.cltr_nm                                  --押品名称|c200
	,t1.mort_pldg_gds_sts_cd                     --抵质押物状态代码|c2
	,t1.cltr_chk_dt                              --押品核验日期|c8
    ,t1.at_oth_bnk_mort_pldg_ind                 --他行有抵质押标志|c1
	,t1.our_bnk_psit_cd                          --我行顺位代码|c1
	,t1.oth_bnk_mort_pldg_cnt                    --他行抵质押笔数|int10
	,t1.oth_bnk_mort_pldg_amt                    --他行抵质押金额|decimal(21, 2)
	,t1.mort_pldg_gds_situ                       --抵质押物情况|c2
	,t1.sys_reg_tm                               --系统登记时间|c20
    ,t2.wrnt_no         --权证编号
    ,t2.wrnt_typ_cd     --权证类型代码
    ,t2.oois_sts_nm     --出入库状态
    ,t3.val_ases_serno                           --价值评估流水号
    ,t3.ases_bss_dt                              --评估基准日期
    ,t3.ases_avldt_stop_dt                       --评估效力截止日期
    ,t3.ases_mod_cd                              --评估方式代码|c1
    ,t3.cltr_ases_chnl_cd                        --押品评估渠道代码|c2
    ,t3.ccy_cd                                   --币种代码|c3
    ,t3.ases_val                                 --评估价值
    ,t3.afm_val         as new_afm_val           --认定价值
    ,t3.mort_pldg_rat                            --抵质押率
from edw.dim_bus_loan_cltr_bas_inf_dd    t1      --押品基本信息
left join (
    SELECT  t1.cltr_no                --押品编号|C32
    FROM edw.dwd_bus_loan_cltr_wrnt_inf_dd  t1 --押品权证信息
    LEFT JOIN edw.dwd_code_library_dd       c1 -- 码值表
    ON t1.OOIS_STS_CD = c1.cd_val
    AND c1.tbl_nm = 'DWD_BUS_LOAN_CLTR_WRNT_INF_DD'
    AND c1.fld_nm = 'OOIS_STS_CD'
    AND c1.dt = '20250228'
    WHERE t1.dt = '20250228'
    group by t1.cltr_no
)t2 on t1.cltr_no=t2.cltr_no
left join(
    select cltr_no                                --押品编号|c32
        ,val_ases_serno                           --价值评估流水号|c32
        ,ases_bss_dt                              --评估基准日期
        ,ases_avldt_stop_dt                       --评估效力截止日期
        ,ases_mod_cd                              --评估方式代码|c1
        ,cltr_ases_chnl_cd                        --押品评估渠道代码|c2
        ,ccy_cd                                   --币种代码|c3
        ,ases_val                                 --评估价值
        ,afm_val                                  --认定价值
        ,incl_mortd_amt_ind                       --包含已抵金额标志|c1
        ,mort_pldg_rat                            --抵质押率
        ,eff_ind	                              --生效标识
        ,row_number() over(partition by cltr_no order by sys_reg_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd --押品价值评估申请信息表
    where dt='20250228'
)t3 on t1.cltr_no=t3.cltr_no
and t3.rn=1
where t1.dt='20250228'
;
-- 合同流水号担保合同编号担保物编号
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_04 AS
select t1.ctr_serno                              --合同流水号|c32
	,t1.grnt_ctr_no                              --担保合同编号|c32
	,t1.grnt_gds_id                              --担保物编号|c20|包括押品编号和保证人客户号
	,t1.grnt_gds_nm                              --担保物名称|c200
	,t1.grnt_amt                                 --担保金额|decimal(21,2)
	,t1.hgst_can_grnt_amt                        --最高可担保金额|decimal(21,2)
	,t1.grnt_gds_typ_cd                          --担保物类型代码|c1|1 保证人 2 押品
    -- ,decode(t1.grnt_gds_typ_cd,'1','保证人','2','押品') AS grnt_gds_typ_nm --担保物类型
    ,COALESCE(SUBSTR(t2.CLTR_TYP_CD,1,5),'')       AS 押品二级分类代码
    ,COALESCE(c1.CLTR_CTG_NM,'')                   AS 押品二级分类名称
    ,t2.CLTR_TYP_CD                                AS 押品三级分类代码
    ,COALESCE(c2.CLTR_CTG_NM,'')                   AS 押品三级分类名称
    ,t2.afm_val         as grnt_afm_val          --认定价值|decimal
	,t3.cst_id                                   --客户号
	,t3.cst_nm                                   --客户名称
    ,t3.rel_serno	                             --用信申请流水号
    ,t3.发生类型
	,t3.ctr_amt                                  --合同金额
	,t3.ctr_bal                                  --合同余额
	,t3.ctr_bgn_dt                               --合同起始日期
	,t3.ctr_mtu_dt                               --合同到期日期
    ,t3.ctr_sts_cd                               --合同状态代码
    ,t3.mgr_id	        --管户人工号
    ,t3.mgr_nm	        --管户人
    ,t3.mgr_org_id	    --管户机构号
    ,t3.hdl_org_id	    --经办机构编号|c10
    ,t3.hdl_opr_id	    --经办人工号
    ,t3.hdl_opr_nm	    --经办人
    ,t3.brc_org_nm,t3.sbr_org_nm,t3.tem_org_nm
	,t4.grnt_ctr_typ_cd                          --担保合同类型代码|c3
	,t4.colc_grnt_ind                            --集合型担保标志|c1
	,t4.wrat_cst_id                              --被担保人客户号|c20
	,t4.wrat_nm                                  --被担保人名称|c200
	,t4.grnt_mod_cd                              --担保方式代码|c3
	,t4.ast_pool_ind                             --资产池标志|c1
	,t4.ast_pool_no                              --资产池编号|c32
	,t4.ofln_grnt_ind                            --线下担保标志|c1
	,t4.ccy_cd                                   --币种代码|c3
	,t4.exr                                      --汇率|decimal
	,t4.grnt_ctr_amt                             --担保合同金额|decimal
	,t4.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
	,t4.rvlg_ind                                 --循环标志|c1
	,t4.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
	,t4.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
	,t4.ofln_grnt_rsn                            --线下担保原因|c512
	,t4.sgn_ctr_mod_cd                           --签约方式代码|c1
	,t4.dbl_rcd_ind                              --双录标志|c1
	,t4.dbl_rcd_mod_cd                           --双录模式代码|c1
	,t4.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,t4.grnt_ctr_sts_nm
	,t4.ctr_crcl_sts_cd                          --合同流转状态代码|c1
	,t4.aprv_sts_cd                              --审批状态代码|c2
	,t4.colc_typ_grnt_ctr_no                     --集合型担保合同编号|c32
	,t4.sys_reg_psn_id                           --系统登记人编号|c20
	,t4.sys_reg_org_id                           --系统登记机构号|c20
	,t4.sys_reg_dt                               --系统登记日期|c8
	,t4.last_upd_dt                              --最后更新日期|c8
	,t4.ctr_sgn_dt                               --合同签收日期|c8
	,t5.cltr_typ_cd                              --押品类型代码|c7
	,t5.cltr_no
	,t5.cltr_nm                                  --押品名称|c200
	,t5.mort_pldg_gds_sts_cd                     --抵质押物状态代码|c2
	,t5.cltr_chk_dt                              --押品核验日期|c8
    ,t5.at_oth_bnk_mort_pldg_ind                 --他行有抵质押标志|c1
	,t5.our_bnk_psit_cd                          --我行顺位代码|c1
	,t5.oth_bnk_mort_pldg_cnt                    --他行抵质押笔数|int10
	,t5.oth_bnk_mort_pldg_amt                    --他行抵质押金额|decimal(21, 2)
	,t5.mort_pldg_gds_situ                       --抵质押物情况|c2
	,t5.sys_reg_tm                               --系统登记时间|c20
    ,t5.wrnt_no         --权证编号
    ,t5.wrnt_typ_cd     --权证类型代码
    ,t5.oois_sts_nm     --出入库状态
    ,t5.val_ases_serno                           --价值评估流水号
    ,t5.ases_bss_dt                              --评估基准日期
    ,t5.ases_avldt_stop_dt                       --评估效力截止日期
    ,t5.ases_mod_cd                              --评估方式代码|c1
    ,t5.cltr_ases_chnl_cd                        --押品评估渠道代码|c2
    ,t5.ccy_cd     as yp_ccy_cd                  --币种代码|c3
    ,t5.ases_val                                 --评估价值
    ,t5.new_afm_val                              --认定价值
    ,t5.mort_pldg_rat                            --抵质押率
    ,t6.wrnt_no         as g_c_wrnt_no     --权证编号
    ,t6.wrnt_typ_cd     as g_c_wrnt_typ_cd --权证类型代码
    ,t6.oois_sts_nm     as g_c_oois_sts_nm --出入库状态
from edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd      t1 --主合同、担保合同、担保物关系
LEFT JOIN    edw.dim_bus_loan_grnt_ctr_mort_pldg_dd t2 --担保合同抵质押信息
ON  t1.grnt_ctr_no = t2.grnt_ctr_no
and t1.grnt_gds_id=t2.cltr_no
AND t2.dt = t1.dt
LEFT JOIN    edw.DIM_BUS_LOAN_CLTR_CTG_INF_DD c1 --押品分类信息
ON      SUBSTR(t2.CLTR_TYP_CD, 1, 5) = c1.CLTR_CTG_CD
AND     c1.DT = t1.dt
LEFT JOIN    edw.DIM_BUS_LOAN_CLTR_CTG_INF_DD c2 --押品分类信息
ON      t2.CLTR_TYP_CD = c2.CLTR_CTG_CD
AND     c2.DT = t1.dt
inner join SJXQ_SJ2025030766_CST_01 t3 on t1.ctr_serno=t3.ctr_serno
inner join SJXQ_SJ2025030766_CST_02 t4 on t1.grnt_ctr_no=t4.grnt_ctr_no
inner join SJXQ_SJ2025030766_CST_03 t5 on t1.grnt_gds_id=t5.cltr_no
left join (
    SELECT  t1.grnt_ctr_no,t1.cltr_no                --押品编号|C32
    FROM edw.dwd_bus_loan_cltr_wrnt_inf_dd  t1 --押品权证信息
    LEFT JOIN edw.dwd_code_library_dd       c1 -- 码值表
    ON t1.OOIS_STS_CD = c1.cd_val
    AND c1.tbl_nm = 'DWD_BUS_LOAN_CLTR_WRNT_INF_DD'
    AND c1.fld_nm = 'OOIS_STS_CD'
    AND c1.dt = t1.dt
    WHERE t1.dt = '20250228'
    group by t1.grnt_ctr_no,t1.cltr_no
)t6 on t1.grnt_gds_id=t6.cltr_no
and t1.grnt_ctr_no=t6.grnt_ctr_no
where t1.dt='20250228'
and t1.GRNT_GDS_TYP_CD='2' -- 押品
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030766_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030766_CST_05 AS
SELECT  grnt_gds_id  AS 押品编号
       ,grnt_gds_nm  AS 担保物名称
       ,cltr_nm      AS 押品名称
       ,case when nvl(g_c_oois_sts_nm,'')<>'' then g_c_oois_sts_nm else oois_sts_nm end AS 出入库状态
       ,brc_org_nm   AS 管户分行名称
       ,sbr_org_nm   AS 管户支行名称
       ,押品二级分类名称
       ,押品三级分类名称
       ,grnt_afm_val AS 贷前认定价值_担保合同的认定价值
       ,new_afm_val  AS 最新认定价值
       ,grnt_ctr_no  AS 担保合同编号
       ,grnt_amt     AS 担保金额
       ,ctr_serno    AS 合同流水号
       ,ctr_amt   	 AS 合同金额
       ,ctr_bal   	 AS 合同余额
FROM SJXQ_SJ2025030766_CST_04
;
select *
from SJXQ_SJ2025030766_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025030766_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct grnt_ctr_no) custs
from SJXQ_SJ2025030766_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ2025030766_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no,grnt_gds_id) custs
from SJXQ_SJ2025030766_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 押品编号) custs
from SJXQ_SJ2025030766_CST_05
;
/*
01	6585445	6585445
02	4310379	4310379
03	114659	114659
04	494300	494300
05	66930	20511
*/***耿鹏程_SJ20250207186_借据到期业务分析.sql
﻿-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ20250207186_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250207186_CST_01
(
    cst_id      string COMMENT '客户号'
    ,cst_nm     string COMMENT '客户名称'
)
;
insert into SJXQ_SJ20250207186_CST_01
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250207186_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250207186_CST_02 AS
SELECT  *
from(
	select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
		,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	from(
		SELECT  cst_id
			,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
			,cr_sco_val                          AS cst_cr_grd_val
			,'1中征分' sc_src
		FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
		WHERE dt <= '@@{yyyyMMdd}' and cr_sco_val<>0
		UNION
		SELECT  cst_id
			,prd_dt
			,cst_cr_grd_val
			,'1中征分' sc_src
		FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
		WHERE dt <= '@@{yyyyMMdd}' and cst_cr_grd_val<>0
		union
		SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
			,'2指标表' sc_src
		from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
		where dt='@@{yyyyMMdd}' and nvl(idv_crd_sco_val,0)<>0
		and idv_crd_sco_val<>-1
		union
		SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
			,'3集市表' sc_src
		from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
		where dt<='@@{yyyyMMdd}' and nvl(digital_unscr,'')<>''
		and digital_unscr <>'-1'
	)t
)t where rn=1
;
-- 实控人
DROP   TABLE IF     EXISTS SJXQ_SJ20250207186_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250207186_CST_03 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
from(
    SElECT cst_id,rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0109' --实际控制人
)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.cst_typ_cd='1'   --实控人为个人客户
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250207186_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250207186_CST_04 AS
SELECT  t1.cst_id                                     AS 客户号
       ,t1.cst_nm                                     AS 客户名称
       ,t2.slf_ast_lbl_rat                            AS 本人资产负债率
       ,t2.ast_lbl_rat                                AS 资产负债率
       ,t3.rel_cst_id   as 实控人客户号
       ,COALESCE(t4.cst_cr_grd_val,t5.cst_cr_grd_val) AS 征信评分_企业为实控人评分
       ,d.last_180_days_gl_bal_avg                    AS 近180天存款日均_同一风险控制号合计_万
from SJXQ_SJ20250207186_CST_01 t1
left join(
    select cst_id
        ,slf_ast_lbl_rat	--本人资产负债率
        ,ast_lbl_rat	    --资产负债率
        ,row_number() over(partition by cst_id order by rcd_tm desc) rn
    from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
    where dt='@@{yyyyMMdd}'
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ20250207186_CST_03 t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20250207186_CST_02 t4
on t1.cst_id=t4.cst_id
left join SJXQ_SJ20250207186_CST_02 t5
on t3.rel_cst_id=t5.cst_id
left join edw.dws_cst_bas_inf_dd    t6
on t1.cst_id = t6.cst_id
and t6.dt = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  case when nvl(t2.sam_rsk_ctrl_id,'')<>'' then t2.sam_rsk_ctrl_id else t1.cst_id end as cmn_rsk_ctrl_id
	       ,SUM(last_180_days_gl_bal_acml * t3.cny_exr / 180) / 10000 last_180_days_gl_bal_avg
	FROM edw.dws_bus_dep_act_inf_dd t1
	LEFT JOIN edw.dws_cst_bas_inf_dd t2
	ON t1.cst_id = t2.cst_id
    AND t2.dt = t1.dt
	---- 折人民币
	LEFT JOIN edw.dim_bus_com_exr_inf_dd t3
	ON t1.ccy_cd = t3.ccy_cd
    AND t3.dt = t1.dt
	WHERE t1.dt = '@@{yyyyMMdd}'
	GROUP BY  cmn_rsk_ctrl_id
)d ON case when nvl(t6.sam_rsk_ctrl_id,'')<>'' then t6.sam_rsk_ctrl_id else t1.cst_id end = d.cmn_rsk_ctrl_id
;
SElECT '04' seq, *
from SJXQ_SJ20250207186_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250207186_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250207186_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250207186_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250207186_CST_04
;
/*
01	81	72
02	3575766	3575765
03	398842	390217
04	82	72
*/***耿鹏程_SJ2025041561_担保人情况.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_01 AS
SELECT  col_1  --合同登记流水号
       ,col_2  --客户号
       ,col_3  --客户名称
       ,col_4  --产品名称
       ,col_5  --合同起始日期
       ,col_6  --合同到期日期
       ,col_7  --合同金额
       ,col_8  --合同余额
       ,col_9  --执行月利率(&permil;)
       ,col_10 --还本结息方式
       ,col_11 --管户机构名称
       ,col_12 --管户人名称
from lab_bigdata_dev.qbi_file_20250417_15_44_51_0
where pt<>''
;
-- 地址
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_02 AS
SELECT  t1.cst_id
       ,t2.dtl_addr        AS 信贷经营地址
       ,t3.dtl_addr        AS 信贷户籍地址
       ,t4.dtl_addr        AS 信贷居住地址
       ,t5.dtl_addr        AS 信贷办公地址
       ,t6.dtl_addr        AS 信贷注册地址
       ,t7.dtl_addr        AS 信贷主地址
       ,c1.cd_val_dscr     AS 信贷主地址类型
from(
    select distinct cst_id
    from edw.loan_cst_ctc_addr
    where dt = '@@{yyyyMMdd}'
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '@@{yyyyMMdd}' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '@@{yyyyMMdd}' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
LEFT JOIN edw.loan_cst_ctc_addr t4
ON t1.cst_id = t4.cst_id
AND t4.dt = '@@{yyyyMMdd}' and t4.del_ind='0' 	--未删除
AND t4.addr_typ = '050200' --家庭地址
LEFT JOIN edw.loan_cst_ctc_addr t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}' and t5.del_ind='0' 	--未删除
AND t5.addr_typ = '050400' --办公地址
LEFT JOIN edw.loan_cst_ctc_addr t6
ON t1.cst_id = t6.cst_id and t6.del_ind='0' 	--未删除
AND t6.dt = '@@{yyyyMMdd}'
AND t6.addr_typ = '050800' --注册地址
LEFT JOIN edw.loan_cst_ctc_addr t7
ON t1.cst_id = t7.cst_id and t7.del_ind='0' 	--未删除
AND t7.dt = '@@{yyyyMMdd}'
AND t7.main_addr_ind = '1' --主地址
left join EDW.DWD_CODE_LIBRARY_DD           c1
on t7.addr_typ=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
;
--担保合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_03 AS
select t2.ctr_serno
    ,t2.busi_typ_cd     --1贷款业务
    ,t2.grnt_ctr_no
    ,t3.grnt_ctr_sts_cd                          --担保合同状态代码
    ,decode(t3.grnt_ctr_sts_cd,'1','未生效','2','已生效','3','终止','4','冻结','5','作废') as grnt_ctr_sts_nm
from SJXQ_SJ2025041561_CST_01               t1
inner join edw.dwd_bus_loan_ctr_rel_grnt_dd t2       --主合同、担保合同关系
on t1.col_1=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
-- and t2.eff_sts_cd<>'2'   --,'0','待生效','1','已生效','2','已失效'
left join edw.dim_bus_loan_ctr_grnt_inf_dd  t3 --担保合同信息
on t2.grnt_ctr_no=t3.grnt_ctr_no
and t3.dt='@@{yyyyMMdd}'
;
-- 保证人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_04 AS
select t1.ctr_serno,t1.grnt_ctr_no,t1.grnt_ctr_sts_nm
    ,t3.gtor_no                                  --保证人编号|c20
    ,t3.gtor_nm                                  --保证人名称|c200
    ,t3.with_brwr_rel                            --与借款人关系|c3
    ,c1.cd_val_dscr     as with_brwr_rel_nm
    ,t3.eff_sts_cd                               --生效状态代码 0:待生效 1:已生效 2:已失效
    ,decode(t3.eff_sts_cd,'0','待生效','1','已生效','2','已失效') as 生效状态
from SJXQ_SJ2025041561_CST_03       t1
INNER JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd   t3 --担保合同保证人信息
on  t1.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd   c1
ON      t3.WITH_BRWR_REL = c1.cd_val
AND     c1.dt = '@@{yyyyMMdd}'
;
-- 保证人信息2 上表更全
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_05 AS
select t1.ctr_serno,t1.grnt_ctr_no,t1.grnt_ctr_sts_nm
	,t4.wrnt_cst_id                              --保证人客户编号|C20
	,t4.wrnt_cst_nm                              --保证人客户名称|C200
	,t4.grnt_psn_seq_nbr                         --担保人序号|C10
from SJXQ_SJ2025041561_CST_03               t1
inner join edw.dws_bus_grnt_prsn_inf_dd     t4          --担保人汇总信息
on t4.bus_ctr_id=t1.ctr_serno
and t4.grnt_ctr_id=t1.grnt_ctr_no
and t4.dt='@@{yyyyMMdd}'
;
-- --关系
-- DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_06 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_06 AS
-- select t1.cst_id,t1.rel_cst_id
--     ,count(1) rel_cnt
-- from(
--     SElECT cst_id,rel_cst_id,rel_typ
--     from edw.loan_cst_rel         --客户关联关系信息
--     where DT = '@@{yyyyMMdd}'
--     union
--     SElECT rel_cst_id,cst_id,rel_typ
--     from edw.loan_cst_rel         --客户关联关系信息
--     where DT = '@@{yyyyMMdd}'
-- )t1 LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '@@{yyyyMMdd}'
-- group by t1.cst_id,t1.rel_cst_id
-- ;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041561_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041561_CST_07 AS
SELECT  t1.col_1            AS 合同登记流水号
       ,t1.col_2            AS 客户号
       ,t1.col_3            AS 客户名称
       ,t1.col_4            AS 产品名称
       ,t1.col_5            AS 合同起始日期
       ,t1.col_6            AS 合同到期日期
       ,t1.col_7            AS 合同金额
       ,t1.col_8            AS 合同余额
       ,t1.col_9            AS 执行月利率
       ,t1.col_10           AS 还本结息方式
       ,t1.col_11           AS 管户机构名称
       ,t1.col_12           AS 管户人名称
       ,t2.grnt_ctr_no      AS 担保合同号
       ,t2.grnt_ctr_sts_nm  AS 担保合同状态
       ,t2.gtor_no          AS 保证人编号
       ,t2.gtor_nm          AS 保证人名称
       ,t4.grnt_psn_seq_nbr as 担保人序号
       ,t2.with_brwr_rel_nm AS 与借款人关系
    ,t3.信贷经营地址 as 担保人经营地址
    ,t3.信贷居住地址 as 担保人居住地址
    ,t3.信贷户籍地址 as 担保人户籍地址
from SJXQ_SJ2025041561_CST_01       t1
left join SJXQ_SJ2025041561_CST_04  t2
on t1.col_1=t2.ctr_serno
left join SJXQ_SJ2025041561_CST_02  t3
on t2.gtor_no=t3.cst_id
left join SJXQ_SJ2025041561_CST_05  t4
on t2.ctr_serno=t4.ctr_serno
and t2.grnt_ctr_no=t4.grnt_ctr_no
and t2.gtor_no=t4.wrnt_cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025041561_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041561_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ2025041561_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no,gtor_no) custs
from SJXQ_SJ2025041561_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no,wrnt_cst_id) custs
from SJXQ_SJ2025041561_CST_05
-- union all
-- SElECT '06' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
-- from SJXQ_SJ2025041561_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025041561_CST_07
;
/*
01	6086	6086
03	3218	3218
04	4398	4398
05	4294	4294
*/
***耿鹏程_SJ20250616116_调查参与人.sql
-- 耿鹏程_SJ20250616116_调查参与人
DROP   TABLE IF EXISTS SJXQ_SJ20250616116_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250616116_CST_01
(
    cst_id              string COMMENT ''
    ,sam_rsk_ctrl_id    string COMMENT ''
)
;
insert into SJXQ_SJ20250616116_CST_01
;
--
DROP   TABLE IF     EXISTS SJXQ_SJ20250616116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250616116_CST_02 AS
select t1.cst_id,t1.sam_rsk_ctrl_id
    ,CASE WHEN nvl(t2.SAM_RSK_CTRL_ID,'') = '' THEN t2.cst_id  ELSE t2.sam_rsk_ctrl_id END AS sam_rsk_ctrl_id2
from SJXQ_SJ20250616116_CST_01      t1
LEFT JOIN edw.DWS_CST_BAS_INF_DD    t2
ON T1.cst_id = t2.cst_id
AND t2.dt = '20250618'
;
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as svy_mod_nm --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.cst_rol_cd               --客户角色代码|C2
    ,t1.adiv                     --行政区划|C12
    ,t1.svy_addr                 --调查地址
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t1.svy_ctnt_and_rslt        --调查内容及结果|C4000
    ,t1.rmk                      --备注|c4000
    ,t1.lct_nd_mid_grd_audt_ind  --定位需中台审核标志|C1
    ,t1.sys_reg_tm
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
where t1.dt='@@{yyyyMMdd}'
and t1.svy_dt>='20250101'
and t1.svy_mod_cd='01' --01:现场（实地）
***耿鹏程_SJ2025072361_汝南信贷客户数据.sql
﻿-- 耿鹏程_SJ2025072361_汝南信贷客户数据
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_01 AS
SELECT  col_1 --同一风控号
       ,col_2 --客户号
       ,col_3 --客户名称
       ,col_4 --信贷归属客户经理名称
       ,col_5 --信贷归属机构名称
from lab_bigdata_dev.qbi_file_20250724_09_07_14_0
where pt<>''
;
-- 同一风险控制号下
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_02 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.ctr_epsr_bal                             --合同敞口余额
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end cum_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd    t1 --合同基础信息
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='20250630'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--触发精准贷后（处置类）
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_03 AS
SELECT  T1.cst_id       --客户号
        ,T2.tsk_gen_dt  --最近一次触碰精准贷后_处置类时间
        ,ROW_NUMBER() over(PARTITION BY T1.cst_id ORDER BY t2.tsk_gen_dt desc) rn
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
AND     T2.DT = '20250630'
WHERE   T1.DT = '20250630'
;
-- 资产负债概况
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_04 AS
select t1.cst_id,t1.svy_rpt_no,t1.svy_rpt_dt
	,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
    ,t1.ast_amt                                  --资产总额|decimal(21,2)
    ,t1.lbl_tot_amt                              --负债总额|decimal(21,2)
    ,t1.ast_lbl_rat                              --资产负债率|decimal(10,6)
    ,t1.slf_ast_amt                              --本人资产总额|decimal(21,2)
    ,t1.slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
    ,t1.slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,t5.svy_rpt_no                          --调查报告编号|c32
		,case when length(t5.svy_rpt_no)=20 then SUBSTR(t5.svy_rpt_no,5,8)
			else SUBSTR(t5.svy_rpt_no,4,8) end as svy_rpt_dt
	    ,t5.ast_amt                                  --资产总额|decimal(21,2)
	    ,t5.lbl_tot_amt                              --负债总额|decimal(21,2)
	    ,t5.ast_lbl_rat                              --资产负债率|decimal(10,6)
	    ,t5.slf_ast_amt                              --本人资产总额|decimal(21,2)
	    ,t5.slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
	    ,t5.slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
	from(
		select distinct col_2 as cst_id
		from SJXQ_SJ2025072361_CST_01
	)t1 inner join edw.dwd_bus_loan_svy_fnc_stat_cus_ass_lib_ovew_dd 	t5 --资产负债概况
	on t1.cst_id=t5.cst_id
	and t5.dt='20250630' and nvl(t5.svy_rpt_no,'')<>''
)t1
;
--销售额
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_05 AS
select t1.cst_id,t1.sal_amt,t1.svy_rpt_no,t1.svy_rpt_dt
	,t1.sys_reg_tm,t1.cnt,t1.max_sys_dt,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,row_number() over(partition by t1.cst_id order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id
		,t6.svy_rpt_no                          --调查报告编号|c32
		,case when length(t6.svy_rpt_no)=20 then SUBSTR(t6.svy_rpt_no,5,8)
			else SUBSTR(t6.svy_rpt_no,4,8) end as svy_rpt_dt
		,sum(t6.sal_amt)     		as sal_amt
		,count(distinct t6.sys_reg_tm) as cnt
		,max(t6.sys_reg_tm) as max_sys_dt
	from(
		select distinct col_2 as cst_id
		from SJXQ_SJ2025072361_CST_01
	)t1 inner join edw.dwd_bus_loan_svy_cst_opr_sal_amt_and_npft_dd		t6 --调查报告-经营信息销售额及净利润信息
	on t1.cst_id=t6.cst_id
	and t6.dt='20250630' and nvl(t6.svy_rpt_no,'')<>''
	group by t1.cst_id,t6.svy_rpt_no
)t1
;
-- 同一风控号下，他行经营性贷款用信家数
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_06 AS
select t1.*
    ,case when nvl(t2.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end cum_rsk_ctrl_id
from(
    SELECT  t1.cst_id
        ,t1.report_dt                    --报告日期
        ,t1.othr_bnk_mngmt_loan_org_num  --他行经营性贷款授信机构数
        ,t2.他行经营性贷款用信家数
        ,t1.scor_rng
    from edw.dws_cst_ccrc_idv_ind_inf_dd                t1 --个人征信指标信息表
    left join(
        --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
        SELECT  report_id
        ,COUNT(distinct dtrb_org)        AS 他行经营性贷款用信家数
        from   edw.dim_cst_ccrc_idv_loan_inf_dd
        where  dt = '20250630'
        and dtrb_org <> 'ZJTLCB'                --他行
        and pd_cd IN ( '41' ,'42' ,'52' )       --贷款类型 41:个人经营性贷款,42:个人创业担保贷款,52:经营性农户贷款
        and act_typ_cd IN ( 'D1' ,'R1' ,'R4' )  --贷款
        and ctr_bal > 0                         --用信
        group by report_id
    )t2 on t1.report_no=t2.report_id
    where t1.dt='20250630'
    and t1.report_dsc_rn=1	--报告降序排序号
    union all
    select t1.cst_id,t1.report_dt	--报告日期
        ,null
        ,t2.他行经营性贷款用信家数
        ,null
    from edw.dws_cst_ccrc_entp_ind_inf_dd t1 --企业征信指标信息表
    inner join(
        --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
        SELECT  report_id
            ,COUNT(DISTINCT dtrb_org_cd)      as 他行经营性贷款用信家数
        from   edw.dim_cst_ccrc_entp_loan_inf_dd a
        where  a.dt = '20250630'
        and dtrb_org_typ_cd <> '00'            --剔除泰隆银行
        and act_typ IN ( 'D1' ,'R1' ,'R4' )    --贷款
        and loan_bal > 0
        group by report_id
    )t2 on t1.report_no=t2.report_id
    where t1.dt='20250630'
    and t1.report_dsc_rn=1
)t1 left join edw.DWS_CST_BAS_INF_DD        t2
on t1.cst_id=t2.cst_id
and t2.dt='20250630'
;
-- 结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025072361_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072361_CST_07 AS
SELECT  t1.col_1           AS 同一风控号
       ,t1.col_2           AS 客户号
       ,t1.col_3           AS 客户名称
       ,t1.col_4           AS 信贷归属客户经理名称
       ,t1.col_5           AS 信贷归属机构名称
       ,t7.scor_rng        AS 人行征信最新评分
       ,t2.同一风险控制号下合同敞口金额
       ,t2.同一风险控制号下合同余额
       ,t8.量化风险等级
       ,t3.tsk_gen_dt      AS 最近一次触碰精准贷后_处置类时间
       ,t4.ast_amt         AS 家庭资产总额
       ,t4.lbl_tot_amt     AS 家庭负债总额
       ,t4.ast_lbl_rat     AS 家庭资产负债率
       ,t4.slf_ast_amt     AS 本人资产总额
       ,t4.slf_lbl_tot_amt AS 本人负债总额
       ,t4.slf_ast_lbl_rat AS 本人资产负债率
       ,t6.同一风险控制号下他行经营性贷款用信家数
       ,t5.sal_amt         AS 销售额
from SJXQ_SJ2025072361_CST_01       t1
left join (
    select cum_rsk_ctrl_id
        ,sum(ctr_epsr_amt)  as 同一风险控制号下合同敞口金额
        ,sum(ctr_bal)       as 同一风险控制号下合同余额
    from SJXQ_SJ2025072361_CST_02
    group by cum_rsk_ctrl_id
)t2 on t1.col_1=t2.cum_rsk_ctrl_id
left join SJXQ_SJ2025072361_CST_03 t3
on t1.col_2=t3.cst_id
and t3.rn=1
left join SJXQ_SJ2025072361_CST_04 t4
on t1.col_2=t4.cst_id
and t4.rn=1
left join SJXQ_SJ2025072361_CST_05 t5
on t1.col_2=t5.cst_id
and t5.rn=1
left join (
    select cum_rsk_ctrl_id
        ,sum(他行经营性贷款用信家数)  as 同一风险控制号下他行经营性贷款用信家数
    from SJXQ_SJ2025072361_CST_06
    group by cum_rsk_ctrl_id
)t6 on t1.col_1=t6.cum_rsk_ctrl_id
left join SJXQ_SJ2025072361_CST_06 t7
on t1.col_2=t7.cst_id
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250630'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250630'
)t8 on t1.col_2=t8.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2025072361_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025072361_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072361_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072361_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072361_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025072361_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025072361_CST_07
;
/*
01	4328	4328
02	1334347	1334347
03	102888	102888
04	4235	4235
05	1267	1267
06	6065764	6065763
07	4328	4328
*/
SElECT '07' seq, *
from SJXQ_SJ2025072361_CST_07
;
***胡燕玲_SJ20250703136_丽水分行理财余额销售额.sql
-- 胡燕玲_SJ20250703136_丽水分行理财余额销售额
-- 截止2025年二季度，丽水分行各支行层级非保本理财产品余额（其中：对公非保本理财产品余额）、人民币理财产品销售额(自年初累计）。详看附件
-- 非保本理财产品余额
DROP   TABLE IF     EXISTS SJXQ_SJ20250703136_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250703136_CST_01 AS
select t1.cst_id                                   --客户编号
	,t1.nbrk_chm_bal                             --非保本理财余额
    ,t2.cst_typ_cd
    ,T3.BRC_ORG_NM
    ,T3.SBR_ORG_NM
from adm_pub.adm_csm_cbus_chm_inf_dd    t1 --客户集市-业务信息-客户理财业务信息表
inner join edw.dws_cst_bas_inf_dd 	    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join (
    SELECT  t1.cst_id --客户编号
            ,T4.BRC_ORG_NM
            ,T4.SBR_ORG_NM
    FROM    edw.dws_bus_chm_act_mgr_inf_dd          t1 --理财考核汇总信息
    INNER JOIN    edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    ON      t1.acs_org_id = t4.org_id --考核机构
    AND     t4.dt = '20250630'
    AND     t4.BRC_ORG_NM = '丽水分行'
    WHERE   t1.dt = '20250630'
    AND     t1.mng_typ_cd = '1'--管户类型：1考核 2销售
)t3 on t1.cst_id=t3.cst_id
where t1.dt='20250630'
;
-- 人民币理财产品销售额(自年初累计）
DROP   TABLE IF     EXISTS SJXQ_SJ20250703136_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250703136_CST_02 AS
SELECT  T4.BRC_ORG_NM
        ,T4.SBR_ORG_NM
        ,sum(t1.trx_amt) trx_amt
        ,sum(t1.cfm_amt) cfm_amt
FROM    EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI t1 --理财交易确认流水明细
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
ON      t1.trx_afl_org_id = t4.org_id --交易所属机构编号
AND     t4.dt = '20250630'
AND     t4.BRC_ORG_NM = '丽水分行'
WHERE   t1.dt <= '20250630' --确认日期
AND     t1.trx_dt >= '20250101'
AND     t1.trx_dt <= '20250630'
AND     t1.trx_sts_cd = '8' --确认成功
AND     t1.bus_cd IN ( '122' , '130' ) --申购、认购 120:认购
AND     T1.TRX_AMT <> 0 --交易金额
AND     t1.stl_ccy_cd = '156' --人民币
GROUP BY T4.BRC_ORG_NM , T4.SBR_ORG_NM
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250703136_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250703136_CST_03 AS
select t1.brc_org_nm as 主管户分行
    ,t1.sbr_org_nm as 主管户支行
    ,t1.非保本理财产品余额
    ,t1.对公非保本理财产品余额
    ,t2.cfm_amt as 人民币理财产品销售额_自年初累计
from(
    select brc_org_nm,sbr_org_nm
        ,sum(nbrk_chm_bal) as 非保本理财产品余额
        ,sum(case when cst_typ_cd='2' then nbrk_chm_bal else 0 end) as 对公非保本理财产品余额
    from SJXQ_SJ20250703136_CST_01
    group by brc_org_nm,sbr_org_nm
)t1 left join SJXQ_SJ20250703136_CST_02 t2
on t1.sbr_org_nm=t2.sbr_org_nm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250703136_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct SBR_ORG_NM) custs
from SJXQ_SJ20250703136_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 主管户支行) custs
from SJXQ_SJ20250703136_CST_03
***范倩倩_SJ2025052011_庆元村行合同信息.sql
/*
截至2025年05月19日，庆元村行数据
数据需求字段
客户号、客户名称、合同号、合同金额、贷款余额
*/
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025052011_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052011_CST_01 AS
SELECT  col_1  --身份证号
from lab_bigdata_dev.qbi_file_20250521_10_38_09_0
where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025052011_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052011_CST_02 AS
SELECT  t1.col_1      AS 身份证号
       ,t2.cst_id     AS 客户号
       ,t2.cst_chn_nm AS 客户名称
       ,t3.ctr_serno  AS 合同号
       ,t3.ctr_amt    AS 合同金额
       ,t3.ctr_bal    AS 贷款余额
from SJXQ_SJ2025052011_CST_01       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.col_1=t2.doc_nbr
and t2.dt='20250519'
left join edw.dim_bus_loan_ctr_bse_inf_dd t3 --合同基础信息
on t2.cst_id=t3.cst_id
and t3.dt='20250519'
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025052011_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025052011_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025052011_CST_02
;
***范春燕_SJ20250418126_商户法人年龄.sql
﻿-- 范春燕003380-泰惠收商户法定代表人的年龄
-- SJ20250418126
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250418126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250418126_CST_01 AS
SELECT  col_1  --商户号
from lab_bigdata_dev.qbi_file_20250422_08_57_07_0
where pt<>''
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250418126_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250418126_CST_02 AS
SELECT  t1.col_1 as 商户号
      --  ,t2.mch_id
       ,t2.entp_lgp_cst_id as 企业法人客户号
      --  ,t2.entp_cst_id     --企业客户号
      --  ,t3.lgp_cst_id      --法人客户号 比 t2.entp_cst_id t3.entp_cst_id 更全
      --  ,t3.entp_lgp_cst_id as entp_lgp_cst_id2  --企业法人客户号 = t2.entp_lgp_cst_id
      --  ,t3.entp_cst_id     as entp_cst_id2      --企业客户号|c20
       ,t4.age as 企业法人年龄
from SJXQ_SJ20250418126_CST_01 t1
left join edw.dim_bus_chnl_ths_mch_inf_dd	t2 --泰惠收商户基本信息
on t1.col_1=t2.mch_id
and t2.dt='@@{yyyyMMdd}'
-- left join edw.dws_bus_chnl_ths_mch_inf_dd	t3 --泰惠收商户汇总信息
-- on t1.col_1=t3.mch_id
-- and t3.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t4 --对私客户基础信息
on t2.entp_lgp_cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
;
SElECT *
from lab_sjxq.SJXQ_SJ20250418126_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ20250418126_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 商户号) custs
from SJXQ_SJ20250418126_CST_02
;
/*
01	4875	4875
02	4875	4875
*/***董怡静_SJ2025051536_小微租赁市场分析-合同无法关联综合评价.sql
﻿/*
清单1：20220101&mdash;&mdash;20250430期间发放的经营性一般贷款中，信贷调查报告综合评价中包含关键词&ldquo;融资租赁&rdquo;、&quot;金融租赁&quot;、&ldquo;设备分期&rdquo;、&ldquo;购买%设备&rdquo;、&ldquo;以租代购&rdquo;、&ldquo;直租&rdquo;、&ldquo;售后回租&rdquo;的合同。其中&ldquo;购买%设备&rdquo;支持模糊搜索。
数据日期=2025年4月30日。
清单2：20220101&mdash;&mdash;20250430期间发放的经营性一般贷款中，最近一笔征信记录中，他行融资机构中存在&quot;22-融资租赁公司&quot;合同。
数据需求字段
清单1：客户号、客户姓名、合同编号、经办人、经办机构、管户人、管户机构、合同起始日期、合同到期日期、合同终结时间、合同状态、合同金额、合同余额、逾期金额、执行利率、还本结息方式、担保方式、产品名称、命中关键词、资金用途备注、征信中（查最近一笔征信记录，剔除我行数据）他行未结清家数、他行未结清余额、他行融资家数、他行授信金额、机构类型为&quot;22-融资租赁公司&quot;的融资家数、机构类型为&quot;22-融资租赁公司&quot;的授信、征信报告日期。
清单2：客户号、客户姓名、合同编号、经办人、经办机构、管户人、管户机构、合同起始日期、合同到期日期、合同终结时间、合同状态、合同金额、合同余额、逾期金额、执行利率、还本结息方式、担保方式、产品名称、命中关键词（参照清单1的关键词，如未命中则输出&ldquo;无&rdquo;）、资金用途备注、征信中（查最近一笔征信记录，剔除我行数据）他行未结清家数、他行未结清余额、他行融资家数、他行授信金额、机构类型为&quot;22-融资租赁公司&quot;的融资家数、机构类型为&quot;22-融资租赁公司&quot;的授信、征信报告日期。
*/
--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_01 AS
SELECT  a.grnt_mod_colc
FROM
(
	SELECT  distinct grnt_mod_colc
	       ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE dt = '@@{yyyyMMdd}'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.grnt_mod_colc
;
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_02 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,C5.cd_val_dscr     AS 合同状态
    ,t1.exec_intr_rat	                        --执行利率
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,c7.grnt_mod_nm     as 担保方式集合
    ,t1.cpt_usg_rmk	        --资金用途备注|c4000
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,T1.rpay_prcp_setl_intr_mod_cd               --还本结息方式代码
    ,C6.cd_val_dscr     AS 还本结息方式
    ,t2.PD_NM
    ,t1.mgr_id	                                 --管户人工号
    ,c1.empe_nm	                                 as 管户人
    ,t1.mgr_org_id	                             --管户机构号
    ,c2.org_nm          as 管户机构
    ,t1.hdl_opr_id	    --经办人工号
    ,c3.empe_nm         as 经办人
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,c4.org_nm          as 经办机构
    ,t4.lve_act_bgn_dt  as 首次贷款发放日期
    ,t5.AHN_LTR_APLY_SERNO
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t1.mgr_id=c1.empe_id
and c1.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    c2 --考核机构树
on  t1.mgr_org_id = c2.org_id
and c2.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            c3 --员工信息汇总
on  t1.hdl_opr_id=c3.empe_id
and c3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    c4 --考核机构树
on  t1.hdl_org_id = c4.org_id
and c4.dt = t1.dt
left join edw.dim_bus_loan_ctr_oth_dtl_inf_dd	t3 --合同其它明细信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join(
    SELECT  t1.ctr_serno 							    --合同流水号|c32
        ,MIN(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt    --出账起始日期|c8
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='@@{yyyyMMdd}'
    and t1.lve_act_bgn_dt between '20220101' and '20250430'
    GROUP BY t1.ctr_serno
)t4 on t1.ctr_serno=t4.ctr_serno
left join edw.dwd_code_library_dd c5
on T1.ctr_sts_cd = c5.cd_val
and c5.dt = t1.dt
left join edw.dwd_code_library_dd c6
on T1.rpay_prcp_setl_intr_mod_cd = c6.cd_val
and c6.dt = t1.dt
left join SJXQ_SJ2025051536_CST_01  c7
on t1.grnt_mod_colc=c7.grnt_mod_colc
left JOIN edw.dwd_bus_loan_lmt_aply_biz_dd      t5 --用信方案
ON t1.REL_SERNO = t5.USC_APLY_SERNO
and  t5.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
-- 经营性一般贷款的口径
AND     T1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( T3.APLY_CHNL_cd <> 'L08'
    OR T1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     T1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     T1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( T1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(T1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
AND     SUBSTR(T1.PRD_NO, 1, 1) NOT IN ( '3' ) --剔除授信额度、非金融机构授信、同业
AND     substr(T1.PRD_NO, 1, 6) NOT IN ( '100103' , '100104' , '100106' , '200103' , '200104' , '200105' )
--剔除代理贷款、对公合作贷款、对公委托贷款、个人代理贷款、个人合作贷款、个人委托贷款
AND     T1.PRD_NO <> '201040801010101' --锦鲤资产池单独逻辑剔除
AND     substr(T1.PRD_NO, 1, 4) NOT IN ( '1002' , '1004' , '1005' , '1006' , '1007' , '2003' )
--剔除票据（承兑+贴现）业务、保理业务、保函、资金类、债券推荐业务、资金类-对私
AND     substr(T1.PRD_NO, 1, 8) NOT IN ( '10030202' , '10030109' , '10030301' , '10030303' , '10030304' )
--贸易融资里剔除开立进口信用证、出口易贷、开立国内信用证、国内信用证买方融资、国内信用证议付
AND     substr(T1.PRD_NO, 1, 13) NOT IN ( '1003000000001' ) --贸易融资里剔除出口融资、应付账款融资，新信贷逻辑为剔除贸e贷
AND     substr(T1.PRD_NO, 1, 13) <> '1003010801001' --贸易融资里剔除跨境电商贷额度-对公
AND     nvl(T1.PRD_NO, '') <> ''
AND     T1.PRD_NO NOT LIKE '2002%'  --剔除信用卡
;
--调查报告-客户综合评价 合同对应的综合评价
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_03 AS
SELECT t2.AHN_LTR_APLY_SERNO
    ,t3.SVY_RPT_NO  --调查报告编号
    ,decode(t3.svy_rpt_job_mod_cd,'01','单笔用信模式','02','授用信模式','')	as 调查报告作业模式
    ,t3.sys_reg_psn_id	--系统登记人编号
    ,t3.eff_ind
    ,t3.rpt_typ_cd	--报告类型代码
from(
    SELECT DISTINCT AHN_LTR_APLY_SERNO
    from SJXQ_SJ2025051536_CST_02
    where nvl(AHN_LTR_APLY_SERNO,'')<>''
)t2 left join edw.dwd_bus_loan_svy_rpt_inf_dd	    t3 --调查报告信息
ON t3.REL_SERNO = t2.AHN_LTR_APLY_SERNO
and t3.dt='@@{yyyyMMdd}'
;
/* 参考代码
SELECT  sri.SVY_RPT_NO
FROM ctr_bse_inf cbi
JOIN lmt_aply_biz lab
ON cbi.REL_SERNO = lab.USC_APLY_SERNO
JOIN svy_rpt_inf sri
ON sri.REL_SERNO = lab.AHN_LTR_APLY_SERNO
WHERE cbi.CTR_SERNO = '合同流水号'
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_04 AS
SELECT  t1.AHN_LTR_APLY_SERNO
       ,t1.SVY_RPT_NO
       ,t1.rpt_typ_cd        --报告类型代码
       ,t4.cst_id AS cst_id2 --客户号
       ,t4.anls_dt           --分析日期
       ,t4.cprsv_evl         --综合评价
       ,t4.rmk               --备注
       ,t4.sys_reg_tm        --系统登记时间
    ,case when t4.cprsv_evl regexp '融资租赁'  then '融资租赁'
        when t4.cprsv_evl regexp '金融租赁'  then '金融租赁'
        when t4.cprsv_evl regexp '设备分期'  then '设备分期'
        when t4.cprsv_evl regexp '以租代购'  then '以租代购'
        when t4.cprsv_evl regexp '直租'  then '直租'
        when t4.cprsv_evl regexp '售后回租'  then '售后回租'
        when t4.cprsv_evl like '%购买%设备%' then '购买%设备'
        else '' end as keyword
FROM SJXQ_SJ2025051536_CST_03                   t1
left JOIN(
    SELECT  SVY_RPT_NO      --调查报告编号
        ,cst_id             --客户号
        ,anls_dt            --分析日期
        ,cprsv_evl          --综合评价
        ,rmk                --备注
        ,sys_reg_tm         --系统登记时间
    from edw.dwd_bus_loan_svy_cst_cprh_evl_dd --调查报告-客户综合评价
    where dt='@@{yyyyMMdd}'
    -- union all
    -- SELECT  cprsv_evl_serno --综合评价流水号 非调查报告编号
    --     ,cst_id             --客户号
    --     ,anls_dt            --分析日期
    --     ,cprsv_evl          --综合评价
    --     ,rmk                --备注
    --     ,sys_reg_tm         --系统登记时间
    -- from edw.dwd_bus_loan_cst_cprh_evl_dd     --客户综合评价
    -- where dt='@@{yyyyMMdd}'
) t4
ON T1.SVY_RPT_NO=T4.SVY_RPT_NO
where nvl(T1.SVY_RPT_NO,'')<>''
;
--最近一笔征信记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_05 AS
select T1.cst_id
    ,T2.report_no                           --报告编号
    ,T2.report_dt                             --报告日期
    ,T2.他行融资家数 as 他行融资家数_指标
    ,t3.他行未结清家数
    ,t3.他行未结清余额
    ,t3.他行融资家数
    ,t3.他行授信金额
    ,t3.融资租赁公司融资家数
    ,t3.融资租赁公司授信金额
from(
    SELECT distinct cst_id
    FROM SJXQ_SJ2025051536_CST_02
)T1
inner join(
    select report_no                           --报告编号
        ,cst_id                                --客户号
	    ,report_dt                             --报告日期
        ,oth_bank_loan_org_num AS 他行融资家数  --他行贷款授信机构数
    from edw.dws_cst_ccrc_idv_ind_inf_dd       --个人征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1     --最新报告
    union
    select report_no                          --报告编号
        ,cst_id                               --客户号
	    ,report_dt                            --报告日期
        ,oth_bank_busi_org_num as 他行融资家数 --他行授信机构数
    from edw.dws_cst_ccrc_entp_ind_inf_dd     --企业征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1     --最新报告
)t2 ON T1.cst_id=T2.cst_id
left JOIN
(
    select cst_id
        ,report_id
        ,count(distinct case when ctr_bal > 0 OR rmn_rpay_trm > 0 then dtrb_org_typ_cd end)   as 他行未结清家数
        ,sum(case when ctr_bal > 0 OR rmn_rpay_trm > 0 then ctr_bal else 0 end)          as 他行未结清余额
        ,count(distinct dtrb_org_typ_cd)    as 他行融资家数
        ,sum(ctr_amt)                  as 他行授信金额
        ,count(distinct case when dtrb_org_typ_cd ='22' then dtrb_org end)  as 融资租赁公司融资家数
        ,sum(case when dtrb_org_typ_cd ='22' then ctr_amt else 0 end)       as 融资租赁公司授信金额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd
    where dt = '@@{yyyyMMdd}'
    and   dtrb_org <> 'ZJTLCB'    --他行
    -- and   act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) --贷款 C1:催收账户,D1:非循环贷账户,R1:循环贷账户,R2:贷记卡账户,R3:准贷记卡账户,R4:循环额度下分账户
    -- and   dtrb_org_typ_cd ='22'   -- 21:信托公司 22-融资租赁公司  24:消费金融公司  51:小额贷款公司
      group by cst_id ,report_id
      union all
      select cst_id
            ,report_id
            ,count(distinct case when ACT_ACTV_STS = '1' then dtrb_org_cd end)   as 他行未结清家数
            ,sum(case when ACT_ACTV_STS = '1' then loan_bal else 0 end)          as 他行未结清余额
            ,count(distinct dtrb_org_cd)    as 他行融资家数
            ,sum(case when crd_lmt>0 then crd_lmt else loan_amt end)                  as 他行授信金额 --信用额度 贷款金额
            ,count(distinct case when dtrb_org_typ_cd ='22' then dtrb_org_cd end)  as 融资租赁公司融资家数
            ,sum(case when dtrb_org_typ_cd ='22' then case when crd_lmt>0 then crd_lmt else loan_amt end else 0 end)    as 融资租赁公司授信金额
      from   edw.dim_cst_ccrc_entp_loan_inf_dd
      where  dt = '@@{yyyyMMdd}'
      and   length(DTRB_ORG_CD)='4' --他行
    --   and    act_typ IN ( 'D1' , 'R1' , 'R4' ) --贷款
-- and dtrb_org_typ_cd ='22'   -- 21:信托公司 22-融资租赁公司  24:消费金融公司  51:小额贷款公司
      group by cst_id ,report_id
)t3 on t2.cst_id = t3.cst_id
and t2.report_no = t3.report_id
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_06 AS
SELECT  t2.cst_id        AS 客户号
       ,t2.cst_nm        AS 客户名称
       ,t2.ctr_serno     AS 合同流水号
       ,t2.经办人
       ,t2.经办机构
       ,t2.管户人
       ,t2.管户机构
       ,t2.ctr_bgn_dt    AS 合同起始日期
       ,t2.ctr_mtu_dt    AS 合同到期日期
       ,t2.TMT_DT        AS 终结日期
       ,t2.合同状态
       ,t2.ctr_amt       AS 合同金额
       ,t2.ctr_bal       AS 合同余额
       ,t2.ovd_amt       AS 逾期金额
       ,t2.exec_intr_rat AS 执行利率
       ,t2.还本结息方式
       ,t2.担保方式集合
       ,t2.PD_NM         AS 产品名称
       ,t1.keyword       AS 命中关键词
       ,t1.cprsv_evl     AS 综合评价
       ,t2.cpt_usg_rmk   AS 资金用途备注
       ,t2.首次贷款发放日期
       ,t3.他行未结清家数
       ,t3.他行未结清余额
       ,t3.他行融资家数
       ,t3.他行授信金额
       ,t3.融资租赁公司融资家数
       ,t3.融资租赁公司授信金额
       ,T3.report_dt     AS 征信报告日期
from (
    SELECT AHN_LTR_APLY_SERNO
    from SJXQ_SJ2025051536_CST_04
    where keyword<>''
    GROUP BY AHN_LTR_APLY_SERNO
)t1
left join SJXQ_SJ2025051536_CST_02  t2
on t1.AHN_LTR_APLY_SERNO=t2.AHN_LTR_APLY_SERNO
left join SJXQ_SJ2025051536_CST_05  t3
on t2.cst_id=t3.cst_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_07 AS
SELECT  t2.cst_id        AS 客户号
       ,t2.cst_nm        AS 客户名称
       ,t2.ctr_serno     AS 合同流水号
       ,t2.经办人
       ,t2.经办机构
       ,t2.管户人
       ,t2.管户机构
       ,t2.ctr_bgn_dt    AS 合同起始日期
       ,t2.ctr_mtu_dt    AS 合同到期日期
       ,t2.TMT_DT        AS 终结日期
       ,t2.合同状态
       ,t2.ctr_amt       AS 合同金额
       ,t2.ctr_bal       AS 合同余额
       ,t2.ovd_amt       AS 逾期金额
       ,t2.exec_intr_rat AS 执行利率
       ,t2.还本结息方式
       ,t2.担保方式集合
       ,t2.PD_NM         AS 产品名称
       ,t1.keyword       AS 命中关键词
       ,t1.cprsv_evl     AS 综合评价
       ,t2.cpt_usg_rmk   AS 资金用途备注
       ,t2.首次贷款发放日期
       ,t3.他行未结清家数
       ,t3.他行未结清余额
       ,t3.他行融资家数
       ,t3.他行授信金额
       ,t3.融资租赁公司融资家数
       ,t3.融资租赁公司授信金额
       ,T3.report_dt     AS 征信报告日期
from SJXQ_SJ2025051536_CST_02       t2
inner join SJXQ_SJ2025051536_CST_05 t3
on t2.cst_id=t3.cst_id
and t3.融资租赁公司融资家数>0
left join (
    SELECT AHN_LTR_APLY_SERNO
    from SJXQ_SJ2025051536_CST_04
    GROUP BY AHN_LTR_APLY_SERNO
)  t1
on t1.AHN_LTR_APLY_SERNO=t2.AHN_LTR_APLY_SERNO
;
SElECT '01' seq, count(1) cnt,count(distinct grnt_mod_colc) custs
from SJXQ_SJ2025051536_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051536_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct AHN_LTR_APLY_SERNO,SVY_RPT_NO) custs
from SJXQ_SJ2025051536_CST_03 where SVY_RPT_NO is not null
union all
SElECT '04' seq, count(1) cnt,count(distinct AHN_LTR_APLY_SERNO,SVY_RPT_NO) custs
from SJXQ_SJ2025051536_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025051536_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025051536_CST_07
;
-- 清单1
SElECT '06' seq, * from lab_bigdata_dev.SJXQ_SJ2025051536_CST_06;
-- 清单2
SElECT '07' seq, * from lab_bigdata_dev.SJXQ_SJ2025051536_CST_07;
/*
01	17	17
02	1734514	1734514
03	1572068	1572068
04	1590122	1572068
05	774698	774697
06	461	461
07	99876	99876
SELECT count(1) as 合同数
    ,sum(case when AHN_LTR_APLY_SERNO is null then 1 else 0 end) as 业务流水号缺失数
    ,count(DISTINCT AHN_LTR_APLY_SERNO) as 业务流水号数
from SJXQ_SJ2025051536_CST_02
;
-- 合同数	业务流水号缺失数	业务流水号数
-- 1734514	127437	1604006
SELECT count(DISTINCT AHN_LTR_APLY_SERNO) as 业务流水号数
    ,sum(case when nvl(SVY_RPT_NO,'')='' then 1 else 0 end) as 调查报告号缺失数
    ,count(DISTINCT SVY_RPT_NO) as 调查报告号数
from SJXQ_SJ2025051536_CST_03
;
-- 业务流水号数	调查报告号缺失数	调查报告号数
-- 1604006	124337	1572068
SELECT count(DISTINCT SVY_RPT_NO) as 调查报告号数
    ,sum(case when nvl(sys_reg_tm,'')='' then 1 else 0 end) as 综合评价缺失数
    ,count(DISTINCT sys_reg_tm) as 综合评价数
    ,sum(case when keyword<>'' then 1 else 0 end) as 关键词综合评价数
from SJXQ_SJ2025051536_CST_04
;
-- 调查报告号数	综合评价缺失数	综合评价数	关键词综合评价数
-- 1572068	1523693	57273	703
-- 20250514以来每日数
SELECT dt,count(1) cnt,count(distinct SVY_RPT_NO) as 调查报告数
from edw.dwd_bus_loan_svy_cst_cprh_evl_dd
where dt>='20250514'
GROUP BY dt order by dt
;
20250514	1464801	781320
20250515	1465149	781625
SELECT dt,count(1) cnt,count(distinct cprsv_evl_serno) as 调查报告数
from edw.dwd_bus_loan_cst_cprh_evl_dd        --客户综合评价
where dt>='20250514'
GROUP BY dt order by dt
;
20250514	2748476	2748476
20250515	2748489	2748489
SELECT dt,count(1) cnt,count(distinct SVY_RPT_NO) as 调查报告数
from edw.loan_svy_cst_cprh_evl               --不含老信贷的数据
where dt>='20250514'
GROUP BY dt order by dt
;
20250514	143980	86784
20250515	144328	87089
-- 综合评价包含关系
SELECT count(t1.SVY_RPT_NO) cnt1,count(t2.SVY_RPT_NO) cnt2
from(
    SELECT distinct  SVY_RPT_NO
    from edw.dwd_bus_loan_svy_cst_cprh_evl_dd
    where dt='@@{yyyyMMdd}'
)t1 left join(
    SELECT distinct  SVY_RPT_NO
    from edw.loan_svy_cst_cprh_evl
    where dt='@@{yyyyMMdd}'
)t2 on t1.SVY_RPT_NO=t2.SVY_RPT_NO
;
--新信贷的表 结论：表1-表2 独立 因为表2没有 调查报告编号，表1包含表3
SHOW PARTITIONS edw.dwd_bus_loan_svy_cst_cprh_evl_dd    --调查报告-客户综合评价
SHOW PARTITIONS edw.dwd_bus_loan_cst_cprh_evl_dd        --客户综合评价
SHOW PARTITIONS edw.loan_svy_cst_cprh_evl               --调查报告-客户综合评价
SHOW PARTITIONS edw.loan_cst_cprh_evl                   --老信贷的数据 没权限
*/
***董怡静_SJ2025051536_小微租赁市场分析-合同维度.sql
﻿/*
清单1：20220101&mdash;&mdash;20250430期间发放的经营性一般贷款中，信贷调查报告综合评价中包含关键词&ldquo;融资租赁&rdquo;、&quot;金融租赁&quot;、&ldquo;设备分期&rdquo;、&ldquo;购买%设备&rdquo;、&ldquo;以租代购&rdquo;、&ldquo;直租&rdquo;、&ldquo;售后回租&rdquo;的合同。其中&ldquo;购买%设备&rdquo;支持模糊搜索。
数据日期=2025年4月30日。
清单2：20220101&mdash;&mdash;20250430期间发放的经营性一般贷款中，最近一笔征信记录中，他行融资机构中存在&quot;22-融资租赁公司&quot;合同。
数据需求字段
清单1：客户号、客户姓名、合同编号、经办人、经办机构、管户人、管户机构、合同起始日期、合同到期日期、合同终结时间、合同状态、合同金额、合同余额、逾期金额、执行利率、还本结息方式、担保方式、产品名称、命中关键词、资金用途备注、征信中（查最近一笔征信记录，剔除我行数据）他行未结清家数、他行未结清余额、他行融资家数、他行授信金额、机构类型为&quot;22-融资租赁公司&quot;的融资家数、机构类型为&quot;22-融资租赁公司&quot;的授信、征信报告日期。
清单2：客户号、客户姓名、合同编号、经办人、经办机构、管户人、管户机构、合同起始日期、合同到期日期、合同终结时间、合同状态、合同金额、合同余额、逾期金额、执行利率、还本结息方式、担保方式、产品名称、命中关键词（参照清单1的关键词，如未命中则输出&ldquo;无&rdquo;）、资金用途备注、征信中（查最近一笔征信记录，剔除我行数据）他行未结清家数、他行未结清余额、他行融资家数、他行授信金额、机构类型为&quot;22-融资租赁公司&quot;的融资家数、机构类型为&quot;22-融资租赁公司&quot;的授信、征信报告日期。
*/
--担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_01 AS
SELECT  a.grnt_mod_colc
FROM
(
	SELECT  distinct grnt_mod_colc
	       ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE dt = '@@{yyyyMMdd}'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.grnt_mod_colc
;
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_02 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,C5.cd_val_dscr     AS 合同状态
    ,t1.exec_intr_rat	                        --执行利率
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,c7.grnt_mod_nm     as 担保方式集合
    ,t1.cpt_usg_rmk	        --资金用途备注|c4000
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,T1.rpay_prcp_setl_intr_mod_cd               --还本结息方式代码
    ,C6.cd_val_dscr     AS 还本结息方式
    ,t2.PD_NM
    ,t1.mgr_id	                                 --管户人工号
    ,c1.empe_nm	                                 as 管户人
    ,t1.mgr_org_id	                             --管户机构号
    ,c2.org_nm          as 管户机构
    ,t1.hdl_opr_id	    --经办人工号
    ,c3.empe_nm         as 经办人
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,c4.org_nm          as 经办机构
    ,t4.lve_act_bgn_dt  as 首次贷款发放日期 --期间首次
    ,t5.AHN_LTR_APLY_SERNO
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t1.mgr_id=c1.empe_id
and c1.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    c2 --考核机构树
on  t1.mgr_org_id = c2.org_id
and c2.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            c3 --员工信息汇总
on  t1.hdl_opr_id=c3.empe_id
and c3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    c4 --考核机构树
on  t1.hdl_org_id = c4.org_id
and c4.dt = t1.dt
left join edw.dim_bus_loan_ctr_oth_dtl_inf_dd	t3 --合同其它明细信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join(
    SELECT  t1.ctr_serno 							    --合同流水号|c32
        ,MIN(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt    --出账起始日期|c8
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='@@{yyyyMMdd}'
    and t1.lve_act_bgn_dt between '20220101' and '20250430'
    GROUP BY t1.ctr_serno
)t4 on t1.ctr_serno=t4.ctr_serno
left join edw.dwd_code_library_dd c5
on T1.ctr_sts_cd = c5.cd_val
and c5.dt = t1.dt
left join edw.dwd_code_library_dd c6
on T1.rpay_prcp_setl_intr_mod_cd = c6.cd_val
and c6.dt = t1.dt
left join SJXQ_SJ2025051536_CST_01  c7
on t1.grnt_mod_colc=c7.grnt_mod_colc
left JOIN edw.dwd_bus_loan_lmt_aply_biz_dd      t5 --用信方案
ON t1.REL_SERNO = t5.USC_APLY_SERNO
and  t5.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
-- 经营性一般贷款的口径
AND     T1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( T3.APLY_CHNL_cd <> 'L08'
    OR T1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     T1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     T1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( T1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(T1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
AND     SUBSTR(T1.PRD_NO, 1, 1) NOT IN ( '3' ) --剔除授信额度、非金融机构授信、同业
AND     substr(T1.PRD_NO, 1, 6) NOT IN ( '100103' , '100104' , '100106' , '200103' , '200104' , '200105' )
--剔除代理贷款、对公合作贷款、对公委托贷款、个人代理贷款、个人合作贷款、个人委托贷款
AND     T1.PRD_NO <> '201040801010101' --锦鲤资产池单独逻辑剔除
AND     substr(T1.PRD_NO, 1, 4) NOT IN ( '1002' , '1004' , '1005' , '1006' , '1007' , '2003' )
--剔除票据（承兑+贴现）业务、保理业务、保函、资金类、债券推荐业务、资金类-对私
AND     substr(T1.PRD_NO, 1, 8) NOT IN ( '10030202' , '10030109' , '10030301' , '10030303' , '10030304' )
--贸易融资里剔除开立进口信用证、出口易贷、开立国内信用证、国内信用证买方融资、国内信用证议付
AND     substr(T1.PRD_NO, 1, 13) NOT IN ( '1003000000001' ) --贸易融资里剔除出口融资、应付账款融资，新信贷逻辑为剔除贸e贷
AND     substr(T1.PRD_NO, 1, 13) <> '1003010801001' --贸易融资里剔除跨境电商贷额度-对公
AND     nvl(T1.PRD_NO, '') <> ''
AND     T1.PRD_NO NOT LIKE '2002%'  --剔除信用卡
;
--调查报告-客户综合评价
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_03 AS
select cst_id
from(
    SELECT  cst_id      --客户号|c20
        ,anls_dt     --分析日期|date
        ,cprsv_evl   --综合评价|c4000
        ,rmk         --备注|c4000
        ,sys_reg_tm  --系统登记时间
        ,case when cprsv_evl regexp '融资租赁'  then '融资租赁'
            when cprsv_evl regexp '金融租赁'  then '金融租赁'
            when cprsv_evl regexp '设备分期'  then '设备分期'
            when cprsv_evl regexp '以租代购'  then '以租代购'
            when cprsv_evl regexp '直租'  then '直租'
            when cprsv_evl regexp '售后回租'  then '售后回租'
            when cprsv_evl like '%购买%设备%' then '购买%设备'
            else '' end as keyword
    from edw.dwd_bus_loan_svy_cst_cprh_evl_dd --调查报告-客户综合评价
    where dt='@@{yyyyMMdd}'
    and anls_dt between '20220101' and '20250430'
    union all
    SELECT  cst_id      --客户号|c20
        ,anls_dt     --分析日期|c8
        ,cprsv_evl   --综合评价|c4000
        ,rmk         --备注|c4000
        ,sys_reg_tm  --系统登记时间|c19
        ,case when cprsv_evl regexp '融资租赁'  then '融资租赁'
            when cprsv_evl regexp '金融租赁'  then '金融租赁'
            when cprsv_evl regexp '设备分期'  then '设备分期'
            when cprsv_evl regexp '以租代购'  then '以租代购'
            when cprsv_evl regexp '直租'  then '直租'
            when cprsv_evl regexp '售后回租'  then '售后回租'
            when cprsv_evl like '%购买%设备%' then '购买%设备'
            else '' end as keyword
    from edw.dwd_bus_loan_cst_cprh_evl_dd     --客户综合评价
    where dt='@@{yyyyMMdd}'
    and anls_dt between '20220101' and '20250430'
)T1 where keyword<>''
group by cst_id
;
--最近一笔征信记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_05 AS
select T1.cst_id
    ,T2.report_no                           --报告编号
    ,T2.report_dt                             --报告日期
    ,T2.他行融资家数 as 他行融资家数_指标
    ,t3.他行未结清家数
    ,t3.他行未结清余额
    ,t3.他行融资家数
    ,t3.他行授信金额
    ,t3.融资租赁公司融资家数
    ,t3.融资租赁公司授信金额
from(
    SELECT distinct cst_id
    FROM SJXQ_SJ2025051536_CST_02
)T1
inner join(
    select report_no                           --报告编号
        ,cst_id                                --客户号
	    ,report_dt                             --报告日期
        ,oth_bank_loan_org_num AS 他行融资家数  --他行贷款授信机构数
    from edw.dws_cst_ccrc_idv_ind_inf_dd       --个人征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1     --最新报告
    union
    select report_no                          --报告编号
        ,cst_id                               --客户号
	    ,report_dt                            --报告日期
        ,oth_bank_busi_org_num as 他行融资家数 --他行授信机构数
    from edw.dws_cst_ccrc_entp_ind_inf_dd     --企业征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1     --最新报告
)t2 ON T1.cst_id=T2.cst_id
left JOIN
(
    select cst_id
        ,report_id
        ,count(distinct case when ctr_bal > 0 OR rmn_rpay_trm > 0 then dtrb_org_typ_cd end)   as 他行未结清家数
        ,sum(case when ctr_bal > 0 OR rmn_rpay_trm > 0 then ctr_bal else 0 end)          as 他行未结清余额
        ,count(distinct dtrb_org_typ_cd)    as 他行融资家数
        ,sum(ctr_amt)                  as 他行授信金额
        ,count(distinct case when dtrb_org_typ_cd ='22' then dtrb_org end)  as 融资租赁公司融资家数
        ,sum(case when dtrb_org_typ_cd ='22' then ctr_amt else 0 end)       as 融资租赁公司授信金额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd
    where dt = '@@{yyyyMMdd}'
    and   dtrb_org <> 'ZJTLCB'    --他行
    -- and   dtrb_org_typ_cd ='22'   -- 21:信托公司 22-融资租赁公司  24:消费金融公司  51:小额贷款公司
    group by cst_id ,report_id
    union all
    select cst_id
        ,report_id
        ,count(distinct case when ACT_ACTV_STS = '1' then dtrb_org_cd end)   as 他行未结清家数
        ,sum(case when ACT_ACTV_STS = '1' then loan_bal else 0 end)          as 他行未结清余额
        ,count(distinct dtrb_org_cd)    as 他行融资家数
        ,sum(case when crd_lmt>0 then crd_lmt else loan_amt end)                  as 他行授信金额 --信用额度 贷款金额
        ,count(distinct case when dtrb_org_typ_cd ='22' then dtrb_org_cd end)  as 融资租赁公司融资家数
        ,sum(case when dtrb_org_typ_cd ='22' then case when crd_lmt>0 then crd_lmt else loan_amt end else 0 end)    as 融资租赁公司授信金额
    from   edw.dim_cst_ccrc_entp_loan_inf_dd
    where  dt = '@@{yyyyMMdd}'
    and   length(DTRB_ORG_CD)='4' --他行
    -- and dtrb_org_typ_cd ='22'                --21:信托公司 22-融资租赁公司  24:消费金融公司  51:小额贷款公司
    group by cst_id ,report_id
)t3 on t2.cst_id = t3.cst_id
and t2.report_no = t3.report_id
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_06 AS
SELECT  t2.cst_id        AS 客户号
       ,t2.cst_nm        AS 客户名称
       ,t2.ctr_serno     AS 合同流水号
       ,t2.经办人
       ,t2.经办机构
       ,t2.管户人
       ,t2.管户机构
       ,t2.ctr_bgn_dt    AS 合同起始日期
       ,t2.ctr_mtu_dt    AS 合同到期日期
       ,t2.TMT_DT        AS 终结日期
       ,t2.合同状态
       ,t2.ctr_amt       AS 合同金额
       ,t2.ctr_bal       AS 合同余额
       ,t2.ovd_amt       AS 逾期金额
       ,t2.exec_intr_rat AS 执行利率
       ,t2.还本结息方式
       ,t2.担保方式集合
       ,t2.PD_NM         AS 产品名称
       ,t1.keywords       AS 命中关键词
       ,t2.cpt_usg_rmk   AS 资金用途备注
       ,t2.首次贷款发放日期
       ,t3.他行未结清家数
       ,t3.他行未结清余额
       ,t3.他行融资家数
       ,t3.他行授信金额
       ,t3.融资租赁公司融资家数
       ,t3.融资租赁公司授信金额
       ,T3.report_dt     AS 征信报告日期
from  SJXQ_SJ2025051536_CST_03      t1
INNER JOIN SJXQ_SJ2025051536_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025051536_CST_05  t3
on t1.cst_id=t3.cst_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST_07 AS
SELECT  t1.cst_id        AS 客户号
       ,t1.cst_nm        AS 客户名称
       ,t1.ctr_serno     AS 合同流水号
       ,t1.经办人
       ,t1.经办机构
       ,t1.管户人
       ,t1.管户机构
       ,t1.ctr_bgn_dt    AS 合同起始日期
       ,t1.ctr_mtu_dt    AS 合同到期日期
       ,t1.TMT_DT        AS 终结日期
       ,t1.合同状态
       ,t1.ctr_amt       AS 合同金额
       ,t1.ctr_bal       AS 合同余额
       ,t1.ovd_amt       AS 逾期金额
       ,t1.exec_intr_rat AS 执行利率
       ,t1.还本结息方式
       ,t1.担保方式集合
       ,t1.PD_NM         AS 产品名称
       ,t4.keywords       AS 命中关键词
       ,t1.cpt_usg_rmk   AS 资金用途备注
       ,t1.首次贷款发放日期
       ,t2.他行未结清家数
       ,t2.他行未结清余额
       ,t2.他行融资家数
       ,t2.他行授信金额
       ,t2.融资租赁公司融资家数
       ,t2.融资租赁公司授信金额
       ,T2.report_dt     AS 征信报告日期
from SJXQ_SJ2025051536_CST_02       t1
inner join SJXQ_SJ2025051536_CST_05 t2
on t1.cst_id=t2.cst_id
and t2.融资租赁公司融资家数>0
left join SJXQ_SJ2025051536_CST_03  t4
on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct grnt_mod_colc) custs
from SJXQ_SJ2025051536_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051536_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST_03
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025051536_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025051536_CST_07
;
SElECT '06' seq, *
from SJXQ_SJ2025051536_CST_06
;
SElECT '07' seq, *
from SJXQ_SJ2025051536_CST_07
;
/*
01	17	17
02	1734514	1734514
03	25218	25218
05	774699	774698
06	80477	80477
07	99953	99953
*/***董怡静_SJ2025051536_小微租赁市场分析.sql
﻿/*
清单1：20220101&mdash;&mdash;20250430期间发放的经营性一般贷款中，信贷调查报告综合评价中包含关键词&ldquo;融资租赁&rdquo;、&quot;金融租赁&quot;、&ldquo;设备分期&rdquo;、&ldquo;购买%设备&rdquo;、&ldquo;以租代购&rdquo;、&ldquo;直租&rdquo;、&ldquo;售后回租&rdquo;的合同。其中&ldquo;购买%设备&rdquo;支持模糊搜索。
数据日期=2025年4月30日。
清单2：20220101&mdash;&mdash;20250430期间发放的经营性一般贷款中，最近一笔征信记录中，他行融资机构中存在&quot;22-融资租赁公司&quot;合同。
数据需求字段
清单1：客户号、客户姓名、合同编号、经办人、经办机构、管户人、管户机构、合同起始日期、合同到期日期、合同终结时间、合同状态、合同金额、合同余额、逾期金额、执行利率、还本结息方式、担保方式、产品名称、命中关键词、资金用途备注、征信中（查最近一笔征信记录，剔除我行数据）他行未结清家数、他行未结清余额、他行融资家数、他行授信金额、机构类型为&quot;22-融资租赁公司&quot;的融资家数、机构类型为&quot;22-融资租赁公司&quot;的授信、征信报告日期。
清单2：客户号、客户姓名、合同编号、经办人、经办机构、管户人、管户机构、合同起始日期、合同到期日期、合同终结时间、合同状态、合同金额、合同余额、逾期金额、执行利率、还本结息方式、担保方式、产品名称、命中关键词（参照清单1的关键词，如未命中则输出&ldquo;无&rdquo;）、资金用途备注、征信中（查最近一笔征信记录，剔除我行数据）他行未结清家数、他行未结清余额、他行融资家数、他行授信金额、机构类型为&quot;22-融资租赁公司&quot;的融资家数、机构类型为&quot;22-融资租赁公司&quot;的授信、征信报告日期。
*/
-- 全行合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.ctr_sts_cd                               --合同状态代码
    ,C5.cd_val_dscr     AS 合同状态
    ,t1.exec_intr_rat	                        --执行利率
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,t1.cpt_usg_rmk	        --资金用途备注|c4000
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,T1.rpay_prcp_setl_intr_mod_cd               --还本结息方式代码
    ,C6.cd_val_dscr     AS 还本结息方式
    ,t2.PD_NM
    ,t1.mgr_id	                                 --管户人工号
    ,c1.empe_nm	                                 as 管户人
    ,t1.mgr_org_id	                             --管户机构号
    ,c2.org_nm          as 管户机构
    ,t1.hdl_opr_id	    --经办人工号
    ,c3.empe_nm         as 经办人
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,c4.org_nm          as 经办机构
    ,t4.lve_act_bgn_dt  as 首次贷款发放日期 --期间首次
    ,t4.dbil_amt_rat,t4.dbil_amt
    ,t5.AHN_LTR_APLY_SERNO
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t1.mgr_id=c1.empe_id
and c1.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    c2 --考核机构树
on  t1.mgr_org_id = c2.org_id
and c2.dt = t1.dt
left join edw.dws_hr_empe_inf_dd            c3 --员工信息汇总
on  t1.hdl_opr_id=c3.empe_id
and c3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    c4 --考核机构树
on  t1.hdl_org_id = c4.org_id
and c4.dt = t1.dt
left join edw.dim_bus_loan_ctr_oth_dtl_inf_dd	t3 --合同其它明细信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join(
    SELECT  t1.ctr_serno 							    --合同流水号|c32
        ,MIN(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt    --出账起始日期|c8
        ,sum(amt*EXEC_INTR_RAT)     as dbil_amt_rat
        ,sum(amt)   as dbil_amt
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='@@{yyyyMMdd}'
    -- and t1.lve_act_bgn_dt between '20220101' and '20250430'
    GROUP BY t1.ctr_serno
)t4 on t1.ctr_serno=t4.ctr_serno
left join edw.dwd_code_library_dd c5
on T1.ctr_sts_cd = c5.cd_val
and c5.dt = t1.dt
left join edw.dwd_code_library_dd c6
on T1.rpay_prcp_setl_intr_mod_cd = c6.cd_val
and c6.dt = t1.dt
left JOIN edw.dwd_bus_loan_lmt_aply_biz_dd      t5 --用信方案
ON t1.REL_SERNO = t5.USC_APLY_SERNO
and  t5.dt=t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.ctr_bgn_dt between '20220101' and '20250430'
-- 经营性一般贷款的口径
AND     T1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( T3.APLY_CHNL_cd <> 'L08'
    OR T1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     T1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     T1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( T1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(T1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
AND     SUBSTR(T1.PRD_NO, 1, 1) NOT IN ( '3' ) --剔除授信额度、非金融机构授信、同业
AND     substr(T1.PRD_NO, 1, 6) NOT IN ( '100103' , '100104' , '100106' , '200103' , '200104' , '200105' )
--剔除代理贷款、对公合作贷款、对公委托贷款、个人代理贷款、个人合作贷款、个人委托贷款
AND     T1.PRD_NO <> '201040801010101' --锦鲤资产池单独逻辑剔除
AND     substr(T1.PRD_NO, 1, 4) NOT IN ( '1002' , '1004' , '1005' , '1006' , '1007' , '2003' )
--剔除票据（承兑+贴现）业务、保理业务、保函、资金类、债券推荐业务、资金类-对私
AND     substr(T1.PRD_NO, 1, 8) NOT IN ( '10030202' , '10030109' , '10030301' , '10030303' , '10030304' )
--贸易融资里剔除开立进口信用证、出口易贷、开立国内信用证、国内信用证买方融资、国内信用证议付
AND     substr(T1.PRD_NO, 1, 13) NOT IN ( '1003000000001' ) --贸易融资里剔除出口融资、应付账款融资，新信贷逻辑为剔除贸e贷
AND     substr(T1.PRD_NO, 1, 13) <> '1003010801001' --贸易融资里剔除跨境电商贷额度-对公
AND     nvl(T1.PRD_NO, '') <> ''
AND     T1.PRD_NO NOT LIKE '2002%'  --剔除信用卡
;
-- 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_02 AS
SELECT  cst_id --客户号|C20
       ,SUM(ctr_amt)                       AS 合同金额
       ,SUM(ctr_bal)                       AS 合同余额
       ,SUM(ovd_amt)                       AS 逾期金额
       ,SUM(dbil_amt)                      AS 借据金额
       ,CASE WHEN SUM(dbil_amt) > 0 THEN SUM(dbil_amt_rat)/SUM(dbil_amt)  ELSE 0 END     AS 执行利率_借据金额加权
FROM SJXQ_SJ2025051536_CST2_01
GROUP BY  cst_id
;
--调查报告-客户综合评价
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_03 AS
select cst_id
from(
    SELECT  cst_id      --客户号|c20
        ,anls_dt     --分析日期|date
        ,cprsv_evl   --综合评价|c4000
        ,rmk         --备注|c4000
        ,sys_reg_tm  --系统登记时间
        ,case when cprsv_evl regexp '融资租赁'  then '融资租赁'
            when cprsv_evl regexp '金融租赁'  then '金融租赁'
            when cprsv_evl regexp '设备分期'  then '设备分期'
            when cprsv_evl regexp '以租代购'  then '以租代购'
            -- when cprsv_evl regexp '直租'  then '直租'
            when cprsv_evl regexp '售后回租'  then '售后回租'
            -- when cprsv_evl like '%购买%设备%' then '购买%设备'
            else '' end as keyword
    from edw.dwd_bus_loan_svy_cst_cprh_evl_dd --调查报告-客户综合评价
    where dt='@@{yyyyMMdd}'
    and anls_dt between '20220101' and '20250430'
    union all
    SELECT  cst_id      --客户号|c20
        ,anls_dt     --分析日期|c8
        ,cprsv_evl   --综合评价|c4000
        ,rmk         --备注|c4000
        ,sys_reg_tm  --系统登记时间|c19
        ,case when cprsv_evl regexp '融资租赁'  then '融资租赁'
            when cprsv_evl regexp '金融租赁'  then '金融租赁'
            when cprsv_evl regexp '设备分期'  then '设备分期'
            when cprsv_evl regexp '以租代购'  then '以租代购'
            -- when cprsv_evl regexp '直租'  then '直租'
            when cprsv_evl regexp '售后回租'  then '售后回租'
            -- when cprsv_evl like '%购买%设备%' then '购买%设备'
            else '' end as keyword
    from edw.dwd_bus_loan_cst_cprh_evl_dd     --客户综合评价
    where dt='@@{yyyyMMdd}'
    and anls_dt between '20220101' and '20250430'
)T1 where keyword<>''
group by cst_id
;
/* 是否风险客户
-- 6、风险排汰（剔除以下客户）
-- （1）近3年内存在业务标识为&ldquo;重组业务&rdquo;、&ldquo;预保预报业务&rdquo;业务的客户。
-- （2）近3年内存在业务被关联办理业务标识为&ldquo;重组业务&rdquo;、&ldquo;预保预报业务&rdquo;业务的客户。
-- （3）小鱼管家&ldquo;一户一策&rdquo;,反馈为&ldquo;退出&rdquo;的客户。
-- （4）&ldquo;隐患客户清单&rdquo;内客户。
-- （5）&ldquo;问题客户清单&rdquo;内&ldquo;禁止&rdquo;类客户。
-- （6）近2年内存在贷后检查任务且业务级贷后管理方案为&ldquo;账户止付&rdquo;、&ldquo;预保预报&rdquo;、&ldquo;诉讼&rdquo;、&ldquo;清收&rdquo;、&ldquo;重组&rdquo;的客户或客户级贷后管理方案为&ldquo;退出&rdquo;、&ldquo;预保预报&rdquo;、&ldquo;诉讼&rdquo;、&ldquo;清收&rdquo;、&ldquo;重组&rdquo;的客户
-- （7）近2年内精准贷后任务有且仅有超期未完成的处置类任务的客户&mdash;&mdash;针对处置类未反馈的客户（2年内有多条精准贷后,部分已反馈过的客户不纳入本条范围）；
-- （8）2年内最近一次预评估数字解读分＜600分或征信分＜500分或模型分＜750分的客户
*/
-- 规则6-8
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_04 AS
SELECT  t.cst_id
       ,'规则6-8-1' exclude_rule
FROM
(
	SELECT  t1.cst_id
	       ,t1.report_no
	       ,t1.idv_crd_sco_val
	       ,t2.CR_SCO_VAL
	       ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id ORDER BY  t1.report_no DESC ) rn
	FROM edw.dws_cst_ccrc_idv_ind_inf_di t1 --个人征信指标信息表
	LEFT JOIN EDW.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI t2 --评分查询记录
	WHERE t1.DT <= '@@{yyyyMMdd}'
	AND t2.CR_SCO_VAL IS NULL -- 没有中征分记录，只有数字解读分
) t
WHERE t.rn = 1
AND t.idv_crd_sco_val < 600
UNION ALL
-- 中征分
SELECT  t2.cst_id
       ,'规则6-8-2' exclude_rule
FROM
(
	SELECT  cst_id
	       ,CR_SCO_VAL
	       ,dt
	       ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  dt DESC ) AS rn
	FROM
	(
		SELECT  DT
		       ,CST_ID
		       ,CR_SCO_VAL
		FROM EDW.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI -- 评分查询记录 DT为20231219~至今，DT即为查询日期
		WHERE DT <= '@@{yyyyMMdd}'
		AND CR_SCO_VAL > 0
		UNION ALL
		SELECT  PRD_DT         AS DT
		       ,CST_ID
		       ,CST_CR_GRD_VAL AS CR_SCO_VAL
		FROM EDW.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI -- 中征信评分批量解析结果表 DT为20231220~至今，当时批量查询6个月前的中征分，PRD_DT即为查询日期，20230531~至今，目前截止20240731
		WHERE DT <= '@@{yyyyMMdd}'
		AND CST_CR_GRD_VAL > 0
		AND PRD_DT <= '@@{yyyyMMdd}'
	) t1
) t2
WHERE t2.rn = 1
AND t2.CR_SCO_VAL < 500
UNION ALL
-- 模型分
SELECT  cst_id
       ,'规则6-8-3' exclude_rule
FROM lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd --按月跑批
WHERE dt = REPLACE(LAST_DAY(ADD_MONTHS(substr(CAST(FROM_UNIXTIME(UNIX_TIMESTAMP()) AS STRING), 1, 10), - 1)), '-', '') --上月月底
AND ( risk_model_score_adj < 750 OR risk_model_score_adj IS NULL ) -- 当前在逾/重组或模型分 < 750
;
-- 风险客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_05 AS
SELECT  cst_id
FROM
(
	-- （1）近3年内存在业务标识为&ldquo;重组业务&rdquo;、&ldquo;预保预报业务&rdquo;业务的客户。 -- 37116
	SELECT  DISTINCT cst_id
	       ,'规则6-1' exclude_rule
	FROM edw.dim_bus_loan_ctr_bse_inf_dd
	WHERE dt <= '@@{yyyyMMdd}'
	AND bsn_mark_cd RLIKE '^03|^04' -- 01:员工贷款；02:信贷人员亲属业务；03:预保预报业务；04:重组业务；05:协作业务
	UNION ALL
	-- （2）近3年内存在业务被关联办理业务标识为&ldquo;重组业务&rdquo;、&ldquo;预保预报业务&rdquo;业务的客户。
	SELECT  DISTINCT t1.cst_id -- 被重组的客户 -- 9440
	       ,'规则6-2-1' exclude_rule
	FROM EDW.DWD_BUS_LOAN_PLN_BIL_REL_INF_DD t1 -- 重组贷款方案关联老借据信息
	JOIN EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t2 -- 合同基础信息
	ON t1.USE_CR_APLY_SERNO = t2.REL_SERNO AND t2.dt = '@@{yyyyMMdd}'
	WHERE t1.dt = '@@{yyyyMMdd}'
	AND t2.bsn_mark_cd RLIKE '^03|^04' -- 03只有1笔
	UNION ALL
	SELECT  DISTINCT C.CST_ID -- 被预保预报的客户 -- 4154
	       ,'规则6-2-2' exclude_rule
	FROM EDW.DWD_BUS_LOAN_CTR_RELOAN_REL_DD A -- 合同无缝续贷关联表
	JOIN EDW.DIM_BUS_LOAN_DBIL_INF_DD C
	ON A.REL_DBIL_SERNO = C.DBIL_ID AND C.DT = '@@{yyyyMMdd}'
	JOIN EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B
	ON A.NEW_CTR_SERNO = B.CTR_SERNO AND B.DT = '@@{yyyyMMdd}'
	WHERE A.DT = '@@{yyyyMMdd}'
	AND A.REL_TYP_CD = '03'
	UNION ALL
	-- （3）小鱼管家&ldquo;一户一策&rdquo;，近2年最近1次反馈为&ldquo;退出&rdquo;的客户 -- 信贷服务计划不续贷 -- 22348
	SELECT  cst_id
	       ,'规则6-3' exclude_rule
	FROM
	(
		SELECT  cst_id
		       ,own_cr_srv_pln_cd
		       ,dt
		       ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  dt DESC ) AS rn
		FROM edw.dwd_cst_asst_cr_cst_rnw_loan_mng_inf_di -- 信贷客户续贷管理信息
		WHERE dt <= '@@{yyyyMMdd}'
	) t
	WHERE t.rn = 1
	AND t.own_cr_srv_pln_cd = '050' -- 不续贷
	UNION ALL
	-- （4）&ldquo;隐患客户清单&rdquo;内客户。 -- 98221
	SELECT  DISTINCT cst_id
	       ,'规则6-4' exclude_rule
	FROM edw.dwd_bus_loan_rsk_hid_dngr_cst_list_dd
	WHERE dt = '@@{yyyyMMdd}' -- 当前在库的隐患客户
	UNION ALL
	-- （5）&ldquo;问题客户清单&rdquo;内&rdquo;禁止&ldquo;类客户。 -- 131544
	SELECT  DISTINCT cst_id
	       ,'规则6-5' exclude_rule
	FROM edw.dim_cst_mng_blst_dd -- 信贷客户黑名单
	WHERE dt = '@@{yyyyMMdd}'
	AND blist_typ_cd = '01' -- 问题客户名单
	AND blist_sts_cd = '1' -- 已生效
	AND prob_cst_typ_cd = '50' -- 禁止
	UNION ALL
	-- （6）近2年内存在贷后检查任务且业务级贷后管理方案为&ldquo;账户止付&rdquo;、&ldquo;预保预报&rdquo;、&ldquo;诉讼&rdquo;、&ldquo;清收&rdquo;、&ldquo;重组&rdquo;的客户或客户级贷后管理方案为&ldquo;退出&rdquo;、&ldquo;预保预报&rdquo;、&ldquo;诉讼&rdquo;、&ldquo;清收&rdquo;、&ldquo;重组&rdquo;的客户
	SELECT  DISTINCT t3.cst_id
	       ,'规则6-6' exclude_rule
	FROM edw.dwd_bus_loan_psp_chk_tsk_inf_dd t1 -- 贷后检查任务信息，主键：btch_serno, tsk_serno
	LEFT JOIN edw.dwd_bus_loan_bsn_mng_pln_dd t2 -- 业务贷后管理方案
	ON t1.btch_serno = t2.btch_serno AND t2.dt = '@@{yyyyMMdd}'
	LEFT JOIN edw.dwd_bus_loan_psp_chk_btch_inf_dd t3 -- 贷后检查批次信息表
	ON t1.btch_serno = t3.btch_serno AND t3.dt = '@@{yyyyMMdd}'
	WHERE t1.dt = '@@{yyyyMMdd}'
	AND ( t2.pst_loan_mng_pln_cd IN ( '12' , '13' , '14' , '15' , '16' ) OR t3.cst_lvl_pst_loan_mng_pln_cd IN ( '03' , '04' , '06' , '07' , '08' ) )
	UNION ALL
	-- （7）近2年内精准贷后任务有且仅有超期未完成的处置类任务的客户&mdash;&mdash;针对处置类未反馈的客户（2年内有多条精准贷后，部分已反馈过的客户不纳入本条范围）；
	SELECT  a.cst_id
	       ,'规则6-7' exclude_rule
	FROM
	(
		SELECT  t.cst_id
		       ,MIN(chuzhi_flg) min_chuzhi_flg
		       ,MIN(chaoqi_flg) min_chaoqi_flg
		       ,MIN(weiwancheng_flg) min_weiwancheng_flg
		FROM
		(
			SELECT  t3.cst_id
			       ,t1.tsk_gen_dt
			       ,t1.fdbk_stop_dt
			       ,t1.actl_fdbk_dt
			       ,t1.pst_loan_chk_tsk_typ_cd
			       ,t1.acrt_pstln_tsk_ovd_days -- 超期天数
			       ,t3.pst_loan_chk_btch_tsk_sts_cd -- 贷后检查批次任务状态代码
			       ,CASE WHEN t1.pst_loan_chk_tsk_typ_cd IN ( '01' ,'02' ,'12' ) THEN 1  ELSE 0 END AS chuzhi_flg -- 处置标志
			       ,CASE WHEN t1.acrt_pstln_tsk_ovd_days > 0 THEN 1  ELSE 0 END                     AS chaoqi_flg -- 超期标志
			       ,CASE WHEN t3.pst_loan_chk_btch_tsk_sts_cd = '0' THEN 1  ELSE 0 END              AS weiwancheng_flg -- 未完成标志
			FROM edw.dwd_bus_loan_psp_chk_tsk_inf_dd t1 -- 贷后检查任务信息，主键：btch_serno, tsk_serno
			LEFT JOIN edw.dwd_bus_loan_psp_chk_btch_inf_dd t3 -- 贷后检查批次信息表
			ON t1.btch_serno = t3.btch_serno AND t3.dt = '@@{yyyyMMdd}'
			WHERE t1.dt = '@@{yyyyMMdd}'
			AND t1.pst_loan_chk_tsk_src_cd = '01' -- 贷后检查任务来源代码 : 01:精准贷后;02:常规贷后;03:自主贷后;04:精准贷后-信用卡
		) t
		GROUP BY  t.cst_id
	) a
	WHERE a.min_chuzhi_flg = 1 -- 仅有处置的
	AND a.min_chaoqi_flg = 1 -- 仅有超期的
	AND a.min_weiwancheng_flg = 1 -- 仅有未完成的
	UNION ALL
	-- （8）2年内最近一次数字解读分＜600分或征信分＜500分或模型分＜750分的客户
	SELECT  cst_id
	       ,exclude_rule --规则6-8
	FROM SJXQ_SJ2025051536_CST2_04
	UNION ALL
	SELECT  DISTINCT t1.cst_id
	       ,t2.exclude_rule
	FROM edw.dim_cst_rel_inf_dd t1
	LEFT JOIN SJXQ_SJ2025051536_CST2_04 t2
	ON t1.rel_cst_id = t2.cst_id
	WHERE t1.dt = '@@{yyyyMMdd}'
	AND t1.rel_typ_cd IN ( '0109' ) --0109-实际控制人
	AND substr(t1.cst_id, 1, 1) IN ( '2' , '8' ) -- 企业客户
	AND t2.cst_id IS NOT NULL
	-- UNION ALL
	-- -- （9）近1年预评估不通过
	-- SELECT  t.cst_id
	--        ,'规则6-9' exclude_rule
	-- FROM
	-- (
	-- 	-- 已修改 新信贷 :产品预评估 客户级预评估结合一起看，两个流程一起发起，产品调用预评估，如果客户级预评估超过30天要重新跑，否则只跑产品级预评估
	-- 	SELECT  a.cst_id
	-- 	       ,a.pre_ases_serno
	-- 	       ,CASE WHEN c.prd_acs_rslt_typ_cd IN ( 2010 ,2020 ,2030 ) THEN c.prd_acs_rslt_typ_cd  ELSE b.rul_set_rslt_cd END AS rul_set_rslt_cd
	-- 	       ,b.dt
	-- 	       ,b.last_upd_tm
	-- 	       ,ROW_NUMBER() OVER ( PARTITION BY a.dt ,a.cst_id ORDER BY  substr(REPLACE(b.last_upd_tm,'-',''),1,8) DESC ) rk
	-- 	FROM edw.dwd_bus_loan_pre_ases_bsn_aply_dd a --预评估业务申请
	-- 	INNER JOIN edw.dim_bus_loan_pre_ases_rul_set_rel_dd b --预评估规则集关系
	-- 	ON a.pre_ases_serno = b.pre_ases_serno AND b.dt = a.dt AND substr(REPLACE(b.last_upd_tm, '-', ''), 1, 8) <= b.dt AND DATEDIFF(to_date(b.dt, 'yyyymmdd'), to_date(substr(REPLACE(b.last_upd_tm, '-', ''), 1, 8), 'yyyymmdd'), 'dd') <= 365 --近1年
	-- 	LEFT JOIN edw.dim_bus_loan_pre_ases_prd_strtg_inf_dd c
	-- 	ON a.cst_id = c.cst_id AND a.pre_ases_serno = c.pre_ases_serno AND a.dt = c.dt AND c.prd_acs_rslt_typ_cd IN ( 2010 , 2020 , 2030 )
	-- 	WHERE a.dt = '@@{yyyyMMdd}'
	-- ) t
	-- WHERE t.rk = 1
	-- AND t.rul_set_rslt_cd IN ( 2010 , 2020 , 2030 ) --近365天最新预评估是否命中拒绝规则 (2010, 2020, 2030)未通过 抗辩未通过 上诉不通过
) t
GROUP BY  cst_id
;
--最近一笔征信记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_06 AS
select T1.cst_id
    ,T2.report_no                           --报告编号
    ,T2.report_dt                             --报告日期
    ,T2.他行融资家数 as 他行融资家数_指标
    ,t3.他行未结清家数
    ,t3.他行未结清余额
    ,t3.他行融资家数
    ,t3.他行授信金额
    ,t3.融资租赁公司融资家数
    ,t3.融资租赁公司授信金额
	,t3.融资租赁公司未结清余额
from SJXQ_SJ2025051536_CST2_02  T1
inner join(
    select report_no                           --报告编号
        ,cst_id                                --客户号
	    ,report_dt                             --报告日期
        ,oth_bank_loan_org_num AS 他行融资家数  --他行贷款授信机构数
    from edw.dws_cst_ccrc_idv_ind_inf_dd       --个人征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1     --最新报告
    union
    select report_no                          --报告编号
        ,cst_id                               --客户号
	    ,report_dt                            --报告日期
        ,oth_bank_busi_org_num as 他行融资家数 --他行授信机构数
    from edw.dws_cst_ccrc_entp_ind_inf_dd     --企业征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1     --最新报告
)t2 ON T1.cst_id=T2.cst_id
left JOIN
(
    select cst_id
        ,report_id
        ,count(distinct case when ctr_bal > 0 OR rmn_rpay_trm > 0 then dtrb_org_typ_cd end)   as 他行未结清家数
        ,sum(case when ctr_bal > 0 OR rmn_rpay_trm > 0 then ctr_bal else 0 end)          as 他行未结清余额
        ,count(distinct dtrb_org_typ_cd)    as 他行融资家数
        ,sum(ctr_amt)                  as 他行授信金额
        ,count(distinct case when dtrb_org_typ_cd ='22' then dtrb_org end)  as 融资租赁公司融资家数
        ,sum(case when dtrb_org_typ_cd ='22' then ctr_amt else 0 end)       as 融资租赁公司授信金额
		,sum(case when dtrb_org_typ_cd ='22' and (ctr_bal > 0 OR rmn_rpay_trm > 0) then ctr_bal else 0 end)          as  融资租赁公司未结清余额
    from   edw.dim_cst_ccrc_idv_loan_inf_dd
    where dt = '@@{yyyyMMdd}'
    and   dtrb_org <> 'ZJTLCB'    --他行
    -- and   dtrb_org_typ_cd ='22'   -- 21:信托公司 22-融资租赁公司  24:消费金融公司  51:小额贷款公司
    group by cst_id ,report_id
    union all
    select cst_id
        ,report_id
        ,count(distinct case when ACT_ACTV_STS = '1' then dtrb_org_cd end)   as 他行未结清家数
        ,sum(case when ACT_ACTV_STS = '1' then loan_bal else 0 end)          as 他行未结清余额
        ,count(distinct dtrb_org_cd)    as 他行融资家数
        ,sum(case when crd_lmt>0 then crd_lmt else loan_amt end)                  as 他行授信金额 --信用额度 贷款金额
        ,count(distinct case when dtrb_org_typ_cd ='22' then dtrb_org_cd end)  as 融资租赁公司融资家数
        ,sum(case when dtrb_org_typ_cd ='22' then case when crd_lmt>0 then crd_lmt else loan_amt end else 0 end)    as 融资租赁公司授信金额
		,sum(case when dtrb_org_typ_cd ='22' and ACT_ACTV_STS = '1' then loan_bal else 0 end)          as  融资租赁公司未结清余额
    from   edw.dim_cst_ccrc_entp_loan_inf_dd
    where  dt = '@@{yyyyMMdd}'
    and   length(DTRB_ORG_CD)='4' --他行
    -- and dtrb_org_typ_cd ='22'                --21:信托公司 22-融资租赁公司  24:消费金融公司  51:小额贷款公司
    group by cst_id ,report_id
)t3 on t2.cst_id = t3.cst_id
and t2.report_no = t3.report_id
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_07 AS
SELECT  t2.cst_id        AS 客户号
       ,t2.客户名称
       ,t2.管户人
       ,t2.管户机构
       ,t2.合同金额
       ,t2.合同余额
       ,t2.逾期金额
       ,t2.借据金额
       ,t2.执行利率_借据金额加权
       ,case when t2.is_instl=1 then '是' else '否' end as 是否含分期
       ,coalesce(t1.keywords,'无')  AS 命中关键词
       ,t3.他行未结清家数
       ,t3.他行未结清余额
       ,t3.他行融资家数
       ,t3.他行授信金额
       ,t3.融资租赁公司融资家数
       ,t3.融资租赁公司授信金额
	   ,t3.融资租赁公司未结清余额
       ,T3.report_dt     AS 征信报告日期
       ,case when t4.cst_id is not null then '是' else '否' end as 是否风险客户
       ,t4.exclude_rules as 风险客户命中规则
from  SJXQ_SJ2025051536_CST2_03         t1
INNER JOIN SJXQ_SJ2025051536_CST2_02    t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2025051536_CST2_06     t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025051536_CST2_05     T4
on t1.cst_id=t4.cst_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025051536_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051536_CST2_08 AS
SELECT  t1.cst_id        AS 客户号
       ,t1.客户名称
       ,t1.管户人
       ,t1.管户机构
       ,t1.合同金额
       ,t1.合同余额
       ,t1.逾期金额
       ,t1.借据金额
       ,t1.执行利率_借据金额加权
       ,case when t1.is_instl=1 then '是' else '否' end as 是否含分期
       ,coalesce(t3.keywords,'无')  AS 命中关键词
       ,t2.他行未结清家数
       ,t2.他行未结清余额
       ,t2.他行融资家数
       ,t2.他行授信金额
       ,t2.融资租赁公司融资家数
       ,t2.融资租赁公司授信金额
	   ,t2.融资租赁公司未结清余额
       ,T2.report_dt     AS 征信报告日期
       ,case when t4.cst_id is not null then '是' else '否' end as 是否风险客户
       ,t4.exclude_rules as 风险客户命中规则
from SJXQ_SJ2025051536_CST2_02       t1
inner join SJXQ_SJ2025051536_CST2_06 t2
on t1.cst_id=t2.cst_id
and t2.融资租赁公司融资家数>0
left join SJXQ_SJ2025051536_CST2_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025051536_CST2_05  T4
on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025051536_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051536_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025051536_CST2_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025051536_CST2_08
;
SElECT '07' seq, *
from SJXQ_SJ2025051536_CST2_07
;
SElECT '08' seq, *
from SJXQ_SJ2025051536_CST2_08
;
/*
*/
***蒋泽宇_SJ2025040121_公司代发工资户情况.sql
DROP   TABLE IF EXISTS SJXQ_SJ2025040121_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025040121_CST_01
(
    entp_cst_nm  string COMMENT ''
    ,entp_cst_id string COMMENT ''
    ,cst_nm      string COMMENT ''
    ,cst_id      string COMMENT ''
    ,mgr_nm      string COMMENT ''
    ,mgr_id      string COMMENT ''
    ,is_opn      string COMMENT ''
)
;
insert into SJXQ_SJ2025040121_CST_01
;
-- 代发工资
DROP   TABLE IF     EXISTS SJXQ_SJ2025040121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040121_CST_02 AS
select t1.entp_cst_nm,t1.entp_cst_id
    ,t2.cst_act_id,t2.dep_act_id
    ,t3.cnt_pty_cst_act_id                       --对方客户账号
    ,t3.trx_dt,t3.trx_amt
    ,T3.smr_dscr
    ,T3.cmt
    ,t3.cnt_pty_fin_instt_nm	--对方金融机构名称
    ,t4.cst_id
from SJXQ_SJ2025040121_CST_01               t1
INNER join edw.dws_bus_dep_act_inf_dd       t2 --存款账户信息汇总
on t1.entp_cst_id=t2.cst_id
and t2.dt='20250331'
INNER join edw.dwd_bus_dep_bal_chg_dtl_di   t3        --存款账户余额发生明细
ON  T3.dep_act_id = T2.dep_act_id
AND T3.cst_act_id = T2.cst_act_id
and t3.dt between '20250301' and '20250331'
and t3.trx_dt between '20250301' and '20250331'
and CONCAT(T3.smr_dscr, T3.cmt) REGEXP '工资'
left join edw.dim_bus_dep_cst_act_inf_dd  	t4	--客户存款账户信息
on t3.cnt_pty_cst_act_id=t4.cst_act_id
and t4.dt='20250331'
where t1.cst_id=''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025040121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040121_CST_03 AS
SELECT  entp_cst_nm        --代发工资户企业
       ,entp_cst_id        --代发工资户企业客户号
       ,cst_nm             --代发工资流向个人客户名
       ,cst_id             --个人客户号
       ,mgr_nm             --管户人
       ,mgr_id             --管户人工号
       ,is_opn             --个人客户是否我行开户
from SJXQ_SJ2025040121_CST_01
where cst_id<>''
union
SELECT  entp_cst_nm        --代发工资户企业
       ,entp_cst_id        --代发工资户企业客户号
       ,null cst_nm             --代发工资流向个人客户名
       ,cst_id             --个人客户号
       ,null mgr_nm             --管户人
       ,null mgr_id             --管户人工号
       ,'是' is_opn             --个人客户是否我行开户
from SJXQ_SJ2025040121_CST_02
;
-- 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025040121_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040121_CST_04 AS
SELECT  t1.cst_id
    ,t2.val_cst            --价值客户
    ,t2.cst_nm	           --客户姓名
    ,t2.prm_mgr_id	   --主管客户经理编号
    ,t2.prm_mgr_nm	   --主管客户经理名称
    ,t3.dep_bal_avg_lst_90 --最近90天日均(折人民币)
    ,t4.chm_90_avg         --理财近3月日均
    ,t5.loan_bal_90_avg    --近90天贷款余额日均
    ,case when t6.cst_id is not null then '是' ELSE '否' END  AS 是否办理信用卡
from(
    select distinct cst_id
    from SJXQ_SJ2025040121_CST_03
    where nvl(cst_id,'')<>''
)t1 left join app_ado.ADM_SUBL_CST_BUS_INF_DD_KHJZ t2
on t1.cst_id=t2.cst_id
and t2.dt='20250331'
left join adm_pub.adm_csm_cbus_dep_acm_inf_dd	t3 --客户日均存款
on t1.cst_id=t3.cst_id
and t3.dt='20250331'
left join adm_pub.adm_csm_cbus_minie_ind_inf_dd	t4 --客户集市-业务信息-客户MINI泰存理指标信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
left join adm_pub.adm_csm_cbus_loan_inf_dd	 t5 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250331'
left join(
    select distinct cst_id
    from edw.dim_bus_crd_cr_crd_inf_dd --信用卡卡片信息
    where dt='20250331'
)t6 on t1.cst_id=t6.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040121_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040121_CST_05 AS
SELECT  t1.entp_cst_nm                      AS 代发工资户企业
       ,t1.entp_cst_id                      AS 代发工资户企业客户号
       ,coalesce(t1.cst_nm,t2.cst_nm)       AS 代发工资流向个人客户名
       ,t1.cst_id                           AS 个人客户号
       ,coalesce(t1.mgr_nm,t2.prm_mgr_nm) AS 管户人
       ,coalesce(t1.mgr_id,t2.prm_mgr_id) AS 管户人工号
       ,t1.is_opn                           AS 个人客户是否我行开户
       ,t2.val_cst                          AS 是否有价值客户
       ,t2.dep_bal_avg_lst_90               AS 近3个月存款日均
       ,t2.chm_90_avg                       AS 近3个月理财日均
       ,t2.loan_bal_90_avg                  AS 近3个月贷款日均
       ,t2.是否办理信用卡
from SJXQ_SJ2025040121_CST_03       t1
left join SJXQ_SJ2025040121_CST_04  t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040121_CST_01 where cst_id<>''
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025040121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040121_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040121_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 个人客户号) custs
from SJXQ_SJ2025040121_CST_05
;
----结果表
SElECT '05' seq, *
from SJXQ_SJ2025040121_CST_05
***蔡雨婷_SJ20250529106_小额贷款流失挽回.sql
﻿-- 蔡雨婷_SJ20250529106_小额贷款流失挽回
/*
流失客户清单
一、先取一份客户级清单：
1、杭州分行25年4月末同一风险控制号下无未结清业务--指未到期未终结的合同，但历史有过一般贷款业务（一般贷款为个人经营性贷款、个人消费性贷款、流动资金贷款、泰e贷（经营）、泰e贷（消费），剔除信用卡、重组贷款、逾期贷款），形成客户级清单进行展示。按以前的口径，增加产品名称字段
二、在以上客户级清单做以下数据：
1.流失日期（客户最后一笔贷款结清时间）
2.客户名称、客户号
3.客户截至2025年5月28日（改到0531）信贷管护机构及信贷管护客户经理工号，如无信贷管护，则以主管户为准
4.结清当年1月1日同一风险控制号下合同总金额；
5.客户是否有我行逾期记录
6.客户是否触发过处置类精准贷后
7.客户出生日期
8.如客户只有循环类贷款，计算客户19-25年当年年透支率（指什么？ 只算循环类贷款，当年年透支率=年日均贷款余额/合同金额）
9.客户19-25年征信分
10.客户19-25年中征分  只给放在一起的分数段
*/
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_01 AS
select distinct t1.cst_id                                   --客户号|C20
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    ,CASE
        WHEN ( t7.LOAN_TAG='非循环贷' AND t6.MAX_END_DT_DBIL <> '18991231' AND t6.MAX_END_DT_DBIL IS NOT NULL AND t6.MAX_END_DT_DBIL < t1.dt AND t6.WRT_OFF = 0 ) -- 非循环贷结清标识：借据终结日期
        OR ( t7.LOAN_TAG='随贷通' AND t1.TMT_DT <> '18991231' AND LEAST(t1.CTR_MTU_DT, t1.TMT_DT) < t1.dt AND t6.WRT_OFF = 0 ) -- 随贷通该笔合同结清日与约定到期日的较小日期
        OR ( t7.LOAN_TAG='其他循环贷' AND t1.TMT_DT <> '18991231' AND t1.TMT_DT < t1.dt AND t6.WRT_OFF = 0 ) -- 其他循环贷合同取合同结清日期
        THEN 0 ELSE 1 END AS is_wjq -- 0 为结清 1 为未结清
    ,t3.ln_org_id
    ,t3.prm_org_id
    ,t7.LOAN_TAG
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join adm_pub.adm_csm_cbas_mng_inf_dd t3
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd  t4 --考核机构树
on  case when nvl(t3.ln_org_id,'')<>'' then t3.ln_org_id else t3.prm_org_id end = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='杭州分行'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
left join(
    SELECT bus_ctr_id
        ,MAX(end_dt)              AS MAX_END_DT_DBIL -- 借据终结日期最大值
        ,NVL(SUM(wrt_off_amt), 0) AS WRT_OFF
    from EDW.DWS_BUS_LOAN_DBIL_INF_DD T1
    where dt='20250531'
    GROUP BY bus_ctr_id
)t6 on t1.ctr_serno=t6.bus_ctr_id
left join(
    SELECT ctr_serno
        ,CASE
            WHEN RVLG_TYP_CD = '0'                                 THEN '非循环贷'
            WHEN PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN '随贷通'
            WHEN RVLG_TYP_CD <> '0'                                THEN '其他循环贷'
            ELSE '其他' END AS LOAN_TAG
    from edw.dim_bus_loan_ctr_bse_inf_dd
    where dt='20250531'
)t7 on t1.ctr_serno=t7.ctr_serno
where t1.dt='20250531'
;
--历史有过一般贷款业务
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_02 AS
select t1.cst_id
    ,max(case when onbs_ovd_intr_bal + ofbs_ovd_intr_bal + ovd_amt>0 then t1.dt else '' end) as ovd_dt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
LEFT JOIN   EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD T3  --合同其他明细信息
ON      T1.CTR_SERNO  =  T3.CTR_SERNO
AND     T3.DT = t1.dt
where t1.dt<='20250531'
-- 一般贷款的口径还是按照这个好了
AND     T1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( T3.APLY_CHNL_cd <> 'L08'
    OR T1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     T1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     T1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( T1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(T1.CTR_STS_CD, '') <> '' ) --剔除未签约的泰e贷
AND     SUBSTR(T1.PRD_NO, 1, 1) NOT IN ( '3' ) --剔除授信额度、非金融机构授信、同业
AND     substr(T1.PRD_NO, 1, 6) NOT IN ( '100103' , '100104' , '100106' , '200103' , '200104' , '200105' )
--剔除代理贷款、对公合作贷款、对公委托贷款、个人代理贷款、个人合作贷款、个人委托贷款
AND     T1.PRD_NO <> '201040801010101' --锦鲤资产池单独逻辑剔除
AND     substr(T1.PRD_NO, 1, 4) NOT IN ( '1002' , '1004' , '1005' , '1006' , '1007' , '2003' )
--剔除票据（承兑+贴现）业务、保理业务、保函、资金类、债券推荐业务、资金类-对私
AND     substr(T1.PRD_NO, 1, 8) NOT IN ( '10030202' , '10030109' , '10030301' , '10030303' , '10030304' )
--贸易融资里剔除开立进口信用证、出口易贷、开立国内信用证、国内信用证买方融资、国内信用证议付
AND     substr(T1.PRD_NO, 1, 13) NOT IN ( '1003000000001' ) --贸易融资里剔除出口融资、应付账款融资，新信贷逻辑为剔除贸e贷
AND     substr(T1.PRD_NO, 1, 13) <> '1003010801001' --贸易融资里剔除跨境电商贷额度-对公
AND     nvl(T1.PRD_NO, '') <> ''
AND     T1.PRD_NO NOT LIKE '2002%'  --剔除信用卡
group by t1.cst_id
;
/*
结清日期判断：分为非自助循环贷款、自助循环贷款和随贷通卡。
（1）非自助循环贷款：为借据终结日期；
（2）自助循环贷款，为&ldquo;合同终止失效时间&rdquo;；
（3）随贷通卡取该笔合同结清日与约定到期日的较小日期。
（4）核销金额=0
*/
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_03 AS
select t1.ctr_serno                                --合同流水号|c32
	,t1.rel_serno                                --用信申请流水号|c32
	,t1.cst_id                                   --客户号|c20
	,t1.cst_nm                                   --客户名称|c200
	,t1.ctr_mtu_dt                               --合同到期日期|c8
	,t1.ctr_bgn_dt                               --合同起始日期|c8
	,t1.ctr_amt                                  --合同金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额|decimal(21,2)
	,t1.ctr_epsr_amt                             --合同敞口金额|decimal(21,2)
	,t1.ctr_epsr_bal                             --合同敞口余额|decimal(20,2)
	,t1.pctr_dtrb_dt                             --预约放款日期|c8
	,t1.ctr_sts_cd                               --合同状态代码|c1
	,t1.strt_use_amt                             --启用金额|decimal(21,2)
	,t1.exec_intr_rat                            --执行利率|decimal(13,7)
	,t1.hpn_typ_cd                               --发生类型代码|c6
	,t1.bsn_mark_cd                              --业务标识代码|c32
	,t1.tmt_dt                                   --终结日期|c8
	,t1.ovd_amt                                  --逾期金额|decimal(21,2)
	,t1.onbs_ovd_intr_bal                        --表内欠息余额|decimal(21,2)
	,t1.ofbs_ovd_intr_bal                        --表外欠息余额|decimal(21,2)
	,t1.ovd_intr_dt                              --欠息日期|c8
	,t1.usc_aply_dt                              --用信申请日期|c8
	,t1.ctr_eff_dt                               --合同生效日期|
	,t1.prcp_setl_dt                             --本金结清日期|c8
    ,t1.RVLG_TYP_CD	    --循环类型代码 0:非循环|1:自助循环|2:半自助循环
    ,T1.PRD_NO
    ,t2.PD_NM
    ,case when nvl(t3.ln_mgr_id,'')<>'' then t3.ln_mgr_id else t3.prm_mgr_id end as 管户客户经理ID
    ,case when nvl(t3.ln_org_id,'')<>'' then t3.ln_org_id else t3.prm_org_id end as 管户机构ID
    ,case when nvl(t3.ln_mgr_id,'')<>'' then t3.ln_mgr_nm else t3.prm_mgr_nm end as 管户客户经理
    ,case when nvl(t3.ln_org_id,'')<>'' then t3.ln_org_nm else t3.prm_org_nm end as 管户机构
    ,t5.sam_rsk_ctrl_id,t5.ovd_dt
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' )
        AND     t1.TMT_DT = '18991231'
        AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
            OR t1.CTR_BAL > 0 ) then 1 else 0 end as is_wjq_old
    ,CASE
        WHEN ( t7.LOAN_TAG='非循环贷' AND t6.MAX_END_DT_DBIL <> '18991231' AND t6.MAX_END_DT_DBIL IS NOT NULL AND t6.MAX_END_DT_DBIL < t1.dt AND WRT_OFF = 0 ) -- 非循环贷结清标识：借据终结日期
        OR ( t7.LOAN_TAG='随贷通' AND t1.TMT_DT <> '18991231' AND LEAST(CTR_MTU_DT, t1.TMT_DT) < t1.dt AND WRT_OFF = 0 ) -- 随贷通该笔合同结清日与约定到期日的较小日期
        OR ( t7.LOAN_TAG='其他循环贷' AND t1.TMT_DT <> '18991231' AND t1.TMT_DT < t1.dt AND WRT_OFF = 0 ) -- 其他循环贷合同取合同结清日期
        THEN 0 ELSE 1 END AS is_wjq -- 0 为结清 1 为未结清
    ,CASE
        WHEN t7.LOAN_TAG='非循环贷'  THEN MAX_END_DT_DBIL -- 非循环贷结清标识：借据终结日期
        WHEN t7.LOAN_TAG='随贷通'   THEN LEAST(CTR_MTU_DT, TMT_DT) -- 随贷通该笔合同结清日与约定到期日的较小日期
        WHEN t7.LOAN_TAG='其他循环贷' THEN TMT_DT -- 其他循环贷合同取合同结清日期
        END AS JQ_DT
    ,t6.MAX_END_DT_DBIL -- 借据终结日期最大值
    ,T6.WRT_OFF,t7.LOAN_TAG
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
-- left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
-- on  t1.mgr_id=t3.empe_id
-- and t3.dt=t1.dt
-- left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
-- on  t1.mgr_org_id = t4.org_id
-- and t4.dt = t1.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd t3
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
-- inner join edw.dim_hr_org_mng_org_tree_dd  t4 --考核机构树
-- on  case when nvl(t3.ln_org_id,'')<>'' then t3.ln_org_id else t3.prm_org_id end = t4.org_id
-- and t4.dt = t1.dt
-- and t4.brc_org_nm='杭州分行'
inner join(
    select t1.sam_rsk_ctrl_id,t2.cst_id,t3.ovd_dt
    from(
        select sam_rsk_ctrl_id
        from SJXQ_SJ20250529106_CST_01
        group by sam_rsk_ctrl_id having max(is_wjq)=0 --同一风险控制号下无未结清业务
    )t1 inner join (
        SELECT DISTINCT sam_rsk_ctrl_id,cst_id
        from SJXQ_SJ20250529106_CST_01
    ) t2
    on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    inner join SJXQ_SJ20250529106_CST_02    t3  --历史有过一般贷款业务
    on t2.cst_id=t3.cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    SELECT bus_ctr_id
        ,MAX(end_dt)              AS MAX_END_DT_DBIL -- 借据终结日期最大值
        ,NVL(SUM(wrt_off_amt), 0) AS WRT_OFF
    from EDW.DWS_BUS_LOAN_DBIL_INF_DD T1
    where dt='20250531'
    GROUP BY bus_ctr_id
)t6 on t1.ctr_serno=t6.bus_ctr_id
left join(
    SELECT ctr_serno
        ,CASE
            WHEN RVLG_TYP_CD = '0'                                 THEN '非循环贷'
            WHEN PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN '随贷通'
            WHEN RVLG_TYP_CD <> '0'                                THEN '其他循环贷'
            ELSE '其他' END AS LOAN_TAG
    from edw.dim_bus_loan_ctr_bse_inf_dd
    where dt='20250531'
)t7 on t1.ctr_serno=t7.ctr_serno
where t1.dt='20250531'
;
-- 结清当年1月1日同一风险控制号下合同总金额
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_04 AS
select t1.sam_rsk_ctrl_id,t1.loss_year
    ,t2.cst_id
    ,t3.ctr_serno
    ,t3.ctr_amt
    ,t3.dt
from(
    select distinct sam_rsk_ctrl_id,concat(substr(loss_dt,1,4),'0101') as loss_year
    from(
        select sam_rsk_ctrl_id,cst_id
            ,max(JQ_DT) as loss_dt
        from SJXQ_SJ20250529106_CST_03
        group by sam_rsk_ctrl_id,cst_id
    )t1
)t1 inner join edw.DWS_CST_BAS_INF_DD       t2
on t1.sam_rsk_ctrl_id=case when nvl(t2.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end
and t2.dt='20250531'
inner join edw.dim_bus_loan_ctr_bse_inf_dd  t3 --合同基础信息
on t2.cst_id=t3.cst_id
and t1.loss_year=t3.dt
and t3.dt<='20250531'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t3.CTR_STS_CD IN ( '2' , '4' )
AND     t3.TMT_DT = '18991231'
AND     to_date(t3.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t3.dt, 'yyyyMMdd') )
    OR t3.CTR_BAL > 0 ) --未到期未终结口径
inner join edw.dim_bus_loan_prd_frml_dd     t4
on t3.prd_no=t4.prd_no
and t4.dt='20250531'
and t4.PD_NM not regexp '信用卡'
;
-- 8.如客户只有循环类贷款，计算客户19-25年当年年透支率
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_05 AS
select t1.cst_id,t1.dt_year
    ,t1.ctr_bal,t1.ctr_amt,t1.day_cnt
    ,round(t1.ctr_bal/t1.ctr_amt/t1.day_cnt,4) as 年透支率
from(
    select t1.cst_id,substr(t1.dt,1,4) dt_year
        ,sum(t1.ctr_bal)    as ctr_bal
        ,max(t1.ctr_amt)    as ctr_amt
        ,count(t1.dt)   as day_cnt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20250531'
    and t2.PD_NM not regexp '信用卡'
    inner join(
        select cst_id
        from SJXQ_SJ20250529106_CST_03
        group by cst_id having min(RVLG_TYP_CD)<>'0'    --只有循环类贷款
    )t3 on t1.cst_id=t3.cst_id
    where t1.dt<='20250531'
    and t1.dt>='20190101'
    and t1.RVLG_TYP_CD<>'0'
    group by t1.cst_id,dt_year
)t1
;
-- 最新中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_06 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
    ,substr(prd_dt,1,4) as prd_year
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id,substr(prd_dt,1,4) order by prd_dt desc,sc_src) rn
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250531' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250531' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
)t where substr(prd_dt,1,4) between '2019' and '2025'
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_07 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
    ,substr(prd_dt,1,4) as prd_year
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id,substr(prd_dt,1,4) order by prd_dt desc,sc_src) rn
from(
	SELECT cst_id,REPLACE(substr(report_dt,1,10) as prd_dt,'-',''),idv_crd_sco_val as cst_cr_grd_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20250531'
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20250531' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t where substr(prd_dt,1,4) between '2019' and '2025'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250529106_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250529106_CST_08 AS
SELECT  t1.cst_id   AS 客户号
       ,t1.cst_nm   AS 客户名称
       ,t1.管户机构ID
       ,t1.管户机构
       ,t1.管户客户经理ID
       ,t1.管户客户经理
       ,t1.pd_nm    AS 产品名称
       ,t1.LOAN_TAG AS 循环类型
       ,t1.loss_dt  AS 流失日期
    ,case when t1.ovd_dt<>'' then '是' else '否' end as 客户是否有我行逾期记录
    ,t2.ctr_amt as 结清当年1月1日同一风险控制号下合同总金额
    ,case when t3.cst_id is not null then '是' else '否' end as 客户是否触发过处置类精准贷后
    ,t4.bth_dt	as	出生日期
    ,t51.年透支率 as 2019年透支率
    ,t52.年透支率 as 2020年透支率
    ,t53.年透支率 as 2021年透支率
    ,t54.年透支率 as 2022年透支率
    ,t55.年透支率 as 2023年透支率
    ,t56.年透支率 as 2024年透支率
    ,t57.年透支率 as 2025年透支率
    ,t61.scor_rng as 2019年中征分
    ,t62.scor_rng as 2020年中征分
    ,t63.scor_rng as 2021年中征分
    ,t64.scor_rng as 2022年中征分
    ,t65.scor_rng as 2023年中征分
    ,t66.scor_rng as 2024年中征分
    ,t67.scor_rng as 2025年中征分
    ,t71.scor_rng as 2019年征信分
    ,t72.scor_rng as 2020年征信分
    ,t73.scor_rng as 2021年征信分
    ,t74.scor_rng as 2022年征信分
    ,t75.scor_rng as 2023年征信分
    ,t76.scor_rng as 2024年征信分
    ,t77.scor_rng as 2025年征信分
from(
    select sam_rsk_ctrl_id,cst_id
        ,max(jq_dt) as loss_dt
        ,max(ovd_dt) as ovd_dt
    from SJXQ_SJ20250529106_CST_03
    group by sam_rsk_ctrl_id,cst_id
)T1 left join (
    select sam_rsk_ctrl_id,loss_year
        ,sum(ctr_amt)   as ctr_amt
    from SJXQ_SJ20250529106_CST_04
    group by sam_rsk_ctrl_id,loss_year
) t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and substr(t1.loss_dt,1,4) = substr(t2.loss_year,1,4)
left join (
    SELECT  distinct T1.cst_id       --客户号
    FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
    INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
    ON      T1.btch_serno = T2.btch_serno
    AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
    AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
    AND     T2.DT = '20250531'
    WHERE   T1.DT = '20250531'
)t3 on t1.cst_id=t3.cst_id
left join edw.dim_cst_idv_bas_inf_dd t4 --个人客户基本信息
on t1.cst_id=t4.cst_id
and t4.dt='20250531'
-- 年透支率
LEFT JOIN SJXQ_SJ20250529106_CST_05 t51
ON t1.cst_id = t51.cst_id AND t51.dt_year = '2019'
LEFT JOIN SJXQ_SJ20250529106_CST_05 t52
ON t1.cst_id = t52.cst_id AND t52.dt_year = '2020'
LEFT JOIN SJXQ_SJ20250529106_CST_05 t53
ON t1.cst_id = t53.cst_id AND t53.dt_year = '2021'
LEFT JOIN SJXQ_SJ20250529106_CST_05 t54
ON t1.cst_id = t54.cst_id AND t54.dt_year = '2022'
LEFT JOIN SJXQ_SJ20250529106_CST_05 t55
ON t1.cst_id = t55.cst_id AND t55.dt_year = '2023'
LEFT JOIN SJXQ_SJ20250529106_CST_05 t56
ON t1.cst_id = t56.cst_id AND t56.dt_year = '2024'
LEFT JOIN SJXQ_SJ20250529106_CST_05 t57
ON t1.cst_id = t57.cst_id AND t57.dt_year = '2025'
-- 中征分
LEFT JOIN SJXQ_SJ20250529106_CST_06 t61
ON t1.cst_id = t61.cst_id AND t61.prd_year = '2019' and t61.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_06 t62
ON t1.cst_id = t62.cst_id AND t62.prd_year = '2020' and t62.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_06 t63
ON t1.cst_id = t63.cst_id AND t63.prd_year = '2021' and t63.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_06 t64
ON t1.cst_id = t64.cst_id AND t64.prd_year = '2022' and t64.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_06 t65
ON t1.cst_id = t65.cst_id AND t65.prd_year = '2023' and t65.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_06 t66
ON t1.cst_id = t66.cst_id AND t66.prd_year = '2024' and t66.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_06 t67
ON t1.cst_id = t67.cst_id AND t67.prd_year = '2025' and t67.rn=1
-- 征信分
LEFT JOIN SJXQ_SJ20250529106_CST_07 t71
ON t1.cst_id = t71.cst_id AND t71.prd_year = '2019' and t71.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_07 t72
ON t1.cst_id = t72.cst_id AND t72.prd_year = '2020' and t72.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_07 t73
ON t1.cst_id = t73.cst_id AND t73.prd_year = '2021' and t73.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_07 t74
ON t1.cst_id = t74.cst_id AND t74.prd_year = '2022' and t74.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_07 t75
ON t1.cst_id = t75.cst_id AND t75.prd_year = '2023' and t75.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_07 t76
ON t1.cst_id = t76.cst_id AND t76.prd_year = '2024' and t76.rn=1
LEFT JOIN SJXQ_SJ20250529106_CST_07 t77
ON t1.cst_id = t77.cst_id AND t77.prd_year = '2025' and t77.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,is_wjq) custs
from SJXQ_SJ20250529106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250529106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250529106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno,loss_year) custs
from SJXQ_SJ20250529106_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,dt_year) custs
from SJXQ_SJ20250529106_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,prd_year) custs
from SJXQ_SJ20250529106_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id,prd_year) custs
from SJXQ_SJ20250529106_CST_07 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250529106_CST_08
;
/*
01	304106	226365
02	1570708	1570708
03	161103	161103
04	30869	30869
05	58359	58359
06	10027974	10027969
07	51505	51505
*/
-- 结果表
SELECT  * FROM    lab_sjxq.SJXQ_SJ20250529106_CST_08;    --51505 汇总***许杰斌_SJ2025042991_长乐村行风险贷款.sql
﻿-- 许杰斌_SJ2025042991_长乐村行风险贷款
-- 导入
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_01 AS
SELECT  t1.col_2   --合同流水号
       ,t1.col_7   --核心客户编号
       ,t1.col_8   --客户名称
       ,sum(t1.col_9) as col_9      --余额
       ,min(t1.col_11) as col_11    --发放日期
       ,min(t1.col_48) as col_48  --首次出险日期2
from lab_bigdata_dev.qbi_file_20250506_14_18_25_0   t1
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd            t2 --考核机构树
ON t1.col_57 = t2.org_id
AND t2.dt = '20250430'
left join(
    SELECT t1.ctr_serno,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as hpn_typ_nm
        ,t1.RVLG_TYP_CD	    --循环类型代码
        ,c4.cd_val_dscr     as 循环类型
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dwd_code_library_dd           c1
    on t1.bsn_mark_cd = c1.cd_val
    and c1.dt = t1.dt
    left join edw.dwd_code_library_dd           c4
    on t1.RVLG_TYP_CD = c4.cd_val
    and c4.dt = t1.dt
    where t1.dt='20250430'
)t3 on t1.col_36=t3.ctr_serno
left join(
    SELECT t1.ctr_serno,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as hpn_typ_nm
        ,t1.RVLG_TYP_CD	    --循环类型代码
        ,c4.cd_val_dscr     as 循环类型
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dwd_code_library_dd           c1
    on t1.bsn_mark_cd = c1.cd_val
    and c1.dt = t1.dt
    left join edw.dwd_code_library_dd           c4
    on t1.RVLG_TYP_CD = c4.cd_val
    and c4.dt = t1.dt
    where t1.dt='20250430'
)t4 on t1.col_39=t4.ctr_serno
where t1.pt<>''
group by  t1.col_2,t1.col_7,t1.col_8
;
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_02 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    -- 30万以下（不含）、30万（不含）-50万、50万（不含）-100万、100万以上（不含）
    ,case when t1.ctr_amt<=300000 then '[0,30w]'
        when t1.ctr_amt>300000 and t1.ctr_amt<=500000 then '(30w,50w]'
        when t1.ctr_amt>500000 and t1.ctr_amt<=1000000 then '(50w,100w]'
        when t1.ctr_amt>1000000 then '100万以上' else '' end as 合同额度区间
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.CTR_STS_CD
    ,t1.TMT_DT
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,decode(t1.hpn_typ_cd,'010','首笔','011','续贷') as 发生类型
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr     as 业务标识
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t1.usc_aply_dt	                            --用信申请日期|c8
    ,case when t1.prd_tag_nm regexp '家园贷' or c3.cd_val_dscr regexp '家园贷' then '是' else '' end as 是否家园贷
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c4.cd_val_dscr     as 循环类型
    ,t2.PD_NM           as 产品名称
    ,case when t4.dbil_term<1 then '1年以内'
        when t4.dbil_term>=1 and t4.dbil_term<2 then '1-2年'
        when t4.dbil_term>=2 and t4.dbil_term<3 then '2-3年'
        when t4.dbil_term>=3 then '3年及以上' else '' end as 最长一笔借据的期限
    ,t4.首次出险日期
    ,t4.dbil_cnt
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,t5.idt_cd	--	行业代码|C5
    ,c2.cd_val_dscr     as 行业
    ,t6.客户首笔准入时间
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = t1.dt
left join(
    SELECT  t1.ctr_serno 	            --合同流水号|c32
        ,round(MAX(DATEDIFF(TO_DATE(t1.EXEC_MTU_DT,'yyyyMMdd'),TO_DATE(t1.LVE_ACT_BGN_DT,'yyyyMMdd'),'dd'))/365,2) AS dbil_term --最长一笔借据的期限
        ,min(case when nvl(t2.fst_hpn_rsk_date,'')<>'' then t2.fst_hpn_rsk_date end)	    as	首次出险日期
        ,COUNT(distinct t1.dbil_id)     AS dbil_cnt
    from edw.dim_bus_loan_dbil_inf_dd               t1
    left join adm_rsk.adm_rsk_ast_loan_dbil_inf_dd  t2
    on t1.dbil_id=t2.dbil_srl_no
    and t2.dt=t1.dt
    where t1.dt='20250430'
    GROUP BY t1.ctr_serno
)t4 on t1.ctr_serno=t4.ctr_serno
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
left join edw.dwd_code_library_dd c2        --132058 tbl_nm,fld_nm,cd_val 唯一
on t5.idt_cd = c2.cd_val
and c2.dt='20250430'
left join(
    SELECT  cst_id
            ,min(ctr_bgn_dt)  as 客户首笔准入时间
    FROM    edw.dim_bus_loan_ctr_bse_inf_dd
    WHERE   dt = '20250430'
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
left join edw.dwd_code_library_dd           c3
on t1.PRD_CSTGRP_MARK = c3.cd_val
and c3.dt = t1.dt
left join edw.dwd_code_library_dd           c4
on t1.RVLG_TYP_CD = c4.cd_val
and c4.dt = t1.dt
where t1.dt='20250430'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
-- AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_03 AS
SELECT  t1.usc_aply_serno     --用信申请流水号
       ,t1.ahn_ltr_aply_serno --授用信申请流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.cst_typ_cd         --客户类型代码
       ,t1.prd_no             --产品编号
       ,t1.pd_nm              --产品名称
       ,t1.hpn_typ_cd         --发生类型代码
       ,t1.apl_amt            --申请金额
       ,t1.aply_epsr_amt      --申请敞口金额
       ,t1.grnt_mod_colc_cd   --担保方式集合代码
       ,t1.apl_dt             --申请日期
       ,t1.rmk                --备注
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_org_id         --管户机构编号
       ,t1.exec_intr_rat      --执行利率
       ,t2.sam_rsk_ctrl_no    --同一风险控制号
       ,t2.csld_cr_lmt        --统一授信额度
       ,t2.csld_cr_xpos       --统一授信敞口
       ,t2.sys_reg_psn_id     --系统登记人
       ,t3.ctr_serno          --合同号
       ,t4.flow_starter       --流程发起者
       ,t4.flow_starter_name  --发起者姓名
       ,t4.start_time         --流程发起时间
       ,t4.org_id             --发起人机构id
       ,t4.biz_id             --业务流水号
       ,t11.aprv_nm           as 团队总经理
       ,t12.aprv_nm           as 审批支行行长
from edw.dwd_bus_loan_lmt_aply_biz_dd       t1 --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
on t1.ahn_ltr_aply_serno=t2.ahn_ltr_aply_serno
and t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join SJXQ_SJ2025042991_CST_02	        t3 --合同基础信息
on t1.USC_APLY_SERNO=t3.rel_serno
inner join SJXQ_SJ2025042991_CST_01	        t5 --合同基础信息
on t3.ctr_serno=t5.col_2
inner join (
    SELECT instance_id              --流程实例id|c32
        ,flow_starter               --流程发起者
        ,flow_starter_name          --发起者姓名
        ,start_time                 --流程发起时间
        ,org_id                     --发起人机构id
        ,biz_id                     --业务流水号
        ,flow_id                                  --流程id|c32
        ,flow_name                                --流程名称|c100
       ,ROW_NUMBER() over(partition by biz_id,flow_starter order by start_time desc) rn
    from edw.dwd_bus_loan_n_wf_instance_his_dd      t4 --流程运行实例历史表
    where dt='20250430'
)t4 on t1.ahn_ltr_aply_serno=t4.biz_id
and t2.sys_reg_psn_id=t4.flow_starter
and t4.rn=1
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='20250430'
    and t1.node_nm='团队总经理'
    GROUP BY instance_id,node_nm
)t11 on t4.instance_id=t11.instance_id
left join(
    SELECT t1.instance_id,t1.node_nm
        ,round(avg(round(t1.aprv_drtn/60,2)),2)                    as aprv_drtn_min
        ,count(1) as aprv_cnt
        ,sum(case when t1.user_comment regexp '退回' then 1 else 0 end) as back_cnt
    from edw.dwd_bus_loan_n_wf_comment_his_dd  t1 --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd           t3 --员工信息汇总
    on  substr(t1.user_id,1,6)=t3.empe_id
    and t3.dt=t1.dt
    where t1.dt='20250430'
    and t1.node_nm='支行行长'
    GROUP BY instance_id,node_nm
)t12 on t4.instance_id=t12.instance_id
where t1.dt='20250430'
;
--是否异地
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_04 AS
SELECT  t1.cst_id
    ,c1.cd_val_dscr as 经营地址行政区划
    ,c2.cd_val_dscr as 户籍地址行政区划
    -- ,t4.pvc_lvl_id_cd	as 	户籍省级编号代码
    -- ,t4.cty_lvl_id_cd	as 	户籍市级编号代码
    -- ,t4.cnr_lvl_id_cd	as 	户籍县级编号代码
    -- ,t5.pvc_lvl_id_cd	as 	经营省级编号代码
    -- ,t5.cty_lvl_id_cd	as 	经营市级编号代码
    -- ,t5.cnr_lvl_id_cd	as 	经营县级编号代码
from(
    select distinct col_7 as cst_id
    from SJXQ_SJ2025042991_CST_01
)t1 LEFT JOIN edw.loan_cst_ctc_addr t2
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250430' and t2.del_ind='0' 	--未删除
AND t2.addr_typ = '050900' --经营地址
LEFT JOIN edw.loan_cst_ctc_addr t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250430' and t3.del_ind='0' 	--未删除
AND t3.addr_typ = '050100' --户籍地址
-- left  join edw.dim_cst_bas_phy_adr_inf_dd   t4   --客户物理地址信息
-- on   t1.cst_id = t4.cst_id
-- and  t4.dt = '20250430'
-- and  t4.phy_adr_typ_cd = '050100'   --户籍地址
-- left  join edw.dim_cst_bas_phy_adr_inf_dd   t5   --客户物理地址信息
-- on   t1.cst_id = t5.cst_id
-- and  t5.dt = '20250430'
-- and  t5.phy_adr_typ_cd = '050900'    --经营所在地地址
left join   edw.dwd_code_library_dd   c1 -- 码值表
ON      substr(t2.adiv,1,6) = c1.cd_val
AND     c1.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND     c1.fld_nm = 'AREA_OR_CNR_DTRCT_DVD_CD'     --区县
AND     c1.dt = '20250430'
left join   edw.dwd_code_library_dd   c2 -- 码值表
ON      substr(t3.adiv,1,6) = c2.cd_val
AND     c2.tbl_nm = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND     c2.fld_nm = 'AREA_OR_CNR_DTRCT_DVD_CD'     --区县
AND     c2.dt = '20250430'
;
-- 配偶信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_05 AS
select t1.cst_id
    ,t2.rel_cst_id
    ,case when t3.cst_id is not null then '是' else '否' end as 配偶我行是否有未结清授信
    ,t3.ctr_bal     as 配偶我行贷款余额
from(
    select distinct col_7 as cst_id
    from SJXQ_SJ2025042991_CST_01
)t1 left join edw.loan_cst_rel  t2        --客户关联关系信息
on t1.cst_id=t2.cst_id
and t2.rel_typ='0301' --配偶
and t2.dt = '20250430'
left join(
    select cst_id,sum(ctr_bal) as ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250430'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t3 on t2.rel_cst_id=t3.cst_id
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_06 AS
select t2.col_2 as ctr_serno                           --业务合同编号|C32
    ,t1.grnt_ctr_id                              --担保合同编号|C32
	,t1.wrnt_cst_id                              --保证人客户编号|C20
	,t1.wrnt_cst_nm                              --保证人客户名称|C200
	,t1.grnt_psn_seq_nbr                         --担保人序号|C10
    ,case when t3.cst_id is not null then '是' else '否' end as is_crdt --担保人我行是否有未结清授信
    ,t3.ctr_bal     --担保人我行贷款余额
    ,row_number() over(partition by t2.col_2 order by t1.grnt_ctr_id,t1.grnt_psn_seq_nbr) rn
from edw.dws_bus_grnt_prsn_inf_dd       t1           --担保人汇总信息
inner join SJXQ_SJ2025042991_CST_01     t2
on t1.bus_ctr_id=t2.col_2
left join(
    select cst_id,sum(ctr_bal) as ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250430'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t3 on t1.wrnt_cst_id=t3.cst_id
where t1.dt='20250430'
;
-- 出险业务准入时客户征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_07 AS
select t1.cst_id ,t1.prd_dt
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
    ,t2.ctr_serno
    ,row_number() over(partition by t1.cst_id,t2.ctr_serno order by prd_dt desc,sc_src) rn
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250430' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250430' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20250430' --and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20250430' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t1 inner join(
    select t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt
    from SJXQ_SJ2025042991_CST_02           t1
    inner join SJXQ_SJ2025042991_CST_01	    t5 --合同基础信息
    on t1.ctr_serno=t5.col_2
)t2 on t1.cst_id=t2.cst_id
where t1.prd_dt<=t2.ctr_bgn_dt
;
-- 出险业务发放时
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_08 AS
SELECT  T1.CST_ID,t1.ctr_serno,t1.DTRB_DT
    ,t1.sys_reg_tm	        --系统登记时间
    ,t2.rul_set_rslt_nm     --新预评估结果
	,t2.PRE_ASES_rul_nm     --预评估触发规则
	,t2.PRE_ASES_prmpt_msg  --预评估提示信息
from(
	SELECT  t1.CST_ID,t1.PRE_ASES_SERNO
        ,t1.cst_nm	        --客户名称
        ,t1.mbrwr_cst_id	--主借款人客户号
        ,t1.aply_org_id	    --申请机构号|c32
        ,t1.sys_reg_tm	    --系统登记时间|c19
        ,t2.ctr_serno
        ,t2.DTRB_DT
	    ,row_number() over(partition by t1.cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD t1 --预评估业务申请
    inner join(
        select distinct col_7   as cst_id
            ,col_2              as ctr_serno
            ,col_11             as DTRB_DT
        from SJXQ_SJ2025042991_CST_01
    )t2 on t1.cst_id=t2.cst_id
	WHERE t1.DT = '20250430'
    and substr(REPLACE(T1.SYS_REG_TM, '-', ''), 1, 8) <= t2.DTRB_DT
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20250430'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
	LEFT JOIN
	(
		SELECT  B1.rul_set_rslt_serno
		FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
		WHERE B1.DT = '20250430'
		GROUP BY  B1.rul_set_rslt_serno
	) T3
	ON T2.rul_set_rslt_serno = T3.rul_set_rslt_serno
    where t2.DT = '20250430'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
--精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_09 AS
SELECT  T1.cst_id
       ,T2.tsk_gen_dt
       ,T1.btch_serno
       ,t3.rul_nm
       ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY  T2.tsk_gen_dt aSC ) AS rn_asc
       ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY  T2.tsk_gen_dt DESC ) AS rn_desc
FROM edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
INNER JOIN edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON T1.btch_serno = T2.btch_serno AND T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
 AND T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01 处置1级, 02 处置2级, 03 预警类, 04 提示类
 AND T2.DT = '20250430'
LEFT JOIN
(
    SELECT  A1.btch_serno
        ,A1.rul_nm --规则名称|c200
        ,A1.rul_ctg_nm --规则分类名称
        ,A1.rul_sub_clss_nm --规则细类名称
        ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY  sgnl_rul_serno DESC ) AS RN
    FROM edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
    WHERE A1.DT = '20250430'
) T3
ON T1.btch_serno = T3.btch_serno AND T3.RN = 1
WHERE T1.DT = '20250430'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_10 AS
SELECT  T1.cst_id
       ,T2.tsk_gen_dt
       ,T2.pst_loan_chk_tsk_typ_cd
       ,decode(T2.pst_loan_chk_tsk_typ_cd,'01','处置1级','02','处置2级','03','预警类','04','提示类','') as 最后一次精准贷后的类型
       ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY  T2.tsk_gen_dt DESC ) AS rn
FROM edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
INNER JOIN edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON T1.btch_serno = T2.btch_serno AND T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
--  AND T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01 处置1级, 02 处置2级, 03 预警类, 04 提示类
AND T2.DT = '20250430'
;
-- 管户交接记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_11 AS
select t1.cst_id                                   --客户号|c20
	,t1.aft_hdv_cst_magr_id                      --移交后客户经理工号|c10
    ,t3.empe_nm     as aft_hdv_cst_magr_nm
	,t1.aft_hdv_mgr_org_no                       --移交后管户机构编号|c12
	,t1.hdv_typ_cd                               --移交类型代码|c1
	,t1.dlve_mod_cd                              --移交方式代码|c1
	,t1.aply_dt                                  --申请日期|c8
	,t1.sys_reg_tm                               --系统登记时间|c26
    ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY  T1.sys_reg_tm aSC) AS rn_asc
    ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY  T1.sys_reg_tm DESC) AS rn_desc
from edw.dwd_cst_mng_loan_mng_hdv_rcd_dd  t1     --管户交接记录
inner join(
    select distinct col_7 as cst_id
    from SJXQ_SJ2025042991_CST_01
)t2 on t1.cst_id=t2.cst_id
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.aft_hdv_cst_magr_id=t3.empe_id
and t3.dt='20250430'
where t1.dt='20250430'
;
-- 实地走访
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_12 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.svy_addr                 --调查地址
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
where t1.dt='20250430'
and t1.svy_mod_cd='01'  --现场（实地）
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025042991_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042991_CST_13 AS
SELECT  t1.col_57 AS 经办机构名称
       ,t1.col_52 AS 经办客户经理
       ,t1.col_55 AS 经办审查人
       ,t3.团队总经理
       ,t3.审批支行行长
       ,t1.col_56 AS 最终审批人
       ,t1.col_2  AS 合同流水号
       ,t1.col_7  AS 核心客户编号
       ,t1.col_8  AS 客户名称
       ,t2.业务标识
       ,t1.col_9  AS 余额
       ,t1.col_51 AS 担保分类
       ,t2.最长一笔借据的期限
       ,t2.产品名称
       ,t2.循环类型
       ,t1.初始合同号1循环类型
       ,t1.初始合同号2循环类型
       ,t2.发生类型
       ,t1.col_36 as 初始合同号1发生类型
       ,t1.col_39 as 初始合同号2发生类型
       ,t2.行业
       ,CASE WHEN t22.age < 20 THEN '20岁以下'
             WHEN t22.age >= 20 AND t22.age <= 50 THEN '20-50岁'
             WHEN t22.age > 50 THEN '50岁以上'  ELSE '' END            AS 年龄区间
       ,t4.经营地址行政区划
       ,t4.户籍地址行政区划
       ,t2.是否家园贷
       ,c1.cd_val_dscr                                             AS 婚姻状况
       ,t5.配偶我行是否有未结清授信
       ,t5.配偶我行贷款余额
       ,t6.is_crdt                                                 AS 担保人1我行是否有未结清授信
       ,t6.ctr_bal                                                 AS 担保人1我行贷款余额
       ,t7.is_crdt                                                 AS 担保人2我行是否有未结清授信
       ,t7.ctr_bal                                                 AS 担保人2我行贷款余额
       ,t8.is_crdt                                                 AS 担保人3我行是否有未结清授信
       ,t8.ctr_bal                                                 AS 担保人3我行贷款余额
       ,t9.is_crdt                                                 AS 担保人4我行是否有未结清授信
       ,t9.ctr_bal                                                 AS 担保人4我行贷款余额
       ,t10.is_crdt                                                AS 担保人5我行是否有未结清授信
       ,t10.ctr_bal                                                AS 担保人5我行贷款余额
       ,t2.客户首笔准入时间
       ,t2.首次出险日期
       ,t1.col_49                                                  AS 是否风险贷款
       ,t11.scor_rng                                               AS 出险业务准入时客户征信分数段
       ,t12.rul_set_rslt_nm                                        AS 出险业务发放时预评估结果
       ,t12.PRE_ASES_rul_nm                                        AS 出险业务发放时预评估触发规则
       ,t12.PRE_ASES_prmpt_msg                                     AS 出险业务发放时预评估提示信息
       ,T13.tsk_gen_dt                                             AS 第一次处置类精准贷后时间
       ,t13.rul_nm                                                 AS 第一次处置类精准贷后触发规则
       ,T14.tsk_gen_dt                                             AS 最后一次处置类精准贷后时间
       ,t15.最后一次精准贷后的类型
       ,t14.rul_nm                                                 AS 最后一次处置类精准贷后触发规则
       ,t2.合同额度区间
       ,CASE WHEN t16.ctr_amt <= 300000 THEN '[0,30w]'
             WHEN t16.ctr_amt > 300000 AND t16.ctr_amt <= 500000 THEN '(30w,50w]'
             WHEN t16.ctr_amt > 500000 AND t16.ctr_amt <= 1000000 THEN '(50w,100w]'
             WHEN t16.ctr_amt > 1000000 THEN '100万以上'  ELSE '' END AS 单户额度区间
       ,t2.sam_rsk_ctrl_id                                         AS 同一风险控制号
       ,CASE WHEN t17.ctr_amt <= 300000 THEN '[0,30w]'
             WHEN t17.ctr_amt > 300000 AND t17.ctr_amt <= 500000 THEN '(30w,50w]'
             WHEN t17.ctr_amt > 500000 AND t17.ctr_amt <= 1000000 THEN '(50w,100w]'
             WHEN t17.ctr_amt > 1000000 THEN '100万以上'  ELSE '' END AS 同一风险控制号额度区间
       ,t18.svy_addr                                               AS 实地走访地址
       ,t18.pcp_psn_nm                                             AS 实地走访人员
       ,t19.aft_hdv_cst_magr_nm                                    AS 交接人1
       ,t19.sys_reg_tm                                             AS 交接人1交接时间
       ,t20.aft_hdv_cst_magr_nm                                    AS 交接人2
       ,t20.sys_reg_tm                                             AS 交接人2交接时间
       ,t21.aft_hdv_cst_magr_nm                                    AS 最近交接人
       ,t21.sys_reg_tm                                             AS 最近1笔交接时间
FROM SJXQ_SJ2025042991_CST_01      t1
LEFT JOIN SJXQ_SJ2025042991_CST_02 t2
ON t1.col_2 = t2.ctr_serno
LEFT JOIN SJXQ_SJ2025042991_CST_03 t3
ON t1.col_2 = t3.ctr_serno
LEFT JOIN SJXQ_SJ2025042991_CST_04 t4
ON t1.col_7 = t4.cst_id
LEFT JOIN SJXQ_SJ2025042991_CST_05 t5
ON t1.col_7 = t5.cst_id
LEFT JOIN SJXQ_SJ2025042991_CST_06 t6
ON t1.col_2 = t6.ctr_serno AND t6.rn = 1
LEFT JOIN SJXQ_SJ2025042991_CST_06 t7
ON t1.col_2 = t7.ctr_serno AND t7.rn = 2
LEFT JOIN SJXQ_SJ2025042991_CST_06 t8
ON t1.col_2 = t8.ctr_serno AND t8.rn = 3
LEFT JOIN SJXQ_SJ2025042991_CST_06 t9
ON t1.col_2 = t9.ctr_serno AND t9.rn = 4
LEFT JOIN SJXQ_SJ2025042991_CST_06 t10
ON t1.col_2 = t10.ctr_serno AND t10.rn = 5
LEFT JOIN SJXQ_SJ2025042991_CST_07 t11
ON t1.col_2 = t11.ctr_serno AND t11.rn = 1
LEFT JOIN SJXQ_SJ2025042991_CST_08 t12
ON t1.col_2 = t12.ctr_serno
LEFT JOIN SJXQ_SJ2025042991_CST_09 t13
ON t1.col_7 = t13.cst_id AND t13.rn_asc = 1
LEFT JOIN SJXQ_SJ2025042991_CST_09 t14
ON t1.col_7 = t14.cst_id AND t14.rn_desc = 1
LEFT JOIN SJXQ_SJ2025042991_CST_10 t15
ON t1.col_7 = t15.cst_id AND t15.rn = 1
LEFT JOIN
(
	SELECT  cst_id
	       ,SUM(ctr_amt) AS ctr_amt
	FROM SJXQ_SJ2025042991_CST_02 t1
    where ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
	GROUP BY  cst_id
)t16
ON t1.col_7 = t16.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
	       ,SUM(ctr_amt) AS ctr_amt
	FROM SJXQ_SJ2025042991_CST_02 t1
    where ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
	GROUP BY  sam_rsk_ctrl_id
)t17
ON t2.sam_rsk_ctrl_id = t17.sam_rsk_ctrl_id
LEFT JOIN SJXQ_SJ2025042991_CST_12 t18
ON t1.col_7 = t18.cst_id AND t18.rn = 1
LEFT JOIN SJXQ_SJ2025042991_CST_11 t19
ON t1.col_7 = t19.cst_id AND t19.rn_asc = 1
LEFT JOIN SJXQ_SJ2025042991_CST_11 t20
ON t1.col_7 = t20.cst_id AND t20.rn_asc = 2
LEFT JOIN SJXQ_SJ2025042991_CST_11 t21
ON t1.col_7 = t21.cst_id AND t21.rn_desc = 1
LEFT JOIN adm_pub.adm_csm_cbas_idv_bas_inf_dd   t22 --对私客户基础信息
ON t1.col_7 = t22.cst_id AND t22.dt = '20250430'
LEFT JOIN edw.dwd_code_library_dd               c1
ON t22.MRG_SITU_CD = c1.CD_VAL
AND c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND c1.FLD_NM = 'MRG_SITU_CD'
AND c1.dt = '20250430'
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs   --合同
from SJXQ_SJ2025042991_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042991_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042991_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042991_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042991_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042991_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042991_CST_07 where rn=1
union all
SElECT '08' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025042991_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042991_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042991_CST_10 where rn=1
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042991_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042991_CST_12 where rn=1
union all
SElECT '13' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025042991_CST_13
;
/*
01	752	487
02	1018805	1018805
03	967813	967813
04	6898256	6898256
05	717271	716543
06	1195578	718177
07	780052	780052
08	436	436
09	184561	102888
10	448705	448705
11	1552620	526778
12	1590639	1590639
13	752	487
*/
***许海萍_SJ2025012421_宁波分行外呼反馈情况.sql
﻿-- 2月4日一年期存款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025012421_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012421_CST_01 AS
SElECT t1.cst_id
    ,t2.brc_org_nm
        then gl_bal else 0 end) as gl_bal  --账户总账余额
FROM edw.dws_bus_dep_act_inf_dd             T1             -- 存款账户信息表
left join edw.dim_hr_org_mng_org_tree_dd    t2             --考核机构树 4481 org_id 唯一
on      t1.opn_org = t2.org_id
and     t2.dt = '20250204'
WHERE   T1.DT = '20250204'
and     t2.brc_org_nm = '宁波分行'
group by t1.cst_id,t2.brc_org_nm
;
-- 1月19日一年期存款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2025012421_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012421_CST_02 AS
SElECT t1.cst_id
    ,sum(t1.gl_bal) as   gl_bal                                 --账户总账余额
FROM edw.dws_bus_dep_act_inf_dd             T1             -- 存款账户信息表
left join edw.dim_hr_org_mng_org_tree_dd    t2             --考核机构树 4481 org_id 唯一
on      t1.opn_org = t2.org_id
and     t2.dt = '20250204'
WHERE   T1.DT = '20250119'
-- and     T1.ACT_STS_CD <>'C'         -- 账户状态
and     t2.brc_org_nm = '宁波分行'
group by t1.cst_id
;
-- 1月19-2月4日期间3年挂钩型理财购买金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025012421_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012421_CST_03_1 AS
select pd_cd                                    --产品代码|C24
	,pd_nm                                    --产品名称|C256
    ,pd_val_dt
	,pd_found_dt                              --产品成立日期|C8
	,pd_end_dt                                --产品结束日期|C8
	,actl_found_dt                            --实际成立日期|C8
    ,DATEDIFF(TO_DATE(pd_end_dt,'yyyyMMdd'),TO_DATE(pd_val_dt,'yyyyMMdd'),'dd') as trm_days
    ,round(DATEDIFF(TO_DATE(pd_end_dt,'yyyyMMdd'),TO_DATE(pd_val_dt,'yyyyMMdd'),'dd')/365,0) as y_trm
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='20250204'
and (pd_nm REGEXP '挂钩型' or (ta_cd <> 'TL' and pd_nm REGEXP '钱潮'))  --挂钩型理财新口径
and pd_sts_cd<>'3'              --发行失败
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025012421_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012421_CST_03 AS
SELECT t1.srl_nbr,T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,C1.cd_val_dscr bus_nm
    ,T1.pd_cd                                    --产品代码|C20
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                 T1 --理财交易确认流水明细
INNER JOIN SJXQ_SJ2025012421_CST_03_1               t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
and t2.y_trm=3
left join edw.dwd_code_library_dd                   c1
on t1.bus_cd=c1.cd_val
and c1.dt='20250204'
where T1.DT<='20250204'
and t1.trx_dt>='20240101'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025012421_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025012421_CST_04 AS
SElECT t1.cst_id        as 客户号
    ,t6.cst_chn_nm      as 客户名称
    ,t2.gl_bal          as 1月19日一年期存款余额
    ,t1.gl_bal          as 2月4日一年期存款余额
    ,t4.dmnd_dep_bal	as 1月19日活期存款余额
    ,t5.dmnd_dep_bal	as 2月4日活期存款余额
    ,t3.gglc_amt        as 1月19到2月4日期间3年挂钩型理财购买金额
from SJXQ_SJ2025012421_CST_01       t1
left join SJXQ_SJ2025012421_CST_02  t2
on t1.cst_id=t2.cst_id
left join(
    select cst_ID,sum(CFM_AMT) as gglc_amt
    from SJXQ_SJ2025012421_CST_03
    where trx_dt between '20250119' and '20250204'
    group by cst_ID
)  t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbus_dep_inf_dd	t4 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250119'
left join adm_pub.adm_csm_cbus_dep_inf_dd	t5 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250204'
left join edw.dws_cst_bas_inf_dd 			t6	    --客户基础信息汇总表
on  t1.cst_id=t6.cst_id
and t6.dt='20250204'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012421_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012421_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025012421_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025012421_CST_04
;
select count(t1.cst_id)
from SJXQ_SJ2025012421_CST_01 t1
inner join SJXQ_SJ2025012421_CST_02 t2
on t1.cst_ID=t2.cst_id
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2025012421_CST_04
***诸银君_SJ20250807131_宁波逾期业务信息.sql
-- 诸银君_SJ20250807131_宁波逾期业务信息
-- 客群
DROP   TABLE IF EXISTS SJXQ_SJ20250807131_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250807131_CST_01
(
    seq         string COMMENT '序号'
    ,ctr_serno  string COMMENT '合同流水号/账户号'
    ,CST_ID     string COMMENT '客户号'
    ,cst_nm     string COMMENT '客户名称'
    ,cst_role       string COMMENT '角色'
)
;
insert into SJXQ_SJ20250807131_CST_01
;
--保证人
DROP   TABLE IF     EXISTS SJXQ_SJ20250807131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250807131_CST_02 AS
select t1.seq,t1.ctr_serno
    ,t2.grnt_ctr_no                              --担保合同编号|c32
    ,nvl(t3.gtor_no,t4.OBG_ID) as 保证人编号
    ,nvl(t3.gtor_nm,t4.OBG_NM) as 保证人名称
from SJXQ_SJ20250807131_CST_01              t1
inner join edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20250807'
left JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='20250807'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20250807'
) t4 on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
;
-- 结果表
DROP   TABLE IF     EXISTS SJXQ_SJ20250807131_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250807131_CST_03 AS
SELECT  t1.seq       AS 序号
       ,t1.ctr_serno AS 合同流水号
       ,t1.CST_ID    AS 客户号
       ,t1.cst_nm    AS 客户名称
       ,t1.cst_role  AS 角色
       ,t2.doc_nbr   AS 证件号码
from (
    select seq,ctr_serno,CST_ID,CST_nm,cst_role
    from SJXQ_SJ20250807131_CST_01
    union all
    select seq,ctr_serno,保证人编号,保证人名称,'担保人'
    from SJXQ_SJ20250807131_CST_02
)t1 left join edw.dws_cst_bas_inf_dd t2 --客户基础信息汇总表
on t1.CST_ID=t2.cst_id
and t2.dt='20250807'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250807131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250807131_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250807131_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20250807131_CST_03
***谭蕾_SJ20250717141_经营项目地址验证.sql
﻿-- 谭蕾_SJ20250717141_经营项目地址验证
-- 导入客户名单
DROP   TABLE IF EXISTS SJXQ_SJ20250717141_01 PURGE;
CREATE TABLE           SJXQ_SJ20250717141_01
(
    cst_id      string COMMENT ''
    ,cst_nm     string COMMENT ''
)
;
insert into SJXQ_SJ20250717141_01
;
--关联企业名称
DROP   TABLE IF     EXISTS SJXQ_SJ20250717141_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250717141_02 AS
select t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
    ,c1.cd_val_dscr     as 客户类型
    ,t8.cst_nm	        as 关联企业名称
    ,t4.opr_prj         AS 经营项目
from edw.loan_cst_bsc       t1                     --客户基本信息
--如果是其他对私客户就查cst_rel表里rel_psn_typ = '6'--经营企业
LEFT JOIN edw.loan_cst_rel  T3 --关系人信息
ON      T1.cst_id = T3.cst_id
and     t3.DEL_IND = '0'
AND     T3.rel_psn_typ = '6' --经营企业
AND     T3.DT = t1.dt
LEFT JOIN edw.loan_cst_opr_bsc  t4
on  T3.rel_cst_id=t4.cst_id
and t4.DEL_IND = '0'
and t4.dt=t1.dt
LEFT JOIN edw.loan_cst_corp_bsc T8 --企业基本信息
ON      T3.rel_cst_id = T8.cst_id
and     t8.DEL_IND = '0'
AND     T8.dt = t1.dt
left join edw.dwd_code_library_dd c1
on t1.cst_typ = c1.cd_val
and c1.dt = t1.dt
where t1.dt='20250721'
and t1.del_ind='0'
and t1.cst_typ NOT IN ( '03' , '05' )
union all
SELECT  t1.cst_id      --客户号
       ,t1.cst_typ     --客户类型
       ,c1.cd_val_dscr AS 客户类型
       ,null
       ,t2.opr_prj     AS 经营项目
from edw.loan_cst_bsc           t1 --客户基本信息
LEFT JOIN edw.loan_cst_opr_bsc  t2
on t1.cst_id=t2.cst_id
and t2.DEL_IND = '0'
and t2.dt=t1.dt
left join edw.dwd_code_library_dd c1
on t1.cst_typ = c1.cd_val
and c1.dt = t1.dt
where t1.dt='20250721'
and t1.del_ind='0'
and t1.cst_typ IN ( '03' , '05' )
;
-- 现场实地调查
DROP   TABLE IF     EXISTS SJXQ_SJ20250717141_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250717141_03 AS
SELECT t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.svy_dt                   --调查日期|C8
    ,t1.adiv                     --行政区划|C12
    ,concat(c2.cd_val_dscr,'-',c3.cd_val_dscr,'-',c4.cd_val_dscr) as 行政区划
    ,t1.svy_addr                 --调查地址
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c1.cd_val_dscr          as 调查地址类型
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_ADDR_TYP_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c1.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      concat(SUBSTR(t1.adiv,1,2),'0000') = c2.CD_VAL
AND     c2.TBL_NM = 'DWD_BUS_LOAN_SVY_CST_OPR_PLC_DD'
AND     c2.FLD_NM = 'ADIV_CD'
and     c2.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c3
ON      concat(SUBSTR(t1.adiv,1,4),'00') = c3.CD_VAL
AND     c3.TBL_NM = 'DWD_BUS_LOAN_SVY_CST_OPR_PLC_DD'
AND     c3.FLD_NM = 'ADIV_CD'
and     c3.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c4
ON      SUBSTR(t1.adiv,1,6) = c4.CD_VAL
AND     c4.TBL_NM = 'DWD_BUS_LOAN_SVY_CST_OPR_PLC_DD'
AND     c4.FLD_NM = 'ADIV_CD'
and     c4.dt=t1.dt
where t1.dt='20250721'
and t1.svy_mod_cd='01' --01:现场（实地）
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250717141_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250717141_04 AS
SELECT  t1.cst_id   AS 客户号
       ,t1.cst_nm   AS 客户名称
       ,t2.客户类型
       ,t2.关联企业名称
       ,COALESCE(t2.经营项目,t4.opr_prj) as 经营项目
       ,t3.svy_dt   AS 调查日期
       ,t3.行政区划
       ,t3.svy_addr AS 调查地址
       ,t3.调查地址类型
from SJXQ_SJ20250717141_01 t1
left join SJXQ_SJ20250717141_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20250717141_03 t3
on t1.cst_id=t3.cst_id
and t3.rn=1
LEFT JOIN edw.loan_cst_opr_bsc  t4
on t1.cst_id=t4.cst_id
and t4.DEL_IND = '0'
and t4.dt='20250721'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250717141_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250717141_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250717141_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250717141_04
;
SElECT '04' seq, *
from SJXQ_SJ20250717141_04
;
***赵凯雯_SJ20250805146_嘉兴分行存量客户.sql
-- 赵凯雯_SJ20250805146_嘉兴分行存量客户
/*
数据日期：截止7月31日
数据范围：嘉兴分行管护客户
取数口径：户籍地、居住地、经营地、工作地中有任一地址包含&ldquo;探花苑&rdquo;、&ldquo;水仙坊&rdquo;、&ldquo;石榴坊&rdquo;、&ldquo;园乐新村&rdquo;、&ldquo;园乐新村&rdquo;、&ldquo;启元小区&rdquo;、&ldquo;嘉州美都&rdquo;小区名的建档客户清单
*/
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ20250805146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250805146_CST_01 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t1.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t1.fml_adr                                  --家庭地址|C256
    ,t1.file_dt	        --建档日期|C8
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
    ,t3.forml_cst_ind                            --正式客户标识
from edw.dws_cst_bas_inf_dd                 t1 --客户基础信息汇总表
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '嘉兴分行'
where t1.dt='20250731'
and t1.file_dt > '18991231'     --建档客户
and concat(t1.reg_adr,t1.wrk_adr,t1.fml_adr) regexp '探花苑|水仙坊|石榴坊|园乐新村|园乐新村|启元小区|嘉州美都'
;
--结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250805146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250805146_CST_02 AS
SELECT  t1.cst_id        AS 客户号
       ,t1.cst_chn_nm    AS 客户姓名
       ,t1.reg_adr       AS 户籍地址
       ,t1.wrk_adr       AS 工作单位或经营所在地
       ,t1.fml_adr       AS 家庭地址
       ,t1.file_dt       AS 建档日期
       ,t1.prm_mgr_id    AS 主管护客户经理工号
       ,t1.prm_mgr_nm    AS 主管护客户经理姓名
       ,t1.prm_org_id    AS 主管护机构号
       ,t1.prm_org_nm    AS 主管户机构名称
       ,t1.forml_cst_ind AS 正式客户标识
       ,t6.sub_cmnt_id   AS 普惠子社区编号
       ,t7.cmnt_nm       AS 普惠子社区名称
       ,t3.vld_cst       AS 有效户
       ,t9.val_cst       AS 价值客户
from SJXQ_SJ20250805146_CST_01 t1
left join adm_ind.adm_ind_l_rul_unvs_cmpn_chrst_l3_dd t3 --客户规则类通用营销特性表3
on t1.cst_id=t3.cst_id
and t3.dt='20250731'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20250731'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20250731'
left join adm_ind.adm_ind_l_rul_unvs_cst_val_l4_dd	    t9 --客户通用风险评估标签表4
on t1.cst_id=t9.cst_id
and t9.dt='20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250805146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250805146_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20250805146_CST_02
***赵卓群_SJ2025070296_苏州分行合规检查.sql
﻿-- 赵卓群_SJ2025070296_苏州分行合规检查
/*
开户信息包含国家机关/国企等政府机构。工作单位或地址关键词：局、厅、委、部、处、科、办公室、政府、党委、组织部、宣传部、纪委、法院、检察院、常委会、政协、管委会、街道等。
同时存在以下交易特征之一：
1、同一账户柜面或ATM累计存现金额 &ge; 100万。
2、单日或多次存入现金，单次金额均&le;5万元且7日内累计&ge;20万元。 --改成：自然周内每一笔存现小于等于5万，累计大于等于20万。
-- 3、多网点多次存入现金，单次金额均&le;5万元且7日内累计&ge;20万元。 --暂不取
4、账户流水中收取手续费笔数超过10笔/月。--看下备注里有没有手续费 摘要、对手名称含手续费
-- 5、交易IP地址非居住地或者工作地且存现&ge;10万元、投保单笔&ge;50万元。  --暂不取
6、月均&ge;3次交易IP为境外，且交易对手名称或备注中包含酒店、会所、奢侈品等。即境外交易累计大于等于54次
7、单月境外取现次数&ge;2次，且每次均接近等值1万美元。9000-11000美元之间
8、现金购买理财或贵金属单笔&ge;20万元。
9、现金偿还信用卡&ge;10万元。
10、现金支付房产首付/房款/保费。--存现并且备注是房产首付或房款或保费
11、账户发生资金备注为：股权转让款、分红款等交易。
12、交易对手名称中包含拍卖行、房地产、酒店等关键词。
13、被有权机关查冻扣的后三天以内，账户发生大额转账/取现，单笔金额&ge;20万元。
14、非工作时间（夜间00：00-6：00/节假日周六日和法定节假日）交易占比&ge;总交易笔数30%。
15、春节或国庆周六日等法定节日前一周集中存款或投保金额&ge;日常月均5倍。日常月均取年日均.存款或投保金额?
16、账户大额入账&ge;50万元后，90%以上资金在7日内取现或消费或投资，并且余额趋零后立即销户或休眠。  余额趋零指1元以内1周以内销户
-- 17、账户开户时间&le;6个月，且期间资金快进快出（月均流水&ge;账户峰值余额&times;5）。 --暂不取
*/
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_01 AS
select t1.cst_id,t1.opn_dt
    ,t2.cst_chn_nm
    ,t2.cst_typ_cd
	,t2.reg_adr                                  --户籍地址|注册地址|C256
	,t2.cmn_adr                                  --通讯地址|C256
	,t2.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t2.fml_adr                                  --家庭地址|C256
	,t3.prm_mgr_id                               --主管护客户经理工号
	,t3.prm_mgr_nm                               --主管护客户经理姓名
	,t3.prm_org_id                               --主管护机构号
	,t3.prm_org_nm                               --主管户机构名称
	,t3.ln_mgr_id                                --信贷归属客户经理
	,t3.ln_mgr_nm                                --信贷归属客户经理名称
	,t3.ln_org_id                                --信贷归属机构
	,t3.ln_org_nm                                --信贷归属机构名称
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from(
    select cst_id,min(opn_dt) as opn_dt
    from edw.dim_bus_dep_act_inf_dd         --存款账户信息
    where dt='20250701'
    GROUP BY cst_id
)t1 inner join edw.dws_cst_bas_inf_dd t2    --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20250701'
and concat(t2.reg_adr,t2.cmn_adr,t2.wrk_adr,t2.fml_adr) regexp '局|厅|委|部|处|科|办公室|政府|党委|组织部|宣传部|纪委|法院|检察院|常委会|政协|管委会|街道'
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250701'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250701'
and t4.brc_org_nm='苏州分行'
;
-- 网银各渠道汇总流水信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_02 AS
SELECT t1.*
	,t2.trx_srl_nbr,t2.trx_dt
from(
	select t1.chnl_typ_cd                              --渠道类型代码|C2
		,t1.trx_seq                                  --交易流水号|C20
		,t1.cst_id                                   --客户号|C10
		,t1.trx_cd                                   --交易代码|C6
		,t1.pmt_act_id                               --付款方账号|C30
		,t1.pmt_act_nm                               --付款方户名|C200
		,t1.rcv_act_id                               --收款方账号|C32
		,t1.rcv_act_nm                               --收款方户名|C200
		,t1.rcv_opn_bnk                              --收款方开户行|C300
		,t1.ccy_cd                                   --币种|C3
		,t1.usr_sbm_tm                               --用户提交时间|C14
		,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
		,t1.rcv_cmsn_fee		--应收手续费
		,t1.usr_cmt                                  --用户备注|C256
		,t1.late_upd_tm	                             --最后更新时间|C20
		,t1.glbl_srl_nbr	                         --全局流水号|C40
		,t1.cst_end_ip                               --客户端ip|C100
		,t1.ovs_ind                                  --境外标志|C1
		,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
		,t1.cnr_nm                                   --国家名称|C200
		,t1.pvc_nm                                   --省份名称|C200
		,t1.cty_nm                                   --城市名称|C200
		,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)  AS 交易对方所在国家或地区
		,CASE
			WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
			WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
			WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
			END                                                    AS MAC或IMEI地址
		,CASE
			WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
			WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
			WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
			END                                                    AS IP地址
		,'个人' as data_src,t1.dt
		,t1.hst_rtn_err_cd,t1.hst_rtn_err_dscr
	from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di  t1 --个人网银各渠道汇总流水信息
	inner join(
		select distinct cst_id
		from SJXQ_SJ2025070296_CST_01
	) t5 on t1.cst_id=t5.cst_id
	where t1.dt BETWEEN '20240101' and '20250701'
	and t1.hst_rtn_err_dscr regexp '处理成功'
	union all
	select t1.chnl_typ_cd                              --渠道类型代码|C2
		,t1.trx_seq                                  --交易流水号|C20
		,t1.cst_id                                   --客户号|C10
		,t1.trx_cd                                   --交易代码|C6
		,t1.pmt_act_id                               --付款方账号|C30
		,t1.pmt_act_nm                               --付款方户名|C300
		-- ,pmt_org_id                               --付款方网点|C10
		,t1.rcv_act_id                               --收款方账号|C32
		,t1.rcv_act_nm                               --收款方户名|C300
		,t1.rcv_opn_bnk                              --收款方开户行|C300
		-- ,rcv_opn_bnk_cnaps                        --收款方开户行联行号|C12
		,t1.ccy_cd                                   --币种|C3
		,t1.usr_sbm_tm                               --用户提交时间|C14
		,t1.trx_amt                                  --交易金额|DECIMAL(18,2)
		,t1.rcv_cmsn_fee                             --应收手续费|DECIMAL(18,2)
		,t1.usr_cmt                                  --用户备注|C256
		-- ,instr_sts_cd                             --指令状态代码|C2
		,t1.late_upd_tm                              --最后更新时间|C20
		,t1.glbl_srl_nbr	--	全局流水号|C40
		,t1.cst_end_ip                               --客户端ip|C100
		,t1.ovs_ind                                  --境外标志|C1
		,decode(t1.ovs_ind,'0','否','1','是') as 跨境交易标识
		,t1.cnr_nm                                   --国家名称|C200
		,t1.pvc_nm                                   --省份名称|C200
		,t1.cty_nm                                   --城市名称|C200
		,IF(t1.cnr_nm = '中国', concat(t1.pvc_nm, ' ', t1.cty_nm), t1.cnr_nm)                 AS 交易对方所在国家或地区
		,CASE
			WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 1)
			WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 1)
			WHEN t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN t1.cst_end_ip
			END                                                    AS mac
		,CASE
			WHEN t1.cst_end_ip REGEXP '@'                                                                                 THEN split_part(t1.cst_end_ip, '@', 2, 100)
			WHEN t1.cst_end_ip REGEXP ':' AND t1.cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR t1.cst_end_ip REGEXP '^null:' THEN split_part(t1.cst_end_ip, ':', 2, 100)
			WHEN t1.cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN t1.cst_end_ip
			END                                                    AS ip
		,'企业' as data_src,t1.dt
		,t1.hst_rtn_err_cd,t1.hst_rtn_err_dscr
	from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di t1 --企业网银各渠道汇总流水信息
	inner join SJXQ_SJ2025070296_CST_01 t5
	on t1.cst_id=t5.cst_id
	where t1.dt BETWEEN '20240101' and '20250701'
	and t1.hst_rtn_err_dscr regexp '处理成功'
	and nvl(t1.glbl_srl_nbr,'')<>''
)t1 INNER JOIN(
	SELECT distinct glbl_srl_nbr,trx_srl_nbr,trx_dt
	from edw.dwd_bus_com_core_trx_msg_inf_di 	--核心交易报文信息
	where dt between '20240101' and '20250701'
	and nvl(trx_srl_nbr,'')<>''
)T2 ON  T1.glbl_srl_nbr = T2.glbl_srl_nbr --柜员流水与交易流水关联
;
-- 客户2024年以来交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_03 AS
select t1.dep_act_id                               --存款账号|C32
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
	,t1.trx_dt                                   --交易日期|C8
	,substr(t1.trx_dt,1,6) as trx_mon
	,t1.trx_tm                                   --交易时间|C9
	,t1.crd_and_dbt_ind                          --借贷标志|C1
	,t1.trx_ccy_cd                               --交易币种代码|C3
	,t1.trx_amt                                  --交易金额
    ,T1.trx_amt * T5.usd_exr                     AS 折美元交易金额
	,t1.act_bal                                  --账户余额
    ,t2.cst_id,t3.cst_chn_nm,t3.cst_typ_cd
	,t1.cst_act_id                               --客户账号|C32
    ,t1.act_nm
	,t1.txt_code                                 --摘要代码|C10
	,t1.smr_dscr                                 --摘要描述|C512
	,t1.trx_chnl_cd                              --交易渠道代码 A01柜面 C01-ATM
    ,c1.cd_val_dscr as trx_chnl_nm
	,t1.csh_ind                                  --现转标志|C1
	,t1.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t1.tlr_srl_nbr                              --柜员流水号|C32
	,t1.trx_bus_org                              --交易营业机构|C12
	,t1.cmt                                      --备注|C200
    ,t1.bal_fld_nm	                             --余额字段名称
    ,case WHEN T1.CSH_IND = '1' AND T1.CRD_AND_DBT_IND = 'C' THEN '转入'
        WHEN T1.CSH_IND = '1' AND T1.CRD_AND_DBT_IND = 'D' THEN '转出'
        WHEN T1.CSH_IND = '0' AND T1.CRD_AND_DBT_IND = 'C' THEN '存现'
        WHEN T1.CSH_IND = '0' AND T1.CRD_AND_DBT_IND = 'D' THEN '取现' else '' END as trx_type
    ,case WHEN t1.crd_and_dbt_ind='D' and T1.TXT_CODE IN ( 'DC0068' , 'DC0069' , 'DC0070' , 'DC0071' , 'DC0072' , 'DC0073' , 'DC0074' , 'DC0075' , 'DC0076'
            , 'DC0077' , 'DC0078' , 'DC0079' , 'DC0080' , 'DC0081' , 'NS0001' , 'NS0002' , 'ZF0046' , 'DC0107' , 'DC0109' , 'YL0011'
            , 'YL0012' , 'YL0013' , 'YL0014' , 'ZF0001' , 'ZF0002' , 'ZF0003' , 'ZF0004' , 'ZF0005' , 'ZF0006' , 'ZF0007' , 'ZF0008'
            , 'ZF0009' , 'ZF0010' , 'ZF0011' , 'KJ0001' , 'KJ0002' , 'KJ0003' , 'KJ0010' , 'WG0001' , 'NSDC01' , 'NSDC02' , 'NSDC04'
            , 'NSDC05' , 'WWB010' , 'WWB011' , 'WWB012' , 'YL1003' , 'YL1006' , 'YL1012' , 'YL1013' , 'IB0023' , 'IB0024' , 'THS001'
            , 'THS002' , 'XF0001' , 'XF0002' , 'XF0003' , 'XF0004' , 'YL0403' , 'YL0504' , 'THS004' , 'THS005' , 'THS007' , 'THS008'
            , 'TY1919' , 'TY1921' ) THEN '消费'
        WHEN t1.crd_and_dbt_ind='D' and T1.TXT_CODE IN ( 'TY0023' , 'TY0024' , 'TY0025' , 'TY0026' , 'TY0061' , 'TY0062' , 'TY0063' , 'TY0064' , 'TY0090'
            , 'C201' , 'TY0081' , 'TY0082' ,'TY0168' , 'TY0148' , 'TY1790' , 'TY1792'
            ,'DP0217' , 'FD0001' , 'LC0001' , 'LC0006' , 'TY0159' , 'TY1930' , 'FD0002' , 'FD0010' , 'FD0012' , 'TY0161' , 'ZHB001' , 'DKYS01'
            , 'DPW033' , 'DP0700' , 'DP2124' , 'DPWT34') THEN '投资' else '' end cost_invst
            , '20241012', '20250126', '20250208', '20250427') then 0    --上班-周末调休
        when WEEKDAY(to_date(t1.trx_dt, 'yyyymmdd')) < 5 then 0     --正常上班日 0:周一 6:周日
        ,'20240502','20240503','20240610','20240916','20240917','20241001','20241002','20241003','20241004','20241007') then 1 --2024上班日放假
            , '20250501', '20250502', '20250505', '20250602')   then 1  --2025上班日放假
        when WEEKDAY(to_date(t1.trx_dt, 'yyyymmdd')) >=5  then 1    --周末放假
        else -1 end is_holiday
    ,WEEKDAY(to_date(t1.trx_dt, 'yyyymmdd')) as WEEK_DAY
    ,case when substr(t1.trx_tm,1,2)<'06' then 1 else 0 end as is_night_trx
	,t4.usr_sbm_tm                               --用户提交时间|C14
	,t4.trx_amt                                  as 交易金额_网银
	,t4.rcv_cmsn_fee		--应收手续费
	,t4.ovs_ind
	,t4.跨境交易标识
	,t4.cnr_nm
	,t4.pvc_nm
	,t4.cty_nm
	,t4.交易对方所在国家或地区
	,t4.mac或imei地址
	,t4.ip地址
	,T6.mgr_id        as 账号管户客户经理编号
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细
inner join edw.dim_bus_dep_act_inf_dd   t2 --存款账户信息
on t1.dep_act_id=t2.dep_act_id
and t2.dt='20250701'
inner join SJXQ_SJ2025070296_CST_01     t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2025070296_CST_02 		t4
ON      T1.tlr_srl_nbr = T4.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T4.trx_dt
LEFT JOIN edw.dim_bus_com_exr_inf_dd 	T5 --汇率信息
ON      T1.trx_ccy_cd = T5.ccy_cd
and     t5.dt='20250701'
left JOIN  edw.dwd_bus_dep_cst_act_mgr_inf_dd T6
ON  T1.cst_act_id =T6.cst_act_id
and T6.dt='20250701'
and T6.frs_ctc_ind = '1' 	--第一联系人标志
LEFT JOIN    edw.dwd_code_library_dd    c1 -- 码值表
ON      T1.trx_chnl_cd = c1.cd_val
AND     c1.DT = '20250701'
where t1.dt between '20240101' and '20250701'
;
-- 1、同一账户柜面或ATM累计存现金额 &ge; 100万。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_01 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
	   ,t2.24年至今累计存现金额
FROM SJXQ_SJ2025070296_CST_03 t1
inner join (
	select cst_act_id,sum(trx_amt) as 24年至今累计存现金额
	from SJXQ_SJ2025070296_CST_03
	and trx_type = '存现'
	group by cst_act_id having sum(trx_amt)>=1000000
)t2 on t1.cst_act_id=t2.cst_act_id
and t1.trx_type = '存现'
;
-- 2、单日或多次存入现金，单次金额均&le;5万元且7日内累计&ge;20万元。 --改成：自然周内每一笔存现小于等于5万，累计大于等于20万。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_02 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t2.week_rn              AS 当年周次
       ,t2.tot_amt              AS 周累计存现金额
FROM SJXQ_SJ2025070296_CST_03 t1
inner join (
	select cst_act_id,week_rn,sum(trx_amt) as tot_amt
	from SJXQ_SJ2025070296_CST_03
	where trx_type = '存现'
	group by cst_act_id,week_rn
	having max(trx_amt) <= 50000 and sum(trx_amt)>=200000
)t2 on t1.cst_act_id=t2.cst_act_id
and t1.week_rn=t2.week_rn
where t1.trx_type = '存现'
;
-- 4、账户流水中收取手续费笔数超过10笔/月。--看下备注里有没有手续费 摘要、对手名称含手续费
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_04 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t2.trx_mon              AS 月份
       ,t2.tot_cnt              AS 当月手续费笔数
       ,t2.tot_amt              AS 当月手续费总金额
FROM SJXQ_SJ2025070296_CST_03 t1
inner join (
	select cst_act_id,trx_mon
		,count(1) 		as tot_cnt
		,sum(trx_amt) 	as tot_amt
	from SJXQ_SJ2025070296_CST_03
	where concat(smr_dscr,cnt_pty_act_nm) regexp '手续费'
	group by cst_act_id,trx_mon
	having tot_cnt > 10
)t2 on t1.cst_act_id=t2.cst_act_id
and t1.trx_mon=t2.trx_mon
;
-- 6、月均&ge;3次交易IP为境外，且交易对手名称或备注中包含酒店、会所、奢侈品等。即境外交易累计大于等于54次
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_06 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t2.tot_cnt              AS 24年以来境外交易笔数
	   ,round(t2.tot_cnt/18,2) 	as 24年以来境外月均交易笔数
FROM SJXQ_SJ2025070296_CST_03 t1
inner join (
	select cst_act_id,count(1) as tot_cnt
	from SJXQ_SJ2025070296_CST_03
	where ovs_ind='1' --境外标志
	group by cst_act_id
	having tot_cnt >= 54
)t2 on t1.cst_act_id=t2.cst_act_id
where concat(t1.cnt_pty_act_nm,t1.cmt) regexp '酒店|会所|奢侈品'
;
-- 7、单月境外取现次数&ge;2次，且每次均接近等值1万美元。9000-11000美元之间
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_07 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t2.trx_mon              AS 月份
       ,t2.tot_cnt              AS 当月境外取现次数
       ,t2.tot_amt              AS 当月境外取现金额_折美元
FROM SJXQ_SJ2025070296_CST_03 t1
inner join (
	select cst_act_id,trx_mon
		,count(1) 			as tot_cnt
		,sum(折美元交易金额) as tot_amt
	from SJXQ_SJ2025070296_CST_03
	where ovs_ind='1' and trx_type='取现'   --无境外取现
	and 折美元交易金额 between 9000 and 11000
	group by cst_act_id,trx_mon
	having tot_cnt >= 2
)t2 on t1.cst_act_id=t2.cst_act_id
and t1.trx_mon=t2.trx_mon
where t1.ovs_ind='1'
and t1.trx_type='取现'
;
-- 8、现金购买理财或贵金属单笔&ge;20万元。？ 一般会分为 存现 再购买
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_08 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期_确认日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
FROM SJXQ_SJ2025070296_CST_03 t1
inner join (
	select distinct cst_act_id
	from SJXQ_SJ2025070296_CST_03
		,'LC0006' --财富产品
		,'TY1930' --贵金属代销转账
		,'ZHB001') --天添宝购买
)t2 on t1.cst_act_id=t2.cst_act_id
	,'LC0006' --财富产品
	,'TY1930' --贵金属代销转账
	,'ZHB001') --天添宝购买
;
-- 9、现金偿还信用卡&ge;10万元。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_09 AS
SELECT  t21.cst_id          AS 客户编号
        ,t21.cst_nm         AS 客户名称
        ,t1.cr_crd_act_id   AS 信用卡账号
        ,t1.cr_crd_card_nbr AS 信用卡卡号
        ,t3.prm_mgr_id      AS 主管护客户经理工号
        ,t3.prm_mgr_nm      AS 主管护客户经理姓名
		,t3.prm_org_id      as 主管护机构号
		,t3.prm_org_nm      as 主管户机构名称
        ,t1.trx_dt          AS 交易日期
        ,t1.trx_tm          AS 交易时间
        ,t1.trx_amt         AS 交易金额
        ,t1.cnt_pty_act_id  AS 对方账号
        ,t1.cnt_pty_act_nm  AS 对方户名
        ,t1.trx_typ_cd      AS 交易类型代码
        ,t1.trx_typ_dscr    AS 交易类型描述
        ,t1.trx_dscr_1      AS 交易描述
        ,t1.act_bal         AS 账户余额
		,-1*t2.tot_amt 	as 累计还款金额
from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di 	t1 --信用卡交易宽表
inner join(
	select cr_crd_card_nbr,sum(trx_amt) as tot_amt
	from adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di t1 --信用卡交易宽表
	where dt>='20240101'
	and substr(t1.trx_typ_cd, 1, 1) = '7' --还款交易
	and t1.trx_typ_dscr regexp '现金'
	group by cr_crd_card_nbr having abs(tot_amt)>=100000
)t2 on t1.cr_crd_card_nbr=t2.cr_crd_card_nbr
inner join edw.dws_bus_crd_cr_crd_inf_dd      t21      --信用卡卡片信息汇总
on t1.cr_crd_card_nbr=t21.cr_crd_card_nbr
and t21.dt='20240701'
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t21.cst_id = t3.cst_id
and t3.dt = '20250701'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250701'
and t4.brc_org_nm='苏州分行'
where t1.dt>='20240101'
and substr(t1.trx_typ_cd, 1, 1) = '7' --还款交易
and t1.trx_typ_dscr regexp '现金'
;
-- 10、现金支付房产首付/房款/保费。--存现并且备注是房产首付或房款或保费
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_10 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
FROM SJXQ_SJ2025070296_CST_03 t1
where t1.trx_type='存现'
and ((t1.cmt regexp '房' and t1.cmt regexp '首付') or t1.cmt regexp '房款|保费')
;
-- 11、账户发生资金备注为：股权转让款、分红款等交易。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_11 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
FROM SJXQ_SJ2025070296_CST_03 	t1
where t1.cmt regexp '股权转让|分红'
;
-- 12、交易对手名称中包含拍卖行、房地产、酒店等关键词。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_12 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
FROM SJXQ_SJ2025070296_CST_03 	t1
where t1.cnt_pty_act_nm regexp '拍卖行|房地产|酒店'
;
-- 13、被有权机关查冻扣的后三天以内，账户发生大额转账/取现，单笔金额&ge;20万元。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_13 AS
SELECT  t2.dep_act_id           AS 存款账号
       ,t2.dtl_seq_nbr          AS 明细序号
       ,t2.cst_id               AS 客户号
       ,t2.cst_chn_nm           AS 客户名称
       ,t1.create_dt            AS 查冻扣日期
       ,t2.cst_typ_cd           AS 客户类型
       ,t2.cst_act_id           AS 客户账号
       ,t2.账号管户客户经理编号
       ,t2.trx_dt               AS 交易日期
       ,t2.trx_amt              AS 交易金额
       ,t2.crd_and_dbt_ind      AS 借贷标志
       ,t2.act_bal              as 账户余额
       ,t2.cnt_pty_cst_act_id   AS 对方客户账号
       ,t2.cnt_pty_act_nm       AS 对方户名
       ,t2.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t2.txt_code             AS 摘要代码
       ,t2.smr_dscr             AS 摘要描述
       ,t2.trx_chnl_nm          AS 交易渠道
       ,t2.cmt                  AS 备注
from(
    select distinct substr(party_id,3,10) as cst_id
        ,replace(create_dt,'-','') as create_dt
    from app_fxq.t10_party_risk                   --风险事件结果表
    where dt between '20240101' and '20250701'
    and replace(create_dt,'-','') between '20240101' and '20250701'     --创建日期
)t1 inner join SJXQ_SJ2025070296_CST_03 t2
on t1.cst_id=t2.cst_id
and datediff(to_date(t2.trx_dt,'yyyyMMdd'),to_date(t1.create_dt,'yyyyMMdd'),'dd') between 0 and 3   --三天以内
and t2.crd_and_dbt_ind='D'
and t2.trx_amt>=200000  --单笔金额
;
-- 14、非工作时间（夜间00：00-6：00/节假日周六日和法定节假日）交易占比&ge;总交易笔数30%。
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_14 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t1.bal_fld_nm           AS 余额字段名称
       ,t1.is_holiday           AS 是否节假日
       ,t1.is_night_trx         AS 是否夜间交易
       ,t2.not_work_cnt         AS 非工作时间交易笔数
       ,t2.tot_cnt              AS 总交易笔数
	   ,round(t2.not_work_cnt/t2.tot_cnt,4) as 非工作时间交易笔数占比
FROM SJXQ_SJ2025070296_CST_03 	t1
inner join (
	select cst_act_id
		,count(1) 			as tot_cnt
		,sum(case when is_holiday=1 or is_night_trx=1 then 1 else 0 end) as not_work_cnt
	from SJXQ_SJ2025070296_CST_03
    where bal_fld_nm='DPLDGBAL'  --动账
	group by cst_act_id having not_work_cnt/tot_cnt >= 0.3
)t2 on t1.cst_act_id=t2.cst_act_id
where t1.bal_fld_nm='DPLDGBAL'  --动账
;
-- 15、春节或国庆周六日等法定节日前一周集中存款或投保金额&ge;日常月均5倍。日常月均取年日均
-- 改成每周存款或投保金额>= 当周年日均5倍
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_04 AS
select t1.cst_id,t1.week_rn,t1.w_min_dt,t1.in_amt
    ,t2.dep_bal_year_avg
from(
    select cst_id,week_rn
        ,min(trx_dt)    as w_min_dt
        ,sum(trx_amt)   as in_amt
    from SJXQ_SJ2025070296_CST_03
    where bal_fld_nm='DPLDGBAL'  --动账
    and crd_and_dbt_ind='D'      --购买存款或投保金额
        ,'DP0251'   --定转活	6792
        ,'DP0217'   --活转定	3635
        ,'DP0700'   --储蓄产品	58
        ,'DP2124'   --大额存单认购	9
        ,'TY0159'   --保险产品续期缴费	729
        ,'TY0159'   --保险产品代收缴费	1116
        ,'TY0161')   --保险产品投保	575
    group by cst_id,week_rn
)t1 inner join adm_pub.adm_csm_cbus_dep_inf_dd t2 --存款业务信息表
on t1.cst_id=t2.cst_id
and t1.w_min_dt=t2.dt
and t2.dt between '20240101' and '20250701'
where t1.in_amt>=5*t2.dep_bal_year_avg                         --存款余额年日均
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_15 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t1.bal_fld_nm           AS 余额字段名称
       ,t1.is_holiday           AS 是否节假日
       ,t1.is_night_trx         AS 是否夜间交易
       ,t2.w_min_dt             AS 当周首次交易日期
       ,t2.in_amt               AS 当周入账金额
       ,t2.dep_bal_year_avg     AS 当周首次交易日期存款年日均
FROM SJXQ_SJ2025070296_CST_03 	    t1
inner join SJXQ_SJ2025070296_CST_04 t2
on t1.cst_id=t2.cst_id
and t1.week_rn=t2.week_rn
;
-- 16、账户大额入账&ge;50万元后，90%以上资金在7日内取现或消费或投资，并且余额趋零后立即销户或休眠。  余额趋零指1元以内1周以内销户
-- 改成大额入账&ge;50万元后，7日内余额在1元以内,15日内销户
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_05 AS
select t1.cst_act_id,t1.dep_act_id,t1.dtl_seq_nbr
    ,t1.trx_dt,t1.trx_amt
    ,t2.dt,t2.gl_bal
    ,t3.dstr_act_dt	    --销户日期
    ,DATEDIFF(TO_DATE(t3.dstr_act_dt,'yyyyMMdd'),TO_DATE(t1.trx_dt,'yyyyMMdd'),'dd') as 大额交易距销户天数
    ,RANK() over(partition by t1.dep_act_id order by t1.dtl_seq_nbr) rn
from SJXQ_SJ2025070296_CST_03 t1
inner join(
    select cst_act_id,dt                               --客户账号|C32
        ,sum(gl_bal) as gl_bal                         --账户总账余额|DECIMAL(20,2)
    from edw.dws_bus_dep_act_inf_dd               --存款账户信息汇总
    where dt between '20240101' and '20250701'
    group by cst_act_id,dt having sum(gl_bal)<1
)t2 on t1.cst_act_id=t2.cst_act_id
and to_char(dateadd(to_date(t1.trx_dt,'yyyyMMdd'),15,'dd'),'yyyyMMdd') = t2.dt
inner join edw.dim_bus_dep_cst_act_inf_dd t3     --客户存款账户信息
on t1.cst_act_id=t3.cst_act_id
and t3.dt='20250701'
and t3.dstr_act_dt<>'18991231'
where t1.trx_amt >= 500000
and t1.crd_and_dbt_ind='C' 	--入账
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025070296_CST_RES_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070296_CST_RES_16 AS
SELECT  t1.dep_act_id           AS 存款账号
       ,t1.dtl_seq_nbr          AS 明细序号
       ,t1.cst_id               AS 客户号
       ,t1.cst_chn_nm           AS 客户名称
       ,t1.cst_typ_cd           AS 客户类型
       ,t1.cst_act_id           AS 客户账号
       ,t1.账号管户客户经理编号
       ,t1.trx_dt               AS 交易日期
       ,t1.trx_amt              AS 交易金额
       ,t1.crd_and_dbt_ind      AS 借贷标志
       ,t1.act_bal              as 账户余额
       ,t1.cnt_pty_cst_act_id   AS 对方客户账号
       ,t1.cnt_pty_act_nm       AS 对方户名
       ,t1.cnt_pty_fin_instt_nm AS 对方金融机构名称
       ,t1.txt_code             AS 摘要代码
       ,t1.smr_dscr             AS 摘要描述
       ,t1.trx_chnl_nm          AS 交易渠道
       ,t1.cmt                  AS 备注
       ,t1.bal_fld_nm           AS 余额字段名称
       ,t1.is_holiday           AS 是否节假日
       ,t1.is_night_trx         AS 是否夜间交易
    ,t2.dstr_act_dt	    as 客户账户销户日期
    ,t2.大额交易距销户天数
FROM SJXQ_SJ2025070296_CST_03 	    t1
inner join SJXQ_SJ2025070296_CST_05 t2
on t1.dep_act_id=t2.dep_act_id
and t1.dtl_seq_nbr>=t2.dtl_seq_nbr
and t2.rn=1
where t2.大额交易距销户天数<=30
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070296_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct trx_srl_nbr,trx_dt) custs
from SJXQ_SJ2025070296_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025070296_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,week_rn) custs
from SJXQ_SJ2025070296_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025070296_CST_05
;
/*
01	440268	440268
02	2583512	2583512
03	40214632	40214632
04	1102488	1102488
05	23025	23025
edw.dwd_bus_crd_cr_crd_trx_dtl_di 	 		--信用卡客户交易流水
adm_pub_app.adm_pblc_ast_crd_cr_trx_srl_di 	--信用卡交易宽表
-- cr_crd_card_nbr,srl_nbr,trx_dt,trx_tm 两表通过4个字段关联
*/
SElECT '01' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_02
-- union all
-- SElECT '03' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
-- from SJXQ_SJ2025070296_CST_RES_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_04
-- union all
-- SElECT '05' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
-- from SJXQ_SJ2025070296_CST_RES_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 信用卡卡号) custs
from SJXQ_SJ2025070296_CST_RES_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_10
union all
SElECT '11' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_11
union all
SElECT '12' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_12
union all
SElECT '13' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_13
union all
SElECT '14' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_14
union all
SElECT '15' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_15
union all
SElECT '16' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ2025070296_CST_RES_16
;
/*
01	5494	5494
02	1249	1249
04	326574	326574
06	21	21
07	0	0
09	5	3
10	8	8
11	6069	6069
12	58541	58541
14	13511364	13511364
*/
SElECT '01' seq, * from SJXQ_SJ2025070296_CST_RES_01 ORDER BY 存款账号,明细序号;
SElECT '02' seq, * from SJXQ_SJ2025070296_CST_RES_02 ORDER BY 存款账号,明细序号;
-- SElECT '03' seq, * from SJXQ_SJ2025070296_CST_RES_03; --暂不取
SElECT '04' seq, * from SJXQ_SJ2025070296_CST_RES_04 ORDER BY 存款账号,明细序号;
-- SElECT '05' seq, * from SJXQ_SJ2025070296_CST_RES_05; --暂不取
SElECT '06' seq, * from SJXQ_SJ2025070296_CST_RES_06 ORDER BY 存款账号,明细序号;
SElECT '07' seq, * from SJXQ_SJ2025070296_CST_RES_07;   --没数据
SElECT '08' seq, * from SJXQ_SJ2025070296_CST_RES_08;   --没数据：逻辑不对
SElECT '09' seq, * from SJXQ_SJ2025070296_CST_RES_09 ORDER BY 信用卡卡号;
SElECT '10' seq, * from SJXQ_SJ2025070296_CST_RES_10 ORDER BY 存款账号,明细序号;
SElECT '11' seq, * from SJXQ_SJ2025070296_CST_RES_11 ORDER BY 存款账号,明细序号;
SElECT '12' seq, * from SJXQ_SJ2025070296_CST_RES_12 ORDER BY 存款账号,明细序号;
SElECT '13' seq, * from SJXQ_SJ2025070296_CST_RES_13 ORDER BY 存款账号,明细序号;
SElECT '14' seq, * from SJXQ_SJ2025070296_CST_RES_14 ORDER BY 存款账号,明细序号;
SElECT '15' seq, * from SJXQ_SJ2025070296_CST_RES_15 ORDER BY 存款账号,明细序号;
SElECT '16' seq, * from SJXQ_SJ2025070296_CST_RES_16 ORDER BY 存款账号,明细序号;***赵卓群_SJ2025081276_苏州分行对公基本户信息.sql
-- 赵卓群_SJ2025081276_苏州分行对公基本户信息
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025081276_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025081276_CST_01 AS
SELECT  T1.cst_id         AS 客户号
    ,t2.cst_chn_nm     AS 客户名称
    ,t1.cst_act_id     AS 客户账号
    ,t1.dep_act_id     AS 存款账号
    ,t3.prm_mgr_id     AS 主管户客户经理工号
    ,t3.prm_mgr_nm     AS 主管户客户经理姓名
    ,t4.sbr_org_nm     AS 主管户支行
    ,t1.act_sts_cd     AS 账户状态代码
    ,c1.cd_val_dscr    AS 账户状态
    ,t2.reg_adr        AS 注册地址
    ,t5.reg_cpt_ccy_cd AS 注册资本币种代码
    ,c3.cd_val_dscr    AS 注册资本币种
    ,t5.reg_cpt        AS 注册资本
    ,t5.org_org_typ_cd AS 组织机构类型代码
    ,c2.cd_val_dscr    AS 组织机构类型
    ,t5.lctax_cert_no  AS 统一信用代码
    ,case when SUBSTR(t5.lctax_cert_no,3,2)='32' or t2.reg_adr regexp '江苏' then '是' else '否' end as 是否注册地址在江苏省内
    ,case when t6.cst_typ_cd='1' then '是' else '否' end as 受益人是否均为自然人
FROM  edw.dim_bus_dep_act_inf_dd  			    t1 --存款账户信息
inner join edw.dws_cst_bas_inf_dd 		    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
and t2.cst_typ_cd='2'   --'对公'
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = T1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = T1.dt
and t4.brc_org_nm = '苏州分行'
left join edw.dim_cst_entp_bas_inf_dd   t5 --企业客户基本信息
on t1.cst_id=t5.cst_id
and t5.dt=T1.dt
left join(
    -- 受益所有人
    SELECT substr(t1.party_id,3,10) as cst_id
        ,max(t2.cst_typ_cd) as cst_typ_cd
    from adm_upss.adm_upss_aml_t47_beneficiary     t1 --对公客户受益所有人表
    left join edw.dws_cst_bas_inf_dd    t2
    on t1.bfi_id=t2.cst_id
    and t2.dt=t1.dt
    where t1.dt='20250812'
    GROUP BY substr(t1.party_id,3,10)
)t6 on t1.cst_id=t6.cst_id
left join edw.dwd_code_library_dd       c1
on t1.act_sts_cd = c1.cd_val
and c1.dt = T1.dt
left join edw.dwd_code_library_dd       c2
on  T5.org_org_typ_cd = c2.cd_val
and c2.dt=T1.dt
left join edw.dwd_code_library_dd       c3
on  T5.reg_cpt_ccy_cd = c3.cd_val
and c3.dt=T1.dt
WHERE   T1.dt='20250812'
AND     T1.ACT_CTG_CD_1= '0001' --基本户
and     T1.act_sts_cd <> 'C'    --剔除销户
and     t5.org_org_typ_cd<>'0500'   --0500:个体工商户
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025081276_CST_01
;
SElECT '01' seq, *
from lab_sjxq.SJXQ_SJ2025081276_CST_01
;
***邓凤平_SJ2025080806_首笔贷款业务分析.sql
﻿-- 邓凤平_SJ2025080806_首笔贷款业务分析
-- 湖北大冶泰隆村镇银行
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.ctr_epsr_bal                             --合同敞口余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.CTR_STS_CD                               --合同状态 1:未生效|2:已生效|3:终止|4:冻结|5:作废
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,replace(replace(replace(replace(t1.grnt_mod_colc,'005','信用'),'010','保证'),'020','抵押'),'040','质押') as 担保方式集合
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as 循环类型
    ,t2.PD_NM
    ,t2.prm_bus_bred_ctg	--	主业务品种分类|c3
    ,c1.cd_val_dscr     as 主业务品种分类
    ,t1.hdl_org_id	    --经办机构编号|c10
    ,t7.org_nm          as 经办机构
    ,t1.hdl_opr_id	    --经办人工号
    ,t6.empe_nm         as 经办人
    ,t1.mgr_id	                                 --管户人工号|C10
    ,t3.empe_nm	        as 管户人
    ,t1.mgr_org_id	                             --管户机构号|C12
    ,t4.org_nm          as 管户机构
    ,t4.brc_org_nm
    ,t5.cst_chn_nm,t5.cst_typ_cd
    ,decode(t5.cst_typ_cd,'1','对私','2','对公') as 客户类型
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
	,t5.reg_adr                                  --户籍地址|注册地址|C256
	,t5.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,t5.fml_adr                                  --家庭地址|C256
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='湖北大冶泰隆村镇银行'
left join edw.dwd_code_library_dd           c1
on t2.prm_bus_bred_ctg = c1.cd_val
and c1.dt = t1.dt
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = t1.dt
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t6 --员工信息汇总
on  t1.hdl_opr_id=t6.empe_id
and t6.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t7 --考核机构树
on  t1.hdl_org_id = t7.org_id
and t7.dt = t1.dt
where t1.dt='20250731'
and t1.ctr_bgn_dt>='20240101'
and t1.hpn_typ_cd='010'     --首笔
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
-- AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_01_1 AS
select t1.ctr_serno                              --合同流水号
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.ctr_epsr_bal                             --合同敞口余额
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='20250731'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 合同担保人
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_02 AS
select t1.cst_id,t1.ctr_serno
    ,t2.grnt_ctr_no         --担保合同编号|c32
    ,t2.grnt_ctr_typ_cd	    --担保合同类型代码|c3
    ,c1.cd_val_dscr             as 担保合同类型
    ,nvl(t3.gtor_no,t4.OBG_ID)  as 担保人编号
    ,nvl(t3.gtor_nm,t4.OBG_NM)  as 担保人名称
    ,t5.mrg_situ_cd                              --婚姻状况代码
    ,decode(t5.mrg_situ_cd,'20','已婚','21','初婚','22','再婚','30','丧偶','10','未婚','23','复婚','40','离婚') as 婚姻状况
    ,case when t5.mrg_situ_cd like '2%' and nvl(PO.rel_cst_id,'')<>''
        and nvl(t3.gtor_no,t4.OBG_ID)<>PO.rel_cst_id then 1 ELSE 0 END AS is_yh_wdb --是否已婚配偶未担保
from SJXQ_SJ2025080806_CST_01                   t1
inner join edw.dwd_bus_loan_ctr_rel_grnt_dd     t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20250731'
and t2.busi_typ_cd='1'	--	业务类型代码1贷款业务2信用卡业务|c1
left JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t3 --担保合同担保人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='20250731'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20250731'
) t4 on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
left join edw.dwd_code_library_dd           c1
on t2.grnt_ctr_typ_cd = c1.cd_val
and c1.dt = '20250731'
left join edw.dim_cst_idv_bas_inf_dd        t5       --个人客户基本信息
on t1.cst_id=t5.cst_id
and t5.dt='20250731'
LEFT JOIN edw.loan_cst_rel PO
ON T1.cst_id = PO.cst_id
AND PO.rel_typ = '0301' --配偶
AND PO.DT = '20250731'
AND PO.del_ind <> '1' --删除标识
AND PO.vld_ind <> '0' --有效标识
;
-- 客户所在子社区
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_03 AS
SELECT  t1.cst_id
    ,t1.ctr_serno
    ,t1.hdl_opr_id
    ,t2.main_add        --主地址
    ,t2.com_son_code	--所属子社区编号
    ,t2.com_son_name	--所属子社区名称
    ,decode(t2.main_add_flag,'1','经营','2','通讯','3','家庭','4','户籍','5','办公','6','注册','') as 主地址类型
    ,t6.sub_cmnt_id AS 普惠子社区编号
    ,t7.cmnt_nm     AS 普惠子社区名称
    ,CASE WHEN COALESCE(T6.SUB_CMNT_ID,'') <> '' AND t1.hdl_opr_id REGEXP T10.EMPLOY_NO THEN '是'    --客户管护人是否是子社区的定人之一
            when nvl(T6.SUB_CMNT_ID,'')='' then ''
            ELSE '否' END AS 经办人是否为子社区定人
    ,CASE WHEN T9.developmentype = '主推' THEN '是' ELSE '否' END AS 是否主推子社区
from SJXQ_SJ2025080806_CST_01    t1
LEFT JOIN edw.xwdt_xw_customer   t2 --客户表(正潜灰)
ON  t1.cst_id = t2.cust_no
AND t2.dt = '20250731'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20250731'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd    t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = t6.dt
LEFT JOIN    edw.xwdt_etl_xw_com_bi_dt_zsq  T9 --社区经营情况明细报表(子社区)(T+2回流)
ON      T6.sub_cmnt_id = T9.comm_sub_community_no
AND     T9.DT = '20250731'
LEFT JOIN
(
	SELECT  COMMUNITY_CODE
	FROM edw.XWDT_ETL_XW_COMMUNITY_PER --普惠社区定人信息表
	WHERE dt = '20250731'
	AND IS_MAIN_PERSON = '2' ---- 1主维护人，2社区定人
	GROUP BY  COMMUNITY_CODE
) T10 ON T6.SUB_CMNT_ID = T10.COMMUNITY_CODE --社区编号
;
-- 准入时征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_04 AS
select t1.cst_id,t1.report_dt,t1.report_no,t1.scor_rng,t1.cst_typ_cd,t1.ctr_bgn_dt
    ,t1.idv_crd_sco_val
    ,t1.cred_total_balan	        --授信余额（信用总余额）
    ,t1.oth_bank_loan_credit_bal    --他行贷款授信余额
	,p1.sex	        --	性别
	,p1.birth_date	--	出生日期
    ,substr(t1.ctr_bgn_dt,1,4)-SUBSTR(p1.birth_date,1,4) as age
	,p1.mar_status                               --婚姻状况
    ,decode(p1.mar_status,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','其他') as 婚姻状况
    ,CASE
        WHEN p1.is_white_customer = '1'                             THEN '白户'     --是否白户 1-白户 空值-非白户
        WHEN p2.rela_bank_mon_num > 0 AND p2.rela_bank_mon_num <= 6 THEN '类白户'   --与银行建立信贷关系月数
        else '非白户' END AS 征信类型
from(
    select t1.cst_id,t1.report_dt	    --报告日期
        ,t1.report_no	                --报告编号
        ,t1.scor_rng,idv_crd_sco_val	--个人信用评分分值|DECIMAL(4,0)
        ,t1.cred_total_balan	        --授信余额（信用总余额）
        ,t1.oth_bank_loan_credit_bal    --他行贷款授信余额
        ,t2.cst_typ_cd
        ,t2.ctr_bgn_dt
        ,row_number() over(partition by t1.cst_id order by t1.report_dt desc) rn
    from edw.dws_cst_ccrc_idv_ind_inf_dd    t1 --个人征信指标信息表
    inner join SJXQ_SJ2025080806_CST_01     t2
    on  t1.cst_id=t2.cst_id
    and t1.report_dt<=t2.ctr_bgn_dt
    and t2.cst_typ_cd='1'
    where t1.dt='20250731'
    union all
    select t1.cst_id,t1.report_dt	--报告日期
        ,t1.report_no	--报告编号
        ,null,null
        ,t1.cred_total_balan	--	信用总余额
        ,t3.他行贷款余额
        ,t2.cst_typ_cd
        ,t2.ctr_bgn_dt
        ,row_number() over(partition by t1.cst_id order by t1.report_dt desc) rn
    from edw.dws_cst_ccrc_entp_ind_inf_dd   t1 --企业征信指标信息表
    inner join SJXQ_SJ2025080806_CST_01     t2
    on  t1.cst_id=t2.cst_id
    and t1.report_dt<=t2.ctr_bgn_dt
    and t2.cst_typ_cd='2'
    inner join(
        --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
        SELECT  report_id
            ,SUM(case WHEN a.dtrb_org_typ_cd <> '00' and act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN loan_bal else 0 end) AS 他行贷款余额
        from   edw.dim_cst_ccrc_entp_loan_inf_dd a
        where  a.dt = '20250731'
        group by report_id
    )t3 on t1.report_no=t3.report_id
    where t1.dt='20250731'
)t1
LEFT JOIN edw.NCIP_CP_M_BASIC_INFO  p1
ON t1.report_no = p1.report_id
AND p1.dt <= '20250731'
LEFT JOIN edw.ncip_zx_p_zb_info     p2
ON t1.report_no = p2.report_no
AND p2.dt <= '20250731'
where t1.rn=1   --准入时
;
-- 合同申请时预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_05 AS
SELECT t1.ctr_serno
	,t2.USC_APLY_SERNO
    ,t2.cst_id              as 预评估客户号
	,t2.PRE_ASES_SERNO                           --预评估流水号|C32
    ,t2.rul_set_no
    ,t2.rul_set_rslt_cd
    ,c1.cd_val_dscr 	    as 预评估结果
    ,t3.rul_set_rslt_nm         --新预评估结果
	,t3.PRE_ASES_rul_nm         --预评估触发规则
	,t3.PRE_ASES_prmpt_msg      --预评估提示信息
from SJXQ_SJ2025080806_CST_01 	            t1
left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd t2   --授信关联预评估信息表
ON t2.USC_APLY_SERNO = t1.REL_SERNO
and t2.DT = '20250731'
LEFT JOIN edw.dwd_code_library_dd               c1
ON  t2.RUL_SET_RSLT_CD = c1.cd_val
AND c1.DT = '20250731'
AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND c1.fld_nm = 'RUL_SET_RSLT_CD'
left JOIN (
    SElECT t1.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t1
    LEFT JOIN edw.dwd_code_library_dd               c1
    ON  t1.RUL_SET_RSLT_CD = c1.cd_val
    AND c1.DT = '20250731'
    AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND c1.fld_nm = 'RUL_SET_RSLT_CD'
	LEFT JOIN
	(
		SELECT  B1.rul_set_rslt_serno
		FROM edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
		WHERE B1.DT = '20250731'
		GROUP BY  B1.rul_set_rslt_serno
	) T2
	ON T1.rul_set_rslt_serno = T2.rul_set_rslt_serno
    where t1.DT = '20250731'
    group by t1.PRE_ASES_SERNO
)T3 ON T2.PRE_ASES_SERNO = T3.PRE_ASES_SERNO
;
--准入个人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_06 AS
select t1.cst_id,t1.ctr_bgn_dt,t1.ctr_serno
	,t2.gdr_cd                                   --性别代码
	,t2.age                                      --年龄
	,t2.mrg_situ_cd                              --婚姻状况
    ,decode(t2.mrg_situ_cd,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','其他') as 婚姻状况
    ,case when t2.mrg_situ_cd like '2%' and t3.rel_cst_id is null then '是' else '否' end as 是否已婚客户未关联配偶或未录入配偶信息
    ,t5.准入时风险等级
    ,t6.当前风险等级
    ,case when t6.rsk_lyr_cd<t5.rsk_lyr_cd then '是' else '否' end as 是否较准入时下降
from SJXQ_SJ2025080806_CST_01           t1
inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t1.ctr_bgn_dt=t2.dt
and t2.dt>='20240101'
left join(
    SElECT cst_id,rel_cst_id
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20250731'
    and REL_TYP_CD='0301' --配偶
    union
    SElECT rel_cst_id,cst_id
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20250731'
    and REL_TYP_CD='0301' --配偶
)t3 on t1.cst_id=t3.cst_id
LEFT JOIN
(
	SELECT  A1.cst_id
        ,a1.rsk_lyr_cd
	       ,CASE WHEN A1.rsk_lyr_cd = '1' THEN '低风险'
	             WHEN A1.rsk_lyr_cd = '5' THEN '高风险'
	             WHEN A1.rsk_lyr_cd = '2' THEN '中低风险'
	             WHEN A1.rsk_lyr_cd = '3' THEN '中风险'
	             WHEN A1.rsk_lyr_cd = '4' THEN '中高风险' END                                 AS 准入时风险等级
	       ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY  A1.rsk_lyr_afm_tm DESC ) AS RN
	FROM edw.dim_cst_asst_rsk_lyr_dd A1 --风险分层信息
	INNER JOIN SJXQ_SJ2025080806_CST_01 t2
	ON a1.cst_id = t2.cst_id AND substr(replace(A1.rsk_lyr_afm_tm, '-', ''), 1, 8) <= t2.ctr_bgn_dt
	WHERE A1.DT = '20250731'
	AND A1.rsk_lyr_cd <> ''
) T5 ON T1.cst_id = T5.cst_id
AND T5.RN = 1
LEFT JOIN
(
	SELECT  A1.cst_id
        ,a1.rsk_lyr_cd
	       ,CASE WHEN A1.rsk_lyr_cd = '1' THEN '低风险'
	             WHEN A1.rsk_lyr_cd = '5' THEN '高风险'
	             WHEN A1.rsk_lyr_cd = '2' THEN '中低风险'
	             WHEN A1.rsk_lyr_cd = '3' THEN '中风险'
	             WHEN A1.rsk_lyr_cd = '4' THEN '中高风险' END                                 AS 当前风险等级
	       ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY  A1.rsk_lyr_afm_tm DESC ) AS RN
	FROM edw.dim_cst_asst_rsk_lyr_dd A1 --风险分层信息
	WHERE A1.DT = '20250731'
	AND   A1.rsk_lyr_cd <> ''
) T6 ON T1.cst_id = T6.cst_id
AND T6.RN = 1
;
-- 调查
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_07 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as 调查方式 --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.svy_addr                 --调查地址
    ,t1.svy_addr_typ_cd          --调查地址类型代码|C3
    ,c2.cd_val_dscr          as 调查地址类型
    ,t1.pcp_mnl_no               --参与人工号|C20
    ,t1.pcp_psn_nm               --参与人姓名|C200
    ,t2.参与人岗位姓名
    ,case when t2.参与人岗位姓名 regexp '团队总' then '是' else '否' end as 是否团队总参与调查
    ,case when t2.参与人岗位姓名 regexp '支行行长' then '是' else '否' end as 是否支行行长参与调查
    ,t1.sys_reg_tm
    ,t3.ctr_serno
    ,t3.is_xfd,t3.is_jyd
    ,case when t3.is_jyd=1 and c2.cd_val_dscr regexp '经营' then '是' else '否' end as 经营性客户是否经营地调查
    ,case when t3.is_xfd=1 and c2.cd_val_dscr regexp '办公' then '是' else '否' end as 消费性客户是否工作地调查
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join(
    SELECT rel_serno
    from edw.loan_svy_rcd_rel_pcpt_inf  --调查记录关联参与人信息
    where dt='20250731'
    and del_ind='0'
    GROUP BY rel_serno
)t2 on t1.svy_rcd_serno=t2.rel_serno
INNER JOIN SJXQ_SJ2025080806_CST_01   t3
ON t1.cst_id = t3.cst_id
AND t1.svy_dt <= t3.ctr_bgn_dt
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt=t1.dt
where t1.dt='20250731'
;
--云调查3个月内是否有实地调查记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_08 AS
select t1.cst_id,t1.svy_dt,t1.ctr_serno
    ,min(t2.svy_dt)     as sd_svy_dt
from SJXQ_SJ2025080806_CST_07   t1
inner join edw.dwd_bus_loan_cst_svy_rcd_dd t2
on t1.cst_id=t2.cst_id
and t1.svy_dt<t2.svy_dt
and replace(add_months(to_date(t1.svy_dt,'yyyyMMdd'),3),'-','') >=t2.svy_dt
and t2.dt='20250731'
and t2.svy_mod_cd='01' --01:现场（实地）
where t1.rn=1
and t1.调查方式 regexp '云调查'
group by t1.cst_id,t1.svy_dt,t1.ctr_serno
;
-- 侧面打听对象 合同发放日期最近一次
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_09 AS
SELECT  t1.svy_rcd_serno         --调查记录流水号|C32
    ,t1.svy_mod_cd               --调查方式代码|C2
    ,c1.cd_val_dscr          as 调查方式 --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,t1.svy_dt                   --调查日期|C8
    ,t1.cst_id                   --客户号|C20
    ,t1.cst_nm                   --客户名称|C200
    ,t1.svy_ctnt_and_rslt        --调查内容及结果|C4000
    ,t1.sys_reg_tm
    ,t2.ctr_serno
    ,t3.调查对象名称
    ,t3.调查对象关系及名称
    ,t3.侧面打听对象是否包含我行客户
    ,t3.侧面打听对象是否包含我行关键人
    ,case when t3.svy_obj_cst_ids regexp t4.gtor_no then '是' else '否' end as 侧面打听对象是否是客户担保人
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id,t2.ctr_serno ORDER BY t1.svy_dt,t1.sys_reg_tm DESC ) AS rn --最近一次调查
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
INNER JOIN SJXQ_SJ2025080806_CST_01 t2
ON t1.cst_id = t2.cst_id
AND t1.svy_dt <= t2.ctr_bgn_dt
inner JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt=t1.dt
and     c1.cd_val_dscr regexp '侧面打听'
left join(
    SELECT t1.rel_serno
        ,max(case when t2.cst_id is not null then 1 else 0 end)         as 侧面打听对象是否包含我行客户
        ,max(case when t3.is_key_person_our_bank='1' then 1 else 0 end) as 侧面打听对象是否包含我行关键人
    from edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd    t1
    left join edw.dws_cst_bas_inf_dd    t2
    on t1.svy_obj_nm=t2.cst_chn_nm
    and case when length(t2.mbl_nbr)<>11 then t2.fml_tel_nbr else t2.mbl_nbr end = t1.svy_obj_mbl_no
    and t2.dt='20250731'
    left join edw.xwdt_xw_customer      t3
    on t2.cst_id = t3.cust_no
    and t3.dt = '20250731'
    LEFT JOIN    EDW.dwd_code_library_dd                c1
    ON      T1.with_be_svy_psn_rel_cd = C1.CD_VAL
    and     c1.dt=t1.dt
    where t1.dt='20250731'
    and nvl(t1.svy_obj_nm,'')<>''
    GROUP BY t1.rel_serno
) t3 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t3.rel_serno --关联流水号
left join(
    from SJXQ_SJ2025080806_CST_02
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
where t1.dt='20250731'
;
-- 资产负债概况
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_10 AS
select t1.cst_id,t1.ctr_serno,t1.svy_rpt_no,t1.svy_rpt_dt
	,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
    ,t1.slf_ast_amt                              --本人资产总额|decimal(21,2)
    ,t1.slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
    ,t1.slf_net_ast                              --本人净资产
    ,t1.slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
	,row_number() over(partition by t1.cst_id,t1.ctr_serno order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id,t1.ctr_serno
		,t5.svy_rpt_no                          --调查报告编号|c32
		,case when length(t5.svy_rpt_no)=20 then SUBSTR(t5.svy_rpt_no,5,8)
			else SUBSTR(t5.svy_rpt_no,4,8) end as svy_rpt_dt
	    ,t5.slf_ast_amt                              --本人资产总额|decimal(21,2)
	    ,t5.slf_lbl_tot_amt                          --本人负债总额|decimal(21,2)
	    ,t5.slf_net_ast                              --本人净资产|decimal(21,2)
	    ,t5.slf_ast_lbl_rat                          --本人资产负债率|decimal(10,6)
	from SJXQ_SJ2025080806_CST_01   t1
    inner join edw.dwd_bus_loan_svy_fnc_stat_cus_ass_lib_ovew_dd 	t5 --资产负债概况
	on t1.cst_id=t5.cst_id
	and t5.dt=t1.ctr_bgn_dt     --准入时
    and nvl(t5.svy_rpt_no,'')<>''
    and t5.dt>='20240101'
)t1
;
--销售额
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_11 AS
select t1.cst_id,t1.ctr_serno,t1.sal_amt,t1.npft,t1.svy_rpt_no,t1.svy_rpt_dt
	,t1.sys_reg_tm,t1.cnt,t1.max_sys_dt,SUBSTR(t1.svy_rpt_no,1,4) as rpt_type
	,row_number() over(partition by t1.cst_id,t1.ctr_serno order by t1.svy_rpt_dt desc) as rn
from(
	select t1.cst_id,t1.ctr_serno
		,t6.svy_rpt_no                          --调查报告编号|c32
		,case when length(t6.svy_rpt_no)=20 then SUBSTR(t6.svy_rpt_no,5,8)
			else SUBSTR(t6.svy_rpt_no,4,8) end as svy_rpt_dt
		,sum(t6.sal_amt)     		as sal_amt
        ,sum(t6.npft)     		    as npft
		,count(distinct t6.sys_reg_tm) as cnt
		,max(t6.sys_reg_tm) as max_sys_dt
	from SJXQ_SJ2025080806_CST_01 t1
    inner join edw.dwd_bus_loan_svy_cst_opr_sal_amt_and_npft_dd		t6 --调查报告-经营信息销售额及净利润信息
	on t1.cst_id=t6.cst_id
	and t6.dt=t1.ctr_bgn_dt     --准入时
    and nvl(t6.svy_rpt_no,'')<>''
	group by t1.cst_id,t6.svy_rpt_no,t1.ctr_serno
)t1
;
-- 当前征信
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_12 AS
SELECT t1.cst_id
    ,t1.report_dt                   --报告日期
    ,t1.report_no                   --报告编号
    ,t1.scor_rng
    ,t1.idv_crd_sco_val             --个人信用评分分值|DECIMAL(4,0)
    ,t1.cred_total_balan            --授信余额（信用总余额）
    ,t1.oth_bank_credit_total_amt   --他行授信总余额(不含未激活)
    ,t1.oth_bank_loan_credit_bal    --他行贷款授信余额
    ,t1.othr_bnk_mngmt_loan_org_num --他行经营性贷款授信机构数
    ,t1.late_6mon_enqu_count        --最近6个月审批查询次数
    ,t1.c_od_total_amt              --贷款当前逾期总额
    ,t1.curr_unsett_loan_od_num     --当前贷款逾期期数
    ,t1.wdil6m                      --近6个月的最大逾期期数
    ,t1.un_normal_loan_balan        --贷款五级分类为非正常的余额
    ,t1.c_c_6m_avg_use_rate	        --信用卡最近6个月平均透支率
    ,t1.五级分类不良贷款余额
from(
    SELECT t1.cst_id
        ,t1.report_dt                   --报告日期
        ,t1.report_no                   --报告编号
        ,t1.scor_rng
        ,t1.idv_crd_sco_val             --个人信用评分分值|DECIMAL(4,0)
        ,t1.cred_total_balan            --授信余额（信用总余额）
        ,t1.oth_bank_credit_total_amt   --他行授信总余额(不含未激活)
        ,t1.oth_bank_loan_credit_bal    --他行贷款授信余额
        ,t1.othr_bnk_mngmt_loan_org_num --他行经营性贷款授信机构数
        ,t1.late_6mon_enqu_count        --最近6个月审批查询次数
        ,t1.c_od_total_amt              --贷款当前逾期总额
        ,t1.curr_unsett_loan_od_num     --当前贷款逾期期数
        ,t1.wdil6m                      --近6个月的最大逾期期数
        ,t1.un_normal_loan_balan        --贷款五级分类为非正常的余额
        ,t1.c_c_6m_avg_use_rate	        --信用卡最近6个月平均透支率
        ,t3.五级分类不良贷款余额
        ,row_number() over(partition by t1.cst_id order by t1.report_dt desc) rn
    from edw.dws_cst_ccrc_idv_ind_inf_dd    t1 --个人征信指标信息表
    inner join(
        select distinct cst_id
        from SJXQ_SJ2025080806_CST_01
        where cst_typ_cd='1'
    )t2 on t1.cst_id=t2.cst_id
    left join(
        SELECT  report_id
        from   edw.dim_cst_ccrc_idv_loan_inf_dd
        where  dt = '20250731'
        group by report_id
    )t3 on t1.report_no=t3.report_id
    where t1.dt='20250731'
    and t1.report_dsc_rn=1     --当前
    union all
    SELECT  t1.cst_id
        ,t1.report_dt --报告日期
        ,t1.report_no --报告编号
        ,null
        ,null
        ,t1.cred_total_balan -- 信用总余额
        ,null
        ,t3.他行贷款余额
        ,null
        ,t1.late_6mon_org_pass_num --近6个月金融机构审批通过家数
        ,t3.贷款逾期金额
        ,t3.贷款逾期月数,null
        ,t3.非正常贷款余额,null
        ,t3.五级分类不良贷款余额
        ,row_number() over(partition by t1.cst_id order by t1.report_dt desc) rn
    from edw.dws_cst_ccrc_entp_ind_inf_dd   t1 --企业征信指标信息表
    inner join(
        select distinct cst_id
        from SJXQ_SJ2025080806_CST_01
        where cst_typ_cd='2'
    )t2 on t1.cst_id=t2.cst_id
    inner join(
        --他行贷款信息 D1:非循环贷账户|R1:循环贷账户|R2:贷记卡账户|R3:准贷记卡账户|R4:循环额度下分账户|C1:催收账户
        SELECT  report_id
            ,SUM(case WHEN a.dtrb_org_typ_cd <> '00' and act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN loan_bal else 0 end) AS 他行贷款余额
            ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_tot_amt else 0 end)                             AS 贷款逾期金额
            ,sum(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) THEN ovd_mon else 0 end) AS 贷款逾期月数
            ,SUM(case WHEN act_typ IN ( 'D1' ,'R1' ,'R4' ) AND five_ctg_cd <> '1' THEN loan_bal else 0 end)         AS 非正常贷款余额
        from   edw.dim_cst_ccrc_entp_loan_inf_dd a
        where  a.dt = '20250731'
        -- and    a.dtrb_org_typ_cd <> '00'  ---- 剔除泰隆银行
        group by report_id
    )t3 on t1.report_no=t3.report_id
    where t1.dt='20250731'
    and t1.report_dsc_rn=1     --当前
)t1
;
-- 精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_13 AS
SELECT t1.btch_serno
    ,t1.tsk_gen_dt
    ,t1.最近一次触发精准贷后类型
    ,COALESCE(t2.cst_id,t3.cst_id) as cst_id
    ,t2.cst_lvl_pst_loan_mng_pln_cd
    ,t2.cst_lvl_pst_loan_mng_pln_nm
    ,t3.pst_loan_mng_pln_cd
    ,t3.pst_loan_mng_pln_nm
    ,ROW_NUMBER() over(partition by COALESCE(t2.cst_id,t3.cst_id) order by t1.tsk_gen_dt desc) rn
from(
    SELECT T1.btch_serno
        ,T1.tsk_gen_dt   --任务生成日期 精准贷后风险触发时间
        ,T1.pst_loan_chk_tsk_typ_cd
        ,c1.cd_val_dscr     as 最近一次触发精准贷后类型
        ,ROW_NUMBER() over(PARTITION BY T1.btch_serno ORDER BY T1.tsk_gen_dt desc) rn_desc
    from edw.dwd_bus_loan_psp_chk_tsk_inf_dd  AS T1 --贷后检查任务信息
    LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
    ON      t1.pst_loan_chk_tsk_typ_cd = c1.cd_val
    AND     c1.DT = t1.dt
    where T1.DT = '20250731'
    AND T1.pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
    AND T1.tsk_gen_dt between '20240101' and '20250731'
)t1 left JOIN (
    SELECT t1.btch_serno,t1.cst_id
        ,t1.cst_lvl_pst_loan_mng_pln_cd              --客户级贷后管理方案代码 ,'03','重组','04','退出','06','预保预报','07','清收','08','诉讼'
        ,c1.cd_val_dscr     as cst_lvl_pst_loan_mng_pln_nm
    from edw.dwd_bus_loan_psp_chk_btch_inf_dd AS T1 --贷后检查批次信息表
    LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
    ON      t1.cst_lvl_pst_loan_mng_pln_cd = c1.cd_val
    AND     c1.DT = t1.dt
    where t1.DT = '20250731'
)t2 on t1.btch_serno=t2.btch_serno
left join(
    SELECT t.*
    from (
        SELECT t1.btch_serno,t2.cst_id
            ,t1.ctr_serno                                --合同流水号|c32
            ,t1.pst_loan_mng_opnn_src_cd                 --贷后管理意见来源代码 ,'1','客户经理意见','2','中台意见'
            ,t1.pst_loan_mng_pln_cd	--	贷后管理方案代码
            ,c1.cd_val_dscr     as pst_loan_mng_pln_nm
            ,ROW_NUMBER() over(PARTITION BY t1.btch_serno ORDER BY t1.sys_reg_tm desc) rn
        from edw.dwd_bus_loan_bsn_mng_pln_dd        t1 --业务贷后管理方案
        left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
        on t1.ctr_serno=t2.ctr_serno
        and t2.dt=t1.dt
        LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
        ON  t1.pst_loan_mng_pln_cd = c1.cd_val
        AND c1.DT = t1.dt
        and c1.cd_val_dscr REGEXP '预保预报|重组|诉讼|清收'     --,'13','预保预报','14','清收','15','诉讼','16','重组'
        where t1.DT = '20250731'
    )t where t.rn=1
)t3 on t1.btch_serno=t3.btch_serno
inner join(
    SELECT  DISTINCT cst_id
    from SJXQ_SJ2025080806_CST_01
)t4 on COALESCE(t2.cst_id,t3.cst_id)=t4.cst_id
where t1.rn_desc=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_13_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_13_1 AS
select t1.cst_id                                   --客户编号
	,t1.cst_nm                                   --客户名称
	,t1.start_dt                                 --任务生成日期
	,t1.end_dt                                   --检查完成日期
	,t1.chk_typ                                  --贷后检查类型
	,t1.chk_way                                  --贷后检查方式
	,t1.chk_stt                                  --贷后检查状态
	,t1.rsk_lvl                                  --客户风险程度判断
	,t1.rsk_lvl_zw                               --客户风险程度判断(中文)
	,t1.chk_opnn                                 --贷后管理意见
    ,c1.cd_val_dscr  as 贷后管理意见
	,t1.offend_rsn                               --触犯原因
	,t1.offend_rsn_ana                           --触犯原因分析
	,t1.aprv_opnn                                --批复意见执行情况
	,t1.rsk_fc                                   --风险分层
	,t1.rsk_lvl_tz                               --风险分层(调整后)
	,t1.trg_typ                                  --触犯规则类型
    ,c2.cd_val_dscr     as 触犯规则类型
    ,row_number() over(partition by t1.cst_id order by t1.start_dt desc) rn
from adm_rsk.adm_rsk_apl_prc_pst_loan_mnt_dd  t1 --精准贷后-任务宽表
LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
ON  t1.chk_opnn = c1.cd_val
AND c1.DT = t1.dt
LEFT JOIN    edw.dwd_code_library_dd 	c2 --码值表
ON  t1.trg_typ = c2.cd_val
AND c2.DT = t1.dt
where t1.dt='20250731'
and t1.cst_id in(
    select cst_id
    from SJXQ_SJ2025080806_CST_01
)
;
-- 客户准入至今逾期天数>=3天的次数
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_14 AS
select t1.cst_id,t1.ctr_bgn_dt,t1.ctr_serno
    ,t2.ovd_cnt as 客户准入至今逾期天数3天及以上次数
from SJXQ_SJ2025080806_CST_01               t1
inner join(
    select CTR_SERNO,count(OVD_DT) as ovd_cnt
    from(
        select CTR_SERNO,OVD_DT                                   --逾期日期
        from edw.dim_bus_loan_dbil_inf_dd
        where dt between '20240101' and '20250731'
        and OVD_DAY >= 3                                 --逾期天数
        union
        select CTR_SERNO,OVD_INTR_DT                                   --逾期日期
        from edw.dim_bus_loan_dbil_inf_dd
        where dt between '20240101' and '20250731'
        and OVD_INTR_DAY >= 3                                 --逾期天数
    )t1 group by ctr_serno
)t2 on t1.ctr_serno=t2.CTR_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025080806_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025080806_CST_15 AS
SELECT  t1.ctr_serno       AS 合同流水号
    ,t1.cst_id          AS 客户号
    ,t1.cst_chn_nm      AS 客户名称
    ,t1.客户类型
    ,t1.ctr_bgn_dt      AS 合同起始日期
    ,t1.ctr_mtu_dt      AS 合同到期日期
    ,t1.主业务品种分类
    ,t1.循环类型
    ,t1.exec_intr_rat   AS 执行月利率
    ,t1.SYS_REG_DT      AS 系统登记日期_经办日期
    ,t1.hdl_opr_id      AS 经办人工号
    ,t1.经办人
    ,t1.hdl_org_id      AS 经办机构编号
    ,t1.经办机构
    ,t1.mgr_id          AS 管户人工号
    ,t1.管户人
    ,t1.mgr_org_id      AS 管户机构号
    ,t1.管户机构
    ,t1.ctr_amt         AS 合同金额
    ,t1.ctr_bal         AS 合同余额
    ,t1.sam_rsk_ctrl_id AS 同一风险控制号
    ,t1_1.同一风险控制号敞口金额
    ,t1_1.同一风险控制号敞口余额
    ,t1.担保方式集合
    ,t2.担保合同类型
    ,t2.担保人
    ,CASE WHEN t2.is_yh_wdb = 1 THEN '是'  ELSE '否' END AS 是否已婚配偶未担保
    ,t3.普惠子社区编号
    ,t3.普惠子社区名称
    ,t3.主地址类型
    ,t3.是否主推子社区
    ,t3.经办人是否为子社区定人 as 是否经办客户经理定人子社区
    ,case when t3.是否主推子社区='否' and t3.经办人是否为子社区定人='否' then '是' else '否' end 是否有弹性突破
	-- ,t1.reg_adr                                  as 户籍地址或注册地址
	-- ,t1.wrk_adr                                  as 工作单位地址或经营所在地地址
	-- ,t1.fml_adr                                  as 家庭地址
    ,t4.征信类型
    ,t4.scor_rng   AS 准入时征信分
    ,decode(coalesce(t4.sex,t6.gdr_cd),'1','男','2','女')       AS 准入时性别
	,nvl(t6.age,t4.age)                                         as 准入时年龄
    ,nvl(t6.婚姻状况,t4.婚姻状况) as 准入时婚姻状况
    ,t5.预评估结果
	,t5.PRE_ASES_rul_nm         as 预评估触发规则
	,t5.PRE_ASES_prmpt_msg      as 预评估提示信息
    ,t6.是否已婚客户未关联配偶或未录入配偶信息 as 准入时是否已婚客户未关联配偶或未录入配偶信息
    ,t6.准入时风险等级
    ,t7.svy_dt                   as 调查日期
    ,t7.调查地址类型
    -- ,t7.svy_addr                 as 调查地址
    ,t7.经营性客户是否经营地调查
    ,t7.消费性客户是否工作地调查
    ,t7.调查方式    --04:侧面打听（现场）|01:现场（实地）|02:云调查|03:非现场|05:侧面打听（非现场）|06:侧面打听（批量）
    ,case when t8.cst_id is not null then '是' else '否' end 云调查3个月内是否有实地调查记录
    ,t9.调查对象名称
    ,t9.svy_ctnt_and_rslt        as 调查内容及结果
    ,t9.侧面打听对象是否包含我行关键人
    ,t9.侧面打听对象是否包含我行客户
    ,t9.侧面打听对象是否是客户担保人
    ,t7.pcp_mnl_no               as 参与人工号
    ,t7.pcp_psn_nm               as 参与人姓名
    ,t7.参与人岗位姓名
    ,t7.是否团队总参与调查
    ,t7.是否支行行长参与调查
    ,t10.slf_ast_amt                              as 准入时本人资产总额_调查报告
    ,t10.slf_lbl_tot_amt                          as 准入时本人负债总额_调查报告
    ,t4.cred_total_balan    as 准入时授信余额_征信报告
    ,t10.slf_net_ast                              as 准入时本人净资产_调查报告
    ,t10.slf_ast_lbl_rat                          as 准入时本人资产负债率_调查报告
    ,t11.sal_amt            as 准入时销售额_调查报告
    ,t11.npft               as 准入时净利润_调查报告
    ,t12.scor_rng as 当前征信分
    ,case when t12.idv_crd_sco_val<t4.idv_crd_sco_val then (t4.idv_crd_sco_val-t12.idv_crd_sco_val)/t4.idv_crd_sco_val else 0 end as 较准入时下降比例
    ,t6.当前风险等级
    ,t6.是否较准入时下降
    ,t15.合同近3个月的透支率
    ,case when t13_1.cst_id is not null then '是' else '否' end as 客户是否触发精准贷后
	,t13_1.trg_typ                                  as 触犯规则类型代码
    ,t13_1.触犯规则类型
	,t13_1.start_dt                                 as 任务生成日期
	,t13_1.offend_rsn                               as 触犯原因
	,t13_1.offend_rsn_ana                           as 触犯原因分析
	,t13_1.贷后管理意见
	,t13_1.rsk_lvl_zw                               as 客户风险程度判断
	,t16.is_risk_cst                              as 是否风险客户
	,t16.rsk_hidden_cst_ind                       as 是否风险隐患客户
    ,t14.客户准入至今逾期天数3天及以上次数
    ,t12.c_c_6m_avg_use_rate	        as 信用卡最近6个月平均透支率
    ,t12.late_6mon_enqu_count           as 最近6个月审批查询次数
    ,t12.oth_bank_loan_credit_bal       as 他行贷款授信余额
    ,nvl(t12.oth_bank_loan_credit_bal,0) - nvl(t4.oth_bank_loan_credit_bal,0) as 他行贷款授信余额较准入时增长
    ,t12.othr_bnk_mngmt_loan_org_num as 他行经营性贷款授信机构数
    ,t12.c_od_total_amt              as 贷款当前逾期总额
    ,t12.curr_unsett_loan_od_num     as 当前贷款逾期期数
    ,t12.wdil6m                      as 近6个月的最大逾期期数
    ,t12.un_normal_loan_balan        as 贷款五级分类为非正常的余额
    ,t12.五级分类不良贷款余额
    ,t12.report_dt                   as 当前征信报告日期
from SJXQ_SJ2025080806_CST_01 t1
left join(
    select sam_rsk_ctrl_id
        ,sum(ctr_epsr_amt) as 同一风险控制号敞口金额
        ,sum(ctr_epsr_bal) as 同一风险控制号敞口余额
    from SJXQ_SJ2025080806_CST_01_1
    group by sam_rsk_ctrl_id
)t1_1 on t1.sam_rsk_ctrl_id=t1_1.sam_rsk_ctrl_id
left join(
    SELECT  ctr_serno
        ,MIN(is_yh_wdb) AS is_yh_wdb
    from SJXQ_SJ2025080806_CST_02
    group by ctr_serno
)t2 on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ2025080806_CST_03 t3
on t1.ctr_serno=t3.ctr_serno
left join SJXQ_SJ2025080806_CST_04 t4
on t1.cst_id=t4.cst_id
left join(
    SELECT  ctr_serno
    from SJXQ_SJ2025080806_CST_05
    GROUP BY ctr_serno
) t5 on t1.ctr_serno=t5.ctr_serno
left join SJXQ_SJ2025080806_CST_06 t6
on t1.ctr_serno=t6.ctr_serno
left join SJXQ_SJ2025080806_CST_07 t7
on t1.ctr_serno=t7.ctr_serno and t7.rn=1
left join SJXQ_SJ2025080806_CST_08 t8
on t1.ctr_serno=t8.ctr_serno
left join SJXQ_SJ2025080806_CST_09 t9
on t1.ctr_serno=t9.ctr_serno and t9.rn=1
left join SJXQ_SJ2025080806_CST_10 t10
on t1.ctr_serno=t10.ctr_serno and t10.rn=1
left join SJXQ_SJ2025080806_CST_11 t11
on t1.ctr_serno=t11.ctr_serno and t11.rn=1
left join SJXQ_SJ2025080806_CST_12 t12
on t1.cst_id=t12.cst_id
-- left join SJXQ_SJ2025080806_CST_13 t13
-- on t1.cst_id=t13.cst_id
left join SJXQ_SJ2025080806_CST_13_1 t13_1
on t1.cst_id=t13_1.cst_id
and t13_1.rn=1
left join SJXQ_SJ2025080806_CST_14 t14
on t1.ctr_serno=t14.ctr_serno
left join(
    select ctr_srl_no as ctr_serno
        ,rct_90_day_prcp_bal_aggr,ctr_amt
        ,case when ctr_amt=0 then 0 else round(rct_90_day_prcp_bal_aggr/90/ctr_amt,4) end as 合同近3个月的透支率
    from adm_rsk.adm_rsk_ast_loan_ctr_dd	--风险集市合同表
    where dt='20250731'
)t15 on t1.ctr_serno=t15.ctr_serno
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd t16 --客户集市-风险信息-基础风险标签信息
on t1.cst_id=t16.cst_id
and  t16.dt='20250731'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_01
union all
SElECT '01_1' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_01_1
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no,担保人编号) custs
from SJXQ_SJ2025080806_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080806_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno,PRE_ASES_SERNO) custs
from SJXQ_SJ2025080806_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_07 where rn=1
union all
SElECT '08' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_09 where rn=1
union all
SElECT '10' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_10 where rn=1
union all
SElECT '11' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_11 where rn=1
union all
SElECT '12' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080806_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080806_CST_13 where rn=1
union all
SElECT '13_1' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025080806_CST_13_1 where rn=1
union all
SElECT '14' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025080806_CST_14
union all
SElECT '15' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025080806_CST_15
;
/*
01	1770	1770
01_1	1007713	1007713
02	1543	1543
03	1770	1770
04	1763	1763
05	3486	3483
06	578	578
07	1728	1728
08	1	1
09	1514	1514
10	650	650
11	334	334
12	1763	1763
13	278	278
13_1	764	764
14	25	25
15	1770	1770
*/
SElECT '15' seq, *
from lab_sjxq.SJXQ_SJ2025080806_CST_15
limit 100
***邱雯琪_SJ2025081206_台州分行高保重叠.sql
﻿-- 邱雯琪_SJ2025081206_台州分行高保重叠
-- 2024年7月新信贷系统上线后至2025年7月31日，信贷系统识别到的台州分行区域内发生多份高保重叠（多份高保合同的保证人和被担保人完全一致）的数据
-- 担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025081206_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025081206_CST_01 AS
select t1.grnt_ctr_no                              --担保合同编号|c32
	,t1.wrat_cst_id                              --被担保人客户号|c20
	,t1.wrat_nm                                  --被担保人名称|c200
	,t1.grnt_ctr_bgn_dt                          --担保合同起始日期|c8
	,t1.grnt_ctr_mtu_dt                          --担保合同到期日期|c8
	,t1.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,c1.cd_val_dscr     as grnt_ctr_sts_nm
	,t1.sys_reg_dt                               --系统登记日期|c8
	,t1.ctr_sgn_dt                               --合同签收日期|c8
	,t1.mgr_id                                   --管户人工号|c10
    ,t2.empe_nm     as 管户人
	,t1.mgr_org_id                               --管户机构编号|c32
    ,t3.保证人编号
    ,t3.保证人名称
    ,t4.org_nm      as 管户机构
from edw.dim_bus_loan_ctr_grnt_inf_dd       t1 --担保合同信息
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  t1.mgr_id=t2.empe_id
and t2.dt=t1.dt
inner JOIN(
    SELECT GRNT_CTR_NO
    from edw.dim_bus_loan_grnt_ctr_gtor_inf_dd  --担保合同保证人信息
    where dt='20250731'
    GROUP BY GRNT_CTR_NO
) t3 on t1.GRNT_CTR_NO=t3.GRNT_CTR_NO
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='台州分行'
LEFT JOIN edw.dwd_code_library_dd 	        c1 --码值表
ON      t1.GRNT_CTR_STS_CD = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     c1.fld_nm = 'GRNT_CTR_STS_CD'
AND     c1.DT = t1.dt
where t1.dt='20250731'
and t1.grnt_ctr_typ_cd='020'    --020:最高额担保
and t1.grnt_mod_cd regexp '010' --010:保证
and t1.grnt_ctr_bgn_dt>='20240701'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025081206_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025081206_CST_02 AS
SELECT  t1.wrat_cst_id       --被担保人客户号
        ,t1.wrat_nm          --被担保人名称
        ,t1.管户人
        ,t1.管户机构
        ,t1.保证人编号
        ,t1.保证人名称
        ,t1.grnt_ctr_no      --担保合同编号
        ,t1.grnt_ctr_bgn_dt  --担保合同起始日期
        ,t1.grnt_ctr_mtu_dt  --担保合同到期日期
        ,t1.grnt_ctr_sts_nm  --担保合同状态
        ,t1.sys_reg_dt       --系统登记日期
        ,t1.ctr_sgn_dt       --合同签收日期
    ,ROW_NUMBER() over(partition by t1.wrat_cst_id,t1.保证人编号 order by t1.grnt_ctr_bgn_dt asc) as rn
from SJXQ_SJ2025081206_CST_01 t1
INNER JOIN (
    select wrat_cst_id,保证人编号
        ,max(t1.grnt_ctr_bgn_dt) AS max_bgn
        ,min(t1.grnt_ctr_mtu_dt) AS min_mtu
    from SJXQ_SJ2025081206_CST_01 t1
    GROUP BY wrat_cst_id,保证人编号
    having count(1) > 1
)t2 on t1.wrat_cst_id=t2.wrat_cst_id
and t1.保证人编号=t2.保证人编号
;
-- 是否重复
DROP   TABLE IF     EXISTS SJXQ_SJ2025081206_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025081206_CST_03 AS
SELECT  t1.wrat_cst_id       as 被担保人客户号
        ,t1.wrat_nm          as 被担保人名称
        ,t1.管户人
        ,t1.管户机构
        ,t1.保证人编号
        ,t1.保证人名称
        ,t1.grnt_ctr_no      as 担保合同编号
        ,t1.grnt_ctr_bgn_dt  as 担保合同起始日期
        ,t1.grnt_ctr_mtu_dt  as 担保合同到期日期
        ,t1.grnt_ctr_sts_nm  as 担保合同状态
        ,t1.sys_reg_dt       as 系统登记日期
        ,t1.ctr_sgn_dt       as 合同签收日期
        ,t1.rn as 保证人和被担保人完全一致的担保合同序号
        ,case when t1.rn=1 then '首份最高额保证合同'
            when t1.grnt_ctr_bgn_dt between t2.grnt_ctr_bgn_dt and t2.grnt_ctr_mtu_dt then '是' else '否' end as 是否与上份担保合同重叠
from SJXQ_SJ2025081206_CST_02       t1
left join SJXQ_SJ2025081206_CST_02  t2
on t1.wrat_cst_id=t2.wrat_cst_id
and t1.保证人编号=t2.保证人编号
and t1.rn=t2.rn+1
;
SElECT '01' seq, count(1) cnt,count(distinct grnt_ctr_no) custs
from SJXQ_SJ2025081206_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct grnt_ctr_no) custs
from SJXQ_SJ2025081206_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 被担保人客户号) custs
from SJXQ_SJ2025081206_CST_03
;
/*
01	43352	43352
02	5511	5511
03	5511	2685
*/
SElECT *
from SJXQ_SJ2025081206_CST_03
***邵梦婷_SJ2025022581_衢州分行信贷数据.sql
﻿-- 截止2025.02.25，衢州分行有未到期未终结授信业务数据，且年龄65岁以上。
DROP   TABLE IF     EXISTS SJXQ_SJ2025022581_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022581_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,datediff(to_date(t1.ctr_bgn_dt,'yyyyMMdd'),to_date(t1.SYS_REG_DT,'yyyyMMdd'),'dd') hdl_bgn_days
    ,replace(add_months(to_date(t1.SYS_REG_DT,'yyyyMMdd'),12),'-','') as SYS_REG_DT_1y
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,t1.cpt_usg_cd	--资金用途代码|c4
    ,t1.cpt_usg_rmk	--资金用途备注|c4000
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
    ,t2.pd_nm
    ,t4.brc_org_nm
    ,t6.age
    ,t6.mrg_situ_cd	--	婚姻状况
    ,t6.bth_dt	--出生日期
    ,c1.cd_val_dscr     as mrg_situ_nm
    ,CASE WHEN A9.usc_aply_serno IS NOT NULL THEN '是' ELSE '否' END AS 配偶是否签字
    ,t8.fst_hdl_dt
    ,case when t8.fst_hdl_dt>t6.bth_dt then round(datediff(to_date(t8.fst_hdl_dt,'yyyyMMdd'),to_date(t6.bth_dt,'yyyyMMdd'),'dd')/365,1)
        else null end as 客户首次办理我行信贷业务时年龄
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt=t1.dt
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt=t1.dt
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t6 --对私客户基础信息
on t1.cst_id=t6.cst_id
and t6.dt=t1.dt
LEFT JOIN
(
	SELECT  distinct usc_aply_serno
	FROM edw.dwd_bus_loan_reply_biz_loan_jnt_acptor_dd --共同承诺人信息
	WHERE DT = '20250225'
	AND rel_typ = '0301' --配偶
) A9
ON t1.rel_serno = A9.usc_aply_serno
LEFT JOIN    EDW.DWD_CODE_LIBRARY c1
ON      T6.MRG_SITU_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWS_CST_IDV_BAS_INF_DD'
AND     c1.FLD_NM = 'MRG_SITU_CD'
left join(
    select ctr_serno,min(SYS_REG_DT) as fst_hdl_dt
    from edw.dim_bus_loan_ctr_bse_inf_dd
    where dt='20250225'
    group by ctr_serno
)t8 on t1.ctr_serno=t8.ctr_serno
where t1.dt='20250225'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
and t4.brc_org_nm='衢州分行'
and t6.age>=65
;
-- 同一户籍地客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025022581_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022581_CST_02 AS
SElECT reg_adr
    ,count(DISTINCT cst_id) as custs
from(
    select cst_id,cst_chn_nm,reg_adr --户籍地址
    from edw.dws_cst_bas_inf_dd
    where dt = '20250225'
    and nvl(reg_adr,'')<>''
    union
    select cst_id,cst_chn_nm,fml_adr --家庭地址
    from edw.dws_cst_bas_inf_dd
    where dt = '20250225'
    and nvl(fml_adr,'')<>''
)t1 group by reg_adr having custs>1
;
-- 发放时，1年内查询次数，查询家数，通过家数
DROP   TABLE IF     EXISTS SJXQ_SJ2025022581_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022581_CST_03 AS
select t1.cst_id,t1.ctr_serno,t1.sys_reg_dt
    ,REPLACE(substr(t2.report_dt,1,10),'-','') as report_dt
    ,t2.late_year_enqu_count	--最近1年内的查询次数
    ,t2.late_1year_enqu_org_num	--最近1年审批查询机构数
    ,t2.late_6mon_org_pass_num	--最近6个月金融机构审批通过家数
    ,row_number() over(partition by t1.ctr_serno order by t2.report_dt desc) rn --发放时最新征信
from SJXQ_SJ2025022581_CST_01               t1
inner join edw.dws_cst_ccrc_idv_ind_inf_dd	t2 --个人征信指标信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and REPLACE(substr(t2.report_dt,1,10),'-','')<=t1.sys_reg_dt
;
-- 发放后，1年内查询次数，查询家数，通过家数
DROP   TABLE IF     EXISTS SJXQ_SJ2025022581_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022581_CST_04 AS
select t1.cst_id,t1.ctr_serno,t1.sys_reg_dt
    ,REPLACE(substr(t2.report_dt,1,10),'-','') as report_dt
    ,t2.late_year_enqu_count	--最近1年内的查询次数
    ,t2.late_1year_enqu_org_num	--最近1年审批查询机构数
    ,t2.late_6mon_org_pass_num	--最近6个月金融机构审批通过家数
    ,row_number() over(partition by t1.ctr_serno order by t2.report_dt asc) rn --发放1年后首次查询征信
from SJXQ_SJ2025022581_CST_01               t1
inner join edw.dws_cst_ccrc_idv_ind_inf_dd	t2 --个人征信指标信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and REPLACE(substr(t2.report_dt,1,10),'-','')>=t1.SYS_REG_DT_1y
;
-- 发放时模型分
DROP   TABLE IF     EXISTS SJXQ_SJ2025022581_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022581_CST_05 AS
SELECT t1.cst_id,t1.ctr_serno,t1.sys_reg_dt,t2.dt
    ,DECODE(t2.modl_rsk_lyr_cd,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') as modl_rsk_lyr_nm
    ,t2.modl_grd	--	模型分|c20
    ,ROW_NUMBER() over(partition by t1.ctr_serno order by t2.dt desc,t2.rsk_lyr_afm_tm desc) rn 	--风险分层认定时间
FROM SJXQ_SJ2025022581_CST_01           t1
INNER JOIN edw.dim_cst_asst_rsk_lyr_dd  t2
on t1.cst_id=t2.cst_id
and t2.dt<='20250225'
and t2.dt <= t1.sys_reg_dt
and nvl(t2.modl_grd,'')<>''
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025022581_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022581_CST_06 AS
SELECT  t1.ctr_serno   AS 合同流水号
    ,t1.cst_id      AS 客户号
    ,t1.cst_nm      AS 客户名称
    ,t1.age         AS 年龄
    ,t1.mrg_situ_nm AS 婚姻状况
    ,t1.ctr_amt     AS 合同金额
    ,t1.ctr_bal     AS 合同余额
    ,t1.SYS_REG_DT  AS 系统登记日期
    ,t1.配偶是否签字
    ,CASE WHEN nvl(t1.grnt_mod_colc,'') <> '' THEN '是'  ELSE '否' END AS 是否有担保
    ,t1.cpt_usg_rmk                                                  AS 资金用途备注
    ,t1.pd_nm                                                        AS 产品名称
    ,CASE WHEN t1.is_xfd = 1 THEN '个人消费性贷款'
        WHEN t1.is_jyd = 1 THEN '个人经营性贷款'  ELSE '' END 经营或消费型
    ,t4.slf_ast_lbl_rat	--本人资产负债率
    ,t4.ast_lbl_rat	    --资产负债率
    ,t2.late_year_enqu_count	as 发放时最近1年内的查询次数
    ,t2.late_1year_enqu_org_num	as 发放时最近1年审批查询机构数
    ,t2.late_6mon_org_pass_num	as 发放时最近6个月金融机构审批通过家数
    ,t3.late_year_enqu_count	as 发放1年后最近1年内的查询次数
    ,t3.late_1year_enqu_org_num	as 发放1年后最近1年审批查询机构数
    ,t3.late_6mon_org_pass_num	as 发放1年后最近6个月金融机构审批通过家数
    ,t5.curr_unsett_cred_loan_org_num	as	当前未结清信用贷款机构数
    ,t6.modl_grd as 发放时模型分
    ,coalesce(t8.同一户籍地客户,t9.同一户籍地客户) as 同一户籍地客户
    ,coalesce(t8.custs,t9.custs) as 同一户籍地客户数
    ,case when t7.doc_nbr like '3308%' or t7.reg_adr regexp '衢州' then '是'  ELSE '否' END AS 是否衢州户籍
    ,t1.客户首次办理我行信贷业务时年龄
from SJXQ_SJ2025022581_CST_01       t1
left join SJXQ_SJ2025022581_CST_03  t2 --发放时
on t1.ctr_serno=t2.ctr_serno
and t2.rn=1
left join SJXQ_SJ2025022581_CST_04  t3 --发放1年后
on t1.ctr_serno=t3.ctr_serno
and t3.rn=1
left join(
    select cst_id
        ,slf_ast_lbl_rat	--本人资产负债率
        ,ast_lbl_rat	    --资产负债率
        ,row_number() over(partition by cst_id order by rcd_tm desc) rn
    from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
    where dt='20250225'
)t4 on t1.cst_id=t4.cst_id
and t4.rn=1
left join edw.dws_cst_ccrc_idv_ind_inf_dd	t5 --个人征信指标信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250225'
and t5.report_dsc_rn=1
left join SJXQ_SJ2025022581_CST_05  t6
on t1.ctr_serno=t6.ctr_serno
and t6.rn=1
left join edw.dws_cst_bas_inf_dd    t7
on t1.cst_id=t7.cst_id
and t7.dt = '20250225'
left join SJXQ_SJ2025022581_CST_02  t8
on t7.reg_adr=t8.reg_adr
left join SJXQ_SJ2025022581_CST_02  t9
on t7.fml_adr=t9.reg_adr
;
SElECT concat(合同流水号,'%'), *
from SJXQ_SJ2025022581_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025022581_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct reg_adr) custs
from SJXQ_SJ2025022581_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025022581_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025022581_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025022581_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025022581_CST_06
;
/*
01	645	645
02	2152637	2152637
03	628	628
04	432	432
05	419	419
06	645	645
*/
***郑一_SJ2025071056_随贷通消费贷促活.sql
﻿-- 郑一_SJ2025071056_随贷通消费贷促活
-- 截至25年6月30日，温州分行随贷通和消费贷款产品数据
-- 导入数据 均为个人客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025071056_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071056_CST_01 AS
SELECT  col_1 --信贷合同流水号
       ,col_2 --客户号
       ,col_3 --产品编号码值
       ,col_4 --执行月利率
       ,col_5 --合同金额
       ,col_6 --合同余额
       ,'随贷通' as 产品类型
from lab_bigdata_dev.qbi_file_20250710_14_42_23_0
where pt<>''
union all
SELECT  col_1 --信贷合同流水号
       ,col_2 --客户号
       ,col_3 --产品编号码值
       ,col_4 --执行月利率
       ,col_5 --合同金额
       ,col_6 --合同余额
       ,'消费贷款'
from lab_bigdata_dev.qbi_file_20250710_14_42_48_0
where pt<>''
;
--客户在我行最低产品利率
DROP   TABLE IF     EXISTS SJXQ_SJ2025071056_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071056_CST_02 AS
SELECT t1.cst_id,t1.his_min_intr
    ,t2.curr_min_intr
from(
    select cst_id                                   --客户号
        ,min(exec_intr_rat) as his_min_intr
    from edw.dim_bus_loan_ctr_bse_inf_dd            --合同基础信息
    where dt<='20250630'
    and exec_intr_rat<>0
    and PRD_NO not like '2002010101%'       --剔除信用卡
    group by cst_id
)t1 left join(
    select cst_id                                   --客户号
        ,min(exec_intr_rat) as curr_min_intr
    from edw.dim_bus_loan_ctr_bse_inf_dd            --合同基础信息
    where dt='20250630'
    and PRD_NO not like '2002010101%'       --剔除信用卡
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
;
-- 当前有未结清授信额度&ge;5万元（剔除房贷）且月利率&ge;3.5&permil;的他行贷款
-- 授信金额	贷款余额	贷款到期日
DROP   TABLE IF     EXISTS SJXQ_SJ2025071056_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071056_CST_03 AS
select t1.cst_id
    ,t1.report_id
    ,t1.act_id
    ,t1.id
    ,t1.act_typ_cd
    ,t1.start_dt	        --贷款开始日期|C8
    ,t1.mtu_dt	            --贷款结束日期|C8
    ,case when t1.act_crd_lmt=0 then t1.ctr_amt else t1.act_crd_lmt end as act_crd_lmt  --账户授信额度
    ,case when t1.ctr_amt=0 then t1.act_crd_lmt else t1.ctr_amt end as ctr_amt          --贷款金额|DECIMAL(16,2)
    ,t1.ctr_bal             --贷款余额|DECIMAL(16,2)
    ,t1.rpay_trm            --还款期数|C4
    ,t1.rmn_rpay_trm        --剩余还款期数|C4
    ,t1.pd_cd               --业务产品种类代码|C60
    ,CASE
        WHEN t1.pd_cd = '11' THEN '个人住房商业贷款'
        WHEN t1.pd_cd = '12' THEN '个人商用房贷款'
        WHEN t1.pd_cd = '13' THEN '个人住房公积金贷款'
        WHEN t1.pd_cd = '21' THEN '个人汽车消费贷款'
        WHEN t1.pd_cd = '31' THEN '个人助学贷款'
        WHEN t1.pd_cd = '32' THEN '国家助学贷款'
        WHEN t1.pd_cd = '33' THEN '商业助学贷款'
        WHEN t1.pd_cd = '41' THEN '个人经营性贷款'
        WHEN t1.pd_cd = '42' THEN '个人创业担保贷款'
        WHEN t1.pd_cd = '51' THEN '农户贷款'
        WHEN t1.pd_cd = '52' THEN '经营性农户贷款'
        WHEN t1.pd_cd = '53' THEN '消费性农户贷款'
        WHEN t1.pd_cd = '91' THEN '其他个人消费贷款'
        WHEN t1.pd_cd = '99' THEN '其他贷款'
        WHEN t1.pd_cd = '71' THEN '准贷记卡'
        WHEN t1.pd_cd = '81' THEN '贷记卡'
        WHEN t1.pd_cd = '82' THEN '大额专项分期卡'
        WHEN t1.pd_cd = '61' THEN '约定购回式证券交易'
        WHEN t1.pd_cd = '62' THEN '股票质押式回购交易'
        WHEN t1.pd_cd = '63' THEN '融资融券业务'
        WHEN t1.pd_cd = '64' THEN '其他证券类融资'
        WHEN t1.pd_cd = '92' THEN '融资租赁业务'
        WHEN t1.pd_cd = 'A1' THEN '资产处置'
        WHEN t1.pd_cd = 'B1' THEN '代偿债务' else '' END AS pd_cd_nm --贷款类型
    ,t1.grnt_mth_cd         --担保方式代码|C60
    ,t1.act_sts_cd          --账户状态代码|C60
    ,t1.late_one_tm_rpay_dt --最近一次还款日期|C8
    ,t1.cls_dt              --关闭日期|date
from   edw.dim_cst_ccrc_idv_loan_inf_dd         t1
inner join edw.dws_cst_ccrc_idv_ind_inf_dd	    t3 --个人征信指标信息表
on  t1.cst_id=t3.cst_id
and t1.report_id=t3.report_no
and t3.dt = '20250630'
and t3.report_dsc_rn = 1
INner join(
    SELECT distinct col_2 as cst_id
    from SJXQ_SJ2025071056_CST_01
)t4 on t1.cst_id=t4.cst_id
where t1.dt = '20250630'
and   t1.dtrb_org <> 'ZJTLCB'    --他行
and   (t1.ctr_bal > 0 OR t1.rmn_rpay_trm > 0)   --未结清
;
-- 贷款月利率
DROP   TABLE IF     EXISTS SJXQ_SJ2025071056_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071056_CST_04 AS
select distinct t1.prm_id	            --	主键ID|c32
    ,t1.crd_rpt_id	            --	信用报告id|c32
    ,t1.act_id	            --	账户编号|C5
    ,t1.act_typ_cd	            --	账户类型代码|c60
    ,t1.org_cd	            --	机构代码|c60
    ,t1.bus_cls_cd	            --	业务种类代码|c60
    ,t1.brw_crd_amt	            --	借款金额/授信金额|c22
    ,t1.bgn_dt	            --	起始日期|date
    ,t1.mtu_dt	            --	到期日期|date
    ,t1.rpay_trm	        --	还款期数|c8
    ,t1.intr_rat	        --	月利率（单位：&permil;,计算得到，因部分借据应还款额为空/已还期数未知/其他原因，导致月利率无法计算,-9999为空）
    ,t1.rpay_mth	            --	还款方式|c32
    ,t1.inpt_dt	            --	录入日期|c8
from   edw.dim_cst_ccrc_idv_dbt_act_rat_dd      t1
inner join edw.dws_cst_ccrc_idv_ind_inf_dd	    t3 --个人征信指标信息表
on  t1.CRD_RPT_ID=t3.report_no
and t3.dt = '20250630'
and t3.report_dsc_rn = 1
INner join(
    SELECT distinct col_2 as cst_id
    from SJXQ_SJ2025071056_CST_01
)t4 on t3.cst_id=t4.cst_id
where t1.dt = '20250630'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071056_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071056_CST_05 AS
SELECT  t1.col_1        AS 信贷合同流水号
       ,t1.col_2        AS 客户号
       ,t1.col_3        AS 产品编号码值
       ,t1.col_4        AS 执行月利率
       ,t1.col_5        AS 合同金额
       ,t1.col_6        AS 合同余额
       ,t1.产品类型
       ,t2.his_min_intr AS 我行最低产品利率
       ,t3.量化风险等级
       ,t4.pd_cd_nm     as 他行贷款产品类型
       ,t4.ctr_amt      AS 贷款金额
       ,t4.ctr_bal      AS 贷款余额
       ,t4.mtu_dt       AS 贷款结束日期
       ,t4.intr_rat     AS 他行贷款月利率
from SJXQ_SJ2025071056_CST_01       t1
left join SJXQ_SJ2025071056_CST_02  t2
on t1.col_2=t2.cst_id
left join(
    -- 取量化风险等级的时候要把'在逾'转为'在逾/重组'
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250630'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250630'
)t3 on t1.col_2=t3.cst_id
left join(
    SELECT t1.cst_id
        ,t1.pd_cd_nm            --他行贷款产品类型
        ,t1.ctr_amt             --贷款金额|DECIMAL(16,2)
        ,t1.ctr_bal             --贷款余额|DECIMAL(16,2)
        ,t1.mtu_dt	            --贷款结束日期|C8
        ,t2.intr_rat
    from SJXQ_SJ2025071056_CST_03       t1
    INNER JOIN SJXQ_SJ2025071056_CST_04 t2
    on t1.report_id=t2.crd_rpt_id
    and t1.act_id=t2.act_id
    where t1.ctr_amt>=50000
    and t1.pd_cd not like '1%'    --剔除房贷
    and t2.intr_rat>3.5     --月利率
)t4 on t1.col_2=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2025071056_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025071056_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct report_id,act_id) custs
from SJXQ_SJ2025071056_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct crd_rpt_id,act_id) custs
from SJXQ_SJ2025071056_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071056_CST_05
;
/*
01	13657	13196
02	1903743	1903743
03	41516	41516
04	30432	30432
05	16888	13196
*/
SElECT '05' seq, *
from SJXQ_SJ2025071056_CST_05
***郑华杰_SJ2025061076_量化风险等级.sql
-- 导入数据
DROP   TABLE IF EXISTS SJXQ_SJ2025061076_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2025061076_CST_01
(
    cst_id      string COMMENT ''
)
;
insert into SJXQ_SJ2025061076_CST_01
;
DROP   TABLE IF EXISTS SJXQ_SJ2025061076_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2025061076_CST_02 as
SELECT  distinct t1.cst_id              AS 客户号
       ,t2.risk_layer_level_10 AS 量化画像风险等级
from SJXQ_SJ2025061076_CST_01 t1
left join(
    select cst_id
        ,risk_layer_level_10         --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250531'
    union
    select cst_id
        ,RISK_MODEL_LEVEL_TEN       -- COMMENT '信用等级(10级)'
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250531'
)t2 on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061076_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061076_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025061076_CST_02
***郑娴阳_SJ2025042206_风险逾期客户清单.sql
-- 只取这两个字段：是否风险客户、是否逾期客户（含核销）
-- 行内风险贷款口径：本金逾期30天、利息逾期60天、重组贷款（包含助兴通）、预保预报（下迁）、信用卡逾期3期以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_01 AS
select t1.cst_id
    ,t1.is_risk_cst                              as 是否风险客户
    ,case when t2.cst_id is not null then 'Y' else 'N' end as 是否逾期客户_含核销
    ,t2.max_ovd_dt
from adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd    t1
left join(
    select cst_id                                   --客户编号
        ,max(dt)    as max_ovd_dt
    from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd     --风险集市信贷业务借据信息表
    where dt<='@@{yyyyMMdd}'
    and is_ovd='1'  --逾期借据
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 存量20241231之前办理泰惠收未配贷清单20250331_Sheet1
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_02 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_55_52_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 存量泰惠收所有状态截止20250331_Sheet4
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_03 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_56_33_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 附件1舟山分行个体户贷款流失群组20241231_Sheet2
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_04 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_57_03_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 个体户流失清单近一年EVA截止20241231_Sheet2
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_05 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_57_33_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 随贷通到期卡清单20250417_Sheet0
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_06 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_58_00_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 随贷通未激活清单20250417_Sheet0
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_07 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_58_39_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 随贷通长期未用信清单20250417_Sheet0
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_08 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_59_04_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
-- 新增20250101后办理泰惠收未配贷清单20250331_Sheet1
DROP   TABLE IF     EXISTS SJXQ_SJ2025042206_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042206_CST_09 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 客户号
    ,t1.col_3  as 客户姓名
    ,t2.是否风险客户
    ,t2.是否逾期客户_含核销
from lab_bigdata_dev.qbi_file_20250423_10_59_30_0 t1
left join SJXQ_SJ2025042206_CST_01 t2
on t1.col_2=t2.cst_id
where t1.pt<>''
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042206_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025042206_CST_09
;
-- 输出结果
-- 存量20241231之前办理泰惠收未配贷清单20250331_Sheet1
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_02;
-- 存量泰惠收所有状态截止20250331_Sheet4
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_03;
-- 附件1舟山分行个体户贷款流失群组20241231_Sheet2
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_04;
-- 个体户流失清单近一年EVA截止20241231_Sheet2
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_05;
-- 随贷通到期卡清单20250417_Sheet0
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_06;
-- 随贷通未激活清单20250417_Sheet0
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_07;
-- 随贷通长期未用信清单20250417_Sheet0
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_08;
-- 新增20250101后办理泰惠收未配贷清单20250331_Sheet1
SElECT * from lab_sjxq.SJXQ_SJ2025042206_CST_09;***郑娴阳_SJ20250422121_客户价值提升与挽回.sql
/*
截止20250331舟山分行数据
数据需求字段
1.全量贷款客户中未配随贷通卡清单（客户号，客户名，是否风险客户，是否逾期客户，分贷款额度区间）
2.全量贷款客户中已配随贷通卡清单（客户号，客户名，是否风险客户，是否逾期客户，分贷款额度区间，随贷通启用额度，随贷通利率，是否在正常使用，是否已经提前结清，是否长期未用信。）
3.存量随贷通卡卡客户（客户号，客户名，是否风险客户，是否逾期客户，随贷通启用额度，随贷通利率，是否在正常使用，是否已经提前结清，是否长期未用信。）
贷款是指非循环类经营性贷款未结清且没有循环类贷款合同存续
分贷款额度区间：0-30（含），30-100（含），100-150（含），150以上
是否在正常使用：目前还有余额的，现在有借据的
是否已经提前结清：合同还在，以前用过信，目前无用信
是否长期未用信：签合同以来未用过信
*/
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ20250422121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422121_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%'
        OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1
        else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.strt_use_amt	--启用金额|decimal(21,2)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm --0:非循环|1:自助循环|2:半自助循环
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end as is_sdt
    ,t1.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' ) AND     t1.TMT_DT = '18991231'
        AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) then 1 else 0 end as is_wjq --未到期未终结口径 是否未结清
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='舟山分行'
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = t1.dt
where t1.dt='20250331'
;
--用信情况
DROP   TABLE IF     EXISTS SJXQ_SJ20250422121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422121_CST_02 AS
select t1.CTR_SERNO                                --合同流水号|C32
    ,sum(t1.PRCP_BAL) as curr_bal
from edw.dim_bus_loan_dbil_inf_dd    t1          --信贷借据信息
inner join SJXQ_SJ20250422121_CST_01 t2
on t1.CTR_SERNO=t2.CTR_SERNO
where t1.dt='20250331'
group by t1.CTR_SERNO
;
-- 风险逾期客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250422121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422121_CST_03 AS
select t1.cst_id
    ,t1.is_risk_cst                              as 是否风险客户
    ,case when t2.cst_id is not null then 'Y' else 'N' end as 是否逾期客户_含核销
    ,t2.max_ovd_dt
from adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd    t1
left join(
    select cst_id                                   --客户编号
        ,max(dt)    as max_ovd_dt
    from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd     --风险集市信贷业务借据信息表
    where dt<='@@{yyyyMMdd}'
    and is_ovd='1'  --逾期借据
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果1  全量贷款客户中未配随贷通卡清单（客户号，客户名，是否风险客户，是否逾期客户，分贷款额度区间）
DROP   TABLE IF     EXISTS SJXQ_SJ20250422121_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422121_CST_04 AS
select t1.cst_id    as 客户号
    ,t4.cst_chn_nm  as 客户名称
    ,t5.是否风险客户
    ,t5.是否逾期客户_含核销
    -- 0-30（含），30-100（含），100-150（含），150以上
    ,case when t6.ctr_amt >=0 and t6.ctr_amt<=300000 then '[0,30w]'
        when t6.ctr_amt >300000 and t6.ctr_amt<=1000000 then '(30w,100w]'
        when t6.ctr_amt >1000000 and t6.ctr_amt<=1500000 then '(100w,150w]'
        when t6.ctr_amt >1500000 then '150万以上' else '' end as 合同金额区间
from(
    select distinct cst_id
    from SJXQ_SJ20250422121_CST_01
    where RVLG_TYP_CD='0' and is_jyd=1 and is_wjq=1  --非循环类经营性贷款未结清
)t1 left join(
    select distinct cst_id
    from SJXQ_SJ20250422121_CST_01
    where RVLG_TYP_CD<>'0' and is_wjq=1  --循环类贷款合同存续
)t2 on t1.cst_id=t2.cst_id
left join(
    select distinct cst_id
    from SJXQ_SJ20250422121_CST_01
    where is_sdt=1
)t3 on t1.cst_id=t3.cst_id
left join edw.dws_cst_bas_inf_dd 	t4			    --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
left join SJXQ_SJ20250422121_CST_03 t5
on t1.cst_id=t5.cst_id
left join(
    select t1.cst_id                                   --客户号|C20
	    ,sum(t1.ctr_amt) as ctr_amt --合同金额区间
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250331'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by t1.cst_id
)t6 on t1.cst_id=t6.cst_id
where t2.cst_id is null --没有循环类贷款合同存续
and t3.cst_id is null   --未配随贷通
;
-- 输出结果2  随贷通启用额度，随贷通利率，是否在正常使用，是否已经提前结清，是否长期未用信
DROP   TABLE IF     EXISTS SJXQ_SJ20250422121_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422121_CST_05 AS
select t1.cst_id    as 客户号
    ,t4.cst_chn_nm  as 客户名称
    ,t5.是否风险客户
    ,t5.是否逾期客户_含核销
    -- 0-30（含），30-100（含），100-150（含），150以上
    ,case when t6.ctr_amt >=0 and t6.ctr_amt<=300000 then '[0,30w]'
        when t6.ctr_amt >300000 and t6.ctr_amt<=1000000 then '(30w,100w]'
        when t6.ctr_amt >1000000 and t6.ctr_amt<=1500000 then '(100w,150w]'
        when t6.ctr_amt >1500000 then '150万以上' else '' end as 合同金额区间
    ,t3.strt_use_amt as 启用金额
    ,t3.exec_intr_rat as 执行利率
    ,t3.是否在正常使用
    ,t3.是否已经提前结清
    ,t3.是否长期未用信
from(
    select distinct cst_id
    from SJXQ_SJ20250422121_CST_01
    where RVLG_TYP_CD='0' and is_jyd=1 and is_wjq=1  --非循环类经营性贷款未结清
)t1 left join(
    select distinct cst_id
    from SJXQ_SJ20250422121_CST_01
    where RVLG_TYP_CD<>'0' and is_wjq=1  --循环类贷款合同存续
)t2 on t1.cst_id=t2.cst_id
left join(
    select t1.cst_id
        ,sum(t1.strt_use_amt) 	as strt_use_amt --启用金额
        ,max(case when t2.curr_bal>0 then 1 else 0 end) as 是否在正常使用
        ,max(case when t2.curr_bal=0 then 1 else 0 end) as 是否已经提前结清
        ,max(case when t2.ctr_serno is null then 1 else 0 end) as 是否长期未用信
    from SJXQ_SJ20250422121_CST_01      t1
    left join SJXQ_SJ20250422121_CST_02 t2
    on t1.ctr_serno=t2.ctr_serno
    where t1.is_sdt=1
    group by t1.cst_id
)t3 on t1.cst_id=t3.cst_id
left join edw.dws_cst_bas_inf_dd 	t4			    --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
left join SJXQ_SJ20250422121_CST_03 t5
on t1.cst_id=t5.cst_id
left join(
    select t1.cst_id                                   --客户号|C20
	    ,sum(t1.ctr_amt) as ctr_amt --合同金额区间
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250331'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by t1.cst_id
)t6 on t1.cst_id=t6.cst_id
where t2.cst_id is null --没有循环类贷款合同存续
and t3.cst_id is not null   --配随贷通
;
-- 输出结果3  存量随贷通卡卡客户（客户号，客户名，是否风险客户，是否逾期客户，随贷通启用额度，随贷通利率，是否在正常使用，是否已经提前结清，是否长期未用信。）
DROP   TABLE IF     EXISTS SJXQ_SJ20250422121_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422121_CST_06 AS
select t1.cst_id    as 客户号
    ,t4.cst_chn_nm  as 客户名称
    ,t5.是否风险客户
    ,t5.是否逾期客户_含核销
    ,t1.strt_use_amt as 启用金额
    ,t1.exec_intr_rat as 执行利率
    ,t1.是否在正常使用
    ,t1.是否已经提前结清
    ,t1.是否长期未用信
from(
    select t1.cst_id
        ,sum(t1.strt_use_amt) 	as strt_use_amt --启用金额
        ,max(case when t2.curr_bal>0 then 1 else 0 end) as 是否在正常使用
        ,max(case when t2.curr_bal=0 then 1 else 0 end) as 是否已经提前结清
        ,max(case when t2.ctr_serno is null then 1 else 0 end) as 是否长期未用信
    from SJXQ_SJ20250422121_CST_01      t1
    left join SJXQ_SJ20250422121_CST_02 t2
    on t1.ctr_serno=t2.ctr_serno
    where t1.is_sdt=1
    group by t1.cst_id
)t1
left join edw.dws_cst_bas_inf_dd 	t4			    --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20250331'
left join SJXQ_SJ20250422121_CST_03 t5
on t1.cst_id=t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ20250422121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ20250422121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250422121_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250422121_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250422121_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250422121_CST_06
;
SElECT '04' seq, *
from SJXQ_SJ20250422121_CST_04
;
SElECT '05' seq, *
from SJXQ_SJ20250422121_CST_05
;
SElECT '06' seq, *
from SJXQ_SJ20250422121_CST_06
***郑娴阳_SJ20250806116_舟山分行客户交接.sql
﻿-- 郑娴阳_SJ20250806116_舟山分行客户交接
-- 信贷客户交接明细
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_01 AS
SELECT a.cst_id
    ,a.bfr_hdv_cst_magr_id	--移交前客户经理工号
    ,t1.empe_nm     as 移交前客户经理
    ,a.bfr_hdv_mgr_org_no	--移交前管户机构编号
    ,t5.org_nm      as 移交前管户机构
    ,a.aft_hdv_cst_magr_id	--移交后客户经理工号
    ,t2.empe_nm     as 移交后客户经理
    ,a.aft_hdv_mgr_org_no	--移交后管户机构编号
    ,t4.org_nm      as 移交后管户机构
    ,a.sys_reg_psn	        --系统登记人
    ,t3.empe_nm     as 系统登记人
	,a.aply_dt                                  --申请日期
    ,substr(REPLACE(a.sys_reg_tm, '-', ''),1,8) as HDV_DT   --交接日期
    ,to_char(dateadd(to_date(substr(REPLACE(a.sys_reg_tm, '-', ''),1,8),'yyyyMMdd'),-2,'dd'),'yyyyMMdd') as hdv_dt_q2d
    ,to_char(dateadd(to_date(substr(REPLACE(a.sys_reg_tm, '-', ''),1,8),'yyyyMMdd'),2,'dd'),'yyyyMMdd') as hdv_dt_h2d
    ,t4.brc_org_nm
    ,row_number() over(partition by a.cst_id order by a.sys_reg_tm desc) rn
FROM    edw.loan_cst_mgr_hdv_rcd AS a  --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
left join edw.dws_hr_empe_inf_dd    t1 --员工汇总信息
on a.bfr_hdv_cst_magr_id=t1.empe_id
and t1.dt=a.dt
left join edw.dws_hr_empe_inf_dd    t2 --员工汇总信息
on a.aft_hdv_cst_magr_id=t2.empe_id
and t2.dt=a.dt
left join edw.dws_hr_empe_inf_dd    t3 --员工汇总信息
on a.sys_reg_psn=t3.empe_id
and t3.dt=a.dt
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd AS t4 --机构树_考核维度
ON  a.aft_hdv_mgr_org_no = t4.org_id
AND t4.dt = a.dt
and t4.brc_org_nm ='舟山分行'
left JOIN    edw.dim_hr_org_mng_org_tree_dd AS t5 --机构树_考核维度
ON  a.bfr_hdv_mgr_org_no = t5.org_id
AND t5.dt = a.dt
WHERE a.dt = '20250731'
and a.del_ind='0'	--	删除标识
AND REPLACE(a.sys_reg_tm, '-', '') between '20250101' and '20250731'
AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
AND a.hdv_typ = '1'
and a.bfr_hdv_cst_magr_id<>a.aft_hdv_cst_magr_id
;
--交接时
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_02 AS
SELECT  t1.cst_id
       ,t1.HDV_DT
       ,t2.ctr_amt                 AS 交接时授信金额
       ,t2.ctr_bal                 AS 交接时用信余额
       ,t6.vld_loan_act            AS 交接时是否有效贷款户
       ,t5.vld_dep_act             AS 交接时是否有效存款户
       ,t9.val_cst                 AS 交接时是否有价值客户
       ,t3.loan_bal_90_avg         AS 交接时近90天贷款余额日均
       ,t4.dep_bal_90_avg          AS 交接时近90天存款余额日均
       ,t7.last_90_ftp_bus_inc_avg AS 交接时近90天FTP营业收入日均
       ,t8.is_risk_cst             as 交接时是否风险客户
from SJXQ_SJ20250806116_CST_01 t1
left join(
    SELECT  t1.cst_id
        ,t1.dt
        ,SUM(ctr_amt) AS ctr_amt
        ,SUM(ctr_bal) AS ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    where t1.dt >='20250101'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    and ((t1.CTR_STS_CD IN ( '2' , '4' ) AND t1.TMT_DT = '18991231'
    AND to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0)
    group by t1.cst_id,t1.dt
)t2 on t1.cst_id=t2.cst_id
and t1.HDV_DT=t2.dt
left join adm_pub.adm_csm_cbus_loan_inf_dd	    t3  --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt=t1.HDV_DT and t3.dt>='20250101'
left join adm_pub.adm_csm_cbus_dep_inf_dd	    t4  --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=t1.HDV_DT and t4.dt>='20250101'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     t5 --规则通用金融行为存款标签
on t1.cst_id=t5.cst_id
and t5.dt=t1.HDV_DT and t5.dt>='20250101'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t6 --通用金融行为贷款标签表2
on t1.cst_id=t6.cst_id
and t6.dt=t1.HDV_DT and t6.dt>='20250101'
left join adm_pub.adm_csm_cbus_ftp_inf_dd	    t7  --客户集市-业务信息-客户FTP业务
on t1.cst_id=t7.cst_id
and t7.dt=t1.HDV_DT and t7.dt>='20250101'
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd    t8 --客户集市-风险信息-基础风险标签信息
on t1.cst_id=t8.cst_id
and t8.dt=t1.HDV_DT and t8.dt>='20250101'
left join adm_ind.adm_ind_l_rul_unvs_cst_val_l4_dd	    t9 --客户通用风险评估标签表4
on t1.cst_id=t9.cst_id
and t9.dt=t1.HDV_DT and t9.dt>='20250101'
where t1.rn=1
;
-- 2025年7月31日数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_03 AS
SELECT  t1.cst_id
       ,t1.HDV_DT
       ,t2.ctr_amt                 AS 当前授信金额
       ,t2.ctr_bal                 AS 当前用信余额
       ,t6.vld_loan_act            AS 当前是否有效贷款户
       ,t5.vld_dep_act             AS 当前是否有效存款户
       ,t9.val_cst                 AS 当前是否有价值客户
       ,t3.loan_bal_90_avg         AS 当前近90天贷款余额日均
       ,t4.dep_bal_90_avg          AS 当前近90天存款余额日均
       ,t7.last_90_ftp_bus_inc_avg AS 当前近90天FTP营业收入日均
       ,t8.is_risk_cst             AS 当前是否风险客户
       ,t10.hdv_cnt                AS 2025年内交接次数
       ,case when t11.cst_id is not null then '是' else '否' end as 是否2025年新发生风险贷款客户
from SJXQ_SJ20250806116_CST_01 t1
left join(
    SELECT  t1.cst_id
        ,SUM(ctr_amt) AS ctr_amt
        ,SUM(ctr_bal) AS ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    where t1.dt = '20250731'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    and ((t1.CTR_STS_CD IN ( '2' , '4' ) AND t1.TMT_DT = '18991231'
    AND to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0)
    group by t1.cst_id
)t2 on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbus_loan_inf_dd	    t3  --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt='20250731'
left join adm_pub.adm_csm_cbus_dep_inf_dd	    t4  --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20250731'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     t5 --规则通用金融行为存款标签
on t1.cst_id=t5.cst_id
and t5.dt='20250731'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t6 --通用金融行为贷款标签表2
on t1.cst_id=t6.cst_id
and t6.dt='20250731'
left join adm_pub.adm_csm_cbus_ftp_inf_dd	    t7  --客户集市-业务信息-客户FTP业务
on t1.cst_id=t7.cst_id
and t7.dt='20250731'
left join adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd    t8 --客户集市-风险信息-基础风险标签信息
on t1.cst_id=t8.cst_id
and t8.dt='20250731'
left join adm_ind.adm_ind_l_rul_unvs_cst_val_l4_dd	    t9 --客户通用风险评估标签表4
on t1.cst_id=t9.cst_id
and t9.dt='20250731'
left join(
    select cst_id,count(1) as hdv_cnt
    from SJXQ_SJ20250806116_CST_01
    group by cst_id
)t10 on t1.cst_id=t10.cst_id
left join(
    select distinct cst_id
    from adm_rsk.adm_rsk_apl_inter_all    t2 --风险集市-资产质量监测表
    where dt='20250731' and is_yr_new_hpn='Y'	--是否年度新发生
)t11 on t1.cst_id=t11.cst_id
where t1.rn=1
;
-- 交出前-主管护 信贷管护 存款管护
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_04 AS
SELECT  t1.cst_id
       ,t1.HDV_DT
       ,t1.hdv_dt_q2d
       ,t3.prm_mgr_id AS 交出前2天主管护客户经理工号
       ,t3.prm_mgr_nm AS 交出前2天主管护客户经理姓名
       ,t4.tem_org_id AS 交出前2天主管户团队号
       ,t4.tem_org_nm AS 交出前2天主管户团队
       ,t4.sbr_org_nm AS 交出前2天主管户支行
       ,t3.ln_mgr_id  AS 交出前2天信贷归属客户经理工号
       ,t3.ln_mgr_nm  AS 交出前2天信贷归属客户经理姓名
       ,t5.tem_org_id AS 交出前2天信贷管户团队号
       ,t5.tem_org_nm AS 交出前2天信贷管户团队
       ,t5.sbr_org_nm AS 交出前2天信贷管户支行
       ,t6.mgr_id     AS 交出前2天存款管护人编号
       ,t6.mgr_nm     AS 交出前2天存款管护人姓名
       ,t6.tem_org_id AS 交出前2天存款管户团队号
       ,t6.tem_org_nm AS 交出前2天存款管户团队
       ,t6.sbr_org_nm AS 交出前2天存款管户支行
       ,case when t3.prm_mgr_id=t3.ln_mgr_id and t3.prm_mgr_id=t6.mgr_id and nvl(t3.prm_mgr_id,'')<>'' then '是' else '否' end as 交出前2天管护经理是否一致
       ,case when t4.tem_org_id=t5.tem_org_id and t4.tem_org_id=t6.tem_org_id and nvl(t4.tem_org_id,'')<>'' then '是' else '否' end as 交出前2天管户团队是否一致
       ,case when t4.sbr_org_nm=t5.sbr_org_nm and t4.sbr_org_nm=t6.sbr_org_nm and nvl(t4.sbr_org_nm,'')<>'' then '是' else '否' end as 交出前2天管护支行是否一致
from SJXQ_SJ20250806116_CST_01                      t1
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.hdv_dt_q2d
and t3.dt>='20241230'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t3.ln_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join(
    SELECT  t6.cst_id
        ,t6.dt
    from edw.dwd_bus_dep_cst_act_mgr_inf_dd   	    t6 --存款客户账户管户信息
    left join edw.dim_hr_org_mng_org_tree_dd        t7 --考核机构树
    on  t6.acs_org_id = t7.org_id
    and t7.dt = '@@{yyyyMMdd}'
    left join edw.dws_hr_empe_inf_dd                t8 --员工信息汇总
    on  t6.mgr_id=t8.empe_id
    and t8.dt='@@{yyyyMMdd}'
    where t6.dt>='20241230'
    and t6.frs_ctc_ind='1'	    --第一联系人标志
    group by t6.cst_id,t6.dt
)t6 on t1.cst_id=t6.cst_id
and t6.dt=t3.dt
where t1.rn=1
;
-- 接手后-主管护 信贷管护 存款管护
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_05 AS
SELECT  t1.cst_id
       ,t1.HDV_DT
       ,t1.hdv_dt_h2d
       ,t3.prm_mgr_id AS 接手后2天主管护客户经理工号
       ,t3.prm_mgr_nm AS 接手后2天主管护客户经理姓名
       ,t4.tem_org_id AS 接手后2天主管户团队号
       ,t4.tem_org_nm AS 接手后2天主管户团队
       ,t4.sbr_org_nm AS 接手后2天主管户支行
       ,t3.ln_mgr_id  AS 接手后2天信贷归属客户经理工号
       ,t3.ln_mgr_nm  AS 接手后2天信贷归属客户经理姓名
       ,t5.tem_org_id AS 接手后2天信贷管户团队号
       ,t5.tem_org_nm AS 接手后2天信贷管户团队
       ,t5.sbr_org_nm AS 接手后2天信贷管户支行
       ,t6.mgr_id     AS 接手后2天存款管护人编号
       ,t6.mgr_nm     AS 接手后2天存款管护人姓名
       ,t6.tem_org_id AS 接手后2天存款管户团队号
       ,t6.tem_org_nm AS 接手后2天存款管户团队
       ,t6.sbr_org_nm AS 接手后2天存款管户支行
       ,case when t3.prm_mgr_id=t3.ln_mgr_id and t3.prm_mgr_id=t6.mgr_id and nvl(t3.prm_mgr_id,'')<>'' then '是' else '否' end as 接手后2天管护经理是否一致
       ,case when t4.tem_org_id=t5.tem_org_id and t4.tem_org_id=t6.tem_org_id and nvl(t4.tem_org_id,'')<>'' then '是' else '否' end as 接手后2天管户团队是否一致
       ,case when t4.sbr_org_nm=t5.sbr_org_nm and t4.sbr_org_nm=t6.sbr_org_nm and nvl(t4.sbr_org_nm,'')<>'' then '是' else '否' end as 接手后2天管护支行是否一致
from SJXQ_SJ20250806116_CST_01                      t1
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.hdv_dt_h2d
and t3.dt>='20250101'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t3.ln_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join(
    SELECT  t6.cst_id
        ,t6.dt
    from edw.dwd_bus_dep_cst_act_mgr_inf_dd   	    t6 --存款客户账户管户信息
    left join edw.dim_hr_org_mng_org_tree_dd        t7 --考核机构树
    on  t6.acs_org_id = t7.org_id
    and t7.dt = '@@{yyyyMMdd}'
    left join edw.dws_hr_empe_inf_dd                t8 --员工信息汇总
    on  t6.mgr_id=t8.empe_id
    and t8.dt='@@{yyyyMMdd}'
    where t6.dt>='20241230'
    and t6.frs_ctc_ind='1'	    --第一联系人标志
    group by t6.cst_id,t6.dt
)t6 on t1.cst_id=t6.cst_id
and t6.dt=t3.dt
where t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_06 AS
SELECT  t1.cst_id     AS 客户号
       ,t6.cst_chn_nm AS 客户姓名
       ,t1.HDV_DT     AS 交接日期
    ,case when nvl(t6.SAM_RSK_CTRL_ID,'')='' then t6.cst_id else t6.sam_rsk_ctrl_id end 同一风险控制号
    ,t2.交接时授信金额
    ,t2.交接时用信余额
    ,t2.交接时是否有效贷款户
    ,t2.交接时是否有效存款户
    ,t2.交接时是否有价值客户
    ,t2.交接时近90天贷款余额日均
    ,t2.交接时近90天存款余额日均
    ,t2.交接时近90天FTP营业收入日均
    ,t2.交接时是否风险客户
    ,t3.当前授信金额
    ,t3.当前用信余额
    ,t3.当前是否有效贷款户
    ,t3.当前是否有效存款户
    ,t3.当前是否有价值客户
    ,t3.当前近90天贷款余额日均
    ,t3.当前近90天存款余额日均
    ,t3.当前近90天FTP营业收入日均
    ,t3.当前是否风险客户
    ,t3.2025年内交接次数
    ,t3.是否2025年新发生风险贷款客户
    ,t1.移交前客户经理
    ,t1.移交前管户机构
    ,t1.移交后客户经理
    ,t1.移交后管户机构
    ,t4.交出前2天主管护客户经理工号
    ,t4.交出前2天主管护客户经理姓名
    ,t4.交出前2天主管户团队号
    ,t4.交出前2天主管户团队
    ,t4.交出前2天主管户支行
    ,t4.交出前2天信贷归属客户经理工号
    ,t4.交出前2天信贷归属客户经理姓名
    ,t4.交出前2天信贷管户团队号
    ,t4.交出前2天信贷管户团队
    ,t4.交出前2天信贷管户支行
    ,t4.交出前2天存款管护人编号
    ,t4.交出前2天存款管护人姓名
    ,t4.交出前2天存款管户团队号
    ,t4.交出前2天存款管户团队
    ,t4.交出前2天存款管户支行
    ,t4.交出前2天管护经理是否一致
    ,t4.交出前2天管户团队是否一致
    ,t4.交出前2天管护支行是否一致
    ,t5.接手后2天主管护客户经理工号
    ,t5.接手后2天主管护客户经理姓名
    ,t5.接手后2天主管户团队号
    ,t5.接手后2天主管户团队
    ,t5.接手后2天主管户支行
    ,t5.接手后2天信贷归属客户经理工号
    ,t5.接手后2天信贷归属客户经理姓名
    ,t5.接手后2天信贷管户团队号
    ,t5.接手后2天信贷管户团队
    ,t5.接手后2天信贷管户支行
    ,t5.接手后2天存款管护人编号
    ,t5.接手后2天存款管护人姓名
    ,t5.接手后2天存款管户团队号
    ,t5.接手后2天存款管户团队
    ,t5.接手后2天存款管户支行
    ,t5.接手后2天管护经理是否一致
    ,t5.接手后2天管户团队是否一致
    ,t5.接手后2天管护支行是否一致
from SJXQ_SJ20250806116_CST_01      t1
left join SJXQ_SJ20250806116_CST_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20250806116_CST_03 t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20250806116_CST_04 t4
on t1.cst_id=t4.cst_id
left join SJXQ_SJ20250806116_CST_05 t5
on t1.cst_id=t5.cst_id
left join edw.DWS_CST_BAS_INF_DD    t6
on t1.cst_id=t6.cst_id
and t6.dt='20250731'
where t1.rn=1
;
-- 截止0731 未到期未终结合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_07 AS
select t1.cst_id,t1.ctr_serno                              --合同流水号
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
where t1.dt='20250731'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--交接时有授信
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_08 AS
SELECT  t1.cst_id
    ,t1.HDV_DT
    ,t2.ctr_serno
    ,t2.cst_nm
    ,t2.ctr_amt       --交接时授信金额
    ,t2.ctr_bal       --交接时用信余额
    ,t2.ctr_bgn_dt    --交接时合同起始日期
    ,t2.ctr_mtu_dt    --交接时合同到期日期
    ,replace(replace(replace(replace(t2.grnt_mod_colc,'005','信用'),'010','保证'),'020','抵押'),'040','质押') as 担保方式集合
    ,case when t3.ctr_serno is not null then '否' else '是' end as 截止0731是否已结清
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from SJXQ_SJ20250806116_CST_01              t1
inner join edw.dim_bus_loan_ctr_bse_inf_dd  t2 --合同基础信息
on t1.cst_id=t2.cst_id
and t1.HDV_DT=t2.dt
and t2.dt>='20250101'
and t2.PRD_NO not like '2002010101%'    --剔除信用卡
and ((t2.CTR_STS_CD IN ( '2' , '4' ) AND t2.TMT_DT = '18991231'
AND to_date(t2.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t2.dt, 'yyyyMMdd') )
OR t2.CTR_BAL > 0)
left join SJXQ_SJ20250806116_CST_07         t3
on t2.ctr_serno=t3.ctr_serno
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='20250731'
where t1.rn=1   --最近一次交接
;
-- 合同担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_09 AS
SELECT  t1.cst_id  --客户号
    ,t1.HDV_DT     --交接日期
    ,t1.ctr_serno  --合同号
    ,t1.cst_nm     --客户名称
    ,t1.ctr_amt    --交接时授信金额
    ,t1.ctr_bal    --交接时用信余额
    ,t1.ctr_bgn_dt --交接时合同起始日期
    ,t1.ctr_mtu_dt --交接时合同到期日期
    ,t1.担保方式集合
    ,t1.截止0731是否已结清
    ,t1.sam_rsk_ctrl_id
    ,t2.grnt_ctr_no            --担保合同编号
    ,nvl(t3.gtor_no,t4.OBG_ID) as 担保人编号
    ,nvl(t3.gtor_nm,t4.OBG_NM) as 担保人名称
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cmn_rsk_ctrl_id
	,t6.prm_mgr_id                               --主管护客户经理工号
	,t6.prm_mgr_nm                               --主管护客户经理姓名
	,t6.ln_mgr_id                                --信贷归属客户经理
	,t6.ln_mgr_nm                                --信贷归属客户经理名称
	,t6.ln_org_id                                --信贷归属机构
	,t6.ln_org_nm                                --信贷归属机构名称
	,t6.forml_cst_ind                            --正式客户标识
    ,t7.sbr_org_nm
    ,t7.tem_org_nm
    ,case when t8.cst_id is not null then '是' else '否' end as is_crdt_cst
from SJXQ_SJ20250806116_CST_08              t1
inner join edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20250731'
left JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='20250731'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20250731'
) t4 on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
left join edw.DWS_CST_BAS_INF_DD            t5
on nvl(t3.gtor_no,t4.OBG_ID)=t5.cst_id
and t5.dt='20250731'
left join adm_pub.adm_csm_cbas_mng_inf_dd           t6 --客户集市-客户基础-客户管户信息
on  t5.cst_id = t6.cst_id
and t6.dt = '20250731'
left join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.ln_org_id = t7.org_id
and t7.dt = '20250731'
left join(
    select distinct cst_id
    from SJXQ_SJ20250806116_CST_07
)t8 on t5.cst_id=t8.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST_10 AS
select t1.*
       ,t2.ctr_serno       AS 合同号
       ,t2.cst_nm          AS 客户名称
       ,t2.ctr_amt         AS 交接时授信金额_合同级
       ,t2.ctr_bal         AS 交接时用信余额_合同级
       ,t2.ctr_bgn_dt      AS 交接时合同起始日期
       ,t2.ctr_mtu_dt      AS 交接时合同到期日期
       ,t2.担保方式集合
       ,t2.截止0731是否已结清
       ,t2.grnt_ctr_no     AS 担保合同编号
       ,t2.担保人编号
       ,t2.担保人名称
       ,case when t2.sam_rsk_ctrl_id=t2.cmn_rsk_ctrl_id then '是' else '否' end as 借款人担保人是否同一风险控制号
       ,t2.prm_mgr_id      AS 担保人主管护客户经理工号
       ,t2.prm_mgr_nm      AS 担保人主管护客户经理姓名
       ,t2.ln_mgr_id       AS 担保人信贷归属客户经理
       ,t2.ln_mgr_nm       AS 担保人信贷归属客户经理名称
       ,t2.ln_org_id       AS 担保人信贷归属机构
       ,t2.ln_org_nm       AS 担保人信贷归属机构名称
       ,t2.forml_cst_ind   AS 担保人正式客户标识
       ,t2.sbr_org_nm      AS 担保人信贷管户支行
       ,t2.tem_org_nm      AS 担保人信贷管户团队
       ,t2.is_crdt_cst     as 担保人是否授信客户
from SJXQ_SJ20250806116_CST_06          t1
inner join SJXQ_SJ20250806116_CST_09    t2
on t1.客户号=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250806116_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250806116_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250806116_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ20250806116_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ20250806116_CST_10
;
/*
01	4381	4381
02	4381	4381
03	4381	4381
04	4381	4381
05	4381	4381
06	4381	4381
07	1007713	1007713
08	1264	1264
09	1717	959
10	1717	910
*/
SElECT '10' seq, *
from SJXQ_SJ20250806116_CST_10
***郑娴阳_SJ20250806116_舟山分行客户交接2.sql
-- 客户交接维度数据：郑娴阳_SJ20250806116_舟山分行客户交接.sql
-- 本脚本为合同+担保人维度数据
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST2_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST2_01 AS
select *
from(
    SELECT a.cst_id
        ,substr(REPLACE(a.sys_reg_tm, '-', ''),1,8) as HDV_DT   --交接日期
        ,row_number() over(partition by a.cst_id order by a.sys_reg_tm desc) rn
    FROM    edw.loan_cst_mgr_hdv_rcd AS a  --有贷款合同的客户交接, ，如果纯信用卡客户，需剔除。
    left join edw.dws_hr_empe_inf_dd    t1 --员工汇总信息
    on a.bfr_hdv_cst_magr_id=t1.empe_id
    and t1.dt=a.dt
    left join edw.dws_hr_empe_inf_dd    t2 --员工汇总信息
    on a.aft_hdv_cst_magr_id=t2.empe_id
    and t2.dt=a.dt
    left join edw.dws_hr_empe_inf_dd    t3 --员工汇总信息
    on a.sys_reg_psn=t3.empe_id
    and t3.dt=a.dt
    INNER JOIN    edw.dim_hr_org_mng_org_tree_dd AS t4 --机构树_考核维度
    ON  a.aft_hdv_mgr_org_no = t4.org_id
    AND t4.dt = a.dt
    and t4.brc_org_nm ='舟山分行'
    left JOIN    edw.dim_hr_org_mng_org_tree_dd AS t5 --机构树_考核维度
    ON  a.bfr_hdv_mgr_org_no = t5.org_id
    AND t5.dt = a.dt
    WHERE a.dt = '20250731'
    and a.del_ind='0'	--	删除标识
    AND REPLACE(a.sys_reg_tm, '-', '') between '20250101' and '20250731'
    AND a.sys_reg_psn NOT IN ( 'sys_reg_psn' , 'loan_transfer' ) --剔除系统迁移 ----20250318
    AND a.hdv_typ = '1'
    and a.bfr_hdv_cst_magr_id<>a.aft_hdv_cst_magr_id
)T1 where t1.rn=1
;
-- 截止0731 未到期未终结合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST2_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST2_02 AS
select t1.cst_id,t1.ctr_serno                              --合同流水号
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
where t1.dt='20250731'
and t1.PRD_NO not like '2002010101%'    --剔除信用卡
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--交接时有授信
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST2_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST2_03 AS
SELECT  t1.cst_id
       ,t1.HDV_DT
       ,t2.ctr_serno
       ,t2.cst_nm
       ,t2.ctr_amt       --交接时授信金额
       ,t2.ctr_bal       --交接时用信余额
       ,t2.ctr_bgn_dt    --交接时合同起始日期
       ,t2.ctr_mtu_dt    --交接时合同到期日期
       ,replace(replace(replace(replace(t2.grnt_mod_colc,'005','信用'),'010','保证'),'020','抵押'),'040','质押') as 担保方式集合
    ,case when t3.ctr_serno is not null then '否' else '是' end as 截止0731是否已结清
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from SJXQ_SJ20250806116_CST2_01 t1
inner join edw.dim_bus_loan_ctr_bse_inf_dd        t2 --合同基础信息
on t1.cst_id=t2.cst_id
and t1.HDV_DT=t2.dt
and t2.dt>='20250101'
and t2.PRD_NO not like '2002010101%'    --剔除信用卡
and ((t2.CTR_STS_CD IN ( '2' , '4' ) AND t2.TMT_DT = '18991231'
AND to_date(t2.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t2.dt, 'yyyyMMdd') )
OR t2.CTR_BAL > 0)
left join SJXQ_SJ20250806116_CST2_02    t3
on t2.ctr_serno=t3.ctr_serno
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20250731'
;
-- 合同担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST2_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST2_04 AS
SELECT  t1.cst_id     --客户号
    ,t1.HDV_DT     --交接日期
    ,t1.ctr_serno  --合同号
    ,t1.cst_nm     --客户名称
    ,t1.ctr_amt    --交接时授信金额
    ,t1.ctr_bal    --交接时用信余额
    ,t1.ctr_bgn_dt --交接时合同起始日期
    ,t1.ctr_mtu_dt --交接时合同到期日期
    ,t1.担保方式集合
    ,t1.截止0731是否已结清
    ,t1.sam_rsk_ctrl_id
    ,t2.grnt_ctr_no            --担保合同编号
    ,nvl(t3.gtor_no,t4.OBG_ID) as 担保人编号
    ,nvl(t3.gtor_nm,t4.OBG_NM) as 担保人名称
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end cmn_rsk_ctrl_id
	,t6.prm_mgr_id                               --主管护客户经理工号
	,t6.prm_mgr_nm                               --主管护客户经理姓名
	,t6.ln_mgr_id                                --信贷归属客户经理
	,t6.ln_mgr_nm                                --信贷归属客户经理名称
	,t6.ln_org_id                                --信贷归属机构
	,t6.ln_org_nm                                --信贷归属机构名称
	,t6.forml_cst_ind                            --正式客户标识
    ,t7.sbr_org_nm
    ,t7.tem_org_nm
from SJXQ_SJ20250806116_CST2_03              t1
inner join edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20250731'
left JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='20250731'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20250731'
) t4 on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
left join edw.DWS_CST_BAS_INF_DD            t5
on nvl(t3.gtor_no,t4.OBG_ID)=t5.cst_id
and t5.dt='20250731'
left join adm_pub.adm_csm_cbas_mng_inf_dd           t6 --客户集市-客户基础-客户管户信息
on  t5.cst_id = t6.cst_id
and t6.dt = '20250731'
left join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.ln_mgr_id = t7.org_id
and t7.dt = '20250731'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250806116_CST2_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250806116_CST2_05 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.HDV_DT          AS 交接日期
       ,t1.ctr_serno       AS 合同号
       ,t1.cst_nm          AS 客户名称
       ,t1.ctr_amt         AS 交接时授信金额
       ,t1.ctr_bal         AS 交接时用信余额
       ,t1.ctr_bgn_dt      AS 交接时合同起始日期
       ,t1.ctr_mtu_dt      AS 交接时合同到期日期
       ,t1.担保方式集合
       ,t1.截止0731是否已结清
       ,t1.sam_rsk_ctrl_id AS 同一风险控制号
       ,t1.grnt_ctr_no     AS 担保合同编号
       ,t1.担保人编号
       ,t1.担保人名称
       ,t1.cmn_rsk_ctrl_id as 担保人同一风险控制号
       ,t1.prm_mgr_id      AS 担保人主管护客户经理工号
       ,t1.prm_mgr_nm      AS 担保人主管护客户经理姓名
       ,t1.ln_mgr_id       AS 担保人信贷归属客户经理
       ,t1.ln_mgr_nm       AS 担保人信贷归属客户经理名称
       ,t1.ln_org_id       AS 担保人信贷归属机构
       ,t1.ln_org_nm       AS 担保人信贷归属机构名称
       ,t1.forml_cst_ind   AS 担保人正式客户标识
       ,t1.sbr_org_nm      AS 担保人信贷管户支行
       ,t1.tem_org_nm      AS 担保人信贷管户团队
from SJXQ_SJ20250806116_CST2_04 t1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250806116_CST2_05
;
SElECT '05' seq, *
from SJXQ_SJ20250806116_CST2_05
***郑建俊_SJ2025031141_衢州分行风险隐患排查.sql
﻿-- 提取衢州分行截止当前最新日期，近一年累计逾期月份数&ge;3次或近一年存在某月逾期金额（逾期本金或逾期利息）&ge;10000元的有效信贷客户数据
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.ctr_epsr_bal            --合同敞口余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ovd_amt	                                --逾期金额
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '衢州分行'
where t1.dt='20250317'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--各月逾期情况
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST_02 AS
select t2.cst_id,t1.dt
	,sum(t1.ovd_prcp) as ovd_prcp       --逾期本金
	,sum(t1.ovd_intr) as ovd_intr       --逾期利息
from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd  t1    --风险集市信贷业务借据信息表
inner join SJXQ_SJ2025031141_CST_01     t2
on t1.ctr_srl_no=t2.ctr_serno
    ,'20241031','20241130','20241231','20250131','20250228','20250317')
and (t1.ovd_prcp>0 or t1.ovd_intr>0)
GROUP BY  t2.cst_id,t1.dt
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST_03 AS
SELECT  t1.cst_id                                     AS 客户号
       ,t2.cst_chn_nm                                 AS 客户中文名称
       ,concat(substr(regexp_replace(t2.reg_adr_dtl_inf,'\\s|,',''),1,greatest(length(regexp_replace(t2.reg_adr_dtl_inf,'\\s|,',''))-6,0)),'******') as 户籍地址脱敏
       ,decode(t2.gdr_cd,'1','男','2','女','未知')    AS 性别代码
       ,t2.age                                        AS 年龄
       ,t3.ctr_epsr_amt                               AS 合同敞口金额
       ,t3.ctr_epsr_bal                               AS 合同敞口余额
       ,substr(t4.dt,1,6)                             AS 逾期月份
       ,t4.ovd_prcp                                   AS 逾期本金
       ,t4.ovd_intr                                   AS 逾期利息
       ,t3.sbr_org_nm                                 AS 管户支行
       ,t3.org_nm                                     AS 管户机构
       ,t3.mgr_id                                     AS 管户人工号
       ,t3.mgr_nm                                     AS 管户人姓名
from(
    SELECT cst_id from SJXQ_SJ2025031141_CST_02
    where ovd_prcp>0 or ovd_intr>0
    GROUP BY cst_id having count(DISTINCT dt)>=3
    union
    SELECT cst_id from SJXQ_SJ2025031141_CST_02
    where ovd_prcp>=10000 or ovd_intr>=10000
)t1 left join adm_pub.adm_csm_cbas_idv_bas_inf_dd	t2 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20250317'
left join(
    SELECT cst_id
        ,sum(ctr_epsr_amt) as ctr_epsr_amt  --合同敞口金额|decimal(21,2)
        ,sum(ctr_epsr_bal) as ctr_epsr_bal  --合同敞口余额
    from SJXQ_SJ2025031141_CST_01
    GROUP BY cst_id
)t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025031141_CST_02 t4
on t1.cst_id=t4.cst_id
;
from SJXQ_SJ2025031141_CST_03
order by 客户号,逾期月份
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025031141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025031141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025031141_CST_03
;
/*
01	54402	54402
02	5579	976
03	5431	858
*/
***郑建俊_SJ2025031141_衢州分行风险隐患排查20250320.sql
﻿-- 提取衢州分行截止当前最新日期，近一年累计逾期月份数&ge;3次或近一年存在某月逾期金额（逾期本金或逾期利息）&ge;10000元的有效信贷客户数据
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_01 AS
select t1.ctr_serno                                 --合同流水号
	,t1.cst_id                                      --客户号|C20
	,t1.cst_nm                                      --客户名称|C200
    ,t1.ctr_amt                                     --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                     --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                            --合同敞口金额|decimal(21,2)
    ,t1.ctr_epsr_bal                                --合同敞口余额
	,t1.ctr_bgn_dt                                  --合同起始日期
	,t1.ctr_mtu_dt                                  --合同到期日期
    ,t1.ovd_amt	                                    --逾期金额
    ,t1.ovd_dt	                                    --逾期日期
    ,t1.onbs_ovd_intr_bal	                        --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                        --表外欠息余额DECIMAL(21,2)
    ,t2.PD_NM
    ,t3.mgr_id	                                    --管户人工号|C10
    ,t3.mgr_nm	                                    --管户人姓名|C200
    ,t3.mgr_org_id	                                --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd         t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '衢州分行'
where t1.dt='20250319'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--各月逾期情况
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_02 AS
SELECT t1.ctr_srl_no       --合同流水号
    ,t1.dbil_srl_no      --借据流水号
    ,t1.dbil_amt         --借据金额
    ,t1.dbil_bal         --借据余额
    ,t1.cny_dbil_bal     --借据余额(折人民币)
    ,t1.nrm_prcp         --正常本金
    ,t1.prcp_ovd_date    --本金逾期日期
    ,t1.intr_ovd_date    --利息逾期日期
    ,t1.ovd_prcp         --逾期本金
    ,t1.ovd_intr         --逾期利息
    ,t1.dbil_grant_date  --借据发放日期
    ,t1.crrt_repay_term  --当前还款期次
    ,t1.resid_repay_term --剩余还款期数
    ,t1.cst_id           --客户编号
    ,t1.cst_nm           --客户名称
    ,t1.is_ovd           --是否逾期
    ,t1.crrt_ovd_day     --当前逾期天数
    ,t1.bsn_type_cd      --业务品种
    ,t1.dt
    ,row_number() over(partition by t1.cst_id,t1.dbil_srl_no,substr(t1.dt,1,6) order by t1.ovd_prcp desc) rn_prcp
    ,row_number() over(partition by t1.cst_id,t1.dbil_srl_no,substr(t1.dt,1,6) order by t1.ovd_intr desc) rn_intr
from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd   t1    --风险集市信贷业务借据信息表
inner join SJXQ_SJ2025031141_CST2_01        t2
on t1.ctr_srl_no=t2.ctr_serno
where t1.dt between '20240320' and '20250319'   --近1年借据逾期情况
and (t1.ovd_prcp>0 or t1.ovd_intr>0)
;
-- 月本金逾期
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_03 AS
select cst_id,substr(dt,1,6) as ovd_mons
    ,sum(ovd_prcp) as ovd_prcp
from SJXQ_SJ2025031141_CST2_02
where rn_prcp=1
group by cst_id,ovd_mons
;
-- 月利息逾期
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_04 AS
select cst_id,substr(dt,1,6) as ovd_mons
    ,sum(ovd_intr) as ovd_intr
from SJXQ_SJ2025031141_CST2_02
where rn_intr=1
group by cst_id,ovd_mons
;
-- 逾期汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_05 AS
select t1.cst_id,t1.ovd_mons
    ,t2.prcp_ovd_date    --本金逾期日期
    ,t2.ovd_prcp         --逾期本金
    ,t3.intr_ovd_date    --利息逾期日期
    ,t3.ovd_intr         --逾期利息
from(
    select cst_id,ovd_mons
    from SJXQ_SJ2025031141_CST2_03
    union
    select cst_id,ovd_mons
    from SJXQ_SJ2025031141_CST2_04
)t1 left join SJXQ_SJ2025031141_CST2_03 t2
on t1.cst_id=t2.cst_id
and t1.ovd_mons=t2.ovd_mons
left join SJXQ_SJ2025031141_CST2_04 t3
on t1.cst_id=t3.cst_id
and t1.ovd_mons=t3.ovd_mons
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_06 AS
SELECT  t1.cst_id                               AS 客户号
       ,t5.cst_chn_nm                           AS 客户中文名称
       ,concat(substr(regexp_replace(t5.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(t5.reg_adr,'\\s|,',''))-6,0)),'******') as 户籍地址脱敏
       ,decode(t2.gdr_cd,'1','男','2','女','未知')    AS 性别代码
       ,t2.age            AS 年龄
       ,t3.ctr_epsr_amt   AS 合同敞口金额
       ,t3.ctr_epsr_bal   AS 合同敞口余额
       ,t4.ovd_mons 	  AS 逾期月份
       ,t4.prcp_ovd_date  AS 本金逾期日期
       ,t4.intr_ovd_date  AS 利息逾期日期
       ,t4.ovd_prcp       AS 逾期本金
       ,t4.ovd_intr       AS 逾期利息
       ,t3.sbr_org_nm     AS 管户支行
       ,t3.org_nm         AS 管户机构
       ,t3.mgr_id         AS 管户人工号
       ,t3.mgr_nm         AS 管户人姓名
from(
    SELECT cst_id from SJXQ_SJ2025031141_CST2_05
    where ovd_prcp>0 or ovd_intr>0
    GROUP BY cst_id having count(DISTINCT ovd_mons)>=3
    union
    SELECT cst_id from SJXQ_SJ2025031141_CST2_05
    where ovd_prcp>=10000 or ovd_intr>=10000
)t1 left join adm_pub.adm_csm_cbas_idv_bas_inf_dd	t2 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20250319'
left join edw.dws_cst_bas_inf_dd 				    t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='20250319'
left join(
    SELECT cst_id
        ,sum(ctr_epsr_amt) as ctr_epsr_amt  --合同敞口金额|decimal(21,2)
        ,sum(ctr_epsr_bal) as ctr_epsr_bal  --合同敞口余额
    from SJXQ_SJ2025031141_CST2_01
    GROUP BY cst_id
)t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025031141_CST2_05 t4
on t1.cst_id=t4.cst_id
;
from SJXQ_SJ2025031141_CST2_06
order by 客户号,逾期月份
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025031141_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ2025031141_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,ovd_mons) custs
from SJXQ_SJ2025031141_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,ovd_mons) custs
from SJXQ_SJ2025031141_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,ovd_mons) custs
from SJXQ_SJ2025031141_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025031141_CST2_06
;
/*
01	54397	54397
02	860251	14284
03	12764	12764
04	12764	12764
05	12764	12764
06	9869	1736
-- 贷款期供交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025031141_CST2_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031141_CST2_02_1 AS
SELECT  t1.cst_id        AS 客户编号
       ,t1.cst_nm        AS 客户名称
       ,t1.dbil_srl_no   AS 借据流水号
       ,t1.dbil_amt      AS 借据金额
       ,t1.dbil_bal      AS 借据余额
       ,t1.prcp_ovd_date AS 本金逾期日期
       ,t1.intr_ovd_date AS 利息逾期日期
       ,t1.ovd_prcp      AS 逾期本金
       ,t1.ovd_intr      AS 逾期利息
       ,t2.trx_dt        AS 交易日期
       ,t2.cur_trm       AS 本期期数
       ,t2.cur_sub_trm   AS 本期子期数
       ,t2.shd_pay_dt    AS 应还日期
       ,t2.rpay_sts_cd   AS 还款状态代码
       ,t2.ini_prcp      AS 初始本金
       ,t2.ini_intr      AS 初始利息
       ,t2.prcp_amt      AS 本金发生额
       ,t2.prcp          AS 本金
       ,t2.rpay_seq_id   AS 还款顺序编号
       ,t2.dtl_seq_nbr   AS 明细序号
       ,t2.evt_cmt       AS 事件说明
       ,t2.smr           AS 摘要
FROM SJXQ_SJ2025031141_CST2_02                  t1
LEFT JOIN edw.dwd_bus_loan_trm_pmt_trx_dtl_di   t2 --贷款期供交易明细
ON      t1.dbil_srl_no = t2.dbil_id
AND     t2.dt >= '20240312'
left join edw.dwd_code_library_dd               c1
on t2.RPAY_STS_CD = c1.cd_val
and c1.dt = '20250131'
WHERE   t1.dt = '@@{yyyyMMdd}'
*/
***郑飞龙_SJ2025051431_龙海村行征信信托融资客户.sql
﻿-- 截止2025年04月30日，龙海村行贷款授信合同未终止，征信中有信托机构融资余额的客户清单。
DROP   TABLE IF     EXISTS SJXQ_SJ2025051431_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051431_CST_01 AS
select distinct t1.cst_id                                   --客户号
    ,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.BRC_ORG_NM like '福建龙海泰隆村镇%'       --龙海村行
where t1.dt='20250430'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 征信中信托机构融资家数，征信中信托机构融资金额。
DROP   TABLE IF     EXISTS SJXQ_SJ2025051431_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051431_CST_02 AS
select t1.cst_id    as 客户号
    ,t2.report_no   as 报告编号
    ,t2.report_dt   as 报告日期
    ,t3.信托公司融资家数
    ,t3.信托公司授信金额
    ,t3.信托公司贷款余额
from SJXQ_SJ2025051431_CST_01   t1
inner join(
    select report_no                                --报告编号
        ,cst_id                                   --客户号
	    ,report_dt                                --报告日期
    from edw.dws_cst_ccrc_idv_ind_inf_dd          --个人征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1
    union
    select report_no                                --报告编号
        ,cst_id                                   --客户号
	    ,report_dt                                --报告日期
    from edw.dws_cst_ccrc_entp_ind_inf_dd         --企业征信指标信息表
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1
)t2 on t1.cst_id=t2.cst_id
INNER JOIN
(
      select cst_id
            ,report_id
            ,count(distinct case when dtrb_org_typ_cd ='21' then dtrb_org end)  as 信托公司融资家数
            ,sum(case when dtrb_org_typ_cd ='21' then ctr_amt else 0 end)       as 信托公司授信金额
            ,sum(case when dtrb_org_typ_cd ='21' then ctr_bal else 0 end)       as 信托公司贷款余额
      from   edw.dim_cst_ccrc_idv_loan_inf_dd
      where  dt = '@@{yyyyMMdd}'
      and    act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) --贷款
      and   dtrb_org_typ_cd ='21'   -- 21:信托公司   24:消费金融公司  51:小额贷款公司
      group by cst_id ,report_id
      union all
      select cst_id
            ,report_id
            ,count(distinct case when dtrb_org_typ_cd ='21' then dtrb_org_cd end)  as 信托公司融资家数  ---- 21:信托公司   24:消费金融公司  51:小额贷款公司
            ,sum(case when dtrb_org_typ_cd ='21' then loan_amt else 0 end)    as 信托公司授信金额
            ,sum(case when dtrb_org_typ_cd ='21' then loan_bal else 0 end)    as 信托公司贷款余额
      from   edw.dim_cst_ccrc_entp_loan_inf_dd
      where  dt = '@@{yyyyMMdd}'
      and    act_typ IN ( 'D1' , 'R1' , 'R4' ) --贷款
      and   dtrb_org_typ_cd ='21'   -- 21:信托公司   24:消费金融公司  51:小额贷款公司
      -- and    (ctr_bal > 0 OR rmn_rpay_trm > 0 )  ---- 未结清
      group by cst_id ,report_id
)t3 on t2.cst_id = t3.cst_id
and t2.report_no = t3.report_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051431_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025051431_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025051431_CST_02
***郑飞龙_SJ2025061931_龙海综合积分.sql
-- 郑飞龙_SJ2025061931_龙海综合积分
-- 截止6月15日，龙海村行名下有可使用综合积分余额的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2025061931_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061931_CST_01 AS
SELECT  t1.cst_id                          AS 客户号
       ,t2.cst_chn_nm                      AS 客户名称
       ,t1.pnt_bal                         AS 综合积分余额_0618
       ,t3.dep_bal                         AS 存款余额
       ,decode(t4.VLD_DEP_ACT ,'1','是','') AS 有效存款户
       ,decode(t5.VLD_LOAN_ACT,'1','是','') AS 有效贷款户
       ,t7.dtl_addr                        AS 主地址
from(
    SELECT  t1.cst_id
        ,SUM(t1.pnt_bal) AS pnt_bal --客户当前综合积分余额
    FROM edw.dim_bus_cmpn_pnt_act_inf_dd        t1
    inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
    on  t1.cst_id = t3.cst_id
    and t3.dt = t1.dt
    and t3.prm_org_id like '3563%' --龙海
    WHERE t1.dt = '20250618'
    AND t1.pnt_typ_cd = '0001' -- 综合积分
    GROUP BY  t1.cst_id
)t1 left join edw.dws_cst_bas_inf_dd        t2 --客户基础信息汇总表 证件号及到期日
ON t1.cst_id = t2.cst_id
AND t2.dt = '20250618'
left join adm_pub.adm_csm_cbus_dep_inf_dd   t3 --存款业务信息表
ON t1.cst_id = t3.cst_id
AND t3.dt = '20250618'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_dep_dd     t4 --规则通用金融行为存款标签
ON t1.cst_id = t4.cst_id
AND t4.dt = '20250618'
left join adm_ind.ADM_IND_L_RUL_UNVS_FIN_BHV_LOAN_L2_DD t5 --有效贷款户：0否1是
ON t1.cst_id = t5.cst_id
AND t5.dt = '20250618'
LEFT JOIN edw.loan_cst_ctc_addr     t7
ON t1.cst_id = t7.cst_id
and t7.del_ind='0' 	--未删除
AND t7.dt = '20250618'
AND t7.main_addr_ind = '1' --主地址
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061931_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ2025061931_CST_01
***郑飞龙_SJ20250702151_中低风险未增额客户.sql
-- 郑飞龙_SJ20250702151_中低风险未增额客户
-- 福建龙海泰隆村镇银行 截止6月30日，我行有信贷业务，风险评级为中低风险及以上，个人征信评分在700分以上，已经办理过续贷且续贷未增额客户。
-- 同一风险控制号下我行授信总额 20230630
DROP   TABLE IF     EXISTS SJXQ_SJ20250702151_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250702151_CST_01 AS
select case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end cmn_risk_ctrl_id
    ,sum(t1.ctr_amt) as cmn_rsk_ctr_amt                                 --合同金额DECIMAL(21,2)
    ,sum(t1.ctr_bal) as cmn_rsk_ctr_bal                                 --合同余额DECIMAL(21,2)
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='20230630'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
group by cmn_risk_ctrl_id
;
-- 同一风险控制号下我行授信总额
DROP   TABLE IF     EXISTS SJXQ_SJ20250702151_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250702151_CST_02 AS
select case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end cmn_risk_ctrl_id
    ,sum(t1.ctr_amt) as cmn_rsk_ctr_amt                                 --合同金额DECIMAL(21,2)
    ,sum(t1.ctr_bal) as cmn_rsk_ctr_bal                                 --合同余额DECIMAL(21,2)
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
where t1.dt='20250630'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
group by cmn_risk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250702151_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250702151_CST_03 AS
SELECT  t1.cst_id       --客户号
    ,t1.cst_nm       --客户名称
    ,t1.mgr_id       --管户人工号
    ,t3.empe_nm      --管户人
    ,t1.mgr_org_id   --管户机构号
    ,t4.org_nm       --管户机构
    ,t1.ctr_serno    --合同流水号
    ,t1.ctr_amt      --合同金额
    ,t1.ctr_bal      --合同余额
    ,t1.ctr_bgn_dt   --合同起始日期
    ,t1.ctr_mtu_dt   --合同到期日期
    ,t8.scor_rng     --最新征信评分
    ,t6.frs_crd_dt   --首次授信日期
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end cmn_risk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '福建龙海泰隆村镇银行'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	t6 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t6.cst_id
and t6.dt=t1.dt
inner join edw.dws_cst_ccrc_idv_ind_inf_dd  t8   --个人征信指标信息表
on t1.cst_id=t8.cst_id
and t8.dt=t1.dt
and t8.report_dsc_rn=1
and t8.idv_crd_sco_val> 700    --700分以上
where t1.dt='20250630'
and t1.hpn_typ_cd='011' --发生类型代码 010:首笔|011:续做
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250702151_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250702151_CST_04 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_nm          AS 客户名称
       ,t1.mgr_id          AS 管户人工号
       ,t1.empe_nm         AS 管户人
       ,t1.mgr_org_id      AS 管户机构号
       ,t1.org_nm          AS 管户机构
       ,t1.ctr_serno       AS 合同流水号
       ,t1.ctr_amt         AS 合同金额
       ,t1.ctr_bal         AS 合同余额
       ,t1.ctr_bgn_dt      AS 合同起始日期
       ,t1.ctr_mtu_dt      AS 合同到期日期
       ,t1.scor_rng        AS 最新征信评分
       ,t1.frs_crd_dt      AS 首次授信日期
       ,t2.cmn_rsk_ctr_amt AS 同一风险控制号下客户可用授信总额_20230630
       ,t3.cmn_rsk_ctr_amt AS 同一风险控制号下客户可用授信总额_20250630
from SJXQ_SJ20250702151_CST_03      t1
left join SJXQ_SJ20250702151_CST_01 t2
on t1.cmn_risk_ctrl_id=t2.cmn_risk_ctrl_id
left join SJXQ_SJ20250702151_CST_02 t3
on t1.cmn_risk_ctrl_id=t3.cmn_risk_ctrl_id
where nvl(t2.cmn_rsk_ctr_amt,0) >= nvl(t3.cmn_rsk_ctr_amt,0)    --未增额
;
SElECT '01' seq, count(1) cnt,count(distinct cmn_risk_ctrl_id) custs
from SJXQ_SJ20250702151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cmn_risk_ctrl_id) custs
from SJXQ_SJ20250702151_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250702151_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20250702151_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ20250702151_CST_04
***郑飞龙_SJ20250714201_龙海信贷客户.sql
﻿-- 郑飞龙_SJ20250714201_龙海信贷客户
-- 截止0714，主管户为龙海村行的客户清单：循环贷款近90天日均10000~30000的或非循环贷款近30天日均1万-3万
-- 循环贷款近90天日均
DROP   TABLE IF     EXISTS SJXQ_SJ20250714201_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250714201_CST_01 AS
select t1.cst_id
    ,avg(ctr_bal)   as clc_loan_avg_bal_90d
    ,count(dt)      as days_
    ,round(sum(ctr_bal)/90,2) as clc_loan_avg_bal_90d2
from(
    select t1.cst_id,t1.dt                                --客户号|C20
        ,sum(t1.ctr_bal) as ctr_bal                                --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
    on  t1.cst_id = t3.cst_id
    and t3.dt = '20250714'
    and t3.prm_org_id like '3563%'  --龙海
    where t1.dt between '20250416' and '20250714'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    group by t1.cst_id,t1.dt
)t1 group by t1.cst_id
;
-- 非循环贷款近30天日均
DROP   TABLE IF     EXISTS SJXQ_SJ20250714201_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250714201_CST_02 AS
select t1.cst_id
    ,avg(ctr_bal)   as uclc_loan_avg_bal_30d
    ,count(dt)      as days_
    ,round(sum(ctr_bal)/30,2) as uclc_loan_avg_bal_30d2
from(
    select t1.cst_id,t1.dt                                --客户号|C20
        ,sum(t1.ctr_bal) as ctr_bal                                --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
    on  t1.cst_id = t3.cst_id
    and t3.dt = '20250714'
    and t3.prm_org_id like '3563%'  --龙海
    where t1.dt between '20250615' and '20250714'
    and t1.PRD_NO not like '2002010101%'    --剔除信用卡
    group by t1.cst_id,t1.dt
)t1 group by t1.cst_id
;
-- 结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250714201_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250714201_CST_03 AS
SELECT  t1.cst_id                AS 客户号
       ,t2.cst_nm                AS 客户名称
       ,t2.ctr_serno             AS 合同号
       ,t2.ctr_amt               AS 授信金额
       ,t2.ctr_bal               AS 用信余额
       ,t3.clc_loan_avg_bal_90d2  AS 循环贷款近90天日均
       ,t4.uclc_loan_avg_bal_30d2 AS 非循环贷款近30天日均
       ,t6.vld_loan_act          AS 有效贷款户
       ,t5.prm_mgr_id            AS 主管护客户经理工号
       ,t5.prm_mgr_nm            AS 主管护客户经理姓名
       ,t5.prm_org_id            AS 主管护机构号
       ,t5.prm_org_nm            AS 主管户机构名称
from(
    select cst_id
    from SJXQ_SJ20250714201_CST_01
    where clc_loan_avg_bal_90d2 between 10000 and 30000
    union
    select cst_id
    from SJXQ_SJ20250714201_CST_02
    where uclc_loan_avg_bal_30d2 between 10000 and 30000
)t1 left join edw.dim_bus_loan_ctr_bse_inf_dd        t2 --合同基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20250714'
left join SJXQ_SJ20250714201_CST_01 t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20250714201_CST_02 t4
on t1.cst_id=t4.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd  t5 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t5.cst_id
and t5.dt = '20250714'
left join adm_ind.adm_ind_l_rul_unvs_fin_bhv_loan_l2_dd t6 --通用金融行为贷款标签表2
on t1.cst_id=t6.cst_id
and t6.dt='20250714'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250714201_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250714201_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250714201_CST_03
;
/*
01	8699	8699
02	3560	3560
03	1011	538
*/
SElECT '03' seq, *
from SJXQ_SJ20250714201_CST_03
;
***郭婷婷_SJ20250422126_眉县村行交易流水.sql
/*
1.村行存量的医疗相关行业对私客户、对公客户及其受益所有人；
2.上述客户的交易流水；
3.上述客户中交易触犯反洗钱系统、核心系统模型的客户---这个先不用搞，得找找表
详细口径：
1.对公：经营范围中存在&quot;医疗、药品、医院、医药、诊所、药房、药店&ldquo;字样的；
2.对私：存在工作单位的，单位名称中存在&quot;医疗、药品、医院、医药、诊所、药房、药店&ldquo;字样的，无工作单位的暂不予考虑
*/
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ20250422126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422126_CST_01 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.cst_typ_cd                               --客户类型|C1
    ,decode(t1.cst_typ_cd,'1','对私','2','对公') as 客户类型
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.opr_scp_dscr                             --经营范围描述
    ,t6.age,t6.job_unt_nm	--工作单位名称
    ,t7.sy_cst_chn_nm
from edw.dws_cst_bas_inf_dd      t1              --客户基础信息汇总表
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '陕西眉县泰隆村镇银行'
left join edw.dim_cst_entp_bas_inf_dd	        t5 --企业客户基本信息
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t6 --对私客户基础信息
on t1.cst_id=t6.cst_id
and t6.dt=t1.dt
LEFT JOIN (
    SELECT a3.cst_id
    from edw.dim_cst_rel_inf_dd         a3 --客户关联关系信息
    inner JOIN edw.dim_cst_bas_inf_dd    b3 --客户基本信息
    ON a3.rel_cst_id = b3.cst_id
    AND b3.dt = a3.dt
    where a3.dt = '@@{yyyyMMdd}'
    AND a3.rel_typ_cd LIKE '09%' --受益人
    and LENGTH(a3.rel_cst_id)=10
    GROUP BY a3.cst_id
)t7 ON t1.cst_id = t7.cst_id
where t1.dt='@@{yyyyMMdd}'
and (t5.opr_scp_dscr regexp '医疗|药品|医院|医药|诊所|药房|药店'
    or t6.job_unt_nm regexp '医疗|药品|医院|医药|诊所|药房|药店')
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250422126_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422126_CST_02 AS
SELECT  t1.cst_id        AS 客户号
       ,t1.cst_chn_nm    AS 客户姓名
       ,t1.客户类型
       ,t1.prm_mgr_id    AS 主管户客户经理工号
       ,t1.prm_mgr_nm    AS 主管户客户经理
       ,t1.org_nm        AS 主管户机构
       ,t1.opr_scp_dscr  AS 经营范围描述
       ,t1.job_unt_nm    AS 工作单位名称
       ,t1.sy_cst_chn_nm AS 对公客户受益所有人
from SJXQ_SJ20250422126_CST_01 t1
;
-- 交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ20250422126_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250422126_CST_03 AS
SELECT  t1.cst_id             AS 客户号
       ,t1.cst_chn_nm         AS 客户姓名
       ,t1.客户类型
       ,t3.cst_act_id         AS 客户账号
       ,t3.dep_act_id         AS 存款账号
       ,t4.dtl_seq_nbr        AS 明细序号
       ,t4.trx_dt             AS 交易日期
       ,t4.trx_tm             AS 交易时间
       ,t4.crd_and_dbt_ind    AS 借贷标志
       ,t4.trx_amt            AS 交易金额
       ,t4.act_bal            AS 账户余额
       ,t4.txt_code           AS 摘要代码
       ,t4.smr_dscr           AS 摘要描述
       ,t4.csh_ind            AS 现转标志
       ,t4.cnt_pty_cst_act_id AS 对方客户账号
       ,t4.cnt_pty_act_nm     AS 对方户名
       ,t4.cnt_pty_cst_typ_cd AS 对方客户类型代码
       ,t4.cmt                AS 备注
from SJXQ_SJ20250422126_CST_01              t1
inner join edw.dws_bus_dep_act_inf_dd       t3 --存款账户信息汇总
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细表
on  t3.dep_act_id=t4.dep_act_id
and t4.dt <='@@{yyyyMMdd}'
and t4.bal_fld_nm = 'DPLDGBAL' --动账
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250422126_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250422126_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 存款账号,明细序号) custs
from SJXQ_SJ20250422126_CST_03
***郭婷婷_SJ2025072886_受益人备案信息.sql
-- 郭婷婷_SJ2025072886_受益人备案信息
-- 陕西眉县泰隆村镇银行 开户在2024年11月1日之前的对公客户
-- 股东、合伙人
DROP   TABLE IF     EXISTS SJXQ_SJ2025072886_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072886_CST_01 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
from(
    SElECT cst_id,rel_cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    union
    SElECT rel_cst_id,cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.cst_typ_cd='1'   --股东、合伙人为个人客户
;
-- 实控人
DROP   TABLE IF     EXISTS SJXQ_SJ2025072886_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072886_CST_02 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
from(
    SElECT cst_id,rel_cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and REL_TYP_CD='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and REL_TYP_CD='0109' --实际控制人
)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.cst_typ_cd='1'   --实控人为个人客户
;
-- 汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025072886_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072886_CST_03 AS
select t1.cst_act_id                               --客户账号|C32
	,t1.cst_act_typ_cd                           --客户账户类型代码|C1
    ,c1.cd_val_dscr     as 客户账户类型
	,t1.cst_act_nm                               --客户账户名称|C200
	,t1.act_sts_cd                               --账户状态代码|C1
    ,c2.cd_val_dscr     as 账户状态
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_org_id                               --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
	,t1.act_cls_frz_ind                          --账户封闭冻结标志|C1
	,t1.act_rcv_oly_ind                          --账户只收不付标志|C1
	,t2.cst_nm                                   --客户名称|C200
	,t2.org_org_typ_cd                           --组织机构类型代码|C6
    ,c3.cd_val_dscr     as 组织机构类型
	,t2.reg_cpt                                  --注册资本|DECIMAL(20,2)
    ,t4.brc_org_nm
    ,t4.org_nm
from edw.dim_bus_dep_cst_act_inf_dd         t1 --客户存款账户信息
inner join edw.dim_cst_entp_bas_inf_dd       t2 --企业客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.opn_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm='陕西眉县泰隆村镇银行'
left join edw.dwd_code_library_dd c1
on t1.cst_act_typ_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd c2
on t1.act_sts_cd = c2.cd_val
and c2.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd c3
on t2.org_org_typ_cd = c3.cd_val
and c3.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.opn_dt<='20241101'
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2025072886_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072886_CST_03_1 AS
select cst_act_id,lmt_eft_dt,close_fg_rsn
from(
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '@@{yyyyMMdd}'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t1 where t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025072886_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025072886_CST_04 AS
SELECT  t1.brc_org_nm      AS 开户分行
       ,t1.org_nm          AS 开户机构
       ,t1.cst_id          AS 客户编号
       ,t1.cst_nm          AS 客户名称
       ,t1.组织机构类型
       ,t1.reg_cpt         AS 注册资本
       ,t1.cst_act_id      AS 客户账号
       ,t1.cst_act_nm      AS 客户账户名称
       ,t1.客户账户类型
       ,t1.opn_dt          AS 开户日期
       ,t1.账户状态
       ,t1.act_cls_frz_ind AS 账户封闭冻结标志
       ,t1.act_rcv_oly_ind AS 账户只收不付标志
       ,case when t4.cst_act_id is not null then '是' else '' end as 暂停非柜面
       ,t2.股东_合伙人
       ,t3.实际控制人
from SJXQ_SJ2025072886_CST_03 t1
left join(
    select cst_id
    from SJXQ_SJ2025072886_CST_01
    group by cst_id
)t2 on  t1.cst_id=t2.cst_id
left join(
    select cst_id
    from SJXQ_SJ2025072886_CST_02
    group by cst_id
)t3 on  t1.cst_id=t3.cst_id
left join SJXQ_SJ2025072886_CST_03_1 t4
on t1.cst_act_id=t4.cst_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2025072886_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2025072886_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025072886_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025072886_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2025072886_CST_04
***郭少聪_SJ20250220156_龙海村行风险排查.sql
﻿-- 截止20250201 龙海村行
DROP   TABLE IF EXISTS SJXQ_SJ20250220156_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20250220156_CST_01
(
    cst_id      string COMMENT ''
    ,cst_nm     string COMMENT ''
)
;
insert into SJXQ_SJ20250220156_CST_01
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250220156_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220156_CST_02 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250201' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250201' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20250201' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20250201' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 上一次征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250220156_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220156_CST_02_1 AS
SELECT *
from(
	SELECT cst_id,prd_dt,cst_cr_grd_val
		,row_number() over(partition by cst_id order by prd_dt desc) rn
	from SJXQ_SJ20250220156_CST_02
	where rn2=1
)t1 WHERE rn=2 	--上一日期
;
--客户
DROP   TABLE IF EXISTS SJXQ_SJ20250220156_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ20250220156_CST_03 as
select t1.cst_id
    ,t1.cst_nm
	,t2.mgr_id                                   --管户人工号|c10
    ,t3.empe_nm     as mgr_nm
	,t2.mgr_org_id                               --管户机构号|c12
    ,t4.slf_ast_lbl_rat	--本人资产负债率
    ,t4.ast_lbl_rat	    --资产负债率
    ,t5.oth_bank_loan_org_num    --他行贷款授信机构数
    ,t5.oth_bank_loan_credit_bal --他行贷款授信余额
    ,t6.他行贷款逾期期数
    ,g.late_12mon_loan_od_num   --近12个月贷款逾期期数
	,t7.oth_bank_loan_org_num as oth_bank_loan_org_num2
    ,nvl(t5.oth_bank_loan_org_num,0) - nvl(t7.oth_bank_loan_org_num,0) as 近半年他行贷款授信机构数变化
    ,round(t8.bal_6m/t8.diff_days,2) as 近6月日均余额
from SJXQ_SJ20250220156_CST_01 t1
left join edw.dim_cst_mng_loan_mgr_dd t2 --信贷客户管户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250201'
left join edw.dws_hr_empe_inf_dd      t3 --员工信息汇总
on  t2.mgr_id=t3.empe_id
and t3.dt='20250201'
left join(
    select cst_id
        ,slf_ast_lbl_rat	--本人资产负债率
        ,ast_lbl_rat	    --资产负债率
        ,row_number() over(partition by cst_id order by rcd_tm desc) rn
    from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
    where dt='20250201'
)t4 on t1.cst_id=t4.cst_id
and t4.rn=1
left join edw.dws_cst_ccrc_idv_ind_inf_dd  t5 --个人征信指标信息表
on t1.cst_id=t5.cst_id
and t5.dt='20250201'
and t5.report_dsc_rn=1
left join(
    SELECT  t1.report_id
        ,SUM(CASE WHEN t1.dtrb_org <> 'ZJTLCB' AND t1.act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN t1.ovd_trm END) AS 他行贷款逾期期数
    FROM edw.dim_cst_ccrc_idv_loan_inf_dd       t1 --个人征信客户贷款信息
    WHERE t1.DT = '20250201'
    AND t1.cls_dt >= '20250201' --未关闭
    GROUP BY t1.report_id
)t6 on t6.report_id=t5.report_no
left join
(
      select report_no,late_12mon_loan_od_num  --近12个月贷款逾期期数
            ,row_number() over(partition by report_no order by dt desc) rn
      from   edw.ncip_zx_p_zb_info
      where  dt <= '20250201'
)g on t5.report_no = g.report_no
and g.rn=1
left join edw.dws_cst_ccrc_idv_ind_inf_dd  t7 --个人征信指标信息表
on t1.cst_id=t7.cst_id
and t7.report_dsc_rn=1
left join(
    -- 近6月日均余额
    select cst_id
        ,sum(cny_authr_crdt_bal) as bal_6m	--授信余额_折人民币
        ,count(distinct dt)     as diff_days
    from adm_rsk.adm_rsk_apl_cst_use_crdt_ctr_info_dd	--风险集市客户授信用信合同维度信息表(信用卡和贷款合同整合宽表)
    group by cst_id
)t8 on t1.cst_Id=t8.cst_id
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ20250220156_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ20250220156_CST_04 as
SELECT  mgr_org_id          AS 管户机构号
       ,t1.mgr_id           AS 管户人工号
       ,t1.mgr_nm           AS 管户人
       ,t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户名称
       ,t2.scor_rng         AS 最新征信分数段
       ,nvl(t2.cst_cr_grd_val,0) - nvl(t3.cst_cr_grd_val,0) AS 最新征信分较上次变化
       ,t1.slf_ast_lbl_rat                    AS 本人资产负债率
       ,t1.ast_lbl_rat                        AS 资产负债率
       ,t1.oth_bank_loan_credit_bal           AS 他行贷款授信余额
       ,case when nvl(t1.oth_bank_loan_credit_bal,0)+nvl(t5.cny_authr_crdt_bal,0) >= nvl(t1.近6月日均余额,0)*2
            and nvl(t5.cny_authr_crdt_bal,0)/nullif(t5.cny_authr_crdt_amt,0)>0.9 then '是' else '' end as 近半年负债增加过快
       ,t1.oth_bank_loan_org_num    AS 他行贷款授信机构数
       ,t1.近半年他行贷款授信机构数变化
       ,t1.他行贷款逾期期数
       ,t1.late_12mon_loan_od_num   AS 近12个月贷款逾期期数
       ,t4.近一年我行逾期借据数
from SJXQ_SJ20250220156_CST_03      t1
left join SJXQ_SJ20250220156_CST_02 t2
on t1.cst_Id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ20250220156_CST_02_1 t3
on t1.cst_Id=t3.cst_id
LEFT JOIN
(
	SELECT  t1.cst_id
	       ,COUNT(DISTINCT t1.dbil_id) AS 近一年我行逾期借据数
	FROM edw.dws_bus_loan_dbil_inf_dd t1
	WHERE t1.DT = '20250201'
	GROUP BY  t1.cst_id
) t4 ON t1.cst_id = t4.cst_id
left join(
	SELECT cst_id
		,sum(cny_authr_crdt_bal) as cny_authr_crdt_bal
		,sum(cny_authr_crdt_amt) as cny_authr_crdt_amt
	from adm_rsk.adm_rsk_apl_cst_use_crdt_ctr_info_dd --风险集市客户授信用信合同维度信息表(信用卡和贷款合同整合宽表)
	where dt='20250201' GROUP BY cst_id
) t5 on t1.cst_id=t5.cst_id
;
SElECT '04' seq, *
from SJXQ_SJ20250220156_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220156_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220156_CST_02 where rn=1
union all
SElECT '021' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220156_CST_02_1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220156_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250220156_CST_04
;
/*
01	355	355
02	3571661	3571660
03	355	355
04	355	355
*/***郭少聪_SJ2025060936_龙海存量信贷业务.sql
-- 截至20250609 龙海村行 未到期未终结合同业务
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_01 AS
SELECT  A1.cst_id       --客户号
        ,A1.cst_nm      --客户名称
        ,A2.grnt_gds_id as grnt_psn_id --担保人客户号
        ,A3.cst_chn_nm  as grnt_psn_nm --担保人客户名称
FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
LEFT JOIN    edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd A2 --主合同、担保合同、担保物关系
ON      A1.ctr_serno = A2.ctr_serno --合同流水号
AND     A2.grnt_gds_typ_cd = '1' --筛选保证人
AND     A2.DT = '20250609'
LEFT JOIN    edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON      A2.grnt_gds_id = A3.cst_id
AND     A3.DT = '20250609'
WHERE   A1.DT = '20250609'
AND     A1.mgr_org_id LIKE '3563%' --龙海村行
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( a1.CTR_STS_CD IN ( '2' , '4' )
AND     a1.TMT_DT = '18991231'
AND     to_date(a1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(a1.dt, 'yyyyMMdd') )
    OR a1.CTR_BAL > 0 ) --未到期未终结口径
;
--客户汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_02 AS
SELECT  t1.cst_id       --客户号
    ,t1.cst_nm          --客户名称
    ,t1.our_bnk_role    --我行角色
    ,t1.主借款人客户号
    ,t1.主借款人名称
    ,T2.ctr_amt         --合同金额
    ,T2.ctr_bal         --合同余额
	,t3.prm_mgr_id      --主管户客户经理工号
	,t3.prm_mgr_nm      --主管户客户经理姓名
	,t3.prm_org_id      --主管户机构号
	,t3.prm_org_nm      --主管户机构名称
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from(
SELECT   A1.cst_id      --客户号
        ,A1.cst_nm      --客户名称
        ,'借款人'   AS our_bnk_role
        ,A1.cst_id  AS 主借款人客户号
        ,A1.cst_nm  AS 主借款人名称
    FROM SJXQ_SJ2025060936_CST_01 A1
    UNION
    SELECT A1.grnt_psn_id
        ,A1.grnt_psn_nm
        ,'保证人'
        ,A1.cst_id         AS 主借款人客户号
        ,A1.cst_nm         AS 主借款人名称
    FROM SJXQ_SJ2025060936_CST_01 A1
    WHERE COALESCE(A1.grnt_psn_id, '') <> ''
)t1 left join(
    select t1.cst_id                                   --客户号|C20
        ,SUM(t1.ctr_amt) AS ctr_amt                                  --合同金额DECIMAL(21,2)
        ,SUM(t1.ctr_bal) AS ctr_bal                                  --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt=t1.dt
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20250609'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    GROUP BY T1.cst_id
)t2 on t1.cst_id=t2.cst_id
left join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250609'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250609'
;
-- 3.个人人行征信报告相关还款责任信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_03 AS
SELECT  A01.cst_id                                                              AS 客户号
        ,SUBSTR(A1.crd_rpt_id, 1, 8)                                            AS 征信日期
        ,A1.bus_mng_org_typ                                                     AS 对外担保机构类型代码
        ,CASE
           WHEN A1.bus_mng_org_typ = '11' THEN '商业银行'
           WHEN A1.bus_mng_org_typ = '12' THEN '村镇银行'
           WHEN A1.bus_mng_org_typ = '14' THEN '住房储蓄银行'
           WHEN A1.bus_mng_org_typ = '15' THEN '外资银行'
           WHEN A1.bus_mng_org_typ = '16' THEN '财务公司'
           WHEN A1.bus_mng_org_typ = '21' THEN '信托公司'
           WHEN A1.bus_mng_org_typ = '22' THEN '融资租赁公司'
           WHEN A1.bus_mng_org_typ = '23' THEN '汽车金融公司'
           WHEN A1.bus_mng_org_typ = '24' THEN '消费金融公司'
           WHEN A1.bus_mng_org_typ = '25' THEN '贷款公司'
           WHEN A1.bus_mng_org_typ = '26' THEN '金融资产管理公司'
           WHEN A1.bus_mng_org_typ = '31' THEN '证券公司'
           WHEN A1.bus_mng_org_typ = '41' THEN '保险公司'
           WHEN A1.bus_mng_org_typ = '51' THEN '小额贷款公司'
           WHEN A1.bus_mng_org_typ = '52' THEN '公积金管理中心'
           WHEN A1.bus_mng_org_typ = '53' THEN '融资担保公司'
           WHEN A1.bus_mng_org_typ = '54' THEN '保理公司'
           WHEN A1.bus_mng_org_typ = '99' THEN '其他机构'
         END                                                                    AS 对外担保机构类型
        ,A1.bus_cls                                                             AS 业务品种代码
        ,COALESCE(A2.cd_nm, '')                                                 AS 业务品种
        ,A1.opn_dt                                                              AS 开立日期
        ,A1.mtu_dt                                                              AS 到期日期
        ,A1.rel_rpay_duty_typ                                                   AS 责任人类型代码
        ,CASE
           WHEN A1.rel_rpay_duty_typ = '1' THEN '共同借款人'
           WHEN A1.rel_rpay_duty_typ = '2' THEN '保证人'
           WHEN A1.rel_rpay_duty_typ = '3' THEN '票据承兑人'
           WHEN A1.rel_rpay_duty_typ = '4' THEN '应收账款债务人'
           WHEN A1.rel_rpay_duty_typ = '5' THEN '供应链中核心企业'
           WHEN A1.rel_rpay_duty_typ = '9' THEN '其他'
           ELSE A1.rel_rpay_duty_typ
         END                                                                    AS 责任人类型
        ,A1.REL_RPAY_DUTY_AMT                                                   AS 还款责任金额
        ,A1.CCY                                                                 AS 币种代码
        ,COALESCE(A3.cd_nm, '')                                                 AS 币种
        ,A1.BAL                                                                 AS 余额
        ,A1.FIVE_CTG                                                            AS 五级分类代码
        ,CASE
           WHEN A1.five_ctg = '1' THEN '正常'
           WHEN A1.five_ctg = '2' THEN '关注'
           WHEN A1.five_ctg = '3' THEN '次级'
           WHEN A1.five_ctg = '4' THEN '可疑'
           WHEN A1.five_ctg = '5' THEN '损失'
           WHEN A1.five_ctg = '6' THEN '违约'
           WHEN A1.five_ctg = '9' THEN '未分类'
           ELSE A1.five_ctg
         END                                                                    AS 五级分类
        ,A1.prm_brw_ctg                                                         AS 主借款人身份类别
		,'个人'                                                                 AS 类型
FROM    edw.dwd_cst_ccrc_ipcr_rel_rpay_duty_di A1  --个人人行征信报告相关还款责任信息
INNER JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd A01  --个人征信指标信息表
ON      A1.crd_rpt_id = A01.report_no
AND     A01.report_dsc_rn= 1
AND     A01.DT = '20250609'
INNER JOIN   (SELECT DISTINCT cst_id FROM  SJXQ_SJ2025060936_CST_02) A0
ON      A0.cst_id = A01.cst_id
LEFT JOIN    edw.dim_bus_com_ipcr_code_dic_dd A2 --个人人行征信报告码值信息
ON      A2.cd = A1.bus_cls
AND     A2.cd_eng_cls = 'PER_LENDINGTRADING_BUSINESSCLASS' --个人借贷交易业务种类代码表
AND     A2.dt = '20250609'
LEFT JOIN    edw.dim_bus_com_ipcr_code_dic_dd A3 --个人人行征信报告码值信息
ON      A3.CD = A1.CCY
AND     A3.CD_ENG_CLS = 'CURRENCY' --币种
AND     A3.DT = '20250609'
WHERE   A1.DT <= '20250609';
-- 4.企业_相关还款责任借贷账户
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_04 AS
SELECT  A01.cst_id                                                      AS 客户号
        ,SUBSTR(A1.rpt_id, 1, 8)                                        AS 征信日期
        ,A1.bus_mng_org_typ_cd                                          AS 对外担保机构类型代码
        ,COALESCE(A2.DIC_NAME, '')                                      AS 对外担保机构类型
        ,A1.BUS_TYP_CD                                                  AS 业务品种代码
        ,COALESCE(A3.DIC_NAME, '')                                      AS 业务品种
        ,A1.OPN_DT                                                      AS 开立日期
        ,A1.MTU_DT                                                      AS 到期日期
        ,A1.REK_RPAY_DTY_TYP_CD                                         AS 责任人类型代码 --相关还款责任人类型代码
        ,CASE
           WHEN A1.REK_RPAY_DTY_TYP_CD = '1' THEN '个人信贷交易共同还款人/共同债务人'
           WHEN A1.REK_RPAY_DTY_TYP_CD = '2' THEN '保证人/反担保人'
           WHEN A1.REK_RPAY_DTY_TYP_CD = '3' THEN '票据承兑人'
           WHEN A1.REK_RPAY_DTY_TYP_CD = '4' THEN '应收账款债务人'
           WHEN A1.REK_RPAY_DTY_TYP_CD = '5' THEN '供应链中核心企业'
           WHEN A1.REK_RPAY_DTY_TYP_CD = '9' THEN '其他' --3、4、5情况汇总
           WHEN A1.REK_RPAY_DTY_TYP_CD = '0' THEN '合计' --对 1、2、9 情况的汇总。
           ELSE ''
         END                                                            AS 责任人类型 --相关还款责任人类型
        ,A1.REL_RPAY_DTY_AMT                                            AS 还款责任金额 --相关还款责任金额
        ,A1.CCY_CD                                                      AS 币种代码 --币种代码
        ,COALESCE(A4.DIC_NAME, '')                                      AS 币种 --币种
        ,A1.BAL                                                         AS 余额 --余额
        ,A1.FIVE_CTG_CD                                                 AS 五级分类代码 --五级分类
        ,CASE
           WHEN A1.FIVE_CTG_CD = '1' THEN '正常'
           WHEN A1.FIVE_CTG_CD = '2' THEN '关注'
           WHEN A1.FIVE_CTG_CD = '3' THEN '次级'
           WHEN A1.FIVE_CTG_CD = '4' THEN '可疑'
           WHEN A1.FIVE_CTG_CD = '5' THEN '损失'
           WHEN A1.FIVE_CTG_CD = '6' THEN '违约'
           WHEN A1.FIVE_CTG_CD = '9' THEN '未分类'
           ELSE ''
         END                                                            AS 五级分类 --五级分类
        ,A1.PRM_BRW_ID_TYP_CD                                           AS 主借款人身份类别
        ,'企业_借贷账户'                                                      AS 类型
FROM    edw.dwd_cst_ccrc_rel_rpay_dty_crd_dbt_act_di A1 --相关还款责任借贷账户
INNER JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd A01 --企业征信指标信息表
ON      A1.rpt_id = A01.report_no
AND     A01.report_dsc_rn= 1
AND     A01.DT = '20250609'
INNER JOIN   (SELECT DISTINCT cst_id FROM  SJXQ_SJ2025060936_CST_02) A0
ON      A0.cst_id = A01.cst_id
LEFT JOIN    edw.ncip_ceq_convert_dic A2 --企业机构化字典映射表
ON      A2.dic_code = A1.bus_mng_org_typ_cd
AND     A2.dic_type = 'BUSINESSADMINORGTYPE' --业务管理机构类型代码
AND     A2.DT = '20250609'
LEFT JOIN    edw.ncip_ceq_convert_dic A3 --企业机构化字典映射表
ON      A3.dic_code = A1.bus_typ_cd
AND     A3.dic_type IN ( 'ENT_LENDINGBUSINESS_LARGECLASS' , 'PER_LENDINGBUSINESS_LARGECLASS' ) --借贷业务大类代码
AND     A3.DT = '20250609'
LEFT JOIN    edw.ncip_ceq_convert_dic A4 --企业机构化字典映射表
ON      A4.DIC_CODE = A1.CCY_CD
AND     A4.DIC_TYPE = 'CURRENCY' --币种
AND     A4.DT = '20250609'
WHERE   A1.DT <= '20250609';
-- 5.企业_相关还款责任担保账户
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_05 AS
SELECT  A01.cst_id                                                       AS 客户号
        ,SUBSTR(A1.rpt_id, 1, 8)                                        AS 征信日期
        ,A1.bus_mng_org_typ_cd                                          AS 对外担保机构类型代码
        ,COALESCE(A2.DIC_NAME, '')                                      AS 对外担保机构类型
        ,A1.BUS_TYP_SEG_CD                                              AS 业务品种代码
        ,COALESCE(A3.DIC_NAME, '')                                      AS 业务品种
        ,''                                                             AS 开立日期
        ,''                                                             AS 到期日期
        ,A1.REL_RPAY_DTY_TYP_CD                                         AS 责任人类型代码 --相关还款责任类型代码
        ,CASE
           WHEN A1.REL_RPAY_DTY_TYP_CD = '1' THEN '个人信贷交易共同还款人/共同债务人'
           WHEN A1.REL_RPAY_DTY_TYP_CD = '2' THEN '保证人/反担保人'
           WHEN A1.REL_RPAY_DTY_TYP_CD = '3' THEN '票据承兑人'
           WHEN A1.REL_RPAY_DTY_TYP_CD = '4' THEN '应收账款债务人'
           WHEN A1.REL_RPAY_DTY_TYP_CD = '5' THEN '供应链中核心企业'
           WHEN A1.REL_RPAY_DTY_TYP_CD = '9' THEN '其他' --3、4、5情况汇总
           WHEN A1.REL_RPAY_DTY_TYP_CD = '0' THEN '合计' --对 1、2、9 情况的汇总。
           ELSE ''
         END                                                            AS 责任人类型 --相关还款责任类型
        ,A1.REL_RPAY_DTY_AMT                                            AS 还款责任金额 --相关还款责任金额
        ,''                                                             AS 币种代码
        ,''                                                             AS 币种
        ,A1.BAL                                                         AS 余额 --余额
        ,A1.FIVE_CTG_CD                                                 AS 五级分类代码 --五级分类
        ,CASE
           WHEN A1.FIVE_CTG_CD = '1' THEN '正常'
           WHEN A1.FIVE_CTG_CD = '2' THEN '关注'
           WHEN A1.FIVE_CTG_CD = '3' THEN '次级'
           WHEN A1.FIVE_CTG_CD = '4' THEN '可疑'
           WHEN A1.FIVE_CTG_CD = '5' THEN '损失'
           WHEN A1.FIVE_CTG_CD = '6' THEN '违约'
           WHEN A1.FIVE_CTG_CD = '9' THEN '未分类'
           ELSE ''
         END                                                            AS 五级分类 --五级分类
        ,''                                                             AS 主借款人身份类别
        ,'企业_担保账户'                                                      AS 类型
FROM    edw.dwd_cst_ccrc_rel_rpay_dty_grnt_act_di A1 --相关还款责任担保账户
INNER JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd A01 --企业征信指标信息表
ON      A1.rpt_id = A01.report_no
AND     A01.report_dsc_rn= 1
AND     A01.DT = '20250609'
INNER JOIN   (SELECT DISTINCT cst_id FROM  SJXQ_SJ2025060936_CST_02) A0
ON      A0.cst_id = A01.cst_id
LEFT JOIN    edw.ncip_ceq_convert_dic A2 --企业机构化字典映射表
ON      A2.dic_code = A1.bus_mng_org_typ_cd
AND     A2.dic_type = 'BUSINESSADMINORGTYPE' --业务管理机构类型代码
AND     A2.DT = '20250609'
LEFT JOIN    edw.ncip_ceq_convert_dic A3 --企业机构化字典映射表
ON      A3.DIC_CODE = A1.BUS_TYP_SEG_CD
AND     A3.DIC_TYPE = 'GUARBUSINESSLINESSUB' --担保业务种类细分代码
AND     A3.DT = '20250609'
WHERE   A1.DT <= '20250609';
-- 6.企业_相关还款责任贴现账户
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_06 AS
SELECT  A2.cst_id                                                          AS 客户号
        ,SUBSTR(A1.report_id, 1, 8)                                        AS 征信日期
        ,A1.org_type                                                       AS 对外担保机构类型代码
        ,COALESCE(A3.DIC_NAME, '')                                         AS 对外担保机构类型
        ,A1.category_segmentation                                          AS 业务品种代码
        ,COALESCE(A4.DIC_NAME, '')                                         AS 业务品种
        ,''                                                                AS 开立日期
        ,''                                                                AS 到期日期
        ,A1.duty_type                                                      AS 责任人类型代码
        ,CASE
           WHEN A1.duty_type = '1' THEN '个人信贷交易共同还款人/共同债务人'
           WHEN A1.duty_type = '2' THEN '保证人/反担保人'
           WHEN A1.duty_type = '3' THEN '票据承兑人'
           WHEN A1.duty_type = '4' THEN '应收账款债务人'
           WHEN A1.duty_type = '5' THEN '供应链中核心企业'
           WHEN A1.duty_type = '9' THEN '其他' --3、4、5情况汇总
           WHEN A1.duty_type = '0' THEN '合计' --对 1、2、9 情况的汇总。
           ELSE ''
         END                                                               AS 责任人类型 --相关还款责任类型
        ,A1.duty_fund                                                      AS 还款责任金额
        ,''                                                                AS 币种代码
        ,''                                                                AS 币种
        ,A1.balance                                                        AS 余额 --余额
        ,A1.five_categories                                                AS 五级分类代码 --五级分类
        ,CASE
           WHEN A1.five_categories = '1' THEN '正常'
           WHEN A1.five_categories = '2' THEN '关注'
           WHEN A1.five_categories = '3' THEN '次级'
           WHEN A1.five_categories = '4' THEN '可疑'
           WHEN A1.five_categories = '5' THEN '损失'
           WHEN A1.five_categories = '6' THEN '违约'
           WHEN A1.five_categories = '9' THEN '未分类'
           ELSE ''
         END                                                               AS 五级分类 --五级分类
        ,''                                                                AS 主借款人身份类别
        ,'企业_贴现'                                                       AS 类型
FROM    edw.ncip_ed08_escu_cor_unit A1 --相关还款责任贴现账户
INNER JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd A2 --企业征信指标信息表
ON      A1.report_id = A2.report_no
AND     A2.report_dsc_rn= 1
AND     A2.DT = '20250609'
INNER JOIN   (SELECT DISTINCT cst_id FROM  SJXQ_SJ2025060936_CST_02) A0
ON      A0.cst_id = A2.cst_id
LEFT JOIN    edw.ncip_ceq_convert_dic A3 --企业机构化字典映射表
ON      A3.dic_code = A1.org_type
AND     A3.dic_type = 'BUSINESSADMINORGTYPE' --业务管理机构类型代码
AND     A3.DT = '20250609'
LEFT JOIN    edw.ncip_ceq_convert_dic A4 --企业机构化字典映射表
ON      A4.DIC_CODE = A1.category_segmentation
AND     A4.DIC_TYPE = 'GUARBUSINESSLINESSUB' --担保业务种类细分代码
AND     A4.DT = '20250609'
WHERE   A1.DT <= '20250609';
--------------------------
-- 7.结果表汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025060936_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025060936_CST_07 AS
SELECT  a1.brc_org_nm   AS 主管户分行
       ,a1.sbr_org_nm   AS 主管户支行
       ,a1.tem_org_nm   AS 主管户团队
       ,a1.prm_mgr_id   AS 主管户客户经理工号
       ,a1.prm_mgr_nm   AS 主管户客户经理姓名
       ,a1.cst_id       AS 客户号
       ,a1.cst_nm       AS 客户名称
       ,a1.our_bnk_role AS 我行角色
       ,a1.主借款人客户号
       ,a1.主借款人名称
       ,a1.ctr_amt      AS 我行借款合同金额
       ,a1.ctr_bal      AS 我行借款合同余额
       ,a2.对外担保异常情况
       ,a2.对外担保异常金额
       ,a2.对外担保异常余额
       ,a2.cls  as 对外担保异常账户类别
FROM    SJXQ_SJ2025060936_CST_02 A1
LEFT JOIN    (
    SELECT  客户号
        ,SUM(还款责任金额)                      AS 对外担保异常金额
        ,SUM(余额)                             AS 对外担保异常余额
    from(
        SELECT  客户号
            ,CAST(还款责任金额 AS decimal) AS 还款责任金额
            ,CAST(余额 AS decimal) AS 余额
            ,五级分类
            ,'个人' as cls
        FROM SJXQ_SJ2025060936_CST_03 T3
        UNION ALL
        SELECT  客户号
            ,还款责任金额
            ,余额
            ,五级分类
            ,'企业_借贷' as cls
        FROM SJXQ_SJ2025060936_CST_04 T4
        UNION ALL
        SELECT  客户号
            ,还款责任金额
            ,余额
            ,五级分类
            ,'企业_担保' as cls
        FROM SJXQ_SJ2025060936_CST_05 T5
        UNION ALL
        SELECT  客户号
            ,还款责任金额
            ,余额
            ,五级分类
            ,'企业_贴现' as cls
        FROM SJXQ_SJ2025060936_CST_06 T6
    )t1 group by 客户号
) A2 ON A1.cst_id = A2.客户号
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025060936_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025060936_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060936_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060936_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060936_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060936_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025060936_CST_07
***郭芝伊_SJ2025022881_信用卡风险排查.sql
﻿-- 2024年度全年，台州分行客户信用卡交易数据
-- 台州分行信用卡
DROP   TABLE IF     EXISTS SJXQ_SJ2025022881_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022881_CST_01 AS
SELECT  T3.CST_ID,T3.CST_NM	--客户名称
       ,T3.BUSI_APL_ID     --信用卡申请流水号
       ,T3.CR_CRD_CARD_NBR --信用卡卡号
       ,T3.BUSI_CTR_ID     --业务合同编号
       ,T3.CR_CRD_PD_ID    --信用卡产品编号
       ,T3.ISU_DT          --发卡日期
       ,T3.CARD_ACTV_DT    --卡片激活日期
       ,T3.CARD_STS_CD     --卡片状态代码
       ,c1.cd_val_dscr  as CARD_STS_nm
       ,T4.CR_CRD_ACT_ID   --信用卡账户
       ,T4.ACT_STS_CD      --信用卡账户状态
       ,c2.cd_val_dscr  as ACT_STS_nm
       ,T4.OPN_DT          --信用卡账户开户日期
       ,T4.BIN_SNG_DAY	   --账单日
       ,T4.CRD_LMT         --信用卡账户额度
       ,t4.cr_lmt_amt_sh	--	影子额度
       ,t4.init_cr_lmt_amt	--	初始额度
       ,t4.shdw_lmt_ind	--	影子额度标志
       ,t4.orig_crd_lmt	--	信用额度
       ,T4.BAL             --信用卡账户余额
       ,T5.BRC_ORG_NM,T5.SBR_ORG_NM,T5.ORG_NM
       ,t6.ctr_amt
FROM EDW.DIM_BUS_CRD_CR_CRD_INF_DD           T3 --信用卡卡片信息
INNER JOIN EDW.DWS_BUS_CRD_CR_CRD_ACT_INF_DD T4 --信用卡账户信息汇总
ON T3.CST_ID = T4.CST_ID
AND T3.CR_CRD_ACT_ID = T4.CR_CRD_ACT_ID --信用卡账户
AND T4.DT = '@@{yyyyMMdd}'
and t4.acs_org_id like '3301%'	--	考核机构|C12
left join edw.dim_hr_org_mng_org_tree_dd     t5
on t4.acs_org_id=t5.org_id
and t5.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_bse_inf_dd   t6
on t3.BUSI_CTR_ID=t6.ctr_serno
and t6.dt='@@{yyyyMMdd}'
left join EDW.DWD_CODE_LIBRARY_DD           c1
on T3.CARD_STS_CD=c1.cd_val
and C1.DT = '@@{yyyyMMdd}'
left join EDW.DWD_CODE_LIBRARY_DD           c2
on T4.ACT_STS_CD=c2.cd_val
and C2.DT = '@@{yyyyMMdd}'
WHERE T3.DT = '@@{yyyyMMdd}'
and t3.late_card_ind='1'    --最新卡标志
;
-- 客户信用卡交易
DROP   TABLE IF     EXISTS SJXQ_SJ2025022881_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022881_CST_02 AS
SELECT  T2.CR_CRD_CRD_NO   --信用卡卡号
       ,T2.CR_CRD_ACT_ID   --信用卡账号
       ,T2.CST_ID          --客户编号
       ,T1.CST_NM
       ,T2.TRX_DT          --交易日期
       ,T2.TRX_TM          --交易时间
       ,T2.TRX_TYP_CD      --交易类型代码
       ,T2.TRX_TYP_DSCR    --交易类型描述
       ,T2.TRX_TYP_CL_DSCR --交易类型分类描述
       ,T2.TRX_CCY_CD      --交易币种代码
       ,T2.TRX_AMT         --交易金额
       ,T2.ACT_BAL         --账户余额
       ,T2.MCH_TYP_CD      --商户类型代码
       ,T2.MCH_CD          --商户代码
       ,T2.CNCL_RVSL_IND   --撤销冲正标志
       ,T2.CUNT_PTY_ACT_ID --对方账号
       ,T2.CUNT_PTY_ACT_NM --对方户名
       ,T2.MON_NO          --月份编号
       ,T2.TRX_DSCR1       --交易描述1
       ,T2.TRX_DSCR2       --交易描述2
    ,case when concat(t2.TRX_TYP_DSCR,t2.TRX_TYP_CL_DSCR,t2.TRX_DSCR1,t2.TRX_DSCR2) regexp '退|失败' then 1 else 0 end as rlue_a
    ,case when (nvl(t1.CST_NM,'')<>'' and t1.cst_nm=t2.CUNT_PTY_ACT_NM) or T2.TRX_DSCR1 regexp t1.cst_nm
        or T2.CUNT_PTY_ACT_NM='网联支付通汇汇差' then 1 else 0 end as rlue_b
FROM SJXQ_SJ2025022881_CST_01 t1
inner JOIN adm_pub_app.adm_pblc_bsn_cr_crd_trx_dtl_di T2 --信用卡交易明细
ON T1.CR_CRD_ACT_ID = T2.CR_CRD_ACT_ID
AND T1.CR_CRD_CARD_NBR = T2.CR_CRD_CRD_NO
AND T2.DT <= '@@{yyyyMMdd}'
and T2.trx_dt between '20240101' and '20241231'
;
-- 规则1：台州分行客户，2024年（每月信用卡贷方金额/信用卡额度&ge;10）的月份数&ge;2
DROP   TABLE IF     EXISTS SJXQ_SJ2025022881_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022881_CST_03 AS
select t1.CR_CRD_CARD_NBR
    ,sum(case when t1.CRD_LMT>0 and abs(t2.mon_trx_amt/t1.CRD_LMT)>=10 then 1 else 0 end) as abn_cnt
from SJXQ_SJ2025022881_CST_01 t1
left join(
    select CR_CRD_CRD_NO,substr(trx_dt,1,6) as mon
        ,sum(trx_amt)   mon_trx_amt
    from SJXQ_SJ2025022881_CST_02
    where trx_amt<0     --贷方金额
    group by CR_CRD_CRD_NO,mon
)t2 on T1.CR_CRD_CARD_NBR = T2.CR_CRD_CRD_NO
group by t1.CR_CRD_CARD_NBR
having abn_cnt>=2
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025022881_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022881_CST_04 AS
SELECT  t2.BRC_ORG_NM   AS 所属分行
    ,t2.cst_id          AS 客户号
    ,t1.CR_CRD_CARD_NBR AS 信用卡号
    ,t2.CRD_LMT         AS 信用卡额度
    ,t2.CARD_STS_nm     as 卡片状态
    ,t3.df_amt_01m as 2024年01月信用卡贷方金额合计
    ,t3.df_amt_02m as 2024年02月信用卡贷方金额合计
    ,t3.df_amt_03m as 2024年03月信用卡贷方金额合计
    ,t3.df_amt_04m as 2024年04月信用卡贷方金额合计
    ,t3.df_amt_05m as 2024年05月信用卡贷方金额合计
    ,t3.df_amt_06m as 2024年06月信用卡贷方金额合计
    ,t3.df_amt_07m as 2024年07月信用卡贷方金额合计
    ,t3.df_amt_08m as 2024年08月信用卡贷方金额合计
    ,t3.df_amt_09m as 2024年09月信用卡贷方金额合计
    ,t3.df_amt_10m as 2024年10月信用卡贷方金额合计
    ,t3.df_amt_11m as 2024年11月信用卡贷方金额合计
    ,t3.df_amt_12m as 2024年12月信用卡贷方金额合计
from SJXQ_SJ2025022881_CST_03       t1
left join SJXQ_SJ2025022881_CST_01  t2
on t1.CR_CRD_CARD_NBR=t2.CR_CRD_CARD_NBR
left join(
    select CR_CRD_CRD_NO
        ,sum(case when substr(trx_dt,1,6)='202401' then abs(trx_amt) else 0 end) as df_amt_01m
        ,sum(case when substr(trx_dt,1,6)='202402' then abs(trx_amt) else 0 end) as df_amt_02m
        ,sum(case when substr(trx_dt,1,6)='202403' then abs(trx_amt) else 0 end) as df_amt_03m
        ,sum(case when substr(trx_dt,1,6)='202404' then abs(trx_amt) else 0 end) as df_amt_04m
        ,sum(case when substr(trx_dt,1,6)='202405' then abs(trx_amt) else 0 end) as df_amt_05m
        ,sum(case when substr(trx_dt,1,6)='202406' then abs(trx_amt) else 0 end) as df_amt_06m
        ,sum(case when substr(trx_dt,1,6)='202407' then abs(trx_amt) else 0 end) as df_amt_07m
        ,sum(case when substr(trx_dt,1,6)='202408' then abs(trx_amt) else 0 end) as df_amt_08m
        ,sum(case when substr(trx_dt,1,6)='202409' then abs(trx_amt) else 0 end) as df_amt_09m
        ,sum(case when substr(trx_dt,1,6)='202410' then abs(trx_amt) else 0 end) as df_amt_10m
        ,sum(case when substr(trx_dt,1,6)='202411' then abs(trx_amt) else 0 end) as df_amt_11m
        ,sum(case when substr(trx_dt,1,6)='202412' then abs(trx_amt) else 0 end) as df_amt_12m
    from SJXQ_SJ2025022881_CST_02
    where trx_amt<0     --贷方金额
    group by CR_CRD_CRD_NO
)t3 on t1.CR_CRD_CARD_NBR=t3.CR_CRD_CRD_NO
;
-- 规则2：台州分行客户，查询信用卡账户在2024的所有贷方交易
-- a.剔除交易用途、交易摘要含&ldquo;退&rdquo;&ldquo;失败&rdquo;的
-- b.且剔除对方客户名称含客户本人名称、网联支付通汇汇差
-- c.剩余交易中筛选对方客户名称数量>= 10个
DROP   TABLE IF     EXISTS SJXQ_SJ2025022881_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025022881_CST_05 AS
SELECT  t2.BRC_ORG_NM   AS 所属分行
    ,t2.cst_id          AS 客户号
    ,t2.CR_CRD_CARD_NBR AS 信用卡号
    ,t2.CRD_LMT         AS 信用卡额度
    ,t1.df_custs        as 交易对手客户数
from(
    select CR_CRD_CRD_NO,count(distinct CUNT_PTY_ACT_NM) df_custs
    from SJXQ_SJ2025022881_CST_02
    where trx_amt<0     --贷方金额
    and rlue_a=0
    and rlue_b=0
    and nvl(CUNT_PTY_ACT_NM,'')<>''
    group by CR_CRD_CRD_NO having df_custs>=10
)t1 left join SJXQ_SJ2025022881_CST_01  t2
on t1.CR_CRD_CRD_NO=t2.CR_CRD_CARD_NBR
;
SElECT '01' seq, count(1) cnt,count(distinct CR_CRD_CARD_NBR) custs
from SJXQ_SJ2025022881_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct CR_CRD_CRD_NO) custs
from SJXQ_SJ2025022881_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct CR_CRD_CARD_NBR) custs
from SJXQ_SJ2025022881_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 信用卡号) custs
from SJXQ_SJ2025022881_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 信用卡号) custs
from SJXQ_SJ2025022881_CST_05
;
/*
01	394199	394199
02	13664904	394199
-- 客户信用卡交易
SELECT  t1.cst_id,t1.cst_nm,t1.CR_CRD_CARD_NBR --信用卡卡号
        ,t1.bin_sng_day	   --账单日
        ,t5.srl_nbr	--	流水号
        ,t5.mon_id	--	月份编号
        ,T5.TRX_DT --交易日期
        ,t5.trx_Tm
        ,t5.trx_ccy_cd
        ,T5.TRX_AMT --交易金额
        ,t5.cur_un_intr_bal
        ,t5.trx_ind --	交易标志
        ,t5.trx_src --	交易来源
        ,t5.wdw_rvs_ind --	撤销冲正标志
        ,T5.TRX_TYP_CD --交易类型代码
        ,T5.TRX_TYP_DSCR --交易类型描述
        ,case when T5.TRX_TYP_CD >= '2000' AND T5.TRX_TYP_CD <= '2999' then '取现转出'
            when T5.TRX_TYP_CD >= '1000' AND T5.TRX_TYP_CD <= '1999' AND T5.TRX_TYP_CD <> '1050' then '消费'
            when T5.TRX_TYP_CD IN ( '8130' , '8950' , '8952' , '8954' , '8956' , '8958' ) then '分期'
            else '' end xyk_trx_type
        ,T5.rtn_gds_trx_id --退货交易标识 XXXXX
        ,T5.trx_dscr_1 --交易描述1|C64
        ,T5.trx_dscr_2 --	交易描述2
        ,T5.mch_typ --商户类型|C32
        ,T5.mch_cd --商户代码|C32
        ,T5.acq_mch_enc --收单商户编码|C15
        ,T5.mch_seq_nbr --商户序号|N6
        ,t5.acq_org_id
FROM SJXQ_SJ2025022881_CST_01 t1
LEFT JOIN EDW.DWD_BUS_CRD_CR_CRD_TRX_DTL_DI T5 --信用卡客户交易流水
ON t1.CR_CRD_ACT_ID = T5.CR_CRD_ACT_ID
AND t1.CR_CRD_CARD_NBR = T5.CR_CRD_CARD_NBR
AND T5.DT <= '@@{yyyyMMdd}'
and t5.trx_dt between '20240101' and '20241231'
-- AND T5.WDW_RVS_IND <> '1' --撤销冲正标志 <> 1
--  AND ( ( T5.TRX_TYP_CD >= '2000' AND T5.TRX_TYP_CD <= '2999' ) --取现/转出
--  OR ( T5.TRX_TYP_CD >= '1000' AND T5.TRX_TYP_CD <= '1999' AND T5.TRX_TYP_CD <> '1050' ) --消费
--  OR ( T5.TRX_TYP_CD IN ( '8130' , '8950' , '8952' , '8954' , '8956' , '8958' ) ) --分期
--  )
;
*/
***郭芝伊_SJ2025050646_台州分行信保贷业务.sql
﻿-- 郭芝伊_SJ2025050646_台州分行信保贷业务
-- 郭芝伊_SJ2025050646_台州分行信保贷业务
-- 高风险国家
DROP   TABLE IF EXISTS SJXQ_SJ2025050646_CST_01 PURGE;
CREATE TABLE 		   SJXQ_SJ2025050646_CST_01
(
    ntn_cd   STRING COMMENT '国家代码'
    ,ntn_nm  STRING COMMENT '国家'
    ,ntn_cd2 STRING COMMENT '国家代码反洗钱'
);
insert into SJXQ_SJ2025050646_CST_01
;
---通用表：主管户为台州分行的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025050646_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025050646_CST_02 AS
SELECT  distinct t1.cst_id
       ,t2.brc_org_nm
       ,t3.cst_act_id
FROM adm_pub.adm_csm_cbas_mng_inf_dd t1 --客户管户信息
INNER JOIN edw.dim_hr_org_mng_org_tree_dd t2 --机构树
ON t1.prm_org_id = t2.org_id AND t2.dt = '20250430' AND t2.brc_org_id LIKE '3301%' --分行--法人机构：台州分行
LEFT JOIN edw.dim_bus_dep_act_inf_dd t3
ON t1.cst_id = t3.cst_id AND t3.dt = '20250430'
WHERE t1.dt = '20250430'
;
-- 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025050646_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025050646_CST_03 AS
select t1.cst_id
    ,case when t2.cst_id is not null then 1 else 0 end as is_xbd
    ,t3.cst_typ_cd -- 客户类型|C1
    ,t4.ntn_cd
    ,case when t5.ntn_cd is not null then 1 else 0 end as is_high_rsk_gj
    ,t5.ntn_nm
    ,case when t6.cst_id is not null then 1 else 0 end as is_high_rsk
    ,case when t7.cst_id is not null then 1 else 0 end as is_cdk
from(
    select distinct cst_id
    from SJXQ_SJ2025050646_CST_02
)t1 left join(
    SELECT distinct t1.CST_ID   --客户号|C20
    FROM edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同基础信息
    LEFT JOIN edw.dwd_code_library_dd   c1
    on t1.prd_usg_mark=c1.cd_val
    and     c1.dt = '20250430'
    WHERE t1.dt = '20250430'
    AND (t1.prd_tag_nm RLIKE '信保贷' or c1.cd_val_dscr regexp '信保贷')
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t2 on t1.cst_id=t2.cst_id
LEFT JOIN edw.dws_cst_bas_inf_dd t3
ON t1.cst_id = t3.cst_id AND t3.dt = '20250430'
left join(
    select cst_id,ntn_cd
    from edw.dws_cst_idv_bas_inf_dd
    where dt='20250430'
    union all
    select cst_id,reg_cnr_cd
    from edw.dim_cst_entp_bas_inf_dd
    where dt='20250430'
)t4 on t1.cst_id=t4.cst_id
left join SJXQ_SJ2025050646_CST_01 t5
on t4.ntn_cd=t5.ntn_cd
left join(
    SELECT  cst_id
    FROM
    (
        SELECT  SUBSTR(party_id,3,10) AS cst_id
            ,levelkey
            ,statistic_dt
            ,ROW_NUMBER() OVER ( PARTITION BY party_id ORDER BY  statistic_dt DESC ) AS rn
        FROM adm_upss.aml_t37_party_result_curr
        WHERE dt = '20250430'
    ) t
    WHERE t.levelkey IN ( '1004' , '1005' )
    AND t.rn = 1
)t6 on t1.cst_id=t6.cst_id
left join(
    -- 公安机关查冻扣记录
    SELECT distinct aa.cst_id
    FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
    WHERE aa.dt = '20250430'
    -- AND qry_ctrl_dt between '20240430' and '20250430'
    AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) )
)t7 on t1.cst_id=t7.cst_id
;
-- 本期该产品业务相关数据
SELECT  COUNT(cst_id)                                       AS 截止20250430信保贷客户数
       ,COUNT(case WHEN is_cdk = 1 THEN cst_id end)         AS 截止20250430信保贷查冻扣客户数
       ,COUNT(case WHEN is_high_rsk_gj = 1 THEN cst_id end) AS 截止20250430信保贷涉高风险地区客户数
       ,COUNT(case WHEN is_high_rsk = 1 THEN cst_id end)    AS 截止20250430信保贷较高风险及以上客户数
from SJXQ_SJ2025050646_CST_03
where is_xbd=1
;
-- 该产品24年4月30日至25年4月30日所有交易金额（万元）
SELECT  SUM(t.amt) / 10000 as 该产品近1年所有交易金额_万
FROM
(
	SELECT  a.cst_id
	       ,nvl(b.amt,0) AS amt
	FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD AS a
	INNER JOIN edw.DIM_BUS_LOAN_DBIL_INF_DD AS b
	ON a.CTR_SERNO = b.CTR_SERNO AND b.dt = '20250430'
    AND b.LVE_ACT_BGN_DT >= '20240430' AND b.LVE_ACT_BGN_DT <= '20250430'
    LEFT JOIN edw.dwd_code_library_dd   c1
    on a.prd_usg_mark=c1.cd_val
    and     c1.dt = '20250430'
	WHERE a.dt = '20250430'
	AND (a.prd_tag_nm RLIKE '信保贷'  or c1.cd_val_dscr regexp '信保贷')
	AND a.CST_ID IN (
        SELECT CST_ID
        FROM SJXQ_SJ2025050646_CST_03
    ) --复用：主管户为台州的客户
) t
;
--该产品24年4月30日至25年4月30日现金交易金额（万元）
SELECT  ( sum(nvl(dtrb_amt, 0)) + sum(nvl(rpay_tot_amt, 0)) ) / 10000 AS 该产品近1年现金交易金额_万
        ,sum(nvl(dtrb_amt, 0)) / 10000                                AS 放款金额
        ,sum(nvl(rpay_tot_amt, 0)) / 10000                            AS 还款总额
FROM    edw.dwd_bus_loan_cst_act_trx_dtl_di --贷款客户账户交易明细
WHERE   dt >= '20240430'
AND     dt <= '20250430'
AND     fnd_src = '0'   --1:转账|2:待销账|4:内部会计账|0:现金|3:内部资金账
AND     dbil_id IN (
    SELECT  b.dbil_id
    FROM    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD AS a
    INNER JOIN    edw.DIM_BUS_LOAN_DBIL_INF_DD AS b
    ON      a.CTR_SERNO = b.CTR_SERNO
    AND     b.dt = '20250430'
    AND     b.LVE_ACT_BGN_DT >= '20240430'
    AND     b.LVE_ACT_BGN_DT <= '20250430'
    LEFT JOIN edw.dwd_code_library_dd   c1
    on a.prd_usg_mark=c1.cd_val
    and     c1.dt = '20250430'
    WHERE   a.dt = '20250430'
    AND     (a.prd_tag_nm  RLIKE '信保贷' or c1.cd_val_dscr regexp '信保贷')
    AND     a.CST_ID IN (
                SELECT  CST_ID
                FROM    SJXQ_SJ2025050646_CST_03  --复用：主管户为台州的客户
            )
)
;
-- 本期分行所有业务相关数据
SELECT  COUNT(cst_id)                                       AS 截止20250430台州分行客户数
       ,COUNT(case WHEN is_high_rsk = 1 THEN cst_id end)    AS 截止20250430台州分行较高风险及以上客户数
from SJXQ_SJ2025050646_CST_03
;
-- 台州分行所有业务24年4月30日至25年4月30日所有交易金额（万元）
SELECT  SUM(trx_amt)/10000 as 台州分行近1年客户交易金额_万
    ,SUM(case when csh_ind='0' then trx_amt else 0 end)/10000 as 台州分行近1年客户现金交易金额_万
    ,SUM(case when csh_ind<>'0' then trx_amt else 0 end)/10000 as 台州分行近1年客户转账交易金额_万
FROM edw.dwd_bus_dep_bal_chg_dtl_di
WHERE dt >= '20240430'
AND dt <= '20240530'
and bal_fld_nm = 'DPLDGBAL' --动账
AND cst_act_id IN (
    select cst_act_id from SJXQ_SJ2025050646_CST_02
)
;
-- 去年同期该产品业务相关数据
-- 截至24年4月30日，该产品涉及客户数量【业务未结清】
-- 该产品23年4月30日至24年4月30日转账交易金额（万元）
DROP   TABLE IF     EXISTS SJXQ_SJ2025050646_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025050646_CST_04 AS
SELECT  distinct t1.cst_id
       ,t3.cst_act_id
       ,case when t4.cst_id is not null then 1 else 0 end as is_xbd
FROM adm_pub.adm_csm_cbas_mng_inf_dd t1 --客户管户信息
INNER JOIN edw.dim_hr_org_mng_org_tree_dd t2 --机构树
ON t1.prm_org_id = t2.org_id AND t2.dt = '20240430' AND t2.brc_org_id LIKE '3301%' --分行--法人机构：台州分行
LEFT JOIN edw.dim_bus_dep_act_inf_dd t3
ON t1.cst_id = t3.cst_id AND t3.dt = '20240430'
LEFT join(
    SELECT distinct t1.CST_ID   --客户号|C20
    FROM edw.dim_bus_loan_ctr_bse_inf_dd t1 --合同基础信息
    LEFT JOIN edw.dwd_code_library_dd   c1
    on t1.prd_usg_mark=c1.cd_val
    and     c1.dt = '20250430'
    WHERE t1.dt = '20240430'
    AND (t1.prd_tag_nm RLIKE '信保贷'  or c1.cd_val_dscr regexp '信保贷')
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
    AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t4 on t1.cst_id=t4.cst_id
WHERE t1.dt = '20240430'
;
select count(distinct cst_id)   as 截止20240430信保贷客户数
from SJXQ_SJ2025050646_CST_04
where is_xbd=1
;
-- 该产品23年4月30日至24年4月30日所有交易金额（万元）
SELECT  SUM(t.amt) / 10000 as 24年该产品近1年所有交易金额_万
FROM
(
	SELECT  a.cst_id
	       ,nvl(b.amt,0) AS amt
	FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD AS a
	INNER JOIN edw.DIM_BUS_LOAN_DBIL_INF_DD AS b
	ON a.CTR_SERNO = b.CTR_SERNO AND b.dt = '20240430'
    AND b.LVE_ACT_BGN_DT >= '20230430' AND b.LVE_ACT_BGN_DT <= '20240430'
    LEFT JOIN edw.dwd_code_library_dd   c1
    on a.prd_usg_mark=c1.cd_val
    and     c1.dt = '20250430'
	WHERE a.dt = '20240430'
	AND (a.prd_tag_nm RLIKE '信保贷'  or c1.cd_val_dscr regexp '信保贷')
	AND a.CST_ID IN (
        SELECT CST_ID
        FROM SJXQ_SJ2025050646_CST_04
    ) --复用：主管户为台州的客户
) t
;
-- 该产品23年4月30日至24年4月30日现金交易金额（万元）
SELECT  ( sum(nvl(dtrb_amt, 0)) + sum(nvl(rpay_tot_amt, 0)) ) / 10000 AS 24年该产品近1年现金交易金额_万
        ,sum(nvl(dtrb_amt, 0)) / 10000                                AS 放款金额
        ,sum(nvl(rpay_tot_amt, 0)) / 10000                            AS 还款总额
FROM    edw.dwd_bus_loan_cst_act_trx_dtl_di --贷款客户账户交易明细
WHERE   dt >= '20230430'
AND     dt <= '20240430'
AND     fnd_src = '0'   --1:转账|2:待销账|4:内部会计账|0:现金|3:内部资金账
AND     dbil_id IN (
    SELECT  b.dbil_id
    FROM    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD AS a
    INNER JOIN    edw.DIM_BUS_LOAN_DBIL_INF_DD AS b
    ON      a.CTR_SERNO = b.CTR_SERNO
    AND     b.dt = '20240430'
    AND     b.LVE_ACT_BGN_DT >= '20230430'
    AND     b.LVE_ACT_BGN_DT <= '20240430'
    LEFT JOIN edw.dwd_code_library_dd   c1
    on a.prd_usg_mark=c1.cd_val
    and     c1.dt = '20250430'
    WHERE   a.dt = '20240430'
    AND     (a.prd_tag_nm  RLIKE '信保贷' or c1.cd_val_dscr regexp '信保贷')
    AND     a.CST_ID IN (
                SELECT  CST_ID
                FROM    SJXQ_SJ2025050646_CST_04
            ) --复用：主管户为台州的客户
)
;
***郭芝伊_SJ2025052141_台州养老服务机构排查.sql
-- 监管提供台州市养老机构名单、台州市镇街养老服务机构名单，需匹配相关机构是否在我行开户。
-- 若开户，需提供截止2025年5月21日，台州分行养老领域机构客户基本信息、账户开户信息、账户交易信息及风险信息。详见附件。
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_01 AS
SELECT  col_1  --机构名称
       ,col_2  --机构社会信用代码
from lab_bigdata_dev.qbi_file_20250522_10_36_11_0
where pt<>''
;
--匹配客户号
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_02 AS
select t1.col_1
    ,t1.col_2
    ,t2.cst_id
    ,t2.cst_chn_nm
from SJXQ_SJ2025052141_CST_01       t1
inner join edw.dws_cst_bas_inf_dd   t2 --客户基础信息汇总表
on t1.col_2=t2.doc_nbr
and t2.dt='20250521'
where nvl(t1.col_2,'')<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_03 AS
select t1.col_1
    ,t1.col_2
    ,t2.cst_id
    ,t2.cst_chn_nm
from SJXQ_SJ2025052141_CST_01       t1
inner join edw.dws_cst_bas_inf_dd   t2 --客户基础信息汇总表
on t1.col_1=t2.cst_chn_nm
and t2.dt='20250521'
where t1.col_2 not in (
    select col_2 from SJXQ_SJ2025052141_CST_02
)
;
-- 客户账号
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_04 AS
select t1.cst_id
    ,t2.cst_act_id                               --客户账号|C32
	,t2.opn_dt                                   --开户日期|C8
	,t2.opn_org_id                               --开户机构编号|C12
    ,c1.org_nm          as 开户机构
	,t2.act_sts_cd                               --账户状态代码|C1
    ,c2.cd_val_dscr     as 账户状态
from (
    select cst_id
    from SJXQ_SJ2025052141_CST_02
    union
    select cst_id
    from SJXQ_SJ2025052141_CST_03
)t1 left join edw.dim_bus_dep_cst_act_inf_dd t2 --客户存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250521'
left join edw.dim_hr_org_mng_org_tree_dd    c1 --考核机构树
on  t2.opn_org_id = c1.org_id
and c1.dt = '20250521'
left join edw.dwd_code_library_dd           c2
on  t2.act_sts_cd = c2.cd_val
and c2.dt = '20250521'
where nvl(t1.cst_id,'')<>''
;
-- 开户以来涉及交易
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_05 AS
SELECT  t1.cst_act_id
       ,COUNT(1)        AS trx_cnt
       ,SUM(t1.trx_amt) AS trx_amt
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细表
inner join SJXQ_SJ2025052141_CST_04     t2 --存款账户信息汇总
on t1.cst_act_id=t2.cst_act_id
where t1.dt<='20250521'
and t1.bal_fld_nm = 'DPLDGBAL' --动账
group by t1.cst_act_id
;
-- 汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_06 AS
select t1.col_1
    ,t1.col_2
    ,t2.cst_id
    ,t2.cst_chn_nm
    ,t3.cst_act_id                               --客户账号
	,t3.opn_dt                                   --开户日期
    ,t3.开户机构
    ,t3.账户状态
    ,t4.trx_cnt
    ,t4.trx_amt
	,t5.opr_scp_dscr                             --经营范围描述|C3000
	,t5.reg_cpt                                  --注册资本|DECIMAL(20,2)
	,t5.actl_rcv_cpt                             --实收资本|DECIMAL(20,2)
	,t5.lctax_cert_no                            --地税证件号|C60
	,t6.prm_mgr_id                               --主管护客户经理工号
	,t6.prm_mgr_nm                               --主管护客户经理姓名
	,t6.prm_org_id                               --主管护机构号
	,t6.prm_org_nm                               --主管户机构名称
    ,case when t7.cst_id is not null then '是' else '否' end as 2021年至今是否反洗钱预警
    ,t8.levelkey_nm as 客户当前洗钱风险评级等级
    ,case when t9.cst_id is not null then '是' else '否' end as 客户历史有无查冻扣信息
from SJXQ_SJ2025052141_CST_01 t1
left join(
    select col_1,col_2,cst_id,cst_chn_nm
    from SJXQ_SJ2025052141_CST_02
    union all
    select col_1,col_2,cst_id,cst_chn_nm
    from SJXQ_SJ2025052141_CST_03
)t2 on t1.col_1=t2.col_1
left join SJXQ_SJ2025052141_CST_04 t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2025052141_CST_05 t4
on t3.cst_act_id=t4.cst_act_id
left join edw.dim_cst_entp_bas_inf_dd t5 --企业客户基本信息
on t2.cst_id=t5.cst_id
and t5.dt='20250521'
left join adm_pub.adm_csm_cbas_mng_inf_dd t6 --客户集市-客户基础-客户管户信息
on t2.cst_id=t6.cst_id
and t6.dt='20250521'
left join(
    SELECT  distinct substr(t1.party_id, 3, 12) AS cst_id
    FROM    adm_upss.aml_t07_case_application_uh t1 --案例历史表
    WHERE   t1.dt = '20250521'
    AND     substr(replace(t1.app_dt,'-',''),1,8) between '20210101' and '20250521'
    and     nvl(t1.application_num,'')<>''
)t7 on t2.cst_id=t7.cst_id
left join(
    SELECT  SUBSTR(party_id,3,10) AS cst_id
        ,decode(levelkey,'1001','低风险' ,'1002','较低风险' ,'1003','一般风险' ,'1004','较高风险' ,'1005','高风险') as levelkey_nm
        ,statistic_dt
        ,ROW_NUMBER() OVER ( PARTITION BY SUBSTR(party_id,3,10) ORDER BY statistic_dt DESC ) AS rn
    FROM adm_upss.aml_t37_party_result_curr
    WHERE dt = '20250521'
)t8 on t2.cst_id=t8.cst_id
and t8.rn=1
-- 公安机关查冻扣记录
left join(
    SELECT distinct aa.cst_id
    FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
    WHERE aa.dt = '20250521'
    AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) )
)t9 on t2.cst_id=t9.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025052141_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025052141_CST_07 AS
SELECT  col_1        AS 机构名称
       ,col_2        AS 机构社会信用代码
       ,cst_id       AS 客户号
       ,opr_scp_dscr AS 经营范围描述
       ,reg_cpt      AS 注册资本
       ,actl_rcv_cpt AS 实收资本
       ,cst_act_id   AS 客户账号
       ,opn_dt       AS 开户日期
       ,开户机构
       ,账户状态
       ,trx_cnt      AS 账户开户以来涉及交易笔数_笔
       ,trx_amt      AS 账户开户以来涉及交易金额_元
       ,prm_org_id   AS 主管护机构号
       ,prm_org_nm   AS 主管户机构名称
       ,prm_mgr_id   AS 主管护客户经理工号
       ,prm_mgr_nm   AS 主管护客户经理姓名
       ,2021年至今是否反洗钱预警
       ,客户当前洗钱风险评级等级
       ,客户历史有无查冻扣信息
from SJXQ_SJ2025052141_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2025052141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052141_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052141_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025052141_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025052141_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 机构名称) custs
from SJXQ_SJ2025052141_CST_07
;
SElECT '07' seq, *
from SJXQ_SJ2025052141_CST_07
;
/*
*/***金来_SJ20241231106_台州分行交易流水EVA.sql
select lgp_id                                   --法人编号
	,cst_id                                   --客户编号
	,mbl_cst                                  --是否是手机银行客户 (1是0否)
from adm_pub.adm_csm_cbus_dep_loan_info_dd    --客户集市-业务信息-客户存贷授信指标标签表
where dt='@@{yyyyMMdd}'
;
SELECT  cst_id
       ,SUM(pnt_bal) AS 客户当前综合积分余额
FROM edw.dim_bus_cmpn_pnt_act_inf_dd
WHERE dt = '@@{yyyyMMdd}'
AND pnt_typ_cd = '0001' -- 综合积分
GROUP BY  cst_id
;
SELECT  cst_id
       ,chm_cst_ind --是否理财客户
FROM app_rpt.adm_subl_cst_wlth_bus_inf_dd --正式客户财富业务信息表
WHERE dt = '@@{yyyyMMdd}'
;
SELECT  cst_id
       ,l12m_cst_val decimal 近12个月客户价值(eva)
       ,cur_y_cst_val decimal 当年客户客户价值(eva)
FROM adm_ind.ADM_IND_I_CST_FIN_BNFT_OI_AMT_IDX_DD
WHERE dt = '@@{yyyyMMdd}'
;
***金蒙蒙_SJ2025070316_存款转换理财保险分析.sql
﻿-- 金蒙蒙_SJ2025070316_存款转换理财保险分析
-- 温州分行2025年1月至6月到期的1Y、2Y、3Y、5Y定期存款，到期后（部分或全部）转化为保险产品、挂钩型理财产品的清单。
-- 导入数据-挂钩
DROP   TABLE IF     EXISTS SJXQ_SJ2025070316_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070316_CST_01 AS
SELECT  col_1   --账户考核机构分行名称
        ,col_2  --账户考核机构支行编号
        ,col_3  --账户考核机构支行名称
        ,col_4  --账户考核机构团队编号
        ,col_5  --账户考核机构团队名称
        ,col_6  --产品代码
        ,substr(replace(col_7,'-',''),1,8) as trx_dt  --交易日期  20250101-20250630
        ,col_8  --客户号
        ,col_9  --客户财富等级
        ,col_10 --管户人工号
        ,col_11 --员工姓名
        ,col_12 --员工所在团队负责人工号
        ,col_13 --员工所在团队负责人姓名
        ,col_14 --员工所在支行负责人工号
        ,col_15 --员工所在支行负责人姓名
        ,col_16 --销售人工号
        ,col_17 --销售姓名
        ,col_18 --交易金额
from lab_bigdata_dev.qbi_file_20250707_16_10_36_0
where pt<>''
;
-- 导入数据-保险
DROP   TABLE IF     EXISTS SJXQ_SJ2025070316_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070316_CST_02 AS
SELECT  replace(col_1,'-','') as trx_dt   --投保日期 20250109-20250630
        ,col_2  --客户号
        ,col_3  --客户账号
        ,col_4  --投保人姓名
        ,col_5  --缴纳保费
        ,col_6  --管护客户经理工号
        ,col_7  --管护客户经理姓名
        ,col_8  --管护比例
        ,col_9  --管护机构号
        ,col_10 --管护机构名称
from lab_bigdata_dev.qbi_file_20250707_16_09_55_0
where pt<>''
;
-- 2025上半年挂钩型理财购买金额
DROP   TABLE IF     EXISTS SJXQ_SJ2025070316_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070316_CST_03 AS
SELECT t1.srl_nbr,T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,t1.trx_dt  as trx_dt2
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,C1.cd_val_dscr     as bus_nm
    ,T1.pd_cd                                    --产品代码|C20
	,t2.pd_nm                                    --产品名称|C256
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
    ,t1.trx_sts_cd
	,t2.pd_found_dt                              --产品成立日期|C8
	,t2.pd_end_dt                                --产品结束日期|C8
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI     T1 --理财交易确认流水明细
INNER JOIN edw.dim_bus_chm_pd_inf_dd    t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
and (t2.pd_nm REGEXP '挂钩' or (t2.ta_cd <> 'TL' and t2.pd_nm REGEXP '钱潮'))  --挂钩型理财新口径
and t2.pd_sts_cd<>'3'              --发行失败
INner join(
    SELECT DISTINCT col_8 as cst_id
    from SJXQ_SJ2025070316_CST_01
)t3 on t1.cst_id=t3.cst_id
left join edw.dwd_code_library_dd       c1
on t1.bus_cd=c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where T1.DT<='@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8)>='20250101'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025070316_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070316_CST_04 AS
select replace(t1.trx_dt,'-','') trx_dt       --交易日期
	,t1.cst_id                                   --客户号
	,t1.insu_hld_nm                              --投保人姓名
	,t1.prod_cd                                  --产品代码
	,t1.prod_nm                                  --产品名称
	,t1.insu_ord_nbr                             --投保单号
	,t1.insu_plcy_id                             --保单号
	,t1.insu_plcy_sts                            --保单状态
	,t1.cur_insu_plcy_sts_nm                     --新保单状态
	,t1.insu_amt                                 --保额
	,t1.frs_trm_insu_fee                         --首期保费
	,t1.mng_cnv_insu_fee  as trx_amt             --管护折算保费
	,t1.mng_cnv_cmsn_fee                         --管护折算手续费
	,t1.mng_cnv_nbr_num                          --管护折算件数
	,t1.mng_mgr_id                               --管护客户经理工号
	,t1.mng_mgr_nm                               --管护客户经理姓名
	,t1.mng_rto                                  --管护比例
	,t1.mng_org_id                               --管护机构号
	,t1.mng_org_nm                               --管护机构名称
	,t1.trx_chnl                                 --交易渠道
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.trx_sts                                  --交易状态
	,t1.stl_sts_cd                               --保司结算状态
    ,decode(t1.stl_sts_cd,'0','待确认' ,'1','待结算' ,'2','不可结算' ,'3','可结算' ,'4','已结算') as stl_sts_nm  --结算状态
FROM    app_rpt.fct_insu_agn_bus_acs_dtl_tbl t1 --保险代销业务考核明细表
INner join(
    SELECT DISTINCT col_2 as cst_id
    from SJXQ_SJ2025070316_CST_02
)t3 on t1.cst_id=t3.cst_id
WHERE   t1.DT = '@@{yyyyMMdd}'
AND     replace(t1.trx_dt,'-','') <= '@@{yyyyMMdd}'
and     replace(t1.trx_dt,'-','') >= '20250101'
AND     t1.insu_plcy_sts = '新保投保' --保单状态 '正常','退保','满期退保'
AND     t1.cur_insu_plcy_sts_nm = '已生效'
;
-- 1年以上定期存款到期
DROP   TABLE IF     EXISTS SJXQ_SJ2025070316_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070316_CST_05 AS
SELECT dep_act_id                               --存款账号|C32
	,cst_act_id                               --客户账号|C32
	,cst_id                                   --客户号|C20
	,act_nm                                   --账户名称|C300
	,act_afl_org                              --核算机构编号
	,dep_trm                                  --存期|C6
	,int_val_dt                               --起息日期|C8
	,mtu_dt                                   --到期日期|C8
	,opn_amt                                  --开户金额
    ,gl_bal                                   --账户总账余额
FROM    EDW.DWS_BUS_DEP_ACT_INF_DD		--存款账户信息表
WHERE   DT='@@{yyyyMMdd}'
AND     LBL_PROD_TYP_CD<>'0' --存款产品类型代码 0:活期 1:定期 非活期外的存款
AND     MTU_DT>='20250101' AND MTU_DT<='20250630'   --25年到期定存
and cst_Id in (
    Select col_8 from SJXQ_SJ2025070316_CST_01
    union
    Select col_2 from SJXQ_SJ2025070316_CST_01
)
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025070316_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025070316_CST_06 AS
SELECT t1.dep_act_id                              as 存款账号
	,t1.cst_act_id                              as 客户账号
	,t1.cst_id                                  as 客户号
	,t1.act_nm                                  as 账户名称
	,t4.org_nm  as 核算机构
	,t1.dep_trm                                 as 存期
	,t1.int_val_dt                              as 起息日期
	,t1.mtu_dt                                  as 到期日期
	,t1.opn_amt                                 as 开户金额
    ,t1.gl_bal                                  as 账户余额_20250706
    ,t2.trx_amt     as 疑似转入挂钩理财金额
    ,t2.trx_dt      as 疑似转入挂钩理财日期
    ,null   as 疑似转入保险金额
    ,null   as 疑似转入保险日期
from SJXQ_SJ2025070316_CST_05               t1
INNER JOIN (
    Select col_8 as cst_id,trx_dt,sum(col_18) as trx_amt
    from SJXQ_SJ2025070316_CST_01
    GROUP BY col_8,trx_dt
)t2 on t1.cst_id=t2.cst_id
and DATEDIFF(TO_DATE(t2.trx_dt,'yyyyMMdd'),TO_DATE(t1.mtu_dt,'yyyyMMdd'),'dd') between 0 and 30
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.act_afl_org = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.opn_amt>t1.gl_bal
union all
SELECT t1.dep_act_id                              as 存款账号
	,t1.cst_act_id                              as 客户账号
	,t1.cst_id                                  as 客户号
	,t1.act_nm                                  as 账户名称
	,t4.org_nm  as 核算机构
	,t1.dep_trm                                 as 存期
	,t1.int_val_dt                              as 起息日期
	,t1.mtu_dt                                  as 到期日期
	,t1.opn_amt                                 as 开户金额
    ,t1.gl_bal                                  as 账户余额_20250706
    ,null,null
    ,t2.trx_amt,t2.trx_dt
from SJXQ_SJ2025070316_CST_05               t1
INNER JOIN (
    Select cst_id,trx_dt,sum(trx_amt) as trx_amt
    from SJXQ_SJ2025070316_CST_04
    GROUP BY cst_id,trx_dt
)t2 on t1.cst_id=t2.cst_id
and DATEDIFF(TO_DATE(t2.trx_dt,'yyyyMMdd'),TO_DATE(t1.mtu_dt,'yyyyMMdd'),'dd') between 0 and 30
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.act_afl_org = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.opn_amt>t1.gl_bal
;
SElECT '01' seq, count(1) cnt,count(distinct col_8) custs
from SJXQ_SJ2025070316_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2025070316_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070316_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070316_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025070316_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025070316_CST_06
;
/*
01	1515	1237
02	512	478
03	1510	1237
04	512	478
05	384	238
06	160	114
*/
SElECT '06' seq, *
from SJXQ_SJ2025070316_CST_06
***金麟_SJ2025021481_湖州分行预评估及他行余额.sql
﻿-- 湖州分行信贷客户最近预评估结果及他行余额
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ2025021481_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021481_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
	,t3.pre_ases_serno
    ,case when t3.rul_set_rslt_nm regexp '抗辩' then '是' else '否' end as 预评估是否发起抗辩
    ,t3.rul_set_rslt_nm     --预评估结果
	,t3.sys_reg_tm
    ,row_number() over(partition by t1.cst_id order by t1.ctr_bgn_dt desc,t1.ctr_serno desc) rn
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
LEFT JOIN
(
	SELECT A1.usc_aply_serno
	FROM edw.dwd_bus_loan_lmt_aply_rel_ases_dd A1 --授信关联预评估信息表
	LEFT JOIN edw.dwd_code_library_dd c1 -- 码值表
	ON A1.rul_set_rslt_cd = c1.cd_val
    AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND c1.fld_nm = 'RUL_SET_RSLT_CD'
    AND c1.DT = '@@{yyyyMMdd}'
	WHERE A1.dt = '@@{yyyyMMdd}'
    group by A1.usc_aply_serno
) T3 ON T1.rel_serno = T3.usc_aply_serno
where t1.dt='@@{yyyyMMdd}'
and t1.mgr_org_id like '3310%' --湖州分行
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025021481_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021481_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '@@{yyyyMMdd}'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
--个人征信贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2025021481_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021481_CST_03 AS
SELECT  t1.cst_id
    ,t1.report_no
    ,t1.report_dt                --报告日期
    ,t1.oth_bank_loan_org_num    --他行贷款授信机构数
    ,t1.oth_bank_loan_credit_bal --他行贷款授信余额
    ,t2.他行贷款机构家数
    ,t2.他行贷款余额
from edw.dws_cst_ccrc_idv_ind_inf_dd  t1 --个人征信指标信息表
left join(
    SELECT  t1.report_id
        ,COUNT(DISTINCT CASE WHEN t1.dtrb_org <> 'ZJTLCB' AND t1.act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN t1.dtrb_org END) AS 他行贷款机构家数
        ,SUM(CASE WHEN t1.dtrb_org <> 'ZJTLCB' AND t1.act_typ_cd IN ( 'D1' ,'R1' ,'R4' ) THEN t1.ctr_bal END)             AS 他行贷款余额
    FROM edw.dim_cst_ccrc_idv_loan_inf_dd       t1 --个人征信客户贷款信息
    WHERE t1.DT = '@@{yyyyMMdd}'
    AND t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
    GROUP BY t1.report_id
)t2 on t2.report_id=t1.report_no
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025021481_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025021481_CST_04 AS
SELECT  t1.ctr_serno                       AS 合同流水号
       ,t1.cst_id                          AS 客户号
       ,t1.cst_nm                          AS 客户名称
       ,t1.ctr_amt                         AS 合同金额
       ,t1.ctr_bgn_dt                      AS 合同起始日期
       ,t1.ctr_mtu_dt                      AS 合同到期日期
       ,t1.PD_NM                           AS 产品名称
       ,t2.PRE_ASES_SERNO                  AS 最新预评估流水号
       ,t2.rul_set_rslt_nm                 AS 最新预评估结果
       ,t2.sys_reg_tm                      AS 最新预评估系统登记时间
	   ,t1.pre_ases_serno 		as 合同预评估流水号
	   ,t1.rul_set_rslt_nm 		as 合同预评估结果
	   ,t1.sys_reg_tm 			as 合同预评估系统登记时间
       ,t1.预评估是否发起抗辩
       ,t3.report_dt                       AS 最新征信报告日期
       ,nvl(t3.oth_bank_loan_org_num ,0)   AS 他行贷款授信机构数
       ,nvl(t3.oth_bank_loan_credit_bal,0) AS 他行贷款授信余额
from SJXQ_SJ2025021481_CST_01 t1
left join SJXQ_SJ2025021481_CST_02 t2
on t1.CST_ID=t2.CST_ID
left join SJXQ_SJ2025021481_CST_03 t3
on t1.CST_ID=t3.CST_ID
where t1.rn=1
;
select *
from SJXQ_SJ2025021481_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025021481_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025021481_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025021481_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025021481_CST_04
;
/*
01	176478	176478
02	5646397	5646397
03	5786486	5786486
04	49724	49724
*/***钟佩琪_SJ2025030606_24年职能营销数据.sql
﻿/* 数据需求： 1.范围：24年在总行就职过人员 2.时间：挂靠在24年在总行就职过人员名下24年1月1号后新开户的账户
3.数据需求：此类账户在24年全年产生的存款营收、财富营收、国业营收，以及各业务下各类产品的月日均规模、营收。
存款：个人活期存款、个人低于1年定期、个人一年定期、个人两年定期、个人三年定期、个人五年定期、个人大额存单
单位活期存款、单位低于1年定期、单位一年定期、单位两年定期、单位三年定期、单位五年定期、单位大额存单
财富：自营理财、代销理财、保险、基金、贵金属
*/
-- 24年在总行就职过人员
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_01 AS
SELECT t1.*
from(
    SELECT t1.empe_id,t1.empe_nm
        ,t1.org_id,t1.org_nm,t1.dt
        ,ROW_NUMBER() over(partition by t1.empe_id order by t1.dt desc) rn
        ,t2.brc_org_id
    from edw.dws_hr_empe_inf_dd                 t1 --员工信息汇总
    INNER JOIN edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
    on t1.org_id=t2.org_id
    and t2.dt=t1.dt
    and t2.brc_org_nm = '浙江泰隆商业银行总行'
    WHERE t1.dt BETWEEN '20240101' AND '20241231'
)t1 where t1.rn=1
;
-- 24年1月1号后新开户的账户
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_02 AS
SELECT a.cst_id        --客户号
    ,a.cst_act_id    --客户账号
    ,a.dep_act_id    --存款账号
    ,a.act_sts_cd    --账户状态代码
    ,a.opn_dt        --开户日期
    ,a.opn_amt	--	开户金额
    ,a.cur_act_bal	--	当前账户余额
    ,a.gl_bal	--	总账余额
    ,decode(a.lbl_prod_typ_cd,'0','活期','1','定期','')	as prod_typ_nm --负债产品类型代码
    ,a.dep_trm	--	存期|C6
        when a.lbl_prod_typ_cd='0' then '1 活期'
        else '' end as pd_cls --产品种类
        ,a.prod_id
        ,d.pd_cmt	--	产品说明|c200
        ,b.gl_bal	as gl_bal2 --总账余额
    ,b.acs_org_id	--	考核机构编号
    ,b.mgr_id
    ,b.mgr_rto       --管护比例
    ,row_number() over(partition by a.dep_act_id order by b.mgr_rto desc) rn
FROM EDW.DIM_BUS_DEP_ACT_INF_DD             A
INNER JOIN EDW.DWS_BUS_DEP_ACT_MGR_INF_DD   B
ON B.DEP_ACT_ID = A.DEP_ACT_ID
AND B.DT = a.dt
INNER JOIN SJXQ_SJ2025030606_CST_01         C
ON b.mgr_id = c.empe_id
left join edw.dim_bus_dep_pd_bas_inf_dd	    d    --存款产品基础信息表
on a.prod_id=d.pd_id
and d.dt = a.dt
WHERE a.dt = '20241231'
AND a.opn_dt >= '20240101'
;
-- 存款FTP
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_03 AS
select t1.cst_id,t1.cst_act_id,t1.pd_cls
    ,sum(avg_bal         ) as avg_bal           --日均余额
    ,sum(ftp_profit_final) as ftp_profit_final  --调节后FTP利润
from SJXQ_SJ2025030606_CST_02 t1
left join(
    select account_no
        ,sum(avg_bal         ) as avg_bal           --日均余额
        ,sum(ftp_profit_final) as ftp_profit_final  --调节后FTP利润
    from app_iftp.adm_papp_ftp_eva_rpt_fact_ftp_cst_a14 t1 --EVA-FTP账户明细查询
    where dt = '20241231'
    AND t1.flag = 'Y'
    group by account_no
)t2 on t2.account_no=t1.dep_act_id
where t1.rn=1
group by t1.cst_id,t1.cst_act_id,t1.pd_cls
;
--自营理财中收
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_04 AS
SELECT t1.cst_id,t1.cst_act_id
    -- ,t1.acs_org_id	--	考核机构编号
    -- ,t1.mgr_id	--	管护人编号
    ,t2.AGN_IND
    ,t2.lc_ftp
    ,t2.lc_mon_avg,t2.lc_year_avg
from(
    SELECT DISTINCT cst_id,cst_act_id
    from SJXQ_SJ2025030606_CST_02
)t1 INNER join(
    SELECT AGN_IND,bnk_act_id
        ,SUM(COALESCE(MID_AMT, 0))    as lc_ftp
        ,sum(case when dt>='20241201' then cur_fnc_amt else 0 end)/31 as lc_mon_avg --理财金额余额
        ,sum(cur_fnc_amt)/365 as lc_year_avg --理财金额余额
    from EDW.DWS_BUS_CHM_ACT_MGR_INF_DD
    where DT BETWEEN '20240101' AND '20241231'
    and MNG_TYP_CD = '1' --管户类型：1考核 2销售
    -- AND     AGN_IND = '0' --代销标志：0自营 1代销
    AND     PD_TP_CD = '1' --理财类型：0基金 1理财
    GROUP BY AGN_IND,bnk_act_id
) t2 --理财考核汇总信息表
on t1.cst_act_id=t2.bnk_act_id
;
--基金中收
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_05 AS
SELECT t1.cst_id,t1.cst_act_id
    ,sum(t2.mid_clc_smy_amt) fund_MID_INCM       --中收合计金额
    ,sum(case when dt>='20241201' then t2.cty_val_amt else 0 end)/31 as fund_mon_avg
    ,sum(t2.cty_val_amt)/365 as fund_year_avg --市值金额
from(
    SELECT DISTINCT cst_id,cst_act_id
    from SJXQ_SJ2025030606_CST_02
)t1
inner join adm_pub_app.ADM_PBLC_LBL_FND_ACT_MGR_INF_DI t2 --基金账户考核汇总信息
on t1.cst_id=t2.cst_id
and t1.cst_act_id=t2.stl_act_id
and t2.DT BETWEEN '20240101' AND '20241231'
AND t2.DAT_DT BETWEEN '20240101' AND '20241231'
AND t2.MGR_TYP_CD = '2' -- 2-管户人 3-顾问 4-推荐人 5-无
group by t1.cst_id,t1.cst_act_id
;
--贵金属中收
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_06 AS
SELECT t1.cst_id,t1.cst_act_id
    ,sum(MID_INC_TOT_AMT) GOD_MID_INCM     --当年中收
    ,sum(case when dt>='20241201' then CMDT_PAY_UNT_PRC else 0 end)/31 as god_mon_avg
    ,sum(CMDT_PAY_UNT_PRC)/365 as god_year_avg
from(
    SELECT DISTINCT cst_id,cst_act_id
    from SJXQ_SJ2025030606_CST_02
)t1 inner join adm_pub.adm_pub_cst_nob_met_trx_dtl_di t2 --贵金属交易明细表
on t1.cst_id=t2.cst_id
and t1.cst_act_id=t2.acct_id
and t2.dt BETWEEN '20240101' AND '20241231'
AND t2.CMDT_PAY_UNT_PRC<>0 			--存在未付钱且有中收，需剔除
group by t1.cst_id,t1.cst_act_id
;
SELECT *
from adm_pub.adm_pub_cst_nob_met_trx_dtl_di
where dt BETWEEN '20240101' AND '20241231'
and cst_id='1622883307'
-- 保险中收
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_07 AS
select t1.cst_id,t1.cst_act_id
    ,sum(mng_cnv_cmsn_fee) INS_MID_INCM        --管护折算手续费
    ,sum(case when dt>='20241201' then MNG_CNV_INSU_FEE else 0 end)/31 as INS_mon_avg
    ,sum(MNG_CNV_INSU_FEE)/365 as INS_year_avg
from(
    SELECT DISTINCT cst_id,cst_act_id
    from SJXQ_SJ2025030606_CST_02
)t1 inner join app_rpt.fct_insu_agn_bus_acs_dtl_tbl   t2 --保险代销业务考核明细表
on t1.cst_id=t2.cst_id
and t1.cst_act_id=t2.cst_act_nbr
and t2.dt='@@{yyyyMMdd}'
AND replace(t2.TRX_DT,'-','') BETWEEN '20240101' AND '20241231'
AND t2.cur_insu_plcy_sts_nm<>'已失效'   --已失效 已生效 已终止 待生效
group by t1.cst_id,t1.cst_act_id
;
--结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_08 AS
select t1.cst_id,t1.cst_act_id
    ,t1.hq_avg_bal ,t1.l1y_avg_bal ,t1.1y_avg_bal ,t1.2y_avg_bal ,t1.3y_avg_bal
    ,t1.5y_avg_bal ,t1.decd_avg_bal
    ,t1.hq_ftp_profit_final ,t1.l1y_ftp_profit_final ,t1.1y_ftp_profit_final ,t1.2y_ftp_profit_final
    ,t1.3y_ftp_profit_final ,t1.5y_ftp_profit_final ,t1.decd_ftp_profit_final
    ,t2.zy_lc_ftp ,t2.zy_lc_mon_avg ,t2.zy_lc_year_avg
    ,t2.dx_lc_ftp ,t2.dx_lc_mon_avg ,t2.dx_lc_year_avg
    ,t4.fund_MID_INCM ,t4.fund_mon_avg ,t4.fund_year_avg
    ,t5.GOD_MID_INCM ,t5.god_mon_avg ,t5.god_year_avg
    ,t6.INS_MID_INCM ,t6.INS_mon_avg ,t6.INS_year_avg
from(
    SELECT t1.cst_id,t1.cst_act_id
        ,sum(case when pd_cls='1 活期'        then avg_bal else 0 end) as hq_avg_bal
        ,sum(case when pd_cls='2 低于1年定期' then avg_bal else 0 end) as l1y_avg_bal
        ,sum(case when pd_cls='3 1年定期'     then avg_bal else 0 end) as 1y_avg_bal
        ,sum(case when pd_cls='4 2年定期'     then avg_bal else 0 end) as 2y_avg_bal
        ,sum(case when pd_cls='5 3年定期'     then avg_bal else 0 end) as 3y_avg_bal
        ,sum(case when pd_cls='6 5年定期'     then avg_bal else 0 end) as 5y_avg_bal
        ,sum(case when pd_cls='7 大额存单'    then avg_bal else 0 end) as decd_avg_bal
        ,sum(case when pd_cls='1 活期'        then ftp_profit_final else 0 end) as hq_ftp_profit_final
        ,sum(case when pd_cls='2 低于1年定期' then ftp_profit_final else 0 end) as l1y_ftp_profit_final
        ,sum(case when pd_cls='3 1年定期'     then ftp_profit_final else 0 end) as 1y_ftp_profit_final
        ,sum(case when pd_cls='4 2年定期'     then ftp_profit_final else 0 end) as 2y_ftp_profit_final
        ,sum(case when pd_cls='5 3年定期'     then ftp_profit_final else 0 end) as 3y_ftp_profit_final
        ,sum(case when pd_cls='6 5年定期'     then ftp_profit_final else 0 end) as 5y_ftp_profit_final
        ,sum(case when pd_cls='7 大额存单'    then ftp_profit_final else 0 end) as decd_ftp_profit_final
    from SJXQ_SJ2025030606_CST_03 t1
    group by t1.cst_id,t1.cst_act_id
)t1 left join (
    select cst_act_id
        ,sum(case when AGN_IND = '0' then lc_ftp      else 0 end) as zy_lc_ftp
        ,sum(case when AGN_IND = '0' then lc_mon_avg  else 0 end) as zy_lc_mon_avg
        ,sum(case when AGN_IND = '0' then lc_year_avg else 0 end) as zy_lc_year_avg
        ,sum(case when AGN_IND = '1' then lc_ftp      else 0 end) as dx_lc_ftp
        ,sum(case when AGN_IND = '1' then lc_mon_avg  else 0 end) as dx_lc_mon_avg
        ,sum(case when AGN_IND = '1' then lc_year_avg else 0 end) as dx_lc_year_avg
    from SJXQ_SJ2025030606_CST_04
    GROUP BY cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
left join SJXQ_SJ2025030606_CST_05 t4 on t1.cst_act_id=t4.cst_act_id
left join SJXQ_SJ2025030606_CST_06 t5 on t1.cst_act_id=t5.cst_act_id
left join SJXQ_SJ2025030606_CST_07 t6 on t1.cst_act_id=t6.cst_act_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_09 AS
SELECT  t1.cst_id                     AS 客户号
       ,t1.cst_act_id                 AS 客户账号
       ,t1.hq_avg_bal                 AS 活期存款月日均
       ,t1.hq_ftp_profit_final        AS 活期存款24年营收
       ,t1.l1y_avg_bal                AS 低于1年定期月日均
       ,t1.l1y_ftp_profit_final       AS 低于1年定期24年营收
       ,t1.1y_avg_bal                 AS 一年定期月日均
       ,t1.1y_ftp_profit_final        AS 一年定期24年营收
       ,t1.2y_avg_bal                 AS 两年定期月日均
       ,t1.2y_ftp_profit_final        AS 两年定期24年营收
       ,t1.3y_avg_bal                 AS 三年定期月日均
       ,t1.3y_ftp_profit_final        AS 三年定期24年营收
       ,t1.5y_avg_bal                 AS 五年定期月日均
       ,t1.5y_ftp_profit_final        AS 五年定期24年营收
       ,t1.decd_avg_bal               AS 大额存单月日均
       ,t1.decd_ftp_profit_final      AS 大额存单24年营收
       ,t1.zy_lc_mon_avg              AS 自营理财月日均
       ,t1.zy_lc_year_avg             AS 自营理财年日均
       ,t1.zy_lc_ftp                  AS 自营理财24年营收
       ,t1.dx_lc_mon_avg              AS 代销理财月日均
       ,t1.dx_lc_year_avg             AS 代销理财年日均
       ,t1.dx_lc_ftp                  AS 代销理财24年营收
       ,t1.fund_mon_avg               AS 基金月日均
       ,t1.fund_year_avg              AS 基金年日均
       ,t1.fund_MID_INCM              AS 基金24年营收
       ,t1.god_mon_avg                AS 贵金属月日均
       ,t1.god_year_avg               AS 贵金属年日均
        -- ,t5.nob_met_mon_avg_acml	--	贵金属余额月日均
        -- ,t5.nob_met_year_avg_acml	--	贵金属余额年日均
       ,t1.GOD_MID_INCM               AS 贵金属24年营收
       ,t1.INS_mon_avg                AS 保险月日均
       ,t1.INS_year_avg               AS 保险年日均
       ,t1.INS_MID_INCM               AS 保险24年营收
       ,t2.dep_ftp_cur_year_acm       AS 客户24年存款FTP营收
       ,t3.whth_fee_cur_year          AS 客户24年财富手续费收入
       ,t4.inter_bus_inc_cur_year_acm AS 客户24年国际业务收入
from SJXQ_SJ2025030606_CST_08               t1
left join app_ado.adm_subl_cst_bus_inf_dd	t2 --实验室应用层资产-客户业务信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20241231'
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt='20241231'
left join adm_pub.adm_csm_cbus_inter_bus_val_inf_dd     t4 --客户集市-业务信息-客户价值信息-国际业务价值信息
on t1.cst_id=t4.cst_id
and t4.dt='20241231'
left join adm_pub.adm_csm_cbus_wlth_nob_met_bus_inf_dd  t5 --客户集市-业务信息-财富-贵金属-业务信息
on t1.cst_id=t5.cst_id
and t5.dt='20241231'
;
select *
from SJXQ_SJ2025030606_CST_09
;
SElECT '01' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ2025030606_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025030606_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025030606_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_act_id,agn_ind) custs
from SJXQ_SJ2025030606_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025030606_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025030606_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025030606_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025030606_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025030606_CST_09
;
/*
01	2702	2702
02	16433	10897
03	11925	10897
04	1519	1519
05	214	214
06	70	70
07	36	36
08	10897	10897
09	10897	10897
-- 存款账户管户中收
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_03 AS
SELECT  t1.core_product_id  --产品编码
    ,t1.product_name     --产品名称
    ,t1.cif_key          --客户号
    ,t1.cif_name         --客户名称
    ,t1.cif_manager
    ,t1.cif_manager_name
    ,t1.account_no       --账号
    ,t1.start_dt         --起息日
    ,t1.maturity_dt      --到期日
    ,t1.avg_bal          --日均余额
    ,t1.ftp_profit_final --调节后FTP利润
    ,t1.flag             --频率
    ,t2.dep_act_id
    ,t2.prod_id
    ,t2.pd_cmt	        --产品说明|c200
    ,t2.cst_id          --客户号
    ,t2.cst_act_id      --客户账号
    ,t2.acs_org_id
    ,t2.mgr_id
    ,t2.mgr_rto
from SJXQ_SJ2025030606_CST_02       t2
left join app_iftp.adm_papp_ftp_eva_rpt_fact_ftp_cst_a14 t1 --EVA-FTP账户明细查询
on t1.account_no=t2.dep_act_id
and t1.org_unit_id=t2.acs_org_id
and t1.cif_manager=t2.mgr_id
and t1.dt = '20241231'
AND t1.flag = 'Y'
;
--基金中收
DROP   TABLE IF     EXISTS SJXQ_SJ2025030606_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030606_CST_05 AS
SELECT t1.cst_id,t1.cst_act_id
    ,sum(tot_mid_inc)   FUD_MID_INCM    --中收合计(认购费+申购费+管理费分成+销售服务费)
from(
    SELECT DISTINCT cst_id,cst_act_id
    from SJXQ_SJ2025030606_CST_02
)t1
inner join edw.dwd_bus_chm_fnd_mid_inc_fee_dtl_di t2
on t1.cst_id=t2.cst_id
and t1.cst_act_id=t2.stl_act_id
and t2.dt BETWEEN '20240101' AND '20241231'
group by t1.cst_id,t1.cst_act_id
;
*/
***陆奇_SJ20250429126_垫款合同数据治理.sql
﻿/*
截至最新时间节点，合同状态为生效或者冻结的垫款合同，且关联的担保合同与担保方式不一致的合同清单。
数据需求字段
垫款合同流水号、客户号、垫款合同状态、垫款合同金额、垫款合同余额、垫款合同担保方式、垫款合同管护机构、垫款合同管护人、
原合同流水号、原合同担保方式、原合同关联的担保合同、原合同关联的担保合同状态、原合同关联的担保合同金额、原合同关联的担保合同类型、
原合同关联的担保合同最高可担保金额、原合同关联的担保合同剩余可担保金额
1. 担保合同与担保方式不一致?
2. 垫款合同,原合同?
3. 剩余可担保金额
*/
--垫款合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,decode(t1.CTR_STS_CD,'2','已生效','4','冻结') as CTR_STS_nm --合同状态
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t1.grnt_mod_colc	    --担保方式集合|c200
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
and t1.CTR_STS_CD IN ( '2' , '4' )  --1:未生效|2:已生效|3:终止|4:冻结|5:作废
;
-- 担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_02 AS
SELECT  a.ctr_serno
       ,a.grnt_mod_colc
FROM
(
	SELECT  ctr_serno
	       ,grnt_mod_colc
	       ,grnt_mod_colc2
	FROM SJXQ_SJ20250429126_CST_01 LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.ctr_serno
         ,a.grnt_mod_colc
;
-- 关联的担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_03 AS
select t1.ctr_serno
    ,t1.grnt_mod_colc
    ,t4.grnt_mod_colc_nm
    ,t2.grnt_ctr_no
	,t2.busi_typ_cd                              --业务类型代码1贷款业务2信用卡业务|c1
	,t2.eff_sts_cd                               --生效状态代码|c1
	,t3.grnt_mod_cd                              --担保方式代码|c3
    ,c2.cd_val_dscr     as grnt_mod_nm      --担保合同担保方式
	,t3.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
	,t3.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,c1.cd_val_dscr     as grnt_ctr_sts_nm  --担保合同状态
    ,t3.grnt_ctr_amt                             --担保合同金额|decimal
    ,t3.grnt_ctr_typ_cd                          --担保合同类型代码|c3
    ,c3.cd_val_dscr     as grnt_ctr_typ_nm  --担保合同类型
from SJXQ_SJ20250429126_CST_01              t1
left join edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_grnt_inf_dd  t3 --担保合同信息
on t2.grnt_ctr_no=t3.grnt_ctr_no
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20250429126_CST_02         t4
on t1.ctr_serno=t4.ctr_serno
LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
ON      t3.GRNT_CTR_STS_CD = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     c1.fld_nm = 'GRNT_CTR_STS_CD'
AND     c1.DT = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       c2
on t3.GRNT_MOD_CD =  c2.cd_val
and c2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       c3
on t3.grnt_ctr_typ_cd =  c3.cd_val
and c3.dt='@@{yyyyMMdd}'
;
--垫款合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_04 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t1.grnt_mod_colc	    --担保方式集合|c200
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
    ,t5.ctr_serno   as dk_ctr_serno
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = t1.dt
inner join SJXQ_SJ20250429126_CST_03    t5
on t1.ctr_serno = substr(t5.ctr_serno,3)    --原合同
and t5.ctr_serno like 'DK%'
and t5.grnt_ctr_no is null
where t1.dt='@@{yyyyMMdd}'
;
-- 担保方式集合
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_05 AS
SELECT  a.ctr_serno
       ,a.grnt_mod_colc
FROM
(
	SELECT  ctr_serno
	       ,grnt_mod_colc
	       ,grnt_mod_colc2
	FROM SJXQ_SJ20250429126_CST_04 LATERAL VIEW explode(split(grnt_mod_colc, ',')) tmp as grnt_mod_colc2
	WHERE nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.ctr_serno
         ,a.grnt_mod_colc
;
-- 关联的担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_06 AS
select t1.ctr_serno
    ,t1.grnt_mod_colc
    ,t4.grnt_mod_colc_nm
    ,t2.grnt_ctr_no
	,t2.busi_typ_cd                              --业务类型代码1贷款业务2信用卡业务|c1
	,t2.eff_sts_cd                               --生效状态代码|c1
	,t3.grnt_mod_cd                              --担保方式代码|c3
    ,c2.cd_val_dscr     as grnt_mod_nm      --担保合同担保方式
	,t3.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
	,t3.grnt_ctr_sts_cd                          --担保合同状态代码|c1
    ,c1.cd_val_dscr     as grnt_ctr_sts_nm  --担保合同状态
    ,t3.grnt_ctr_amt                             --担保合同金额|decimal
    ,t3.grnt_ctr_typ_cd                          --担保合同类型代码|c3
    ,c3.cd_val_dscr     as grnt_ctr_typ_nm  --担保合同类型
from SJXQ_SJ20250429126_CST_04              t1
left join edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_grnt_inf_dd  t3 --担保合同信息
on t2.grnt_ctr_no=t3.grnt_ctr_no
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20250429126_CST_05         t4
on t1.ctr_serno=t4.ctr_serno
LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
ON      t3.GRNT_CTR_STS_CD = c1.cd_val
AND     c1.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     c1.fld_nm = 'GRNT_CTR_STS_CD'
AND     c1.DT = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       c2
on t3.GRNT_MOD_CD =  c2.cd_val
and c2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       c3
on t3.grnt_ctr_typ_cd =  c3.cd_val
and c3.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250429126_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250429126_CST_07 AS
SELECT  t1.ctr_serno              AS 垫款合同流水号
       ,t1.CTR_STS_nm             AS 垫款合同状态
       ,t1.cst_id                 AS 客户号
       ,t1.ctr_amt                AS 垫款合同金额
       ,t1.ctr_bal                AS 垫款合同余额
       ,t2.grnt_mod_colc_nm       AS 垫款合同担保方式集合
       ,t1.org_nm                 AS 垫款合同管护机构
       ,t1.mgr_nm                 AS 垫款合同管护人
       ,t2.grnt_mod_nm            AS 垫款合同的担保合同担保方式
       ,t2.grnt_ctr_sts_nm        AS 垫款合同的担保合同状态
       ,t2.grnt_ctr_typ_nm        AS 垫款合同的担保合同类型
       ,t3.ctr_serno              AS 原合同流水号
       ,t4.grnt_mod_colc_nm       AS 原合同担保方式集合
       ,t4.grnt_ctr_no            AS 原合同的担保合同编号
       ,t4.grnt_ctr_sts_nm        AS 原合同的担保合同状态
       ,t4.grnt_ctr_amt           AS 原合同的担保合同金额
       ,t4.grnt_ctr_typ_nm        AS 原合同的担保合同类型
       ,t4.cltr_hgst_can_grnt_amt AS 原合同的押品最高可担保金额
       ,t3.ctr_amt                AS 原合同金额
       ,t4.grnt_mod_nm            AS 原合同的担保合同担保方式
from SJXQ_SJ20250429126_CST_01      t1
left join SJXQ_SJ20250429126_CST_03 t2
on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20250429126_CST_04 t3
on t1.ctr_serno=t3.dk_ctr_serno
left join SJXQ_SJ20250429126_CST_06 t4
on t3.ctr_serno=t4.ctr_serno
where t2.grnt_ctr_no is null    --不一致 9个合同 存在多个担保合同，核对无误 代码如下
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250429126_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250429126_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250429126_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250429126_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250429126_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250429126_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 垫款合同流水号) custs
from SJXQ_SJ20250429126_CST_07
;
/*
01	507	507
02	507	507
03	531	507
04	339	339
05	339	339
06	379	339
07	381	341
SELECT  t1.ctr_serno              AS 垫款合同流水号
       ,t1.CTR_STS_nm             AS 垫款合同状态
       ,t1.cst_id                 AS 客户号
       ,t1.ctr_amt                AS 垫款合同金额
       ,t1.ctr_bal                AS 垫款合同余额
       ,t2.grnt_mod_colc_nm       AS 垫款合同担保方式集合
       ,t1.org_nm                 AS 垫款合同管护机构
       ,t1.mgr_nm                 AS 垫款合同管护人
       ,t2.grnt_mod_nm            AS 垫款合同的担保合同担保方式
       ,t2.grnt_ctr_sts_nm        AS 垫款合同的担保合同状态
       ,t2.grnt_ctr_typ_nm        AS 垫款合同的担保合同类型
from SJXQ_SJ20250429126_CST_01      t1
left join SJXQ_SJ20250429126_CST_03 t2
on t1.ctr_serno=t2.ctr_serno
where t2.grnt_mod_colc_nm<>t2.grnt_mod_nm
GROUP BY t1.ctr_serno
;
*/
SElECT '07' seq, *
from lab_bigdata_dev.SJXQ_SJ20250429126_CST_07
***陈哲渊_SJ2025040816_存单提前支取客户清单.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 于彪
-- 创建日期: 2025-04-09 15:31:41
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 2月14日-2月21日舟山金塘小微企业专营支行存单未到期提前支取客户清单（个人整存整取客户）
DROP   TABLE IF     EXISTS SJXQ_SJ2025040816_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040816_CST_01 AS
select T1.dep_act_id                               --存款账号|C8
	,T1.cst_act_id                               --客户账号|C32
	,T1.cst_id                                   --客户号|C20
	,T1.prod_id                                  --产品编号|C24
    ,t5.pd_cmt
	,T1.dep_cls_cd                               --存款种类代码|C4
    ,c2.cd_val_dscr     as 存款种类
	,T1.act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     as 账户状态
	,T1.dep_trm                                  --存期|C6
	,T1.mtu_dt                                   --到期日期|C8
	,T1.opn_dt                                   --开户日期|C8
	,T1.opn_amt                                  --开户金额|DECIMAL(20,2)
	,T1.act_dstr_act_dt                          --账户销户日期|C8
	,T1.cur_act_bal                              --当前账户余额|DECIMAL(20,2)
	,T1.gl_bal                                   --总账余额|DECIMAL(20,2)
    ,decode(t1.lbl_prod_typ_cd,'0','活期','1','定期') as 存款产品类型
	,T1.act_ctg_cd_1                             --账户分类代码1|C32
	,T1.act_ctg_cd_2                             --账户分类代码2|C32
	,T1.act_ctg_cd_3                             --账户分类代码3|C110
	,t4.mgr_id                                   --管护人编号|C200
    ,t2.empe_nm     as 管户客户经理名称
	,t4.acs_org_id                               --考核机构编号|C12
    ,t3.org_nm      as 管户机构名称
from edw.dim_bus_dep_act_inf_dd       t1         --存款账户信息
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T4
ON      T1.cst_act_id = T4.cst_act_id
AND     T4.dt = t1.dt
AND     T4.frs_ctc_ind = '1' --第一联系人标志
inner join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  t4.mgr_id=t2.empe_id
and t2.dt=t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t4.acs_org_id=t3.org_id
and t3.dt=t1.dt
and t3.sbr_org_nm = '舟山金塘小微企业专营支行'
inner join edw.dim_bus_dep_pd_bas_inf_dd	 t5       --存款产品基础信息表
on t1.prod_id=t5.pd_id
and t5.dt = t1.dt
and t5.pd_cmt regexp '存单|个人整存整取'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON t1.act_sts_cd = C1.CD_VAL
AND C1.DT = t1.dt
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON t1.dep_cls_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
where T1.dt='@@{yyyyMMdd}'
and t1.mtu_dt<>t1.act_dstr_act_dt
and T1.act_dstr_act_dt between '20250214' and '20250221'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025040816_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040816_CST_03 AS
SELECT  t1.cst_id,t1.cst_act_id
    ,t1.dep_act_id
    ,t3.dtl_seq_nbr
    ,t3.crd_and_dbt_ind	    --借贷标志|C1
    ,t3.trx_dt
    ,t3.trx_amt
	,t3.act_bal                                  --账户余额|DECIMAL(21,2)
	,t3.txt_code                                 --摘要代码|C10
	,t3.smr_dscr                                 --摘要描述|C512
	,t3.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t3.cnt_pty_sub_act_seq_nbr                  --对方子账户序号|C8
	,t3.cnt_pty_sys_act_id                       --对方系统账号|C32
	,t3.cnt_pty_act_nm                           --对方户名|c200
	,t3.cnt_pty_cst_typ_cd                       --对方客户类型代码|C2
	,t3.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t3.cnt_pty_fin_instt_typ_cd                 --对方金融机构类型代码|C2
	,t3.cnt_pty_fin_instt_cd                     --对方金融机构代码|C12
	,t3.cmt                                      --备注|C200
	,t3.prod_id                                  --产品编号|C24
    ,t3.dt
FROM SJXQ_SJ2025040816_CST_01              t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di  T3
ON  t1.dep_act_id=t3.dep_act_id
AND T3.dt >='20250214'
and t3.trx_dt >='20250214'
and t3.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040816_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040816_CST_04 AS
SELECT  T1.cst_id      AS 客户号
       ,t1.dep_act_id  AS 存单号
       ,T1.cur_act_bal AS 当前账户余额
       ,T1.gl_bal      AS 总账余额
       ,T1.dep_trm     AS 存期
       ,T1.pd_cmt      AS 产品名称
       ,T1.存款种类
       ,T1.账户状态
       ,t1.mgr_id      AS 管户客户经理工号
       ,t1.管户客户经理名称
       ,t1.管户机构名称
from SJXQ_SJ2025040816_CST_01 t1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025040816_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2025040816_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025040816_CST_04
;
SElECT '01' seq, *
from SJXQ_SJ2025040816_CST_04***陈哲渊_SJ2025061271_理财保有量.sql
﻿-- SJ2025061271
-- 截止5月31日舟山分行各支行全量理财余额保有量以及理财余额保有量较年初增量数据
-- 20250531 理财保有量
DROP   TABLE IF     EXISTS SJXQ_SJ2025061271_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061271_CST_01 AS
select t1.pd_cd                                    --产品代码|C24
	,t1.bnk_act_id                               --银行账号|C32
	,t1.cst_id                                   --客户编号|C20
	,t1.fnc_amt                                  --当前理财金额|DECIMAL(21,2)
    ,t2.opn_org_id
    ,t3.sbr_org_nm
from edw.dws_bus_chm_act_acm_inf_dd         t1 --理财账户份额汇总信息
inner join edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
ON  t1.bnk_act_id = t2.cst_act_id
AND t2.dt = t1.dt
inner JOIN edw.dim_hr_org_mng_org_tree_dd    t3 --机构树_考核维度
ON  t2.opn_org_id = t3.org_id
AND t3.dt = t1.dt
and t3.brc_org_nm = '舟山分行'
where t1.dt='20250531'
AND t1.pd_tp_cd = '1' --理财
and t1.fnc_amt<>0
;
-- 20250101 理财保有量
DROP   TABLE IF     EXISTS SJXQ_SJ2025061271_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061271_CST_02 AS
select t1.pd_cd                                    --产品代码|C24
	,t1.bnk_act_id                               --银行账号|C32
	,t1.cst_id                                   --客户编号|C20
	,t1.fnc_amt                                  --当前理财金额|DECIMAL(21,2)
    ,t2.opn_org_id
    ,t3.sbr_org_nm
from edw.dws_bus_chm_act_acm_inf_dd         t1 --理财账户份额汇总信息
inner join edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
ON  t1.bnk_act_id = t2.cst_act_id
AND t2.dt = t1.dt
inner JOIN edw.dim_hr_org_mng_org_tree_dd    t3 --机构树_考核维度
ON  t2.opn_org_id = t3.org_id
AND t3.dt = t1.dt
and t3.brc_org_nm = '舟山分行'
where t1.dt='20250101'
AND t1.pd_tp_cd = '1' --理财
and t1.fnc_amt<>0
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025061271_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061271_CST_03 AS
SELECT  t1.sbr_org_nm                            AS 开卡机构名称
       ,round(nvl(t1.fnc_amt,0)/10000,4)                AS 全量理财余额保有量_万元
       ,round((nvl(t1.fnc_amt,0) - nvl(t2.fnc_amt,0))/10000,4) AS 全量理财余额保有量较年初增量_万元
from(
    select sbr_org_nm
        ,sum(fnc_amt) as fnc_amt
    from SJXQ_SJ2025061271_CST_01
    group by sbr_org_nm
)t1 left join(
    select sbr_org_nm
        ,sum(fnc_amt) as fnc_amt
    from SJXQ_SJ2025061271_CST_02
    group by sbr_org_nm
)t2 on t1.sbr_org_nm=t2.sbr_org_nm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,bnk_act_id,pd_cd) custs
from SJXQ_SJ2025061271_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,bnk_act_id,pd_cd) custs
from SJXQ_SJ2025061271_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 开卡机构名称) custs
from SJXQ_SJ2025061271_CST_03
;
/*
01	14759	14759
02	13835	13835
03	6	6
*/
SElECT '03' seq, *
from lab_bigdata_dev.SJXQ_SJ2025061271_CST_03
***陈哲渊_SJ2025061946_舟山天添宝客户明细.sql
-- 陈哲渊_SJ2025061946_舟山天添宝客户明细
-- 截止5月31日天添宝客户的购买时间、购买金额及活期存款日均
DROP   TABLE IF     EXISTS SJXQ_SJ2025061946_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061946_CST_01 AS
select *
from(
    SELECT  t1.cst_id
        ,t1.trx_dt
        ,t1.trx_tm
        ,t1.bus_cd
        ,t1.bnk_act_id
        ,t1.cfm_amt
        ,t2.DVD_GRP_CD
        ,t3.prm_mgr_id                               --主管护客户经理工号
        ,t3.prm_mgr_nm                               --主管护客户经理姓名
        ,t3.prm_org_id                               --主管护机构号
        ,t3.prm_org_nm                               --主管户机构名称
        ,row_number() over(partition by t1.cst_id order by t1.trx_dt,t1.trx_tm) as rn
    FROM    edw.dwd_bus_chm_trx_cfm_dtl_di              t1
    INNER JOIN edw.dwd_bus_chm_ptfl_cpn_pd_rel_inf_dd   t2 --组合宝成分产品信息映射表
    ON      t1.pd_cd = t2.pd_cd
    and     t2.DVD_GRP_CD = 'TTB001'     --分组代码 天添宝 代销理财
    AND     t2.dt = '20250531'
    INNER JOIN adm_pub.adm_csm_cbas_mng_inf_dd          t3 --客户集市-客户基础-客户管户信息
    on  t1.cst_id = t3.cst_id
    and t3.dt = '20250531'
    and t3.prm_org_id like '3312%' --舟山
    WHERE   t1.dt <= '20250531'
    AND     t1.bus_cd IN ( '120' , '122' , '130' , '134' , '139' ) --认购、申购、基金成立、非交易过户入、定期定额申购
    AND     T1.trx_sts_cd = '8' --确认成功
)t1 where t1.rn=1
;
-- 购买天添宝前一个月的活期存款月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2025061946_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061946_CST_02 AS
select t1.cst_id,t1.trx_dt,t2.dmnd_dep_bal_mon_avg	--	活期存款余额月日均
from(
    select distinct cst_id,trx_dt
    from SJXQ_SJ2025061946_CST_01
)t1 left join adm_pub.adm_csm_cbus_dep_inf_dd t2 --存款业务信息表
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.dt
and t2.dt<='20250531'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025061946_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025061946_CST_03 AS
SELECT  t1.cst_id                AS 客户号
       ,t2.cst_chn_nm            AS 客户名称
       ,t1.trx_dt                AS 首次购买天添宝日期
       ,t1.cfm_amt               AS 首次购买天添宝的金额
       ,t3.dmnd_dep_bal_mon_avg  AS 购买天添宝前一个月的活期存款月日均
       ,t4.dmnd_dep_bal_mon_avg  AS 截止20250531活期存款月日均
       ,t4.dmnd_dep_bal_year_avg AS 截止20250531活期存款年日均
       ,t1.prm_mgr_nm            AS 主管护客户经理姓名
       ,t1.prm_org_nm            AS 主管户机构名称
from SJXQ_SJ2025061946_CST_01       t1
left join edw.dws_cst_bas_inf_dd    t2
on t1.cst_id=t2.cst_id
and t2.dt='20250531'
left join SJXQ_SJ2025061946_CST_02  t3
on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbus_dep_inf_dd t4 --存款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt ='20250531'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061946_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025061946_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025061946_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2025061946_CST_03
;
***陈婉漪_SJ20250210166_流水分析.sql
DROP   TABLE IF     EXISTS SJXQ_SJ20250210166_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250210166_CST_01 AS
SELECT  t3.enterprise_name  AS 客户号
       ,t1.account_no       AS 账号
       ,t5.upload_file_name AS 文件名
       ,t1.bank             AS 开户银行
       ,CASE WHEN t5.status = '-3' THEN '未读取到文件数据，请检查是否为空文件/空Sheet'
             WHEN t5.status = '-11' THEN '未读取到文件数据，请检查是否为空文件/空Sheet'
             WHEN t5.status = '-12' THEN '文件名过长，请修改后重新上传'
             WHEN t5.status = '-13' THEN '单个文件不能超过30MB，请拆分成较小的文件后重新上传'
             WHEN t5.status = '-14' THEN '不支持该文件格式，请上传xlsx/csv/txt/PDF文件；系统问题，已同步技术人员（见知ocr解析失败）'
             WHEN t5.status = '-16' THEN '系统问题，已同步技术人员（服务器或网络异常）'
             WHEN t5.status = '-20' THEN '无效的Excel文件，请尝试打开文件并另存为.xls格式后重新上传'
             WHEN t5.status = '-100' THEN '该文件已被加密，系统无法解析，请尝试解密后重新上传'
             WHEN t5.status = '-120' THEN '识别失败（非流水文件或无表头文件，忽略文件或补全表头后重新上传；第X行起借贷标志存在异常，请检查），校验失败（第X行交易金额超出最大位数限制，请检查；第X行存在余额错误，请检查；第X行金额格式存在异常，请检查；未识别交易日期及交易金额，请检查文件）'
             WHEN t5.status = '-121' THEN '识别失败（未识别交易金额，请检查文件）；校验失败（X处余额错误，请检查）'
             WHEN t5.status = '-122' THEN '识别失败（未识别交易日期，请检查文件）；校验失败（第X行起存在日期/时间格式错误，请检查）'
             WHEN t5.status = '-123' THEN '系统问题，已同步技术人员（-123）'
             WHEN t5.status = '-220' THEN '系统问题，已同步技术人员（文件与银行标准格式差异较大）'
             WHEN t5.status = '-270' THEN '系统问题，已同步技术人员（见知ocr解析失败）；暂不支持此银行多币种流水文件的解析'
             WHEN t5.status = '-271' THEN '该文件已被加密，系统无法解析，请尝试解密后重新上传'
             WHEN t5.status = '-430' THEN '系统问题，已同步技术人员（-430）'
             WHEN t5.status = '-431' THEN '文件解析超时，请重新上传'
             WHEN t5.status = '-450' THEN '系统问题，已同步技术人员（-450）'
             WHEN t5.status = '-500' THEN '单个上传文件中的流水条数需要低于50,000条，请拆分文件后上传'
             WHEN t5.status = '-250' THEN '文件已识别，未读取到有效数据行，请检查：1）是否为无数据行的空文件/Sheet；2）日期格式是否正确（需包含年/月/日信息）'
             WHEN t5.status = '999' THEN '识别成功' END AS 文件解析状态
FROM edw.bfas_c4c_bank_account              t1 --银行账号数据表
INNER JOIN edw.bfas_tb_enterprise_entity    t2
ON t2.le_id = t1.le_id
and t2.dt=t1.dt
INNER JOIN edw.bfas_tb_enterprise           t3 --基础_机构信息
ON t2.enterprise_id = t3.enterprise_id
and t3.dt=t1.dt
AND t3.delete_flag = 0
INNER JOIN edw.bfas_c4c_upload_log_relation t4 --分类规则模板表
ON t1.account_id = t4.account_id
and t4.dt=t1.dt
INNER JOIN edw.bfas_c4c_upload_log          t5 --文件上传日志
ON t4.log_id = t5.log_id
and t5.dt=t1.dt
AND t5.file_delete_by is null
AND t5.le_id > 0
where t1.dt='@@{yyyyMMdd}'
;
select '银行账号数据表' as tbl_nm
	,count(1) cnt
	,count(distinct le_id) as 企业ID
	,count(distinct account_no) as 账号
from edw.bfas_c4c_bank_account --银行账号数据表
where dt='20241231';
select '基础_机构信息' as tbl_nm
	,count(1) cnt
	,count(distinct enterprise_id) as ID
from edw.bfas_tb_enterprise --基础_机构信息
where dt='20241231';
select '分类规则模板表' as tbl_nm
	,count(1) cnt
	,count(distinct log_id) as 记录ID
	,count(distinct account_id) as 账号ID
from edw.bfas_c4c_upload_log_relation --分类规则模板表
where dt='20241231';
select '文件上传日志' as tbl_nm
	,count(1) cnt
	,count(distinct log_id) as ID
	,count(distinct le_id) as 所在企业
from edw.bfas_c4c_upload_log --文件上传日志
where dt='20241231';***陈慧萍_SJ2025042416_政和村行交易风险排查.sql
﻿-- 陈慧萍022721-地下六合彩
-- SJ2025042416
/* 是否要求同时满足？开户机构 政和
&quot;1.个人客户联系方式相同超3户；
2.个人客户居住地址相同超过3户&quot;
&quot;1.开户时间距离注册时间1个月以内的对公账户；
2.3个以上对公客户注册地址相同
3.对公客户注册日期间隔7天以内&quot;
&quot;1.当日首笔交易较最后一笔交易时间，间隔达到8个小时以上，同时提出当天交易10笔以下客户；--有10天满足记为是
2.交易明细中，存在交易时间在23:00-05:00之间的，且连续5天在该时段内交易超过20笔的客户&quot;
每个月，客户账户入账交易笔数占比90%以上 或 账户出账交易笔数占比90%以上
&quot;1.交易规模异常：每个月，账户交易量累计超过1000万；
2.交易频率异常：每个月，账户交易频次累计超过1000笔；
3.客户职业不匹配：客户预留职业信息为不便分类、家庭主妇、无业、自由职业、农业生产人员等，但账户存在（1）、（2）异常的；--单独出个名单
4.客户身份不匹配：客户年龄在23岁以下、70岁以上等，但账户存在（1）、（2）异常的；--单独出个名单&quot;
&quot;1.入账时间到下一笔出账时间间隔在半小时内，且一天内超过20笔以上；
2.每个月，出账累计金额/入账累计金额 比例在90%以上&quot;
&quot;1.每个月，账户交易渠道通过ATM渠道笔数达到30笔；
2.每个月，线下交易在3家以上村行网点发生；--线下指在柜面&quot;
&quot;1.每个月，统计相同金额交易笔数，且存在笔数占比20%以上；
2.每个月，交易金额的最后两位或最后一位的数值，相同的频次出现10笔以上，不统计最后一位是0的&quot;
交易附言有&ldquo;充值&rdquo;、&ldquo;返利&rdquo;以及&ldquo;字母+数字&rdquo;、数字+字母，字母1个以上直接加数字一个以上
*/
-- 数据需求（数据时间：2024年1月1日至今）
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_01 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_chn_nm                               --客户姓名|C200
	,t1.cst_typ_cd                               --客户类型|C1
	,case when length(t1.mbl_nbr)>=7 then t1.mbl_nbr when length(t1.fml_tel_nbr)<=3 then t1.mbl_nbr
        else t1.fml_tel_nbr end as mbl_nbr       --手机|C32
	,t1.reg_adr                                  --户籍地址|注册地址|C256
	,t1.fml_adr                                  --家庭地址|C256
    ,t2.min_opn_dt
    ,t5.org_org_found_dt	--组织机构成立日期
    ,datediff(to_date(t2.min_opn_dt,'yyyyMMdd'),to_date(t5.org_org_found_dt,'yyyyMMdd'),'dd') as diff_days
    ,t4.org_nm,t6.age,t6.ocp_cd	--	职业代码
    ,c1.cd_val_dscr     as ocp_nm
    ,case when c1.cd_val_dscr regexp '不便分类|家庭主妇|无业|自由职业|农业生产' then 1 else 0 end as is_kw
from edw.dws_cst_bas_inf_dd        t1           --客户基础信息汇总表
left join(
    select cst_id,min(opn_dt)  as min_opn_dt    --开户日期|C8
    from edw.dim_bus_dep_cst_act_inf_dd  		--客户存款账户信息
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm='福建政和泰隆村镇银行'
left join edw.dim_cst_entp_bas_inf_dd	t5 --企业客户基本信息
on t1.cst_id=t5.cst_id
and t5.dt=t1.dt
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t6 --对私客户基础信息
on t1.cst_id=t6.cst_id
and t6.dt=t1.dt
left join edw.dwd_code_library_dd   c1
on t6.ocp_cd = c1.cd_val
and c1.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
;
-- 客户交易记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_02 AS
select t1.cst_id,t1.cst_act_id,t1.dep_act_id
	,t3.dtl_seq_nbr                              --明细序号|INTEGER
	,t3.trx_dt                                   --交易日期|C8
	,t3.trx_tm                                   --交易时间|C9
	,t3.crd_and_dbt_ind                          --借贷标志|C1
	,t3.trx_amt                                  --交易金额|DECIMAL(21,2)
	,t3.act_bal                                  --账户余额|DECIMAL(21,2)
	,t3.txt_code                                 --摘要代码|C10
	,t3.smr_dscr                                 --摘要描述|C512
	,t3.trx_chnl_cd                              --交易渠道代码 A01:柜面 C01:ATM
	,t3.cmt                                      --备注|C200
    ,t3.trx_bus_org                              --交易营业机构|C12
    ,concat(substr(t3.trx_dt,1,4),cast(weekofyear(to_date(t3.trx_dt, &quot;yyyymmdd&quot;)) as string)) as curr_week
    ,case when concat(t3.smr_dscr,t3.cmt) regexp '充值|返利|[a-zA-Z]+[0-9]+|[0-9]+[a-zA-Z]+' then 1 else 0 end as is_kw
    ,row_number() over(partition by t1.cst_id,t3.trx_dt order by t3.trx_tm,t3.dtl_seq_nbr) as day_tm_rn
from edw.dim_bus_dep_act_inf_dd         t1 			--存款账户信息
inner join SJXQ_SJ2025042416_CST_01     t2
on t1.cst_id=t2.cst_id
INNER join edw.DWD_BUS_DEP_BAL_CHG_DTL_DI   t3
ON   t1.DEP_ACT_ID=t3.DEP_ACT_ID
and t3.dt>='20240101'
and t3.bal_fld_nm = 'DPLDGBAL' --动账
where t1.dt='@@{yyyyMMdd}'
;
-- 对公客户注册日期间隔7天以内
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_03 AS
select t1.cst_id,t1.cst_chn_nm,t1.org_org_found_dt
    ,t2.cst_id      as cst_id2
    ,t2.cst_chn_nm  as cst_chn_nm2
    ,t2.org_org_found_dt as org_org_found_dt2
from(
    select cst_id,cst_chn_nm,org_org_found_dt	--组织机构成立日期
        ,row_number() over(order by org_org_found_dt) rn
    from SJXQ_SJ2025042416_CST_01 t2
    where cst_typ_cd='2'
    and nvl(org_org_found_dt,'')<>''
)t1 inner join(
    select cst_id,cst_chn_nm,org_org_found_dt	--组织机构成立日期
        ,row_number() over(order by org_org_found_dt) rn
    from SJXQ_SJ2025042416_CST_01 t2
    where cst_typ_cd='2'
    and nvl(org_org_found_dt,'')<>''
)t2 on t1.rn = t2.rn+1
where datediff(to_date(t1.org_org_found_dt,'yyyyMMdd'),to_date(t2.org_org_found_dt,'yyyyMMdd'),'dd')<7
and t2.org_org_found_dt>='20240101'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_04 AS
select t2.cst_id                                  as 客户号
	,t2.cst_chn_nm                              as 客户姓名
    ,'1-1 联系方式相同超3户' as ind
from(
    select mbl_nbr,count(1) as cnt
    from SJXQ_SJ2025042416_CST_01
    where cst_typ_cd='1' and nvl(mbl_nbr,'')<>''
    group by mbl_nbr having cnt>3
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.mbl_nbr=t2.mbl_nbr
where t2.cst_typ_cd='1'
union all
select t2.cst_id                                  as 客户号
	,t2.cst_chn_nm                              as 客户姓名
    ,'1-2 居住地址相同超过3户' as ind
from(
    from SJXQ_SJ2025042416_CST_01
    where cst_typ_cd='1' and nvl(fml_adr,'')<>''
    group by fml_adr having cnt>3
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.fml_adr=t2.fml_adr
where t2.cst_typ_cd='1'
union all
select cst_id                                  as 客户号
	,cst_chn_nm                              as 客户姓名
    ,'2-1 开户时间距离注册时间1个月以内的对公账户' as ind
from SJXQ_SJ2025042416_CST_01
where cst_typ_cd='2'
and diff_days<=30 and diff_days>=0  --检查小于0数据
union all
select t2.cst_id                                  as 客户号
	,t2.cst_chn_nm                              as 客户姓名
    ,'2-2 对公客户注册地址相同超3户' as ind
from(
    select reg_adr,count(1) as cnt
    from SJXQ_SJ2025042416_CST_01
    where cst_typ_cd='2' and nvl(reg_adr,'')<>''
    group by reg_adr having cnt>3
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.reg_adr=t2.reg_adr
where t2.cst_typ_cd='2'
union all
select cst_id                                  as 客户号
	,cst_chn_nm                              as 客户姓名
    ,'2-3 对公客户注册日期间隔7天以内' as ind
from SJXQ_SJ2025042416_CST_03
union all
select cst_id2                                  as 客户号
	,cst_chn_nm2                              as 客户姓名
    ,'2-3 对公客户注册日期间隔7天以内' as ind
from SJXQ_SJ2025042416_CST_03
union all
select t1.cst_id as 客户号
    ,t2.cst_chn_nm                              as 客户姓名
    ,'3-1 间隔达到8个小时以上' as ind
from(
    select cst_id,trx_dt,min(trx_tm) as min_tm
        ,max(trx_tm) as max_tm,count(1) cnt
    from SJXQ_SJ2025042416_CST_02
    where length(trx_tm)>=5
    group by cst_id,trx_dt having cnt>=10
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
where substr(max_tm,1,2)*60+substr(max_tm,3,2) - substr(min_tm,1,2)*60-substr(min_tm,3,2) > 8*60
group by t1.cst_id,t2.cst_chn_nm having count(1) >= 10 --10天满足记为是
union all
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'3-2 每周夜间交易超过20笔' as ind
from(
    select cst_id,curr_week
    from SJXQ_SJ2025042416_CST_02
    where substr(trx_tm,1,4)>'2300' or substr(trx_tm,1,4)<'0500'
    group by cst_id,curr_week having count(1)>20
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_05 AS
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'5-1 超过1000万' as ind
from(
    select cst_id,substr(trx_dt,1,6) as mons
    from SJXQ_SJ2025042416_CST_02
    group by cst_id,mons having sum(trx_amt)>10000000
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
union all
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'5-2 超过1000笔' as ind
from(
    select cst_id,substr(trx_dt,1,6) as mons
    from SJXQ_SJ2025042416_CST_02
    group by cst_id,mons having count(1)>1000
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_06 AS
select t1.cst_id as 客户号
    ,t1.cst_chn_nm        as 客户姓名
    ,'5-3 职业不匹配' as ind
from SJXQ_SJ2025042416_CST_01  t1
inner join(
    select distinct 客户号 from SJXQ_SJ2025042416_CST_05
)t2 on t1.cst_id=t2.客户号
where t1.is_kw=1
union all
select t1.cst_id as 客户号
    ,t1.cst_chn_nm        as 客户姓名
    ,'5-4 身份不匹配' as ind
from SJXQ_SJ2025042416_CST_01  t1
inner join(
    select distinct 客户号 from SJXQ_SJ2025042416_CST_05
)t2 on t1.cst_id=t2.客户号
where t1.age<23 or t1.age>70
;
-- 1.入账时间到下一笔出账时间间隔在半小时内，且一天内超过20笔以上；
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_07 AS
select t1.cst_id,t1.trx_dt,t1.trx_tm,t2.trx_tm as trx_tm_nxt
from SJXQ_SJ2025042416_CST_02       t1 --入账
inner join SJXQ_SJ2025042416_CST_02 t2 --出账
on t1.day_tm_rn+1=t2.day_tm_rn
and t1.trx_dt=t2.trx_dt
and t1.cst_id=t2.cst_id
and substr(t2.trx_tm,1,2)*60+substr(t2.trx_tm,3,2) - substr(t1.trx_tm,1,2)*60 - substr(t1.trx_tm,3,2) <30
where t1.crd_and_dbt_ind='C' and t2.crd_and_dbt_ind='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_08 AS
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'6-1 20笔以上' as ind
from(
    select cst_id,trx_dt
    from SJXQ_SJ2025042416_CST_07
    group by cst_id,trx_dt having count(1) > 20
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
union all
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'7-1 ATM渠道笔数达到30笔' as ind
from(
    select cst_id,substr(trx_dt,1,6) as mons
    from SJXQ_SJ2025042416_CST_02
    where trx_chnl_cd='C01'     --ATM
    group by cst_id,mons having count(1)>=30
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
union all
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'7-2 3家以上村行网点发生' as ind
from(
    select cst_id,substr(trx_dt,1,6) as mons
    from SJXQ_SJ2025042416_CST_02
    where trx_chnl_cd='A01'     --柜面
    group by cst_id,mons having count(distinct trx_bus_org) >3
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
union all
select distinct t1.cst_id as 客户号
    ,t2.cst_chn_nm        as 客户姓名
    ,'8-2 相同的频次出现10笔以上' as ind
from(
    select cst_id,substr(trx_dt,1,6) as mons
        ,substr(trx_amt,-1,1) as lst_num
    from SJXQ_SJ2025042416_CST_02
    where substr(trx_amt,-1,1) <> '0'
    group by cst_id,mons,lst_num having count(1)>10
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
;
-- 清单汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_09 AS
SElECT 客户号,客户姓名,ind
from SJXQ_SJ2025042416_CST_04
union
SElECT 客户号,客户姓名,ind
from SJXQ_SJ2025042416_CST_05
union
SElECT 客户号,客户姓名,ind
from SJXQ_SJ2025042416_CST_06
union
SElECT 客户号,客户姓名,ind
from SJXQ_SJ2025042416_CST_08
;
-- 每个月，客户账户入账交易笔数占比90%以上 或 账户出账交易笔数占比90%以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_10 AS
SELECT  t1.cst_id     AS 客户号
       ,t2.cst_chn_nm AS 客户姓名
       ,'4 占比90%以上'   AS ind
       ,t1.mons       AS 交易月份
       ,t1.in_rate    AS 入账占比
       ,t1.out_rate   AS 出账占比
       ,t1.交易笔数
from(
    select cst_id,substr(trx_dt,1,6) as mons
        ,sum(case when crd_and_dbt_ind='C' then 1 else 0 end)/count(1) as in_rate
        ,sum(case when crd_and_dbt_ind='D' then 1 else 0 end)/count(1) as out_rate
        ,count(1) as 交易笔数
    from SJXQ_SJ2025042416_CST_02
    group by cst_id,mons
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
where t1.in_rate>0.9 or t1.out_rate>0.9
;
-- 2.每个月，出账累计金额/入账累计金额 比例在90%以上
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_11 AS
SELECT  t1.cst_id      AS 客户号
       ,t2.cst_chn_nm  AS 客户姓名
       ,'6-2 90%以上'    AS ind
       ,t1.mons        AS 交易月份
       ,t1.out_amt     AS 出账累计金额
       ,t1.in_amt      AS 入账累计金额
       ,t1.out_in_rate AS 出账占比
from(
    select cst_id,substr(trx_dt,1,6) as mons
        ,sum(case when crd_and_dbt_ind='C' then trx_amt else 0 end) as in_amt
        ,sum(case when crd_and_dbt_ind='D' then trx_amt else 0 end) as out_amt
        ,case when sum(case when crd_and_dbt_ind='C' then trx_amt else 0 end) >0
        then sum(case when crd_and_dbt_ind='D' then trx_amt else 0 end)/sum(case when crd_and_dbt_ind='C' then trx_amt else 0 end)
            else 1 end as out_in_rate
    from SJXQ_SJ2025042416_CST_02
    group by cst_id,mons
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
where t1.out_in_rate>0.9
;
-- 1.每个月，统计相同金额交易笔数，且存在笔数占比20%以上；
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_12 AS
SELECT  distinct t1.cst_id AS 客户号
       ,t2.cst_chn_nm      AS 客户姓名
       ,'8-1 占比20%以上'      AS ind
       ,t1.mons            AS 交易月份
       ,t1.trx_amt         AS 相同金额
       ,t1.trx_cnt         AS 交易笔数
       ,t1.rate            AS 月占比
from(
    select t1.cst_id,t1.mons,t1.trx_amt,t1.trx_cnt
        ,trx_cnt/sum(trx_cnt) over(partition by cst_id,mons) as rate
    from(
        select cst_id,substr(trx_dt,1,6) as mons,trx_amt
            ,count(1) as trx_cnt
        from SJXQ_SJ2025042416_CST_02
        group by cst_id,mons,trx_amt
    )t1
)t1 inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
where t1.rate>0.2
;
-- 交易附言有&ldquo;充值&rdquo;、&ldquo;返利&rdquo;以及&ldquo;字母+数字&rdquo;
DROP   TABLE IF     EXISTS SJXQ_SJ2025042416_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025042416_CST_13 AS
SELECT  t1.cst_id          AS 客户号
       ,t2.cst_chn_nm      AS 客户姓名
       ,'9 充值,返利,字母+数字'    AS ind
       ,t1.cst_act_id      AS 客户账号
       ,t1.dep_act_id      AS 存款账号
       ,t1.trx_dt          AS 交易日期
       ,t1.trx_tm          AS 交易时间
       ,t1.crd_and_dbt_ind AS 借贷标志
       ,t1.trx_amt         AS 交易金额
       ,t1.txt_code        AS 摘要代码
       ,t1.smr_dscr        AS 摘要描述
       ,t1.cmt             AS 备注
from SJXQ_SJ2025042416_CST_02 t1
inner join SJXQ_SJ2025042416_CST_01 t2
on t1.cst_id=t2.cst_id
where t1.is_kw=1
;
-- 汇总统计
select ind,count(1) cnt,count(distinct 客户号) as 客户数
from SJXQ_SJ2025042416_CST_09
group by ind
order by ind
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042416_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2025042416_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042416_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号,ind) custs
from SJXQ_SJ2025042416_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号,ind) custs
from SJXQ_SJ2025042416_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号,ind) custs
from SJXQ_SJ2025042416_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025042416_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号,ind) custs
from SJXQ_SJ2025042416_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户号,ind) custs
from SJXQ_SJ2025042416_CST_09
;
/*
01	244631	244631
02	4159213	4159213
03	301	301
04	309403	309114
05	131	131
06	3	3
07	267333	22102
08	91422	91422
09	400670	400670
*/***陈柯颖_SJ2025071796_信用卡免年费客户.sql
-- 陈柯颖_SJ2025071796_信用卡免年费客户
-- 截至7月17日，绍兴分行未达到免年费标准并将于三季度扣除年费的信用卡客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2025071796_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071796_CST_01 AS
select t1.cr_crd_card_nbr                          --信用卡卡号|C19
	,t1.main_crd_ind                             --主附卡标志|C1
	,t1.card_sts_cd                              --卡片状态代码|C2
    ,c1.cd_val_dscr     as 卡片状态
	,t1.card_sts_dt                              --卡片状态日期|C8
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.mtu_day                                  --到期日|C8
	,t1.late_trx_dt                              --最后交易日期|C8
	,t1.card_fee_cd                              --卡片费用代码|C2
    ,CASE
        WHEN t1.card_fee_cd = 'A' THEN '免第一年年费'
        WHEN t1.card_fee_cd = 'B' THEN ''
        WHEN t1.card_fee_cd = 'F' THEN '终身免年费帐户'
        WHEN t1.card_fee_cd = 'H' THEN ''
        WHEN t1.card_fee_cd = 'S' THEN '年费全收'
        WHEN t1.card_fee_cd = 'W' THEN ''
        END 费用代码
	,t1.cr_crd_act_id                            --信用卡账号|C10
	,t1.nxt_clc_af_mon                           --下次收年费月份|C3
    ,t2.act_org_id                               --核算机构编号|c12
	,t2.act_sts_cd                               --账户状态代码|c2
    ,c2.cd_val_dscr     as 账户状态
from edw.dim_bus_crd_cr_crd_inf_dd           t1 --信用卡卡片信息
inner join edw.dim_bus_crd_cr_crd_act_inf_dd t2 --信用卡账户信息
on t1.cr_crd_act_id=t2.cr_crd_act_id
and t2.dt=t1.dt
LEFT JOIN
(
	SELECT  *
	       ,ROW_NUMBER() OVER ( PARTITION BY product ,fee_code ORDER BY  effect_day DESC ) AS rn
	FROM edw.ncrd_prmfe
	WHERE dt = '20250717'
) AS t3
ON t1.CR_CRD_PD_ID = t3.product AND t1.card_fee_cd = t3.fee_code AND t3.rn = 1
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.act_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '绍兴分行'
left join edw.dwd_code_library_dd   c1
on t1.card_sts_cd = c1.cd_val
and c1.dt = t1.dt
left join edw.dwd_code_library_dd   c2
on t2.act_sts_cd = c2.cd_val
and c2.dt = t1.dt
where t1.dt='20250717'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025071796_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025071796_CST_02 AS
SELECT  cst_id          AS 客户号
       ,cst_nm          AS 客户名称
       ,cr_crd_card_nbr AS 信用卡卡号
       ,卡片状态
       ,账户状态
       ,nxt_clc_af_mon  AS 下次收年费月份
from SJXQ_SJ2025071796_CST_01
and card_fee_cd <> 'F'  --终身免年费帐户
;
SElECT '01' seq, count(1) cnt,count(distinct cr_crd_card_nbr) custs
from SJXQ_SJ2025071796_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025071796_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2025071796_CST_02
***陈锐_SJ20250513161_台州注册企业清单.sql
﻿-- 陈锐_SJ20250513161_台州注册企业清单
/*
提取台州范围内所有注册企业清单，请提供能取到的最新数据
数据需求字段
注册企业名称、机构代码证号码、注册地址、注册时间等全量可以提供的字段
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20250513161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250513161_CST_01 AS
SELECT  t1.company_id
	,decode(t1.company_major_type, 1, '个体户', 2, '合作社', 3, '企业', '') AS 归类后的主体类型
    ,t1.n_company_status                                                 AS 归类后的登记状态
    ,t1.province                                                         AS 省
    ,t1.city                                                             AS 城市
    ,t1.district                                                         AS 区县
from edw.nout_company_base_clean t1 --企业基本信息清洗表
where t1.dt='@@{yyyyMMdd-1d}'
and t1.city='台州市'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250513161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250513161_CST_02 AS
SELECT  t1.company_name      AS 企业名称
	,t1.credit_no            AS 统一信用代码
	,t1.org_code             AS 组织机构代码
	,t1.establish_date       AS 成立日期
	,t1.legal_person         AS 法定代表人
	,t1.legal_person_caption AS 法人头衔
	,t1.company_status       AS 登记状态
	,t1.company_type         AS 类型
	,t1.issue_date           AS 核准日期
	,t1.operation_startdate  AS 营业期限自
	,t1.operation_enddate    AS 营业期限至
	,t1.capital              AS 注册资本
	,t1.company_address      AS 地址
	,t1.business_scope       AS 经营范围
	,t1.real_capital         AS 实缴资本
	,t2.归类后的主体类型
	,t2.归类后的登记状态
	,t2.省
	,t2.城市
	,t2.区县
	,t3.industry             AS 最深一级的行业名称
	,t3.industry_code        AS 最深一级的行业代码
	,t3.industry_l1_code     AS 一级行业编码
	,t3.industry_l1_name     AS 一级行业名称
	,t3.industry_l2_code     AS 二级行业编码
	,t3.industry_l2_name     AS 二级行业名称
	,t3.industry_l3_code     AS 三级行业编码
	,t3.industry_l3_name     AS 三级行业名称
	,t3.industry_l4_code     AS 四级行业编码
	,t3.industry_l4_name     AS 四级行业名称
    ,ROW_NUMBER() over(partition by t1.credit_no order by t1.use_flag,t1.id desc) as 同一统一信用代码排序
from edw.nout_company_base              t1 --企业基本信息表
inner join SJXQ_SJ20250513161_CST_01    t2
on t1.company_id=t2.company_id
left join edw.nout_company_industry 	t3 --企业行业信息表
on t1.company_id=t3.company_id
and t3.dt=t1.dt
where t1.dt='@@{yyyyMMdd-1d}'
;
SElECT '01' seq, count(1) cnt,count(distinct company_id) custs
from SJXQ_SJ20250513161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 统一信用代码) custs
from SJXQ_SJ20250513161_CST_02
;
SElECT *
from lab_sjxq.SJXQ_SJ20250513161_CST_02
limit 1000
***陈飞_SJ2024123156_贷款和随贷通业务数据.sql
﻿-- 长乐村行20190101-20241231的贷款和随贷通业务在信贷系统合同详情内的借还款记录导出（详见清单）
-- 若该流程审批完成时数据无法取数至20241231，请于元旦后再取数至20241231。
DROP   TABLE IF     EXISTS SJXQ_SJ2024123156_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024123156_CST_01 AS
SELECT  t1.col_1 --序号
    ,t1.col_2 --业务品种
    ,t1.col_3 --合同流水号
    ,t1.col_4 --借据流水号
    ,t1.col_5 --客户名称
    ,t2.ctr_serno
	,t2.ctr_bgn_dt                               --合同起始日期
	,t2.ctr_mtu_dt                               --合同到期日期
from qbi_file_20250102_14_08_05_0           t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2
on t1.col_3=t2.ctr_serno
and t2.dt='20241231'
where t1.pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024123156_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024123156_CST_02 AS
SELECT  t1.ctr_serno
       ,t2.dbil_id
       ,t2.LVE_ACT_BGN_DT --出账起始日期|C8
       ,t2.EXEC_MTU_DT    --执行到期日|C8
       ,t2.TMT_DT         --终结日期|C8
       ,t2.MTU_DT         --到期日期|C8
       ,t3.dtl_seq_nbr    --明细序号|BIGINT
       ,t3.trx_dt
       ,t3.trx_amt        --交易金额
       ,t3.trx_dir        --交易方向 台账类型
       ,decode(t3.trx_dir,'0','发放','1','回收','') AS 台账类型
       ,t3.trx_evt        --交易事件
       ,t3.evt_cmt        --事件说明 交易描述
       ,t3.bal_fld_cmt    --余额字段说明
       ,t3.smr            --摘要
from SJXQ_SJ2024123156_CST_01           t1
inner join edw.dim_bus_loan_dbil_inf_dd t2 --信贷借据信息
on t1.ctr_serno=t2.ctr_serno
and t1.col_4=t2.dbil_id
and t2.dt='20241231'
inner join edw.dwd_bus_loan_act_trx_dtl_di t3 --贷款账户交易明细，余额字段bal_fld_cmt
ON  t2.dbil_id = t3.loan_dbil_id
AND t3.dt between '20190101' and '20241231'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024123156_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024123156_CST_02_1 AS
SELECT  t1.serialno           AS 信息流水号
       ,t1.relativecontractno AS 合同流水号
       ,t2.cst_nm             AS 客户姓名
       ,t1.relativeserialno   AS 借据流水号
       ,t2.cst_id             AS 客户号
       ,t1.occurdate          AS 账务发生日期
       ,CASE WHEN t1.occurdirection = '0' THEN '发放'  ELSE '回收' END AS 台账类型
       ,t1.actualdebitsum     AS 发放金额
       ,t1.actualcreditsum    AS 回收金额
       ,t1.businessdesc
       ,t4.itemname           AS 交易描述
       ,t2.lve_act_bgn_dt     AS 借据发放日期
       ,t2.mtu_dt             AS 借据到期日期
FROM edw.loan_business_wastebook        t1 --业务流水账 20240719停止更新
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd  t2 --信贷借据信息
ON t2.dt = '20241231'
AND t1.relativeserialno = t2.dbil_id
inner join SJXQ_SJ2024123156_CST_01     t3
on t1.relativecontractno=t3.ctr_serno
and t1.relativeserialno=t3.col_4
LEFT JOIN edw.loan_code_library         t4 --代码库 20240719停止更新
ON t1.businessdesc = t4.itemno
AND t4.codeno = 'BusinessDesc'
AND t4.dt = '20240719'
WHERE t1.dt <= '20240719'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024123156_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024123156_CST_03 AS
SELECT  t1.col_1          AS 序号
       ,t1.col_2          AS 业务品种
       ,t1.ctr_serno      AS 合同流水号
       ,t1.col_4          AS 借据流水号
       ,t1.col_5          AS 客户名称
       ,t1.ctr_bgn_dt     AS 合同起始日期
       ,t1.ctr_mtu_dt     AS 合同到期日期
       ,t2.lve_act_bgn_dt AS 出账起始日期
       ,t2.exec_mtu_dt    AS 执行到期日
       ,t2.tmt_dt         AS 终结日期
       ,t2.mtu_dt         AS 到期日期
       ,t2.台账类型
       ,t2.trx_dt         as 交易日期
       ,t2.trx_amt        AS 交易金额
       ,t2.evt_cmt        AS 事件说明
from SJXQ_SJ2024123156_CST_01       t1
left join SJXQ_SJ2024123156_CST_02  t2
on t1.ctr_serno=t2.ctr_serno
and t1.col_4=t2.dbil_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno,col_4) custs
from SJXQ_SJ2024123156_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno,dbil_id,dtl_seq_nbr) custs
from SJXQ_SJ2024123156_CST_02
union all
SElECT '021' seq, count(1) cnt,count(distinct 合同流水号,借据流水号) custs
from SJXQ_SJ2024123156_CST_02_1
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号,借据流水号) custs
from SJXQ_SJ2024123156_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2024123156_CST_03
;
/*
01	474	474
02	48004	48004
021	42093	474
03	48004	474
*/
***陈鹏_SJ20250224111_鲤想财资拓客.sql
/*
对公客户名称
上年度交易次数 > 10
管户机构
管户客户经理
法定代表人客户号
法定代表人名称
法定代表人是否开立结算账户
法定代表人上年度活期账户交易次数
法定代表人配偶客户号
法定代表人配偶名称
法定代表人配偶是否开立结算账户
法定代表人配偶上年度活期账户交易次数
同一法定代表人的其他公司1
客户号
上年度交易次数
同一法定代表人的其他公司2
客户号
上年度交易次数
同一法定代表人的其他公司3
客户号
上年度交易次数
...
*/
--对私开立结算账户客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_01 as
select cst_id
    ,max(case when lbl_prod_typ_cd='0' then 1 else 0 end) as is_hq_act
from edw.dim_bus_dep_act_inf_dd  			--存款账户信息
where dt='@@{yyyyMMdd}'
group by cst_id
;
-- 上年度交易次数
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_02 as
select t1.dep_act_id                             --存款账号|C32
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
    ,t1.crd_and_dbt_ind
    ,t1.trx_amt                             --原币种交易金额
	,t1.cst_act_id    as   cst_act_id2      --客户账号|C32
    ,t1.dt
    ,t2.cst_id,t2.cst_act_id
    ,t2.lbl_prod_typ_cd
    ,decode(t2.lbl_prod_typ_cd,'0','活期','1','定期') as lbl_prod_typ_nm
from edw.dwd_bus_dep_bal_chg_dtl_di     t1 --存款账户余额发生明细
inner join edw.dim_bus_dep_act_inf_dd  	t2 --存款账户信息
ON t1.dep_act_id=t2.dep_act_id
AND T2.dt ='@@{yyyyMMdd}'
LEFT JOIN edw.dwd_bus_bill_acc_mrgn_inf_dd  T3
ON t2.cst_act_id = T3.mrgn_act_id
AND T1.DT = T3.dt -- 承兑保证金信息
where t1.dt between '20231201' and '20250131'
AND T1.bal_fld_nm = 'DPLDGBAL'
AND T3.mrgn_act_id IS NULL -- 剔除保证金账户
AND t1.TXT_CODE NOT IN ( 'DPW040' , 'IB0047' ) --摘要代码 剔除代发工资
    ,'DP1000','DP2081','DP2094','DP2096','DP2131','DP3000','DP3001','DPW032','GL0002','GL0621','IB0034'
    ,'LN0004','LN0009','LN0014','LN0022','LN0023','LN1012','LN1024','LN1025','LN1036','TY0100','TY0101'
    ,'TY0111','TY0113','TY0114','TY0130','TY0131','WWP001','WWP002','WWP004','WWP010','WWP021') --除计息 剔除利息相关
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_03 as
select cst_id
    ,count(1) as trx_cnt_24
    ,count(case when lbl_prod_typ_cd='0' then cst_id end) as hq_trx_cnt_24
from SJXQ_SJ20250220151_CST_02 t1
where t1.trx_dt BETWEEN '20240101' and '20241231'
group by cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250220151_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250220151_CST_04 as
SELECT  t1.cst_id      AS 对公客户号
       ,t1.cst_chn_nm  AS 对公客户姓名
       ,t7.trx_cnt_24  AS 上年度交易次数
       ,t1.cst_typ     --客户类型
       ,t1.cst_typ_cd  --客户类型分类
       ,t1.org_mngr_nm AS 管户机构名称
       ,t1.acs_mngr_nm AS 管户客户经理名称
       ,t2.lgp_cst_id  AS 对公客户法人客户号
       ,t2.lgp_nm      AS 对公客户法人客户名称
       ,t1.legal_name  AS 对公客户法定代表人客户姓名
       ,CASE WHEN t6.cst_id is not null THEN 'Y'  ELSE '' END AS 法定代表人是否开立账户
       ,CASE WHEN t6.is_hq_act = 1 THEN 'Y'  ELSE '' END      AS 法定代表人是否开立活期账户
       ,t8.hq_trx_cnt_24                                      AS 法定代表人上年度活期账户交易次数
       ,T3.rel_cst_id                                         AS 法人配偶客户号
       ,T4.cst_chn_nm                                         AS 法人配偶客户名称
       ,CASE WHEN t9.cst_id is not null THEN 'Y'  ELSE '' END AS 法定代表人配偶是否开立账户
       ,CASE WHEN t9.is_hq_act = 1 THEN 'Y'  ELSE '' END      AS 法定代表人配偶是否开立活期账户
       ,t10.hq_trx_cnt_24                                     AS 法定代表人配偶上年度活期账户交易次数
       ,t5.cst_id                                             AS 同一法定代表人其他公司客户号
       ,t11.trx_cnt_24                                        AS 同一法定代表人其他公司客户上年度交易次数
from adm_pub.adm_csm_cbas_org_inf_dd    t1 --客户集市-客户基础-对公客户基础信息
left join edw.dim_cst_entp_lgp_inf_dd   t2 --对公客户法人信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_rel              t3
ON t2.lgp_cst_id = t3.cst_id
AND t3.rel_typ = '0301' --配偶
AND t3.DT = '@@{yyyyMMdd}'
AND t3.del_ind <> '1' --删除标识
AND t3.vld_ind <> '0' --有效标识
LEFT JOIN edw.dws_cst_bas_inf_dd        T4 --客户基础信息汇总表
ON t3.rel_cst_id = T4.cst_id
AND T4.DT = '@@{yyyyMMdd}'
left join edw.dim_cst_entp_lgp_inf_dd   t5
on t2.lgp_cst_id = t5.lgp_cst_id
and t1.cst_id<>t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20250220151_CST_01     t6
on t2.lgp_cst_id=t6.cst_id
left join SJXQ_SJ20250220151_CST_03     t7
on t1.cst_id=t7.cst_id
left join SJXQ_SJ20250220151_CST_03     t8
on t2.lgp_cst_id=t8.cst_id
left join SJXQ_SJ20250220151_CST_01     t9
on T3.rel_cst_id=t9.cst_id
left join SJXQ_SJ20250220151_CST_03     t10
on T3.rel_cst_id=t10.cst_id
left join SJXQ_SJ20250220151_CST_03     t11
on t5.cst_id=t11.cst_id
where t1.dt='@@{yyyyMMdd}'
;
select *
from SJXQ_SJ20250220151_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220151_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220151_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250220151_CST_04
;
/*
*/***陈鹏_SJ20250403166_企业及法人借据明细.sql
﻿-- 导入
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_01
(
    seq         int     COMMENT ''
    ,entp_nm    string  COMMENT ''
    ,lgp_nm     string  COMMENT ''
)
;
insert into SJXQ_SJ20250403166_CST_01
values (1,'浙江台州树时贸易有限公司','王龙'),
    (2,'台州市力安仪贸易有限公司','包力'),
    (3,'台州市椒江三鑫彩色印刷厂','包力'),
    (4,'台州市恒程金属材料有限公司','包力'),
    (5,'台州市黄岩枝亿模具厂','包力'),
    (6,'台州市枝亿模具有限公司','包力'),
    (7,'台州来龙贸易有限公司','蔡银川'),
    (8,'台州市正拓机械有限公司','蔡银川'),
    (9,'温岭研能机电有限公司','陈波'),
    (10,'台州天合消防工程咨询有限公司','陈波'),
    (11,'台州市万犸模钢有限公司','陈精能'),
    (12,'优熙(台州)电子商务有限公司','陈精能'),
    (13,'台州市劳内贸易有限公司','陈精能'),
    (14,'浙江道本贸易有限公司','陈啸犇'),
    (15,'台州市黄岩犇犇模具厂','陈啸犇'),
    (16,'台州市黄岩乾圣模具厂','陈啸犇'),
    (17,'台州市林状贸易有限公司','陈昱霖'),
    (18,'浙江陆行贸易有限公司','陈昱霖'),
    (19,'台州梦远贸易有限公司','高永胜'),
    (20,'台州市贝尚电子商务有限公司','何法定'),
    (21,'台州台利机电有限公司','胡从良'),
    (22,'台州市圆振贸易有限公司','胡从良'),
    (23,'台州立值贸易有限公司','胡伶俐'),
    (24,'台州市黄岩迪旺模具厂','黄晓迪'),
    (25,'台州毅星物流有限公司','郏毅海'),
    (26,'浙江立锦科技有限公司','蒋安'),
    (27,'台州市路桥鼎超二手车经纪有限公司','蒋安'),
    (28,'台州雨洋机电有限公司','蒋安'),
    (29,'台州市黄岩恒天电机有限公司','蒋安'),
    (30,'台州市黄岩安昌模具厂 ','蒋安'),
    (31,'台州市黄岩杰犇模具厂','金鸿杰'),
    (32,'台州市翊强模塑有限公司','金耀廷'),
    (33,'台州市黄岩祥屹模具有限公司','金耀廷'),
    (34,'台州旭瑛贸易有限公司','柯雪萍'),
    (35,'台州雨腾机电有限公司','柯雪萍'),
    (36,'台州市泰猫机电科技有限公司','柯雪萍'),
    (37,'台州市牧羽贸易有限公司','柯雪萍'),
    (38,'台州双贝建筑材料有限公司','李慧'),
    (39,'台州市桑月贸易有限公司','李嘉宝'),
    (40,'合州建瑞机械有限公司','李信'),
    (41,'台州市咸牛机电有限公司','李智仁'),
    (42,'台州海宇建材有限公司','林欣'),
    (43,'台州悦建贸易有限公司','刘岳飞'),
    (44,'台州市展迈贸易有限公司','刘岳飞'),
    (45,'台州慕源贸易有限公司','刘岳飞'),
    (46,'台州椒江阿聪房产中介所','罗本聪'),
    (47,'台州坤凌模塑有限公司','罗本聪'),
    (48,'跃美(台州)电子商务有限公司','罗本聪'),
    (49,'台州市黄岩联益模具厂','罗杰'),
    (50,'台州太度贸易有限公司','罗杰'),
    (51,'台州市罗杰汽车销售有限公司','罗杰'),
    (52,'台州市筱恒贸易有限公司','罗杰'),
    (53,'温岭罗杰二手车经纪有限公司','罗杰'),
    (54,'台州甘悟家具有限公司','潘莹婷'),
    (55,'台州坚铭商贸有限公司','潘莹婷'),
    (56,'台州市莹婷塑模有限公司','潘莹婷'),
    (57,'台州市纵珵金属材料有限公司','潘莹婷'),
    (58,'台州市森语金属制品有限公司','潘莹婷'),
    (59,'台州市龙擎商贸仃限公司','彭章辉'),
    (60,'台州市汐图贸易有限公司','邱灵红'),
    (61,'台州稞以贸易有限公司','邱灵红'),
    (62,'台州仁若贸易有限公司','任爱琪'),
    (63,'台州市烨罡模塑仃限公司','任爱琪'),
    (64,'台歌贸易(台州)有限公司','任爱琪'),
    (65,'台州阿啦蕾贸易有限公司','邵珍菊'),
    (66,'台州市黄岩叶军模具厂','沈泓成'),
    (67,'台州炽科门业科技有限公司','沈泓成'),
    (68,'台州市清滢贸易有限公司','沈泓成'),
    (69,'台州市祥旋贸易有限公司','沈泓成'),
    (70,'温岭晓溪贸易有限公司','沈泓成'),
    (71,'台州黄岩柔溪日用品有限公司','沈灵坤'),
    (72,'台州灵坤贸易有限公司','沈灵坤'),
    (73,'台州市黄岩航拓模具厂','沈灵坤'),
    (74,'台州市车博汽车零部件有限公司','孙晶晶'),
    (75,'台州劲辉机电有限公司','孙鑫'),
    (76,'台州市言玉贸易有限公司','王贝贝'),
    (77,'台州市黄岩承龙模具厂','王龙'),
    (78,'台州福威汽车用品有限公司','王小丽'),
    (79,'台州市黄岩艺绘文具有限责任公司','王小丽'),
    (80,'台州连购商贸有限公司','王一容'),
    (81,'台州焱霖模具有限公司','王一容'),
    (82,'浙江铭泉贸易有限公司','王懿龙'),
    (83,'台州市黄岩伍胜模具厂','伍红兵'),
    (84,'台州利颢贸易有限公司','徐美琴'),
    (85,'浙江昱西贸易有限公司','徐美琴'),
    (86,'台州市灿江模具有限公司','徐美琴'),
    (87,'台州市整恬贸易有限公司','颜巧燕'),
    (88,'台州时陌贸易有限公司','叶子涵'),
    (89,'台州市黄岩宇丞模具厂','叶子涵'),
    (90,'台州市宏尔商贸有限公司','叶子涵'),
    (91,'台州莱责商贸有限公司','叶子涵'),
    (92,'台州市欣顿电子商务有限公司','余磊'),
    (93,'台州纵恒物流有限公司','张恒'),
    (94,'浙江盛洁建材有限公司','张洁'),
    (95,'台州市樱爱美容服务有限公司','张樱子'),
    (96,'温岭恒先贸易有限公司','郑荣君'),
    (97,'温岭鲸越贸易有限公司','郑荣君'),
    (98,'台州科盟贸易有限公司','郑荣君')
;
--公司
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_02 AS
select t1.seq,t1.entp_nm,t1.lgp_nm as lgp_nm2
    ,t2.cst_id
    ,t3.lgp_cst_id                               --对公客户法人客户号
	,t3.lgp_nm                                   --对公客户法人客户名称
from SJXQ_SJ20250403166_CST_01          t1
inner join edw.dim_cst_entp_bas_inf_dd	t2 --企业客户基本信息	3	cst_nm	string	客户名称|C200
on t1.entp_nm=t2.cst_nm
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_entp_lgp_inf_dd   t3 --对公客户法人信息表 667556 cst_id 唯一
on t2.cst_id=t3.cst_id
and t3.dt=t2.dt
;
-- 法人
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_03 AS
select t1.entp_nm,t1.lgp_nm
    ,t2.cst_id
from SJXQ_SJ20250403166_CST_01          t1
inner join edw.dws_cst_idv_bas_inf_dd	t2 --个人客户基本信息汇总表
on t1.lgp_nm=t2.cst_chn_nm
and t1.entp_nm=t2.job_unt_nm	--工作单位名称
and t2.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_03_1 AS
select t1.entp_nm,t1.lgp_nm
    ,t2.cst_id,t2.job_unt_nm
from SJXQ_SJ20250403166_CST_01          t1
inner join edw.dws_cst_idv_bas_inf_dd	t2 --个人客户基本信息汇总表
on t1.lgp_nm=t2.cst_chn_nm
and nvl(t2.job_unt_nm,'')<>''
and t2.dt='@@{yyyyMMdd}'
where t2.cst_id not in(
    Select cst_id from SJXQ_SJ20250403166_CST_03
)
;
-- 同一风险控制号下我行授信总额（授信还在有效期）
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_04 AS
SELECT  le.cst_id
        ,SUM(FACL_LMT)  AS 客户授信总额
FROM edw.loan_lmt_exmp      le
INNER JOIN edw.loan_cst_bsc cb
ON le.CST_ID = cb.CST_ID
AND cb.DT = '@@{yyyyMMdd}'
WHERE le.DEL_IND = '0'
AND ( EXISTS (
SELECT  1
FROM edw.loan_lmt_use_rslt_rcd u
WHERE u.SPLT_LMT_NO = le.SPLT_LMT_NO
AND INI_OCP_FACL_AMT > ALRY_RSM_FACL_LMT
AND OCP_STS = '1'
AND U.DT = '@@{yyyyMMdd}' ) OR le.LMT_STS IN ( '01' , '02' ) ) AND LE.DT = '@@{yyyyMMdd}'
GROUP BY  le.cst_id
;
--担保方式
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_05 AS
SELECT  a.ctr_serno,a.prcp_setl_dt
       ,a.grnt_mod_colc
FROM
(
	SELECT  ctr_serno
        ,prcp_setl_dt	--	本金结清日期|c8
        ,grnt_mod_colc
        ,grnt_mod_colc2
	FROM edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc as grnt_mod_colc2
	WHERE dt = '@@{yyyyMMdd}'
	AND nvl(grnt_mod_colc,'')<>''
) a
LEFT JOIN edw.dwd_code_library_dd b --码值表
ON a.grnt_mod_colc2 = b.cd_val
AND b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND b.fld_nm = 'GRNT_MOD_CD'
AND b.DT = '@@{yyyyMMdd}'
GROUP BY  a.ctr_serno,a.prcp_setl_dt
         ,a.grnt_mod_colc
;
-- 输出结果1 对公客户
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_06 AS
SELECT  t1.seq as 序号
    ,t1.entp_nm as 企业名称
       ,t1.cst_id                                 AS 企业客户号
       ,t1.lgp_nm2 as 法定代表人
       ,t2.客户授信总额
       ,t3.acs_org_nm                             AS 考核机构名称
       ,t3.cst_mngr_nm                            AS 管护客户经理名称
       ,t9.org_nm                                 AS 主管户机构
       ,t8.prm_mgr_nm                             AS 主管户客户经理
       ,t3.dbil_id                                AS 借据编号
       ,nvl(t4.empe_nm,t3.opr_empe_id)            AS 经办人
       ,t5.org_nm                                 AS 经办机构
       ,t3.amt                                    AS 发放金额
       ,t3.amt * c1.cny_exr                       AS 发放金额_折人民币
       ,t3.dtrb_dt                                AS 发放日期
       ,t3.apnt_mtu_day                           AS 约定到期日期
       ,t3.loan_usg_cd                            AS 贷款用途代码
       ,c2.cd_val_dscr                            AS 贷款用途
       ,t6.grnt_mod_nm                            AS 担保方式
       ,t3.ctr_amt                                AS 合同金额
       ,t3.prcp_bal                               AS 本金余额
       ,t3.prcp_bal * c1.cny_exr                  AS 本金余额_折人民币
       ,t3.end_dt                                 AS 终结日期
       ,t6.prcp_setl_dt	as 本金结清日期
       ,t3.ovd_amt                                AS 逾期金额
       ,t3.ovd_amt * c1.cny_exr                   AS 逾期金额_折人民币
       ,t3.ibs_ovd_intr_bal + t3.obs_ovd_intr_bal AS 逾期利息
       ,t3.obs_ovd_intr_bal                       AS 表外欠息余额
       ,t3.ovd_day                                AS 逾期天数
       ,t3.ovd_dt                                 AS 本金逾期日期
       ,t3.ovd_intr_dt                            AS 利息逾期日期
       ,t3.five_ctg_cd                            AS 五级分类代码
       ,c3.cd_val_dscr                            AS 五级分类
       ,t7.ctr_bal                                AS 承兑余额
from SJXQ_SJ20250403166_CST_02              t1
left join SJXQ_SJ20250403166_CST_04         t2
on t1.cst_id=t2.cst_id
left join edw.dws_bus_loan_dbil_inf_dd      t3 --贷款借据信息汇总
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t3.opr_empe_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.opr_org_id=t5.org_id
and t5.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	c1 --汇率信息
ON  T3.ccy_cd = c1.ccy_cd
AND c1.DT ='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd        c2 -- 码值表
ON  T3.loan_usg_cd = c2.cd_val
AND c2.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND c2.fld_nm = 'LOAN_USG_CD'
AND c2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd        c3 -- 码值表
ON  T3.FIVE_CTG_CD = c3.cd_val
AND c3.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND c3.fld_nm = 'FIVE_CTG_CD'
AND c3.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ20250403166_CST_05     t6
on t3.bus_ctr_id=t6.ctr_serno
left join app_ado.FCT_ACC_BAL_LST       t7 --承兑余额清单
on t3.bus_ctr_id=t7.bus_ctr_id
and t7.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t8 --客户`主管户`信息
on  t1.cst_id = t8.cst_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t8.prm_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
;
-- 输出结果2 法人
DROP   TABLE IF     EXISTS SJXQ_SJ20250403166_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250403166_CST_07 AS
SELECT  t1.entp_nm as 企业名称
       ,t1.cst_id                                 AS 法人客户号
       ,t1.lgp_nm                                 AS 法人名称
       ,t2.客户授信总额
       ,t3.acs_org_nm                             AS 考核机构名称
       ,t3.cst_mngr_nm                            AS 管护客户经理名称
       ,t9.org_nm                                 AS 主管户机构
       ,t8.prm_mgr_nm                             AS 主管户客户经理
       ,t3.dbil_id                                AS 借据编号
       ,t4.empe_nm                                AS 经办人
       ,t5.org_nm                                 AS 经办机构
       ,t3.amt                                    AS 发放金额
       ,t3.amt * c1.cny_exr                       AS 发放金额_折人民币
       ,t3.dtrb_dt                                AS 发放日期
       ,t3.apnt_mtu_day                           AS 约定到期日期
       ,t3.loan_usg_cd                            AS 贷款用途代码
       ,c2.cd_val_dscr                            AS 贷款用途
       ,t6.grnt_mod_nm                            AS 担保方式
       ,t3.ctr_amt                                AS 合同金额
       ,t3.prcp_bal                               AS 本金余额
       ,t3.prcp_bal * c1.cny_exr                  AS 本金余额_折人民币
       ,t3.end_dt                                 AS 终结日期
       ,t6.prcp_setl_dt                           AS 本金结清日期
       ,t3.ovd_amt                                AS 逾期金额
       ,t3.ovd_amt * c1.cny_exr                   AS 逾期金额_折人民币
       ,t3.ibs_ovd_intr_bal + t3.obs_ovd_intr_bal AS 逾期利息
       ,t3.obs_ovd_intr_bal                       AS 表外欠息余额
       ,t3.ovd_day                                AS 逾期天数
       ,t3.ovd_dt                                 AS 本金逾期日期
       ,t3.ovd_intr_dt                            AS 利息逾期日期
       ,t3.five_ctg_cd                            AS 五级分类代码
       ,c3.cd_val_dscr                            AS 五级分类
       ,t7.ctr_bal                                AS 承兑余额
from SJXQ_SJ20250403166_CST_03              t1
left join SJXQ_SJ20250403166_CST_04         t2
on t1.cst_id=t2.cst_id
left join edw.dws_bus_loan_dbil_inf_dd      t3 --贷款借据信息汇总
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t3.opr_empe_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.opr_org_id=t5.org_id
and t5.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd 	c1 --汇率信息
ON  T3.ccy_cd = c1.ccy_cd
AND c1.DT ='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd        c2 -- 码值表
ON  T3.loan_usg_cd = c2.cd_val
AND c2.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND c2.fld_nm = 'LOAN_USG_CD'
AND c2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd        c3 -- 码值表
ON  T3.FIVE_CTG_CD = c3.cd_val
AND c3.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND c3.fld_nm = 'FIVE_CTG_CD'
AND c3.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ20250403166_CST_05     t6
on t3.bus_ctr_id=t6.ctr_serno
left join app_ado.FCT_ACC_BAL_LST       t7 --承兑余额清单
on t3.bus_ctr_id=t7.bus_ctr_id
and t7.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t8 --客户`主管户`信息
on  t1.cst_id = t8.cst_id
and t8.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t9 --考核机构树
on  t8.prm_org_id = t9.org_id
and t9.dt = '@@{yyyyMMdd}'
;
SElECT '01' seq, count(distinct entp_nm) cnt,count(distinct lgp_nm) custs
from SJXQ_SJ20250403166_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250403166_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250403166_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250403166_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20250403166_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 借据编号) custs
from SJXQ_SJ20250403166_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 借据编号) custs
from SJXQ_SJ20250403166_CST_07
;
/*
01	98	47
02	31	31
03	9	9
05	7610471	7610471
06	35	5
07	134	7
*/
SELECT t1.*,t2.cst_id,t2.lgp_cst_id
,t2.lgp_nm  as dws_lgp_nm
,t3.cst_id as 法人客户号
from SJXQ_SJ20250403166_CST_01 t1
left join SJXQ_SJ20250403166_CST_02 t2
on t1.entp_nm=t2.entp_nm
left join SJXQ_SJ20250403166_CST_03 t3
on t1.entp_nm=t3.entp_nm
ORDER BY t1.seq
***陈鹏_SJ20250425146_台州分行人行评级数据.sql
﻿--陈鹏006986-央行评级
--台州分行
--SJ20250425146
-- 借据号	合同号	&quot;贷款业务种类（例如：11流动资金贷款）&quot;	贷款本金	*担保方式（0:信用；1:保证；2:质押；3:抵押）	年利率	贷款发放日	贷款到期日
-- *最近一次实际还款日期	贷款剩余本金	&quot;贷款状态（10:正常；11:结清）&quot;	绿色信贷（1:是；2:否） 	五级分类（1:正常；2:关注；3:次级；4:可疑；5:损失）
--临时表1 截止20250427有余额的企业信贷信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01 AS
SELECT  t1.DBIL_ID     AS 借据编号
    ,t1.CTR_SERNO      AS 合同流水号
    ,t1.PRD_NO         AS 产品代码
    ,t3.PD_NM          AS 产品名称
    ,t1.AMT            AS 借据金额
    ,t1.EXEC_INTR_RAT  AS 执行利率
    ,t1.LVE_ACT_BGN_DT AS 出账起始日期
    ,t1.APNT_MTU_DT    AS 约定到期日
    ,t1.MTU_DT         AS 到期日期
    ,t1.PRCP_BAL       AS 本金余额
    ,t1.DBIL_STS_CD    AS 借据状态代码
    ,mz_jj.cd_val_dscr AS 借据状态
    ,t1.FCLS_RSLT_CD   AS 五级分类结果代码 --&quot;1-正常2-关注3-次级4-可疑5-损失&quot;
    ,CASE
        WHEN t1.FCLS_RSLT_CD IN ( '01' , '02' , '03' , '04' , '05' , '06' ) THEN '正常'
        WHEN t1.FCLS_RSLT_CD IN ( '07' , '08' )                             THEN '关注'
        WHEN t1.FCLS_RSLT_CD IN ( '09' , '10' )                             THEN '次级'
        WHEN t1.FCLS_RSLT_CD IN ( '11' )                                    THEN '可疑'
        WHEN t1.FCLS_RSLT_CD IN ( '12' )                                    THEN '损失'
        END               AS 五级分类结果
    --,t2.CTR_SERNO      AS 合同流水号
    --,t2.REL_SERNO      AS 用信申请流水号
    ,t2.CST_ID         AS 客户号
    ,t2.CST_NM         AS 客户名称
    ,t2.GRN_LOAN_IND   AS 属于绿色信贷标志
    ,t2.ctr_bal        AS 合同余额
    ,t2.grnt_mod_colc  AS 担保方式集合
    ,gh.ln_org_id      AS 信贷归属机构
    ,gh.ln_org_nm      AS 信贷归属机构名称
    ,t5.上次还款日期
FROM    edw.DIM_BUS_LOAN_DBIL_INF_DD            t1
INNER JOIN    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD   t2
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '20250427'
LEFT JOIN    edw.dwd_code_library_dd mz_jj
ON      t1.DBIL_STS_CD = mz_jj.cd_val
AND     mz_jj.dt = '20250427'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD t3
ON      t1.PRD_NO = t3.PRD_NO
AND     t3.dt = '20250427'
INNER JOIN    adm_pub.adm_csm_cbas_mng_inf_dd gh
ON      t2.cst_id = gh.cst_id
AND     gh.dt = '20250427'
AND     gh.ln_org_id LIKE '3301%'   --台州分行
INNER JOIN  edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      t2.cst_id = T4.cst_id
AND     T4.CST_TYP_CD = '2'
AND     T4.dt = '20250427'
left join (
        SELECT  DBIL_ID
                ,Max(last_rpay_dt) AS 上次还款日期
        FROM    EDW.DWD_BUS_LOAN_TRM_PMT_INF_DD  A1  --贷款期供信息
        WHERE   DT = '20250427'
        GROUP BY DBIL_ID
)t5 on t1.DBIL_ID=t5.DBIL_ID
WHERE   t1.dt = '20250427'
AND     t1.PRCP_BAL > 0
;
--临时表2 企业出资信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 AS
SELECT  A1.csld_crd_cd                                                             AS 统一社会信用代码
        ,A1.cst_id                                                                 AS 客户号
        ,A1.shh_nm                                                                 AS 股东名称
        ,A1.shh_typ                                                                AS 股东类型
        ,A1.ctrb_rto                                                               AS 出资比例
        ,A1.idv_id_no                                                              AS 个人标识码
        ,A1.ctrb_ccy                                                               AS 认缴出资币种
        ,A1.ctrb_amt                                                               AS 认缴出资额
        ,CASE
           WHEN A2.doc_nbr IS NOT NULL     THEN '身份证'
           WHEN A3.csld_crd_cd IS NOT NULL THEN '统一社会信用代码'
         END                                                                       AS 证件类型
        ,COALESCE(A2.doc_nbr, A3.csld_crd_cd)                                      AS 证件号码
        ,ROW_NUMBER() OVER ( PARTITION BY A1.csld_crd_cd ORDER BY A1.ctrb_rto DESC ) AS RN
FROM    (
            SELECT  csld_crd_cd --统一社会信用代码
			        ,cst_id
                    ,shh_nm --股东名称
                    ,shh_typ --股东类型
                    ,ctrb_rto --出资比例
                    ,idv_id_no --个人标识码
                    ,ctrb_ccy --认缴出资币种
                    ,ctrb_amt --认缴出资额
                    ,RANK() OVER ( PARTITION BY csld_crd_cd ORDER BY qry_tm DESC ) AS RN
            FROM    edw.dim_cst_out_geb_shh_inf_dd --工商企业股东及出资信息
            WHERE   DT = '20250331'
        ) A1
LEFT JOIN    (
                 SELECT  ppl_id --人员标识码
                         ,cst_nm --被查询人姓名
                         ,doc_nbr --被查询人证件号码
                         ,ROW_NUMBER() OVER ( PARTITION BY ppl_id,cst_nm ORDER BY qry_tm DESC ) AS RN
                 FROM    edw.dwd_cst_out_geb_idv_qry_inf_dd --工商个人查询信息
                 WHERE   DT = '20250427'
             ) A2
ON      A1.idv_id_no = A2.ppl_id
AND     A1.shh_nm = A2.cst_nm
AND     A2.RN = 1
LEFT JOIN    (
                 SELECT  cst_nm --客户名称
                         ,csld_crd_cd --统一信用代码
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_nm ORDER BY qry_tm DESC ) AS RN
                 FROM    edw.dim_cst_out_geb_bas_inf_dd --工商查询企业基本信息
                 WHERE   DT = '20250427'
             ) A3
ON      A1.shh_nm = A3.cst_nm
AND     A3.RN = 1
WHERE   A1.RN = 1  --取查询日期最新的
;
--临时表3 企业基本信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_03 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_03 AS
SELECT  T1.客户号
        ,T2.cst_chn_nm       AS 企业名称
        ,T2.doc_nbr          AS 统一社会信用代码
        ,T4.ful_adr          AS 登记注册地址
        ,T4.cnr_lvl_id_cd    AS 登记地行政区划代码
        ,T3.org_org_found_dt AS 成立日期
        ,T3.opr_scp_dscr     AS 业务范围
        ,T3.idt_ctg_cd       AS 行业分类代码
        ,T5.cd_val_dscr      AS 行业分类
        ,T3.ENTP_ECN_TYP_CD  AS 企业经济类型代码
        ,T6.cd_val_dscr      AS 企业经济类型
        ,CASE
           WHEN T7.主营业务变更情况 = '1' THEN '是'
           WHEN T7.主营业务变更情况 = '0' THEN '否'
         END                 AS 主营业务变更情况
        ,CASE
           WHEN T7.近一年主要人员是否发生变更 = '1' THEN '是'
           WHEN T7.近一年主要人员是否发生变更 = '0' THEN '否'
         END                 AS 近一年主要人员是否发生变动
        ,T8.近三年的欠税条数
        ,T3.emp_nbr          AS 从业人员数量
        ,CASE
           WHEN T4.cnr_lvl_id_cd RLIKE '县' THEN '是'
           ELSE '否'
         END                 AS 是否县域企业
        ,CASE
           WHEN T3.fm_ind = '1' THEN '是'
           ELSE '否'
         END                 AS 是否涉农企业
        ,T3.reg_cpt_ccy_cd   AS 注册资本币种代码
        ,T3.reg_cpt          AS 注册资本
FROM    (
            SELECT  DISTINCT 客户号
            FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01
        ) T1
INNER JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '20250427'
LEFT JOIN    edw.dim_cst_entp_bas_inf_dd T3 --企业客户基本信息
ON      T1.客户号 = T3.cst_id
AND     T3.DT = '20250427'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.ful_adr
                         ,A1.cnr_lvl_id_cd
                         ,A2.cd_val_dscr
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id , A1.phy_adr_typ_cd ORDER BY A1.upd_dt DESC ) AS RN
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd A1 --客户物理地址信息
                 LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表
                 ON      A1.cnr_lvl_id_cd = A2.cd_val
                 AND     A2.tbl_nm = 'CUSTOMER_ADDRESS'
                 AND     A2.fld_nm = 'CITY'
                 AND     A2.DT = '20250427'
                 WHERE   A1.DT = '20250427'
                 AND     A1.phy_adr_typ_cd = '050800'
             ) T4
ON      T1.客户号 = T4.cst_id
AND     T4.RN = 1
LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表
ON      T3.idt_ctg_cd = T5.cd_val
AND     T5.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T5.fld_nm = 'IDT_CTG_CD'
AND     T5.DT = '20250427'
LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表
ON      T3.ENTP_ECN_TYP_CD = T6.cd_val
AND     T6.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T6.fld_nm = 'ENTP_ECN_TYP_CD'
AND     T6.DT = '20250427'
LEFT JOIN    (
                 SELECT  B1.cst_id
                         ,MAX(CASE
                                WHEN B1.mdt_desc RLIKE '主营' THEN '1'
                                ELSE '0'
                              END) AS 主营业务变更情况
                         ,MAX(CASE
                                WHEN B1.mdt_desc RLIKE '主要成员|主要人员' AND B1.mdf_dt >= '20240427' THEN '1'
                                ELSE '0'
                              END) AS 近一年主要人员是否发生变更
                 FROM    (
                             SELECT  A1 . *
                                     ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.qry_tm DESC ) AS RN
                             FROM    edw.dim_cst_out_geb_mdf_inf_dd A1 --工商企业变更信息
                             WHERE   A1.DT = '20250427'
                             AND     A1.cst_id <> ''
                         ) B1
                 WHERE   B1.RN = 1
                 GROUP BY B1.cst_id
             ) T7
ON      T1.客户号 = T7.cst_id
LEFT JOIN    (
                 SELECT  B1.cst_id
                         ,COUNT(DISTINCT B1.hpn_dt) AS 近三年的欠税条数
                 FROM    (
                             SELECT  A1 . *
                                     ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.late_qry_tm DESC ) AS RN
                             FROM    edw.dim_cst_out_cort_tax_arer_inf_dd A1 --法院查询欠税信息
                             WHERE   A1.DT = '20250427'
                             AND     A1.cst_id <> ''
                         ) B1
                 WHERE   B1.RN = 1
                 AND     SUBSTR(REPLACE(B1.hpn_dt, '-', ''), 1, 8) >= '20220427'
                 GROUP BY B1.cst_id
             ) T8
ON      T1.客户号 = T8.cst_id ;
--临时表4 主要负责人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_04 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_04 AS
SELECT  T1.客户号
        ,T3.CST_CHN_NM                                                                                                             AS 主要负责人名称
        ,T4.cd_val_dscr                                                                                                            AS 主要负责人身份标识类型
        ,T3.DOC_NBR                                                                                                                AS 主要负责人身份标识号码
        ,T3.REG_ADR                                                                                                                AS 主要负责人户籍情况
        ,T5.cd_val_dscr                                                                                                            AS 主要负责人学历情况
FROM    (
            SELECT  DISTINCT 客户号
            FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01
        ) T1
LEFT JOIN    edw.loan_cst_rel T2 --客户关联信息
ON      T1.客户号 = T2.cst_id
AND     T2.rel_typ_cd = '0109' --实际控制人
AND     T2.DT = '20250427'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T2.rel_cst_id= T3.cst_id
AND     T3.DT = '20250427'
LEFT JOIN    edw.dwd_code_library_dd T4 -- 码值表
ON      T3.DOC_TYP_CD = T4.cd_val
AND     T4.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T4.fld_nm = 'DOC_TYP_CD'
AND     T4.DT = '20250427'
LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表
ON      T3.HI_ACDM_DEG_CD = T5.cd_val
AND     T5.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
AND     T5.fld_nm = 'HI_ACDM_DEG_CD'
AND     T5.DT = '20250427';
--结果表1  客户信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_KHXX PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_KHXX AS
SELECT  T1.客户号
        ,T1.企业名称
        ,T1.统一社会信用代码
        ,T1.登记注册地址
        ,T1.登记地行政区划代码
        ,T1.成立日期
        ,T1.业务范围
        ,T1.行业分类代码
        ,T1.行业分类
        ,T1.企业经济类型代码
        ,T1.企业经济类型
        ,T1.主营业务变更情况
        ,T1.近一年主要人员是否发生变动
        ,T1.近三年的欠税条数
        ,T1.从业人员数量
        ,T1.是否县域企业
        ,T1.是否涉农企业
        ,T1.注册资本币种代码
        ,T1.注册资本
        ,T2.主要负责人名称
        ,T2.主要负责人身份标识类型
        ,T2.主要负责人身份标识号码
        ,T2.主要负责人户籍情况
        ,T2.主要负责人学历情况
        ,T2.主要负责人在本单位从业年限
        ,T3.借据编号
        ,T3.合同流水号
        ,T3.产品代码
        ,T3.产品名称
        ,T3.借据金额
        ,T3.执行利率
        ,T3.出账起始日期
        ,T3.约定到期日
        ,T3.到期日期
        ,t3.上次还款日期
        ,T3.本金余额
        ,T3.借据状态代码
        ,T3.借据状态
        ,T3.五级分类结果代码
        ,T3.五级分类结果
        ,T3.属于绿色信贷标志
        ,T3.合同余额
        ,T3.担保方式集合
        ,T3.信贷归属机构
        ,T3.信贷归属机构名称
        ,T41.股东名称 AS 出资人1名称
        ,T41.股东类型 AS 出资人1类型
        ,T41.出资比例 AS 出资人1比例
        ,T41.证件类型 AS 出资人1证件类型
        ,T41.证件号码 AS 出资人1证件号码
        ,T42.股东名称 AS 出资人2名称
        ,T42.股东类型 AS 出资人2类型
        ,T42.出资比例 AS 出资人2比例
        ,T42.证件类型 AS 出资人2证件类型
        ,T42.证件号码 AS 出资人2证件号码
        ,T43.股东名称 AS 出资人3名称
        ,T43.股东类型 AS 出资人3类型
        ,T43.出资比例 AS 出资人3比例
        ,T43.证件类型 AS 出资人3证件类型
        ,T43.证件号码 AS 出资人3证件号码
        ,T44.股东名称 AS 出资人4名称
        ,T44.股东类型 AS 出资人4类型
        ,T44.出资比例 AS 出资人4比例
        ,T44.证件类型 AS 出资人4证件类型
        ,T44.证件号码 AS 出资人4证件号码
        ,T45.股东名称 AS 出资人5名称
        ,T45.股东类型 AS 出资人5类型
        ,T45.出资比例 AS 出资人5比例
        ,T45.证件类型 AS 出资人5证件类型
        ,T45.证件号码 AS 出资人5证件号码
        ,T46.股东名称 AS 出资人6名称
        ,T46.股东类型 AS 出资人6类型
        ,T46.出资比例 AS 出资人6比例
        ,T46.证件类型 AS 出资人6证件类型
        ,T46.证件号码 AS 出资人6证件号码
FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_03 T1
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_04 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01 T3
ON      T1.客户号 = T3.客户号
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 T41
ON      T1.客户号 = T41.客户号
AND     T41.RN = 1
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 T42
ON      T1.客户号 = T42.客户号
AND     T42.RN = 2
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 T43
ON      T1.客户号 = T43.客户号
AND     T43.RN = 3
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 T44
ON      T1.客户号 = T44.客户号
AND     T44.RN = 4
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 T45
ON      T1.客户号 = T45.客户号
AND     T45.RN = 5
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_02 T46
ON      T1.客户号 = T46.客户号
AND     T46.RN = 6;
-- 输出结果
select *
from lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_KHXX
limit 100
;
--1.临时表一 资产负债表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_01 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_01 AS
SELECT       T.reportno		 AS 报表编号
			 ,T.objectno	 AS 客户号
             ,T.reportdate	 AS 报表期次
-----------------------	资产负债表（资产）
			 ,MAX(CASE WHEN T1.rowsubject='101' THEN T1.col1value END)  AS 期初值_货币资金
		     ,MAX(CASE WHEN T1.rowsubject='101' THEN T1.col2value END)  AS 期末值_货币资金
			 ,MAX(CASE WHEN T1.rowsubject='102' THEN T1.col1value END)  AS 期初值_短期投资
		     ,MAX(CASE WHEN T1.rowsubject='102' THEN T1.col2value END)  AS 期末值_短期投资
			 ,MAX(CASE WHEN T1.rowsubject='103' THEN T1.col1value END)  AS 期初值_应收票据
		     ,MAX(CASE WHEN T1.rowsubject='103' THEN T1.col2value END)  AS 期末值_应收票据
			 ,MAX(CASE WHEN T1.rowsubject='104' THEN T1.col1value END)  AS 期初值_应收帐款
		     ,MAX(CASE WHEN T1.rowsubject='104' THEN T1.col2value END)  AS 期末值_应收帐款
			 ,MAX(CASE WHEN T1.rowsubject='105' THEN T1.col1value END)  AS 期初值_减_坏帐准备
		     ,MAX(CASE WHEN T1.rowsubject='105' THEN T1.col2value END)  AS 期末值_减_坏帐准备
			 ,MAX(CASE WHEN T1.rowsubject='106' THEN T1.col1value END)  AS 期初值_应收帐款净额
		     ,MAX(CASE WHEN T1.rowsubject='106' THEN T1.col2value END)  AS 期末值_应收帐款净额
			 ,MAX(CASE WHEN T1.rowsubject='107' THEN T1.col1value END)  AS 期初值_预付货款
		     ,MAX(CASE WHEN T1.rowsubject='107' THEN T1.col2value END)  AS 期末值_预付货款
			 ,MAX(CASE WHEN T1.rowsubject='108' THEN T1.col1value END)  AS 期初值_其它应收款
		     ,MAX(CASE WHEN T1.rowsubject='108' THEN T1.col2value END)  AS 期末值_其它应收款
			 ,MAX(CASE WHEN T1.rowsubject='134' THEN T1.col1value END)  AS 期初值_应收股利
		     ,MAX(CASE WHEN T1.rowsubject='134' THEN T1.col2value END)  AS 期末值_应收股利
			 ,MAX(CASE WHEN T1.rowsubject='19c' THEN T1.col1value END)  AS 期初值_应收利息
		     ,MAX(CASE WHEN T1.rowsubject='19c' THEN T1.col2value END)  AS 期末值_应收利息
			 ,MAX(CASE WHEN T1.rowsubject='10806' THEN T1.col1value END)  AS 期初值_应收补贴款
		     ,MAX(CASE WHEN T1.rowsubject='10806' THEN T1.col2value END)  AS 期末值_应收补贴款
			 ,MAX(CASE WHEN T1.rowsubject='110' THEN T1.col1value END)  AS 期初值_存货
		     ,MAX(CASE WHEN T1.rowsubject='110' THEN T1.col2value END)  AS 期末值_存货
			 ,MAX(CASE WHEN T1.rowsubject='111' THEN T1.col1value END)  AS 期初值_减_存货跌价准备
		     ,MAX(CASE WHEN T1.rowsubject='111' THEN T1.col2value END)  AS 期末值_减_存货跌价准备
			 ,MAX(CASE WHEN T1.rowsubject='112' THEN T1.col1value END)  AS 期初值_存货净额
		     ,MAX(CASE WHEN T1.rowsubject='112' THEN T1.col2value END)  AS 期末值_存货净额
			 ,MAX(CASE WHEN T1.rowsubject='109' THEN T1.col1value END)  AS 期初值_待摊费用
		     ,MAX(CASE WHEN T1.rowsubject='109' THEN T1.col2value END)  AS 期末值_待摊费用
			 ,MAX(CASE WHEN T1.rowsubject='114' THEN T1.col1value END)  AS 期初值_一年内到期的长期债券投资
		     ,MAX(CASE WHEN T1.rowsubject='114' THEN T1.col2value END)  AS 期末值_一年内到期的长期债券投资
			 ,MAX(CASE WHEN T1.rowsubject='115' THEN T1.col1value END)  AS 期初值_其它流动资产
		     ,MAX(CASE WHEN T1.rowsubject='115' THEN T1.col2value END)  AS 期末值_其它流动资产
			 ,MAX(CASE WHEN T1.rowsubject='801' THEN T1.col1value END)  AS 期初值_流动资产合计
		     ,MAX(CASE WHEN T1.rowsubject='801' THEN T1.col2value END)  AS 期末值_流动资产合计
			 ,MAX(CASE WHEN T1.rowsubject='116' THEN T1.col1value END)  AS 期初值_长期债权投资
		     ,MAX(CASE WHEN T1.rowsubject='116' THEN T1.col2value END)  AS 期末值_长期债权投资
			 ,MAX(CASE WHEN T1.rowsubject='197' THEN T1.col1value END)  AS 期初值_长期股权投资
		     ,MAX(CASE WHEN T1.rowsubject='197' THEN T1.col2value END)  AS 期末值_长期股权投资
			 ,MAX(CASE WHEN T1.rowsubject='815' THEN T1.col1value END)  AS 期初值_长期投资合计
		     ,MAX(CASE WHEN T1.rowsubject='815' THEN T1.col2value END)  AS 期末值_长期投资合计
			 ,MAX(CASE WHEN T1.rowsubject='117' THEN T1.col1value END)  AS 期初值_固定资产原价
		     ,MAX(CASE WHEN T1.rowsubject='117' THEN T1.col2value END)  AS 期末值_固定资产原价
			 ,MAX(CASE WHEN T1.rowsubject='118' THEN T1.col1value END)  AS 期初值_减_累计折旧
		     ,MAX(CASE WHEN T1.rowsubject='118' THEN T1.col2value END)  AS 期末值_减_累计折旧
			 ,MAX(CASE WHEN T1.rowsubject='119' THEN T1.col1value END)  AS 期初值_固定资产净值
		     ,MAX(CASE WHEN T1.rowsubject='119' THEN T1.col2value END)  AS 期末值_固定资产净值
			 ,MAX(CASE WHEN T1.rowsubject='128' THEN T1.col1value END)  AS 期初值_减_固定资产减值准备
		     ,MAX(CASE WHEN T1.rowsubject='128' THEN T1.col2value END)  AS 期末值_减_固定资产减值准备
			 ,MAX(CASE WHEN T1.rowsubject='j19' THEN T1.col1value END)  AS 期初值_固定资产净额
		     ,MAX(CASE WHEN T1.rowsubject='j19' THEN T1.col2value END)  AS 期末值_固定资产净额
			 ,MAX(CASE WHEN T1.rowsubject='121' THEN T1.col1value END)  AS 期初值_固定资产清理
		     ,MAX(CASE WHEN T1.rowsubject='121' THEN T1.col2value END)  AS 期末值_固定资产清理
			 ,MAX(CASE WHEN T1.rowsubject='120' THEN T1.col1value END)  AS 期初值_在建工程
		     ,MAX(CASE WHEN T1.rowsubject='120' THEN T1.col2value END)  AS 期末值_在建工程
			 ,MAX(CASE WHEN T1.rowsubject='19a' THEN T1.col1value END)  AS 期初值_在建工程减值准备
		     ,MAX(CASE WHEN T1.rowsubject='19a' THEN T1.col2value END)  AS 期末值_在建工程减值准备
			 ,MAX(CASE WHEN T1.rowsubject='802' THEN T1.col1value END)  AS 期初值_固定资产合计
		     ,MAX(CASE WHEN T1.rowsubject='802' THEN T1.col2value END)  AS 期末值_固定资产合计
		     ,MAX(CASE WHEN T1.rowsubject='123' THEN T1.col1value END)  AS 期初值_无形资产
		     ,MAX(CASE WHEN T1.rowsubject='123' THEN T1.col2value END)  AS 期末值_无形资产
			 ,MAX(CASE WHEN T1.rowsubject='199' THEN T1.col1value END)  AS 期初值_无形资产减值准备
		     ,MAX(CASE WHEN T1.rowsubject='199' THEN T1.col2value END)  AS 期末值_无形资产减值准备
			 ,MAX(CASE WHEN T1.rowsubject='124' THEN T1.col1value END)  AS 期初值_递延资产
		     ,MAX(CASE WHEN T1.rowsubject='124' THEN T1.col2value END)  AS 期末值_递延资产
			 ,MAX(CASE WHEN T1.rowsubject='803' THEN T1.col1value END)  AS 期初值_无形及递延资产合计
		     ,MAX(CASE WHEN T1.rowsubject='803' THEN T1.col2value END)  AS 期末值_无形及递延资产合计
			 ,MAX(CASE WHEN T1.rowsubject='125' THEN T1.col1value END)  AS 期初值_其它长期资产
		     ,MAX(CASE WHEN T1.rowsubject='125' THEN T1.col2value END)  AS 期末值_其它长期资产
			 ,MAX(CASE WHEN T1.rowsubject='181' THEN T1.col1value END)  AS 期初值_长期待摊费用
		     ,MAX(CASE WHEN T1.rowsubject='181' THEN T1.col2value END)  AS 期末值_长期待摊费用
			 ,MAX(CASE WHEN T1.rowsubject='126' THEN T1.col1value END)  AS 期初值_递延税款借项
		     ,MAX(CASE WHEN T1.rowsubject='126' THEN T1.col2value END)  AS 期末值_递延税款借项
			 ,MAX(CASE WHEN T1.rowsubject='804' THEN T1.col1value END)  AS 期初值_资产总计
		     ,MAX(CASE WHEN T1.rowsubject='804' THEN T1.col2value END)  AS 期末值_资产总计
			 ,MAX(CASE WHEN T1.rowsubject='278' THEN T1.col1value END)  AS 期初值_潜亏
		     ,MAX(CASE WHEN T1.rowsubject='278' THEN T1.col2value END)  AS 期末值_潜亏
-----------------------
-----------------------	资产负债表（负债及所有者权益）
			 ,MAX(CASE WHEN T1.rowsubject='201' THEN T1.col1value END)  AS 期初值_短期借款
		     ,MAX(CASE WHEN T1.rowsubject='201' THEN T1.col2value END)  AS 期末值_短期借款
			 ,MAX(CASE WHEN T1.rowsubject='202' THEN T1.col1value END)  AS 期初值_应付票据
		     ,MAX(CASE WHEN T1.rowsubject='202' THEN T1.col2value END)  AS 期末值_应付票据
			 ,MAX(CASE WHEN T1.rowsubject='203' THEN T1.col1value END)  AS 期初值_应付帐款
		     ,MAX(CASE WHEN T1.rowsubject='203' THEN T1.col2value END)  AS 期末值_应付帐款
			 ,MAX(CASE WHEN T1.rowsubject='204' THEN T1.col1value END)  AS 期初值_预收账款
		     ,MAX(CASE WHEN T1.rowsubject='204' THEN T1.col2value END)  AS 期末值_预收账款
			 ,MAX(CASE WHEN T1.rowsubject='218' THEN T1.col1value END)  AS 期初值_应付工资
		     ,MAX(CASE WHEN T1.rowsubject='218' THEN T1.col2value END)  AS 期末值_应付工资
			 ,MAX(CASE WHEN T1.rowsubject='205' THEN T1.col1value END)  AS 期初值_应付福利费
		     ,MAX(CASE WHEN T1.rowsubject='205' THEN T1.col2value END)  AS 期末值_应付福利费
			 ,MAX(CASE WHEN T1.rowsubject='219' THEN T1.col1value END)  AS 期初值_应付股利
		     ,MAX(CASE WHEN T1.rowsubject='219' THEN T1.col2value END)  AS 期末值_应付股利
			 ,MAX(CASE WHEN T1.rowsubject='207' THEN T1.col1value END)  AS 期初值_应交税金
		     ,MAX(CASE WHEN T1.rowsubject='207' THEN T1.col2value END)  AS 期末值_应交税金
			 ,MAX(CASE WHEN T1.rowsubject='274' THEN T1.col1value END)  AS 期初值_应付利息
		     ,MAX(CASE WHEN T1.rowsubject='274' THEN T1.col2value END)  AS 期末值_应付利息
			 ,MAX(CASE WHEN T1.rowsubject='208' THEN T1.col1value END)  AS 期初值_其他应交款
		     ,MAX(CASE WHEN T1.rowsubject='208' THEN T1.col2value END)  AS 期末值_其他应交款
			 ,MAX(CASE WHEN T1.rowsubject='209' THEN T1.col1value END)  AS 期初值_其他应付款
		     ,MAX(CASE WHEN T1.rowsubject='209' THEN T1.col2value END)  AS 期末值_其他应付款
			 ,MAX(CASE WHEN T1.rowsubject='210' THEN T1.col1value END)  AS 期初值_预提费用
		     ,MAX(CASE WHEN T1.rowsubject='210' THEN T1.col2value END)  AS 期末值_预提费用
			 ,MAX(CASE WHEN T1.rowsubject='j20' THEN T1.col1value END)  AS 期初值_预计负债
		     ,MAX(CASE WHEN T1.rowsubject='j20' THEN T1.col2value END)  AS 期末值_预计负债
			 ,MAX(CASE WHEN T1.rowsubject='211' THEN T1.col1value END)  AS 期初值_一年内到期的长期负债
		     ,MAX(CASE WHEN T1.rowsubject='211' THEN T1.col2value END)  AS 期末值_一年内到期的长期负债
			 ,MAX(CASE WHEN T1.rowsubject='212' THEN T1.col1value END)  AS 期初值_其他流动负债
		     ,MAX(CASE WHEN T1.rowsubject='212' THEN T1.col2value END)  AS 期末值_其他流动负债
			 ,MAX(CASE WHEN T1.rowsubject='805' THEN T1.col1value END)  AS 期初值_流动负债合计
		     ,MAX(CASE WHEN T1.rowsubject='805' THEN T1.col2value END)  AS 期末值_流动负债合计
			 ,MAX(CASE WHEN T1.rowsubject='213' THEN T1.col1value END)  AS 期初值_长期借款
		     ,MAX(CASE WHEN T1.rowsubject='213' THEN T1.col2value END)  AS 期末值_长期借款
			 ,MAX(CASE WHEN T1.rowsubject='214' THEN T1.col1value END)  AS 期初值_应付债券
		     ,MAX(CASE WHEN T1.rowsubject='214' THEN T1.col2value END)  AS 期末值_应付债券
			 ,MAX(CASE WHEN T1.rowsubject='215' THEN T1.col1value END)  AS 期初值_长期应付款
		     ,MAX(CASE WHEN T1.rowsubject='215' THEN T1.col2value END)  AS 期末值_长期应付款
			 ,MAX(CASE WHEN T1.rowsubject='216' THEN T1.col1value END)  AS 期初值_其他长期负债
		     ,MAX(CASE WHEN T1.rowsubject='216' THEN T1.col2value END)  AS 期末值_其他长期负债
			 ,MAX(CASE WHEN T1.rowsubject='806' THEN T1.col1value END)  AS 期初值_长期负债合计
		     ,MAX(CASE WHEN T1.rowsubject='806' THEN T1.col2value END)  AS 期末值_长期负债合计
			 ,MAX(CASE WHEN T1.rowsubject='217' THEN T1.col1value END)  AS 期初值_递延税款贷项
		     ,MAX(CASE WHEN T1.rowsubject='217' THEN T1.col2value END)  AS 期末值_递延税款贷项
			 ,MAX(CASE WHEN T1.rowsubject='807' THEN T1.col1value END)  AS 期初值_负债合计
		     ,MAX(CASE WHEN T1.rowsubject='807' THEN T1.col2value END)  AS 期末值_负债合计
			 ,MAX(CASE WHEN T1.rowsubject='301' THEN T1.col1value END)  AS 期初值_实收资本或股本
		     ,MAX(CASE WHEN T1.rowsubject='301' THEN T1.col2value END)  AS 期末值_实收资本或股本
			 ,MAX(CASE WHEN T1.rowsubject='302' THEN T1.col1value END)  AS 期初值_资本公积
		     ,MAX(CASE WHEN T1.rowsubject='302' THEN T1.col2value END)  AS 期末值_资本公积
			 ,MAX(CASE WHEN T1.rowsubject='303' THEN T1.col1value END)  AS 期初值_盈余公积
		     ,MAX(CASE WHEN T1.rowsubject='303' THEN T1.col2value END)  AS 期末值_盈余公积
			 ,MAX(CASE WHEN T1.rowsubject='304' THEN T1.col1value END)  AS 期初值_其中公益金
		     ,MAX(CASE WHEN T1.rowsubject='304' THEN T1.col2value END)  AS 期末值_其中公益金
			 ,MAX(CASE WHEN T1.rowsubject='305' THEN T1.col1value END)  AS 期初值_未分配利润
		     ,MAX(CASE WHEN T1.rowsubject='305' THEN T1.col2value END)  AS 期末值_未分配利润
			 ,MAX(CASE WHEN T1.rowsubject='808' THEN T1.col1value END)  AS 期初值_所有者权益合计
		     ,MAX(CASE WHEN T1.rowsubject='808' THEN T1.col2value END)  AS 期末值_所有者权益合计
			 ,MAX(CASE WHEN T1.rowsubject='809' THEN T1.col1value END)  AS 期初值_负债及所有者权益总计
		     ,MAX(CASE WHEN T1.rowsubject='809' THEN T1.col2value END)  AS 期末值_负债及所有者权益总计
		     ,MAX(CASE WHEN T1.rowsubject='z74' THEN T1.col1value END)  AS 期初值_未结清对外担保余额
		     ,MAX(CASE WHEN T1.rowsubject='z74' THEN T1.col2value END)  AS 期末值_未结清对外担保余额
FROM    edw.loan_REPORT_RECORD      T --报表记录  --20220118
INNER JOIN    edw.loan_REPORT_DATA  T1 --报表数据  --20220118
ON      T.reportno = T1.reportno
AND     T1.DT = '20250427'
WHERE T.DT = '20250427'
AND   T.modelno ='0001'           -- 资产负债表
AND   T.ObjectType = 'CustomerFS' -- 对象类型为客户号
AND   T.reportstatus = '02' --报表状态
GROUP BY T.reportno	,T.objectno,T.reportdate	;
----------------------
--2.临时表二 主营业务经营利润
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_02 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_02 AS
SELECT       T.reportno		 AS 报表编号
			 ,T.objectno	 AS 客户号
             ,T.reportdate	 AS 报表期次
		     ,MAX(CASE WHEN T1.rowsubject='501' THEN T1.col2value END)  AS 期末值_一主营业务收入
		     ,MAX(CASE WHEN T1.rowsubject='502' THEN T1.col2value END)  AS 期末值_减_营业成本
		     ,MAX(CASE WHEN T1.rowsubject='503' THEN T1.col2value END)  AS 期末值_营业费用
		     ,MAX(CASE WHEN T1.rowsubject='504' THEN T1.col2value END)  AS 期末值_营业税金及附加
		     ,MAX(CASE WHEN T1.rowsubject='505' THEN T1.col2value END)  AS 期末值_二主营业务经营利润
		     ,MAX(CASE WHEN T1.rowsubject='506' THEN T1.col2value END)  AS 期末值_加_其它业务利润
		     ,MAX(CASE WHEN T1.rowsubject='507' THEN T1.col2value END)  AS 期末值_减_管理费用
		     ,MAX(CASE WHEN T1.rowsubject='508' THEN T1.col2value END)  AS 期末值_财务费用
		     ,MAX(CASE WHEN T1.rowsubject='522' THEN T1.col2value END)  AS 期末值_其中_汇兑损失
		     ,MAX(CASE WHEN T1.rowsubject='509' THEN T1.col2value END)  AS 期末值_三经营利润
		     ,MAX(CASE WHEN T1.rowsubject='510' THEN T1.col2value END)  AS 期末值_加_投资收益
		     ,MAX(CASE WHEN T1.rowsubject='532' THEN T1.col2value END)  AS 期末值_期货收益
		     ,MAX(CASE WHEN T1.rowsubject='511' THEN T1.col2value END)  AS 期末值_补贴收入
		     ,MAX(CASE WHEN T1.rowsubject='512' THEN T1.col2value END)  AS 期末值_营业外收入
		     ,MAX(CASE WHEN T1.rowsubject='513' THEN T1.col2value END)  AS 期末值_减_营业外支出
		     ,MAX(CASE WHEN T1.rowsubject='514' THEN T1.col2value END)  AS 期末值_加_以前年度损益调整
		     ,MAX(CASE WHEN T1.rowsubject='515' THEN T1.col2value END)  AS 期末值_四利润总额
		     ,MAX(CASE WHEN T1.rowsubject='516' THEN T1.col2value END)  AS 期末值_减_所得税
		     ,MAX(CASE WHEN T1.rowsubject='523' THEN T1.col2value END)  AS 期末值_少数股东损益
		     ,MAX(CASE WHEN T1.rowsubject='517' THEN T1.col2value END)  AS 期末值_五净利润
FROM    edw.loan_REPORT_RECORD T --报表记录
INNER JOIN    edw.loan_REPORT_DATA T1 --报表数据
ON      T.reportno = T1.reportno
AND     T1.DT = '20250427'
WHERE T.DT = '20250427'
AND   T.modelno = '0002'           -- 损益表
AND   T.ObjectType = 'CustomerFS'  -- 对象类型为客户号
AND   T.reportstatus = '02' --报表状态
GROUP BY T.reportno	,T.objectno,T.reportdate;
----------------------
--3.临时表三 现金流量表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_03 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_03 AS
SELECT       T.reportno		 AS 报表编号
			 ,T.objectno	 AS 客户号
             ,T.reportdate	 AS 报表期次
		     ,MAX(CASE WHEN T1.rowsubject='a01' THEN T1.col2value END)  AS 期末值_销售商品_提供劳务收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a16' THEN T1.col2value END)  AS 期末值_收到的租金
		     ,MAX(CASE WHEN T1.rowsubject='a17' THEN T1.col2value END)  AS 期末值_收到的增值税销项税额和退回的增值税款
		     ,MAX(CASE WHEN T1.rowsubject='a18' THEN T1.col2value END)  AS 期末值_收到的除增值税以外的其他税费返还
		     ,MAX(CASE WHEN T1.rowsubject='a19' THEN T1.col2value END)  AS 期末值_收到的其他与经营活动有关的现金
		     ,MAX(CASE WHEN T1.rowsubject='a20' THEN T1.col2value END)  AS 期末值_经营活动产生现金流入小计
		     ,MAX(CASE WHEN T1.rowsubject='a02' THEN T1.col2value END)  AS 期末值_购买商品_接受劳务支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a03' THEN T1.col2value END)  AS 期末值_经营费用现金支出
		     ,MAX(CASE WHEN T1.rowsubject='a22' THEN T1.col2value END)  AS 期末值_支付给职工以及为职工支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a23' THEN T1.col2value END)  AS 期末值_支付的增值税款
		     ,MAX(CASE WHEN T1.rowsubject='a24' THEN T1.col2value END)  AS 期末值_支付的所得税款
		     ,MAX(CASE WHEN T1.rowsubject='a25' THEN T1.col2value END)  AS 期末值_支付的除增值税_所得税以外的其他税费
		     ,MAX(CASE WHEN T1.rowsubject='a26' THEN T1.col2value END)  AS 期末值_支付的其他与经营活动有关的现金
		     ,MAX(CASE WHEN T1.rowsubject='a27' THEN T1.col2value END)  AS 期末值_经营活动产生现金流出小计
		     ,MAX(CASE WHEN T1.rowsubject='a28' THEN T1.col2value END)  AS 期末值_收回投资所收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a29' THEN T1.col2value END)  AS 期末值_分得股利或利润所收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a30' THEN T1.col2value END)  AS 期末值_取得债券利息收入所收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a31' THEN T1.col2value END)  AS 期末值_处置固定资产_无形资产和其他长期资产而收到的现金净额
		     ,MAX(CASE WHEN T1.rowsubject='a32' THEN T1.col2value END)  AS 期末值_收到其他与投资活动有关的现金
		     ,MAX(CASE WHEN T1.rowsubject='a33' THEN T1.col2value END)  AS 期末值_投资活动现金流入小计
		     ,MAX(CASE WHEN T1.rowsubject='a34' THEN T1.col2value END)  AS 期末值_购建固定资产_无形资产和其他长期资产所支付的现金净额
		     ,MAX(CASE WHEN T1.rowsubject='a35' THEN T1.col2value END)  AS 期末值_权益性投资所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a36' THEN T1.col2value END)  AS 期末值_债权性投资所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a37' THEN T1.col2value END)  AS 期末值_支付的其他与投资活动有关的现金
		     ,MAX(CASE WHEN T1.rowsubject='a38' THEN T1.col2value END)  AS 期末值_投资活动现金流出小计
		     ,MAX(CASE WHEN T1.rowsubject='811' THEN T1.col2value END)  AS 期末值_投资活动产生的现金流量净额
		     ,MAX(CASE WHEN T1.rowsubject='a39' THEN T1.col2value END)  AS 期末值_吸收权益性投资所收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a40' THEN T1.col2value END)  AS 期末值_发行债券所收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a41' THEN T1.col2value END)  AS 期末值_借款所收到的现金
		     ,MAX(CASE WHEN T1.rowsubject='a42' THEN T1.col2value END)  AS 期末值_收到其他与筹资活动有关的现金
		     ,MAX(CASE WHEN T1.rowsubject='a43' THEN T1.col2value END)  AS 期末值_筹资活动现金流入小计
		     ,MAX(CASE WHEN T1.rowsubject='a44' THEN T1.col2value END)  AS 期末值_偿还债务所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a45' THEN T1.col2value END)  AS 期末值_发生筹资费用所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a46' THEN T1.col2value END)  AS 期末值_分配股利_利润_偿付利息所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a47' THEN T1.col2value END)  AS 期末值_融资租赁所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a48' THEN T1.col2value END)  AS 期末值_减少注册资本所支付的现金
		     ,MAX(CASE WHEN T1.rowsubject='a49' THEN T1.col2value END)  AS 期末值_支付的其他与筹资活动有关的现金
		     ,MAX(CASE WHEN T1.rowsubject='a50' THEN T1.col2value END)  AS 期末值_筹资活动现金流出小计
		     ,MAX(CASE WHEN T1.rowsubject='812' THEN T1.col2value END)  AS 期末值_融资活动产生的现金净流量
		     ,MAX(CASE WHEN T1.rowsubject='a51' THEN T1.col2value END)  AS 期末值_四汇率变动对现金的影响额
		     ,MAX(CASE WHEN T1.rowsubject='813' THEN T1.col2value END)  AS 期末值_五现金及现金等价物净增加额
FROM    edw.loan_REPORT_RECORD T --报表记录  --20220118
INNER JOIN    edw.loan_REPORT_DATA T1 --报表数据  --20220118
ON      T.reportno = T1.reportno
AND     T1.DT = '20250427'
WHERE T.DT = '20250427'
AND   T.modelno = '0008'           -- 现金流量表(自动)
AND   T.ObjectType = 'CustomerFS'  -- 对象类型为客户号
AND   T.reportstatus = '02' --报表状态
GROUP BY T.reportno	,T.objectno,T.reportdate;
--结果表1 资产负债表22、23年 年报
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB1 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB1 AS
SELECT T0.客户名称
       ,CASE
          WHEN T2.REPORTPERIOD = '1' THEN '年报'
          WHEN T2.REPORTPERIOD = '2' THEN '半年报'
          WHEN T2.REPORTPERIOD = '3' THEN '季报'
          WHEN T2.REPORTPERIOD = '4' THEN '月报'
          WHEN T2.REPORTPERIOD = '9' THEN '其他'
         END 报表周期 --需补充映射
          ,T1.*
FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_01  T1  -----客户财务报表记录
INNER JOIN  (
            SELECT  DISTINCT 客户号,客户名称
            FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01
        ) T0
ON     T1.客户号 = T0.客户号
LEFT JOIN   edw.loan_customer_fsrecord   T2
ON      T2.customerid = T1.客户号
AND     T2.REPORTDATE = T1.报表期次
AND     T2.DT = '20250427'
AND     T2.REPORTPERIOD = '1'  --年报
;
--结果表2 利润表22、23 年末本年累计值
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB2 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB2 AS
SELECT   T0.客户名称
         ,CASE
          WHEN T2.REPORTPERIOD = '1' THEN '年报'
          WHEN T2.REPORTPERIOD = '2' THEN '半年报'
          WHEN T2.REPORTPERIOD = '3' THEN '季报'
          WHEN T2.REPORTPERIOD = '4' THEN '月报'
          WHEN T2.REPORTPERIOD = '9' THEN '其他'
         END 报表周期 --需补充映射
          ,T1.*
FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_02  T1
INNER JOIN  (
            SELECT  DISTINCT 客户号,客户名称
            FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01
        ) T0
ON     T1.客户号 = T0.客户号
LEFT JOIN   edw.loan_customer_fsrecord   T2
ON      T2.customerid = T1.客户号
AND     T2.REPORTDATE = T1.报表期次
AND     T2.DT = '20250427'
AND     T2.REPORTPERIOD = '1'  --年报
;
--结果表3 现金流量表22、23 年末本年累计值
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB3 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB3 AS
SELECT   T0.客户名称
        ,CASE
          WHEN T2.REPORTPERIOD = '1' THEN '年报'
          WHEN T2.REPORTPERIOD = '2' THEN '半年报'
          WHEN T2.REPORTPERIOD = '3' THEN '季报'
          WHEN T2.REPORTPERIOD = '4' THEN '月报'
          WHEN T2.REPORTPERIOD = '9' THEN '其他'
         END 报表周期 --需补充映射
          ,T1.*
FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_03  T1
INNER JOIN  (
            SELECT  DISTINCT 客户号,客户名称
            FROM    lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_01
        ) T0
ON     T1.客户号 = T0.客户号
LEFT JOIN   edw.loan_customer_fsrecord   T2
ON      T2.customerid = T1.客户号
AND     T2.REPORTDATE = T1.报表期次
AND     T2.DT = '20250427'
AND     T2.REPORTPERIOD = '1'  --年报
;
/*
-- 客户信息以下字段缺失
报表年份 主营业务收入来源 金融机构内部评级结果 信贷资产支持 经营地产权情况 董事会成员（执行董事）数量	监事会成员（监事）数量
*/
select * from lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_KHXX          --客户信息
limit 100;
select * from lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB1;   --年报
select * from lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB2;   --利润表
select * from lab_bigdata_dev.tmp_qiyexinxi_SJ20250425146_caibao_JGB3;   --现金流量表
/*
select 4 as seq,'edw.loan_customer_fsrecord' as tbl,min(dt) as min_dt,max(dt) as max_dt,count(distinct dt) as dts
from edw.loan_customer_fsrecord --客户财务报表记录
where dt between '20240101' and '20241231'
union all
select 5 as seq,'edw.loan_report_data' as tbl,min(dt) as min_dt,max(dt) as max_dt,count(distinct dt) as dts
from edw.loan_report_data --报表数据
where dt between '20240101' and '20241231'
union all
select 6 as seq,'edw.loan_report_record' as tbl,min(dt) as min_dt,max(dt) as max_dt,count(distinct dt) as dts
from edw.loan_report_record --报表记录
where dt between '20240101' and '20241231'
;
select 4 as seq,'edw.loan_customer_fsrecord' as tbl
    ,sum(case when dt='20240101' then 1 else 0 end) as min_cnt
    ,sum(case when dt='20241231' then 1 else 0 end) as max_cnt
from edw.loan_customer_fsrecord --客户财务报表记录
union all
select 5 as seq,'edw.loan_report_data' as tbl
    ,sum(case when dt='20240101' then 1 else 0 end) as min_cnt
    ,sum(case when dt='20241231' then 1 else 0 end) as max_cnt
from edw.loan_report_data --报表数据
union all
select 6 as seq,'edw.loan_report_record' as tbl
    ,sum(case when dt='20240101' then 1 else 0 end) as min_cnt
    ,sum(case when dt='20241231' then 1 else 0 end) as max_cnt
from edw.loan_report_record --报表记录
;
*/
***陶丹佳_SJ2025031081_精准贷后.sql
﻿/*
时间：2024年全年
数据范围：触发精准贷后，且贷后管理方案反馈为退出及以下的客户，
口径为1.客户级：退出、清收、预保预报、重组、诉讼 2.业务级：预保预报、重组、诉讼、清收。
取数口径：1.续办为非重组及非预保预报的正常业务 2.续办为非重组及非预保预报的正常业务且额度较上一笔未下降
数据需求字段
合同号、客户号、客户名称、合同金额、合同余额、时间、业务品种、是否循环、风险分层、经办人工号、经办人名称、机构
*/
-- 精准贷后 取2024年首次触发精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2025031081_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031081_CST_01 AS -- explain
SELECT t1.btch_serno
    ,t1.tsk_gen_dt
    ,COALESCE(t2.cst_id,t3.cst_id) as cst_id
    ,t2.cst_lvl_pst_loan_mng_pln_cd,t2.cst_lvl_pst_loan_mng_pln_nm,t2.chk_cpl_dt
    ,t3.pst_loan_mng_pln_cd,t3.pst_loan_mng_pln_nm
    ,t3.ctr_serno                                --合同流水号|c32
    ,t3.ori_ctr_amt                              --原合同金额|decimal(21,2)
    ,t3.new_ctr_amt                              --新合同金额|decimal(21,2)
    ,t3.ctr_amt,t3.ctr_bal,t3.sys_reg_tm
    ,case when t2.cst_lvl_pst_loan_mng_pln_nm REGEXP '退出|清收|预保预报|重组|诉讼' then 1 else 0 end as is_cst_out  --客户级
    ,case when t3.pst_loan_mng_pln_nm REGEXP '预保预报|重组|诉讼|清收' then 1 else 0 end as is_biz_out      --业务级
from(
    SELECT btch_serno
        ,tsk_gen_dt   --任务生成日期 精准贷后风险触发时间
        ,ROW_NUMBER() over(PARTITION BY btch_serno ORDER BY tsk_gen_dt aSC) rn_asc
    from edw.dwd_bus_loan_psp_chk_tsk_inf_dd  AS T2 --贷后检查任务信息
    where DT = '@@{yyyyMMdd}'
    AND pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
    AND tsk_gen_dt between '20240101' and '20241231'
)t1 left JOIN (
    SELECT t1.btch_serno,t1.cst_id
        ,t1.cst_lvl_pst_loan_mng_pln_cd              --客户级贷后管理方案代码 ,'03','重组','04','退出','06','预保预报','07','清收','08','诉讼'
        ,c1.cd_val_dscr     as cst_lvl_pst_loan_mng_pln_nm
        ,t1.chk_cpl_dt	    --检查完成日期|c8
    from edw.dwd_bus_loan_psp_chk_btch_inf_dd AS T1 --贷后检查批次信息表
    LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
    ON      t1.cst_lvl_pst_loan_mng_pln_cd = c1.cd_val
    AND     c1.DT = t1.dt
    where t1.DT = '@@{yyyyMMdd}'
)t2 on t1.btch_serno=t2.btch_serno
left join(
    SELECT t.*
    from (
        SELECT t1.btch_serno,t2.cst_id
            ,t1.ctr_serno                                --合同流水号|c32
            ,t1.ori_ctr_amt                              --原合同金额|decimal(21,2)
            ,t1.new_ctr_amt                              --新合同金额|decimal(21,2)
            ,t2.ctr_amt,t2.ctr_bal
            ,t1.pst_loan_mng_opnn_src_cd                 --贷后管理意见来源代码 ,'1','客户经理意见','2','中台意见'
            ,t1.pst_loan_mng_pln_cd	--	贷后管理方案代码
            ,c1.cd_val_dscr     as pst_loan_mng_pln_nm
            ,t1.sys_reg_tm
            ,ROW_NUMBER() over(PARTITION BY t1.btch_serno ORDER BY t1.sys_reg_tm desc) rn
        from edw.dwd_bus_loan_bsn_mng_pln_dd        t1 --业务贷后管理方案
        left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
        on t1.ctr_serno=t2.ctr_serno
        and t2.dt=t1.dt
        LEFT JOIN    edw.dwd_code_library_dd 	c1 --码值表
        ON  t1.pst_loan_mng_pln_cd = c1.cd_val
        AND c1.DT = t1.dt
        and c1.cd_val_dscr REGEXP '预保预报|重组|诉讼|清收'     --,'13','预保预报','14','清收','15','诉讼','16','重组'
        where t1.DT = '@@{yyyyMMdd}'
    )t where t.rn=1
)t3 on t1.btch_serno=t3.btch_serno
where t1.rn_asc=1
;
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ2025031081_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031081_CST_02 AS
SELECT t1.ctr_serno         --合同流水号
    ,t1.cst_id              --客户号
    ,t1.cst_nm              --客户名称
    ,t1.rel_serno           --用信申请流水号
    ,t1.ctr_amt             --合同金额
    ,t1.ctr_bal             --合同余额
    ,t1.ctr_epsr_amt        --合同敞口金额
    ,t1.ctr_epsr_bal        --合同敞口余额
    ,t1.ctr_bgn_dt          --合同起始日期
    ,t1.ctr_mtu_dt          --合同到期日期
    ,t2.pd_nm
    ,t1.RVLG_TYP_CD         --循环类型代码
    ,c2.cd_val_dscr         as RVLG_TYP_nm
    ,t1.cur_rsk_ctg_rslt_cd --当前风险分类结果代码
    ,c1.cd_val_dscr         as cur_rsk_ctg_rslt_nm
    ,t1.hdl_org_id          --经办机构编号|c10
    ,t1.hdl_opr_id          --经办人工号
    ,t1.bsn_mark_cd
    ,c3.cd_val_dscr         as bsn_mark_nm --业务标识
    ,t3.empe_nm             as hdl_opr_nm --经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt=t1.dt
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.hdl_opr_id=t3.empe_id
and t3.dt=t1.dt
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.hdl_org_id = t4.org_id
and t4.dt = t1.dt
left join edw.dwd_code_library_dd           c1
on t1.cur_rsk_ctg_rslt_cd = c1.cd_val
and c1.dt = t1.dt
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = t1.dt
left join edw.dwd_code_library_dd           c3
on t1.bsn_mark_cd = c3.cd_val
and c3.dt = t1.dt
where t1.dt='@@{yyyyMMdd}'
;
-- 精准贷后且贷后管理方案反馈为退出及以下的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025031081_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031081_CST_03 AS -- explain
SELECT  t1.tsk_gen_dt       as 24年首次触发精准贷后日期
    ,t1.客户级贷后管理日期
    ,t1.cst_lvl_pst_loan_mng_pln_nm     as 客户级贷后管理方案
    ,t1.业务级贷后管理日期
    ,t1.pst_loan_mng_pln_nm             as 业务级贷后管理方案
    ,t2.ctr_serno           as 合同流水号
    ,t2.cst_id              as 客户号
    ,t2.cst_nm              as 客户名称
    ,t2.ctr_amt             as 合同金额
    ,t2.ctr_bal             as 合同余额
    ,t2.ctr_epsr_amt        as 合同敞口金额
    ,t2.ctr_epsr_bal        as 合同敞口余额
    ,t2.ctr_bgn_dt          as 合同起始日期
    ,t2.ctr_mtu_dt          as 合同到期日期
    ,t2.pd_nm               as 业务品种
    ,t2.RVLG_TYP_nm         as 循环类型
    ,t2.cur_rsk_ctg_rslt_nm as 当前风险分类结果
    ,t2.hdl_opr_id          as 经办人工号
    ,t2.hdl_opr_nm          as 经办人
    ,t2.org_nm              as 经办机构
    ,row_number() over(partition by t2.cst_Id order by t2.ctr_bgn_dt desc) rn
from(
    SELECT cst_id,tsk_gen_dt
        ,cst_lvl_pst_loan_mng_pln_nm
        ,pst_loan_mng_pln_nm
        ,chk_cpl_dt     as 客户级贷后管理日期
        ,sys_reg_tm     as 业务级贷后管理日期
        ,row_number() over(partition by cst_id order by tsk_gen_dt asc) rn
    from SJXQ_SJ2025031081_CST_01
    where is_cst_out=1 or is_biz_out=1
)t1 inner join SJXQ_SJ2025031081_CST_02 t2
on t1.cst_id=t2.cst_id
and t1.tsk_gen_dt<=t2.ctr_bgn_dt
and t2.is_cz_ybyb=0     --非重组非预保预报
where t1.rn=1   --首次触发精准贷后
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2025031081_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025031081_CST_04 AS -- explain
SELECT t1.*,t2.合同金额     as 上一笔合同金额
from SJXQ_SJ2025031081_CST_03       t1
inner join SJXQ_SJ2025031081_CST_03 t2
on  t1.合同流水号=t2.合同流水号
and t2.rn=2     --上一笔
and t1.合同金额>=t2.合同金额
where t1.rn=1   --当前合同
;
SELECT *
from SJXQ_SJ2025031081_CST_03
;
SELECT *
from SJXQ_SJ2025031081_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct btch_serno) custs
from SJXQ_SJ2025031081_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2025031081_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025031081_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2025031081_CST_04
***陶婉欣_SJ2025051511_叶县村行对公基本户客户信息.sql
﻿-- 陶婉欣_SJ2025051511_叶县村行对公基本户客户信息
/*
河南叶县泰隆村镇银行
2019年7月1日至 2024 年 11 月 1 日期间在我行开立基本户的客户中注册地在河南省内，
注册资本 1000 万（不含）以上的公司、合伙企业、外国公司分支机构。
数据需求字段
客户号，公司名称 ，公司类别，注册地，注册资本，法人姓名，法人联系电话
*/
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025051511_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051511_CST_01 AS
SELECT  T1.cst_id         --客户号
       ,T1.opn_dt         --存款账号开户日期
       ,t2.org_nm         --开户机构
       ,t3.reg_adr        --注册地址
       ,t3.doc_nbr        --证件号码
       ,t3.doc_typ_cd     --证件类型代码
FROM  edw.dws_bus_dep_act_inf_dd            T1 --存款账户信息汇总
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.opn_org = t2.org_id
and t2.dt = t1.dt
and t2.brc_org_nm = '河南叶县泰隆村镇银行'
inner join edw.dws_cst_bas_inf_dd 		    t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt=t1.dt
and t3.cst_typ_cd='2' --'对公'
WHERE   T1.dt='@@{yyyyMMdd}'
AND     T1.ACT_CTG_CD_1= '0001' --基本户
and T1.opn_dt between '20190701' and '20241101'
;
--汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2025051511_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025051511_CST_02 AS
select t1.cst_id
    ,t1.reg_adr        as 注册地址
    ,t2.reg_cpt        as 注册资本
    ,t2.cst_nm         as 客户名称
    ,t2.lctax_cert_no  as 统一信用代码
    ,t2.org_org_typ_cd as 组织机构类型代码
    ,c1.cd_val_dscr    as 组织机构类型
    ,t3.lgp_nm         as 对公客户法人客户名称
    ,t3.lgp_tel        as 对公客户法人手机号
from(
    select distinct cst_id
       ,reg_adr        --注册地址
       ,doc_typ_cd     --证件类型代码
    from SJXQ_SJ2025051511_CST_01
)t1
left join edw.dim_cst_entp_bas_inf_dd   t2 --企业客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_entp_lgp_inf_dd   t3       --对公客户法人信息表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       c1
on  T2.org_org_typ_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where SUBSTR(t2.lctax_cert_no,3,2)='41'     --注册地在河南省内
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051511_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025051511_CST_02
;
SElECT '02' seq, *
from lab_sjxq.SJXQ_SJ2025051511_CST_02
;
***韩祺妙_SJ2025030761_绍兴分行反洗钱自查.sql
-- 2024年1月1日至2025年3月1日风险评级为高风险等级和较高风险等级的客户数据清单。
DROP   TABLE IF     EXISTS SJXQ_SJ2025030761_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030761_CST_01 AS
select *
from(
    SELECT  substr(t2.party_id,3,12)  AS cst_id
        ,t2.party_chn_name	    --	客户名称
        ,t2.levelkey
        ,decode(t2.levelkey,'1004','较高风险','1005','高风险','') as levelkey_nm
        ,t2.rcheck_dt
        ,ROW_NUMBER() OVER (PARTITION BY substr(t2.party_id,3,12) ORDER BY t2.statistic_dt DESC) AS rn
        ,t2.statistic_dt --评级日期
        ,t3.prm_mgr_id,t3.prm_mgr_nm
        ,t4.org_nm
    FROM adm_upss.aml_t37_party_result_curr              t2
    inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
    on  substr(t2.party_id,3,12) = t3.cst_id
    and t3.dt = '20250301'
    inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
    on  t3.prm_org_id = t4.org_id
    and t4.dt = '20250301'
    and t4.brc_org_nm = '绍兴分行'
    WHERE t2.dt = '20250301'
and t1.rn=1
;
-- 可疑案例账户
DROP   TABLE IF     EXISTS SJXQ_SJ2025030761_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030761_CST_02 AS
SELECT distinct t2.cst_id
FROM    adm_upss.aml_t07_case_application_uh t1
INNER JOIN (
    SELECT DISTINCT cst_id
    from SJXQ_SJ2025030761_CST_01
) t2 ON substr(t1.party_id, 3, 12) = t2.cst_id
WHERE   t1.dt = '20250301'
AND     substr(replace(t1.app_dt,'-',''),1,8) between '20240101' and '20250301'
AND     t1.cast_type = '2' --案例类型:1:大额 2:可疑
AND     t1.app_state_cd = '5'  --1：处理中, 2：已审批,  3：退回, 4：已排除，5上报
;
-- 公安机关查冻扣记录
DROP   TABLE IF     EXISTS SJXQ_SJ2025030761_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030761_CST_03 AS
SELECT distinct aa.cst_id
FROM edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN (
    SELECT DISTINCT cst_id
    from SJXQ_SJ2025030761_CST_01
) t2 ON aa.cst_id = t2.cst_id
WHERE aa.dt = '20250301'
AND qry_ctrl_dt between '20240101' and '20250301'
AND ( aa.instt_typ_cd IN ( '04' , '05' ) OR ( ( aa.instt_nm LIKE '%法院%' OR aa.instt_typ_cd = '01' ) AND aa.LAW_DOC_ID LIKE '%刑%' ) )
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025030761_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030761_CST_04 AS
SELECT  t1.cst_id                                                 AS 客户号
       ,t1.party_chn_name                                         AS 客户名称
       ,t2.cst_act_id                                             AS 客户账号
       ,t1.levelkey_nm                                            AS 当前风险评级
       ,case when t7.cst_id is not null then 'Y'  ELSE '' END as 是否上报过可疑案例
       ,case when t8.cst_id is not null then 'Y'  ELSE '' END as 是否有公安机关查冻扣记录
       ,'' as 是否是反洗钱灰名单
       ,CASE WHEN t3.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否账户止付
       ,CASE WHEN t4.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否账户冻结
       ,CASE WHEN t5.cst_act_id is not null THEN 'Y'  ELSE '' END AS 是否暂停非柜面
       ,t6.fg_day_lmt                                             AS 日累计非柜限额
       ,concat(t1.prm_mgr_id,t1.prm_mgr_nm)                       AS 主管户客户经理
       ,t1.org_nm                                                 AS 主管户机构
from SJXQ_SJ2025030761_CST_01               t1
left join edw.dim_bus_dep_cst_act_inf_dd    t2 --客户存款账户信息
on t1.cst_id=t2.cst_id
and t2.dt='20250301'
left join(
    SELECT  distinct t1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    WHERE   t1.DT = '20250301'
    AND     t1.FRZ_SRC_CD='2'  --账户止付
    AND     t1.NFRZ_IND = '0'
)t3 on t2.cst_act_id=t3.cst_act_id
left join(
    SELECT  distinct t1.cst_act_id
    FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
    WHERE   t1.DT = '20250301'
    AND     t1.FRZ_SRC_CD='1'  --账户冻结
    AND     t1.NFRZ_IND = '0'
)t4 on t2.cst_act_id=t4.cst_act_id
left join(
    SELECT  distinct cst_act_id
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '20250301'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t5 on t2.cst_act_id=t5.cst_act_id
left join(
    SELECT  cengcgjz    cst_act_id
        ,leijiedu   fg_day_lmt
    FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
    WHERE   dt = '20250301'
    AND     zhxeleix = '2'
    AND     shijbhao = 'FGMXIANE' -- 非柜面限额
    AND     edkzzhqi = '1D'
)t6 on t2.cst_act_id=t6.cst_act_id
left join SJXQ_SJ2025030761_CST_02 t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ2025030761_CST_03 t8 on t1.cst_id=t8.cst_id
;
-- 绍兴分行反洗钱风险评级为较高风险客户的数据需求
DROP   TABLE IF     EXISTS SJXQ_SJ2025030761_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030761_CST_05 AS
SELECT  客户号
       ,客户名称
       ,客户账号
       ,当前风险评级
       ,是否上报过可疑案例
       ,是否有公安机关查冻扣记录
       ,是否账户止付
       ,是否账户冻结
       ,是否暂停非柜面
       ,日累计非柜限额
       ,主管户客户经理
       ,主管户机构
from SJXQ_SJ2025030761_CST_04
where 当前风险评级='较高风险'
;
-- 绍兴分行反洗钱风险评级为高风险客户的数据需求
DROP   TABLE IF     EXISTS SJXQ_SJ2025030761_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025030761_CST_06 AS
SELECT  客户号
       ,客户名称
       ,客户账号
       ,当前风险评级
       ,是否上报过可疑案例
       ,是否账户止付
       ,是否账户冻结
       ,是否暂停非柜面
       ,日累计非柜限额
       ,主管户客户经理
       ,主管户机构
from SJXQ_SJ2025030761_CST_04
where 当前风险评级='高风险'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030761_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030761_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025030761_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025030761_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025030761_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025030761_CST_06
***顾佳萍_SJ20241231131_一年定期存单质押.sql
﻿-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241231131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241231131_CST_01 AS
SELECT  T1.dep_act_id                       AS 存款账号
       ,T1.cst_act_id                       AS 客户账号
       ,T1.ccy_cd                           AS 币种代码
       ,T1.cst_id                           AS 客户号
       ,T1.act_nm                           AS 账户名称
       ,T1.dep_trm                          AS 存期
       ,T1.int_val_dt                       AS 起息日期
       ,T1.mtu_dt                           AS 到期日期
       ,T1.act_afl_org                      AS 核算机构编号
       ,T1.opn_dt                           AS 开户日期
       ,T1.gl_bal                           AS 账户总账余额
       ,T1.gl_bal * T3.AVG_PRC / T3.QUO_UNT AS 余额_折人民币
       ,T1.act_mth_acm_bal * T3.AVG_PRC / T3.QUO_UNT / SUBSTR(T1.DT,7,2)    AS 月日均_折人民币
       ,T1.prod_id                          AS 存款产品代码
       ,t8.pd_cmt                           as 存款产品名称
       ,decode(T1.lbl_prod_typ_cd,'0','活期','1','定期','') AS 存款产品类型代码
       ,T4.mgr_id                           AS 存款管户客户经理编号
       ,T5.empe_nm                          AS 存款管户客户经理名称
       ,T4.mgr_rto                          AS 管护比例
       ,T4.acs_org_id                       AS 存款管户客户经理考核机构编号
       ,t6.org_nm                           AS 存款管户客户经理考核机构
       ,t6.sbr_org_nm                       AS 存款管户客户经理考核支行
    ,case when T7.act_id is not null then '是' else '否' end                AS 是否质押
from edw.dws_bus_dep_act_inf_dd                 t1 --存款账户信息汇总
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD T3 --汇率信息
ON      t1.CCY_CD = T3.CCY_CD
AND     T3.dt='20241231'
left JOIN  edw.dwd_bus_dep_cst_act_mgr_inf_dd   t4 --存款客户账户`管户`信息
ON  T1.cst_act_id =T4.cst_act_id
and T4.dt='20241231'
left join  edw.dws_hr_empe_inf_dd               T5
ON  T4.mgr_id=T5.empe_id
and  T5.dt='20241231'
left JOIN  edw.dim_hr_org_mng_org_tree_dd       t6
ON  T4.acs_org_id=t6.org_id
and  t6.dt='20241231'
left JOIN edw.dim_bus_loan_cltr_dep_cert_spcl_dd t7 --贷款客户押品存单专项信息
ON      T1.cst_act_id = T7.act_id
AND     T1.dt = T7.dt
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd      T8 --存款产品
ON      T1.prod_id = T8.pd_id
AND     T8.dt='20241231'
where T1.dt='20241231'
AND     T1.prod_id IN ( '00202040100' , '00201040100' , '00201020100' , '00201020105'
    ,'00202020100') --单位大额存单,个人大额存单,个人整存整取,新成长乐,单位定期
AND     T4.acs_org_id like  '3302%'   --杭州分行
;
SElECT '01' seq, *
from SJXQ_SJ20241231131_CST_01
;
***鲁豪杰_SJ2025040931_绍兴分行信贷客户信息.sql
-- 截止20250331 绍兴分行所有客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025040931_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040931_CST_01 AS
select cst_id ,prd_dt ,cst_cr_grd_val,sc_src
	,case when nvl(scor_rng,'')<>'' then scor_rng
			120+floor((cst_cr_grd_val - 120)/20)*20+ 20,')')  end as scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc,sc_src) rn
	,row_number() over(partition by cst_id,prd_dt order by sc_src) rn2
from(
	SELECT  cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250331' and cr_sco_val<>0
	UNION
	SELECT  cst_id
		,prd_dt
		,cst_cr_grd_val
		,'1中征分' sc_src,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250331' and (cst_cr_grd_val<>0 or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,REPLACE(substr(report_dt,1,10),'-',''),idv_crd_sco_val
		,'2指标表' sc_src,scor_rng
	from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
	where dt='20250331' and report_dsc_rn=1
	and (nvl(idv_crd_sco_val,0) not in(0,-1) or nvl(scor_rng,'')<>'')
	union
	SELECT cst_id,SUBSTR(report_id,1,8),cast(digital_unscr as int)
		,'3集市表' sc_src
		,case when cast(digital_unscr as int) <120 then '[0,120)'
			when cast(digital_unscr as int) >=1000 then '[1000,)'
				120+floor((cast(digital_unscr as int) - 120)/20)*20+ 20,')')  end as scor_rng
	from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
	where dt<='20250331' and nvl(digital_unscr,'')<>''
	and digital_unscr <> '-1'
)t
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025040931_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040931_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
		,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn2
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250331'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20250331'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250331'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
where t1.rn=1
;
-- 个人客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025040931_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040931_CST_03 AS
SELECT  t1.dt              AS 数据时间
       ,t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户名
       ,t5.sys_reg_tm      AS 预评估时间
       ,t5.rul_set_rslt_nm AS 预评估结果
       ,t2.prd_dt          AS 人行征信报告日期
       ,t2.scor_rng        AS 人行征信最新评分分数段
       ,t3.prm_org_id      AS 主管户机构号
       ,t3.prm_mgr_nm      AS 主管户客户经理
from edw.dws_cst_bas_inf_dd 	    t1 			    --客户基础信息汇总表
left join SJXQ_SJ2025040931_CST_01  t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
left join SJXQ_SJ2025040931_CST_02 t5
on t1.cst_id=t5.cst_id
where t1.dt='20250331'
and t1.cst_typ_cd='1'  --'对私','2','对公'
and t4.brc_org_nm = '绍兴分行'
;
-- 对公客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025040931_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025040931_CST_04 AS
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 公司名称
       ,t2.lgp_cst_id AS 对公客户法人客户号
       ,t2.lgp_nm     AS 对公客户法人客户名称
       ,t5.prd_dt     AS 人行征信报告日期
       ,t5.scor_rng   AS 人行征信最新评分分数段
from edw.dws_cst_bas_inf_dd 	        t1 			    --客户基础信息汇总表
left join edw.dim_cst_entp_lgp_inf_dd   t2            --对公客户法人信息表 667556 cst_id 唯一
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
left join SJXQ_SJ2025040931_CST_01  t5
on t2.lgp_cst_id=t5.cst_id
and t5.rn=1
where t1.dt='20250331'
and t1.cst_typ_cd='2'  --'对私','2','对公'
and t4.brc_org_nm = '绍兴分行'
;
SElECT '03' seq, *
from SJXQ_SJ2025040931_CST_03
;
SElECT '04' seq, *
from SJXQ_SJ2025040931_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040931_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025040931_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025040931_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025040931_CST_04
***鲁豪杰_SJ20250630201_绍兴分行贷后风险分层.sql
﻿-- 鲁豪杰_SJ20250630201_绍兴分行贷后风险分层
-- 截止25年6月30日，绍兴分行所有客户在我行的最新征信分、预评估结果以及贷后风险分层类型。
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20250630201_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250630201_CST_01 AS
select cst_id,prd_dt,cst_cr_grd_val
	,nvl(cst_cr_grd_val,0) as zz_score
	,scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc) rn
from(
	SELECT cst_id,prd_dt,cst_cr_grd_val,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250630'
    union
	SELECT cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250630'
)t where nvl(cst_id,'')<>''
;
-- 征信分
DROP   TABLE IF     EXISTS SJXQ_SJ20250630201_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250630201_CST_02 AS
SELECT cst_id,REPLACE(substr(report_dt,1,10),'-','') as prd_dt
    ,idv_crd_sco_val
    ,case when idv_crd_sco_val is null or idv_crd_sco_val <=0 then 0 else idv_crd_sco_val end as zx_score
    ,scor_rng
from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
where dt='20250630'
and report_dsc_rn=1
;
-- 最近一次预评估
DROP   TABLE IF     EXISTS SJXQ_SJ20250630201_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250630201_CST_03 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
	,t3.rul_set_rslt_nm as rul_set_rslt_nm2
	,COALESCE(t2.rul_set_rslt_nm,t3.rul_set_rslt_nm) as 预评估结果
from(
	SELECT CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250630'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20250630'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250630'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left JOIN (
    SElECT t1.PRE_ASES_SERNO
    from edw.dwd_bus_loan_lmt_aply_rel_ases_dd  t1   --授信关联预评估信息表
    LEFT JOIN edw.dwd_code_library_dd               c1
    ON  t1.RUL_SET_RSLT_CD = c1.cd_val
    AND c1.DT = '20250630'
    AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND c1.fld_nm = 'RUL_SET_RSLT_CD'
    where t1.DT = '20250630'
	GROUP BY t1.PRE_ASES_SERNO
)T3 ON T1.PRE_ASES_SERNO = T3.PRE_ASES_SERNO
where t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250630201_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250630201_CST_04 AS
SELECT  '20250630'                              AS 数据时间
       ,t1.cst_id                               AS 客户号
       ,t2.cst_chn_nm                           AS 客户名称
       ,t3.sys_reg_tm                           AS 最近一次预评估时间
       ,t3.预评估结果                           AS 最近一次预评估结果
       ,t4.prd_dt       as 中征分日期
       ,t4.scor_rng_mod as 中征分数段
       ,nvl(t8.prd_dt,t7.report_dt)             AS 征信报告日期
       ,t8.scor_rng_mod                         AS 征信分数段
       ,t5.量化风险等级
       ,t1.prm_mgr_id                           AS 主管护客户经理工号
       ,t1.prm_mgr_nm                           AS 主管护客户经理姓名
       ,t1.prm_org_id                           AS 主管护机构号
       ,t1.prm_org_nm                           AS 主管户机构名称
       ,decode(t2.cst_typ_cd,'1','个人','2','对公') AS 客户类型
       ,t6.lgp_cst_id                           AS 对公客户法人客户号
       ,t6.lgp_nm                               AS 对公客户法人客户名称
from(
    select distinct t1.cst_id                        --客户号
        ,t3.prm_mgr_id                               --主管护客户经理工号
        ,t3.prm_mgr_nm                               --主管护客户经理姓名
        ,t3.prm_org_id                               --主管护机构号
        ,t3.prm_org_nm                               --主管户机构名称
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
    on  t1.cst_id = t3.cst_id
    and t3.dt = t1.dt
    inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
    on  t3.prm_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm='绍兴分行'
    where t1.dt='20250630'
)t1 left join edw.DWS_CST_BAS_INF_DD        t2
on t1.cst_id=t2.cst_id
and t2.dt='20250630'
left join SJXQ_SJ20250630201_CST_03     t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20250630201_CST_01     t4
on t1.cst_id=t4.cst_id
and t4.rn=1
left join(
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250630'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250630'
)t5 on t1.cst_id=t5.cst_id
left join edw.dim_cst_entp_lgp_inf_dd   t6 --对公客户法人信息表
on t1.cst_id=t6.cst_id
and t6.dt='20250630'
left join edw.dws_cst_ccrc_entp_ind_inf_dd	t7 --企业征信指标信息表
on t1.cst_id=t7.cst_id
and t7.dt='20250630'
and t7.report_dsc_rn=1
left join SJXQ_SJ20250630201_CST_02     t8
on t1.cst_id=t8.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250630201_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250630201_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250630201_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250630201_CST_04
;
/*
01	2238170	2238170
02	5877775	5877775
03	5775440	5775440
04	66583	66583
*/
SElECT '04' seq, *
from SJXQ_SJ20250630201_CST_04
;
***鲁豪杰_SJ2025073176_绍兴贷后风险分层.sql
-- 鲁豪杰_SJ2025073176_绍兴贷后风险分层
-- 截止25年7月31日，绍兴分行所有客户在我行的最新征信分、预评估结果以及贷后风险分层类型。
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2025073176_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025073176_CST_01 AS
select cst_id,prd_dt,cst_cr_grd_val
	,nvl(cst_cr_grd_val,0) as zz_score
	,scor_rng
	,row_number() over(partition by cst_id order by prd_dt desc) rn
from(
	SELECT cst_id,prd_dt,cst_cr_grd_val,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20250731'
    union
	SELECT cst_id
		,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
		,cr_sco_val                          AS cst_cr_grd_val
		,scor_rng
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20250731'
)t where nvl(cst_id,'')<>''
;
-- 征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2025073176_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025073176_CST_02 AS
SELECT cst_id,REPLACE(substr(report_dt,1,10),'-','') as prd_dt
    ,idv_crd_sco_val
    ,case when idv_crd_sco_val is null or idv_crd_sco_val <=0 then 0 else idv_crd_sco_val end as zx_score
    ,scor_rng
from edw.dws_cst_ccrc_idv_ind_inf_dd    --个人征信指标信息表
where dt='20250731'
and report_dsc_rn=1
;
-- 最近一次预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2025073176_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025073176_CST_03 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,T1.PRE_ASES_SERNO
    ,t1.sys_reg_tm	    --系统登记时间
    ,t2.rul_set_rslt_nm --新预评估结果
	,t3.rul_set_rslt_nm as rul_set_rslt_nm2
	,COALESCE(t2.rul_set_rslt_nm,t3.rul_set_rslt_nm) as 预评估结果
from(
	SELECT CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by sys_reg_tm desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20250731'
)t1 left JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20250731'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20250731'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left JOIN (
    SElECT t1.PRE_ASES_SERNO
    from edw.dwd_bus_loan_lmt_aply_rel_ases_dd  t1   --授信关联预评估信息表
    LEFT JOIN edw.dwd_code_library_dd               c1
    ON  t1.RUL_SET_RSLT_CD = c1.cd_val
    AND c1.DT = '20250731'
    AND c1.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND c1.fld_nm = 'RUL_SET_RSLT_CD'
    where t1.DT = '20250731'
	GROUP BY t1.PRE_ASES_SERNO
)T3 ON T1.PRE_ASES_SERNO = T3.PRE_ASES_SERNO
where t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025073176_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025073176_CST_04 AS
SELECT  '20250731'                              AS 数据时间
       ,t1.cst_id                               AS 客户号
       ,t2.cst_chn_nm                           AS 客户名称
       ,t3.sys_reg_tm                           AS 最近一次预评估时间
       ,t3.预评估结果                                AS 最近一次预评估结果
       ,t4.prd_dt                               AS 中征分日期
       ,t4.scor_rng_mod                         AS 中征分数段
       ,nvl(t8.prd_dt,t7.report_dt)             AS 征信报告日期
       ,t8.scor_rng_mod                         AS 征信分数段
       ,t5.量化风险等级
       ,t1.prm_mgr_id                           AS 主管护客户经理工号
       ,t1.prm_mgr_nm                           AS 主管护客户经理姓名
       ,t1.prm_org_id                           AS 主管护机构号
       ,t1.prm_org_nm                           AS 主管户机构名称
       ,decode(t2.cst_typ_cd,'1','个人','2','对公') AS 客户类型
       ,t6.lgp_cst_id                           AS 对公客户法人客户号
       ,t6.lgp_nm                               AS 对公客户法人客户名称
from(
    select distinct t1.cst_id                        --客户号
        ,t3.prm_mgr_id                               --主管护客户经理工号
        ,t3.prm_mgr_nm                               --主管护客户经理姓名
        ,t3.prm_org_id                               --主管护机构号
        ,t3.prm_org_nm                               --主管户机构名称
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
    on  t1.cst_id = t3.cst_id
    and t3.dt = t1.dt
    inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
    on  t3.prm_org_id = t4.org_id
    and t4.dt = t1.dt
    and t4.brc_org_nm='绍兴分行'
    where t1.dt='20250731'
)t1 left join edw.DWS_CST_BAS_INF_DD        t2
on t1.cst_id=t2.cst_id
and t2.dt='20250731'
left join SJXQ_SJ2025073176_CST_03     t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2025073176_CST_01     t4
on t1.cst_id=t4.cst_id
and t4.rn=1
left join(
    select cst_id
        ,replace(risk_layer_level_10,'在逾','在逾/重组') as 量化风险等级
        --'客户分层等级_10级_加调整项' -- 基于risk_model_score_adj、谋超阈值划分的10级等级
    from lab_bigdata_dev.quant_portr_base_adj_idv_cst_credit_score_bas_info_v2_dd
    where dt = '20250731'
    union
    select cst_id
        ,replace(RISK_MODEL_LEVEL_TEN,'在逾','在逾/重组')
    from lab_bigdata_dev.quant_portr_base_entp_cst_credit_score_bas_info_dd
    where dt = '20250731'
)t5 on t1.cst_id=t5.cst_id
left join edw.dim_cst_entp_lgp_inf_dd   t6 --对公客户法人信息表
on t1.cst_id=t6.cst_id
and t6.dt='20250731'
left join edw.dws_cst_ccrc_entp_ind_inf_dd	t7 --企业征信指标信息表
on t1.cst_id=t7.cst_id
and t7.dt='20250731'
and t7.report_dsc_rn=1
left join SJXQ_SJ2025073176_CST_02     t8
on t1.cst_id=t8.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025073176_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025073176_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025073176_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2025073176_CST_04
;
/*
01	2238170	2238170
02	5877775	5877775
03	5775440	5775440
04	66583	66583
adm_rsk.adm_rsk_apl_inter_all	风险集市-资产质量监测表	66	rsk_lvl	string	贷后风险判断
adm_rsk.adm_rsk_apl_inter_all	风险集市-资产质量监测表	69	rsk_lvl_bef	string	出险前贷后风险判断
    ,t6.rsk_lyr_cd	    --风险分层代码|c1
    ,decode(t6.rsk_lyr_cd,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险','') AS 风险分层 --不是合同表的客户风险等级
edw.dwd_bus_loan_lmt_biz_stat_inf_dd
*/
SElECT '04' seq, *
from SJXQ_SJ2025073176_CST_04
***黄思瑶_SJ2025032716_交易问题排查.sql
-- 注意事项：核查日期
-- 2023年7月1日2025年3月，联网核查结果是证件号码不存在但后续发生过交易的客户数据，包括总行和各村行；
-- 联网核查结果是在'20240812'批量导入的历史数据，以后才是每天更新
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_01 AS
select t1.bank_name                                --核查机构名称
	,t1.bank_code2                               --核查机构网点代码
	,t1.checkdate                                --联网核查日期
	,t1.checktime                                --联网核查时间
	,t1.name                                     --公民姓名
	,t1.id_no                                    --居民身份证件号码
	,t1.counter_no                               --柜员号
    ,t2.empe_nm
    ,T8.POS_NM                                   --职位名称
	,t1.purpose                                  --摘要
    ,t3.cst_id  as cst_id_chk
    ,row_number() over(partition by t1.id_no order by t1.checkdate,t1.checktime) rn_asc
    -- ,row_number() over(partition by t1.id_no order by t1.checkdate desc,t1.checktime desc) rn_desc
from adm_upss.aml_t3r_lwhc_log      t1 --公民联网核查日志记录表
left join edw.dws_hr_empe_inf_dd    t2 --员工信息汇总
on  t1.counter_no=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd    t3 --客户基础信息汇总表
on t1.id_no=t3.doc_nbr
and t3.dt=t1.checkdate
and t3.dt BETWEEN '20230701' AND '20250331'
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD T8 --职位信息
ON      T2.POS_ENC = T8.POS_ID
AND     T8.DT = '@@{yyyyMMdd}'
where t1.dt BETWEEN '20230701' AND '20250331'
and t1.checkdate BETWEEN '20230701' AND '20250331'
and nvl(t1.id_no,'')<>''
and t1.result = '15' --号码不存在
;
-- 后续发生过交易的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_02 AS
select t1.id_no,t1.checkdate
    ,t2.cst_id,t2.cst_chn_nm,t2.doc_nbr
    ,t3.cst_act_id
	,t3.cst_act_typ_cd                           --客户账户类型代码|C1
	,t3.cst_act_nm                               --客户账户名称|C200
	,t3.act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     as act_sts_nm
	,t3.opn_org_id                               --开户机构编号|C12
    ,t5.org_nm          as opn_org_nm
	,t3.opn_dt                                   --开户日期|C8
	,t3.opn_tlr_id                               --开户柜员编号|C10
    ,t6.empe_nm         as opn_tlr_nm
	,t3.dstr_act_dt                              --销户日期|C8
    ,t4.存款账号
    ,t4.存款账号状态
from SJXQ_SJ2025032716_CST_01       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.id_no=t2.doc_nbr
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_bus_dep_cst_act_inf_dd t3 --客户存款账户信息
on t2.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join (
    select t1.cst_act_id
    from edw.dws_bus_dep_act_inf_dd     t1             --存款账户信息汇总
    left join edw.dwd_code_library_dd   C1
    ON  T1.act_sts_cd = C1.CD_VAL
    AND C1.tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
    AND C1.FLD_NM='ACT_STS_CD'
    AND C1.DT = '@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    group by t1.cst_act_id
)t4 on t3.cst_act_id=t4.cst_act_id
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t3.opn_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd    t6 --员工信息汇总
on  t3.opn_tlr_id=t6.empe_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   C1
ON  T3.act_sts_cd = C1.CD_VAL
AND C1.tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
AND C1.FLD_NM='ACT_STS_CD'
AND C1.DT = '@@{yyyyMMdd}'
where t1.rn_asc=1   --首次号码不存在核查
;
--交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_03 AS
select t1.id_no,t1.cst_act_id,t1.checkdate
    ,t2.dep_act_id                               --存款账号|C32
	,t2.dtl_seq_nbr                              --明细序号|INTEGER
	,t2.trx_dt                                   --交易日期|C8
	,t2.trx_tm                                   --交易时间|C9
	,t2.crd_and_dbt_ind                          --借贷标志|C1
	,t2.trx_ccy_cd                               --交易币种代码|C3
	,t2.act_cr_ind                               --账户钞汇标志|C1
	,t2.trx_amt                                  --交易金额|DECIMAL(21,2)
	,t2.act_bal                                  --账户余额|DECIMAL(21,2)
	,t2.sub_act_seq_nbr                          --子账户序号|C8
	,t2.txt_code                                 --摘要代码|C10
	,t2.smr_dscr                                 --摘要描述|C512
	,t2.trx_chnl_cd                              --交易渠道代码 A01柜面
	,t2.csh_ind                                  --现转标志|C1
	,t2.cnt_pty_cst_act_id                       --对方客户账号
	,t2.cnt_pty_act_nm                           --对方户名|c200
	,t2.cnt_pty_cst_typ_cd                       --对方客户类型代码
	,t2.agn_nm                                   --代理人姓名|C200
	,t2.agn_doc_typ_cd                           --代理人证件类型代码
	,t2.tlr_srl_nbr                              --柜员流水号|C32
	,t2.trx_bus_org                              --交易营业机构|C12
	,t2.opn_org                                  --开户机构|C12
	,t2.opr_tlr                                  --操作柜员|C10
	,t2.cmt                                      --备注|C200
	,t2.act_nm                                   --账户名称|C200
from SJXQ_SJ2025032716_CST_02               t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2          --存款账户余额发生明细
on t1.cst_act_id=t2.cst_act_id
and t1.checkdate<t2.trx_dt
and t2.dt BETWEEN '20230701' AND '20250331'
and t2.bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 输出结果1 核查记录明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_04 AS
SELECT  t1.bank_name  AS 核查机构名称
       ,t1.bank_code2 AS 核查机构网点代码
       ,t1.checkdate  AS 联网核查日期
       ,t1.checktime  AS 联网核查时间
       ,t1.name       AS 公民姓名
       ,t1.id_no      AS 居民身份证件号码
       ,t1.counter_no AS 柜员号
       ,t1.empe_nm    AS 柜员名称
       ,t1.POS_NM     AS 职位名称
       ,t1.purpose    AS 摘要
       ,t1.rn_asc     AS 核查顺序
from SJXQ_SJ2025032716_CST_01 t1
where id_no in(
    select distinct id_no from SJXQ_SJ2025032716_CST_03
);
-- 输出结果2 账户明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_05 AS
SELECT  t1.cst_act_id                         AS 客户账号
       ,t3.cst_id_chk                         AS 客户号
       ,t2.trx_cnt                            AS 流水笔数
       ,t2.柜面渠道交易次数
       ,t3.id_no                              AS 核查证件号码
       ,t3.name                               AS 核查姓名
       ,t3.counter_no                         AS 核查柜员号
       ,t3.empe_nm                            AS 核查柜员名称
       ,t3.POS_NM                             AS 核查职位名称
       ,t3.bank_code2                         AS 核查机构网点代码
       ,t3.bank_name                          AS 核查机构名称
       ,decode(t4.is_empe_chk,0,'否',1,'是')    AS 是否有人工核查记录
       ,concat(t3.checkdate,' ',t3.checktime) AS 核查记录最早一次时间
       ,t4.核查记录最后一次时间
       ,t1.opn_org_id                         AS 开户机构编号
       ,t1.opn_org_nm                         AS 开户机构
       ,t1.opn_tlr_id                         AS 开户柜员编号
       ,t1.opn_tlr_nm                         AS 开户柜员
       ,t1.opn_dt                             AS 开户日期
       ,t1.dstr_act_dt                        AS 销户日期
       ,t1.cst_id                             AS 账户号当前对应的客户号
       ,t1.cst_chn_nm                         AS 账户号当前对应的客户名称
       ,t1.doc_nbr                            AS 账户号当前对应的客户证件号
       ,t1.act_sts_nm                         AS 客户账号状态
    ,t1.存款账号
    ,t1.存款账号状态
       ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END  AS 是否止付
       ,T5.frz_dt                                                   AS 止付日期
       ,T5.act_stop_pmt_typ_cd                                      AS 止付类型代码
       ,T5.act_stop_pmt_typ                                         AS 止付类型
       ,T5.frz_cls_cd                                               AS 止付种类代码
       ,T5.frz_cls                                                  AS 止付种类
       ,T5.frz_rsn                                                  AS 止付原因
       ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END  AS 是否关闭非柜面
       ,T7.close_fg_rsn                                             AS 关闭非柜原因
       ,t7.lmt_eft_dt   as 关闭非柜生效日期
from SJXQ_SJ2025032716_CST_02 t1
left join(
    select cst_act_id,count(1) as trx_cnt
        ,sum(case when trx_chnl_cd ='A01' then 1 else 0 end) as 柜面渠道交易次数
    from SJXQ_SJ2025032716_CST_03
    group by cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
left join SJXQ_SJ2025032716_CST_01 t3
on t1.id_no=t3.id_no
and t3.rn_asc=1
left join(
    select id_no
        ,max(case when empe_nm is not null then 1 else 0 end) as is_empe_chk
        ,max(concat(checkdate,' ',checktime)) as 核查记录最后一次时间
    from SJXQ_SJ2025032716_CST_01
    group by id_no
)t4 on t1.id_no=t4.id_no
LEFT JOIN
(
	SELECT  t1.cst_act_id
	       ,t1.frz_dt
	       ,t1.frz_rsn
	       ,t1.frz_cls_cd
	       ,c1.cd_val_dscr frz_cls --止付种类
	       ,t1.ACT_STOP_PMT_TYP_CD
	       ,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
	       ,ROW_NUMBER() OVER (PARTITION BY cst_act_id ORDER BY  frz_dt DESC) rn
	FROM edw.dwd_bus_dep_frz_inf_dd t1 --账户冻结登记
	LEFT JOIN edw.dwd_code_library_dd c1
	ON t1.frz_cls_cd = c1.cd_val AND c1.tbl_nm = 'DWD_BUS_DEP_FRZ_INF_DD' AND c1.fld_nm = 'FRZ_CLS_CD' AND c1.dt = '@@{yyyyMMdd}'
	LEFT JOIN edw.dwd_code_library_dd c2
	ON t1.frz_cls_cd = c2.cd_val AND c2.tbl_nm = 'DWD_BUS_DEP_FRZ_INF_DD' AND c2.fld_nm = 'ACT_STOP_PMT_TYP_CD' AND c2.dt = '@@{yyyyMMdd}'
	WHERE t1.DT = '@@{yyyyMMdd}'
	AND t1.FRZ_SRC_CD = '2' --止付
	AND t1.NFRZ_IND = '0'
) t5 --止付
ON t1.cst_act_id = t5.cst_act_id AND t5.rn = 1
LEFT JOIN
(
	SELECT  cst_act_id
	       ,lmt_eft_dt
	       ,lmt_cmt close_fg_rsn
	       ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY  lmt_eft_dt DESC ) rn
	FROM edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
	WHERE DT = '@@{yyyyMMdd}'
	AND ACT_THRS_TYP = '2' --暂停非柜面
	AND evt_id = 'DPDRAW'
) t7 --关闭非柜面
ON t1.cst_act_id = t7.cst_act_id AND t7.rn = 1
WHERE t1.id_no in(
    SELECT  distinct id_no
    FROM SJXQ_SJ2025032716_CST_03
);
-- 输出结果3 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_06 AS
SELECT  t1.id_no              AS 联网核查证件号码
       ,t1.checkdate          AS 核查日期
       ,t1.dep_act_id         AS 存款账号
       ,t1.dtl_seq_nbr        AS 明细序号
       ,t1.trx_dt             AS 交易日期
       ,t1.trx_tm             AS 交易时间
       ,t1.crd_and_dbt_ind    AS 借贷标志
       ,t1.trx_ccy_cd         AS 交易币种代码
       ,t1.act_cr_ind         AS 账户钞汇标志
       ,t1.trx_amt            AS 交易金额
       ,t1.act_bal            AS 账户余额
       ,t1.cst_act_id         AS 客户账号
       ,t1.sub_act_seq_nbr    AS 子账户序号
       ,t1.txt_code           AS 摘要代码
       ,t1.smr_dscr           AS 摘要描述
       ,t1.trx_chnl_cd        AS 交易渠道代码
       ,t4.cd_val_dscr        as 交易渠道
       ,t1.csh_ind            AS 现转标志
       ,t1.cnt_pty_cst_act_id AS 对方客户账号
       ,t1.cnt_pty_act_nm     AS 对方户名
       ,t1.cnt_pty_cst_typ_cd AS 对方客户类型代码
       ,t1.agn_nm             AS 代理人姓名
       ,t1.agn_doc_typ_cd     AS 代理人证件类型代码
       ,t1.tlr_srl_nbr        AS 柜员流水号
       ,t1.trx_bus_org        AS 交易营业机构
       ,t1.opn_org            AS 开户机构
       ,t1.opr_tlr            AS 操作柜员
       ,t1.cmt                AS 备注
       ,t1.act_nm             AS 账户名称
from SJXQ_SJ2025032716_CST_03               t1
left join edw.dwd_code_library_dd           t4 --132058 tbl_nm,fld_nm,cd_val 唯一
on t1.trx_chnl_cd = t4.cd_val
and t4.dt='@@{yyyyMMdd}'
;
-- 2023年7月1日2025年3月开户或者期间发生交易的账户，一人代理开立5户及以上账户清单，包括总行和各村行；
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_07 AS
select cst_act_id                         --客户账号|C32
from edw.dws_bus_dep_act_inf_dd           --存款账户信息汇总
where dt='@@{yyyyMMdd}'
and opn_dt between '20230701' AND '20250331'
union
select cst_act_id
from edw.dwd_bus_dep_bal_chg_dtl_di           --存款账户余额发生明细
where dt BETWEEN '20230701' AND '20250331'
and bal_fld_nm = 'DPLDGBAL'   --动账
;
-- 银行账户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_08 AS
select bank_code1                             --开户行代码
	,self_acc_name                            --账户户名
	,cst_no                                   --客户号
	,self_acc_no                              --账号表中每个账号一条记录，不能为空；如果只有卡号无账号，填写卡号，即账号与卡号一致
    ,acc_type                                 --公私标识11：个人；12：单位
	,acc_type1                                --个人账户种类当Acc_type =11时填写：11：代表I类账户；12：代表II类账户；13：代表III类账户；14：代表信用卡账户
	,ent_cst_type                             --单位账户类型当Acc_type =12时填写，具体规范见附填写数字
	,id_no                                    --身份证件号码个人客户按照表3Id_no字段、单位客户按照表4 License字段
	,open_time                                --开户日期YYYYMMDD
	,close_time                               --销户日期YYYYMMDD
    ,agent_name                               --代理人姓名Agency_flag=11，即发生代理关系时填写
	,agent_tel                                --代理人联系方式Agency_flag=11，即发生代理关系时填写
	,agent_type                               --代理人身份证件种类Agency_flag=11，即发生代理关系时填写。按如下填列：11：居民身份证或临时身份证；12：军人或武警身份证件；13：港澳居民往来内地身份通行证，台湾居民来往大陆通行证或其他有效旅行证件；14：外国公民护照；19：其他类个人身份有效证件填写数字
	,agent_no                                 --代理人身份证件号码Agency_flag=11，即发生代理关系时填写
	,dt
    ,cst_act_id
from(
	SELECT T1.*,t2.cst_act_id
		,ROW_NUMBER() over(partition by T1.self_acc_no order by t1.dt desc) rn
	from adm_upss.aml_t3r_acct   		t1                  --符合特定条件的银行账户信息表
    inner join SJXQ_SJ2025032716_CST_07 t2
    on t1.self_acc_no=t2.cst_act_id
	where t1.dt BETWEEN '20230701' AND '20250331'
)t1 where t1.rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_09 AS
select t1.cst_act_id
    ,t2.dep_cls_cd                               --存款种类|C4
    ,c3.cd_val_dscr     as 账户类型_存款种类
	,t2.cst_id                                   --客户号|C20
    ,t3.cst_chn_nm
    ,t3.doc_nbr
    ,decode(t3.cst_typ_cd,'1','对私','2','对公','') as cst_typ_nm --客户类型|C1
    ,t2.cst_tp
	,t2.opn_org                                  --开户机构编号|C12
    ,c1.org_nm      as 开户机构
	,t2.act_opn_tlr                              --开户柜员编号|C10
    ,c2.empe_nm     as 开户柜员
	,t2.opn_dt                                   --开户日期|C8
	,t2.act_dstr_act_dt                          --销户日期|C8
    ,t4.prm_mgr_id
    ,t4.prm_mgr_nm
    ,t4.prm_org_id
    ,t5.org_nm
    ,t6.agn_doc_typ                              --代理人证件类型代码|c5
    ,c4.cd_val_dscr     as agn_doc_typ_nm
    ,t6.agn_doc_nbr                              --代理人证件号码|c60
    ,t6.agn_nm                                   --代理人名称|c200
    ,t6.agn_tel                                  --代理人电话|c16
from SJXQ_SJ2025032716_CST_07           t1
inner join edw.dws_bus_dep_act_inf_dd   t2 --存款账户信息汇总
on t1.cst_act_id=t2.cst_act_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd        t3 --客户基础信息汇总表
on t2.cst_id=t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t4 --客户`主管户`信息
on  t2.cst_id = t4.cst_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t4.prm_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            c1 --考核机构树
on  t2.opn_org = c1.org_id
and c1.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                c2 --员工信息汇总
on  t2.act_opn_tlr=c2.empe_id
and c2.dt='@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT DISTINCT cst_id
	    ,cst_act_id
        ,agn_doc_typ                              --代理人证件类型代码|c5
        ,agn_doc_nbr                              --代理人证件号码|c60
        ,agn_nm                                   --代理人名称|c200
        ,agn_tel                                  --代理人电话|c16
	FROM edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd --代理业务交易登记簿
	WHERE dt = '@@{yyyyMMdd}'
	AND agn_bus_typ = '1' --代理业务类型代码:代理开户
) T6
ON T2.cst_id = T6.cst_id AND T1.cst_act_id = T6.cst_act_id
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON t2.dep_cls_cd = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd c4
ON      T6.agn_doc_typ = c4.cd_val
AND     c4.tbl_nm = 'DWD_BUS_DEP_BAL_CHG_DTL_DI'
AND     c4.fld_nm = 'AGN_DOC_TYP_CD'
AND     c4.DT = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025032716_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025032716_CST_10 AS
SELECT  t1.cst_act_id      AS 客户账号
       ,t1.账户类型_存款种类
       ,t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户姓名
       ,t1.doc_nbr         AS 客户证件号
       ,t1.cst_typ_nm      AS 客户类型
       ,t1.agn_nm          AS 代理人名称
       ,t1.agn_tel         AS 代理人电话
       ,t1.agn_doc_typ_nm  AS 代理人证件类型
       ,t1.agn_doc_nbr     AS 代理人证件号码
       ,t1.opn_org         AS 开户机构编号
       ,t1.开户机构
       ,t1.act_opn_tlr     AS 开户柜员编号
       ,t1.开户柜员
       ,t1.prm_org_id      AS 主管户机构号
       ,t1.org_nm          AS 主管户机构
       ,t1.prm_mgr_nm      AS 主管户人
       ,t1.opn_dt          AS 开户日期
       ,t1.act_dstr_act_dt AS 销户日期
from SJXQ_SJ2025032716_CST_09 t1
inner join(
    select agn_doc_nbr
    from SJXQ_SJ2025032716_CST_09 t1
    where nvl(agn_doc_nbr,'')<>''
    group by agn_doc_nbr having count(distinct cst_act_id)>=5
)t2 on t1.agn_doc_nbr=t2.agn_doc_nbr
;
SElECT '01' seq, count(1) cnt,count(distinct id_no) custs
from SJXQ_SJ2025032716_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025032716_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025032716_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 居民身份证件号码) custs
from SJXQ_SJ2025032716_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025032716_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025032716_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025032716_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025032716_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2025032716_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2025032716_CST_10
***黄河_SJ20250612141_金华分行对公法人受益人.sql
﻿-- 黄河_SJ20250612141_金华分行对公法人受益人
-- 截至2025年5月底，有多少对公客户的受益所有人识别为客户的法定代表人？
-- 截至2025年5月底，存量对公客户数量有多少？
-- 截至2025年5月底，有多少对公客户的受益所有人信息仍缺失？
--客户担任法人的企业 关联企业
DROP   TABLE IF     EXISTS SJXQ_SJ20250612141_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250612141_CST_01 AS
select t1.cst_id    as 客户号
    ,t1.cst_nm      as 客户名称
    ,t2.lgp_cst_id  as 法定代表人客户号
    ,t2.lgp_nm      as 法定代表人客户名称
    ,t5.受益所有人
    ,case when nvl(t2.lgp_cst_id,'')<>'' and t5.受益所有人 regexp t2.lgp_cst_id then 1
        when nvl(t2.lgp_nm,'')<>'' and t5.受益所有人 regexp t2.lgp_nm then 1
        else 0 end as 法人是否受益人
    ,case when t5.受益所有人 is null then 1 else 0 end as 是否受益所有人缺失
    ,t3.prm_mgr_id      as 主管护客户经理工号
	,t3.prm_mgr_nm      as 主管护客户经理姓名
	,t3.prm_org_id      as 主管护机构号
	,t3.prm_org_nm      as 主管户机构名称
    ,t6.cst_act_id       AS 客户账号
    ,t6.dep_act_id       AS 存款账号
    ,t6.act_sts_cd       AS 存款账户状态代码
    ,c1.cd_val_dscr      AS 存款账户状态
    ,t6.act_cls_frz_ind  AS 账户封闭冻结标志_不收不付
    ,t6.act_stop_pmt_ind AS 账户只收不付标志
    ,case when t7.cst_act_id is not null then '是' else '否' end as 暂停非柜面
from edw.dim_cst_entp_bas_inf_dd            t1 --企业客户基本信息
left join edw.dim_cst_entp_lgp_inf_dd       t2 --对公客户法人信息表
on t1.cst_id=t2.cst_id
and t2.dt='20250531'
inner join adm_pub.adm_csm_cbas_mng_inf_dd  t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20250531'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20250531'
and t4.brc_org_nm='金华分行'
left join(
    SELECT substr(party_id,3,10) as cst_id
    from adm_upss.adm_upss_aml_t47_beneficiary     --对公客户受益所有人表
    where dt='20250531'
    GROUP BY cst_id
)t5 on t1.cst_id=t5.cst_id
inner join edw.dws_bus_dep_act_inf_dd t6
on t1.cst_id=t6.cst_id
and t6.dt=t1.dt
and t6.act_sts_cd <> 'C'   --剔除 已销户和未开户
left join edw.dwd_code_library_dd   c1
on t6.act_sts_cd = c1.cd_val
and c1.dt = '20250531'
left join (
    SELECT  cst_act_id,lmt_eft_dt,lmt_cmt close_fg_rsn
            ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
    FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
    WHERE   DT = '20250531'
    AND     ACT_THRS_TYP = '2' --暂停非柜面
    AND     evt_id = 'DPDRAW'
)t7 on t6.cst_act_id=t7.cst_act_id
and t7.rn=1
where t1.dt='20250531'
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250612141_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ20250612141_CST_01
;
***黄洁_SJ2025041671_旬阳村行贵金属宝石客户.sql
﻿/*注：
一、总体要求
（一）填写内容
1.本概览适用于贵金属和宝石行业代表性从业机构。请各填报单位严格按照&ldquo;能填尽填&rdquo;原则填写各指标项内容，若本级单位不掌握相关信息时，请在对应&ldquo;备注&rdquo;栏目说明有关情况。
2.为便于后期统计，请勿随意更改表格格式。
（二）数据要求
1.时间序列：时点数，即截至统计期末的数量，本表统计当年度末数据；时期数，即统计期间内的数量，本表统计当年度内数据。
2.填写要求：对于添加批注的指标项，均为固定内容，可对应选择一个或多个选项。对于涉及日期、时间的指标项，请均以年-月-日为格式填写。对于涉及金额的指标项，请统一以&ldquo;人民币&rdquo;作为币种进行折算填写。
二、本子表可同时作为所有从业机构的监管名录使用。
三、本子表各项指标信息可通过国家企业信用信息公示系统、天眼查、企查查等外部公开渠道获取，仅&ldquo;是否属于代表性从业机构&rdquo;一项需根据工作需要选择。
*/
--企业客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025041671_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041671_CST_01 AS
select t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.entp_ecn_typ_cd	--	企业经济类型代码|C3
    ,c2.cd_val_dscr     as entp_ecn_typ_nm
    ,case when c2.cd_val_dscr regexp '有限责任' then '有限责任公司'
        when c2.cd_val_dscr regexp '股份有限' then '股份有限公司'
        when c2.cd_val_dscr regexp '个体' then '个体工商户'
        else '其他机构' end  as entp_ecn_typ_nm2
	,t1.opr_scp_dscr                             --经营范围描述|C3000
	,t1.idt_ctg_cd                               --行业分类代码|C10
    ,c1.cd_val_dscr     as idt_ctg_nm
	,t1.lctax_cert_no                            --地税证件号|C60
    ,t1.opr_situ_cd	--	经营状况代码|C4
    ,c3.cd_val_dscr     as opr_situ_nm
    ,t1.cls_entp_ind	--关停企业标志|C1
    ,t1.org_org_found_dt	--	组织机构成立日期|C8
    ,t1.reg_cpt	    --	注册资本|DECIMAL(20,2)
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.mbl_nbr	--	手机|C32
    ,case when length(t5.mbl_nbr)<length(t5.fml_tel_nbr) then t5.fml_tel_nbr else t5.mbl_nbr end AS mbl_nbr2
    ,t5.cmp_tel_nbr      --公司电话
    ,t5.reg_adr	--	户籍地址|注册地址|C256
from edw.dim_cst_entp_bas_inf_dd        t1  --企业客户基本信息
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm = '陕西旬阳泰隆村镇银行'
left join edw.dwd_code_library_dd       c1
on t1.idt_ctg_cd = c1.cd_val
and c1.dt=t1.dt
left join edw.dwd_code_library_dd       c2
on t1.entp_ecn_typ_cd = c2.cd_val
and c2.dt=t1.dt
left join edw.dwd_code_library_dd       c3
on t1.opr_situ_cd = c3.cd_val
and c3.dt=t1.dt
left join edw.dws_cst_bas_inf_dd 		t5		    --客户基础信息汇总表
on  t1.cst_id = t5.cst_id
and t5.dt = t1.dt
where t1.dt='20241231'
--and t1.opr_situ_cd like '01%' --未关停
and (
    concat(t1.cst_nm,t1.opr_scp_dscr) regexp '贵金属|宝石'
    or t1.idt_ctg_cd regexp '^(B092|B0929|B1093|C2438|C322|C3229|C3253|F5245)'
)
;
-- 工商信息
DROP   TABLE IF     EXISTS SJXQ_SJ2025041671_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041671_CST_02 AS
SELECT *
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC) AS RN
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY is_abnormal desc,GEB_HOSTSENDTIME asc) AS RN2
FROM    (
    SELECT  GEB_ENTNAME             --客户名称
        ,GEB_CREDITCODE             --统一社会信用代码
        ,GEB_ENTTYPE                --企业机构类型
        ,GEB_FRNAME                 --法定代表人负责人执行事务合伙人
        ,GEB_ENTSTATUS              --经营状态
        ,GEB_RECCAP                 --实收资本万元
        ,GEB_REGCAPCUR              --注册资本币种
        ,GEB_REGORGCITY             --所在城市
        ,GEB_REGORGDISTRICT         --所在区县
        ,GEB_ZSOPSCOPE              --经营业务范围
        ,GEB_DOM                    --住所
        ,GEB_INDUSTRYCONAME         --国民经济代码名称
        ,geb_esdate                 --成立日期
        ,geb_othertel               --其他电话
        ,GEB_HOSTSENDTIME           --geb_hostsendtime 交易发送主机时间
        ,geb_regorgprovince         --所在省份
        ,geb_regorgcode             --注册地址行政编号
    FROM    edw.OUTD_GS_ENTINFO_BASIC   --工商企业-企业基本信息
    WHERE   dt <= '@@{yyyyMMdd}'
    UNION ALL
    SELECT  dt_entname             AS GEB_ENTNAME
        ,dt_creditcode         AS GEB_CREDITCODE
        ,dt_enttype            AS GEB_ENTTYPE
        ,dt_frname             AS GEB_FRNAME
        ,dt_entstatus          AS GEB_ENTSTATUS
        ,dt_reccap             AS GEB_RECCAP
        ,dt_regcapcur          AS GEB_REGCAPCUR
        ,dt_regorgcity         AS GEB_REGORGCITY
        ,dt_regorgdistrict     AS GEB_REGORGDISTRICT
        ,dt_zsopscope          AS GEB_ZSOPSCOPE
        ,dt_dom                AS GEB_DOM
        ,dt_industryconame     AS GEB_INDUSTRYCONAME
        ,dt_esdate             AS geb_esdate
        ,dt_othertel           AS geb_othertel
        ,insert_time_chinadaas AS GEB_HOSTSENDTIME
        ,dt_regorgprovince     AS geb_regorgprovince
        ,dt_regorgcode         AS geb_regorgcode
    FROM    edw.nout_zs_ent_basic
    WHERE   dt <= '@@{yyyyMMdd}'
)a inner join SJXQ_SJ2025041671_CST_02  b
on a.GEB_CREDITCODE=b.lctax_cert_no
where length(GEB_CREDITCODE)>0 --剔除非空
;
DROP   TABLE IF     EXISTS SJXQ_SJ2025041671_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041671_CST_03 AS
select qry_srl_nbr                              --查询流水号|C30
	,qry_tm                                   --查询时间|C14
	,cst_id                                   --客户号|C20
	,cst_nm                                   --客户名称|C600
	,pmit_opr_prj                             --许可经营项目|C4000
	,aprv_dt                                  --核准日期|C50
	,dstr_dt                                  --注销日期|C50
	,csld_crd_cd                              --统一信用代码|C100
	,adr                                      --住址|C2000
	,opr_sts                                  --经营状态|C50
	,entp_typ                                 --企业类型|C300
	,entp_typ_enc                             --企业(机构)类型编码|C50
	,found_dt                                 --成立日期|C50
	,lgl_rprs                                 --法定代表人/负责人/执行事务合伙人|C300
	,entp_id                                  --企业ID|C100
	,idt_cd                                   --国民经济行业代码|C50
	,cd_nm                                    --国民经济代码名称|C100
	,reg_cpt                                  --注册资本（企业:万元）|C50
	,reg_cpt_ccy                              --注册资本币种|C100
	,opr_bus_scp                              --经营业务范围|C4000
from edw.dim_cst_out_geb_bas_inf_dd           --工商查询企业基本信息
where dt='@@{yyyyMMdd}'
and cst_id in(
    select cst_id from SJXQ_SJ2025041671_CST_01
)
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2025041671_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2025041671_CST_04 AS
SELECT  t1.cst_nm                 AS 机构全称
       ,t1.lctax_cert_no          AS 统一社会信用代码
       ,t1.org_org_found_dt       AS 成立日期
       ,t1.entp_ecn_typ_nm        AS 企业类型
       ,t1.entp_ecn_typ_nm2       AS 企业类型2
       ,t1.idt_ctg_nm             AS 所属行业
       ,t1.opr_scp_dscr           AS 经营范围
       ,t3.lgp_nm                 AS 法定代表人
       ,t1.opr_situ_nm            AS 经营状况
       ,round(t1.reg_cpt/10000,2) AS 注册资本_万
       ,t1.reg_adr                AS 注册地址
       ,t1.mbl_nbr2               AS 联系电话
       ,t1.cmp_tel_nbr            AS 公司电话
       ,''                        AS 是否属于代表性从业机构
from SJXQ_SJ2025041671_CST_01           t1
left join edw.dim_cst_entp_lgp_inf_dd   t3 --对公客户法人信息表
on t1.cst_id=t3.cst_id
and t3.dt='20250331'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041671_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct GEB_CREDITCODE) custs
from SJXQ_SJ2025041671_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2025041671_CST_03
;
***黄洁_SJ20250703196_旬阳村行对公清单.sql
-- 黄洁_SJ20250703196_旬阳村行对公清单
-- 提取旬阳村行全量对公客户清单，时点数据为2025年7月3日，时期数据为2018年1月1日-2025年7月3日。
-- 法定代表人
DROP   TABLE IF     EXISTS SJXQ_SJ20250703196_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250703196_CST_01 AS
select t1.cst_id                                   --客户号
	,t1.lgp_cst_id                               --对公客户法人客户号
	,t1.lgp_nm                                   --对公客户法人客户名称
	,t1.lgp_doc_typ_cd                           --对公客户法人证件类型
    ,c1.cd_val_dscr     as 对公客户法人证件类型
	,t1.lgp_doc_id                               --对公客户法人证件号
	,t1.lgp_doc_mtu_dt                           --对公客户法人证件到期日
    ,case when c1.cd_val_dscr regexp '身份证' then substr(t1.lgp_doc_id,7,8) else null end as birth_dt
	,t2.bth_dt                                   --出生日期|C8
from edw.dim_cst_entp_lgp_inf_dd        t1             --对公客户法人信息表
left join edw.dim_cst_idv_bas_inf_dd    t2             --个人客户基本信息
on t1.lgp_cst_id=t2.cst_id
and t2.dt= t1.dt
left join edw.dwd_code_library_dd   c1
on t1.lgp_doc_typ_cd = c1.cd_val
and c1.dt = t1.dt
where t1.dt='20250703'
;
--实际控制人
DROP   TABLE IF     EXISTS SJXQ_SJ20250703196_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250703196_CST_02 AS
SElECT t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
	,t2.doc_nbr     --证件号码|C60
from(
    SElECT cst_id,rel_cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20250703'
    and REL_TYP_CD='0109' --实际控制人
    union
    SElECT rel_cst_id,cst_id,REL_TYP_CD
    from edw.DIM_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20250703'
    and REL_TYP_CD='0109' --实际控制人
)t1 inner join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='20250703'
and t2.cst_typ_cd='1'   --实控人为个人客户
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '20250703'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20250703196_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20250703196_CST_03 AS
SELECT  ROW_NUMBER() over(order by t1.cst_id) AS 序号
       ,t1.cst_id                          AS 客户号
       ,t1.cst_nm                          AS 客户名称
       ,t2.doc_typ_cd                      AS 证件类型代码
       ,c1.cd_val_dscr                     AS 证件类型
       ,t1.lctax_cert_no                   AS 地税证件号
       ,t2.doc_nbr                         AS 证件号码
       ,t2.reg_adr                         AS 注册地址
       ,t1.reg_cpt                         AS 注册资本
       ,t5.lgp_nm                          AS 对公客户法人客户名称
       ,t5.对公客户法人证件类型
       ,t5.lgp_doc_mtu_dt                  AS 对公客户法人证件到期日
       ,coalesce(t5.birth_dt,t5.bth_dt)    AS 对公客户法人出生日期
       ,t6.cst_chn_nm                      AS 实际控制人
       ,t6.doc_nbr                         AS 实际控制人证件号码
       ,t7.bfi_name                        AS 受益人名称
       ,t7.gnd_cd                          AS 受益人性别代码
       ,c2.cd_val_dscr                     AS 受益人国籍
       ,t7.brth_dt                         AS 受益人出生日期
       ,t7.addr                            AS 受益人联系地址
       ,t7.cell_no                         AS 受益人联系方式
       ,t7.card_type                       AS 受益人证件类型代码
       ,t7.card_no                         AS 受益人证件号码
       ,t7.card_end_dt                     AS 受益人证件到期日期
from edw.dim_cst_entp_bas_inf_dd  t1 --企业客户基本信息
inner join edw.dws_cst_bas_inf_dd t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt=t1.dt
inner join adm_pub.adm_csm_cbas_mng_inf_dd           t3 --客户集市-客户基础-客户管户信息
on  t1.cst_id = t3.cst_id
and t3.dt = t1.dt
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = t1.dt
and t4.brc_org_nm regexp '旬阳'
left join SJXQ_SJ20250703196_CST_01  t5 --对公客户法人信息表
on t1.cst_id=t5.cst_id
left join SJXQ_SJ20250703196_CST_02  t6 --对公客户法人信息表
on t1.cst_id=t6.cst_id
left join adm_upss.adm_upss_aml_t47_beneficiary	t7 --对公客户受益所有人表
on t1.cst_id=substr(t7.party_id, 3, 10)
and t7.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd c1
on t2.doc_typ_cd = c1.cd_val
and c1.dt = t1.dt
left join edw.dim_cst_idv_bas_inf_dd    t8             --个人客户基本信息
on t7.bfi_id=t8.cst_id
and t8.dt= t1.dt
left join edw.dwd_code_library_dd   c2
on t8.ntn_cd = c2.cd_val
and c2.dt = t1.dt
where t1.dt='20250703'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250703196_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20250703196_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20250703196_CST_03
;
/*
控股股东占股比例
受益所有权关系类型
备注
受益所有权形成日期
*/
SElECT '03' seq, *
from SJXQ_SJ20250703196_CST_03