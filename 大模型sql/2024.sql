***gr取数SQL-SJ20230816121-潘包婷-011667.sql
-- 一、个人账户数据需求字段
--  客户号、账户名称、客户账号、存款账号、开户日期、开户渠道、开户柜员、
--  证件号码、年龄、性别、户籍地址、户籍省份、职业、工作单位、手机号码、手机号码是否本人、
--  是否本行员工、是否理财客户、是否信贷客户、贷款余额、新柜面标签是否工资户、是否批量开户、
--  是否存量交易中存在代发工资字样，但近3个月交易中无代发工资、总账余额、定期余额、近一年日均余额、近一年交易金额加总、近一年交易笔数加总、近一年非柜面最大日累计支出金额、
--  网银是否签约、网银开通时间、网银单笔限额、网银日累计限额、手机银行是否签约、手机银行开通时间、手机单笔限额、手机日累计限额、快捷支付日累计限额、是否设置非柜限额、非柜单笔限额、非柜日累计限额、
--  账户状态、是否关闭非柜、关闭非柜原因、是否冻结、冻结日期、冻结种类、冻结原因、是否止付、止付日期、止付类型、止付种类、止付原因、
--  开户机构名称、开户机构号、存款管户客户经理名称、存款管户客户经理工号、管户机构名称、管户机构号
SELECT COUNT(*)
from  lab_bigdata_dev.tmp_yxw_pbt_20230821_001_gr
SELECT *
from  lab_bigdata_dev.tmp_yxw_pbt_20230821_001_gr
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_pbt_20230821_001_gr PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_pbt_20230821_001_gr AS
SELECT   T1.cst_id        as  客户号
        ,T1.act_nm        as  账户名称
        ,T1.cst_act_id    as  客户账号
        ,T1.dep_act_id    as  存款账号
        ,T1.opn_dt        as  开户日期
        ,A1.cd_val_dscr   as  开户渠道
        ,T1.act_opn_tlr   as  开户柜员编号
        ,A2.empe_nm       as  开户柜员
        ,substr(T3.doc_nbr,1,6) as 证件号前6位
        ,2023-SUBSTR(T3.doc_nbr,7,4)   as   客户年龄
        ,A3.cd_val_dscr                as   性别
        ,concat(substr(regexp_replace(T3.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.reg_adr,'\\s|,',''))-6,0)),'******')   户籍地址脱敏
        ,case  WHEN  T3.reg_adr LIKE  '%省%'    then   CONCAT(substring_index(T3.reg_adr, '省', 1),'省')
               WHEN  T3.reg_adr LIKE  '%市%'    and    T3.reg_adr  REGEXP '上海|重庆|天津|北京'  then CONCAT(substring_index(T3.reg_adr, '市', 1),'市')
               WHEN  T3.reg_adr REGEXP '内蒙古|广西|西藏|宁夏|新疆'    then   CONCAT(substr(T3.reg_adr, 1,2),'自治区')
               WHEN  T3.reg_adr REGEXP '内蒙古'    then   CONCAT(substr(T3.reg_adr, 1,3),'自治区')
               WHEN  T3.reg_adr LIKE  '%特别行政区%'    and    T3.reg_adr REGEXP '香港|澳门'    then   CONCAT(substring_index(T3.reg_adr, '特别行政区', 1),'特别行政区')
               WHEN  T3.reg_adr LIKE  '%杭州市%'    then   '浙江省'
               WHEN  T3.reg_adr LIKE  '%武汉市%'    then   '湖北省'
               else  T3.reg_adr  end  AS   户籍省份
        ,A5.cd_val_dscr   as  职业
        ,concat(substr(T3.mbl_nbr,1,3),'****',substr(T3.mbl_nbr,-4))   手机号脱敏
        ,CASE  when  T22.lpm_ctfno  is null  or  T22.lpm_ctfno='' or   T22.lpm_ifrachird='0' THEN '未知'
               when  T22.lpm_ifrachird='1' and  T22.lpm_state='1'    THEN '已实名'
               when  T22.lpm_ifrachird='1' and  T22.lpm_state='2'    then  '未实名'
               else  '未知' end  as  手机号是否本人
        ,T7.own_emp_id    AS  本行员工号
--  ******************************************************************************
        ,case when T16.cst_id is not null then '是'
              else '否' end     as  是否我行贷款客户
        ,T16.ctr_bal_sum        AS  贷款余额
        ,case when T17.cst_id is not null then '是'
              else '否' end     as  是否我行理财客户
        ,CASE  WHEN  T18.kehuhaoo  is null or  T18.kehuhaoo <>'' THEN  '否'
                else  '是'  end AS  新柜面标签是否工资户
        ,CASE  WHEN  T13.cst_act_id  is null or  T13.cst_act_id <>'' THEN  '否'
                else  '是'  end AS  是否批量开户
        ,case when A7.CST_ACT_ID is not null then '是'
              else '否' end     as  是否存量工资户但最近3个月没有代发工资
        ,T1.gl_bal        as  总账余额
        ,case when T21.cst_act_id is not null then '是'
              else '否' end       AS  是否我行定期客户
        ,T21.定期余额             AS   定期余额
        -- ,T1.last_30_days_gl_bal_acml/30   as 过去30天日均余额
        -- ,T1.last_90_days_gl_bal_acml/90   as 过去90天日均余额
        -- ,T1.last_180_days_gl_bal_acml/180 AS  过去180天日均余额
        ,last_360_days_gl_bal_acml/360 AS  过去360天日均余额
        ,T10.trx_amt_sum     AS  近一年交易金额加总
        ,T10.trx_numbers     AS  近一年交易笔数加总
        ,T20.trx_amt_sum_max AS  近一年非柜面最大日累计支出金额
        ,CASE WHEN  T91.cst_id is null then  '否'
              WHEN  T91.cst_id is not null THEN  '是'
              else  '其他'  end  AS   网上银行是否签约
        ,substr(T91.客户网银开通时间,1,8)   客户网银开通日期
        ,T91.网银单笔限额
        ,T91.网银日累计限额
        ,CASE WHEN  T9.cst_id is null then  '否'
              WHEN  T9.cst_id is not null THEN  '是'
              else  '其他'  end  AS   手机银行是否签约
        ,substr(T9.客户手机开通时间,1,8)  客户手机开通日期
        ,T9.手机单笔限额
        ,T9.手机日累计限额
        ,T15.快捷支付日累计限额
        ,CASE WHEN  T8.客户账号 is null     then  '否'
              WHEN  T8.客户账号 is not null THEN  '是'
              else  '其他'  end  AS   是否设置非柜限额
        ,T8.单笔限额        as 非柜单笔限额
        ,T8.累计限额        as 非柜汇总日累计限额
        ,T1.ACT_STS_CD    as  账户状态代码
        ,T19.cd_val_dscr  as  账户状态
        ,case when T12.cst_act_id is not null then '是' else '否' end  as 是否关闭非柜面
        ,T12.lmt_cmt    as 关闭原因
        ,case when T6.cst_act_id is not null then '是' else '否'  end  as 是否冻结
        ,T6.frz_dt      AS 冻结日期
        ,A6.cd_val_dscr as 冻结类型
        ,T6.frz_rsn     as 冻结原因
        ,case when T11.cst_act_id is not null then '是' else '否' end  as 是否止付
        ,T11.frz_dt      AS  止付日期
        ,T11.act_stop_pmt_typ_cd   AS  止付类型代码
        ,a11.cd_val_dscr     AS    止付类型
        ,T11.frz_cls_cd   AS  止付种类代码
        ,A8.cd_val_dscr   as  止付种类
        ,T11.frz_rsn      as  止付原因
        ,T1.opn_org       as  开户机构编号
        ,T2.org_nm        as  开户机构名称
        ,T2.sbr_org_nm    as  开户支行名称
        ,T4.mgr_id        as 存款管户客户经理编号
        ,T5.empe_nm       as 存款管户客户经理名称
        ,T4.acs_org_id    as 存款管户客户经理考核机构编号
        ,A4.org_nm        as 存款管户客户经理考核机构
        ,A4.sbr_org_nm    as 存款管户客户经理考核支行
FROM edw.dws_bus_dep_act_inf_dd T1           -- 存款账户信息表
left join  (
    select cd_val,cd_val_dscr
    from   edw.dwd_code_library_dd
    where  dt='@@{yyyyMMdd}'
      )   A1  on T1.opn_chnl_cd=A1.cd_val
left JOIN  edw.dws_hr_empe_inf_dd  A2   ON  T1.act_opn_tlr=A2.empe_id  and A2.dt='@@{yyyyMMdd}'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd  T2      ON  T1.opn_org=T2.org_id  and T2.dt='@@{yyyyMMdd}'
left JOIN  edw.dws_cst_bas_inf_dd          T3      ON  T1.cst_id =T3.cst_id  and T3.dt='@@{yyyyMMdd}'
left JOIN  edw.dwd_bus_dep_cst_act_mgr_inf_dd T4   ON  T1.cst_act_id =T4.cst_act_id  and T4.dt='@@{yyyyMMdd}'  and T4.frs_ctc_ind = '1'
left join  edw.dws_hr_empe_inf_dd          T5      ON  T4.mgr_id=T5.empe_id     and  T5.dt='@@{yyyyMMdd}'
left JOIN  edw.dim_hr_org_mng_org_tree_dd  A4      ON  T4.acs_org_id=A4.org_id  and  A4.dt='@@{yyyyMMdd}'
left join  (	 SELECT b1.*
				 from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
                 FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     NFRZ_IND = '0') b1 where b1.rn=1
             ) T6 --账户冻结登记
on T1.cst_act_id=T6.cst_act_id
left join (select *
          from edw.dwd_code_library_dd
          where dt='@@{yyyyMMdd}'
          and fld_nm='FRZ_CLS_CD'
          and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
          ) A6
on T6.frz_cls_cd=A6.cd_val
left JOIN  (
    select    A.cst_act_id
             ,SUM(if(trx_dt>='20230601',1,0))    as thr_month_numbers
    from    edw.DIM_BUS_DEP_ACT_INF_DD  A
    left join   edw.DWD_BUS_DEP_BAL_CHG_DTL_DI  B
           ON   A.DEP_ACT_ID=B.DEP_ACT_ID
    	   AND  A.CST_ACT_ID=B.CST_ACT_ID
    	   AND  B.dt>='20210101'
        --    AND  B.dt<='20230630'
    where  A.dt='@@{yyyyMMdd}'
    and    A.opn_org  like '3302%'
    -- and    A.opn_dt>='20230101'
    -- AND    A.opn_dt<='20230630'
    and    CONCAT(B.smr_dscr,B.cmt)  regexp  '工资'
    GROUP BY  A.cst_act_id
)    A7  on T1.cst_act_id=A7.CST_ACT_ID   and  A7.thr_month_numbers=0
left join  edw.dim_cst_idv_bas_inf_dd T7  ON  T1.cst_id =T7.cst_id    and T7.dt='@@{yyyyMMdd}'
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='GDR_CD'
    and     tbl_nm='DIM_CST_IDV_BAS_INF_DD'
) A3  on   T7.gdr_cd=A3.cd_val
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='OCP_CD'
    and    tbl_nm='DIM_CST_IDV_BAS_INF_DD'
) A5  on   T7.ocp_cd=A5.cd_val
left  JOIN  (
        select
          cengcgjz 客户账号,
          danciedu 单笔限额,
          leijiedu 累计限额
        from edw.core_kdpa_zheddy -- 负债账户额度定义表
        where dt = '@@{yyyyMMdd}'
        and  zhxeleix='2'
        and shijbhao='FGMXIANE' -- 非柜面限额
        and edkzzhqi='1D' -- 日限额
)   T8  on  T1.cst_act_id=T8.客户账号
left JOIN  lab_bigdata_dev.tmp_yxw_20230324_s_p1  T9  on  T1.cst_id=T9.cst_id
left JOIN  lab_bigdata_dev.tmp_hyx_20230324_s_w1  T91 ON  T1.cst_id=T91.cst_id
left JOIN  (
--  开户日至20230630期间交易金额加总、开户日至20230630期间交易笔数加总、开户日至20230630非柜面最大日累计支出金额、
    select    A.cst_act_id
             ,A.dep_act_id
             ,SUM(B.trx_amt)     as   trx_amt_sum
             ,COUNT(1)           as   trx_numbers
    from    edw.DIM_BUS_DEP_ACT_INF_DD  A
    left join   edw.DWD_BUS_DEP_BAL_CHG_DTL_DI  B
           ON   A.DEP_ACT_ID=B.DEP_ACT_ID
    	   AND  A.CST_ACT_ID=B.CST_ACT_ID
    	   AND  B.dt>='20220801'
           AND  B.dt<='@@{yyyyMMdd}'
    where  A.dt='@@{yyyyMMdd}'
    and    A.opn_org  like '3302%'
    -- and    A.opn_dt>='20230101'
    -- AND    A.opn_dt<='20230630'
    -- and    CONCAT(B.smr_dscr,B.cmt)  regexp  '工资'
    GROUP BY  A.cst_act_id,A.dep_act_id
)    T10  on T1.cst_act_id=T10.CST_ACT_ID   and   T1.dep_act_id=T10.dep_act_id
left join  ( SELECT a1.*
			 from
                 (SELECT  *,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
                  FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                  WHERE   DT = '@@{yyyyMMdd}'
                  AND     NFRZ_IND = '0'  ) a1
                  where   a1.rn=1
             ) T11        --账户冻结登记
    on T1.cst_act_id=T11.cst_act_id
left join (select *
          from edw.dwd_code_library_dd
          where dt='@@{yyyyMMdd}'
          and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
          and fld_nm='FRZ_CLS_CD') A8
    on T11.frz_cls_cd=A8.cd_val
left  JOIN  (
    select cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where  dt='@@{yyyyMMdd}'
    AND    fld_nm='ACT_STOP_PMT_TYP_CD'
    AND    tbl_nm='DWD_BUS_DEP_FRZ_INF_DD') a11   on T11.ACT_STOP_PMT_TYP_CD=a11.cd_val
left join ( SELECT c1.*
		    from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
                 FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     ACT_THRS_TYP = '2'      --暂停非柜面
				 and evt_id='DPDRAW') c1 where c1.rn=1
             ) T12 --账户额度控制
on     T1.cst_act_id=T12.cst_act_id
left JOIN (
    SELECT
         DISTINCT '批量开户'     as   类型
                  ,T1.kehuzhao   as  cst_act_id
    FROM    edw.core_kcdb_pldlmx T1 --卡下批量代理业务明细登记簿
    INNER JOIN    edw.core_kcdb_pldlyw T2 --卡下批量代理业务登记簿
    ON      T1.weituoho = T2.weituoho
    AND     T2.DT = '@@{yyyyMMdd}'
    WHERE   T2.plywleix = '01'
    AND     T1.plmxclzt = '1'
    AND     T1.DT = '@@{yyyyMMdd}'
)   T13    on    T1.cst_act_id=T13.cst_act_id
left JOIN  (
    select act_id
         ,max(day_lmt_amt)        快捷支付日累计限额
    from edw.dwd_bus_chnl_epc_pay_agr_inf_dd     -- 快捷支付
    WHERE dt = '@@{yyyyMMdd}'
    group by act_id
)   T15  on    T1.cst_act_id=T15.act_id
left JOIN
( select   a.CST_ID
          ,SUM(ctr_bal)   as ctr_bal_sum
  from    edw.dim_bus_loan_ctr_inf_dd a
  where  a.dt='@@{yyyyMMdd}'
  GROUP BY a.CST_ID
)   T16  ON    T1.cst_id=T16.cst_id
left join
(
select distinct
          T2.CST_ID
FROM    adm_pub.adm_csm_cbus_pd_hld_inf_dd T2 --客户持有产品信息表
WHERE   T2.DT = '@@{yyyyMMdd}'
AND     T2.IS_HLD_CHM = '1'
)    T17  ON    T1.cst_id=T17.cst_id
left join  edw.core_kcpb_zhbzxx   T18   ON  T1.cst_id=T18.kehuhaoo and  T18.dt='@@{yyyyMMdd}'
left join  (
     select  cd_val,cd_val_dscr
     from    edw.dwd_code_library_dd
     where   dt='@@{yyyyMMdd}'
     and     cd_nm like '%存款账户状态%'
     AND     tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
      )   T19  on T1.act_sts_cd=T19.cd_val
left JOIN (
     SELECT  B.cst_act_id
            ,B.dep_act_id
            ,MAX(trx_amt_sum_day)  as trx_amt_sum_max
     from (
           SELECT  A.cst_act_id
                  ,A.dep_act_id
                  ,A.trx_dt
                  ,sum(trx_amt)  trx_amt_sum_day
           from  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI  A
           WHERE A.dt>='20220801'
           AND   A.dt<='@@{yyyyMMdd}'
           AND   A.crd_and_dbt_ind='D'
           and   A.smr_dscr NOT regexp '代发|代扣'
           and   A.bal_fld_nm='DPLDGBAL'
           GROUP BY  A.cst_act_id,A.dep_act_id,A.trx_dt
      ) B
      GROUP BY  B.cst_act_id,B.dep_act_id
)    T20  on T1.cst_act_id=T20.CST_ACT_ID   and   T1.dep_act_id=T20.dep_act_id
left join (
    select  cst_act_id
           ,sum(gl_bal)  定期余额
    from edw.dws_bus_dep_act_inf_dd
    where dt='@@{yyyyMMdd}'
    and lbl_prod_typ_cd='1'
    group by cst_act_id
    HAVING sum(gl_bal)>0
) T21 on T1.cst_act_id=T21.cst_act_id
left join
(   select    a.*
             ,ROW_NUMBER() over (partition by  lpm_ctfno,lpm_mobeil order by lpm_hostsendtime  desc)   as  rn
    from   edw.nout_lt_personalcert_main  a
    where  a.dt<='@@{yyyyMMdd}'
)   T22   on  T3.doc_nbr=T22.lpm_ctfno  and T3.mbl_nbr=T22.lpm_mobeil    and  T22.rn=1
AND     T1.STL_ACT_IND = '1' --结算账户
-- AND     T1.CCY_CD = '156'   --只取人民币
-- AND     T1.BAL_GL_IND <> '0' --剔除虚户
-- AND     T1.CST_ID <> '2000394435'  --剔除验资户，该客户是验资户专户
AND     T1.DT = '@@{yyyyMMdd}'
and     T1.opn_org like '3302%'
and     T1.ACT_STS_CD <>'C'
;
-- and     T1.opn_dt>='20230101'
-- AND     T1.opn_dt<='20230630';
SELECT COUNT(1)
from  lab_bigdata_dev.tmp_yxw_pbt_20230821_001_gr***qsxu_SJ2024070331_20240705.sql
-- ODPS SQL 临时查询
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-07-05 14:39:57
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJ2024060651 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJ2024060651 AS
SELECT  COALESCE(C.CST_ID, E1.CST_ID) CST_ID
        ,B.ACT
        ------,B.ACT_NM
        ,CASE
           WHEN ZFB_CNT > 0 THEN '是'
           ELSE '否'
         END 支付宝活跃
        ,CASE
           WHEN WX_CNT > 0 THEN '是'
           ELSE '否'
         END 微信活跃
        ,CASE
           WHEN C.CST_ID IS NOT NULL  THEN '借记卡'
           WHEN E1.CST_ID IS NOT NULL THEN '贷记卡'
           ELSE ''
         END 账户类型
        ,ACT_CTG_CD_2 账户分类代码
        ,COALESCE(C.OPN_DT, E1.CARD_ACTV_DT) OPN_DT
        ,COALESCE(D.ACS_ORG_ID, E.ACS_ORG_ID) ACS_ORG_ID
        ,K.SUM_ORG_ID ZHIHANG
        ,I.ORG_NM ZHIHANG_NM
        ,K1.SUM_ORG_ID FENHANG
        ,I1.ORG_NM FENHANG_NM
        ,K2.SUM_ORG_ID TUANDUI
        ,I2.ORG_NM TUANDUI_NM
        ,COALESCE(E.FRS_MGR_ID, D.MGR_ID) MGR_ID
        ,Z.EMPE_NM MGR_NM
        ,Z1.POS_ID 职位
        ,Z1.POS_NM 职位名称
FROM    (
            SELECT  ACT
                    -----ACT_NM,
                    ,SUM(CASE
                           WHEN pay_org_id = 'Z2007933000010' THEN 1
                           ELSE 0
                         END) ZFB_CNT
                    ,SUM(CASE
                           WHEN pay_org_id = 'Z2004944000010' THEN 1
                           ELSE 0
                         END) WX_CNT
            FROM    EDW.DWD_BUS_CHNL_EPC_PAY_SRL_DTL_DI
            WHERE   DT >= '20240601'
            AND     DT <= '20240630'
            AND     PAY_ORG_ID IN ( 'Z2007933000010' , 'Z2004944000010' )
            AND     TRX_TYP = '0110'
            AND     CNTR_STS = '00'
            GROUP BY ACT
        ) B
LEFT JOIN    EDW.DIM_BUS_DEP_CST_ACT_INF_DD C
ON      B.ACT = C.CST_ACT_ID
AND     C.DT = '20240704'
LEFT JOIN    EDW.DWD_BUS_DEP_CST_ACT_MGR_INF_DD D
ON      B.act = D.CST_ACT_ID
AND     D.DT = '20240704'
AND     D.FRS_CTC_IND = '1'
LEFT JOIN    edw.dwd_bus_crd_cr_crd_mgr_inf_dd E
ON      B.ACT = E.cr_crd_card_nbr
AND     E.DT = '20240704'
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd E1
ON      B.ACT = E1.cr_crd_card_nbr
AND     E1.DT = '20240704'
LEFT JOIN    app_rpt.DIM_HR_ORG_SUM_ORG_REL_DD K
ON      K.DT = '20240704'
AND     K.SUM_ORG_LVL = 'Z'
AND     K.ORG_RLTN_DIM_CD = 'WD3'
AND     K.SUM_TYP_CD = '1'
AND     COALESCE(D.ACS_ORG_ID, E.acs_org_id) = K.UNT_ORG_ID
LEFT JOIN    EDW.DIM_HR_ORG_BAS_INF_DD I
ON      I.ORG_ID = K.SUM_ORG_ID
AND     I.DT = '20240704'
LEFT JOIN    app_rpt.DIM_HR_ORG_SUM_ORG_REL_DD K1
ON      K1.DT = '20240704'
AND     K1.SUM_ORG_LVL = 'F'
AND     K1.ORG_RLTN_DIM_CD = 'WD3'
AND     K1.SUM_TYP_CD = '1'
AND     COALESCE(D.ACS_ORG_ID, E.acs_org_id) = K1.UNT_ORG_ID
LEFT JOIN    EDW.DIM_HR_ORG_BAS_INF_DD I1
ON      I1.ORG_ID = K1.SUM_ORG_ID
AND     I1.DT = '20240704'
LEFT JOIN    app_rpt.DIM_HR_ORG_SUM_ORG_REL_DD K2
ON      K2.DT = '20240704'
AND     K2.SUM_ORG_LVL = 'T'
AND     K2.ORG_RLTN_DIM_CD = 'WD3'
AND     K2.SUM_TYP_CD = '1'
AND     COALESCE(D.ACS_ORG_ID, E.acs_org_id) = K2.UNT_ORG_ID
LEFT JOIN    EDW.DIM_HR_ORG_BAS_INF_DD I2
ON      I2.ORG_ID = K2.SUM_ORG_ID
AND     I2.DT = '20240704'
------LEFT JOIN EDW.DIM_HR_EMPE_BAS_INF_DD X ON X.EMPE_ID=D.MGR_ID AND X.DT='20240704'
LEFT JOIN    EDW.DWS_HR_EMPE_INF_DD Z
ON      COALESCE(E.FRS_MGR_ID, D.MGR_ID) = Z.EMPE_ID
AND     Z.DT = '20240704'
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD Z1
ON      Z.POS_ENC = Z1.POS_ID
AND     Z1.DT = '20240704'
LEFT JOIN    (
                 SELECT  CST_ACT_ID
                         ,ACT_CTG_CD_2
                 FROM    EDW.DIM_BUS_DEP_ACT_INF_DD
                 WHERE   DT = '20240704'
                 AND     ACT_CTG_CD_2 IN ( '301' , '302' , '303' )
             ) Y
ON      B.ACT = Y.CST_ACT_ID;
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJ2024060651_2 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJ2024060651_2 AS
SELECT  FENHANG_NM
        ,ZHIHANG_NM
        ,TUANDUI_NM
        ,MGR_ID
        ,MGR_NM
        ,职位名称
        ,COUNT(DISTINCT CASE
                          WHEN 支付宝活跃 = '是' OR 微信活跃 = '是' THEN ACT
                          ELSE NULL
                        END) 当月活跃账户数
        ,COUNT(DISTINCT CASE
                          WHEN 支付宝活跃 = '是' OR 微信活跃 = '是' AND 账户类型 = '贷记卡' THEN ACT
                          ELSE NULL
                        END) 当月活跃贷记卡账户数
FROM    LAB_BIGDATA_DEV.SJ2024060651
GROUP BY FENHANG_NM , ZHIHANG_NM , TUANDUI_NM , MGR_ID , MGR_NM , 职位名称;
***SJ2023103161_PART1.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 杨森
-- 创建日期: 2023-11-01 15:26:45
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 提取截至2022年12月31日数据
DROP TABLE IF EXISTS . purge;
CREATE TABLE IF NOT EXISTS . AS
-- 1.营业网点数量  417
select
'1' as ind, count(distinct sbr_org_nm) as nm
-- distinct grp_org_nm,cpy_org_nm,brc_org_nm,sbs_org_nm,sbr_org_nm
from
edw.dim_hr_org_mng_org_tree_dd
where dt = '20221231'
and cpy_org_nm = '浙江泰隆商业银行股份有限公司'  --只取总行，不算村行
and sbr_org_nm regexp '支行|营业部'
union all
-- 2.ATM机有卡现金存取；本行借记卡（含个人卡与单位卡）在本行或他行ATM办理存取现金；2022年收付交易的总和，单位：万元
--智能现金柜：
-- 取款 0
select sum(tran_amt) val1
from edw.sscs_biz_oper_trans
where p_trans_code = '1011101'
and p_req_date like '2022%'
and dt >= '20220101'
and dt <= '20221231'
;
select * from edw.sscs_biz_oper_trans
where dt = '20221231'
-- 存款 0
select sum(tran_amt) val2
from edw.sscs_biz_oper_trans
where p_trans_code = '1011103'
and p_req_date like '2022%'
and dt >= '20220101'
and dt <= '20221231'
;
ATM
--有卡存款 544506.172 (1050824笔)
select count(*)
--sum(amount)/10000 val3
--cast (amount as decimal(16,2)) val3
from edw.frhd_atm_jrnl
where procode = 020000
and into_flag ='Y'
and point_mod != '012'
and dt >= '20220101'
and dt <= '20221231'
;
--刷脸存款 58.16 (262笔)
select count(*)
--sum(amount)/10000 val4
--cast (amount as decimal(16,2))
from edw.frhd_atm_jrnl
where procode = 060001
and into_flag ='Y'
and dt >= '20220101'
and dt <= '20221231'
;
--999152.077146
select '2' as ind,sum(trx_amt)/10000 as val -- 交易金额
from edw.dwd_bus_dep_bal_chg_dtl_di a --存款账户余额发生明细表
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.cst_act_id=b.cst_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
    and a.trx_chnl_cd='C01' --交易渠道ATM
        and a.csh_ind='0' --0:现金;1:转账
union all
--1031381.777
select '2' as ind,sum(trx_amt)/10000 as val --  存取款金额
from edw.dwd_bus_chnl_atm_trx_srl_di a --ATM交易流水
inner join edw.core_kdpa_kehuzh b --客户账号表
on a.prm_act_id=b.kehuzhao and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.kehuhaoo = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
    and trx_cd in ( '010000' , '020000') --010000取款；020000存款
union all
--487424.3956790002
select '2' as ind,sum(a.amount)/10000 as val --
from edw.frhd_cups_jrnl  a --银联系统流水表
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.account=b.cst_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
    and a.merch_type='6011' --商户类型 6011 ATM
union all
-- 3.柜面现金存取 包括个人账户柜面现金存入本行账户交易(有卡、折)和柜面本行账户取款(有卡、折)、对公账户现金存款、现金取款和现金支票兑付
-- 16393536.106931
select '3' as ind,sum(trx_amt)/10000 as val --  柜面现金交易金额
from edw.dwd_bus_dep_bal_chg_dtl_di a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
    and a.trx_chnl_cd='A01' --交易渠道柜面
    and a.csh_ind='0' --0:现金;1:转账
    and a.TXT_CODE <> 'DP2137'  --无卡
union all
-- 4.柜面现金汇款 柜面无卡无折现金交易和现金汇入他行账户交易
-- 298.785365
select '4' as ind,sum(trx_amt)/10000 as val --  柜面转账交易金额
from edw.dwd_bus_dep_bal_chg_dtl_di a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt >= '20220101' and a.dt <= '20221231'
    and a.trx_chnl_cd = 'A01' --交易渠道柜面
    and a.csh_ind = '0' --0:现金;1:转账
    and a.TXT_CODE = 'DP2137'  --无卡
union all
-- 5.本行ATM机办理无卡无折（包括个人卡、折和单位卡、折）存款业务
/*
-- 6175580.7
select '5' as ind,sum(a.transamount)/10000 as val --  无卡无折存款
from edw.atmv_trans_info a --交易信息表
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.cardno=b.cst_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
*/
--63209.137
select '5' as ind, sum(amount)/10000 as val
from edw.frhd_atm_jrnl
where procode = 020000
and into_flag ='Y'
and point_mod = '012'
and dt >= '20220101'
and dt <= '20221231'
;
-- 6.外币现钞兑换 包括一方或双方均为外币，同时一方或双方均为现钞的兑换
-- 848.7176812753
union all
/*
select '6' as ind,sum(buy_cnv_usd*B.AVG_PRC/B.QUO_UNT)/10000 as val --
from edw.dwd_bus_ibiz_idv_fx_stl_dtl_dd  a --国结个人结售汇明细
inner join edw.dim_bus_com_exr_inf_dd b on a.dt=b.dt and b.ccy_cd='840' and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on a.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt='20221231' and a.trx_dt>='20220101' and a.trx_dt<='20221231'
    and (buy_ccy<>'156' or sel_ccy<>'156') --一方或双方均为外币
        and (buy_cr_ind='1' or sel_cr_ind='1') --一方或双方均为现钞
*/
select '6' as ind,sum((t2.trx_amt*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
--t4.cd_val_dscr,T5.cst_id ,t3.zijnlaiy,t3.zijnquxn,t2.*
from  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI t2  --账户余额发生明细汇总表
inner join  edw.core_kfxb_jshdjb  t3  ----结售汇登记簿
    on t3.jbguiyls =t2.tlr_srl_nbr  --经办柜员流水
    and  t3.jiaoyirq=t2.trx_dt  --交易日期
    and t3.dt=t2.dt
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on t2.trx_dt=a2.dt
    and t2.trx_ccy_cd=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on t2.trx_dt=a3.dt
where t2.dt >='20220101'
and t2.dt <= '20221231'
and t2.csh_ind='1'  --(0现金1转账)
and ( (t3.zijnlaiy='0'  and  t3.zijnquxn='1')  or (t3.zijnlaiy='1'  and  t3.zijnquxn='0') )
and  t2.smr_dscr<>'贷款发放'
union all
-- 7.个人跨境汇款 本行个人客户本外币跨境汇出和跨境汇入汇款，港澳台地区视为境外，但不包括我国自贸区
-- (1)表名：Irmt_Master,日期：remit_Date 客户号：bene_Id 处理类型为解付：deal_Type='SETTLE' 汇款人账号：ord_Acct,申报类型：dec_Type='SWSR'
-- (2)表名：Ormt_Master,日期：remit_Date 客户号：ord_Id 是否退汇：is_Return='YES' 收款人账号：bene_Acc,申报类型：remit_Flag='JW'
-- 1354343.05253380944+0
select
'71' as ind,sum((a.remit_amount*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
from edw.niss_irmt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on a.bene_id = c.cst_id and c.dt='20221231' and c.cst_typ_cd='1' --个人客户
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a2.dt and a.remit_ccy_no=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a3.dt
where a.dt = '20221231'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and deal_Type = 'SETTLE'  --处理类型为解付
and dec_Type = 'SWSR'
union all
-- 汇出 --0
select
'72' as ind,sum((a.remit_amount*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
from edw.niss_ormt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on a.ord_id = c.cst_id and c.dt='20221231' and c.cst_typ_cd='1' --个人客户
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a2.dt and a.remit_ccy_no=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a3.dt
where a.dt = '20221231'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and is_Return = 'YES'
and remit_Flag='JW'
/*
select '7' as ind,sum((t.rmit_amt*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val --  汇入汇款
from edw.dwd_bus_ibiz_irmt_prm_dd t --汇入汇款主信息
inner join edw.core_kdpa_kehuzh b --客户账号表
on t.bnf_act_id=b.kehuzhao and b.dt='20221231'
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on b.kehuhaoo=c.cst_id and c.dt='20221231' and c.cst_typ_cd='1' --个人客户
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on t.trx_dt=a2.dt
    and t.rmit_ccy_cd=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on t.trx_dt=a3.dt
where t.dt='20221231' and t.trx_dt>='20220101' and t.trx_dt='20221231' and t.cnr_cd <> 'CHN' and t.trx_sts_cd='M'
union all
select '7' as ind,sum((t.rmit_amt*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val --  汇出汇款
from edw.dwd_bus_ibiz_ormt_prm_dd t --汇出汇款主信息
inner join edw.core_kdpa_kehuzh b --客户账号表
on t.rmit_act_id=b.kehuzhao and b.dt='20221231'
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on b.kehuhaoo=c.cst_id and c.dt='20221231' and c.cst_typ_cd='1' --个人客户
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on t.trx_dt=a2.dt
    and t.rmit_ccy_cd=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on t.trx_dt=a3.dt
where t.dt='20221231' and t.trx_dt>='20220101' and t.trx_dt='20221231' and t.cnr_cd <> 'CHN' and t.trx_sts_cd='M'
*/
union all
-- 8.交易一方位于高风险国家或地区的跨境汇款 0
-- (1)表名：Irmt_Master,日期：remit_Date 处理类型为解付：deal_Type=settle 汇款行代码：ord_Inst_Id
-- (2)表名：Ormt_Master,日期：remit_Date,收款人开户行代码：acc_Bk_Id ,是否退汇：is_Return='YES'
-- 汇入 2357480.9795575707
select
'8' as ind,sum((a.remit_amount*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
from edw.niss_irmt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a2.dt and a.remit_ccy_no=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a3.dt
where a.dt = '20231001'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and deal_Type = 'SETTLE'  --处理类型为解付
,'BDI','ALB','BRB','KHM','JAM','NIC','PAN','UGA','ALB','MKD','MNE','SRB','BIH','HRV','BFA','CYM','MAR','SEN','HTI','JOR','MLT','PHL','TUR')
    or cnty_name regexp '科索沃|克拉米亚|阿联酋|顿涅茨克|卢甘斯克')
union all
-- 汇出 --1154.867795025
select
'8' as ind,sum((a.remit_amount*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
from edw.niss_ormt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a2.dt and a.remit_ccy_no=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a3.dt
where a.dt = '20231001'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and is_Return = 'YES'
,'BDI','ALB','BRB','KHM','JAM','NIC','PAN','UGA','ALB','MKD','MNE','SRB','BIH','HRV','BFA','CYM','MAR','SEN','HTI','JOR','MLT','PHL','TUR')
    or cnty_name regexp '科索沃|克拉米亚|阿联酋|顿涅茨克|卢甘斯克')
-- 9.境外刷卡 包括本行信用卡、借记卡在境外POS刷卡或线上刷卡交易  7346.778368450007292267+3324.053041
select '91' as ind,sum(a.amount)/10000 as val --  消费金额
from edw.frhd_cups_jrnl  a --银联系统流水表
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.account=b.cst_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101'
and a.dt<='20221231'
and a.fdinst_id = '00010344' --境外
union all
select '92' as ind,sum(a.trx_amt)/10000 as val --  信用卡刷卡金额
from edw.dwd_bus_crd_cr_crd_trx_dtl_di a --信用卡客户交易流水
inner join edw.dim_bus_crd_cr_crd_inf_dd a2 --信用卡卡片信息
on a.cr_crd_card_nbr=a2.cr_crd_card_nbr and a2.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on a2.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101'
and a.dt<='20221231'
--and a.trx_typ_cd='1184' --银联卡境外消费
and a.insd_and_otsd_trx_ind = '1' --信用卡境内外标识
union all
-- 10.境外ATM取现 包括本行信用卡、借记卡在境外ATM机取现
-- 4321.037678999998206564+3324.053041
select '101' as ind,sum(a.amount)/10000 as val --  借记卡境外ATM取现
from edw.frhd_cups_jrnl  a --银联系统流水表
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.account=b.cst_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
    and a.merch_type='6011' --商户类型 6011 ATM
    and a.fdinst_id = '00010344' --境外
union all
select '102' as ind,sum(a.trx_amt)/10000 as val --  信用卡境外取现
from edw.dwd_bus_crd_cr_crd_trx_dtl_di a --信用卡客户交易流水
inner join edw.dim_bus_crd_cr_crd_inf_dd a2 --信用卡卡片信息
on a.cr_crd_card_nbr=a2.cr_crd_card_nbr and a2.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on a2.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101'
and a.dt<='20221231'
--and a.trx_typ_cd='2184' --银联卡境外取现
and a.insd_and_otsd_trx_ind = '1'
union all
-- 11.对公跨境汇款 本行对公客户本外币跨境汇出和跨境汇入汇款 2529.7523832996+0
-- 15171465.11331679298+0
select
'111' as ind,sum((a.remit_amount*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
from edw.niss_irmt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on a.bene_id = c.cst_id and c.dt='20221231' and c.cst_typ_cd='2' --对公客户
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a2.dt and a.remit_ccy_no=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a3.dt
where a.dt = '20221231'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and deal_Type = 'SETTLE'  --处理类型为解付
and dec_Type = 'SWSR'
union all
-- 汇出 --0
select
'112' as ind,sum((a.remit_amount*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val
from edw.niss_ormt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on a.ord_id = c.cst_id and c.dt='20221231' and c.cst_typ_cd='2' --对公客户
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a2.dt and a.remit_ccy_no=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on a.SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) = a3.dt
where a.dt = '20221231'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and is_Return = 'YES'
and remit_Flag='JW'
/*
select '11' as ind,sum((t.rmit_amt*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val --  汇入汇款
from edw.dwd_bus_ibiz_irmt_prm_dd t --汇入汇款主信息
inner join edw.core_kdpa_kehuzh b --客户账号表
on t.bnf_act_id=b.kehuzhao and b.dt='20221231'
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on b.kehuhaoo=c.cst_id and c.dt='20221231' and c.cst_typ_cd='2' --对公客户
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on t.trx_dt=a2.dt
    and t.rmit_ccy_cd=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on t.trx_dt=a3.dt
where t.dt='20221231' and t.trx_dt>='20220101' and t.trx_dt='20221231' and t.cnr_cd <> 'CHN' and t.trx_sts_cd='M'
union all
select '11' as ind,sum((t.rmit_amt*a2.avg_prc/100)/(a3.avg_prc/100))/10000 as val --  汇出汇款
from edw.dwd_bus_ibiz_ormt_prm_dd t --汇出汇款主信息
inner join edw.core_kdpa_kehuzh b --客户账号表
on t.rmit_act_id=b.kehuzhao and b.dt='20221231'
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on b.kehuhaoo=c.cst_id and c.dt='20221231' and c.cst_typ_cd='2' --对公客户
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
inner join
(select dt,
            avg_prc, --中间价
            ccy_cd --币种代码
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where dt>='20220101' and dt<='20221231'
    ) a2
on t.trx_dt=a2.dt
    and t.rmit_ccy_cd=a2.ccy_cd
left join
    (select dt,
            avg_prc --中间价
    from edw.dim_bus_com_exr_inf_dd --汇率信息
    where ccy_cd = '156' --人民币
        and dt>='20220101' and dt<='20221231'
    ) a3
on t.trx_dt=a3.dt
where t.dt='20221231' and t.trx_dt>='20220101' and t.trx_dt='20221231' and t.cnr_cd <> 'CHN' and t.trx_sts_cd='M'
*/
-- 12.代理行资金清算 境外代理行在本行开立代理清算账户发生的资金清算交易
-- 13.第三方支付机构账户资金清算 非银行支付机构特定业务待结算资金专用存款账户、预付卡备付金专用存款账户资金收付交易
-- 14.云杰
-- 15.特约商户收单 包括在本行开立账户，或在他行开立账户由本行收单 泰惠收？
-- 10362903.840186
union all
select '15' as ind,sum(a.trx_pay_amt)/10000 as val --  订单金额
from edw.dws_bus_chnl_ths_ord_inf_di  a --泰惠收订单信息汇总
inner join edw.dws_bus_chnl_ths_mch_inf_dd b --泰惠收商户汇总信息
on a.frs_lvl_mch_id=b.mch_id and b.dt='20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on b.opn_org = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
and a.trx_sts = '00'
-- 收付
union all
-- 16.代发工资业务	与客户签订代发工资协议，为客户提供代发工资扣款、汇划服务
-- 2164106.803932
select '16' as ind,sum(trx_amt)/10000 as val --  交易金额
from edw.dwd_bus_dep_bal_chg_dtl_di a --存款账户余额发生明细
inner join edw.dws_bus_dep_act_inf_dd b --存款账户信息汇总
on a.cst_act_id=b.cst_act_id and b.dt='20221231'
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on b.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
    and a.txt_code='DPW040' --代发工资
    and a.crd_and_dbt_ind='D'
-- 17.可转让资管类产品余额	包括本行发行或代理销售其他机构资产类产品中可在产品到期前向其他客户转让的产品（业务已有）
-- 18.资管类产品余额 包括销售本行理财产品，代销基金、投资性保险、信托计划、理财子公司产品等
-- 19.贵金属产品销售 包括销售本行发行或代理销售其他机构贵金属产品
-- 20.高交易额个人客户交易额 前项客户全年交易总额，剔除理财及资管类产品申购赎回、银证转账、同名账户互转
-- 920884433.285352
select '38' as ind, sum(trx_amt_tot)/10000 as val
from
(select c.cst_id,
       sum(a.trx_amt) trx_amt_tot
        from edw.dwd_bus_dep_bal_chg_dtl_di a --存款余额发生明细
        inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
        on a.cst_act_id=b.cst_act_id and b.dt='20221231' and b.act_sts_cd <> 'C' --未销户客户
        inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
        on b.cst_id=c.cst_id and c.dt='20221231'
        LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
        ON      c.CST_ID = T2.CST_ID
        AND     T2.DT = '20221231'
        LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
        ON      t2.prm_org_id = t3.org_id
        AND     T3.DT = '20221231'
        where a.dt>='20220101' and a.dt<='20221231'
        AND     t3.cpy_org_id = '999999998'
        group by c.cst_id
) d
where d.trx_amt_tot>=100000000
;
/*
-- 167889392.237866
union all
select '20' as ind,sum(d.trx_amt_tot2)/10000 as val --  高交易额个人客户交易额
from
(select c.cst_id,
       sum(a.trx_amt) trx_amt_tot,
       sum(case when a.smr_dscr not regexp '理财' then trx_amt end) trx_amt_tot2
from edw.dwd_bus_dep_bal_chg_dtl_di a --存款账户余额发生明细表
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.cst_act_id=b.cst_act_id and b.dt='20221231'
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on b.cst_id=c.cst_id and c.dt='20221231' and c.cst_typ_cd='1' --个人客户
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt>='20220101' and a.dt<='20221231'
group by c.cst_id
) d
where d.trx_amt_tot>=100000000
*/
-- 27.互联网资金存管账户 包括使用实体账户或虚拟账户（银行内部账户）、代理行账户为平台类企业及其入驻商户、客户开立账户并根据平台客户指令划转、结算资金等服务
-- 截至2022年底，零售通、行业通、缴费通、e账簿下平台、商户、会员绑定的结算账户、我行内部户、平台下虚拟账户
-- 业务已给数据
-- 39.境内经营地域范围 经批准开展业务的地域范围，如全国、某省或某几省，在不超出一个地市或区县范围内经营的，填写&ldquo;本地市&rdquo;或&ldquo;本区县&rdquo;
-- (不用取）
-- 40.境外经营地域范围 本机构设立境外经营性分支机构的国家或地区
-- （不用取）
-- 41.涉刑事冻结、扣划客户数量 评估期内，本机构根据公安机关、检察机关和法院对刑事案件侦办要求冻结、扣划资金、账户的客户数量。无法区分刑事、民事案由的，公安、检察机关冻结、
--    扣划默认为刑事案由，法院冻结、扣划默认为民事案由；统计评估期内新增冻结、扣划，包括新增轮候冻结、扣划。
--  10692
SELECT  '41' as ind,count(distinct aa.cst_id) as num
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on aa.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE   aa.dt = '20231031'
AND     qry_ctrl_dt >= '20220101'
AND     qry_ctrl_dt <= '20221231'
-- 42.涉刑事查询客户数量 评估期内，本机构根据公安机关、检察机关刑事案件侦办要求查询信息涉及的客户数量。多个机关或多次查询同一客户的，可合并计数
-- 36725
SELECT  '42' as ind,count(distinct aa.cst_id) as num
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
inner join adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
on aa.cst_id = c.cst_id and c.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd d  --机构树
on c.prm_org_id = d.org_id and d.dt = '20221231' and d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE   aa.dt = '20231031'
AND     qry_ctrl_dt >= '20220101'
AND     qry_ctrl_dt <= '20221231'
-- 43.涉反洗钱调查客户数量 评估期内，本机构根据人民银行反洗钱调查要求查询信息涉及的客户数量。多地人民银行或多次查询同一客户的，可合并计数
-- 不用取
-- 44.f.最近一次自查存量客户信息完整率（法定基本信息全部具备的客户/全部客户）的时间，法规规定的个人客户要素信息完整和对公客户要素信息完整的客户比例分别是？
-- （计算完整率时，名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、个人客户完整：客户名称、客户名称、证件类型、证件类型、证件号码、证件到期日、客户国籍、性别、客户职业均有值，且居住地址/户籍地址任已一项有值,手机号码/联系电话任已一项有值。名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 2、个人客户：截至2022年底，开立账户的自然人客户及办理过网贷的自然人客户，名下账户均已销户或互联网贷款客户借款余额已为0，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.fct_idv_dep_act_inf_dd  个人存量账户信息表
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
--odps.adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD  客户集市-客户基础-对私客户基础信息
--odps.adm_pub.adm_csm_cbas_org_bas_inf_dd  客户集市客户基础属性字段处理
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_SJ2023103161_44_1;
CREATE TABLE LAB_BIGDATA_DEV.TMP_SJ2023103161_44_1
(
    cst_id             STRING --客户号
    ,cst_chn_nm        STRING --客户名称
    ,doc_typ_cd        STRING --证件类型
    ,doc_nbr           STRING --证件号
    ,doc_mtu_dt	       string	--证件到期日
    ,ntn_cd	           string	--客户国籍
    ,gdr_cd            STRING --性别
    ,ocp_cd            STRING --职业
    ,adr               STRING --家庭地址_户籍地址
    ,tel               STRING --电话
    ,xh                STRING --是否全部销户
    ,wdye              STRING --网贷余额
    ,bsbf              STRING --不收不付
);
INSERT INTO LAB_BIGDATA_DEV.TMP_SJ2023103161_44_1
select t0.cst_id                --AS 客户号
        ,t0.cst_chn_nm          --AS 客户名称
        ,t00.doc_typ_cd          --AS 证件类型
        ,t00.doc_nbr             --AS 证件号
        ,t00.doc_mtu_dt         -- AS 证件到期日
        ,t0.ntn_cd              --AS 客户国籍
        ,t0.gdr_cd              --AS 性别
        ,t0.ocp_cd              --AS 职业
        ,COALESCE(t00.fml_adr, t00.reg_adr)  AS adr --家庭地址_户籍地址
        ,COALESCE(t00.mbl_nbr, t00.fml_tel_nbr)  AS tel  --手机_家庭电话
        ,t1.是否全部销户 as xh
        ,t2.余额 as wdye
        ,t3.不收不付标识 as bsbf
from edw.dim_cst_idv_bas_inf_dd t0  -- 个人客户基本信息 gdr_cd性别ocp_cd职业ntn_cd国籍
inner join edw.dws_cst_bas_inf_dd t00 --客户基础信息汇总表  证件号及到期日
on t0.cst_id = t00.cst_id and t00.dt = '20221231'
left join (
        select a.cst_id, min(b.dstr_act_dt) dstr_act_dt
                ,case when min(b.dstr_act_dt) = '18991231' then '否' else '是' end as 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.dstr_act_dt)=18991231，则该客户存在未销户账户
        from edw.dim_cst_idv_bas_inf_dd a
        left join edw.DIM_BUS_DEP_CST_ACT_INF_DD b  -- 客户存款账户信息
        on a.cst_id = b.cst_id
        and b.dt = '20221231'
        where a.dt = '20221231'
        group by a.cst_id
) t1                            -- t1判断是否全部销户
on t0.cst_id = t1.cst_id
left join (
        select a.cst_id, sum(b.ctr_bal) as 余额
        from edw.dim_cst_idv_bas_inf_dd a
        left join edw.dim_bus_loan_ctr_inf_dd b   -- 信贷合同信息
        on a.cst_id = b.cst_id
        and b.dt = '20221231'
        left join edw.dim_bus_loan_pd_inf_dd c  -- 信贷产品信息
        on b.pd_cd = c.pd_cd
        and c.dt = '20221231'
        where c.pd_nm in ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
        and a.dt = '20221231'
        group by a.cst_id
) t2                            -- t2判断互联网贷款余额
on t0.cst_id = t2.cst_id
left join (
        select d.cst_id, '是' as 不收不付标识
        from (
                select c.cst_id
                        ,max(c.act_cls_frz_ind) max_               -- 客户层级。若max和min都为1，则所有账户均为不收不付
                        ,min(c.act_cls_frz_ind) min_
                from (
                        select a.cst_id
                                ,b.act_cls_frz_ind      -- 封闭冻结（不收不付）
                        from edw.dim_cst_idv_bas_inf_dd a
                        left join edw.DIM_BUS_DEP_CST_ACT_INF_DD b  -- 客户存款账户信息
                        on a.cst_id = b.cst_id
                        and b.dt = '20221231'
                        where a.dt = '20221231'

                        union
                        select a.cst_id
                                ,'1' as act_cls_frz_ind      -- 封闭冻结
                        from edw.dim_cst_idv_bas_inf_dd a
                        inner join edw.dim_bus_crd_cr_crd_inf_dd b
                        on a.cst_id = b.cst_id and b.dt = '20221231' and (b.card_sts_cd IN ( 'Q' , '2' , 'D' , 'F' , 'L' , 'S' , 'Y' ) or b.LATE_CARD_IND <> '1')
                        and b.dt = '20221231'
                        where a.dt = '20221231'
                ) c
                group by c.cst_id
        ) d
        where max_ = 1 and min_ = 1             -- 只保留所有账户都不收不付的客户
) t3
on t0.cst_id = t3.cst_id
where t0.dt = '20221231'
;
--44-1
select count(distinct aa.cst_id)
from LAB_BIGDATA_DEV.TMP_SJ2023103161_44_1 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where cst_chn_nm is not null and cst_chn_nm <> ''
and   doc_typ_cd is not null and doc_typ_cd <> ''
and   doc_nbr is not null and doc_nbr <> ''
and   doc_mtu_dt is not null and doc_mtu_dt <> ''
and   ntn_cd is not null and ntn_cd <> ''
and   gdr_cd is not null and gdr_cd <> ''
and   ocp_cd is not null and ocp_cd <> ''
and   adr is not null and adr <> ''
and   tel is not null and tel <> ''
and   xh = '否'
and   (wdye > 0 or wdye is null or wdye = '')
and   (bsbf is null or bsbf = '') --4553276
--44-2
select count(distinct aa.cst_id)
from LAB_BIGDATA_DEV.TMP_SJ2023103161_44_1 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where xh = '否'
and   (wdye > 0 or wdye is null or wdye = '') --5245667
and   (bsbf is null or bsbf = '') --5189441
-- 3、对公客户：客户名称、证件类型、证件号码、证件到期日、客户国籍、经营范围、组织机构类型、注册地址、法定代表人、法定代表人证件类型、法定代表人证件号、法定代表人证件到期日、实际控制人名称、实际控制人证件类型、实际控制人证件号码、实际控制人证件到期日、受益所有人名称、受益所有人证件类型、受益所有人证件号码、受益所有人证件到期日、受益所有人地址。名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计
-- 4、截至2022年底，开立账户的对公客户，名下账户均已销户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- app_ado.ADM_DAR_CST_ORG_INF_DD  对公客户账户信息表
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_SJ2023103161_44_2;
CREATE TABLE LAB_BIGDATA_DEV.TMP_SJ2023103161_44_2
(
    cst_id                        STRING --客户号
    ,cst_chn_nm                   STRING --客户名称
    ,doc_typ_cd                   STRING --证件类型
    ,doc_nbr                      STRING --证件号
    ,doc_mtu_dt	                  STRING --证件到期日
    ,opr_scp_dscr        STRING --经营范围
    ,adr                          STRING --地址
    ,fr_cst_chn_nm                STRING --法定代表人
    ,fr_prm_doc_typ_cd            STRING --法人证件类型
    ,fr_prm_doc_nbr               STRING --法人证件号
    ,fr_prm_doc_mtu_dt            STRING --法人证件到期日
    ,sk_cst_chn_nm                STRING --实控人名称
    ,sk_prm_doc_typ_cd            STRING --法人证件类型
    ,sk_prm_doc_nbr               STRING --实控人证件号码
    ,sk_prm_doc_mtu_dt            STRING --实控人证件到期日
    ,sy_cst_chn_nm                STRING --受益人名称
    ,sy_prm_doc_typ_cd            STRING --受益人证件类型
    ,sy_prm_doc_nbr               STRING --受益人证件号码
    ,sy_prm_doc_mtu_dt            STRING --受益人证件到期日
    ,xh                STRING --是否全部销户
    ,wdye              STRING --网贷余额
    ,bsbf              STRING --不收不付
);
INSERT INTO LAB_BIGDATA_DEV.TMP_SJ2023103161_44_2
select t0.cst_id                --AS 客户号
        ,t0.cst_chn_nm          --AS 客户名称
        ,t0.doc_typ_cd          --AS 证件类型
        ,t0.doc_nbr             --AS 证件号
        ,t0.doc_mtu_dt          --AS 证件到期日
        ,t00.opr_scp_dscr      --AS 经营范围
        ,COALESCE(t000.reg_adr,t000.wrk_adr)    AS adr --地址
        --,COALESCE(t000.registeradd, t000.officeadd)  AS adr --地址
        --,t000.registeradd      --AS 注册地址
        --,t000.officeadd        --AS 实际办公地址
        ,b1.cst_chn_nm  as fr_cst_chn_nm         --AS 法定代表人
        ,b1.prm_doc_typ_cd as fr_prm_doc_typ_cd  --AS 法人证件类型
        ,b1.prm_doc_nbr as fr_prm_doc_nbr        --AS 法人证件号
        ,b1.prm_doc_mtu_dt as fr_prm_doc_mtu_dt  --AS 法人证件到期日
        ,b2.cst_chn_nm as sk_cst_chn_nm          --AS 实控人名称
        ,b2.prm_doc_typ_cd as sk_prm_doc_typ_cd  --AS 法人证件类型
        ,b2.prm_doc_nbr as sk_prm_doc_nbr        --AS 实控人证件号码
        ,b2.prm_doc_mtu_dt as sk_prm_doc_mtu_dt  --AS 实控人证件到期日
        ,b3.cst_chn_nm as sy_cst_chn_nm          --AS 受益人名称
        ,b3.prm_doc_typ_cd as sy_prm_doc_typ_cd  --AS 受益人证件类型
        ,b3.prm_doc_nbr as sy_prm_doc_nbr        --AS 受益人证件号码
        ,b3.prm_doc_mtu_dt as sy_prm_doc_mtu_dt  --AS 受益人证件到期日
        ,t1.是否全部销户 as xh
        ,t2.余额 as wdye
        ,t3.不收不付标识 as bsbf
from adm_pub.adm_csm_cbas_org_bas_inf_dd t0 -- 客户集市客户基础属性字段处理
left join edw.dim_cst_entp_bas_inf_dd t00 --企业客户表
on t0.cst_id = t00.cst_id and t00.dt = '20221231'
left join edw.dws_cst_bas_inf_dd t000
on t0.cst_id = t000.cst_id and t000.dt = '20221231'
--left join edw.loan_ent_info t000    --企业基本信息
--on t0.cst_id = t000.customerid and t000.dt = '20221231'
left join edw.dim_cst_rel_inf_dd a1 --客户关联关系信息
on t0.cst_id = a1.cst_id and a1.dt = '20221231' and a1.rel_typ_cd = '0101' --法人
left join edw.dim_cst_bas_inf_dd b1  --客户基本信息
on a1.rel_cst_id = b1.cst_id and b1.dt = '20221231'
left join edw.dim_cst_rel_inf_dd a2  --客户关联关系信息
on t0.cst_id = a2.cst_id and a2.dt = '20221231' and a2.rel_typ_cd = '0109' --实控人
left join edw.dim_cst_bas_inf_dd b2  --客户基本信息
on a2.rel_cst_id = b2.cst_id and b2.dt = '20221231'
left join edw.dim_cst_rel_inf_dd a3  --客户关联关系信息
on t0.cst_id = a3.cst_id and a3.dt = '20221231' and a3.rel_typ_cd like '09%'  --受益人
left join edw.dim_cst_bas_inf_dd b3  --客户基本信息
on a3.rel_cst_id = b3.cst_id and b3.dt = '20221231'
left join (
        select a.cst_id, min(b.dstr_act_dt) dstr_act_dt
                ,case when min(b.dstr_act_dt) = '18991231' then '否' else '是' end as 是否全部销户 -- 未销户账户的销户日期为18991231。若min(b.dstr_act_dt)=18991231，则该客户存在未销户账户
        from adm_pub.adm_csm_cbas_org_bas_inf_dd a
        left join edw.DIM_BUS_DEP_CST_ACT_INF_DD b  -- 客户存款账户信息
        on a.cst_id = b.cst_id
        and b.dt = '20221231'
        where a.dt = '20221231'
        group by a.cst_id
) t1                            -- t1判断是否全部销户
on t0.cst_id = t1.cst_id
left join (
        select a.cst_id, sum(b.ctr_bal) as 余额
        from adm_pub.adm_csm_cbas_org_bas_inf_dd a
        left join edw.dim_bus_loan_ctr_inf_dd b   -- 信贷合同信息
        on a.cst_id = b.cst_id
        and b.dt = '20221231'
        left join edw.dim_bus_loan_pd_inf_dd c  -- 信贷产品信息
        on b.pd_cd = c.pd_cd
        and c.dt = '20221231'
        where c.pd_nm in ( '蚂蚁借呗' , '百度分期贷' , '公积金贷' , '享贷（个税）' , '享贷（商户）' )
        and a.dt = '20221231'
        group by a.cst_id
) t2                            -- t2判断互联网贷款余额
on t0.cst_id = t2.cst_id
left join (
        select d.cst_id, '是' as 不收不付标识
        from (
                select c.cst_id
                        ,max(c.act_cls_frz_ind) max_               -- 客户层级。若max和min都为1，则所有账户均为不收不付
                        ,min(c.act_cls_frz_ind) min_
                from (
                        select a.cst_id
                                ,b.act_cls_frz_ind      -- 封闭冻结（不收不付）
                        from adm_pub.adm_csm_cbas_org_bas_inf_dd a
                        left join edw.DIM_BUS_DEP_CST_ACT_INF_DD b  -- 客户存款账户信息
                        on a.cst_id = b.cst_id
                        and b.dt = '20221231'
                        where a.dt = '20221231'
                ) c
                group by c.cst_id
        ) d
        where max_ = 1 and min_ = 1             -- 只保留所有账户都不收不付的客户
) t3
on t1.cst_id = t3.cst_id
where t0.dt = '20221231'
;
--44-3
select count(distinct aa.cst_id)
from LAB_BIGDATA_DEV.TMP_SJ2023103161_44_2 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where cst_chn_nm is not null and cst_chn_nm <> ''
and   doc_typ_cd is not null and doc_typ_cd <> ''
and   doc_nbr is not null and doc_nbr <> ''
and   doc_mtu_dt is not null and doc_mtu_dt <> ''
and   opr_scp_dscr is not null and opr_scp_dscr <> ''
and   adr is not null and adr <> ''
and   fr_cst_chn_nm is not null and fr_cst_chn_nm <> ''
and   fr_prm_doc_typ_cd is not null and fr_prm_doc_typ_cd <> ''
and   fr_prm_doc_nbr is not null and fr_prm_doc_nbr <> ''
and   fr_prm_doc_mtu_dt is not null and fr_prm_doc_mtu_dt <> ''
and   sk_cst_chn_nm is not null and sk_cst_chn_nm <> ''
and   sk_prm_doc_typ_cd is not null and sk_prm_doc_typ_cd <> ''
and   sk_prm_doc_nbr is not null and sk_prm_doc_nbr <> ''
and   sk_prm_doc_mtu_dt is not null and sk_prm_doc_mtu_dt <> ''
and   sy_cst_chn_nm is not null and sy_cst_chn_nm <> ''
and   sy_prm_doc_typ_cd is not null and sy_prm_doc_typ_cd <> ''
and   sy_prm_doc_nbr is not null and sy_prm_doc_nbr <> ''
and   sy_prm_doc_mtu_dt is not null and sy_prm_doc_mtu_dt <> ''
and   xh = '否'
and   (wdye > 0 or wdye is null or wdye = '')
and   (bsbf is null or bsbf = '') --36127  --36209 --280744
--44-4
select count(distinct aa.cst_id)
from LAB_BIGDATA_DEV.TMP_SJ2023103161_44_2 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where xh = '否'
and   (wdye > 0 or wdye is null or wdye = '')
and   (bsbf is null or bsbf = '') --384902
-- 45.h.客户洗钱风险分类划分的级别和各级别数量、占比
-- 1、在2022年12月31日时点，最终人工认定为高风险、较高风险、一般风险、较低风险、低风险的客户有多少
/*
levelkey _c1
1002 6920147
1004 23663
1005 2191
1001 92711 低风险
1003 745060
*/
DROP TABLE IF EXISTS lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022;
CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 (
    TEMPLATEKEY      STRING COMMENT '模板编码'
  , GSKEY            STRING COMMENT '公式编号'
  , PARTY_ID         STRING COMMENT '客户号'
  , LEVELKEY         STRING COMMENT '最终风险等级'
  , FRISTAPPRALEVEL  STRING COMMENT '初评等级'
  , STATISTIC_DT     STRING COMMENT '评级日期'
  , RCHECK_DT        STRING COMMENT '审批日期'
  , TEMPCATEGORY     STRING COMMENT '模板类别'
  , ORGANKEY         STRING COMMENT '客户机构'
  , RN               STRING COMMENT '序号'
)COMMENT
'';
INSERT INTO lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022
SELECT S.TEMPLATEKEY,S.GSKEY,S.PARTY_ID,S.LEVELKEY,S.FRISTAPPRALEVEL,S.STATISTIC_DT,S.RCHECK_DT,S.TEMPCATEGORY,S.ORGANKEY,S.RN
  FROM (
        SELECT T.TEMPLATEKEY,T.GSKEY,T.PARTY_ID,T.LEVELKEY,T.FRISTAPPRALEVEL,T.STATISTIC_DT,T.RCHECK_DT,T.TEMPCATEGORY,T.ORGANKEY
            , RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY T.RCHECK_DT DESC) AS RN
        FROM (
              SELECT A.TEMPLATEKEY,A.GSKEY,A.PARTY_ID,A.LEVELKEY,A.FRISTAPPRALEVEL,SUBSTR(A.STATISTIC_DT,1,10) AS STATISTIC_DT,SUBSTR(A.RCHECK_DT,1,10) AS RCHECK_DT,A.TEMPCATEGORY,A.ORGANKEY
                FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
              WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
                AND A.DT = '20231031'
              UNION
              SELECT A.TEMPLATEKEY,A.GSKEY,A.PARTY_ID,A.LEVELKEY,A.FRISTAPPRALEVEL,SUBSTR(A.STATISTIC_DT,1,10) AS STATISTIC_DT,SUBSTR(A.RCHECK_DT,1,10) AS RCHECK_DT,A.TEMPCATEGORY,A.ORGANKEY
                FROM adm_upss.AML_T37_PARTY_RESULT_UH A
              WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
                AND A.DT = '20231031'
        ) T
) S WHERE S.RN <= 2
;
SELECT S.LEVELKEY, COUNT(1)
  FROM (SELECT A.PARTY_ID, A.LEVELKEY
          FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
         WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
           AND A.DT = '20231031'
        UNION
        SELECT T.PARTY_ID, T.LEVELKEY
          FROM (SELECT A.PARTY_ID,
                       A.LEVELKEY,
                       RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY A.RCHECK_DT DESC) AS RN
                  FROM adm_upss.AML_T37_PARTY_RESULT_UH A
                 WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
                   AND A.DT = '20231031'
                   AND NOT EXISTS
                 (SELECT 1
                          FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
                         WHERE A.PARTY_ID = B.PARTY_ID
                           AND SUBSTR(B.RCHECK_DT,1,10) <= '2022-12-31'
                           AND B.DT = '20231031')) T
         WHERE RN = 1) S
 GROUP BY S.LEVELKEY
;
-- 2、在2022年12月31日时点，名下账户均已销户或互联网贷款客户借款余额已为0的客户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- 2190014
SELECT COUNT(1)
  FROM (SELECT A.PARTY_ID, A.LEVELKEY
          FROM adm_upss.AML_T37_PARTY_RESULT_CURR A,
               lab_bigdata_dev.TMP_T47_PARTY_STS  B
         WHERE SUBSTR(A.RCHECK_DT, 1, 10) <= '2022-12-31'
           AND A.PARTY_ID = B.PARTY_ID
           AND A.DT = '20231031'
        UNION
        SELECT T.PARTY_ID, T.LEVELKEY
          FROM (SELECT A.PARTY_ID,
                       A.LEVELKEY,
                       RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY A.RCHECK_DT DESC) AS RN
                  FROM adm_upss.AML_T37_PARTY_RESULT_UH A, lab_bigdata_dev.TMP_T47_PARTY_STS B
                 WHERE SUBSTR(A.RCHECK_DT, 1, 10) <= '2022-12-31'
                   AND A.PARTY_ID = B.PARTY_ID
                   AND A.DT = '20231031'
                   AND NOT EXISTS
                 (SELECT 1
                          FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
                         WHERE A.PARTY_ID = B.PARTY_ID
                           AND SUBSTR(B.RCHECK_DT, 1, 10) <= '2022-12-31'
                           AND B.DT = '20231031')) T
         WHERE RN = 1) S
-- 46.i.近一年内建立业务关系客户数量，以及风险分类划分的级别和各级别数量、占比
-- 1196867
select count(distinct aa.cst_id) num
from edw.dim_bus_dep_act_inf_dd aa -- 存款账户信息
    inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
    on aa.cst_id = bb.cst_id and bb.dt = '20221231'
    inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
    on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where aa.dt = '20221231'
and aa.opn_dt >= '20220101'  --开户日期
and aa.opn_dt <= '20221231'  --开户日期
select S.LEVELKEY, COUNT(distinct s.cst_id)
from
    (select aa.cst_id,dd.LEVELKEY
    from edw.dim_bus_dep_act_inf_dd aa -- 存款账户信息
    inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
    on aa.cst_id = bb.cst_id and bb.dt = '20221231'
    inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
    on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
    left join
    (
              SELECT A.PARTY_ID, A.LEVELKEY
              FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
            WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
              AND A.DT = '20231031'
            UNION
            SELECT T.PARTY_ID, T.LEVELKEY
              FROM (SELECT A.PARTY_ID,
                          A.LEVELKEY,
                          RANK() OVER(PARTITION BY A.PARTY_ID ORDER BY A.RCHECK_DT DESC) AS RN
                      FROM adm_upss.AML_T37_PARTY_RESULT_UH A
                    WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
                      AND A.DT = '20231031'
                      AND NOT EXISTS
                    (SELECT 1
                              FROM adm_upss.AML_T37_PARTY_RESULT_CURR B
                            WHERE A.PARTY_ID = B.PARTY_ID
                              AND SUBSTR(B.RCHECK_DT,1,10) <= '2022-12-31'
                              AND B.DT = '20231031')) T
            WHERE RN = 1 ) dd on aa.cst_id = substr(dd.party_id,3)
    where aa.dt = '20221231'
    and aa.opn_dt >= '20220101'  --开户日期
    and aa.opn_dt <= '20221231'  --开户日期
) s
group by s.LEVELKEY
/*
levelkey	_c1
\N	6656
1003	56383
1004	3740
1002	1000253
1005	321
1001	4694
*/
-- 47.j.近一年内，在建立业务关系环节对客户采取强化尽职调查的客户数量
-- 48.k.近一年内，在建立业务关系环节，经尽职调查认为风险过高或无法有效识别客户身份而拒绝建立业务关系的客户人次和占比
-- 49.m.近一年内，因信息不完整而未予解付的跨境汇款笔数
-- (1)表名：Irmt_Master,日期：remit_Date 处理类型为退汇：deal_Type='RETURN'
-- 2851
select
'49' as ind,count(distinct ir_no)
from edw.niss_irmt_master a
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树
on a.trans_org_id = b.org_id and b.dt = '20221231' and b.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where a.dt = '20231001'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) >= '20220101'
and SUBSTR(REPLACE(remit_date, '-', ''), 1, 8) <= '20221231'
and deal_Type = 'RETURN'  --处理类型为退汇
-- 50.d.近一年内发现个人身份证件过期的数量，因身份证件过期且无合理理由未更新而中止业务关系的客户数量
-- 50 我们行证件过期是给账户做只收不付的  --act_rcv_oly_ind
-- 136148
select '50-1' as ind,count(distinct cst_id) as num
from adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD a  --客户集市-客户基础-对私客户基础信息
where a.dt = '20221231'
and a.doc_mtu_dt >= '20220101'
and a.doc_mtu_dt <= '20221231'
-- 54235
select '50-2' as ind,count(distinct d.cst_id) as num
from (
        select c.cst_id
                ,max(c.act_rcv_oly_ind) max_               -- 客户层级。若max和min都为1，则所有账户均为只收不付
                ,min(c.act_rcv_oly_ind) min_
        from (
                select a.cst_id
                        ,b.act_rcv_oly_ind      -- 只收不付
                from adm_pub.ADM_CSM_CBAS_IDV_BAS_INF_DD a  --客户集市-客户基础-对私客户基础信息
                left join edw.DIM_BUS_DEP_CST_ACT_INF_DD b  --客户存款账户信息
                on a.cst_id = b.cst_id and b.dt = '20221231'
                where a.dt = '20221231'
                and a.doc_mtu_dt >= '20220101'
                and a.doc_mtu_dt <= '20221231'
        ) c
        group by c.cst_id
) d
where max_ = 1 and min_ = 1             -- 只保留所有账户都只收不付的客户
/*
-- 121618
select
'50' as ind,count(distinct party_id)
from (
    SELECT a.party_id,b.card_end_dt
        ,a.party_status_cd  --当事人状态:0：正常1：销户2：未开户4：删除X：未知
        ,b.flag --0禁用1启用
    FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
    WHERE A.PARTY_ID = B.PARTY_ID
    AND A.DT = '20221231'
    AND B.DT = '20221231'
    and b.card_end_dt >= '20220101'
    and b.card_end_dt <= '20221231'
    --AND (a.party_status_cd = '0' or b.flag = '0')
) T;
--0
select
'50' as ind,count(distinct party_id)
from (
    SELECT a.party_id,b.card_end_dt
        ,a.party_status_cd  --当事人状态:0：正常1：销户2：未开户4：删除X：未知
        ,b.flag --0禁用1启用
    FROM adm_upss.ADM_UPSS_AML_T47_PARTY A, adm_upss.ADM_UPSS_AML_T47_INDIVIDUAL B
    WHERE A.PARTY_ID = B.PARTY_ID
    AND A.DT = '20221231'
    AND B.DT = '20221231'
    and b.card_end_dt >= '20220101'
    and b.card_end_dt <= '20221231'
    AND (a.party_status_cd <> '0' or b.flag = '0')
) T;
*/
-- 51.f.近一年内发现客户身份注销的数量及终止业务关系的数量，从发现注销到完成终止业务关系流程的最长时间
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1;
CREATE TABLE LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1
(
    dt                  STRING --查询日期
    ,geb_creditcode     STRING --统一信用代码
    ,geb_entname        STRING --企业名称
    ,geb_entstatus      STRING --经营状态  --工商状态
    ,geb_candate	string	--注销日期
    ,geb_revdate	string	--吊销日期
    ,geb_orgcodes       STRING --组织机构代码
    ,geb_regno          STRING --注册号
);
INSERT INTO LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1
SELECT  dt
,geb_creditcode
        ,geb_entname
        ,geb_entstatus
        ,geb_candate
        ,geb_revdate
        ,geb_orgcodes
        ,geb_regno
FROM    (
            SELECT  dt
            ,geb_creditcode
                    ,geb_entname
                    ,geb_entstatus
                    ,geb_candate
                    ,geb_revdate
                    ,geb_orgcodes
                    ,geb_regno
                    ,row_number() OVER ( PARTITION BY geb_entname ORDER BY dt DESC ) rnk
            FROM    edw.outd_gs_entinfo_basic
            WHERE   dt >= '20220101'
            and     dt <= '20221231'
        ) t
WHERE   t.rnk = 1;
--步骤二：对公账户工商注销后，其在我行开立的结算账户状态
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_SJ2023103161_51_2;
CREATE TABLE LAB_BIGDATA_DEV.TMP_SJ2023103161_51_2
(
    CST_ID          STRING --客户号
    ,cst_chn_nm     STRING --客户名称
    ,prm_doc_typ_cd STRING --主证件类型代码
    ,prm_doc_nbr    STRING --主证件号码
    ,cst_act_id     STRING --客户账号
    ,dep_act_id     STRING --负债账号
    ,act_nm         STRING --账户名称
    ,act_sts_cd     STRING --账户状态
    ,act_dstr_act_dt STRING --账户销户日期
    ,geb_entstatus  STRING --工商状态
    ,geb_candate	string	--注销日期
    ,geb_revdate	string	--吊销日期
    ,dt           string  --查询日期
);
INSERT INTO LAB_BIGDATA_DEV.TMP_SJ2023103161_51_2
SELECT  A.cst_id          AS 客户号
        ,A.cst_chn_nm     AS 客户名称
        ,A.prm_doc_typ_cd AS 主证件类型代码
        ,A.prm_doc_nbr    AS 主证件号码
        ,dep.cst_act_id   AS 客户账号
        ,dep.dep_act_id   AS 负债账号
        ,dep.act_nm       AS 账户名称
        ,dep.act_sts_cd   AS 账户状态
        ,dep.act_dstr_act_dt  AS 账户销户日期
        ,B.geb_entstatus  AS 工商状态
        ,B.geb_candate      AS 注销日期
        ,B.geb_revdate      AS 吊销日期
        ,B.DT               AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN    edw.dim_bus_dep_act_inf_dd dep --存款账户信息
ON      A.cst_id = dep.cst_id
AND     dep.stl_act_ind = '1' --结算账户标志
AND     dep.dt = '20221231'
INNER JOIN    LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1 B
ON      A.cst_chn_nm = B.geb_entname
LEFT JOIN    edw.dwd_code_library_dd C
ON      A.prm_doc_typ_cd = C.cd_val
AND     C.dt = '20221231'
AND     C.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE   A.dt = '20221231'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 工商注销
UNION
SELECT  A.cst_id          AS 客户号
        ,A.cst_chn_nm     AS 客户名称
        ,A.prm_doc_typ_cd AS 主证件类型代码
        ,A.prm_doc_nbr    AS 主证件号码
        ,dep.cst_act_id   AS 客户账号
        ,dep.dep_act_id   AS 负债账号
        ,dep.act_nm       AS 账户名称
        ,dep.act_sts_cd   AS 账户状态
        ,dep.act_dstr_act_dt  AS 账户销户日期
        ,B.geb_entstatus  AS 工商状态
        ,B.geb_candate      AS 注销日期
        ,B.geb_revdate      AS 吊销日期
                ,B.DT               AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN    edw.dim_bus_dep_act_inf_dd dep
ON      A.cst_id = dep.cst_id
AND     dep.stl_act_ind = '1' --结算账户标志
AND     dep.dt = '20221231'
INNER JOIN    LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1 B
ON      A.prm_doc_nbr = B.geb_creditcode
LEFT JOIN    edw.dwd_code_library_dd C
ON      A.prm_doc_typ_cd = C.cd_val
AND     C.dt = '20221231'
AND     C.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE   A.dt = '20221231'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 经营状态
UNION
SELECT  A.cst_id          AS 客户号
        ,A.cst_chn_nm     AS 客户名称
        ,A.prm_doc_typ_cd AS 主证件类型代码
        ,A.prm_doc_nbr    AS 主证件号码
        ,dep.cst_act_id   AS 客户账号
        ,dep.dep_act_id   AS 负债账号
        ,dep.act_nm       AS 账户名称
        ,dep.act_sts_cd   AS 账户状态
        ,dep.act_dstr_act_dt  AS 账户销户日期
        ,B.geb_entstatus  AS 工商状态
        ,B.geb_candate      AS 注销日期
        ,B.geb_revdate      AS 吊销日期
                ,B.DT               AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN    edw.dim_bus_dep_act_inf_dd dep
ON      A.cst_id = dep.cst_id
AND     dep.stl_act_ind = '1' --结算账户标志
AND     dep.dt = '20221231'
INNER JOIN    LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1 B
ON      A.prm_doc_nbr = B.geb_orgcodes
LEFT JOIN    edw.dwd_code_library_dd C
ON      A.prm_doc_typ_cd = C.cd_val
AND     C.dt = '20221231'
AND     C.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE   A.dt = '20221231'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 经营状态
UNION
SELECT  A.cst_id          AS 客户号
        ,A.cst_chn_nm     AS 客户名称
        ,A.prm_doc_typ_cd AS 主证件类型代码
        ,A.prm_doc_nbr    AS 主证件号码
        ,dep.cst_act_id   AS 客户账号
        ,dep.dep_act_id   AS 负债账号
        ,dep.act_nm       AS 账户名称
        ,dep.act_sts_cd   AS 账户状态
        ,dep.act_dstr_act_dt  AS 账户销户日期
        ,B.geb_entstatus  AS 工商状态
        ,B.geb_candate      AS 注销日期
        ,B.geb_revdate      AS 吊销日期
                ,B.DT               AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN    edw.dim_bus_dep_act_inf_dd dep
ON      A.cst_id = dep.cst_id
AND     dep.stl_act_ind = '1' --结算账户标志
AND     dep.dt = '20221231'
INNER JOIN    LAB_BIGDATA_DEV.TMP_SJ2023103161_51_1 B
ON      A.prm_doc_nbr = B.geb_regno
LEFT JOIN    edw.dwd_code_library_dd C
ON      A.prm_doc_typ_cd = C.cd_val
AND     C.dt = '20221231'
AND     C.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     C.fld_nm = 'PRM_DOC_TYP_CD'
WHERE   A.dt = '20221231'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 经营状态
;
-- 近一年内发现客户身份注销的数量 --99145
select '51_1' as ind,count(distinct cst_id) num
from LAB_BIGDATA_DEV.TMP_SJ2023103161_51_2 t
-- 近一年内发现客户身份注销的数量及终止业务关系的数量
-- 94572
select '51_2' as ind,count(distinct cst_id) num
from LAB_BIGDATA_DEV.TMP_SJ2023103161_51_2
where act_sts_cd <> 'A'  --账户状态异常
-- 从发现注销到完成终止业务关系流程的最长时间
select max(tt.dateminus) max_days
from (
select cst_id,
case when act_dstr_act_dt >= dt then datediff(to_date(act_dstr_act_dt,'yyyymmdd'),to_date(dt,'yyyymmdd'),'dd') else 0 end as dateminus
from
(
select
cst_id,act_dstr_act_dt,dt
--,REPLACE(geb_candate, '-', '') candate
--,REPLACE(geb_revdate, '-', '') revdate
--,case when REPLACE(geb_candate, '-', '') >= REPLACE(geb_revdate, '-', ''),REPLACE(geb_candate, '-', ''),REPLACE(geb_revdate, '-', '')
--,GREATEST(REPLACE(geb_candate, '-', ''),REPLACE(geb_revdate, '-', '')) datee
from LAB_BIGDATA_DEV.TMP_SJ2023103161_51_2
where act_sts_cd <> 'A'
--order by act_dstr_act_dt desc
) t
) tt
-- 52.g.近一年内，根据机构客户风险等级划分设定，应当及实际开展到期重评客户风险等级的客户数量
-- 2022年，存量客户月底到期重评的客户数量，2021年12月-2022年11月预警的客户。
-- 2374463
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
  AND SUBSTR(A.STATISTIC_DT,1,10) >= '2021-12-01'
  AND SUBSTR(A.STATISTIC_DT,1,10) <= '2022-11-30'
  AND A.DT = '20231031'
UNION
SELECT A.PARTY_ID
  FROM adm_upss.AML_T37_PARTY_RESULT_UH A
  AND SUBSTR(A.STATISTIC_DT,1,10) >= '2021-12-01'
  AND SUBSTR(A.STATISTIC_DT,1,10) <= '2022-11-30'
  AND A.DT = '20231031'
  ) T;
-- 53.h.近一年内，经持续尽调认为业务关系不符合客户身份，需开展强化尽职调查和重新评定客户风险等级的客户数量（不包含以上定期重评、因外部查冻扣开展强化尽调客户）及占全部客户数量比例（名下账户均已销户且无其他业务关系存续的客户、已采取账户不收不付措施并中止其他业务办理的客户不纳入统计）
-- 1、2022年完成人工人工评定的客户，不含新开客户评级、PKG99、CXD11两个公式。
SELECT  count(DISTINCT A.PARTY_ID) as num
FROM    LAB_BIGDATA_DEV.TMP_T37_PARTY_RESULT_2022 A
WHERE   ( ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
AND     SUBSTR(A.STATISTIC_DT, 1, 10) >= '2022-01-01'
AND     SUBSTR(A.STATISTIC_DT, 1, 10) <= '2022-12-31' )
    OR ( A.LEVELKEY IN ( '1004' , '1005' )
AND     SUBSTR(A.RCHECK_DT, 1, 10) >= '2022-01-01'
AND     SUBSTR(A.RCHECK_DT, 1, 10) <= '2022-12-31' ) )
AND     ORGANKEY IN (
                        SELECT  B.ORGANKEY
                        FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                        WHERE   B.report_organkey = 'C1092933000014'
                        AND     B.DT = '20231031'
                    )
AND A.TEMPCATEGORY = '2'
-- 240683
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
WHERE SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
  AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
  AND A.TEMPCATEGORY = '2'
  AND A.DT = '20231031'
UNION
SELECT A.PARTY_ID
  FROM adm_upss.AML_T37_PARTY_RESULT_UH A
WHERE SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
  AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
  AND A.TEMPCATEGORY = '2'
  AND A.DT = '20231031'
  ) T;
-- 2、在2022年12月31日时点，名下账户均已销户或互联网贷款客户借款余额已为0的客户，已采取账户不收不付措施并中止其他业务办理的客户不纳入统计。
-- 180969
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
     , lab_bigdata_dev.TMP_T47_PARTY_STS B
 WHERE SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
   AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND A.TEMPCATEGORY = '2'
   AND A.PARTY_ID = B.PARTY_ID
   AND A.DT = '20231031'
UNION
SELECT A.PARTY_ID
  FROM adm_upss.AML_T37_PARTY_RESULT_UH A
     , lab_bigdata_dev.TMP_T47_PARTY_STS B
 WHERE SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
   AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND A.TEMPCATEGORY = '2'
   AND A.PARTY_ID = B.PARTY_ID
   AND A.DT = '20231031'
  ) T;
-- 54.i.近一年内，经尽职调查后，调升、调降客户风险等级的客户数量，调升至最高等级和由最高风险等级调降的客户数量（以上分别统计）
-- 1、调升：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次高，且系统初评等级不是低风险、较低风险、一般风险。
-- 2013
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022  A
     , lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022  B
 WHERE A.PARTY_ID = B.PARTY_ID
   AND B.LEVELKEY < A.LEVELKEY
   AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
   AND A.RN = 1
   AND B.RN = 2
  ) T;
-- 2、调降：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次低，且系统初评等级不是低风险、较低风险、一般风险。
-- 1360
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 A
     , lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 B
 WHERE A.PARTY_ID = B.PARTY_ID
   AND B.LEVELKEY > A.LEVELKEY
   AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
   AND A.RN = 1
   AND B.RN = 2
  ) T;
-- 3、调升至最高等级：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级是高风险，前一次风险等级不是高风险。
-- 216
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 A
     , lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 B
 WHERE A.PARTY_ID = B.PARTY_ID
   AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
   AND A.LEVELKEY = '1005'
   AND B.LEVELKEY != '1005'
   AND A.RN = 1
   AND B.RN = 2
  ) T;
-- 4、由最高风险等级调降的客户：2022年内有过人工评定等级的记录，且2022年内评定时间最晚的一次风险等级比前一次低，且前一次风险等级是高风险。
-- 534
SELECT COUNT(1)
  FROM (
SELECT A.PARTY_ID
  FROM lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 A
     , lab_bigdata_dev.TMP_T37_PARTY_RESULT_2022 B
 WHERE A.PARTY_ID = B.PARTY_ID
   AND SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND SUBSTR(A.RCHECK_DT,1,10) >= '2022-01-01'
   AND A.LEVELKEY != '1005'
   AND B.LEVELKEY = '1005'
   AND A.RN = 1
   AND B.RN = 2
  ) T;
--  44
--select * from adm_upss.aml_t00_organ where dt='20211231';
--2022年客户信息
DROP TABLE if exists tmp_lig_20220118_20;
create table tmp_lig_20220118_20 as
select b.opn_org_id,c.gdr_cd,c.ntn_cd,c.ocp_cd,d.opr_scp_dscr,a.*
from edw.dws_cst_bas_inf_dd a
inner join (SELECT t1.cst_id,t1.opn_org_id
          ,row_number() over(partition by t1.cst_id order by t1.opn_dt) rnum
          FROM EDW.DIM_BUS_DEP_CST_ACT_INF_DD T1
          LEFT JOIN EDW.dwd_bus_dep_act_cst_act_rel_dd T2
            ON      T1.CST_ACT_ID = T2.CST_ACT_ID
            AND     T2.DT = '20221231'
            AND     T2.LGP_ID = '9999'
          LEFT JOIN    EDW.DIM_BUS_DEP_ACT_INF_DD T3
            ON      T2.DEP_ACT_ID = T3.DEP_ACT_ID
            AND     T3.DT = '20221231'
            AND     T3.LGP_ID = '9999'
          WHERE T1.DT='20221231'
          AND t1.opn_org_id in(select organkey from adm_upss.aml_t00_organ where dt='20221231' and organdes='ZH')
          AND t1.ACT_STS_CD='A'
          ) b    ON a.cst_id=b.cst_id
                and b.rnum=1
left join edw.dim_cst_idv_bas_inf_dd c
      on a.cst_id=c.cst_id
      and c.dt='20221231'
left join edw.dim_cst_entp_bas_inf_dd d
      on a.cst_id=d.cst_id
      and d.dt='20221231'
where a.dt='20221231'
;
--2022年对公客户关系人信息
DROP TABLE if exists TMP03_ORG_20220118_19;
CREATE TABLE TMP03_ORG_20220118_19 AS
SELECT * FROM (
    SELECT A.CST_ID,A1.REL_TYP_CD,A1.REL_CST_ID,B.CST_CHN_NM,B.PRM_DOC_TYP_CD,PRM_DOC_NBR,PRM_DOC_MTU_DT,A.OCP_CD
          ,ROW_NUMBER() OVER(PARTITION BY A.CST_ID,A1.REL_TYP_CD ORDER BY A1.REL_CST_ID) RNUM
    FROM tmp_lig_20220118_20 A
    LEFT JOIN EDW.DIM_CST_REL_INF_DD A1
        ON A.CST_ID=A1.CST_ID
        AND A1.DT='20221231'
    LEFT JOIN (SELECT A.CST_ID,A.CST_CHN_NM,A.PRM_DOC_TYP_CD,A.PRM_DOC_NBR,A.PRM_DOC_MTU_DT,B.OCP_CD
              FROM EDW.DIM_CST_BAS_INF_DD A
  						, EDW.DIM_CST_IDV_BAS_INF_DD B
              WHERE A.DT='20221231' AND B.DT='20221231' AND A.CST_ID=B.CST_ID
  						UNION ALL
              SELECT REL_CST_ID CST_ID,REL_NM CST_CHN_NM,DOC_TYP_CD PRM_DOC_TYP_CD,DOC_NBR PRM_DOC_NBR,DOC_MTU_DT PRM_DOC_MTU_DT,'' OCP_CD
              FROM EDW.DIM_CST_REL_IDV_INF_DD WHERE DT='20221231') B
    ON A1.REL_CST_ID=B.CST_ID
) A WHERE RNUM=1;
--2022年个人客户信息不完整数据
DROP TABLE if exists tmp_lig_20220118_20_IDV_1;
CREATE TABLE tmp_lig_20220118_20_IDV_1 AS
SELECT A.*
FROM tmp_lig_20220118_20 A
WHERE CST_TYP_CD='1'
AND (CST_CHN_NM=''
OR COALESCE(gdr_cd,'')=''
OR COALESCE(ntn_cd,'')=''
OR COALESCE(ocp_cd,'')=''
OR COALESCE(doc_nbr,'')=''
OR COALESCE(doc_typ_cd,'')=''
OR (COALESCE(mbl_nbr,'')='' AND COALESCE(fml_tel_nbr,'')='')
OR (COALESCE(reg_adr,'')='' AND COALESCE(fml_adr,'')='')
);
--2022年个人客户信息有效性不足数据
DROP TABLE if exists tmp_lig_20220118_20_IDV_2;
CREATE TABLE tmp_lig_20220118_20_IDV_2 AS
SELECT A.*
FROM tmp_lig_20220118_20 A
LEFT JOIN tmp_lig_20220118_20_IDV_1 B
ON A.CST_ID=B.CST_ID
WHERE A.CST_TYP_CD='1' AND B.CST_ID IS NULL
AND (COALESCE(A.ocp_cd,'') LIKE '8%'
OR (LENGTH(COALESCE(A.reg_adr,''))<=8
AND LENGTH(COALESCE(A.fml_adr,''))<=8)
);
--2022年对公客户信息不完整数据
DROP TABLE if exists tmp_lig_20220118_20_ORG_1;
CREATE TABLE tmp_lig_20220118_20_ORG_1 AS
SELECT
COALESCE(B.CST_CHN_NM,'')   LEGAL_OBJ
,COALESCE(B.PRM_DOC_TYP_CD,'')  LEGAL_CARD_TYPE
,COALESCE(B.PRM_DOC_NBR,'')   LEGAL_CARD_NO
,COALESCE(B.PRM_DOC_MTU_DT,'') LEGAL_CARD_END_DT
,A.*
FROM tmp_lig_20220118_20 A
LEFT JOIN TMP03_ORG_20220118_19 B
ON A.CST_ID=B.CST_ID
AND B.REL_TYP_CD='0101'
WHERE CST_TYP_CD='2'
AND (A.CST_CHN_NM=''
OR COALESCE(idt_cd,'')=''
OR COALESCE(opr_scp_dscr,'')=''
OR COALESCE(doc_nbr,'')=''
OR COALESCE(doc_typ_cd,'')=''
OR COALESCE(B.CST_CHN_NM,'')=''
OR COALESCE(B.PRM_DOC_TYP_CD,'')=''
OR COALESCE(B.PRM_DOC_NBR,'')=''
OR (COALESCE(reg_adr,'')='')
);
--2022年对公客户信息有效性不足数据
DROP TABLE if exists tmp_lig_20220118_20_ORG_2;
CREATE TABLE tmp_lig_20220118_20_ORG_2 AS
SELECT
COALESCE(B.CST_CHN_NM,'')   LEGAL_OBJ
,COALESCE(B.PRM_DOC_TYP_CD,'')  LEGAL_CARD_TYPE
,COALESCE(B.PRM_DOC_NBR,'')   LEGAL_CARD_NO
,COALESCE(B.PRM_DOC_MTU_DT,'') LEGAL_CARD_END_DT
,A.*
FROM tmp_lig_20220118_20 A
LEFT JOIN TMP03_ORG_20220118_19 B
ON A.CST_ID=B.CST_ID
AND B.REL_TYP_CD='0101'
LEFT JOIN tmp_lig_20220118_20_ORG_1 C
ON A.CST_ID=C.CST_ID
WHERE A.CST_TYP_CD='2' AND C.CST_ID IS NULL
AND (COALESCE(A.ocp_cd,'') LIKE '8%'
OR (COALESCE(A.reg_adr,'')<>'' AND LENGTH(COALESCE(A.reg_adr,''))<=8)
AND COALESCE(B.PRM_DOC_MTU_DT,'')<='20221231')
);
--2021年客户信息
DROP TABLE if exists tmp_lig_20220118_21;
create table tmp_lig_20220118_21 as
select b.opn_org_id,c.gdr_cd,c.ntn_cd,c.ocp_cd,d.opr_scp_dscr,a.*
from edw.dws_cst_bas_inf_dd a
inner join (SELECT t1.cst_id,t1.opn_org_id
            ,row_number() over(partition by t1.cst_id order by t1.opn_dt) rnum
            FROM EDW.DIM_BUS_DEP_CST_ACT_INF_DD T1
            LEFT JOIN    EDW.dwd_bus_dep_act_cst_act_rel_dd T2
                        ON      T1.CST_ACT_ID = T2.CST_ACT_ID
                        AND     T2.DT = '20221231'
                        AND     T2.LGP_ID = '9999'
            LEFT JOIN    EDW.DIM_BUS_DEP_ACT_INF_DD T3
                        ON      T2.DEP_ACT_ID = T3.DEP_ACT_ID
                        AND     T3.DT = '20221231'
                        AND     T3.LGP_ID = '9999'
            WHERE T1.DT='20221231'
            AND t1.opn_org_id in(select organkey from adm_upss.aml_t00_organ where dt='20221231' and organdes='ZH')
            AND t1.ACT_STS_CD='A') b
    and b.rnum=1
    left join edw.dim_cst_idv_bas_inf_dd c
      on a.cst_id=c.cst_id
    and c.dt='20221231'
    left join edw.dim_cst_entp_bas_inf_dd d
      on a.cst_id=d.cst_id
    and d.dt='20221231'
  where a.dt='20221231'
;
--2021年对公客户关系人信息
DROP TABLE if exists TMP03_ORG_20220118_21;
CREATE TABLE TMP03_ORG_20220118_21 AS
SELECT * FROM (
    SELECT A.CST_ID,A1.REL_TYP_CD,A1.REL_CST_ID,B.CST_CHN_NM,B.PRM_DOC_TYP_CD,PRM_DOC_NBR,PRM_DOC_MTU_DT,A.OCP_CD
    ,ROW_NUMBER() OVER(PARTITION BY A.CST_ID,A1.REL_TYP_CD ORDER BY A1.REL_CST_ID) RNUM
    FROM tmp_lig_20220118_21 A
      LEFT JOIN EDW.DIM_CST_REL_INF_DD A1
        ON A.CST_ID=A1.CST_ID
AND A1.DT='20211231'
  LEFT JOIN (SELECT A.CST_ID,A.CST_CHN_NM,A.PRM_DOC_TYP_CD,A.PRM_DOC_NBR,A.PRM_DOC_MTU_DT,B.OCP_CD FROM EDW.DIM_CST_BAS_INF_DD A
  						, EDW.DIM_CST_IDV_BAS_INF_DD B WHERE A.DT='20211231' AND B.DT='20211231' AND A.CST_ID=B.CST_ID
  						UNION ALL
             SELECT REL_CST_ID CST_ID,REL_NM CST_CHN_NM,DOC_TYP_CD PRM_DOC_TYP_CD,DOC_NBR PRM_DOC_NBR,DOC_MTU_DT PRM_DOC_MTU_DT,'' OCP_CD
             FROM EDW.DIM_CST_REL_IDV_INF_DD WHERE DT='20211231') B
    ON A1.REL_CST_ID=B.CST_ID
) A WHERE RNUM=1;
--2021年个人客户信息不完整数据
DROP TABLE if exists tmp_lig_20220118_21_IDV_1;
CREATE TABLE tmp_lig_20220118_21_IDV_1 AS
SELECT A.*
FROM tmp_lig_20220118_21 A
WHERE CST_TYP_CD='1'
AND (CST_CHN_NM=''
OR COALESCE(gdr_cd,'')=''
OR COALESCE(ntn_cd,'')=''
OR COALESCE(ocp_cd,'')=''
OR COALESCE(doc_nbr,'')=''
OR COALESCE(doc_typ_cd,'')=''
OR (COALESCE(mbl_nbr,'')='' AND COALESCE(fml_tel_nbr,'')='')
OR (COALESCE(reg_adr,'')='' AND COALESCE(fml_adr,'')='')
);
--2021年个人客户信息有效性不足数据
DROP TABLE if exists tmp_lig_20220118_21_IDV_2;
CREATE TABLE tmp_lig_20220118_21_IDV_2 AS
SELECT A.*
FROM tmp_lig_20220118_21 A
LEFT JOIN tmp_lig_20220118_21_IDV_1 B
ON A.CST_ID=B.CST_ID
WHERE A.CST_TYP_CD='1' AND B.CST_ID IS NULL
AND (COALESCE(A.ocp_cd,'') LIKE '8%'
OR (LENGTH(COALESCE(A.reg_adr,''))<=8
AND LENGTH(COALESCE(A.fml_adr,''))<=8)
);
--2021年对公客户信息不完整数据
DROP TABLE if exists tmp_lig_20220118_21_ORG_1;
CREATE TABLE tmp_lig_20220118_21_ORG_1 AS
SELECT
COALESCE(B.CST_CHN_NM,'')   LEGAL_OBJ
,COALESCE(B.PRM_DOC_TYP_CD,'')  LEGAL_CARD_TYPE
,COALESCE(B.PRM_DOC_NBR,'')   LEGAL_CARD_NO
,COALESCE(B.PRM_DOC_MTU_DT,'') LEGAL_CARD_END_DT
,A.*
FROM tmp_lig_20220118_21 A
LEFT JOIN TMP03_ORG_20220118_21 B
ON A.CST_ID=B.CST_ID
AND B.REL_TYP_CD='0101'
WHERE CST_TYP_CD='2'
AND (A.CST_CHN_NM=''
OR COALESCE(idt_cd,'')=''
OR COALESCE(opr_scp_dscr,'')=''
OR COALESCE(doc_nbr,'')=''
OR COALESCE(doc_typ_cd,'')=''
OR COALESCE(B.CST_CHN_NM,'')=''
OR COALESCE(B.PRM_DOC_TYP_CD,'')=''
OR COALESCE(B.PRM_DOC_NBR,'')=''
OR (COALESCE(reg_adr,'')='')
);
--2021年对公客户信息有效性不足数据
DROP TABLE if exists tmp_lig_20220118_21_ORG_2;
CREATE TABLE tmp_lig_20220118_21_ORG_2 AS
SELECT
COALESCE(B.CST_CHN_NM,'')   LEGAL_OBJ
,COALESCE(B.PRM_DOC_TYP_CD,'')  LEGAL_CARD_TYPE
,COALESCE(B.PRM_DOC_NBR,'')   LEGAL_CARD_NO
,COALESCE(B.PRM_DOC_MTU_DT,'') LEGAL_CARD_END_DT
,A.*
FROM tmp_lig_20220118_21 A
LEFT JOIN TMP03_ORG_20220118_21 B
ON A.CST_ID=B.CST_ID
AND B.REL_TYP_CD='0101'
LEFT JOIN tmp_lig_20220118_21_ORG_1 C
ON A.CST_ID=C.CST_ID
WHERE A.CST_TYP_CD='2' AND C.CST_ID IS NULL
AND (COALESCE(A.ocp_cd,'') LIKE '8%'
OR (COALESCE(A.reg_adr,'')<>'' AND LENGTH(COALESCE(A.reg_adr,''))<=8)
AND COALESCE(B.PRM_DOC_MTU_DT,'')<='20211231')
);
2020年底自然人客户数
2020年底非自然人客户数
select count(*) from tmp_lig_20220118_20
where cst_typ_cd='1'
--group by opn_org_id
select count(*) from tmp_lig_20220118_20
where cst_typ_cd='2'
--group by opn_org_id
2021年底自然人客户数
2021年底非自然人客户数
select count(*) from tmp_lig_20220118_21
where cst_typ_cd='1'
--group by opn_org_id
select count(*) from tmp_lig_20220118_21
where cst_typ_cd='2'
--group by opn_org_id
--2021年末尚未完成客户信息治理客户数
select count(*) from
(select cst_id from tmp_lig_20220118_21_IDV_1
union all
select cst_id from tmp_lig_20220118_21_org_1
union all
select cst_id from tmp_lig_20220118_21_IDV_2
union all
select cst_id from tmp_lig_20220118_21_org_2) a
--group by opn_org_id
--2021年末尚未完成客户信息治理客户数
select count(*) from
(select cst_id from tmp_lig_20220118_20_IDV_1
union all
select cst_id from tmp_lig_20220118_20_org_1
union all
select cst_id from tmp_lig_20220118_20_IDV_2
union all
select cst_id from tmp_lig_20220118_20_org_2) a
--group by opn_org_id
--2021年被控制客户信息
create table tmp_lig_20220118_21_IDV_kz as
  SELECT distinct a.cst_id FROM edw.DIM_BUS_DEP_CST_ACT_INF_DD a
    inner join (
      select cst_act_id from edw.DIM_BUS_DEP_CST_ACT_INF_DD where dt='20211231' and (act_rcv_oly_ind='1'
or act_cls_frz_ind='1')
union  all
select cst_act_id
from edw.dwd_bus_dep_act_lmt_inf_dd
where dt='20211231'
and act_thrs_typ='2'
union all
select cst_act_id
from edw.dwd_bus_dep_frz_inf_dd
where dt='20211231'
and nfrz_ind='0'
) b
  on a.cst_act_id=b.cst_act_id
where dt='20211231'
AND a.opn_org_id in(select organkey from adm_upss.aml_t00_organ where dt='20211231' and organdes='ZH')
CREATE TABLE TMP_LIG_20220118_ACT(CST_ACT_ID STRING);
--插入涉案账户，账户列表参考业务提供的EXCEL文件
insert into TMP_LIG_20220118_ACT
select '' from dual union all
select '' from dual
;
--8.（2）人工新增可疑交易份数（份）
SELECT * FROM T07_CASE_APPLICATION_UH WHERE CASE_DATE BETWEEN DATE'2021-01-01' AND DATE'2021-12-31'
AND
/*
--2020年被控制客户信息
DROP TABLE if exists tmp_lig_20220118_20_IDV_kz;
create table tmp_lig_20220118_20_IDV_kz as
  SELECT distinct a.cst_id FROM edw.DIM_BUS_DEP_CST_ACT_INF_DD a
    inner join (
      select cst_act_id from edw.DIM_BUS_DEP_CST_ACT_INF_DD where dt='20201231' and (act_rcv_oly_ind='1'
or act_cls_frz_ind='1')
union  all
select cst_act_id
from edw.dwd_bus_dep_act_lmt_inf_dd
where dt='20201231'
and act_thrs_typ='2'
union all
select cst_act_id
from edw.dwd_bus_dep_frz_inf_dd
where dt='20201231'
and nfrz_ind='0'
) b
  on a.cst_act_id=b.cst_act_id
where dt='20201231'
AND a.opn_org_id in(select organkey from adm_upss.aml_t00_organ where dt='20211231' and organdes='ZH')
--反洗钱统计数据 20600
SELECT count(*) FROM T10_PARTY_RISK A ,T47_PARTY B
WHERE RISK_TYPE='F15' AND  b.PARTY_ID like 'ZH%'
AND A.PARTY_ID=B.PARTY_ID
AND A.CREATE_DT BETWEEN DATE'2021-01-01' AND DATE'2021-12-31'
AND B.CREATE_DT<=DATE'2021-12-31'
--group by b.ORGANKEY
SELECT COUNT(DISTINCT A.PARTY_ID) FROM T10_PARTY_RISK A ,T47_PARTY B
,(SELECT PARTY_ID FROM T10_CHECKPARTY_RELT UNION ALL
SELECT PARTY_ID FROM T10_CHECKPARTY_RELT_UH) T
WHERE RISK_TYPE='F15' AND  b.PARTY_ID like 'ZH%'
AND A.PARTY_ID=B.PARTY_ID
and t.party_id=a.party_id
AND A.CREATE_DT BETWEEN DATE'2021-01-01' AND DATE'2021-12-31'
AND B.CREATE_DT<=DATE'2021-12-31'
--group by b.ORGANKEY
SELECT COUNT(DISTINCT A.PARTY_ID)
FROM T10_PARTY_RISK A ,T47_PARTY B
,(SELECT PARTY_ID FROM T37_PARTY_RESULT_CURR WHERE GSKEY='PKG99' UNION ALL
SELECT PARTY_ID FROM T37_PARTY_RESULT_uh WHERE GSKEY='PKG99') T
WHERE RISK_TYPE='F15' AND  b.PARTY_ID like 'ZH%'
AND A.PARTY_ID=B.PARTY_ID
and t.party_id=a.party_id
AND A.CREATE_DT BETWEEN DATE'2021-01-01' AND DATE'2021-12-31'
AND B.CREATE_DT<=DATE'2021-12-31'
--group by b.ORGANKEY
select '1' FLAG,PARTY_ID,ORGANKEY from t47_party where party_id in (
select party_id from t37_party_result_CURR where levelkEy='1005')
AND PARTY_ID like 'ZH%'
AND CREATE_DT<=DATE'2021-12-31'
UNION ALL
select '2' FLAG,PARTY_ID,ORGANKEY from t47_party where party_id in (
SELECT PARTY_ID FROM T10_PARTY_RISK A WHERE RISK_TYPE='F15'
AND A.CREATE_DT BETWEEN DATE'2021-01-01' AND DATE'2021-12-31')
AND PARTY_ID like 'ZH%'
AND CREATE_DT<=DATE'2021-12-31'
CREATE TABLE TMP_LIG_20220118_CST(TYPE STRING,CST_ID STRING,ORG_ID STRING);
tunnel upload -c gbk D:\TMP_LIG_20220118_CST.txt tldata_dev.TMP_LIG_20220118_CST;
select COUNT(*)
from tmp_lig_20220118_21_IDV_kz A,TMP_LIG_20220118_CST B
where A.cst_id=B.CST_ID
and b.type='2'
--GROUP BY org_id
select count(*) from t47_party where party_id in (
select party_id from t37_party_result_CURR where levelkEy='1005')
AND ORGANKEY like '3303%'
AND CREATE_DT<=DATE'2021-12-31'
--group by ORGANKEY
select count(*) from t47_party where party_id in (
select party_id from t37_party_result_CURR where levelkEy='1005')
AND ORGANKEY like '3303%'
AND CREATE_DT<=DATE'2021-12-31'
and party_id in (SELECT PARTY_ID FROM T10_CHECKPARTY_RELT UNION ALL
SELECT PARTY_ID FROM T10_CHECKPARTY_RELT_UH)
--group by ORGANKEY
select COUNT(*)
from tmp_lig_20220118_21_IDV_kz A,TMP_LIG_20220118_CST B
where A.cst_id=B.CST_ID
and b.type='1'
--GROUP BY org_id
*/
***SJ2023103161_PART2.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 张云杰
-- 创建日期: 2023-11-02 11:05:33
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
--14 与第三方支付机构教育 258871.376593
--大额支付系统处理的，银行名称带&ldquo;备付金&rdquo;字样且行号&ldquo;991&rdquo;开头的银行
-- mbflag: 1往账 2来账
-- payflag：1贷记 2借记
-- 往账贷记 我行付款
-- 往账借记 我行收款
-- 来账贷记 我行收款
-- 来账借记 我行付款
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_14_hvps PURGE;
CREATE TABLE zyj_mis_SJ2023103161_14_hvps AS
SELECT  '14'                                                                     AS ind
        ,sum(( t.realamount * a2.avg_prc / 100 ) / ( a3.avg_prc / 100 )) / 10000 AS val
FROM    edw.spmt_t_hvps_paymentbook t
INNER JOIN    (
                  SELECT  dt
                          ,avg_prc --中间价
                          ,ccy_cd --币种代码
                  FROM    edw.dim_bus_com_exr_inf_dd --汇率信息
                  WHERE   dt >= '20220101'
                  AND     dt <= '20221231'
              ) a2
ON      t.workdate = a2.dt
AND     t.currency = a2.ccy_cd
LEFT JOIN    (
                 SELECT  dt
                         ,avg_prc --中间价
                 FROM    edw.dim_bus_com_exr_inf_dd --汇率信息
                 WHERE   ccy_cd = '156' --人民币
                 AND     dt >= '20220101'
                 AND     dt <= '20221231'
             ) a3
ON      t.workdate = a3.dt
WHERE   t.dt >= '20220101'
AND     t.dt <= '20221231'
AND     ( ( t.payeebankname LIKE '%备付金%'
AND     t.payeebank LIKE '991%' )
    OR ( t.payerbankname LIKE '%备付金%'
AND     t.payerbank LIKE '991%' ) );
select * from zyj_mis_SJ2023103161_14_hvps;
-- select * from edw.spmt_t_hvps_paymentbook t
-- where t.dt = '20221231';
--总行交易
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_14_hvps_zh PURGE;
create table zyj_mis_SJ2023103161_14_hvps_zh
as
SELECT  '泰隆银行' as zh
        ,count(*) as 总笔数
        ,sum(t.cny_amt) 总金额
FROM    adm_upss.aml_t47_transaction t
and t.dt <= '20221231'
and t.dt >= '20220101'
;
select * from zyj_mis_SJ2023103161_14_hvps_zh;
--交易对手排名
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_14_hvps_dt PURGE;
create table zyj_mis_SJ2023103161_14_hvps_dt
as
SELECT  s . *
        ,CASE WHEN R.交易银行 IS NOT NULL THEN r.笔数 ELSE 0 END 总笔数交易对手
        ,CASE WHEN R.交易银行 IS NOT NULL THEN r.总金额 else 0 end 总金额交易对手
FROM    (
  SELECT  t.opp_organname 交易银行
                          ,count(*) 笔数
                          ,sum(t.cny_amt) 总金额
                  FROM    adm_upss.aml_t47_transaction t
                  WHERE   t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
                  AND     t.opp_organname is not null
                  AND     t.dt <= '20221231'
                  AND     t.dt >= '20220101'
                  GROUP BY t.opp_organname

        ) s
LEFT JOIN    (
         SELECT  t.opp_organname 交易银行
                    ,count(*) 笔数
                    ,sum(t.cny_amt) 总金额
            FROM    adm_upss.aml_t47_transaction t
            WHERE   t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
            AND     t.dt <= '20221231'
            AND     t.dt >= '20220101'
            AND     t.opp_organname is not null
            AND     t.opp_name = t.opp_organname
            GROUP BY t.opp_organname
              ) r
ON      s.交易银行 = r.交易银行;
select * from zyj_mis_SJ2023103161_14_hvps_dt;
select T.tx_no,T.tx_dt,T.organkey,T.cny_amt,T.opp_name,T.opp_organname FROM adm_upss.aml_t47_transaction t
where t.dt = '20221231' and t.opp_organname like '%财付通%';
-- 扫二维码付款	36745822	10663138226.65
-- 微信转账	28309319	68627357629.88
-- 财付通支付科技有限公司	8089180	42527808619.52
select T.opp_name,count(*) as 笔数,sum(cny_amt) as 金额 FROM adm_upss.aml_t47_transaction t
where t.dt >= '20220101' AND t.dt <= '20221231' and t.opp_organname like '%财付通%' and t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
GROUP BY T.opp_name
order by count(*) desc;
--支付宝（中国）网络技术有限公司	7900205	55092851722.11
--还款	2293251	5850925074.57
select T.opp_name,count(*) as 笔数,sum(cny_amt) as 金额 FROM adm_upss.aml_t47_transaction t
where t.dt >= '20220101' AND t.dt <= '20221231' and t.opp_organname like '%支付宝%' and t.opp_sys_id IN ( 'H01' , 'H04' , 'H12' )
GROUP BY T.opp_name
order by count(*) desc;
-- 21 境内跨行转账汇款
-- 40165.0877315969
-- 表名： Ormt_Master,
-- 清算渠道：clearing_Channel ='FMT'
-- 日期：remit_Date
-- 是否退汇：is_Return='YES'
-- 票据汇总：1556747.85985
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_21_ormt PURGE;
CREATE TABLE zyj_mis_SJ2023103161_21_ormt AS
SELECT  '21'                                                                       AS ind
        ,sum(( t.remit_amount * a2.avg_prc / 100 ) / ( a3.avg_prc / 100 )) / 10000 AS val
FROM    edw.niss_ormt_master t
INNER JOIN    (
                  SELECT  dt
                          ,avg_prc --中间价
                          ,iso_ccy_cd --币种代码
                  FROM    edw.dim_bus_com_exr_inf_dd --汇率信息
                  WHERE   dt >= '20220101'
                  AND     dt <= '20221231'
              ) a2
ON      REPLACE(substr(t.trans_date, 1, 10), '-', '') = a2.dt
AND     t.remit_ccy = a2.iso_ccy_cd
LEFT JOIN    (
                 SELECT  dt
                         ,avg_prc --中间价
                 FROM    edw.dim_bus_com_exr_inf_dd --汇率信息
                 WHERE   ccy_cd = '156' --人民币
                 AND     dt >= '20220101'
                 AND     dt <= '20221231'
             ) a3
ON      REPLACE(substr(t.trans_date, 1, 10), '-', '') = a3.dt
WHERE   t.dt = '20221231'
AND     t.clearing_Channel = 'FMT'
AND     t.is_Return = 'YES';
;
select * from zyj_mis_SJ2023103161_21_ormt;
--境内外人民币edw.ebnk_cmb_hke_cert_inf  1556747.85985
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_21_forrmb PURGE;
CREATE TABLE zyj_mis_SJ2023103161_21_forrmb AS
SELECT  '21'                        AS ind
        ,SUM(rcv.PRSNT_AMT) / 10000 AS 总金额
FROM    edw.nbms_ifb_acpt_prsnt_rcv rcv
INNER JOIN    edw.nbms_ifb_core_buss_log log
ON      rcv.id = log.BUSS_ID
AND     log.dt <= '20221231'
WHERE   log.TXN_CD = 'CNAPS_PAY'
AND     log.ACCT_STAT = '1'
AND     rcv.NEW_DH_ACTNO != '0'
AND     rcv.dt = '20221231'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    edw.nbms_ifb_cust_acct acct
                       WHERE   acct.acct_no = rcv.NEW_DH_ACTNO
                       AND     acct.dt = '20221231'
                   );
select * from zyj_mis_SJ2023103161_21_forrmb;
select t.dt,count(*) as cnt from edw.nbms_ifb_core_buss_log t
where t.dt<='20221201' and t.dt<='20221231'
GROUP BY t.dt
;
-- 22全量信用卡数量 367025
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_22_card PURGE;
CREATE TABLE zyj_mis_SJ2023103161_22_card AS
SELECT  '22'                               AS ind
        ,count(DISTINCT t.cr_crd_card_nbr) AS val --  信用卡数
FROM    adm_pub_app.adm_pblc_ast_crd_card_inf_dd t
INNER JOIN    edw.dim_bus_crd_cr_crd_inf_dd t1
ON      t1.dt = '20221231'
AND     t.cr_crd_card_nbr = t1.cr_crd_card_nbr
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t.sbst_cr_card_ind = '1'
AND     t.dt = '20221231'
AND     t3.cpy_org_id = '999999998';
SELECT  *
FROM    zyj_mis_SJ2023103161_22_card;
-- --21 境内跨行转账汇款 425306351.457868
-- DROP TABLE IF EXISTS zyj_mis_SJ2023103161_21_trx PURGE;
-- CREATE TABLE zyj_mis_SJ2023103161_21_trx AS
-- SELECT  '21'                   AS ind
--         ,sum(jiaoyije) / 10000 AS val
-- FROM    edw.CORE_KCGB_SFDJBU a --收费登记簿
-- INNER JOIN    edw.dws_bus_dep_act_inf_dd b
-- ON      a.zhanghao = b.dep_act_id
-- AND     b.dt = '20221231'
-- LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
-- ON      b.CST_ID = T2.CST_ID
-- AND     T2.DT = '20221231'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
-- ON      t2.prm_org_id = t3.org_id
-- AND     t3.dt = '20221231'
-- WHERE   a.DT >= '20220101'
-- AND     a.dt <= '20221231'
-- AND     SHOUFDMA = 'TL010015'
-- AND     QDAOLEIX <> 'B05'
-- AND     t3.cpy_org_id = '999999998';
-- select * from zyj_mis_SJ2023103161_21_trx;
--重复校验
-- select t.org_id,count(*) from edw.dim_hr_org_mng_org_tree_dd t
-- where t.dt = '20221231'
-- GROUP BY t.org_id
-- HAVING count(*)>1
-- 23 个人网银
-- 1：3283092
-- 2：3067322
-- 3：112359
-- 4：651
-- 1、2022年12月31日前，已开通个人网银且截至2022年12月31日签约状态正常的客户数
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_23_idvbank PURGE;
CREATE TABLE zyj_mis_SJ2023103161_23_idvbank AS
SELECT  '231'                      AS ind
        ,count(DISTINCT pcc_cstno) AS val
FROM    edw.ebnk_pb_cstinf_channel t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.pcc_cstno = T2.CST_ID
AND     T2.DT = '20231105'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231105'
WHERE   t.dt = '20221231'
AND     t.pcc_channelstt = '0'
AND     t.pcc_channel IN ( '0' , '1' )
AND     t3.cpy_org_id = '999999998'
UNION ALL
-- 2、2022年12月31日前，已开通个人手机银行且截至2022年12月31日签约状态正常的客户数
SELECT  '232' AS ind
        ,count(DISTINCT pcc_cstno) AS val
FROM    edw.ebnk_pb_cstinf_channel t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.pcc_cstno = T2.CST_ID
AND     T2.DT = '20231105'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231105'
WHERE   t.dt = '20221231'
AND     t.pcc_channelstt = '0'
AND     t.pcc_channel = '2'
AND     t3.cpy_org_id = '999999998'
UNION ALL
-- 3、个人客户已申领ukey且证书状态正常且证书有效期大于2022年12月31日，统计ukey数
SELECT  '233'                      AS ind
        ,count(DISTINCT pcc_cstno) AS val
FROM    edw.ebnk_pb_cstinf_channel t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.pcc_cstno = T2.CST_ID
AND     T2.DT = '20231105'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231105'
WHERE   t.dt = '20221231'
AND     t.pcc_channelstt = '0'
AND     t.pcc_safeflag = '10000'
AND     t3.cpy_org_id = '999999998'
UNION ALL
-- 4、2022年12月31日前，个人客户已申领令牌（令牌无状态，目前已停发、存量客户在用），统计令牌数
SELECT  '234'                      AS ind
        ,count(DISTINCT pcc_cstno) AS val
FROM    edw.ebnk_pb_cstinf_channel t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.pcc_cstno = T2.CST_ID
AND     T2.DT = '20231105'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231105'
WHERE   t.dt = '20221231'
AND     t.pcc_safeflag = '01000'
AND     t3.cpy_org_id = '999999998'
;
select * from zyj_mis_SJ2023103161_23_idvbank;
-- 24.企业网银
-- 1、2022年12月31日前，已开通企业网银且截至2022年12月31日签约状态正常的客户数
-- 241	402524
-- 242	195700
-- 243	131
-- 244	315284
-- 245	86672
DROP TABLE IF EXISTS zyj1_mis_SJ2023103161_24_combank PURGE;
CREATE TABLE zyj1_mis_SJ2023103161_24_combank AS
SELECT  '241'                         AS ind
        ,count(DISTINCT t.cci_cstno) AS val
FROM    edw.ebnk_cb_cst_channel_inf t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.cci_cstno = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t.dt = '20221231'
AND     t.cci_channel = '0'
AND     t.cci_channelstt = '0'
AND     t.cci_bankid = '020200'
AND     t3.cpy_org_id = '999999998'
UNION ALL
-- 2、2022年12月31日前，已开通企业手机银行且截至2022年12月31日签约状态正常的客户数
SELECT  '242'                         AS ind
        ,count(DISTINCT t.cci_cstno) AS val
FROM    edw.ebnk_cb_cst_channel_inf t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.cci_cstno = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t.dt = '20221231'
AND     t.cci_channel = '4'
AND     t.cci_channelstt = '0'
AND     t.cci_bankid = '020200'
AND     t3.cpy_org_id = '999999998'
UNION ALL
-- 3、2022年12月31日前，已开通银企直连且截至2022年12月31日签约状态正常的客户数
SELECT  '243'                         AS ind
        ,count(DISTINCT t.cif_hostno) AS val
FROM    edw.ebnk_yq_cst_inf t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.cif_hostno = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t.dt = '20221231'
-- AND     t.cif_type = '1'
AND     t.cif_stt = '0'
AND     t3.cpy_org_id = '999999998'
UNION ALL
-- 4、2022年12月31日前，企业客户已申领ukey且截至2022年12月31日证书状态正常且证书有效期大于当前日期，统计ukey数
SELECT  '244'                        AS ind
        ,count(DISTINCT t.cci_keyno) AS val
FROM    edw.ebnk_cb_cert_inf t
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T.cci_cstno = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t.dt = '20221231'
AND     t.cci_expiredate > '20221231'
AND     t3.cpy_org_id = '999999998'
AND     t.cci_keyno IS NOT NULL
UNION ALL
-- 5、企业客户已申领云盾且状态正常且有效期大于当前日期，统计云盾数
SELECT  '245'                        AS ind
        ,count(DISTINCT t.hci_cstno) AS val
FROM    edw.ebnk_cmb_hke_cert_inf t
INNER JOIN    edw.ebnk_cb_cert_inf t1
ON      t.hci_cstno = t1.cci_cstno
AND     t1.dt = '20231105'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      T1.cci_cstno = T2.CST_ID
AND     T2.DT = '20231105'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231105'
WHERE   t3.cpy_org_id = '999999998'
AND     t.dt = '20231105'
AND     t1.cci_expiredate > '20231105'
;
select * FROM zyj1_mis_SJ2023103161_24_combank;
--保险箱 385
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_25_coffer PURGE;
CREATE TABLE zyj_mis_SJ2023103161_25_coffer AS
SELECT  '25'                           AS ind
        ,count(DISTINCT t.tail_box_id) AS val --  柜员尾箱数量
FROM    edw.dwd_bus_chnl_cnt_tail_box_tlr_inf_dd t --柜员尾箱信息
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t.bus_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t.dt = '20221231'
AND     t3.cpy_org_id = '999999998';
select * from zyj_mis_SJ2023103161_25_coffer;
--非居民
-- 26.NRA（非居民）账户 4653
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_26_NRA PURGE;
CREATE TABLE zyj_mis_SJ2023103161_26_NRA AS
SELECT  '26'                          AS ind
        ,count(DISTINCT b.cst_act_id) AS val --  NRA账户数量
FROM    edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      b.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
and t3.dt = '20221231'
WHERE   b.dt = '20221231'
and     b.cst_act_id like 'NRA%'
AND     t3.cpy_org_id = '999999998';
select * from zyj_mis_SJ2023103161_26_NRA;
--28 企业客户 392992
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_28_ent PURGE;
CREATE TABLE zyj_mis_SJ2023103161_28_ent AS
SELECT  '28'                           AS ind
        ,count(DISTINCT a.prm_doc_nbr) AS val --  企业客户数量
FROM    (
            SELECT  a1.prm_doc_nbr
            FROM    edw.dim_cst_entp_bas_inf_dd a --企业客户基本信息
            INNER JOIN    edw.dim_cst_bas_inf_dd a1 --客户基本信息
            ON      a.cst_id = a1.cst_id
            AND     a1.dt = '20221231'
            INNER JOIN    edw.dws_bus_dep_act_inf_dd b
            ON      a.cst_id = b.cst_id
            AND     b.dt = '20221231'
            LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
            ON      a.CST_ID = T2.CST_ID
            AND     T2.DT = '20221231'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
            ON      t2.prm_org_id = t3.org_id
            AND     t3.dt = '20221231'
            WHERE   a.dt = '20221231'
            AND     a.org_org_typ_cd NOT LIKE '02%' --事业单位
            AND     a.org_org_typ_cd NOT LIKE '03%' --机关、政府
            AND     a.cst_typ_cd NOT IN ( '0' , '1' )
            AND     t3.cpy_org_id = '999999998'
            AND     b.act_sts_cd <> 'C'
            AND     a1.prm_doc_nbr IS NOT NULL
            UNION ALL
            SELECT  t.mcht_licn_no AS prm_doc_nbr
            FROM    app_rpt.FCT_THS_MCH_INF_CESHI t
            LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
            ON      t.cst_id = T2.CST_ID
            AND     T2.DT = '20221231'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
            ON      t2.prm_org_id = t3.org_id
            AND     t3.dt = '20221231'
            WHERE   t.mch_stat IN ( '00' , '99' )
            AND     t.dt = '20221231'
            AND     t.cst_id LIKE '2%'
            AND     t.mcht_licn_no IS NOT NULL
            AND     t3.cpy_org_id = '999999998'
        ) a;
-- select distinct t1.cst_id  --客户号
--                     ,t1.cst_nm   --客户名称
--                     ,t1.cst_typ_cd   --客户类型代码
--                     ,t1.entp_siz_cd  --企业规模代码
--                     ,t1.idt_ctg_cd   --行业分类代码
--                     ,t2.prm_doc_typ_cd   --主证件类型代码
--                     ,t2.prm_doc_nbr      --主证件号码
-- from edw.dim_cst_entp_bas_inf_dd t1    --企业客户基本信息
-- left join edw.dim_cst_bas_inf_dd t2    --客户基本信息
-- on t1.cst_id = t2.cst_id
-- where t1.dt = '20231010'
-- and t2.dt = '20231010';
select * from zyj_mis_SJ2023103161_28_ent;
-- 29.个体工商户 51102
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_29_selfem PURGE;
CREATE TABLE zyj_mis_SJ2023103161_29_selfem AS
SELECT  '29'                      AS ind
        ,count(DISTINCT a.prm_doc_nbr) AS val --  个体工商户数量
FROM    (
            SELECT  a1.prm_doc_nbr
            FROM    edw.dim_cst_entp_bas_inf_dd a --企业客户基本信息
            INNER JOIN    edw.dim_cst_bas_inf_dd a1 --客户基本信息
            ON      a.cst_id = a1.cst_id
            AND     a1.dt = '20221231'
            INNER JOIN    edw.dws_bus_dep_act_inf_dd b
            ON      a.cst_id = b.cst_id
            AND     b.dt = '20221231'
            LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
            ON      a.CST_ID = T2.CST_ID
            AND     T2.DT = '20221231'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
            ON      t2.prm_org_id = t3.org_id
            AND     t3.dt = '20221231'
            WHERE   a.dt = '20221231'
            AND     t3.cpy_org_id = '999999998'
            AND     b.act_sts_cd <> 'C'
            AND     a1.prm_doc_nbr IS NOT NULL
            UNION ALL
            SELECT  t.mcht_licn_no AS prm_doc_nbr
            FROM    app_rpt.FCT_THS_MCH_INF_CESHI t
            LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
            ON      t.cst_id = T2.CST_ID
            AND     T2.DT = '20221231'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
            ON      t2.prm_org_id = t3.org_id
            AND     t3.dt = '20221231'
            WHERE   t.mch_stat IN ( '00' , '99' )
            AND     t.dt = '20221231'
            AND     t.cst_id LIKE '2%'
            AND     t.mcht_licn_no IS NOT NULL
            AND     t3.cpy_org_id = '999999998'
        ) a
where a.prm_doc_nbr like '92%'
;
select * from zyj_mis_SJ2023103161_29_selfem;
--30 现金密集型行业 263776
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_30_cashall PURGE;
CREATE TABLE zyj_mis_SJ2023103161_30_cashall AS
SELECT  '30'                      AS ind
        ,count(DISTINCT a.cst_id) AS val --  现金密集型客户数量
FROM    edw.dws_cst_bas_inf_dd a --客户基础信息汇总
INNER JOIN    edw.dws_bus_dep_act_inf_dd b
ON      a.cst_id = b.cst_id
AND     b.dt = '20221231'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      a.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   a.dt = '20221231'
AND     t3.cpy_org_id = '999999998'
AND     a.cst_typ_cd = '2' --对公客户
AND     ( a.idt_cd LIKE 'H%' --餐饮
    OR a.idt_cd LIKE 'R%' --娱乐
    OR a.idt_cd LIKE 'F%' --批发零售
);
select * from zyj_mis_SJ2023103161_30_cashall;
--31特定非金融行业客户 8677
-- C2438珠宝首饰及有关物品制造、F5245珠宝首饰零售、K7010房地产开发、
-- K7030房地产中介服务、L7231律师及相关法律服务、L7241会计、审计及税务服务
--下述行业的客户及泰惠收商户
--且截至2022年底未全部销户货未全部终止业务
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_31_unspecial PURGE;
CREATE TABLE zyj_mis_SJ2023103161_31_unspecial AS
SELECT  '31'                      AS ind
        ,count(DISTINCT r.cst_id) AS val
FROM    (
            SELECT  a.cst_id
            FROM    edw.dws_cst_bas_inf_dd a --客户基础信息汇总
            INNER JOIN    edw.dws_bus_dep_act_inf_dd b
            ON      a.cst_id = b.cst_id
            AND     b.dt = '20221231'
            WHERE   a.dt = '20221231'
            and b.act_sts_cd <> 'C'
            AND     ( ( a.idt_cd = 'C2438'
                OR a.idt_cd LIKE 'C2438%' )
                OR ( a.idt_cd = 'F5245'
                OR a.idt_cd LIKE 'F5245%' )
                OR ( a.idt_cd = 'K7010'
                OR a.idt_cd LIKE 'K7010%' )
                OR ( a.idt_cd = 'K7030'
                OR a.idt_cd LIKE 'K7030%' )
                OR ( a.idt_cd = 'L7231'
                OR a.idt_cd LIKE 'L7231%' )
                OR ( a.idt_cd = 'L7241'
                OR a.idt_cd LIKE 'L7241%' ) )
            UNION ALL
            SELECT  a.stl_act_cst_id AS cst_id
            FROM    edw.dws_bus_chnl_ths_mch_inf_dd a --泰惠收客户
            INNER JOIN    edw.dws_cst_bas_inf_dd a1 --客户基础信息汇总
            ON      a.stl_act_cst_id = a1.CST_ID
            AND     a1.dt = '20221231'
            INNER JOIN    edw.dws_bus_dep_act_inf_dd b
            ON      a1.CST_ID = b.cst_id
            AND     b.dt = '20221231'
            WHERE   a.dt = '20221231'
            AND     a.ctr_sts_cd IN ( '00' , '99' )
            AND     ( ( a1.idt_cd = 'C2438'
                OR a1.idt_cd LIKE 'C2438%' )
                OR ( a1.idt_cd = 'F5245'
                OR a1.idt_cd LIKE 'F5245%' )
                OR ( a1.idt_cd = 'K7010'
                OR a1.idt_cd LIKE 'K7010%' )
                OR ( a1.idt_cd = 'K7030'
                OR a1.idt_cd LIKE 'K7030%' )
                OR ( a1.idt_cd = 'L7231'
                OR a1.idt_cd LIKE 'L7231%' )
                OR ( a1.idt_cd = 'L7241'
                OR a1.idt_cd LIKE 'L7241%' ) )
        ) r
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      r.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
WHERE   t3.cpy_org_id = '999999998';
select * from zyj_mis_SJ2023103161_31_unspecial t;
--32个人客户，参考杨森中间结果表
--5036817
--44-2
select count(distinct aa.cst_id)
from LAB_BIGDATA_DEV.TMP_SJ2023103161_44_1 aa
inner join adm_pub.adm_csm_cbas_mng_inf_dd bb --客户管户信息
on aa.cst_id = bb.cst_id and bb.dt = '20221231'
inner join edw.dim_hr_org_mng_org_tree_dd cc  --机构树
on bb.prm_org_id = cc.org_id and cc.dt = '20221231' and cc.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
where xh = '否'
and   (wdye > 0 or wdye is null or wdye = '') --5245667
--and   (bsbf is null or bsbf = '') --5189441
;
SELECT  *
FROM    zyj_mis_SJ2023103161_32_person;
-- 33.非居民客户 4147
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_33_unres PURGE;
CREATE TABLE zyj_mis_SJ2023103161_33_unres AS
select '33' as ind,count(distinct a.cst_id) as val
FROM    edw.dws_cst_bas_inf_dd a
INNER JOIN    edw.dws_bus_dep_act_inf_dd b
ON      a.cst_id = b.cst_id
AND     b.dt = '20221231'
AND     b.act_sts_cd <> 'C'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      a.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     T3.DT = '20221231'
where a.dt='20221231'
                        'B0400',
                        'B0600'
                        )
AND     t3.cpy_org_id = '999999998'
;
select * from zyj_mis_SJ2023103161_33_unres;
--35 外国非公众人物 739
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_35_unpublic PURGE;
CREATE TABLE zyj_mis_SJ2023103161_35_unpublic AS
SELECT  '35'                      AS ind
        ,count(DISTINCT b.cst_id) AS val --  客户数
FROM    edw.niss_ormt_master a
INNER JOIN    edw.dim_bus_dep_cst_act_inf_dd b
ON      a.ord_acct = b.cst_act_id and b.dt = '20221231'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      b.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     T3.DT = '20221231'
WHERE  a.dt = '20221231'
AND     b.act_sts_cd <> 'C'
AND     t3.cpy_org_id = '999999998'
AND     a.cnty_code IN ( 'SOM' , 'IRQ' , 'KWT' , 'COD' , 'SDN' , 'LBN' , 'PRK' , 'LBY' , 'GNB' , 'CAF' , 'YEM' , 'SSD' , 'MLI' , 'AFG' , 'IRN' , 'PAK' , 'SYR' , 'CUB' , 'RUS' , 'ZWE' , 'VEN' , 'MMR' , 'BLR' , 'UKR' , 'BDI' , 'ALB' , 'BRB' , 'KHM' , 'JAM' , 'NIC' , 'PAN' , 'UGA' , 'ALB' , 'MKD' , 'MNE' , 'SRB' , 'BIH' , 'HRV' , 'BFA' , 'CYM' , 'MAR' , 'SEN' , 'HTI' , 'JOR' , 'MLT' , 'PHL' , 'TUR' );
SELECT  *
FROM    zyj_mis_SJ2023103161_35_unpublic;
--36 通过本行互联网渠道建立业务关系  327281
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_36_netchnl PURGE;
CREATE TABLE zyj_mis_SJ2023103161_36_netchnl AS
SELECT  '36'                      AS ind
        ,count(DISTINCT r.cst_id) AS val
FROM    (
            SELECT  t1.cst_id
            FROM    EDW.DWD_BUS_LOAN_ENTR_FORM_DD T1 --信贷业务进件单信息
            LEFT JOIN    EDW.DWD_BUS_LOAN_APL_REL_DD T14 -- 进件单关联表
            ON      T14.XUDAI_LST_SRL_NBR = T1.APL_SRL_NBR -- 关联 进件流水号
            AND     T14.OBJ_TYP = 'OnlineBusiness' -- 关联类型为 进件相关信息
            AND     T14.DT = '20221231'
            LEFT JOIN    EDW.LOAN_ENTRYFORM_BUSINESS T15 -- 进件相关业务信息
            ON      T15.SERIALNO = T14.OBJ_ID
            AND     T15.DT = '20221231'
            LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
            ON      t1.CST_ID = T2.CST_ID
            AND     T2.DT = '20221231'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
            ON      t2.prm_org_id = t3.org_id
            AND     T3.DT = '20221231'
            WHERE   t1.dt = '20221231'
            AND     t3.cpy_org_id = '999999998'
            AND     T15.sourcechannel IN ( 'L081009' , 'L081055' , 'L081057' )
            UNION ALL
            SELECT  t.cst_id
            FROM    app_rpt.adm_pub_bus_cr_crd_inf_dd t
            INNER JOIN    adm_pub_app.adm_pblc_ast_crd_card_inf_dd T1
            ON      T.cr_crd_card_nbr = T1.cr_crd_card_nbr
            AND     T1.DT = '20221231'
            LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
            ON      t.CST_ID = T2.CST_ID
            AND     T2.DT = '20221231'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
            ON      t2.prm_org_id = t3.org_id
            AND     T3.DT = '20221231'
            WHERE   t.dt = '20221231'
            AND     t3.cpy_org_id = '999999998'
            AND     t.chnl_cd IN ( 'L06' , 'L08' )
            AND     t1.sbst_cr_card_ind = '1'
        ) r;
select t.* FROM zyj_mis_SJ2023103161_36_netchnl t
;
--37 通过第三方建立业务关系，借呗和百度联合贷款 5245
--where c.pd_nm in ( '蚂蚁借呗' , '百度分期贷' )
--201050101040332 201050101040319
-- select * from edw.dim_bus_loan_pd_inf_dd t
-- where t.dt = '20221231'
-- AND t.pd_nm in ( '蚂蚁借呗' , '百度分期贷' );
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_37_otherbus PURGE;
CREATE TABLE zyj_mis_SJ2023103161_37_otherbus AS
SELECT  '37'                      AS ind
        ,count(DISTINCT t.cst_id) AS val
FROM    edw.dim_bus_loan_ctr_inf_dd t
WHERE   t.pd_cd IN ( '201050101040332' , '201050101040319' ) --'蚂蚁借呗' , '百度分期贷'
AND     t.dt = '20221231'
AND     t.ctr_bal > 0;
select * from zyj_mis_SJ2023103161_37_otherbus;
--38 高交易额客户数量 20081
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_38_maxamt PURGE;
CREATE TABLE zyj_mis_SJ2023103161_38_maxamt AS
select '38' as ind,count(d.cst_id) as val --  高交易额客户数量
from
(select c.cst_id,
       sum(a.trx_amt) trx_amt_tot
from edw.dwd_bus_dep_bal_chg_dtl_di a --存款余额发生明细
inner join edw.dim_bus_dep_cst_act_inf_dd b --客户存款账户信息
on a.cst_act_id=b.cst_act_id and b.dt='20221231' and b.act_sts_cd <> 'C' --未销户客户
inner join edw.dws_cst_bas_inf_dd c --客户基础信息汇总
on b.cst_id=c.cst_id and c.dt='20221231'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t2
ON      c.CST_ID = T2.CST_ID
AND     T2.DT = '20221231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     T3.DT = '20221231'
where a.dt>='20220101' and a.dt<='20221231'
AND     t3.cpy_org_id = '999999998'
group by c.cst_id) d
where d.trx_amt_tot>=100000000
;
select * from zyj_mis_SJ2023103161_38_maxamt;
--55 近一年内，经强化尽职调查后，采取业务与交易限制措施的客户数量
-- 1、2022年底，客户风险等级是较高风险、高风险客户数量
-- 2、2022年底，客户风险等级是较高风险、高风险，且在2022年被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付的客户。
-- 55	1004	22728
-- 55	1005	8610
CREATE TABLE IF NOT EXISTS  ZYJ_T37_PARTY_RESULT_2022 (
    TEMPLATEKEY      STRING COMMENT '模板编码'
  , GSKEY            STRING COMMENT '公式编号'
  , PARTY_ID         STRING COMMENT '客户号'
  , LEVELKEY         STRING COMMENT '最终风险等级'
  , FRISTAPPRALEVEL  STRING COMMENT '初评等级'
  , STATISTIC_DT     STRING COMMENT '评级日期'
  , RCHECK_DT        STRING COMMENT '审批日期'
  , TEMPCATEGORY     STRING COMMENT '模板类别'
  , ORGANKEY         STRING COMMENT '客户机构'
  , RN               STRING COMMENT '序号'
)COMMENT
'';
INSERT INTO ZYJ_T37_PARTY_RESULT_2022
SELECT S.TEMPLATEKEY,S.GSKEY,S.PARTY_ID,S.LEVELKEY,S.FRISTAPPRALEVEL,S.STATISTIC_DT,S.RCHECK_DT,S.TEMPCATEGORY,S.ORGANKEY,S.RN
  FROM (
SELECT T.TEMPLATEKEY,T.GSKEY,T.PARTY_ID,T.LEVELKEY,T.FRISTAPPRALEVEL,T.STATISTIC_DT,T.RCHECK_DT,T.TEMPCATEGORY,T.ORGANKEY
     , RANK() OVER(PARTITION BY T.PARTY_ID ORDER BY T.RCHECK_DT DESC) AS RN
FROM (
SELECT A.TEMPLATEKEY,A.GSKEY,A.PARTY_ID,A.LEVELKEY,A.FRISTAPPRALEVEL,SUBSTR(A.STATISTIC_DT,1,10) AS STATISTIC_DT,SUBSTR(A.RCHECK_DT,1,10) AS RCHECK_DT,A.TEMPCATEGORY,A.ORGANKEY
  FROM adm_upss.AML_T37_PARTY_RESULT_CURR A
 WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND A.DT = '20231031'
UNION
SELECT A.TEMPLATEKEY,A.GSKEY,A.PARTY_ID,A.LEVELKEY,A.FRISTAPPRALEVEL,SUBSTR(A.STATISTIC_DT,1,10) AS STATISTIC_DT,SUBSTR(A.RCHECK_DT,1,10) AS RCHECK_DT,A.TEMPCATEGORY,A.ORGANKEY
  FROM adm_upss.AML_T37_PARTY_RESULT_UH A
 WHERE SUBSTR(A.RCHECK_DT,1,10) <= '2022-12-31'
   AND A.DT = '20231031'
) T
) S WHERE S.RN <= 2
;
-- DROP TABLE IF EXISTS ZYJ_T47_PARTY_STS;
-- CREATE TABLE IF NOT EXISTS  ZYJ_T47_PARTY_STS (
--     PARTY_ID STRING COMMENT '客户号',
--     STS      STRING COMMENT '客户状态'
-- )COMMENT
-- '';
-- INSERT INTO ZYJ_T47_PARTY_STS
-- --账户全部销户
-- SELECT A.PARTY_ID,'1' AS STS
--   FROM adm_upss.ADM_UPSS_AML_T47_PARTY A
--  WHERE NOT EXISTS (SELECT 1
--           FROM adm_upss.ADM_UPSS_AML_T47_ID_DEPOSIT B
--          WHERE A.PARTY_ID = B.PARTY_ID
--            AND B.ACCT_STATUS_CD = '0'
--            AND B.dt = '20221231')
--   AND A.DT = '20221231'
-- UNION
-- --互联网贷款客户借款余额已为0
-- SELECT A.PARTY_ID,'2' AS STS
--   FROM adm_upss.adm_upss_aml_t47_loan_acct A
--  WHERE A.LTYPEKEY = '201050101040319'
--    AND AMT_VAL = '0'
--    AND NOT EXISTS
--  (SELECT 1 FROM adm_upss.adm_upss_aml_T47_ID_DEPOSIT B WHERE A.PARTY_ID = B.PARTY_ID AND B.DT = '20221231')
--    AND A.DT = '20221231'
-- UNION
-- --采取不收不付
-- SELECT  C.CST_ACT_ID
--         ,'3'
-- FROM    edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
-- LEFT JOIN    edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
-- ON      A.FRZ_ID = B.FRZ_ID
-- AND     B.DT = '20221231'
-- AND     b.FRZ_SRC_CD = '1'
-- LEFT JOIN    edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
-- ON      A.LBL_ACT_ID = C.DEP_ACT_ID
-- AND     C.DT = '20221231'
-- WHERE   A.DT = '20221231'
-- AND     A.FRZ_SCP_CD = '2'
-- AND     A.NFRZ_IND = '0'
-- AND     A.LMT_TYP IN ( '1' , '2' )
-- AND     B.FRZ_ID IS NULL
-- AND     LMT_TYP = '2'
-- AND     C.CST_ACT_ID IS NOT NULL
-- ;
--------------------------------------------------------------------------------------------------------------------
--迭代版代码
--2、取2022年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，关联2022年暂停非柜面、账户只收不付、不收不付的客户
--1、取2022年系统初评是高风险、较高风险或人工评定是高风险、较高风险的客户，去重。
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_55_ratehigh PURGE;
CREATE TABLE zyj_mis_SJ2023103161_55_ratehigh AS
SELECT  '551'                       AS ind
        ,count(DISTINCT A.PARTY_ID) AS val
FROM    ZYJ_T37_PARTY_RESULT_2022 A
WHERE   ( ( A.FRISTAPPRALEVEL IN ( '1004' , '1005' )
AND     SUBSTR(A.STATISTIC_DT, 1, 10) >= '2022-01-01'
AND     SUBSTR(A.STATISTIC_DT, 1, 10) <= '2022-12-31' )
    OR ( A.LEVELKEY IN ( '1004' , '1005' )
AND     SUBSTR(A.RCHECK_DT, 1, 10) >= '2022-01-01'
AND     SUBSTR(A.RCHECK_DT, 1, 10) <= '2022-12-31' ) )
AND     ORGANKEY IN (
                        SELECT  B.ORGANKEY
                        FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                        WHERE   B.report_organkey = 'C1092933000014'
                        AND     B.DT = '20231031'
                    )
UNION ALL
SELECT  '552'                       AS ind
        ,count(DISTINCT S.party_id) AS val
FROM    ZYJ_T37_PARTY_RESULT_2022 S
INNER JOIN    adm_upss.aml_t47_agreement T
ON      S.PARTY_ID = T.customer_id
INNER JOIN    (
                  SELECT  CST_ACT_ID
                  FROM    edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
                  WHERE   DT = '20221231'
                  AND     LMT_LVL = '30'
                  AND     ACT_THRS_TYP = '2'
                  AND     EVT_ID = 'DPDRAW'
                  AND     LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
                  GROUP BY CST_ACT_ID
                  UNION
                  SELECT  C.CST_ACT_ID
                  FROM    edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
                  LEFT JOIN    edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
                  ON      A.FRZ_ID = B.FRZ_ID
                  AND     B.DT = '20221231'
                  AND     b.FRZ_SRC_CD = '1'
                  LEFT JOIN    edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
                  ON      A.LBL_ACT_ID = C.DEP_ACT_ID
                  AND     C.DT = '20221231'
                  WHERE   A.DT = '20221231'
                  AND     A.FRZ_SCP_CD = '2'
                  AND     A.NFRZ_IND = '0'
                  AND     A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
                  AND     B.FRZ_ID IS NULL
                  AND     C.CST_ACT_ID IS NOT NULL
              ) M
ON      T.acct_num = M.CST_ACT_ID
WHERE   ( ( S.fristappralevel IN ( '1004' , '1005' )
AND     substr(S.statistic_dt, 1, 10) >= '2022-01-01'
AND     substr(S.statistic_dt, 1, 10) <= '2022-12-31' )
    OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND     substr(S.rcheck_dt, 1, 10) >= '2022-01-01'
AND     substr(S.rcheck_dt, 1, 10) <= '2022-12-31' ) )
AND     ORGANKEY IN (
                        SELECT  B.ORGANKEY
                        FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                        WHERE   B.report_organkey = 'C1092933000014'
                        AND     B.DT = '20231031'
                    );
select * from zyj_mis_SJ2023103161_55_ratehigh;
--56 k.近一年内，经强化尽职调查后，终止业务关系的客户数量，以及占全部强化尽职调查客户的比例和占全部客户数量的比例
--2022年底，客户风险等级是较高风险、高风险，且在2022年账户不收不付、销户的客户。
--9380
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_56_survey PURGE;
CREATE TABLE zyj_mis_SJ2023103161_56_survey AS
SELECT  '56'               AS ind
        ,count(A.PARTY_ID) AS val --  客户数
FROM    ZYJ_T37_PARTY_RESULT_2022 A
WHERE   A.LEVELKEY IN ( '1004' , '1005' )
AND     A.PARTY_ID like 'ZH%'
AND     SUBSTR(A.RCHECK_DT, 1, 10) <= '2022-12-31'
AND     EXISTS (
                   SELECT  1
                   FROM    ZYJ_T47_PARTY_STS B
                   WHERE   A.PARTY_ID = B.PARTY_ID
                   AND     B.STS IN ( '1' , '3' )
               )
;
select * from zyj_mis_SJ2023103161_56_survey;
--57 反洗钱 1587
-- 1、2022年度，被公安机关冻结、扣划（不含轮候冻结）的客户
-- 2、2022年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且2022年第一次冻扣前已被划分为高风险、较高风险的客户
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_57_froze PURGE;
CREATE TABLE zyj_mis_SJ2023103161_57_froze AS
SELECT  aa.cst_id
        ,aa.qry_ctrl_dt
        ,aa.qry_ctrl_tm
        ,aa.frz_bgn_dt
        ,aa.frz_tmn_dt
        ,ROW_NUMBER() OVER ( PARTITION BY aa.cst_id ORDER BY aa.qry_ctrl_dt , aa.qry_ctrl_tm ) AS rn
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd aa --司法查冻扣汇总信息
INNER JOIN    adm_pub.adm_csm_cbas_mng_inf_dd c --客户管户信息
ON      aa.cst_id = c.cst_id
AND     c.dt = '20221231'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd d --机构树
ON      c.prm_org_id = d.org_id
AND     d.dt = '20221231'
AND     d.cpy_org_id = '999999998' --法人机构：浙江泰隆商业银行股份有限公司
WHERE   aa.dt = '20231031'
AND     qry_ctrl_dt >= '20220101'
AND     qry_ctrl_dt <= '20221231'
AND     qry_ctrl_typ_nm IN ( '冻结' , '划扣' )
AND     ( aa.instt_typ_cd IN ( '04' , '05' )
    OR ( ( aa.instt_nm LIKE '%法院%'
    OR aa.instt_typ_cd = '01' )
AND     aa.LAW_DOC_ID LIKE '%刑%' ) );
--57关联高风险客群
-- 10692
-- 1587
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_57_frozerate PURGE;
CREATE TABLE zyj_mis_SJ2023103161_57_frozerate AS
SELECT  '571'                     AS ind
        ,count(DISTINCT t.cst_id) AS val
FROM    zyj_mis_SJ2023103161_57_froze t
UNION ALL
SELECT  '572' AS ind
        ,count(DISTINCT t.cst_id)
FROM    zyj_mis_SJ2023103161_57_froze t
INNER JOIN    ZYJ_T37_PARTY_RESULT_2022 A
ON      T.cst_id = substr(A.party_id, 3)
AND     TO_CHAR(DATEADD(TO_DATE(t.qry_ctrl_dt, 'yyyyMMdd'), - 1, 'dd'), 'yyyyMMdd') = REPLACE(substr(A.STATISTIC_DT, 1, 10), '-', '')
WHERE   A.LEVELKEY IN ( '1004' , '1005' )
AND     A.party_id LIKE 'ZH%';
SELECT  *
FROM    zyj_mis_SJ2023103161_57_frozerate;
--58、b.近一年内，机构上报大额交易报告笔数、份数
--20459858	12342
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_58_masivetxt PURGE;
CREATE TABLE zyj_mis_SJ2023103161_58_masivetxt AS
SELECT  '58' AS ind
        ,COUNT(B.TICD) --大额交易笔数
        ,COUNT(DISTINCT A.REPORTKEY) --份数
FROM    adm_upss.AML_T07_MSG_UH A
,    adm_upss.aml_t3a_tsdt_n_hst B
WHERE   A.REPORTORGANKEY = 'C1092933000014'
AND     A.SENDDATE_CH >= '20220101'
AND     A.SENDDATE_CH <= '20221231'
AND     A.DT = '20231031'
AND     B.DT = '20231031'
AND     A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND     A.REPORT_TYPE_CD = 'BH'
AND     A.REPORTKEY = B.RPT_ID
AND     B.cust_id like 'ZH%'
;
SELECT * FROM zyj_mis_SJ2023103161_58_masivetxt T;
--59 c.近一年内，大额交易报告交易对手为空（包括填写替代符&ldquo;@N&rdquo;）、为内部过渡账户的比例（按笔计）分别是？（不包括机构自身与客户之间发生的交易，如贷款、付息等）
/*大额现转标志是转账，交易对手账号是空或者交易对手名称是空的；*/
--6373
--538218
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_59_empty1 PURGE;
CREATE TABLE zyj_mis_SJ2023103161_59_empty1 AS
SELECT COUNT(B.TICD)
  FROM adm_upss.AML_T07_MSG_UH A ,adm_upss.AML_T3A_TSDT_N_HST B
 WHERE A.REPORTORGANKEY = 'C1092933000014'
   AND A.SENDDATE_CH >= '20220101'
   AND A.SENDDATE_CH <= '20221231'
   AND A.DT = '20231031'
   AND B.DT = '20231031'
   AND A.REPORT_TYPE_CD = 'BH'
   AND A.REPORTKEY = B.RPT_ID
   AND B.IS_CASH = '01'
   AND (B.TCAC = '@N' OR B.TCNM = '@N')
   AND B.CRPP NOT LIKE '%贷款发放%'
   AND B.CRPP NOT LIKE '%归还贷款%'
   AND B.CRPP NOT LIKE '%付息%'
   AND B.CRPP NOT LIKE '%结息%'
  AND     B.cust_id like 'ZH%'
;
/*大额现转标志是转账，交易对手账号是内部账户；*/
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_59_empty2 PURGE;
CREATE TABLE zyj_mis_SJ2023103161_59_empty2 AS
SELECT  COUNT(B.TICD)
FROM    adm_upss.AML_T07_MSG_UH A
,    adm_upss.AML_T3A_TSDT_N_HST B
WHERE   A.REPORTORGANKEY = 'C1092933000014'
AND     A.SENDDATE_CH >= '20220101'
AND     A.SENDDATE_CH <= '20221231'
AND     A.DT = '20231031'
AND     B.DT = '20231031'
AND     A.MSG_TYPE_CD IN ( 'N' , 'A' )
AND     A.REPORT_TYPE_CD = 'BH'
AND     A.REPORTKEY = B.RPT_ID
AND     B.IS_CASH = '01'
AND     B.CRPP NOT LIKE '%贷款发放%'
AND     B.CRPP NOT LIKE '%归还贷款%'
AND     B.CRPP NOT LIKE '%付息%'
AND     B.CRPP NOT LIKE '%结息%'
AND     B.cust_id like 'ZH%'
AND     EXISTS (
                   SELECT  1
                   FROM    adm_upss.ADM_UPSS_AML_T47_AGREEMENT_ACCT C
                   WHERE   B.TCAC = C.ACCT_NUM
                   AND     C.TXN_DSC = 'NBZH'
                   AND     C.DT = '20231031'
               );
SELECT  *
FROM    zyj_mis_SJ2023103161_59_empty1;
SELECT  *
FROM    zyj_mis_SJ2023103161_59_empty2;
--60 d.近一年内，大额交易报告报送超时的笔数及比例
--大额交易回执是警告回执，且回执内容含有逾期报送
--273402
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_60_warning PURGE;
CREATE TABLE zyj_mis_SJ2023103161_60_warning AS
SELECT '60' as ind,COUNT(DISTINCT D.TICD) as val
  FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B, adm_upss.AML_T3A_FDCF_FCER C ,adm_upss.AML_T3A_TSDT_N_HST D
WHERE C.ERRS LIKE '%逾期%'
   AND B.RCPT_ID = C.RCPT_ID
   AND A.MSGKEY = B.MSG_ID
   AND A.REPORTKEY = D.RPT_ID
   AND A.SENDDATE_CH >= '20220101'
   AND A.SENDDATE_CH <= '20221231'
   AND A.DT = '20231031'
   AND B.DT = '20231031'
   AND C.DT = '20231031'
   AND D.DT = '20231031'
   AND A.REPORTORGANKEY = 'C1092933000014'
   AND A.REPORT_TYPE_CD = 'BH'
 ;
SELECT * FROM zyj_mis_SJ2023103161_60_warning;
--61 e.近一年内，反洗钱监测分析中心校验不合格、要求更正或补录的笔数及比例
--大额交易回执是错误回执、系统补正回执、通用错误回执
--367698
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_61_cwhz PURGE;
CREATE TABLE zyj_mis_SJ2023103161_61_cwhz AS
SELECT '61' as ind,COUNT(DISTINCT C.TICD) as val
  FROM adm_upss.AML_T07_MSG_UH A, adm_upss.AML_T3A_RECEIPT B ,adm_upss.AML_T3A_TSDT_N_HST C
   AND A.MSGKEY = B.MSG_ID
   AND A.REPORTKEY = C.RPT_ID
   AND A.SENDDATE_CH >= '20220101'
   AND A.SENDDATE_CH <= '20221231'
   AND A.DT = '20231031'
   AND B.DT = '20231031'
   AND C.DT = '20231031'
   AND A.REPORTORGANKEY = 'C1092933000014'
   AND A.REPORT_TYPE_CD = 'BH'
;
select * from zyj_mis_SJ2023103161_61_cwhz;
--62 f.近一年内，人工填报大额交易报告涉及的业务类型、笔数、比例（人工填报大额交易报告笔数/所有大额交易报告笔数）
--大额案例类型是人工新增
--2516
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_62_rgxz PURGE;
CREATE TABLE zyj_mis_SJ2023103161_62_rgxz AS
SELECT '62' as ind,count(DISTINCT B.TICD) as val
  FROM adm_upss.AML_T07_CASE_APPLICATION_UH A,adm_upss.AML_T3A_TSDT_N_HST B
 WHERE A.CAST_TYPE = '1'
   AND A.DATE_STATUS_CD = '1'
   AND A.DT = '20231031'
   AND B.DT = '20231031'
   AND SUBSTR(A.APP_DT,1,10) >= '2022-01-01'
   AND SUBSTR(A.APP_DT,1,10) <= '2022-12-31'
   AND A.APP_ORG_ID IN (SELECT B.ORGANKEY
                          FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
                         WHERE B.report_organkey = 'C1092933000014'
                           AND B.DT = '20231031')
;
select * from zyj_mis_SJ2023103161_62_rgxz;
--65 f.可疑交易预警延后2年实现率：近2年内产生可疑交易预警的客户，在预警后受到司法机关查冻扣、人民银行反洗钱调查或税务机立案调查的客户数量和占比
-- 651	34881
-- 652	283
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_65_yjyh PURGE;
CREATE TABLE zyj_mis_SJ2023103161_65_yjyh AS
SELECT  A.PARTY_ID
        ,A.APP_DT
        ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY a.APP_DT ) AS rn
FROM    adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE   SUBSTR(A.APP_DT, 1, 10) >= '2021-01-01'
AND     SUBSTR(A.APP_DT, 1, 10) <= '2022-12-31'
AND     A.CAST_TYPE = '2'
AND     A.DT = '20231031'
AND     A.APP_ORG_ID IN (
                            SELECT  B.ORGANKEY
                            FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                            WHERE   B.report_organkey = 'C1092933000014'
                            AND     B.DT = '20231031'
                        );
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_65_yjyh1 PURGE;
CREATE TABLE zyj_mis_SJ2023103161_65_yjyh1 AS
SELECT  '651'                      AS ind
        ,COUNT(DISTINCT PARTY_ID) AS val
FROM    zyj_mis_SJ2023103161_65_yjyh
union ALL
--65 2、2021年至2022年被可疑预警的主客户，且在2022年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '652'                      AS ind
        ,COUNT(DISTINCT PARTY_ID) AS val
FROM    (
            SELECT  t . *
            FROM    zyj_mis_SJ2023103161_65_yjyh t
            WHERE   t.rn = 1
        ) p
INNER JOIN    (
                  SELECT  r . *
                  FROM    zyj_mis_SJ2023103161_57_froze r
                  WHERE   r.rn = 1
              ) s
ON      substr(p.PARTY_ID, 3) = s.cst_id
AND     REPLACE(substr(p.APP_DT, 1, 10), '-', '') > s.frz_bgn_dt
;
select * from zyj_mis_SJ2023103161_65_yjyh1;
--66 g.查冻扣客户3年历史预警率：评估时点近三年内受到司法机关新增查冻扣（不含已有冻扣客户新增轮候冻扣）、人民银行反洗钱调查或税务机立案调查的客户中，在接受调查或冻扣前已产生可疑交易预警的客户数量和占比
--49940
--277
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_66_yjyh PURGE;
CREATE TABLE zyj_mis_SJ2023103161_66_yjyh AS
SELECT  A.PARTY_ID
        ,A.APP_DT
        ,ROW_NUMBER() OVER ( PARTITION BY a.PARTY_ID ORDER BY a.APP_DT ) AS rn
FROM    adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE   SUBSTR(A.APP_DT, 1, 10) >= '2020-01-01'
AND     SUBSTR(A.APP_DT, 1, 10) <= '2022-12-31'
AND     A.CAST_TYPE = '2'
AND     A.DT = '20231031'
AND     A.APP_ORG_ID IN (
                            SELECT  B.ORGANKEY
                            FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                            WHERE   B.report_organkey = 'C1092933000014'
                            AND     B.DT = '20231031'
                        );
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_66_yjyh1 PURGE;
CREATE TABLE zyj_mis_SJ2023103161_66_yjyh1 AS
SELECT  '661'                      AS ind
        ,COUNT(DISTINCT PARTY_ID) AS val
FROM    zyj_mis_SJ2023103161_66_yjyh
union ALL
--66 2、2020年至2022年被可疑预警的主客户，且在2022年底前被司法查冻扣或被税务机关查询，且查冻扣时间晚于客户最早被可疑预警的时间的客户。
SELECT  '662'                      AS ind
        ,COUNT(DISTINCT PARTY_ID) AS val
FROM    (
            SELECT  t . *
            FROM    zyj_mis_SJ2023103161_66_yjyh t
            WHERE   t.rn = 1
        ) p
INNER JOIN    (
                  SELECT  r . *
                  FROM    zyj_mis_SJ2023103161_57_froze r
                  WHERE   r.rn = 1
              ) s
ON      substr(p.PARTY_ID, 3) = s.cst_id
AND     REPLACE(substr(p.APP_DT, 1, 10), '-', '') > s.frz_bgn_dt
;
select * from zyj_mis_SJ2023103161_66_yjyh1;
--67 f.近一年内，向反洗钱中心报送可疑交易报告数量，向人民银行分支机构直接报送重点可疑交易报告数量，向侦查、监察机关和税务部门报案数量
--2022年，上报可疑案例的报告数量
--2047
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_67_kebg PURGE;
CREATE TABLE zyj_mis_SJ2023103161_67_kebg AS
SELECT '67' as ind,COUNT(*) as val
  FROM adm_upss.AML_T07_CASE_APPLICATION_UH A
 WHERE SUBSTR(A.APP_DT,1,10) >= '2022-01-01'
   AND SUBSTR(A.APP_DT,1,10) <= '2022-12-31'
   AND A.APP_STATE_CD = '5'
   AND A.CAST_TYPE = '2'
   AND A.DT = '20231031'
   AND A.APP_ORG_ID IN (SELECT B.ORGANKEY
                          FROM adm_upss.adm_upss_aml_t07_report_organ_rel B
                         WHERE B.report_organkey = 'C1092933000014'
                           AND B.DT = '20231031')
                           ;
select * from zyj_mis_SJ2023103161_67_kebg;
--68 g.近一年内，可疑交易报告涉及客户数量，以及因上报可疑交易而对客户采取强化尽职调查、调整风险等级、采取管控措施、中止业务关系的客户数量（以上分别统计）
--1、2022年上报可疑案例的主客户数量
--1769
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_68_mcust1 PURGE;
CREATE TABLE zyj_mis_SJ2023103161_68_mcust1 AS
SELECT  DISTINCT A.PARTY_ID
FROM    adm_upss.AML_T07_CASE_APPLICATION_UH A
WHERE   SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'
AND     SUBSTR(A.APP_DT, 1, 10) <= '2022-12-31'
AND     A.APP_STATE_CD = '5'
AND     A.CAST_TYPE = '2'
AND     A.DT = '20231031'
AND     A.APP_ORG_ID IN (
                            SELECT  B.ORGANKEY
                            FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                            WHERE   B.report_organkey = 'C1092933000014'
                            AND     B.DT = '20231031'
                        );
select count(DISTINCT PARTY_ID) from zyj_mis_SJ2023103161_68_mcust1;
--
--2、被上报可疑案例后，风险等级是高风险、较高风险、被调低非柜限额、电子银行限额、暂停非柜面、账户只收不付、不收不付、销户的客户
--786
DROP TABLE IF EXISTS zyj_mis_SJ2023103161_68_mcust2 PURGE;
CREATE TABLE zyj_mis_SJ2023103161_68_mcust2 AS
SELECT  DISTINCT aaa.party_id
FROM    zyj_mis_SJ2023103161_68_mcust1 aaa
INNER JOIN    ZYJ_T37_PARTY_RESULT_2022 S
ON      aaa.PARTY_ID = S.PARTY_ID
INNER JOIN    adm_upss.aml_t47_agreement T
ON      S.PARTY_ID = T.customer_id
INNER JOIN    (
                  SELECT  CST_ACT_ID
                  FROM    edw.DWD_BUS_DEP_ACT_LMT_INF_DD --账户额度控制
                  WHERE   DT = '20221231'
                  AND     LMT_LVL = '30'
                  AND     ACT_THRS_TYP = '2'
                  AND     EVT_ID = 'DPDRAW'
                  AND     LMT_CMT NOT IN ( '预售资金监管' , '教培专户签约' , '联名账户' )
                  GROUP BY CST_ACT_ID
                  UNION
                  SELECT  C.CST_ACT_ID
                  FROM    edw.DWD_BUS_DEP_FRZ_MASF_DD A --存款账户冻结主档
                  LEFT JOIN    edw.DWD_BUS_DEP_FRZ_INF_DD B --存款账户冻结登记簿
                  ON      A.FRZ_ID = B.FRZ_ID
                  AND     B.DT = '20221231'
                  AND     b.FRZ_SRC_CD = '1'
                  LEFT JOIN    edw.DWD_BUS_DEP_ACT_CST_ACT_REL_DD C --客户账户存款账户关联信息
                  ON      A.LBL_ACT_ID = C.DEP_ACT_ID
                  AND     C.DT = '20221231'
                  WHERE   A.DT = '20221231'
                  AND     A.FRZ_SCP_CD = '2'
                  AND     A.NFRZ_IND = '0'
                  AND     A.LMT_TYP IN ( '1' , '2' ) --只收不付 不收不付
                  AND     B.FRZ_ID IS NULL
                  AND     C.CST_ACT_ID IS NOT NULL
              ) M
ON      T.acct_num = M.CST_ACT_ID
WHERE   ( ( S.fristappralevel IN ( '1004' , '1005' )
AND     substr(S.statistic_dt, 1, 10) >= '2022-01-01'
AND     substr(S.statistic_dt, 1, 10) <= '2022-12-31' )
    OR ( S.LEVELKEY IN ( '1004' , '1005' )
AND     substr(S.rcheck_dt, 1, 10) >= '2022-01-01'
AND     substr(S.rcheck_dt, 1, 10) <= '2022-12-31' ) )
AND     ORGANKEY IN (
                        SELECT  B.ORGANKEY
                        FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                        WHERE   B.report_organkey = 'C1092933000014'
                        AND     B.DT = '20231031'
                    );
SELECT  count(DISTINCT PARTY_ID)
FROM    zyj_mis_SJ2023103161_68_mcust2;
--69 i.近一年内司法机关新增冻扣客户（不含已有冻扣客户新增轮候冻扣）中，已在近年内（不超过5年）被提交可疑交易报告的客户数量与占比
--1、2022年度，被公安机关冻结、扣划（不含轮候冻结）的客户
--2、2022年度，被公安机关冻结、扣划（不含轮候冻结）的客户，且在2018-2022年被上报可疑案例的主客户
-- 10692
-- 413
select '691' as ind,count(DISTINCT t.cst_id) as val
FROM zyj_mis_SJ2023103161_57_froze t
union all
select '692' as ind
,COUNT(DISTINCT A.PARTY_ID)
FROM    adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN    (
                  SELECT  r . *
                  FROM    zyj_mis_SJ2023103161_57_froze r
                  WHERE   r.rn = 1
              ) s
ON      substr(a.PARTY_ID, 3) = s.cst_id
WHERE   SUBSTR(A.APP_DT, 1, 10) >= '2018-01-01'
AND     SUBSTR(A.APP_DT, 1, 10) <= '2022-12-31'
AND     A.APP_STATE_CD = '5'
AND     A.CAST_TYPE = '2'
AND     A.DT = '20231031'
AND     A.APP_ORG_ID IN (
                            SELECT  B.ORGANKEY
                            FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                            WHERE   B.report_organkey = 'C1092933000014'
                            AND     B.DT = '20231031'
                        );
--70 j.近一年内被提交可疑交易报告的客户中，已被司法机关查冻扣、人民银行反洗钱调查、涉诈通报客户数量与占比
--2022年上报可疑案例的主客户，且在上报前，已被司法查冻扣、预警人行黑名单的客户
--200
select '70' as ind
,COUNT(DISTINCT A.PARTY_ID)
FROM    adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN    (
                  SELECT  r . *
                  FROM    zyj_mis_SJ2023103161_57_froze r
                  WHERE   r.rn = 1
              ) s
ON      substr(a.PARTY_ID, 3) = s.cst_id
WHERE   SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'  --近1年
AND     SUBSTR(A.APP_DT, 1, 10) <= '2022-12-31'
AND     A.APP_STATE_CD = '5'
AND     A.CAST_TYPE = '2'
AND     A.DT = '20231031'
AND     REPLACE(substr(A.APP_DT, 1, 10), '-', '') > s.frz_bgn_dt --查扣时间小于预警时间
AND     A.APP_ORG_ID IN (
                            SELECT  B.ORGANKEY
                            FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                            WHERE   B.report_organkey = 'C1092933000014'
                            AND     B.DT = '20231031'
                        );
SELECT * FROM zyj_mis_SJ2023103161_57_froze;
--明细导出
select DISTINCT A.PARTY_ID
FROM    adm_upss.AML_T07_CASE_APPLICATION_UH A
INNER JOIN    (
                  SELECT  r . *
                  FROM    zyj_mis_SJ2023103161_57_froze r
                  WHERE   r.rn = 1
              ) s
ON      substr(a.PARTY_ID, 3) = s.cst_id
WHERE   SUBSTR(A.APP_DT, 1, 10) >= '2022-01-01'  --近1年
AND     SUBSTR(A.APP_DT, 1, 10) <= '2022-12-31'
AND     A.APP_STATE_CD = '5'
AND     A.CAST_TYPE = '2'
AND     A.DT = '20231031'
AND     REPLACE(substr(A.APP_DT, 1, 10), '-', '') > s.frz_bgn_dt --查扣时间小于预警时间
AND     A.APP_ORG_ID IN (
                            SELECT  B.ORGANKEY
                            FROM    adm_upss.adm_upss_aml_t07_report_organ_rel B
                            WHERE   B.report_organkey = 'C1092933000014'
                            AND     B.DT = '20231031'
                        );***SJ2023122501-台州分行个人账户明细.sql
--数据日期：20221001-20231101
--机构：台州分行、总行营业部
-- 客户账号 账户名称 开户机构 开户日期 销户日期 账户类型 客户号 账户状态 日均余额
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_01 AS
SElECT t1.dep_act_id,t1.cst_act_id,t1.act_nm
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,t1.opn_dt
    ,t1.act_dstr_act_dt   --销户日期
    ,t1.cst_id
    ,decode(t1.act_sts_cd,'A','正常','B','不动户','D','久悬户','E','封闭冻结','F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
    ,decode(t1.ACT_CTG_CD_2,'301','I类户','302','II类户','303','III类户','')    ACT_CTG
    ,t1.last_30_days_gl_bal_acml/30     lst_30_day_avg_bal --过去30天日均余额
    ,t1.last_90_days_gl_bal_acml/90     lst_90_day_avg_bal
    ,t1.last_180_days_gl_bal_acml/180   lst_180_day_avg_bal
    ,t1.last_270_days_gl_bal_acml/270   lst_270_day_avg_bal
    ,t1.last_360_days_gl_bal_acml/360   lst_360_day_avg_bal
FROM edw.dws_bus_dep_act_inf_dd             T1             -- 存款账户信息表
left join edw.dim_hr_org_mng_org_tree_dd    t4             --考核机构树 4481 org_id 唯一
on      t1.opn_org = t4.org_id
and     t4.dt = '20231101'
WHERE   T1.DT = '20231101'
AND     T1.STL_ACT_IND = '1'                    -- 结算账户
and     T1.ACT_STS_CD <>'C'                     -- 账户状态
-- AND     T1.CCY_CD = '156'   --只取人民币
-- AND     T1.BAL_GL_IND <> '0' --剔除虚户
-- AND     T1.CST_ID <> '2000394435'  --剔除验资户，该客户是验资户专户
AND   (T1.opn_org like  '3301%' or  T1.opn_org like  '9999%') --台州分行、总行营业部
and     T1.opn_dt>='20221001'
AND     T1.opn_dt<='20231101'
;
-- 年龄 户籍地址 居住地址
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_02 AS
SElECT cst_id,doc_nbr
    ,2023-cast(SUBSTR(doc_nbr,7,4) as int) age
    ,concat(substr(regexp_replace(reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(reg_adr,'\\s|,',''))-6,0)),'******')  reg_adr_pro
    ,concat(substr(regexp_replace(fml_adr,'\\s|,',''),1,greatest(length(regexp_replace(fml_adr,'\\s|,',''))-6,0)),'******')  fml_adr_pro
from edw.dws_cst_bas_inf_dd
where dt = '20231101'
;
--账户是否关闭非柜面 关闭非柜面原因
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_03 AS
SELECT  cst_act_id,lmt_cmt
    ,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
WHERE   DT = '20231101'
AND     ACT_THRS_TYP = '2'      --暂停非柜面
and     evt_id='DPDRAW'
;
-- 是否止付 止付原因
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_04 AS
SELECT  cst_act_id,frz_rsn
    ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
WHERE   DT = '20231101'
AND     FRZ_SRC_CD='2'  --止付
AND     NFRZ_IND = '0'
;
-- 客户交易
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_05 AS
SELECT  A.cst_act_id
    ,A.dep_act_id
    ,A.trx_dt
    ,A.trx_amt
    ,case when A.TRX_CHNL_CD='A01' then '柜面' else '' end trx_chnl
from  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI            A
INNER join lab_bigdata_dev.SJXQ_SJ2023122501_CST_01  T2
on a.cst_act_id=t2.cst_act_id
and a.dep_act_id=t2.dep_act_id
and a.trx_dt>=t2.opn_dt         --开户至今
WHERE A.dt<='20231101'
AND   A.crd_and_dbt_ind='D'     --汇出
;
-- 客户交易-非柜面
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_05_1 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_05_1 AS
SELECT  A.cst_act_id
    ,A.dep_act_id
    ,A.trx_dt
    ,A.trx_amt
from  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI            A
INNER join lab_bigdata_dev.SJXQ_SJ2023122501_CST_01  T2
on a.cst_act_id=t2.cst_act_id
and a.dep_act_id=t2.dep_act_id
and a.trx_dt>=t2.opn_dt         --开户至今
WHERE A.dt<='20231101'
AND   A.crd_and_dbt_ind='D'     --汇出
    ,'FD0011','FD0012','FD0013','FD0014','FD0015','FD0016','FD0017','FD0018','FD0019','LC0009','LN0002'
    ,'LN0003','LN0004','THKHK1','XE1207','XYKHK1','YL0035','TY0033')
and   A.smr_dscr NOT regexp '代发|代扣'
and   A.bal_fld_nm='DPLDGBAL'
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_06 AS
SElECT t1.cst_act_id,t1.max_per_trx_amt
    ,t2.max_per_trx_amt_gm
    ,t3.max_per_trx_amt_fgm
    ,t4.max_day_trx_amt_gm
    ,t5.max_day_trx_amt_fgm
from(
    SElECT cst_act_id,max(trx_amt) max_per_trx_amt
    from lab_bigdata_dev.SJXQ_SJ2023122501_CST_05
    group by cst_act_id
)t1 left join (
    SElECT cst_act_id,max(trx_amt) max_per_trx_amt_gm
    from lab_bigdata_dev.SJXQ_SJ2023122501_CST_05
    where trx_chnl='柜面'
    group by cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
left join (
    SElECT cst_act_id,max(trx_amt) max_per_trx_amt_fgm
    from lab_bigdata_dev.SJXQ_SJ2023122501_CST_05_1
    group by cst_act_id
)t3 on t1.cst_act_id=t3.cst_act_id
left join(
    SElECT cst_act_id,max(trx_amt) max_day_trx_amt_gm
    FROM(
        SElECT cst_act_id,trx_dt,sum(trx_amt) trx_amt
        from lab_bigdata_dev.SJXQ_SJ2023122501_CST_05
        where trx_chnl='柜面'
        group by cst_act_id,trx_dt
    )A GROUP by cst_act_id
)t4 on t1.cst_act_id=t4.cst_act_id
left join(
    SElECT cst_act_id,max(trx_amt) max_day_trx_amt_fgm
    FROM(
        SElECT cst_act_id,trx_dt,sum(trx_amt) trx_amt
        from lab_bigdata_dev.SJXQ_SJ2023122501_CST_05_1
        group by cst_act_id,trx_dt
    )A GROUP by cst_act_id
)t5 on t1.cst_act_id=t5.cst_act_id
;
-- 非柜额度
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_07 AS
select distinct cengcgjz cst_act_id
    ,danciedu
    ,leijiedu
from edw.core_kdpa_zheddy -- 负债账户额度定义表
where dt = '20231101'
and  zhxeleix='2'
and shijbhao='FGMXIANE' -- 非柜面限额
and edkzzhqi='1D' -- 日限额
;
--  开户日至20231101期间交易金额加总、开户日至20231101期间交易笔数加总
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_08 AS
select A.cst_act_id,a.dep_act_id
    ,SUM(B.trx_amt)     as   trx_amt_sum
    ,COUNT(1)           as   trx_numbers
from edw.DIM_BUS_DEP_ACT_INF_DD             A
INNER join edw.DWD_BUS_DEP_BAL_CHG_DTL_DI   B
ON   A.DEP_ACT_ID=B.DEP_ACT_ID
AND  A.CST_ACT_ID=B.CST_ACT_ID
AND  B.dt>= a.opn_dt
AND  B.dt<='20231101'
where  A.dt='20231101'
AND   (A.opn_org like  '3301%' or  A.opn_org like  '9999%') --台州分行、总行营业部
-- and    CONCAT(B.smr_dscr,B.cmt)  regexp  '工资'
GROUP BY  A.cst_act_id,a.dep_act_id
;
--账户常用转出渠道
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_09 AS
SElECT cst_act_id,dep_act_id,cd_val_dscr
    ,ROW_NUMBER() over(PARTITION by cst_act_id,dep_act_id order by trx_cnt desc) cnt_rn
    ,ROW_NUMBER() over(PARTITION by cst_act_id,dep_act_id order by trx_amt desc) amt_rn
from(
    SElECT t1.cst_act_id,t1.dep_act_id,t2.cd_val_dscr
        ,count(1) trx_cnt
        ,sum(t1.trx_amt) trx_amt
    from edw.DWD_BUS_DEP_BAL_CHG_DTL_DI     t1
    left join edw.dwd_code_library_dd       t2
    on t1.trx_chnl_cd=t2.cd_val
    and t2.dt='20231130'
    where t1.dt>='20221001' and t1.dt<='20231101'
    and t1.trx_dt>='20221001' and t1.trx_dt<='20231101'
    and t1.crd_and_dbt_ind = 'D'   --借贷标志|C1 D借
    GROUP by t1.cst_act_id,t1.dep_act_id,t2.cd_val_dscr
)a
;
--数据汇总
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2023122501_CST_10 AS
SElECT t1.cst_act_id			客户账号
    ,t1.act_nm                  账户名称
    ,t1.brc_org_nm              开户分行
    ,t1.sbr_org_nm              开户支行
    ,t1.tem_org_nm              开户团队
    ,t1.opn_dt                  开户日期
    ,t1.act_dstr_act_dt         销户日期
    ,t1.ACT_CTG                 账户类型
    ,t1.cst_id                  客户号
    ,t2.age                     年龄
    ,t2.reg_adr_pro             户籍地址
    ,t2.fml_adr_pro             家庭地址
    ,t1.act_sts                 账户状态
    ,case when t3.cst_act_id is not null then 1 else 0 end  账户是否关闭非柜面
    ,t3.lmt_cmt                 关闭非柜面原因
    ,case when t4.cst_act_id is not null then 1 else 0 end  是否止付
    ,t4.frz_rsn                 止付原因
    ,case when t12.certid is not null then 1 else 0 end     是否查冻
    ,t6.max_per_trx_amt			开户至今单笔汇出最大金额
    ,t6.max_per_trx_amt_gm      开户至今单笔汇出最大金额_柜面
    ,t6.max_per_trx_amt_fgm     开户至今单笔汇出最大金额_非柜面
    ,t6.max_day_trx_amt_gm      开户至今单日汇出最大金额累计_柜面
    ,t6.max_day_trx_amt_fgm     开户至今单日汇出最大金额累计_非柜面
    ,t7.danciedu                单笔非柜额度
    ,t7.leijiedu                累计非柜额度
    ,case when t1.opn_mons<=1 then t8.trx_numbers else round(t8.trx_numbers/t1.opn_mons,0) end 月均交易笔数
    ,case when t1.opn_mons<=1 then t8.trx_amt_sum else round(t8.trx_amt_sum/t1.opn_mons,0) end 月均交易金额
    ,t1.lst_30_day_avg_bal 		过去30天日均余额
    ,t1.lst_90_day_avg_bal      过去90天日均余额
    ,t1.lst_180_day_avg_bal     过去180天日均余额
    ,t1.lst_270_day_avg_bal     过去270天日均余额
    ,t1.lst_360_day_avg_bal     过去360天日均余额
    ,t9.cd_val_dscr             账户常用转出渠道
    ,t9_1.cd_val_dscr           账户转出金额最多渠道
    ,case when t10.act_id is not null then 1 else 0 end     开通电子银行及第三方支付情况
    ,case when t11.cst_id is not null then 1 else 0 end     工资户标识
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_01        t1
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_02   t2 on t1.cst_id=t2.cst_id
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_03   t3 on t1.cst_act_id=t3.cst_act_id and t3.rn=1
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_04   t4 on t1.cst_act_id=t4.cst_act_id and t4.rn=1
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_06   t6 on t1.cst_act_id=t6.cst_act_id
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_07   t7 on t1.cst_act_id=t7.CST_ACT_ID
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_08   t8
on t1.cst_act_id=t8.cst_act_id and t1.dep_act_id=t8.dep_act_id
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_09   t9
on t1.cst_act_id=t9.cst_act_id and t1.dep_act_id=t9.dep_act_id and t9.cnt_rn=1
left join lab_bigdata_dev.SJXQ_SJ2023122501_CST_09   t9_1
on t1.cst_act_id=t9_1.cst_act_id and t1.dep_act_id=t9_1.dep_act_id and t9_1.amt_rn=1
left join (
    select distinct act_id
    from edw.dwd_bus_chnl_epc_pay_agr_inf_dd    --开通电子银行及第三方支付情况
    WHERE dt = '20231101'
)t10 on t1.cst_act_id=t10.act_id
left join (
    SElECT distinct kehuhaoo  as  cst_id        --工资户标识
    from edw.core_kcpb_zhbzxx
    where dt = '20231101'
)t11 on t1.cst_id=t11.cst_id
left join(
    Select distinct certid
    from app_rpt.INTER_ENQUIRY_REG              --是否查冻
    where dt<='20231224'
)t12 on t2.doc_nbr=t12.certid
;
/*
SElECT '1' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_01
union all
SElECT '2' seq,count(1) cnt,count(DISTINCT cst_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_02
union all
SElECT '3' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_03
union all
SElECT '4' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_04
union all
SElECT '5' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_05
union all
SElECT '6' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_06
union all
SElECT '7' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_07
union all
SElECT '8' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_08
union all
SElECT '9' seq,count(1) cnt,count(DISTINCT cst_act_id) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_09
union all
SElECT '10' seq,count(1) cnt,count(DISTINCT 客户账号) custs
from lab_bigdata_dev.SJXQ_SJ2023122501_CST_10
;
1	121120	121120
2	15649128	15649128
3	3915334	3647947
4	2603850	2573444
5	7339635	85951
6	85951	85951
7	3445709	3445707
8	2310553	2310553
9	9935877	4472125
10	121120	121120
*/***SJ2023122511-邹干清-015591.sql
-- 中国人民银行宁波市分行关于年度现金分析报告要求，
-- 需要取现和存现金额各前5名的小微制造业企业用现情况，
-- 取现和存现金额各前5名的制造业企业用现情况，企业名称、金额（2023年）、同比变化（金额）数据期间为2022年和2023年数据，
-- 数据截止日期2023年12月22日
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_001 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_001 AS
SELECT  T1.cst_id  as 客户号
       ,T2.cst_nm  as 客户名称
       ,sum(case when substr(T3.trx_dt,1,4)='2022' and T3.crd_and_dbt_ind='D' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2022年支取金额
       ,sum(case when substr(T3.trx_dt,1,4)='2023' and T3.crd_and_dbt_ind='D' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2023年支取金额
       ,sum(case when substr(T3.trx_dt,1,4)='2022' and T3.crd_and_dbt_ind='C' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2022年存入金额
       ,sum(case when substr(T3.trx_dt,1,4)='2023' and T3.crd_and_dbt_ind='C' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2023年存入金额
       ,'1'  as flag
from   edw.dws_bus_dep_act_inf_dd   T1
LEFT JOIN  edw.dim_cst_entp_bas_inf_dd T2 ON  T1.cst_id=T2.cst_id and  T2.dt='@@{yyyyMMdd}'
left join  edw.dwd_bus_dep_bal_chg_dtl_di  T3
    ON   T1.dep_act_id=T3.dep_act_id
    AND  T1.cst_act_id=T3.cst_act_id
    AND  T3.csh_ind = '0' -- 现金
    AND  T3.dt >='20220101'
    AND  T3.dt <='20231222'
LEFT JOIN    edw.dwd_bus_chnl_cnt_alc_mny_trx_dtl_di T7 --配钞交易明细
ON      T3.tlr_srl_nbr = T7.srl_nbr
AND     T3.trx_dt =  T7.trx_dt
AND     T3.trx_amt = T7.unt_amt
AND     T7.dt >= '20220101'
AND     T7.dt <= '20231222'
AND     T7.par_typ = '抵现'
WHERE   T1.dt='@@{yyyyMMdd}'
AND     T7.srl_nbr  is null
AND     T1.opn_org like '3303%'
AND     substr(T2.idt_ctg_cd,1,1)='C'
GROUP BY  T1.cst_id,T2.cst_nm
;
-- 2023制造业支取前5
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001z purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001z AS
SELECT T1.*
FROM (
    SELECT  A.*
           ,ROW_NUMBER() over(partition by A.flag order by A.2023年支取金额 desc) as rn
    FROM   lab_bigdata_dev.tmp_yxw_zgq_20231226_001  A
    WHERE  A.客户号 in (
        SELECT distinct T1.cst_id
        FROM   edw.dim_bus_dep_cst_act_inf_dd T1
        where  T1.dt='@@{yyyyMMdd}'
        AND    T1.act_sts_cd='A'
    )
)   T1
where T1.rn<=5;
SELECT *
from  lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001z
-- 2023制造业存入前5
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001c purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001c AS
SELECT T1.*
FROM (
    SELECT  A.*
           ,ROW_NUMBER() over(partition by A.flag order by A.2023年存入金额 desc) as rn
    FROM  lab_bigdata_dev.tmp_yxw_zgq_20231226_001  A
    WHERE  A.客户号 in (
        SELECT distinct T1.cst_id
        FROM   edw.dim_bus_dep_cst_act_inf_dd T1
        where  T1.dt='@@{yyyyMMdd}'
        AND    T1.act_sts_cd='A'
    )
)   T1
where T1.rn<=5;
SELECT *
from  lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001c
select T1.*
from   edw.dim_bus_dep_cst_act_inf_dd T1
where  T1.dt='@@{yyyyMMdd}'
AND    T1.cst_id in (
    SELECT 客户号
    FROM  lab_bigdata_dev.tmp_yxw_zgq_20231226_001_zz001c
)
SELECT T3.*
from   edw.dws_bus_dep_act_inf_dd   T1
LEFT JOIN  edw.dim_cst_entp_bas_inf_dd T2 ON  T1.cst_id=T2.cst_id and  T2.dt='@@{yyyyMMdd}'
left join  edw.dwd_bus_dep_bal_chg_dtl_di  T3
    ON   T1.dep_act_id=T3.dep_act_id
    AND  T1.cst_act_id=T3.cst_act_id
    AND  T3.csh_ind = '0' -- 现金
    AND  T3.dt >='20220101'
    AND  T3.dt <='20231222'
LEFT JOIN    edw.dwd_bus_chnl_cnt_alc_mny_trx_dtl_di T7 --配钞交易明细
ON      T3.tlr_srl_nbr = T7.srl_nbr
AND     T3.trx_dt =  T7.trx_dt
AND     T3.trx_amt = T7.unt_amt
AND     T7.dt >= '20220101'
AND     T7.dt <= '20231222'
AND     T7.par_typ = '抵现'
WHERE   T1.dt='@@{yyyyMMdd}'
AND     T7.srl_nbr  is null
AND     T1.opn_org like '3303%'
AND     substr(T2.idt_ctg_cd,1,1)='C'
AND     T1.cst_id='2609653953';
-----------------------------------------------------------------------------------------------------------
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei AS
SELECT  T1.cst_id  as 客户号
       ,T2.cst_nm  as 客户名称
       ,sum(case when substr(T3.trx_dt,1,4)='2022' and T3.crd_and_dbt_ind='D' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2022年支取金额
       ,sum(case when substr(T3.trx_dt,1,4)='2023' and T3.crd_and_dbt_ind='D' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2023年支取金额
       ,sum(case when substr(T3.trx_dt,1,4)='2022' and T3.crd_and_dbt_ind='C' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2022年存入金额
       ,sum(case when substr(T3.trx_dt,1,4)='2023' and T3.crd_and_dbt_ind='C' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2023年存入金额
       ,'1'  as flag
from   edw.dws_bus_dep_act_inf_dd   T1
LEFT JOIN  edw.dim_cst_entp_bas_inf_dd T2 ON  T1.cst_id=T2.cst_id and  T2.dt='@@{yyyyMMdd}'
left join  edw.dwd_bus_dep_bal_chg_dtl_di  T3
    ON   T1.dep_act_id=T3.dep_act_id
    AND  T1.cst_act_id=T3.cst_act_id
    AND  T3.csh_ind = '0' -- 现金
    AND  T3.dt >='20220101'
    AND  T3.dt <='20231222'
LEFT JOIN    edw.dwd_bus_chnl_cnt_alc_mny_trx_dtl_di T7 --配钞交易明细
ON      T3.tlr_srl_nbr = T7.srl_nbr
AND     T3.trx_dt =  T7.trx_dt
AND     T3.trx_amt = T7.unt_amt
AND     T7.dt >= '20220101'
AND     T7.dt <= '20231222'
AND     T7.par_typ = '抵现'
WHERE   T1.dt='@@{yyyyMMdd}'
AND     T7.srl_nbr  is null
AND     T1.opn_org like '3303%'
AND     substr(T2.idt_ctg_cd,1,1)='C'
GROUP BY  T1.cst_id,T2.cst_nm
;
-- 2023小微制造业支取前5
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei_zz001z purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei_zz001z AS
SELECT T1.*
FROM (
    SELECT  A.*
           ,ROW_NUMBER() over(partition by A.flag order by A.2023年支取金额 desc) as rn
    FROM   lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei  A
    WHERE  A.客户号 in (
        SELECT distinct T1.cst_id
        FROM   edw.dim_bus_dep_cst_act_inf_dd T1
        where  T1.dt='@@{yyyyMMdd}'
        AND    T1.act_sts_cd='A'
    )
)   T1
where T1.rn<=5
SELECT *
from  lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei_zz001z
-- 2023小微制造业存入前5
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei_zz001c purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei_zz001c AS
SELECT T1.*
FROM (
    SELECT  A.*
           ,ROW_NUMBER() over(partition by A.flag order by A.2023年存入金额 desc) as rn
    FROM  lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei  A
    WHERE  A.客户号 in (
        SELECT distinct T1.cst_id
        FROM   edw.dim_bus_dep_cst_act_inf_dd T1
        where  T1.dt='@@{yyyyMMdd}'
        AND    T1.act_sts_cd='A'
    )
)   T1
where T1.rn<=5
;
SELECT *
from  lab_bigdata_dev.tmp_yxw_zgq_20231226_002_xiaowei_zz001c;
-- select *
-- from  edw.dwd_code_library_dd
-- where dt='@@{yyyyMMdd}'
-- and   LENGTH(cd_val)=1***SJ2023122656-财富销售适当性回访.sql
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,SUBSTR(T1.DOC_NBR,7,8) BIRTH_DT
    ,T1.AGE
    ,T1.M_TEL_NO
    ,DECODE(T1.GDR_CD,'1','男','2','女','未知') GENDER
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T3.AUM_BAL
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
    ,t5.NCR_FND_BAL
    ,CASE WHEN T3.AUM_BAL>0 THEN T5.NCR_FND_BAL/T3.AUM_BAL ELSE 0 END NCR_FND_BAL_RATE
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20231130'
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T3 --客户金融资产信息表
ON  T1.CST_ID = T3.CST_ID
AND T3.DT='20231130'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231130'
LEFT JOIN(
    SELECT A.CST_ID, SUM(A.TOT_AMT) NCR_FND_BAL     --非货基金保有量
    FROM EDW.DIM_BUS_CHM_FND_ACT_LOT_DTL_INF_DD A   --基金账户份额信息
    INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD    C
    ON A.PROD_CD = C.PD_CD
    AND C.DT = '20231130'
    WHERE A.DT = '20231130'
    AND C.FND_TYP_CD<>'04'
    AND A.TOT_AMT>0
    GROUP BY A.CST_ID
)T5 ON T1.CST_ID=T5.CST_ID
WHERE T1.DT='20231130'
;
--保险 20221201-20221231
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_02 AS
SELECT T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,T1.CST_ID
    ,substr(t1.SYS_SRL_NBR,1,8) bd_jf_dt
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP
    ,T2.CMP_CD
    ,T3.CMP_NM
    ,T1.TRX_DT
    ,T1.TRX_AMT
    ,T4.EFE_LOAN_CST_IND                                    EFE_LOAN_CST_IND_TRX
    ,CASE WHEN NVL(T5.OWN_EMP_ID,'')<>'' THEN 1 ELSE 0 END  OWN_EMP_ID_TRX
    ,T1.TRX_ZID     --交易帐号|C32
    ,T1.CHNL_TYP    --渠道类型|C10
    ,t6.insu_fee    --保险费用
    ,T6.PAY_YEAR_PRD_TYP --缴费年期类型|C2 1趸缴 2年缴
    ,T6.PAY_YEAR    --缴费年限|C10
    ,t6.acc_dt	    --受理日期|C16
    ,T6.EFT_DT      --生效日期
    ,T7.MNG_ID      RCM_PSN_ID
    ,T7.MNG_ORG_ID  RCM_ORG_ID
    -- ,T8.MNG_ID      PRM_MGR_ID
    -- ,T8.MNG_ORG_ID  PRM_ORG_ID
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20231130'
LEFT JOIN EDW.DIM_BUS_INSU_CMP_INF_DD           T3 --保险公司信息
ON  T2.CMP_CD=T3.CMP_CD
AND T3.DT='20231130'
LEFT JOIN ADM_PUB.ADM_CSM_CBAS_IND_INF_DD       T4
ON  T1.CST_ID=T4.CST_ID AND T1.TRX_DT=T4.DT
AND T4.DT BETWEEN '20221201' AND '20221231'
LEFT JOIN EDW.DWS_CST_IDV_BAS_INF_DD            T5
ON T1.CST_ID=T5.CST_ID AND T1.TRX_DT=T5.DT
AND T5.DT BETWEEN '20221201' AND '20221231'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
AND     T6.DT = '20231130'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT = '20231130'
-- LEFT JOIN    ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG T8 --保险代销客户产品清单-全量
-- ON      T1.SYS_SRL_NBR = T8.TRX_SEQ --交易流水号
-- AND     T8.MNG_TYP = '1'            --取管户信息
-- AND     T8.DT = '20221231'
WHERE T1.DT = '20231130'
AND     T1.TRX_DT BETWEEN '20221201' AND '20221231'
AND     T1.TRX_NM NOT LIKE '%非实时投保申请%'        --交易名称 --20230525 LJH 周丽月业务老师要求 '不包括:非实时投保申请'
;
-- 基金 20231101-20231130
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_03 AS
SELECT T1.CST_ID
    -- ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.TA_CFM_SRL_NBR TRX_SRL_NBR
    -- ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,T1.BUS_DT          TRX_DT
    ,T1.CFM_DT
    ,C1.CD_VAL_DSCR     TRX_CHNL
    ,T1.APL_AMT         TRX_AMT
    ,T1.CFM_AMT                     --确认金额
    ,T1.RCM_PSN_ID      RCM_PSN_ID  --推荐人员工号
    ,T1.TRX_ACT_ID                  --银行账号
    ,t1.TACD
    ,T1.TA_NM                       --基金公司
    ,T1.PD_CD                       --产品代码
    ,T2.PD_NM                       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS                --业绩比较基准
    ,T2.FOUND_DT                    --产品成立日期
    ,''                             --产品起息日期
    ,T2.MTU_DT                      --产品结束日期
    ,T3.CST_RSK_GRD_CD  TRX_FND_RSK_LVL     --客户交易日风险等级
    ,T3.ASES_DT         TRX_FND_RSK_ASES_DT --客户交易日风险测评时间
    ,T4.EFE_LOAN_CST_IND                                    EFE_LOAN_CST_IND_TRX
    ,CASE WHEN NVL(T5.OWN_EMP_ID,'')<>'' THEN 1 ELSE 0 END  OWN_EMP_ID_TRX
FROM (
    SELECT CST_ID,TA_CFM_SRL_NBR,ORIG_APL_SRL_NBR
        ,BUS_DT,CFM_DT,TRX_CHNL_CD
        ,APL_AMT,APL_TM,CFM_AMT
        ,TRX_ACT_ID,PD_CD
        ,COALESCE(T.WLTH_ADVSR_ID,T.WLTH_MNG_MNL_ID) RCM_PSN_ID
        ,t.TACD,C1.TA_NM
    FROM    EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI  T --基金交易确认流水明细
    LEFT JOIN edw.dim_bus_chm_fnd_ta_inf_dd     C1
    ON T.TACD=C1.TA_CD AND C1.DT='20231130'
    WHERE   T.DT >= '20231101'
    AND     T.DT <= '20231130'
    AND     T.BUS_DT >='20231001'   -- 10-11月期间购买
    AND T.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
    AND T.BUS_CD IN ( '120' , '122' , '136' , '139' , '138' ) --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
    AND T.CFM_AMT > 0
) T1 INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD       T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231130'
AND T2.FND_TYP_CD<>'04' -- 非货基金
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD                   C1
ON T1.TRX_CHNL_CD=C1.CD_VAL
AND C1.DT='20231130'
AND C1.TBL_NM='DIM_BUS_CHM_FND_AIP_AGR_INF_DD'
AND C1.FLD_NM='CHNL_CD'
LEFT JOIN EDW.DIM_BUS_CHM_FND_CST_RSK_GRD_INF_DD    T3      --基金风评表
ON T1.CST_ID=T3.CST_ID AND T1.BUS_DT = T3.DT   --交易时
AND T3.DT BETWEEN '20231101' AND '20231130'
LEFT JOIN ADM_PUB.ADM_CSM_CBAS_IND_INF_DD           T4
ON  T1.CST_ID=T4.CST_ID AND T1.BUS_DT=T4.DT
AND T4.DT BETWEEN '20231101' AND '20231130'
LEFT JOIN EDW.DWS_CST_IDV_BAS_INF_DD                T5
ON T1.CST_ID=T5.CST_ID AND T1.BUS_DT=T5.DT
AND T5.DT BETWEEN '20231101' AND '20231130'
;
-- 贵金属
--2023年 贵金属购买信息汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_04 AS
SELECT ORD_ID               --订单号
    ,ORD_TM TRX_DT          --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE DT >= '20231101' and dt <= '20231130'
AND ORD_TM >= '2023-01-01'
UNION ALL
SELECT ORD_ID               --订单号
    ,ORD_TM                 --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE DT >= '20231101' and dt <= '20231130'
AND ORD_TM >= '2023-11-01'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_05 AS
SELECT T1.*
    ,T4.EFE_LOAN_CST_IND                                    EFE_LOAN_CST_IND_TRX
    ,CASE WHEN NVL(T5.OWN_EMP_ID,'')<>'' THEN 1 ELSE 0 END  OWN_EMP_ID_TRX
FROM SJXQ_SJ2023122656_CST_04               T1
INNER JOIN ADM_PUB.ADM_CSM_CBAS_IND_INF_DD   T4
ON  T1.CST_ID=T4.CST_ID AND T1.TRX_DT=T4.DT
AND T4.DT BETWEEN '20231101' AND '20231130'
INNER JOIN EDW.DWS_CST_IDV_BAS_INF_DD        T5
ON T1.CST_ID=T5.CST_ID AND T1.TRX_DT=T5.DT
AND T5.DT BETWEEN '20231101' AND '20231130'
;
-- 自营/代销 理财
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_06 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.CFM_DT --确认日期
    ,C1.CD_VAL_DSCR  TRX_CHNL --交易渠道
    ,T1.TRX_AMT --交易金额
    ,T1.CFM_AMT --确认金额
    ,T1.TRX_LOT --交易份额
    ,T1.CFM_LOT --确认份额
    ,T1.MGR_ID      SALE_EMPE_ID --推荐人员工号
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.BNK_ACT_ID --银行账号
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.PD_FOUND_DT     --产品成立日期
    ,T2.PD_VAL_DT       --产品起息日期
    ,T2.PD_END_DT       --产品结束日期
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
    ,T3.RSK_LVL_CD         TRX_FIN_RSK_LVL      --客户交易日风险等级
    ,T3.LATE_ASES_DT       TRX_FIN_RSK_ASES_DT  --客户交易日风险测评时间
    ,T4.EFE_LOAN_CST_IND                                    EFE_LOAN_CST_IND_TRX
    ,CASE WHEN NVL(T5.OWN_EMP_ID,'')<>'' THEN 1 ELSE 0 END  OWN_EMP_ID_TRX
    ,T1.TACD,C2.TA_NAME
    -- ,T6.MGR_ID
    -- ,T6.ACS_ORG_ID
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231130'
LEFT JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD   T3 --风评
ON T1.CST_ID=T3.CST_ID AND T1.TRX_DT=T3.DT
LEFT JOIN ADM_PUB.ADM_CSM_CBAS_IND_INF_DD   T4
ON  T1.CST_ID=T4.CST_ID AND T1.TRX_DT=T4.DT
AND T4.DT BETWEEN '20231101' AND '20231130'
LEFT JOIN EDW.DWS_CST_IDV_BAS_INF_DD        T5
ON T1.CST_ID=T5.CST_ID AND T1.TRX_DT=T5.DT
AND T5.DT BETWEEN '20231101' AND '20231130'
-- LEFT JOIN EDW.DWS_BUS_CHM_ACT_MGR_INF_DD    T6 --理财考核汇总信息
-- ON T1.CST_ID=T6.CST_ID AND T1.PD_CD=T6.PD_CD AND T1.BNK_ACT_ID=T6.BNK_ACT_ID
-- AND T6.MNG_TYP_CD = '1'  --`管户`类型 1考核 2销售
-- AND T6.DT='20231130'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON T1.TRX_CHNL_CD = C1.CD_VAL
AND C1.DT = '20231130'
LEFT JOIN edw.finc_tbtainfo                 C2
ON T1.TACD = C2.TA_CODE
AND C2.DT = '20231130'
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.TRX_DT BETWEEN '20231101' AND '20231130'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND T1.TRX_CD IN ( '100200' , '100201' )
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_07 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,'保险' PROD_CLASS
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM,T1.CMP_CD,T1.CMP_NM
    ,NULL PD_RSK_GRD,NULL PFM_COMP_BAS,NULL FOUND_DT,NULL PD_VAL_DT
    ,NULL MTU_DT,NULL TRX_RSK_LVL
    ,T1.EFE_LOAN_CST_IND_TRX,T1.OWN_EMP_ID_TRX
    ,C1.PROMPT CHNL_TYP
    ,T1.TRX_DT,T1.TRX_AMT,T1.TRX_ZID
    ,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR,T1.insu_fee
    ,T1.bd_jf_dt,T1.EFT_DT
    ,T1.RCM_PSN_ID,T3.EMPE_NM RCM_PSN_NM
    ,T1.RCM_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ2023122656_CST_02               T1  --保险
LEFT JOIN edw.finc_tbdict                   C1
ON T1.CHNL_TYP = C1.VAL
AND C1.DT='20231130'
AND C1.HS_KEY='K_JYQD'  --交易渠道
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231130'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.RCM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231130'
UNION all
SELECT T1.CST_ID,T1.TRX_SRL_NBR,NULL,'基金'
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM,T1.TACD,T1.TA_NM
    ,T1.PD_RSK_GRD,T1.PFM_COMP_BAS,T1.FOUND_DT,NULL,T1.MTU_DT
    ,T1.TRX_FND_RSK_LVL ,T1.EFE_LOAN_CST_IND_TRX ,T1.OWN_EMP_ID_TRX
    ,T1.TRX_CHNL,T1.TRX_DT,T1.TRX_AMT,T1.TRX_ACT_ID
    ,NULL,NULL,NULL,NULL,NULL
    ,T1.RCM_PSN_ID,T3.EMPE_NM
    ,T4.ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ2023122656_CST_03               T1  --基金
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231130'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T3.ORG_ID = T4.ORG_ID
AND     T4.DT = '20231130'
UNION all
SELECT CST_ID,ORD_ID,NULL,'贵金属'
    ,GOODS_TYP,NULL,CMDT_NM,NULL,PVD_NM,NULL,NULL,NULL,NULL,NULL,NULL
    ,T1.EFE_LOAN_CST_IND_TRX ,T1.OWN_EMP_ID_TRX
    ,CHNL_NM,TRX_DT,TRX_AMT,ACCT_ID,NULL,NULL,NULL,NULL,NULL
    ,RCM_PSN_ID,RCM_PSN_NM
    ,RCM_PSN_AFL_DEPT_ID
    ,RCM_PSN_AFL_SUB_BRN
    ,RCM_PSN_AFL_BRN
FROM SJXQ_SJ2023122656_CST_05   T1  --贵金属
UNION all
SELECT T1.CST_ID,T1.SRL_NBR,NULL,CONCAT(T1.AGN_IND,'理财')
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,T1.TACD,T1.TA_NAME
    ,T1.PD_RSK_GRD,T1.PFM_COMP_BAS,T1.PD_FOUND_DT,T1.PD_VAL_DT,T1.PD_END_DT
    ,T1.TRX_FIN_RSK_LVL,T1.EFE_LOAN_CST_IND_TRX,T1.OWN_EMP_ID_TRX
    ,T1.TRX_CHNL,T1.TRX_DT,T1.TRX_AMT,T1.BNK_ACT_ID,NULL,NULL,NULL,NULL,NULL
    ,T1.SALE_EMPE_ID,t3.EMPE_NM
    ,T1.SALE_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ2023122656_CST_06   T1  --理财
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.SALE_EMPE_ID = T3.empe_id
AND T3.DT = '20231130'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.SALE_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231130'
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2023122656_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122656_CST_08 AS
SElECT T1.CST_ID						客户号
    ,t2.CST_CHN_NM                      客户名称
    ,T1.SYS_SRL_NBR                     交易流水号
    ,T1.INSU_PLCY_ID                    保单号_保险
    ,T1.PROD_CLASS                      财富产品分类名称_大类
    ,T1.PROD_TYPE                       产品类型
    ,T1.PD_CD                           产品代码
    ,T1.PD_NM                           产品名称
    ,T1.CMP_CD                          发行机构
    ,T1.CMP_NM                          发行机构名称
    ,T1.PD_RSK_GRD                      产品风险等级
    ,T1.PFM_COMP_BAS                    业绩比较基准_理财
    ,T1.FOUND_DT                        产品成立日_自营理财_钱潮
    ,T1.PD_VAL_DT                       产品起息日_自营理财_钱潮
    ,T1.MTU_DT                          产品结束日_自营理财_钱潮
    ,T2.BIRTH_DT                        出生年月日
    ,T2.AGE                             年龄
    ,T1.TRX_RSK_LVL                     客户风险测评结果_交易日
    ,T2.NCR_FND_BAL                     客户非货基金保有量_20231130时点值
    ,T2.AUM_BAL                         AUM_20231130时点值
    ,T2.NCR_FND_BAL_RATE                非货基金保有量与AUM比值
    ,T1.EFE_LOAN_CST_IND_TRX            是否信贷有效户_交易日
    ,T1.OWN_EMP_ID_TRX                  是否行内员工_交易日
    ,T2.GENDER                          性别
    ,T2.M_TEL_NO                        手机号
    ,T1.CHNL_TYP                        购买渠道
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_AMT                         交易金额
    ,T1.TRX_ZID                         交易账号
    ,T1.PAY_YEAR_PRD_TYP                缴费年期类型_保险
    ,T1.PAY_YEAR                        缴费年限_保险
    ,T1.insu_fee                        保险费用_保险
    ,T1.bd_jf_dt                        保单首次缴费日_保险
    ,T1.EFT_DT                          生效日期_保险
    ,T1.RCM_PSN_ID                      推荐人工号
    ,T1.RCM_PSN_NM                      推荐人姓名
    ,T1.RCM_ORG_ID                      推荐人所在机构
    ,T1.SBR_ORG_NM                      推荐人所在支行名称
    ,T1.BRC_ORG_NM                      推荐人所在分行名称
    ,T2.PRM_MGR_ID                      管户人工号
    ,T2.PRM_MGR_NM                      管户人姓名
    ,T2.PRM_ORG_ID                      管户人所在机构
    ,T2.SBR_ORG_NM                      管户人支行名称
    ,T2.BRC_ORG_NM                      管户人分行名称
    ,'20231130'                         数据日期_8位
from SJXQ_SJ2023122656_CST_07       t1
left join SJXQ_SJ2023122656_CST_01  t2
on t1.cst_id = t2.cst_id
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122656_CST_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2023122656_CST_08
;
01	14224876	14224876
02	377	368
03	24268	8202
04	1436	1183
05	2589	1834
06	139897	38107
07	167131	46489
08	167131	46489
*/
***SJ20231227101-曾卓慧-017367.sql
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zzh_20231228_001 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zzh_20231228_001 AS
SELECT  T1.cst_id  as 客户号
       ,T2.cst_nm  as 客户名称
       ,substr(T2.idt_ctg_cd,1,1)  as 行业首字母C制造业F批发和零售业G交通运输业
       ,sum(case when substr(T3.trx_dt,1,4)='2022' and T3.crd_and_dbt_ind='D' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2022年支取金额
       ,sum(case when substr(T3.trx_dt,1,4)='2023' and T3.crd_and_dbt_ind='D' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2023年支取金额
       ,sum(case when substr(T3.trx_dt,1,4)='2022' and T3.crd_and_dbt_ind='C' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2022年存入金额
       ,sum(case when substr(T3.trx_dt,1,4)='2023' and T3.crd_and_dbt_ind='C' THEN  T3.trx_amt ELSE  0 end )/10000  AS  2023年存入金额
       ,'1'  as flag
from   edw.dws_bus_dep_act_inf_dd   T1
LEFT JOIN  edw.dim_cst_entp_bas_inf_dd T2 ON  T1.cst_id=T2.cst_id and  T2.dt='@@{yyyyMMdd}'
left join  edw.dwd_bus_dep_bal_chg_dtl_di  T3
    ON   T1.dep_act_id=T3.dep_act_id
    AND  T1.cst_act_id=T3.cst_act_id
    AND  T3.csh_ind = '0' -- 现金
    AND  T3.dt >='20220101'
    AND  T3.dt <='20231222'
LEFT JOIN    edw.dwd_bus_chnl_cnt_alc_mny_trx_dtl_di T7 --配钞交易明细
ON      T3.tlr_srl_nbr = T7.srl_nbr
AND     T3.trx_dt =  T7.trx_dt
AND     T3.trx_amt = T7.unt_amt
AND     T7.dt >= '20220101'
AND     T7.dt <= '20231222'
AND     T7.par_typ = '抵现'
WHERE   T1.dt='@@{yyyyMMdd}'
AND     T7.srl_nbr  is null
AND     T1.opn_org like '4461%'
GROUP BY  T1.cst_id,T2.cst_nm,substr(T2.idt_ctg_cd,1,1)
;
SELECT *
FROM  lab_bigdata_dev.tmp_yxw_zzh_20231228_001
-- select cd_val,cd_val_dscr
-- from  edw.dwd_code_library_dd
-- where dt='@@{yyyyMMdd}'
-- and   cd_val_dscr  REGEXP '交通'
-- 2023制造业支取前5
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zzh_20231228_001_zz001z purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zzh_20231228_001_zz001z AS
SELECT  T1.*
       ,decode(T1.行业首字母C制造业F批发和零售业G交通运输业,'C','制造业','F','批发和零售业','G','交通运输业','')    行业类别
FROM (
    SELECT  A.*
           ,ROW_NUMBER() over(partition by A.flag,A.行业首字母C制造业F批发和零售业G交通运输业 order by A.2023年支取金额 desc) as rn
    FROM   lab_bigdata_dev.tmp_yxw_zzh_20231228_001  A
    WHERE  A.客户号 in (
        SELECT distinct T1.cst_id
        FROM   edw.dim_bus_dep_cst_act_inf_dd T1
        where  T1.dt='@@{yyyyMMdd}'
        AND    T1.act_sts_cd='A'
    )
)   T1
where T1.rn<=5;
SELECT *
FROM  lab_bigdata_dev.tmp_yxw_zzh_20231228_001_zz001z
-- 2023制造业存入前5
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_zzh_20231228_001_zz001c purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_zzh_20231228_001_zz001c AS
SELECT T1.*
       ,decode(T1.行业首字母C制造业F批发和零售业G交通运输业,'C','制造业','F','批发和零售业','G','交通运输业','')    行业类别
FROM (
    SELECT  A.*
           ,ROW_NUMBER() over(partition by A.flag,A.行业首字母C制造业F批发和零售业G交通运输业 order by A.2023年存入金额 desc) as rn
    FROM  lab_bigdata_dev.tmp_yxw_zzh_20231228_001  A
    WHERE  A.客户号 in (
        SELECT distinct T1.cst_id
        FROM   edw.dim_bus_dep_cst_act_inf_dd T1
        where  T1.dt='@@{yyyyMMdd}'
        AND    T1.act_sts_cd='A'
    )
)   T1
where T1.rn<=5;
***SJ20231227106_财富销售适当性预警业务数据.sql
/*
2023年12月17日至2023年12月24日期间每日按客户维度取数。
客户确定方式：当日本人名下持有以下任一产品：
1、定期自营理财或代销理财
【定期自营理财判断方式：产品模板为封闭1303、定开1309的产品；
定期代销理财判断方式：封闭D303、定开D309、周期D306】；
2、缴费方式为期缴的保险产品且保单状态正常、保险缴费期未结束
【保险缴费期未结束判断方式：银保通系统保险业务流水查询中账务日期、缴费年期，结合取数日判断，例：账务日期2023年12月21日、缴费年期3年，最后期缴款日为2025年12月21日，取数日小于最后期缴款日的，符合要求】
同一客户在12月17日至12月24日间每日产生数据的，不合并，全部展示。
*/
-- 客户号 统一风险控制号 贷款合同号 维度
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,SUBSTR(T1.DOC_NBR,7,8) BIRTH_DT
    ,T1.AGE
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
    ,t5.sam_rsk_ctrl_id     --同一风险控制号
    ,T6.CRDT_RSK_LVL        --信用风险等级
    ,CASE WHEN T7.CST_ID IS NOT NULL THEN 1 ELSE 0 END IS_BLACK_LIST
    ,t1.dt
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID and t1.dt = t2.dt
AND     T2.DT between '20231217' and '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID  and t1.dt = t4.dt
AND     T4.DT between '20231217' and '20231224'
LEFT JOIN EDW.DWS_CST_BAS_INF_DD                    T5
ON T1.CST_ID = T5.CST_ID and t1.dt = t5.dt
AND T5.DT between '20231217' and '20231224'
left join(
    select dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') CRDT_RSK_LVL
        ,ROW_NUMBER() OVER(PARTITION BY dt,CST_ID ORDER BY busi_id DESC) RN
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt between '20231217' and '20231224'
)T6 on T1.cst_id=T6.cst_id and t1.dt=t6.dt AND T6.RN=1
LEFT JOIN(
    select distinct dt,cst_id
    from edw.dim_bus_loan_ctr_inf_dd
    where dt between '20231217' and '20231224'
    and cst_rsk_grd>='6'--'5','高风险','6','黑名单'
)T7 ON T1.CST_ID=T7.CST_ID and t1.dt=t7.dt
WHERE T1.DT between '20231217' and '20231224'
;
--客户征信信息
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_02 AS
select T1.cst_id,T1.report_dt
    ,T1.wdil6m                      --近6个月的最大逾期期数
    ,T1.late_6_mon_max_od_amt	    --近6个月的最高逾期金额(信用卡+贷款）
    ,T1.late_6mon_enqu_count	    --最近6个月审批查询次数
    ,T1.late_6mon_enqu_org_num      --近6个月审批查询金融机构家数
    ,T1.late_6mon_org_pass_num      --近6个月审批通过金融机构家数
    ,T1.cred_card_total_balan	    --信用卡总余额
    ,T1.c_c_6m_avg_use_rate	        --信用卡最近6个月平均透支率
    ,T1.o_bank_no_num	            --未结清非抵押类贷款银行家数
    ,T2.digital_unscr               --征信分
    ,T1.report_dsc_rn
    ,T1.DT
from edw.DWS_CST_CCRC_IDV_IND_INF_DD                    t1
left join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di  t2
on t1.report_no=t2.report_id
and t2.dt<='20231224'
where t1.dt between '20231217' and '20231224'
and t1.report_dsc_rn<=2    --最新,次新
;
-- 自营/代销 理财
--定期自营理财判断方式：产品模板为封闭1303、定开1309的产品
--定期代销理财判断方式：封闭D303、定开D309、周期D306
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_03 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.TRX_AMT --交易金额
    ,decode(T1.TRX_STS_CD,'6','部分确认未全部返回','7','部分确认已全部返回'
        ,'8','确认成功','S','成功')                     TRX_STS
    ,DECODE(T1.BUS_CD,'122','申购','130','认购','')     trx_cd
    ,T1.MGR_ID      SALE_EMPE_ID --推荐人员工号
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
    ,t3.dt
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231224'
inner join edw.dws_bus_chm_act_acm_inf_dd 	t3		--理财账户份额汇总信息
on t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.fnc_amt>0    --持有
and t3.DT between '20231217' and '20231224'
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.TRX_DT <= t3.dt
;
--保险 20231206-20231210 交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;,缴费方式为期缴,缴费期未结束
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_04 AS
SELECT T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,T1.CST_ID
    ,substr(t1.SYS_SRL_NBR,1,8) bd_fst_jf_dt        --保单首次缴费日期
    ,to_char(DATEADD(TO_DATE(substr(t1.SYS_SRL_NBR,1,8), 'yyyymmdd'),t6.PAY_YEAR,'yyyy'),'yyyyMMdd') bd_last_jf_dt
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,case when T1.TRX_CD = '510001' then '新保承保' else null end TRX_CD
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP --产品类型|C1
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.TRX_AMT
    ,T1.trx_sts	--交易状态|C1
    ,CASE T6.PAY_YEAR_PRD_TYP WHEN '1' THEN '趸缴'
        WHEN '2' THEN '期缴' else '' END PAY_YEAR_PRD_TYP --缴费年期类型
    ,T6.PAY_YEAR    --缴费年限|C10
    ,CASE WHEN T6.INSU_PLCY_STS='0' THEN '正常' else '' end INSU_PLCY_STS --保单状态
    ,T7.MNG_ID      RCM_PSN_ID
    ,T7.MNG_ORG_ID  RCM_ORG_ID
    ,t1.dt
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20231224'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
and     t1.dt = t6.dt
AND     T6.INSU_PLCY_STS ='0'       --保单状态：0:正常 1:退保 3:犹豫期退保  --所卡范围
AND     T6.PAY_YEAR_PRD_TYP='2'  --期缴
AND     T6.DT between '20231217' and '20231224'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
and     t1.dt = t7.dt
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT between '20231217' and '20231224'
WHERE   T1.DT between '20231217' and '20231224'
AND     T1.TRX_CD = '510001' --交易代码 510001新保承保
;
--财富产品交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_05 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,'保险产品' PROD_CLASS
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR   --保险
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,'保险' PROD_TYPE
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,T1.RCM_PSN_ID,T3.EMPE_NM RCM_PSN_NM            --推荐人
    ,T1.RCM_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM      --推荐人机构
    ,t1.dt
FROM SJXQ_SJ20231227106_CST_04              T1  --保险
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            T3
ON  T1.RCM_PSN_ID = T3.EMPE_ID
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.RCM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
where t1.dt<=t1.bd_last_jf_dt
UNION all
SELECT T1.CST_ID,T1.SRL_NBR,'理财产品' PROD_CLASS
    ,NULL,NULL,NULL,NULL
    ,T1.trx_sts,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE2
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,T1.SALE_EMPE_ID,t3.EMPE_NM
    ,T1.SALE_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.dt
FROM SJXQ_SJ20231227106_CST_03              T1  --理财
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.SALE_EMPE_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.SALE_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
;
--财富产品交易 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_06 AS
SElECT dt,CST_ID
from SJXQ_SJ20231227106_CST_05
GROUP by dt,cst_ID
;
--同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_07 AS
SELECT T1.CST_ID,T1.SAM_RSK_CTRL_ID
    ,t2.CST_ID      RSK_CST_ID
    ,T2.CST_CHN_NM  RSK_CST_NM
    ,T3.rel_typ
    ,T2.CRDT_RSK_LVL
    ,T2.IS_BLACK_LIST
    ,t1.dt
FROM SJXQ_SJ20231227106_CST_01              T1
INNER JOIN SJXQ_SJ20231227106_CST_01        T2  --同一风险控制号下的客户号
ON T1.SAM_RSK_CTRL_ID=T2.SAM_RSK_CTRL_ID and t1.dt=t2.dt
LEFT JOIN(
    SELECT T3.DT,T3.CST_ID,T3.REL_CST_ID
    FROM edw.dim_cst_rel_inf_dd            T3  --同一风险风险控制号下的客户关系 会存在多个关联
    LEFT JOIN edw.dwd_code_library_dd      C1
    ON T3.rel_typ_cd = C1.cd_val
    AND C1.dt='20231224'
    WHERE T3.DT between '20231217' and '20231224'
    GROUP BY T3.DT,T3.CST_ID,T3.REL_CST_ID
)T3 ON T1.CST_ID=T3.CST_ID
AND T2.CST_ID=T3.REL_CST_ID and t2.dt=t3.dt
WHERE nvl(t1.sam_rsk_ctrl_id,'')<>''    --非空
;
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_07_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_07_1 AS
SELECT T3.DT,T3.CST_ID,T3.REL_CST_ID
        ELSE (case when T3.rel_typ_cd = '0406' then '法人机构' else C1.CD_VAL_DSCR end)
        END)) rel_typ
FROM edw.dim_cst_rel_inf_dd            T3  --同一风险风险控制号下的客户关系 会存在多个关联
LEFT JOIN edw.dwd_code_library_dd      C1
ON T3.rel_typ_cd = C1.cd_val
AND C1.dt='@@{yyyyMMdd}'
WHERE T3.DT = '@@{yyyyMMdd}'
GROUP BY T3.DT,T3.CST_ID,T3.REL_CST_ID
;
SELECT *
from SJXQ_SJ20231227106_CST_07_1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_07_2 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_07_2 AS
SELECT DISTINCT rel_typ_cd
FROM edw.dim_cst_rel_inf_dd            T3  --同一风险风险控制号下的客户关系 会存在多个关联
WHERE T3.DT<='@@{yyyyMMdd}'
;
--客户贷款信息
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_08 AS
select B.cst_ID
    ,B.BUSI_CTR_ID                         --合同流水号
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行年利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr FIVE_CTG                --五级分类
    ,b.crc_ind                             --是否为循环类贷款
    ,D.PREEVALUATERESULT                    pre_ases_res_CD
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT end        pre_ases_res
    ,CASE WHEN B.bus_cd = 'J' THEN 1 ELSE 0 END                         IS_ZXT_LOAN     --助兴通贷款
    ,CASE WHEN B.bus_cd = 'J' AND NVL(G.LOAN_BAL,0)=0 THEN 1 ELSE 0 END IS_ZXT_LOAN_JQ
    ,b.dt
from edw.DIM_BUS_LOAN_CTR_INF_DD        B --信贷合同信息
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     B.DT = C.DT
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT between '20231217' and '20231224'
left join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and c.dt=d.dt
and D.customerrole = '01' -- 角色为借款人
and D.dt between '20231217' and '20231224'
left join edw.dwd_code_library_dd       E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='20231224'
LEFT JOIN (
    SELECT DT,BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        ,sum(prcp_bal) LOAN_BAL     --本金余额
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT between '20231217' and '20231224'
    GROUP BY DT,BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID AND B.DT = G.DT
WHERE NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND   B.DT between '20231217' and '20231224'
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ20231227106_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227106_CST_09 AS
SElECT T1.dt					数据日期_交易日期
    ,T1.cst_ID                  客户号
    ,t2.cst_chn_nm              客户名称
    ,T1.pd_cd                   产品代码
    ,T1.pd_nm                   产品名称
    ,T1.SYS_SRL_NBR             交易流水号
    ,T1.trx_sts                 交易状态
    ,T1.trx_dt                  交易日期
    ,T1.trx_amt                 交易金额
    ,T1.PROD_TYPE               财富产品分类
	,''							产品类型
    ,T1.INSU_PLCY_ID            保单号_保险
    ,T1.INSU_PLCY_STS           保单状态_保险
    ,T1.PAY_YEAR_PRD_TYP        缴费年限类型_保险
    ,T1.PAY_YEAR                缴费年限_保险
    ,T1.RCM_PSN_ID              推荐人工号
    ,T1.RCM_PSN_NM              推荐人姓名
    ,T1.RCM_ORG_ID              推荐人所在机构
    ,T1.SBR_ORG_NM              推荐人所在支行
    ,T1.BRC_ORG_NM              推荐人所在分行
    ,T2.PRM_MGR_ID              管户人工号
    ,T2.PRM_MGR_NM              管户人姓名
    ,T2.PRM_ORG_ID              管户人所在机构
    ,T2.SBR_ORG_NM              管护人所在支行
    ,T2.BRC_ORG_NM              管户人所在分行
	,T2.BIRTH_DT                购买人出生年月日
	,T2.AGE                     购买人年龄
    ,T2.SAM_RSK_CTRL_ID         		同一风险控制号
    ,T3.RSK_CST_ID                      同一风险控制号下的客户号
    ,T3.RSK_CST_NM                      同一风险控制号下的客户名称
    ,T3.rel_typ                         同一风险风险控制号下的客户与购买人的关系
    ,T3.CRDT_RSK_LVL                    同一风险控制号下的客户信用风险等级
    ,T3.IS_BLACK_LIST                   同一风险控制号下的客户是否为黑名单客户
    ,T4.report_dt                       同一风险控制号下的客户最新征信报告日期
    ,T4.wdil6m                          同一风险控制号下的客户最新征信报告中近6个月的最大逾期期数
    ,T4.late_6_mon_max_od_amt	        同一风险控制号下的客户最新征信报告中近6个月的最高逾期金额_信用卡和贷款
    ,T4.late_6mon_enqu_count	        同一风险控制号下的客户最新征信报告中近6个月审批查询次数
    ,T4.late_6mon_enqu_org_num          同一风险控制号下的客户最新征信报告中近6个月审批查询金融机构家数
    ,T4.late_6mon_org_pass_num          同一风险控制号下的客户最新征信报告中近6个月审批通过金融机构家数
    ,T4.cred_card_total_balan	        同一风险控制号下的客户最新征信报告中信用卡总余额
    ,T4.c_c_6m_avg_use_rate	            同一风险控制号下的客户最新征信报告中近6个月信用卡平均透支率
    ,T4.o_bank_no_num	                同一风险控制号下的客户最新征信报告中未结清非抵押类贷款银行家数
    ,T5.o_bank_no_num	                同一风险控制号下的客户次新征信报告中未结清非抵押类贷款银行家数
    ,T4.digital_unscr                   购买人最新征信报告中的征信分
    ,T5.digital_unscr                   购买人次新征信报告中的征信分
    ,T6.BUSI_CTR_ID                     同一风险控制号下的客户贷款合同号
    ,T6.DTRB_DT                         同一风险控制号下的客户贷款合同生效日
    ,T6.FIVE_CTG                        同一风险控制号下的客户贷款五级分类
    ,T6.pre_ases_res_CD                 同一风险控制号下的客户贷款预评估结果代码
    ,T6.pre_ases_res                    同一风险控制号下的客户贷款预评估结果
    ,T6.IS_ZXT_LOAN                     同一风险控制号下的客户贷款是否为助兴通贷款
    ,T6.IS_ZXT_LOAN_JQ                  助兴通贷款是否结清
    ,T6.crc_ind                         同一风险控制号下的客户贷款是否为循环类贷款
    ,T6.INTR_RAT                        同一风险控制号下的客户贷款年利率
    ,''                                 同一风险控制号下的客户循环类贷款近三个月平均透支率
from SJXQ_SJ20231227106_CST_06      t1  --交易主表
left join SJXQ_SJ20231227106_CST_01 t2  --基础信息
on t1.dt=t2.dt and t1.cst_ID=t2.cst_ID
left JOIN SJXQ_SJ20231227106_CST_07 T3  --同一风险控制号
ON T1.DT=T3.DT AND T1.CST_ID=T3.CST_ID
LEFT JOIN SJXQ_SJ20231227106_CST_02 T4  --征信
on T1.DT=T4.DT AND T1.CST_ID=T4.CST_ID
AND T4.report_dsc_rn = 1 --最新征信
LEFT JOIN SJXQ_SJ20231227106_CST_02 T5  --征信
on T1.DT=T5.DT AND T1.CST_ID=T5.CST_ID
AND T5.report_dsc_rn = 2 --次新征信
left JOIN SJXQ_SJ20231227106_CST_08 T6  --贷款信息
ON T1.DT=T6.DT AND T1.CST_ID=T6.CST_ID
;
SElECT '01' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ20231227106_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct dt,cst_id,report_dsc_rn) custs
from SJXQ_SJ20231227106_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ20231227106_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ20231227106_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ20231227106_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ20231227106_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct dt,cst_id,RSK_CST_ID) custs
from SJXQ_SJ20231227106_CST_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct dt,BUSI_CTR_ID) custs
from SJXQ_SJ20231227106_CST_08
UNION all
SElECT '09' seq, count(1) cnt, count(distinct 数据日期_交易日期,客户号) custs
from SJXQ_SJ20231227106_CST_09
;
SElECT *
from SJXQ_SJ20231227106_CST_09
;
/*
01	114688570	114688570
02	63812674	63812674
03	465505	255246
04	334581	305119
05	800014	539623
06	539623	539623
07	76776331	76776331
08	42554966	42554966
09	3637028	539623
dt = '20240226'
01	114688570	114688570
02	63812674	63812674
03	465201	255043
04	334581	305119
05	799710	539444
06	539444	539444
07	76776331	76776331
08	42554966	42554966
09	3636753	539444
*/***SJ20231227116_财富销售适当性预警业务.sql
/*20231225 每日新增成功购买的财富业务：
保险业务：交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;；
理财业务：财富产品分类为自营理财、代销理财的；
基金：财富产品分类为基金，业务代码为&ldquo;申购确认&rdquo;&ldquo;认购确认&rdquo;且交易成功，基金单个定投协议号下的首次定投起始日期为2023年12月10日且成功支付首笔定投款；
贵金属：财富产品分类为贵金属，贵金属成功购买交易&quot;
step1:确定字段
step2:确定日期 20231206-20231210
step3:注意 ROW_NUMBER 表
*/
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
    ,t5.sam_rsk_ctrl_id
    ,T6.CRDT_RSK_LVL
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20231225'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231225'
LEFT JOIN EDW.DWS_CST_BAS_INF_DD                    T5
ON T1.CST_ID = T5.CST_ID
AND T5.DT = '20231225'
left join(
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') CRDT_RSK_LVL
        ,ROW_NUMBER() OVER(PARTITION BY CST_ID ORDER BY busi_id DESC) RN
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='20231225'
)T6 on T1.cst_id=T6.cst_id AND T6.RN=1
WHERE T1.DT='20231225'
;
--保险 20231206-20231210 交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_02 AS
SELECT T1.SYS_SRL_NBR ,T1.INSU_PLCY_ID,T1.CST_ID
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,case when T1.TRX_CD = '510001' then '新保承保' else null end TRX_CD
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP --产品类型|C1
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.TRX_AMT
    ,T1.trx_sts	--交易状态|C1
    ,CASE T6.PAY_YEAR_PRD_TYP WHEN '1' THEN '趸缴'
        WHEN '2' THEN '年缴' else '' END PAY_YEAR_PRD_TYP --缴费年期类型
    ,T6.PAY_YEAR    --缴费年限|C10
    ,CASE WHEN T6.INSU_PLCY_STS='0' THEN '正常' else '' end INSU_PLCY_STS
    ,T7.MNG_ID      RCM_PSN_ID
    ,T7.MNG_ORG_ID  RCM_ORG_ID
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20231225'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
AND     T6.INSU_PLCY_STS ='0'   --保单状态：0:正常 1:退保 3:犹豫期退保  --所卡范围
AND     T6.DT = '20231225'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT = '20231225'
WHERE   T1.DT = '20231225'
AND     T1.TRX_DT BETWEEN '20231206' AND '20231210'
AND     T1.TRX_CD = '510001' --交易代码 510001新保承保
;
-- 基金 20231206-20231210 业务代码为&ldquo;申购确认&rdquo;&ldquo;认购确认&rdquo;且交易成功
-- 业务代码为 '定投申请' 首次定投起始日期为2023年12月10日且成功支付首笔定投款
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_03 AS
SELECT T1.CST_ID,t1.aip_agr_id
    ,DECODE(T2.BUS_CD,'020','认购','022','申购','039','定投') TRX_CD    --交易代码
    ,T2.bus_glo_srl_nbr TRX_SRL_NBR
    ,DECODE(T1.TRX_STS_CD,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,T2.chnl_dt TRX_DT
    ,T2.chnl_tm TRX_tm
    ,T2.APL_AMT         TRX_AMT
    ,T2.RCM_PSN_ID      RCM_PSN_ID  --推荐人员工号
    ,T2.PD_CD                       --产品代码
    ,T3.PD_NM                       --产品名称
    ,DECODE(T3.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04'
        ,'货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,case when T2.BUS_CD='039' and T4.ACM_SUC_TMS=1 then 1 else NULL end is_fst_aip
    --首次定投日是2023年12月10日，并且在这天成功扣划定投款的客户
        OR (T2.BUS_CD='039' AND T4.aip_start_dt ='20231210' and T4.ACM_SUC_TMS>0) THEN 1
        ELSE 0 END IS_SELECT
FROM EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI         t1
inner join (
    SElECT apl_id,CST_ID,BUS_CD,bus_glo_srl_nbr,chnl_dt,chnl_tm,CHNL_CD,APL_AMT,rcm_psn_id
        ,trx_act_id,taact_id,ta_cd,pd_cd
        ,row_number() OVER(PARTITION by apl_id order by dt desc) rn
    FROM edw.dwd_bus_chm_fnd_cst_rqs_srl_dd  --基金客户资金类交易申请流水
    WHERE dt<='20231225'
    and chnl_dt between '20231206' and '20231210'   --交易时间
    -- AND trx_cd IN ( '100200' , '100201' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
    AND trx_sts_cd IN ( '3','S' )        -- 交易成功
)T2 on t1.orig_apl_id = T2.apl_id and T2.rn=1
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD        T3  --基金产品表
ON T2.PD_CD=T3.PD_CD
AND T3.DT='20231225'
AND T3.FND_TYP_CD<>'04' -- 非货基金
left JOIN EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD    T4 -- 基金定投协议信息
on T1.aip_agr_id = T4.agr_id and T4.dt='20231225'
WHERE T1.DT <= '20231225'
AND   T1.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND   T1.BUS_CD IN ( '120' , '122' , '136' , '139' , '138') --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND   T1.CFM_AMT > 0
;
--贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_04 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '20231225'
AND ORD_TM >= '2023-12-06' and ORD_TM<= '2023-12-10'
UNION ALL
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '20231225'
AND ORD_TM >= '2023-12-06' and ORD_TM<= '2023-12-10'
;
-- 自营/代销 理财
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_05 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.TRX_AMT --交易金额
    ,decode(T1.TRX_STS_CD,'6','部分确认未全部返回','7','部分确认已全部返回'
        ,'8','确认成功','S','成功')                     TRX_STS
    ,DECODE(T1.BUS_CD,'122','申购','130','认购','')     trx_cd
    ,T1.MGR_ID      SALE_EMPE_ID --推荐人员工号
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231225'
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.TRX_DT BETWEEN '20231206' AND '20231210'
;
--财富产品交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_06 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,'保险' PROD_CLASS
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR   --保险
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,NULL is_fst_aip     --基金
    ,T1.RCM_PSN_ID,T3.EMPE_NM RCM_PSN_NM            --推荐人
    ,T1.RCM_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM      --推荐人机构
FROM SJXQ_SJ20231227116_CST_02              T1  --保险
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            T3
ON  T1.RCM_PSN_ID = T3.EMPE_ID
AND T3.DT = '20231225'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.RCM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231225'
UNION all
SELECT T1.CST_ID,T1.TRX_SRL_NBR,'基金'
    ,NULL,NULL,NULL,NULL
    ,T1.trx_sts,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,T1.is_fst_aip
    ,T1.RCM_PSN_ID,T3.EMPE_NM
    ,T4.ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ20231227116_CST_03              T1  --基金
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231225'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T3.ORG_ID = T4.ORG_ID
AND     T4.DT = '20231225'
WHERE T1.IS_SELECT=1    --选中基金交易
UNION all
SELECT CST_ID,ORD_ID,'贵金属'
    ,NULL,NULL,NULL,NULL
    ,ORD_STS,'购买',NULL,CMDT_NM,GOODS_TYP
    ,TRX_DT,substr(PMT_TM,12,19),TRX_AMT
    ,NULL
    ,RCM_PSN_ID,RCM_PSN_NM
    ,RCM_PSN_AFL_DEPT_ID
    ,RCM_PSN_AFL_SUB_BRN
    ,RCM_PSN_AFL_BRN
FROM SJXQ_SJ20231227116_CST_04   T1  --贵金属
UNION all
SELECT T1.CST_ID,T1.SRL_NBR,CONCAT(T1.AGN_IND,'理财')
    ,NULL,NULL,NULL,NULL
    ,T1.trx_sts,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,NULL
    ,T1.SALE_EMPE_ID,t3.EMPE_NM
    ,T1.SALE_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ20231227116_CST_05              T1  --理财
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.SALE_EMPE_ID = T3.empe_id
AND T3.DT = '20231225'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.SALE_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231225'
;
--同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_07 AS
SELECT T1.CST_ID,T1.SAM_RSK_CTRL_ID
    ,t2.CST_ID RSK_CST_ID,T2.CST_CHN_NM RSK_CST_NM
    ,CASE WHEN T1.CST_ID=T2.CST_ID THEN '本人' ELSE C1.CD_VAL_DSCR END rel_typ
    ,T2.CRDT_RSK_LVL
FROM SJXQ_SJ20231227116_CST_01              T1
INNER JOIN SJXQ_SJ20231227116_CST_01        T2
ON T1.SAM_RSK_CTRL_ID=T2.SAM_RSK_CTRL_ID
LEFT JOIN edw.dim_cst_rel_inf_dd            T3
ON T1.CST_ID=T3.CST_ID AND T2.CST_ID=T3.REL_CST_ID
AND T3.DT = '20231225'
LEFT JOIN edw.dwd_code_library_dd           C1
ON T3.rel_typ_cd = C1.cd_val
AND C1.dt='20231225'
WHERE nvl(t1.sam_rsk_ctrl_id,'')<>''    --非空
;
-- 前后15天贷款
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_08 AS
select a.cst_ID,a.trx_dt
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行年利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr FIVE_CTG                --五级分类
    ,case when b.crc_ind = '1' then '循环贷款'
            OR SUBSTR(b.PD_ID,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                                                  --贷款用途
    ,B.USG_CMT                                                      --贷款用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt    --贷款利率优惠备注
    ,case when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan              --是否政策性贷款
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from(
    SElECT distinct cst_ID,trx_dt
    from SJXQ_SJ20231227116_CST_06
)a INNER JOIN edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.cst_ID = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.DT = '20231225'
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '20231225'
and ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd'))<=15 --交易日前后15天内的贷款
left join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '20231225'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='20231225'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '20231225'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '20231225'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
--与当笔贷款贷款类型相同的上一笔贷款合同号
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_09 AS
SElECT t1.cst_ID,t1.loan_type,t1.DTRB_DT
    ,t2.BUSI_CTR_ID         lst_BUSI_CTR_ID
    ,t2.DTRB_DT             lst_DTRB_DT
    ,t2.ref_year_intr_rat   lst_ref_year_intr_rat
    ,t2.INTR_RAT            lst_INTR_RAT
    ,t2.aprv_exe_mon_intr_rat lst_mon_intr_rat
    ,t2.CTR_AMT             lst_CTR_AMT
    ,row_number() OVER(partition by t1.cst_ID,t1.loan_type,t1.DTRB_DT order by t2.DTRB_DT desc) rn
from( --交易日前后15天内的贷款信息
    SElECT distinct cst_id,DTRB_DT,loan_type
    from SJXQ_SJ20231227116_CST_08
)t1 inner join (
    select b.cst_ID
        ,B.BUSI_CTR_ID                         --合同流水号
        ,B.CTR_AMT                             --合同金额
        ,c.ref_year_intr_rat                   --参考年利率
        ,B.INTR_RAT                            --执行年利率
        ,c.aprv_exe_mon_intr_rat               --执行月利率
        ,G.DTRB_DT                             --发放日期
        ,case when b.crc_ind = '1' then '循环贷款'
                OR SUBSTR(PD_ID,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    FROM edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
    INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
    ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
    AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
    AND     C.DT = '20231225'
    LEFT JOIN (
        SELECT  BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
        WHERE DT = '20231225'
        GROUP BY BUS_CTR_ID
    ) G ON  B.BUSI_CTR_ID = G.BUS_CTR_ID
    WHERE   NVL(B.CST_ID,'') <> ''  --剔除空值和空
    AND     B.DT = '20231225'
)t2 on t1.cst_ID=t2.cst_ID and t1.loan_type=t2.loan_type
and t2.DTRB_DT < t1.DTRB_DT     --历史发放贷款
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_10 AS
SElECT T1.SYS_SRL_NBR,T1.PROD_CLASS
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_AMT,T1.is_fst_aip
    ,T1.RCM_PSN_ID,T1.RCM_PSN_NM                --推荐人
    ,T1.RCM_ORG_ID,T1.SBR_ORG_NM,T1.BRC_ORG_NM  --推荐人机构
    ,T1.CST_ID
    ,T2.SAM_RSK_CTRL_ID
    ,T2.RSK_CST_ID
    ,T2.RSK_CST_NM
    ,T2.rel_typ,T2.CRDT_RSK_LVL
    ,T3.BUSI_CTR_ID,T3.loan_type,T3.FIVE_CTG,T3.dtrb_dt,T3.ref_year_intr_rat
    ,T3.INTR_RAT,T3.aprv_exe_mon_intr_rat,T3.ctr_amt,T3.is_zc_loan,T3.is_jl_loan
    ,T3.LOAN_USG_CD,T3.USG_CMT,T3.intr_rat_adj_cmt,T3.pre_ases_res
    ,T4.lst_BUSI_CTR_ID
	,T4.lst_DTRB_DT
	,T4.lst_ref_year_intr_rat
	,T4.lst_INTR_RAT
	,T4.lst_mon_intr_rat
	,T4.lst_CTR_AMT
from SJXQ_SJ20231227116_CST_06      T1  --财富交易主表
left join SJXQ_SJ20231227116_CST_07 T2  --同一风险风险控制号
ON T1.CST_ID=T2.CST_ID
LEFT JOIN SJXQ_SJ20231227116_CST_08 T3  --前后15天内的贷款
ON T1.CST_ID=T3.CST_ID
AND T1.TRX_DT=T3.TRX_DT
LEFT JOIN SJXQ_SJ20231227116_CST_09 T4  --上一笔贷款
ON  T3.CST_ID=T4.CST_ID
AND T3.LOAN_TYPE=T4.LOAN_TYPE
AND T3.DTRB_DT = T4.DTRB_DT AND T4.RN=1
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20231227116_CST_11 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20231227116_CST_11 AS
select TO_CHAR(DATEADD(TO_DATE(t1.trx_dt, 'yyyymmdd'), 15, 'dd'),'yyyymmdd')        数据日期
    ,T1.SYS_SRL_NBR                     交易流水号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.INSU_PLCY_ID                    保单号_保险
    ,T1.INSU_PLCY_STS                   保单状态_保险
    ,T1.PAY_YEAR_PRD_TYP                缴费年期类型_保险
    ,T1.PAY_YEAR                        缴费年限_保险
    ,T1.TRX_STS                         交易状态
    ,T1.TRX_CD                          交易代码_业务代码
    ,T1.PD_CD                           产品代码
    ,T1.PD_NM                           产品名称
    ,T1.PROD_TYPE                       产品类型
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_AMT                         交易金额
    ,T1.is_fst_aip                      是否首笔定投_基金
    ,T1.RCM_PSN_ID                      推荐人工号
    ,T1.RCM_PSN_NM                      推荐人姓名
    ,T1.RCM_ORG_ID                      推荐人所在机构
    ,T1.SBR_ORG_NM                      推荐人所在支行
    ,T1.BRC_ORG_NM                      推荐人所在分行
    ,T2.PRM_MGR_ID                      管户人工号
    ,T2.PRM_MGR_NM                      管户人姓名
    ,T2.PRM_ORG_ID                      管户人所在机构
    ,T2.SBR_ORG_NM                      管户人支行名称
    ,T2.BRC_ORG_NM                      管户人分行名称
    ,T1.CST_ID							购买人客户号
    ,T2.CST_CHN_NM                      购买人名称
    ,T2.SAM_RSK_CTRL_ID                 同一风险控制号
    ,T1.RSK_CST_ID                      同一风险风险控制号下的客户号
    ,T1.RSK_CST_NM                      同一风险风险控制号下的客户名称
    ,T1.rel_typ                         同一风险风险控制号下的客户与购买人的关系
    ,T1.CRDT_RSK_LVL                    同一风险控制号下的客户的信用风险等级
    ,T1.BUSI_CTR_ID                     财富业务交易日前后15天内的贷款合同号
    ,T1.loan_type                       当笔贷款类型
    ,T1.FIVE_CTG                        当笔贷款五级分类
    ,T1.dtrb_dt                         当笔贷款发放日期
    ,T1.ref_year_intr_rat               当笔贷款参考年利率
    ,T1.INTR_RAT                        当笔贷款执行年利率
    ,T1.aprv_exe_mon_intr_rat           当笔贷款执行月利率
    ,T1.ctr_amt                         当笔贷款合同金额
    ,T1.is_zc_loan                      当笔贷款是否为政策性贷款
    ,T1.is_jl_loan                      当笔贷款是否为接力贷
    ,T1.LOAN_USG_CD                     当笔贷款用途
    ,T1.USG_CMT                         当笔贷款用途备注
    ,T1.intr_rat_adj_cmt                当笔贷款利率优惠备注
    ,T1.pre_ases_res                    当笔贷款预评估结果
    ,T1.lst_BUSI_CTR_ID                 与当笔贷款贷款类型相同的上一笔贷款合同号
    ,case when T1.lst_BUSI_CTR_ID is not null then T1.loan_type else null end 上一笔贷款类型
    ,T1.lst_DTRB_DT                     上一笔贷款发放日期
    ,T1.lst_ref_year_intr_rat           上一笔贷款参考年利率
    ,T1.lst_INTR_RAT                    上一笔贷款执行年利率
	,T1.lst_mon_intr_rat                上一笔贷款执行月利率
	,T1.lst_CTR_AMT                     上一笔贷款合同金额
from SJXQ_SJ20231227116_CST_10      T1
left join SJXQ_SJ20231227116_CST_01 T2  --基础信息
ON T1.CST_ID=T2.CST_ID
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct BUSI_CTR_ID) custs
from SJXQ_SJ20231227116_CST_08
UNION all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_09 where rn=1
UNION all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20231227116_CST_10
UNION all
SElECT '11' seq, count(1) cnt, count(distinct 购买人客户号) custs
from SJXQ_SJ20231227116_CST_11
;
01	14355264	14355264
02	8	8
03	832	633
04	306	241
05	18068	6529
06	18986	7294
07	9606145	6711352
08	290	281
09	119	90
10	25360	7294
11	25360	7294
*/
***SJ2023122801_销售适当性.sql
/*20231217-20231224 每日新增成功购买的财富业务：
保险业务：交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;；
理财业务：财富产品分类为自营理财、代销理财的；
基金：财富产品分类为基金，业务代码为&ldquo;申购确认&rdquo;&ldquo;认购确认&rdquo;且交易成功，基金单个定投协议号下的首次定投起始日期为2023年12月10日且成功支付首笔定投款；
贵金属：财富产品分类为贵金属，贵金属成功购买交易&quot;
*/
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,SUBSTR(T1.DOC_NBR,7,8) BIRTH_DT
    ,T1.AGE
    ,T1.M_TEL_NO
    ,DECODE(T1.GDR_CD,'1','男','2','女','未知') GENDER
    ,T1.fm_ind,T1.reg_adr_dtl_inf,T1.fam_adr_dtl_inf
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
WHERE T1.DT='20231224'
;
--保险 20231217-20231224
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_02 AS
SELECT T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,T1.CST_ID
    ,substr(t1.SYS_SRL_NBR,1,8) bd_jf_dt --保单首次缴费日
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP
    ,T2.CMP_CD
    ,T3.CMP_NM
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.TRX_AMT
    ,T4.EFE_LOAN_CST_IND                                    EFE_LOAN_CST_IND_TRX
    ,CASE WHEN NVL(T5.OWN_EMP_ID,'')<>'' THEN 1 ELSE 0 END  OWN_EMP_ID_TRX
    ,T1.TRX_ZID             --交易帐号|C32
    ,T1.CHNL_TYP            --渠道类型|C10
    ,t6.insu_fee            --保险费用
    ,T6.PAY_YEAR_PRD_TYP    --缴费年期类型|C2 1趸缴 2年缴
    ,T6.PAY_YEAR            --缴费年限|C10
    ,t6.acc_dt	            --受理日期|C16
    ,T6.EFT_DT              --生效日期
    ,T7.MNG_ID      RCM_PSN_ID
    ,T7.MNG_ORG_ID  RCM_ORG_ID
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20231224'
LEFT JOIN EDW.DIM_BUS_INSU_CMP_INF_DD           T3 --保险公司信息
ON  T2.CMP_CD=T3.CMP_CD
AND T3.DT='20231224'
LEFT JOIN ADM_PUB.ADM_CSM_CBAS_IND_INF_DD       T4
ON  T1.CST_ID=T4.CST_ID AND T1.TRX_DT=T4.DT
AND T4.DT BETWEEN '20231217' AND '20231224'
LEFT JOIN EDW.DWS_CST_IDV_BAS_INF_DD            T5
ON T1.CST_ID=T5.CST_ID AND T1.TRX_DT=T5.DT
AND T5.DT BETWEEN '20231217' AND '20231224'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
AND     T6.INSU_PLCY_STS ='0'   --保单状态：0:正常 1:退保 3:犹豫期退保  --所卡范围
AND     T6.DT = '20231224'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT = '20231224'
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.TRX_DT = T8.DT
AND T8.DT BETWEEN '20231217' AND '20231224'
WHERE T1.DT = '20231224'
AND     T1.TRX_DT BETWEEN '20231217' AND '20231224'
AND     T1.TRX_CD = '510001' --交易代码 新保承保(510001)
;
-- 基金 20231217-20231224
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_03 AS
SELECT T0.CST_ID
    ,T1.BUS_CD
    ,DECODE(T1.BUS_CD,'020','认购','022','申购','039','定投申请') TRX_TYPE
    ,T1.bus_glo_srl_nbr TRX_SRL_NBR
    ,T1.chnl_dt TRX_DT
    ,T1.chnl_tm TRX_tm
    ,T0.CFM_DT
    ,T1.CHNL_CD         TRX_CHNL_CD
    ,T1.APL_AMT         TRX_AMT
    ,T0.CFM_AMT                     --确认金额
    ,T1.RCM_PSN_ID      RCM_PSN_ID  --推荐人员工号
    ,T1.TRX_ACT_ID                  --银行账号
    ,t1.taact_id
    ,t1.ta_cd
    ,T1.PD_CD                       --产品代码
    ,T2.PD_NM                       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS                --业绩比较基准
    ,T2.FOUND_DT                    --产品成立日期
    ,''                             --产品起息日期
    ,T2.MTU_DT                      --产品结束日期
    ,T3.CST_RSK_GRD_CD  TRX_FND_RSK_LVL     --客户交易日风险等级
    ,T3.ASES_DT         TRX_FND_RSK_ASES_DT --客户交易日风险测评时间
    ,T3.nvld_dt         TRX_FND_RSK_MTU_dt
    ,T6.CST_RSK_GRD_CD  new_FND_RSK_LVL     --客户交易日风险等级
    ,T6.ASES_DT         new_FND_RSK_ASES_DT --客户交易日风险测评时间
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI     t0
inner join (
    SElECT apl_id,cst_Id,BUS_CD,bus_glo_srl_nbr,chnl_dt,chnl_tm,CHNL_CD,APL_AMT,rcm_psn_id
        ,trx_act_id,taact_id,ta_cd,pd_cd
        ,row_number() OVER(PARTITION by apl_id order by dt desc) rn
    FROM edw.dwd_bus_chm_fnd_cst_rqs_srl_dd  --基金客户资金类交易申请流水
    WHERE dt<='@@{yyyyMMdd}'
    and chnl_dt between '20231217' and '20231224'   --交易时间
    -- AND trx_cd IN ( '100200' , '100201' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
    AND trx_sts_cd IN ( '3','S' )        -- 交易成功
)t1 on t0.orig_apl_id = t1.apl_id and t1.rn=1
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD        T2  --基金产品表
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231224'
AND T2.FND_TYP_CD<>'04' -- 非货基金
LEFT JOIN EDW.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    T3      --基金风评表
ON T1.CST_ID=T3.CST_ID AND T1.chnl_dt = T3.DT                --交易时
AND T3.DT BETWEEN '20231217' AND '20231224'
LEFT JOIN EDW.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    T6      --基金风评表
ON T1.CST_ID=T6.CST_ID AND T6.DT = '@@{yyyyMMdd}'           --最新
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.chnl_dt = T8.DT
AND T8.DT BETWEEN '20231217' AND '20231224'
left JOIN (	--首次定投日是2023年12月10日，并且在这天成功扣划定投款的客户
    SELECT DISTINCT cst_id --95
	FROM  EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD -- 基金定投协议信息
	WHERE DT='@@{yyyyMMdd}'
    and aip_start_dt ='20231210'    --首次定投日
    AND ACM_SUC_TMS>0               --成功扣款
)T9 ON T1.CST_ID=T9.CST_ID
WHERE T0.DT <= '@@{yyyyMMdd}'
AND   T0.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND   T0.BUS_CD IN ( '120' , '122' , '136' , '139' , '138') --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND   T0.CFM_AMT > 0
;
--客户上一次基金风评
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_04 AS
SELECT T1.CST_ID,T1.TRX_DT,T1.TRX_FND_RSK_ASES_DT
    ,T2.cst_rsk_grd_cd  lst_fnd_rsk_lvl
    ,T2.ases_dt         lst_fnd_rsk_ase_dt
    ,T2.nvld_dt         lst_fnd_rsk_mtu_dt
    ,ROW_NUMBER() OVER(PARTITION BY T1.CST_ID,T1.TRX_DT ORDER BY T2.ases_dt DESC) RN
FROM(
    SElECT DISTINCT T1.CST_ID,T1.TRX_DT,T1.TRX_FND_RSK_ASES_DT
    from SJXQ_SJ2023122801_CST_03 T1
    WHERE T1.IS_SELECT=1 --没有满足条件的记录
)T1 INNER JOIN EDW.dim_bus_chm_fnd_cst_rsk_grd_inf_dd   T2 --基金风评表
ON T1.CST_ID=T2.CST_ID AND T2.ases_dt < T1.TRX_FND_RSK_ASES_DT
AND T2.DT <= '20231224'
;
-- 贵金属
--2023年 贵金属购买信息汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_05 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '@@{yyyyMMdd}'
AND ORD_TM >= '2023-12-17' and ORD_TM<= '2023-12-24'
UNION ALL
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '@@{yyyyMMdd}'
AND ORD_TM >= '2023-12-17' and ORD_TM<= '2023-12-24'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_06 AS
SELECT T1.*
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM SJXQ_SJ2023122801_CST_05                       T1
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.TRX_DT = T8.DT
AND T8.DT BETWEEN '20231217' AND '20231224'
;
-- 自营/代销 理财
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_07 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.CFM_DT --确认日期
    ,T1.TRX_CHNL_CD
    -- ,C1.CD_VAL_DSCR  TRX_CHNL --交易渠道
    ,T1.TRX_AMT --交易金额
    ,T1.CFM_AMT --确认金额
    ,T1.TRX_LOT --交易份额
    ,T1.CFM_LOT --确认份额
    ,T1.MGR_ID      SALE_EMPE_ID --推荐人员工号
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.BNK_ACT_ID --银行账号
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.PD_FOUND_DT     --产品成立日期
    ,T2.PD_VAL_DT       --产品起息日期
    ,T2.PD_END_DT       --产品结束日期
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
    ,T3.RSK_LVL_CD          TRX_FIN_RSK_LVL      --客户交易日风险等级
    ,T3.LATE_ASES_DT        TRX_Fin_RSK_ASEs_DT  --客户交易日风险测评时间
    ,t3.rsk_vld_prd_stop_dt TRX_FIN_RSK_mtu_DT
    ,T7.RSK_LVL_CD          new_Fin_RSK_LVL     --客户最新风险等级
    ,T7.LATE_ASES_DT        new_Fin_RSK_ASES_DT --客户最新风险测评时间
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231224'
LEFT JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD           T3  --风评
ON T1.CST_ID=T3.CST_ID AND T1.TRX_DT=T3.DT              --交易时
and t3.dt between '20231217' AND '20231224'
LEFT JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD           T7  --风评
ON T1.CST_ID=T7.CST_ID AND T7.DT='@@{yyyyMMdd}'         --最新
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.TRX_DT = T8.DT
AND T8.DT BETWEEN '20231217' AND '20231224'
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.TRX_DT BETWEEN '20231217' AND '20231224'
;
--理财上一次风险评估
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_08 AS
SELECT T1.CST_ID,T1.TRX_DT,T1.TRX_FIN_RSK_ASES_DT
    ,T2.rsk_lvl_cd              lst_fin_rsk_lvl
    ,T2.LATE_ASES_DT            lst_fin_rsk_ase_dt
    ,T2.rsk_vld_prd_stop_dt     lst_fin_rsk_mtu_dt
    ,ROW_NUMBER() OVER(PARTITION BY T1.CST_ID,T1.TRX_DT ORDER BY T2.LATE_ASES_DT DESC) RN
FROM(
    SElECT DISTINCT T1.CST_ID,T1.TRX_DT,T1.TRX_FIN_RSK_ASES_DT
    from SJXQ_SJ2023122801_CST_07 T1
)T1 INNER JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD   T2 --基金风评表
ON T1.CST_ID=T2.CST_ID AND T2.LATE_ASES_DT < T1.TRX_FIN_RSK_ASES_DT
AND T2.DT <= '20231224'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_09 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,'保险' PROD_CLASS
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,NULL PD_RSK_GRD
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,T1.RCM_PSN_ID,T3.EMPE_NM RCM_PSN_NM
    ,T1.RCM_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.AUM_BAL_TRX
    ,NULL TRX_RSK_LVL,NULL TRX_RSK_ASES_DT,NULL TRX_RSK_MTU_DT
    ,NULL LST_RSK_LVL,NULL LST_RSK_ASES_DT,NULL LST_RSK_MTU_DT
    ,NULL NEW_RSK_LVL,NULL NEW_RSK_ASES_DT
FROM SJXQ_SJ2023122801_CST_02               T1  --保险
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.RCM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
UNION all
SELECT T1.CST_ID,T1.TRX_SRL_NBR,NULL,'基金'
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,T1.PD_RSK_GRD
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,T1.RCM_PSN_ID,T3.EMPE_NM
    ,T4.ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.AUM_BAL_TRX
    ,T1.TRX_FND_RSK_LVL,T1.TRX_FND_RSK_ASES_DT,T1.TRX_FND_RSK_MTU_DT
    ,T2.LST_FND_RSK_LVL,T2.LST_FND_RSK_ASE_DT,T2.LST_FND_RSK_MTU_DT
    ,T1.NEW_FND_RSK_LVL,T1.NEW_FND_RSK_ASES_DT
FROM SJXQ_SJ2023122801_CST_03               T1  --基金
left join SJXQ_SJ2023122801_CST_04          t2  --上一次风评
on T1.CST_ID=T2.CST_ID AND T1.TRX_DT=T2.TRX_DT
AND T2.RN = 1
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T3.ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
WHERE T1.IS_SELECT=1    --选中基金交易
UNION all
SELECT CST_ID,ORD_ID,NULL,'贵金属'
    ,GOODS_TYP,NULL,CMDT_NM
    ,NULL
    ,TRX_DT,substr(PMT_TM,12,19)
    ,TRX_AMT
    ,RCM_PSN_ID,RCM_PSN_NM
    ,RCM_PSN_AFL_DEPT_ID
    ,RCM_PSN_AFL_SUB_BRN
    ,RCM_PSN_AFL_BRN
    ,AUM_BAL_TRX,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
FROM SJXQ_SJ2023122801_CST_06   T1  --贵金属
UNION all
SELECT T1.CST_ID,T1.SRL_NBR,NULL,CONCAT(T1.AGN_IND,'理财')
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,T1.PD_RSK_GRD
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,T1.SALE_EMPE_ID,t3.EMPE_NM
    ,T1.SALE_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.AUM_BAL_TRX
    ,T1.TRX_FIN_RSK_LVL,T1.TRX_FIN_RSK_ASES_DT,T1.TRX_FIN_RSK_MTU_DT
    ,T2.LST_FIN_RSK_LVL,T2.LST_FIN_RSK_ASE_DT,T2.LST_FIN_RSK_MTU_DT
    ,T1.NEW_FIN_RSK_LVL,T1.NEW_FIN_RSK_ASES_DT
FROM SJXQ_SJ2023122801_CST_07               T1  --理财
left join SJXQ_SJ2023122801_CST_08          t2  --上一次风评
on T1.CST_ID=T2.CST_ID
AND T1.TRX_DT=T2.TRX_DT
AND T2.RN=1
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.SALE_EMPE_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.SALE_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2023122801_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122801_CST_10 AS
SElECT TO_CHAR(DATEADD(TO_DATE(t1.trx_dt, 'yyyymmdd'), 1, 'dd'),'yyyymmdd') 取数日期
    ,REPLACE(T1.TRX_DT,'-','')          数据日期
    ,T1.SYS_SRL_NBR                     交易流水号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.PROD_TYPE                       产品类型
    ,T1.INSU_PLCY_ID                    保单号_保险
    ,T1.PD_CD                           产品代码
    ,T1.PD_NM                           产品名称
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_TM                          交易时间
    ,T1.TRX_AMT                         交易金额
    ,T1.RCM_PSN_ID                      推荐人工号
    ,T1.RCM_PSN_NM                      推荐人姓名
    ,T1.RCM_ORG_ID                      推荐人所在机构
    ,T1.SBR_ORG_NM                      推荐人所在支行名称
    ,T1.BRC_ORG_NM                      推荐人所在分行名称
    ,T2.PRM_MGR_ID                      管户人工号
    ,T2.PRM_MGR_NM                      管户人姓名
    ,T2.PRM_ORG_ID                      管户人所在机构
    ,T2.SBR_ORG_NM                      管户人支行名称
    ,T2.BRC_ORG_NM                      管户人分行名称
    ,T1.CST_ID						    客户号
    ,T2.CST_CHN_NM                      客户名称
    ,T2.BIRTH_DT                        出生年月日
    ,T2.AGE                             年龄
    ,T2.FM_IND							购买人是否农户
    ,T2.REG_ADR_DTL_INF                 购买人户籍地址
    ,T2.FAM_ADR_DTL_INF                 购买人家庭地址
    ,T1.AUM_BAL_TRX                     购买人购买时点AUM
    ,T1.PD_RSK_GRD                      产品风险等级
    ,T1.TRX_RSK_LVL                     购买时点购买人风险等级
    ,T1.TRX_RSK_ASES_DT                 购买时点购买人风险等级测评时间
    ,T1.TRX_RSK_MTU_DT                  购买时点购买人风险等级到期日
    ,T1.LST_RSK_LVL                     购买人购买时点上一次风险等级
    ,T1.LST_RSK_ASES_DT                 购买人购买时点上一次风险等级测评时间
    ,T1.LST_RSK_MTU_DT                  购买人购买时点上一次风险等级到期日
    ,T1.NEW_RSK_LVL                     客户最新风险等级
    ,T1.NEW_RSK_ASES_DT                 客户最新风险等级测评时间
FROM SJXQ_SJ2023122801_CST_09       T1
LEFT JOIN SJXQ_SJ2023122801_CST_01  T2
ON T1.CST_ID = T2.CST_ID
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_08
UNION all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2023122801_CST_09
UNION all
SElECT '10' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2023122801_CST_10
;
01	14353126	14353126
02	0	0
03	641	420
04	9220	55
05	609	493
06	609	493
07	35496	12002
08	4418453	7931
09	36486	12698
10	36486	12698
*/
***SJ2023122971-5年大额交易清单.sql
-- 数据日期：20190101-20231231
-- 名单范围：台州分行5年累计取现金额超300万的个人、单位客户信息
-- 字段：客户号、名称、取现金额、行业、职业、取现用途、资金来源
--交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2023122971_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122971_CST_01 AS
SELECT  T1.cst_id
    ,T3.dep_act_id      --
    ,T3.dtl_seq_nbr
    ,T3.trx_dt
    ,T3.trx_amt
    ,t3.trx_ccy_cd
    ,t3.act_bal
    ,t4.cd_val_dscr trx_chnl
    ,t5.cd_val_dscr txt_code
    ,t3.smr_dscr
    ,t3.cmt
    ,t3.act_nm
from   edw.dws_bus_dep_act_inf_dd           T1
INNER join  edw.dwd_bus_dep_bal_chg_dtl_di  T3
ON   T1.dep_act_id=T3.dep_act_id
AND  T1.cst_act_id=T3.cst_act_id
AND  T3.csh_ind = '0'           --现金
AND  T3.crd_and_dbt_ind='D'     --支取
AND  T3.dt >='20190101'     AND T3.dt <='20231231'
and  t3.trx_dt>='20190101'  and t3.trx_dt<='20231231'
left join edw.dwd_code_library_dd           t4 --132058 tbl_nm,fld_nm,cd_val 唯一
on t3.trx_chnl_cd = t4.cd_val
and t4.dt='20231231'
left join edw.dwd_code_library_dd           t5 --132058 tbl_nm,fld_nm,cd_val 唯一
on t3.txt_code = t5.cd_val
and t5.dt='20231231'
LEFT JOIN edw.dwd_bus_chnl_cnt_alc_mny_trx_dtl_di T7 --配钞交易明细
ON      T3.tlr_srl_nbr = T7.srl_nbr
AND     T3.trx_dt =  T7.trx_dt
AND     T3.trx_amt = T7.unt_amt
AND     T7.dt >= '20190101'
AND     T7.dt <= '20231231'
AND     T7.par_typ = '抵现'
WHERE   T1.dt='20231231'
and     T1.dep_act_id IS NOT NULL
AND     T1.opn_org like '3301%'                --开户机构 台州分行
-- AND     substr(T2.idt_ctg_cd,1,1)='C'       --行业分类 制造业
AND     T7.srl_nbr  is null                    --非配钞抵现交易
;
--5年300万交易客户
DROP   TABLE IF     EXISTS SJXQ_SJ2023122971_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122971_CST_02 AS
SElECT cst_id,sum(trx_amt) trx_amt_5y
from SJXQ_SJ2023122971_CST_01
group by cst_id
having sum(trx_amt)>=3000000
;
--客户维度基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2023122971_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122971_CST_03 AS
SElECT t1.cst_id,t1.cst_chn_nm,'个人' cst_type
    ,t3.trx_amt_5y
    ,t4.cd_val_dscr ocp_cd
    ,t5.cd_val_dscr idt_cd
from edw.dws_cst_idv_bas_inf_dd	        t1  --个人客户基本信息汇总表
left join edw.dws_cst_bas_inf_dd        t2
on t1.CST_ID=t2.CST_ID
and t2.dt='20231231'
INNER join SJXQ_SJ2023122971_CST_02     t3  --300万交易客户
on t1.cst_id = t3.cst_id
left join edw.dwd_code_library_dd t4        --132058 tbl_nm,fld_nm,cd_val 唯一
on t1.ocp_cd = t4.cd_val
and t4.dt='20231231'
left join edw.dwd_code_library_dd t5        --132058 tbl_nm,fld_nm,cd_val 唯一
on t2.idt_cd = t5.cd_val
and t5.dt='20231231'
where t1.dt='20231231'
union all --企业客户
SElECT t1.cst_id,t1.cst_nm,'企业'
    ,t2.trx_amt_5y
    ,''
    ,t5.cd_val_dscr
from edw.dim_cst_entp_bas_inf_dd        T1  --企业客户基本信息
INNER join SJXQ_SJ2023122971_CST_02     t2  --300万交易客户
on t1.cst_id = t2.cst_id
left join edw.dwd_code_library_dd       t5  --132058 tbl_nm,fld_nm,cd_val 唯一
on t1.idt_ctg_cd = t5.cd_val
and t5.dt='20231231'
where t1.dt='20231231'
;
--大额取现客户交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2023122971_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122971_CST_04 AS
SElECT T1.cst_id        客户号
    ,t1.cst_chn_nm      客户姓名
    ,t1.cst_type        客户类型
    ,T2.dep_act_id      存款账号
    ,T2.trx_dt          交易时间
    ,T2.trx_amt         交易金额
    ,t2.act_bal         账户余额
    ,t2.trx_chnl        交易渠道
    ,t2.txt_code        摘要代码
    ,t2.smr_dscr        摘要描述
    ,t2.cmt             备注
    ,t2.act_nm          账户名称
from SJXQ_SJ2023122971_CST_03 t1
INNER join SJXQ_SJ2023122971_CST_01 t2
on t1.cst_id=t2.cst_id
and t2.dep_act_id is not null
;
DROP   TABLE IF     EXISTS SJXQ_SJ2023122971_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2023122971_CST_05 AS
SElECT cst_id       客户号
    ,cst_chn_nm     客户姓名
    ,cst_type       客户类型
    ,trx_amt_5y     累计交易金额
    ,ocp_cd         职业
    ,idt_cd         行业
from SJXQ_SJ2023122971_CST_03
;
/*
SElECT '1' seq,count(1) cnt, count(DISTINCT cst_id)
from SJXQ_SJ2023122971_CST_01
union all
SElECT '2' seq,count(1) cnt, count(DISTINCT cst_id)
from SJXQ_SJ2023122971_CST_02
union all
SElECT '3' seq,count(1) cnt, count(DISTINCT cst_id)
from SJXQ_SJ2023122971_CST_03
union all
SElECT '4' seq,count(1) cnt, count(DISTINCT 客户号)
from SJXQ_SJ2023122971_CST_04
;
1	4167540	561398
2	3458	3458
3	3458	3458
4	192225	3458
*/***SJ20240053126_长乐村行贷款信息.sql
/*
需求：
1. 时间：2024年5月末
2. 机构：信贷管户机构 长乐村行
3. 客群：全量贷款含历史
4. 字段：合同号 客户号 客户名称 贷款余额 担保方式 婚姻状况 配偶是否签署担保
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024053126_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024053126_CST_01 AS
select t1.busi_ctr_id                            --业务合同编号|C32
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.main_grnt_mth_cd                         --主要担保方式代码|C3
    ,decode(t1.main_grnt_mth_cd,'005','信用','010','保证','020','抵押','040','质押','') main_grnt_mth_nm
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
INNER join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on  t1.busi_ctr_id = t3.busi_ctr_id
and t3.dt = '20240531'
INNER join  edw.dim_hr_org_mng_org_tree_dd  t4 --考核机构树 4481 org_id 唯一
on  t3.acs_org_id = t4.org_id
and t4.dt = '20240531'
and t4.BRC_ORG_NM='福建长乐泰隆村镇银行'
where t1.dt='20240531'
;
-- 只有一个担保且为配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2024053126_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024053126_CST_02 AS
select distinct t1.objectno
        ,t2.ownerid       ---- 权属人编号
        ,t2.ownername     ---- 权属人名称
        ,t3.relativeid
from   edw.loan_guaranty_relative       t1 --业务合同、担保合同与担保物关联表
inner join edw.loan_guaranty_info       t2 --担保物信息表
on t1.guarantyid = t2.guarantyid --担保物编号
and t2.dt = t1.dt
inner join edw.loan_customer_relative   t3 --客户关联信息
on t2.ownerid = t3.customerid
and t3.dt = t1.dt
and t3.relationship = '0301'   -- 关联关系为：配偶
where  t1.dt = '20240531'
and    t2.pawntype is null
and    t1.objectno in (
    select objectno
    from   edw.loan_guaranty_relative --业务合同、担保合同与担保物关联表
    where  dt = '20240531'
    group by objectno
    having count(1) = 1
) --只有一个担保,且为保证担保
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024053126_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024053126_CST_03 AS
select t1.busi_ctr_id                           --业务合同编号
	,t1.cst_id                                  --客户编号
	,t1.cst_nm                                  --客户名称
	,t1.ctr_bal                                 --合同余额
    ,t1.main_grnt_mth_nm                        --主要担保方式代码
    ,t3.mrg_situ_cd	                            --婚姻状况
    ,c1.cd_val_dscr     mrg_situ_nm
    ,case when t2.objectno is not null then '是' else '否' end is_guaranty
from SJXQ_SJ2024053126_CST_01       t1
left join SJXQ_SJ2024053126_CST_02  t2
on  t1.cst_id = t2.relativeid
and t1.busi_ctr_id = t2.objectno
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t3 --客户集市-客户基础-对私客户基础信息
on  t1.cst_id=t3.cst_id
and t3.dt='20240531'
LEFT JOIN edw.dwd_code_library_dd   c1
ON      t3.mrg_situ_cd = c1.cd_val
AND     c1.dt = '20240531'
AND     c1.fld_nm = 'MRG_SITU_CD' --婚姻状况代码
AND     c1.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024053126_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024053126_CST_04 AS
select busi_ctr_id               业务合同编号
	,cst_id                      客户编号
	,cst_nm                      客户名称
	,ctr_bal                     合同余额
    ,main_grnt_mth_nm            主要担保方式代码
    ,mrg_situ_nm	             婚姻状况
    ,is_guaranty                 配偶是否签署担保
from SJXQ_SJ2024053126_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024053126_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct objectno,relativeid) custs
from SJXQ_SJ2024053126_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024053126_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 业务合同编号) custs
from SJXQ_SJ2024053126_CST_04
;
/*
01	11327	11327
02	1475514	1475514
03	11327	11327
04	11327	11327
*/
***SJ20240060331_杭州分行存款交易明细.sql
-- 杭州分行 账户交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024060331_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060331_CST_01 AS
SElECT t1.dep_act_id	            存款账号
    ,t1.dtl_seq_nbr	                明细序号
    ,t1.trx_dt	                    交易日期
    ,t1.trx_tm	                    交易时间
    ,t1.crd_and_dbt_ind	            借贷标志
    ,t1.trx_ccy_cd	                交易币种代码
    ,t1.act_cr_ind	                账户钞汇标志
    ,t1.trx_amt	                    交易金额
    ,t1.act_bal	                    账户余额
    ,t1.cst_act_id	                客户账号
    ,t1.sub_act_seq_nbr	            子账户序号
    ,t1.vch_cls_cd	                凭证种类代码
    ,t1.vch_bch_nbr	                凭证批号
    ,t1.vch_seq_nbr	                凭证序号
    ,t1.txt_code	                摘要代码
    ,t1.smr_dscr	                摘要描述
    ,t1.trx_chnl_cd	                交易渠道代码
    ,t1.ext_trx_no	                外部交易码
    ,t1.int_trx_no	                内部交易码
    ,t1.csh_ind	                    现转标志
    ,t1.cnt_pty_cst_act_id	        对方客户账号
    ,t1.cnt_pty_act_nm	            对方户名
    ,t1.cnt_pty_fin_instt_nm	    对方金融机构名称
    ,t1.cnt_pty_fin_instt_cd	    对方金融机构代码
    ,t1.agn_nm	                    代理人姓名
    ,t1.agn_doc_typ_cd	            代理人证件类型代码
    ,t1.agn_doc_nbr	                代理人证件号码
    ,t1.tlr_srl_nbr	                柜员流水号
    ,t1.trx_bus_org	                交易营业机构
    ,t1.opn_org	                    开户机构
    ,t1.aut_tlr	                    授权柜员
    ,t1.mtk_act_orig_tlr_srl_nbr	错账原柜员流水号
    ,t1.cmt	                        备注
    ,t1.act_nm	                    账户名称
    ,t1.bal_fld_nm	                余额字段名称
    ,t1.prod_id	                    产品编号
    ,t3.pd_cmt	                    产品说明
    ,t1.bnk_bus_id	                银行业务编号
    ,t1.mnt_tlr_id	                维护柜员编号
    ,t1.crad_ind_cd	                卡标志代码
    ,t1.cst_act_typ_cd	            客户账户类型代码
    ,t1.bus_now_trsf_ind	        业务现转标志
    ,decode(t3.pd_trm_dmnd_typ_cd,'0','活期','1','定期')  产品定期活期类型
    ,t3.bal_gl_sync_ind             余额与总账同步标志
from edw.dwd_bus_dep_bal_chg_dtl_di         t1 --存款账户余额发生明细
inner join (
    select distinct t1.DEP_ACT_ID
    from edw.dws_bus_dep_act_mgr_inf_dd	        t1 --存款账户管护汇总信息
    inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
    on  t1.acs_org_id=t2.org_id
    and t2.dt='@@{yyyyMMdd}'
    and t2.brc_org_nm='杭州分行'
    where t1.dt='@@{yyyyMMdd}'
)t2 on t1.DEP_ACT_ID=t2.DEP_ACT_ID
left join edw.dim_bus_dep_pd_bas_inf_dd	    t3 --存款产品基础信息表
on  t1.prod_id=t3.pd_id
and t3.dt='@@{yyyyMMdd}'
where t1.dt between '20240531' and '20240601'
and concat(t1.trx_dt,substr(t1.trx_tm,1,6)) between '20240531210000' and '20240601010000'
;
SELECT count(1) cnt,count(DISTINCT 存款账号,明细序号)
from SJXQ_SJ2024060331_CST_01
;
/*
14972	14972
1. 账户序号、实际账户序号 啥意思？表中只有 子账户序号、对方子账户序号。
2. 会计日期：是那一天？
3. 存款类型：指定期、活期吗？
4. 柜员号 是 柜员流水号 吗？
*/
***SJ20240103171_杭州分行理财客户明细.sql
/*
截至2024年1月3日 杭州分行 辖内 购买过1年期理财的客户明细
1. 限制年龄18-74岁
2. 可参考13023报表逻辑。但是报表展示的都是没有到期的信息，业务需要的是所有信息
3. 限制杭州分行，加一下分支行团队
*/
-- 客户号 客户名字 年龄
DROP   TABLE IF     EXISTS SJXQ_SJ20240103171_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240103171_CST_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,T1.AGE
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20240103'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20240103'
WHERE   T1.DT='20240103'
AND     T1.AGE between 18 AND 74
;
--理财考核汇总信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240103171_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240103171_CST_02 AS
SElECT T1.cst_id,T1.pd_cd,T1.bnk_act_id
from edw.dws_bus_chm_act_mgr_inf_dd         T1
LEFT JOIN edw.DWS_HR_EMPE_INF_DD            T2 --员工基本信息
ON      T1.MGR_ID = T2.EMPE_ID
AND     T2.DT = '20240103'
LEFT JOIN edw.DIM_HR_ORG_MNG_ORG_TREE_DD    T3 --机构树_考核维度
ON      T1.ACS_ORG_ID = T3.ORG_ID
AND     T3.DT = '20240103'
WHERE   T1.DT = '20240103'
AND     T1.PD_TP_CD = '1'  --理财类型代码：0基金1理财
and     T1.MNG_TYP_CD = '1'  --`管户`类型 1考核 2销售
and     T1.ACS_ORG_ID like '3302%'  --杭州分行
GROUP BY T1.cst_id,T1.pd_cd,T1.bnk_act_id
;
-- 自营/代销 理财
DROP   TABLE IF     EXISTS SJXQ_SJ20240103171_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240103171_CST_03 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.CFM_DT --确认日期
    ,T1.TRX_CHNL_CD
    ,T1.TRX_AMT --交易金额
    ,T1.CFM_AMT --确认金额
    ,T1.TRX_LOT --交易份额
    ,T1.CFM_LOT --确认份额
    ,T1.MGR_ID      SALE_EMPE_ID --推荐人员工号
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.BNK_ACT_ID --银行账号
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.PD_FOUND_DT     --产品成立日期
    ,T2.PD_VAL_DT       --产品起息日期
    ,T2.PD_END_DT       --产品结束日期
    ,DATEDIFF(TO_DATE(T2.PD_END_DT, 'yyyyMMdd'),TO_DATE(T2.PD_VAL_DT, 'yyyyMMdd'),'dd') fin_term
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
	,T3.MGR_ID
	,T3.MGR_NM
	,T3.ACS_ORG_ID
	,T3.MGR_BRC_ORG_NM
	,T3.MGR_SBR_ORG_NM
	,T3.MGR_TEM_ORG_NM
	,T3.INVST_MAT_DT
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD     T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD    T2  --产品
ON T1.PD_CD=T2.PD_CD
AND T2.DT='@@{yyyyMMdd}'
INNER join SJXQ_SJ20240103171_CST_02     T3  --管户
ON T1.cst_id = T3.CST_ID AND T1.pd_cd=T3.PD_CD
AND T1.bnk_act_id=T3.BNK_ACT_ID
WHERE T1.DT = '20240103'
AND T1.TRX_DT <= '20240103'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240103171_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240103171_CST_04 AS
SElECT t1.cst_id            客户号
    ,t2.CST_CHN_NM          客户名称
    ,t2.AGE                 年龄
    ,t1.pd_nm               产品名称
    ,t1.TRX_AMT             交易金额
    ,t1.fin_term            产品期限
    ,T1.PD_FOUND_DT         产品成立日期
    ,T1.PD_VAL_DT           产品起息日期
    ,T1.PD_END_DT           产品结束日期
    ,t1.INVST_MAT_DT        投资到期日
	,T1.MGR_ID              管户人工号
	,T1.MGR_NM              管户人名称
	,T1.ACS_ORG_ID          管户机构号
	,T1.MGR_BRC_ORG_NM      分行
	,T1.MGR_SBR_ORG_NM      支行
	,T1.MGR_TEM_ORG_NM      团队
from SJXQ_SJ20240103171_CST_03      t1
INNER join SJXQ_SJ20240103171_CST_01 t2
on t1.cst_id=t2.cst_id
where t1.fin_term between 300 and 400
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20240103171_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20240103171_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20240103171_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ20240103171_CST_04
;
01	13272434	13272434
02	138169	32398
03	559863	30865
04	6985	3495
*/
***SJ2024010506_贵金属开门红清单.sql
/*
1.信用卡的交易数据
客户层面；数据日期2023年1月1日-2023年12月31日；不要村行的数据
贵金属消费记录，取数口径MCC5094
2.借记卡的交易数据
客户层面数据日期2023年1月1日-2023年12月31日
不要村行的数据；贵金属消费记录，取数口径:交易对手包含&quot;黄金&rdquo;&quot;贵金属&quot; &quot;珠宝&rdquo;&ldquo;&quot;金&quot;任一字段但不包含基金'&ldquo;投资&rdquo;字段:
包含&lsquo;饰品&rsquo;且不包含&lsquo;纺织|装饰|服装|汽车|家居|'
包含&lsquo;黄金&rsquo;且不包含&lsquo;幼儿园|大厦|纺织'
不包含&ldquo;工艺品&rdquo;；不包含&ldquo;五金&rdquo;；
包含&quot;金店&quot;且不包含&ldquo;五金|超市|药品&rdquo;
包含&quot;金饰&quot;且不包含&ldquo;装潢&rdquo;
包含&quot;银楼&quot;且不包含&ldquo;科技&rdquo;
*/
--借记卡的交易数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024010506_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010506_CST_01 AS
SELECT T1.dep_act_id,t1.cst_act_id,t1.act_nm
    ,T1.trx_dt,T1.trx_tm,T1.trx_amt
    ,t1.trx_chnl_cd,t2.cd_val_dscr trx_chnl_nm
    ,T1.cnt_pty_cst_act_id,T1.cnt_pty_act_nm
    ,t1.cnt_pty_fin_instt_nm,t1.cmt
    ,case when t1.cnt_pty_act_nm like '%饰品%' and t1.cnt_pty_act_nm not like '%纺织%'
            and t1.cnt_pty_act_nm not like '%装饰%' and t1.cnt_pty_act_nm not like '%服装%'
            and t1.cnt_pty_act_nm not like '%汽车%' and t1.cnt_pty_act_nm not like '%家居%' then '饰品'
        when t1.cnt_pty_act_nm like '%黄金%' and t1.cnt_pty_act_nm not like '%幼儿园%'
            and t1.cnt_pty_act_nm not like '%大厦%' and t1.cnt_pty_act_nm not like '%纺织%' then '黄金'
        when t1.cnt_pty_act_nm like '%金店%' and t1.cnt_pty_act_nm not like '%五金%'
            and t1.cnt_pty_act_nm not like '%超市%' and t1.cnt_pty_act_nm not like '%药品%' then '金店'
        when t1.cnt_pty_act_nm like '%金饰%' and t1.cnt_pty_act_nm not like '%装潢%'    then '金饰'
        when t1.cnt_pty_act_nm like '%银楼%' and t1.cnt_pty_act_nm not like '%科技%'    then '银楼'
        else '' end csm_typ
    ,t3.cst_id
from edw.dwd_bus_dep_bal_chg_dtl_di         t1  --存款账户余额发生明细
left join edw.dwd_code_library_dd           t2
on t1.trx_chnl_cd=t2.cd_val
and t2.dt='20231231'
inner join edw.dws_bus_dep_act_inf_dd       T3  -- 存款账户信息表
on t1.dep_act_id=t3.dep_act_id
and t1.cst_act_id=t3.cst_act_id
and t3.dt = '20231231'
inner join edw.dim_hr_org_mng_org_tree_dd   t4  --考核机构树 4481 org_id 唯一
on      t1.opn_org = t4.org_id
and     t4.brc_org_nm not like '%村镇银行%'
and     t4.dt = '20231231'
where T1.dt between '20230101' and '20231231'
and LENGTH(T1.cnt_pty_act_nm) > 3 and T1.cnt_pty_act_nm not like '%个体%'           --非个人账户
and T1.cnt_pty_act_nm not like '%基金%' and T1.cnt_pty_act_nm not like '%投资%'     --不包含基金,投资
and T1.cnt_pty_act_nm not like '%工艺品%' and T1.cnt_pty_act_nm not like '%五金%'   --不包含工艺品,五金
and T1.cnt_pty_act_nm REGEXP '黄金|金店|饰品|金饰|银楼'
;
--信用卡交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2024010506_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010506_CST_02 AS
SElECT t1.cr_crd_act_id,t1.cr_crd_card_nbr,t1.srl_nbr
    ,T1.trx_typ_cd,T1.trx_typ_dscr  --交易类型描述|C32
    ,t1.trx_amt,t1.trx_dt,t1.trx_tm
    ,t1.mch_typ,C1.cd_val_dscr mch_typ_NM
    ,t1.mch_cd
    ,t1.trx_brn,t1.trx_src,t1.chnl_id
    ,t1.trx_dscr_1,t1.trx_dscr_2
    ,case when t1.trx_dscr_1 like '%饰品%' and t1.trx_dscr_1 not like '%纺织%'
            and t1.trx_dscr_1 not like '%装饰%' and t1.trx_dscr_1 not like '%服装%'
            and t1.trx_dscr_1 not like '%汽车%' and t1.trx_dscr_1 not like '%家居%' then '饰品'
        when t1.trx_dscr_1 like '%黄金%' and t1.trx_dscr_1 not like '%幼儿园%'
            and t1.trx_dscr_1 not like '%大厦%' and t1.trx_dscr_1 not like '%纺织%' then '黄金'
        when t1.trx_dscr_1 like '%金店%' and t1.trx_dscr_1 not like '%五金%'
            and t1.trx_dscr_1 not like '%超市%' and t1.trx_dscr_1 not like '%药品%' then '金店'
        when t1.trx_dscr_1 like '%金饰%' and t1.trx_dscr_1 not like '%装潢%'    then '金饰'
        when t1.trx_dscr_1 like '%银楼%' and t1.trx_dscr_1 not like '%科技%'    then '银楼'
        else '' end csm_typ
    ,T3.CST_ID
from edw.dwd_bus_crd_cr_crd_trx_dtl_di	        t1  --信用卡客户交易流水
left join edw.dwd_code_library_dd               c1
on t1.mch_typ=c1.cd_val
and c1.dt='20231231'
inner join edw.dim_bus_crd_cr_crd_act_inf_dd    T2  --信用卡账户信息
ON T1.cr_crd_act_id=T2.cr_crd_act_id
AND T2.DT='20231231'
inner join edw.dim_bus_crd_cr_crd_inf_dd        t3  --卡信息
on T1.cr_crd_card_nbr=T3.cr_crd_card_nbr
AND T3.DT = '20231231'
inner join edw.dim_hr_org_mng_org_tree_dd       t4  --考核机构树 4481 org_id 唯一
on      t2.act_org_id = t4.org_id
and     t4.brc_org_nm not like '%村镇银行%'
and     t4.dt = '20231231'
where t1.dt between '20230101' and '20231231'
and   t1.mch_typ='5094'
;
--交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024010506_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010506_CST_03 AS
SElECT CST_ID
    ,count(1)       trx_cnt
    ,count(distinct substr(trx_dt,1,6))             trx_mons
    ,sum(trx_amt)   trx_amt
from(
    SElECT cst_id,trx_dt,trx_amt
        ,cnt_pty_act_nm trx_oppo_nm
        ,csm_typ,'借记卡'   data_src
    from SJXQ_SJ2024010506_CST_01
    where csm_typ<>''
    union all
    SElECT cst_id,trx_dt,trx_amt
        ,trx_dscr_1
        ,csm_typ,'信用卡'   data_src
    from SJXQ_SJ2024010506_CST_02
    where csm_typ<>''
)a GROUP by CST_ID
;
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024010506_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010506_CST_04 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,t1.age
    ,decode(t1.gdr_cd,'1','男','2','女','未知') gender
    ,CASE WHEN LENGTH(T1.own_emp_id)>0 THEN 1 ELSE 0 END IS_EMPE
    ,T3.EFE_LOAN_CST_IND
    ,T3.efe_dep_cst_ind,T3.efe_wlth_cst_ind
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
    ,T5.AUM_BAL,T5.aum_year_avg
    ,T6.dmnd_dep_bal
    ,t7.chm_bal_td_cur      --活期理财
    ,T8.GOLD_TRX_TOT_AMT
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20231231'
left join adm_pub.adm_csm_cbas_ind_inf_dd           T3
on T1.CST_ID=T3.cst_id
and T3.dt='20231231'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231231'
LEFT JOIN app_rpt.adm_subl_cst_wlth_bus_inf_dd      T5 --正式客户财富业务信息表
ON T1.CST_ID = T5.CST_ID
AND T5.DT = '20231231'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t6 --存款业务信息表
ON T1.CST_ID = T6.CST_ID
AND T6.DT = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_chm_inf_dd	        t7 --客户理财业务信息表
ON T1.CST_ID = T7.CST_ID
AND T7.DT = '@@{yyyyMMdd}'
left join(
    SELECT CST_ID,SUM(cmdt_pay_unt_prc) GOLD_TRX_TOT_AMT
    FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di	--贵金属交易整合表
    WHERE DT<='20231231'
    GROUP BY CST_ID
)t8 on t1.cst_id=T8.CST_ID
WHERE T1.DT='20231231'
and t4.brc_org_nm not like '%村镇银行%'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024010506_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010506_CST_05 AS
SELECT T1.CST_ID 		客户号
    ,T2.CST_CHN_NM      客户名
    ,T2.AGE             年龄
    ,T2.GENDER          性别
    ,T2.PRM_MGR_ID  	主管户经理工号
    ,T2.PRM_MGR_NM 		主管户经理名称
    ,T2.BRC_ORG_NM 		分行管户机构
    ,T2.SBR_ORG_NM      支行管户机构
    ,T1.trx_cnt 	    交易次数
    ,t1.trx_mons        交易月份数
    ,T1.TRX_AMT         交易金额
    ,T1.trx_oppo_nm     交易对象
    ,T1.CSM_TYP 		交易类别
	,T2.EFE_LOAN_CST_IND 	是否信贷有效户
    ,T2.EFE_DEP_CST_IND     是否存款有效户
    ,T2.EFE_WLTH_CST_IND    是否财富有效户
    ,T2.GOLD_TRX_TOT_AMT 	我行贵金属的购买金额
	,T2.AUM_YEAR_AVG        AUM年日均_20231231
	,T2.AUM_BAL             AUM余额_20231231
    ,T2.DMND_DEP_BAL        最新活期存款余额
    ,T2.CHM_BAL_TD_CUR      最新活期理财余额
	,T2.IS_EMPE             是否我行员工
FROM SJXQ_SJ2024010506_CST_03       T1
LEFT JOIN SJXQ_SJ2024010506_CST_04  T2
ON  T1.CST_ID=T2.CST_ID
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010506_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010506_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010506_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010506_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024010506_CST_05
;
01	26634	4743
02	31299	17350
03	6382	6382
04	12947240	12947240
05	6382	6382
*/
***SJ2024010516_村行财富顾问排查.sql
/*
数据日期:当前最新时点情况数据
数据范围:综合财富平台中客户的管户信息数据
取数口径:财富管户人或财富顾问或财富管户机构是村行或村行员工的客户数据
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST_01 AS
SELECT  CUST_MANAGER,CUST_MANAGER_NAME
FROM    EDW.CFIN_CUST_MANAGER_INFO
WHERE   DT = '@@{yyyyMMdd}'
AND     FUND_CREDENTIAL_FLAG = '1' --是否具备基金销售资质
AND     PROTOCOL_STATUS = '0'  --员工状态正常
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST_02 AS
SELECT T1.CST_ID,T1.CST_NM
    ,T1.WLTH_MNG_MNL_ID
    ,T2.EMPE_NM         WLTH_MNG_MNL_NM
    ,T3.ORG_NM          WLTH_MNG_ORG_NM
    ,T1.WLTH_ADVSR_ID
    ,T4.EMPE_NM         WLTH_ADVSR_NM
    ,T5.ORG_NM          WLTH_ADVSR_ORG_NM
    ,T1.WLTH_MNG_ORG_ID
    ,T6.CPY_ORG_NM
    ,T6.BRC_ORG_ID,T6.BRC_ORG_NM
    ,T6.SBR_ORG_ID,T6.SBR_ORG_NM
    ,T6.TEM_ORG_ID,T6.TEM_ORG_NM
    ,T6.ORG_NM          CST_WLTH_MNG_ORG_NM
    ,CASE WHEN T3.CPY_ORG_ID='999999997'        --财富管户人是村行员工
        OR T5.CPY_ORG_ID='999999997'            --财富顾问是村行员工
        OR T6.CPY_ORG_ID='999999997'            --财富管户机构是村行
        THEN 1     -- 法人机构代码：'999999997','泰隆村镇银行'
        ELSE 0 END IS_SELECT
    ,T7.PRM_MGR_ID
    ,T7.PRM_MGR_NM
    ,T8.ORG_NM      PRM_ORG_NM
FROM EDW.DIM_BUS_CHM_FND_CST_CTR_INF_DD	    T1  --基金客户签约信息表
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            T2  --员工信息汇总
ON      T1.WLTH_MNG_MNL_ID=T2.EMPE_ID
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T3  --考核机构树
ON      T2.ORG_ID = T3.ORG_ID
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            T4  --员工信息汇总
ON      T1.WLTH_ADVSR_ID=T4.EMPE_ID
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T5  --考核机构树
ON      T4.ORG_ID = T5.ORG_ID
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T6  --考核机构树
ON      T1.WLTH_MNG_ORG_ID = T6.ORG_ID
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T7  --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T7.CST_ID
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T8  --考核机构树 4481 ORG_ID 唯一
ON      T7.PRM_ORG_ID = T8.ORG_ID
AND     T8.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
;
--基金客户对应客户账号 58720
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST_03 AS
SElECT distinct cst_id,fnd_act_id CST_ACT_ID
from edw.dim_bus_chm_fnd_act_inf_dd           --基金账户信息表 比申请表多2000左右账户信息
where dt='@@{yyyyMMdd}'
;
/*
fnd_act_id,count(1) cnt
31	11
33	185
60	1
62	58464
63	55
71	3
99	1
SElECT cust_no cst_id,acct_no cst_act_id
from edw.cfin_fund_cust_trans_req_log --基金客户交易流水申请表
where dt<='@@{yyyyMMdd}'
union
SElECT cust_no,acct_no
from edw.cfin_fund_cust_trans_req_log_h
where dt<='@@{yyyyMMdd}'
;*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST_04 AS
SELECT T1.CST_ACT_ID,t1.cst_act_nm,T1.CST_ID
    ,T1.opn_org_id	    --开户机构编号|C12
    ,C1.ORG_NM      OPN_ORG_NM
    -- ,CASE WHEN T2.cst_act_id IS NOT NULL THEN 1 ELSE 0 END IS_FND_TRANS
    -- ,rank() over(partition by T1.CST_ID
    --     order by CASE WHEN T2.cst_act_id IS NOT NULL THEN 1 ELSE 0 END desc) rn
FROM EDW.dim_bus_dep_cst_act_inf_dd    	            T1
INNER join SJXQ_SJ2024010516_CST_03                 T2  --客户账号可以为空
on t1.cst_act_id=t2.cst_act_id
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            C1  --开户机构
ON      T1.opn_org_id = C1.ORG_ID
AND     C1.DT = '@@{yyyyMMdd}'
INNER JOIN SJXQ_SJ2024010516_CST_02                 T5  --满足管户条件客户
ON T1.CST_ID=T5.CST_ID AND T5.IS_SELECT=1
WHERE T1.DT='@@{yyyyMMdd}'
-- AND T1.ACT_STS_CD <> 'C'         --销户也要
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST_05 AS
SElECT T1.CST_ID 			 客户号
    ,T1.CST_NM               客户名称
    ,T4.CST_ACT_ID           结算账户
    ,T4.OPN_ORG_NM           结算账户的开卡机构
    ,T1.TEM_ORG_ID           财富管户机构_团队CD
    ,T1.TEM_ORG_NM           财富管户机构_团队
    ,T1.SBR_ORG_ID           财富管户机构_支行CD
    ,T1.SBR_ORG_NM           财富管户机构_支行
    ,T1.BRC_ORG_ID           财富管户机构_分行CD
    ,T1.BRC_ORG_NM           财富管户机构_分行
    ,T1.CPY_ORG_NM           财富管户机构_总行
    ,T1.WLTH_MNG_MNL_NM      财富管户人
    ,T1.WLTH_MNG_MNL_ID      财富管户人工号
    ,CASE WHEN T2.CUST_MANAGER IS NOT NULL THEN 1 ELSE 0 END    财富管户人是否有基金资质
    ,T1.WLTH_MNG_ORG_NM      财富管户人所属机构
    -- ,''                      财富管户人所属机构是否具备基金代销资质
    ,T1.WLTH_ADVSR_NM        财富顾问
    ,T1.WLTH_ADVSR_ID        财富顾问工号
    ,CASE WHEN T3.CUST_MANAGER IS NOT NULL THEN 1 ELSE 0 END    财富顾问是否有基金资质
    ,T1.WLTH_ADVSR_ORG_NM    财富顾问所属机构
    -- ,''                      财富顾问所属机构是否具备基金代销资质
    ,T1.CST_WLTH_MNG_ORG_NM  客户当前的财富管户机构
    ,T1.PRM_MGR_ID           主管户经理工号
    ,T1.PRM_MGR_NM           主管户经理
    ,T1.PRM_ORG_NM           主管户经理所属机构
    -- ,''                      主管户经理所属机构是否具备基金代销资质
from SJXQ_SJ2024010516_CST_02       T1
left join SJXQ_SJ2024010516_CST_01  t2 on t1.WLTH_MNG_MNL_ID=t2.CUST_MANAGER
left join SJXQ_SJ2024010516_CST_01  t3 on t1.WLTH_ADVSR_ID=t3.CUST_MANAGER
LEFT JOIN SJXQ_SJ2024010516_CST_04  T4 ON T1.CST_ID=T4.CST_ID
WHERE T1.IS_SELECT = 1
;
/*
SElECT '01' seq, count(1) cnt, count(distinct CUST_MANAGER) custs
from SJXQ_SJ2024010516_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010516_CST_02 where IS_SELECT = 1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct CST_ACT_ID) custs
from SJXQ_SJ2024010516_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010516_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024010516_CST_05
;
01	2765	2765
02	665	665
03	58720	58720
04	83	83
05	665	665
*/
***SJ2024010516_村行财富顾问排查2.sql
--是否具备基金销售资质
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST2_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST2_01 AS
SELECT  CUST_MANAGER,CUST_MANAGER_NAME
FROM    EDW.CFIN_CUST_MANAGER_INFO
WHERE   DT = '@@{yyyyMMdd}'
AND     FUND_CREDENTIAL_FLAG = '1' --是否具备基金销售资质
AND     PROTOCOL_STATUS = '0'  --员工状态正常
;
--公募基金市值明细表
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST2_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST2_02 AS
SElECT T1.*
    ,T5.PRM_MGR_ID
    ,T5.PRM_MGR_NM
    ,T6.ORG_NM
    ,row_number() over(partition by T1.cust_no,T1.acct_no order by T1.dt desc) rn --取客户最新交易数据
FROM(
    SElECT cust_no,cust_name,acct_no
        ,T1.cust_wealth_manager            --财富管户人
        ,T1.cust_wealth_manager_name       --财富管户人姓名
        ,T1.cust_wealth_advisor            --财富顾问
        ,T1.cust_wealth_advisor_name       --财富顾问姓名
        ,T1.manage_bank_code               --财富管户人所属总行
        ,T1.manage_bank_code_name          --财富管户人所属总行名称
        ,T1.manage_branch_code             --财富管户人所属分行
        ,T1.manage_branch_code_name        --财富管户人所属分行名称
        ,T1.manage_sub_code                --财富管户人所属支行
        ,T1.manage_sub_code_name           --财富管户人所属支行名称
        ,T1.manage_team                    --财富管户人所属团队
        ,T1.manage_team_name               --财富管户人所属团队名称
        ,T1.advisor_bank_code              --顾问所属总行
        ,T1.advisor_bank_code_name         --顾问所属总行名称
        ,T1.advisor_branch_code            --顾问所属分行
        ,T1.advisor_branch_code_name       --顾问所属分行名称
        ,T1.advisor_sub_code               --顾问所属支行
        ,T1.advisor_sub_code_name          --顾问所属支行名称
        ,T1.advisor_team                   --顾问所属团队
        ,T1.advisor_team_name              --顾问所属团队名称
        ,T1.cust_wealth_org                --管户机构
        ,T2.org_nm                      cust_wealth_org_NM
        ,T1.dt
        ,a2.org_nm                      cust_wealth_manager_org_nm
        ,B2.org_nm                      cust_wealth_advisor_org_nm
        ,case when a2.CPY_ORG_ID='999999997'
            or b2.CPY_ORG_ID='999999997'
            or T2.CPY_ORG_ID='999999997' then 1 else 0 end is_select
    from edw.cfin_fund_market_value_detail      T1  --公募基金市值明细表 遍历dt 取最新一条
    LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            A1  --员工信息汇总
    ON T1.cust_wealth_manager=A1.EMPE_ID
    AND A1.DT = '@@{yyyyMMdd}'
    LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    A2  --机构
    ON      a1.org_id = A2.ORG_ID
    AND     A2.DT = '@@{yyyyMMdd}'
    LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            B1  --员工信息汇总
    ON T1.cust_wealth_advisor=B1.EMPE_ID
    AND B1.DT = '@@{yyyyMMdd}'
    LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    B2  --机构
    ON      B1.org_id = B2.ORG_ID
    AND     B2.DT = '@@{yyyyMMdd}'
    LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T2  --机构
    ON      T1.cust_wealth_org = T2.ORG_ID
    AND     T2.DT = '@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
)t1 LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T5  --客户`主管户`信息
ON      T1.CUST_NO = T5.CST_ID
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T6  --考核机构树
ON      T5.PRM_ORG_ID = T6.ORG_ID
AND     T6.DT = '@@{yyyyMMdd}'
where T1.is_select=1
;
--基金客户对应客户账号
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST2_03 AS
SElECT distinct cst_id,fnd_act_id CST_ACT_ID
from edw.dim_bus_chm_fnd_act_inf_dd           --基金账户信息表 比申请表多2000左右账户信息
where dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST2_04 AS
SELECT T1.CST_ACT_ID,T1.CST_ID
    ,T1.opn_org_id        --开户机构编号|C12
    ,T5.ORG_NM      OPN_ORG_NM
FROM edw.dim_bus_dep_cst_act_inf_dd         T1  --客户存款账户信息
inner join SJXQ_SJ2024010516_CST2_03        t2
on t1.cst_act_id=t2.cst_act_id
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T5  --开户机构
ON      T1.opn_org_id = T5.ORG_ID
AND     T5.DT = '@@{yyyyMMdd}'
WHERE T1.DT='@@{yyyyMMdd}'
-- AND T1.ACT_STS_CD <> 'C'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024010516_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010516_CST2_05 AS
SELECT T1.CUST_NO                    客户号
    ,T1.CUST_NAME                    客户名称
    ,T1.ACCT_NO                      结算账户
    ,T4.OPN_ORG_NM                   结算账户的开卡机构
    ,T1.MANAGE_TEAM_NAME             财富管户机构_团队
    ,T1.MANAGE_SUB_CODE_NAME         财富管户机构_支行
    ,T1.MANAGE_BRANCH_CODE_NAME      财富管户机构_分行
    ,T1.MANAGE_BANK_CODE_NAME        财富管户机构_总行
    ,T1.CUST_WEALTH_MANAGER_NAME     财富管户人
    ,T1.CUST_WEALTH_MANAGER          财富管户人工号
    ,CASE WHEN T2.CUST_MANAGER IS NOT NULL THEN 1 ELSE 0 END 财富管户人是否有基金资质
    ,T1.CUST_WEALTH_MANAGER_ORG_NM   财富管户人所属机构
    ,''                              财富管户人所属机构是否具备基金代销资质
    ,T1.CUST_WEALTH_ADVISOR          财富顾问
    ,T1.CUST_WEALTH_ADVISOR_NAME     财富顾问工号
    ,CASE WHEN T3.CUST_MANAGER IS NOT NULL THEN 1 ELSE 0 END 财富顾问是否有基金资质
    ,T1.CUST_WEALTH_ADVISOR_ORG_NM   财富顾问所属机构
    ,''                              财富顾问所属机构是否具备基金代销资质
    ,T1.CUST_WEALTH_ORG_NM           客户当前的财富管户机构
    ,T1.PRM_MGR_ID                   主管户经理工号
    ,T1.PRM_MGR_NM                   主管户经理
    ,T1.ORG_NM                       主管户经理所属机构
    ,''                              主管户经理所属机构是否具备基金代销资质
FROM SJXQ_SJ2024010516_CST2_02      T1
LEFT JOIN SJXQ_SJ2024010516_CST2_01 T2 ON T1.CUST_WEALTH_MANAGER=T2.CUST_MANAGER
LEFT JOIN SJXQ_SJ2024010516_CST2_01 T3 ON T1.CUST_WEALTH_ADVISOR=T3.CUST_MANAGER
LEFT JOIN SJXQ_SJ2024010516_CST2_04 T4 ON T1.CUST_NO=T4.CST_ID
where t1.rn=1
;
SElECT '01' seq, count(1) cnt, count(distinct CUST_MANAGER) custs
from SJXQ_SJ2024010516_CST2_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cust_no) custs
from SJXQ_SJ2024010516_CST2_02 where rn=1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct CST_ACT_ID) custs
from SJXQ_SJ2024010516_CST2_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct CST_ID) custs
from SJXQ_SJ2024010516_CST2_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024010516_CST2_05
;
/*
01	2768	2768
02	62	62          --持有基金市值客户数较少
03	58720	58720
04	58293	58292
05	62	62
*/
***SJ2024010822-金华分行账户排查.sql
/*
电子银行=手机银行+网上银行
个人存量客户信息：开户日期2010年1月1日至2023年12月31日开立的账户状态为正常的个人账户
取数日期 @@{yyyyMMdd}
数据范围 开户日期2010年1月1日至2023年12月31日 账户状态为正常 个人账户
--注意：row_number\金华分行
*/
--止付
DROP   TABLE IF     EXISTS SJXQ_SJ2024010822_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010822_CST_01 AS
SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
    ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t1.frz_cls_cd = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt='@@{yyyyMMdd}'
WHERE   t1.DT = '@@{yyyyMMdd}'
AND     t1.FRZ_SRC_CD='2'  --止付
AND     t1.NFRZ_IND = '0'
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ2024010822_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010822_CST_02 AS
SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
    ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.FRZ_SRC_CD='1'  --冻结
AND     T1.NFRZ_IND = '0'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024010822_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010822_CST_03 AS
SELECT  T1.cst_id                        AS 客户号
        ,T1.act_nm                       AS 账户名称
        ,T1.cst_act_id                   AS 客户账号
        ,T1.dep_act_id                   AS 存款账号
        ,T1.opn_dt                       AS 开户日期
        ,T1.act_dstr_act_dt              as 销户日期
        ,substr(T3.doc_nbr, 1, 6)        AS 证件号前6位
        ,2024 - SUBSTR(T3.doc_nbr, 7, 4) AS 年龄
        ,concat(substr(regexp_replace(T3.reg_adr, '\\s|,', ''), 1, greatest(length(regexp_replace(T3.reg_adr, '\\s|,', '')) - 6, 0)), '******') 户籍地址脱敏
        ,CASE
            WHEN T3.reg_adr LIKE '%省%'
                THEN CONCAT(substring_index(T3.reg_adr, '省', 1), '省')
            WHEN T3.reg_adr LIKE '%市%' AND T3.reg_adr REGEXP '上海|重庆|天津|北京'
                THEN CONCAT(substring_index(T3.reg_adr, '市', 1), '市')
            WHEN T3.reg_adr REGEXP '内蒙古|广西|西藏|宁夏|新疆'
                THEN CONCAT(substr(T3.reg_adr, 1, 2), '自治区')
            WHEN T3.reg_adr REGEXP '内蒙古'
                THEN CONCAT(substr(T3.reg_adr, 1, 3), '自治区')
            WHEN T3.reg_adr LIKE '%特别行政区%' AND T3.reg_adr REGEXP '香港|澳门'
                THEN CONCAT(substring_index(T3.reg_adr, '特别行政区', 1), '特别行政区')
            WHEN T3.reg_adr LIKE '%杭州市%'
                THEN '浙江省'
            WHEN T3.reg_adr LIKE '%武汉市%'
                THEN '湖北省'
            ELSE T3.reg_adr
         END                             AS 户籍省份
        ,CASE
           WHEN T18.kehuhaoo IS NULL OR T18.kehuhaoo <> '' THEN '否'
           ELSE '是'
         END                             AS 新柜面标签是否工资户
        ,T7.job_unt_nm                   as 工作单位名称
        ,CASE
           WHEN A7.CST_ACT_ID IS NOT NULL THEN '是'
           ELSE '否'
         END                             AS 20230101以来是否有过工资流水
        -- ,CASE
        --    WHEN T91.cst_id IS NULL     THEN '否'
        --    WHEN T91.cst_id IS NOT NULL THEN '是'
        --    ELSE '其他'
        --  END                             AS 网上银行是否签约
        -- ,substr(T91.客户网银开通时间, 1, 8) 客户网银开通日期
        -- ,T91.网银单笔限额
        -- ,T91.网银日累计限额
        -- ,CASE
        --    WHEN T9.cst_id IS NULL     THEN '否'
        --    WHEN T9.cst_id IS NOT NULL THEN '是'
        --    ELSE '其他'
        --  END                             AS 手机银行是否签约
        -- ,substr(T9.客户手机开通时间, 1, 8) 客户手机开通日期
        -- ,T9.手机单笔限额
        -- ,T9.手机日累计限额
        -- ,nvl(T9.手机单笔限额,0) + nvl(T91.网银单笔限额,0)       as 电子银行单笔限额
        -- ,nvl(T9.手机日累计限额,0) + nvl(T91.网银日累计限额,0)   as 电子银行日累计限额
        ,CASE
           WHEN T8.客户账号 IS NULL     THEN '否'
           WHEN T8.客户账号 IS NOT NULL THEN '是'
           ELSE '其他'
         END                             AS 是否设置非柜限额
        ,T8.单笔限额                      AS 非柜单笔限额
        ,T8.累计限额                      AS 非柜日累计限额
        ,T1.ACT_STS_CD                   AS 账户状态代码
        ,T19.cd_val_dscr                 AS 账户状态
        ,CASE
           WHEN T12.cst_act_id IS NOT NULL THEN '是'
           ELSE '否'
         END                             AS 是否关闭非柜面
        ,T12.lmt_cmt                     AS 关闭原因
        ,CASE
           WHEN T6.cst_act_id IS NOT NULL THEN '是'
           ELSE '否'
         END                             AS 是否冻结
        ,T6.frz_dt                       AS 冻结日期
        ,T6.frz_cls                      AS 冻结种类
        ,T6.frz_rsn                      AS 冻结原因
        ,CASE
           WHEN T11.cst_act_id IS NOT NULL THEN '是'
           ELSE '否'
         END                             AS 是否止付
        ,T11.frz_dt                      AS 止付日期
        ,T11.act_stop_pmt_typ_cd         AS 止付类型代码
        ,T11.act_stop_pmt_typ            AS 止付类型
        ,T11.frz_cls_cd                  AS 止付种类代码
        ,T11.frz_cls                     AS 止付种类
        ,T11.frz_rsn                     AS 止付原因
        ,T1.opn_org                      AS 开户机构编号
        ,T2.org_nm                       AS 开户机构名称
        ,T2.sbr_org_nm                   AS 开户支行名称
        ,T4.mgr_id                       AS 存款管户客户经理编号
        ,T5.empe_nm                      AS 存款管户客户经理名称
        ,T4.acs_org_id                   AS 存款管户客户经理考核机构编号
        ,A4.org_nm                       AS 存款管户客户经理考核机构
        ,A4.sbr_org_nm                   AS 存款管户客户经理考核支行
        ,t23.last_12_mon_own_ftp_ctb     as FTP
FROM    edw.dws_bus_dep_act_inf_dd              T1 --存款账户信息表
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd     T2 --开户机构
ON      T1.opn_org = T2.org_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd             T3
ON      T1.cst_id = T3.cst_id
AND     T3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T4
ON      T1.cst_act_id = T4.cst_act_id
AND     T4.dt = '@@{yyyyMMdd}'
AND     T4.frs_ctc_ind = '1' --第一联系人标志
LEFT JOIN    edw.dws_hr_empe_inf_dd             T5
ON      T4.mgr_id = T5.empe_id
AND     T5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd     A4 --存款管户考核机构
ON      T4.acs_org_id = A4.org_id
AND     A4.dt = '@@{yyyyMMdd}'
LEFT JOIN    SJXQ_SJ2024010822_CST_02           t6 --冻结
on T1.cst_act_id = T6.cst_act_id AND T6.RN = 1
LEFT JOIN    (
            SELECT  A.cst_act_id
                    ,SUM(IF(b.trx_dt >= '20230101', 1, 0)) AS thr_month_numbers
            FROM    edw.DIM_BUS_DEP_ACT_INF_DD A
            INNER JOIN    edw.DWD_BUS_DEP_BAL_CHG_DTL_DI B
            ON      A.DEP_ACT_ID = B.DEP_ACT_ID
            AND     A.CST_ACT_ID = B.CST_ACT_ID
            and     CONCAT(B.smr_dscr, B.cmt) REGEXP '工资'
            AND     B.dt >= '20210101'
            WHERE   A.dt = '@@{yyyyMMdd}'
            AND     A.ACT_CTG_CD_2 IN ( '301' , '302' , '303' ) --I、II、III类账户
            GROUP BY A.cst_act_id
        ) A7
ON      T1.cst_act_id = A7.CST_ACT_ID
AND     A7.thr_month_numbers > 0
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd T7
ON      T1.cst_id = T7.cst_id
AND     T7.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  cengcgjz 客户账号
                         ,danciedu 单笔限额
                         ,leijiedu 累计限额
                 FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     zhxeleix = '2'
                 AND     shijbhao = 'FGMXIANE' -- 非柜面限额
                 AND     edkzzhqi = '1D'
 -- 日限额
             ) T8
ON      T1.cst_act_id = T8.客户账号
-- LEFT JOIN    lab_bigdata_dev.tmp_yxw_20230324_s_p1 T9
-- ON      T1.cst_id = T9.cst_id
-- LEFT JOIN    lab_bigdata_dev.tmp_hyx_20230324_s_w1 T91
-- ON      T1.cst_id = T91.cst_id
LEFT JOIN    SJXQ_SJ2024010822_CST_01           T11 --止付
on T1.cst_act_id = T11.cst_act_id AND T11.RN = 1
LEFT JOIN    (
            SELECT  c1 . *
            FROM    (
                        SELECT  *
                                ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
                        FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
                        WHERE   DT = '@@{yyyyMMdd}'
                        AND     ACT_THRS_TYP = '2' --暂停非柜面
                        AND     evt_id = 'DPDRAW'
                    ) c1
            WHERE   c1.rn = 1
        ) T12 --账户额度控制
ON      T1.cst_act_id = T12.cst_act_id
LEFT JOIN    edw.core_kcpb_zhbzxx T18
ON      T1.cst_id = T18.kehuhaoo
AND     T18.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  cd_val
                         ,cd_val_dscr
                 FROM    edw.dwd_code_library_dd
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     cd_nm LIKE '%存款账户状态%'
                 AND     tbl_nm = 'DWS_BUS_DEP_ACT_INF_DD'
             ) T19
ON      T1.act_sts_cd = T19.cd_val
left join adm_pub.adm_csm_cbus_ftp_inf_dd	t23         --客户集市-业务信息-客户FTP业务
on t1.cst_id = t23.cst_id
and t23.dt = '@@{yyyyMMdd}'
WHERE   T1.ACT_CTG_CD_2 IN ( '301' , '302' , '303' ) -- I、II、III类账户 个人账户
AND     T1.STL_ACT_IND = '1'    --结算账户
AND     T1.opn_dt >= '20100101'
AND     T1.opn_dt <= '20231231'
AND     T1.DT = '@@{yyyyMMdd}'
AND     T1.opn_org LIKE '3308%' --金华分行
AND     T1.ACT_STS_CD = 'A'     --账户状态为正常
;
***SJ2024010901_台州分行非有效户.sql
--近6个月均为非有效户
DROP   TABLE IF     EXISTS SJXQ_SJ2024010901_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010901_CST_01 AS
SElECT cst_id,max(efe_cst_ind) efe_cst_ind
from adm_pub.adm_csm_cbas_ind_inf_dd        t1 	    --客户基础标识信息
where t1.dt between '20230701' and '20231231'
group by cst_id
;
--是否购买过定期产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024010901_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010901_CST_02 AS
SELECT t1.cst_id                   --定期理财
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd
and t2.dt='20231231'
WHERE t1.dt = '20231231'
union
SELECT CST_ID					    --定期存款
FROM EDW.DWS_BUS_DEP_ACT_INF_DD		--存款账户信息表
WHERE DT='20231231'
AND MTU_DT>'18991231' and dep_trm<>'0D' --定期存款
;
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024010901_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010901_CST_03 AS
SElECT t1.cst_id,t1.cst_chn_nm
    ,t1.doc_nbr
    ,t8.rsk_grd	            --风险等级
    ,t1.mbl_nbr             --手机号码
    ,t1.fml_tel_nbr         --家庭电话
    ,t1.cmn_adr             --通讯地址
    ,t1.fml_adr             --家庭地址
    ,t2.efe_cst_ind
    ,t2.qefe_dep_cst_ind	--准有效存款户标识
    ,t2.qefe_chm_cst_ind	--准有效财富户
    ,t2.efe_loan_cst_ind
    ,t2.qefe_loan_cst_ind	--准有效贷款户标识
    ,t3.dep_bal_mon_avg	    --存款余额月日均
    ,T4.PRM_MGR_ID,T4.PRM_MGR_NM,T4.PRM_ORG_ID
    ,T5.BRC_ORG_NM,T5.SBR_ORG_NM,T5.TEM_ORG_NM
    ,T6.is_risk_cst         --是否风险客户
    ,T7.ACT_CNT
from edw.dws_cst_bas_inf_dd	                t1  --客户基础信息汇总表
inner join adm_pub.adm_csm_cbas_ind_inf_dd  t2  --
on t1.cst_id=t2.cst_id
and T2.DT = '20231231'
inner join adm_pub.adm_csm_cbus_dep_inf_dd	t3  --客户存款业务信息表
on t1.cst_id=t3.cst_id
AND T3.DT = '20231231'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd      t4  --客户`主管户`信息
on      t1.cst_id = t4.cst_id
and     t4.dt = '20231231'
and     (t4.prm_org_id like  '3301%' or  t4.prm_org_id='999900099') --台州分行、总行营业部
-- and     (t4.prm_org_id like  '3301%' or  t4.prm_org_id like '9999%') --台州分行、总行营业部、总行清算中心
left join edw.dim_hr_org_mng_org_tree_dd                t5  --考核机构树
on      t4.prm_org_id = t5.org_id
and     t5.dt = '20231231'
left JOIN adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd    T6
ON T1.cst_id=T6.cst_id
AND T6.DT = '20231231'
LEFT JOIN(
    SELECT cst_id,COUNT(1) ACT_CNT
    FROM edw.dws_bus_dep_act_inf_dd    			--存款账户信息汇总
    WHERE DT = '20231231' AND ACT_STS_CD <> 'C'
    group BY cst_id
)T7 on t1.cst_id=t7.cst_id
left join edw.dws_cst_idv_bas_inf_dd                    t8
on t1.cst_id = t8.cst_id
and t8.dt='20231231'
where t1.dt = '20231231'
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024010901_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010901_CST_04 AS
SELECT T1.CST_ID            客户号
    ,T3.CST_CHN_NM          客户名称
    ,T3.PRM_MGR_ID          主管户客户经理工号
    ,T3.PRM_MGR_NM          主管户客户经理姓名
    ,T3.PRM_ORG_ID          主管户机构号
    ,T3.BRC_ORG_NM          主管户分行
    ,T3.SBR_ORG_NM          主管户支行
    ,T3.TEM_ORG_NM          主管户团队
    ,CASE WHEN T2.CST_ID IS NOT NULL THEN 1 ELSE 0 END 是否购买过定期产品
    ,T3.QEFE_DEP_CST_IND	准有效存款户标识
    ,T3.QEFE_CHM_CST_IND	准有效财富户
    ,T3.EFE_LOAN_CST_IND    有效信贷户标识
    ,T3.QEFE_LOAN_CST_IND	准有效贷款户标识
    ,T3.RSK_GRD	            风险等级
    ,T3.IS_RISK_CST         是否风险客户
    ,T3.EFE_CST_IND 		近6个月均为非有效户
    ,T3.DEP_BAL_MON_AVG	    存款余额月日均
    ,T3.MBL_NBR             手机号码
    ,T3.FML_TEL_NBR         家庭电话
    ,T3.FML_ADR 			家庭地址
    ,T3.CMN_ADR             通讯地址
    ,T3.ACT_CNT 			有效存款账户数量
FROM SJXQ_SJ2024010901_CST_01       T1
LEFT JOIN SJXQ_SJ2024010901_CST_02  T2 ON T1.CST_ID=T2.CST_ID
INNER JOIN SJXQ_SJ2024010901_CST_03  T3 ON T1.CST_ID=T3.CST_ID
WHERE T1.EFE_CST_IND<>'1' --近6个月均为非有效户
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010901_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010901_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010901_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024010901_CST_04
;
01	16065856	16065856
02	1707541	1707541
03	3699993	3699993
04	3096953 3096953
*/***SJ2024010916-福建村行存款明细.sql
-- 开户行：356199999	福建政和泰隆村镇**
-- 存款账户基本信息汇总表；客户账户管户信息表；存款产品信息表；
--存款账户管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024010916_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010916_CST_01 AS
select t1.cst_id,t1.cst_act_id
from edw.dwd_bus_dep_cst_act_mgr_inf_dd     t1      --存款客户账户`管户`信息
left join edw.dws_hr_empe_inf_dd            t2      --员工信息汇总
on  T1.mgr_id=T2.empe_id
AND T2.DT='20240109'
INNER join edw.dim_hr_org_mng_org_tree_dd   t4      --考核机构树
on      t1.acs_org_id = t4.org_id
and     t4.dt = '20240109'
AND     T4.BRC_ORG_ID='356199999'   --福建政和泰隆村镇
where t1.dt='20240109'
GROUP by t1.cst_id,t1.cst_act_id
;
--存款账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024010916_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010916_CST_02 AS
SElECT T1.dep_act_id,T1.cst_act_id,T1.cst_id,T1.ACT_NM
    ,T1.OPN_DT,T1.INT_VAL_DT,T1.MTU_DT
    ,cur_act_bal,gl_bal
    ,C1.cd_val_dscr PROD_NM
    ,T1.act_sts_cd
    ,decode(T1.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结'
        ,'F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
    ,t1.ACT_CTG_CD_2
    ,decode(t1.ACT_CTG_CD_2,'301','I类户','302','II类户','303','III类户') act_typ
from edw.dws_bus_dep_act_inf_dd     T1  --存款账户信息汇总 dep_act_id
INNER JOIN EDW.DWD_CODE_LIBRARY_DD  C1
ON T1.prod_id=C1.CD_VAL
AND C1.DT='20240109'
AND C1.TBL_NM='DIM_BUS_DEP_ACT_INF_DD'
AND C1.FLD_NM='PROD_ID'
and c1.cd_val_dscr REGEXP '成长|长寿|泰隆一本'
where T1.dt = '20240109'
AND T1.OPN_DT between '20171120' AND '20240109'     --开户日期
--ACT_STS_CD <> 'C' and STL_ACT_IND = '1' --非销户且为结算账户 cst_act_id 99%近似唯一
--ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' )    --账户状态正常（不确定）
;
--结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024010916_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024010916_CST_03 AS
select t1.cst_id        客户号
    ,t3.ACT_NM          账户名称
    ,t3.cst_act_id      客户账号
    ,T3.dep_act_id          存款账号
    ,t3.act_sts             账户状态
    ,t3.act_typ             账户类型
    ,T3.PROD_NM             产品名称
    ,T3.cur_act_bal         当前账户余额
    ,T3.gl_bal              账户总账余额
    ,T3.OPN_DT              开户日期
    ,T3.INT_VAL_DT             起息日
    ,T3.MTU_DT                 到期日
    ,T2.dep_act_mng_mgr        管户经理
    ,T2.dep_act_mng_brc_org    管户分行
    ,T2.dep_act_mng_sbr_org    管户支行
    ,case when length(T1.own_emp_id)>0 then 1 else 0 end    是否行员
    ,case when t4.cst_id is not null then 1 else 0 end      是否员工直系亲属
from   edw.dim_cst_idv_bas_inf_dd   T1
INNER JOIN SJXQ_SJ2024010916_CST_01 T2 --管户信息
ON T1.cst_id=T2.cst_id
INNER JOIN SJXQ_SJ2024010916_CST_02 T3 --账户信息
ON T2.cst_id=T3.cst_id AND T2.cst_act_id=T3.cst_act_id
left join (--员工直系亲属
    SELECT DISTINCT  c2.cst_id
    from       edw.dim_hr_empe_invl_pty_inf_dd c1   --员工家庭成员与关联人信息
    inner join edw.dws_cst_bas_inf_dd        c2
    on c1.invl_pty_id_card_id=c2.doc_nbr
    AND   c2.dt='20240109'--身份证关联
    where  c1.dt='20240109'
    -- 配偶、父母、子女、兄弟姐妹、祖父母或外祖父母、孙子、孙女，或外孙子、外孙女、儿媳或女婿、公婆或岳父母、其他血亲、其他姻亲
) T4  on  T1.cst_id=T4.cst_id
where  T1.dt='20240109'
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024010916_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024010916_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct 客户账号) custs
from SJXQ_SJ2024010916_CST_03
;
01	75358	57517
02	1216015	444571
03	14784	5568
*/
***SJ2024011066_贵金属开门红数据监测1.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-01-10 14:07:58
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- ** SJ2024011066
-- **********************************************************************
-- 01 贵金属整合表
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD AS
  SELECT
    DT                    AS 查询日期
    ,PVD_NM               AS 商铺名称
    ,ORD_ID               AS 订单号
    ,USR_NM               AS 买家名称
    ,CST_ID               AS 客户号
    ,CST_NM               AS 真实姓名
    ,PST_MTH              AS 邮寄方式
    ,ORD_TM               AS 订单时间
    ,PMT_TM               AS 付款时间
    ,PMT_MTH              AS 支付方式
    ,CHNL_NM              AS 渠道
    ,ORD_STS              AS 订单状态
    ,CMDT_NM              AS 商品名称
    ,CMDT_SPEC            AS 商品规格
    ,QTY                  AS 购买数量
    ,GOODS_TYP            AS 商品分类
    ,GOODS_RETURN_STATUS  AS 商品退款状态
    ,CMDT_UNT_PRC         AS 商品现金单价
    ,CMDT_PAY_UNT_PRC     AS 商品应付现金总额
    ,CMSN_TYP             AS 佣金类型
    ,MID_INC_RTO          AS 佣金比例_金额
    ,MID_INC_TOT_AMT      AS 佣金总额
    ,RCM_PSN_ID           AS 推荐人工号
    ,RCM_PSN_NM           AS 推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID  AS 推荐人所属部门_团队ID
    ,RCM_PSN_AFL_DEPT     AS 推荐人所属部门_团队
    ,RCM_PSN_AFL_SUB_BRN  AS 推荐人所属支行
    ,RCM_PSN_AFL_BRN      AS 推荐人所属分行
    ,DATA_SRC             AS 数据来源
FROM  adm_pub.ADM_PUB_CST_NOB_MET_TRX_DTL_DI A
WHERE A.dt >= '20240101'
AND  A.dt <= '@@{yyyyMMdd}'
UNION ALL
SELECT
    DT                    AS 查询日期
    ,PVD_NM               AS 商铺名称
    ,ORD_ID               AS 订单号
    ,USR_NM               AS 买家名称
    ,CST_ID               AS 客户号
    ,CST_NM               AS 真实姓名
    ,PST_MTH              AS 邮寄方式
    ,ORD_TM               AS 订单时间
    ,PMT_TM               AS 付款时间
    ,PMT_MTH              AS 支付方式
    ,CHNL_NM              AS 渠道
    ,ORD_STS              AS 订单状态
    ,CMDT_NM              AS 商品名称
    ,CMDT_SPEC            AS 商品规格
    ,QTY                  AS 购买数量
    ,GOODS_TYP            AS 商品分类
    ,GOODS_RETURN_STATUS  AS 商品退款状态
    ,CMDT_UNT_PRC         AS 商品现金单价
    ,CMDT_PAY_UNT_PRC     AS 商品应付现金总额
    ,CMSN_TYP             AS 佣金类型
    ,MID_INC_RTO          AS 佣金比例_金额
    ,MID_INC_TOT_AMT      AS 佣金总额
    ,RCM_PSN_ID           AS 推荐人工号
    ,RCM_PSN_NM           AS 推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID  AS 推荐人所属部门_团队ID
    ,RCM_PSN_AFL_DEPT     AS 推荐人所属部门_团队
    ,RCM_PSN_AFL_SUB_BRN  AS 推荐人所属支行
    ,RCM_PSN_AFL_BRN      AS 推荐人所属分行
    ,DATA_SRC             AS 数据来源
FROM  adm_pub.ADM_PUB_CST_NOB_MET_TRX_HAND_DI A
WHERE A.dt >= '20240101'
AND  A.dt <= '@@{yyyyMMdd}';
-- 04 个人
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_EMPE_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_EMPE_01 AS
SELECT  *
        ,CASE
            WHEN 中收排名 = 1 AND 销售中收 >= 300000    THEN '50克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 250000    THEN '30克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 200000    THEN '20克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 = 1 AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 = 1 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 = 1 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 = 1 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 = 1 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 250000    THEN '30克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 200000    THEN '20克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 200000    THEN '20克金条'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 68 AND 中收排名 <= 117 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 68 AND 中收排名 <= 117 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 68 AND 中收排名 <= 117 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 118 AND 中收排名 <= 197 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 118 AND 中收排名 <= 197 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 198 AND 中收排名 <= 347 AND 销售中收 >= 10000     THEN '200油卡'
           ELSE ''
         END AS 入围奖励
FROM    (
            SELECT  t1.推荐人所属分行
                    ,t1.推荐人所属支行
                    ,t1.推荐人工号
                    ,t1.推荐人姓名
                    ,sum(t1.商品应付现金总额)                                 AS 销售规模
                    ,sum(t1.佣金总额)                                     AS 销售中收
                    ,row_number() OVER ( ORDER BY sum(t1.佣金总额) DESC ) AS 中收排名
            FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD t1
            WHERE   t1.查询日期 >= '20240101'
            AND     t1.查询日期 <= '@@{yyyyMMdd}'
            AND     t1.推荐人所属分行 REGEXP '分行'
            GROUP BY t1.推荐人所属分行 , t1.推荐人所属支行 , t1.推荐人工号 , t1.推荐人姓名
        ) T1;
-- 03 支行
-- 支行人力数据 雷萍提供人力数据，已复核数仓数据
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_EMPE_NUM PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_EMPE_NUM AS
-- SELECT  t.empe_id
--         ,t.org_id
--         ,t.org_nm
--         ,t1.sbr_org_id
--         ,t1.sbr_org_nm
--         ,t1.brc_org_id
--         ,t1.brc_org_nm
SELECT  t1.sbr_org_id
        ,t1.sbr_org_nm
        ,count(DISTINCT empe_id) empe_num
FROM    edw.dws_hr_empe_inf_dd t
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t1
ON      t.org_id = t1.org_id
AND     t1.dt = '@@{yyyyMMdd}'
WHERE   t.dt = '@@{yyyyMMdd}'
AND     t.HC_TYP_CD = '1' --编制内
AND     t.lbr_typ_cd <> '07' --剔除合作用工
GROUP BY t1.sbr_org_id, t1.sbr_org_nm
;
-- 支行数据
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_01 AS
SELECT  *
        ,CASE
           WHEN 中收达成排名 = 1 AND 销售中收 >= 700000                    THEN '特等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 600000                    THEN '一等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 500000                    THEN '二等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 300000                    THEN '三等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 200000                    THEN '四等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 100000                    THEN '优胜奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 600000   THEN '一等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 500000   THEN '二等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 300000   THEN '三等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 200000   THEN '四等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 100000   THEN '优胜奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 500000   THEN '二等奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 300000   THEN '三等奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 200000   THEN '四等奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 100000   THEN '优胜奖'
           WHEN 中收达成排名 >= 7 AND 中收达成排名 <= 11 AND 销售中收 >= 300000  THEN '三等奖'
           WHEN 中收达成排名 >= 7 AND 中收达成排名 <= 11 AND 销售中收 >= 200000  THEN '四等奖'
           WHEN 中收达成排名 >= 7 AND 中收达成排名 <= 11 AND 销售中收 >= 100000  THEN '优胜奖'
           WHEN 中收达成排名 >= 12 AND 中收达成排名 <= 19 AND 销售中收 >= 200000 THEN '四等奖'
           WHEN 中收达成排名 >= 12 AND 中收达成排名 <= 19 AND 销售中收 >= 100000 THEN '优胜奖'
           WHEN 中收达成排名 >= 20 AND 中收达成排名 <= 49 AND 销售中收 >= 100000 THEN '优胜奖'
           ELSE ''
         END AS 入围奖项
FROM    (
            SELECT  T1.推荐人所属分行                                   AS 分行
                    ,T1.推荐人所属支行                                  AS 支行
                    ,T2.empe_num                                 AS 1月10日在职销售人力
                    ,t1.销售规模
                    ,t1.销售中收
                    ,t1.破冰人数
                    ,ROUND(t1.破冰人数 / t2.empe_num, 2)             AS 人员破冰率
                    ,row_number() OVER ( ORDER BY t1.销售中收 DESC ) AS 中收达成排名
            FROM    (
                        SELECT  推荐人所属分行
                                ,推荐人所属支行
                                ,sum(商品应付现金总额)         AS 销售规模
                                ,sum(佣金总额)             AS 销售中收
                                ,count(DISTINCT 推荐人工号) AS 破冰人数
                        FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD
                        WHERE   查询日期 >= '20240101'
                        AND     查询日期 <= '@@{yyyyMMdd}'
                        AND     推荐人所属分行 REGEXP '分行'
                        GROUP BY 推荐人所属分行 , 推荐人所属支行
                    ) T1
            LEFT JOIN    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_EMPE_NUM T2
            ON      t1.推荐人所属支行 = t2.sbr_org_nm
        ) t1;
-- 02 分行
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_01 AS
SELECT  A.分行
        ,A.当日规模
        ,A.当日中收
        ,A.当月规模
        ,A.当月中收
        ,A.1月1日至今规模
        ,A.1月1日至今中收
        ,A.1月1日至今件数
        ,D.empe_num AS 当前在职销售人力
        ,A.1月1日至今破冰人数
        ,ROUND(A.1月1日至今破冰人数/D.empe_num,2) AS 员工破冰率
        ,D.sbr_org_num AS 当前支行数
        ,A.1月1日至今破冰支行数
        ,ROUND(A.1月1日至今破冰支行数/D.sbr_org_num,2) AS 支行破冰率
        ,A.1月1日至今件均规模元
        ,A.1月1日至今网均规模元
        ,CASE
           WHEN 分行中收排名 = 1 AND 1月1日至今中收 >= 5000000                  THEN '一等奖'
           WHEN 分行中收排名 = 1 AND 1月1日至今中收 >= 3000000                  THEN '二等奖'
           WHEN 分行中收排名 = 1 AND 1月1日至今中收 >= 1000000                  THEN '三等奖'
           WHEN 分行中收排名 >= 2 AND 分行中收排名 <= 3 AND 1月1日至今中收 >= 3000000 THEN '二等奖'
           WHEN 分行中收排名 >= 2 AND 分行中收排名 <= 3 AND 1月1日至今中收 >= 1000000 THEN '三等奖'
           WHEN 分行中收排名 >= 4 AND 分行中收排名 <= 6 AND 1月1日至今中收 >= 1000000 THEN '三等奖'
           ELSE ''
         END AS 优秀专员奖
        ,b.营销达人奖入围奖励人数
        ,c.优秀机构奖入围机构数
FROM    (
            SELECT  t1.推荐人所属分行 分行
                    ,t1.当日规模
                    ,t1.当日中收
                    ,t2.当月规模
                    ,t2.当月中收
                    ,T3.1月1日至今规模
                    ,T3.1月1日至今中收
                    ,T3.1月1日至今件数
                    ,T3.1月1日至今破冰人数
                    ,T3.1月1日至今破冰支行数
                    ,T3.1月1日至今件均规模元
                    ,T3.1月1日至今网均规模元
                    ,row_number() OVER ( ORDER BY t3.1月1日至今中收 DESC ) AS 分行中收排名
            FROM    (
                        SELECT  t.推荐人所属分行
                                ,nvl(t1.当日规模,0) 当日规模
                                ,nvl(t1.当日中收,0) 当日中收
                        FROM    (
                                    SELECT  DISTINCT 推荐人所属分行
                                    FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD
                                    WHERE     推荐人所属分行 REGEXP '分行'
                                ) t
                        LEFT JOIN    (
                                         SELECT  推荐人所属分行
                                                 ,sum(商品应付现金总额) AS 当日规模
                                                 ,sum(佣金总额)     AS 当日中收
                                         FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD
                                         WHERE   查询日期 = '@@{yyyyMMdd}'
                                         AND     推荐人所属分行 REGEXP '分行'
                                         GROUP BY 推荐人所属分行
                                     ) t1
                        ON      t.推荐人所属分行 = t1.推荐人所属分行
                    ) T1
            LEFT JOIN    (
                             SELECT  推荐人所属分行
                                     ,sum(商品应付现金总额) AS 当月规模
                                     ,sum(佣金总额)     AS 当月中收
                             FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD
                             WHERE   查询日期 >= '@@{yyyyMM}01'
                             AND     查询日期 <= '@@{yyyyMMdd}'
                             AND     推荐人所属分行 REGEXP '分行'
                             GROUP BY 推荐人所属分行
                         ) T2
            ON      t1.推荐人所属分行 = t2.推荐人所属分行
            LEFT JOIN    (
                             SELECT  推荐人所属分行
                                     ,sum(商品应付现金总额)                                     AS 1月1日至今规模
                                     ,sum(佣金总额)                                         AS 1月1日至今中收
                                     ,sum(购买数量)                                         AS 1月1日至今件数
                                     ,count(DISTINCT 推荐人工号)                             AS 1月1日至今破冰人数
                                     ,count(DISTINCT 推荐人所属支行)                           AS 1月1日至今破冰支行数
                                     ,ROUND(sum(商品应付现金总额) / sum(购买数量), 2)               AS 1月1日至今件均规模元
                                     ,ROUND(sum(商品应付现金总额) / count(DISTINCT 推荐人所属支行), 2) AS 1月1日至今网均规模元
                             FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_TRX_SUM_DD
                             WHERE   查询日期 >= '20240101'
                             AND     查询日期 <= '@@{yyyyMMdd}'
                             AND     推荐人所属分行 REGEXP '分行'
                             GROUP BY 推荐人所属分行
                         ) T3
            ON      t1.推荐人所属分行 = t3.推荐人所属分行
        ) A
LEFT JOIN    (
                 SELECT  推荐人所属分行
                         ,sum(CASE
                                WHEN 入围奖励 <> '' THEN 1
                                ELSE 0
                              END) AS 营销达人奖入围奖励人数
                 FROM    lab_bigdata_dev.SJXQ_SJ2024011066_GOLD_MONITOR_EMPE_01
                 GROUP BY 推荐人所属分行
             ) B
ON      a.分行 = b.推荐人所属分行
LEFT JOIN    (
                 SELECT  分行
                         ,sum(CASE
                                WHEN 入围奖项 <> '' THEN 1
                                ELSE 0
                              END) AS 优秀机构奖入围机构数
                 FROM    lab_bigdata_dev.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_01
                 GROUP BY 分行
             ) c
ON      a.分行 = c.分行
LEFT JOIN (
        SELECT  t1.brc_org_id
                ,t1.brc_org_nm
                ,count(DISTINCT empe_id) empe_num
                ,count(DISTINCT sbr_org_id) sbr_org_num
        FROM    edw.dws_hr_empe_inf_dd t
        LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t1
        ON      t.org_id = t1.org_id
        AND     t1.dt = '@@{yyyyMMdd}'
        WHERE   t.dt = '@@{yyyyMMdd}'
        AND     t.HC_TYP_CD = '1' --编制内
        AND     t.lbr_typ_cd <> '07' --剔除合作用工
        GROUP BY t1.brc_org_id, t1.brc_org_nm
) D
ON     a.分行 = d.brc_org_nm
;
--加上总计
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_02 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_02 AS
SELECT  *
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_01
UNION ALL
SELECT  '总计' AS 分行
        ,sum(当日规模) 当日规模
        ,sum(当日中收) 当日中收
        ,sum(当月规模) 当月规模
        ,sum(当月中收) 当月中收
        ,sum(1月1日至今规模) 1月1日至今规模
        ,sum(1月1日至今中收) 1月1日至今中收
        ,sum(1月1日至今件数) 1月1日至今件数
        ,sum(当前在职销售人力) 当前在职销售人力
        ,sum(1月1日至今破冰人数) 1月1日至今破冰人数
        ,ROUND(AVG(员工破冰率),2) 员工破冰率
        ,sum(当前支行数) 当前支行数
        ,sum(1月1日至今破冰支行数) 1月1日至今破冰支行数
        ,ROUND(avg(支行破冰率),2) 支行破冰率
        ,avg(1月1日至今件均规模元) 1月1日至今件均规模元
        ,avg(1月1日至今网均规模元) 1月1日至今网均规模元
        ,'' 优秀专员奖
        ,sum(营销达人奖入围奖励人数) 营销达人奖入围奖励人数
        ,sum(优秀机构奖入围机构数) 优秀机构奖入围机构数
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_01;
--结果表
-- 个人维度 LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_EMPE_01
-- 支行维度 LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_SBR_01
-- 分行维度 LAB_BIGDATA_DEV.SJXQ_SJ2024011066_GOLD_MONITOR_BRC_02
SELECT * FROM SJXQ_SJ2024011066_GOLD_MONITOR_BRC_02***SJ2024011296-涉案账户关联排查.sql
/*
需求方：温州分行；
四张表：1、附件清单关联对私账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、工作单位、职业、关系人关系类型；
             2、附件清单关联对公账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、一级行业类型、关系人关系类型；
            3、工作单位在附件中的对私账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、工作单位、职业；
            4、附件清单公司账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、一级行业类型；
备注：名单存在重复企业4个，使用需去重
*/
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_01 AS
SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
    ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='20240111'
left join edw.dwd_code_library_dd   c2
on t1.frz_cls_cd = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt='20240111'
WHERE   t1.DT = '20240111'
AND     t1.FRZ_SRC_CD='2'  --止付
AND     t1.NFRZ_IND = '0'
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_02 AS
SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
    ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='20240111'
WHERE   T1.DT = '20240111'
AND     T1.FRZ_SRC_CD='1'  --冻结
AND     T1.NFRZ_IND = '0'
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_03 AS
SELECT  cst_act_id,lmt_cmt close_fg_rsn
        ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '20240111'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_04 AS
SELECT  cengcgjz    cst_act_id
    ,danciedu   fg_per_lmt
    ,leijiedu   fg_day_lmt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '20240111'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
;
--账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_05 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,T1.IDT_CD,C3.CD_VAL_DSCR IDT_NM
    ,T3.CST_ACT_ID,T3.CST_ACT_NM,T3.OPN_DT
    ,T4.MGR_ID,C1.EMPE_NM MGR_NM
    ,T4.ACS_ORG_ID,C2.ORG_NM ACS_ORG_NM
    ,CASE WHEN T8.cst_act_id IS NULL     THEN '否'
           WHEN T8.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,T8.fg_per_lmt                      AS 非柜单笔限额
    ,T8.fg_day_lmt                      AS 非柜日累计限额
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
FROM EDW.DWS_CST_BAS_INF_DD                     T1 --
INNER JOIN EDW.DIM_BUS_DEP_CST_ACT_INF_DD       T3 --客户存款账户信息
ON T1.CST_ID=T3.CST_ID
AND T3.DT = '20240111'
left JOIN EDW.DWD_BUS_DEP_CST_ACT_MGR_INF_DD    T4 --存款管户
ON  T3.CST_ACT_ID =T4.CST_ACT_ID
AND T3.CST_ID=T4.CST_ID
AND T4.DT='20240111'
AND T4.FRS_CTC_IND = '1' --第一联系人标志 4个客户具有2个管户人
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD                C1
ON  T4.MGR_ID=C1.EMPE_ID
AND C1.DT= '20240111'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD        C2 --考核机构树
ON      T4.ACS_ORG_ID = C2.ORG_ID
AND     C2.DT = '20240111'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD               C3
ON T1.IDT_CD = C3.CD_VAL
AND C3.DT='20240111'
left join SJXQ_SJ2024011296_CST_01              t5 --止付
on t3.cst_act_id=t5.cst_act_id and t5.rn=1
left join SJXQ_SJ2024011296_CST_02              t6 --冻结
on t3.cst_act_id=t6.cst_act_id and t6.rn=1
left join SJXQ_SJ2024011296_CST_03              t7 --关闭非柜面
on t3.cst_act_id=t7.cst_act_id and t7.rn=1
left join SJXQ_SJ2024011296_CST_04              t8 --非柜面限额
on t3.cst_act_id=t8.cst_act_id
WHERE T1.DT = '20240111'
;
--公司账户信息结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_06 AS
SElECT t1.CST_ID        客户号
    ,T1.CST_CHN_NM      客户名称
    ,T1.IDT_CD          行业代码
    ,T1.IDT_NM          行业名称
    ,T1.CST_ACT_ID      客户账号
    ,T1.OPN_DT          开户日期
    ,T1.MGR_ID          管户人工号
    ,T1.MGR_NM          管户人姓名
    ,T1.ACS_ORG_ID      管户机构号
    ,T1.ACS_ORG_NM      管户机构
    ,是否设置非柜限额
    ,非柜单笔限额
    ,非柜日累计限额
    ,是否关闭非柜面
    ,关闭原因
    ,是否冻结
    ,冻结日期
    ,冻结种类
    ,冻结原因
    ,是否止付
    ,止付日期
    ,止付类型代码
    ,止付类型
    ,止付种类代码
    ,止付种类
    ,止付原因
from SJXQ_SJ2024011296_CST_05                   t1
INNER JOIN (
    select distinct CMP_NM
    from QBI_FILE_20240115_14_42_49
) T2 --清单
ON T1.CST_CHN_NM = T2.CMP_NM
;
--2. 附件清单关联对私账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、工作单位、职业、关系人关系类型
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_07 AS
SElECT t1.客户号        清单客户号
    ,t1.客户名称        清单客户名称
    ,t2.rel_cst_id      关联客户号
    ,t4.CST_CHN_NM      关联客户名称
    ,T4.CST_ACT_ID      客户账号
    ,T4.OPN_DT          开户日期
    ,T4.MGR_ID          管户人工号
    ,T4.MGR_NM          管户人姓名
    ,T4.ACS_ORG_ID      管户机构号
    ,T4.ACS_ORG_NM      管户机构
    ,t4.是否设置非柜限额
    ,t4.非柜单笔限额
    ,t4.非柜日累计限额
    ,t4.是否关闭非柜面
    ,t4.关闭原因
    ,t4.是否冻结
    ,t4.冻结日期
    ,t4.冻结种类
    ,t4.冻结原因
    ,t4.是否止付
    ,t4.止付日期
    ,t4.止付类型代码
    ,t4.止付类型
    ,t4.止付种类代码
    ,t4.止付种类
    ,t4.止付原因
    ,t3.job_unt_nm      工作单位
    ,t3.ocp_cd          职业代码
    ,c2.cd_val_dscr     职业
    ,t2.rel_typ_nm      关系人关系类型
from (select distinct 客户号,客户名称 from SJXQ_SJ2024011296_CST_06) t1
inner join (
    SElECT t2.cst_id,t2.rel_cst_id
    from edw.dim_cst_rel_inf_dd         t2 --企业关联的个人客户
    LEFT JOIN edw.dwd_code_library_dd   C1
    ON T2.rel_typ_cd = C1.cd_val
    AND C1.dt='20240111'
    where t2.dt = '20240111'
    GROUP by t2.cst_id,t2.rel_cst_id
)t2 on t1.客户号=t2.cst_id
inner join edw.dim_cst_idv_bas_inf_dd   t3
on t2.rel_cst_id = t3.cst_id
and t3.dt = '20240111'
left join SJXQ_SJ2024011296_CST_05      t4 --个人客户账户
on t2.rel_cst_id=t4.cst_id
LEFT JOIN edw.dwd_code_library_dd       C2
ON T3.ocp_cd = C2.cd_val
AND C2.dt='20240111'
;
--3、附件清单关联对公账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、一级行业类型、关系人关系类型；
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_08 AS
SElECT t1.客户号        清单客户号
    ,t1.客户名称        清单客户名称
    ,t2.rel_cst_id      关联客户号
    ,t4.CST_CHN_NM      关联客户名称
    ,T4.CST_ACT_ID      客户账号
    ,T4.OPN_DT          开户日期
    ,T4.MGR_ID          管户人工号
    ,T4.MGR_NM          管户人姓名
    ,T4.ACS_ORG_ID      管户机构号
    ,T4.ACS_ORG_NM      管户机构
    ,t4.是否设置非柜限额
    ,t4.非柜单笔限额
    ,t4.非柜日累计限额
    ,t4.是否关闭非柜面
    ,t4.关闭原因
    ,t4.是否冻结
    ,t4.冻结日期
    ,t4.冻结种类
    ,t4.冻结原因
    ,t4.是否止付
    ,t4.止付日期
    ,t4.止付类型代码
    ,t4.止付类型
    ,t4.止付种类代码
    ,t4.止付种类
    ,t4.止付原因
    ,t3.idt_ctg_cd      行业类型代码
    ,c2.cd_val_dscr     行业类型
    ,t2.rel_typ_nm      关系人关系类型
from (select distinct 客户号,客户名称 from SJXQ_SJ2024011296_CST_06) t1
inner join (
    SElECT t2.cst_id,t2.rel_cst_id
    from edw.dim_cst_rel_inf_dd         t2 --企业关联的个人客户
    LEFT JOIN edw.dwd_code_library_dd   C1
    ON T2.rel_typ_cd = C1.cd_val
    AND C1.dt='20240111'
    where t2.dt = '20240111'
    GROUP by t2.cst_id,t2.rel_cst_id
)t2 on t1.客户号=t2.cst_id
INNER JOIN EDW.DIM_CST_ENTP_BAS_INF_DD  T3 --企业客户基本信息
ON T2.REL_CST_ID = T3.CST_ID
AND T3.DT = '20240111'
LEFT JOIN SJXQ_SJ2024011296_CST_05      T4
ON T2.REL_CST_ID=T4.CST_ID
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD      C2  --132058 TBL_NM,FLD_NM,CD_VAL 唯一
ON T3.IDT_CTG_CD = C2.CD_VAL
AND C2.DT='20240111'
;
--4、工作单位在附件中的对私账户：账号、户名、开户日期、账户管控措施、管户机构、管户客户经理、非柜限额、管控日期、工作单位、职业；
DROP   TABLE IF     EXISTS SJXQ_SJ2024011296_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024011296_CST_09 AS
SElECT t1.CST_ID        客户号
    ,T1.CST_CHN_NM      客户名称
    ,T4.IDT_CD          行业代码
    ,T4.IDT_NM          行业名称
    ,T4.CST_ACT_ID      客户账号
    ,T4.OPN_DT          开户日期
    ,T4.MGR_ID          管户人工号
    ,T4.MGR_NM          管户人姓名
    ,T4.ACS_ORG_ID      管户机构号
    ,T4.ACS_ORG_NM      管户机构
    ,是否设置非柜限额
    ,非柜单笔限额
    ,非柜日累计限额
    ,是否关闭非柜面
    ,关闭原因
    ,是否冻结
    ,冻结日期
    ,冻结种类
    ,冻结原因
    ,是否止付
    ,止付日期
    ,止付类型代码
    ,止付类型
    ,止付种类代码
    ,止付种类
    ,止付原因
    ,t1.job_unt_nm      工作单位_命中清单
    ,t1.ocp_cd          职业代码
    ,c2.cd_val_dscr     职业
from edw.dws_cst_idv_bas_inf_dd                 t1 --个人客户基本信息汇总表
INNER JOIN (
    select distinct CMP_NM
    from QBI_FILE_20240115_14_42_49
) T2 --清单
ON T1.job_unt_nm = T2.CMP_NM
LEFT JOIN SJXQ_SJ2024011296_CST_05      T4
ON  T1.CST_ID=T4.CST_ID
LEFT JOIN edw.dwd_code_library_dd      C2
ON T1.ocp_cd = C2.cd_val
AND C2.dt='20240111'
where t1.dt= '20240111'
;
SElECT '01' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024011296_CST_01 where rn=1
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024011296_CST_02 where rn=1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024011296_CST_03 where rn=1
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024011296_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id,cst_act_id) custs
from SJXQ_SJ2024011296_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024011296_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct 清单客户号) custs
from SJXQ_SJ2024011296_CST_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct 清单客户号) custs
from SJXQ_SJ2024011296_CST_08
UNION all
SElECT '09' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024011296_CST_09
;
01	2590877	2590877
02	33167	33167
03	3652335	3652335
04	3641162	3641159
05	16964276	16964269
06	6	4
07	6	4
08	0	0
09	45	40
***SJ2024012331-账户分析及排查.sql
数据内容一：开户机构为台州分行辖内（含总行营业部）的个人结算账户工资户（剔除行内员工及其亲属账户、剔除已销户数据），存量账户中工资已停发1个月，但不足3个月的工资账户数据；
数据内容二：开户机构为台州分行辖内（含总行营业部）的个人结算账户工资户（剔除行内员工及其亲属账户、剔除已销户数据），存量账户中地址为括号内的户籍地的数据（贵州榕江、云南昭通、湖北黄冈、河南柘城、湖北恩施、云南德宏、江西上饶、贵州阳市、重庆奉节、河南洛阳、贵州毕节、广西贺州、云南曲靖、河南平舆、四川通江、湖南郴州）
工资户口径：
1.账户交易流水中有出现 交易柜员为&ldquo;WPSPGY&rdquo;的账户
2.账户交易流水中&ldquo;摘要描述&rdquo;字段，有出现登记为&ldquo;代发工资&rdquo;的账户
3.账户交易流水中&ldquo;备注&rdquo;字段，有出现&ldquo;待发工资&rdquo;或&ldquo;工资&rdquo;的账户
--冻结,止付_控制
DROP   TABLE IF     EXISTS SJXQ_SJ2024012331_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012331_CST_01 AS
SELECT t1.cst_act_id,t1.FRZ_SRC_CD --1冻结 2止付
    ,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
    ,ROW_NUMBER() over (partition by t1.cst_act_id,t1.FRZ_SRC_CD order by t1.frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t1.frz_cls_cd = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt='@@{yyyyMMdd}'
WHERE   t1.DT = '@@{yyyyMMdd}'
AND     t1.NFRZ_IND = '0'
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2024012331_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012331_CST_02 AS
SELECT cst_act_id
    ,lmt_cmt close_fg_rsn
    ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '@@{yyyyMMdd}'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ2024012331_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012331_CST_03 AS
SELECT cengcgjz     cst_act_id
    ,danciedu       fg_per_lmt
    ,leijiedu       fg_day_lmt  -- 非柜面日累计限额
FROM    edw.core_kdpa_zheddy    -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE'   -- 非柜面限额
AND     edkzzhqi = '1D'
;
/*
存在多个非柜限额
'6214806601001188616')
*/
-- 行内员工及其亲属
DROP   TABLE IF     EXISTS SJXQ_SJ2024012331_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012331_CST_04 AS
select cst_id
from   edw.dim_cst_idv_bas_inf_dd
where  dt='@@{yyyyMMdd}'
and    length(own_emp_id)>0    -- 本行员工号
union
SELECT c2.cst_id
from   edw.dim_hr_empe_invl_pty_inf_dd  c1   --员工家庭成员与关联人信息
inner join edw.dws_cst_bas_inf_dd       c2
on c1.invl_pty_id_card_id=c2.doc_nbr  --身份证关联
and   c2.dt='@@{yyyyMMdd}'
where c1.dt='@@{yyyyMMdd}'
-- 配偶、父母、子女、兄弟姐妹、祖父母或外祖父母、孙子、孙女，或外孙子、外孙女、儿媳或女婿、公婆或岳父母、其他血亲、其他姻亲
;
-- 工资流水
DROP   TABLE IF     EXISTS SJXQ_SJ2024012331_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012331_CST_05 AS
SELECT A.CST_ACT_ID
    ,B.TRX_DT
    ,B.TRX_AMT
    ,B.TRX_CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,B.CNT_PTY_CST_ACT_ID
    ,B.CNT_PTY_ACT_NM
    ,ROW_NUMBER() OVER(PARTITION BY A.CST_ACT_ID ORDER BY B.TRX_DT DESC) RN
FROM EDW.DIM_BUS_DEP_ACT_INF_DD              A
INNER  JOIN  EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   B
ON  A.CST_ACT_ID=B.CST_ACT_ID
AND A.DEP_ACT_ID=B.DEP_ACT_ID
AND (CONCAT(B.SMR_DSCR,B.CMT) REGEXP '工资' OR B.OPR_TLR='WPSPGY')
AND B.CRD_AND_DBT_IND='C'
AND B.TRX_AMT>0
AND B.DT>='@@{yyyyMMdd -3m}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON  B.TRX_CHNL_CD=C1.CD_VAL
AND C1.DT='@@{yyyyMMdd}'
where A.dt='@@{yyyyMMdd}'
AND  A.BAL_GL_IND <> '0'    -- 剔除虚拟户
AND  A.STL_ACT_IND = '1'    -- 结算账户
AND  A.ACT_STS_CD <> 'C'    -- 剔除已销户
AND  (A.opn_org like '3301%' or A.opn_org='999900099')  --台州分行、总行营业部
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024012331_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012331_CST_06 AS
SELECT T1.cst_id     as 客户号
    ,T1.cst_act_id   as 客户账号
    ,T1.act_nm       as 账户名称
    ,T1.opn_dt       as 开户日期
    ,T1.opn_org      as 开户机构编号
    ,T2.org_nm       AS 开户机构名称
    ,T2.sbr_org_nm   AS 开户支行
    ,T2.brc_org_nm   AS 开户分行
    ,t3.mbl_nbr         手机号码
    ,concat(substr(regexp_replace(T3.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.reg_adr,'\\s|,',''))-6,0)),'******')  户籍地址脱敏
    ,case when T3.reg_adr REGEXP '榕江|昭通|黄冈|柘城|恩施|德宏|上饶|阳市|奉节|洛阳|毕节|贺州|曲靖|平舆|通江|郴州' then 1 else 0 end     是否指定户籍
    ,case when t4.cst_act_id is not null then 1 else 0 end  是否冻结
    ,t4.frz_dt      冻结时间
    ,T4.frz_rsn     冻结原因
    ,T4.frz_cls     冻结种类
    ,case when t5.cst_act_id is not null then 1 else 0 end  是否止付
    ,t5.frz_dt              止付时间
    ,T5.frz_rsn             止付原因
    ,T5.frz_cls             止付种类
    ,T5.ACT_STOP_PMT_TYP    止付类型
    ,case when T6.cst_act_id is not null then 1 else 0  end 是否关闭非柜面
    ,t6.close_fg_rsn        关闭非柜面原因
    ,T7.fg_day_lmt          非柜面日累计限额
    ,T1.act_sts_cd    as  账户状态编号
    ,C1.cd_val_dscr   as  账户状态
    ,T8.TRX_DT              最后一次代发日期
    ,T8.TRX_AMT             最后一次代发金额
    ,T8.TRX_CHNL            最后一次交易渠道
    ,T8.CNT_PTY_CST_ACT_ID  代发账号
    ,T8.CNT_PTY_ACT_NM      代发账户名称
    ,substr(t8.trx_dt,1,6)  停发月份
FROM edw.dws_bus_dep_act_inf_dd             T1
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd    T2
ON  T1.opn_org=T2.org_id
and T2.dt='@@{yyyyMMdd}'
LEFT JOIN  edw.dws_cst_bas_inf_dd           T3
ON  T1.cst_id=T3.cst_id
and T3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024012331_CST_01          t4
on  t1.cst_act_id=t4.cst_act_id
and t4.FRZ_SRC_CD='1'   --1冻结
and t4.rn=1
left join SJXQ_SJ2024012331_CST_01          t5
on  t1.cst_act_id=t5.cst_act_id
and t5.FRZ_SRC_CD='2'   --2止付
and t5.rn=1
left join SJXQ_SJ2024012331_CST_02          t6
on  t1.cst_act_id=t6.cst_act_id
and t6.rn=1
left join SJXQ_SJ2024012331_CST_03          t7
on  t1.cst_act_id=t7.cst_act_id
left join edw.dwd_code_library_dd           C1
ON  T1.act_sts_cd = C1.CD_VAL
AND C1.tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
AND C1.FLD_NM='ACT_STS_CD'
AND C1.DT = '@@{yyyyMMdd}'
INNER JOIN SJXQ_SJ2024012331_CST_05         T8 ON T1.CST_ACT_ID=T8.CST_ACT_ID AND T8.RN=1
LEFT JOIN SJXQ_SJ2024012331_CST_04          T9 ON T1.CST_ID = T9.CST_ID
where T1.dt='@@{yyyyMMdd}'
AND   T1.BAL_GL_IND <> '0'      -- 剔除虚拟户
AND   T1.STL_ACT_IND = '1'      -- 结算账户
AND   T1.ACT_STS_CD <> 'C'      -- 剔除已销户
AND  (T1.opn_org like '3301%' or T1.opn_org ='999900099') --台州分行、总行营业部
AND  T9.CST_ID IS NULL          -- 剔除行内员工及其亲属账户
;
-- 数据内容一：开户机构为台州分行辖内（含总行营业部）的个人结算账户工资户（剔除行内员工及其亲属账户、剔除已销户数据），存量账户中工资已停发1个月，但不足3个月的工资账户数据；
SElECT *
from SJXQ_SJ2024012331_CST_06
where 工资停发天数>30 and 工资停发天数<=93
;
-- 数据内容二：开户机构为台州分行辖内（含总行营业部）的个人结算账户工资户（剔除行内员工及其亲属账户、剔除已销户数据），存量账户中地址为括号内的户籍地的数据（贵州榕江、云南昭通、湖北黄冈、河南柘城、湖北恩施、云南德宏、江西上饶、贵州阳市、重庆奉节、河南洛阳、贵州毕节、广西贺州、云南曲靖、河南平舆、四川通江、湖南郴州）
SElECT *
from SJXQ_SJ2024012331_CST_06
where 是否指定户籍=1
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024012331_CST_01 where rn=1
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024012331_CST_02 where rn=1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024012331_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024012331_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024012331_CST_05 where rn=1
UNION all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024012331_CST_06
;
01	2634394	2618306
02	3661836	3661836
03	3673192	3673189
04	122316	122316
05	93918	93918
06	88734	88701
*/
***SJ2024012336-老保管箱存量客户明细.sql
--报表管理-数据需求-数据上传
--主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_01 AS
select doc_nbr
from qbi_file_20240126_08_42_51
GROUP BY doc_nbr
;
--证件信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_02 AS
SElECT t1.doc_nbr,t1.cst_id
from edw.dim_cst_bas_doc_inf_dd	    t1 --客户证件信息
inner join SJXQ_SJ2024012336_CST_01 t2
on t1.doc_nbr = t2.doc_nbr
left join edw.dwd_code_library_dd   c1          --132058
on t1.doc_typ_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
GROUP by t1.doc_nbr,t1.cst_id
;
--个人客户主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_03 AS
select t1.cst_id                                --客户号|c20
	,t1.cst_chn_nm                              --客户中文名称|c200
	,decode(t1.gdr_cd,'1','男','2','女','未知') gender --性别代码|c1
    ,t1.ntn_cd,c1.cd_val_dscr   nationality
    ,t1.ocp_cd,c2.cd_val_dscr   occupation      --职业代码|c5
    ,t1.bth_cty_cd                              --出生城市代码|c256
	,t1.job_unt_nm                              --工作单位名称|C200
    ,T7.PRM_ORG_ID
FROM EDW.DIM_CST_IDV_BAS_INF_DD     T1
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C1          --132058
ON T1.NTN_CD = C1.CD_VAL
AND C1.DT='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C2
ON  T1.OCP_CD=C2.CD_VAL
AND C2.TBL_NM='DIM_CST_IDV_BAS_INF_DD'
AND C2.FLD_NM='OCP_CD'
AND C2.DT='@@{yyyyMMdd}'
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T7  --客户`主管户`信息 15842885 CST_ID 唯一
ON  T1.CST_ID = T7.CST_ID
AND T7.DT = '@@{yyyyMMdd}'
-- LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T8  --考核机构树 4481 ORG_ID 唯一
-- ON      T7.PRM_ORG_ID = T8.ORG_ID
-- AND     T8.DT = '@@{yyyyMMdd}'
WHERE T1.DT='@@{yyyyMMdd}'
;
--企业客户主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_04 AS
SELECT T1.CST_ID                                --客户号|C20
	,T1.CST_NM                                  --客户名称|C200
	,T1.REG_CNR_CD,C1.CD_VAL_DSCR	REG_CNR     --注册国家代码|C3
    ,T1.OPR_SCP_DSCR	                        --经营范围描述|C3000
	,T1.ORG_ORG_TYP_CD                          --组织机构类型代码|C6
	,T1.ENTP_SIZ_CD                             --企业规模代码|C1
	,T1.OPR_SITU_CD                             --经营状况代码|C4
	,T1.ORG_ORG_FOUND_DT                        --组织机构成立日期|C8
	,T1.REG_CPT_CCY_CD                          --注册资本币种代码|C3
	,T1.REG_CPT                                 --注册资本|DECIMAL(20,2)
	,T1.EMP_NBR                                 --职工人数|INTEGER
	,T1.IDT_CTG_CD                              --行业分类代码|C10
	,T3.LGP_CST_ID                          --对公客户法人客户号
	,T3.LGP_NM                              --对公客户法人客户名称
    ,T3.LGP_DOC_TYP_CD	                    --对公客户法人证件类型
	,T3.LGP_DOC_ID                          --对公客户法人证件号
	,T3.LGP_TEL                             --对公客户法人手机号
    ,T3.LGP_DOC_MTU_DT	                    --对公客户法人证件到期日
    ,t4.rel_cst_id  sy_cst_id
    ,t5.rel_cst_id  sk_cst_id
    ,t7.prm_org_id
FROM EDW.DIM_CST_ENTP_BAS_INF_DD        T1
inner join edw.dws_cst_bas_inf_dd       t6
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
inner JOIN SJXQ_SJ2024012336_CST_01     T2           --关联主表
ON T6.DOC_NBR = T2.DOC_NBR
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1 --132058
ON T1.REG_CNR_CD = C1.CD_VAL
AND C1.DT='@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_CST_ENTP_LGP_INF_DD   T3 --对公客户法人信息表
ON T1.CST_ID = T3.CST_ID
AND T3.DT='@@{yyyyMMdd}'
LEFT JOIN    EDW.DIM_CST_REL_INF_DD     T4 --客户关联关系信息
ON      T1.CST_ID = T4.CST_ID
AND     T4.DT = '@@{yyyyMMdd}'
AND     T4.REL_TYP_CD LIKE '09%'    --受益人
LEFT JOIN    EDW.DIM_CST_REL_INF_DD     T5 --客户关联关系信息
ON      T1.CST_ID = T5.CST_ID
AND     T5.DT = '@@{yyyyMMdd}'
AND     T5.REL_TYP_CD = '0109'      --实际控制人（高管）
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD T7 --客户`主管户`信息 15842885 CST_ID 唯一
ON  T1.CST_ID = T7.CST_ID
AND T7.DT = '@@{yyyyMMdd}'
WHERE T1.DT='@@{yyyyMMdd}'
;
--客户基础信息汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_05 AS
select T1.cst_id                                 --客户号|C20
	,T1.cst_chn_nm                               --客户姓名|C200
	,T1.doc_typ_cd,c1.cd_val_dscr  doc_typ       --证件类型
	,T1.doc_nbr                                  --证件号
	,T1.doc_mtu_dt                               --证件到期日
    ,CASE WHEN T2.phone='' THEN T2.tel_phn ELSE T2.phone END FILE_phone
	,T1.mbl_nbr                                  --手机|C32
	,T1.fml_tel_nbr                              --家庭电话|C32
	,T1.reg_adr                                  --户籍地址|注册地址|C256
	,T1.cmn_adr                                  --通讯地址|C256
	,T1.wrk_adr                                  --工作单位地址|经营所在地地址|C256
	,T1.fml_adr                                  --家庭地址|C256
    ,case when t2.DOC_NBR is not null then 1 else 0 end is_select
from edw.dws_cst_bas_inf_dd         T1           --客户基础信息汇总表
left JOIN SJXQ_SJ2024012336_CST_01  T2           --关联主表
ON T1.DOC_NBR = T2.DOC_NBR
left join edw.dwd_code_library_dd   c1          --132058
on t1.doc_typ_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
--老保管箱存量客户信息提取要求-对私客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_06 AS
SELECT T1.PRM_ORG_ID    客户号归属机构网点代码
    ,T1.CST_ID          客户号
	,T1.CST_CHN_NM      客户名称
	,T1.GENDER          性别
    ,T1.NATIONALITY     国籍
    ,T1.OCCUPATION      职业
	,T1.JOB_UNT_NM      工作单位名称
    ,T2.DOC_TYP         身份证件种类
    ,T2.DOC_NBR         身份证件号码
    ,T2.DOC_ISU_DT	    证件签发日期
    ,T2.DOC_MTU_DT	    证件到期日期
    ,t3.FILE_phone      清单手机号
    ,T3.mbl_nbr         手机
	,T3.fml_tel_nbr     家庭电话
    ,t3.fml_adr         家庭地址
    ,t3.wrk_adr         工作单位地址
    ,t1.bth_cty_cd      出生城市代码
	,t3.reg_adr         户籍地址
	,t3.cmn_adr         通讯地址
from SJXQ_SJ2024012336_CST_03       t1
left join SJXQ_SJ2024012336_CST_02  t2
on t1.cst_id=t2.cst_id
inner join SJXQ_SJ2024012336_CST_05  t3
on  t1.cst_id=t3.cst_id
and t3.is_select=1 --名单中对私客群
;
--老保管箱存量客户信息提取要求-对公客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024012336_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012336_CST_07 AS
SElECT T1.prm_org_id    客户号归属机构网点代码
    ,t1.CST_ID          客户号
	,T1.CST_NM          客户名称
	,T1.REG_CNR         注册国家
    ,T2.DOC_TYP         身份证件种类
    ,T2.DOC_NBR         身份证件号码
    ,T2.DOC_ISU_DT	    证件签发日期
    ,T2.DOC_MTU_DT	    证件到期日期
    ,T3.FILE_phone      清单手机号
    ,T3.mbl_nbr         手机
    ,t3.wrk_adr         经营所在地地址
    ,T1.OPR_SCP_DSCR	经营范围描述
	,t3.reg_adr         注册地址
	,t3.cmn_adr         通讯地址
	,T1.LGP_CST_ID      对公客户法人客户号
	,T1.LGP_NM          对公客户法人客户名称
    ,T1.LGP_DOC_TYP_CD	对公客户法人证件类型
	,T1.LGP_DOC_ID      对公客户法人证件号
	,T1.LGP_TEL         对公客户法人手机号
    ,T1.LGP_DOC_MTU_DT	对公客户法人证件到期日
    ,t4.cst_chn_nm      实际控制人名称
	,t4.doc_typ         实际控制人证件类型
	,t4.doc_nbr         实际控制人证件号码
	,t4.doc_mtu_dt      实际控制人证件到期日
	,t4.mbl_nbr         实际控制人联系电话
    ,t5.cst_chn_nm      受益所有人名称
	,t5.doc_typ         受益所有人证件类型
	,t5.doc_nbr         受益所有人证件号码
	,t5.doc_mtu_dt      受益所有人证件到期日
	,t5.mbl_nbr         受益所有人联系电话
from SJXQ_SJ2024012336_CST_04       t1
left join SJXQ_SJ2024012336_CST_02  t2
on t1.cst_id=t2.cst_id
INNER join SJXQ_SJ2024012336_CST_05  t3
on  t1.cst_id=t3.cst_id
and t3.is_select=1      --名单中对公客群
left join SJXQ_SJ2024012336_CST_05  t4
on t1.sk_cst_id=t4.cst_id
left join SJXQ_SJ2024012336_CST_05  t5
on t1.sy_cst_id=t5.cst_id
;
SElECT '01' seq, count(1) cnt, count(distinct doc_nbr) custs
from SJXQ_SJ2024012336_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct doc_nbr) custs
from SJXQ_SJ2024012336_CST_02
UNION all
SElECT '02_' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024012336_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024012336_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024012336_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024012336_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024012336_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024012336_CST_07
;
01	3208	3208
02	2978	2844
02_	2978	2978
03	14443016	14443016
04	148	147
05	16209291	16209291
06	2831	2831
07	148	147
***SJ2024012526-侵占隐瞒资金自查.sql
/*
1.2023年12月1日-2024年1月25日，行内员工在工作时间（8:30-17:30）
在柜面渠道（不含超柜、ATM等自主机具，仅仅是操作人员为柜员）
办理业务（业务类型：储蓄类业务账户开/销户、个人/对公结算账户存/取款、信用卡/随贷通卡存/取款）。
机构号	业务日期	交易打开时间	菜单码	菜单名称	经办柜员号	客户号	客户工号	客户名称	交易金额	现金金额
2.2023年12月1日-2024年1月25日，16:00以后办理的个人/对公存/取款业务。
交易金额为100元以内（含）的业务。（同时数据中须有字段无卡存款渠道可分为手输账号或刷卡进入的区别）
开户机构号	所属分村行名称	客户账号	存款账号	交易机构号	交易机构名称	客户号	账户名称	我行员工工号	交易日期	交易时间	借贷标志c转入d转出	交易金额	摘要代码	摘要描述	操作柜员	柜员名称	柜员流水号	是否抵现交易
3.2023年12月1日-2024年1月25日，
当天同一个账号间隔1小时以上办理两笔及以上现金业务（白天办理该业务，间隔1小时以上后再次同一个账号办理储蓄类业务账户开/销户、个人/对公结算账户存/取款、信用卡/随贷通卡存/取款）。
17点后开户机构号	17点后所属分村行名称	17点后客户账号	17点后存款账号	17点后交易机构号	17点后交易机构名称	17点后客户号	17点后账户名称	17点后我行员工工号	17点后交易日期	17点后交易时间	17点后交易时间2	17点后借贷标志c转入d转出	17点后交易金额	17点后摘要代码	17点后摘要描述	17点后操作柜员	17点后柜员名称	17点后柜员流水号	17点前开户机构号	17点前所属分村行名称	17点前客户账号	17点前存款账号	17点前交易机构号	17点前交易机构名称	17点前客户号	17点前账户名称	17点前我行员工工号	17点前交易日期	17点前交易时间	17点前交易时间2	17点前借贷标志c转入d转出	17点前交易金额	17点前摘要代码	17点前摘要描述	17点前操作柜员	17点前柜员名称	17点前柜员流水号
*/***SJ2024012611-疫后经济监管报表.sql
/*要求:
0. 亿元，两位小数
1. 企业户数是指统计期末的存量账户数，以企业为单位，每户企业多个账户需合并记为1户，不包含政府机关，事业单位等。
2. 小微企业标准为工信部企业划型标准小微企业法人，同时需剔除房地产、投资公司、大型在建工程、SPV、金融机构（含地方六类金融机构）。
3. 是否有授信标准为期末时点，包含表外业务。
4. &ldquo;账户流入金额&rdquo;、&ldquo;账户流出金额&rdquo;、&ldquo;代发工资金额&rdquo;为统计期限内上述账户的发生额（剔除同企业账户间互转）。
5. 动账户数=发生资金划转（剔除存款利息、银行收费、同企业账户间互转）企业户数。
6. 动账率=发生资金划转（剔除存款利息、银行收费、同企业账户间互转）企业户数/账户总数。
7. 同比填百分比，若为负增长，用负数表示。
8. 对公账户不包括个体工商户。
（1）全对公账户：上海分行本外币非销户状态的企业结算账户（不含个体工商户）。
a.账户状态按报表周期期末时点值判断，如2021年3月31日状态；
b.企业按&ldquo;组织机构类型&rdquo;0101企业法人、0102个人独资合伙企业、0103企业的分支机构、0104非法人企业判断；
c.结算账户按人民币账户&ldquo;账户类型&rdquo;为基本户、一般户、临时户和专用户，外币账户账户类型为0005外汇账户和0007外币账户；
d.同一客户号企业有多个账户时需合并记为1户。
（2）扣除金融机构及同业
a.扣除金融机构及同业：全部对公账户数量减去客户号以0开头的同业客户的账户数量
    b.剔除规模以上,按按工信部大型企业标准剔除。
C.当季日均存款（包含理财等）50万元以下企业，以客户为单位按我行标准存款统计规则。
d.授信小微企业,小微企业标准为工信部企业划型标准小微企业法人，同时需剔除房地产、投资公司、大型在建工程、SPV、金融机构（含地方六类金融机构）；授信小微企业按信贷业务的报表口径，是否有授信标准为期末时点，包含表外业务。
（3）制造业、批发和零售业、交通运输/仓储和邮政业、住宿和餐饮业、文化/体育和娱乐业、旅游及会展业按对公账户的行业分类统计，与2021年版行业相比删除卫生和社会工作和租赁和商务服务业，增加旅游及会展业。
（4）账户资金情况：在统计周期内账户资金流入和流出情况，贷方记账为流入，借方记账为流出；不包括同一客户号账户之间的交易。
（5）税费支出：交易流水中借方记账，记账柜员为TIPS的交易。
（6）电费支出：交易流水中借方记账，收款人为&ldquo;国网上海市电力公司&rdquo;的交易。
（7）代发工资情况：通过柜面和电子银行办理的代发工资业务，柜面的交易代码2310，电子银行按电子银行功能识别。
（8）代发工资人次：根据代发工资业务收款人按笔数统计
（9）流入动账：发生贷方交易的账户，剔除存款利息、同客户号本行其他账户转入。
（10）当季无动账企业户数：统计周期内无贷方交易的账户数，含仅存在存款利息、同客户号本行其他账户转入交易的账户。
（11）当年无动账企业户数：年初至统计期末无贷方交易的账户数，含仅存在存款利息、同客户号本行其他账户转入交易的账户。
（12）流出动账：发生借方交易的账户，剔除银行收费（电子银行服务费和汇款手续费）、转出至本行同一客户号其他账号。
（13）当季无动账企业户数：统计周期内未发生借方交易的账户，含仅存在银行收费（电子银行服务费和汇款手续费）、转出至本行同一客户号其他账号交易是账户。
（14）当年无动账企业户数：年初至统计期末未发生借方交易的账户，含仅存在银行收费（电子银行服务费和汇款手续费）、转出至本行同一客户号其他账号交易是账户。
（15）出口结算：出口结算（出口单证业务+汇入汇款业务）=（业务编号BP开头+业务编号OC开头+业务编号IR开头）。
（16）非贸易项下汇入汇款：国结系统交易类型为&ldquo;非贸易对公&rdquo;的汇入交易。
（17）进口结算：进口结算（进口单证业务+汇出汇款业务）=（业务编码BR开头+业务编码IC开头+业务编号OR开头）。
（18）非贸易项下汇出汇款：国结系统交易类型为&ldquo;非贸易对公&rdquo;的汇出交易。
*/
--2022/2023
1. 企业情况：企业名称、账户合并、是否金融机构及同业、是否规模以上、年日均存款含理财、是否授信、是否政府事业单位
    行业(制造业，批发和零售业，交通运输、仓储和邮政业，住宿和餐饮业，文化、体育和娱乐业， 旅游及会展业)
2. 账户资金：企业名称、流入金额、同比增幅、 流出金额、税费、电费 净流入金额、期初余额（2022年期末）、期末余额
3. 代发工资：企业名称、代发金额、代发金额增幅、代发人次
4. 动账情况：企业名称、是否1、2、3、4季度动账、1、2、3、4季度账户总数
    流出动账
5. 国际结算：企业名称、出口结算、非贸易汇入款、进口结算、汇出款项
-- 客户年日均余额小于50W
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_01 AS
SELECT  A.CST_ID,A.CST_ACT_ID
FROM    edw.DIM_BUS_DEP_ACT_INF_DD          A
INNER JOIN    edw.DIM_CST_ENTP_BAS_INF_DD   B
ON      A.CST_ID = B.CST_ID
AND     B.ORG_ORG_TYP_CD IN ( '0101' , '0102' , '0103' , '0104' ) --组织类型机构代码(0101企业法人、0102个人独资合伙企业、0103企业的分支机构、0104非法人企业)
AND     B.DT = A.DT
WHERE   A.ACT_STS_CD IN ( '0' , '1' , 'A' )
AND     A.ACT_CTG_CD_1 IN ( '0001' , '0002' , '0003' , '0004' , '0005' , '0007' )
AND     A.ACT_AFL_ORG LIKE '3101%'
AND     A.CST_ID NOT LIKE '0%' --金融机构及同业
AND     A.DT BETWEEN '20230101' AND '20231231'
GROUP BY A.CST_ID,A.CST_ACT_ID
HAVING SUM(A.CUR_ACT_BAL)/365 < 500000
;
-- 企业账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_02 AS
select T1.cst_id                            --客户号|C20
	,T1.cst_nm                            --客户名称|C200
    ,CASE WHEN T1.CST_ID LIKE '0%' THEN '金融机构及同业'
          WHEN (T2.ENTP_SIZ_CD <> '2' OR T2.ENTP_SIZ_CD IS NULL) THEN '剔除规模以上'
          WHEN T2.ENTP_SIZ_CD IN ( '4' , '5' ) THEN '小微企业'
          WHEN T3.IDT_CD LIKE 'C%' THEN '制造业'
          WHEN T3.IDT_CD LIKE 'F%' THEN '批发和零售业'
          WHEN T3.IDT_CD LIKE 'G%' THEN '交通运输、仓储和邮政业'
          WHEN T3.IDT_CD LIKE 'R%' THEN '文化、体育和娱乐业'
          WHEN T3.IDT_CD LIKE 'L7282%' OR T3.IDT_CD='L7292') THEN '租赁和商务服务业'
          WHEN T3.IDT_CD LIKE 'H%' THEN '住宿和餐饮业'
          WHEN T4.CST_ID IS NOT NULL THEN '小于50W'
          ELSE '' END   ENTERPRISE_TYPE
	,T1.cst_typ_cd                        --客户类型代码|C1
	,T1.org_org_typ_cd                    --组织机构类型代码|C6
    ,C1.cd_val_dscr     org_org_typ       --组织机构类型 0101:企业法人  0102:企业独资、合伙企业  0103：企业的分支机构  0104：企业非法人  0500：个体工商户
    ,T1.fin_instt_typ_cd	              --金融机构类型代码|C32
    ,C2.cd_val_dscr     fin_instt_typ
	,T1.entp_siz_cd                       --企业规模代码|C1
	,T1.emp_nbr                           --职工人数|INTEGER
	,T1.idt_ctg_cd                        --行业分类代码|C10
    ,T2.CST_ACT_ID
    ,T2.CUR_ACT_BAL
    ,T3.FILE_DT
from edw.dim_cst_entp_bas_inf_dd        T1      --企业客户基本信息
INNER JOIN(
    SELECT T2.CST_ID,T2.CST_ACT_ID,SUM(T2.CUR_ACT_BAL) CUR_ACT_BAL
    FROM edw.DIM_BUS_DEP_ACT_INF_DD   T2      --存款账户信息
    WHERE T2.DT = '20231231'
    AND T2.ACT_CTG_CD_1 IN ( '0001' , '0002' , '0003' , '0004' , '0005' , '0007' )
    --账户分类代码(1:基本户,2:一般户,3:临时户,4:专用户,5:外汇账户,7:外币账户)
    AND T2.ACT_STS_CD  IN ( '0' , '1' , 'A' )
    -- AND T2.STL_ACT_IND = '1'         --非销户且为结算账户
    AND T2.ACT_AFL_ORG LIKE '3101%'     --账户所属机构
    GROUP BY T2.CST_ID,T2.CST_ACT_ID
)T2 ON  T1.CST_ID = T2.CST_ID AND T1.CST_ACT_ID=T2.CST_ACT_ID
INNER JOIN edw.DIM_CST_BAS_INF_DD       T3 --客户基本信息
ON      T1.CST_ID = T3.CST_ID
AND     T3.DT = '20231231'
LEFT JOIN SJXQ_SJ2024012611_CST_01      T4 ON T1.CST_ID=T4.CST_ID
left join edw.dwd_code_library_dd       c1
on  T1.org_org_typ_cd = c1.cd_val
and c1.dt='20231231'
left join edw.dwd_code_library_dd       c2
on  T1.fin_instt_typ_cd = c2.cd_val
and c2.dt='20231231'
where T1.dt='20231231'
;
-- 上年 账户年日均余额小于50W
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_03 AS
;
-- 上年 企业账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_04 AS
;
-------------------------------------------- 从结果表取数 --------------------------------------------
adm_upss.ENTP_CUST_CAPTAIL_TB_INFO_I
adm_upss.ENTP_CUST_MOBILE_ACCOUNT_INFO_I
adm_upss.ENTP_CUST_PAY_WAGES_INFO_I
adm_upss.ENTP_INTERNATION_SETLL_INFO_I
-- 2.账户资金情况
select enterprise_type        --企业类型
	,enterprise_num           --企业户数
	,cur_act_bal              --账户余额
	,jiaoyije_inflow          --流入金额
	,jiaoyije_outflow         --流出金额
	,electricity_expen        --电费支出
	,tax_expen                --税费支出
	,time_dimsion             --时间维度
	,enterprise_num_a         --同比去年同期增长>10%企业户数
	,enterprise_num_b         --同比去年同期增长-10%~10%企业户数
	,enterprise_num_c         --同比去年同期增长-30%~-10%企业户数
	,enterprise_num_d         --同比去年同期增长<-30%企业户数
	,jiaoyije_in_a            --同比去年同期增长>10%流入金额
	,jiaoyije_in_b            --同比去年同期增长-10%~10%流入金额
	,jiaoyije_in_c            --同比去年同期增长-30%~-10%流入金额
	,jiaoyije_in_d            --同比去年同期增长<-30%流入金额
	,data_date                --数据日期
	,dt                       --数据日期
from adm_upss.entp_cust_captail_tb_info_i       --账户资金情况
where dt='20231231'
;
-- 4.动账情况
select enterprise_type        --企业类型
	,jiedaibz                 --借贷标志
	,mobile_cust_cn           --动账户数
	,mobile_cust_first_month  --当季第一月流入或流出动账户数
	,mobile_cust_two_month    --当季第二月流入或流出动账户数
	,mobile_cust_three_month  --当季第三月流入或流出动账户数
	,mobile_cust_season_no    --当季无动账企业户数
	,time_dimsion             --时间维度
	,data_date                --数据日期
	,dt                       --数据日期
from adm_upss.entp_cust_mobile_account_info_i   --账户资金情况
where dt='20231231'
;
-- 3.代发工资情况
select enterprise_type        --企业类型
	,entp_pay_wages           --代发工资
	,entp_pay_wages_num       --代发工资笔数
	,time_dimsion             --时间维度
	,entp_num_a               --同比去年同期增长>10%企业户数
	,entp_num_b               --同比去年同期增长-10%~10%企业户数
	,entp_num_c               --同比去年同期增长-30%~-10%企业户数
	,entp_num_d               --同比去年同期增长<-30%企业户数
	,current_pay_wages_a      --同比去年同期增长>10%流入金额
	,current_pay_wages_b      --同比去年同期增长-10%~10%流入金额
	,current_pay_wages_c      --同比去年同期增长-30%~-10%流入金额
	,current_pay_wages_d      --同比去年同期增长<-30%流入金额
	,data_date                --数据日期
	,dt                       --数据日期
from adm_upss.entp_cust_pay_wages_info_i        --账户资金情况
where dt='20231231'
;
-- 5.国际结算
select enterprise_type        --企业类型
	,time_dimsion             --时间维度
	,internation_setll_summ   --国际结算汇总
	,inward_summart           --汇入合计
	,outward_summart          --汇出合计
	,export_settlem           --出口结算
	,import_settlem           --进口结算
	,feimao_export_settlem    --非贸易项下汇入汇款
	,feimao_import_settlem    --非贸易项下汇出汇款
	,data_date                --数据日期
	,dt                       --数据日期
from adm_upss.entp_internation_setll_info_i     --国际结算
where dt='20231231'
;
***SJ2024012611-疫后经济监管报表_20221231.sql
--20230331 时点数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_01 AS
--20230630 时点数据
--20230930 时点数据
--20231231 时点数据
--20221231 时点数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_01 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,t2.enterprise_num enterprise_num_lst
    ,(t1.enterprise_num-t2.enterprise_num)/t2.enterprise_num r_enterprise_num
    ,round(t1.jiaoyije_inflow/100000000,2) jiaoyije_inflow
    ,round(t2.jiaoyije_inflow/100000000,2) jiaoyije_inflow_lst
    ,(t1.jiaoyije_inflow-t2.jiaoyije_inflow)/t2.jiaoyije_inflow r_amt_inflow
    ,t1.enterprise_num_a
    ,round(t1.jiaoyije_in_a/100000000,2) jiaoyije_in_a
    ,round(t2.jiaoyije_in_a/100000000,2) jiaoyije_in_a_lst
    ,(t1.jiaoyije_in_a-t2.jiaoyije_in_a)/t2.jiaoyije_in_a r_amt_in_a
    ,t1.enterprise_num_b
    ,round(t1.jiaoyije_in_b/100000000,2) jiaoyije_in_b
    ,round(t2.jiaoyije_in_b/100000000,2) jiaoyije_in_b_lst
    ,(t1.jiaoyije_in_b-t2.jiaoyije_in_b)/t2.jiaoyije_in_b r_amt_in_b
    ,t1.enterprise_num_c
    ,round(t1.jiaoyije_in_c/100000000,2) jiaoyije_in_c
    ,round(t2.jiaoyije_in_c/100000000,2) jiaoyije_in_c_lst
    ,(t1.jiaoyije_in_c-t2.jiaoyije_in_c)/t2.jiaoyije_in_c r_amt_in_c
    ,t1.enterprise_num_d
    ,round(t1.jiaoyije_in_d/100000000,2) jiaoyije_in_d
    ,round(t2.jiaoyije_in_d/100000000,2) jiaoyije_in_d_lst
    ,(t1.jiaoyije_in_d-t2.jiaoyije_in_d)/t2.jiaoyije_in_d r_amt_in_d
    ,round(t1.jiaoyije_outflow/100000000,2) jiaoyije_outflow
    ,round(t2.jiaoyije_outflow/100000000,2) jiaoyije_outflow_lst
    ,(t1.jiaoyije_outflow-t2.jiaoyije_outflow)/t2.jiaoyije_outflow r_amt_outflow
    ,round(t1.tax_expen/100000000,2) tax_expen
    ,round(t2.tax_expen/100000000,2) tax_expen_lst
    ,(t1.tax_expen-t2.tax_expen)/t2.tax_expen r_tax_expen
    ,round(t1.electricity_expen/100000000,2) electricity_expen
    ,round(t2.electricity_expen/100000000,2) electricity_expen_lst
    ,(t1.electricity_expen-t2.electricity_expen)/t2.electricity_expen r_electricity_expen
    ,round((t1.jiaoyije_inflow-t1.jiaoyije_outflow)/100000000,2) amt_netflow
    ,round((t2.jiaoyije_inflow-t2.jiaoyije_outflow)/100000000,2) amt_netflow_lst
    ,(t1.jiaoyije_inflow-t1.jiaoyije_outflow-t2.jiaoyije_inflow+t2.jiaoyije_outflow)/(t2.jiaoyije_inflow-t2.jiaoyije_outflow) r_amt_netflow
    ,round(t1.cur_act_bal/100000000,2) cur_act_bal
    ,round(t2.cur_act_bal/100000000,2) cur_act_bal_lst
    ,(t1.cur_act_bal-t2.cur_act_bal)/t2.cur_act_bal r_cur_act_bal
from adm_upss.entp_cust_captail_tb_info_i       t1 --账户资金情况
left join adm_upss.entp_cust_captail_tb_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20221231'
where t1.dt='20221231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_01_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_01_1 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,enterprise_num_lst
    ,r_enterprise_num
    ,jiaoyije_inflow
    ,jiaoyije_inflow_lst
    ,case when jiaoyije_inflow_lst>0 then (t1.jiaoyije_inflow-jiaoyije_inflow_lst)/jiaoyije_inflow_lst else 0 end r_amt_inflow
    ,t1.enterprise_num_a
    ,jiaoyije_in_a
    ,jiaoyije_in_a_lst
    ,case when jiaoyije_in_a_lst>0 then (t1.jiaoyije_in_a-jiaoyije_in_a_lst)/jiaoyije_in_a_lst else 0 end r_amt_in_a
    ,t1.enterprise_num_b
    ,jiaoyije_in_b
    ,jiaoyije_in_b_lst
    ,case when jiaoyije_in_b_lst>0 then (t1.jiaoyije_in_b-jiaoyije_in_b_lst)/jiaoyije_in_b_lst else 0 end r_amt_in_b
    ,t1.enterprise_num_c
    ,jiaoyije_in_c
    ,jiaoyije_in_c_lst
    ,case when jiaoyije_in_c_lst>0 then (t1.jiaoyije_in_c-jiaoyije_in_c_lst)/jiaoyije_in_c_lst else 0 end r_amt_in_c
    ,t1.enterprise_num_d
    ,jiaoyije_in_d
    ,jiaoyije_in_d_lst
    ,case when jiaoyije_in_d_lst>0 then (t1.jiaoyije_in_d-jiaoyije_in_d_lst)/jiaoyije_in_d_lst else 0 end r_amt_in_d
    ,jiaoyije_outflow
    ,jiaoyije_outflow_lst
    ,case when jiaoyije_outflow_lst>0 then (t1.jiaoyije_outflow-jiaoyije_outflow_lst)/jiaoyije_outflow_lst else 0 end r_amt_outflow
    ,tax_expen
    ,tax_expen_lst
    ,case when tax_expen_lst>0 then (t1.tax_expen-tax_expen_lst)/tax_expen_lst else 0 end r_tax_expen
    ,electricity_expen
    ,electricity_expen_lst
    ,case when electricity_expen_lst>0 then (t1.electricity_expen-electricity_expen_lst)/electricity_expen_lst else 0 end r_electricity_expen
    ,amt_netflow
    ,amt_netflow_lst
    ,case when amt_netflow_lst>0 then (amt_netflow-amt_netflow_lst)/amt_netflow_lst else 0 end r_amt_netflow
    ,cur_act_bal
    ,cur_act_bal_lst
    ,case when cur_act_bal_lst>0 then (t1.cur_act_bal-cur_act_bal_lst)/cur_act_bal_lst else 0 end r_cur_act_bal
from SJXQ_SJ2024012611_CST_20221231_01 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_02 AS
select t1.enterprise_type                          --企业类型
    ,t1.entp_pay_wages/100000000 entp_pay_wages
    ,t2.entp_pay_wages/100000000 entp_pay_wages_lst
    ,(t1.entp_pay_wages-t2.entp_pay_wages)/t2.entp_pay_wages r_entp_pay_wages
    ,t1.entp_num_a
    ,t1.current_pay_wages_a/100000000 current_pay_wages_a
    ,t2.current_pay_wages_a/100000000 current_pay_wages_a_lst
    ,(t1.current_pay_wages_a-t2.current_pay_wages_a)/t2.current_pay_wages_a r_current_pay_wages_a
    ,t1.entp_num_b
    ,t1.current_pay_wages_b/100000000 current_pay_wages_b
    ,t2.current_pay_wages_b/100000000 current_pay_wages_b_lst
    ,(t1.current_pay_wages_b-t2.current_pay_wages_b)/t2.current_pay_wages_b r_current_pay_wages_b
    ,t1.entp_num_c
    ,t1.current_pay_wages_c/100000000 current_pay_wages_c
    ,t2.current_pay_wages_c/100000000 current_pay_wages_c_lst
    ,(t1.current_pay_wages_c-t2.current_pay_wages_c)/t2.current_pay_wages_c r_current_pay_wages_c
    ,t1.entp_num_d
    ,t1.current_pay_wages_d/100000000 current_pay_wages_d
    ,t2.current_pay_wages_d/100000000 current_pay_wages_d_lst
    ,(t1.current_pay_wages_d-t2.current_pay_wages_d)/t2.current_pay_wages_d r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,t2.entp_pay_wages_num entp_pay_wages_num_lst
    ,(t1.entp_pay_wages_num-t2.entp_pay_wages_num)/t2.entp_pay_wages_num r_entp_pay_wages_num
from adm_upss.entp_cust_pay_wages_info_i       t1 --代发工资情况
left join adm_upss.entp_cust_pay_wages_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20221231'
where t1.dt='20221231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_02_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_02_1 AS
select t1.enterprise_type                          --企业类型
    ,entp_pay_wages
    ,entp_pay_wages_lst
    ,case when entp_pay_wages_lst>0 then (t1.entp_pay_wages-entp_pay_wages_lst)/entp_pay_wages_lst else 0 end r_entp_pay_wages
    ,t1.entp_num_a
    ,current_pay_wages_a
    ,current_pay_wages_a_lst
    ,case when current_pay_wages_a_lst>0 then (t1.current_pay_wages_a-current_pay_wages_a_lst)/current_pay_wages_a_lst else 0 end r_current_pay_wages_a
    ,t1.entp_num_b
    ,current_pay_wages_b
    ,current_pay_wages_b_lst
    ,case when current_pay_wages_b_lst>0 then (t1.current_pay_wages_b-current_pay_wages_b_lst)/current_pay_wages_b_lst else 0 end r_current_pay_wages_b
    ,t1.entp_num_c
    ,current_pay_wages_c
    ,current_pay_wages_c_lst
    ,case when current_pay_wages_c_lst>0 then (t1.current_pay_wages_c-current_pay_wages_c_lst)/current_pay_wages_c_lst else 0 end r_current_pay_wages_c
    ,t1.entp_num_d
    ,current_pay_wages_d
    ,current_pay_wages_d_lst
    ,case when current_pay_wages_d_lst>0 then (t1.current_pay_wages_d-current_pay_wages_d_lst)/current_pay_wages_d_lst else 0 end r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,entp_pay_wages_num_lst
    ,case when entp_pay_wages_num_lst>0 then (t1.entp_pay_wages_num-entp_pay_wages_num_lst)/entp_pay_wages_num_lst else 0 end r_entp_pay_wages_num
from SJXQ_SJ2024012611_CST_20221231_02 t1
;
--流入动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_03 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20221231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_03_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_03_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20221231_03 t1
;
--流出动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_04 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20221231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_04_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_04_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20221231_04 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_05 AS
select t1.enterprise_type                          --企业类型
    ,round(t1.internation_setll_summ/100000000,2) internation_setll_summ
    ,round(t2.internation_setll_summ/100000000,2) internation_setll_summ_lst
    ,(t1.internation_setll_summ-t2.internation_setll_summ)/t2.internation_setll_summ r_internation_setll_summ
    ,round(t1.inward_summart/100000000,2) inward_summart
    ,round(t2.inward_summart/100000000,2) inward_summart_lst
    ,(t1.inward_summart-t2.inward_summart)/t2.inward_summart r_inward_summart
    ,round(t1.export_settlem/100000000,2) export_settlem
    ,round(t2.export_settlem/100000000,2) export_settlem_lst
    ,(t1.export_settlem-t2.export_settlem)/t2.export_settlem r_export_settlem
    ,round(t1.feimao_export_settlem/100000000,2) feimao_export_settlem
    ,round(t2.feimao_export_settlem/100000000,2) feimao_export_settlem_lst
    ,(t1.feimao_export_settlem-t2.feimao_export_settlem)/t2.feimao_export_settlem r_feimao_export_settlem
    ,round(t1.outward_summart/100000000,2) outward_summart
    ,round(t2.outward_summart/100000000,2) outward_summart_lst
    ,(t1.outward_summart-t2.outward_summart)/t2.outward_summart r_outward_summart
    ,round(t1.import_settlem/100000000,2) import_settlem
    ,round(t2.import_settlem/100000000,2) import_settlem_lst
    ,(t1.import_settlem-t2.import_settlem)/t2.import_settlem r_import_settlem
    ,round(t1.feimao_import_settlem/100000000,2) feimao_import_settlem
    ,round(t2.feimao_import_settlem/100000000,2) feimao_import_settlem_lst
    ,(t1.feimao_import_settlem-t2.feimao_import_settlem)/t2.feimao_import_settlem r_feimao_import_settlem
from adm_upss.entp_internation_setll_info_i       t1 --国际结算
left join adm_upss.entp_internation_setll_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20221231'
where t1.dt='20221231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20221231_05_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20221231_05_1 AS
select t1.enterprise_type                          --企业类型
    ,internation_setll_summ
    ,internation_setll_summ_lst
    ,case when internation_setll_summ_lst>0 then (t1.internation_setll_summ-internation_setll_summ_lst)/internation_setll_summ_lst else 0 end r_internation_setll_summ
    ,inward_summart
    ,inward_summart_lst
    ,case when inward_summart_lst>0 then (t1.inward_summart-inward_summart_lst)/inward_summart_lst else 0 end r_inward_summart
    ,export_settlem
    ,export_settlem_lst
    ,case when export_settlem_lst>0 then (t1.export_settlem-export_settlem_lst)/export_settlem_lst else 0 end r_export_settlem
    ,feimao_export_settlem
    ,feimao_export_settlem_lst
    ,case when feimao_export_settlem_lst>0 then (t1.feimao_export_settlem-feimao_export_settlem_lst)/feimao_export_settlem_lst else 0 end r_feimao_export_settlem
    ,outward_summart
    ,outward_summart_lst
    ,case when outward_summart_lst>0 then (t1.outward_summart-outward_summart_lst)/outward_summart_lst else 0 end r_outward_summart
    ,import_settlem
    ,import_settlem_lst
    ,case when import_settlem_lst>0 then (t1.import_settlem-import_settlem_lst)/import_settlem_lst else 0 end r_import_settlem
    ,feimao_import_settlem
    ,feimao_import_settlem_lst
    ,case when feimao_import_settlem_lst>0 then (t1.feimao_import_settlem-feimao_import_settlem_lst)/feimao_import_settlem_lst else 0 end r_feimao_import_settlem
from SJXQ_SJ2024012611_CST_20221231_05 t1
;
--输出结果
SELECT *
from SJXQ_SJ2024012611_CST_20221231_01_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20221231_02_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20221231_03_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20221231_04_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20221231_05_1
***SJ2024012611-疫后经济监管报表_20230331.sql
--20230331 时点数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_01 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,t2.enterprise_num enterprise_num_lst
    ,(t1.enterprise_num-t2.enterprise_num)/t2.enterprise_num r_enterprise_num
    ,round(t1.jiaoyije_inflow/100000000,2) jiaoyije_inflow
    ,round(t2.jiaoyije_inflow/100000000,2) jiaoyije_inflow_lst
    ,(t1.jiaoyije_inflow-t2.jiaoyije_inflow)/t2.jiaoyije_inflow r_amt_inflow
    ,t1.enterprise_num_a
    ,round(t1.jiaoyije_in_a/100000000,2) jiaoyije_in_a
    ,round(t2.jiaoyije_in_a/100000000,2) jiaoyije_in_a_lst
    ,(t1.jiaoyije_in_a-t2.jiaoyije_in_a)/t2.jiaoyije_in_a r_amt_in_a
    ,t1.enterprise_num_b
    ,round(t1.jiaoyije_in_b/100000000,2) jiaoyije_in_b
    ,round(t2.jiaoyije_in_b/100000000,2) jiaoyije_in_b_lst
    ,(t1.jiaoyije_in_b-t2.jiaoyije_in_b)/t2.jiaoyije_in_b r_amt_in_b
    ,t1.enterprise_num_c
    ,round(t1.jiaoyije_in_c/100000000,2) jiaoyije_in_c
    ,round(t2.jiaoyije_in_c/100000000,2) jiaoyije_in_c_lst
    ,(t1.jiaoyije_in_c-t2.jiaoyije_in_c)/t2.jiaoyije_in_c r_amt_in_c
    ,t1.enterprise_num_d
    ,round(t1.jiaoyije_in_d/100000000,2) jiaoyije_in_d
    ,round(t2.jiaoyije_in_d/100000000,2) jiaoyije_in_d_lst
    ,(t1.jiaoyije_in_d-t2.jiaoyije_in_d)/t2.jiaoyije_in_d r_amt_in_d
    ,round(t1.jiaoyije_outflow/100000000,2) jiaoyije_outflow
    ,round(t2.jiaoyije_outflow/100000000,2) jiaoyije_outflow_lst
    ,(t1.jiaoyije_outflow-t2.jiaoyije_outflow)/t2.jiaoyije_outflow r_amt_outflow
    ,round(t1.tax_expen/100000000,2) tax_expen
    ,round(t2.tax_expen/100000000,2) tax_expen_lst
    ,(t1.tax_expen-t2.tax_expen)/t2.tax_expen r_tax_expen
    ,round(t1.electricity_expen/100000000,2) electricity_expen
    ,round(t2.electricity_expen/100000000,2) electricity_expen_lst
    ,(t1.electricity_expen-t2.electricity_expen)/t2.electricity_expen r_electricity_expen
    ,round((t1.jiaoyije_inflow-t1.jiaoyije_outflow)/100000000,2) amt_netflow
    ,round((t2.jiaoyije_inflow-t2.jiaoyije_outflow)/100000000,2) amt_netflow_lst
    ,(t1.jiaoyije_inflow-t1.jiaoyije_outflow-t2.jiaoyije_inflow+t2.jiaoyije_outflow)/(t2.jiaoyije_inflow-t2.jiaoyije_outflow) r_amt_netflow
    ,round(t1.cur_act_bal/100000000,2) cur_act_bal
    ,round(t2.cur_act_bal/100000000,2) cur_act_bal_lst
    ,(t1.cur_act_bal-t2.cur_act_bal)/t2.cur_act_bal r_cur_act_bal
from adm_upss.entp_cust_captail_tb_info_i       t1 --账户资金情况
left join adm_upss.entp_cust_captail_tb_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230331'
where t1.dt='20230331'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_01_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_01_1 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,enterprise_num_lst
    ,r_enterprise_num
    ,jiaoyije_inflow
    ,jiaoyije_inflow_lst
    ,case when jiaoyije_inflow_lst>0 then (t1.jiaoyije_inflow-jiaoyije_inflow_lst)/jiaoyije_inflow_lst else 0 end r_amt_inflow
    ,t1.enterprise_num_a
    ,jiaoyije_in_a
    ,jiaoyije_in_a_lst
    ,case when jiaoyije_in_a_lst>0 then (t1.jiaoyije_in_a-jiaoyije_in_a_lst)/jiaoyije_in_a_lst else 0 end r_amt_in_a
    ,t1.enterprise_num_b
    ,jiaoyije_in_b
    ,jiaoyije_in_b_lst
    ,case when jiaoyije_in_b_lst>0 then (t1.jiaoyije_in_b-jiaoyije_in_b_lst)/jiaoyije_in_b_lst else 0 end r_amt_in_b
    ,t1.enterprise_num_c
    ,jiaoyije_in_c
    ,jiaoyije_in_c_lst
    ,case when jiaoyije_in_c_lst>0 then (t1.jiaoyije_in_c-jiaoyije_in_c_lst)/jiaoyije_in_c_lst else 0 end r_amt_in_c
    ,t1.enterprise_num_d
    ,jiaoyije_in_d
    ,jiaoyije_in_d_lst
    ,case when jiaoyije_in_d_lst>0 then (t1.jiaoyije_in_d-jiaoyije_in_d_lst)/jiaoyije_in_d_lst else 0 end r_amt_in_d
    ,jiaoyije_outflow
    ,jiaoyije_outflow_lst
    ,case when jiaoyije_outflow_lst>0 then (t1.jiaoyije_outflow-jiaoyije_outflow_lst)/jiaoyije_outflow_lst else 0 end r_amt_outflow
    ,tax_expen
    ,tax_expen_lst
    ,case when tax_expen_lst>0 then (t1.tax_expen-tax_expen_lst)/tax_expen_lst else 0 end r_tax_expen
    ,electricity_expen
    ,electricity_expen_lst
    ,case when electricity_expen_lst>0 then (t1.electricity_expen-electricity_expen_lst)/electricity_expen_lst else 0 end r_electricity_expen
    ,amt_netflow
    ,amt_netflow_lst
    ,case when amt_netflow_lst>0 then (amt_netflow-amt_netflow_lst)/amt_netflow_lst else 0 end r_amt_netflow
    ,cur_act_bal
    ,cur_act_bal_lst
    ,case when cur_act_bal_lst>0 then (t1.cur_act_bal-cur_act_bal_lst)/cur_act_bal_lst else 0 end r_cur_act_bal
from SJXQ_SJ2024012611_CST_20230331_01 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_02 AS
select t1.enterprise_type                          --企业类型
    ,t1.entp_pay_wages/100000000 entp_pay_wages
    ,t2.entp_pay_wages/100000000 entp_pay_wages_lst
    ,(t1.entp_pay_wages-t2.entp_pay_wages)/t2.entp_pay_wages r_entp_pay_wages
    ,t1.entp_num_a
    ,t1.current_pay_wages_a/100000000 current_pay_wages_a
    ,t2.current_pay_wages_a/100000000 current_pay_wages_a_lst
    ,(t1.current_pay_wages_a-t2.current_pay_wages_a)/t2.current_pay_wages_a r_current_pay_wages_a
    ,t1.entp_num_b
    ,t1.current_pay_wages_b/100000000 current_pay_wages_b
    ,t2.current_pay_wages_b/100000000 current_pay_wages_b_lst
    ,(t1.current_pay_wages_b-t2.current_pay_wages_b)/t2.current_pay_wages_b r_current_pay_wages_b
    ,t1.entp_num_c
    ,t1.current_pay_wages_c/100000000 current_pay_wages_c
    ,t2.current_pay_wages_c/100000000 current_pay_wages_c_lst
    ,(t1.current_pay_wages_c-t2.current_pay_wages_c)/t2.current_pay_wages_c r_current_pay_wages_c
    ,t1.entp_num_d
    ,t1.current_pay_wages_d/100000000 current_pay_wages_d
    ,t2.current_pay_wages_d/100000000 current_pay_wages_d_lst
    ,(t1.current_pay_wages_d-t2.current_pay_wages_d)/t2.current_pay_wages_d r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,t2.entp_pay_wages_num entp_pay_wages_num_lst
    ,(t1.entp_pay_wages_num-t2.entp_pay_wages_num)/t2.entp_pay_wages_num r_entp_pay_wages_num
from adm_upss.entp_cust_pay_wages_info_i       t1 --代发工资情况
left join adm_upss.entp_cust_pay_wages_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230331'
where t1.dt='20230331'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_02_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_02_1 AS
select t1.enterprise_type                          --企业类型
    ,entp_pay_wages
    ,entp_pay_wages_lst
    ,case when entp_pay_wages_lst>0 then (t1.entp_pay_wages-entp_pay_wages_lst)/entp_pay_wages_lst else 0 end r_entp_pay_wages
    ,t1.entp_num_a
    ,current_pay_wages_a
    ,current_pay_wages_a_lst
    ,case when current_pay_wages_a_lst>0 then (t1.current_pay_wages_a-current_pay_wages_a_lst)/current_pay_wages_a_lst else 0 end r_current_pay_wages_a
    ,t1.entp_num_b
    ,current_pay_wages_b
    ,current_pay_wages_b_lst
    ,case when current_pay_wages_b_lst>0 then (t1.current_pay_wages_b-current_pay_wages_b_lst)/current_pay_wages_b_lst else 0 end r_current_pay_wages_b
    ,t1.entp_num_c
    ,current_pay_wages_c
    ,current_pay_wages_c_lst
    ,case when current_pay_wages_c_lst>0 then (t1.current_pay_wages_c-current_pay_wages_c_lst)/current_pay_wages_c_lst else 0 end r_current_pay_wages_c
    ,t1.entp_num_d
    ,current_pay_wages_d
    ,current_pay_wages_d_lst
    ,case when current_pay_wages_d_lst>0 then (t1.current_pay_wages_d-current_pay_wages_d_lst)/current_pay_wages_d_lst else 0 end r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,entp_pay_wages_num_lst
    ,case when entp_pay_wages_num_lst>0 then (t1.entp_pay_wages_num-entp_pay_wages_num_lst)/entp_pay_wages_num_lst else 0 end r_entp_pay_wages_num
from SJXQ_SJ2024012611_CST_20230331_02 t1
;
--流入动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_03 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20230331'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_03_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_03_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20230331_03 t1
;
--流出动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_04 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20230331'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_04_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_04_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20230331_04 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_05 AS
select t1.enterprise_type                          --企业类型
    ,round(t1.internation_setll_summ/100000000,2) internation_setll_summ
    ,round(t2.internation_setll_summ/100000000,2) internation_setll_summ_lst
    ,(t1.internation_setll_summ-t2.internation_setll_summ)/t2.internation_setll_summ r_internation_setll_summ
    ,round(t1.inward_summart/100000000,2) inward_summart
    ,round(t2.inward_summart/100000000,2) inward_summart_lst
    ,(t1.inward_summart-t2.inward_summart)/t2.inward_summart r_inward_summart
    ,round(t1.export_settlem/100000000,2) export_settlem
    ,round(t2.export_settlem/100000000,2) export_settlem_lst
    ,(t1.export_settlem-t2.export_settlem)/t2.export_settlem r_export_settlem
    ,round(t1.feimao_export_settlem/100000000,2) feimao_export_settlem
    ,round(t2.feimao_export_settlem/100000000,2) feimao_export_settlem_lst
    ,(t1.feimao_export_settlem-t2.feimao_export_settlem)/t2.feimao_export_settlem r_feimao_export_settlem
    ,round(t1.outward_summart/100000000,2) outward_summart
    ,round(t2.outward_summart/100000000,2) outward_summart_lst
    ,(t1.outward_summart-t2.outward_summart)/t2.outward_summart r_outward_summart
    ,round(t1.import_settlem/100000000,2) import_settlem
    ,round(t2.import_settlem/100000000,2) import_settlem_lst
    ,(t1.import_settlem-t2.import_settlem)/t2.import_settlem r_import_settlem
    ,round(t1.feimao_import_settlem/100000000,2) feimao_import_settlem
    ,round(t2.feimao_import_settlem/100000000,2) feimao_import_settlem_lst
    ,(t1.feimao_import_settlem-t2.feimao_import_settlem)/t2.feimao_import_settlem r_feimao_import_settlem
from adm_upss.entp_internation_setll_info_i       t1 --国际结算
left join adm_upss.entp_internation_setll_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230331'
where t1.dt='20230331'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230331_05_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230331_05_1 AS
select t1.enterprise_type                          --企业类型
    ,internation_setll_summ
    ,internation_setll_summ_lst
    ,case when internation_setll_summ_lst>0 then (t1.internation_setll_summ-internation_setll_summ_lst)/internation_setll_summ_lst else 0 end r_internation_setll_summ
    ,inward_summart
    ,inward_summart_lst
    ,case when inward_summart_lst>0 then (t1.inward_summart-inward_summart_lst)/inward_summart_lst else 0 end r_inward_summart
    ,export_settlem
    ,export_settlem_lst
    ,case when export_settlem_lst>0 then (t1.export_settlem-export_settlem_lst)/export_settlem_lst else 0 end r_export_settlem
    ,feimao_export_settlem
    ,feimao_export_settlem_lst
    ,case when feimao_export_settlem_lst>0 then (t1.feimao_export_settlem-feimao_export_settlem_lst)/feimao_export_settlem_lst else 0 end r_feimao_export_settlem
    ,outward_summart
    ,outward_summart_lst
    ,case when outward_summart_lst>0 then (t1.outward_summart-outward_summart_lst)/outward_summart_lst else 0 end r_outward_summart
    ,import_settlem
    ,import_settlem_lst
    ,case when import_settlem_lst>0 then (t1.import_settlem-import_settlem_lst)/import_settlem_lst else 0 end r_import_settlem
    ,feimao_import_settlem
    ,feimao_import_settlem_lst
    ,case when feimao_import_settlem_lst>0 then (t1.feimao_import_settlem-feimao_import_settlem_lst)/feimao_import_settlem_lst else 0 end r_feimao_import_settlem
from SJXQ_SJ2024012611_CST_20230331_05 t1
;
--输出结果
SELECT *
from SJXQ_SJ2024012611_CST_20230331_01_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230331_02_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230331_03_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230331_04_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230331_05_1
***SJ2024012611-疫后经济监管报表_20230630.sql
--20230630 时点数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_01 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,t2.enterprise_num enterprise_num_lst
    ,(t1.enterprise_num-t2.enterprise_num)/t2.enterprise_num r_enterprise_num
    ,round(t1.jiaoyije_inflow/100000000,2) jiaoyije_inflow
    ,round(t2.jiaoyije_inflow/100000000,2) jiaoyije_inflow_lst
    ,(t1.jiaoyije_inflow-t2.jiaoyije_inflow)/t2.jiaoyije_inflow r_amt_inflow
    ,t1.enterprise_num_a
    ,round(t1.jiaoyije_in_a/100000000,2) jiaoyije_in_a
    ,round(t2.jiaoyije_in_a/100000000,2) jiaoyije_in_a_lst
    ,(t1.jiaoyije_in_a-t2.jiaoyije_in_a)/t2.jiaoyije_in_a r_amt_in_a
    ,t1.enterprise_num_b
    ,round(t1.jiaoyije_in_b/100000000,2) jiaoyije_in_b
    ,round(t2.jiaoyije_in_b/100000000,2) jiaoyije_in_b_lst
    ,(t1.jiaoyije_in_b-t2.jiaoyije_in_b)/t2.jiaoyije_in_b r_amt_in_b
    ,t1.enterprise_num_c
    ,round(t1.jiaoyije_in_c/100000000,2) jiaoyije_in_c
    ,round(t2.jiaoyije_in_c/100000000,2) jiaoyije_in_c_lst
    ,(t1.jiaoyije_in_c-t2.jiaoyije_in_c)/t2.jiaoyije_in_c r_amt_in_c
    ,t1.enterprise_num_d
    ,round(t1.jiaoyije_in_d/100000000,2) jiaoyije_in_d
    ,round(t2.jiaoyije_in_d/100000000,2) jiaoyije_in_d_lst
    ,(t1.jiaoyije_in_d-t2.jiaoyije_in_d)/t2.jiaoyije_in_d r_amt_in_d
    ,round(t1.jiaoyije_outflow/100000000,2) jiaoyije_outflow
    ,round(t2.jiaoyije_outflow/100000000,2) jiaoyije_outflow_lst
    ,(t1.jiaoyije_outflow-t2.jiaoyije_outflow)/t2.jiaoyije_outflow r_amt_outflow
    ,round(t1.tax_expen/100000000,2) tax_expen
    ,round(t2.tax_expen/100000000,2) tax_expen_lst
    ,(t1.tax_expen-t2.tax_expen)/t2.tax_expen r_tax_expen
    ,round(t1.electricity_expen/100000000,2) electricity_expen
    ,round(t2.electricity_expen/100000000,2) electricity_expen_lst
    ,(t1.electricity_expen-t2.electricity_expen)/t2.electricity_expen r_electricity_expen
    ,round((t1.jiaoyije_inflow-t1.jiaoyije_outflow)/100000000,2) amt_netflow
    ,round((t2.jiaoyije_inflow-t2.jiaoyije_outflow)/100000000,2) amt_netflow_lst
    ,(t1.jiaoyije_inflow-t1.jiaoyije_outflow-t2.jiaoyije_inflow+t2.jiaoyije_outflow)/(t2.jiaoyije_inflow-t2.jiaoyije_outflow) r_amt_netflow
    ,round(t1.cur_act_bal/100000000,2) cur_act_bal
    ,round(t2.cur_act_bal/100000000,2) cur_act_bal_lst
    ,(t1.cur_act_bal-t2.cur_act_bal)/t2.cur_act_bal r_cur_act_bal
from adm_upss.entp_cust_captail_tb_info_i       t1 --账户资金情况
left join adm_upss.entp_cust_captail_tb_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230630'
where t1.dt='20230630'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_01_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_01_1 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,enterprise_num_lst
    ,r_enterprise_num
    ,jiaoyije_inflow
    ,jiaoyije_inflow_lst
    ,case when jiaoyije_inflow_lst>0 then (t1.jiaoyije_inflow-jiaoyije_inflow_lst)/jiaoyije_inflow_lst else 0 end r_amt_inflow
    ,t1.enterprise_num_a
    ,jiaoyije_in_a
    ,jiaoyije_in_a_lst
    ,case when jiaoyije_in_a_lst>0 then (t1.jiaoyije_in_a-jiaoyije_in_a_lst)/jiaoyije_in_a_lst else 0 end r_amt_in_a
    ,t1.enterprise_num_b
    ,jiaoyije_in_b
    ,jiaoyije_in_b_lst
    ,case when jiaoyije_in_b_lst>0 then (t1.jiaoyije_in_b-jiaoyije_in_b_lst)/jiaoyije_in_b_lst else 0 end r_amt_in_b
    ,t1.enterprise_num_c
    ,jiaoyije_in_c
    ,jiaoyije_in_c_lst
    ,case when jiaoyije_in_c_lst>0 then (t1.jiaoyije_in_c-jiaoyije_in_c_lst)/jiaoyije_in_c_lst else 0 end r_amt_in_c
    ,t1.enterprise_num_d
    ,jiaoyije_in_d
    ,jiaoyije_in_d_lst
    ,case when jiaoyije_in_d_lst>0 then (t1.jiaoyije_in_d-jiaoyije_in_d_lst)/jiaoyije_in_d_lst else 0 end r_amt_in_d
    ,jiaoyije_outflow
    ,jiaoyije_outflow_lst
    ,case when jiaoyije_outflow_lst>0 then (t1.jiaoyije_outflow-jiaoyije_outflow_lst)/jiaoyije_outflow_lst else 0 end r_amt_outflow
    ,tax_expen
    ,tax_expen_lst
    ,case when tax_expen_lst>0 then (t1.tax_expen-tax_expen_lst)/tax_expen_lst else 0 end r_tax_expen
    ,electricity_expen
    ,electricity_expen_lst
    ,case when electricity_expen_lst>0 then (t1.electricity_expen-electricity_expen_lst)/electricity_expen_lst else 0 end r_electricity_expen
    ,amt_netflow
    ,amt_netflow_lst
    ,case when amt_netflow_lst>0 then (amt_netflow-amt_netflow_lst)/amt_netflow_lst else 0 end r_amt_netflow
    ,cur_act_bal
    ,cur_act_bal_lst
    ,case when cur_act_bal_lst>0 then (t1.cur_act_bal-cur_act_bal_lst)/cur_act_bal_lst else 0 end r_cur_act_bal
from SJXQ_SJ2024012611_CST_20230630_01 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_02 AS
select t1.enterprise_type                          --企业类型
    ,t1.entp_pay_wages/100000000 entp_pay_wages
    ,t2.entp_pay_wages/100000000 entp_pay_wages_lst
    ,(t1.entp_pay_wages-t2.entp_pay_wages)/t2.entp_pay_wages r_entp_pay_wages
    ,t1.entp_num_a
    ,t1.current_pay_wages_a/100000000 current_pay_wages_a
    ,t2.current_pay_wages_a/100000000 current_pay_wages_a_lst
    ,(t1.current_pay_wages_a-t2.current_pay_wages_a)/t2.current_pay_wages_a r_current_pay_wages_a
    ,t1.entp_num_b
    ,t1.current_pay_wages_b/100000000 current_pay_wages_b
    ,t2.current_pay_wages_b/100000000 current_pay_wages_b_lst
    ,(t1.current_pay_wages_b-t2.current_pay_wages_b)/t2.current_pay_wages_b r_current_pay_wages_b
    ,t1.entp_num_c
    ,t1.current_pay_wages_c/100000000 current_pay_wages_c
    ,t2.current_pay_wages_c/100000000 current_pay_wages_c_lst
    ,(t1.current_pay_wages_c-t2.current_pay_wages_c)/t2.current_pay_wages_c r_current_pay_wages_c
    ,t1.entp_num_d
    ,t1.current_pay_wages_d/100000000 current_pay_wages_d
    ,t2.current_pay_wages_d/100000000 current_pay_wages_d_lst
    ,(t1.current_pay_wages_d-t2.current_pay_wages_d)/t2.current_pay_wages_d r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,t2.entp_pay_wages_num entp_pay_wages_num_lst
    ,(t1.entp_pay_wages_num-t2.entp_pay_wages_num)/t2.entp_pay_wages_num r_entp_pay_wages_num
from adm_upss.entp_cust_pay_wages_info_i       t1 --代发工资情况
left join adm_upss.entp_cust_pay_wages_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230630'
where t1.dt='20230630'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_02_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_02_1 AS
select t1.enterprise_type                          --企业类型
    ,entp_pay_wages
    ,entp_pay_wages_lst
    ,case when entp_pay_wages_lst>0 then (t1.entp_pay_wages-entp_pay_wages_lst)/entp_pay_wages_lst else 0 end r_entp_pay_wages
    ,t1.entp_num_a
    ,current_pay_wages_a
    ,current_pay_wages_a_lst
    ,case when current_pay_wages_a_lst>0 then (t1.current_pay_wages_a-current_pay_wages_a_lst)/current_pay_wages_a_lst else 0 end r_current_pay_wages_a
    ,t1.entp_num_b
    ,current_pay_wages_b
    ,current_pay_wages_b_lst
    ,case when current_pay_wages_b_lst>0 then (t1.current_pay_wages_b-current_pay_wages_b_lst)/current_pay_wages_b_lst else 0 end r_current_pay_wages_b
    ,t1.entp_num_c
    ,current_pay_wages_c
    ,current_pay_wages_c_lst
    ,case when current_pay_wages_c_lst>0 then (t1.current_pay_wages_c-current_pay_wages_c_lst)/current_pay_wages_c_lst else 0 end r_current_pay_wages_c
    ,t1.entp_num_d
    ,current_pay_wages_d
    ,current_pay_wages_d_lst
    ,case when current_pay_wages_d_lst>0 then (t1.current_pay_wages_d-current_pay_wages_d_lst)/current_pay_wages_d_lst else 0 end r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,entp_pay_wages_num_lst
    ,case when entp_pay_wages_num_lst>0 then (t1.entp_pay_wages_num-entp_pay_wages_num_lst)/entp_pay_wages_num_lst else 0 end r_entp_pay_wages_num
from SJXQ_SJ2024012611_CST_20230630_02 t1
;
--流入动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_03 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20230630'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_03_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_03_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20230630_03 t1
;
--流出动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_04 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20230630'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_04_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_04_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20230630_04 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_05 AS
select t1.enterprise_type                          --企业类型
    ,round(t1.internation_setll_summ/100000000,2) internation_setll_summ
    ,round(t2.internation_setll_summ/100000000,2) internation_setll_summ_lst
    ,(t1.internation_setll_summ-t2.internation_setll_summ)/t2.internation_setll_summ r_internation_setll_summ
    ,round(t1.inward_summart/100000000,2) inward_summart
    ,round(t2.inward_summart/100000000,2) inward_summart_lst
    ,(t1.inward_summart-t2.inward_summart)/t2.inward_summart r_inward_summart
    ,round(t1.export_settlem/100000000,2) export_settlem
    ,round(t2.export_settlem/100000000,2) export_settlem_lst
    ,(t1.export_settlem-t2.export_settlem)/t2.export_settlem r_export_settlem
    ,round(t1.feimao_export_settlem/100000000,2) feimao_export_settlem
    ,round(t2.feimao_export_settlem/100000000,2) feimao_export_settlem_lst
    ,(t1.feimao_export_settlem-t2.feimao_export_settlem)/t2.feimao_export_settlem r_feimao_export_settlem
    ,round(t1.outward_summart/100000000,2) outward_summart
    ,round(t2.outward_summart/100000000,2) outward_summart_lst
    ,(t1.outward_summart-t2.outward_summart)/t2.outward_summart r_outward_summart
    ,round(t1.import_settlem/100000000,2) import_settlem
    ,round(t2.import_settlem/100000000,2) import_settlem_lst
    ,(t1.import_settlem-t2.import_settlem)/t2.import_settlem r_import_settlem
    ,round(t1.feimao_import_settlem/100000000,2) feimao_import_settlem
    ,round(t2.feimao_import_settlem/100000000,2) feimao_import_settlem_lst
    ,(t1.feimao_import_settlem-t2.feimao_import_settlem)/t2.feimao_import_settlem r_feimao_import_settlem
from adm_upss.entp_internation_setll_info_i       t1 --国际结算
left join adm_upss.entp_internation_setll_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230630'
where t1.dt='20230630'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230630_05_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230630_05_1 AS
select t1.enterprise_type                          --企业类型
    ,internation_setll_summ
    ,internation_setll_summ_lst
    ,case when internation_setll_summ_lst>0 then (t1.internation_setll_summ-internation_setll_summ_lst)/internation_setll_summ_lst else 0 end r_internation_setll_summ
    ,inward_summart
    ,inward_summart_lst
    ,case when inward_summart_lst>0 then (t1.inward_summart-inward_summart_lst)/inward_summart_lst else 0 end r_inward_summart
    ,export_settlem
    ,export_settlem_lst
    ,case when export_settlem_lst>0 then (t1.export_settlem-export_settlem_lst)/export_settlem_lst else 0 end r_export_settlem
    ,feimao_export_settlem
    ,feimao_export_settlem_lst
    ,case when feimao_export_settlem_lst>0 then (t1.feimao_export_settlem-feimao_export_settlem_lst)/feimao_export_settlem_lst else 0 end r_feimao_export_settlem
    ,outward_summart
    ,outward_summart_lst
    ,case when outward_summart_lst>0 then (t1.outward_summart-outward_summart_lst)/outward_summart_lst else 0 end r_outward_summart
    ,import_settlem
    ,import_settlem_lst
    ,case when import_settlem_lst>0 then (t1.import_settlem-import_settlem_lst)/import_settlem_lst else 0 end r_import_settlem
    ,feimao_import_settlem
    ,feimao_import_settlem_lst
    ,case when feimao_import_settlem_lst>0 then (t1.feimao_import_settlem-feimao_import_settlem_lst)/feimao_import_settlem_lst else 0 end r_feimao_import_settlem
from SJXQ_SJ2024012611_CST_20230630_05 t1
;
--输出结果
SELECT *
from SJXQ_SJ2024012611_CST_20230630_01_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230630_02_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230630_03_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230630_04_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230630_05_1
***SJ2024012611-疫后经济监管报表_20230930.sql
--20230930 时点数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_01 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,t2.enterprise_num enterprise_num_lst
    ,(t1.enterprise_num-t2.enterprise_num)/t2.enterprise_num r_enterprise_num
    ,round(t1.jiaoyije_inflow/100000000,2) jiaoyije_inflow
    ,round(t2.jiaoyije_inflow/100000000,2) jiaoyije_inflow_lst
    ,(t1.jiaoyije_inflow-t2.jiaoyije_inflow)/t2.jiaoyije_inflow r_amt_inflow
    ,t1.enterprise_num_a
    ,round(t1.jiaoyije_in_a/100000000,2) jiaoyije_in_a
    ,round(t2.jiaoyije_in_a/100000000,2) jiaoyije_in_a_lst
    ,(t1.jiaoyije_in_a-t2.jiaoyije_in_a)/t2.jiaoyije_in_a r_amt_in_a
    ,t1.enterprise_num_b
    ,round(t1.jiaoyije_in_b/100000000,2) jiaoyije_in_b
    ,round(t2.jiaoyije_in_b/100000000,2) jiaoyije_in_b_lst
    ,(t1.jiaoyije_in_b-t2.jiaoyije_in_b)/t2.jiaoyije_in_b r_amt_in_b
    ,t1.enterprise_num_c
    ,round(t1.jiaoyije_in_c/100000000,2) jiaoyije_in_c
    ,round(t2.jiaoyije_in_c/100000000,2) jiaoyije_in_c_lst
    ,(t1.jiaoyije_in_c-t2.jiaoyije_in_c)/t2.jiaoyije_in_c r_amt_in_c
    ,t1.enterprise_num_d
    ,round(t1.jiaoyije_in_d/100000000,2) jiaoyije_in_d
    ,round(t2.jiaoyije_in_d/100000000,2) jiaoyije_in_d_lst
    ,(t1.jiaoyije_in_d-t2.jiaoyije_in_d)/t2.jiaoyije_in_d r_amt_in_d
    ,round(t1.jiaoyije_outflow/100000000,2) jiaoyije_outflow
    ,round(t2.jiaoyije_outflow/100000000,2) jiaoyije_outflow_lst
    ,(t1.jiaoyije_outflow-t2.jiaoyije_outflow)/t2.jiaoyije_outflow r_amt_outflow
    ,round(t1.tax_expen/100000000,2) tax_expen
    ,round(t2.tax_expen/100000000,2) tax_expen_lst
    ,(t1.tax_expen-t2.tax_expen)/t2.tax_expen r_tax_expen
    ,round(t1.electricity_expen/100000000,2) electricity_expen
    ,round(t2.electricity_expen/100000000,2) electricity_expen_lst
    ,(t1.electricity_expen-t2.electricity_expen)/t2.electricity_expen r_electricity_expen
    ,round((t1.jiaoyije_inflow-t1.jiaoyije_outflow)/100000000,2) amt_netflow
    ,round((t2.jiaoyije_inflow-t2.jiaoyije_outflow)/100000000,2) amt_netflow_lst
    ,(t1.jiaoyije_inflow-t1.jiaoyije_outflow-t2.jiaoyije_inflow+t2.jiaoyije_outflow)/(t2.jiaoyije_inflow-t2.jiaoyije_outflow) r_amt_netflow
    ,round(t1.cur_act_bal/100000000,2) cur_act_bal
    ,round(t2.cur_act_bal/100000000,2) cur_act_bal_lst
    ,(t1.cur_act_bal-t2.cur_act_bal)/t2.cur_act_bal r_cur_act_bal
from adm_upss.entp_cust_captail_tb_info_i       t1 --账户资金情况
left join adm_upss.entp_cust_captail_tb_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230930'
where t1.dt='20230930'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_01_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_01_1 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,enterprise_num_lst
    ,r_enterprise_num
    ,jiaoyije_inflow
    ,jiaoyije_inflow_lst
    ,case when jiaoyije_inflow_lst>0 then (t1.jiaoyije_inflow-jiaoyije_inflow_lst)/jiaoyije_inflow_lst else 0 end r_amt_inflow
    ,t1.enterprise_num_a
    ,jiaoyije_in_a
    ,jiaoyije_in_a_lst
    ,case when jiaoyije_in_a_lst>0 then (t1.jiaoyije_in_a-jiaoyije_in_a_lst)/jiaoyije_in_a_lst else 0 end r_amt_in_a
    ,t1.enterprise_num_b
    ,jiaoyije_in_b
    ,jiaoyije_in_b_lst
    ,case when jiaoyije_in_b_lst>0 then (t1.jiaoyije_in_b-jiaoyije_in_b_lst)/jiaoyije_in_b_lst else 0 end r_amt_in_b
    ,t1.enterprise_num_c
    ,jiaoyije_in_c
    ,jiaoyije_in_c_lst
    ,case when jiaoyije_in_c_lst>0 then (t1.jiaoyije_in_c-jiaoyije_in_c_lst)/jiaoyije_in_c_lst else 0 end r_amt_in_c
    ,t1.enterprise_num_d
    ,jiaoyije_in_d
    ,jiaoyije_in_d_lst
    ,case when jiaoyije_in_d_lst>0 then (t1.jiaoyije_in_d-jiaoyije_in_d_lst)/jiaoyije_in_d_lst else 0 end r_amt_in_d
    ,jiaoyije_outflow
    ,jiaoyije_outflow_lst
    ,case when jiaoyije_outflow_lst>0 then (t1.jiaoyije_outflow-jiaoyije_outflow_lst)/jiaoyije_outflow_lst else 0 end r_amt_outflow
    ,tax_expen
    ,tax_expen_lst
    ,case when tax_expen_lst>0 then (t1.tax_expen-tax_expen_lst)/tax_expen_lst else 0 end r_tax_expen
    ,electricity_expen
    ,electricity_expen_lst
    ,case when electricity_expen_lst>0 then (t1.electricity_expen-electricity_expen_lst)/electricity_expen_lst else 0 end r_electricity_expen
    ,amt_netflow
    ,amt_netflow_lst
    ,case when amt_netflow_lst>0 then (amt_netflow-amt_netflow_lst)/amt_netflow_lst else 0 end r_amt_netflow
    ,cur_act_bal
    ,cur_act_bal_lst
    ,case when cur_act_bal_lst>0 then (t1.cur_act_bal-cur_act_bal_lst)/cur_act_bal_lst else 0 end r_cur_act_bal
from SJXQ_SJ2024012611_CST_20230930_01 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_02 AS
select t1.enterprise_type                          --企业类型
    ,t1.entp_pay_wages/100000000 entp_pay_wages
    ,t2.entp_pay_wages/100000000 entp_pay_wages_lst
    ,(t1.entp_pay_wages-t2.entp_pay_wages)/t2.entp_pay_wages r_entp_pay_wages
    ,t1.entp_num_a
    ,t1.current_pay_wages_a/100000000 current_pay_wages_a
    ,t2.current_pay_wages_a/100000000 current_pay_wages_a_lst
    ,(t1.current_pay_wages_a-t2.current_pay_wages_a)/t2.current_pay_wages_a r_current_pay_wages_a
    ,t1.entp_num_b
    ,t1.current_pay_wages_b/100000000 current_pay_wages_b
    ,t2.current_pay_wages_b/100000000 current_pay_wages_b_lst
    ,(t1.current_pay_wages_b-t2.current_pay_wages_b)/t2.current_pay_wages_b r_current_pay_wages_b
    ,t1.entp_num_c
    ,t1.current_pay_wages_c/100000000 current_pay_wages_c
    ,t2.current_pay_wages_c/100000000 current_pay_wages_c_lst
    ,(t1.current_pay_wages_c-t2.current_pay_wages_c)/t2.current_pay_wages_c r_current_pay_wages_c
    ,t1.entp_num_d
    ,t1.current_pay_wages_d/100000000 current_pay_wages_d
    ,t2.current_pay_wages_d/100000000 current_pay_wages_d_lst
    ,(t1.current_pay_wages_d-t2.current_pay_wages_d)/t2.current_pay_wages_d r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,t2.entp_pay_wages_num entp_pay_wages_num_lst
    ,(t1.entp_pay_wages_num-t2.entp_pay_wages_num)/t2.entp_pay_wages_num r_entp_pay_wages_num
from adm_upss.entp_cust_pay_wages_info_i       t1 --代发工资情况
left join adm_upss.entp_cust_pay_wages_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230930'
where t1.dt='20230930'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_02_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_02_1 AS
select t1.enterprise_type                          --企业类型
    ,entp_pay_wages
    ,entp_pay_wages_lst
    ,case when entp_pay_wages_lst>0 then (t1.entp_pay_wages-entp_pay_wages_lst)/entp_pay_wages_lst else 0 end r_entp_pay_wages
    ,t1.entp_num_a
    ,current_pay_wages_a
    ,current_pay_wages_a_lst
    ,case when current_pay_wages_a_lst>0 then (t1.current_pay_wages_a-current_pay_wages_a_lst)/current_pay_wages_a_lst else 0 end r_current_pay_wages_a
    ,t1.entp_num_b
    ,current_pay_wages_b
    ,current_pay_wages_b_lst
    ,case when current_pay_wages_b_lst>0 then (t1.current_pay_wages_b-current_pay_wages_b_lst)/current_pay_wages_b_lst else 0 end r_current_pay_wages_b
    ,t1.entp_num_c
    ,current_pay_wages_c
    ,current_pay_wages_c_lst
    ,case when current_pay_wages_c_lst>0 then (t1.current_pay_wages_c-current_pay_wages_c_lst)/current_pay_wages_c_lst else 0 end r_current_pay_wages_c
    ,t1.entp_num_d
    ,current_pay_wages_d
    ,current_pay_wages_d_lst
    ,case when current_pay_wages_d_lst>0 then (t1.current_pay_wages_d-current_pay_wages_d_lst)/current_pay_wages_d_lst else 0 end r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,entp_pay_wages_num_lst
    ,case when entp_pay_wages_num_lst>0 then (t1.entp_pay_wages_num-entp_pay_wages_num_lst)/entp_pay_wages_num_lst else 0 end r_entp_pay_wages_num
from SJXQ_SJ2024012611_CST_20230930_02 t1
;
--流入动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_03 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20230930'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_03_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_03_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20230930_03 t1
;
--流出动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_04 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20230930'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_04_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_04_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20230930_04 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_05 AS
select t1.enterprise_type                          --企业类型
    ,round(t1.internation_setll_summ/100000000,2) internation_setll_summ
    ,round(t2.internation_setll_summ/100000000,2) internation_setll_summ_lst
    ,(t1.internation_setll_summ-t2.internation_setll_summ)/t2.internation_setll_summ r_internation_setll_summ
    ,round(t1.inward_summart/100000000,2) inward_summart
    ,round(t2.inward_summart/100000000,2) inward_summart_lst
    ,(t1.inward_summart-t2.inward_summart)/t2.inward_summart r_inward_summart
    ,round(t1.export_settlem/100000000,2) export_settlem
    ,round(t2.export_settlem/100000000,2) export_settlem_lst
    ,(t1.export_settlem-t2.export_settlem)/t2.export_settlem r_export_settlem
    ,round(t1.feimao_export_settlem/100000000,2) feimao_export_settlem
    ,round(t2.feimao_export_settlem/100000000,2) feimao_export_settlem_lst
    ,(t1.feimao_export_settlem-t2.feimao_export_settlem)/t2.feimao_export_settlem r_feimao_export_settlem
    ,round(t1.outward_summart/100000000,2) outward_summart
    ,round(t2.outward_summart/100000000,2) outward_summart_lst
    ,(t1.outward_summart-t2.outward_summart)/t2.outward_summart r_outward_summart
    ,round(t1.import_settlem/100000000,2) import_settlem
    ,round(t2.import_settlem/100000000,2) import_settlem_lst
    ,(t1.import_settlem-t2.import_settlem)/t2.import_settlem r_import_settlem
    ,round(t1.feimao_import_settlem/100000000,2) feimao_import_settlem
    ,round(t2.feimao_import_settlem/100000000,2) feimao_import_settlem_lst
    ,(t1.feimao_import_settlem-t2.feimao_import_settlem)/t2.feimao_import_settlem r_feimao_import_settlem
from adm_upss.entp_internation_setll_info_i       t1 --国际结算
left join adm_upss.entp_internation_setll_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20230930'
where t1.dt='20230930'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20230930_05_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20230930_05_1 AS
select t1.enterprise_type                          --企业类型
    ,internation_setll_summ
    ,internation_setll_summ_lst
    ,case when internation_setll_summ_lst>0 then (t1.internation_setll_summ-internation_setll_summ_lst)/internation_setll_summ_lst else 0 end r_internation_setll_summ
    ,inward_summart
    ,inward_summart_lst
    ,case when inward_summart_lst>0 then (t1.inward_summart-inward_summart_lst)/inward_summart_lst else 0 end r_inward_summart
    ,export_settlem
    ,export_settlem_lst
    ,case when export_settlem_lst>0 then (t1.export_settlem-export_settlem_lst)/export_settlem_lst else 0 end r_export_settlem
    ,feimao_export_settlem
    ,feimao_export_settlem_lst
    ,case when feimao_export_settlem_lst>0 then (t1.feimao_export_settlem-feimao_export_settlem_lst)/feimao_export_settlem_lst else 0 end r_feimao_export_settlem
    ,outward_summart
    ,outward_summart_lst
    ,case when outward_summart_lst>0 then (t1.outward_summart-outward_summart_lst)/outward_summart_lst else 0 end r_outward_summart
    ,import_settlem
    ,import_settlem_lst
    ,case when import_settlem_lst>0 then (t1.import_settlem-import_settlem_lst)/import_settlem_lst else 0 end r_import_settlem
    ,feimao_import_settlem
    ,feimao_import_settlem_lst
    ,case when feimao_import_settlem_lst>0 then (t1.feimao_import_settlem-feimao_import_settlem_lst)/feimao_import_settlem_lst else 0 end r_feimao_import_settlem
from SJXQ_SJ2024012611_CST_20230930_05 t1
;
--输出结果
SELECT *
from SJXQ_SJ2024012611_CST_20230930_01_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230930_02_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230930_03_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230930_04_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20230930_05_1
***SJ2024012611-疫后经济监管报表_20231231.sql
--20231231 时点数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_01 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,t2.enterprise_num enterprise_num_lst
    ,(t1.enterprise_num-t2.enterprise_num)/t2.enterprise_num r_enterprise_num
    ,round(t1.jiaoyije_inflow/100000000,2) jiaoyije_inflow
    ,round(t2.jiaoyije_inflow/100000000,2) jiaoyije_inflow_lst
    ,(t1.jiaoyije_inflow-t2.jiaoyije_inflow)/t2.jiaoyije_inflow r_amt_inflow
    ,t1.enterprise_num_a
    ,round(t1.jiaoyije_in_a/100000000,2) jiaoyije_in_a
    ,round(t2.jiaoyije_in_a/100000000,2) jiaoyije_in_a_lst
    ,(t1.jiaoyije_in_a-t2.jiaoyije_in_a)/t2.jiaoyije_in_a r_amt_in_a
    ,t1.enterprise_num_b
    ,round(t1.jiaoyije_in_b/100000000,2) jiaoyije_in_b
    ,round(t2.jiaoyije_in_b/100000000,2) jiaoyije_in_b_lst
    ,(t1.jiaoyije_in_b-t2.jiaoyije_in_b)/t2.jiaoyije_in_b r_amt_in_b
    ,t1.enterprise_num_c
    ,round(t1.jiaoyije_in_c/100000000,2) jiaoyije_in_c
    ,round(t2.jiaoyije_in_c/100000000,2) jiaoyije_in_c_lst
    ,(t1.jiaoyije_in_c-t2.jiaoyije_in_c)/t2.jiaoyije_in_c r_amt_in_c
    ,t1.enterprise_num_d
    ,round(t1.jiaoyije_in_d/100000000,2) jiaoyije_in_d
    ,round(t2.jiaoyije_in_d/100000000,2) jiaoyije_in_d_lst
    ,(t1.jiaoyije_in_d-t2.jiaoyije_in_d)/t2.jiaoyije_in_d r_amt_in_d
    ,round(t1.jiaoyije_outflow/100000000,2) jiaoyije_outflow
    ,round(t2.jiaoyije_outflow/100000000,2) jiaoyije_outflow_lst
    ,(t1.jiaoyije_outflow-t2.jiaoyije_outflow)/t2.jiaoyije_outflow r_amt_outflow
    ,round(t1.tax_expen/100000000,2) tax_expen
    ,round(t2.tax_expen/100000000,2) tax_expen_lst
    ,(t1.tax_expen-t2.tax_expen)/t2.tax_expen r_tax_expen
    ,round(t1.electricity_expen/100000000,2) electricity_expen
    ,round(t2.electricity_expen/100000000,2) electricity_expen_lst
    ,(t1.electricity_expen-t2.electricity_expen)/t2.electricity_expen r_electricity_expen
    ,round((t1.jiaoyije_inflow-t1.jiaoyije_outflow)/100000000,2) amt_netflow
    ,round((t2.jiaoyije_inflow-t2.jiaoyije_outflow)/100000000,2) amt_netflow_lst
    ,(t1.jiaoyije_inflow-t1.jiaoyije_outflow-t2.jiaoyije_inflow+t2.jiaoyije_outflow)/(t2.jiaoyije_inflow-t2.jiaoyije_outflow) r_amt_netflow
    ,round(t1.cur_act_bal/100000000,2) cur_act_bal
    ,round(t2.cur_act_bal/100000000,2) cur_act_bal_lst
    ,(t1.cur_act_bal-t2.cur_act_bal)/t2.cur_act_bal r_cur_act_bal
from adm_upss.entp_cust_captail_tb_info_i       t1 --账户资金情况
left join adm_upss.entp_cust_captail_tb_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20231231'
where t1.dt='20231231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_01_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_01_1 AS
select t1.enterprise_type                           --企业类型
	,t1.enterprise_num                              --企业户数
    ,enterprise_num_lst
    ,r_enterprise_num
    ,jiaoyije_inflow
    ,jiaoyije_inflow_lst
    ,case when jiaoyije_inflow_lst>0 then (t1.jiaoyije_inflow-jiaoyije_inflow_lst)/jiaoyije_inflow_lst else 0 end r_amt_inflow
    ,t1.enterprise_num_a
    ,jiaoyije_in_a
    ,jiaoyije_in_a_lst
    ,case when jiaoyije_in_a_lst>0 then (t1.jiaoyije_in_a-jiaoyije_in_a_lst)/jiaoyije_in_a_lst else 0 end r_amt_in_a
    ,t1.enterprise_num_b
    ,jiaoyije_in_b
    ,jiaoyije_in_b_lst
    ,case when jiaoyije_in_b_lst>0 then (t1.jiaoyije_in_b-jiaoyije_in_b_lst)/jiaoyije_in_b_lst else 0 end r_amt_in_b
    ,t1.enterprise_num_c
    ,jiaoyije_in_c
    ,jiaoyije_in_c_lst
    ,case when jiaoyije_in_c_lst>0 then (t1.jiaoyije_in_c-jiaoyije_in_c_lst)/jiaoyije_in_c_lst else 0 end r_amt_in_c
    ,t1.enterprise_num_d
    ,jiaoyije_in_d
    ,jiaoyije_in_d_lst
    ,case when jiaoyije_in_d_lst>0 then (t1.jiaoyije_in_d-jiaoyije_in_d_lst)/jiaoyije_in_d_lst else 0 end r_amt_in_d
    ,jiaoyije_outflow
    ,jiaoyije_outflow_lst
    ,case when jiaoyije_outflow_lst>0 then (t1.jiaoyije_outflow-jiaoyije_outflow_lst)/jiaoyije_outflow_lst else 0 end r_amt_outflow
    ,tax_expen
    ,tax_expen_lst
    ,case when tax_expen_lst>0 then (t1.tax_expen-tax_expen_lst)/tax_expen_lst else 0 end r_tax_expen
    ,electricity_expen
    ,electricity_expen_lst
    ,case when electricity_expen_lst>0 then (t1.electricity_expen-electricity_expen_lst)/electricity_expen_lst else 0 end r_electricity_expen
    ,amt_netflow
    ,amt_netflow_lst
    ,case when amt_netflow_lst>0 then (amt_netflow-amt_netflow_lst)/amt_netflow_lst else 0 end r_amt_netflow
    ,cur_act_bal
    ,cur_act_bal_lst
    ,case when cur_act_bal_lst>0 then (t1.cur_act_bal-cur_act_bal_lst)/cur_act_bal_lst else 0 end r_cur_act_bal
from SJXQ_SJ2024012611_CST_20231231_01 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_02 AS
select t1.enterprise_type                          --企业类型
    ,t1.entp_pay_wages/100000000 entp_pay_wages
    ,t2.entp_pay_wages/100000000 entp_pay_wages_lst
    ,(t1.entp_pay_wages-t2.entp_pay_wages)/t2.entp_pay_wages r_entp_pay_wages
    ,t1.entp_num_a
    ,t1.current_pay_wages_a/100000000 current_pay_wages_a
    ,t2.current_pay_wages_a/100000000 current_pay_wages_a_lst
    ,(t1.current_pay_wages_a-t2.current_pay_wages_a)/t2.current_pay_wages_a r_current_pay_wages_a
    ,t1.entp_num_b
    ,t1.current_pay_wages_b/100000000 current_pay_wages_b
    ,t2.current_pay_wages_b/100000000 current_pay_wages_b_lst
    ,(t1.current_pay_wages_b-t2.current_pay_wages_b)/t2.current_pay_wages_b r_current_pay_wages_b
    ,t1.entp_num_c
    ,t1.current_pay_wages_c/100000000 current_pay_wages_c
    ,t2.current_pay_wages_c/100000000 current_pay_wages_c_lst
    ,(t1.current_pay_wages_c-t2.current_pay_wages_c)/t2.current_pay_wages_c r_current_pay_wages_c
    ,t1.entp_num_d
    ,t1.current_pay_wages_d/100000000 current_pay_wages_d
    ,t2.current_pay_wages_d/100000000 current_pay_wages_d_lst
    ,(t1.current_pay_wages_d-t2.current_pay_wages_d)/t2.current_pay_wages_d r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,t2.entp_pay_wages_num entp_pay_wages_num_lst
    ,(t1.entp_pay_wages_num-t2.entp_pay_wages_num)/t2.entp_pay_wages_num r_entp_pay_wages_num
from adm_upss.entp_cust_pay_wages_info_i       t1 --代发工资情况
left join adm_upss.entp_cust_pay_wages_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20231231'
where t1.dt='20231231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_02_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_02_1 AS
select t1.enterprise_type                          --企业类型
    ,entp_pay_wages
    ,entp_pay_wages_lst
    ,case when entp_pay_wages_lst>0 then (t1.entp_pay_wages-entp_pay_wages_lst)/entp_pay_wages_lst else 0 end r_entp_pay_wages
    ,t1.entp_num_a
    ,current_pay_wages_a
    ,current_pay_wages_a_lst
    ,case when current_pay_wages_a_lst>0 then (t1.current_pay_wages_a-current_pay_wages_a_lst)/current_pay_wages_a_lst else 0 end r_current_pay_wages_a
    ,t1.entp_num_b
    ,current_pay_wages_b
    ,current_pay_wages_b_lst
    ,case when current_pay_wages_b_lst>0 then (t1.current_pay_wages_b-current_pay_wages_b_lst)/current_pay_wages_b_lst else 0 end r_current_pay_wages_b
    ,t1.entp_num_c
    ,current_pay_wages_c
    ,current_pay_wages_c_lst
    ,case when current_pay_wages_c_lst>0 then (t1.current_pay_wages_c-current_pay_wages_c_lst)/current_pay_wages_c_lst else 0 end r_current_pay_wages_c
    ,t1.entp_num_d
    ,current_pay_wages_d
    ,current_pay_wages_d_lst
    ,case when current_pay_wages_d_lst>0 then (t1.current_pay_wages_d-current_pay_wages_d_lst)/current_pay_wages_d_lst else 0 end r_current_pay_wages_d
    ,t1.entp_pay_wages_num
    ,entp_pay_wages_num_lst
    ,case when entp_pay_wages_num_lst>0 then (t1.entp_pay_wages_num-entp_pay_wages_num_lst)/entp_pay_wages_num_lst else 0 end r_entp_pay_wages_num
from SJXQ_SJ2024012611_CST_20231231_02 t1
;
--流入动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_03 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20231231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_03_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_03_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20231231_03 t1
;
--流出动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_04 AS
select t1.enterprise_type                          --企业类型
    ,t1.mobile_cust_first_month
    ,t2.mobile_cust_first_month mobile_cust_first_month_lst
    ,(t1.mobile_cust_first_month-t2.mobile_cust_first_month)/t2.mobile_cust_first_month r_mobile_cust_first_month
    ,t1.mobile_cust_first_month/t1.mobile_cust_cn r_season1m
    ,t2.mobile_cust_first_month/t2.mobile_cust_cn r_season1m_lst
    ,t1.mobile_cust_two_month
    ,t2.mobile_cust_two_month mobile_cust_two_month_lst
    ,(t1.mobile_cust_two_month-t2.mobile_cust_two_month)/t2.mobile_cust_two_month r_mobile_cust_two_month
    ,t1.mobile_cust_two_month/t1.mobile_cust_cn r_season2m
    ,t2.mobile_cust_two_month/t2.mobile_cust_cn r_season2m_lst
    ,t1.mobile_cust_three_month
    ,t2.mobile_cust_three_month mobile_cust_three_month_lst
    ,(t1.mobile_cust_three_month-t2.mobile_cust_three_month)/t2.mobile_cust_three_month r_mobile_cust_three_month
    ,t1.mobile_cust_three_month/t1.mobile_cust_cn r_season3m
    ,t2.mobile_cust_three_month/t2.mobile_cust_cn r_season3m_lst
    ,t1.mobile_cust_season_no
    ,t2.mobile_cust_season_no mobile_cust_season_no_lst
    ,(t1.mobile_cust_season_no-t2.mobile_cust_season_no)/t2.mobile_cust_season_no r_mobile_cust_season_no
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month) mobile_cust_avg
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month) mobile_cust_avg_lst
    ,(t1.mobile_cust_first_month+t1.mobile_cust_two_month+t1.mobile_cust_three_month)/t1.mobile_cust_cn/3 mobile_cust_avg_r
    ,(t2.mobile_cust_first_month+t2.mobile_cust_two_month+t2.mobile_cust_three_month)/t2.mobile_cust_cn/3 mobile_cust_avg_lst_r
    ,t3.mobile_cust_year_no
    ,t4.mobile_cust_year_no mobile_cust_year_no_lst
    ,(t3.mobile_cust_year_no-t4.mobile_cust_year_no)/t4.mobile_cust_year_no r_mobile_cust_year_no
from adm_upss.entp_cust_mobile_account_info_i       t1 --动账情况
left join adm_upss.entp_cust_mobile_account_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t1.jiedaibz=t2.jiedaibz
and t1.dt=t2.dt
and t2.time_dimsion = '2'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t3 --当年 年无动账
on  t1.enterprise_type=t3.enterprise_type
and t1.jiedaibz=t3.jiedaibz
and t1.dt=t3.data_date
and t3.time_dimsion = '4'
left join ENTP_CUST_YEAR_MOBILE_ACCOUNT_INFO t4 --上年 年无动账
on  t1.enterprise_type=t4.enterprise_type
and t1.jiedaibz=t4.jiedaibz
and t1.dt=t4.data_date
and t4.time_dimsion = '2'
where t1.dt='20231231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
and t1.jiedaibz='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_04_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_04_1 AS
SElECT enterprise_type                          --企业类型
    ,mobile_cust_first_month
    ,mobile_cust_first_month_lst
    ,r_mobile_cust_first_month
    ,r_season1m
    ,r_season1m_lst
    ,(r_season1m-r_season1m_lst)/r_season1m_lst r_r_season1m_lst
    ,mobile_cust_two_month
    ,mobile_cust_two_month_lst
    ,r_mobile_cust_two_month
    ,r_season2m
    ,r_season2m_lst
    ,(r_season2m-r_season2m_lst)/r_season2m_lst r_r_season2m_lst
    ,mobile_cust_three_month
    ,mobile_cust_three_month_lst
    ,r_mobile_cust_three_month
    ,r_season3m
    ,r_season3m_lst
    ,(r_season3m-r_season3m_lst)/r_season3m_lst r_r_season3m_lst
    ,mobile_cust_avg
    ,mobile_cust_avg_lst
    ,(mobile_cust_avg-mobile_cust_avg_lst)/mobile_cust_avg_lst r_mobile_cust_avg_lst
    ,mobile_cust_avg_r
    ,mobile_cust_avg_lst_r
    ,(mobile_cust_avg_r-mobile_cust_avg_lst_r)/mobile_cust_avg_lst_r r_mobile_cust_avg_lst_r
    ,t1.mobile_cust_season_no
    ,mobile_cust_season_no_lst
    ,r_mobile_cust_season_no
    ,mobile_cust_year_no
    ,mobile_cust_year_no_lst
    ,(mobile_cust_year_no-mobile_cust_year_no_lst)/mobile_cust_year_no_lst r_mobile_cust_year_no
from SJXQ_SJ2024012611_CST_20231231_04 t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_05 AS
select t1.enterprise_type                          --企业类型
    ,round(t1.internation_setll_summ/100000000,2) internation_setll_summ
    ,round(t2.internation_setll_summ/100000000,2) internation_setll_summ_lst
    ,(t1.internation_setll_summ-t2.internation_setll_summ)/t2.internation_setll_summ r_internation_setll_summ
    ,round(t1.inward_summart/100000000,2) inward_summart
    ,round(t2.inward_summart/100000000,2) inward_summart_lst
    ,(t1.inward_summart-t2.inward_summart)/t2.inward_summart r_inward_summart
    ,round(t1.export_settlem/100000000,2) export_settlem
    ,round(t2.export_settlem/100000000,2) export_settlem_lst
    ,(t1.export_settlem-t2.export_settlem)/t2.export_settlem r_export_settlem
    ,round(t1.feimao_export_settlem/100000000,2) feimao_export_settlem
    ,round(t2.feimao_export_settlem/100000000,2) feimao_export_settlem_lst
    ,(t1.feimao_export_settlem-t2.feimao_export_settlem)/t2.feimao_export_settlem r_feimao_export_settlem
    ,round(t1.outward_summart/100000000,2) outward_summart
    ,round(t2.outward_summart/100000000,2) outward_summart_lst
    ,(t1.outward_summart-t2.outward_summart)/t2.outward_summart r_outward_summart
    ,round(t1.import_settlem/100000000,2) import_settlem
    ,round(t2.import_settlem/100000000,2) import_settlem_lst
    ,(t1.import_settlem-t2.import_settlem)/t2.import_settlem r_import_settlem
    ,round(t1.feimao_import_settlem/100000000,2) feimao_import_settlem
    ,round(t2.feimao_import_settlem/100000000,2) feimao_import_settlem_lst
    ,(t1.feimao_import_settlem-t2.feimao_import_settlem)/t2.feimao_import_settlem r_feimao_import_settlem
from adm_upss.entp_internation_setll_info_i       t1 --国际结算
left join adm_upss.entp_internation_setll_info_i  t2
on  t1.enterprise_type=t2.enterprise_type
and t2.time_dimsion = '2'
and t2.dt='20231231'
where t1.dt='20231231'
and t1.time_dimsion='4' --时间维度 1上年月 2上年季 3当年月 4当年季
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012611_CST_20231231_05_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012611_CST_20231231_05_1 AS
select t1.enterprise_type                          --企业类型
    ,internation_setll_summ
    ,internation_setll_summ_lst
    ,case when internation_setll_summ_lst>0 then (t1.internation_setll_summ-internation_setll_summ_lst)/internation_setll_summ_lst else 0 end r_internation_setll_summ
    ,inward_summart
    ,inward_summart_lst
    ,case when inward_summart_lst>0 then (t1.inward_summart-inward_summart_lst)/inward_summart_lst else 0 end r_inward_summart
    ,export_settlem
    ,export_settlem_lst
    ,case when export_settlem_lst>0 then (t1.export_settlem-export_settlem_lst)/export_settlem_lst else 0 end r_export_settlem
    ,feimao_export_settlem
    ,feimao_export_settlem_lst
    ,case when feimao_export_settlem_lst>0 then (t1.feimao_export_settlem-feimao_export_settlem_lst)/feimao_export_settlem_lst else 0 end r_feimao_export_settlem
    ,outward_summart
    ,outward_summart_lst
    ,case when outward_summart_lst>0 then (t1.outward_summart-outward_summart_lst)/outward_summart_lst else 0 end r_outward_summart
    ,import_settlem
    ,import_settlem_lst
    ,case when import_settlem_lst>0 then (t1.import_settlem-import_settlem_lst)/import_settlem_lst else 0 end r_import_settlem
    ,feimao_import_settlem
    ,feimao_import_settlem_lst
    ,case when feimao_import_settlem_lst>0 then (t1.feimao_import_settlem-feimao_import_settlem_lst)/feimao_import_settlem_lst else 0 end r_feimao_import_settlem
from SJXQ_SJ2024012611_CST_20231231_05 t1
;
--输出结果
SELECT *
from SJXQ_SJ2024012611_CST_20231231_01_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20231231_02_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20231231_03_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20231231_04_1
;
SELECT *
from SJXQ_SJ2024012611_CST_20231231_05_1
***SJ2024012966-潜在客户画像.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024012966_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012966_CST_01 AS
select t1.cst_id                                   --客户号
	,t1.cst_chn_nm                               --客户中文名称
	,decode(t1.gdr_cd,'1','男','2','女','') gender --性别代码
	,t1.age                                      --年龄
	,t1.org_mngr_id                              --管户机构
	,t1.org_mngr_nm                              --管户机构名称
	,t1.acs_mngr_id                              --管户客户经理
	,t1.acs_mngr_nm                              --管户客户经理名称
    ,case when age<=20 then '0 <=20'
        when age>20 and age<=30 then '1 20<x<=30'
        when age>30 and age<=40 then '2 30<x<=40'
        when age>40 and age<=50 then '3 40<x<=50'
        when age>50 and age<=60 then '4 50<x<=60'
        when age>60 and age<=70 then '5 60<x<=70'
        when age>70 then '6 x>70' else '' end age_grd
    ,t4.BRC_ORG_id
    ,T4.BRC_ORG_NM
    ,t4.org_id,t4.org_nm
    ,IF(t5.forml_cst_ind = '1', '是', '否') is_fomal        --是否正式客户
from adm_pub.adm_csm_cbas_idv_bas_inf_dd             t1   --客户集市-客户基础-对私客户基础信息
INNER JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3   --客户`主管户`信息 16065131 cst_id 唯一
on      t1.cst_id = t3.cst_id
and     t3.dt = '@@{yyyyMMdd}'
INNER join edw.dim_hr_org_mng_org_tree_dd            t4   --考核机构树 4481 org_id 唯一
on      t3.prm_org_id = t4.org_id
and     t4.dt = '@@{yyyyMMdd}'
and     t4.brc_org_nm LIKE '%分行%' -- t3.brc_org_nm LIKE '%总行%'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t5
ON      t1.cst_id = t5.cst_id
AND     t5.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024012966_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024012966_CST_02 AS
SElECT BRC_ORG_NM
    ,count(1)                                     总客户数
    ,sum(case when gender='女' then 1 else 0 end) 女性
    ,sum(case when gender='男' then 1 else 0 end) 男性
    ,sum(case when gender='女' and age_grd='0 <=20' then 1 else 0 end)      女性_less20
    ,sum(case when gender='男' and age_grd='0 <=20' then 1 else 0 end)      男性_less20
    ,sum(case when gender='女' and age_grd='1 20<x<=30' then 1 else 0 end)  女性_20_30
    ,sum(case when gender='男' and age_grd='1 20<x<=30' then 1 else 0 end)  男性_20_30
    ,sum(case when gender='女' and age_grd='2 30<x<=40' then 1 else 0 end)  女性_30_40
    ,sum(case when gender='男' and age_grd='2 30<x<=40' then 1 else 0 end)  男性_30_40
    ,sum(case when gender='女' and age_grd='3 40<x<=50' then 1 else 0 end)  女性_40_50
    ,sum(case when gender='男' and age_grd='3 40<x<=50' then 1 else 0 end)  男性_40_50
    ,sum(case when gender='女' and age_grd='4 50<x<=60' then 1 else 0 end)  女性_50_60
    ,sum(case when gender='男' and age_grd='4 50<x<=60' then 1 else 0 end)  男性_50_60
    ,sum(case when gender='女' and age_grd='5 60<x<=70' then 1 else 0 end)  女性_60_70
    ,sum(case when gender='男' and age_grd='5 60<x<=70' then 1 else 0 end)  男性_60_70
    ,sum(case when gender='女' and age_grd='6 x>70' then 1 else 0 end)      女性_more70
    ,sum(case when gender='男' and age_grd='6 x>70' then 1 else 0 end)      男性_more70
from SJXQ_SJ2024012966_CST_01
where is_fomal='是'
GROUP by BRC_ORG_NM
;
--输出结果
SElECT *
from SJXQ_SJ2024012966_CST_02
***SJ2024013026_湖州泰隆生活小程序客户邀约.sql
-- 湖州分行营业部财富中心数据
-- 20231228-20240131
DROP   TABLE IF     EXISTS SJXQ_SJ2024013026_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013026_CST_01 AS
SELECT  T6.SBR_ORG_ID   AS 支行层级机构编号
        ,T6.SBR_ORG_NM  AS 支行层级机构名称
        ,T.EMPE_ID      AS 员工号
        ,T5.EMPE_NM     AS 员工姓名
        ,T.UNION_ID     AS 邀请人UNIONID
        ,T1.TO_UNION_ID AS 被邀请人UNIONID
        ,T1.TO_USER_ID  AS 被邀请人用户USERID
        ,T2.CST_ID      AS 被邀请人客户号
        ,T4.CST_CHN_NM  AS 被邀请人客户名称
        ,T2.ADD_TM      AS 添加时间
        ,T2.LGN_TM      AS 登录时间
        ,T2.LAST_LGN_TM AS 上次登录时间
        ,T1.CHANNEL_NO  AS 注册渠道 --(0:微信)
        ,T1.STATUS      AS 状态 --(0:未登录,1:存量用户,2新用户)
        ,T1.SHARE_TIME  AS 分享时间
        ,T1.ADD_TIME    AS 新客登录时间
        ,T3.TELEPHONE   AS 被邀请人手机号
FROM LAB_BIGDATA_DEV.FJ_UNION_ID_MTCH_EMPE_ID_LBB   T
INNER JOIN    EDW.DWS_HR_EMPE_INF_DD                T5
ON      T.EMPE_ID = T5.EMPE_ID
AND     T5.DT = '20240131'
INNER JOIN    EDW.DIM_HR_ORG_MNG_ORG_TREE_DD        T6
ON      T5.ORG_ID = T6.ORG_ID
AND     T6.DT = '20240131'
LEFT JOIN EDW.TLSC_SUNYARDMALL_THIRD_SHARE_REGISTER T1
ON      T.UNION_ID = T1.FROM_UNION_ID
AND     T1.DT = '20240131'
LEFT JOIN    EDW.DIM_BUS_CMPN_PNT_MALL_USR_INF_DD   T2 --积分商城用户信息
ON      T1.TO_USER_ID = T2.MALL_CST_ID
AND     T2.DT = '20240131'
LEFT JOIN    EDW.TLSC_SUNYARDMALL_USER              T3
ON      T2.CST_ID = REPLACE(REPLACE(REPLACE(COALESCE(TRIM(T3.OPENID), ''), CHR(13), ''), CHR(10), ''), '&quot;', '')
AND     T3.DT = '20240131'
LEFT JOIN    EDW.DIM_CST_BAS_INF_DD                 T4
ON      T2.CST_ID = T4.CST_ID
AND     T4.DT = '20240131'
WHERE   T.DT = '20240131'
;
SELECT *
from SJXQ_SJ2024013026_CST_01
-- where 新客登录时间>='20231227'
***SJ2024013141-安永协助审查.sql
-- 取数客群限制为 未销户且经营状态异常且 不包含不动户、久悬户、止付状态为&ldquo;不收不付&rdquo;的对公账户
--冻结,止付_控制
DROP   TABLE IF     EXISTS SJXQ_SJ2024013141_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013141_CST_01 AS
SELECT t1.cst_act_id,t1.FRZ_SRC_CD --1冻结 2止付
    ,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类 '启用不收不付控制', '封闭控制', '封闭冻结'
    ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
    ,ROW_NUMBER() over (partition by t1.cst_act_id,t1.FRZ_SRC_CD order by t1.frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t1.ACT_STOP_PMT_TYP_CD = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt='@@{yyyyMMdd}'
WHERE   t1.DT = '@@{yyyyMMdd}'
AND     t1.NFRZ_IND = '0'
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ2024013141_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013141_CST_02 AS
SELECT cst_act_id
    ,lmt_cmt close_fg_rsn
    ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '@@{yyyyMMdd}'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ2024013141_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013141_CST_03 AS
SELECT cengcgjz     cst_act_id
    ,danciedu       fg_per_lmt
    ,leijiedu       fg_day_lmt  -- 非柜面日累计限额
FROM    edw.core_kdpa_zheddy    -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE'   -- 非柜面限额
AND     edkzzhqi = '1D'
;
/*
存在多个非柜限额
'6214806601001188616')
*/
-- 工商信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024013141_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013141_CST_04 AS
SELECT *
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC) AS RN
    ,row_number() OVER (PARTITION BY GEB_CREDITCODE ORDER BY is_abnormal desc,GEB_HOSTSENDTIME asc) AS RN2
FROM    (
    SELECT  GEB_ENTNAME             --客户名称
        ,GEB_CREDITCODE             --统一社会信用代码
        ,GEB_ENTTYPE                --企业机构类型
        ,GEB_FRNAME                 --法定代表人负责人执行事务合伙人
        ,GEB_ENTSTATUS              --经营状态
        ,GEB_RECCAP                 --实收资本万元
        ,GEB_REGCAPCUR              --注册资本币种
        ,GEB_REGORGCITY             --所在城市
        ,GEB_REGORGDISTRICT         --所在区县
        ,GEB_ZSOPSCOPE              --经营业务范围
        ,GEB_DOM                    --住所
        ,GEB_INDUSTRYCONAME         --国民经济代码名称
        ,geb_esdate                 --成立日期
        ,geb_othertel               --其他电话
        ,GEB_HOSTSENDTIME           --geb_hostsendtime 交易发送主机时间
        ,geb_regorgprovince         --所在省份
        ,geb_regorgcode             --注册地址行政编号
    FROM    edw.OUTD_GS_ENTINFO_BASIC   --工商企业-企业基本信息
    WHERE   dt <= '@@{yyyyMMdd}'
    UNION ALL
    SELECT  dt_entname             AS GEB_ENTNAME
        ,dt_creditcode         AS GEB_CREDITCODE
        ,dt_enttype            AS GEB_ENTTYPE
        ,dt_frname             AS GEB_FRNAME
        ,dt_entstatus          AS GEB_ENTSTATUS
        ,dt_reccap             AS GEB_RECCAP
        ,dt_regcapcur          AS GEB_REGCAPCUR
        ,dt_regorgcity         AS GEB_REGORGCITY
        ,dt_regorgdistrict     AS GEB_REGORGDISTRICT
        ,dt_zsopscope          AS GEB_ZSOPSCOPE
        ,dt_dom                AS GEB_DOM
        ,dt_industryconame     AS GEB_INDUSTRYCONAME
        ,dt_esdate             AS geb_esdate
        ,dt_othertel           AS geb_othertel
        ,insert_time_chinadaas AS GEB_HOSTSENDTIME
        ,dt_regorgprovince     AS geb_regorgprovince
        ,dt_regorgcode         AS geb_regorgcode
    FROM    edw.nout_zs_ent_basic
    WHERE   dt <= '@@{yyyyMMdd}'
)a where length(GEB_CREDITCODE)>0 --剔除非空
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024013141_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013141_CST_05 AS
select cst_act_id,dep_act_id
    ,max(trx_dt) max_trx_dt	            --交易日期|C8
FROM edw.dwd_bus_dep_bal_chg_dtl_di     --历史交易
WHERE  dt<='@@{yyyyMMdd}'
    ,'DP1000','DP2081','DP2094','DP2096','DP2131','DP3000','DP3001','DPW032','GL0002','GL0621','IB0034'
    ,'LN0004','LN0009','LN0014','LN0022','LN0023','LN1012','LN1024','LN1025','LN1036','TY0100','TY0101'
    ,'TY0111','TY0113','TY0114','TY0130','TY0131','WWP001','WWP002','WWP004','WWP010','WWP021') --除计息
group by cst_act_id,dep_act_id
;
--结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024013141_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024013141_CST_06 AS
select '@@{yyyyMMdd}'   as  数据日期
    ,T1.cst_id          as  客户号
    ,T2.cst_nm              客户名称
    ,T1.cst_act_id      as  客户账号
    ,T1.dep_act_id      as  存款账号
    ,T1.act_nm          as  账户名称
    ,decode(t1.act_sts_cd,'A','正常','F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') 账户状态
    ,T20.cd_val_dscr    as  账户分类1
    ,T18.cd_val_dscr    as  账户分类2
    ,T3.opn_dt          as  客户账户开户日期
    ,T1.opn_dt          as  子户开户日期
    ,T1.opn_org         as  开户机构编号
    ,c1.org_nm          AS  开户机构名称
    ,c1.sbr_org_nm      AS  开户支行名称
    ,c1.brc_org_nm      AS  开户分行
    ,t8.max_trx_dt          账户最近一笔流水发生时间
    ,T9.GEB_HOSTSENDTIME    外数中经营状态变为异常的日期
    ,T10.GEB_ENTSTATUS      外数中经营状态
    ,case when t4.cst_act_id is not null then 1 else 0 end  是否冻结
    ,t4.frz_dt      冻结时间
    ,T4.frz_rsn     冻结原因
    ,T4.frz_cls     冻结种类
    ,case when t5.cst_act_id is not null then 1 else 0 end  是否止付
    ,t5.frz_dt              止付时间
    ,T5.frz_rsn             止付原因
    ,T5.frz_cls             止付种类
    ,T5.ACT_STOP_PMT_TYP    止付类型
    ,case when T6.cst_act_id is not null then 1 else 0  end 是否关闭非柜面
    ,t6.close_fg_rsn        关闭非柜面原因
    ,T7.fg_day_lmt          非柜面日累计限额
FROM edw.dws_bus_dep_act_inf_dd             T1     -- 存款账户信息表
INNER JOIN edw.DIM_CST_ENTP_BAS_INF_DD      T2     -- 企业客户基本信息表
ON      t2.CST_ID = T1.CST_ID -- 客户号
AND     t2.LGP_ID = T1.LGP_ID -- 法人代码
AND     t2.ORG_ORG_TYP_CD IN ( '0101' , '0102' , '0103' , '0104' , '0500' ) --组织机构类型 0101:企业法人  0102:企业独资、合伙企业  0103：企业的分支机构  0104：企业非法人  0500：个体工商户
AND     t2.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd    c1
ON  T1.opn_org=c1.org_id
and c1.dt='@@{yyyyMMdd}'
left  JOIN edw.dim_bus_dep_cst_act_inf_dd   T3
ON  T1.cst_act_id=T3.cst_act_id
and  T3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024013141_CST_01          t4
on  t1.cst_act_id=t4.cst_act_id
and t4.FRZ_SRC_CD='1'   --1冻结
and t4.rn=1
left join SJXQ_SJ2024013141_CST_01          t5
on  t1.cst_act_id=t5.cst_act_id
and t5.FRZ_SRC_CD='2'   --2止付
and t5.rn=1
left join SJXQ_SJ2024013141_CST_02          t6  --非柜面原因
on  t1.cst_act_id=t6.cst_act_id
and t6.rn=1
left join SJXQ_SJ2024013141_CST_03          t7  --非柜面限额
on  t1.cst_act_id=t7.cst_act_id
left join SJXQ_SJ2024013141_CST_05          t8  --最近一笔流水
on  t1.cst_act_id=t8.cst_act_id
and t1.dep_act_id=t8.dep_act_id
left join SJXQ_SJ2024013141_CST_04          t9
ON  t2.cst_nm=t9.GEB_ENTNAME
and t9.rn2=1    --经营状态异常日期
INNER join SJXQ_SJ2024013141_CST_04         t10
on  t2.cst_nm=t10.GEB_ENTNAME
and t10.is_abnormal=1   --经营状态异常
and t10.rn=1            --当前经营状态
left join  (
    select cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
    where dt='@@{yyyyMMdd}'
      )   T18  on T1.ACT_CTG_CD_2=T18.cd_val
left join  (
    select cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
    where dt='@@{yyyyMMdd}'
      )   T20  on T1.ACT_CTG_CD_1=T20.cd_val
where t1.dt='@@{yyyyMMdd}'
AND T1.BAL_GL_IND <> '0'    -- 剔除虚拟户
and (t5.frz_cls!='封闭冻结' or T5.frz_cls is null)
;
SElECT '01' seq, count(1) cnt, count(distinct cst_act_id,FRZ_SRC_CD) custs
from SJXQ_SJ2024013141_CST_01 where rn=1
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024013141_CST_02 where rn=1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024013141_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct GEB_CREDITCODE) custs
from SJXQ_SJ2024013141_CST_04 where rn=1
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024013141_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024013141_CST_06
;
/*
01	2670367	2670367
02	3669752	3669752
03	3698088	3698085
04	8752502	8752502
05	22650643	15517966
06	45651	40982
*/***SJ20240201106-社区企业行业摸排.sql
--需求二
DROP   TABLE IF     EXISTS SJXQ_SJ20240201106_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240201106_CST_01 AS
SElECT cast(t0.seq as int) seq
    ,t0.sub_cmnt_id,t0.sub_cmnt_nm
    ,T1.CST_ID
    ,t1.idt_cd	            --行业代码                              好多企业没有行业代码
    ,C3.cd_val_dscr idt_cd_3
from qbi_file_20240206_11_03_24         t0
inner join adm_pub.adm_csm_cbas_org_inf_dd t1 	--客户集市-客户基础-对公客户基础信息
on t0.sub_cmnt_id=t1.sub_cmnt_id
and t1.DT='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       C3  --132058 tbl_nm,fld_nm,cd_val 唯一
ON substr(t1.idt_cd,1,4) = C3.CD_VAL
AND C3.DT='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240201106_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240201106_CST_02 AS
SElECT sub_cmnt_id,idt_cd_3,idt_num
    ,row_number() over(partition by sub_cmnt_id order by idt_num desc)rn
from(
    SElECT sub_cmnt_id,idt_cd_3,count(1) idt_num
    from SJXQ_SJ20240201106_CST_01
    WHERE idt_cd_3 IS NOT NULL
    group by sub_cmnt_id,idt_cd_3
)A
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240201106_CST_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240201106_CST_03 AS
SElECT cast(t1.seq as int) 序号
    ,t1.sub_cmnt_id     子社区号
    ,t1.sub_cmnt_nm     子社区名
    ,t2.idt_cd_3        行业TOP1
    ,t2.idt_num         行业TOP1数量
    ,t3.idt_cd_3		行业TOP2
    ,t3.idt_num         行业TOP2数量
    ,t4.idt_cd_3		行业TOP3
    ,t4.idt_num         行业TOP3数量
    ,t5.idt_cd_3        行业TOP4
    ,t5.idt_num         行业TOP4数量
    ,t6.idt_cd_3 		行业TOP5
    ,t6.idt_num         行业TOP5数量
from qbi_file_20240206_11_03_24         T1
left join SJXQ_SJ20240201106_CST_02     t2
on t1.sub_cmnt_id=t2.sub_cmnt_id and t2.rn=1
left join SJXQ_SJ20240201106_CST_02     t3
on t1.sub_cmnt_id=t3.sub_cmnt_id and t3.rn=2
left join SJXQ_SJ20240201106_CST_02     t4
on t1.sub_cmnt_id=t4.sub_cmnt_id and t4.rn=3
left join SJXQ_SJ20240201106_CST_02     t5
on t1.sub_cmnt_id=t5.sub_cmnt_id and t5.rn=4
left join SJXQ_SJ20240201106_CST_02     t6
on t1.sub_cmnt_id=t6.sub_cmnt_id and t6.rn=5
;
--需求三
DROP   TABLE IF     EXISTS SJXQ_SJ20240201106_CST_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240201106_CST_04 AS
SELECT t1.cst_id	        --客户号
    ,t1.cst_chn_nm	        --客户姓名
    ,t1.idt_cd	            --行业代码
    ,C1.cd_val_dscr idt_cd_1
    ,C2.cd_val_dscr idt_cd_2
    ,C3.cd_val_dscr idt_cd_3
    ,t1.born_cty	        --诞生城市
    ,t1.m_tel_no	        --手机
    ,t1.f_tel_no	        --家庭电话
    ,t1.c_tel_no	        --公司电话
    ,IF(length(t1.m_tel_no)>=8,t1.m_tel_no, IF(length(t1.f_tel_no)>=8,t1.f_tel_no,t1.c_tel_no)) m_tel_no_all
    ,t1.legal_name	        --对公客户法定代表人客户姓名
    ,t1.reg_adr_dtl_inf		--户籍地址 注册地址
    ,t1.cprh_cmnt_id	    --综合社区编号
    ,t1.cprh_cmnt_plt_id	--综合社区板块编号
    ,t1.sub_cmnt_id	        --子社区编号                    部分客户没有社区编号
    ,t2.cmnt_nm             --社区名称
    ,t2.adr cmnt_addr       --社区地址
    ,t1.file_dt	            --建档日期
from adm_pub.adm_csm_cbas_org_inf_dd    t1 	--客户集市-客户基础-对公客户基础信息
left join edw.dwd_code_library_dd       c1  --132058 tbl_nm,fld_nm,cd_val 唯一
ON substr(t1.idt_cd,1,1) = C1.CD_VAL
AND C1.DT='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       C2  --132058 tbl_nm,fld_nm,cd_val 唯一
ON substr(t1.idt_cd,1,3) = C2.CD_VAL
AND C2.DT='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       C3  --132058 tbl_nm,fld_nm,cd_val 唯一
ON substr(t1.idt_cd,1,4) = C3.CD_VAL
AND C3.DT='@@{yyyyMMdd}'
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd   T2
ON      t1.sub_cmnt_id = t2.cmnt_enc
AND     t2.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.born_cty regexp '绍兴|越城|柯桥|上虞|诸暨|嵊州|新昌' --诞生城市: 绍兴市
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240201106_CST_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240201106_CST_05 AS
SElECT born_cty         诞生城市
    ,cst_id	            客户号
    ,cst_chn_nm         客户姓名
    ,file_dt            建档日期
    ,reg_adr_dtl_inf    注册地址
    ,sub_cmnt_id	    子社区编号
    ,cmnt_nm            所属子社区
    ,idt_cd_1           所属行业一级
    ,idt_cd_2           所属行业二级
    ,idt_cd_3           所属行业三级
    ,m_tel_no_all       联系电话
from SJXQ_SJ20240201106_CST_04
;
--需求二结果
SELECT *
from SJXQ_SJ20240201106_CST_03
order by 序号
;
--需求三结果
SElECT *
from SJXQ_SJ20240201106_CST_05
;
SElECT '01' seq, count(1) cnt, count(distinct sub_cmnt_id) custs
from SJXQ_SJ20240201106_CST_01
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20240201106_CST_04
;
01	25386	668
04	4679	4679
***SJ2024020111_开门红保险贵金属.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024020111_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020111_CST_01 AS
SELECT DT                 --查询日期
    ,PVD_NM               --商铺名称
    ,ORD_ID               --订单号
    ,USR_NM               --买家名称
    ,CST_ID               --客户号
    ,CST_NM               --真实姓名
    ,PST_MTH              --邮寄方式
    ,ORD_TM               --订单时间
    ,PMT_TM               --付款时间
    ,PMT_MTH              --支付方式
    ,CHNL_NM              --渠道
    ,ORD_STS              --订单状态
    ,CMDT_NM              --商品名称
    ,CMDT_SPEC            --商品规格
    ,QTY                  --购买数量
    ,GOODS_TYP            --商品分类
    ,GOODS_RETURN_STATUS  --商品退款状态
    ,CMDT_UNT_PRC         --商品现金单价
    ,CMDT_PAY_UNT_PRC     --商品应付现金总额
    ,CMSN_TYP             --佣金类型
    ,MID_INC_RTO          --佣金比例_金额
    ,MID_INC_TOT_AMT      --佣金总额
    ,RCM_PSN_ID           --推荐人工号
    ,RCM_PSN_NM           --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID  --推荐人所属部门_团队ID
    ,RCM_PSN_AFL_DEPT     --推荐人所属部门_团队
    ,RCM_PSN_AFL_SUB_BRN  --推荐人所属支行
    ,RCM_PSN_AFL_BRN      --推荐人所属分行
    ,DATA_SRC             --数据来源
FROM  adm_pub.ADM_PUB_CST_NOB_MET_TRX_DTL_DI A
WHERE A.dt >= '20230101'
AND  A.dt <= '20240131'
UNION ALL
SELECT DT                 --查询日期
    ,PVD_NM               --商铺名称
    ,ORD_ID               --订单号
    ,USR_NM               --买家名称
    ,CST_ID               --客户号
    ,CST_NM               --真实姓名
    ,PST_MTH              --邮寄方式
    ,ORD_TM               --订单时间
    ,PMT_TM               --付款时间
    ,PMT_MTH              --支付方式
    ,CHNL_NM              --渠道
    ,ORD_STS              --订单状态
    ,CMDT_NM              --商品名称
    ,CMDT_SPEC            --商品规格
    ,QTY                  --购买数量
    ,GOODS_TYP            --商品分类
    ,GOODS_RETURN_STATUS  --商品退款状态
    ,CMDT_UNT_PRC         --商品现金单价
    ,CMDT_PAY_UNT_PRC     --商品应付现金总额
    ,CMSN_TYP             --佣金类型
    ,MID_INC_RTO          --佣金比例_金额
    ,MID_INC_TOT_AMT      --佣金总额
    ,RCM_PSN_ID           --推荐人工号
    ,RCM_PSN_NM           --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID  --推荐人所属部门_团队ID
    ,RCM_PSN_AFL_DEPT     --推荐人所属部门_团队
    ,RCM_PSN_AFL_SUB_BRN  --推荐人所属支行
    ,RCM_PSN_AFL_BRN      --推荐人所属分行
    ,DATA_SRC             --数据来源
FROM  adm_pub.ADM_PUB_CST_NOB_MET_TRX_HAND_DI A
WHERE A.dt >= '20230101'
AND  A.dt <= '20240131'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020111_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020111_CST_02 AS
SELECT  t1.sbr_org_id
    ,t1.brc_org_nm
    ,t1.sbr_org_nm
    ,t.empe_id
	,CASE WHEN T4.POS_NM='客户经理'	THEN 1 ELSE 0 END IS_CST_MNG 	-- 客户经理
	,CASE WHEN T4.POS_NM='服务经理'	THEN 1 ELSE 0 END IS_SVC_MNG	-- 服务经理
FROM    edw.dws_hr_empe_inf_dd t
INNER JOIN   edw.dim_hr_org_mng_org_tree_dd t1
ON      t.org_id = t1.org_id
AND     t1.dt = '20240131'
and     t1.brc_org_nm REGEXP '分行'
LEFT JOIN EDW.DIM_HR_ORG_JOB_INF_DD			T4	--职位信息
ON 		T.POS_ENC=T4.POS_ID
AND 	T4.DT = '20231031'
WHERE   t.dt = '20240131'
AND     t.HC_TYP_CD = '1' --编制内
AND     t.lbr_typ_cd <> '07' --剔除合作用工
;
-- 贵金属结果表
DROP   TABLE IF     EXISTS SJXQ_SJ2024020111_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020111_CST_03 AS
SElECT t1.brc_org_nm					分行
    ,mng_num_24_1m						破冰总人数
    ,mng_num_23_1m                      2023年1月_人数
    ,mng_num_23                         2023全年_人数
    ,round(mng_num_24_1m/empe_num,3)    总人数破冰率
    ,cst_mgr_num                        客户经理
    ,svc_mgr_num                        服务经理
    ,scale_2024_1m                      金额_规模
    ,scale_2023_1m                      2023年1月_规模
    ,qty_2024_1m                        数量_件数
    ,qty_2023_1m                        2023年1月_件数
    ,MID_INC_2024_1m                    金额_中收
    ,MID_INC_2023_1m                    2023年1月中收
    ,sbr_cnt_2024_1m                    总数_网点
    ,sbr_cnt_2023_1m                    2023年1月_网点
	,sbr_cnt_2023 						2023年全年_网点
from (
    SElECT t1.RCM_PSN_AFL_BRN brc_org_nm
        ,count(DISTINCT case when t1.dt>='20240101' then t1.RCM_PSN_ID end)                         mng_num_24_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20230131' then t1.RCM_PSN_ID end)   mng_num_23_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20231231' then t1.RCM_PSN_ID end)   mng_num_23
        ,count(DISTINCT case when t1.dt>='20240101' and t2.IS_CST_MNG=1 then t2.empe_id end)        cst_mgr_num
        ,count(DISTINCT case when t1.dt>='20240101' and t2.IS_SVC_MNG=1 then t2.empe_id end)        svc_mgr_num
        ,sum(case when t1.dt>='20240101' then t1.CMDT_PAY_UNT_PRC else 0 end)                       scale_2024_1m
        ,sum(case when t1.dt>='20230101' and t1.dt<='20230131' then t1.CMDT_PAY_UNT_PRC else 0 end) scale_2023_1m
        ,sum(case when t1.dt>='20240101' then t1.QTY else 0 end)                                    qty_2024_1m
        ,sum(case when t1.dt>='20230101' and t1.dt<='20230131' then t1.QTY else 0 end)              qty_2023_1m
        ,sum(case when t1.dt>='20240101' then t1.MID_INC_TOT_AMT else 0 end)                        MID_INC_2024_1m
        ,sum(case when t1.dt>='20230101' and t1.dt<='20230131' then t1.MID_INC_TOT_AMT else 0 end)  MID_INC_2023_1m
        ,count(DISTINCT case when t1.dt>='20240101' then t1.RCM_PSN_AFL_SUB_BRN end)                        sbr_cnt_2024_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20230131' then t1.RCM_PSN_AFL_SUB_BRN end)  sbr_cnt_2023_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20231231' then t1.RCM_PSN_AFL_SUB_BRN end)  sbr_cnt_2023
    from SJXQ_SJ2024020111_CST_01       t1
    left join SJXQ_SJ2024020111_CST_02  t2 on t1.RCM_PSN_ID=t2.empe_id
    GROUP by t1.RCM_PSN_AFL_BRN
)t1 INNER join(
    SElECT brc_org_nm,count(1) empe_num
    from SJXQ_SJ2024020111_CST_02
    GROUP by brc_org_nm
)t2 on t1.brc_org_nm=t2.brc_org_nm
UNION all
SElECT t1.brc_org_nm					分行
    ,mng_num_24_1m						破冰总人数
    ,mng_num_23_1m                      2023年1月_人数
    ,mng_num_23                         2023全年_人数
    ,round(mng_num_24_1m/empe_num,3)    总人数破冰率
    ,cst_mgr_num                        客户经理
    ,svc_mgr_num                        服务经理
    ,scale_2024_1m                      金额_规模
    ,scale_2023_1m                      2023年1月_规模
    ,qty_2024_1m                        数量_件数
    ,qty_2023_1m                        2023年1月_件数
    ,MID_INC_2024_1m                    金额_中收
    ,MID_INC_2023_1m                    2023年1月中收
    ,sbr_cnt_2024_1m                    总数_网点
    ,sbr_cnt_2023_1m                    2023年1月_网点
	,sbr_cnt_2023 						2023年全年_网点
from (
    SElECT '合计' brc_org_nm
        ,count(DISTINCT case when t1.dt>='20240101' then t1.RCM_PSN_ID end)                         mng_num_24_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20230131' then t1.RCM_PSN_ID end)   mng_num_23_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20231231' then t1.RCM_PSN_ID end)   mng_num_23
        ,count(DISTINCT case when t1.dt>='20240101' and t2.IS_CST_MNG=1 then t2.empe_id end)        cst_mgr_num
        ,count(DISTINCT case when t1.dt>='20240101' and t2.IS_SVC_MNG=1 then t2.empe_id end)        svc_mgr_num
        ,sum(case when t1.dt>='20240101' then t1.CMDT_PAY_UNT_PRC else 0 end)                       scale_2024_1m
        ,sum(case when t1.dt>='20230101' and t1.dt<='20230131' then t1.CMDT_PAY_UNT_PRC else 0 end) scale_2023_1m
        ,sum(case when t1.dt>='20240101' then t1.QTY else 0 end)                                    qty_2024_1m
        ,sum(case when t1.dt>='20230101' and t1.dt<='20230131' then t1.QTY else 0 end)              qty_2023_1m
        ,sum(case when t1.dt>='20240101' then t1.MID_INC_TOT_AMT else 0 end)                        MID_INC_2024_1m
        ,sum(case when t1.dt>='20230101' and t1.dt<='20230131' then t1.MID_INC_TOT_AMT else 0 end)  MID_INC_2023_1m
        ,count(DISTINCT case when t1.dt>='20240101' then t1.RCM_PSN_AFL_SUB_BRN end)                        sbr_cnt_2024_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20230131' then t1.RCM_PSN_AFL_SUB_BRN end)  sbr_cnt_2023_1m
        ,count(DISTINCT case when t1.dt>='20230101' and t1.dt<='20231231' then t1.RCM_PSN_AFL_SUB_BRN end)  sbr_cnt_2023
    from SJXQ_SJ2024020111_CST_01       t1
    left join SJXQ_SJ2024020111_CST_02  t2 on t1.RCM_PSN_ID=t2.empe_id
)t1 INNER join(
    SElECT count(1) empe_num
    from SJXQ_SJ2024020111_CST_02
)t2 on 1=1
;
--保险交易明细 保险明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024020111_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020111_CST_04 AS
select t1.act_dt                                 --会计日期
	,replace(t1.trx_dt,'-','') trx_dt            --交易日期
	,t1.cst_id                                   --客户号
	,t1.mng_cnv_insu_fee                         --管护折算保费    规模
	,t1.mng_cnv_cmsn_fee                         --管护折算手续费  中收
	,t1.mng_cnv_nbr_num                          --管护折算件数    件数
	,t1.mng_mgr_id                               --管护客户经理工号
	,t1.mng_mgr_nm                               --管护客户经理姓名
	,t1.mng_rto                                  --管护比例
	,t1.mng_org_id                               --管护机构号
	,t1.mng_org_nm                               --管护机构名称
	,t1.sal_ppl_id                               --销售人员工号
	,t1.sal_ppl_nm                               --销售人员姓名
	,t1.sal_ppl_pst_id                           --销售人员岗位编号
	,t1.sal_ppl_pst_nm                           --销售人员岗位名称
	,t1.sal_ppl_afl_org_id                       --销售人员所属机构号
	,t1.sal_ppl_afl_org_nm                       --销售人员所属机构名称
	,t1.trx_tm                                   --交易时间
	,t1.sal_org_id_fh                            --销售人员所属机构所属分行
    ,T2.BRC_ORG_NM
    ,T2.SBR_ORG_NM
	,t1.dt                                       --日期分区
from app_rpt.fct_insu_agn_bus_acs_dtl_tbl   t1  --保险代销业务考核明细表 insu_plcy_id(insu_id),mng_mgr_id,mng_org_id 唯一
INNER join edw.dim_hr_org_mng_org_tree_dd   t2
ON      t1.sal_ppl_afl_org_id = t2.org_id
AND     t2.dt = '20240131'
and     t2.brc_org_nm REGEXP '分行'
WHERE t1.DT='20240131'
AND t1.TRX_DT >= '2023-01-01'
AND t1.TRX_DT <='2024-01-31'
;
-- 保险结果表
DROP   TABLE IF     EXISTS SJXQ_SJ2024020111_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020111_CST_05 AS
SElECT t1.brc_org_nm					分行
    ,mng_num_24_1m						破冰总人数
    ,mng_num_23_1m                      2023年1月_人数
    ,mng_num_23                         2023全年_人数
    ,round(mng_num_24_1m/empe_num,3)    总人数破冰率
    ,cst_mgr_num                        客户经理
    ,svc_mgr_num                        服务经理
    ,scale_2024_1m                      金额_规模
    ,scale_2023_1m                      2023年1月_规模
    ,qty_2024_1m                        数量_件数
    ,qty_2023_1m                        2023年1月_件数
    ,MID_INC_2024_1m                    金额_中收
    ,MID_INC_2023_1m                    2023年1月中收
    ,sbr_cnt_2024_1m                    总数_网点
    ,sbr_cnt_2023_1m                    2023年1月_网点
	,sbr_cnt_2023 						2023年全年_网点
from (
    SElECT t1.BRC_ORG_NM
        ,count(DISTINCT case when t1.TRX_DT>='20240101' then t1.sal_ppl_id end)                             mng_num_24_1m
        ,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.sal_ppl_id end)   mng_num_23_1m
        ,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20231231' then t1.sal_ppl_id end)   mng_num_23
        ,count(DISTINCT case when t1.TRX_DT>='20240101' and t2.IS_CST_MNG=1 then t2.empe_id end)            cst_mgr_num
        ,count(DISTINCT case when t1.TRX_DT>='20240101' and t2.IS_SVC_MNG=1 then t2.empe_id end)            svc_mgr_num
        ,sum(case when t1.TRX_DT>='20240101' then t1.mng_cnv_insu_fee else 0 end)                           scale_2024_1m
        ,sum(case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.mng_cnv_insu_fee else 0 end) scale_2023_1m
        ,sum(case when t1.TRX_DT>='20240101' then t1.mng_cnv_nbr_num else 0 end)                            qty_2024_1m
        ,sum(case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.mng_cnv_nbr_num else 0 end)  qty_2023_1m
        ,sum(case when t1.TRX_DT>='20240101' then t1.mng_cnv_cmsn_fee else 0 end)                           MID_INC_2024_1m
        ,sum(case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.mng_cnv_cmsn_fee else 0 end) MID_INC_2023_1m
        ,count(DISTINCT case when t1.TRX_DT>='20240101' then t1.SBR_ORG_NM end)                             sbr_cnt_2024_1m
        ,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.SBR_ORG_NM end)   sbr_cnt_2023_1m
		,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20231231' then t1.SBR_ORG_NM end)   sbr_cnt_2023
    from SJXQ_SJ2024020111_CST_04       t1
    left join SJXQ_SJ2024020111_CST_02  t2 on t1.sal_ppl_id=t2.empe_id
    GROUP by t1.BRC_ORG_NM
)t1 INNER join(
    SElECT brc_org_nm,count(1) empe_num
    from SJXQ_SJ2024020111_CST_02
    GROUP by brc_org_nm
)t2 on t1.brc_org_nm=t2.brc_org_nm
union all
SElECT t1.brc_org_nm					分行
    ,mng_num_24_1m						破冰总人数
    ,mng_num_23_1m                      2023年1月_人数
    ,mng_num_23                         2023全年_人数
    ,round(mng_num_24_1m/empe_num,3)    总人数破冰率
    ,cst_mgr_num                        客户经理
    ,svc_mgr_num                        服务经理
    ,scale_2024_1m                      金额_规模
    ,scale_2023_1m                      2023年1月_规模
    ,qty_2024_1m                        数量_件数
    ,qty_2023_1m                        2023年1月_件数
    ,MID_INC_2024_1m                    金额_中收
    ,MID_INC_2023_1m                    2023年1月中收
    ,sbr_cnt_2024_1m                    总数_网点
    ,sbr_cnt_2023_1m                    2023年1月_网点
	,sbr_cnt_2023 						2023年全年_网点
from (
    SElECT '合计' brc_org_nm
        ,count(DISTINCT case when t1.TRX_DT>='20240101' then t1.sal_ppl_id end)                             mng_num_24_1m
        ,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.sal_ppl_id end)   mng_num_23_1m
        ,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20231231' then t1.sal_ppl_id end)   mng_num_23
        ,count(DISTINCT case when t1.TRX_DT>='20240101' and t2.IS_CST_MNG=1 then t2.empe_id end)            cst_mgr_num
        ,count(DISTINCT case when t1.TRX_DT>='20240101' and t2.IS_SVC_MNG=1 then t2.empe_id end)            svc_mgr_num
        ,sum(case when t1.TRX_DT>='20240101' then t1.mng_cnv_insu_fee else 0 end)                           scale_2024_1m
        ,sum(case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.mng_cnv_insu_fee else 0 end) scale_2023_1m
        ,sum(case when t1.TRX_DT>='20240101' then t1.mng_cnv_nbr_num else 0 end)                            qty_2024_1m
        ,sum(case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.mng_cnv_nbr_num else 0 end)  qty_2023_1m
        ,sum(case when t1.TRX_DT>='20240101' then t1.mng_cnv_cmsn_fee else 0 end)                           MID_INC_2024_1m
        ,sum(case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.mng_cnv_cmsn_fee else 0 end) MID_INC_2023_1m
        ,count(DISTINCT case when t1.TRX_DT>='20240101' then t1.SBR_ORG_NM end)                             sbr_cnt_2024_1m
        ,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20230131' then t1.SBR_ORG_NM end)   sbr_cnt_2023_1m
		,count(DISTINCT case when t1.TRX_DT>='20230101' and t1.TRX_DT<='20231231' then t1.SBR_ORG_NM end)   sbr_cnt_2023
    from SJXQ_SJ2024020111_CST_04       t1
    left join SJXQ_SJ2024020111_CST_02  t2 on t1.sal_ppl_id=t2.empe_id
)t1 INNER join(
    SElECT count(1) empe_num
    from SJXQ_SJ2024020111_CST_02
)t2 on 1=1
;
--结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024020111_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020111_CST_06 AS
SElECT t1.分行
    ,t1.破冰总人数			破冰总人数_保险
    ,t1.2023年1月_人数      2023年1月_人数_保险
    ,t1.2023全年_人数       2023全年_人数_保险
    ,t1.总人数破冰率        总人数破冰率_保险
    ,t1.客户经理            客户经理_保险
    ,t1.服务经理            服务经理_保险
    ,t1.金额_规模           金额_规模_保险
    ,t1.2023年1月_规模      2023年1月_规模_保险
    ,t1.数量_件数           数量_件数_保险
    ,t1.2023年1月_件数      2023年1月_件数_保险
    ,t1.金额_中收           金额_中收_保险
    ,t1.2023年1月中收       2023年1月中收_保险
    ,t1.总数_网点           总数_网点_保险
    ,t1.2023年1月_网点      2023年1月_网点_保险
    ,t1.2023年全年_网点     2023年全年_网点_保险
    ,t2.破冰总人数			破冰总人数_贵金属
    ,t2.2023年1月_人数      2023年1月_人数_贵金属
    ,t2.2023全年_人数       2023全年_人数_贵金属
    ,t2.总人数破冰率        总人数破冰率_贵金属
    ,t2.客户经理            客户经理_贵金属
    ,t2.服务经理            服务经理_贵金属
    ,t2.金额_规模           金额_规模_贵金属
    ,t2.2023年1月_规模      2023年1月_规模_贵金属
    ,t2.数量_件数           数量_件数_贵金属
    ,t2.2023年1月_件数      2023年1月_件数_贵金属
    ,t2.金额_中收           金额_中收_贵金属
    ,t2.2023年1月中收       2023年1月中收_贵金属
    ,t2.总数_网点           总数_网点_贵金属
    ,t2.2023年1月_网点      2023年1月_网点_贵金属
    ,t2.2023年全年_网点     2023年全年_网点_贵金属
from SJXQ_SJ2024020111_CST_05       t1  --保险
left join SJXQ_SJ2024020111_CST_03  t2  --贵金属
on t1.分行=t2.分行
;
SElECT '01' seq, count(1) cnt, count(distinct CST_ID) custs
from SJXQ_SJ2024020111_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024020111_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct 分行) custs
from SJXQ_SJ2024020111_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct CST_ID) custs
from SJXQ_SJ2024020111_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct 分行) custs
from SJXQ_SJ2024020111_CST_05
;
01	44464	30447
02	10306	10306
03	14	14
04	22933	21537
05	14	14
***SJ2024020181_团购客户业务情况.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_01 AS
SELECT cst_id
    ,ORD_ID         --订单号
    ,add_tm         --订单时间
    ,pmt_tm         --付款时间
    ,cmdt_inf
    ,GET_JSON_OBJECT(cmdt_inf, '$.[0].goods_count')      AS goods_count     --商品数量
    ,GET_JSON_OBJECT(cmdt_inf, '$.[0].goods_all_price')  AS GOODS_ALL_PRICE --商品应付现金总额
    ,get_json_object(cmdt_inf, '$.[0].goods_name')       AS goods_name
    ,get_json_object(cmdt_inf, '$.[0].goods_class_name') AS goods_class_name
    ,sal_tot_prc	--销售总价
    ,stl_tot_prc	--结算总价
    ,row_number() over (partition by ord_id order by cmdt_id desc) rn
FROM  edw.dwd_bus_cmpn_pnt_mall_ord_srl_dd -- 积分商城订单流水明细
where dt = '20240131'
and tsk_actv_typ_cd = 'tuangou'
and tnt_id = 'tlcard'
AND nvl(pmt_tm,'')<>'' --付款时间
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_02 AS
SELECT  ORD_ID --订单号
        ,GET_JSON_OBJECT(name_tmp, '$.goods_commission_type')   AS goods_commission_type --类型
        ,GET_JSON_OBJECT(name_tmp, '$.goods_gsp_ids')           AS goods_gsp_ids --商品规格
        ,GET_JSON_OBJECT(name_tmp, '$.goods_gsp_val')           AS goods_gsp_val -- 商品规格中文
        ,GET_JSON_OBJECT(name_tmp, '$.goods_commission_rate')   AS goods_commission_rate --佣金比例/金额
        ,GET_JSON_OBJECT(name_tmp, '$.settle_commission_price') AS settle_commission_price --佣金总额
        ,GET_JSON_OBJECT(name_tmp, '$.goods_id')                AS goods_id --商品ID
        ,GET_JSON_OBJECT(name_tmp, '$.goods_count')             AS goods_count --商品数量
        ,GET_JSON_OBJECT(name_tmp, '$.goods_price')             AS goods_price --商品现金单价
        ,GET_JSON_OBJECT(name_tmp, '$.goods_all_price')         AS GOODS_ALL_PRICE --商品应付现金总额
        ,GET_JSON_OBJECT(name_tmp, '$.goods_return_status')     AS goods_return_status --商品退款状态
FROM    (
    SELECT  REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(json_str, '^\\[', ''), '\\]$', ''), '},\\{', '}|{') AS json_str1
            ,t1.ORD_ID
    FROM    (
                SELECT  TRIM(CMDT_INF) AS json_str
                        ,ORD_ID        AS ORD_ID
                FROM    SJXQ_SJ2024020181_CST_01       --积分商城订单
                WHERE   LENGTH(CMDT_INF) > 0
                and     rn=1
            ) t1
) t2 LATERAL VIEW explode(SPLIT(json_str1, '\\|')) b AS name_tmp
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_03 AS
select t1.cst_id                            --客户号|C20
	,t1.cst_chn_nm                          --客户中文名称|C200
	,t1.gdr_cd                              --性别代码|C1
    ,decode(t1.gdr_cd,'1','男','2','女','') gender
    ,T3.PRM_MGR_ID
    ,T3.PRM_MGR_NM
    ,T3.PRM_ORG_ID
    ,t4.cost_cnt
    ,t4.cost_amt
	,t1.own_emp_id                          --本行员工号|C10
    ,t1.own_empe_ind
	,t1.sam_rsk_ctrl_id                     --同一风险控制号|C24
	,t1.mbl_nbr                             --手机|C32
	,t1.file_dt                             --建档日期|C8
    ,t6.cprh_cmnt_id                        --综合社区编号
    ,t6.cprh_cmnt_plt_id                    --综合社区板块编号
    ,t6.sub_cmnt_id                         --子社区编号
    ,t7.cmnt_nm                             --社区名称
    ,t7.adr                                 --社区地址
from edw.dws_cst_idv_bas_inf_dd       t1         --个人客户基本信息汇总表
inner join qbi_file_20240205_10_59_43 t2
on  t1.mbl_nbr=t2.cst_phone
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3    --客户`主管户`信息 16065131 cst_id 唯一
on      t1.cst_id = t3.cst_id
and     t3.dt = '20240131'
left join(
    select cst_id
        ,count(1)           cost_cnt
        ,sum(stl_tot_prc)   cost_amt
    from SJXQ_SJ2024020181_CST_01
    where rn=1
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20240131'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20240131'
where t1.dt='20240131'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_04 AS
select t1.cst_id                            --客户号|C20
    ,t1.sam_rsk_ctrl_id                     --同一风险控制号|C24
    ,t8.dep_bal_year_avg	                --存款年日均
    ,t8.fnc_year_avg_amt	                --理财年日均
    ,t9.loan_bal_acs_year_avg	            --贷款余额年日均
from edw.dws_cst_idv_bas_inf_dd                 t1 --个人客户基本信息汇总表
left join app_rpt.adm_subl_cst_wlth_bus_inf_dd	t8 --正式客户财富业务信息表
on  t1.cst_id=t8.cst_id
and t8.dt='20240131'
left join adm_pub.adm_csm_cbus_loan_inf_dd	    t9 --客户集市-业务信息-客户贷款业务信息表
on  t1.cst_id=t9.cst_id
and t9.dt='20240131'
where t1.dt='20240131'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_05 AS
select t1.cst_id                            --客户号|C20
    ,t1.sam_rsk_ctrl_id                     --同一风险控制号|C24
    ,t8.dep_bal_year_avg	                --存款年日均
    ,t8.fnc_year_avg_amt	                --理财年日均
    ,t9.loan_bal_acs_year_avg	            --贷款余额年日均
from edw.dws_cst_idv_bas_inf_dd                 t1 --个人客户基本信息汇总表
left join app_rpt.adm_subl_cst_wlth_bus_inf_dd	t8 --正式客户财富业务信息表
on  t1.cst_id=t8.cst_id
and t8.dt='20231231'
left join adm_pub.adm_csm_cbus_loan_inf_dd	    t9 --客户集市-业务信息-客户贷款业务信息表
on  t1.cst_id=t9.cst_id
and t9.dt='20231231'
where t1.dt='20231231'
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_06;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_06 AS
SELECT T1.CST_ID,T1.sam_rsk_ctrl_id
    ,sum(t2.dep_bal_year_avg)       dep_year_avg_1m
    ,sum(t2.fnc_year_avg_amt)       fnc_year_avg_1m
    ,sum(t2.loan_bal_acs_year_avg)  lon_year_avg_1m
    ,sum(t3.dep_bal_year_avg)       dep_year_avg_12m
    ,sum(t3.fnc_year_avg_amt)       fnc_year_avg_12m
    ,sum(t3.loan_bal_acs_year_avg)  lon_year_avg_12m
FROM SJXQ_SJ2024020181_CST_03         T1
LEFT JOIN SJXQ_SJ2024020181_CST_04    T2
ON T1.sam_rsk_ctrl_id=T2.sam_rsk_ctrl_id
LEFT JOIN SJXQ_SJ2024020181_CST_05    T3
ON T1.sam_rsk_ctrl_id=T3.sam_rsk_ctrl_id
where nvl(t1.sam_rsk_ctrl_id,'')<>''        --不限制会跑不出来
GROUP BY T1.CST_ID,T1.sam_rsk_ctrl_id
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024020181_CST_07;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020181_CST_07 AS
select t1.mbl_nbr           客户手机号码
    ,t1.cst_id              客户号
	,t1.cst_chn_nm          客户名称
    ,T1.PRM_ORG_ID          主管户机构号
    ,T1.PRM_MGR_ID          主管户客户经理工号
    ,t1.gender              性别
    ,t1.own_empe_ind        是否员工
    ,t1.cost_cnt            团购次数
    ,t1.cost_amt            团购金额
    ,t1.cmnt_nm             社区名称
    ,t2.sam_rsk_ctrl_id     同一风险控制号
    ,t2.dep_year_avg_12m    20231231同一风险控制号下存款年日均合计
    ,t2.fnc_year_avg_12m    20231231同一风险控制号下理财年日均合计
    ,t2.lon_year_avg_12m    20231231同一风险控制号下贷款年日均合计
    ,case when a1.cst_id is not null then 1 else 0 end  20231231前是否办理过信用卡
    ,case when b1.cst_id is not null then 1 else 0 end  20231231前是否买过贵金属
    ,case when c1.cst_id is not null then 1 else 0 end  20231231前是否买过保险
    ,t2.dep_year_avg_1m     20240131同一风险控制号下存款年日均合计
    ,t2.fnc_year_avg_1m     20240131同一风险控制号下理财年日均合计
    ,t2.lon_year_avg_1m     20240131同一风险控制号下贷款年日均合计
    ,case when a2.cst_id is not null then 1 else 0 end  20240131前是否办理过信用卡
    ,case when b2.cst_id is not null then 1 else 0 end  20240131前是否买过贵金属
    ,case when c2.cst_id is not null then 1 else 0 end  20240131前是否买过保险
from SJXQ_SJ2024020181_CST_03       t1
left join SJXQ_SJ2024020181_CST_06  t2
on t1.cst_id=t2.cst_id
left join (
    SELECT distinct CST_ID
    FROM edw.dim_bus_crd_cr_crd_inf_dd --信用卡卡片信息
    WHERE DT = '20231231'
)A1 ON T1.CST_ID=A1.CST_ID
left join (
    SELECT distinct CST_ID
    FROM edw.dim_bus_crd_cr_crd_inf_dd --信用卡卡片信息
    WHERE DT = '20240131'
)A2 ON T1.CST_ID=A2.CST_ID
left join (
    SElECT cst_id                   --客户号
    from adm_pub.adm_pub_cst_nob_met_trx_dtl_di --贵金属交易明细表
    where dt <= '20231231'
    and cmdt_pay_unt_prc>0
    union
    SElECT cst_id                   --客户号
    from adm_pub.adm_pub_cst_nob_met_trx_hand_di --贵金属柜面或退款交易手工表
    where dt <= '20231231'
    and cmdt_pay_unt_prc>0
)B1 ON T1.CST_ID=B1.CST_ID
left join (
    SElECT cst_id                   --客户号
    from adm_pub.adm_pub_cst_nob_met_trx_dtl_di --贵金属交易明细表
    where dt <= '20240131'
    and cmdt_pay_unt_prc>0
    union
    SElECT cst_id                   --客户号
    from adm_pub.adm_pub_cst_nob_met_trx_hand_di --贵金属柜面或退款交易手工表
    where dt <= '20240131'
    and cmdt_pay_unt_prc>0
)B2 ON T1.CST_ID=B2.CST_ID
left join (
    SElECT DISTINCT cst_id
    from edw.dwd_bus_insu_plcy_insu_inf_dd  --保险交易
    where dt ='20231231' and insu_fee>0
)C1 ON T1.CST_ID=C1.CST_ID
left join (
    SElECT DISTINCT cst_id
    from edw.dwd_bus_insu_plcy_insu_inf_dd  --购买过保险
    where dt ='20240131' and insu_fee>0
)C2 ON T1.CST_ID=C2.CST_ID
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020181_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct ORD_ID) custs
from SJXQ_SJ2024020181_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020181_CST_03
UNION all
SElECT '031' seq, count(1) cnt, count(distinct mbl_nbr) custs
from SJXQ_SJ2024020181_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020181_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020181_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020181_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024020181_CST_07
UNION all
SElECT '071' seq, count(1) cnt, count(distinct 客户手机号码) custs
from SJXQ_SJ2024020181_CST_07
;
01	11864	3405
02	0	0
03	1426	1426
031	1426	810
04	14463368	14463368
05	14376433	14376433
06	855	855
07	1426	1426
071	1426	810
899条记录匹配出810个手机号，匹配出1426个客户号
*/
***SJ2024020441_台州分行挂钩理财客户余额.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024020441_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020441_CST_01 AS
SElECT brc_org_nm 		--账户考核机构分行名称
    ,sbr_org_id         --账户考核机构支行编号
    ,sbr_org_nm         --账户考核机构支行名称
    ,tem_org_nm         --账户考核机构团队名称
    ,cst_id             --客户号
from qbi_file_20240218_11_44_12
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020441_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020441_CST_02 AS
SElECT t1.brc_org_nm 	    账户考核机构分行名称
    ,t1.sbr_org_id          账户考核机构支行编号
    ,t1.sbr_org_nm          账户考核机构支行名称
    ,t1.tem_org_nm          账户考核机构团队名称
    ,t1.cst_id              客户号
    ,t2.dep_bal             1031存款余额
    ,t3.dep_bal             1130存款余额
    ,t4.dep_bal             1231存款余额
    ,t5.dep_bal             0131存款余额
FROM SJXQ_SJ2024020441_CST_01               t1
inner join adm_pub.adm_csm_cbus_dep_inf_dd  t2 on t1.cst_id=t2.cst_id and t2.dt='20231031'
inner join adm_pub.adm_csm_cbus_dep_inf_dd  t3 on t1.cst_id=t3.cst_id and t3.dt='20231130'
inner join adm_pub.adm_csm_cbus_dep_inf_dd  t4 on t1.cst_id=t4.cst_id and t4.dt='20231231'
inner join adm_pub.adm_csm_cbus_dep_inf_dd  t5 on t1.cst_id=t5.cst_id and t5.dt='20240131'
;
SELECT *
from SJXQ_SJ2024020441_CST_02
ORDER BY 账户考核机构支行编号,账户考核机构团队名称
***SJ2024020556_台州分行挂钩型理财0218.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_01; -- 01	3113	2959
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_01 AS
SElECT cast(seq as int) seq
    ,brc_org_nm 		--账户考核机构分行名称
    ,sbr_org_id         --账户考核机构支行编号
    ,sbr_org_nm         --账户考核机构支行名称
    ,tem_org_nm         --账户考核机构团队名称
    ,pd_cd              --产品代码
    ,srl_nb             --流水号
    ,cst_id             --客户号
    ,mgr_id             --管户人工号
    ,cfm_amt            --管户认购金额
    ,trx_dt             --购买日期
from qbi_file_20240207_10_10_51
;
-- 客户前14日所有交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_01_1; -- 39214
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_01_1 AS
SELECT T1.CST_ID,T1.TRX_DT BUY_FIN_DT,t1.cfm_amt
    ,t2.cst_act_id,t2.dep_act_id,t3.dtl_seq_nbr
    ,t3.trx_dt,t3.trx_tm,t3.crd_and_dbt_ind,t3.trx_amt,t3.act_bal
    ,t3.txt_code
    ,t4.cd_val_dscr txt_nm
    ,t3.smr_dscr                                 --摘要描述|C512
	,t3.cnt_pty_act_nm                           --对方户名|c200
	,t3.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t3.cnt_pty_fin_instt_typ_cd                 --对方金融机构类型代码|C2
    ,t3.cmt
	,t3.act_nm                                   --账户名称|C200
	,t3.bal_fld_nm                               --余额字段名称|C32
FROM(
    SELECT CST_ID,TRX_DT,sum(cfm_amt) cfm_amt
    FROM SJXQ_SJ2024020556_CST_01
    GROUP by CST_ID,TRX_DT
)T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
ON T1.CST_ID=T2.CST_ID
AND T2.DT='20240210'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3   --交易表数据不全
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.DT<='20240210'
AND T3.TRX_DT<=t1.TRX_DT
AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(t1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd')
left join edw.dwd_code_library_dd           t4
on t3.txt_code=t4.cd_val
and t4.dt='20240210'
;
--交易前14日 行外转入金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_02 AS
SELECT T1.CST_ID,T1.TRX_DT
    ,SUM(T3.trx_amt)    bank_out_in_amt_14d
    ,MAX(T3.TRX_DT)     LST_BANK_OUT_IN_DT
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
ON T1.CST_ID=T2.CST_ID
AND T2.DT='20240210'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.cnt_pty_fin_instt_nm not like '%泰隆%'   --行外
AND T3.CRD_AND_DBT_IND='C' 	                    --转入
    ,'DP2129' 	--大额存单手工赎回
    ,'IB0040' 	--鑫钱宝赎回-自动
    ,'IB0042' 	--鑫钱宝-补记赎回
    ,'IB0043' 	--鑫钱宝-赎回冲正
    ,'IB0044' 	--鑫钱宝-全额赎回(解约申请)
    ,'IB0045' 	--鑫钱宝-定额赎回(人工赎回)
    ,'LC0002' 	--财富产品赎回
    ,'LC0009' 	--组合产品申购/赎回
    ,'LC0010' 	--组合产品赎回
    ,'LN1033' 	--单笔赎回
    ,'TA0005' 	--股本金记账
    ,'TA0632' 	--股本金记账
    ,'TY0066' 	--理财赎回(理财)
    ,'TY0067' 	--理财赎回(基金)
    ,'TY0068' 	--理财赎回(财富宝)
    ,'TY0069' 	--理财赎回(小鱼钱包)
    ,'TY0089' 	--天添向上赎回
    ,'TY0141' 	--T+0产品赎回
    ,'ZHB002' 	--天添宝赎回
    ,'LC0003'	--财富产品兑付
    ,'LC0005'     --财富产品购买冻结              剔除买入当日该笔购买交易
) AND T3.DT<='20240210'
AND T3.TRX_DT<=T1.TRX_DT
AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
GROUP BY T1.CST_ID,T1.TRX_DT
;
-- 交易前14日 行外转入金额明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_02_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_02_1 AS
SELECT T1.CST_ID,T1.TRX_DT BUY_FIN_DT
    ,t2.CST_ACT_ID,t2.DEP_ACT_ID,t2.ACT_STS_CD,t2.stl_act_ind
    ,t3.dtl_seq_nbr                           --明细序号|INTEGER
	,t3.trx_dt                                   --交易日期|C8
	,t3.trx_tm                                   --交易时间|C9
	,t3.trx_amt                                  --交易金额|DECIMAL(21,t3.2)
	,t3.act_bal                                  --账户余额|DECIMAL(21,t3.2)
	,t3.txt_code                                 --摘要代码|C10
	,t3.smr_dscr                                 --摘要描述|C512
	,t3.trx_chnl_cd                              --交易渠道代码|C3
	,t3.csh_ind                                  --现转标志|C1
	,t3.cnt_pty_cst_act_id                       --对方客户账号|C32
	,t3.cnt_pty_sub_act_seq_nbr                  --对方子账户序号|C8
	,t3.cnt_pty_sys_act_id                       --对方系统账号|C32
	,t3.cnt_pty_act_nm                           --对方户名|c200
	,t3.cnt_pty_cst_typ_cd                       --对方客户类型代码|C2
	,t3.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t3.cnt_pty_fin_instt_typ_cd                 --对方金融机构类型代码|C2
	,t3.cnt_pty_fin_instt_cd                     --对方金融机构代码|C12
	,t3.cmt                                      --备注|C200
	,t3.trx_trg_mth                              --交易触发方式|C2
	,t3.tms                                      --时间戳|DECIMAL(8)
	,t3.act_nm                                   --账户名称|C200
	,t3.bal_fld_nm                               --余额字段名称|C32
	,t3.prod_id                                  --产品编号|C24
	,t3.crad_ind_cd                              --卡标志代码|C2
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
ON T1.CST_ID=T2.CST_ID
AND T2.DT='20240210'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.cnt_pty_fin_instt_nm not like '%泰隆%'   --行外
AND T3.CRD_AND_DBT_IND='C' 	                    --转入
and t3.txt_code <> 'LC0005'     --财富产品购买冻结              剔除买入当日该笔购买交易
    ,'LN1033','TA0005','TA0632','TY0`066','TY0067','TY0068','TY0069','TY0089','TY0141','ZHB002','LC0003')
AND T3.DT<='20240210'
AND T3.TRX_DT<=T1.TRX_DT
AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
;
--交易前14日 定期存款到期金额 到期会注销账户 CUR_ACT_BAL,GL_BAL 为0
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_03 AS
SELECT T1.CST_ID,T1.TRX_DT
    ,SUM(T2.opn_amt)    regu_dep_ovd_amt_14d
    ,MAX(t2.mtu_dt)     LST_DEP_MTU_DT
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 inner join edw.dws_bus_dep_act_inf_dd t2
on  t1.cst_id=t2.cst_id
and t2.mtu_dt<=T1.TRX_DT
and t2.mtu_dt>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
and t2.dt='20240210'
AND t2.lbl_prod_typ_cd='1'  --存款产品类型代码 0:活期 1:定期
AND T2.act_mth_acm_bal>0    --月累计总账余额积数
GROUP BY T1.CST_ID,T1.TRX_DT
;
-- SELECT T1.CST_ID,T1.TRX_DT,SUM(T3.trx_amt) cls_fnc_ovd_amt_14d
-- FROM(
--     SELECT DISTINCT CST_ID,TRX_DT
--     FROM SJXQ_SJ2024020556_CST_01
-- )T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
-- ON T1.CST_ID=T2.CST_ID
-- AND T2.DT='20240210'
-- INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3
-- ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
-- AND T2.CST_ACT_ID=T3.CST_ACT_ID
-- AND T3.CRD_AND_DBT_IND='C' 	                --转入
-- AND T3.DT<='20240210'
-- AND T3.TRX_DT<=T1.TRX_DT
-- AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
-- AND T3.txt_code='DP0235'	--销户 定期存款到期
-- GROUP BY T1.CST_ID,T1.TRX_DT
-- ;
--交易前14日 定期存款到期明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_03_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_03_1 AS
SELECT T1.CST_ID,T1.TRX_DT
    ,t2.act_nm                                   --账户名称|C300
	,t2.dep_trm                                  --存期|C6
	,t2.int_val_dt                               --起息日期|C8
	,t2.mtu_dt                                   --到期日期|C8
	,t2.opn_dt                                   --开户日期|C8
	,t2.act_dstr_act_dt                          --销户日期|C8
	,t2.gl_bal                                   --账户总账余额
	,t2.prod_id                                  --存款产品代码|C24
	,t2.cst_tp                                   --所属客户类型代码|C1
	,t2.dep_cls_cd                               --存款种类|C4
	,t2.act_sts_cd                               --存款账户状态代码|C1
	,t2.stl_act_ind                              --结算账户标志|C1
	,t2.opn_amt                                  --开户金额
	,t2.ini_mtu_dt                               --初始到期日期|C8
	,t2.ini_val_dt                               --初始起息日期|C8
	,t2.cur_act_bal                              --当前账户余额
	,t2.frs_dep_dt                               --首次存入日期|C8
	,t2.act_ctg_cd_1                             --账户分类代码1|C32
	,t2.bal_gl_ind                               --余额总账同步标志|C1
	,t2.ac_vld_prd_dt                            --账户有效日期|C8
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 inner join edw.dws_bus_dep_act_inf_dd t2
on  t1.cst_id=t2.cst_id
and t2.mtu_dt<=T1.TRX_DT
and t2.mtu_dt>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
and t2.dt='20240210'
AND t2.lbl_prod_typ_cd='1'  --存款产品类型代码 0:活期 1:定期
AND T2.act_mth_acm_bal>0    --月累计总账余额积数
;
/*
SELECT *
from SJXQ_SJ2024020556_CST_03_2
ORDER BY cst_id,BUY_FIN_DT,trx_dt,trx_tm
*/
--交易前14日 开放式理财赎回金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_04 AS
SELECT T1.CST_ID,T1.TRX_DT
    ,SUM(T3.trx_amt)    opn_fnc_ovd_amt_14d
    ,MAX(T3.TRX_DT)     LST_OPN_FNC_OVD_DT
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
ON T1.CST_ID=T2.CST_ID
AND T2.DT='20240210'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.CRD_AND_DBT_IND='C' 	                --转入
AND T3.DT<='20240210'
AND T3.TRX_DT<=T1.TRX_DT
AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
AND T3.txt_code IN(  'B00632' 	--股本金记账
                    ,'DP2129' 	--大额存单手工赎回
                    ,'IB0040' 	--鑫钱宝赎回-自动
                    ,'IB0042' 	--鑫钱宝-补记赎回
                    ,'IB0043' 	--鑫钱宝-赎回冲正
                    ,'IB0044' 	--鑫钱宝-全额赎回(解约申请)
                    ,'IB0045' 	--鑫钱宝-定额赎回(人工赎回)
                    ,'LC0002' 	--财富产品赎回
                    ,'LC0009' 	--组合产品申购/赎回
                    ,'LC0010' 	--组合产品赎回
                    ,'LN1033' 	--单笔赎回
                    ,'TA0005' 	--股本金记账
                    ,'TA0632' 	--股本金记账
                    ,'TY0066' 	--理财赎回(理财)
                    ,'TY0067' 	--理财赎回(基金)
                    ,'TY0068' 	--理财赎回(财富宝)
                    ,'TY0069' 	--理财赎回(小鱼钱包)
                    ,'TY0089' 	--天添向上赎回
                    ,'TY0141' 	--T+0产品赎回
                    ,'ZHB002' 	--天添宝赎回
) GROUP BY T1.CST_ID,T1.TRX_DT
;
--交易前14日 封闭式理财到期金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_05 AS
SELECT T1.CST_ID,T1.TRX_DT
    ,SUM(T3.trx_amt)    cls_fnc_ovd_amt_14d
    ,MAX(T3.TRX_DT)     LST_CLS_FNC_OVD_DT
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
ON T1.CST_ID=T2.CST_ID
AND T2.DT='20240210'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.CRD_AND_DBT_IND='C' 	                --转入
AND T3.DT<='20240210'
AND T3.TRX_DT<=T1.TRX_DT
AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd') --交易日前14天
AND T3.txt_code='LC0003'	--财富产品兑付
GROUP BY T1.CST_ID,T1.TRX_DT
;
/*
目前
行外转入口径：交易对手不含&ldquo;泰隆&rdquo;的转入，且 摘要代码 不属于理财赎回。需要和你确认下
定期存款到期：目前交易表中缺失，需要和开发核对
开放式理财 摘要代码 如下，和相伟核对过
'B00632' 	--股本金记账
,'DP2129' 	--大额存单手工赎回
,'IB0040' 	--鑫钱宝赎回-自动
,'IB0042' 	--鑫钱宝-补记赎回
,'IB0043' 	--鑫钱宝-赎回冲正
,'IB0044' 	--鑫钱宝-全额赎回(解约申请)
,'IB0045' 	--鑫钱宝-定额赎回(人工赎回)
,'LC0002' 	--财富产品赎回
,'LC0009' 	--组合产品申购/赎回
,'LC0010' 	--组合产品赎回
,'LN1033' 	--单笔赎回
,'TA0005' 	--股本金记账
,'TA0632' 	--股本金记账
,'TY0066' 	--理财赎回(理财)
,'TY0067' 	--理财赎回(基金)
,'TY0068' 	--理财赎回(财富宝)
,'TY0069' 	--理财赎回(小鱼钱包)
,'TY0089' 	--天添向上赎回
,'TY0141' 	--T+0产品赎回
,'ZHB002' 	--天添宝赎回
封闭式理财 摘要代码 如下，为自己查数据所得
'LC0003'	--财富产品兑付
*/
--交易前14日 账户余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_05_1;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_05_1 AS
SELECT T1.CST_ID,T1.TRX_DT BUY_FIN_DT,T3.TRX_DT,MAX(t3.act_bal) ACT_BAL
FROM(
    SELECT DISTINCT CST_ID,TRX_DT
    FROM SJXQ_SJ2024020556_CST_01
)T1 INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2
ON T1.CST_ID=T2.CST_ID
AND T2.DT='20240210'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3   --交易表数据不全
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.DT<='20240210'
AND T3.TRX_DT=TO_CHAR(DATEADD(TO_DATE(t1.TRX_DT, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd')
GROUP BY T1.CST_ID,T1.TRX_DT,T3.TRX_DT
;
--结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_06;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_06 AS
SELECT T1.seq
    ,T1.brc_org_nm 		   --账户考核机构分行名称
    ,T1.sbr_org_id         --账户考核机构支行编号
    ,T1.sbr_org_nm         --账户考核机构支行名称
    ,T1.tem_org_nm         --账户考核机构团队名称
    ,T1.pd_cd              --产品代码
    ,T1.srl_nb             --流水号
    ,T1.cst_id             --客户号
    ,T1.mgr_id             --管户人工号
    ,T1.cfm_amt            --管户认购金额
    ,T1.trx_dt             --购买日期
    ,t2.bank_out_in_amt_14d
    ,t3.regu_dep_ovd_amt_14d
    ,t4.opn_fnc_ovd_amt_14d
    ,t5.cls_fnc_ovd_amt_14d
    ,nvl(t2.bank_out_in_amt_14d,0)
        + nvl(t3.regu_dep_ovd_amt_14d,0)
        + nvl(t4.opn_fnc_ovd_amt_14d,0)
        + nvl(t5.cls_fnc_ovd_amt_14d,0) tot_in_amt
    ,T6.ACT_BAL
FROM SJXQ_SJ2024020556_CST_01       t1
left join SJXQ_SJ2024020556_CST_02  t2 on t1.cst_id=t2.cst_id and t1.trx_dt=t2.trx_dt
left join SJXQ_SJ2024020556_CST_03  t3 on t1.cst_id=t3.cst_id and t1.trx_dt=t3.trx_dt
left join SJXQ_SJ2024020556_CST_04  t4 on t1.cst_id=t4.cst_id and t1.trx_dt=t4.trx_dt
left join SJXQ_SJ2024020556_CST_05  t5 on t1.cst_id=t5.cst_id and t1.trx_dt=t5.trx_dt
left join SJXQ_SJ2024020556_CST_05_1  t6 on t1.cst_id=t6.cst_id and t1.trx_dt=t6.BUY_FIN_DT
;
SElECT *
from SJXQ_SJ2024020556_CST_06
where tot_in_amt<cfm_amt and act_bal<cfm_amt
ORDER BY seq
;
SElECT *
from SJXQ_SJ2024020556_CST_06
where bank_out_in_amt_14d<cfm_amt
;
--20240218 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_08;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_08 AS
SElECT cst_id                      客户号
    ,trx_dt                        挂钩理财购买日期
    ,cst_act_id                    客户主账号
    ,dep_act_id                    存款账号
    ,trx_dt                        交易日期
    ,trx_tm                        交易时间
    ,crd_and_dbt_ind               借贷标志
    ,trx_amt                       交易金额
    ,act_bal                       账户余额
    ,txt_code                      摘要代码
    ,cd_val_dscr                   摘要代码说明
    ,smr_dscr                      摘要描述
    ,cnt_pty_act_nm                对方户名
    ,cnt_pty_fin_instt_nm          对方金融机构名称
    ,cmt                           备注
from SJXQ_SJ2024020556_CST_01_1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_09;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_09 AS
SELECT txt_code         摘要代码
    ,cd_val_dscr        摘要代码说明
    ,count(1)           购买挂钩理财前14日转入资金次数
    ,sum(trx_amt)       购买挂钩理财前14日转入金额
from SJXQ_SJ2024020556_CST_01_1
where crd_and_dbt_ind='C'
GROUP BY txt_code,cd_val_dscr
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST_10;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST_10 AS
SElECT seq                 序号
    ,T1.brc_org_nm 		   账户考核机构分行名称
    ,T1.sbr_org_id         账户考核机构支行编号
    ,T1.sbr_org_nm         账户考核机构支行名称
    ,T1.tem_org_nm         账户考核机构团队名称
    ,T1.pd_cd              产品代码
    ,T1.srl_nb             流水号
    ,T1.cst_id             客户号
    ,T1.mgr_id             管户人工号
    ,T1.cfm_amt            管户认购金额
    ,T1.trx_dt             购买日期
    ,bank_out_in_amt_14d        近14日行外转入金额
    ,regu_dep_ovd_amt_14d       近14日定期存款到期金额
    ,opn_fnc_ovd_amt_14d        近14日开放式理财赎回金额
    ,cls_fnc_ovd_amt_14d        近14日封闭式理财赎回金额
    ,tot_in_amt                 近14日转入总金额
    ,act_bal                    前14日账户余额
from SJXQ_SJ2024020556_CST_06 t1
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024020556_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020556_CST_02
UNION all
SElECT '02_1' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020556_CST_02_1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020556_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020556_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024020556_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024020556_CST_06
;
01	3113	2959
02	2623	2309
02_1	11177	2309
03	220	202
04	1044	918
05	240	211
06	3113	2959
/*
-- 封闭式理财产品 业务代码,交易代码 151	100413
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_EXP_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_EXP_01 AS
SELECT t1.bus_cd,t1.trx_cd
    ,t1.trx_dt,t1.cst_id,t1.bnk_act_id,t1.pd_cd,t1.cfm_amt
from edw.dwd_bus_chm_trx_cfm_dtl_di 	t1
INNER JOIN edw.dim_bus_chm_pd_inf_dd    t2            --理财产品信息
on  t1.pd_cd=t2.pd_cd
and t1.trx_dt=t2.pd_end_dt --产品交易日为产品到期日
and t2.dt='20240210'
and t2.pd_ctg_cd='1' 	--剔除基金
and t2.TRX_MTH_CD='2' --封闭式理财
and t2.pd_end_dt >='20231001'
where t1.dt<='20240210'
;
SElECT distinct bus_cd,trx_cd
from SJXQ_SJ2024020556_EXP_01
;
-- 封闭式理财产品到期 摘要代码
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_EXP_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_EXP_02 AS
select a.cst_id,b.CST_ACT_ID,b.DEP_ACT_ID
	,c.trx_dt pd_end_dt,b.trx_dt,b.trx_amt,b.txt_code,b.smr_dscr,b.cmt
	,b.cnt_pty_cst_act_id                       --对方客户账号|C32
	,b.cnt_pty_sub_act_seq_nbr                  --对方子账户序号|C8
	,b.cnt_pty_sys_act_id                       --对方系统账号|C32
	,b.cnt_pty_act_nm                           --对方户名|c200
	,b.cnt_pty_cst_typ_cd                       --对方客户类型代码|C2
	,b.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,b.cnt_pty_fin_instt_typ_cd                 --对方金融机构类型代码|C2
	,b.cnt_pty_fin_instt_cd                     --对方金融机构代码|C12
from edw.DIM_BUS_DEP_ACT_INF_DD             A
INNER join edw.DWD_BUS_DEP_BAL_CHG_DTL_DI   B
ON   A.DEP_ACT_ID=B.DEP_ACT_ID
AND  A.CST_ACT_ID=B.CST_ACT_ID
and b.crd_and_dbt_ind='C' 	--转入
and b.dt<='20240210'
and b.trx_dt>='20231001'
inner join SJXQ_SJ2024020556_EXP_01         C
on  a.cst_id=c.cst_id
and b.trx_amt=c.cfm_amt
and b.trx_dt>=c.trx_dt
where  A.dt='20240210'
;
--定期存款到期
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_EXP_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_EXP_03 AS
select dep_act_id                               --存款账号|C32
	,cst_act_id                               --客户账号|C32
	,ccy_cd                                   --币种代码|C3
	,cst_id                                   --客户号|C20
	,act_nm                                   --账户名称|C300
	,dep_trm                                  --存期|C6
	,int_val_dt                               --起息日期|C8
	,mtu_dt                                   --到期日期|C8
	,gl_bal                                   --账户总账余额|DECIMAL(20,2)
	,prod_id                                  --存款产品代码|C24
	,cst_tp                                   --所属客户类型代码|C1
	,lbl_prod_typ_cd                          --存款产品类型代码|C1
	,dep_cls_cd                               --存款种类|C4
	,act_sts_cd                               --存款账户状态代码|C1
	,stl_act_ind                              --结算账户标志|C1
	,opn_amt                                  --开户金额|DECIMAL(20,2)
	,ini_mtu_dt                               --初始到期日期|C8
	,ini_val_dt                               --初始起息日期|C8
	,cur_act_bal                              --当前账户余额|DECIMAL(20,2)
	,frs_dep_dt                               --首次存入日期|C8
	,act_ctg_cd_1                             --账户分类代码1|C32
	,ac_vld_prd_dt                            --账户有效日期|C8
from edw.dws_bus_dep_act_inf_dd               --存款账户信息汇总
where dt='20240210'
AND CUR_ACT_BAL>0
AND lbl_prod_typ_cd='1' --存款产品类型代码 0:活期 1:定期
AND MTU_DT>='20231001'
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id,cfm_amt) custs
from SJXQ_SJ2024020556_EXP_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id,trx_amt) custs
from SJXQ_SJ2024020556_EXP_02
01	11715	11178
02	12498	11156
总记录数 3113，四项总金额<理财购买金额448条，行外转入小于理财购买金额796条，包含前面的 448条
1. 可能14日前余额就>理财购买金额
2. 行内异名转账
*/
***SJ2024020556_台州分行挂钩型理财0221.sql
/*
挂钩理财购买日期：20231101-20240204
数据日期：20240210
遇到的问题：
1. 同一客户当天多笔交易 cst_id='1032234522' and trx_dt='20231226'
2. 存款账户余额发生明细 需要区分 动账、非动账
3. 同一笔理财分4个管户，需合并
4. 一个用户一天会购买多笔理财 需分开统计 1004047279
*/
--主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_01 AS
SElECT max(cast(seq as int)) seq
    ,t1.srl_nb             				--流水号
    ,substr(t1.srl_nb,1,14) sub_srl_nb  --流水号
    ,sum(t1.cfm_amt)                            cfm_amt           --管户认购金额
from qbi_file_20240207_10_10_51 	t1
left join edw.dws_hr_empe_inf_dd   	t2        --员工信息汇总
on  t1.mgr_id = t2.empe_id
and t2.dt = '@@{yyyyMMdd}'
GROUP by t1.srl_nb,substr(t1.srl_nb,1,14)
;
-- 找到购买挂钩理财对应的 存款账号、明细序号
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_02 AS
SElECT *,row_number() over(partition by cst_id,sub_srl_nb order by diff asc)rn
from(
    SElECT cast(t1.seq as int) seq
        ,t1.cst_id             --客户号
        ,t1.sub_srl_nb         --购买时间
        ,t2.cst_act_id
        ,t2.dep_act_id
        ,t3.dtl_seq_nbr
        ,t3.trx_dt              gg_trx_dt
        ,substr(t3.trx_tm,1,6)  trx_tm
        ,t3.trx_amt
        ,cast(concat(t3.trx_dt,substr(t3.trx_tm,1,6)) as int) - cast(t1.sub_srl_nb as int) diff
    from SJXQ_SJ2024020556_CST2_01              t1
    inner JOIN EDW.DIM_BUS_DEP_ACT_INF_DD       T2  --客户都在
    ON T1.CST_ID=T2.CST_ID
    AND T2.DT='@@{yyyyMMdd}'
    inner JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3  --交易表数据不全
    ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
    -- AND T2.CST_ACT_ID=T3.CST_ACT_ID
    AND t1.sub_srl_nb <= concat(t3.trx_dt,substr(t3.trx_tm,1,6)) --有的会相差1-2s
    and t1.gg_trx_dt=t3.trx_dt
    and t1.cfm_amt=t3.trx_amt
    AND T3.DT<='@@{yyyyMMdd}'
    and t3.trx_dt between '20231101' and '20240204' --挂钩理财购买日期
    and t3.txt_code = 'LC0005'      --财富产品购买冻结
    and t3.bal_fld_nm = 'DPCNTLAM'  --非动账交易
)t1
;
/*
--指定客户号 交易明细
SELECT t2.cst_id,t3.*
from EDW.DIM_BUS_DEP_ACT_INF_DD       T2
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3   --交易表数据不全
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
-- AND T2.CST_ACT_ID=T3.CST_ACT_ID
AND T3.DT<='@@{yyyyMMdd}'
AND T3.TRX_DT>='20231001'
where T2.DT='@@{yyyyMMdd}'
and t2.cst_id =''
;
--指定存款账号
SELECT t3.*
from EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3   --交易表数据不全
where T3.DT<='@@{yyyyMMdd}'
AND T3.TRX_DT>='20231001'
and t3.DEP_ACT_ID = ''
order by dtl_seq_nbr
;
*/
-- 客户前14日所有交易(含当日)
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_03 AS
SELECT T1.CST_ID,T1.gg_trx_dt
    ,t3.dep_act_id
    ,t3.dtl_seq_nbr
    ,t3.trx_dt,t3.trx_tm,t3.crd_and_dbt_ind,t3.trx_amt,t3.act_bal
    ,t3.txt_code
    ,t4.cd_val_dscr txt_nm
    ,t3.smr_dscr                                 --摘要描述|C512
	,t3.cnt_pty_act_nm                           --对方户名|c200
	,t3.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t3.cnt_pty_fin_instt_typ_cd                 --对方金融机构类型代码|C2
    ,t3.cmt
	,t3.act_nm                                   --账户名称|C200
	,t3.bal_fld_nm                               --余额字段名称|C32
                            , 'DP0228', 'YL0040', 'LCPS01', 'YL0021', 'DE0001', 'CG0019', 'DC0037', 'GJ0001', 'TY0049', 'CG0018', 'DP2105', 'FX0632'
                            , 'TY1921', 'YL0033', 'DC0033', 'FX0633', 'SJZZ01', 'TY1917')
                then '行外转入'
                    , 'DP2020', 'FD0011', 'DP0204', 'TY0011', 'LN0002', 'BA0004', 'LC0006', 'YL0015', 'XE0003', 'FD0013', 'DP0622', 'SGZ001', 'XE0026', 'DP0700'
                    , 'DP2126', 'FD0003', 'ST0001', 'AT0003', 'DP0232', 'DP2019', 'DP0210', 'DPW040', 'DPW289', 'YL0001')
                then '行内资金'
            when t3.txt_code = 'LC0003' then '封闭式理财到期'
                    , 'TA0632', 'TY0066', 'TY0067', 'TY0068', 'TY0069', 'TY0089', 'TY0141', 'ZHB002')
                then '开放式理财赎回'
            else '' end trx_typ
                , 'DPW031', 'DPW040', 'DPW085', 'DPWT34', 'FX0632', 'FX0633', 'GJ0001', 'IB0047', 'LCPS01', 'SGZ001', 'SJZZ01', 'TY0013', 'TY0049', 'TY1917', 'TY1921'
                , 'TYMD03', 'TYN001', 'XE0001', 'YL0021', 'YL0033', 'YL0040', 'YL0042')
                , 'DP1000', 'DP2019', 'DP2020', 'DP2022', 'FD0003', 'FD0004', 'FD0011', 'FD0013', 'IB9999', 'LC0006', 'LN0002', 'ST0001', 'THS009', 'TY0011', 'TY5020'
                , 'XE0003', 'XE0026', 'XETH01', 'YL0015')
                then '行内资金'
          when t3.crd_and_dbt_ind = 'D' then '转出'
          when t3.bal_fld_nm = 'DPLDGBAL' then '非动账交易' else '' end trx_type
    ,case when T3.CRD_AND_DBT_IND='D' and (T3.cnt_pty_fin_instt_typ_cd='13'  or T3.cnt_pty_fin_instt_nm like '%泰隆%') then '行内账号互转'
          when T3.CRD_AND_DBT_IND='C' and (T3.cnt_pty_fin_instt_typ_cd='13'  or T3.cnt_pty_fin_instt_nm like '%泰隆%') and t3.act_nm = t3.cnt_pty_act_nm  then '行内同名转入'
          when T3.CRD_AND_DBT_IND='C' and (T3.cnt_pty_fin_instt_typ_cd='13'  or T3.cnt_pty_fin_instt_nm like '%泰隆%') and t3.act_nm <> t3.cnt_pty_act_nm then '行内异名转入'
          when T3.CRD_AND_DBT_IND='D' and (T3.cnt_pty_fin_instt_typ_cd<>'13' or T3.cnt_pty_fin_instt_nm not like '%泰隆%') and t3.act_nm = t3.cnt_pty_act_nm  then '行外同名转出'
          when T3.CRD_AND_DBT_IND='D' and (T3.cnt_pty_fin_instt_typ_cd<>'13' or T3.cnt_pty_fin_instt_nm not like '%泰隆%') and t3.act_nm <> t3.cnt_pty_act_nm then '行外异名转出'
          when T3.CRD_AND_DBT_IND='C' and (T3.cnt_pty_fin_instt_typ_cd<>'13' or T3.cnt_pty_fin_instt_nm not like '%泰隆%') and t3.act_nm = t3.cnt_pty_act_nm  then '行外同名转入'
          when T3.CRD_AND_DBT_IND='C' and (T3.cnt_pty_fin_instt_typ_cd<>'13' or T3.cnt_pty_fin_instt_nm not like '%泰隆%') and t3.act_nm <> t3.cnt_pty_act_nm then '行外异名转入'
        else '' end trx_typ_self --部分对手信息数据缺失，仅供参考用于确定 交易摘要
FROM (
    SElECT distinct cst_id,gg_trx_dt
    from SJXQ_SJ2024020556_CST2_02
    where rn=1
)T1 inner JOIN EDW.DIM_BUS_DEP_ACT_INF_DD   T2  --客户都在
ON T1.CST_ID=T2.CST_ID
AND T2.DT='@@{yyyyMMdd}'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3   --交易表数据不全
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
-- AND T2.CST_ACT_ID=T3.CST_ACT_ID  --一个存款账号会对应不同客户账号
AND T3.DT<='@@{yyyyMMdd}'
AND t3.trx_dt<=t1.gg_trx_dt --获取当天所有交易明细
AND T3.TRX_DT>=TO_CHAR(DATEADD(TO_DATE(t1.gg_trx_dt, 'yyyyMMdd'),-14,'dd'),'yyyyMMdd')
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           T4
ON T3.TXT_CODE=T4.CD_VAL
AND T4.DT='@@{yyyyMMdd}'
;
-- 对客户转入交易打标签 并更新 临时表3 增加字段 trx_type
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_04 AS
SELECT txt_code,txt_nm,smr_dscr,trx_typ_self,trx_typ
    ,count(1) cnt,sum(trx_amt) trx_amt
FROM SJXQ_SJ2024020556_CST2_03
WHERE bal_fld_nm = 'DPLDGBAL'   --动账
and CRD_AND_DBT_IND='C'         --转入
GROUP BY txt_code,txt_nm,smr_dscr,trx_typ_self,trx_typ
;
/*
判断购买前一笔`动账` 账户余额是否 >= 购买金额: 3050 笔均是
1. 交易序号存在断档 不能通过+1 关联
2. 14日内无任何交易 应认定为 行内资金
3. 一条记录不满足，因为 存款账号 6320601098000072772 第 1569,1570 客户账号与其他不同
SElECT t1.*
from SJXQ_SJ2024020556_CST2_02  t1
left join SJXQ_SJ2024020556_CST2_05 t2
on t1.dep_act_id=t2.dep_act_id
and t1.dtl_seq_nbr=t2.dtl_seq_nbr
where t1.rn=1
and t2.dep_act_id is null
;
SELECT *
from SJXQ_SJ2024020556_CST2_05
where is_enough<>1
;
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_05 AS
select *
    ,case when act_bal>=trx_amt then 1 else 0 end is_enough
from(
    select t1.cst_id           --客户号
        ,t1.sub_srl_nb         --购买时间
        ,t1.dep_act_id
        ,t1.dtl_seq_nbr
        ,t1.gg_trx_dt
        ,t1.trx_tm
        ,t1.trx_amt
        ,t2.act_bal
        ,t2.dtl_seq_nbr lst_dtl_seq_nbr
        ,row_number() over(partition by t1.dep_act_id,t1.dtl_seq_nbr order by t2.dtl_seq_nbr desc) rn
    from SJXQ_SJ2024020556_CST2_02          t1
    inner join (
        SElECT distinct dep_act_id,dtl_seq_nbr,act_bal
        from SJXQ_SJ2024020556_CST2_03      t2
        WHERE bal_fld_nm = 'DPLDGBAL'   --动账
        -- and CRD_AND_DBT_IND='C'      --不需要限制
    )t2 on  t1.dep_act_id=t2.dep_act_id
    and t1.dtl_seq_nbr>t2.dtl_seq_nbr
    where t1.rn=1
)t1 where t1.rn=1
;
/*购买挂钩理财前 账户余额 >= 购买金额
    1. 近期转入 >= 购买金额 则按 转入认定 资金来源
    2. 近期转入 < 购买金额 不足部分认定为 行内资金
    3. 存在账户余额大于购买金额，近几天转入金额也大于购买金额？当前优先考虑转入金额
*/
-- 找到 近期转入 >= 购买金额 的交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_06;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_06 AS
SElECT t1.cst_id           --客户号
    ,t1.sub_srl_nb         --购买时间
    ,t1.gg_trx_dt
    ,t1.dep_act_id
    ,t1.dtl_seq_nbr
    ,t1.trx_amt     gg_trx_amt
    ,t2.dtl_seq_nbr dtl_seq_nbr_14
    ,t2.trx_dt,t2.trx_tm,t2.trx_amt,t2.act_bal
    ,t2.txt_code,t2.txt_nm,t2.trx_type
    ,sum(t2.trx_amt) over(partition by t1.dep_act_id,t1.dtl_seq_nbr order by t2.dtl_seq_nbr desc) as cum_amt
from SJXQ_SJ2024020556_CST2_05          t1
inner join SJXQ_SJ2024020556_CST2_03    t2 --cst_id,trx_dt
on  t1.cst_id = t2.cst_id
and t1.gg_trx_dt = t2.gg_trx_dt
and t1.dep_act_id=t2.dep_act_id
and t1.dtl_seq_nbr>t2.dtl_seq_nbr
and t2.bal_fld_nm = 'DPLDGBAL'   --动账
and t2.CRD_AND_DBT_IND='C'
;
-- 1. 近期转入 >= 购买金额 则按 转入认定 资金来源
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_07;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_07 AS
SElECT t1.*,t2.dtl_seq_nbr_14 fst_dtl_seq_nbr
from SJXQ_SJ2024020556_CST2_06 t1
inner join(
    -- 首次 >= 购买金额 的交易 序号
    select cst_id,sub_srl_nb,dep_act_id,dtl_seq_nbr,dtl_seq_nbr_14
        ,row_number() over(partition by cst_id,sub_srl_nb,dep_act_id,dtl_seq_nbr order by cum_amt)rn
    from SJXQ_SJ2024020556_CST2_06
    where cum_amt>=gg_trx_amt   --近期转入 >= 购买金额
)t2 on t1.cst_id=t2.cst_id
and t1.sub_srl_nb=t2.sub_srl_nb
and t1.dep_act_id=t2.dep_act_id
and t1.dtl_seq_nbr=t2.dtl_seq_nbr
and t1.dtl_seq_nbr_14>=t2.dtl_seq_nbr_14
and t2.rn=1
;
-- 2. 近期转入 < 购买金额 不足部分认定为 行内资金
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_08;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_08 AS
SELECT t1.cst_id,t1.sub_srl_nb,t1.gg_trx_amt
    ,sum(t1.trx_amt)           tot_amt_in
    ,sum(case when trx_type='封闭式理财到期' then t1.trx_amt else 0 end) cls_fnc_amt
    ,sum(case when trx_type='开放式理财赎回' then t1.trx_amt else 0 end) opn_fnc_amt
    ,sum(case when trx_type='定期存款到期'   then t1.trx_amt else 0 end) fix_dep_amt
    ,sum(case when trx_type='行内资金' then t1.trx_amt else 0 end) + t1.gg_trx_amt-sum(t1.trx_amt) bank_in_amt
    ,sum(case when trx_type='行外转入' then t1.trx_amt else 0 end)      bank_out_amt
from SJXQ_SJ2024020556_CST2_06 t1
inner join(
    select cst_id,sub_srl_nb,sum(trx_amt) trx_amt
    from SJXQ_SJ2024020556_CST2_06
    GROUP by Cst_id,sub_srl_nb
)t2 on t1.cst_id=t2.cst_id and t1.sub_srl_nb=t2.sub_srl_nb
WHERE t1.gg_trx_amt > t2.trx_amt
GROUP BY t1.cst_id,t1.sub_srl_nb,t1.gg_trx_amt
;
--计算资金来源比例
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_09;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_09 AS
SELECT cst_id,sub_srl_nb
    ,sum(trx_amt)           tot_amt_in
    ,round(sum(case when trx_type='封闭式理财到期' then trx_amt else 0 end)/sum(trx_amt),3) cls_fnc_rat
    ,round(sum(case when trx_type='开放式理财赎回' then trx_amt else 0 end)/sum(trx_amt),3) opn_fnc_rat
    ,round(sum(case when trx_type='定期存款到期'   then trx_amt else 0 end)/sum(trx_amt),3) fix_dep_rat
    ,round(sum(case when trx_type='行内资金'      then trx_amt else 0 end)/sum(trx_amt),3) bank_in_rat
    ,round(sum(case when trx_type='行外转入'      then trx_amt else 0 end)/sum(trx_amt),3) bank_out_rat
from SJXQ_SJ2024020556_CST2_07
GROUP BY cst_id,sub_srl_nb
UNION all
SElECT cst_id,sub_srl_nb
    ,tot_amt_in
    ,round(cls_fnc_amt/gg_trx_amt,3)    cls_fnc_rat
    ,round(opn_fnc_amt/gg_trx_amt,3)    opn_fnc_rat
    ,round(fix_dep_amt/gg_trx_amt,3)    fix_dep_rat
    ,round(bank_in_amt/gg_trx_amt,3)    bank_in_rat
    ,round(bank_out_amt/gg_trx_amt,3)   bank_out_rat
from SJXQ_SJ2024020556_CST2_08
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024020556_CST2_10;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020556_CST2_10 AS
SElECT t1.seq               序号
    ,t1.brc_org_nm			账户考核机构分行名称
    ,t1.sbr_org_id          账户考核机构支行编号
    ,t1.sbr_org_nm          账户考核机构支行名称
    ,t1.tem_org_nm          账户考核机构团队名称
    ,t1.pd_cd               产品代码
    ,t1.srl_nb              流水号
    ,t1.cst_id              客户号
    ,t1.mgr_id              管户人工号
	,t1.empe_nm             管户人姓名
    ,t1.cfm_amt             管户认购金额
    ,t1.gg_trx_dt           购买日期
    ,coalesce(t2.tot_amt_in,0)  累计转入金额
    ,t2.bank_out_rat            行外转入占比
    ,case when t2.cst_id is null then 1 else t2.bank_in_rat end 行内资金占比
    ,t2.fix_dep_rat             定期存款到期占比
    ,t2.opn_fnc_rat             开放式理财赎回占比
    ,t2.cls_fnc_rat             封闭式理财到期占比
from SJXQ_SJ2024020556_CST2_01      t1
left join SJXQ_SJ2024020556_CST2_09 t2
on t1.cst_id=t2.cst_id
and t1.sub_srl_nb=t2.sub_srl_nb
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_02 where rn=1
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id,gg_trx_dt,dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ2024020556_CST2_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct txt_code,smr_dscr) custs
from SJXQ_SJ2024020556_CST2_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_08
UNION all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,sub_srl_nb) custs
from SJXQ_SJ2024020556_CST2_09
UNION all
SElECT '10' seq, count(1) cnt, count(distinct 客户号,流水号) custs
from SJXQ_SJ2024020556_CST2_10
;
/*
01	3092	3092
02	3092	3092
03	39630	39630
04	122	93
05	3052	3052
06	12462	3025
07	5272	2711
08	314	314
09	3025	3025
10	3092	3092
*/
***SJ2024020641_衢州分行签约理财客户1.sql
-- 衢州分行签约理财客户
--20240131 已签约理财
--客户号 客户姓名 柜台签约理财时间 管户人 管户机构信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024020641_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020641_CST_01 AS
select T1.cst_id                                 --客户号
	,T1.cst_chn_nm                               --客户名称
	,T1.prm_mgr_id                               --主管户经理
	,T1.prm_mgr_nm                               --主管户经理名称
	,T1.prm_org_id                               --主管户机构号
	,T1.prm_org_nm                               --主管户机构名称
	,T1.wlth_mng_mnl_id                          --财富管户人工号
    ,t3.empe_nm             wlth_mng_mnl_nm
    ,T1.wlth_mng_mnl_org                         --财富管户人所在机构
	,T1.wlth_mng_org_id                          --财富管户机构号
    ,t2.BRC_ORG_NM
    ,t2.SBR_ORG_NM
    ,t2.org_nm
	,T1.chm_ctr_cst                              --是否理财签约
	,T1.chm_ctr_chnl                             --理财签约渠道
	,T1.ctr_dt                                   --理财签约日期
from app_rpt.adm_subl_cst_wlth_bus_inf_dd   T1    --正式客户财富业务信息表
INNER join edw.dim_hr_org_mng_org_tree_dd   t2    --考核机构树
on  t1.wlth_mng_org_id = t2.org_id
and t2.dt = '20240131'
AND T2.BRC_ORG_NM='衢州分行'
left join edw.dws_hr_empe_inf_dd            t3    --员工信息汇总
on  t1.wlth_mng_mnl_id=t3.empe_id
and t3.dt='20240131'
where T1.dt='20240131'
and T1.chm_ctr_cst='1'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024020641_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024020641_CST_02 AS
SElECT cst_id 			客户号
    ,cst_chn_nm         客户姓名
    ,ctr_dt             理财签约日期
    ,chm_ctr_chnl       理财签约渠道
    ,wlth_mng_mnl_id    财富管户人ID
    ,wlth_mng_mnl_nm    财富管户人
    ,BRC_ORG_NM         财富管户分行
    ,SBR_ORG_NM         财富管户支行
    ,org_nm             财富管户机构
from SJXQ_SJ2024020641_CST_01
;
select *
from SJXQ_SJ2024020641_CST_02
***SJ20240219101_理财基金购买适当性.sql
-- 2024年1月新增的定期理财认购/申购，非货基金认购/申购交易，交易申请确认状态为成功
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_01 AS
SELECT '定期理财'   bus_type  --业务类型
    -- ,decode(trx_cd,'100200','理财产品购买','100201','理财产品申购') --交易代码
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,t1.srl_nbr --流水号
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    -- , 销售人员姓名
    -- , brc_org_nm
    -- , sbr_org_nm
    -- ,bnk_act_id 银行账号
    ,t1.tatrx_act_nbr
    ,t1.tacd    --ta代码
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
    ,t1.cst_id          --cst_ID
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt between '20240101' and '20240131'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t1.trx_cd IN ( '100200' , '100201' )
;
-- 客户上一次理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_02 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,a.rsk_lvl_cd,a.late_ases_dt
        ,row_number() over(partition by a.cst_id order by late_ases_dt desc) rn
    from edw.dwd_bus_chm_cst_rsk_ases_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ20240219101_CST_01)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,rsk_lvl_cd,late_ases_dt
) a where rn=2
;
-- 客户交易时理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_03 AS
select T1.srl_nbr,T1.trx_dt
    ,T2.rsk_lvl_cd         trx_rsk_lvl      --客户交易日风险等级
    ,T2.late_ases_dt       trx_rsk_ases_dt  --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_01 T1
inner join edw.dwd_bus_chm_cst_rsk_ases_dd T2
on T1.cst_ID=T2.cst_id and T1.trx_dt=T2.dt
where T2.dt between '20240101' and '20240131'
;
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_04 AS
SELECT '非货基金' BUS_TYPE
    ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    -- ,TRX_ACT_ID     --银行账号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.CST_ID          --CST_ID
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='@@{yyyyMMdd}'
    and T1.CHANNEL_DATE between '20240101' and '20240131'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20240101' and '20240131'
    and T1.CHANNEL_DATE between '20240101' and '20240131'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_05 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,cst_rsk_grd_cd rsk_lvl_cd,ases_dt late_ases_dt,
        row_number() over(partition by a.cst_id order by ases_dt desc) rn
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ20240219101_CST_04)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,cst_rsk_grd_cd,ases_dt
) a where rn=2
;
-- 客户交易时基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_06 AS
select a.srl_nbr,a.trx_dt
    ,b.cst_rsk_grd_cd       trx_rsk_lvl     --客户交易日风险等级
    ,b.ases_dt              trx_rsk_ases_dt --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_04           a
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    b
on a.cst_ID=b.cst_id and a.trx_dt=b.dt
where b.dt between '20240101' and '20240131'
;
--定期理财+基金
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_07 AS
select T1.*
    ,T4.rsk_lvl_cd,T4.late_ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_01           T1		--理财交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ20240219101_CST_02      T2      --上次理财风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ20240219101_CST_03      T3      --交易时理财风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dwd_bus_chm_cst_rsk_ases_dd           T4 		--理财风评表
on T1.CST_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
union all
select T1.*
    ,T4.cst_rsk_grd_cd,T4.ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_04           T1      --基金交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ20240219101_CST_05      T2      --上次基金风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ20240219101_CST_06      T3      --交易时基金风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    T4      --基金风评表
on t1.cst_ID=t4.cst_ID and t4.dt='@@{yyyyMMdd}'
;
--关联其他字段（主表）
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_08 AS
SElECT T1.*
    ,T2.ta_name --发行机构
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    ,T7.credit_rsk_grd
    ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    ,T9.aum_avg_360d
    ,T10.aum_bal TRX_aum_bal
    ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ20240219101_CST_07   T1
left join edw.finc_tbtainfo                 T2 on t1.tacd=T2.ta_code  and T2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_ID=T3.cst_id and T3.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='@@{yyyyMMdd}'
left join (
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='@@{yyyyMMdd}'
) T7 on T1.CST_ID=T7.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.CST_ID=T8.cst_id and T8.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.CST_ID=T9.cst_id and T9.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
on T1.CST_ID=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20240101' and '20240131'
left join (
    SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
    inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '@@{yyyyMMdd}'
    WHERE a.dt between '20240101' and '20240131' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
    group by a.cst_id, a.dt
) t11 on T1.cst_ID=t11.cst_id and T1.trx_dt=t11.dt
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_09 AS
select distinct a.cst_ID,trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,b.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_08 a
left join edw.dws_cst_bas_inf_dd b
on a.cst_ID=b.cst_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd c
on b.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='@@{yyyyMMdd}'
and NVL(c.sam_rsk_ctrl_id,'')<>''
;
-- 前后15天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_10 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,rel_cust_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                         --贷款用途代码
    ,B.USG_CMT                             --用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt --贷款利率优惠备注
    ,case
        when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_09   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.CRC_IND <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '@@{yyyyMMdd}'
left outer join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '@@{yyyyMMdd}'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '@@{yyyyMMdd}'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_11 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_11 AS
select cst_ID,trx_dt
    ,a.rel_cst_id
    ,rel_cust_nm
    ,BUSI_CTR_ID                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,stdinr                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,INTR_RAT                            --执行利率
    ,REF_MON_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,a.REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,pre_ases_res
    ,HPN_TYP
    ,USG_CMT
    ,intr_rat_adj_cmt
    ,is_wfdk
    ,is_zc_loan
    ,lst_BUSI_CTR_ID
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.BUSI_CTR_ID            	lst_BUSI_CTR_ID
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.INTR_RAT                 lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ20240219101_CST_10
        where DIFF_TM<=15
    ) a
    left join lab_bigdata_dev.SJXQ_SJ20240219101_CST_10 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.pd_cd=b.pd_cd and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_12 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ20240219101_CST_12 AS
select a.bus_type              业务类型
    ,a.trx_type                交易类型
    ,a.srl_nbr                 交易流水号
    ,a.trx_sts                 交易状态
    ,concat(a.trx_dt,' ',a.trx_tm) 申请日期
    ,a.cfm_dt                  确认日期
    ,a.trx_chnl                交易渠道
    ,a.trx_amt                 交易金额
    ,a.cfm_amt                 确认金额
    ,a.trx_lot                 交易份额
    ,a.cfm_lot                 确认份额
    ,a.sale_empe_id            销售人员工号
    ,a.sale_empe_nm            销售人员姓名
    ,a.brc_org_nm              所属分行
    ,a.sbr_org_nm              所属支行
    ,a.tatrx_act_nbr           交易账号
    ,a.pd_cd                   产品代码
    ,a.pd_nm                   产品名称
    ,a.ta_name                 发行机构
    ,a.prod_type               产品类型
    ,a.pd_rsk_grd              产品风险等级
    ,a.pfm_comp_bas            业绩比较基准
    ,a.pd_found_dt             产品扣款日
    ,a.pd_val_dt               产品起息日
    ,a.pd_end_dt               产品到期日
    ,a.CST_ID                  客户号
    ,a.cst_nm                  客户名称
    ,a.age                     客户年龄
    ,a.gender                  客户性别
    ,''                        客户手机号码
    ,a.rsk_lvl_cd                                           	客户当前风险测评结果
    ,decode(a.late_ases_dt,'18991231','',a.late_ases_dt)    	客户当前结果测评时间
    ,a.lst_rsk_lvl                                          	客户上一次风险测评结果
    ,decode(a.lst_rsk_ases_dt,'18991231','',a.lst_rsk_ases_dt)  客户上一次风险测评时间
    ,a.trx_rsk_lvl                                              客户交易日风险等级
    ,decode(a.trx_rsk_ases_dt,'18991231','',a.trx_rsk_ases_dt)  客户交易日风险测评时间
    ,a.is_farm								是否农户
    ,a.efe_loan_cst_ind                     是否信贷有效户
    ,a.efe_dep_cst_ind                      是否存款有效户
    ,a.is_empe                              是否行内员工
    ,a.aum_avg_360d                         客户近一年AUM
    ,a.trx_ncr_fnd_bal                      客户交易时非货基金保有量
    ,a.TRX_aum_bal                          客户交易时AUM
    ,if(b.cst_ID is not null,'是','') 		交易日前后15天内同一风险控制号下是否存在贷款
    ,b.rel_cust_nm                  		贷款客户名称
    ,c.loan_apl_credit_rsk_grd      		当前贷款申请时客户信用风险等级
    ,a.credit_rsk_grd               		当前客户信用风险等级
    ,b.BUSI_CTR_ID                   		当前笔贷款合同流水号
    ,b.reg_dt                       		当前笔贷款申请日期
    ,b.DTRB_DT                      		当前笔贷款发放日期
    ,b.CTR_AMT                      		当前笔贷款金额
    ,ref_year_intr_rat              		当前笔贷款参考年利率
    ,INTR_RAT                       		当前笔贷款执行年利率
    ,aprv_exe_mon_intr_rat          		当前笔贷款执行月利率
    ,b.pre_ases_res                 		当前笔贷款预审批结果
    ,b.FIVE_CTG                     		当前笔贷款五级分类
    ,b.HPN_TYP                      		贷款类型
    ,b.is_zc_loan                   		是否为政策性贷款
    ,b.is_wfdk                      		是否为接力贷
    ,b.intr_rat_adj_cmt             		贷款利率优惠备注
    ,b.USG_CMT                      		贷款用途备注
    ,b.lst_BUSI_CTR_ID              		上一笔贷款合同流水号
    ,b.lst_CTR_AMT                  		上一笔贷款合同金额
    ,b.lst_INTR_RAT                 		上一笔贷款执行年利率
    ,b.lst_aprv_exe_mon_intr_rat    		上一笔贷款执行月利率
    ,b.lst_DTRB_DT                   		上一笔贷款发放日期
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_08       a
left join lab_bigdata_dev.SJXQ_SJ20240219101_CST_11  b
on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
left join (
    select distinct dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') loan_apl_credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt<='@@{yyyyMMdd}'
) c on b.rel_cst_id=c.cst_id and b.reg_dt=c.dt
;
SElECT '01' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_01
union all
SElECT '04' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_04
union all
SElECT '07' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_07
union all
SElECT '08' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_08
;
SElECT '02' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_02
union all
SElECT '03' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_03
union all
SElECT '05' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_05
union all
SElECT '06' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ20240219101_CST_06
;
/*
01	5600	5311	5600
04	469	406	469
07	6069	5717	6069
08	6069	5717	6069
02	3213	3213
03	5600	5600
05	117	117
06	469	469
*/***SJ20240219126_保险续期追缴.sql
/*
取该笔保单对应的账号当前考核和管户信息，账号取综合理财平台-保险业务流水查询表对应的保单号和账号匹配信息。
账户考核分行名称	账户考核机构名称	账户考核支行名称	当前管户客户经理工号	当前管户客户经理姓名
取综合理财平台-保险业务流水查询表对应的保单号和推荐人编号、名称和机构信息
销售人员工号	销售人员姓名	销售人员所属机构名称
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20240219126_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240219126_CST_01 AS
SElECT insu_plcy_id
from qbi_file_20240226_09_16_43
;
--保险交易明细 保险明细
DROP   TABLE IF     EXISTS SJXQ_SJ20240219126_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240219126_CST_02 AS
select t1.act_dt                                --会计日期
	,replace(t1.trx_dt,'-','') trx_dt           --交易日期
    ,t1.insu_plcy_id	                        --保单号
	,t1.cst_id                                  --客户号
	,t1.mng_cnv_insu_fee                        --管护折算保费    规模
	,t1.mng_cnv_cmsn_fee                        --管护折算手续费  中收
	,t1.mng_cnv_nbr_num                         --管护折算件数    件数
	,t1.mng_mgr_id                              --管护客户经理工号
	,t1.mng_mgr_nm                              --管护客户经理姓名
	,t1.mng_rto                                 --管护比例
	,t1.mng_org_id                              --管护机构号
    ,t2.brc_org_nm
    ,t2.sbr_org_nm
	,t1.mng_org_nm                              --管护机构名称
	,t1.sal_ppl_id                              --销售人员工号
	,t1.sal_ppl_nm                              --销售人员姓名
	,t1.sal_ppl_pst_id                          --销售人员岗位编号
	,t1.sal_ppl_pst_nm                          --销售人员岗位名称
	,t1.sal_ppl_afl_org_id                      --销售人员所属机构号
	,t1.sal_ppl_afl_org_nm                      --销售人员所属机构名称
	,t1.trx_tm                                  --交易时间
	,t1.sal_org_id_fh                           --销售人员所属机构所属分行
from app_rpt.fct_insu_agn_bus_acs_dtl_tbl   t1  --保险代销业务考核明细表 insu_plcy_id(insu_id),mng_mgr_id,mng_org_id 唯一
left join edw.dim_hr_org_mng_org_tree_dd    t2
ON      t1.mng_org_id = t2.org_id
AND     t2.dt = '@@{yyyyMMdd}'
WHERE t1.DT='@@{yyyyMMdd}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240219126_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240219126_CST_03 AS
SElECT t1.insu_plcy_id                          		保单号
from SJXQ_SJ20240219126_CST_01      T1
left join SJXQ_SJ20240219126_CST_02 t2
on t1.insu_plcy_id =t2. insu_plcy_id
GROUP by t1.insu_plcy_id
;
/*
SElECT '01' seq, count(1) cnt, count(distinct insu_plcy_id) custs
from SJXQ_SJ20240219126_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct insu_plcy_id) custs
from SJXQ_SJ20240219126_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct 保单号) custs
from SJXQ_SJ20240219126_CST_03
;
01	1554	1554
02	57514	57405
03	1554	1554
*/***SJ2024022001_申请费用补贴清单.sql
-- 2022和2023 10-12月共3月 分行机构号为 616199999 的，客户合同金额、贷款余额
-- 字段：客户号，客户名称，合同金额、贷款余额、是否农户、担保方式，配偶客户号，配偶名称
DROP   TABLE IF     EXISTS SJXQ_SJ2024022001_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022001_CST_01 AS
SElECT t1.cst_id
    ,t1.cst_chn_nm	            --客户中文名称
    ,decode(T1.FM_IND,'0','否','1','是','未知') FM_IND
    ,t1.org_mngr_id	            --管户机构
    ,t1.org_mngr_nm	            --管户机构名称
    ,t2.rel_cst_id
    ,t3.cst_chn_nm rel_cst_nm
from adm_pub.adm_csm_cbas_idv_bas_inf_dd    t1
inner join edw.dim_hr_org_mng_org_tree_dd   t4             --考核机构树 4537 org_id 唯一
on  t1.org_mngr_id = t4.org_id
and t4.dt = '20231231'
and t4.brc_org_id='616199999' --陕西旬阳泰隆村镇银行
left join edw.dim_cst_rel_inf_dd            t2
on  t1.cst_id=t2.cst_id
and t2.rel_typ_cd='0301' --配偶
and t2.dt='20231231'
left join edw.dim_cst_bas_inf_dd            t3
on  t2.rel_cst_id=t3.cst_id
and t3.dt='20231231'
where t1.dt = '20231231'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024022001_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022001_CST_02 AS
select t1.dt,t1.cst_id                                   --客户编号|C20
	,sum(t1.ctr_amt)   ctr_amt                               --合同金额|DECIMAL(20,2)
	,sum(t1.ctr_bal)   ctr_bal                               --合同余额|DECIMAL(20,2)
from edw.dim_bus_loan_ctr_inf_dd        t1 --信贷合同信息
GROUP by t1.dt,t1.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024022001_CST_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022001_CST_03 AS
SElECT t1.cst_id                客户号
    ,t1.cst_chn_nm	            客户名称
    ,T1.FM_IND                  农户标识
    ,t1.rel_cst_id              配偶客户号
    ,t1.rel_cst_nm              配偶客户名称
    ,t2.ctr_amt                 合同金额_202210
    ,t2.ctr_bal                 合同余额_202210
    ,t3.ctr_amt                 合同金额_202211
    ,t3.ctr_bal                 合同余额_202211
    ,t4.ctr_amt                 合同金额_202212
    ,t4.ctr_bal                 合同余额_202212
    ,t5.ctr_amt                 合同金额_202310
    ,t5.ctr_bal                 合同余额_202310
    ,t6.ctr_amt                 合同金额_202311
    ,t6.ctr_bal                 合同余额_202311
    ,t7.ctr_amt                 合同金额_202312
    ,t7.ctr_bal                 合同余额_202312
from SJXQ_SJ2024022001_CST_01       t1
inner join (select distinct cst_id from SJXQ_SJ2024022001_CST_02) a on t1.cst_id=a.cst_id
left join SJXQ_SJ2024022001_CST_02  t2 on t1.cst_id=t2.cst_id and t2.dt='20221031'
left join SJXQ_SJ2024022001_CST_02  t3 on t1.cst_id=t3.cst_id and t3.dt='20221130'
left join SJXQ_SJ2024022001_CST_02  t4 on t1.cst_id=t4.cst_id and t4.dt='20221231'
left join SJXQ_SJ2024022001_CST_02  t5 on t1.cst_id=t5.cst_id and t5.dt='20231031'
left join SJXQ_SJ2024022001_CST_02  t6 on t1.cst_id=t6.cst_id and t6.dt='20231130'
left join SJXQ_SJ2024022001_CST_02  t7 on t1.cst_id=t7.cst_id and t7.dt='20231231'
;
/*
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022001_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022001_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024022001_CST_03
;
01	110954	110954
02	10342079	1803762
03	5321	5321
*/
/*
select t1.busi_ctr_id                            --业务合同编号|C32
	,t1.pd_cd                                    --产品代码|C4
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.trm_mon                                  --期限月|INTEGER
	,t1.loan_usg_cd                              --贷款用途代码|C4
	,t1.main_grnt_mth_cd                         --主要担保方式代码|C3
	,t1.bgn_dt                                   --起始日期|C10
	,t1.mtu_day                                  --到期日期|C10
    ,t3.wrnt_cst_id
    ,t3.wrnt_cst_nm
from edw.dim_bus_loan_ctr_inf_dd        t1 --信贷合同信息
left join edw.loan_guaranty_relative    t2 --业务合同、担保合同与担保物关联表
on t1.busi_ctr_id = t2.objectno
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN edw.dws_bus_grnt_prsn_inf_dd  t3 --担保人汇总信息
ON  t3.bus_ctr_id = t2.objectno     --业务合同编号
AND t3.grnt_ctr_id = t2.contractno  --担保合同编号
and t3.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
*/
***SJ2024022017_福卡发卡量.sql
-- 截止23年底 湖州分行 福卡 累计发卡量 当年发卡量
DROP   TABLE IF     EXISTS SJXQ_SJ2024022017_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022017_CST_01 AS
select b.brc_org_nm,b.SBR_ORG_ID,b.SBR_ORG_NM
    ,count(distinct case when isu_dt<='20231231' then ic_crd_card_nbr end )     截止23年底累计发卡量_不区分销户
    ,count(distinct case when isu_dt between '20230101' and '20231231'
        then ic_crd_card_nbr end )                                              截止23年底当年发卡量_不区分销户
from  edw.dim_bus_crd_ic_crd_inf_dd         as a
inner join edw.dim_hr_org_mng_org_tree_dd   as b
on a.isu_org=b.org_id
and b.dt='@@{yyyyMMdd}'
and b.brc_org_nm='湖州分行'
where a.dt='@@{yyyyMMdd}'
and a.ic_crd_prod_id in ( '1005' ,'6001' ,'9014' ,'9015' ,'9016' ,'9019' ,'9020' ,'9021' ,'9022' ,'9023' ,'9024' ,'9027' ,'9043' ,'9047' )
and a.isu_org <>''
group by b.brc_org_nm,b.SBR_ORG_ID,b.SBR_ORG_NM
;
SELECT sum(截止23年底累计发卡量_不区分销户) 截止23年底累计发卡量_不区分销户
    ,sum(截止23年底当年发卡量_不区分销户)   截止23年底当年发卡量_不区分销户
from SJXQ_SJ2024022017_CST_01
***SJ2024022176_贵金属反洗钱排查.sql
/*
购买时间 20230701-20240131
贵金属购买人地址、收货人姓名、联系方式、收货地址
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024022176_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022176_CST_01 AS
SELECT  T2.openid cst_id    --客户号
    ,t1.order_id            --订单号
    ,T1.order_status
    ,decode(t1.order_status,20,'已付款',30,'已发货',50,'已完成','') order_status_nm
    ,T1.receiver_name	    --收货人姓名,确认订单后，将买家的收货地址所有信息添加到订单中，该订单与买家收货地址没有任何关联
    ,T1.receiver_mobile	    --收货人手机号码
    ,REPLACE(substr(T1.addtime,1,10),'-','') trx_dt
    ,T1.addtime             --添加时间，这里为长时间格式
    ,T1.totalPrice + T1.integral_all * 0.01  tot_trx_amt
    ,T1.receiver_area	        --收货人详细地址，例如：凌空二街56-1号，4单元2楼1号
    ,T1.receiver_area_info	    --收货人详细地址，例如：凌空二街56-1号，4单元2楼1号
    ,t2.nickname
    ,t2.telephone
    ,t2.username,t2.user_cash_fee,t2.user_integral_fee,t2.tenant_code
    ,t2.org_code
FROM    edw.tlsc_sunyardmall_orderform T1 --订单表
LEFT JOIN    edw.tlsc_sunyardmall_user T2 --用户表
ON      T1.user_id = T2.id --用户id
AND     T2.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     REPLACE(substr(T1.addtime,1,10),'-','') between '20230701' and '20240131'
AND     T1.order_status <> '0' --剔除取消订单
and     t1.order_status <>'10' --剔除已提交待付款
and     t1.order_status <>'25' --13024 报表剔除
AND     T1.tenant_code = 'tljincheng' --租户类型为 tljincheng
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024022176_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022176_CST_02 AS
SELECT  cst_id              客户号
    ,order_id               订单号
    ,receiver_name	        收货人姓名
    ,receiver_mobile	    收货人手机号码
    ,addtime                添加时间
    ,tot_trx_amt            交易总金额
    ,receiver_area	        收货人地址
    ,receiver_area_info	    收货人详细地址
    ,username               用户名
from SJXQ_SJ2024022176_CST_01
;
--202401月 13024 贵金属交易订单号
DROP   TABLE IF     EXISTS SJXQ_SJ2024022176_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022176_CST_03 AS
SElECT order_id,cst_id,ord_dt,pay_dt,order_status
from qbi_file_20240227_16_23_01     -- 20240101-20240131
union all
SElECT order_id,cst_id,ord_dt,pay_dt,order_status
from qbi_file_20240227_16_56_58     -- 20230701-20231231
;
--20230701-20240131 13024贵金属交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024022176_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022176_CST_04 AS
SElECT t1.col_1					序号
    ,t1.col_2               	数据来源
    ,t1.col_3               	商铺名称
    ,t1.col_4               	订单号
    ,t1.col_5               	买家名称
    ,t1.col_6               	客户号
    ,t1.col_7               	真实姓名
    ,t1.col_8               	邮寄方式
    ,t1.col_9               	下单时间
    ,t1.col_10              	付款时间
    ,t1.col_11              	支付方式
    ,t1.col_12              	渠道
    ,t1.col_13              	订单状态
    ,t1.col_14              	商品名称
    ,t1.col_15              	商品规格
    ,t1.col_16              	购买数量
    ,t1.col_17              	商品分类
    ,t1.col_18              	商品退款状态
    ,t1.col_19              	商品现金单价
    ,t1.col_20              	商品应付现金总额
    ,t1.col_21              	佣金类型
    ,t1.col_22              	佣金比例_金额
    ,t1.col_23              	佣金总额
    ,t1.col_24              	推荐人工号
    ,t1.col_25              	推荐人姓名
    ,t1.col_26              	推荐人所属部门_团队id
    ,t1.col_27              	推荐人所属部门_团队
    ,t1.col_28              	支行名称
    ,t1.col_29              	分行名称
    ,t2.receiver_name	        收货人姓名
    ,t2.receiver_mobile	        收货人手机号码
    ,t2.addtime                 添加时间
    ,t2.tot_trx_amt             交易总金额
    ,t2.receiver_area	        收货人地址
    ,t2.receiver_area_info	    收货人详细地址
    ,t2.username                用户名
from qbi_file_20240229_08_46_44     t1
left join SJXQ_SJ2024022176_CST_01  t2 on t1.col_4=t2.order_id
;
SElECT *
from SJXQ_SJ2024022176_CST_04
;
SElECT '01' seq, count(1) cnt, count(distinct order_id) custs
from SJXQ_SJ2024022176_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024022176_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct order_id) custs
from SJXQ_SJ2024022176_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024022176_CST_04
;
/*
表1和表3 的`订单状态`无必然联系
01  27614	27614
02	27614	21861
03	27614	27614
SELECT t1.order_status,t3.t1.order_status,count(1) cnt
from SJXQ_SJ2024022176_CST_01 t1
left join SJXQ_SJ2024022176_CST_03 t2 on t1.order_id=t2.order_id
group by  t1.order_status,t3.t1.order_status
;
*/
***SJ2024022301_泰e贷合同清单.sql
-- 截止 20240131 丽水分行 泰e贷1.0 2.0 合同清单 剔除终止失效
DROP   TABLE IF     EXISTS SJXQ_SJ2024022301_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022301_CST_01 AS
select apl_id                               --申请编号|C4
	,apl_dt                                 --申请日期|C8
	,pd_id                                  --产品编号|C24
	,hpn_dt                                 --发生日期
	,hpn_typ_cd                             --发生类型代码|C32
	,mtu_dt                                 --到期日期|C8
	,cst_id                                 --客户编号|C20
	,main_grnt_mth_cd                       --主要担保方式代码|C3
	,apl_amt                                --申请金额|DECIMAL(20,2)
	,intr_rat                               --利率|DECIMAL(14,8)
	,aprv_mtu_dt                            --批准到期日期|C8
	,aprv_exe_mon_intr_rat                  --批准执行月利率|DECIMAL(14,8)
	,hdl_dt                                 --经办日期|C8
	,reg_dt                                 --登记日期|C8
	,pd_cd                                  --产品标识|C2048
	,busi_apl_id                            --申请相关流水号|c32
	,cst_nm                                 --客户姓名|c200
from edw.dwd_bus_loan_apl_inf_dd            --信贷业务申请信息
where dt='20240131'
;
--信贷合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024022301_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022301_CST_02 AS
select t1.busi_ctr_id                            --业务合同编号|C32
	,t1.busi_apl_id                             --业务申请编号|C32
	,t1.crd_ctr_id                              --授信合同编号|C32
	,t1.pd_cd                                   --产品代码|C4
    ,t2.pd_nm
    ,t2.prm_bus_bred_ctg	                    --主业务品种分类|C200
    ,decode(t2.prm_bus_bred_ctg,'010','贷款','090','随贷通','') prm_bus_bred_ctg_nm
    ,CASE WHEN T9.APL_STYP = '060040' THEN '泰e贷2.0' ELSE '泰e贷' END PD_TYP
	,t1.cst_id                                  --客户编号|C20
	,t1.cst_nm                                  --客户名称|C200
	,t1.apnt_start_dt                           --约定开始日期 合同起始日
	,t1.apnt_mtu_dt                             --约定到期日期 合同到期日
	,t1.ccy_cd                                  --币种代码|C3
	,t1.ctr_amt                                 --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                 --合同余额|DECIMAL(20,2)
	,t1.intr_rat                                --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                             --贷款用途代码|C4
	,t1.main_grnt_mth_cd                        --主要担保方式代码|C3
    ,decode(t1.main_grnt_mth_cd,'005','信用','010','保证','020','抵押','040','质押','') main_grnt_mth_nm
	,t1.hpn_dt                                  --发生日期|C8
	,t1.hpn_typ_cd                              --发生类型代码|C32
    ,c1.cd_val_dscr hpn_typ_nm
	,t1.hdl_dt                                  --经办日期|C8
	,t1.crc_ind                                 --循环贷款标志|C1
	,t1.end_dt                                  --终结日期|C8
	,t1.bus_cd                                  --业务标识代码|C32
	,t1.bus_lab_cd                              --营销标签代码|C2048
    ,C2.cd_val_dscr bus_lab_NM
	,t1.frz_sts_cd                              --冻结状态代码|C1
    ,c3.cd_val_dscr frz_sts_nm                  --授信状态
	,t1.ctr_typ                                  --合同类型|C10
	,t1.bus_typ                                 --业务类型|C10
	,t1.intr_rat_adj_cmt                        --利率调整备注|c250
	,t1.usg_cmt                                 --用途备注|c4
	,t1.cmt                                     --备注|c1000
	,t1.bgn_dt                                  --起始日期|C10
	,t1.mtu_day                                 --到期日期|C10
    ,t3.acs_org_id	                            --管护机构编号|C12
    ,t3.acs_mngr_id	                            --管户客户经理编号|C32
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,T5.empe_NM acs_mngr_NM
from edw.dim_bus_loan_ctr_inf_dd        T1 --信贷合同信息
left join edw.dim_bus_loan_pd_inf_dd	t2 --信贷产品信息
on  t1.pd_cd=t2.pd_cd
and t2.dt = '20240131'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同`管户`信息
on  t1.busi_ctr_id=t3.busi_ctr_id
and t3.dt = '20240131'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4537 org_id 唯一
on      t3.acs_org_id = t4.org_id
and     t4.BRC_ORG_NM='丽水分行'
and     t4.dt = '20240131'
LEFT JOIN edw.dws_hr_empe_inf_dd            T5 --员工信息汇总
ON  T3.acs_mngr_id=T5.empe_id
AND T5.DT='20240131'
left JOIN EDW.DWD_BUS_LOAN_REL_APL_INF_DD T8
ON  T1.BUSI_APL_ID= T8.APL_SRL_NBR
AND T8.REL_OBJ_TYP = 'EntryForm'
AND T8.DT = '20240131'-- 李强新增
left JOIN EDW.DWD_BUS_LOAN_ENTR_FORM_DD T9
ON T8.REL_OBJ_ID =T9.APL_SRL_NBR
and T9.DT = '20240131'
and T9.APL_STYP = '060040' --李强新增
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD    C1 --码值表(发生类型)
ON      T1.HPN_TYP_CD = C1.CD_VAL --发生类型 码值
AND     C1.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     C1.FLD_NM = 'HPN_TYP_CD'
AND     C1.DT = '20240131'
LEFT JOIN    edw.dwd_code_library_dd    C2 --码值表
ON      T1.bus_lab_cd = C2.cd_val
AND     C2.fld_nm = 'BUS_LAB_CD'
AND     C2.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     C2.DT = '20240131'
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD    C3 --码值表(发生类型)
ON      T1.frz_sts_cd = C3.CD_VAL --发生类型 码值
AND     C3.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     C3.FLD_NM = 'FRZ_STS_CD'
AND     C3.DT = '20240131'
where   t1.dt='20240131'
and     nvl(t1.busi_apl_id,'')<>''    --剔除空值和空
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024022301_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022301_CST_03 AS
select T1.dbil_id                                  --借据编号|C50
	,T1.bus_ctr_id                               --信贷合同编号|C32
	,T1.cst_id                                   --客户编号|C20
	,T1.cst_nm                                   --客户名称|C200
	,T1.pd_cd                                    --产品代码|C4
	,T1.acs_org_id                               --考核机构编号|C12
	,T1.acs_org_nm                               --考核机构名称|C200
	,T1.cst_mngr_nm                              --管护客户经理名称|C100
	,T1.dtrb_dt                                  --发放日期|C8
	,T1.apnt_mtu_day                             --约定到期日期|C8
	,T1.end_dt                                   --终结日期|C8
	,T1.exe_intr_rat                             --执行利率
	,T1.loan_act_sts                             --贷款账户状态|C1
    ,decode(T1.loan_act_sts,'0','未结清','1','已结清','2','核销','3','准销户','4','录入','5','已减免','') loan_act_sts_nm
	,T1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,T1.amt                                      --发放金额|DECIMAL(20,2)
from edw.dws_bus_loan_dbil_inf_dd   t1            --贷款借据信息汇总
inner join SJXQ_SJ2024022301_CST_02 t2
on t1.bus_ctr_id=t2.busi_ctr_id
where t1.dt='20240131'
and   t1.dtrb_dt between '20230101' and '20240131'
;
--汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024022301_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022301_CST_04 AS
SElECT T1.busi_ctr_id                            --业务合同编号|C32
	,t1.busi_apl_id                             --业务申请编号|C32
	,t1.crd_ctr_id                              --授信合同编号|C32
	,t1.pd_cd                                   --产品代码|C4
    ,t1.pd_nm
    ,t1.prm_bus_bred_ctg	                    --主业务品种分类|C200
    ,T1.prm_bus_bred_ctg_nm
    ,T1.PD_TYP
	,t1.cst_id                                  --客户编号|C20
	,t1.cst_nm                                  --客户名称|C200
	,t1.apnt_start_dt                           --约定开始日期 合同起始日
	,t1.apnt_mtu_dt                             --约定到期日期 合同到期日
	,t1.ccy_cd                                  --币种代码|C3
	,t1.ctr_amt                                 --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                 --合同余额|DECIMAL(20,2)
	,t1.intr_rat                                --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                             --贷款用途代码|C4
	,t1.main_grnt_mth_cd                        --主要担保方式代码|C3
    ,T1.main_grnt_mth_nm
	,t1.hpn_dt                                  --发生日期|C8
	,t1.hpn_typ_cd                              --发生类型代码|C32
    ,T1.hpn_typ_nm
	,t1.hdl_dt                                  --经办日期|C8
	,t1.crc_ind                                 --循环贷款标志|C1
	,t1.end_dt                                  --终结日期|C8
	,t1.bus_cd                                  --业务标识代码|C32
	,t1.bus_lab_cd                              --营销标签代码|C2048
    ,T1.bus_lab_NM
	,t1.frz_sts_cd                              --冻结状态代码|C1
    ,T1.frz_sts_nm                              --授信状态
	,t1.ctr_typ                                 --合同类型|C10
	,t1.bus_typ                                 --业务类型|C10
	,t1.intr_rat_adj_cmt                        --利率调整备注|c250
	,t1.usg_cmt                                 --用途备注|c4
	,t1.cmt                                     --备注|c1000
	,t1.bgn_dt                                  --起始日期|C10
	,t1.mtu_day                                 --到期日期|C10
    ,T1.acs_org_id	                            --管护机构编号|C12
    ,t1.acs_mngr_id	                            --管户客户经理编号|C32
    ,T1.BRC_ORG_NM,T1.SBR_ORG_NM,T1.TEM_ORG_NM,T1.ORG_NM
    ,T1.acs_mngr_NM
    ,T2.aprv_exe_mon_intr_rat
    ,CASE WHEN T3.CNT_0101_0131>0 THEN '否' ELSE '是' END is_noloan_0101_0131
    ,CASE WHEN T3.CNT_0701_0131>0 THEN '否' ELSE '是' END is_noloan_0701_0131
from SJXQ_SJ2024022301_CST_02       T1
LEFT JOIN SJXQ_SJ2024022301_CST_01  T2 ON T1.BUSI_APL_ID=T2.APL_ID
LEFT JOIN(
    SELECT bus_ctr_id,COUNT(DBIL_ID) CNT_0101_0131
        ,COUNT(CASE WHEN DTRB_DT>='20230701' THEN DBIL_ID END) CNT_0701_0131
    FROM SJXQ_SJ2024022301_CST_03
    GROUP BY bus_ctr_id
)T3 ON T1.BUSI_CTR_ID=T3.bus_ctr_id
;
--结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024022301_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022301_CST_05 AS
SElECT busi_ctr_id				合同编号
	,busi_apl_id                业务申请流水号
	,cst_id                     客户编号
	,cst_nm                     客户名称
    ,hpn_typ_nm                 发生类型
    ,prm_bus_bred_ctg_nm        业务品种
    ,PD_TYP                     产品类型
    ,pd_nm                      产品名称
    ,bus_lab_cd                 营销标签
	,ctr_amt                    合同金额
	,ctr_bal                    合同余额
	,intr_rat                   执行月利率
	,apnt_start_dt              合同起始日
	,apnt_mtu_dt                合同到期日
    ,main_grnt_mth_nm           主要担保方式
    ,frz_sts_nm                 授信状态
    ,BRC_ORG_NM                 管户分行名称
    ,SBR_ORG_NM                 管户支行名称
    ,ORG_NM                     管户机构名称
    ,acs_mngr_id                管户人工号
    ,acs_mngr_NM                管户人姓名
    ,is_noloan_0101_0131        2023年1月1日_2024年1月31日是否连续未用信
    ,is_noloan_0701_0131        2023年7月1日_2024年1月31日是否连续未用信
FROM SJXQ_SJ2024022301_CST_04
;
SElECT '01' seq, count(1) cnt, count(distinct apl_id) custs
from SJXQ_SJ2024022301_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024022301_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct bus_ctr_id, dbil_id) custs
from SJXQ_SJ2024022301_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024022301_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 合同编号) custs
from SJXQ_SJ2024022301_CST_05
;
/*
01	7051055	7051055
02	17547	17547
03	38907	38907
04	17547	17547
05	17547	17547
*/***SJ2024022306_客户还款习惯分析.sql
-- 客群合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_01 AS
select t1.busi_ctr_id               --业务合同编号
    ,t1.busi_apl_id                 --业务申请编号
    ,t1.pd_cd                       --产品代码
    ,t1.cst_id                      --客户编号
    ,t1.cst_nm                      --客户名称
    ,t1.apnt_start_dt               --约定开始日期
    ,t1.apnt_mtu_dt                 --约定到期日期
    ,t1.ctr_amt                     --合同金额
    ,t1.ctr_bal                     --合同余额
    ,t1.rpay_mth	                --还款方式
    ,t1.prcp_pyf_dt                 --本金结清日期
    ,t1.stl_nbr	            --结算帐号|C64
    ,t2.acs_org_id	        --管护机构编号
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
FROM edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同`管户`信息
on  t1.busi_ctr_id = t2.busi_ctr_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t2.acs_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.SBR_ORG_NM='临海古城小微企业专营支行' --台州分行
WHERE t1.dt='@@{yyyyMMdd}'
;
--贷款账户交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_02 AS
SElECT t1.busi_ctr_id,t1.cst_nm
    ,T2.DBIL_ID,t3.loan_act_id
    ,t3.dtl_seq_nbr,t3.cst_id
    ,t3.trx_dt
    ,t3.trx_dir                                 --交易方向 0放款 1还款
    ,t3.trx_amt,t3.bal
    ,t3.loan_bal_fld                            --贷款余额字段
    ,t3.bal_fld_cmt                             --余额字段说明
    ,t3.trx_evt                                 --交易事件|C10
    ,t3.evt_cmt                                 --事件说明|C80
    ,t3.smr                                     --摘要|C512
    ,t3.dt
    ,t3.loan_rpay_mth	--贷款归还方式|C2
FROM SJXQ_SJ2024022306_CST_01               T1
INNER JOIN EDW.DWS_BUS_LOAN_DBIL_INF_DD     T2 --贷款借据信息汇总
ON  T1.BUSI_CTR_ID = T2.BUS_CTR_ID
AND T2.DT = '@@{yyyyMMdd}'
INNER JOIN EDW.DWD_BUS_LOAN_ACT_TRX_DTL_DI  T3 --贷款账户交易明细
ON  T2.DBIL_ID=T3.LOAN_DBIL_ID
and t3.dt<='@@{yyyyMMdd}'
;
--贷款客户账户交易明细表
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_03 AS
SElECT t1.cst_id,t1.cst_nm
    ,t1.DBIL_ID        --贷款借据号
    ,t2.mingxibh       --明细编号
    ,t2.dkzhangh       --贷款账号
    ,t2.jiaoyirq       --交易日期
    ,t2.fkjineee       --放款金额
    ,t2.zhchbjin       --正常本金
    ,t2.yuqibjin       --逾期本金
    ,t2.dzhibjin       --呆滞本金
    ,t2.daizbjin       --呆账本金
    ,t2.keyongje       --可用金额
    ,t2.hkzongee       --还款总额
    ,t2.ghbenjin       --归还本金
    ,t2.ghysyjlx       --归还应收应计利息
    ,t2.ghynshqx       --归还应收欠息
    ,t2.ghyjfuxi       --归还应计复息
    ,t2.ghfxfuxi       --归还复息
    ,t2.jiaoyisj       --交易事件
    ,t2.shjshuom       --事件说明
    ,t2.jiaoyima       --交易码
    ,t2.zhaiyoms       --摘要
    ,t2.dt             --日期
from(
    SElECT distinct cst_id,cst_nm,DBIL_ID
    from SJXQ_SJ2024022306_CST_02
)t1 inner join edw.core_klnl_dkkhmx t2 --贷款客户账户交易明细表
on  t1.DBIL_ID=t2.dkjiejuh
and t2.dt<='@@{yyyyMMdd}'
and t2.dt>='@@{yyyyMMdd-2y}'   --近2年
and SUBSTR(t2.jiaoyirq,7,2)='20'    --还款日
and t2.shjshuom not like '%逾期%'
;
-- 实验室应用层资产-存款账户考核信息汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_04 AS
SElECT cst_id,dt
    ,sum(t1.dep_act_bal_rmb) dep_act_bal_rmb    --余额
from(
    select t1.cst_id,t1.dt
        ,t3.DEP_ACT_ID,t3.GL_BAL
        ,COALESCE(ROUND(t3.gl_bal * t4.AVG_PRC / t4.QUO_UNT, 2), 0) DEP_ACT_BAL_RMB
    FROM edw.DIM_BUS_DEP_ACT_INF_DD             t1 --存款账户信息 DEP_ACT_ID 唯一
    inner join (
        select distinct cst_id
        from SJXQ_SJ2024022306_CST_01
    )t2 on t1.cst_id=t2.cst_id                     --客群 缩减数据量
    left join edw.dws_bus_dep_act_acm_inf_dd    t3 --存款账户余额累计汇总 DEP_ACT_ID 唯一
    ON  t1.DEP_ACT_ID = t3.DEP_ACT_ID
    and t1.dt=t3.dt
    and t3.dt between '20220517' and	'20240520'
    INNER JOIN edw.DIM_BUS_COM_EXR_INF_DD       t4
    ON  t3.CCY_CD = t4.CCY_CD
    AND t3.DT = t4.dt
    and t4.dt between '20220517' and	'20240520'
    where t1.dt between '20220517' and	'20240520'
)t1 group by cst_id,dt
;
/*
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_04_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_04_2 AS
SElECT t1.dt,t1.cst_id
    ,sum(t1.dep_act_bal_rmb) dep_act_bal_rmb    --余额
from APP_ADO.ADM_SUBL_BUS_DEP_ACT_ACS_INF_DD t1
inner join (
    select distinct cst_id
    from SJXQ_SJ2024022306_CST_01
)t2 on t1.cst_id=t2.cst_id
where t1.dt between '20220101' and	'20240520'
group by t1.dt,t1.cst_id
;
*/
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_05 AS
SElECT t1.cst_id,t1.cst_nm,t1.trx_dt
    ,t1.repay_tot_amt,t1.repay_bj,t1.repay_lx
    ,nvl(t2.dep_act_bal_rmb,0)     bal_1d
    ,nvl(t3.dep_act_bal_rmb,0)     bal_2d
    ,nvl(t4.dep_act_bal_rmb,0)     bal_3d
from(
    SElECT cst_id,cst_nm,jiaoyirq trx_dt
        ,sum(hkzongee)  repay_tot_amt
        ,sum(ghbenjin)  repay_bj
        ,sum(ghysyjlx)  repay_lx
    from SJXQ_SJ2024022306_CST_03
    group by cst_id,cst_nm,jiaoyirq
)t1 left join SJXQ_SJ2024022306_CST_04  t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=TO_CHAR(DATEADD(TO_DATE(t2.dt,'yyyymmdd'),1,'dd'),'yyyymmdd')
left join SJXQ_SJ2024022306_CST_04      t3
on t1.cst_id=t3.cst_id
and t1.trx_dt=TO_CHAR(DATEADD(TO_DATE(t3.dt,'yyyymmdd'),2,'dd'),'yyyymmdd')
left join SJXQ_SJ2024022306_CST_04      t4
on t1.cst_id=t4.cst_id
and t1.trx_dt=TO_CHAR(DATEADD(TO_DATE(t4.dt,'yyyymmdd'),3,'dd'),'yyyymmdd')
where repay_tot_amt<>0  --剔除还款金额为0的期次
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_06 AS
SElECT cst_id           客户号
    ,cst_nm             客户姓名
    ,trx_dt             还款日期
    ,repay_tot_amt      还款总额
    ,repay_bj           还款本金
    ,repay_lx           还款利息
    ,bal_1d             还款前1日存款余额
    ,bal_2d             还款前2日存款余额
    ,bal_3d             还款前3日存款余额
    ,case when bal_1d>repay_tot_amt and bal_2d>repay_tot_amt and bal_3d>repay_tot_amt then '是' else '否' end 是否满足还款前3日存款余额大于当期应还本息
    ,case when bal_1d>repay_bj and bal_2d>repay_bj and bal_3d>repay_bj then '是' else '否' end 是否满足还款前3日存款余额大于当期应还本金
    ,case when bal_1d>repay_lx and bal_2d>repay_lx and bal_3d>repay_lx then '是' else '否' end 是否满足还款前3日存款余额大于当期应还利息
from SJXQ_SJ2024022306_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024022306_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct DBIL_ID,dtl_seq_nbr) custs
from SJXQ_SJ2024022306_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,jiaoyirq) custs
from SJXQ_SJ2024022306_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct dt,cst_id) custs
from SJXQ_SJ2024022306_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022306_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号,还款日期) custs
from SJXQ_SJ2024022306_CST_06
;
/*
01	6186	6186
02	368334	368334
03	13637	4045
04	137890	137890
05	3818	3818
06	3818	3818
-- 期供明细 实际还款值为0 该表不可用
SElECT t2.loanaccount	        --贷款账号
    ,t2.duebillno	            --贷款借据号
    ,t2.paytimes	            --本期期数
    ,t2.subpaytimes	            --本期子期数
    ,t2.begindate	            --起始日期
    ,t2.enddate	                --到期日期
    ,t2.expirdate	            --宽限期到期日
    ,t2.initcapital	            --初始本金
    ,t2.initinterest	        --初始利息
    ,t2.capital	                    --本金
    ,t2.accruedinterestreceivable	--应收应计利息
    ,t2.actualrateinterest	            --实际利率利息收入
    ,t2.actualrecordinterest	        --实际应计利息
    ,t2.actualrateactualinterest	    --实际利率实际利息收入
    ,t2.writeoffcapitalinterset	        --已核销本金利息
    ,t2.actualwriteoffcapinte	        --实际核销本金利息
    ,t2.periodstatus	                --本期状态
    ,t2.productcode	                    --产品代码
    ,t2.productname	                    --产品名称
from(
    SElECT distinct DBIL_ID
    from SJXQ_SJ2024022306_CST_02
)t1 inner join edw.loan_repay_debt_detail t2 --期供明细
on t1.DBIL_ID=t2.duebillno
and t2.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024022306_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022306_CST_04_1 AS
SElECT cst_id
    ,min(dt) min_dt
    ,max(dt) max_dt
    ,DATEDIFF(TO_DATE(max(dt),'yyyymmdd'),TO_DATE(min(dt),'yyyymmdd'),'MM') mons
    ,count(1) cnt
from SJXQ_SJ2024022306_CST_04
group by cst_id
;
-- 部分客户 ADM_SUBL_BUS_DEP_ACT_ACS_INF_DD 存在重复计算余额情况 1003349246 2607354383
SELECT t1.*,t2.dep_act_bal_rmb
from SJXQ_SJ2024022306_CST_04 t1
left join SJXQ_SJ2024022306_CST_04_2 t2
on t1.cst_id=t2.cst_id
and t1.dt=t2.dt
where t1.dep_act_bal_rmb<>t2.dep_act_bal_rmb
数据说明：1. 数据为最新日期，支行近2年20日还款共3818条记录
2. 增加了前3日余额是否大于应还本金、利息
3. 表 ADM_SUBL_BUS_DEP_ACT_ACS_INF_DD 在 20230901 前只有月末记录 ，20日还款前3日记录无余额，通过上下游表分析 edw.dws_bus_dep_act_acm_inf_dd 取该表的 gl_bal*汇率
*/***SJ2024022726_财富适当性预警-不当销售.sql
/*20231222-20231224 每日新增成功购买的财富业务：
保险业务：交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;；
理财业务：财富产品分类为自营理财、代销理财的；
基金：财富产品分类为基金，业务代码为&ldquo;申购确认&rdquo;&ldquo;认购确认&rdquo;且交易成功，基金单个定投协议号下的首次定投起始日期为2023年12月10日且成功支付首笔定投款；
贵金属：财富产品分类为贵金属，贵金属成功购买交易&quot;
历史取数编号: SJXQ_SJ2023122801_CST_10
*/
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,SUBSTR(T1.DOC_NBR,7,8) BIRTH_DT
    ,T1.AGE
    ,T1.M_TEL_NO
    ,DECODE(T1.GDR_CD,'1','男','2','女','未知') GENDER
    ,T1.fm_ind,T1.reg_adr_dtl_inf,T1.fam_adr_dtl_inf
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20231231'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231231'
WHERE T1.DT='20231231'
;
--保险 20231222-20231224
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_02 AS
SELECT T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,T1.CST_ID
    ,substr(t1.SYS_SRL_NBR,1,8) bd_jf_dt --保单首次缴费日
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP
    ,T2.CMP_CD
    ,T3.CMP_NM
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.TRX_AMT
    ,T4.EFE_LOAN_CST_IND                                    EFE_LOAN_CST_IND_TRX
    ,CASE WHEN NVL(T5.OWN_EMP_ID,'')<>'' THEN 1 ELSE 0 END  OWN_EMP_ID_TRX
    ,T1.TRX_ZID             --交易帐号|C32
    ,T1.CHNL_TYP            --渠道类型|C10
    ,t6.insu_fee            --保险费用
    ,T6.PAY_YEAR_PRD_TYP    --缴费年期类型|C2 1趸缴 2年缴
    ,T6.PAY_YEAR            --缴费年限|C10
    ,t6.acc_dt	            --受理日期|C16
    ,T6.EFT_DT              --生效日期
    ,t6.rcm_psn     --均为空
    ,T7.MNG_ID      RCM_PSN_ID
    ,T7.MNG_ORG_ID  RCM_ORG_ID
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20231224'
LEFT JOIN EDW.DIM_BUS_INSU_CMP_INF_DD           T3 --保险公司信息
ON  T2.CMP_CD=T3.CMP_CD
AND T3.DT='20231224'
LEFT JOIN ADM_PUB.ADM_CSM_CBAS_IND_INF_DD       T4
ON  T1.CST_ID=T4.CST_ID AND T1.TRX_DT=T4.DT
AND T4.DT BETWEEN '20231222' AND '20231224'
LEFT JOIN EDW.DWS_CST_IDV_BAS_INF_DD            T5
ON T1.CST_ID=T5.CST_ID AND T1.TRX_DT=T5.DT
AND T5.DT BETWEEN '20231222' AND '20231224'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
AND     T6.INSU_PLCY_STS ='0'   --保单状态：0:正常 1:退保 3:犹豫期退保  --所卡范围
AND     T6.DT = '20231224'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT = '20231224'
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.TRX_DT = T8.DT
AND T8.DT BETWEEN '20231222' AND '20231224'
WHERE T1.DT = '20231224'
AND   T1.TRX_DT BETWEEN '20231222' AND '20231224'
AND   T1.TRX_CD = '510001' --交易代码 新保承保(510001)
;
-- 基金 20231222-20231224
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_03 AS
SELECT T0.CST_ID
    ,T1.BUS_CD
    ,DECODE(T1.BUS_CD,'020','认购','022','申购','039','定投申请') TRX_TYPE
    ,T1.bus_glo_srl_nbr TRX_SRL_NBR
    ,T1.chnl_dt TRX_DT
    ,T1.chnl_tm TRX_tm
    ,T0.CFM_DT
    ,T1.CHNL_CD         TRX_CHNL_CD
    ,T1.APL_AMT         TRX_AMT
    ,T0.CFM_AMT                     --确认金额
    ,t0.wlth_mng_mnl_id	            --财富管护人工号
    ,t0.wlth_advsr_id	            --财富顾问工号
    ,case when nvl(t0.wlth_advsr_id,'')<>'' then t0.wlth_advsr_id else t0.wlth_mng_mnl_id end RCM_PSN_ID
    ,T1.RCM_PSN_ID      RCM_PSN_ID2  --推荐人员工号
    ,T1.TRX_ACT_ID                  --银行账号
    ,t1.taact_id
    ,t1.ta_cd
    ,T1.PD_CD                       --产品代码
    ,T2.PD_NM                       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS                --业绩比较基准
    ,T2.FOUND_DT                    --产品成立日期
    ,''                             --产品起息日期
    ,T2.MTU_DT                      --产品结束日期
    ,T3.CST_RSK_GRD_CD  TRX_FND_RSK_LVL     --客户交易日风险等级
    ,T3.ASES_DT         TRX_FND_RSK_ASES_DT --客户交易日风险测评时间
    ,T3.nvld_dt         TRX_FND_RSK_MTU_dt
    ,T6.CST_RSK_GRD_CD  new_FND_RSK_LVL     --客户交易日风险等级
    ,T6.ASES_DT         new_FND_RSK_ASES_DT --客户交易日风险测评时间
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI     t0
inner join (
    SElECT apl_id,cst_Id,BUS_CD,bus_glo_srl_nbr,chnl_dt,chnl_tm,CHNL_CD,APL_AMT,rcm_psn_id
        ,trx_act_id,taact_id,ta_cd,pd_cd
        ,row_number() OVER(PARTITION by apl_id order by dt desc) rn
    FROM edw.dwd_bus_chm_fnd_cst_rqs_srl_dd  --基金客户资金类交易申请流水
    WHERE dt<='@@{yyyyMMdd}'
    and chnl_dt between '20231222' and '20231224'   --交易时间
    -- AND trx_cd IN ( '100200' , '100201' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
    AND trx_sts_cd IN ( '3','S' )        -- 交易成功
)t1 on t0.orig_apl_id = t1.apl_id and t1.rn=1
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD        T2  --基金产品表
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231224'
AND T2.FND_TYP_CD<>'04' -- 非货基金
LEFT JOIN EDW.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    T3      --基金风评表
ON T1.CST_ID=T3.CST_ID AND T1.chnl_dt = T3.DT                --交易时
AND T3.DT BETWEEN '20231222' AND '20231224'
LEFT JOIN EDW.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    T6      --基金风评表
ON T1.CST_ID=T6.CST_ID AND T6.DT = '@@{yyyyMMdd}'           --最新
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.chnl_dt = T8.DT
AND T8.DT BETWEEN '20231222' AND '20231224'
left JOIN (	--首次定投日是2023年12月10日，并且在这天成功扣划定投款的客户
    SELECT DISTINCT cst_id,aip_start_dt --95
	FROM  EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD -- 基金定投协议信息
	WHERE DT='@@{yyyyMMdd}'
    and aip_start_dt BETWEEN '20231222' AND '20231224'   --首次定投日
    AND ACM_SUC_TMS>0               --成功扣款
)T9 ON T1.CST_ID=T9.CST_ID AND T1.chnl_dt = T9.aip_start_dt
WHERE T0.DT <= '@@{yyyyMMdd}'
AND   T0.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND   T0.BUS_CD IN ( '120' , '122' , '136' , '139' , '138') --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND   T0.CFM_AMT > 0
;
--客户上一次基金风评
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_04 AS
SELECT T1.CST_ID,T1.TRX_DT,T1.TRX_FND_RSK_ASES_DT
    ,T2.cst_rsk_grd_cd  lst_fnd_rsk_lvl
    ,T2.ases_dt         lst_fnd_rsk_ase_dt
    ,T2.nvld_dt         lst_fnd_rsk_mtu_dt
    ,ROW_NUMBER() OVER(PARTITION BY T1.CST_ID,T1.TRX_DT ORDER BY T2.ases_dt DESC) RN
FROM(
    SElECT DISTINCT T1.CST_ID,T1.TRX_DT,T1.TRX_FND_RSK_ASES_DT
    from SJXQ_SJ2024022726_CST2_03 T1
    WHERE T1.IS_SELECT=1 --没有满足条件的记录
)T1 INNER JOIN EDW.dim_bus_chm_fnd_cst_rsk_grd_inf_dd   T2 --基金风评表
ON T1.CST_ID=T2.CST_ID AND T2.ases_dt < T1.TRX_FND_RSK_ASES_DT
AND T2.DT <= '20231224'
;
-- 贵金属
--2023年 贵金属购买信息汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_05 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '@@{yyyyMMdd}'
AND replace(ORD_TM,'-','') between '20231222' and '20231224'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '@@{yyyyMMdd}'
AND replace(ORD_TM,'-','') between '20231222' and '20231224'   --交易时间
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_06 AS
SELECT T1.*
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM SJXQ_SJ2024022726_CST2_05                       T1
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.TRX_DT = T8.DT
AND T8.DT BETWEEN '20231222' AND '20231224'
;
-- 自营/代销 理财
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_07 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.CFM_DT --确认日期
    ,T1.TRX_CHNL_CD
    -- ,C1.CD_VAL_DSCR  TRX_CHNL --交易渠道
    ,T1.TRX_AMT --交易金额
    ,T1.CFM_AMT --确认金额
    ,T1.TRX_LOT --交易份额
    ,T1.CFM_LOT --确认份额
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.BNK_ACT_ID --银行账号
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.PD_FOUND_DT     --产品成立日期
    ,T2.PD_VAL_DT       --产品起息日期
    ,T2.PD_END_DT       --产品结束日期
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    ,T4.RSK_LVL_CD          TRX_FIN_RSK_LVL      --客户交易日风险等级
    ,T4.LATE_ASES_DT        TRX_Fin_RSK_ASEs_DT  --客户交易日风险测评时间
    ,t4.rsk_vld_prd_stop_dt TRX_FIN_RSK_mtu_DT
    ,T7.RSK_LVL_CD          new_Fin_RSK_LVL     --客户最新风险等级
    ,T7.LATE_ASES_DT        new_Fin_RSK_ASES_DT --客户最新风险测评时间
    ,T8.AUM_BAL     AUM_BAL_TRX
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20231224'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID
and t1.pd_cd=t3.pd_cd
and t1.bnk_act_id=t3.bnk_act_id
LEFT JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD           T4  --风评
ON T1.CST_ID=T4.CST_ID AND T1.TRX_DT=T4.DT              --交易时
and t4.dt between '20231222' AND '20231224'
LEFT JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD           T7  --风评
ON T1.CST_ID=T7.CST_ID AND T7.DT='@@{yyyyMMdd}'         --最新
LEFT JOIN ADM_PUB.ADM_CSM_CBUS_CST_FIN_AST_INF_DD   T8 --客户金融资产信息表
ON  T1.CST_ID = T8.CST_ID AND T1.TRX_DT = T8.DT
AND T8.DT BETWEEN '20231222' AND '20231224'
WHERE T1.DT = '@@{yyyyMMdd}'    --只有近7天数据
AND T1.TRX_DT BETWEEN '20231222' AND '20231224'
;
--理财上一次风险评估
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_08 AS
SELECT T1.CST_ID,T1.TRX_DT,T1.TRX_FIN_RSK_ASES_DT
    ,T2.rsk_lvl_cd              lst_fin_rsk_lvl
    ,T2.LATE_ASES_DT            lst_fin_rsk_ase_dt
    ,T2.rsk_vld_prd_stop_dt     lst_fin_rsk_mtu_dt
    ,ROW_NUMBER() OVER(PARTITION BY T1.CST_ID,T1.TRX_DT ORDER BY T2.LATE_ASES_DT DESC) RN
FROM(
    SElECT DISTINCT T1.CST_ID,T1.TRX_DT,T1.TRX_FIN_RSK_ASES_DT
    from SJXQ_SJ2024022726_CST2_07 T1
)T1 INNER JOIN EDW.DWD_BUS_CHM_CST_RSK_ASES_DD   T2 --基金风评表
ON T1.CST_ID=T2.CST_ID AND T2.LATE_ASES_DT < T1.TRX_FIN_RSK_ASES_DT
AND T2.DT <= '20231224'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_09 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,'保险' PROD_CLASS
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,NULL PD_RSK_GRD
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,T1.RCM_PSN_ID,T3.EMPE_NM RCM_PSN_NM
    ,T1.RCM_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.AUM_BAL_TRX
    ,NULL TRX_RSK_LVL,NULL TRX_RSK_ASES_DT,NULL TRX_RSK_MTU_DT
    ,NULL LST_RSK_LVL,NULL LST_RSK_ASES_DT,NULL LST_RSK_MTU_DT
    ,NULL NEW_RSK_LVL,NULL NEW_RSK_ASES_DT
FROM SJXQ_SJ2024022726_CST2_02               T1  --保险
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.RCM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
UNION all
SELECT T1.CST_ID,T1.TRX_SRL_NBR,NULL,'基金'
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,T1.PD_RSK_GRD
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,T1.RCM_PSN_ID,T3.EMPE_NM
    ,T4.ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.AUM_BAL_TRX
    ,T1.TRX_FND_RSK_LVL,T1.TRX_FND_RSK_ASES_DT,T1.TRX_FND_RSK_MTU_DT
    ,T2.LST_FND_RSK_LVL,T2.LST_FND_RSK_ASE_DT,T2.LST_FND_RSK_MTU_DT
    ,T1.NEW_FND_RSK_LVL,T1.NEW_FND_RSK_ASES_DT
FROM SJXQ_SJ2024022726_CST2_03               T1  --基金
left join SJXQ_SJ2024022726_CST2_04          t2  --上一次风评
on T1.CST_ID=T2.CST_ID AND T1.TRX_DT=T2.TRX_DT
AND T2.RN = 1
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T3.ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
WHERE T1.IS_SELECT=1    --选中基金交易
UNION all
SELECT CST_ID,ORD_ID,NULL,'贵金属'
    ,GOODS_TYP,NULL,CMDT_NM
    ,NULL
    ,TRX_DT,substr(PMT_TM,12,19)
    ,TRX_AMT
    ,RCM_PSN_ID,RCM_PSN_NM
    ,RCM_PSN_AFL_DEPT_ID
    ,RCM_PSN_AFL_SUB_BRN
    ,RCM_PSN_AFL_BRN
    ,AUM_BAL_TRX,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
FROM SJXQ_SJ2024022726_CST2_06   T1  --贵金属
UNION all
SELECT T1.CST_ID,T1.SRL_NBR,NULL,CONCAT(T1.AGN_IND,'理财')
    ,T1.PROD_TYPE,T1.PD_CD,T1.PD_NM
    ,T1.PD_RSK_GRD
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,T1.SALE_EMPE_ID,t3.EMPE_NM
    ,T1.SALE_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
    ,t1.AUM_BAL_TRX
    ,T1.TRX_FIN_RSK_LVL,T1.TRX_FIN_RSK_ASES_DT,T1.TRX_FIN_RSK_MTU_DT
    ,T2.LST_FIN_RSK_LVL,T2.LST_FIN_RSK_ASE_DT,T2.LST_FIN_RSK_MTU_DT
    ,T1.NEW_FIN_RSK_LVL,T1.NEW_FIN_RSK_ASES_DT
FROM SJXQ_SJ2024022726_CST2_07               T1  --理财
left join SJXQ_SJ2024022726_CST2_08          t2  --上一次风评
on T1.CST_ID=T2.CST_ID
AND T1.TRX_DT=T2.TRX_DT
AND T2.RN=1
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.SALE_EMPE_ID = T3.empe_id
AND T3.DT = '20231224'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.SALE_ORG_ID = T4.ORG_ID
AND     T4.DT = '20231224'
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST2_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST2_10 AS
SElECT TO_CHAR(DATEADD(TO_DATE(t1.trx_dt, 'yyyymmdd'), 1, 'dd'),'yyyymmdd') 取数日期
    ,REPLACE(T1.TRX_DT,'-','')          数据日期
    ,T1.SYS_SRL_NBR                     交易流水号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.PROD_TYPE                       产品类型
    ,T1.INSU_PLCY_ID                    保单号_保险
    ,T1.PD_CD                           产品代码
    ,T1.PD_NM                           产品名称
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_TM                          交易时间
    ,T1.TRX_AMT                         交易金额
    ,T1.RCM_PSN_ID                      推荐人工号
    ,T1.RCM_PSN_NM                      推荐人姓名
    ,T1.RCM_ORG_ID                      推荐人所在机构
    ,T1.SBR_ORG_NM                      推荐人所在支行名称
    ,T1.BRC_ORG_NM                      推荐人所在分行名称
    ,T2.PRM_MGR_ID                      管户人工号
    ,T2.PRM_MGR_NM                      管户人姓名
    ,T2.PRM_ORG_ID                      管户人所在机构
    ,T2.SBR_ORG_NM                      管户人支行名称
    ,T2.BRC_ORG_NM                      管户人分行名称
    ,T1.CST_ID						    客户号
    ,T2.CST_CHN_NM                      客户名称
    ,T2.BIRTH_DT                        出生年月日
    ,T2.AGE                             年龄
    ,T2.FM_IND							购买人是否农户
    ,T2.REG_ADR_DTL_INF                 购买人户籍地址
    ,T2.FAM_ADR_DTL_INF                 购买人家庭地址
    ,T1.AUM_BAL_TRX                     购买人购买时点AUM
    ,T1.PD_RSK_GRD                      产品风险等级
    ,T1.TRX_RSK_LVL                     购买时点购买人风险等级
    ,T1.TRX_RSK_ASES_DT                 购买时点购买人风险等级测评时间
    ,T1.TRX_RSK_MTU_DT                  购买时点购买人风险等级到期日
    ,T1.LST_RSK_LVL                     购买人购买时点上一次风险等级
    ,T1.LST_RSK_ASES_DT                 购买人购买时点上一次风险等级测评时间
    ,T1.LST_RSK_MTU_DT                  购买人购买时点上一次风险等级到期日
    ,T1.NEW_RSK_LVL                     客户最新风险等级
    ,T1.NEW_RSK_ASES_DT                 客户最新风险等级测评时间
FROM SJXQ_SJ2024022726_CST2_09       T1
LEFT JOIN SJXQ_SJ2024022726_CST2_01  T2
ON T1.CST_ID = T2.CST_ID
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST2_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_03 where IS_SELECT=1
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id,PMT_TM) custs
from SJXQ_SJ2024022726_CST2_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_08 where rn=1
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024022726_CST2_09
UNION all
SElECT '10' seq, count(1) cnt, count(distinct 客户号,交易日期) custs
from SJXQ_SJ2024022726_CST2_10
;
/*
01	14376433	14376433
02	14	14
03	80	78
04	6	6
05	164	160
06	164	160
07	5191	2036
08	1319	1319
09	5449	2252
10	5449	2252
*/
***SJ2024022726_财富适当性预警-捆绑销售.sql
/*20240131 每日新增成功购买的财富业务：
保险业务：交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;；
理财业务：财富产品分类为自营理财、代销理财的；
基金：财富产品分类为基金，业务代码为&ldquo;申购确认&rdquo;&ldquo;认购确认&rdquo;且交易成功，基金单个定投协议号下的首次定投起始日期为2023年12月10日且成功支付首笔定投款；
贵金属：财富产品分类为贵金属，贵金属成功购买交易&quot;
step1:确定字段
step2:确定日期 20240111-20240115
step3:注意 ROW_NUMBER 表
*/
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_01 AS
SELECT T1.CST_ID,T1.CST_CHN_NM
    ,T2.PRM_MGR_ID,T2.PRM_MGR_NM,T2.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t5.sam_rsk_ctrl_id
    ,T6.CRDT_RSK_LVL
FROM ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD            T1
LEFT JOIN ADM_PUB_APP.ADM_PBLC_CST_PRM_MNG_INF_DD   T2 --客户`主管户`信息 15842885 CST_ID 唯一
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '20240131'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD            T4 --考核机构树 4481 ORG_ID 唯一
ON      T2.PRM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20240131'
LEFT JOIN EDW.DWS_CST_BAS_INF_DD                    T5
ON T1.CST_ID = T5.CST_ID
AND T5.DT = '20240131'
left join(
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') CRDT_RSK_LVL
        ,ROW_NUMBER() OVER(PARTITION BY CST_ID ORDER BY busi_id DESC) RN
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='20240131'
)T6 on T1.cst_id=T6.cst_id AND T6.RN=1
WHERE T1.DT='20240131'
;
--保险 20240111-20240115 交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_02 AS
SELECT T1.SYS_SRL_NBR ,T1.INSU_PLCY_ID,T1.CST_ID
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,case when T1.TRX_CD = '510001' then '新保承保' else null end TRX_CD
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP --产品类型|C1
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.TRX_AMT
    ,T1.trx_sts	--交易状态|C1
    ,T6.PAY_YEAR_PRD_TYP PAY_YEAR_PRD_TYP_CD
    ,DECODE(T6.PAY_YEAR_PRD_TYP,'1','趸缴','2','年缴','') PAY_YEAR_PRD_TYP --缴费年期类型
    ,T6.PAY_YEAR    --缴费年限|C10
    ,DECODE(T6.INSU_PLCY_STS,'0','正常','')     INSU_PLCY_STS
    ,t6.rcm_psn     --均为空
    ,T7.MNG_ID      RCM_PSN_ID
    ,T7.MNG_ORG_ID  RCM_ORG_ID
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20240131'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
AND     T6.INSU_PLCY_STS ='0'   --保单状态：0:正常 1:退保 3:犹豫期退保  --所卡范围
AND     T6.DT = '20240131'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT = '20240131'
WHERE   T1.DT = '20240131'
AND     T1.TRX_DT BETWEEN '20240111' AND '20240115'
AND     T1.TRX_CD = '510001' --交易代码 510001新保承保
;
-- 基金 20240111-20240115 业务代码为&ldquo;申购确认&rdquo;&ldquo;认购确认&rdquo;且交易成功
-- 业务代码为 '定投申请' 首次定投起始日期为2023年12月10日且成功支付首笔定投款
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_03 AS
SELECT T1.CST_ID,t1.aip_agr_id
    ,DECODE(T2.BUS_CD,'020','认购','022','申购','039','定投') TRX_CD    --交易代码
    ,T2.bus_glo_srl_nbr TRX_SRL_NBR
    ,DECODE(T1.TRX_STS_CD,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,T2.chnl_dt TRX_DT
    ,T2.chnl_tm TRX_tm
    ,T2.APL_AMT         TRX_AMT
    ,t1.wlth_mng_mnl_id	            --财富管护人工号
    ,t1.wlth_advsr_id	            --财富顾问工号
    ,case when nvl(t1.wlth_advsr_id,'')<>'' then t1.wlth_advsr_id else t1.wlth_mng_mnl_id end RCM_PSN_ID
    ,T2.RCM_PSN_ID      RCM_PSN_ID2  --推荐人员工号
    ,T2.PD_CD                       --产品代码
    ,T3.PD_NM                       --产品名称
    ,DECODE(T3.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04'
        ,'货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,case when T2.BUS_CD='039' and T4.ACM_SUC_TMS=1 then 1 else NULL end is_fst_aip
    --首次定投日是2023年12月10日，并且在这天成功扣划定投款的客户
        OR (T2.BUS_CD='039' AND T4.aip_start_dt = T2.chnl_dt and T4.ACM_SUC_TMS>0) THEN 1
        ELSE 0 END IS_SELECT
FROM EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI         t1
inner join (
    SElECT apl_id,CST_ID,BUS_CD,bus_glo_srl_nbr,chnl_dt,chnl_tm,CHNL_CD,APL_AMT,rcm_psn_id
        ,trx_act_id,taact_id,ta_cd,pd_cd
        ,row_number() OVER(PARTITION by apl_id order by dt desc) rn
    FROM edw.dwd_bus_chm_fnd_cst_rqs_srl_dd  --基金客户资金类交易申请流水
    WHERE dt<='20240131'
    and chnl_dt between '20240111' and '20240115'   --交易时间
    -- AND trx_cd IN ( '100200' , '100201' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
    AND trx_sts_cd IN ( '3','S' )        -- 交易成功
)T2 on t1.orig_apl_id = T2.apl_id and T2.rn=1
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD        T3  --基金产品表
ON  T2.PD_CD=T3.PD_CD
AND T3.DT='20240131'
AND T3.FND_TYP_CD<>'04' -- 非货基金
left JOIN EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD    T4 -- 基金定投协议信息
on  T1.aip_agr_id = T4.agr_id
and T4.dt='20240131'
WHERE T1.DT <= '20240131'
AND   T1.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND   T1.BUS_CD IN ( '120' , '122' , '136' , '139' , '138') --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND   T1.CFM_AMT > 0
;
--贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_04 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '20240131'
AND replace(ORD_TM,'-','') between '20240111' and '20240115'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '20240131'
AND replace(ORD_TM,'-','') between '20240111' and '20240115'   --交易时间
;
-- 自营/代销 理财
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_05 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.TRX_AMT --交易金额
    ,decode(T1.TRX_STS_CD,'6','部分确认未全部返回','7','部分确认已全部返回'
        ,'8','确认成功','S','成功')                     TRX_STS
    ,DECODE(T1.BUS_CD,'122','申购','130','认购','')     trx_cd
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
AND T2.DT='20240131'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
WHERE T1.DT = '@@{yyyyMMdd}'        --只有近7天数据
AND T1.TRX_DT BETWEEN '20240111' AND '20240115'
;
--财富产品交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_06 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,'保险' PROD_CLASS
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR   --保险
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,NULL is_fst_aip     --基金
    ,T1.RCM_PSN_ID,T3.EMPE_NM RCM_PSN_NM            --推荐人
    ,T1.RCM_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM      --推荐人机构
FROM SJXQ_SJ2024022726_CST_02               T1  --保险
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            T3
ON  T1.RCM_PSN_ID = T3.EMPE_ID
AND T3.DT = '20240131'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.RCM_ORG_ID = T4.ORG_ID
AND     T4.DT = '20240131'
UNION all
SELECT T1.CST_ID,T1.TRX_SRL_NBR,'基金'
    ,NULL,NULL,NULL,NULL
    ,T1.trx_sts,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT
    ,T1.is_fst_aip
    ,T1.RCM_PSN_ID,T3.EMPE_NM
    ,T4.ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ2024022726_CST_03              T1  --基金
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.RCM_PSN_ID = T3.empe_id
AND T3.DT = '20240131'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T3.ORG_ID = T4.ORG_ID
AND     T4.DT = '20240131'
WHERE T1.IS_SELECT=1    --选中基金交易
UNION all
SELECT CST_ID,ORD_ID,'贵金属'
    ,NULL,NULL,NULL,NULL
    ,ORD_STS,'购买',NULL,CMDT_NM,GOODS_TYP
    ,TRX_DT,substr(PMT_TM,12,19),TRX_AMT
    ,NULL
    ,RCM_PSN_ID,RCM_PSN_NM
    ,RCM_PSN_AFL_DEPT_ID
    ,RCM_PSN_AFL_SUB_BRN
    ,RCM_PSN_AFL_BRN
FROM SJXQ_SJ2024022726_CST_04   T1  --贵金属
UNION all
SELECT T1.CST_ID,T1.SRL_NBR,CONCAT(T1.AGN_IND,'理财')
    ,NULL,NULL,NULL,NULL
    ,T1.trx_sts,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,t1.trx_tm,T1.TRX_AMT
    ,NULL
    ,T1.SALE_EMPE_ID,t3.EMPE_NM
    ,T1.SALE_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM
FROM SJXQ_SJ2024022726_CST_05              T1  --理财
LEFT JOIN edw.dws_hr_empe_inf_dd            T3
ON  T1.SALE_EMPE_ID = T3.empe_id
AND T3.DT = '20240131'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树 4481 ORG_ID 唯一
ON      T1.SALE_ORG_ID = T4.ORG_ID
AND     T4.DT = '20240131'
;
--同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_07 AS
SELECT T1.CST_ID,T1.SAM_RSK_CTRL_ID
    ,t2.CST_ID RSK_CST_ID,T2.CST_CHN_NM RSK_CST_NM
    ,CASE WHEN T1.CST_ID=T2.CST_ID THEN '本人' ELSE C1.CD_VAL_DSCR END rel_typ
    ,T2.CRDT_RSK_LVL
FROM SJXQ_SJ2024022726_CST_01              T1
INNER JOIN SJXQ_SJ2024022726_CST_01        T2
ON  T1.SAM_RSK_CTRL_ID=T2.SAM_RSK_CTRL_ID
LEFT JOIN edw.dim_cst_rel_inf_dd           T3
ON  T1.CST_ID=T3.CST_ID AND T2.CST_ID=T3.REL_CST_ID
AND T3.DT = '20240131'
LEFT JOIN edw.dwd_code_library_dd          C1
ON  T3.rel_typ_cd = C1.cd_val
AND C1.dt='20240131'
WHERE nvl(t1.sam_rsk_ctrl_id,'')<>''    --非空
;
-- 前后15天贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_08 AS
select a.cst_ID,a.trx_dt
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行年利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr FIVE_CTG                --五级分类
    ,case when b.crc_ind = '1' then '循环贷款'
            OR SUBSTR(b.PD_CD,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                                                  --贷款用途
    ,B.USG_CMT                                                      --贷款用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt    --贷款利率优惠备注
    ,case when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan              --是否政策性贷款
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from(
    SElECT distinct cst_ID,trx_dt
    from SJXQ_SJ2024022726_CST_06
)a INNER JOIN edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.cst_ID = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.DT = '20240131'
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '20240131'
and ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd'))<=15 --交易日前后15天内的贷款
left join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '20240131'
left join edw.dwd_code_library_dd           E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='20240131'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '20240131'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '20240131'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
--与当笔贷款贷款类型相同的上一笔贷款合同号
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_09 AS
SElECT t1.cst_ID,t1.loan_type,t1.DTRB_DT
    ,t2.BUSI_CTR_ID             lst_BUSI_CTR_ID
    ,t2.DTRB_DT                 lst_DTRB_DT
    ,t2.ref_year_intr_rat       lst_ref_year_intr_rat
    ,t2.INTR_RAT                lst_INTR_RAT
    ,t2.aprv_exe_mon_intr_rat   lst_mon_intr_rat
    ,t2.CTR_AMT                 lst_CTR_AMT
    ,row_number() OVER(partition by t1.cst_ID,t1.loan_type,t1.DTRB_DT order by t2.DTRB_DT desc) rn
from( --交易日前后15天内的贷款信息
    SElECT distinct cst_id,DTRB_DT,loan_type
    from SJXQ_SJ2024022726_CST_08
)t1 inner join (
    select b.cst_ID
        ,B.BUSI_CTR_ID                         --合同流水号
        ,B.CTR_AMT                             --合同金额
        ,c.ref_year_intr_rat                   --参考年利率
        ,B.INTR_RAT                            --执行年利率
        ,c.aprv_exe_mon_intr_rat               --执行月利率
        ,G.DTRB_DT                             --发放日期
        ,case when b.crc_ind = '1' then '循环贷款'
                OR SUBSTR(b.PD_CD,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    FROM edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
    INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
    ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
    AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
    AND     C.DT = '20240131'
    LEFT JOIN (
        SELECT  BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
        WHERE DT = '20240131'
        GROUP BY BUS_CTR_ID
    ) G ON  B.BUSI_CTR_ID = G.BUS_CTR_ID
    WHERE   NVL(B.CST_ID,'') <> ''  --剔除空值和空
    AND     B.DT = '20240131'
)t2 on t1.cst_ID=t2.cst_ID and t1.loan_type=t2.loan_type
and t2.DTRB_DT < t1.DTRB_DT     --历史发放贷款
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_10 AS
SElECT T1.SYS_SRL_NBR,T1.PROD_CLASS
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_AMT,T1.is_fst_aip
    ,T1.RCM_PSN_ID,T1.RCM_PSN_NM                --推荐人
    ,T1.RCM_ORG_ID,T1.SBR_ORG_NM,T1.BRC_ORG_NM  --推荐人机构
    ,T1.CST_ID
    ,T2.SAM_RSK_CTRL_ID
    ,T2.RSK_CST_ID
    ,T2.RSK_CST_NM
    ,T2.rel_typ,T2.CRDT_RSK_LVL
    ,T3.BUSI_CTR_ID,T3.loan_type,T3.FIVE_CTG,T3.dtrb_dt,T3.ref_year_intr_rat
    ,T3.INTR_RAT,T3.aprv_exe_mon_intr_rat,T3.ctr_amt,T3.is_zc_loan,T3.is_jl_loan
    ,T3.LOAN_USG_CD,T3.USG_CMT,T3.intr_rat_adj_cmt,T3.pre_ases_res
    ,T4.lst_BUSI_CTR_ID
	,T4.lst_DTRB_DT
	,T4.lst_ref_year_intr_rat
	,T4.lst_INTR_RAT
	,T4.lst_mon_intr_rat
	,T4.lst_CTR_AMT
from SJXQ_SJ2024022726_CST_06      T1  --财富交易主表
left join SJXQ_SJ2024022726_CST_07 T2  --同一风险风险控制号
ON T1.CST_ID=T2.CST_ID
LEFT JOIN SJXQ_SJ2024022726_CST_08 T3  --前后15天内的贷款
ON T1.CST_ID=T3.CST_ID
AND T1.TRX_DT=T3.TRX_DT
LEFT JOIN SJXQ_SJ2024022726_CST_09 T4  --上一笔贷款
ON  T3.CST_ID=T4.CST_ID
AND T3.LOAN_TYPE=T4.LOAN_TYPE
AND T3.DTRB_DT = T4.DTRB_DT AND T4.RN=1
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024022726_CST_11 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024022726_CST_11 AS
select TO_CHAR(DATEADD(TO_DATE(t1.trx_dt, 'yyyymmdd'), 15, 'dd'),'yyyymmdd') 数据日期
    ,T1.SYS_SRL_NBR                     交易流水号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.PROD_TYPE                       产品类型
    ,T1.INSU_PLCY_ID                    保单号_保险
    ,T1.INSU_PLCY_STS                   保单状态_保险
    ,T1.PAY_YEAR_PRD_TYP                缴费年期类型_保险
    ,T1.PAY_YEAR                        缴费年限_保险
    ,T1.TRX_STS                         交易状态
    ,T1.PD_CD                           产品代码
    ,T1.PD_NM                           产品名称
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_AMT                         交易金额
    ,T1.TRX_CD                          交易代码_业务代码
    ,T1.is_fst_aip                      是否首笔定投_基金
    ,T1.RCM_PSN_ID                      推荐人工号
    ,T1.RCM_PSN_NM                      推荐人姓名
    ,T1.RCM_ORG_ID                      推荐人所在机构
    ,T1.SBR_ORG_NM                      推荐人所在支行
    ,T1.BRC_ORG_NM                      推荐人所在分行
    ,T2.PRM_MGR_ID                      管户人工号
    ,T2.PRM_MGR_NM                      管户人姓名
    ,T2.PRM_ORG_ID                      管户人所在机构
    ,T2.SBR_ORG_NM                      管户人支行名称
    ,T2.BRC_ORG_NM                      管户人分行名称
    ,T1.CST_ID							购买人客户号
    ,T2.CST_CHN_NM                      购买人名称
    ,T2.SAM_RSK_CTRL_ID                 同一风险控制号
    ,T1.RSK_CST_ID                      同一风险风险控制号下的客户号
    ,T1.RSK_CST_NM                      同一风险风险控制号下的客户名称
    ,T1.rel_typ                         同一风险风险控制号下的客户与购买人的关系
    ,T1.CRDT_RSK_LVL                    同一风险控制号下的客户的信用风险等级
    ,T1.BUSI_CTR_ID                     财富业务交易日前后15天内的贷款合同号
    ,T1.loan_type                       当笔贷款类型
    ,T1.FIVE_CTG                        当笔贷款五级分类
    ,T1.dtrb_dt                         当笔贷款发放日期
    ,T1.ref_year_intr_rat               当笔贷款参考年利率
    ,T1.INTR_RAT                        当笔贷款执行年利率
    ,T1.aprv_exe_mon_intr_rat           当笔贷款执行月利率
    ,T1.ctr_amt                         当笔贷款合同金额
    ,T1.is_zc_loan                      当笔贷款是否为政策性贷款
    ,T1.is_jl_loan                      当笔贷款是否为接力贷
    ,T1.LOAN_USG_CD                     当笔贷款用途
    ,T1.USG_CMT                         当笔贷款用途备注
    ,T1.intr_rat_adj_cmt                当笔贷款利率优惠备注
    ,T1.pre_ases_res                    当笔贷款预评估结果
    ,T1.lst_BUSI_CTR_ID                 与当笔贷款贷款类型相同的上一笔贷款合同号
    ,case when T1.lst_BUSI_CTR_ID is not null then T1.loan_type else null end 上一笔贷款类型
    ,T1.lst_DTRB_DT                     上一笔贷款发放日期
    ,T1.lst_ref_year_intr_rat           上一笔贷款参考年利率
    ,T1.lst_INTR_RAT                    上一笔贷款执行年利率
	,T1.lst_mon_intr_rat                上一笔贷款执行月利率
	,T1.lst_CTR_AMT                     上一笔贷款合同金额
from SJXQ_SJ2024022726_CST_10      T1
left join SJXQ_SJ2024022726_CST_01 T2  --基础信息
ON T1.CST_ID=T2.CST_ID
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_01
UNION all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_02
UNION all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_03
UNION all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_04
UNION all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_05
UNION all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_06
UNION all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_07
UNION all
SElECT '08' seq, count(1) cnt, count(distinct BUSI_CTR_ID) custs
from SJXQ_SJ2024022726_CST_08
UNION all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_09 where rn=1
UNION all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024022726_CST_10
UNION all
SElECT '11' seq, count(1) cnt, count(distinct 购买人客户号) custs
from SJXQ_SJ2024022726_CST_11
;
/*
01	14463368	14463368
02	209	202
03	137	80
04	3208	2518
05	39720	8747
06	43200	11430
07	9664076	6745884
08	585	573
09	287	257
10	64918	11430
11	64918	11430
*/
***SJ2024030401_客户交接贷款反馈.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024030401_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030401_CST_01 AS
SElECT busi_ctr_id
FROM qbi_file_20240319_13_33_09
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030401_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030401_CST_02 AS
SElECT t1.busi_ctr_id
	,t2.cst_id                                   --客户号
	,t2.cst_nm                                   --客户名称
	,t2.not_used_2                               --是否连续三个月未有新借据
	,t2.pd_cd                                    --产品编码
	,t2.pd_nm                                    --产品名称
	,t2.bus_cd                                   --业务标识
	,t2.intr_rat                                 --执行利率
	,t2.apnt_start_dt                            --合同起始日
	,t2.apnt_mtu_dt                              --合同到期日
	,t2.frz_sts_cd                               --冻结状态代码
	,t2.not_used_3                               --是否连续六个月未使用
	,t2.not_used_4                               --是否连续一年未使用
	,t2.wthr_eft                                 --是否生效
	,t2.wthr_not_use                             --是否从未使用
	,t2.dep_bal_30_avg_1                         --客户近30天存款月日均
	,t2.hpn_typ_cd                               --发生类型代码
	,t2.hpn_typ_nm                               --发生类型名称
    ,t2.data_dt
    ,t2.dt
    ,row_number() over(partition by t2.ln_ctr_ar_id order by data_dt desc) rn
from SJXQ_SJ2024030401_CST_01               t1
inner join app_rpt.fct_rong_e_dai_moni_list t2 --融e贷贷后监测清单
on t1.busi_ctr_id=t2.ln_ctr_ar_id
where t2.dt<='@@{yyyyMMdd}'
;
/*
SElECT SUBSTR(dt,1,6) mons,count(1) cnt
from SJXQ_SJ2024030401_CST_02
where rn=1
GROUP BY mons
202012	2
202112	9
202210	2
202212	61
202306	5
202308	52
202309	684
202310	1548
202311	1195
202312	1118
202401	749
202402	1374
202403	1
SELECT dt
    ,count(ln_ctr_ar_id) cnt
    ,count(DISTINCT ln_ctr_ar_id) cnt
from app_rpt.fct_rong_e_dai_moni_list         --融e贷贷后监测清单
where dt>='20230101'
GROUP BY dt
ORDER BY dt
20230628	124332	124332
20230728	128938	128938
20230828	719344	719344
20230928	723694	723694
SELECT t1.dt,count(t1.ln_ctr_ar_id) curr_custs
    ,count(t2.ln_ctr_ar_id) remain_custs
    ,count(t1.ln_ctr_ar_id)-count(t2.ln_ctr_ar_id) new_custs
from app_rpt.fct_rong_e_dai_moni_list t1
left join app_rpt.fct_rong_e_dai_moni_list t2 on t1.ln_ctr_ar_id=t2.ln_ctr_ar_id
and t1.dt=TO_CHAR(DATEADD(TO_DATE(t2.dt,'yyyymmdd'), 1, 'dd'),'yyyymmdd')
and t2.dt>='20230801'
where t1.dt>='20230802'
and nvl(t1.ln_ctr_ar_id,'')<>''
GROUP BY t1.dt
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024030401_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030401_CST_03 AS
SElECT t1.busi_ctr_id
	,t2.occurdate                                --发生日期
	,t2.customerid                               --客户编号
	,t2.customername                             --客户名称
	,t2.occurtype                                --发生类型011续做,010首笔,610卡片申请
	,t2.creditaggreement                         --使用授信协议号
	,t2.businesscurrency                         --币种
	,t2.businesssum                              --金额
	,t2.maturity                                 --到期日期
	,t2.balance                                  --当前余额
	,t2.normalbalance                            --正常余额
	,t2.overduebalance                           --逾期余额
	,t2.classifyresult                           --五级分类结果
    ,c1.cd_val_dscr     classifyresult_nm
	,t2.productcode                              --产品代码
    ,T2.purpose
    ,T2.purposeremark
    ,CASE WHEN NVL(T2.businessflag,'') = 'J' THEN '是' ELSE '否' END is_chzu
from SJXQ_SJ2024030401_CST_01           t1
inner join edw.loan_business_contract   t2 --业务合同表
on  t1.busi_ctr_id=t2.serialno
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd       c1
on  t2.classifyresult=c1.cd_val
and c1.tbl_nm = 'BUSINESS_CONTRACT'
and c1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030401_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030401_CST_04 AS
SElECT t1.busi_ctr_id
    ,T2.cst_id
    ,t2.pre_dfd_pre_rpt_ind	--预保预报标识|C1
from SJXQ_SJ2024030401_CST_01           t1
left join edw.dim_bus_loan_ctr_inf_dd   t2 --信贷合同信息
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030401_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030401_CST_05 AS
SELECT t1.busi_ctr_id
    ,T2.brk_rsn                                             --精准贷后触发内容
    ,CASE
        WHEN T2.cst_rsk_deg_id = '01' THEN '正常'
        WHEN T2.cst_rsk_deg_id = '02' THEN '风险可控'
        WHEN T2.cst_rsk_deg_id = '03' THEN '存在风险隐患'
        WHEN T2.cst_rsk_deg_id = '04' THEN '风险暴露' else ''
        END  cst_rsk_deg_nm                                 --精准贷后反馈
    ,c1.cd_val_dscr      LOAN_PST_CHK_TYP_nm                --贷后检查类型
    ,c2.cd_val_dscr      RSK_TRG_TYP_nm                     --风险触发类型
    ,row_number() OVER (PARTITION BY T2.cst_id ORDER BY T2.srl_nbr DESC) rn
FROM SJXQ_SJ2024030401_CST_04                        t1
inner JOIN edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd T2 --精准贷后结果信息表
ON  t1.cst_id = T2.cst_id
AND T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DWD_CODE_LIBRARY AS c1
ON      c1.CD_VAL = T2.LOAN_PST_CHK_TYP
AND     c1.tbl_nm = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     c1.fld_nm = 'LOAN_PST_CHK_TYP'
LEFT JOIN    EDW.DWD_CODE_LIBRARY AS c2
ON      c2.CD_VAL = T2.RSK_TRG_TYP_CD
AND     c2.tbl_nm = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     c2.fld_nm = 'RSK_TRG_TYP_CD'
;
--结果输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024030401_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030401_CST_06 AS
SElECT t1.busi_ctr_id
	,t2.not_used_2                          是否连续三个月未有新借据
	,t2.not_used_3                          是否连续六个月未使用
	,t2.not_used_4                          是否连续一年未使用
	,t2.wthr_eft                            是否生效
	,t2.wthr_not_use                        是否从未使用
    ,t2.data_dt                             前面数据最新日期
	,t1.occurdate                           发生日期
	,t1.customerid                          客户编号
	,t1.customername                        客户名称
	,t1.businesssum                         金额
	,t1.maturity                            到期日期
	,t1.balance                             当前余额
	,t1.normalbalance                       正常余额
	,t1.overduebalance                      逾期余额
    ,t1.classifyresult_nm                   五级分类
	,t1.productcode                         产品代码
    ,t1.is_chzu                             是否重组
    ,t4.pre_dfd_pre_rpt_ind                 预保预报标识
    ,T5.brk_rsn                             精准贷后触发内容
    ,T5.cst_rsk_deg_nm                      精准贷后反馈
    ,T5.LOAN_PST_CHK_TYP_nm                 贷后检查类型
    ,T5.RSK_TRG_TYP_nm                      风险触发类型
from SJXQ_SJ2024030401_CST_03       t1
left join SJXQ_SJ2024030401_CST_02  t2
on  t1.busi_ctr_id=t2.busi_ctr_id
and t2.rn=1
left join SJXQ_SJ2024030401_CST_04  t4
on t1.busi_ctr_id=t4.busi_ctr_id
left join SJXQ_SJ2024030401_CST_05  t5
on t1.busi_ctr_id=t5.busi_ctr_id
and t5.rn=1
;
SElECT '01' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024030401_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024030401_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024030401_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024030401_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024030401_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024030401_CST_06
;
/*
01	9266	9266
02	6800	6800
03	9266	9266
04	9266	9266
05	7496	7496
06	9266	9266
*/***SJ2024030501_小雪球产品短信营销.sql
/*1、截止2024年3月5日，购买过以下代码理财产品的客户:
2.2024年3月5日时点，理财风险评级在PR3(含)及以上的客户，
3、2024年3月5日时点，AUM资产在100万(合)以上且理财风险评级在PR2(含)及以上的客户
符合以上任条件客户汇总后按客户号去里
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024030501_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030501_CST_01 AS
SELECT  t1.cst_id          --cst_ID
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id --销售人员工号
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on  t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
    ,'9K76650A','9K76651A','9K76652A','9K76653A','9K76654A','9K76655A','9K76656A','9K76657A')
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt <= '20240305'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030501_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030501_CST_02 AS
select rsk_lvl_cd                             --风险等级代码|decimal
	,rsk_vld_prd_stop_dt                      --风险有效期截止日期|decimal
	,late_ases_dt                             --最后评估日期|decimal
	,cst_id                                   --客户号|c24
    ,row_number() over(partition by cst_id order by late_ases_dt desc) rn --取上一次风评
from edw.dwd_bus_chm_cst_rsk_ases_dd          --理财客户风险评估结果表
where dt='20240305'
and nvl(cst_id,'')<>''
and rsk_lvl_cd>=2
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030501_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030501_CST_03 AS
SElECT t1.cst_id
    ,t1.aum_bal	--客户综合金融资产(aum)
    ,t2.rsk_lvl
from adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd    t1 --客户集市-业务信息-客户金融资产信息表
inner join SJXQ_SJ2024030501_CST_02             t2 --风评2及以上
on t1.cst_id=t2.cst_id
where t1.dt='20240305'
and t1.aum_bal>=1000000
;
--汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024030501_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030501_CST_04 AS
SElECT distinct cst_id,'购买指定理财' typ_nm
from SJXQ_SJ2024030501_CST_01
union all
SElECT cst_id,'理财风评R3及以上'
from SJXQ_SJ2024030501_CST_02
where rsk_lvl_cd>=3
union all
SElECT cst_id,'AUM100万及以上'
from SJXQ_SJ2024030501_CST_03
;
--输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024030501_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030501_CST_05 AS
SElECT cst_id
from SJXQ_SJ2024030501_CST_04
group by cst_id
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030501_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030501_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030501_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030501_CST_04
;
/*
01	456	415
02	352805	352805
03	15008	15008
04	171277	163187
*/***SJ2024030541_2月理财基金适当性销售.sql
-- 2024年1月新增的定期理财认购/申购，非货基金认购/申购交易，交易申请确认状态为成功
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_01 AS
SELECT '定期理财'   bus_type  --业务类型
    -- ,decode(trx_cd,'100200','理财产品购买','100201','理财产品申购') --交易代码
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,t1.srl_nbr --流水号
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    -- , 销售人员姓名
    -- , brc_org_nm
    -- , sbr_org_nm
    -- ,bnk_act_id 银行账号
    ,t1.tatrx_act_nbr
    ,t1.tacd    --ta代码
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
    ,t1.cst_id          --cst_ID
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt between '20240201' and '20240229'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t1.trx_cd IN ( '100200' , '100201' )
;
-- 客户上一次理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_02 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,a.rsk_lvl_cd,a.late_ases_dt
        ,row_number() over(partition by a.cst_id order by late_ases_dt desc) rn
    from edw.dwd_bus_chm_cst_rsk_ases_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024030541_CST_01)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,rsk_lvl_cd,late_ases_dt
) a where rn=2
;
-- 客户交易时理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_03 AS
select T1.srl_nbr,T1.trx_dt
    ,T2.rsk_lvl_cd         trx_rsk_lvl      --客户交易日风险等级
    ,T2.late_ases_dt       trx_rsk_ases_dt  --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_01 T1
inner join edw.dwd_bus_chm_cst_rsk_ases_dd T2
on T1.cst_ID=T2.cst_id and T1.trx_dt=T2.dt
where T2.dt between '20240201' and '20240229'
;
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_04 AS
SELECT '非货基金' BUS_TYPE
    ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.CST_ID          --CST_ID
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='@@{yyyyMMdd}'
    and T1.CHANNEL_DATE between '20240201' and '20240229'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20240201' and '20240229'
    and T1.CHANNEL_DATE between '20240201' and '20240229'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_05 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,cst_rsk_grd_cd rsk_lvl_cd,ases_dt late_ases_dt,
        row_number() over(partition by a.cst_id order by ases_dt desc) rn
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024030541_CST_04)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,cst_rsk_grd_cd,ases_dt
) a where rn=2
;
-- 客户交易时基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_06 AS
select a.srl_nbr,a.trx_dt
    ,b.cst_rsk_grd_cd       trx_rsk_lvl     --客户交易日风险等级
    ,b.ases_dt              trx_rsk_ases_dt --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_04           a
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    b
on a.cst_ID=b.cst_id and a.trx_dt=b.dt
where b.dt between '20240201' and '20240229'
;
--定期理财+基金
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_07 AS
select T1.*
    ,T4.rsk_lvl_cd,T4.late_ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_01           T1		--理财交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024030541_CST_02      T2      --上次理财风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024030541_CST_03      T3      --交易时理财风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dwd_bus_chm_cst_rsk_ases_dd           T4 		--理财风评表
on T1.CST_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
union all
select T1.*
    ,T4.cst_rsk_grd_cd,T4.ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_04           T1      --基金交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024030541_CST_05      T2      --上次基金风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024030541_CST_06      T3      --交易时基金风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    T4      --基金风评表
on t1.cst_ID=t4.cst_ID and t4.dt='@@{yyyyMMdd}'
;
--关联其他字段（主表）
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_08 AS
SElECT T1.*
    ,T2.ta_name --发行机构
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    ,T7.credit_rsk_grd
    ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    ,T9.aum_avg_360d
    ,T10.aum_bal TRX_aum_bal
    ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ2024030541_CST_07   T1
left join edw.finc_tbtainfo                 T2 on t1.tacd=T2.ta_code  and T2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_ID=T3.cst_id and T3.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='@@{yyyyMMdd}'
left join (
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='@@{yyyyMMdd}'
) T7 on T1.CST_ID=T7.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.CST_ID=T8.cst_id and T8.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.CST_ID=T9.cst_id and T9.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
on T1.CST_ID=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20240201' and '20240229'
left join (
    SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
    inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '@@{yyyyMMdd}'
    WHERE a.dt between '20240201' and '20240229' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
    group by a.cst_id, a.dt
) t11 on T1.cst_ID=t11.cst_id and T1.trx_dt=t11.dt
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_09 AS
select distinct a.cst_ID,trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,b.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_08 a
left join edw.dws_cst_bas_inf_dd b
on a.cst_ID=b.cst_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd c
on b.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='@@{yyyyMMdd}'
and NVL(c.sam_rsk_ctrl_id,'')<>''
;
-- 前后15天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_10 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,rel_cust_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                         --贷款用途代码
    ,B.USG_CMT                             --用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt --贷款利率优惠备注
    ,case
        when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_09   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.CRC_IND <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '@@{yyyyMMdd}'
left outer join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '@@{yyyyMMdd}'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '@@{yyyyMMdd}'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_11 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_11 AS
select cst_ID,trx_dt
    ,a.rel_cst_id
    ,rel_cust_nm
    ,BUSI_CTR_ID                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,stdinr                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,INTR_RAT                            --执行利率
    ,REF_MON_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,a.REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,pre_ases_res
    ,HPN_TYP
    ,USG_CMT
    ,intr_rat_adj_cmt
    ,is_wfdk
    ,is_zc_loan
    ,lst_BUSI_CTR_ID
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.BUSI_CTR_ID            	lst_BUSI_CTR_ID
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.INTR_RAT                 lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ2024030541_CST_10
        where DIFF_TM<=15
    ) a
    left join lab_bigdata_dev.SJXQ_SJ2024030541_CST_10 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.pd_cd=b.pd_cd and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_12 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024030541_CST_12 AS
select a.bus_type              业务类型
    ,a.trx_type                交易类型
    ,a.srl_nbr                 交易流水号
    ,a.trx_sts                 交易状态
    ,concat(a.trx_dt,' ',a.trx_tm) 申请日期
    ,a.cfm_dt                  确认日期
    ,a.trx_chnl                交易渠道
    ,a.trx_amt                 交易金额
    ,a.cfm_amt                 确认金额
    ,a.trx_lot                 交易份额
    ,a.cfm_lot                 确认份额
    ,a.sale_empe_id            销售人员工号
    ,a.sale_empe_nm            销售人员姓名
    ,a.brc_org_nm              所属分行
    ,a.sbr_org_nm              所属支行
    ,a.tatrx_act_nbr           交易账号
    ,a.pd_cd                   产品代码
    ,a.pd_nm                   产品名称
    ,a.ta_name                 发行机构
    ,a.prod_type               产品类型
    ,a.pd_rsk_grd              产品风险等级
    ,a.pfm_comp_bas            业绩比较基准
    ,a.pd_found_dt             产品扣款日
    ,a.pd_val_dt               产品起息日
    ,a.pd_end_dt               产品到期日
    ,a.CST_ID                  客户号
    ,a.cst_nm                  客户名称
    ,a.age                     客户年龄
    ,a.gender                  客户性别
    ,''                        客户手机号码
    ,a.rsk_lvl_cd                                           	客户当前风险测评结果
    ,decode(a.late_ases_dt,'18991231','',a.late_ases_dt)    	客户当前结果测评时间
    ,a.lst_rsk_lvl                                          	客户上一次风险测评结果
    ,decode(a.lst_rsk_ases_dt,'18991231','',a.lst_rsk_ases_dt)  客户上一次风险测评时间
    ,a.trx_rsk_lvl                                              客户交易日风险等级
    ,decode(a.trx_rsk_ases_dt,'18991231','',a.trx_rsk_ases_dt)  客户交易日风险测评时间
    ,a.is_farm								是否农户
    ,a.efe_loan_cst_ind                     是否信贷有效户
    ,a.efe_dep_cst_ind                      是否存款有效户
    ,a.is_empe                              是否行内员工
    ,a.aum_avg_360d                         客户近一年AUM
    ,a.trx_ncr_fnd_bal                      客户交易时非货基金保有量
    ,a.TRX_aum_bal                          客户交易时AUM
    ,if(b.cst_ID is not null,'是','') 		交易日前后15天内同一风险控制号下是否存在贷款
    ,b.rel_cust_nm                  		贷款客户名称
    ,c.loan_apl_credit_rsk_grd      		当前贷款申请时客户信用风险等级
    ,a.credit_rsk_grd               		当前客户信用风险等级
    ,b.BUSI_CTR_ID                   		当前笔贷款合同流水号
    ,b.reg_dt                       		当前笔贷款申请日期
    ,b.DTRB_DT                      		当前笔贷款发放日期
    ,b.CTR_AMT                      		当前笔贷款金额
    ,ref_year_intr_rat              		当前笔贷款参考年利率
    ,INTR_RAT                       		当前笔贷款执行年利率
    ,aprv_exe_mon_intr_rat          		当前笔贷款执行月利率
    ,b.pre_ases_res                 		当前笔贷款预审批结果
    ,b.FIVE_CTG                     		当前笔贷款五级分类
    ,b.HPN_TYP                      		贷款类型
    ,b.is_zc_loan                   		是否为政策性贷款
    ,b.is_wfdk                      		是否为接力贷
    ,b.intr_rat_adj_cmt             		贷款利率优惠备注
    ,b.USG_CMT                      		贷款用途备注
    ,b.lst_BUSI_CTR_ID              		上一笔贷款合同流水号
    ,b.lst_CTR_AMT                  		上一笔贷款合同金额
    ,b.lst_INTR_RAT                 		上一笔贷款执行年利率
    ,b.lst_aprv_exe_mon_intr_rat    		上一笔贷款执行月利率
    ,b.lst_DTRB_DT                   		上一笔贷款发放日期
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_08       a
left join lab_bigdata_dev.SJXQ_SJ2024030541_CST_11  b
on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
left join (
    select distinct dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') loan_apl_credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt<='@@{yyyyMMdd}'
) c on b.rel_cst_id=c.cst_id and b.reg_dt=c.dt
;
SElECT '01' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_01
union all
SElECT '04' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_04
union all
SElECT '07' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_07
union all
SElECT '08' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_08
;
SElECT '02' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_02
union all
SElECT '03' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_03
union all
SElECT '05' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_05
union all
SElECT '06' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ2024030541_CST_06
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024030541_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024030541_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024030541_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 客户号,申请日期) custs
from SJXQ_SJ2024030541_CST_12
;
/*
01	4512	4265	4512
04	1109	1033	1109
07	5621	5285	5621
08	5621	5285	5621
02	2577	2577
03	4512	4512
05	277	277
06	1109	1109
09	7877	5285
10	12662	5285
11	25	25
12	5621	5621
*/***SJ2024030776_个体经营性贷款清单.sql
-- 个人客户，持有个人经营性贷款或用途为经营的随贷通卡（截至2023.12.31业务未到期），客户总授信&le;150万，剔除村行（代码参考附件）
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_01 AS
SELECT  t.cst_id
        ,sum(t.ctr_amt * t1.avg_prc / t1.quo_unt) AS sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd         t
INNER JOIN    edw.dim_bus_com_exr_inf_dd    t1 --汇率信息表
ON      t.ccy_cd = t1.ccy_cd --币种代码
AND     t1.dt = '20221231'
WHERE   t.dt = '20221231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08' OR t.pd_cd <> '201050101040335' )  --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319'                            --剔除 百度分期贷
AND
(
    (
        (t.ctr_bal > 0 OR (t.ctr_bal IS NULL AND nvl(t.crc_ind,'0')='0')
        OR ((nvl(t.crc_ind, '0') <> '0' OR t.pd_cd LIKE '2010503%')
            AND (t.ctr_bal = 0 OR t.ctr_bal IS NULL)
            AND t.apnt_mtu_dt >= '20221231')
        )
        AND nvl(t.frz_sts_cd,' ') NOT IN ( '3' , '4' )
    ) OR (t.ctr_bal > 0 AND t.pd_cd LIKE '2010503%' AND t.apnt_mtu_dt <= '20221231' AND t.frz_sts_cd IN ( '3' , '4' ))
) ----未终结、未到期业务
AND NOT EXISTS (
    SELECT  'x'
    FROM    edw.dim_bus_loan_ctr_inf_dd t2
    WHERE   t.busi_ctr_id = t2.busi_ctr_id
    AND     t2.dt = '20221231'
    AND     t2.pd_cd LIKE '2010503%'
    AND     t2.apnt_start_dt > t2.dt
) --剔除提前续卡随贷通
GROUP BY t.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_02 AS
SELECT  DISTINCT T.BUSI_CTR_ID
    ,T.CST_ID,t.cst_nm
    ,t3.brc_org_nm,t3.SBR_ORG_NM,t3.ORG_NM
    ,t4.sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd t
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t2
ON      t.cst_id = t2.cst_id
AND     t2.dt = '20221231'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
AND     t3.brc_org_nm ='温州分行'
INNER JOIN SJXQ_SJ2024030776_CST_01     t4
ON      t.cst_id = t4.cst_id
AND     t4.sum_ctr_amt <= 1500000
WHERE   t.dt = '20221231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08'
    OR t.pd_cd <> '201050101040335' ) --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332' --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319' --剔除百度分期贷
AND     ( t.pd_cd NOT IN ( '201050102010146' , '201050101040348' )
    OR t.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( ( ( t.ctr_bal > 0
    OR ( t.ctr_bal IS NULL
AND     nvl(t.crc_ind, '0') = '0' )
    OR ( ( nvl(t.crc_ind, '0') <> '0'
    OR t.pd_cd LIKE '2010503%' )
AND     ( t.ctr_bal = 0
    OR t.ctr_bal IS NULL )
AND     t.apnt_mtu_dt >= '20221231' ) )
AND     nvl(t.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
    OR ( t.ctr_bal > 0
AND     t.pd_cd LIKE '2010503%'
AND     t.apnt_mtu_dt <= '20221231'
AND     t.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
AND     t.pd_cd NOT LIKE '2010402%'
AND     ( t.pd_cd LIKE '201050102%'
    OR ( t.pd_cd LIKE '2010503%'
AND     t.loan_usg_cd LIKE '01%' ) ) ---个人一般经营性贷款、经营用途随贷通
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_03 AS
SELECT  t.cst_id
        ,sum(t.ctr_amt * t1.avg_prc / t1.quo_unt) AS sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd         t
INNER JOIN    edw.dim_bus_com_exr_inf_dd    t1 --汇率信息表
ON      t.ccy_cd = t1.ccy_cd --币种代码
AND     t1.dt = '20231231'
WHERE   t.dt = '20231231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08' OR t.pd_cd <> '201050101040335' )  --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319'                            --剔除 百度分期贷
AND
(
    (
        (t.ctr_bal > 0 OR (t.ctr_bal IS NULL AND nvl(t.crc_ind,'0')='0')
        OR ((nvl(t.crc_ind, '0') <> '0' OR t.pd_cd LIKE '2010503%')
            AND (t.ctr_bal = 0 OR t.ctr_bal IS NULL)
            AND t.apnt_mtu_dt >= '20231231')
        )
        AND nvl(t.frz_sts_cd,' ') NOT IN ( '3' , '4' )
    ) OR (t.ctr_bal > 0 AND t.pd_cd LIKE '2010503%' AND t.apnt_mtu_dt <= '20231231' AND t.frz_sts_cd IN ( '3' , '4' ))
) ----未终结、未到期业务
AND NOT EXISTS (
    SELECT  'x'
    FROM    edw.dim_bus_loan_ctr_inf_dd t2
    WHERE   t.busi_ctr_id = t2.busi_ctr_id
    AND     t2.dt = '20231231'
    AND     t2.pd_cd LIKE '2010503%'
    AND     t2.apnt_start_dt > t2.dt
) --剔除提前续卡随贷通
GROUP BY t.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_04 AS
SELECT  DISTINCT T.BUSI_CTR_ID
    ,T.CST_ID,t.cst_nm
    ,t3.brc_org_nm,t3.SBR_ORG_NM,t3.ORG_NM
    ,t4.sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd t
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t2
ON      t.cst_id = t2.cst_id
AND     t2.dt = '20231231'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231231'
AND     t3.brc_org_nm ='温州分行'
INNER JOIN SJXQ_SJ2024030776_CST_01     t4
ON      t.cst_id = t4.cst_id
AND     t4.sum_ctr_amt <= 1500000
WHERE   t.dt = '20231231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08'
    OR t.pd_cd <> '201050101040335' ) --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332' --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319' --剔除百度分期贷
AND     ( t.pd_cd NOT IN ( '201050102010146' , '201050101040348' )
    OR t.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( ( ( t.ctr_bal > 0
    OR ( t.ctr_bal IS NULL
AND     nvl(t.crc_ind, '0') = '0' )
    OR ( ( nvl(t.crc_ind, '0') <> '0'
    OR t.pd_cd LIKE '2010503%' )
AND     ( t.ctr_bal = 0
    OR t.ctr_bal IS NULL )
AND     t.apnt_mtu_dt >= '20231231' ) )
AND     nvl(t.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
    OR ( t.ctr_bal > 0
AND     t.pd_cd LIKE '2010503%'
AND     t.apnt_mtu_dt <= '20231231'
AND     t.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
AND     t.pd_cd NOT LIKE '2010402%'
AND     ( t.pd_cd LIKE '201050102%'
    OR ( t.pd_cd LIKE '2010503%'
AND     t.loan_usg_cd LIKE '01%' ) ) ---个人一般经营性贷款、经营用途随贷通
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_05 AS
SElECT '20221231' data_dt,t1.*
    ,t2.frs_crd_dt	        --首次授信日期
    ,t3.efe_loan_cst_ind	--有效信贷户标识
from SJXQ_SJ2024030776_CST_02                   t1
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd  t2 --客户集市-业务信息-贷款-授信与额度
on  t1.cst_id=t2.cst_id
and t2.dt = '20221231'
left join adm_pub.adm_csm_cbas_ind_inf_dd	    t3 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id=t3.cst_id
and t3.dt = '20221231'
union all
SElECT '20231231' data_dt,t1.*
    ,t2.frs_crd_dt	        --首次授信日期
    ,t3.efe_loan_cst_ind	--有效信贷户标识
from SJXQ_SJ2024030776_CST_04                   t1
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd  t2 --客户集市-业务信息-贷款-授信与额度
on  t1.cst_id=t2.cst_id
and t2.dt = '20231231'
left join adm_pub.adm_csm_cbas_ind_inf_dd	    t3 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id=t3.cst_id
and t3.dt = '20231231'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_06 AS
select data_dt          日期
    ,brc_org_nm 		管户分行
    ,sbr_org_nm         管户支行
    ,cst_id             客户号
    ,cst_nm             客户名称
    ,frs_crd_dt         首次授信时间
    ,efe_loan_cst_ind   是否有效信贷户
    ,busi_ctr_id        合同号
    ,sum_ctr_amt        合同金额
    ,org_nm             管户机构名称
from SJXQ_SJ2024030776_CST_05
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct data_dt,cst_id) custs
from SJXQ_SJ2024030776_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 日期,客户号) custs
from SJXQ_SJ2024030776_CST_06
;
/*
01	745933	745933
02	18747	14130
03	776077	776077
04	15774	12183
05	34521	26313
06	34521	26313
*/
***SJ2024030871_商机客户画像收集表.sql
-- 客户转化情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_01 AS
SELECT distinct case_no,case_name,case_phase,cst_id,exec_date
    ,rel_cst_id,is_slf,sample_class
    ,connect_chnl,sum_score,prm_fh_org_nm,is_convert
FROM LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_AFF_ANLS_DAPAN
WHERE CASE_PHASE='allround202401'
;
-- 客户名单
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_02 AS
SELECT t1.cst_id,score,brc_org_nm,rn,sample_typ,t2.is_convert
from lab_bigdata_dev.wushan_024547_khlx_waihu_20240131_EG   T1
LEFT JOIN(
    select cst_id,max(is_convert) is_convert --1转化 0 未转化
    FROM SJXQ_SJ2024030871_CST_01
    where CASE_NO = 'USE_CASE_14' --理财客户拉新
    group by cst_id
)T2 on t1.cst_id=t2.cst_id
union all
SELECT t1.cst_id,score,brc_org_nm,rn,sample_typ,t2.is_convert
from lab_bigdata_dev.wushan_024547_lswh_waihu_20240131_EG t1
LEFT JOIN(
    select cst_id,max(is_convert) is_convert --1转化 0 未转化
    FROM SJXQ_SJ2024030871_CST_01
    where CASE_NO = 'USE_CASE_12' --理财流失挽回
    group by cst_id
)T2 on t1.cst_id=t2.cst_id
;
-- 基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_03 AS
select t1.cst_id                                 --客户号
	,t1.cst_chn_nm                               --客户中文名称
	,t1.gdr_cd                                   --性别代码
    ,decode(t1.gdr_cd,'1','男','2','女','未知') gdr_nm
	,t1.age                                      --年龄
    ,CASE WHEN T1.AGE<=30 THEN '1 [0,30]'
        WHEN T1.AGE>30 AND T1.AGE<=40 THEN '2 (30,40]'
        WHEN T1.AGE>40 AND T1.AGE<=50 THEN '3 (40,50]'
        WHEN T1.AGE>50 AND T1.AGE<=60 THEN '4 (50,60]'
        WHEN T1.AGE>60 AND T1.AGE<=70 THEN '5 (60,70]'
        WHEN T1.AGE>70 THEN '6 70+' ELSE '' END AGE_GRD
	,t1.mrg_situ_cd                             --婚姻状况
	,t1.file_dt                                 --建档日期
    ,t2.ctr_dt                                  --理财签约日期
    ,t4.pd_hld_nbr                               --产品持有数
    ,case when t5.cst_id is not null then 1 else 0 end is_djk_cst
    ,case when t6.cst_id is not null then 1 else 0 end is_dfgz_cst
    ,t7.dep_bal_avg_6m
from adm_pub.adm_csm_cbas_idv_bas_inf_dd    t1  --客户集市-客户基础-对私客户基础信息
inner join SJXQ_SJ2024030871_CST_02         t0 on t1.cst_id=t0.cst_id
left join edw.dwd_bus_chm_ctr_inf_dd        t2  --理财客户签约信息
on  t1.cst_id=t2.cst_id
and t2.dt='20240307'
left join edw.dwd_bus_chm_cst_rsk_ases_dd   T3 	--理财风评表
on T1.CST_ID=T3.cst_id
and T3.dt='20240307'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd t4 --客户集市-标签信息-客户持有产品信息表
on T1.CST_ID=T4.cst_id
and t4.dt='20240307'
left join(
    select DISTINCT cst_id
    FROM    app_ado.FCT_CC_AR_DTL_SMY_DD
    WHERE   dt = '20240307'
    AND     crd_ctg_cd = '1' --贷记卡
    AND     cr_crd_sts_cd NOT IN ( 'Q' , '2' ) --剔除销户、到期未续
    AND     ac_sts_cd <> 'V' --剔除核销
)t5 on t1.cst_id=t5.cst_id
left join (
    SELECT  DISTINCT T2.CST_ID
    FROM    EDW.CORE_KDPL_ZHMINX                T1
    INNER JOIN    EDW.DWS_BUS_DEP_ACT_INF_DD    T2
    ON      T2.DEP_ACT_ID = T1.ZHANGHAO
    AND     T1.dt = T2.dt
    AND     T2.DT = '20240307'
    WHERE   T1.DT <= '20240307'
    AND     T1.ZHAIYODM = 'IB0047' --代发工资
)t6 on t1.cst_id=t6.cst_id
left join(
    select cst_id
        ,round(sum(last_180_days_gl_bal_acml)/180,2) dep_bal_avg_6m
    from   edw.dws_bus_dep_act_inf_dd
    where dt = '20240307'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
where T1.dt='20240307'
;
--外呼情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_04 AS
SElECT cst_id,call_dt,cst_res,CALL_STATUS
    ,ROW_NUMBER() over(partition by cst_id order by call_dt asc) rn  --拒接客户会2次电销，取最早一次
FROM(
    SElECT t1.cst_id,replace(substr(t2.call_end_tm,1,10),'-','') call_dt
    from(
        select t1.data_id,t1.custno cst_id           --客户号
        FROM    edw.cout_tb_outbound_data   t1 --新外呼数据表
        inner join edw.cout_tb_out_project  t2
        on  t1.project_id = t2.project_id
        and t2.project_name = '电销商机' -- project_id = '367'
        and t2.dt='20240307'
        WHERE t1.dt >= '20240205'   -- 二级项目名称 呼叫起始日期
        AND   t1.field3 = '淘金行动之工薪族一星客户中台外呼（年终奖场景）'
    ) t1 left join(
        SELECT T1.DAT_ID                                   --数据ID|C22
            ,t1.call_start_tm,t1.call_end_tm,t1.tlk_tm
            ,CASE
                WHEN T2.DIC_VALUE = '有效接通' OR ( T2.DIC_VALUE = '话务条异常' AND T1.DEAL_OPNN_SYS_CHC_CNTNT IN ( '分期成功' , '可再次追踪' ) ) THEN '有效接通'
                WHEN T2.DIC_VALUE IS NULL AND T1.DEAL_OPNN_SYS_CHC_CNTNT IS NULL                                                THEN '未外呼'
                ELSE '无效外呼' END     CALL_STATUS      --外呼状态/是否有效接通
            ,concat(T1.CST_OPNN,T1.RFS_RSN,T1.DEAL_OPNN_SYS_CHC_CNTNT) cst_res
        from edw.dwd_bus_cmpn_cout_rcd_di           t1  --人工外呼外拨记录
        LEFT JOIN EDW.COUT_TB_OUTBOUND_SERVERSULT   T2
        ON      T1.CALL_RSL = T2.ID
        AND     T2.DT = '20240307'
        where t1.dt>='20240205'
    )t2 on t1.data_id=t2.dat_id
    group by t1.cst_id,call_dt
)A
;
-- 开户天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_05 AS
select t2.dep_act_id,t2.act_nm,t2.cst_act_id,t2.cst_id
    ,t2.opn_dt,t2.ACT_STS_CD
from SJXQ_SJ2024030871_CST_02           t1
INNER join edw.DIM_BUS_DEP_ACT_INF_DD   t2
on  t1.cst_id=t2.cst_id
and t2.dt='20240307'
and t2.ACT_CTG_CD_2 = '301'  --I类账户
-- and t2.stl_act_ind='1'       --结算账户
and t2.ACT_STS_CD <> 'C'
AND t2.ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' ) --账户状态正常
;
-- 安装金融理财app的数量
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_06 AS
select t1.cst_ID,t2.fina_app_cnt_1y
from SJXQ_SJ2024030871_CST_02           t1
inner join(
    select t2.cst_id,count(distinct t2.package_name) fina_app_cnt_1y
    from wushan_adm_papp_app_data_di        t2
    inner join edw.nout_app_class_info      t3
    on lower(trim(t2.package_name)) = lower(trim(t3.pkg_name)) -- app分类表
    and t3.dt='20240307'
    and t3.category_name = '金融理财'
    where t2.dt<='20240307'
    group by t2.cst_id
)T2 on  t1.cst_ID=t2.cst_id
;
-- 借记卡 近六个月交易次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_07 AS
SELECT T1.CST_ID
    ,count(case when t3.trx_amt>0 then t3.dtl_seq_nbr end)              trx_cnt_6m
    ,max(case when t3.crd_and_dbt_ind='C' then t3.trx_amt else 0 end)   max_in_amt_6m
FROM SJXQ_SJ2024030871_CST_02               T1
INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD       T2  --客户都在
ON  T1.CST_ID=T2.CST_ID
AND T2.DT='20240307'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3  --交易表
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T3.DT<='20240307'
group by T1.CST_ID
;
--近六个月手机银行登录次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_08 AS
select t1.alg_userid   cst_id
    ,count(T1.dt)      login_cnt_6m
from edw.ebnk_mb_audit_log          T1
inner join SJXQ_SJ2024030871_CST_02 t2
on t1.alg_userid=t2.cst_id
and T1.dt<='20240307'
and T1.ALG_BSNCODE='100001'
AND T1.ALG_ERRORCODE IS NULL
and T1.ALG_SYSID ='MBC'
AND LENGTH(T1.ALG_USERID) = 10
group by T1.alg_userid
;
-- 近三个月浏览理财页面次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_09 AS
SELECT  a.distinct_id cst_id
        ,a.event
        ,a.time
        ,a.a_event_duration duration
        ,a.product_id
        ,a.product_name
        ,a.click_name
        ,a.is_success
        ,a.page_name
FROM    edw.aubs_events_ibnk        a
inner join SJXQ_SJ2024030871_CST_02 t2
on a.distinct_id=t2.cst_id
AND     a.event REGEXP '^financial'
AND     a.event REGEXP '_pageview$'
;
--历史购买理财次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_10 AS
SELECT t1.cst_id          --cst_ID
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on  t1.pd_cd=t2.pd_cd
and t2.dt='20240307'
inner join SJXQ_SJ2024030871_CST_02     t3
on  t1.cst_id=t3.cst_id
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt <='20240307'
;
--结果字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_11 AS
SElECT t1.cst_id,T1.brc_org_nm,t1.sample_typ,t1.is_convert
    ,t3.cst_chn_nm,t3.gdr_nm,t3.age,t3.AGE_GRD
    ,t3.ctr_dt                                  --理财签约日期
    ,t3.fina_ctr_days
    ,t3.fina_rsk_lvl
    ,t3.pd_hld_nbr                               --产品持有数
    ,t3.is_djk_cst,t3.is_dfgz_cst,t3.dep_bal_avg_6m
    ,t4.call_dt,t4.cst_res,t4.CALL_STATUS
    ,t5.opn_days
    ,t6.fina_app_cnt_1y
    ,t7.trx_cnt_6m,t7.max_in_amt_6m
    ,t8.login_cnt_6m,t9.view_fina_cnt_3m
    ,t10.fina_trx_cnt,t10.bf_jkq_buy_amt,t10.fina_trx_cnt_1y
    ,t10.max_trx_amt,t10.jkq_hq_fina_buy_amt,t10.jkq_dq_fina_buy_amt
from SJXQ_SJ2024030871_CST_02       t1
left join SJXQ_SJ2024030871_CST_03  t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024030871_CST_04  t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join (
    select cst_id,max(opn_days) opn_days
    from SJXQ_SJ2024030871_CST_05
    GROUP by cst_id
)t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2024030871_CST_06  t6 on t1.cst_id=t6.cst_id
left join SJXQ_SJ2024030871_CST_07  t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ2024030871_CST_08  t8 on t1.cst_id=t8.cst_id
left join(
    SElECT cst_id,count(a.event) view_fina_cnt_3m
    from SJXQ_SJ2024030871_CST_09 a
    group by cst_id
)t9 on t1.cst_id=t9.cst_id
left join(
    SElECT cst_id,count(1) fina_trx_cnt
        ,sum(case when trx_dt<'20240205' then cfm_amt else 0 end)   bf_jkq_buy_amt
        ,sum(case when trx_dt>='20230307' then 1 else 0 end)        fina_trx_cnt_1y
        ,max(cfm_amt) max_trx_amt
        ,sum(case when trx_dt>='20240205' and is_fix=0 then cfm_amt else 0 end)  jkq_hq_fina_buy_amt
        ,sum(case when trx_dt>='20240205' and is_fix=1 then cfm_amt else 0 end)  jkq_dq_fina_buy_amt
    from SJXQ_SJ2024030871_CST_10
    where cfm_amt>0
    group by cst_id
)t10 on t1.cst_id=t10.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST_12 AS
SElECT cst_id                   客户号
    ,cst_chn_nm                 客户名称
    ,brc_org_nm                 所属分行
    ,gdr_nm                     性别
    ,AGE_GRD                    年龄层
    ,is_convert                 是否成功转化
    ,cst_res                    呼叫小结
    ,CALL_STATUS                呼叫状态
    ,fina_ctr_days              理财签约天数
    ,fina_rsk_lvl               理财风评
    ,pd_hld_nbr                 产品持有数
    ,is_djk_cst                 是否持有贷记卡
    ,is_dfgz_cst                是否代发工资户
    ,dep_bal_avg_6m             近六个月存款日均
    ,opn_days                   I类卡开户天数
    ,fina_app_cnt_1y       安装金融理财app的数量
    ,trx_cnt_6m                 近六个月交易次数
    ,max_in_amt_6m              近六个月流入最高金额
    ,login_cnt_6m               近六个月手机银行登录次数
    ,view_fina_cnt_3m           近三个月浏览理财页面次数
    ,case when bf_jkq_buy_amt>0 then '是' else '否' end 监测期前是否购买过理财
    ,fina_trx_cnt_1y            近一年的理财交易笔数
    ,max_trx_amt                历史理财投资单笔最大金额
    ,jkq_hq_fina_buy_amt        监测期内活期理财累计购买金额
    ,jkq_dq_fina_buy_amt        监测期内定期理财购买金额
    ,''                         近六个月线上便利支付总笔数
    ,''                         近六个月线上便利支付总金额
    ,''                         近六个月餐饮交易总笔数
    ,''                         近六个月母婴交易总笔数
    ,''                         近六个月影视交易总笔数
from SJXQ_SJ2024030871_CST_11
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_06
union all
SElECT 'app' seq, count(1) cnt, count(distinct cst_id) custs
from LAB_BIGDATA_DEV.APP_SAMPLE
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_08
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024030871_CST_12
;
/*
01	4366	3631
02	2000	2000
03	2000	2000
04	1895	1895
05	2292	1996
06	843	843
07	1964	1964
08	1710	1710
09	55778	840
10	43065	1154
11	2067	2000
12	2067	2000
app	979	979
*/
***SJ2024030871_商机客户画像收集表20240131.sql
-- 客户转化情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_01 AS
SELECT distinct case_no,case_name,case_phase,cst_id,exec_date
    ,rel_cst_id,is_slf,sample_class
    ,connect_chnl,sum_score,prm_fh_org_nm,is_convert
    ,call_rslt              --外呼小结
    ,call_status            --外呼状态
FROM LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_AFF_ANLS_DAPAN
WHERE CASE_PHASE='allround202401'
;
-- 客户名单
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_02 AS
SELECT '理财客户拉新' CASE_NM,t1.cst_id,t1.score,t1.brc_org_nm,t1.rn,t1.sample_typ
    ,t2.is_convert,t2.call_rslt,t2.call_status
from lab_bigdata_dev.wushan_024547_khlx_waihu_20240131_EG   T1
LEFT JOIN(
    select cst_id,max(is_convert)       is_convert --1转化 0 未转化
        ,min(call_status)                       call_status
    FROM SJXQ_SJ2024030871_CST2_01
    where CASE_NO = 'USE_CASE_14' --理财客户拉新
    group by cst_id
)T2 on t1.cst_id=t2.cst_id
union all
SELECT '理财流失挽回' CASE_NM,t1.cst_id,t1.score,t1.brc_org_nm,t1.rn,t1.sample_typ
    ,t2.is_convert,t2.call_rslt,t2.call_status
from lab_bigdata_dev.wushan_024547_lswh_waihu_20240131_EG t1
LEFT JOIN(
    select cst_id,max(is_convert)       is_convert --1转化 0 未转化
        ,min(call_status)                       call_status
    FROM SJXQ_SJ2024030871_CST2_01
    where CASE_NO = 'USE_CASE_12' --理财流失挽回
    group by cst_id
)T2 on t1.cst_id=t2.cst_id
;
-- 基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_03 AS
select t1.cst_id                                 --客户号
	,t1.cst_chn_nm                               --客户中文名称
	,t1.gdr_cd                                   --性别代码
    ,decode(t1.gdr_cd,'1','男','2','女','未知') gdr_nm
	,t1.age                                      --年龄
    ,CASE WHEN T1.AGE<=30 THEN '1 [0,30]'
        WHEN T1.AGE>30 AND T1.AGE<=40 THEN '2 (30,40]'
        WHEN T1.AGE>40 AND T1.AGE<=50 THEN '3 (40,50]'
        WHEN T1.AGE>50 AND T1.AGE<=60 THEN '4 (50,60]'
        WHEN T1.AGE>60 AND T1.AGE<=70 THEN '5 (60,70]'
        WHEN T1.AGE>70 THEN '6 70+' ELSE '' END AGE_GRD
	,t1.mrg_situ_cd                             --婚姻状况
	,t1.file_dt                                 --建档日期
    ,t2.ctr_dt                                  --理财签约日期
    ,t4.pd_hld_nbr                               --产品持有数
    ,case when t5.cst_id is not null then 1 else 0 end is_djk_cst
    ,case when t6.cst_id is not null then 1 else 0 end is_dfgz_cst
    ,t7.dep_bal_avg_6m
from adm_pub.adm_csm_cbas_idv_bas_inf_dd    t1  --客户集市-客户基础-对私客户基础信息
inner join SJXQ_SJ2024030871_CST2_02        t0
on t1.cst_id=t0.cst_id
left join edw.dwd_bus_chm_ctr_inf_dd        t2  --理财客户签约信息
on  t1.cst_id=t2.cst_id
and t2.dt='20240131'
left join edw.dwd_bus_chm_cst_rsk_ases_dd   T3 	--理财风评表
on T1.CST_ID=T3.cst_id
and T3.dt='20240131'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd t4 --客户集市-标签信息-客户持有产品信息表
on T1.CST_ID=T4.cst_id
and t4.dt='20240131'
left join(
    select DISTINCT cst_id
    FROM    app_ado.FCT_CC_AR_DTL_SMY_DD
    WHERE   dt = '20240131'
    AND     crd_ctg_cd = '1' --贷记卡
    AND     cr_crd_sts_cd NOT IN ( 'Q' , '2' ) --剔除销户、到期未续
    AND     ac_sts_cd <> 'V' --剔除核销
)t5 on t1.cst_id=t5.cst_id
left join (
    SELECT  DISTINCT T2.CST_ID
    FROM    EDW.CORE_KDPL_ZHMINX                T1
    INNER JOIN    EDW.DWS_BUS_DEP_ACT_INF_DD    T2
    ON      T2.DEP_ACT_ID = T1.ZHANGHAO
    AND     T1.dt = T2.dt
    AND     T2.DT = '20240131'
    WHERE   T1.DT <= '20240131'
    AND     T1.ZHAIYODM = 'IB0047' --代发工资
)t6 on t1.cst_id=t6.cst_id
left join(
    select cst_id
        ,round(sum(last_180_days_gl_bal_acml)/180,2) dep_bal_avg_6m
    from   edw.dws_bus_dep_act_inf_dd
    where dt = '20240131'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
where T1.dt='20240131'
;
--外呼情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_04 AS
SElECT cst_id,call_dt,cst_res,CALL_STATUS
    ,ROW_NUMBER() over(partition by cst_id order by call_dt asc) rn  --拒接客户会2次电销，取最早一次
FROM(
    SElECT t1.cst_id,replace(substr(t2.call_end_tm,1,10),'-','') call_dt
    from(
        select t1.data_id,t1.custno cst_id           --客户号
        FROM    edw.cout_tb_outbound_data   t1 --新外呼数据表
        inner join edw.cout_tb_out_project  t2
        on  t1.project_id = t2.project_id
        and t2.project_name = '电销商机' -- project_id = '367'
        and t2.dt='20240307'
        WHERE t1.dt >= '20240205'   -- 二级项目名称 呼叫起始日期
        AND   t1.field3 = '淘金行动之工薪族一星客户中台外呼（年终奖场景）'
    ) t1 left join(
        SELECT T1.DAT_ID                                   --数据ID|C22
            ,t1.call_start_tm,t1.call_end_tm,t1.tlk_tm
            ,CASE
                WHEN T2.DIC_VALUE = '有效接通' OR ( T2.DIC_VALUE = '话务条异常' AND T1.DEAL_OPNN_SYS_CHC_CNTNT IN ( '分期成功' , '可再次追踪' ) ) THEN '有效接通'
                WHEN T2.DIC_VALUE IS NULL AND T1.DEAL_OPNN_SYS_CHC_CNTNT IS NULL                                                THEN '未外呼'
                ELSE '无效外呼' END     CALL_STATUS      --外呼状态/是否有效接通
            ,concat(T1.CST_OPNN,T1.RFS_RSN,T1.DEAL_OPNN_SYS_CHC_CNTNT) cst_res
        from edw.dwd_bus_cmpn_cout_rcd_di           t1  --人工外呼外拨记录
        LEFT JOIN EDW.COUT_TB_OUTBOUND_SERVERSULT   T2
        ON      T1.CALL_RSL = T2.ID
        AND     T2.DT = '20240307'
        where t1.dt>='20240205'
    )t2 on t1.data_id=t2.dat_id
    group by t1.cst_id,call_dt
)A
;
-- 开户天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_05 AS
select t2.dep_act_id,t2.act_nm,t2.cst_act_id,t2.cst_id
    ,t2.opn_dt,t2.ACT_STS_CD
from SJXQ_SJ2024030871_CST2_02          t1
INNER join edw.DIM_BUS_DEP_ACT_INF_DD   t2
on  t1.cst_id=t2.cst_id
and t2.dt='20240131'
and t2.ACT_CTG_CD_2 = '301'  --I类账户
-- and t2.stl_act_ind='1'       --结算账户
and t2.ACT_STS_CD <> 'C'
AND t2.ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' ) --账户状态正常
;
-- 安装金融理财app的数量
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_06 AS
select t1.cst_ID,t2.fina_app_cnt_1y
from SJXQ_SJ2024030871_CST2_02              t1
inner join(
    select t2.cst_id,count(distinct t2.package_name) fina_app_cnt_1y
    from wushan_adm_papp_app_data_di        t2
    inner join edw.nout_app_class_info      t3
    on lower(trim(t2.package_name)) = lower(trim(t3.pkg_name)) -- app分类表
    and t3.dt='20240131'
    and t3.category_name = '金融理财'
    where t2.dt<='20240131'
    group by t2.cst_id
)T2 on  t1.cst_ID=t2.cst_id
;
-- 借记卡 近六个月交易次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_07 AS
SELECT T1.CST_ID
    ,count(case when t3.trx_amt>0 then t3.dtl_seq_nbr end)              trx_cnt_6m
    ,max(case when t3.crd_and_dbt_ind='C' then t3.trx_amt else 0 end)   max_in_amt_6m
FROM SJXQ_SJ2024030871_CST2_02              T1
INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD       T2  --客户都在
ON  T1.CST_ID=T2.CST_ID
AND T2.DT='20240131'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3  --交易表
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T3.DT<='20240131'
group by T1.CST_ID
;
--近六个月手机银行登录次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_08 AS
select t1.alg_userid   cst_id
    ,count(T1.dt)      login_cnt_6m
from edw.ebnk_mb_audit_log              T1
inner join SJXQ_SJ2024030871_CST2_02    t2
on t1.alg_userid=t2.cst_id
and T1.dt<='20240131'
and T1.ALG_BSNCODE='100001'
AND T1.ALG_ERRORCODE IS NULL
and T1.ALG_SYSID ='MBC'
AND LENGTH(T1.ALG_USERID) = 10
group by T1.alg_userid
;
-- 近三个月浏览理财页面次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_09 AS
SELECT  a.distinct_id cst_id
        ,a.event
        ,a.time
        ,a.a_event_duration duration
        ,a.product_id
        ,a.product_name
        ,a.click_name
        ,a.is_success
        ,a.page_name
FROM    edw.aubs_events_ibnk            a
inner join SJXQ_SJ2024030871_CST2_02    t2
on a.distinct_id=t2.cst_id
AND     a.event REGEXP '^financial'
AND     a.event REGEXP '_pageview$'
;
--历史购买理财次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_10 AS
SELECT t1.cst_id          --cst_ID
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on  t1.pd_cd=t2.pd_cd
and t2.dt='20240131'
inner join SJXQ_SJ2024030871_CST2_02    t3
on  t1.cst_id=t3.cst_id
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt <='20240131'
;
--结果字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_11 AS
SElECT t1.case_nm,t1.cst_id,T1.brc_org_nm,t1.sample_typ,t1.is_convert
    ,t1.call_rslt,t1.call_status
    ,t3.cst_chn_nm,t3.gdr_nm,t3.age,t3.AGE_GRD
    ,t3.ctr_dt                                  --理财签约日期
    ,t3.fina_ctr_days
    ,t3.fina_rsk_lvl
    ,t3.pd_hld_nbr                               --产品持有数
    ,t3.is_djk_cst,t3.is_dfgz_cst,t3.dep_bal_avg_6m
    ,t4.call_dt,t4.cst_res,t4.CALL_STATUS CALL_STATUS_old
    ,t5.opn_days
    ,t6.fina_app_cnt_1y
    ,t7.trx_cnt_6m,t7.max_in_amt_6m
    ,t8.login_cnt_6m,t9.view_fina_cnt_3m
    ,t10.fina_trx_cnt,t10.bf_jkq_buy_amt,t10.fina_trx_cnt_1y
    ,t10.max_trx_amt,t10.jkq_hq_fina_buy_amt,t10.jkq_dq_fina_buy_amt
from SJXQ_SJ2024030871_CST2_02       t1
left join SJXQ_SJ2024030871_CST2_03  t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024030871_CST2_04  t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join (
    select cst_id,max(opn_days) opn_days
    from SJXQ_SJ2024030871_CST2_05
    GROUP by cst_id
)t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2024030871_CST2_06  t6 on t1.cst_id=t6.cst_id
left join SJXQ_SJ2024030871_CST2_07  t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ2024030871_CST2_08  t8 on t1.cst_id=t8.cst_id
left join(
    SElECT cst_id,count(a.event) view_fina_cnt_3m
    from SJXQ_SJ2024030871_CST2_09 a
    group by cst_id
)t9 on t1.cst_id=t9.cst_id
left join(
    SElECT cst_id,count(1) fina_trx_cnt
        ,sum(case when trx_dt<'20240205' then cfm_amt else 0 end)   bf_jkq_buy_amt
        ,max(cfm_amt) max_trx_amt
        ,sum(case when trx_dt>='20240205' and is_fix=0 then cfm_amt else 0 end)  jkq_hq_fina_buy_amt
        ,sum(case when trx_dt>='20240205' and is_fix=1 then cfm_amt else 0 end)  jkq_dq_fina_buy_amt
    from SJXQ_SJ2024030871_CST2_10
    where cfm_amt>0
    group by cst_id
)t10 on t1.cst_id=t10.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024030871_CST2_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030871_CST2_12 AS
SElECT case_nm                  案例名称
    ,cst_id                     客户号
    ,cst_chn_nm                 客户名称
    ,brc_org_nm                 所属分行
    ,gdr_nm                     性别
    ,AGE_GRD                    年龄层
    ,is_convert                 是否成功转化
    ,call_rslt                  呼叫小结
    ,CALL_STATUS                呼叫状态
    ,fina_ctr_days              理财签约天数
    ,fina_rsk_lvl               理财风评
    ,pd_hld_nbr                 产品持有数
    ,is_djk_cst                 是否持有贷记卡
    ,is_dfgz_cst                是否代发工资户
    ,dep_bal_avg_6m             近六个月存款日均
    ,opn_days                   I类卡开户天数
    ,fina_app_cnt_1y            安装金融理财app的数量
    ,trx_cnt_6m                 近六个月交易次数
    ,max_in_amt_6m              近六个月流入最高金额
    ,login_cnt_6m               近六个月手机银行登录次数
    ,view_fina_cnt_3m           近三个月浏览理财页面次数
    ,case when bf_jkq_buy_amt>0 then '是' else '否' end 监测期前是否购买过理财
    ,fina_trx_cnt_1y            近一年的理财交易笔数
    ,max_trx_amt                历史理财投资单笔最大金额
    ,jkq_hq_fina_buy_amt        监测期内活期理财累计购买金额
    ,jkq_dq_fina_buy_amt        监测期内定期理财购买金额
    ,''                         近六个月线上便利支付总笔数
    ,''                         近六个月线上便利支付总金额
    ,''                         近六个月餐饮交易总笔数
    ,''                         近六个月母婴交易总笔数
    ,''                         近六个月影视交易总笔数
from SJXQ_SJ2024030871_CST2_11 t1
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_06
union all
SElECT 'app' seq, count(1) cnt, count(distinct cst_id) custs
from LAB_BIGDATA_DEV.APP_SAMPLE
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_08
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030871_CST2_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024030871_CST2_12
;
/*
01	4360	3631
02	2000	2000
03	2000	2000
04	1895	1895
05	2294	1997
06	840	840
07	1961	1961
08	1703	1703
09	43249	754
10	41070	1122
11	2000	2000
12	2000	2000
app	979	979
*/
***SJ2024031116_上海统计局年报.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024031116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031116_CST_01 AS
select t1.prod_cd pd_cd                          --产品代码|c32
	,t1.cst_id                                   --客户号|c32
	,t1.tot_lot                                  --总份额|decimal(16,2)
	,t1.tot_amt                                  --总金额|decimal(16,2)
	,t1.cst_typ_cd                               --客户类型代码 '1','个人','2','机构'
	,t1.crt_tm                                   --创建时间|timestamp
    ,t2.pd_nm
    ,case when t2.qdii_ind = '1' then 1 else 0 end is_qdii
    ,t3.prm_org_nm
    ,case when t3.prm_org_id like '3101%' then 1 else 0 end is_shanghai
from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd    t1  --基金账户份额信息
left join edw.dim_bus_chm_fnd_pd_inf_dd        t2  --基金产品基础信息表
on  t1.prod_cd = t2.pd_cd
and t2.dt='20231231'
left join adm_pub.adm_csm_cbas_mng_inf_dd      t3  --客户`管户`基础信息
on  t1.cst_id=t3.cst_id
and t3.dt='20231231'
where t1.dt='20231231'
;
SElECT pd_cd    基金产品代码
    ,pd_nm      基金产品名称
    ,sum(case when cst_typ_cd='1' then tot_amt else 0 end) 个人投资者余额
    ,sum(case when cst_typ_cd='2' then tot_amt else 0 end) 机构投资者余额
from SJXQ_SJ2024031116_CST_01
where is_qdii=1 and is_shanghai=1
group by pd_cd,pd_nm
order by pd_cd
;
/*
005676	易方达高端消费人民币C	387.56022	0
006075	博时标普500ETF联接C	73415.410418	0
006328	易方达中概ETF联接人民币C	7595.307087	0
007361	易方达中短美元债人民币C	60184.081716	0
008763	天弘越南市场A	9087.63824	0
013308	易方达恒生科技ETF联接A	20245.124445	0
013309	易方达恒生科技ETF联接C	1119295.212534	9023578.623663
016055	博时纳斯达克100ETF发起联接QDIIA人民币	127357.99626	0
016057	博时纳斯达克100ETF发起联接QDIIC人民币	17575.785918	0
050025	博时标普500ETF联接A	12683.52699	0
110011	易方达优质精选混合	6769.069705	0
118002	易方达高端消费人民币A	4200.95027	0
*/***SJ2024031346_积分旅程产效监测.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024031346_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031346_CST_01 AS
SELECT data_src,cst_id
    ,replace(substr(data_dt,1,10),'-','')   data_dt
    ,cast(free_intgral as int)              free_intgral
    ,cast(use_crdt as int)                  use_crdt
    ,cast(free_intgral_crdt as int)         free_intgral_crdt
FROM qbi_file_20240320_14_21_15
;
--表1
DROP   TABLE IF     EXISTS SJXQ_SJ2024031346_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031346_CST_02 AS
SElECT t1.cst_id
    ,t1.data_dt             开立理财账户日期
    ,t1.free_intgral        赠送分值_3888
    ,t2.cprh_contri_12m     开立账户前一日客户价值
    ,t3.cprh_contri_12m     开立账户后30天客户价值
    ,t3.whth_fee_12m        开立账户后30天客户价值中财富收入
    ,t4.fnc_mon_avg_amt	 	开立账户前一日理财月日均余额
    ,t5.fnc_mon_avg_amt	 	开立账户后30天理财月日均余额
from LAB_BIGDATA_DEV.SJXQ_SJ2024031346_CST_01           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd       t4 --客户金融资产信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd       t5 --客户金融资产信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.data_src='1'
;
--表2
DROP   TABLE IF     EXISTS SJXQ_SJ2024031346_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031346_CST_03 AS
SElECT t1.cst_id
    ,t1.data_dt                     首次申请泰2日期
    ,t1.free_intgral                赠送分值_3888
    ,t1.use_crdt                    是否用信
    ,t1.free_intgral_crdt           用信赠送分值_5888
    ,t2.cprh_contri_12m             申请前一日客户价值
    ,t3.cprh_contri_12m             申请后30天客户价值
    ,t6.cur_year_loan_ftp_inc       申请后30天当年贷款FTP利润收入
    ,t4.loan_bal_acs_mon_avg        申请前一日贷款余额月日均
    ,t5.loan_bal_acs_mon_avg        申请后30天贷款余额月日均
from LAB_BIGDATA_DEV.SJXQ_SJ2024031346_CST_01           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t4 --客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t5 --客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_ftp_inf_dd	            t6 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t6.cst_id
and t6.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.data_src='2'
;
--表3 首笔一般贷款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024031346_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031346_CST_04 AS
SElECT t.cst_id,t.free_intgral
	,min(t3.dtrb_dt)    data_dt    --发生日期|C8
from LAB_BIGDATA_DEV.SJXQ_SJ2024031346_CST_01           t
LEFT JOIN    edw.dwd_bus_loan_apl_inf_dd t1 --信贷业务申请信息表
ON      t.cst_id = t1.cst_id
AND     t1.dt = '@@{yyyyMMdd}'
AND     ( substr(t1.pd_id, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
		OR substr(t1.pd_id, 1, 7) = '2010503' ) 		--一般贷款
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd t2 --信贷合同信息
ON      t.cst_id = t2.cst_id
AND     t1.apl_id = t2.busi_apl_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) 			--剔除 员工贷款
AND     ( t2.chnl_cd <> 'L08'     OR t2.pd_cd <> '201050101040335' ) 	--剔除 小鱼分期
AND     t2.pd_cd <> '201050101040332' 									--剔除 蚂蚁借呗
AND     t2.pd_cd <> '201050101040319' 									--剔除 百度分期贷
AND     ( t2.pd_cd NOT IN ( '201050102010146' , '201050101040348' ) OR t2.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( substr(t2.pd_cd, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
    OR substr(t2.pd_cd, 1, 7) = '2010503' ) --一般贷款
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd t3 --贷款借据信息汇总
ON      t.cst_id = t3.cst_id
AND     t2.busi_ctr_id = t3.bus_ctr_id
AND     t3.dt = '@@{yyyyMMdd}'
-- AND     t3.dtrb_dt >= '20231001' --发放日期
where t.data_src='3'
group by t.cst_id,t.free_intgral
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031346_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031346_CST_05 AS
SElECT t1.cst_id
    ,t1.data_dt                     首笔一般贷款日期
    ,t1.free_intgral                达标赠送积分_8888积分
    ,t2.cprh_contri_12m             申请前一日客户价值
    ,t3.cprh_contri_12m             申请后30天客户价值
    ,t6.cur_year_loan_ftp_inc       申请后30天当年贷款FTP利润收入
    ,t4.loan_bal_acs_mon_avg        申请前一日贷款余额月日均
    ,t5.loan_bal_acs_mon_avg        申请后30天贷款余额月日均
    ,t4.loan_mon_avg                申请前一日一般贷款余额月日均
    ,t5.loan_mon_avg                申请后30天一般贷款余额月日均
from LAB_BIGDATA_DEV.SJXQ_SJ2024031346_CST_04           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t4 --客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t5 --客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_ftp_inf_dd	            t6 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t6.cst_id
and t6.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024031346_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024031346_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024031346_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024031346_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024031346_CST_05
;
01	3451	3362
02	1582	1582
03	1695	1695
04	174	174
05	174	174
***SJ2024031561_台州黄金展.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024031561_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031561_CST_01 AS
SElECT T1.seq,T1.card_id
    ,cst_act_nm                               --客户账户名称|C200
	,act_sts_cd                               --账户状态代码|C1
    ,c1.cd_val_dscr     act_sts_nm
	,cst_id                                   --客户编号|C20
	,opn_dt                                   --开户日期|C8
FROM qbi_file_20240318_10_54_38             T1
left join edw.dim_bus_dep_cst_act_inf_dd    t2        --客户存款账户信息
ON T1.card_id=T2.cst_act_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t2.act_sts_cd=c1.cd_val
and c1.dt='20240131'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031561_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031561_CST_02 AS
SElECT seq              序号
    ,card_id            卡号
    ,cst_act_nm         客户名称
	,act_sts_nm         账户状态代码
	,cst_id             客户号
	,opn_dt             开户日期
FROM SJXQ_SJ2024031561_CST_01
;
SElECT '01' seq, count(1) cnt, count(distinct card_id) custs
from SJXQ_SJ2024031561_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct 卡号) custs
from SJXQ_SJ2024031561_CST_02
;
/*
01	517	517
02	517	517
*/***SJ2024031566_日落集市手续费调账.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_01 AS
SElECT t1.data_src,t1.mcht_id,t1.mcht_nm,t1.act_id
    ,t2.ecif_client_no  cst_id
    ,t2.mcht_name         --商户名称
    ,t2.mcht_simple_name  --商户简称
    ,t2.mcht_mng_no	      --上级商户号
    ,t2.mcht_org_id       --机构号
    ,t2.mcht_amr_no       --客户经理工号
    ,t2.mcht_amr_name     --客户经理姓名
FROM qbi_file_20240318_13_45_49       t1
left join edw.dpss_pbs_mcht_base_info t2             --商户基本信息表
on t1.mcht_id=t2.MCHT_ID
and t2.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_02 AS
select t1.dt,t1.cst_id
    ,t1.dmnd_dep_bal_mon_avg	--活期存款余额月日均
from adm_pub.adm_csm_cbus_dep_inf_dd    t1	--客户集市-业务信息-客户存款业务信息表
INNER join SJXQ_SJ2024031566_CST_01     t2 on t1.cst_id=t2.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_03 AS
select t1.mcht_id
    ,t2.txn_seq_id                               --内部流水号
	,t2.txn_sub_type                             --交易子类型：010001:普通支付;010002:担保支付;010003:快捷支付（接口类）;030001:交易状态查询(支持：支付、退货等);040001:退货交易;051001：普通代收交易;030501：普通代收交易;
	,t2.txn_order_id                             --订单号(外部系统流水号)
    ,t2.txn_dt
    ,t2.dt
	-- ,t2.txn_amt                                  --交易支付金额(包含：消费、退货、撤销,交易单位为分，例:1.23元=123)
    ,CASE WHEN sign(nvl(t2.TXN_AMT,0) - 100) = -1 THEN nvl(t2.TXN_AMT, 0) / 100
        ELSE t2.TXN_AMT / 100 END           TXN_AMT
    ,CASE WHEN sign(nvl(t3.FEE_IN_AMT, 0) - 100) = - 1 THEN nvl(t3.FEE_IN_AMT, 0) / 100
        ELSE t3.FEE_IN_AMT / 100 END        shod_handfee
    ,case when sign(nvl(( t3.SETL_FEE_AMT ), 0) - 100) = - 1 THEN nvl(( t3.SETL_FEE_AMT ), 0) / 100
        ELSE ( t3.SETL_FEE_AMT ) / 100 END  real_handfee
FROM SJXQ_SJ2024031566_CST_01           t1
INNER join edw.dpss_pbs_order_info      t2  --支付平台订单信息登记表
on  t1.mcht_id=t2.MER_ID
and t2.dt>='20240101' and t2.dt <='20240229'
    ,'101000','110603','110702','110704','100411','100412','100413','100414','100417'
    ,'100419','100423','100499','201003','201002','201001','201007' )
LEFT JOIN edw.dpss_bth_mer_in_acc_dtl   t3  --商户入账明细表
ON  t2.TXN_SEQ_ID = t3.CHL_TXN_SSN
AND t3.dt = t2.dt
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_04 AS
SElECT substr(txn_dt,1,6) mons,mcht_id
    ,round(sum(TXN_AMT),2)       TXN_AMT
    ,round(sum(shod_handfee),2)  shod_handfee
    ,round(sum(real_handfee),2)  real_handfee
from SJXQ_SJ2024031566_CST_03
group by mons,mcht_id
;
--sheet1
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_05 AS
SElECT t1.mcht_id 				商户号
    ,t1.mcht_nm                 商户名称
    ,t1.act_id                  账号
    ,t1.dmnd_dep_bal_mon_avg    12月月日均_活期
    ,t1.TXN_AMT                 1月交易金额
    ,t1.shod_handfee            1月应收手续费
    ,t1.real_handfee            1月实收手续费
    ,t2.dmnd_dep_bal_mon_avg	1月月日均_活期
    ,t2.TXN_AMT                 2月交易金额
    ,t2.shod_handfee            2月应收手续费
    ,t2.real_handfee            2月实收手续费
from(
    SElECT t1.mcht_id
        ,t1.mcht_nm
        ,t1.act_id
        ,t2.dmnd_dep_bal_mon_avg
        ,t4.TXN_AMT
        ,t4.shod_handfee
        ,t4.real_handfee
    from SJXQ_SJ2024031566_CST_01       t1
    left join SJXQ_SJ2024031566_CST_02  t2 on t1.cst_id=t2.cst_id and t2.dt='20231231'
    left join SJXQ_SJ2024031566_CST_04  t4 on t1.mcht_id=t4.mcht_id and t4.mons='202401'
    where t1.data_src = 'sheet1'
)t1 left join (
    SElECT t1.mcht_id
        ,t2.dmnd_dep_bal_mon_avg
        ,t4.TXN_AMT
        ,t4.shod_handfee
        ,t4.real_handfee
    from SJXQ_SJ2024031566_CST_01       t1
    left join SJXQ_SJ2024031566_CST_02  t2 on t1.cst_id=t2.cst_id and t2.dt='20240131'
    left join SJXQ_SJ2024031566_CST_04  t4 on t1.mcht_id=t4.mcht_id and t4.mons='202402'
    where t1.data_src = 'sheet1'
)t2 on t1.mcht_id=t2.mcht_id
;
--sheet2
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_06 AS
SElECT t1.mcht_id 				商户号
    ,t1.mcht_nm                 商户名称
    ,t1.act_id                  账号
    ,t2.dmnd_dep_bal_mon_avg    1月月日均_活期
    ,t4.TXN_AMT                 2月交易金额
    ,t4.shod_handfee            2月应收手续费
    ,t4.real_handfee            2月实收手续费
from SJXQ_SJ2024031566_CST_01       t1
left join SJXQ_SJ2024031566_CST_02  t2 on t1.cst_id=t2.cst_id and t2.dt='20240131'
left join SJXQ_SJ2024031566_CST_04  t4 on t1.mcht_id=t4.mcht_id and t4.mons='202402'
where t1.data_src = 'sheet2'
;
SElECT '01' seq, count(1) cnt, count(distinct mcht_id) custs
from SJXQ_SJ2024031566_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ2024031566_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct mcht_id,txn_dt) custs
from SJXQ_SJ2024031566_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct mons,mcht_id) custs
from SJXQ_SJ2024031566_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 商户号) custs
from SJXQ_SJ2024031566_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 商户号) custs
from SJXQ_SJ2024031566_CST_06
;
/*
01	31	31
02	62	62
03	12526	762
04	57	57
05	15	15
06	16	16
*/***SJ2024031906_贷款审批结果分析.sql
-- 预评估不通过的原因
DROP   TABLE IF     EXISTS SJXQ_SJ2024031906_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031906_CST_01 AS
select apl_srl_nbr --16
from edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
where dt='20240315'
-- and qry_rsl = '2010'
-- and apl_cst_rol = '01'
group by apl_srl_nbr
;
--贷款业务申请信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024031906_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031906_CST_02 AS
select t1.apl_id                                   --申请编号 18
    ,t1.cst_id                                     --客户编号
    ,t1.cst_nm                                     --客户姓名
	,t1.apl_dt                                     --申请日期|C8
	,t1.pd_id                                      --产品编号|C24
	,t1.hpn_dt                                     --发生日期|C8
	,t1.mtu_dt                                     --到期日期|C8
	,t1.apl_amt                                    --申请金额|DECIMAL(20,2)
	,t1.intr_rat                                   --利率|DECIMAL(14,8)
	,t1.aprv_exe_amt                               --批准执行金额|DECIMAL(20,2)
	,t1.hdl_dt                                     --经办日期|C8
	,t1.reg_dt                                     --登记日期|C8
	,t1.pre_apl_srl_nbr                            --预申请流水号 预评估申请流水号
    ,t1.svy_id	                                   --调查人|C20
    ,t2.org_nm  svy_org_nm
	,t1.pd_cd                                      --产品标识|C2048
	,t1.busi_apl_id                                --申请相关流水号 基本为空
	,t1.pre_ases_rsl                               --预评估结果|c32
    ,c1.cd_val_dscr     pre_ases_rsl_nm
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
from edw.dwd_bus_loan_apl_inf_dd  t1    --信贷业务申请信息
left join edw.dws_hr_empe_inf_dd  t2    --员工信息汇总
on  t1.svy_id=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1
ON  t1.pre_ases_rsl = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3    --客户`主管户`信息 16065131 cst_id 唯一
on      t1.cst_id = t3.cst_id
and     t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd t4             --考核机构树 4537 org_id 唯一
on      t3.prm_org_id = t4.org_id
and     t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM like '%村镇银行%'
where t1.dt='20240315'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031906_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031906_CST_03 AS
select t1.apl_id                    申请编号
    ,t1.cst_id                      客户编号
    ,t1.cst_nm                      客户姓名
    ,''                             当前阶段
    ,t1.svy_id	                    调查人
    ,t1.svy_org_nm                  调查人机构
    ,''                             审批权限上收原因
	,t1.pre_ases_rsl_nm             预评估结果
    ,t3.pre_ases_fail_rsn           预评估不通过的原因
    ,t3.pre_ases_sts                预评估是否通过
    ,T1.BRC_ORG_NM                  分行
    ,T1.ORG_NM                      客户归属机构
from SJXQ_SJ2024031906_CST_02       t1
left join SJXQ_SJ2024031906_CST_01  t3
on t1.apl_id=t3.apl_srl_nbr
;
/*
SElECT '01' seq, count(1) cnt, count(distinct apl_srl_nbr) custs
from SJXQ_SJ2024031906_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct apl_id) custs
from SJXQ_SJ2024031906_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct 申请编号) custs
from SJXQ_SJ2024031906_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct applyserialno) custs
from SJXQ_SJ2024031906_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct apl_srl_nbr,pre_ases_srl_nbr) custs
from SJXQ_SJ2024031906_CST_05
;
01	2710790	2710790
02	276398	276398
03	276398	276398
04	321277	321277
05	549673	240497
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024031906_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031906_CST_04 AS
SElECT applyserialno                                                  --预评估申请流水号
    ,inputdate
    ,REGEXP_REPLACE( REPLACE(opinion, ',', '|'),'\\s','|')   opinion  --抗辩中台审批意见
    ,ROW_NUMBER() over(partition by applyserialno order by inputdate desc)rn
from edw.loan_defend_opinion
where dt = '@@{yyyyMMdd}'
and opiniontype = '2' --1-抗辩理由 2-抗辩中台审核意见 3-征信授权书中台审核意见 4-重新提交理由 5-审查岗审核意见
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024031906_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031906_CST_05 AS
select t1.apl_srl_nbr                           --申请流水号 18
	,t1.rel_obj_id                              --关联对象编号 预评估流水号
    ,t2.pre_ases_srl_nbr                        --预评估申请流水号 16
    ,t2.cst_id
    ,decode(t2.cst_rol_cd,'01','借款人','02','担保人','03','关系人','04','潜在客户','') cst_role
    ,t2.pre_ases_rsl
    ,c1.cd_val_dscr         pre_ases_rsl_nm
    ,t2.reg_tm
    ,t5.opinion
from edw.dwd_bus_loan_rel_apl_inf_dd        t1  --信贷业务关联申请信息
left join edw.dwd_bus_loan_pre_ases_rsl_dd  t2  --预评估最终结果信息
on t1.rel_obj_id=t2.srl_nbr
and t2.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息 16065131 cst_id 唯一
on      t2.cst_id = t3.cst_id
and     t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树 4537 org_id 唯一
on      t3.prm_org_id = t4.org_id
and     t4.dt = '@@{yyyyMMdd}'
and     t4.BRC_ORG_NM like '%村镇银行%'
left join SJXQ_SJ2024031906_CST_04          t5
on  t2.pre_ases_srl_nbr=t5.applyserialno
and t5.rn=1
left join SJXQ_SJ2024031906_CST_01          t6
on t2.pre_ases_srl_nbr=t6.apl_srl_nbr
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1
ON  t2.pre_ases_rsl = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and   t1.rel_obj_typ = 'CusPreEvaluate'   ---- 关联对象类型:预评估
;
***SJ20240321101_计财头寸分析.sql
/*截止20240320，温州分行 存款客户 日累计转账限额 渠道不限
》=5000w
*/
--对私
DROP   TABLE IF     EXISTS SJXQ_SJ20240321101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240321101_CST_01 AS
select t1.pcc_cstno     cst_id                   --网银客户号
	,t1.pcc_bankid                               --多法人机构号码
	,t1.pcc_channel                              --渠道（0:个人;1:手机WAP;2:手机客户端）
	,t1.pcc_outdaylimit                          --对外资金日累计限额
	,t1.pcc_custleadername                       --推荐人姓名
    ,t2.cip_namecn                               --客户姓名
    ,t2.cip_limitmoney                           --客户转帐日累计限额
from edw.ebnk_pb_cstinf_channel     t1 --个人渠道信息表（新增）
left join edw.ebnk_pb_cstinf_main   t2 --个人客户信息表
on  t1.pcc_cstno=t2.cip_cstno
and t1.pcc_bankid=t2.cip_bankid
and t2.dt='20240320'
where t1.dt='20240320'
and (t1.pcc_outdaylimit>=50000000 or t2.cip_limitmoney>=50000000)
;
--对公
DROP   TABLE IF     EXISTS SJXQ_SJ20240321101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240321101_CST_02 AS
select t1.cci_cstno     cst_id                   --网银客户号
	,t1.cci_bankid                               --多法人标识位（020200：母行；020201：浙江庆元；020202：湖北大冶；）
	,t1.cci_channel                              --开通渠道（0：企业WEB；4：手机网银；）
	,t1.cci_limitmoney                           --对外转帐日累计限额
	,t1.cci_ctplimitmoney                        --公转私日交易限额
    ,t2.cif_namecn                               --客户名称(中文)
	,t2.cif_limitmoney                           --客户转帐日累计限额
	,t2.cif_ctplimitmoney                        --客户公转私日累计限额
from edw.ebnk_cb_cst_channel_inf    t1 --企业客户渠道信息表
left join edw.ebnk_cb_cst_inf       t2 --企业客户信息表
on  t1.cci_cstno=t2.cif_cstno
and t1.cci_bankid=t2.cif_bankid
and t2.dt='20240320'
where t1.dt='20240320'
and (t1.cci_limitmoney>50000000 or t2.cif_limitmoney>50000000 or t2.cif_ctplimitmoney>50000000)
;
--存款管户信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240321101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240321101_CST_03 AS
select t1.cst_act_id                             --客户账号|C32
	,t1.mgr_id                                   --管护人编号|C200
	,t1.acs_org_id                               --考核机构编号|C12
	,t1.mgr_rto                                  --管护比例|DECIMAL(7,3)
	,t1.frs_ctc_ind                              --第一联系人标志|C1
	,t1.cst_id                                   --客户号
    ,t2.cst_act_nm                               --客户账户名称
from edw.dwd_bus_dep_cst_act_mgr_inf_dd     t1   --客户存款账户管护信息
left join edw.dim_bus_dep_cst_act_inf_dd    t2   --客户存款账户信息
on t1.cst_act_id=t2.cst_act_id
and t2.dt = '20240320'
inner join edw.dim_hr_org_mng_org_tree_dd   t4   --考核机构树
on  t1.acs_org_id = t4.org_id
and t4.dt = '20240320'
and t4.brc_org_nm='温州分行'
where t1.dt='20240320'
;
--客户限额汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240321101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240321101_CST_04 AS
select cst_id,cip_namecn cst_nm
    ,max(case when pcc_channel='0' then pcc_outdaylimit else null end)  net_bnk_outdaylimit
    ,max(case when pcc_channel='0' then cip_limitmoney else null end)   net_cst_daylimit
    ,max(case when pcc_channel='2' then pcc_outdaylimit else null end)  mbl_bnk_outdaylimit
    ,max(case when pcc_channel='2' then cip_limitmoney else null end)   mbl_cst_daylimit
from SJXQ_SJ20240321101_CST_01 t1
group by cst_id,cst_nm
union all
select cst_id,cif_namecn cst_nm
    ,max(case when cci_channel='0' then cci_limitmoney else null end)  net_bnk_outdaylimit
    ,max(case when cci_channel='0' then cif_limitmoney else null end)  net_cst_daylimit
    ,max(case when cci_channel='2' then cci_limitmoney else null end)  mbl_bnk_outdaylimit
    ,max(case when cci_channel='2' then cif_limitmoney else null end)  mbl_cst_daylimit
from SJXQ_SJ20240321101_CST_02
group by cst_id,cst_nm
;
--客户主管户
DROP   TABLE IF     EXISTS SJXQ_SJ20240321101_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240321101_CST_05 AS
select '20240320' 					日期
    ,t4.brc_org_nm                  主管户分行
    ,t4.SBR_ORG_NM                  主管户支行
    ,t4.TEM_ORG_NM                  主管户团队
    ,T4.ORG_NM                      主管户机构名称
    ,t3.prm_org_id                  主管户机构号
    ,T3.PRM_MGR_ID                  主管户经理工号
    ,T3.PRM_MGR_NM                  主管户经理姓名
    ,t1.cst_id                      客户号
    ,t1.cst_nm                      客户名称
    ,t1.net_bnk_outdaylimit         网上银行对外转帐日累计限额
    ,t1.net_cst_daylimit            网上银行客户转帐日累计限额
    ,t1.mbl_bnk_outdaylimit         手机银行对外转帐日累计限额
    ,t1.mbl_cst_daylimit            手机银行客户转帐日累计限额
from SJXQ_SJ20240321101_CST_04                      t1
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3    --客户`主管户`信息 16065131 cst_id 唯一
on  t1.cst_id = t3.cst_id
and t3.dt = '20240320'
inner join edw.dim_hr_org_mng_org_tree_dd t4             --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.brc_org_nm='温州分行'
and t4.dt = '20240320'
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id,pcc_channel) custs
from SJXQ_SJ20240321101_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id,cci_channel) custs
from SJXQ_SJ20240321101_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20240321101_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ20240321101_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ20240321101_CST_05
;
/*
01	2046	720
02	1790	1694
03	252662	159326
01	2046	2046
02	1790	1789
03	252662	159326
04	2414	2414
05	2414	2414
*/
***SJ2024032251_保险业务-s1-20240101-20240321.sql
/*
问题：
2. 在册相关人数是否为 客户经理，服务经理之和？
3. 支行破冰率-客户经理 怎么算的？
4. 信贷户、存款户 是否为 有效信贷、有效存款户？是
*/
--上年保险销售数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_01 AS
select t1.trx_dt                                   --交易日期
	,t1.trx_amt                                  --交易金额
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.org_id                                   --交易机构号
	,t1.org_nm                                   --交易机构名称
	,t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
	,t1.insu_hld_nm                              --投保人名称
	,t1.wth_insu_nm                              --被保险人名称
	,t1.bnf_nm                                   --受益人信息
	,t1.cmp_cd                                   --公司代码
	,t1.cmp_nm                                   --公司名称
	,t1.pd_cd                                    --产品代码
	,t1.pd_nm                                    --产品名称
	,t1.insu_id                                  --保单号
	,t1.cmsn_fee                                 --手续费
    ,t1.mng_insu_fee	                    --管户折算保费
    ,t1.mng_cmsn_fee	                    --管户折算手续费(中收)
	,t1.mng_typ                                  --管户类型
	,t1.mng_id                                   --管户人员工号
	,t1.mng_nm                                   --管户人员名称
	,t1.mng_org_id                               --管户人员所属机构号
	,t1.mng_org_nm                               --管户人员所属机构名称
	,t1.mng_rto                                  --管户比例
	,t1.pos_id                                   --职位编号
    ,T2.POS_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2 	-- 客户经理
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
from adm_pub.adm_pub_insu_cst_pd_list       t1 --保险代销客户产品清单-全量
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      T2 --职位信息
ON      T1.pos_id = T2.POS_ID
AND     T2.DT = '20240229'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.mng_org_id = t4.org_id
and     t4.dt = '20231231'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.INSU_PLCY_STS_CD IN ( '0' , '1' , 'A' ) --0正常 1退保 A满期退保
AND     T1.MNG_TYP = '1'    --管户类型：1考核 2销售
AND     T1.TRX_DT between '20230101' and '20231231'
;
-- cst_id,考核分行，考核支行，保费，中收，件数，mgr_id,is_cst_mgr,is_srv_mgr
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_02 AS
select t1.trx_dt                                 --交易日期
	,t1.trx_amt                                  --交易金额
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.org_id                                   --交易机构号
	,t1.org_nm                                   --交易机构名称
	,t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
	,t1.insu_hld_nm                              --投保人名称
	,t1.wth_insu_nm                              --被保险人名称
	,t1.bnf_nm                                   --受益人信息
	,t1.cmp_cd                                   --公司代码
	,t1.cmp_nm                                   --公司名称
	,t1.pd_cd                                    --产品代码
	,t1.pd_nm                                    --产品名称
	,t1.insu_id                                  --保单号
	,t1.cmsn_fee                                 --手续费
    ,t1.mng_insu_fee	                    --管户折算保费
    ,t1.mng_cmsn_fee	                    --管户折算手续费(中收)
	,t1.mng_typ                                  --管户类型
	,t1.mng_id                                   --管户人员工号
	,t1.mng_nm                                   --管户人员名称
	,t1.mng_org_id                               --管户人员所属机构号
	,t1.mng_org_nm                               --管户人员所属机构名称
	,t1.mng_rto                                  --管户比例
	,t1.pos_id                                   --职位编号
    ,T2.POS_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2 	-- 客户经理
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
from adm_pub.adm_pub_insu_cst_pd_list       t1 --保险代销客户产品清单-全量
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      T2 --职位信息
ON      T1.pos_id = T2.POS_ID
AND     T2.DT = '20240229'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.mng_org_id = t4.org_id
and     t4.dt = '20231231'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.INSU_PLCY_STS_CD IN ( '0' , '1' , 'A' ) --0正常 1退保 A满期退保
AND     T1.MNG_TYP = '1'    --管户类型：1考核 2销售
AND     T1.TRX_DT between '20240101' and '20240321'
;
-- empe_id,is_cst_mgr,is_srv_mgr,分行、支行，关联上表员工聚合 20240229，上年是否开单，本年是否开单
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_03 AS
SELECT T1.EMPE_ID,T1.EMPE_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
    ,case when t3.mng_id is not null then 1 else 0 end is_brkice        --本年开单
    ,case when t5.mng_id is not null then 1 else 0 end is_brkice_lst    --上年开单
FROM edw.dws_hr_empe_inf_dd                 t1
LEFT JOIN EDW.DIM_HR_ORG_JOB_INF_DD         T2 --职位信息
ON      T1.POS_ENC = T2.POS_ID
AND     T2.DT = '20240229'
left join (
    SElECT distinct mng_id
    from SJXQ_SJ2024032251_CST_02  --本年开单客户经理
)t3 on t1.empe_id=t3.mng_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.org_id = t4.org_id
and     t4.dt = '20231231'
left join (
    SElECT distinct mng_id
    from SJXQ_SJ2024032251_CST_01  --上年开单客户经理
)t5 on t1.empe_id=t5.mng_id
WHERE   t1.dt = '20240229'
AND     t1.HC_TYP_CD = '1'                  --编制内
AND     t1.lbr_typ_cd <> '07'               --剔除合作用工
;
-- 支行，关联上表支行聚合 20231231
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_04 AS
SElECT distinct T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
    ,case when t3.SBR_ORG_ID is not null then 1 else 0 end is_brkice
FROM edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
left join (
    SElECT distinct SBR_ORG_ID
    from SJXQ_SJ2024032251_CST_02
)t3 on t4.SBR_ORG_ID=t3.SBR_ORG_ID
where t4.dt = '20231231'
and nvl(t4.SBR_ORG_ID,'')<>''
;
-- cst_id,分行，sam_custs，is_vld_loan,is_vld_dep，保费，件数
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_05 AS
SElECT t1.cst_id
    ,t1.efe_dep_cst_ind	        --有效存款户标识
    ,t1.efe_loan_cst_ind	    --有效信贷户标识
    ,t2.sam_rsk_ctrl_id	        --同一风险控制号
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM,T4.ORG_NM
    ,t5.insu_num,t5.mng_insu_fee
from adm_pub.adm_csm_cbas_ind_inf_dd t1     --客户集市-基础信息-客户基础标识信息
left join edw.dws_cst_bas_inf_dd	 t2     --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20240321'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3  --客户`主管户`信息
on      t1.cst_id = t3.cst_id
and     t3.dt = '20240321'
left join edw.dim_hr_org_mng_org_tree_dd            t4  --考核机构树
on      t3.prm_org_id = t4.org_id
and     t4.dt = '20240321'
left join(
    SElECT cst_id,count(insu_id)    insu_num
        ,sum(mng_insu_fee)          mng_insu_fee
    from SJXQ_SJ2024032251_CST_02
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
where   t1.dt='20240321'
;
-- 上表自关联，按分行聚合，同风险件数，同风险保费
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_06 AS
SElECT t1.BRC_ORG_NM
    ,count(distinct t2.cst_id)      sam_rsk_custs
    ,sum(t2.insu_num)               insu_num
    ,sum(t2.mng_insu_fee)           mng_insu_fee
from SJXQ_SJ2024032251_CST_05       t1
left join SJXQ_SJ2024032251_CST_05  t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where nvl(t1.sam_rsk_ctrl_id,'')<>''
and nvl(t1.BRC_ORG_NM,'')<>''
group by t1.BRC_ORG_NM
;
--汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_07 AS
SElECT t1.BRC_ORG_NM,t1.mng_insu_fee,t1.mng_cmsn_fee,t1.custs,t1.insu_num
    ,t1.cst_avg_insu_fee,t1.ord_avg_insu_fee
    ,t1.rjbf_cst_mng,t1.jjbf_cst_mng,t1.avg_js_cst_mng
    ,t1.rjbf_svc_mng,t1.jjbf_svc_mng,t1.avg_js_svc_mng
    ,t2.empe_num,t2.cst_mng_num,t2.svc_mng_num,t2.qt_mng_num
    ,t2.empe_num_brkice,t2.cst_mng_num_brkice,t2.svc_mng_num_brkice,t2.qt_mng_num_brkice
    ,t2.empe_num_brkice/t2.empe_num             brkice_rat
    ,case when t2.cst_mng_num=0 then 0 else t2.cst_mng_num_brkice/t2.cst_mng_num    end   cst_brkice_rat
    ,case when t2.svc_mng_num=0 then 0 else t2.svc_mng_num_brkice/t2.svc_mng_num    end   svc_brkice_rat
    ,case when t2.qt_mng_num=0  then 0 else t2.qt_mng_num_brkice/t2.qt_mng_num      end   qt_brkice_rat
    ,t2.lsty_cst_mngs,t2.lsty_cur_cst_mngs,t2.lsty_svc_mngs,t2.lsty_cur_svc_mngs
    ,t3.sbr_num,t3.brk_ice_sbr_num
    ,t4.efe_loan_num,t4.efe_dep_num,t4.jjbf_efe_loan,t4.jjbf_efe_dep
    ,t5.sam_rsk_custs
    ,case when t5.insu_num=0 then 0 else t5.mng_insu_fee/t5.insu_num end jjbf_sam_rsk_cst
from(
    SElECT BRC_ORG_NM
        ,sum(mng_insu_fee)      mng_insu_fee
        ,sum(mng_cmsn_fee)      mng_cmsn_fee
        ,count(distinct cst_id) custs
        ,count(insu_id)         insu_num
        ,sum(mng_insu_fee)/count(distinct cst_id)   cst_avg_insu_fee
        ,sum(mng_insu_fee)/count(insu_id)           ord_avg_insu_fee
        ,case when count(distinct case when MNG_TYP2 = '客户经理' then cst_id end)=0 then 0
            else sum(case when MNG_TYP2 = '客户经理' then mng_insu_fee else 0 end)/count(distinct case when MNG_TYP2 = '客户经理' then cst_id end) end rjbf_cst_mng
        ,case when count(case when MNG_TYP2 = '客户经理' then insu_id end)=0 then 0
            else sum(case when MNG_TYP2 = '客户经理' then mng_insu_fee else 0 end)/count(case when MNG_TYP2 = '客户经理' then insu_id end) end         jjbf_cst_mng
        ,case when count(distinct case when MNG_TYP2 = '客户经理' then mng_id end)=0 then 0
            else count(case when MNG_TYP2 = '客户经理' then insu_id end)/count(distinct case when MNG_TYP2 = '客户经理' then mng_id end)   end        avg_js_cst_mng
        ,case when count(distinct case when MNG_TYP2 = '服务经理' then cst_id end)=0 then 0
            else sum(case when MNG_TYP2 = '服务经理' then mng_insu_fee else 0 end)/count(distinct case when MNG_TYP2 = '服务经理' then cst_id end) end   rjbf_svc_mng
        ,case when count(case when MNG_TYP2 = '服务经理' then insu_id end)=0 then 0
            else sum(case when MNG_TYP2 = '服务经理' then mng_insu_fee else 0 end)/count(case when MNG_TYP2 = '服务经理' then insu_id end)        end    jjbf_svc_mng
        ,case when count(distinct case when MNG_TYP2 = '服务经理' then mng_id end) =0 then 0
            else count(case when MNG_TYP2 = '服务经理' then insu_id end)/count(distinct case when MNG_TYP2 = '服务经理' then mng_id end)         end     avg_js_svc_mng
    from SJXQ_SJ2024032251_CST_02
    group by BRC_ORG_NM
)t1 left join(
    select BRC_ORG_NM
        ,count(empe_id)                                        empe_num
        ,count(case when MNG_TYP2='客户经理' then empe_id end)  cst_mng_num
        ,count(case when MNG_TYP2='服务经理' then empe_id end)  svc_mng_num
        ,count(case when MNG_TYP2='其他' then empe_id end)      qt_mng_num
        ,count(case when is_brkice=1 then empe_id end)                         empe_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='客户经理' then empe_id end)  cst_mng_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='服务经理' then empe_id end)  svc_mng_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='其他' then empe_id end)      qt_mng_num_brkice
        ,count(case when is_brkice_lst=1 and MNG_TYP2='客户经理' then empe_id end)                      lsty_cst_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='客户经理' and is_brkice=1 then empe_id end)      lsty_cur_cst_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='服务经理' then empe_id end)                      lsty_svc_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='服务经理' and is_brkice=1 then empe_id end)      lsty_cur_svc_mngs
    from SJXQ_SJ2024032251_CST_03
    group by BRC_ORG_NM
)t2 on t1.BRC_ORG_NM=t2.BRC_ORG_NM
left join(
    select BRC_ORG_NM,count(SBR_ORG_ID)                     sbr_num
        ,count(case when is_brkice=1 then SBR_ORG_ID end)   brk_ice_sbr_num
    from SJXQ_SJ2024032251_CST_04
    group by BRC_ORG_NM
)t3 on t1.BRC_ORG_NM=t3.BRC_ORG_NM
left join (
    SElECT BRC_ORG_NM
        ,count(case when efe_loan_cst_ind='1' then cst_id end)  efe_loan_num
        ,count(case when efe_dep_cst_ind='1' then cst_id end)   efe_dep_num
        ,case when sum(case when efe_loan_cst_ind='1' then insu_num else 0 end)=0 then 0
            else sum(case when efe_loan_cst_ind='1' then mng_insu_fee else 0 end)/sum(case when efe_loan_cst_ind='1' then insu_num else 0 end)  end jjbf_efe_loan
        ,case when sum(case when efe_dep_cst_ind='1' then insu_num else 0 end)=0 then 0
            else sum(case when efe_dep_cst_ind='1' then mng_insu_fee else 0 end)/sum(case when efe_dep_cst_ind='1' then insu_num else 0 end)    end jjbf_efe_dep
    from SJXQ_SJ2024032251_CST_05
    group by BRC_ORG_NM
)t4 on t1.BRC_ORG_NM=t4.BRC_ORG_NM
left join SJXQ_SJ2024032251_CST_06 t5
on t1.BRC_ORG_NM=t5.BRC_ORG_NM
;
--输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST_08 AS
SElECT BRC_ORG_NM 					分行名称
    ,mng_insu_fee                   保费
    ,mng_cmsn_fee                   中收
    ,custs                          客户数
    ,insu_num                       件数
    ,round(cst_avg_insu_fee,2)      人均保费
    ,round(ord_avg_insu_fee,2)      件均保费
    ,round(rjbf_cst_mng    ,2)      人均保费_客户经理
    ,round(jjbf_cst_mng    ,2)      件均保费_客户经理
    ,round(avg_js_cst_mng  ,2)      平均件数_客户经理
    ,round(rjbf_svc_mng    ,2)      人均保费_服务经理
    ,round(jjbf_svc_mng    ,2)      件均保费_服务经理
    ,round(avg_js_svc_mng  ,2)      平均件数_服务经理
    ,empe_num                       总员工数_20240229
    ,svc_mng_num                    服务经理_总
    ,cst_mng_num                    客户经理_总
    ,qt_mng_num                     其他_总
    ,empe_num_brkice                总人数_破冰
    ,svc_mng_num_brkice             服务经理_破冰
    ,cst_mng_num_brkice             客户经理_破冰
    ,qt_mng_num_brkice              其他_破冰
    ,round(brkice_rat    ,2)        总破冰率
    ,round(svc_brkice_rat,2)        服务经理_破冰率
    ,round(cst_brkice_rat,2)        客户经理_破冰率
    ,round(qt_brkice_rat ,2)        其他_破冰率
    ,sbr_num                        支行数量_20231231
    ,brk_ice_sbr_num                破冰支行数量
    ,efe_loan_num                   有效信贷户_20240321
    ,sam_rsk_custs                  同一风险控制号信贷户_20240321
    ,efe_dep_num                    有效存款户_20240321
    ,round(jjbf_efe_loan   ,2)      有效信贷户_件均保费
    ,round(jjbf_sam_rsk_cst,2)      同一风险控制号信贷户_件均保费
    ,round(jjbf_efe_dep    ,2)      有效存款户_件均保费
    ,lsty_cst_mngs                  上年开单客户经理数
    ,lsty_cur_cst_mngs              上年开单且本年开单客户经理数
    ,lsty_svc_mngs                  上年开单服务经理数
    ,lsty_cur_svc_mngs              上年开单且本年开单服务经理数
from SJXQ_SJ2024032251_CST_07
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024032251_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct SBR_ORG_ID) custs
from SJXQ_SJ2024032251_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct BRC_ORG_NM) custs
from SJXQ_SJ2024032251_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct BRC_ORG_NM) custs
from SJXQ_SJ2024032251_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct 分行名称) custs
from SJXQ_SJ2024032251_CST_08
;
/*
01	21565	20300
02	3335	3174
03	13463	13463
04	1149	1149
05	16526479	16526479
06	31	31
07	14	14
08	14	14
*/
***SJ2024032251_保险业务-s2-20230101-20230321.sql
/*
问题：
2. 在册相关人数是否为 客户经理，服务经理之和？
3. 支行破冰率-客户经理 怎么算的？
4. 信贷户、存款户 是否为 有效信贷、有效存款户？是
*/
--上年保险销售数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_01 AS
select t1.trx_dt                                   --交易日期
	,t1.trx_amt                                  --交易金额
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.org_id                                   --交易机构号
	,t1.org_nm                                   --交易机构名称
	,t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
	,t1.insu_hld_nm                              --投保人名称
	,t1.wth_insu_nm                              --被保险人名称
	,t1.bnf_nm                                   --受益人信息
	,t1.cmp_cd                                   --公司代码
	,t1.cmp_nm                                   --公司名称
	,t1.pd_cd                                    --产品代码
	,t1.pd_nm                                    --产品名称
	,t1.insu_id                                  --保单号
	,t1.cmsn_fee                                 --手续费
    ,t1.mng_insu_fee	                    --管户折算保费
    ,t1.mng_cmsn_fee	                    --管户折算手续费(中收)
	,t1.mng_typ                                  --管户类型
	,t1.mng_id                                   --管户人员工号
	,t1.mng_nm                                   --管户人员名称
	,t1.mng_org_id                               --管户人员所属机构号
	,t1.mng_org_nm                               --管户人员所属机构名称
	,t1.mng_rto                                  --管户比例
	,t1.pos_id                                   --职位编号
    ,T2.POS_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2 	-- 客户经理
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
from adm_pub.adm_pub_insu_cst_pd_list       t1 --保险代销客户产品清单-全量
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      T2 --职位信息
ON      T1.pos_id = T2.POS_ID
AND     T2.DT = '20240229'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.mng_org_id = t4.org_id
and     t4.dt = '20231231'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.INSU_PLCY_STS_CD IN ( '0' , '1' , 'A' ) --0正常 1退保 A满期退保
AND     T1.MNG_TYP = '1'    --管户类型：1考核 2销售
AND     T1.TRX_DT between '20220101' and '20221231'
;
-- cst_id,考核分行，考核支行，保费，中收，件数，mgr_id,is_cst_mgr,is_srv_mgr
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_02 AS
select t1.trx_dt                                 --交易日期
	,t1.trx_amt                                  --交易金额
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.org_id                                   --交易机构号
	,t1.org_nm                                   --交易机构名称
	,t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
	,t1.insu_hld_nm                              --投保人名称
	,t1.wth_insu_nm                              --被保险人名称
	,t1.bnf_nm                                   --受益人信息
	,t1.cmp_cd                                   --公司代码
	,t1.cmp_nm                                   --公司名称
	,t1.pd_cd                                    --产品代码
	,t1.pd_nm                                    --产品名称
	,t1.insu_id                                  --保单号
	,t1.cmsn_fee                                 --手续费
    ,t1.mng_insu_fee	                    --管户折算保费
    ,t1.mng_cmsn_fee	                    --管户折算手续费(中收)
	,t1.mng_typ                                  --管户类型
	,t1.mng_id                                   --管户人员工号
	,t1.mng_nm                                   --管户人员名称
	,t1.mng_org_id                               --管户人员所属机构号
	,t1.mng_org_nm                               --管户人员所属机构名称
	,t1.mng_rto                                  --管户比例
	,t1.pos_id                                   --职位编号
    ,T2.POS_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2 	-- 客户经理
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
from adm_pub.adm_pub_insu_cst_pd_list       t1 --保险代销客户产品清单-全量
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      T2 --职位信息
ON      T1.pos_id = T2.POS_ID
AND     T2.DT = '20240229'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.mng_org_id = t4.org_id
and     t4.dt = '20231231'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.INSU_PLCY_STS_CD IN ( '0' , '1' , 'A' ) --0正常 1退保 A满期退保
AND     T1.MNG_TYP = '1'    --管户类型：1考核 2销售
AND     T1.TRX_DT between '20230101' and '20230321'
;
-- empe_id,is_cst_mgr,is_srv_mgr,分行、支行，关联上表员工聚合 20240229，上年是否开单，本年是否开单
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_03 AS
SELECT T1.EMPE_ID,T1.EMPE_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
    ,case when t3.mng_id is not null then 1 else 0 end is_brkice        --本年开单
    ,case when t5.mng_id is not null then 1 else 0 end is_brkice_lst    --上年开单
FROM edw.dws_hr_empe_inf_dd                 t1
LEFT JOIN EDW.DIM_HR_ORG_JOB_INF_DD         T2 --职位信息
ON      T1.POS_ENC = T2.POS_ID
AND     T2.DT = '20240229'
left join (
    SElECT distinct mng_id
    from SJXQ_SJ2024032251_CST2_02  --本年开单客户经理
)t3 on t1.empe_id=t3.mng_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.org_id = t4.org_id
and     t4.dt = '20231231'
left join (
    SElECT distinct mng_id
    from SJXQ_SJ2024032251_CST2_01  --上年开单客户经理
)t5 on t1.empe_id=t5.mng_id
WHERE   t1.dt = '20240229'
AND     t1.HC_TYP_CD = '1'                  --编制内
AND     t1.lbr_typ_cd <> '07'               --剔除合作用工
;
-- 支行，关联上表支行聚合 20231231
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_04 AS
SElECT distinct T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
    ,case when t3.SBR_ORG_ID is not null then 1 else 0 end is_brkice
FROM edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
left join (
    SElECT distinct SBR_ORG_ID
    from SJXQ_SJ2024032251_CST2_02
)t3 on t4.SBR_ORG_ID=t3.SBR_ORG_ID
where t4.dt = '20231231'
and nvl(t4.SBR_ORG_ID,'')<>''
;
-- cst_id,分行，sam_custs，is_vld_loan,is_vld_dep，保费，件数
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_05 AS
SElECT t1.cst_id
    ,t1.efe_dep_cst_ind	        --有效存款户标识
    ,t1.efe_loan_cst_ind	    --有效信贷户标识
    ,t2.sam_rsk_ctrl_id	        --同一风险控制号
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM,T4.ORG_NM
    ,t5.insu_num,t5.mng_insu_fee
from adm_pub.adm_csm_cbas_ind_inf_dd t1     --客户集市-基础信息-客户基础标识信息
left join edw.dws_cst_bas_inf_dd	 t2     --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20240321'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3  --客户`主管户`信息
on      t1.cst_id = t3.cst_id
and     t3.dt = '20240321'
left join edw.dim_hr_org_mng_org_tree_dd            t4  --考核机构树
on      t3.prm_org_id = t4.org_id
and     t4.dt = '20240321'
left join(
    SElECT cst_id,count(insu_id)    insu_num
        ,sum(mng_insu_fee)          mng_insu_fee
    from SJXQ_SJ2024032251_CST2_02
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
where   t1.dt='20240321'
;
-- 上表自关联，按分行聚合，同风险件数，同风险保费
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_06 AS
SElECT t1.BRC_ORG_NM
    ,count(distinct t2.cst_id)      sam_rsk_custs
    ,sum(t2.insu_num)               insu_num
    ,sum(t2.mng_insu_fee)           mng_insu_fee
from SJXQ_SJ2024032251_CST2_05       t1
left join SJXQ_SJ2024032251_CST2_05  t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where nvl(t1.sam_rsk_ctrl_id,'')<>''
and nvl(t1.BRC_ORG_NM,'')<>''
group by t1.BRC_ORG_NM
;
--汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_07 AS
SElECT t1.BRC_ORG_NM,t1.mng_insu_fee,t1.mng_cmsn_fee,t1.custs,t1.insu_num
    ,t1.cst_avg_insu_fee,t1.ord_avg_insu_fee
    ,t1.rjbf_cst_mng,t1.jjbf_cst_mng,t1.avg_js_cst_mng
    ,t1.rjbf_svc_mng,t1.jjbf_svc_mng,t1.avg_js_svc_mng
    ,t2.empe_num,t2.cst_mng_num,t2.svc_mng_num,t2.qt_mng_num
    ,t2.empe_num_brkice,t2.cst_mng_num_brkice,t2.svc_mng_num_brkice,t2.qt_mng_num_brkice
    ,t2.empe_num_brkice/t2.empe_num             brkice_rat
    ,case when t2.cst_mng_num=0 then 0 else t2.cst_mng_num_brkice/t2.cst_mng_num    end   cst_brkice_rat
    ,case when t2.svc_mng_num=0 then 0 else t2.svc_mng_num_brkice/t2.svc_mng_num    end   svc_brkice_rat
    ,case when t2.qt_mng_num=0  then 0 else t2.qt_mng_num_brkice/t2.qt_mng_num      end   qt_brkice_rat
    ,t2.lsty_cst_mngs,t2.lsty_cur_cst_mngs,t2.lsty_svc_mngs,t2.lsty_cur_svc_mngs
    ,t3.sbr_num,t3.brk_ice_sbr_num
    ,t4.efe_loan_num,t4.efe_dep_num,t4.jjbf_efe_loan,t4.jjbf_efe_dep
    ,t5.sam_rsk_custs
    ,case when t5.insu_num=0 then 0 else t5.mng_insu_fee/t5.insu_num end jjbf_sam_rsk_cst
from(
    SElECT BRC_ORG_NM
        ,sum(mng_insu_fee)      mng_insu_fee
        ,sum(mng_cmsn_fee)      mng_cmsn_fee
        ,count(distinct cst_id) custs
        ,count(insu_id)         insu_num
        ,sum(mng_insu_fee)/count(distinct cst_id)   cst_avg_insu_fee
        ,sum(mng_insu_fee)/count(insu_id)           ord_avg_insu_fee
        ,case when count(distinct case when MNG_TYP2 = '客户经理' then cst_id end)=0 then 0
            else sum(case when MNG_TYP2 = '客户经理' then mng_insu_fee else 0 end)/count(distinct case when MNG_TYP2 = '客户经理' then cst_id end) end rjbf_cst_mng
        ,case when count(case when MNG_TYP2 = '客户经理' then insu_id end)=0 then 0
            else sum(case when MNG_TYP2 = '客户经理' then mng_insu_fee else 0 end)/count(case when MNG_TYP2 = '客户经理' then insu_id end) end         jjbf_cst_mng
        ,case when count(distinct case when MNG_TYP2 = '客户经理' then mng_id end)=0 then 0
            else count(case when MNG_TYP2 = '客户经理' then insu_id end)/count(distinct case when MNG_TYP2 = '客户经理' then mng_id end)   end        avg_js_cst_mng
        ,case when count(distinct case when MNG_TYP2 = '服务经理' then cst_id end)=0 then 0
            else sum(case when MNG_TYP2 = '服务经理' then mng_insu_fee else 0 end)/count(distinct case when MNG_TYP2 = '服务经理' then cst_id end) end   rjbf_svc_mng
        ,case when count(case when MNG_TYP2 = '服务经理' then insu_id end)=0 then 0
            else sum(case when MNG_TYP2 = '服务经理' then mng_insu_fee else 0 end)/count(case when MNG_TYP2 = '服务经理' then insu_id end)        end    jjbf_svc_mng
        ,case when count(distinct case when MNG_TYP2 = '服务经理' then mng_id end) =0 then 0
            else count(case when MNG_TYP2 = '服务经理' then insu_id end)/count(distinct case when MNG_TYP2 = '服务经理' then mng_id end)         end     avg_js_svc_mng
    from SJXQ_SJ2024032251_CST2_02
    group by BRC_ORG_NM
)t1 left join(
    select BRC_ORG_NM
        ,count(empe_id)                                        empe_num
        ,count(case when MNG_TYP2='客户经理' then empe_id end)  cst_mng_num
        ,count(case when MNG_TYP2='服务经理' then empe_id end)  svc_mng_num
        ,count(case when MNG_TYP2='其他' then empe_id end)      qt_mng_num
        ,count(case when is_brkice=1 then empe_id end)                         empe_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='客户经理' then empe_id end)  cst_mng_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='服务经理' then empe_id end)  svc_mng_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='其他' then empe_id end)      qt_mng_num_brkice
        ,count(case when is_brkice_lst=1 and MNG_TYP2='客户经理' then empe_id end)                      lsty_cst_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='客户经理' and is_brkice=1 then empe_id end)      lsty_cur_cst_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='服务经理' then empe_id end)                      lsty_svc_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='服务经理' and is_brkice=1 then empe_id end)      lsty_cur_svc_mngs
    from SJXQ_SJ2024032251_CST2_03
    group by BRC_ORG_NM
)t2 on t1.BRC_ORG_NM=t2.BRC_ORG_NM
left join(
    select BRC_ORG_NM,count(SBR_ORG_ID)                     sbr_num
        ,count(case when is_brkice=1 then SBR_ORG_ID end)   brk_ice_sbr_num
    from SJXQ_SJ2024032251_CST2_04
    group by BRC_ORG_NM
)t3 on t1.BRC_ORG_NM=t3.BRC_ORG_NM
left join (
    SElECT BRC_ORG_NM
        ,count(case when efe_loan_cst_ind='1' then cst_id end)  efe_loan_num
        ,count(case when efe_dep_cst_ind='1' then cst_id end)   efe_dep_num
        ,case when sum(case when efe_loan_cst_ind='1' then insu_num else 0 end)=0 then 0
            else sum(case when efe_loan_cst_ind='1' then mng_insu_fee else 0 end)/sum(case when efe_loan_cst_ind='1' then insu_num else 0 end)  end jjbf_efe_loan
        ,case when sum(case when efe_dep_cst_ind='1' then insu_num else 0 end)=0 then 0
            else sum(case when efe_dep_cst_ind='1' then mng_insu_fee else 0 end)/sum(case when efe_dep_cst_ind='1' then insu_num else 0 end)    end jjbf_efe_dep
    from SJXQ_SJ2024032251_CST2_05
    group by BRC_ORG_NM
)t4 on t1.BRC_ORG_NM=t4.BRC_ORG_NM
left join SJXQ_SJ2024032251_CST2_06 t5
on t1.BRC_ORG_NM=t5.BRC_ORG_NM
;
--输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST2_08 AS
SElECT BRC_ORG_NM 					分行名称
    ,mng_insu_fee                   保费
    ,mng_cmsn_fee                   中收
    ,custs                          客户数
    ,insu_num                       件数
    ,round(cst_avg_insu_fee,2)      人均保费
    ,round(ord_avg_insu_fee,2)      件均保费
    ,round(rjbf_cst_mng    ,2)      人均保费_客户经理
    ,round(jjbf_cst_mng    ,2)      件均保费_客户经理
    ,round(avg_js_cst_mng  ,2)      平均件数_客户经理
    ,round(rjbf_svc_mng    ,2)      人均保费_服务经理
    ,round(jjbf_svc_mng    ,2)      件均保费_服务经理
    ,round(avg_js_svc_mng  ,2)      平均件数_服务经理
    ,empe_num                       总员工数_20240229
    ,svc_mng_num                    服务经理_总
    ,cst_mng_num                    客户经理_总
    ,qt_mng_num                     其他_总
    ,empe_num_brkice                总人数_破冰
    ,svc_mng_num_brkice             服务经理_破冰
    ,cst_mng_num_brkice             客户经理_破冰
    ,qt_mng_num_brkice              其他_破冰
    ,round(brkice_rat    ,2)        总破冰率
    ,round(svc_brkice_rat,2)        服务经理_破冰率
    ,round(cst_brkice_rat,2)        客户经理_破冰率
    ,round(qt_brkice_rat ,2)        其他_破冰率
    ,sbr_num                        支行数量_20231231
    ,brk_ice_sbr_num                破冰支行数量
    ,efe_loan_num                   有效信贷户_20240321
    ,sam_rsk_custs                  同一风险控制号信贷户_20240321
    ,efe_dep_num                    有效存款户_20240321
    ,round(jjbf_efe_loan   ,2)      有效信贷户_件均保费
    ,round(jjbf_sam_rsk_cst,2)      同一风险控制号信贷户_件均保费
    ,round(jjbf_efe_dep    ,2)      有效存款户_件均保费
    ,lsty_cst_mngs                  上年开单客户经理数
    ,lsty_cur_cst_mngs              上年开单且本年开单客户经理数
    ,lsty_svc_mngs                  上年开单服务经理数
    ,lsty_cur_svc_mngs              上年开单且本年开单服务经理数
from SJXQ_SJ2024032251_CST2_07
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST2_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST2_02
union all
SElECT '03' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024032251_CST2_03
union all
SElECT '04' seq, count(1) cnt, count(distinct SBR_ORG_ID) custs
from SJXQ_SJ2024032251_CST2_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST2_05
union all
SElECT '06' seq, count(1) cnt, count(distinct BRC_ORG_NM) custs
from SJXQ_SJ2024032251_CST2_06
union all
SElECT '07' seq, count(1) cnt, count(distinct BRC_ORG_NM) custs
from SJXQ_SJ2024032251_CST2_07
union all
SElECT '08' seq, count(1) cnt, count(distinct 分行名称) custs
from SJXQ_SJ2024032251_CST2_08
;
/*
01	10629	10243
02	10503	10048
03	13463	13463
04	1149	1149
05	16526479	16526479
06	31	31
07	15	15
08	15	15
*/
***SJ2024032251_保险业务-s3-20230101-20231231.sql
/*
问题：
2. 在册相关人数是否为 客户经理，服务经理之和？
3. 支行破冰率-客户经理 怎么算的？
4. 信贷户、存款户 是否为 有效信贷、有效存款户？是
*/
--上年保险销售数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_01 AS
select t1.trx_dt                                   --交易日期
	,t1.trx_amt                                  --交易金额
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.org_id                                   --交易机构号
	,t1.org_nm                                   --交易机构名称
	,t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
	,t1.insu_hld_nm                              --投保人名称
	,t1.wth_insu_nm                              --被保险人名称
	,t1.bnf_nm                                   --受益人信息
	,t1.cmp_cd                                   --公司代码
	,t1.cmp_nm                                   --公司名称
	,t1.pd_cd                                    --产品代码
	,t1.pd_nm                                    --产品名称
	,t1.insu_id                                  --保单号
	,t1.cmsn_fee                                 --手续费
    ,t1.mng_insu_fee	                    --管户折算保费
    ,t1.mng_cmsn_fee	                    --管户折算手续费(中收)
	,t1.mng_typ                                  --管户类型
	,t1.mng_id                                   --管户人员工号
	,t1.mng_nm                                   --管户人员名称
	,t1.mng_org_id                               --管户人员所属机构号
	,t1.mng_org_nm                               --管户人员所属机构名称
	,t1.mng_rto                                  --管户比例
	,t1.pos_id                                   --职位编号
    ,T2.POS_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2 	-- 客户经理
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
from adm_pub.adm_pub_insu_cst_pd_list       t1 --保险代销客户产品清单-全量
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      T2 --职位信息
ON      T1.pos_id = T2.POS_ID
AND     T2.DT = '20240229'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.mng_org_id = t4.org_id
and     t4.dt = '20231231'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.INSU_PLCY_STS_CD IN ( '0' , '1' , 'A' ) --0正常 1退保 A满期退保
AND     T1.MNG_TYP = '1'    --管户类型：1考核 2销售
AND     T1.TRX_DT between '20220101' and '20221231'
;
-- cst_id,考核分行，考核支行，保费，中收，件数，mgr_id,is_cst_mgr,is_srv_mgr
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_02 AS
select t1.trx_dt                                 --交易日期
	,t1.trx_amt                                  --交易金额
	,t1.trx_cd                                   --交易代码
	,t1.trx_nm                                   --交易名称
	,t1.org_id                                   --交易机构号
	,t1.org_nm                                   --交易机构名称
	,t1.cst_id                                   --客户号
	,t1.cst_typ                                  --客户类型
	,t1.insu_hld_nm                              --投保人名称
	,t1.wth_insu_nm                              --被保险人名称
	,t1.bnf_nm                                   --受益人信息
	,t1.cmp_cd                                   --公司代码
	,t1.cmp_nm                                   --公司名称
	,t1.pd_cd                                    --产品代码
	,t1.pd_nm                                    --产品名称
	,t1.insu_id                                  --保单号
	,t1.cmsn_fee                                 --手续费
    ,t1.mng_insu_fee	                    --管户折算保费
    ,t1.mng_cmsn_fee	                    --管户折算手续费(中收)
	,t1.mng_typ                                  --管户类型
	,t1.mng_id                                   --管户人员工号
	,t1.mng_nm                                   --管户人员名称
	,t1.mng_org_id                               --管户人员所属机构号
	,t1.mng_org_nm                               --管户人员所属机构名称
	,t1.mng_rto                                  --管户比例
	,t1.pos_id                                   --职位编号
    ,T2.POS_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2 	-- 客户经理
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
from adm_pub.adm_pub_insu_cst_pd_list       t1 --保险代销客户产品清单-全量
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      T2 --职位信息
ON      T1.pos_id = T2.POS_ID
AND     T2.DT = '20240229'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.mng_org_id = t4.org_id
and     t4.dt = '20231231'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.INSU_PLCY_STS_CD IN ( '0' , '1' , 'A' ) --0正常 1退保 A满期退保
AND     T1.MNG_TYP = '1'    --管户类型：1考核 2销售
AND     T1.TRX_DT between '20230101' and '20231231'
;
-- empe_id,is_cst_mgr,is_srv_mgr,分行、支行，关联上表员工聚合 20240229，上年是否开单，本年是否开单
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_03 AS
SELECT T1.EMPE_ID,T1.EMPE_NM
	,CASE WHEN T2.POS_NM='客户经理'	THEN '客户经理'
        WHEN T2.POS_NM='服务经理' THEN '服务经理'
        ELSE '其他' END MNG_TYP2
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
    ,case when t3.mng_id is not null then 1 else 0 end is_brkice        --本年开单
    ,case when t5.mng_id is not null then 1 else 0 end is_brkice_lst    --上年开单
FROM edw.dws_hr_empe_inf_dd                 t1
LEFT JOIN EDW.DIM_HR_ORG_JOB_INF_DD         T2 --职位信息
ON      T1.POS_ENC = T2.POS_ID
AND     T2.DT = '20240229'
left join (
    SElECT distinct mng_id
    from SJXQ_SJ2024032251_CST3_02  --本年开单客户经理
)t3 on t1.empe_id=t3.mng_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on      t1.org_id = t4.org_id
and     t4.dt = '20231231'
left join (
    SElECT distinct mng_id
    from SJXQ_SJ2024032251_CST3_01  --上年开单客户经理
)t5 on t1.empe_id=t5.mng_id
WHERE   t1.dt = '20240229'
AND     t1.HC_TYP_CD = '1'                  --编制内
AND     t1.lbr_typ_cd <> '07'               --剔除合作用工
;
-- 支行，关联上表支行聚合 20231231
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_04 AS
SElECT distinct T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM
    ,case when t3.SBR_ORG_ID is not null then 1 else 0 end is_brkice
FROM edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
left join (
    SElECT distinct SBR_ORG_ID
    from SJXQ_SJ2024032251_CST3_02
)t3 on t4.SBR_ORG_ID=t3.SBR_ORG_ID
where t4.dt = '20231231'
and nvl(t4.SBR_ORG_ID,'')<>''
;
-- cst_id,分行，sam_custs，is_vld_loan,is_vld_dep，保费，件数
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_05 AS
SElECT t1.cst_id
    ,t1.efe_dep_cst_ind	        --有效存款户标识
    ,t1.efe_loan_cst_ind	    --有效信贷户标识
    ,t2.sam_rsk_ctrl_id	        --同一风险控制号
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_ID,T4.SBR_ORG_NM,T4.ORG_NM
    ,t5.insu_num,t5.mng_insu_fee
from adm_pub.adm_csm_cbas_ind_inf_dd t1     --客户集市-基础信息-客户基础标识信息
left join edw.dws_cst_bas_inf_dd	 t2     --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20240321'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3  --客户`主管户`信息
on      t1.cst_id = t3.cst_id
and     t3.dt = '20240321'
left join edw.dim_hr_org_mng_org_tree_dd            t4  --考核机构树
on      t3.prm_org_id = t4.org_id
and     t4.dt = '20240321'
left join(
    SElECT cst_id,count(insu_id)    insu_num
        ,sum(mng_insu_fee)          mng_insu_fee
    from SJXQ_SJ2024032251_CST3_02
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
where   t1.dt='20240321'
;
-- 上表自关联，按分行聚合，同风险件数，同风险保费
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_06 AS
SElECT t1.BRC_ORG_NM
    ,count(distinct t2.cst_id)      sam_rsk_custs
    ,sum(t2.insu_num)               insu_num
    ,sum(t2.mng_insu_fee)           mng_insu_fee
from SJXQ_SJ2024032251_CST3_05       t1
left join SJXQ_SJ2024032251_CST3_05  t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where nvl(t1.sam_rsk_ctrl_id,'')<>''
and nvl(t1.BRC_ORG_NM,'')<>''
group by t1.BRC_ORG_NM
;
--汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_07 AS
SElECT t1.BRC_ORG_NM,t1.mng_insu_fee,t1.mng_cmsn_fee,t1.custs,t1.insu_num
    ,t1.cst_avg_insu_fee,t1.ord_avg_insu_fee
    ,t1.rjbf_cst_mng,t1.jjbf_cst_mng,t1.avg_js_cst_mng
    ,t1.rjbf_svc_mng,t1.jjbf_svc_mng,t1.avg_js_svc_mng
    ,t2.empe_num,t2.cst_mng_num,t2.svc_mng_num,t2.qt_mng_num
    ,t2.empe_num_brkice,t2.cst_mng_num_brkice,t2.svc_mng_num_brkice,t2.qt_mng_num_brkice
    ,t2.empe_num_brkice/t2.empe_num             brkice_rat
    ,case when t2.cst_mng_num=0 then 0 else t2.cst_mng_num_brkice/t2.cst_mng_num    end   cst_brkice_rat
    ,case when t2.svc_mng_num=0 then 0 else t2.svc_mng_num_brkice/t2.svc_mng_num    end   svc_brkice_rat
    ,case when t2.qt_mng_num=0  then 0 else t2.qt_mng_num_brkice/t2.qt_mng_num      end   qt_brkice_rat
    ,t2.lsty_cst_mngs,t2.lsty_cur_cst_mngs,t2.lsty_svc_mngs,t2.lsty_cur_svc_mngs
    ,t3.sbr_num,t3.brk_ice_sbr_num
    ,t4.efe_loan_num,t4.efe_dep_num,t4.jjbf_efe_loan,t4.jjbf_efe_dep
    ,t5.sam_rsk_custs
    ,case when t5.insu_num=0 then 0 else t5.mng_insu_fee/t5.insu_num end jjbf_sam_rsk_cst
from(
    SElECT BRC_ORG_NM
        ,sum(mng_insu_fee)      mng_insu_fee
        ,sum(mng_cmsn_fee)      mng_cmsn_fee
        ,count(distinct cst_id) custs
        ,count(insu_id)         insu_num
        ,sum(mng_insu_fee)/count(distinct cst_id)   cst_avg_insu_fee
        ,sum(mng_insu_fee)/count(insu_id)           ord_avg_insu_fee
        ,case when count(distinct case when MNG_TYP2 = '客户经理' then cst_id end)=0 then 0
            else sum(case when MNG_TYP2 = '客户经理' then mng_insu_fee else 0 end)/count(distinct case when MNG_TYP2 = '客户经理' then cst_id end) end rjbf_cst_mng
        ,case when count(case when MNG_TYP2 = '客户经理' then insu_id end)=0 then 0
            else sum(case when MNG_TYP2 = '客户经理' then mng_insu_fee else 0 end)/count(case when MNG_TYP2 = '客户经理' then insu_id end) end         jjbf_cst_mng
        ,case when count(distinct case when MNG_TYP2 = '客户经理' then mng_id end)=0 then 0
            else count(case when MNG_TYP2 = '客户经理' then insu_id end)/count(distinct case when MNG_TYP2 = '客户经理' then mng_id end)   end        avg_js_cst_mng
        ,case when count(distinct case when MNG_TYP2 = '服务经理' then cst_id end)=0 then 0
            else sum(case when MNG_TYP2 = '服务经理' then mng_insu_fee else 0 end)/count(distinct case when MNG_TYP2 = '服务经理' then cst_id end) end   rjbf_svc_mng
        ,case when count(case when MNG_TYP2 = '服务经理' then insu_id end)=0 then 0
            else sum(case when MNG_TYP2 = '服务经理' then mng_insu_fee else 0 end)/count(case when MNG_TYP2 = '服务经理' then insu_id end)        end    jjbf_svc_mng
        ,case when count(distinct case when MNG_TYP2 = '服务经理' then mng_id end) =0 then 0
            else count(case when MNG_TYP2 = '服务经理' then insu_id end)/count(distinct case when MNG_TYP2 = '服务经理' then mng_id end)         end     avg_js_svc_mng
    from SJXQ_SJ2024032251_CST3_02
    group by BRC_ORG_NM
)t1 left join(
    select BRC_ORG_NM
        ,count(empe_id)                                        empe_num
        ,count(case when MNG_TYP2='客户经理' then empe_id end)  cst_mng_num
        ,count(case when MNG_TYP2='服务经理' then empe_id end)  svc_mng_num
        ,count(case when MNG_TYP2='其他' then empe_id end)      qt_mng_num
        ,count(case when is_brkice=1 then empe_id end)                         empe_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='客户经理' then empe_id end)  cst_mng_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='服务经理' then empe_id end)  svc_mng_num_brkice
        ,count(case when is_brkice=1 and MNG_TYP2='其他' then empe_id end)      qt_mng_num_brkice
        ,count(case when is_brkice_lst=1 and MNG_TYP2='客户经理' then empe_id end)                      lsty_cst_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='客户经理' and is_brkice=1 then empe_id end)      lsty_cur_cst_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='服务经理' then empe_id end)                      lsty_svc_mngs
        ,count(case when is_brkice_lst=1 and MNG_TYP2='服务经理' and is_brkice=1 then empe_id end)      lsty_cur_svc_mngs
    from SJXQ_SJ2024032251_CST3_03
    group by BRC_ORG_NM
)t2 on t1.BRC_ORG_NM=t2.BRC_ORG_NM
left join(
    select BRC_ORG_NM,count(SBR_ORG_ID)                     sbr_num
        ,count(case when is_brkice=1 then SBR_ORG_ID end)   brk_ice_sbr_num
    from SJXQ_SJ2024032251_CST3_04
    group by BRC_ORG_NM
)t3 on t1.BRC_ORG_NM=t3.BRC_ORG_NM
left join (
    SElECT BRC_ORG_NM
        ,count(case when efe_loan_cst_ind='1' then cst_id end)  efe_loan_num
        ,count(case when efe_dep_cst_ind='1' then cst_id end)   efe_dep_num
        ,case when sum(case when efe_loan_cst_ind='1' then insu_num else 0 end)=0 then 0
            else sum(case when efe_loan_cst_ind='1' then mng_insu_fee else 0 end)/sum(case when efe_loan_cst_ind='1' then insu_num else 0 end)  end jjbf_efe_loan
        ,case when sum(case when efe_dep_cst_ind='1' then insu_num else 0 end)=0 then 0
            else sum(case when efe_dep_cst_ind='1' then mng_insu_fee else 0 end)/sum(case when efe_dep_cst_ind='1' then insu_num else 0 end)    end jjbf_efe_dep
    from SJXQ_SJ2024032251_CST3_05
    group by BRC_ORG_NM
)t4 on t1.BRC_ORG_NM=t4.BRC_ORG_NM
left join SJXQ_SJ2024032251_CST3_06 t5
on t1.BRC_ORG_NM=t5.BRC_ORG_NM
;
--输出
DROP   TABLE IF     EXISTS SJXQ_SJ2024032251_CST3_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032251_CST3_08 AS
SElECT BRC_ORG_NM 					分行名称
    ,mng_insu_fee                   保费
    ,mng_cmsn_fee                   中收
    ,custs                          客户数
    ,insu_num                       件数
    ,round(cst_avg_insu_fee,2)      人均保费
    ,round(ord_avg_insu_fee,2)      件均保费
    ,round(rjbf_cst_mng    ,2)      人均保费_客户经理
    ,round(jjbf_cst_mng    ,2)      件均保费_客户经理
    ,round(avg_js_cst_mng  ,2)      平均件数_客户经理
    ,round(rjbf_svc_mng    ,2)      人均保费_服务经理
    ,round(jjbf_svc_mng    ,2)      件均保费_服务经理
    ,round(avg_js_svc_mng  ,2)      平均件数_服务经理
    ,empe_num                       总员工数_20240229
    ,svc_mng_num                    服务经理_总
    ,cst_mng_num                    客户经理_总
    ,qt_mng_num                     其他_总
    ,empe_num_brkice                总人数_破冰
    ,svc_mng_num_brkice             服务经理_破冰
    ,cst_mng_num_brkice             客户经理_破冰
    ,qt_mng_num_brkice              其他_破冰
    ,round(brkice_rat    ,2)        总破冰率
    ,round(svc_brkice_rat,2)        服务经理_破冰率
    ,round(cst_brkice_rat,2)        客户经理_破冰率
    ,round(qt_brkice_rat ,2)        其他_破冰率
    ,sbr_num                        支行数量_20231231
    ,brk_ice_sbr_num                破冰支行数量
    ,efe_loan_num                   有效信贷户_20240321
    ,sam_rsk_custs                  同一风险控制号信贷户_20240321
    ,efe_dep_num                    有效存款户_20240321
    ,round(jjbf_efe_loan   ,2)      有效信贷户_件均保费
    ,round(jjbf_sam_rsk_cst,2)      同一风险控制号信贷户_件均保费
    ,round(jjbf_efe_dep    ,2)      有效存款户_件均保费
    ,lsty_cst_mngs                  上年开单客户经理数
    ,lsty_cur_cst_mngs              上年开单且本年开单客户经理数
    ,lsty_svc_mngs                  上年开单服务经理数
    ,lsty_cur_svc_mngs              上年开单且本年开单服务经理数
from SJXQ_SJ2024032251_CST3_07
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST3_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST3_02
union all
SElECT '03' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024032251_CST3_03
union all
SElECT '04' seq, count(1) cnt, count(distinct SBR_ORG_ID) custs
from SJXQ_SJ2024032251_CST3_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032251_CST3_05
union all
SElECT '06' seq, count(1) cnt, count(distinct BRC_ORG_NM) custs
from SJXQ_SJ2024032251_CST3_06
union all
SElECT '07' seq, count(1) cnt, count(distinct BRC_ORG_NM) custs
from SJXQ_SJ2024032251_CST3_07
union all
SElECT '08' seq, count(1) cnt, count(distinct 分行名称) custs
from SJXQ_SJ2024032251_CST3_08
;
/*
01	10629	10243
02	21565	20300
03	13463	13463
04	1149	1149
05	16526479	16526479
06	31	31
07	15	15
08	15	15
*/
***SJ2024032706_基金劳动竞赛.sql
-- 10月31日15：00前 使用的是业务日期bus_dt，不是确认流水的确认日期，确认流水使用20231103 dt, 限制bus_dt<=20231031
--活动开始前（10月31日15：00前）已在我行存在定投扣款成功记录的客户
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_01 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_01 AS
SELECT  cst_id
    ,max(apl_tm) max_apl_tm
    ,max(cfm_dt)    max_cfm_dt
    ,max(bus_dt)    max_bus_dt
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di --基金交易确认流水明细
WHERE   dt <= '@@{yyyyMMdd}'
AND     bus_dt <= '20231031'        --业务时间
-- and     apl_tm<='2023-10-31 15:00:00'   --申请时间
AND     TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     BUS_CD = '139' --定时定额申购确认
GROUP by cst_id
;
--20240331
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_02_1 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_02_1 AS
SElECT a.cst_id,a.cfm_dt,a.apl_amt,a.cfm_amt,a.bus_dt,a.apl_tm
    ,e.rsk_grd,e.fnd_typ
from edw.dwd_bus_chm_fnd_trx_cfm_dtl_di                 A  --基金交易确认流水明细 一天数据量 879 788
-- LEFT JOIN(
--     SELECT PD_CD
--     FROM EDW.DIM_BUS_CHM_FND_PD_INF_DD
--     WHERE DT='@@{yyyyMMdd}'
--     AND fnd_typ_cd='04'  -- 01-股票型；02-债券型；03-混合型；04-货币型
-- )C ON A.PD_CD=C.PD_CD
left join LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_01  D
on a.cst_id=d.cst_id
LEFT JOIN(
        ,decode(fnd_typ_cd,'01','股票型','02','债券型','03','混合型','04','货币型','06','FOF基金') fnd_typ
    FROM EDW.DIM_BUS_CHM_FND_PD_INF_DD
    WHERE DT='@@{yyyyMMdd}'         -- 01-股票型；02-债券型；03-混合型；04-货币型
)e ON A.PD_CD=e.PD_CD
where A.dt<='@@{yyyyMMdd}'
and A.bus_dt>'20231031' and A.bus_dt<='20240331'    --业务时间
-- and apl_tm>'2023-10-31 15:00:00' and apl_tm<='2024-03-31 15:00:00'  --申请时间
and A.BUS_CD ='139'                       --定时定额申购确认
--     ,'014430','007791','007790','007603','007823','007824','007604','006592','006591','005471'
--     ,'004667','000792','000084','000085','110052','110053')		-- 剔除 同业存单基金、短债
-- AND C.PD_CD IS NULL 	    -- 剔除 货基
and d.cst_id is null        -- 剔除 存量定投客户
;
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_02 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_02 AS
SElECT cst_id
    ,count(1)                             aip_cnt
    ,sum(cfm_amt)                         aip_amt
FROM LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_02_1
GROUP by cst_id
having count(1)>=3
and sum(cfm_amt)>=1000
;
--20240331 客户名下有正常状态定投协议
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_03 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_03 AS
SELECT a.cst_id,min(a.agr_sts_cd) agr_sts_cd
FROM EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD a
inner JOIN(
    SELECT PD_CD
    FROM EDW.DIM_BUS_CHM_FND_PD_INF_DD
    WHERE DT='@@{yyyyMMdd}'
)e ON A.PD_CD=e.PD_CD
WHERE a.DT = '20240331' -- 不能超过 20240331
group by a.cst_id
;
--数据汇总
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_04 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_04 AS
SELECT b.cst_chn_nm				as 	客户姓名
	,A.CST_ID 					as	客户号
	,T3.EMPE_NM                 as 	当前财富管户人姓名
	,T2.WLTH_MNG_MNL_ID         as 	当前财富管户人工号
	,T4.TEM_ORG_NM              as	当前财富管户人所在团队名称
	,T4.BRC_ORG_NM              as 	当前财富管户人所在分行名称
    ,a.fnd_rsk_grd                  基金风险等级
	,a.aip_fnd_typ                  基金类型
	,COALESCE(A.aip_amt,0)      as  定投累计申请金额
	,COALESCE(A.aip_cnt,0)      as  定投累计申请次数
	,decode(c.agr_sts_cd,'0','正常','1','暂停','2','客户终止','3','异常终止','4','到期终止','') AS  20240331定投协议状态
FROM LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_02           A   --1031
left join edw.dim_cst_bas_inf_dd	                    b --客户基本信息
on a.cst_id=b.cst_id
and b.dt='@@{yyyyMMdd}'
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_03      c   --协议状态
ON A.CST_ID=c.CST_ID
LEFT JOIN EDW.DIM_BUS_CHM_FND_CST_CTR_INF_DD            T2	-- 基金客户签约信息表
ON      A.CST_ID = T2.CST_ID
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD                        T3 	-- 员工汇总信息
ON      T2.WLTH_MNG_MNL_ID = T3.EMPE_ID
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD                T4
ON      T4.ORG_ID = T3.ORG_ID
AND     T4.DT = '@@{yyyyMMdd}'
;
--输出结果
SElECT *
from LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST1_04
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032706_CST1_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032706_CST1_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032706_CST1_03
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024032706_CST1_04
;
/*
01	19274	19274
02	1539	1539
03	5933	5933
04	1539	1539
说明：1. 之前代码 用 业务日期 代替了 确认日期。定投协议状态改为存在 有效即可。
2. 本次修改：定投基金产品风险评级需为 R3、R4、R5 的基金；定投协议状态 符合竞赛要求，即风险评级需为 R3、R4、R5
3. 代码需要在 20240401 运行，否则需要修改数据日期
SJ2024032706_基金劳动竞赛_final.sql
20240418 日数据
01	19274	19274
02	1572	1572
03	5922	5922
04	1572	1572
*/***SJ2024032706_基金劳动竞赛0418.sql
-- 10月31日15：00前 使用的是业务日期bus_dt，不是确认流水的确认日期，确认流水使用20231103 dt, 限制bus_dt<=20231031
--活动开始前（10月31日15：00前）已在我行存在定投扣款成功记录的客户
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_01 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_01 AS
SELECT  cst_id
    ,max(apl_tm) max_apl_tm
    ,max(cfm_dt)    max_cfm_dt
    ,max(bus_dt)    max_bus_dt
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di --基金交易确认流水明细
WHERE   dt <= '@@{yyyyMMdd}'
-- AND     bus_dt <= '20231031'        --业务时间
and     apl_tm<='2023-10-31 15:00:00'   --申请时间
AND     TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     BUS_CD = '139' --定时定额申购确认
GROUP by cst_id
;
--20240331
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_02_1 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_02_1 AS
SElECT a.cst_id,a.cfm_dt,a.apl_amt,a.cfm_amt,a.bus_dt,a.apl_tm,a.dt
    ,e.rsk_grd,e.fnd_typ
from edw.dwd_bus_chm_fnd_trx_cfm_dtl_di                 A  --基金交易确认流水明细 一天数据量 879 788
-- LEFT JOIN(
--     SELECT PD_CD
--     FROM EDW.DIM_BUS_CHM_FND_PD_INF_DD
--     WHERE DT='@@{yyyyMMdd}'
--     AND fnd_typ_cd='04'  -- 01-股票型；02-债券型；03-混合型；04-货币型
-- )C ON A.PD_CD=C.PD_CD
left join LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_01  D
on a.cst_id=d.cst_id
LEFT JOIN(
        ,decode(fnd_typ_cd,'01','股票型','02','债券型','03','混合型','04','货币型','06','FOF基金') fnd_typ
    FROM EDW.DIM_BUS_CHM_FND_PD_INF_DD
    WHERE DT='@@{yyyyMMdd}'         -- 01-股票型；02-债券型；03-混合型；04-货币型
)e ON A.PD_CD=e.PD_CD
where A.dt<='@@{yyyyMMdd}'
-- and A.bus_dt>'20231031' and A.bus_dt<='20240331'    --业务时间
and apl_tm>'2023-10-31 15:00:00'
and apl_tm<='2024-03-31 15:00:00'  --申请时间
and A.BUS_CD ='139'                       --定时定额申购确认
--     ,'014430','007791','007790','007603','007823','007824','007604','006592','006591','005471'
--     ,'004667','000792','000084','000085','110052','110053')		-- 剔除 同业存单基金、短债
-- AND C.PD_CD IS NULL 	    -- 剔除 货基
and d.cst_id is null        -- 剔除 存量定投客户
;
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_02 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_02 AS
SElECT cst_id
    ,count(1)                             aip_cnt
    ,sum(cfm_amt)                         aip_amt
FROM LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_02_1
GROUP by cst_id
having count(1)>=3
and sum(cfm_amt)>=1000
;
--20240331 客户名下有正常状态定投协议
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_03 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_03 AS
SELECT a.cst_id,min(a.agr_sts_cd) agr_sts_cd
FROM EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD a
inner JOIN(
    SELECT PD_CD
    FROM EDW.DIM_BUS_CHM_FND_PD_INF_DD
    WHERE DT='20240331'
)e ON A.PD_CD=e.PD_CD
WHERE a.DT = '20240331' -- 不能超过 20240331
group by a.cst_id
;
--数据汇总
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_04 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_04 AS
SELECT b.cst_chn_nm				as 	客户姓名
	,A.CST_ID 					as	客户号
	,T3.EMPE_NM                 as 	当前财富管户人姓名
	,T2.WLTH_MNG_MNL_ID         as 	当前财富管户人工号
	,T4.TEM_ORG_NM              as	当前财富管户人所在团队名称
	,T4.BRC_ORG_NM              as 	当前财富管户人所在分行名称
    ,a.fnd_rsk_grd                  基金风险等级
	,a.aip_fnd_typ                  基金类型
	,COALESCE(A.aip_amt,0)      as  定投累计申请金额
	,COALESCE(A.aip_cnt,0)      as  定投累计申请次数
	,decode(c.agr_sts_cd,'0','正常','1','暂停','2','客户终止','3','异常终止','4','到期终止','') AS  20240331定投协议状态
FROM LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_02          A   --1031
left join edw.dim_cst_bas_inf_dd	                    b --客户基本信息
on a.cst_id=b.cst_id
and b.dt='20240331'
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST2_03     c   --协议状态
ON A.CST_ID=c.CST_ID
LEFT JOIN EDW.DIM_BUS_CHM_FND_CST_CTR_INF_DD            T2	-- 基金客户签约信息表
ON      A.CST_ID = T2.CST_ID
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD                        T3 	-- 员工汇总信息
ON      T2.WLTH_MNG_MNL_ID = T3.EMPE_ID
AND     T3.DT = '20240331'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD                T4
ON      T4.ORG_ID = T3.ORG_ID
AND     T4.DT = '20240331'
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032706_CST2_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032706_CST2_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024032706_CST2_03
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024032706_CST2_04
;
/*
SJ2024032706_基金劳动竞赛_final.sql
20240418 日数据
01	19274	19274
02	1572	1572
03	5922	5922
04	1572	1572
--20240418
01	19274	19274
02	1582	1582
03	5922	5922
04	1582	1582
*/***SJ2024032706_基金劳动竞赛_final.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-04-09 16:19:38
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 10月31日15：00前 使用的是业务日期bus_dt，不是确认流水的确认日期，确认流水使用20231101 dt, 限制bus_dt<=20231031
--活动开始前（10月31日15：00前）已在我行存在定投扣款成功记录的客户
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_01 AS
SELECT  DISTINCT cst_id
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di --基金交易确认流水明细
WHERE   dt <= '20231101'
-- AND     bus_dt <= '20231031' --业务时间
AND   replace(replace(replace(apl_tm,'-',''),':',''),' ','') <= '20241031150000'
AND     TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     BUS_CD = '139' --定时定额申购确认
 ;
--20240331
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_02 AS
SELECT  A.cst_id
        ,count(1) aip_cnt
        ,sum(a.cfm_amt) aip_amt
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di A --基金交易确认流水明细 一天数据量 879 788
LEFT JOIN    (
                 SELECT  PD_CD
                 FROM    EDW.DIM_BUS_CHM_FND_PD_INF_DD
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     fnd_typ_cd = '04'
             -- 01-股票型；02-债券型；03-混合型；04-货币型
             ) C
ON      A.PD_CD = C.PD_CD
LEFT JOIN    LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_01 D
ON      a.cst_id = d.cst_id
LEFT JOIN    (
                 SELECT  PD_CD
                         ,decode(fnd_typ_cd, '01', '股票型', '02', '债券型', '03', '混合型', '04', '货币型', '06', 'FOF基金') fnd_typ
                 FROM    EDW.DIM_BUS_CHM_FND_PD_INF_DD
                 WHERE   DT = '@@{yyyyMMdd}'
             -- 01-股票型；02-债券型；03-混合型；04-货币型
             ) e
ON      A.PD_CD = e.PD_CD
WHERE   A.dt <= '20240402'
-- AND     A.bus_dt >= '20231031'
-- AND     A.bus_dt <= '20240331' --业务时间
AND     replace(replace(replace(A.apl_tm,'-',''),':',''),' ','') <= '20240331150000'
AND     replace(replace(replace(A.apl_tm,'-',''),':',''),' ','') >= '20231031150000'
AND     A.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     A.BUS_CD = '139' --定时定额申购确认
AND     d.cst_id IS NULL -- 剔除 存量定投客户
AND     e.rsk_grd IN ( 'R3' , 'R4' , 'R5' ) --定投的产品需为风险评级为 R3、R4、R5 的基金
GROUP BY A.cst_id
 HAVING count(1) >= 3
AND     sum(a.cfm_amt) >= 1000;
--20240331 客户名下有正常状态定投协议
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_03 AS
SELECT  a.cst_id
        ,min(a.agr_sts_cd) agr_sts_cd_240331
FROM    EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD a
INNER JOIN    (
                  SELECT  PD_CD
                  FROM    EDW.DIM_BUS_CHM_FND_PD_INF_DD
                  WHERE   DT = '20240331'
                  AND     rsk_grd_cd IN ( '3' , '4' , '5' )
 --符合竞赛要求的有效定投协议
              ) e
ON      A.PD_CD = e.PD_CD
WHERE   a.DT = '20240331' -- 不能超过 20240331
GROUP BY a.cst_id;
--数据汇总
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_04 AS
SELECT  b.cst_chn_nm                                                                                  AS 客户姓名
        ,A.CST_ID                                                                                     AS 客户号
        ,T3.EMPE_NM                                                                                   AS 当前财富管户人姓名
        ,T2.WLTH_MNG_MNL_ID                                                                           AS 当前财富管户人工号
        ,T4.TEM_ORG_NM                                                                                AS 当前财富管户人所在团队名称
        ,T4.BRC_ORG_NM                                                                                AS 当前财富管户人所在分行名称
        ,a.fnd_rsk_grd 基金风险等级
        ,a.aip_fnd_typ 基金类型
        ,COALESCE(A.aip_amt, 0)                                                                       AS 定投累计申请金额
        ,COALESCE(A.aip_cnt, 0)                                                                       AS 定投累计申请次数
        ,decode(c.agr_sts_cd_240331, '0', '正常', '1', '暂停', '2', '客户终止', '3', '异常终止', '4', '到期终止', '') AS 20240331定投协议状态
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_02 A --1031
LEFT JOIN    edw.dim_cst_bas_inf_dd b --客户基本信息
ON      a.cst_id = b.cst_id
AND     b.dt = '20240331'
LEFT JOIN    LAB_BIGDATA_DEV.SJXQ_SJ2024032706_CST_03 c --协议状态
ON      A.CST_ID = c.CST_ID
LEFT JOIN    EDW.DIM_BUS_CHM_FND_CST_CTR_INF_DD T2 -- 基金客户签约信息表
ON      A.CST_ID = T2.CST_ID
AND     T2.DT = '@@{yyyyMMdd}' --取最新管户人
LEFT JOIN    EDW.DWS_HR_EMPE_INF_DD T3 -- 员工汇总信息
ON      T2.WLTH_MNG_MNL_ID = T3.EMPE_ID
AND     T3.DT = '20240331'
LEFT JOIN    EDW.DIM_HR_ORG_MNG_ORG_TREE_DD T4
ON      T4.ORG_ID = T3.ORG_ID
AND     T4.DT = '20240331';
***SJ2024032831_财富业务捆绑销售.sql
-- 一下订单和报表是对应的，但是关联贷款，报表数据会存在重复订单记录
--保险 20230101-20240327 交易名称为&ldquo;新保承保&rdquo;、保单状态为&ldquo;正常&rdquo;
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_02 AS
SELECT T1.SYS_SRL_NBR,T1.INSU_PLCY_ID,T1.CST_ID
    ,CASE WHEN T1.PD_CD IN ( '65963' , '70219' , '620' , '139' ) THEN '理财型保险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '1'                   THEN '寿险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '2'                   THEN '年金险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '3'                   THEN '意外险'
        WHEN SUBSTR(T2.CTRL_IND, 45, 1) = '4'                   THEN '健康险'
        ELSE '其他' END PROD_TYPE
    ,case when T1.TRX_CD = '510001' then '新保承保' else null end TRX_CD
    ,T1.PD_CD
    ,T2.PD_NM
    ,T2.PD_TYP --产品类型|C1
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.TRX_AMT
    ,T6.insu_fee
    ,T1.trx_sts	--交易状态|C1
    ,T6.cmp_cd,T8.CMP_NM
    ,T6.PAY_YEAR_PRD_TYP PAY_YEAR_PRD_TYP_CD
    ,DECODE(T6.PAY_YEAR_PRD_TYP,'1','趸缴','2','年缴','') PAY_YEAR_PRD_TYP --缴费年期类型
    ,T6.PAY_YEAR    --缴费年限|C10
    ,DECODE(T6.INSU_PLCY_STS,'0','正常','1','退保','3','犹豫期退保') INSU_PLCY_STS
    ,t6.rcm_psn     --均为空
    ,T7.MNG_ID      SAL_PSN_ID
    ,T7.MNG_ORG_ID  SAL_ORG_ID
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD        T1 --保险业务交易流水信息
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD         T2 --保险产品信息表
ON      T1.PD_CD = T2.PD_CD  --产品代码
AND     T2.DT = '20240327'
INNER JOIN EDW.DWD_BUS_INSU_PLCY_INSU_INF_DD    T6 --保险保单投保信息
ON      T1.INSU_PLCY_ID = T6.INSU_PLCY_ID --保单号
AND     T1.SYS_SRL_NBR  = T6.ACC_SRL_NBR  --系统流水号
AND     T6.DT = '20240327'
LEFT JOIN ADM_PUB.ADM_PUB_INSU_CST_PD_LIST_MNG  T7 --保险代销客户产品清单-全量
ON      T1.SYS_SRL_NBR = T7.TRX_SEQ --交易流水号
AND     T7.MNG_TYP = '2'            --取销售信息
AND     T7.DT = '20240327'
LEFT JOIN edw.dim_bus_insu_cmp_inf_dd	        T8 --保险公司信息
ON T6.cmp_cd=T8.cmp_cd
AND T8.DT='20240327'
WHERE   T1.DT = '20240327'
AND     T1.TRX_DT <='20240327'
AND     T1.TRX_CD = '510001' --交易代码 510001新保承保
;
--贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_04 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '20240327'
AND replace(ORD_TM,'-','') between '20230101' and '20240327'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '20240327'
AND replace(ORD_TM,'-','') between '20230101' and '20240327'   --交易时间
;
--财富产品交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_06 AS
SELECT T1.CST_ID,T1.SYS_SRL_NBR,'保险' PROD_CLASS,CMP_NM
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR   --保险
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_TM,T1.TRX_AMT,t1.insu_fee
    ,T1.SAL_PSN_ID,T3.EMPE_NM SAL_PSN_NM            --销售人
    ,T1.SAL_ORG_ID,T4.SBR_ORG_NM,T4.BRC_ORG_NM,t4.TEM_ORG_NM      --销售人机构
FROM SJXQ_SJ2024032831_CST_02               T1  --保险
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD            T3
ON  T1.SAL_PSN_ID = T3.EMPE_ID
AND T3.DT = '20240327'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD    T4 --考核机构树
ON      T1.SAL_ORG_ID = T4.ORG_ID
AND     T4.DT = '20240327'
UNION all
SELECT CST_ID,ORD_ID,'贵金属',PVD_NM
    ,NULL,NULL,NULL,NULL
    ,ORD_STS,'购买',NULL,CMDT_NM,GOODS_TYP
    ,TRX_DT,substr(PMT_TM,12,19),TRX_AMT,NULL
    ,RCM_PSN_ID,RCM_PSN_NM
    ,RCM_PSN_AFL_DEPT_ID
    ,RCM_PSN_AFL_SUB_BRN
    ,RCM_PSN_AFL_BRN,RCM_PSN_AFL_DEPT
FROM SJXQ_SJ2024032831_CST_04   T1  --贵金属
;
-- 前后15天贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_08 AS
select a.cst_ID,a.trx_dt
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行年利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,g.DTRB_AMT                            --发放金额
    ,E.cd_val_dscr FIVE_CTG                --五级分类
    ,case when b.crc_ind = '1' then '循环贷款'
            OR SUBSTR(b.PD_CD,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                                                  --贷款用途
    ,B.USG_CMT                                                      --贷款用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt    --贷款利率优惠备注
    ,case when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan              --是否政策性贷款
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
    ,row_number() over(partition by a.cst_ID,a.trx_dt order by ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) asc)rn
from(
    SElECT distinct cst_ID,trx_dt
    from SJXQ_SJ2024032831_CST_06
)a INNER JOIN edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.cst_ID = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.DT = '20240327'
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '20240327'
and ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd'))<=15 --交易日前后15天内的贷款
left join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '20240327'
left join edw.dwd_code_library_dd           E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='20240327'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '20240327'
LEFT JOIN (
    SELECT BUS_CTR_ID,DTRB_DT,amt DTRB_AMT  --发放日期,金额
        ,row_number() over(partition by bus_ctr_id order by dtrb_dt asc) rn
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '20240327'
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID and G.rn=1
;
--与当笔贷款贷款类型相同的前一笔贷款合同号
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_09 AS
SElECT t1.cst_ID,t1.loan_type,t1.DTRB_DT
    ,t2.BUSI_CTR_ID             lst_BUSI_CTR_ID
    ,t2.DTRB_DT                 lst_DTRB_DT
    ,t2.ref_year_intr_rat       lst_ref_year_intr_rat
    ,t2.INTR_RAT                lst_INTR_RAT
    ,t2.aprv_exe_mon_intr_rat   lst_mon_intr_rat
    ,t2.CTR_AMT                 lst_CTR_AMT
    ,row_number() OVER(partition by t1.cst_ID,t1.loan_type,t1.DTRB_DT order by t2.DTRB_DT desc) rn
from( --交易日前后15天内的贷款信息
    SElECT distinct cst_id,DTRB_DT,loan_type
    from SJXQ_SJ2024032831_CST_08
    where rn=1
)t1 inner join (
    select b.cst_ID
        ,B.BUSI_CTR_ID                         --合同流水号
        ,B.CTR_AMT                             --合同金额
        ,c.ref_year_intr_rat                   --参考年利率
        ,B.INTR_RAT                            --执行年利率
        ,c.aprv_exe_mon_intr_rat               --执行月利率
        ,G.DTRB_DT                             --发放日期
        ,case when b.crc_ind = '1' then '循环贷款'
                OR SUBSTR(b.PD_CD,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    FROM edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
    INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
    ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
    AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
    AND     C.DT = '20240327'
    LEFT JOIN (
        SELECT  BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
        WHERE DT = '20240327'
        GROUP BY BUS_CTR_ID
    ) G ON  B.BUSI_CTR_ID = G.BUS_CTR_ID
    WHERE   NVL(B.CST_ID,'') <> ''  --剔除空值和空
    AND     B.DT = '20240327'
)t2 on t1.cst_ID=t2.cst_ID and t1.loan_type=t2.loan_type
and t2.DTRB_DT < t1.DTRB_DT     --历史发放贷款
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_10 AS
SElECT T1.SYS_SRL_NBR,T1.PROD_CLASS,t1.CMP_NM
    ,T1.INSU_PLCY_ID,T1.INSU_PLCY_STS,T1.PAY_YEAR_PRD_TYP,T1.PAY_YEAR
    ,T1.TRX_STS,T1.TRX_CD,T1.PD_CD,T1.PD_NM,T1.PROD_TYPE
    ,T1.TRX_DT,T1.TRX_AMT,t1.insu_fee
    ,T1.SAL_PSN_ID,T1.SAL_PSN_NM        --销售人
    ,T1.SAL_ORG_ID,T1.SBR_ORG_NM
    ,T1.BRC_ORG_NM,t1.TEM_ORG_NM        --销售人机构
    ,T1.CST_ID
    ,T3.BUSI_CTR_ID,T3.loan_type,T3.FIVE_CTG,T3.dtrb_dt,t3.DTRB_AMT
    ,T3.ref_year_intr_rat
    ,T3.INTR_RAT,t3.REF_MON_INTR_RAT,T3.aprv_exe_mon_intr_rat,T3.ctr_amt
    ,T3.is_zc_loan,T3.is_jl_loan
    ,T3.LOAN_USG_CD,T3.USG_CMT,T3.intr_rat_adj_cmt,T3.pre_ases_res,t3.DIFF_TM
    ,T4.lst_BUSI_CTR_ID
	,T4.lst_DTRB_DT
	,T4.lst_ref_year_intr_rat
	,T4.lst_INTR_RAT
	,T4.lst_mon_intr_rat            --执行月利率
	,T4.lst_CTR_AMT
from SJXQ_SJ2024032831_CST_06      T1  --交易主表
LEFT JOIN SJXQ_SJ2024032831_CST_08 T3  --前后15天内的贷款
ON T1.CST_ID=T3.CST_ID
AND T1.TRX_DT=T3.TRX_DT
and t3.rn=1
LEFT JOIN SJXQ_SJ2024032831_CST_09 T4  --前一笔贷款
ON  T3.CST_ID=T4.CST_ID
AND T3.LOAN_TYPE=T4.LOAN_TYPE
AND T3.DTRB_DT = T4.DTRB_DT
AND T4.RN=1
;
--输出结果 保险
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_11 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_11 AS
select '20230327'                       数据日期
    ,T1.SYS_SRL_NBR                     交易流水号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.PROD_TYPE                       产品类型
    ,T1.INSU_PLCY_ID                    保单号
    ,t1.CMP_NM                          保险公司
    ,T1.TRX_STS                         交易状态
    ,T1.PD_CD                           产品代码
    ,T1.PD_NM                           产品名称
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_AMT                         交易金额
    ,t1.insu_fee                        保费
    ,T1.TRX_CD                          交易代码_业务代码
    ,T1.SAL_PSN_ID                      销售人工号
    ,T1.SAL_PSN_NM                      销售人姓名
    ,T1.SAL_ORG_ID                      销售人所在机构ID
    ,t1.TEM_ORG_NM                      销售人所在团队
    ,T1.SBR_ORG_NM                      销售人所在支行
    ,T1.BRC_ORG_NM                      销售人所在分行
    ,T1.CST_ID							购买人客户号
    ,T1.BUSI_CTR_ID                     财富业务交易日前后15天内的贷款合同号
    ,T1.loan_type                       当笔贷款类型
    ,T1.FIVE_CTG                        当笔贷款五级分类
    ,T1.dtrb_dt                         当笔贷款发放日期
    ,t1.DTRB_AMT                        贷款金额
    ,T1.REF_MON_INTR_RAT                当笔贷款参考月利率
    ,T1.aprv_exe_mon_intr_rat           当笔贷款执行月利率
    ,T1.ctr_amt                         当笔贷款合同金额
    ,T1.lst_BUSI_CTR_ID                 与当笔贷款贷款类型相同的前一笔贷款合同号
    ,T1.lst_DTRB_DT                     前一笔贷款发放日期
	,T1.lst_mon_intr_rat                前一笔贷款执行月利率
	,T1.lst_CTR_AMT                     前一笔贷款合同金额
from SJXQ_SJ2024032831_CST_10 T1
WHERE PROD_CLASS='保险'
;
--输出结果 贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ2024032831_CST_12 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024032831_CST_12 AS
select '20230327'                       数据日期
    ,T1.SYS_SRL_NBR                     订单号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.PROD_TYPE                       商品分类
    ,t1.CMP_NM                          贵金属公司
    ,T1.TRX_STS                         订单状态
    ,T1.PD_NM                           产品名称
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_AMT                         交易金额
    ,T1.SAL_PSN_ID                      销售人工号
    ,T1.SAL_PSN_NM                      销售人姓名
    ,T1.SAL_ORG_ID                      销售人所在机构ID
    ,t1.TEM_ORG_NM                      销售人所在团队
    ,T1.SBR_ORG_NM                      销售人所在支行
    ,T1.BRC_ORG_NM                      销售人所在分行
    ,T1.CST_ID							购买人客户号
    ,T1.BUSI_CTR_ID                     财富业务交易日前后15天内的贷款合同号
    ,T1.loan_type                       当笔贷款类型
    ,T1.FIVE_CTG                        当笔贷款五级分类
    ,T1.dtrb_dt                         当笔贷款发放日期
    ,t1.DTRB_AMT                        贷款金额
    ,T1.REF_MON_INTR_RAT                当笔贷款参考月利率
    ,T1.aprv_exe_mon_intr_rat           当笔贷款执行月利率
    ,T1.ctr_amt                         当笔贷款合同金额
    ,T1.lst_BUSI_CTR_ID                 与当笔贷款贷款类型相同的前一笔贷款合同号
    ,T1.lst_DTRB_DT                     前一笔贷款发放日期
	,T1.lst_mon_intr_rat                前一笔贷款执行月利率
	,T1.lst_CTR_AMT                     前一笔贷款合同金额
    ,case when T1.lst_mon_intr_rat is not null then T1.lst_mon_intr_rat - T1.aprv_exe_mon_intr_rat
        else NULL end                   前一笔执行月利率_当前执行月利率
    ,case when T1.lst_CTR_AMT is not null then T1.ctr_amt/T1.lst_CTR_AMT
        else null end                   当前笔合同金额比前一笔
    ,t1.DIFF_TM                         贷款申请与购买间隔日期
from SJXQ_SJ2024032831_CST_10 T1
WHERE PROD_CLASS='贵金属'
;
SElECT '02' seq, count(1) cnt, count(distinct cst_id,TRX_DT) custs
from SJXQ_SJ2024032831_CST_02
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id,TRX_DT) custs
from SJXQ_SJ2024032831_CST_04
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id,TRX_DT) custs
from SJXQ_SJ2024032831_CST_06
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id,TRX_DT) custs
from SJXQ_SJ2024032831_CST_08 where rn=1
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_ID,loan_type,DTRB_DT) custs
from SJXQ_SJ2024032831_CST_09 where rn=1
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id,TRX_DT) custs
from SJXQ_SJ2024032831_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct 购买人客户号,交易日期) custs
from SJXQ_SJ2024032831_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 购买人客户号,交易日期) custs
from SJXQ_SJ2024032831_CST_12
;
/*
02	54802	53257
04	57878	46329
06	112680	99504
08	20440	20440
09	14167	14167
10	112680	99504
11	54802	53257
12	57878	46329
*/***SJ20240401136_挂钩型理财统一风险控制.sql
-- 存续期的挂钩型理财产品
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_01 AS
select pd_cd                                    --产品代码|C24
	,pd_nm                                    --产品名称|C256
	,rsk_grd                                  --风险等级|INTEGER
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='@@{yyyyMMdd}'
,'CC012','CC013','CC014','CC015','CC016','CC017','CC018','CC019','CC020','CC021','CC022'
,'CC023','CC024','CC025','CC026','CC027','CC028','CC029','CC030','CC031','CC032','CC033'
,'CC034','CC035','CC036','CC037','CC038','CC039','CC040','CC041','CC042','CC043','CC044'
,'CC045','CC046','CC047','CC048','CC049','CC050','CC051','CC052','CC053','CC054','CC055'
,'CC056','CC057','CC058','CC059','CC060','CC061','CC062','CC063','CC064','CC065','CC066'
,'CC067','CC068','CC069','CC070','CC071','CC072','CC073','CC074','CC075','CC076','CC077'
,'CC078','CC079','CC080','CC081','CC083','CC084','CC085','CC087','CC088','CC089','CC090'
,'CC091','CC092','CC093','CC094','CC095','CC096','CC097','CC098','CC099','CC100','CC101'
,'CC102','CC103','CC105','CC106','CC107','CC108','CC111','CC112','CC115','CC117','CC118'
,'CC119','CC120','CC121','CC122','CC123','CC124','CC127','CC128','CC129','CC130','CC131'
,'CC132','CC133','CC135','CC136','CC137','CC138','CC139','CC140','CC141','CC142','CC143'
,'CC144','CC145','CC147','CC148','CC149','CC150','CC151','CC152','CC153','CC155','CC156'
,'CC157','CC158','CC159','CC160','CC161','CC162','CC163','CC164','CC165','CC166','CC167'
,'CC168','CC169','CC170','CC171','CC172','CC173','CC174','CC175','CC176','CC177','CC178'
,'CC179','CC180','CC181','CC182','CC183','CC184','CC185','CC186','CC187')
;
-- 序号	客户号	客户姓名	申请日期	确认日期	交易渠道	交易金额	确认金额 产品代码	产品名称
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_02 AS
SElECT t1.srl_nbr
    ,t2.trx_dt ,t2.trx_tm ,t2.trx_cd ,t2.tacd
	,t2.cst_id ,t2.bnk_act_id ,t2.pd_cd ,t2.trx_amt
    ,t2.trx_sts_cd
	,t2.act_sts_cd                               --账务状态代码
	,t2.cfm_dt
	,t2.mgr_id                                   --客户经理号
    ,t3.pd_nm
    ,t1.tacd            cfm_tacd
	,t1.cfm_dt          cfm_cfm_dt
	,t1.trx_dt          cfm_trx_dt
	,t1.trx_tm          cfm_trx_tm
	,t1.trx_cd          cfm_trx_cd
	,t1.bus_cd ,t1.trx_org_id ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
	,t1.cst_id          cfm_cst_id
	,t1.bnk_act_id      cfm_bnk_act_id
	,t1.pd_cd           cfm_pd_cd
	,t1.trx_amt         cfm_trx_amt
	,t1.cfm_amt
	,t1.mgr_id          cfm_mgr_id
    ,t4.sam_rsk_ctrl_id
from EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI             t1 --理财交易确认流水明细
left join edw.dwd_bus_chm_trx_rqs_srl_dtl_di    t2
on t1.srl_nbr=t2.srl_nbr
and t2.dt<='@@{yyyyMMdd}' -- 最小 trx_dt 20220628
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t2.trx_cd IN ( '100200' , '100201' , '100213' , '100211' , '100214' , '100257' , '100256' )
-- AND t2.trx_sts_cd IN ( '0' , '1' , '5' , '6' , '7' , 'A' , 'G' , 'Z' , '8' )
inner join SJXQ_SJ20240401136_CST_01            t3
on t1.pd_cd=t3.pd_cd
left join edw.dws_cst_bas_inf_dd                t4
on  t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
where t1.dt<='@@{yyyyMMdd}'     --确认日期
AND t1.trx_sts_cd ='8'          --确认成功
AND T1.TRX_AMT > 0              --交易金额
;
-- 销售人员工号	销售人员姓名	所属分行	所属支行
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_03 AS
SELECT t1.cst_id,t1.pd_cd
from edw.dws_bus_chm_act_mgr_inf_dd         t1 --理财考核汇总信息
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  t1.mgr_id=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t1.acs_org_id=t3.org_id
and t3.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.MNG_TYP_CD = '2'    --`管户`类型 1考核 2销售
and t1.PD_TP_CD='1'        --理财
and t1.pd_cd like 'CC%'
GROUP BY t1.cst_id,t1.pd_cd
;
--同一风险控制号 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_04 AS
select t1.cst_id,t1.sam_rsk_ctrl_id,t2.cst_id rsk_cst_id
from(
    SElECT distinct cst_id,sam_rsk_ctrl_id
    from SJXQ_SJ20240401136_CST_02
    where nvl(sam_rsk_ctrl_id,'')<>''
)t1 left join edw.dws_cst_bas_inf_dd                    t2
on  t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t2.dt='@@{yyyyMMdd}'
;
-- 客户同一风险控制号下征信分数
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_05 AS
select t1.cst_id,t1.sam_rsk_ctrl_id,t1.rsk_cst_id
    ,t3.digital_unscr,t3.report_id
    ,row_number() over(partition by t1.cst_id,t1.sam_rsk_ctrl_id,t1.rsk_cst_id order by t3.report_id desc) rn
from SJXQ_SJ20240401136_CST_04      t1
left join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di t3 --个人征信基本概要信息
on  t1.rsk_cst_id=t3.cst_id
and t3.dt <= '@@{yyyyMMdd}'
;
-- 客户同一风险控制号下风险等级（黑名单/高风险） 客户同一风险控制号下近6个月逾期金额
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_06 AS
select t1.cst_id,t1.sam_rsk_ctrl_id,t1.rsk_cst_id
    ,decode(t2.cst_rsk_grd,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险','6','黑名单','') cst_rsk_grd_nm
    ,t3.zxovd_l6m_m1up_ovrdamt_mthmax
from SJXQ_SJ20240401136_CST_04          t1
left join(
    select cst_id,max(cst_rsk_grd) cst_rsk_grd
    from edw.dim_bus_loan_ctr_inf_dd
    where dt = '@@{yyyyMMdd}'
    group by cst_id
)   t2 --信贷合同信息
on  t1.rsk_cst_id=t2.cst_id
left join adm_pub.adm_csm_cbus_out_crd_idv_ovd_rcd_dd t3 --客户集市-业务信息-个人征信-逾期记录信息表
on  t1.rsk_cst_id=t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_07 AS
SElECT row_number() over(order by t2.srl_nbr) rn
    ,t2.cst_id
    ,t1.cst_chn_nm
    ,t2.trx_dt,t2.cfm_trx_dt,t2.trx_chnl,t2.trx_amt,t2.cfm_trx_amt
    ,t2.pd_cd,t2.pd_nm,t2.mgr_id apl_mgr_id,t2.cfm_mgr_id
    ,t3.mgr_id,t3.mgr_nm,t3.brc_org_nm,t3.sbr_org_NM
    ,t2.sam_rsk_ctrl_id
    ,t4.rsk_cst_id
    ,t5.digital_unscr
    ,t6.cst_rsk_grd_nm
    ,t6.zxovd_l6m_m1up_ovrdamt_mthmax
from SJXQ_SJ20240401136_CST_02              t2
left join SJXQ_SJ20240401136_CST_03         t3
on  t2.cst_id=t3.cst_id
and t2.pd_cd=t3.pd_cd
left join SJXQ_SJ20240401136_CST_04         t4
on  t2.cst_id=t4.cst_id
and t2.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
left join SJXQ_SJ20240401136_CST_05         t5
on  t4.cst_id=t5.cst_id
and t4.sam_rsk_ctrl_id=t5.sam_rsk_ctrl_id
and t4.rsk_cst_id=t5.rsk_cst_id
and t5.rn=1
left join SJXQ_SJ20240401136_CST_06         t6
on  t4.cst_id=t6.cst_id
and t4.sam_rsk_ctrl_id=t6.sam_rsk_ctrl_id
and t4.rsk_cst_id=t6.rsk_cst_id
left join edw.dim_cst_bas_inf_dd	        t1
on t2.cst_id=t1.cst_id --客户基本信息
and t1.dt='@@{yyyyMMdd}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240401136_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240401136_CST_08 AS
SElECT rn                               序号
    ,cst_id                             客户号
    ,cst_chn_nm                         客户姓名
    ,trx_dt                             申请日期
    ,cfm_trx_dt                         确认日期
    ,trx_chnl                           交易渠道
    ,trx_amt                            交易金额
    ,cfm_trx_amt                        确认金额
    ,mgr_id                             销售人员工号
    ,mgr_nm                             销售人员姓名
    ,brc_org_nm                         所属分行
    ,sbr_org_NM                         所属支行
    ,pd_cd                              产品代码
    ,pd_nm                              产品名称
    ,sam_rsk_ctrl_id                    同一风险控制号
    ,rsk_cst_id                         同一风险控制号下客户号
    ,digital_unscr                      客户同一风险控制号下征信分数
    ,cst_rsk_grd_nm                     客户同一风险控制号下风险等级
    ,zxovd_l6m_m1up_ovrdamt_mthmax      客户同一风险控制号下近6个月逾期金额
from SJXQ_SJ20240401136_CST_07
;
SElECT '01' seq, count(1) cnt, count(distinct pd_cd) custs
from SJXQ_SJ20240401136_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cfm_cst_id,cfm_trx_dt) custs
from SJXQ_SJ20240401136_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id,pd_cd) custs
from SJXQ_SJ20240401136_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id,sam_rsk_ctrl_id) custs
from SJXQ_SJ20240401136_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id,sam_rsk_ctrl_id,rsk_cst_id) custs
from SJXQ_SJ20240401136_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id,sam_rsk_ctrl_id,rsk_cst_id) custs
from SJXQ_SJ20240401136_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ20240401136_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct 客户号,申请日期) custs
from SJXQ_SJ20240401136_CST_08
;
/*
01	173	173
02	38384	36979
03	430185	430185
04	31585	16102
05	31585	31585
06	31585	31585
07	60773	36974
08	60773	36974
*/***SJ2024040201_清算挂账处理.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024040201_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040201_CST_00 AS
SElECT cst_id,cst_act_id,act_nm
    ,min(gz_dt)         gz_dt
    ,sum(gz_amt)        gz_amt
    ,max(gz_reason)     gz_reason
FROM qbi_file_20240409_09_17_20
group by cst_id,cst_act_id,act_nm
;
--存款账户管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040201_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040201_CST_01 AS
select t1.cst_id,t1.cst_act_id
from edw.dwd_bus_dep_cst_act_mgr_inf_dd     t1      --存款客户账户`管户`信息 cst_id,cst_act_id,acs_org_id, mgr_id 唯一
left join edw.dws_hr_empe_inf_dd            t2      --员工信息汇总 empe_id 唯一
on  T1.mgr_id=T2.empe_id
AND T2.DT='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4      --考核机构树 org_id 唯一
on      t1.acs_org_id = t4.org_id
and     t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
GROUP by t1.cst_id,t1.cst_act_id
;
-- 信贷管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040201_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040201_CST_02 AS
SElECT t1.cst_id
    -- ,t1.stl_nbr	    --结算帐号|C64
from edw.dim_bus_loan_ctr_inf_dd            t1
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t2
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t3      --员工信息汇总 empe_id 唯一
on  T2.acs_mngr_id=T3.empe_id
AND T3.DT='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4      --考核机构树 org_id 唯一
on      t2.acs_org_id = t4.org_id
and     t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and NVL(t1.cst_id,'') <> ''    --剔除空值和空
GROUP by t1.cst_id
;
-- 财富管户、财富顾问、主管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040201_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040201_CST_03 AS
select COALESCE(T2.CST_ID,T1.CST_ID) CST_ID
    ,t1.cst_act_id,t1.act_nm,t1.gz_dt,t1.gz_amt,t1.gz_reason
    ,decode(t2.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结','F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
    ,t3.wlth_mng_mnl_id,t3.wlth_mng_org_id,t3.wlth_advsr_id
    ,t4.prm_mgr_nm
    ,t5.sbr_org_nm prm_org_nm
from SJXQ_SJ2024040201_CST_00                       t1
left join edw.dim_bus_dep_cst_act_inf_dd            T2 --客户存款账户信息
on  t1.cst_act_id=t2.cst_act_id
AND T2.DT='@@{yyyyMMdd}'
LEFT JOIN edw.dim_bus_chm_fnd_cst_ctr_inf_dd        t3 --财富管户 财富顾问
on  COALESCE(T2.CST_ID,T1.CST_ID)=t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t4 --客户`主管户`信息 cst_id 唯一
on  COALESCE(T2.CST_ID,T1.CST_ID) = t4.cst_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树 org_id 唯一
on  t4.prm_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
;
--汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024040201_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040201_CST_04 AS
SElECT t1.cst_ID
    ,t1.cst_act_id
    ,t1.act_nm
    ,t1.gz_dt
    ,t1.gz_amt
    ,coalesce(t2.dep_act_mng_mgr,t2.dep_act_mgr_id,'')  dep_act_mng_mgr
    ,coalesce(t2.dep_act_mng_org,t2.dep_act_org_id,'')  dep_act_mng_org
    ,coalesce(t3.EMPE_NM,T1.wlth_mng_mnl_id,'')         wlth_mng_nm
    ,coalesce(t4.sbr_org_nm,t1.wlth_mng_org_id,'')      wlth_mng_org
    ,coalesce(t5.EMPE_NM,T1.wlth_advsr_id,'')           wlth_advsr_nm
    ,coalesce(t6.sbr_org_nm,t5.org_id,'')               wlth_advsr_org
    ,t1.prm_mgr_nm
    ,t1.prm_org_nm
    ,coalesce(t7.loan_mng_mgr,t7.loan_mng_mgr_id,'')    loan_mng_mgr
    ,coalesce(t7.loan_mng_org,t7.loan_mng_org_id,'')    loan_mng_org
    ,t1.act_sts
    ,t1.gz_reason
from SJXQ_SJ2024040201_CST_03        t1
left join SJXQ_SJ2024040201_CST_01   t2
on  t1.cst_act_id=t2.cst_act_id
left join edw.dws_hr_empe_inf_dd                t3      --员工信息汇总 empe_id 唯一
on  T1.wlth_mng_mnl_id=T3.empe_id
AND T3.DT='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd        t4      --考核机构树 org_id 唯一
on  t1.wlth_mng_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                t5      --员工信息汇总 empe_id 唯一
on  T1.wlth_advsr_id=t5.empe_id
AND t5.DT='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd        t6      --考核机构树 org_id 唯一
on  t5.org_id = t6.org_id
and t6.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2024040201_CST_02              t7
on t1.cst_id=t7.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024040201_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040201_CST_05 AS
SElECT cst_ID               客户号
    ,cst_act_id		        客户账号
    ,act_nm                 账户名称
    ,gz_dt                  挂账日期
    ,gz_amt                 挂账金额
    ,dep_act_mng_mgr        存款账户管户人
    ,dep_act_mng_org        存款账户管户支行
    ,wlth_mng_nm            财富管户人
    ,wlth_mng_org           财富管户支行
    ,wlth_advsr_nm          财富顾问
    ,wlth_advsr_org         财富顾问支行
    ,prm_mgr_nm             主管户人
    ,prm_org_nm             主管户支行
    ,loan_mng_mgr           信贷管户人
    ,loan_mng_org           信贷管户支行
    ,act_sts                账户状态
    ,gz_reason              挂账原因
from SJXQ_SJ2024040201_CST_04
;
SElECT '00' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024040201_CST_00
union all
SElECT '01' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024040201_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040201_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024040201_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024040201_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 客户账号) custs
from SJXQ_SJ2024040201_CST_05
;
/*
00	339	339
01	15126010	15125998
02	1826675	1826675
03	339	339
04	339	339
05	339	339
*/
***SJ2024040221_贵金属合规.sql
-- 一下订单和报表是对应的，但是关联贷款，报表数据会存在重复订单记录
--贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_04 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'DTL' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '20240327'
AND replace(ORD_TM,'-','') between '20230101' and '20240327'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,'HAND' DATA_SRC2
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '20240327'
AND replace(ORD_TM,'-','') between '20230101' and '20240327'   --交易时间
;
-- 客户在销售日是否信贷有效户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_05 AS
select t1.cst_ID,t1.trx_dt
    ,t2.sam_rsk_ctrl_id
    ,t3.efe_loan_cst_ind		-- 销售日是否信贷有效户 有效信贷户
from(
    SElECT distinct CST_ID,trx_dt
    from SJXQ_SJ2024040221_CST_04
)t1 left join edw.dws_cst_bas_inf_dd            t2
on  t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join app_rpt.adm_subl_cst_wlth_bus_inf_dd 	t3  --正式客户财富业务信息表
on  t1.cst_id=t3.cst_id and t1.trx_dt=t3.dt
and t3.dt between '20230101' and '20240327'     --交易日期范围
;
-- 客户同一风险控制号在销售日是否信贷有效户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_06 AS
SElECT t1.cst_ID,t1.trx_dt
    ,max(t3.efe_loan_cst_ind)   sam_rsk_cst_efe_loan
from SJXQ_SJ2024040221_CST_05                   t1
left join edw.dws_cst_bas_inf_dd                t2
on  t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t2.dt='@@{yyyyMMdd}'
left join app_rpt.adm_subl_cst_wlth_bus_inf_dd 	t3  --正式客户财富业务信息表
on  t2.cst_id=t3.cst_id     --同一风险控制号 下客户
and t1.trx_dt=t3.dt         --交易日
and t3.dt between '20230101' and '20240327'     --交易日期范围
where nvl(t1.sam_rsk_ctrl_id,'')<>''
GROUP by t1.cst_ID,t1.trx_dt
;
-- 前后15天贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_08 AS
select a.cst_ID,a.trx_dt
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行年利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,g.DTRB_AMT                            --发放金额
    ,E.cd_val_dscr FIVE_CTG                --五级分类
    ,case when b.crc_ind = '1' then '循环贷款'
            OR SUBSTR(b.PD_CD,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                                                  --贷款用途
    ,B.USG_CMT                                                      --贷款用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt    --贷款利率优惠备注
    ,case when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan              --是否政策性贷款
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
    ,row_number() over(partition by a.cst_ID,a.trx_dt order by ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) asc)rn
from(
    SElECT distinct cst_ID,trx_dt
    from SJXQ_SJ2024040221_CST_06
)a INNER JOIN edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.cst_ID = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.DT = '20240327'
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '20240327'
and ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd'))<=15 --交易日前后15天内的贷款
left join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '20240327'
left join edw.dwd_code_library_dd           E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='20240327'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '20240327'
LEFT JOIN (
    SELECT BUS_CTR_ID,DTRB_DT,amt DTRB_AMT  --发放日期,金额
        ,row_number() over(partition by bus_ctr_id order by dtrb_dt asc) rn
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '20240327'
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID and G.rn=1
;
--与当笔贷款贷款类型相同的前一笔贷款合同号
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_09 AS
SElECT t1.cst_ID,t1.loan_type,t1.DTRB_DT
    ,t2.BUSI_CTR_ID             lst_BUSI_CTR_ID
    ,t2.DTRB_DT                 lst_DTRB_DT
    ,t2.ref_year_intr_rat       lst_ref_year_intr_rat
    ,t2.INTR_RAT                lst_INTR_RAT
    ,t2.aprv_exe_mon_intr_rat   lst_mon_intr_rat
    ,t2.CTR_AMT                 lst_CTR_AMT
    ,row_number() OVER(partition by t1.cst_ID,t1.loan_type,t1.DTRB_DT order by t2.DTRB_DT desc) rn
from( --交易日前后15天内的贷款信息
    SElECT distinct cst_id,DTRB_DT,loan_type
    from SJXQ_SJ2024040221_CST_08
    where rn=1
)t1 inner join (
    select b.cst_ID
        ,B.BUSI_CTR_ID                         --合同流水号
        ,B.CTR_AMT                             --合同金额
        ,c.ref_year_intr_rat                   --参考年利率
        ,B.INTR_RAT                            --执行年利率
        ,c.aprv_exe_mon_intr_rat               --执行月利率
        ,G.DTRB_DT                             --发放日期
        ,case when b.crc_ind = '1' then '循环贷款'
                OR SUBSTR(b.PD_CD,1,7)='2010503' then '一般贷款' ELSE '其他' end loan_type
    FROM edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
    INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
    ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
    AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
    AND     C.DT = '20240327'
    LEFT JOIN (
        SELECT  BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
        WHERE DT = '20240327'
        GROUP BY BUS_CTR_ID
    ) G ON  B.BUSI_CTR_ID = G.BUS_CTR_ID
    WHERE   NVL(B.CST_ID,'') <> ''  --剔除空值和空
    AND     B.DT = '20240327'
)t2 on t1.cst_ID=t2.cst_ID and t1.loan_type=t2.loan_type
and t2.DTRB_DT < t1.DTRB_DT     --历史发放贷款
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_10 AS
SElECT T1.ORD_ID,'贵金属' PROD_CLASS,t1.PVD_NM CMP_NM
    ,T1.ORD_STS,CMDT_NM PD_NM,GOODS_TYP PROD_TYPE
    ,T1.TRX_DT,T1.TRX_AMT
    ,T1.RCM_PSN_ID              SAL_PSN_ID
    ,T1.RCM_PSN_NM              SAL_PSN_NM        --销售人
    ,T1.RCM_PSN_AFL_DEPT_ID     SAL_ORG_ID
    ,T1.RCM_PSN_AFL_SUB_BRN     SBR_ORG_NM
    ,T1.RCM_PSN_AFL_BRN         BRC_ORG_NM
    ,t1.RCM_PSN_AFL_DEPT        TEM_ORG_NM        --销售人机构
    ,T1.CST_ID
    ,t2.efe_loan_cst_ind
    ,t3.sam_rsk_cst_efe_loan
    ,T4.BUSI_CTR_ID,T4.loan_type,T4.FIVE_CTG,T4.dtrb_dt,t4.DTRB_AMT
    ,T4.ref_year_intr_rat
    ,T4.INTR_RAT,t4.REF_MON_INTR_RAT,T4.aprv_exe_mon_intr_rat,T4.ctr_amt
    ,T4.is_zc_loan,T4.is_jl_loan
    ,T4.LOAN_USG_CD,T4.USG_CMT,T4.intr_rat_adj_cmt,T4.pre_ases_res,t4.DIFF_TM
    ,T5.lst_BUSI_CTR_ID
	,T5.lst_DTRB_DT
	,T5.lst_ref_year_intr_rat
	,T5.lst_INTR_RAT
	,T5.lst_mon_intr_rat            --执行月利率
	,T5.lst_CTR_AMT
from SJXQ_SJ2024040221_CST_04      T1  --交易主表
left join SJXQ_SJ2024040221_CST_05 t2
on t1.cst_ID=t2.cst_ID
and t1.trx_dt=t2.trx_dt
left join SJXQ_SJ2024040221_CST_06 t3
on t1.cst_ID=t3.cst_ID
and t1.trx_dt=t3.trx_dt
LEFT JOIN SJXQ_SJ2024040221_CST_08 T4  --前后15天内的贷款
ON T1.CST_ID=T4.CST_ID
AND T1.TRX_DT=T4.TRX_DT
and t4.rn=1
LEFT JOIN SJXQ_SJ2024040221_CST_09 T5  --前一笔贷款
ON  T4.CST_ID=T5.CST_ID
AND T4.LOAN_TYPE=T5.LOAN_TYPE
AND T4.DTRB_DT = T5.DTRB_DT
AND T5.RN=1
;
--输出结果 贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ2024040221_CST_11 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040221_CST_11 AS
select '20230327'                       数据日期
    ,T1.ORD_ID                          订单号
    ,T1.PROD_CLASS                      财富产品分类
    ,T1.PROD_TYPE                       商品分类
    ,t1.CMP_NM                          贵金属公司
    ,T1.ORD_STS                         订单状态
    ,T1.PD_NM                           产品名称
    ,T1.TRX_DT                          交易日期
    ,T1.TRX_AMT                         交易金额
    ,T1.SAL_PSN_ID                      销售人工号
    ,T1.SAL_PSN_NM                      销售人姓名
    ,T1.SAL_ORG_ID                      销售人所在机构ID
    ,t1.TEM_ORG_NM                      销售人所在团队
    ,T1.SBR_ORG_NM                      销售人所在支行
    ,T1.BRC_ORG_NM                      销售人所在分行
    ,T1.CST_ID                          购买人客户号
    ,t1.efe_loan_cst_ind                客户在销售日是否信贷有效户
    ,t1.sam_rsk_cst_efe_loan            客户同一风险控制号在销售日是否信贷有效户
    ,T1.BUSI_CTR_ID                     财富业务交易日前后15天内的贷款合同号
    ,T1.loan_type                       当笔贷款类型
    ,T1.FIVE_CTG                        当笔贷款五级分类
    ,T1.dtrb_dt                         当笔贷款发放日期
    ,t1.DTRB_AMT                        贷款金额
    ,T1.REF_MON_INTR_RAT                当笔贷款参考月利率
    ,T1.aprv_exe_mon_intr_rat           当笔贷款执行月利率
    ,T1.ctr_amt                         当笔贷款合同金额
    ,T1.lst_BUSI_CTR_ID                 与当笔贷款贷款类型相同的前一笔贷款合同号
    ,T1.lst_DTRB_DT                     前一笔贷款发放日期
	,T1.lst_mon_intr_rat                前一笔贷款执行月利率
	,T1.lst_CTR_AMT                     前一笔贷款合同金额
    ,case when T1.lst_mon_intr_rat is not null then T1.lst_mon_intr_rat - T1.aprv_exe_mon_intr_rat
        else NULL end                   前一笔执行月利率_当前执行月利率
    ,case when nvl(T1.lst_CTR_AMT,0)<>0 then T1.ctr_amt/T1.lst_CTR_AMT
        else null end                   当前笔合同金额比前一笔
    ,t1.DIFF_TM                         贷款申请与购买间隔日期
from SJXQ_SJ2024040221_CST_10 T1
;
SElECT '04' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024040221_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024040221_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024040221_CST_06
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024040221_CST_08 where rn=1
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,DTRB_DT) custs
from SJXQ_SJ2024040221_CST_09 where rn=1
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024040221_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct 购买人客户号,交易日期) custs
from SJXQ_SJ2024040221_CST_11
;
/*
04	57993	46395
05	46395	46395
06	42828	42828
08	8205	8205
09	5454	5454
10	57993	46395
11	57993	46395
*/***SJ2024040326_张家港塘桥支行.sql
/*
2023.11.1-2024.3.31期间，苏州分行张家港塘桥支行财富AUM日均及财富有效户交接数据；财富新增有效户前50户；储蓄新增有效户前250户数据。
1. 有效储蓄户如何定义的？开立存款账号的嘛？整存整取，苏乐定两个产品满10000元
2. 新增是较 20231031 日客户状态的新增吗，还是历史首次达标？历史首次达标
3. 财富新增有效户前50户；储蓄新增有效户前250户数据。按时间排序
具体字段：
财富新增有效户：客户号 20240331财富AUM日均 20240331有效财富户 新增时间 主管户经理工号 主管户经理名称
储蓄新增有效户：客户号 20240331财富AUM日均 20240331有效财富户 新增时间 主管户经理工号 主管户经理名称
1.汤出去的有效财富户分给谁，个数，4月1日有效财富户
2. 支行23.11.1-24.3.31 新增有效前50户
3. 支行23.11.1-24.3.31 新增储蓄有效前250户
*/
-- 20240101 至今 汤宇星 管户客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_01 AS
SElECT distinct prm_mgr_id
	,prm_mgr_nm                               --主管护人名称|C60
    ,cst_id                                   --客户号|C20
	,cst_nm                                   --客户姓名|C200
from adm_pub_app.adm_pblc_cst_prm_mng_inf_dd
where dt between '20240101' and '20240331'
and prm_mgr_id='011937' --汤宇星
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_02 AS
SElECT t1.prm_mgr_id    mgr_id
	,t1.prm_mgr_nm      mgr_nm                  --主管护人名称|C60
    ,t1.cst_id                                  --客户号|C20
	,t1.cst_nm                                  --客户姓名|C200
    ,t2.efe_wlth_cst_ind                        --有效财富户标识
    ,t3.prm_mgr_id
    ,t3.prm_mgr_nm
    ,t3.prm_org_nm
from SJXQ_SJ2024040326_CST_01 t1
left join adm_pub.adm_csm_cbas_ind_inf_dd   t2 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='20240401'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
--输出结果1 离职人员有效财富户交接
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_03 AS
SELECT mgr_nm
    ,prm_mgr_nm
    ,count(DISTINCT cst_id) 交接有效财富户数
from SJXQ_SJ2024040326_CST_02
where efe_wlth_cst_ind='1'      --有效财富户
GROUP BY mgr_nm,prm_mgr_nm
;
--历史有效财富户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_04 AS
SElECT distinct cst_id
from adm_pub.adm_csm_cbas_ind_inf_dd  --客户集市-基础信息-客户基础标识信息
where dt<='20231031'
and efe_wlth_cst_ind='1'
;
--新增有效财富户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_05 AS
SElECT t1.cst_id,min(t1.dt) efe_wlth_cst_dt
from adm_pub.adm_csm_cbas_ind_inf_dd    t1 --客户集市-基础信息-客户基础标识信息
left join SJXQ_SJ2024040326_CST_04      t2
on t1.cst_id=t2.cst_id
where t1.dt between '20231101' and '20240331'
and t1.efe_wlth_cst_ind='1'
and t2.cst_id is null       --剔除 历史有效财富户
GROUP by t1.cst_id
;
--输出结果2 客户号 20240331财富AUM日均 20240331有效财富户 新增时间 主管户经理工号 主管户经理名称
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_06 AS
select t1.cst_id            客户号
    ,t5.aum_mon_avg         20240331日AUM月日均
    ,t5.wlth_mon_avg        20240331财富月日均
    ,t6.efe_wlth_cst_ind    20240331有效财富户标识
    ,t1.efe_wlth_cst_dt     有效财富户新增日期
    ,T3.PRM_MGR_ID          主管户经理工号
    ,T3.PRM_MGR_NM          主管户经理名称
    ,row_number() over(order by t1.efe_wlth_cst_dt) 序号
from SJXQ_SJ2024040326_CST_05 t1
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240331'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240331'
and t4.SBR_ORG_NM like '%张家港塘桥支行%'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd	t5 --客户集市-业务信息-客户金融资产信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20240331'
left join adm_pub.adm_csm_cbas_ind_inf_dd           t6 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id=t6.cst_id
and t6.dt='20240331'
;
--历史有效储蓄户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_07 AS
select t1.dt,t1.cst_id
    ,sum(t1.gl_bal)        gl_bal	--账户总账余额|DECIMAL(20,2)
from edw.dws_bus_dep_act_inf_dd	            t1 --存款账户信息汇总
inner join edw.dim_bus_dep_pd_bas_inf_dd    t2 --存款产品基础信息表
on t1.prod_id=t2.pd_id
and t2.dt='@@{yyyyMMdd}'
and t2.pd_cmt regexp '整存整取|苏乐定'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  T1.act_afl_org = t3.org_id
and t3.dt = '@@{yyyyMMdd}'
and t3.SBR_ORG_NM like '%张家港塘桥支行%'
where t1.dt<='20231031'
group by t1.dt,t1.cst_id
having sum(t1.gl_bal)>=10000
;
--新增有效储蓄户
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_08 AS
select t1.dt,t1.cst_id
    ,sum(t1.gl_bal)        gl_bal	--账户总账余额|DECIMAL(20,2)
from edw.dws_bus_dep_act_inf_dd	            t1 --存款账户信息汇总
inner join edw.dim_bus_dep_pd_bas_inf_dd    t2 --存款产品基础信息表
on  t1.prod_id=t2.pd_id
and t2.dt='@@{yyyyMMdd}'
and t2.pd_cmt regexp '整存整取|苏乐定'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  T1.act_afl_org = t3.org_id
and t3.dt = '@@{yyyyMMdd}'
and t3.SBR_ORG_NM like '%张家港塘桥支行%'
left join(
    select distinct cst_id
    from sjxq_sj2024040326_cst_07
) t4 on t1.cst_id=t4.cst_id
where t1.dt between '20231101' and '20240331'
and t4.cst_id is null       --剔除 历史有效储蓄户
group by t1.dt,t1.cst_id
having sum(t1.gl_bal)>=10000
;
--输出结果3 客户号 20240331财富AUM日均 20240331有效财富户 新增时间 主管户经理工号 主管户经理名称
DROP   TABLE IF     EXISTS SJXQ_SJ2024040326_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040326_CST_09 AS
select t1.cst_id            客户号
    ,t5.aum_mon_avg         20240331日AUM月日均
    ,t5.wlth_mon_avg        20240331财富月日均
    ,t6.efe_wlth_cst_ind    20240331有效财富户标识
    ,t1.efe_dep_dt          有效储蓄户新增日期
    ,T3.PRM_MGR_ID          主管户经理工号
    ,T3.PRM_MGR_NM          主管户经理名称
    ,row_number() over(order by t1.efe_dep_dt) 序号
from(
    select cst_id,min(dt) efe_dep_dt
    from SJXQ_SJ2024040326_CST_08
    group by cst_id
)t1
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240331'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240331'
and t4.SBR_ORG_NM like '%张家港塘桥支行%'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd	t5 --客户集市-业务信息-客户金融资产信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20240331'
left join adm_pub.adm_csm_cbas_ind_inf_dd           t6 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id=t6.cst_id
and t6.dt='20240331'
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040326_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040326_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct prm_mgr_nm) custs
from SJXQ_SJ2024040326_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040326_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040326_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040326_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040326_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040326_CST_08
union all
SElECT '09' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040326_CST_09
;
/*
01	1469	1469
02	1469	1469
03	3	3
04	213366	213366
05	58926	58926
06	114	114
07	362145	967
08	23254	298
09	280	280
*/***SJ2024040341_嘉兴积分旅程业务分析.sql
-- 嘉兴分行 20230701-20230930
-- cst_id,首次开立理财账户日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_01 AS
select opn_dt                                 --开通日期|C8
	,act_sts_cd                               --账户状态代码|C1
	,cst_typ_cd                               --客户类型代码
	,cst_id                                   --客户编号
    ,row_number() over(partition by cst_id order by opn_dt) rn --最早开户日期
from edw.dim_bus_chm_act_inf_dd             t1 --理财账户信息
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.afl_org = t4.org_id           --所属机构
and t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM = '嘉兴分行'
where t1.dt='@@{yyyyMMdd}'
-- and t1.ta_cd = 'TL'     --理财
and t1.frs_opn_ind='1'  --首次开户标志
and t1.opn_dt between '20230701' and '20230930'
;
-- cst_id,首次泰2用信日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_02 AS
select t1.busi_ctr_id                           --业务合同编号|C32
	,t1.pd_cd                                   --产品代码|C4
    ,CASE WHEN T9.APL_STYP = '060040' THEN '泰e贷2.0' ELSE '泰e贷' END PD_TYP
	,t1.cst_id                                  --客户编号|C20
	,t1.cst_nm                                  --客户名称|C200
	,t1.apnt_start_dt                           --约定开始日期 合同起始日
	,t1.apnt_mtu_dt                             --约定到期日期 合同到期日
	,t1.ccy_cd                                  --币种代码|C3
	,t1.ctr_amt                                 --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                 --合同余额|DECIMAL(20,2)
	,t1.hpn_dt                                  --发生日期|C8
    ,t3.acs_org_id	                            --管护机构编号|C12
    ,t3.acs_mngr_id	                            --管户客户经理编号|C32
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t6.MIN_DTRB_DT
from edw.dim_bus_loan_ctr_inf_dd            T1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同`管户`信息
on  t1.busi_ctr_id=t3.busi_ctr_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4537 org_id 唯一
on      t3.acs_org_id = t4.org_id
and     t4.BRC_ORG_NM='嘉兴分行'
and     t4.dt = '@@{yyyyMMdd}'
inner JOIN    (
                 SELECT  BUS_CTR_ID
                         ,MIN(DTRB_DT) AS MIN_DTRB_DT --最早一笔借据发放日期
                 FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD --借据表
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY BUS_CTR_ID
             ) T6
ON      T1.BUSI_CTR_ID = T6.BUS_CTR_ID --非循环贷款，有借据才生效
left JOIN EDW.DWD_BUS_LOAN_REL_APL_INF_DD   T8
ON  T1.BUSI_APL_ID= T8.APL_SRL_NBR
AND T8.REL_OBJ_TYP = 'EntryForm'
AND T8.DT = '@@{yyyyMMdd}'  --李强新增
left JOIN EDW.DWD_BUS_LOAN_ENTR_FORM_DD     T9
ON T8.REL_OBJ_ID =T9.APL_SRL_NBR
and T9.DT = '@@{yyyyMMdd}'
and T9.APL_STYP = '060040'  --李强新增
where   t1.dt='@@{yyyyMMdd}'
and     nvl(t1.busi_apl_id,'')<>''    --剔除空值
;
-- cst_id,首次办理一般贷款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_03 AS
select t1.cst_id,t1.busi_ctr_id,t6.MIN_DTRB_DT data_dt
    ,row_number() over(partition by t1.cst_id order by t6.MIN_DTRB_DT) rn
from edw.dim_bus_loan_ctr_inf_dd            T1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同`管户`信息
on  t1.busi_ctr_id=t3.busi_ctr_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4537 org_id 唯一
on      t3.acs_org_id = t4.org_id
and     t4.BRC_ORG_NM='嘉兴分行'
and     t4.dt = '@@{yyyyMMdd}'
inner JOIN    (
                 SELECT  BUS_CTR_ID
                         ,MIN(DTRB_DT) AS MIN_DTRB_DT --最早一笔借据发放日期
                 FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD --借据表
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY BUS_CTR_ID
             ) T6
ON      T1.BUSI_CTR_ID = T6.BUS_CTR_ID --非循环贷款，有借据才生效
WHERE t1.dt = '@@{yyyyMMdd}'
AND     t1.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) 			--剔除 员工贷款
AND     ( t1.chnl_cd <> 'L08'     OR t1.pd_cd <> '201050101040335' ) 	--剔除 小鱼分期
AND     t1.pd_cd <> '201050101040332' 									--剔除 蚂蚁借呗
AND     t1.pd_cd <> '201050101040319' 									--剔除 百度分期贷
AND     ( t1.pd_cd NOT IN ( '201050102010146' , '201050101040348' ) OR t1.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( substr(t1.pd_cd, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
    OR substr(t1.pd_cd, 1, 7) = '2010503' ) --一般贷款
;
--表1
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_04 AS
SElECT t1.cst_id                    客户号
    ,t1.opn_dt                      开立理财账户日期
    ,nvl(t2.cprh_contri_12m,0)      开立账户前一日客户价值
    ,nvl(t3.cprh_contri_12m,0)      开立账户后30天客户价值
    ,nvl(t3.whth_fee_12m   ,0)      开立账户后30天客户价值中财富收入
    ,nvl(t4.fnc_mon_avg_amt,0)	 	开立账户前一日理财月日均余额
    ,nvl(t5.fnc_mon_avg_amt,0)	 	开立账户后30天理财月日均余额
from LAB_BIGDATA_DEV.SJXQ_SJ2024040341_CST_01           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd       t4 --客户金融资产信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd       t5 --客户金融资产信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.rn=1
;
--表2
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_05 AS
SElECT t1.cst_id                        客户号
    ,t1.data_dt                         首次申请泰e贷2发放日期
    ,nvl(t2.cprh_contri_12m      ,0)    发放前一日客户价值
    ,nvl(t3.cprh_contri_12m      ,0)    发放后30天客户价值
    ,nvl(t6.cur_year_loan_ftp_inc,0)    发放后30天当年贷款FTP利润收入
    ,nvl(t4.loan_bal_acs_mon_avg ,0)    发放前一日贷款余额月日均
    ,nvl(t5.loan_bal_acs_mon_avg ,0)    发放后30天贷款余额月日均
from(
    SElECT cst_id,MIN_DTRB_DT data_dt
        ,row_number() over(partition by cst_id order by min_dtrb_dt) rn
    from SJXQ_SJ2024040341_CST_02
    where PD_TYP='泰e贷2.0'
)t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t4 --客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t5 --客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_ftp_inf_dd	            t6 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t6.cst_id
and t6.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.rn=1   --泰e贷2.0 首次信用
-- and t1.data_dt between '20230701' and '20230930'    --用信日期
;
--表3 首笔一般贷款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_06 AS
SElECT t1.cst_id                        客户号
    ,t1.data_dt                         首笔一般贷款发放日期
    ,nvl(t2.cprh_contri_12m      ,0)    发放前一日客户价值
    ,nvl(t3.cprh_contri_12m      ,0)    发放后30天客户价值
    ,nvl(t6.cur_year_loan_ftp_inc,0)    发放后30天当年贷款FTP利润收入
    ,nvl(t4.loan_bal_acs_mon_avg ,0)    发放前一日贷款余额月日均
    ,nvl(t5.loan_bal_acs_mon_avg ,0)    发放后30天贷款余额月日均
    ,nvl(t4.loan_mon_avg         ,0)    发放前一日一般贷款余额月日均
    ,nvl(t5.loan_mon_avg         ,0)    发放后30天一般贷款余额月日均
from SJXQ_SJ2024040341_CST_03                           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t4 --客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t5 --客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_ftp_inf_dd	            t6 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t6.cst_id
and t6.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.rn=1 --一般贷款 首次信用
and t1.data_dt between '20230701' and '20230930'    --用信日期
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040341_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040341_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040341_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040341_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040341_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040341_CST_06
;
/*
01	588	588
02	9267	9267
03	175293	175293
04	588	588
05	541	541
06	1324	1324
*/
***SJ2024040341_嘉兴积分旅程业务分析0411.sql
-- 嘉兴分行 20230701-20230930
-- cst_id,首次开立理财账户日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_01 AS
select opn_dt                                 --开通日期|C8
	,act_sts_cd                               --账户状态代码|C1
	,cst_typ_cd                               --客户类型代码
	,cst_id                                   --客户编号
    ,row_number() over(partition by cst_id order by opn_dt) rn --最早开户日期
from edw.dim_bus_chm_act_inf_dd             t1 --理财账户信息
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.afl_org = t4.org_id           --所属机构
and t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM = '嘉兴分行'
where t1.dt='@@{yyyyMMdd}'
-- and t1.ta_cd = 'TL'     --理财
and t1.frs_opn_ind='1'  --首次开户标志
and t1.opn_dt between '20230701' and '20230930'
;
--表1
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_04 AS
SElECT t1.cst_id                    客户号
    ,t1.opn_dt                      开立理财账户日期
    ,nvl(t2.cprh_contri_12m,0)      开立账户前一日客户价值
    ,nvl(t3.cprh_contri_12m,0)      开立账户后30天客户价值
    ,nvl(t3.whth_fee_12m   ,0)      开立账户后30天客户价值中财富收入
    ,nvl(t4.fnc_mon_avg_amt,0)	 	开立账户前一日理财月日均余额
    ,nvl(t5.fnc_mon_avg_amt,0)	 	开立账户后30天理财月日均余额
from LAB_BIGDATA_DEV.SJXQ_SJ2024040341_CST_01           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd       t4 --客户金融资产信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd       t5 --客户金融资产信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.opn_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.rn=1
;
-- cst_id,首次泰2用信日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_02 AS
select t1.busi_ctr_id                           --业务合同编号|C32
	,t1.pd_cd                                   --产品代码|C4
    ,CASE WHEN T9.APL_STYP = '060040' THEN '泰e贷2.0' ELSE '泰e贷' END PD_TYP
	,t1.cst_id                                  --客户编号|C20
	,t1.cst_nm                                  --客户名称|C200
	,t1.apnt_start_dt                           --约定开始日期 合同起始日
	,t1.apnt_mtu_dt                             --约定到期日期 合同到期日
	,t1.ccy_cd                                  --币种代码|C3
	,t1.ctr_amt                                 --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                 --合同余额|DECIMAL(20,2)
	,t1.hpn_dt                                  --发生日期|C8
    ,t3.acs_org_id	                            --管护机构编号|C12
    ,t3.acs_mngr_id	                            --管户客户经理编号|C32
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t6.MIN_DTRB_DT
    ,substr(t7.authorizationtime,1,8)   tyd_sgn_dt
from edw.dim_bus_loan_ctr_inf_dd            T1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同`管户`信息
on  t1.busi_ctr_id=t3.busi_ctr_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4537 org_id 唯一
on      t3.acs_org_id = t4.org_id
and     t4.BRC_ORG_NM='嘉兴分行'
and     t4.dt = '@@{yyyyMMdd}'
inner JOIN    (
                 SELECT  BUS_CTR_ID
                         ,MIN(DTRB_DT) AS MIN_DTRB_DT --最早一笔借据发放日期
                 FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD --借据表
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY BUS_CTR_ID
             ) T6
ON      T1.BUSI_CTR_ID = T6.BUS_CTR_ID --非循环贷款，有借据才生效
left join edw.loan_contractsign_task        t7 --合同签署任务表
on t1.busi_ctr_id=t7.objectno
and t7.OBJECTTYPE ='BusinessContract'
and nvl(t7.authorizationtime,'')<>''
and t7.dt='@@{yyyyMMdd}'
left JOIN EDW.DWD_BUS_LOAN_REL_APL_INF_DD   T8
ON  T1.BUSI_APL_ID= T8.APL_SRL_NBR
AND T8.REL_OBJ_TYP = 'EntryForm'
AND T8.DT = '@@{yyyyMMdd}'  --李强新增
left JOIN EDW.DWD_BUS_LOAN_ENTR_FORM_DD     T9
ON T8.REL_OBJ_ID =T9.APL_SRL_NBR
and T9.DT = '@@{yyyyMMdd}'
and T9.APL_STYP = '060040'  --李强新增
where   t1.dt='@@{yyyyMMdd}'
and     nvl(t1.busi_apl_id,'')<>''    --剔除空值
;
--表2
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_05 AS
SElECT t1.cst_id                        客户号
    ,t1.data_dt                         泰e贷2首次授信日期
    ,t1.MIN_DTRB_DT                     首次申请泰e贷2发放日期
    ,nvl(t2.cprh_contri_12m      ,0)    授信前一日客户价值
    ,nvl(t3.cprh_contri_12m      ,0)    授信后30天客户价值
    ,nvl(t6.cur_year_loan_ftp_inc,0)    授信后30天当年贷款FTP利润收入
    ,nvl(t4.loan_bal_acs_mon_avg ,0)    授信前一日贷款余额月日均
    ,nvl(t5.loan_bal_acs_mon_avg ,0)    授信后30天贷款余额月日均
from(
    SElECT cst_id,MIN_DTRB_DT
        ,tyd_sgn_dt data_dt             -- 泰e贷2.0 授信时间
        ,row_number() over(partition by cst_id order by tyd_sgn_dt) rn
    from SJXQ_SJ2024040341_CST_02
    where PD_TYP='泰e贷2.0'
)t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t4 --客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t5 --客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_ftp_inf_dd	            t6 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t6.cst_id
and t6.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.rn=1   --泰e贷2.0 首次授信
and t1.data_dt between '20230701' and '20230930'    --授信日期
;
-- cst_id,首次办理一般贷款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_03 AS
select t1.cst_id,t1.busi_ctr_id,t6.MIN_DTRB_DT data_dt
    ,row_number() over(partition by t1.cst_id order by t6.MIN_DTRB_DT) rn
from edw.dim_bus_loan_ctr_inf_dd            T1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同`管户`信息
on  t1.busi_ctr_id=t3.busi_ctr_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4537 org_id 唯一
on      t3.acs_org_id = t4.org_id
and     t4.BRC_ORG_NM='嘉兴分行'
and     t4.dt = '@@{yyyyMMdd}'
inner JOIN    (
                 SELECT  BUS_CTR_ID
                         ,MIN(DTRB_DT) AS MIN_DTRB_DT --最早一笔借据发放日期
                 FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD --借据表
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY BUS_CTR_ID
             ) T6
ON      T1.BUSI_CTR_ID = T6.BUS_CTR_ID --非循环贷款，有借据才生效
WHERE t1.dt = '@@{yyyyMMdd}'
AND     t1.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) 			--剔除 员工贷款
AND     ( t1.chnl_cd <> 'L08'     OR t1.pd_cd <> '201050101040335' ) 	--剔除 小鱼分期
AND     t1.pd_cd <> '201050101040332' 									--剔除 蚂蚁借呗
AND     t1.pd_cd <> '201050101040319' 									--剔除 百度分期贷
AND     ( t1.pd_cd NOT IN ( '201050102010146' , '201050101040348' ) OR t1.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( substr(t1.pd_cd, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
    OR substr(t1.pd_cd, 1, 7) = '2010503' ) --一般贷款
;
--表3 首笔一般贷款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024040341_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040341_CST_06 AS
SElECT t1.cst_id                        客户号
    ,t1.data_dt                         首笔一般贷款发放日期
    ,nvl(t2.cprh_contri_12m      ,0)    发放前一日客户价值
    ,nvl(t3.cprh_contri_12m      ,0)    发放后30天客户价值
    ,nvl(t6.cur_year_loan_ftp_inc,0)    发放后30天当年贷款FTP利润收入
    ,nvl(t4.loan_bal_acs_mon_avg ,0)    发放前一日贷款余额月日均
    ,nvl(t5.loan_bal_acs_mon_avg ,0)    发放后30天贷款余额月日均
    ,nvl(t4.loan_mon_avg         ,0)    发放前一日一般贷款余额月日均
    ,nvl(t5.loan_mon_avg         ,0)    发放后30天一般贷款余额月日均
from SJXQ_SJ2024040341_CST_03                           t1
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t2 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t2.cst_id
and t2.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd   t3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
on t1.cst_id=t3.cst_id
and t3.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t4 --客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),-1,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_loan_inf_dd	            t5 --客户贷款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
left join adm_pub.adm_csm_cbus_ftp_inf_dd	            t6 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t6.cst_id
and t6.dt=TO_CHAR(DATEADD(TO_DATE(t1.data_dt,'yyyymmdd'),30,'dd'),'yyyymmdd')
where t1.rn=1 --一般贷款 首次信用
and t1.data_dt between '20230701' and '20230930'    --用信日期
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040341_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040341_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040341_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040341_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040341_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024040341_CST_06
;
/*
01	588	588
02	9267	9267
03	175293	175293
04	588	588
05	541	541
06	1324	1324
*/
***SJ2024040776_惠分期客户业务检查.sql
--样本数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_01 AS
SElECT t1.col_1,t2.busi_ctr_id          --合同流水号
    ,t1.col_2,t2.cst_id               --客户编号
    ,t1.col_3,t2.cst_nm               --客户名称
    ,t1.col_4,t2.bus_typ              --业务品种 1
    ,t1.col_5   loan_atr              --贷款性质
    ,t1.col_6,t2.rpay_mth             --还本计息方式 1
    ,t1.col_7,t2.ctr_amt              --合同金额
    ,t1.col_8,t2.ctr_bal              --合同余额
    ,t1.col_9,t2.intr_rat             --执行年利率 1
    ,t1.substr(replace(col_10,'-',''),1,8) col_10,t2.apnt_start_dt        --合同起始日
    ,t1.substr(replace(col_11,'-',''),1,8) col_11,t2.apnt_mtu_dt          --合同到期日
    ,t1.col_12,t2.stl_nbr              --账号 1
    ,t1.col_13  SBR_ORG_NM             --支行
    ,t1.col_14,t2.empe_id              --管户人工号 合同表该字段为空
    ,t1.col_15,t2.empe_nm              --管户人姓名 1
    ,t1.col_16,t2.pre_dfd_pre_rpt_ind  --预保预报标识
    ,t2.hpn_dt busi_hpn_dt  --与申请表不同
    ,t3.apl_id,t3.hpn_dt
    ,t3.reg_dt              --贷款申请日期 基本同 hpn_dt
	,t3.hpn_typ_cd                               --发生类型代码|C32
	,t3.loan_dir_cd                              --贷款投向代码|C5
	,t3.apl_amt                                  --申请金额|DECIMAL(20,2)
	,t3.stdinr                                   --基准利率|DECIMAL(20,2)
	,t3.aprv_exe_mon_intr_rat                    --批准执行月利率|DECIMAL(14,8)
	,t3.aprv_exe_amt                             --批准执行金额|DECIMAL(20,2)
	,t3.intr_rat_adj_cmt                         --利率调整备注|C256
	,t3.cst_ases_crd_grd                         --客户评估信用等级|C10
	,t3.crc_ind                                  --循环贷款标志|C1
	,t3.ref_year_intr_rat                        --参考年利率|number(12,7)
	,t3.pre_ases_rsl                             --预评估结果 均为空
    ,t4.dbil_id,t4.dtrb_dt	--发放日期
FROM qbi_file_20240410_16_46_12         t1
left join edw.dim_bus_loan_ctr_inf_dd   t2 --信贷合同信息
on t1.col_1=t2.busi_ctr_id
and t2.dt='@@{yyyyMMdd}'
and t2.apnt_start_dt between '20230901' and '20240122'  --合同起始日
left join edw.dwd_bus_loan_apl_inf_dd   t3 --信贷业务申请信息
on  t2.busi_apl_id = t3.apl_id
and t3.dt='@@{yyyyMMdd}'
and t3.hpn_dt between '20230101' and '20240122'         --发生日期
inner JOIN edw.dws_bus_loan_dbil_inf_dd t4 --贷款借据信息汇总
ON  t2.busi_ctr_id = t4.bus_ctr_id
AND t4.dt = '@@{yyyyMMdd}'
;
-- 查看数据准确性
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_02 AS
SElECT sum(case when col_1=busi_ctr_id then 1 else 0 end) busi_ctr_id_diff          --合同流水号
,sum(case when col_2 =cst_id             then 1 else 0 end)   cst_id_diff
,sum(case when col_3 =cst_nm             then 1 else 0 end)   cst_nm_diff
,sum(case when col_4 =bus_typ            then 1 else 0 end)   bus_typ_diff
,sum(case when col_6 =rpay_mth           then 1 else 0 end)   rpay_mth_diff
,sum(case when col_7 =ctr_amt            then 1 else 0 end)   ctr_amt_diff
,sum(case when col_8 =ctr_bal            then 1 else 0 end)   ctr_bal_diff
,sum(case when col_9 =intr_rat           then 1 else 0 end)   intr_rat_diff
,sum(case when col_10=apnt_start_dt      then 1 else 0 end)  apnt_start_dt_diff
,sum(case when col_11=apnt_mtu_dt        then 1 else 0 end)  apnt_mtu_dt_diff
,sum(case when col_12=stl_nbr            then 1 else 0 end)  stl_nbr_diff
,sum(case when col_14=empe_id            then 1 else 0 end)  empe_id_diff
,sum(case when col_15=empe_nm            then 1 else 0 end)  empe_nm_diff
,sum(case when col_16=pre_dfd_pre_rpt_ind then 1 else 0 end)  pre_dfd_pre_rpt_ind_diff
,sum(case when hpn_dt<>reg_dt           then 1 else 0 end)  reg_dt_diff
,sum(case when hpn_dt<>busi_hpn_dt      then 1 else 0 end)  hpn_dt_diff
from SJXQ_SJ2024040776_CST_01
;
--办理贷款时 征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_03 AS
SElECT t1.cst_id,t1.reg_dt
    ,t2.digital_unscr   cst_reg_zxscore
    ,t2.dt              reg_report_dt
    ,row_number() over(partition by t1.cst_id,t1.reg_dt order by t2.dt desc) rn
from(
    SElECT distinct cst_id,reg_dt
    from SJXQ_SJ2024040776_CST_01
)t1 inner join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di t2
on t1.cst_id=t2.cst_id
and t2.dt<=t1.reg_dt
and t2.dt<='@@{yyyyMMdd}' --不加报错
;
--最新 征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_04 AS
SElECT t1.cst_id
    ,t2.digital_unscr   cst_cur_zxscore
    ,t2.dt              cur_report_dt
    ,row_number() over(partition by t1.cst_id order by t2.dt desc) rn
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024040776_CST_01
)t1 inner join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di t2
on t1.cst_id=t2.cst_id
and t2.dt<='@@{yyyyMMdd}'
;
--还款
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_05 AS
SElECT t1.busi_ctr_id
    ,t1.dbil_id,t1.dtrb_dt	--发放日期
    ,t3.dtl_seq_nbr,t3.cst_id,t3.cst_nm
    ,t3.trx_dt
    ,t3.trx_dir                                 --交易方向 0放款 1还款
    ,t3.trx_amt,t3.bal
    ,t3.loan_bal_fld                            --贷款余额字段
    ,t3.bal_fld_cmt                             --余额字段说明
	,t3.trx_evt                                 --交易事件|C10
	,t3.evt_cmt                                 --事件说明|C80
	,t3.smr                                     --摘要|C512
    ,t3.dt
from SJXQ_SJ2024040776_CST_01               t1
inner join edw.dwd_bus_loan_act_trx_dtl_di  t3 --贷款账户交易明细
on  t1.dbil_id=t3.loan_dbil_id
and t3.dt<='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_06 AS
SElECT busi_ctr_id
    ,count(case when evt_cmt='逾期标准还款' and bal_fld_cmt like '%本金' then dtl_seq_nbr end)      dlq_rpy_bj_cnt
    ,sum(  case when evt_cmt='逾期标准还款' and bal_fld_cmt like '%本金' then trx_amt else 0 end)   dlq_rpy_bj_amt
    ,count(case when evt_cmt='逾期标准还款' and bal_fld_cmt regexp '罚息|利息|复息|欠息' then dtl_seq_nbr end)      dlq_rpy_lx_cnt
    ,sum(  case when evt_cmt='逾期标准还款' and bal_fld_cmt regexp '罚息|利息|复息|欠息' then trx_amt else 0 end)   dlq_rpy_lx_amt
    -- ,sum(trx_amt)  rpy_tot_amt
from SJXQ_SJ2024040776_CST_05
where trx_dir='1'   --交易方向 0放款 1还款
and smr='归还贷款'
group by busi_ctr_id
;
--精准贷后
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_07 AS
SELECT t1.cst_id,t1.dtrb_dt
    ,replace(t2.tsk_mak_dt,'/','')  tsk_mak_dt      --任务生成日期
    ,T2.brk_rsn                                     --精准贷后触发内容
    ,CASE
        WHEN T2.cst_rsk_deg_id = '01' THEN '正常'
        WHEN T2.cst_rsk_deg_id = '02' THEN '风险可控'
        WHEN T2.cst_rsk_deg_id = '03' THEN '存在风险隐患'
        WHEN T2.cst_rsk_deg_id = '04' THEN '风险暴露' else ''
        END  cst_rsk_deg_nm                                 --精准贷后反馈
    ,c1.cd_val_dscr      LOAN_PST_CHK_TYP_nm                --贷后检查类型
    ,c2.cd_val_dscr      RSK_TRG_TYP_nm                     --风险触发类型
    ,row_number() OVER (PARTITION BY T1.cst_id,t1.dtrb_dt ORDER BY T2.tsk_mak_dt DESC) rn
FROM (select distinct cst_id,dtrb_dt from SJXQ_SJ2024040776_CST_01)  t1
inner JOIN edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd                T2 --精准贷后结果信息表
ON  t1.cst_id = T2.cst_id
and replace(t2.tsk_mak_dt,'/','')>=t1.dtrb_dt --办理贷款后
AND T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DWD_CODE_LIBRARY AS c1
ON      c1.CD_VAL = T2.LOAN_PST_CHK_TYP
AND     c1.tbl_nm = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     c1.fld_nm = 'LOAN_PST_CHK_TYP'
LEFT JOIN    EDW.DWD_CODE_LIBRARY AS c2
ON      c2.CD_VAL = T2.RSK_TRG_TYP_CD
AND     c2.tbl_nm = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     c2.fld_nm = 'RSK_TRG_TYP_CD'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_08 AS
select cst_id,dtrb_dt
    ,count(1)                               tgt_loan_cnt
from SJXQ_SJ2024040776_CST_07
group by cst_id,dtrb_dt
;
--贷前他行负债余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_09 AS
select t1.cst_id,t1.dtrb_dt
    ,t2.oth_bank_loan_credit_bal dq_othbnk_loan_bal       --他行授信贷款余额
    ,t2.report_dt
    ,row_number() over(partition by t1.cst_id,t1.dtrb_dt order by report_dsc_rn)rn
FROM (select distinct cst_id,dtrb_dt from SJXQ_SJ2024040776_CST_01)  t1
inner JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd t2 --个人征信指标信息表
ON      t1.cst_id = t2.cst_id
and     substr(REPLACE(t2.report_dt,'-',''),1,8) <=t1.dtrb_dt   --贷前
AND     t2.dt = '@@{yyyyMMdd}'
;
-- 最新他行负债余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_10 AS
select t1.cst_id
    ,t2.oth_bank_loan_credit_bal cur_othbnk_loan_bal       --他行授信贷款余额
    ,t2.report_dt
FROM (select distinct cst_id from SJXQ_SJ2024040776_CST_01)  t1
inner JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd t2 --个人征信指标信息表
ON  t1.cst_id = t2.cst_id
AND t2.report_dsc_rn = 1
AND t2.dt = '@@{yyyyMMdd}'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_11 AS
SElECT t1.busi_ctr_id               --合同流水号
    ,t1.cst_id                      --客户编号
    ,t1.cst_nm                      --客户名称
    ,t1.col_4   bus_typ             --业务品种 1
    ,t1.loan_atr                    --贷款性质
    ,t1.col_6   rpay_mth            --还本计息方式 1
    ,t1.ctr_amt                     --合同金额
    ,t1.ctr_bal                     --合同余额
    ,t1.col_9   intr_rat            --执行年利率 1
    ,t1.apnt_start_dt               --合同起始日
    ,t1.apnt_mtu_dt                 --合同到期日
    ,t1.col_12  stl_nbr             --账号 1
    ,t1.SBR_ORG_NM                  --支行
    ,t1.col_14  empe_id             --管户人工号 合同表该字段为空
    ,t1.col_15  empe_nm             --管户人姓名 1
    ,t1.pre_dfd_pre_rpt_ind         --预保预报标识
    ,t2.cst_reg_zxscore,t2.reg_report_dt
    ,t3.cst_cur_zxscore,t3.cur_report_dt
    ,case when nvl(t4.dlq_rpy_bj_cnt,0)+nvl(t4.dlq_rpy_lx_cnt,0)>0 then '是' else '否' end is_dlq_rpy
    ,t4.dlq_rpy_bj_cnt,t4.dlq_rpy_bj_amt
    ,t4.dlq_rpy_lx_cnt,t4.dlq_rpy_lx_amt
    ,case when t5.cst_id is not null then '是' else '否' end is_tgt_loan
    ,t5.tgt_loan_cnt,t5.tgt_loan_content
    ,t6.dq_othbnk_loan_bal,t6.report_dt     dqn_rpt_dt
    ,t7.cur_othbnk_loan_bal,t7.report_dt    cur_rpt_dt
from SJXQ_SJ2024040776_CST_01       t1
left join SJXQ_SJ2024040776_CST_03  t2
on  t1.CST_ID=t2.cst_id
and t1.reg_dt=t2.reg_dt
and t2.rn=1
left join SJXQ_SJ2024040776_CST_04  t3
on  t1.CST_ID=t3.cst_id
and t3.rn=1
left join SJXQ_SJ2024040776_CST_06  t4
on  t1.busi_ctr_id=t4.busi_ctr_id
left join SJXQ_SJ2024040776_CST_08  t5
on  t1.cst_id=t5.cst_id
and t1.dtrb_dt=t5.dtrb_dt
left join SJXQ_SJ2024040776_CST_09  t6
on  t1.cst_id=t6.cst_id
and t1.dtrb_dt=t6.dtrb_dt
and t6.rn=1
left join SJXQ_SJ2024040776_CST_10  t7
on  t1.cst_id=t7.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024040776_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040776_CST_12 AS
SElECT busi_ctr_id                  合同流水号
    ,cst_id                         客户编号
    ,cst_nm                         客户名称
    ,bus_typ                        业务品种
    ,loan_atr                       贷款性质
    ,rpay_mth                       还本计息方式
    ,ctr_amt                        合同金额
    ,ctr_bal                        合同余额
    ,intr_rat                       执行年利率
    ,apnt_start_dt                  合同起始日
    ,apnt_mtu_dt                    合同到期日
    ,stl_nbr                        账号
    ,SBR_ORG_NM                     支行
    ,empe_id                        管户人工号
    ,empe_nm                        管户人姓名
    ,pre_dfd_pre_rpt_ind            预保预报标识
    ,cst_reg_zxscore                客户办理贷款时征信分
    ,cst_cur_zxscore                客户最新征信分
    ,is_dlq_rpy                     是否出现逾期还款情况
    ,dlq_rpy_bj_cnt                 逾期还本金次数
    ,dlq_rpy_bj_amt                 逾期还本金金额
    ,dlq_rpy_lx_cnt                 逾期还利息次数
    ,dlq_rpy_lx_amt                 逾期还利息金额
    ,is_tgt_loan                    办理贷款后是否触发精准贷后
    ,tgt_loan_cnt                   办理贷款后触发精准贷后次数
    ,tgt_loan_content               办理贷款后触发精准贷后内容
    ,dqn_rpt_dt                     贷前负债余额查询时间
    ,dq_othbnk_loan_bal             贷前他行负债余额
    ,cur_rpt_dt                     最新负债余额查询时间
    ,cur_othbnk_loan_bal            最新他行负债余额
from SJXQ_SJ2024040776_CST_11
;
SElECT '01' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040776_CST_01
union all
SElECT '02' seq, count(1) cnt, count(1) custs
from SJXQ_SJ2024040776_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id,reg_dt) custs
from SJXQ_SJ2024040776_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040776_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct busi_ctr_id,dbil_id,dtl_seq_nbr) custs
from SJXQ_SJ2024040776_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040776_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id,dtrb_dt) custs
from SJXQ_SJ2024040776_CST_07 where rn=1
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id,dtrb_dt) custs
from SJXQ_SJ2024040776_CST_08
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,dtrb_dt) custs
from SJXQ_SJ2024040776_CST_09 where rn=1
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024040776_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct busi_ctr_id) custs
from SJXQ_SJ2024040776_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 合同流水号) custs
from SJXQ_SJ2024040776_CST_12
;
/*
01	1109	1109
02	1	1
03	951	951
04	950	950
05	18973	18973
06	1099	1099
07	496	496
08	496	496
09	950	950
10	950	950
11	1109	1109
12	1109	1109
*/
***SJ2024040781_升金有礼达标客户.sql
客户号 财富管户分行 财富管户支行***SJ2024040846_双录系统员工资质校验.sql
-- 工号	姓名	理财销售资质	基金销售资质	保险销售资质
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040846_CST_01; --28228
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040846_CST_01 AS
SElECT t1.empe_id       工号
    ,t1.empe_nm	        姓名
    ,case when t3.empe_id is not null then '是' else '否' end 理财销售资质
    ,case when t4.empe_id is not null then '是' else '否' end 基金销售资质
    ,case when t5.empe_id is not null then '是' else '否' end 保险销售资质
FROM EDW.DWS_HR_EMPE_INF_DD					T1	--员工汇总信息
left join(
    --理财销售资质
    SELECT  distinct a.client_manager empe_id
    FROM    edw.finc_tbclientmanager a
    WHERE   a.prd_rights LIKE '%1%' --理财
    AND     dt = '@@{yyyyMMdd}'
)t3 on t1.empe_id=t3.empe_id
left join(
    -- 基金从业资质
    SELECT  distinct cust_manager    empe_id
    FROM    edw.cfin_cust_manager_info
    WHERE   dt = '@@{yyyyMMdd}'
    AND     fund_credential_flag = '1'  --是否具备基金销售资质
    AND     PROTOCOL_STATUS = '0'       --员工状态正常
)t4 on t1.empe_id=t4.empe_id
left join(
    -- 保险销售资质
    SELECT  distinct a.cm_id empe_id
    FROM    edw.dim_hr_empe_fin_mng_intlg_ctf_inf_dd a
    inner JOIN    edw.finc_tbclientmanager b
    ON      a.cm_id = b.client_manager
    AND     b.dt = '@@{yyyyMMdd}'
    WHERE   a.dt = '@@{yyyyMMdd}'
    AND     a.bus_typ = '4'     --保险资质
)T5 on t1.empe_id=t5.empe_id
where T1.DT = '@@{yyyyMMdd}'
;
--01	28228	28228
SElECT '01' seq, count(1) cnt, count(distinct 工号) custs
from SJXQ_SJ2024040846_CST_01
***SJ2024040866_丽水理财监管报送.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024040866_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040866_CST_01 AS
select t1.cst_id                            --客户编号
	,t1.cur_fnc_amt                         --理财金额余额
    ,case when t2.cst_id is not null then 1 else 0 end is_entp_cst
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
from edw.dws_bus_chm_act_mgr_inf_dd	                t1 --理财考核汇总信息
left join edw.dim_cst_entp_bas_inf_dd               t2 --企业客户基本信息
on  t1.cst_id = t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t1.acs_org_id = t4.org_id           --考核机构
and t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM = '丽水分行'
where t1.dt='20240331'
and t1.MNG_TYP_CD = '1'  --`管户`类型 1考核 2销售
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024040866_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040866_CST_02 AS
SElECT T4.BRC_ORG_NM,T4.SBR_ORG_NM
	,sum(t1.trx_amt) trx_amt
	,sum(t1.cfm_amt) cfm_amt
from EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI             t1 --理财交易确认流水明细
inner join edw.dim_hr_org_mng_org_tree_dd       t4 --考核机构树
on  t1.trx_afl_org_id = t4.org_id           --交易所属机构编号
and t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM = '丽水分行'
where t1.dt<='@@{yyyyMMdd}'     --确认日期
and t1.trx_dt>='20240101' and t1.trx_dt<='20240331'
AND t1.trx_sts_cd ='8'          --确认成功
AND T1.TRX_AMT <> 0             --交易金额
and t1.stl_ccy_cd='156'         --人民币
group by T4.BRC_ORG_NM,T4.SBR_ORG_NM
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024040866_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024040866_CST_03 AS
SElECT t2.BRC_ORG_NM                分行
    ,T2.SBR_ORG_NM                  支行
    ,nvl(t1.cur_fnc_amt,0)          理财余额0331
    ,nvl(t1.entp_cur_fnc_amt,0)     对公理财余额0331
    ,t2.cfm_amt                     人民币理财产品销售额
from SJXQ_SJ2024040866_CST_02 t2
left join(
    SElECT t1.BRC_ORG_NM
        ,T1.SBR_ORG_NM
        ,sum(cur_fnc_amt)      cur_fnc_amt
        ,sum(case when is_entp_cst=1 then cur_fnc_amt else 0 end)  entp_cur_fnc_amt
    from SJXQ_SJ2024040866_CST_01 t1
    group by t1.BRC_ORG_NM,T1.SBR_ORG_NM
)t1 on t1.SBR_ORG_NM=t2.SBR_ORG_NM
;
SElECT '01' seq, count(1) cnt, count(distinct SBR_ORG_NM) custs
from SJXQ_SJ2024040866_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct SBR_ORG_NM) custs
from SJXQ_SJ2024040866_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct 支行) custs
from SJXQ_SJ2024040866_CST_03
;
/*
01	274003	35
02	35	35
03	35	35
*/
***SJ20240409201_招商招财通.sql
--字段汇总
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409201_CST_01;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409201_CST_01 AS
select t1.prod_cd                                   --产品代码|c32
    ,'招商招财通A'  pd_nm
	,t1.ta_cd                                       --ta代码|c16
	,t1.trx_act_id                                  --交易账号|c32
	,t1.cst_id                                      --客户号|c32
    ,t2.cst_nm
    ,t1.tot_cost	                                --总成本|decimal(16,2)
	,t1.tot_lot                                     --总份额|decimal(16,2)
	,t1.tot_amt                                     --总金额|decimal(16,2)
    ,t1.acm_ern_amt	                                --累计总收益|decimal(16,2)
    ,t1.pos_pft_los	                                --持仓盈亏|decimal(16,2)
	,t1.cst_typ_cd                                  --客户类型代码|c1
    ,t2.wlth_mng_mnl_id
    ,t4.empe_nm             wlth_mng_mnl_nm
    ,t2.wlth_mng_org_id
    ,t3.prm_mgr_id	                                --主管护人工号|C20
    ,t3.prm_mgr_nm	                                --主管护人名称|C60
    ,t3.prm_org_id	                                --主管护机构号|C12
from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd     t1 --基金账户份额信息
left join edw.dim_bus_chm_fnd_cst_ctr_inf_dd    t2 --基金客户签约信息表
on  t1.cst_id = t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3 --客户主管户信息
on  t1.cst_id = t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                t4 --员工信息汇总
on  t2.wlth_mng_mnl_id=t4.empe_id   --财富管户人
and t4.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.prod_cd='004667'     --招商招财通A
and t1.tot_lot<>0
;
--结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409201_CST_02;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409201_CST_02 AS
select t1.cst_id                客户号
    ,concat(substr(t1.cst_nm,1,1),'*',substr(t1.cst_nm,length(t1.cst_nm)-1,1))  客户名称
    ,t1.pd_nm 					基金产品名称
    ,t1.prod_cd                 基金产品代码
	,t1.tot_lot                 持有份额_份
    ,t1.pos_pft_los             持仓盈亏_元
    ,t1.wlth_mng_mnl_id         财富管户人工号
    ,t1.wlth_mng_mnl_nm         财富管户人姓名
    ,t5.TEM_ORG_NM              财富管户人所属团队
    ,T5.SBR_ORG_NM              财富管户人所属支行
    ,T5.BRC_ORG_NM              财富管户人所属分行
    ,t1.prm_mgr_nm              主管户人姓名
    ,t1.prm_mgr_id              主管户工号
    ,t6.TEM_ORG_NM              主管户人所属团队
    ,T6.SBR_ORG_NM              主管户人所属支行
    ,T6.BRC_ORG_NM              主管户人所属分行
from LAB_BIGDATA_DEV.SJXQ_SJ20240409201_CST_01  t1
left join edw.dim_hr_org_mng_org_tree_dd        t5 --考核机构树
on  t1.wlth_mng_org_id=t5.org_id    --财富管户机构
and t5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd        t6 --考核机构树
on  t1.prm_org_id=t6.org_id         --主管户机构
and t6.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt, count(distinct cst_ID) custs
from SJXQ_SJ20240409201_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ20240409201_CST_02
;
/*
01	386	386
02	386	386
*/***SJ20240409207_广发基金定投奖励.sql
-- 活动开始前（10.31日前）已在我行存在定投扣款成功记录的客户
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01 AS
SELECT  DISTINCT cst_id
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di --基金交易确认流水明细
WHERE   dt <= '20231130'
AND     bus_dt <= '20231031' --业务时间
AND     TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     BUS_CD = '139' --定时定额申购确认
;
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01_1;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01_1 AS
SELECT  DISTINCT CST_ID
FROM  EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD -- 基金定投协议信息
WHERE DT='20231031'
AND ACM_SUC_TMS>0    --6月30日前存在定投扣款成功客户
;
-- 定投累计申请金额
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02 AS
SELECT  A.cst_id
        ,count(1)           AIP_ACM_CFM_CNT
        ,sum(a.cfm_amt)     AIP_ACM_CFM_AMT
            , '混合型', '04', '货币型', '05', '其他', '06', 'FOF基金'))) AIP_ACM_fnd_typ
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di          A --基金交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD            C --基金产品基础信息表
on  A.PD_CD=C.PD_CD
AND C.DT='@@{yyyyMMdd}'
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01 D
ON      a.cst_id = d.cst_id
WHERE   A.dt <= '@@{yyyyMMdd}'
AND     A.bus_dt BETWEEN '20231101' AND '20240331' --业务时间
AND     A.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     A.BUS_CD = '139' --定时定额申购确认
AND     d.cst_id IS NULL --剔除 存量定投客户
GROUP BY A.cst_id
HAVING AIP_ACM_CFM_CNT >= 3
AND    AIP_ACM_CFM_AMT >= 1000
;
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02_1;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02_1 AS
SELECT  A.CST_ID
    ,min(A.AIP_START_DT)    AIP_START_DT
    ,sum(a.ACM_AIP_SUC_AMT) AIP_ACM_CFM_AMT
    ,sum(a.ACM_SUC_TMS)     AIP_ACM_CFM_CNT
    ,max(a.dt)              max_dt
from(
    SElECT a.cst_ID,a.AIP_START_DT,a.ACM_AIP_SUC_AMT,a.ACM_SUC_TMS,a.AGR_STS_CD,a.dt
        ,ROW_NUMBER() over(partition by a.agr_id,a.cst_ID ORDER by a.dt desc) rn
    FROM  EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD     A -- 基金定投协议信息
    inner join EDW.DIM_BUS_CHM_FND_PD_INF_DD     c
    ON  a.PD_CD=C.Pd_cd
    and c.DT='@@{yyyyMMdd}'
    LEFT JOIN SJXQ_SJ20240409207_CST_01_1 D
    ON A.CST_ID=D.CST_ID
    WHERE A.DT BETWEEN '20231101' and '20240331'
    AND A.AIP_START_DT BETWEEN '20231101' and '20240331'   --基金确认时间，之前定投需剔除
    AND D.CST_ID IS NULL 		-- 剔除 存量定投客户
)a where rn=1                   --非增量更新，取最新记录
GROUP by  A.CST_ID
having AIP_ACM_CFM_AMT >=1000
;
--当前基金状态
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03 AS
SELECT cst_id, cst_nm, agr_sts_cd
    ,decode(agr_sts_cd,'0','正常','1','暂停','2','客户终止','3','异常终止','4','到期终止','') agr_sts_nm
    ,dt     agr_sts_final_updt
    ,row_number() over(partition by cst_id order by dt desc)rn
FROM EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD
WHERE DT BETWEEN '20231101' and '20240331'
;
-- 输出结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_04;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_04 AS
SELECT concat(substr(c.cst_nm,1,1),'**')    as  客户姓名_脱敏
	,A.CST_ID 					                as  客户号
	,T2.WLTH_MNG_MNL_ID                         as  取数当日财富管户人工号
	,T3.EMPE_NM                                 as  取数当日财富管户人姓名
	,T4.TEM_ORG_NM                              as  当前财富管户人3月31日所属团队
	,T4.BRC_ORG_NM                              as  当前财富管户人3月31日所属分行
	,COALESCE(A.AIP_ACM_CFM_AMT,0)              as  定投累计申请金额
	,COALESCE(A.AIP_ACM_CFM_CNT,0)              as  定投累计申请次数
    ,agr_sts_final_updt                             定投协议最后更新日期
    ,agr_sts_nm                                     定投协议最后更新状态
	,case when agr_sts_final_updt='20240331' then agr_sts_nm else 'null' end AS  定投协议0331日状态
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02      A
-- left join edw.dim_cst_bas_inf_dd	                b --客户基本信息
-- on  a.cst_ID=b.cst_ID
-- and b.dt='@@{yyyyMMdd}'
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03 c
ON  A.CST_ID=c.CST_ID
and c.rn=1
LEFT JOIN EDW.DIM_BUS_CHM_FND_CST_CTR_INF_DD    T2 -- 基金客户签约信息表
ON  A.CST_ID = T2.CST_ID
AND T2.DT = '@@{yyyyMMdd}'  --取数当日该客户的财富管户人
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD                T3 -- 员工汇总信息
ON  T2.WLTH_MNG_MNL_ID = T3.EMPE_ID
and nvl(T2.WLTH_MNG_MNL_ID,'')<>''  --非空
AND T3.DT = '20240331'      --3月31日财富管户人所属分行、团队
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD        T4
ON  coalesce(T3.ORG_ID,t2.wlth_mng_org_id) = T4.ORG_ID
AND T4.DT = '@@{yyyyMMdd}'
;
SELECT '01' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01
union all
SELECT '011' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01_1
union all
SELECT '02' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02
union all
SELECT '021' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02_1
union all
SELECT '03' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03 where rn=1
union all
SELECT '04' ,COUNT(1) CNT,COUNT(DISTINCT 客户号) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_04
;
/*
01	19274	19274
011	7848	7848
02	691	691
021	733	733
03	15644	15644
04	691	691
*/***SJ20240409207_广发基金定投奖励0418.sql
-- 活动开始前（10.31日前）已在我行存在定投扣款成功记录的客户
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01 AS
SELECT  DISTINCT cst_id
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di --基金交易确认流水明细
WHERE   dt <= '20231130'
-- AND     bus_dt <= '20231031' --业务时间
and     apl_tm<='2023-10-31 15:00:00'   --申请时间
AND     TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     BUS_CD = '139' --定时定额申购确认
;
-- 定投累计申请金额
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02 AS
SELECT  A.cst_id
        ,count(1)           AIP_ACM_CFM_CNT
        ,sum(a.cfm_amt)     AIP_ACM_CFM_AMT
            , '混合型', '04', '货币型', '05', '其他', '06', 'FOF基金'))) AIP_ACM_fnd_typ
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di          A --基金交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD            C --基金产品基础信息表
on  A.PD_CD=C.PD_CD
AND C.DT='@@{yyyyMMdd}'
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01 D
ON      a.cst_id = d.cst_id
WHERE   A.dt <= '@@{yyyyMMdd}'
-- AND     A.bus_dt BETWEEN '20231101' AND '20240331' --业务时间
AND     replace(replace(replace(A.apl_tm,'-',''),':',''),' ','') <= '20240331150000'
AND     replace(replace(replace(A.apl_tm,'-',''),':',''),' ','') > '20231031150000'
AND     A.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：'0','申请成功','3','确认成功','4','部分确认成功','S','成功'
AND     A.BUS_CD = '139' --定时定额申购确认
AND     d.cst_id IS NULL --剔除 存量定投客户
GROUP BY A.cst_id
HAVING AIP_ACM_CFM_CNT >= 3
AND    AIP_ACM_CFM_AMT >= 1000
;
--当前基金状态
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03 AS
SELECT cst_id, cst_nm, agr_sts_cd
    ,decode(agr_sts_cd,'0','正常','1','暂停','2','客户终止','3','异常终止','4','到期终止','') agr_sts_nm
    ,dt     agr_sts_final_updt
    ,row_number() over(partition by cst_id order by dt desc)rn
FROM EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD
WHERE DT BETWEEN '20231101' and '20240331'
;
-- 输出结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_04;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_04 AS
SELECT concat(substr(c.cst_nm,1,1),'**')    as  客户姓名_脱敏
	,A.CST_ID 					                as  客户号
	,T2.WLTH_MNG_MNL_ID                         as  取数当日财富管户人工号
	,T3.EMPE_NM                                 as  取数当日财富管户人姓名
	,T4.TEM_ORG_NM                              as  当前财富管户人3月31日所属团队
	,T4.BRC_ORG_NM                              as  当前财富管户人3月31日所属分行
	,COALESCE(A.AIP_ACM_CFM_AMT,0)              as  定投累计申请金额
	,COALESCE(A.AIP_ACM_CFM_CNT,0)              as  定投累计申请次数
    ,agr_sts_final_updt                             定投协议最后更新日期
    ,agr_sts_nm                                     定投协议最后更新状态
	,case when agr_sts_final_updt='20240331' then agr_sts_nm else 'null' end AS  定投协议0331日状态
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02      A
-- left join edw.dim_cst_bas_inf_dd	                b --客户基本信息
-- on  a.cst_ID=b.cst_ID
-- and b.dt='@@{yyyyMMdd}'
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03 c
ON  A.CST_ID=c.CST_ID
and c.rn=1
LEFT JOIN EDW.DIM_BUS_CHM_FND_CST_CTR_INF_DD    T2 -- 基金客户签约信息表
ON  A.CST_ID = T2.CST_ID
AND T2.DT = '@@{yyyyMMdd}'  --取数当日该客户的财富管户人
LEFT JOIN EDW.DWS_HR_EMPE_INF_DD                T3 -- 员工汇总信息
ON  T2.WLTH_MNG_MNL_ID = T3.EMPE_ID
and nvl(T2.WLTH_MNG_MNL_ID,'')<>''  --非空
AND T3.DT = '20240331'      --3月31日财富管户人所属分行、团队
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD        T4
ON  coalesce(T3.ORG_ID,t2.wlth_mng_org_id) = T4.ORG_ID
AND T4.DT = '@@{yyyyMMdd}'
;
SELECT '01' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_01
union all
SELECT '02' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_02
union all
SELECT '03' seq,COUNT(1) CNT,COUNT(DISTINCT CST_ID) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_03
where rn=1
union all
SELECT '04' ,COUNT(1) CNT,COUNT(DISTINCT 客户号) CUSTS
FROM LAB_BIGDATA_DEV.SJXQ_SJ20240409207_CST_04
;
/*
01	19274	19274
011	7848	7848
02	691	691
021	733	733
03	15644	15644
04	691	691
20240418修改后
01	19274	19274
02	694	694
03	15644	15644
04	694	694
*/***SJ2024040981_贵金属开门红.sql
-- dt还是用最新日期dt,订单时间限制20240101-20240331
-- 01 贵金属整合表
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD AS
  SELECT
    DT                    AS 查询日期
    ,PVD_NM               AS 商铺名称
    ,ORD_ID               AS 订单号
    ,USR_NM               AS 买家名称
    ,CST_ID               AS 客户号
    ,CST_NM               AS 真实姓名
    ,PST_MTH              AS 邮寄方式
    ,ORD_TM               AS 订单时间
    ,PMT_TM               AS 付款时间
    ,PMT_MTH              AS 支付方式
    ,CHNL_NM              AS 渠道
    ,ORD_STS              AS 订单状态
    ,CMDT_NM              AS 商品名称
    ,CMDT_SPEC            AS 商品规格
    ,QTY                  AS 购买数量
    ,GOODS_TYP            AS 商品分类
    ,GOODS_RETURN_STATUS  AS 商品退款状态
    ,CMDT_UNT_PRC         AS 商品现金单价
    ,CMDT_PAY_UNT_PRC     AS 商品应付现金总额
    ,CMSN_TYP             AS 佣金类型
    ,MID_INC_RTO          AS 佣金比例_金额
    ,MID_INC_TOT_AMT      AS 佣金总额
    ,RCM_PSN_ID           AS 推荐人工号
    ,RCM_PSN_NM           AS 推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID  AS 推荐人所属部门_团队ID
    ,RCM_PSN_AFL_DEPT     AS 推荐人所属部门_团队
    ,RCM_PSN_AFL_SUB_BRN  AS 推荐人所属支行
    ,RCM_PSN_AFL_BRN      AS 推荐人所属分行
    ,DATA_SRC             AS 数据来源
FROM  adm_pub.ADM_PUB_CST_NOB_MET_TRX_DTL_DI A
WHERE A.dt <= '@@{yyyyMMdd}'
and replace(a.ord_tm,'-','') between '20240101' and '20240331'
UNION ALL
SELECT
    DT                    AS 查询日期
    ,PVD_NM               AS 商铺名称
    ,ORD_ID               AS 订单号
    ,USR_NM               AS 买家名称
    ,CST_ID               AS 客户号
    ,CST_NM               AS 真实姓名
    ,PST_MTH              AS 邮寄方式
    ,ORD_TM               AS 订单时间
    ,PMT_TM               AS 付款时间
    ,PMT_MTH              AS 支付方式
    ,CHNL_NM              AS 渠道
    ,ORD_STS              AS 订单状态
    ,CMDT_NM              AS 商品名称
    ,CMDT_SPEC            AS 商品规格
    ,QTY                  AS 购买数量
    ,GOODS_TYP            AS 商品分类
    ,GOODS_RETURN_STATUS  AS 商品退款状态
    ,CMDT_UNT_PRC         AS 商品现金单价
    ,CMDT_PAY_UNT_PRC     AS 商品应付现金总额
    ,CMSN_TYP             AS 佣金类型
    ,MID_INC_RTO          AS 佣金比例_金额
    ,MID_INC_TOT_AMT      AS 佣金总额
    ,RCM_PSN_ID           AS 推荐人工号
    ,RCM_PSN_NM           AS 推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID  AS 推荐人所属部门_团队ID
    ,RCM_PSN_AFL_DEPT     AS 推荐人所属部门_团队
    ,RCM_PSN_AFL_SUB_BRN  AS 推荐人所属支行
    ,RCM_PSN_AFL_BRN      AS 推荐人所属分行
    ,DATA_SRC             AS 数据来源
FROM  adm_pub.ADM_PUB_CST_NOB_MET_TRX_HAND_DI A
WHERE A.dt <= '@@{yyyyMMdd}'
and replace(a.ord_tm,'-','') between '20240101' and '20240331'
;
-- 04 个人
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_EMPE_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_EMPE_01 AS
SELECT  *
        ,CASE
            WHEN 中收排名 = 1 AND 销售中收 >= 300000    THEN '50克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 250000    THEN '30克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 200000    THEN '20克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 = 1 AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 = 1 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 = 1 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 = 1 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 = 1 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 = 1 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 250000    THEN '30克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 200000    THEN '20克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 2 AND 中收排名 <= 3  AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 200000    THEN '20克金条'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 4 AND 中收排名 <= 8  AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 150000    THEN '华为60M'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 9 AND 中收排名 <= 14 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 100000    THEN '苹果15Pro'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 15 AND 中收排名 <= 22 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 80000     THEN '苹果15'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 23 AND 中收排名 <= 32 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 60000     THEN '苹果平板'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 33 AND 中收排名 <= 47 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 50000     THEN '苹果手表'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 48 AND 中收排名 <= 67 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 68 AND 中收排名 <= 117 AND 销售中收 >= 40000     THEN '2克金条'
            WHEN 中收排名 >= 68 AND 中收排名 <= 117 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 68 AND 中收排名 <= 117 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 118 AND 中收排名 <= 197 AND 销售中收 >= 20000     THEN '1克金条'
            WHEN 中收排名 >= 118 AND 中收排名 <= 197 AND 销售中收 >= 10000     THEN '200油卡'
            WHEN 中收排名 >= 198 AND 中收排名 <= 347 AND 销售中收 >= 10000     THEN '200油卡'
           ELSE ''
         END AS 入围奖励
FROM    (
            SELECT  t1.推荐人所属分行
                    ,t1.推荐人所属支行
                    ,t1.推荐人工号
                    ,t1.推荐人姓名
                    ,sum(t1.商品应付现金总额)                                 AS 销售规模
                    ,sum(t1.佣金总额)                                     AS 销售中收
                    ,row_number() OVER ( ORDER BY sum(t1.佣金总额) DESC ) AS 中收排名
            FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD t1
            WHERE   t1.查询日期 >= '20240101'
            AND     t1.查询日期 <= '@@{yyyyMMdd}'
            AND     t1.推荐人所属分行 REGEXP '分行'
            GROUP BY t1.推荐人所属分行 , t1.推荐人所属支行 , t1.推荐人工号 , t1.推荐人姓名
        ) T1;
-- 03 支行
-- 支行人力数据 雷萍提供人力数据，已复核数仓数据
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_EMPE_NUM PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_EMPE_NUM AS
-- SELECT  t.empe_id
--         ,t.org_id
--         ,t.org_nm
--         ,t1.sbr_org_id
--         ,t1.sbr_org_nm
--         ,t1.brc_org_id
--         ,t1.brc_org_nm
SELECT  t1.sbr_org_id
        ,t1.sbr_org_nm
        ,count(DISTINCT empe_id) empe_num
FROM    edw.dws_hr_empe_inf_dd t
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t1
ON      t.org_id = t1.org_id
AND     t1.dt = '@@{yyyyMMdd}'
WHERE   t.dt = '@@{yyyyMMdd}'
AND     t.HC_TYP_CD = '1' --编制内
AND     t.lbr_typ_cd <> '07' --剔除合作用工
GROUP BY t1.sbr_org_id, t1.sbr_org_nm
;
-- 支行数据
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_01 AS
SELECT  *
        ,CASE
           WHEN 中收达成排名 = 1 AND 销售中收 >= 700000                    THEN '特等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 600000                    THEN '一等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 500000                    THEN '二等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 300000                    THEN '三等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 200000                    THEN '四等奖'
           WHEN 中收达成排名 = 1 AND 销售中收 >= 100000                    THEN '优胜奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 600000   THEN '一等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 500000   THEN '二等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 300000   THEN '三等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 200000   THEN '四等奖'
           WHEN 中收达成排名 >= 2 AND 中收达成排名 <= 3 AND 销售中收 >= 100000   THEN '优胜奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 500000   THEN '二等奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 300000   THEN '三等奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 200000   THEN '四等奖'
           WHEN 中收达成排名 >= 4 AND 中收达成排名 <= 6 AND 销售中收 >= 100000   THEN '优胜奖'
           WHEN 中收达成排名 >= 7 AND 中收达成排名 <= 11 AND 销售中收 >= 300000  THEN '三等奖'
           WHEN 中收达成排名 >= 7 AND 中收达成排名 <= 11 AND 销售中收 >= 200000  THEN '四等奖'
           WHEN 中收达成排名 >= 7 AND 中收达成排名 <= 11 AND 销售中收 >= 100000  THEN '优胜奖'
           WHEN 中收达成排名 >= 12 AND 中收达成排名 <= 19 AND 销售中收 >= 200000 THEN '四等奖'
           WHEN 中收达成排名 >= 12 AND 中收达成排名 <= 19 AND 销售中收 >= 100000 THEN '优胜奖'
           WHEN 中收达成排名 >= 20 AND 中收达成排名 <= 49 AND 销售中收 >= 100000 THEN '优胜奖'
           ELSE ''
         END AS 入围奖项
FROM    (
            SELECT  T1.推荐人所属分行                                   AS 分行
                    ,T1.推荐人所属支行                                  AS 支行
                    ,T2.empe_num                                 AS 1月10日在职销售人力
                    ,t1.销售规模
                    ,t1.销售中收
                    ,t1.破冰人数
                    ,ROUND(t1.破冰人数 / t2.empe_num, 2)             AS 人员破冰率
                    ,row_number() OVER ( ORDER BY t1.销售中收 DESC ) AS 中收达成排名
            FROM    (
                        SELECT  推荐人所属分行
                                ,推荐人所属支行
                                ,sum(商品应付现金总额)         AS 销售规模
                                ,sum(佣金总额)             AS 销售中收
                                ,count(DISTINCT 推荐人工号) AS 破冰人数
                        FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD
                        WHERE   查询日期 >= '20240101'
                        AND     查询日期 <= '@@{yyyyMMdd}'
                        AND     推荐人所属分行 REGEXP '分行'
                        GROUP BY 推荐人所属分行 , 推荐人所属支行
                    ) T1
            LEFT JOIN    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_EMPE_NUM T2
            ON      t1.推荐人所属支行 = t2.sbr_org_nm
        ) t1;
-- 02 分行
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_01 AS
SELECT  A.分行
        ,A.当日规模
        ,A.当日中收
        ,A.当月规模
        ,A.当月中收
        ,A.1月1日至今规模
        ,A.1月1日至今中收
        ,A.1月1日至今件数
        ,D.empe_num AS 当前在职销售人力
        ,A.1月1日至今破冰人数
        ,ROUND(A.1月1日至今破冰人数/D.empe_num,2) AS 员工破冰率
        ,D.sbr_org_num AS 当前支行数
        ,A.1月1日至今破冰支行数
        ,ROUND(A.1月1日至今破冰支行数/D.sbr_org_num,2) AS 支行破冰率
        ,A.1月1日至今件均规模元
        ,A.1月1日至今网均规模元
        ,CASE
           WHEN 分行中收排名 = 1 AND 1月1日至今中收 >= 5000000                  THEN '一等奖'
           WHEN 分行中收排名 = 1 AND 1月1日至今中收 >= 3000000                  THEN '二等奖'
           WHEN 分行中收排名 = 1 AND 1月1日至今中收 >= 1000000                  THEN '三等奖'
           WHEN 分行中收排名 >= 2 AND 分行中收排名 <= 3 AND 1月1日至今中收 >= 3000000 THEN '二等奖'
           WHEN 分行中收排名 >= 2 AND 分行中收排名 <= 3 AND 1月1日至今中收 >= 1000000 THEN '三等奖'
           WHEN 分行中收排名 >= 4 AND 分行中收排名 <= 6 AND 1月1日至今中收 >= 1000000 THEN '三等奖'
           ELSE ''
         END AS 优秀专员奖
        ,b.营销达人奖入围奖励人数
        ,c.优秀机构奖入围机构数
FROM    (
            SELECT  t1.推荐人所属分行 分行
                    ,t1.当日规模
                    ,t1.当日中收
                    ,t2.当月规模
                    ,t2.当月中收
                    ,T3.1月1日至今规模
                    ,T3.1月1日至今中收
                    ,T3.1月1日至今件数
                    ,T3.1月1日至今破冰人数
                    ,T3.1月1日至今破冰支行数
                    ,T3.1月1日至今件均规模元
                    ,T3.1月1日至今网均规模元
                    ,row_number() OVER ( ORDER BY t3.1月1日至今中收 DESC ) AS 分行中收排名
            FROM    (
                        SELECT  t.推荐人所属分行
                                ,nvl(t1.当日规模,0) 当日规模
                                ,nvl(t1.当日中收,0) 当日中收
                        FROM    (
                                    SELECT  DISTINCT 推荐人所属分行
                                    FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD
                                    WHERE     推荐人所属分行 REGEXP '分行'
                                ) t
                        LEFT JOIN    (
                                         SELECT  推荐人所属分行
                                                 ,sum(商品应付现金总额) AS 当日规模
                                                 ,sum(佣金总额)     AS 当日中收
                                         FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD
                                         WHERE   查询日期 = '@@{yyyyMMdd}'
                                         AND     推荐人所属分行 REGEXP '分行'
                                         GROUP BY 推荐人所属分行
                                     ) t1
                        ON      t.推荐人所属分行 = t1.推荐人所属分行
                    ) T1
            LEFT JOIN    (
                             SELECT  推荐人所属分行
                                     ,sum(商品应付现金总额) AS 当月规模
                                     ,sum(佣金总额)     AS 当月中收
                             FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD
                             WHERE   查询日期 >= '@@{yyyyMM}01'
                             AND     查询日期 <= '@@{yyyyMMdd}'
                             AND     推荐人所属分行 REGEXP '分行'
                             GROUP BY 推荐人所属分行
                         ) T2
            ON      t1.推荐人所属分行 = t2.推荐人所属分行
            LEFT JOIN    (
                             SELECT  推荐人所属分行
                                     ,sum(商品应付现金总额)                                     AS 1月1日至今规模
                                     ,sum(佣金总额)                                         AS 1月1日至今中收
                                     ,sum(购买数量)                                         AS 1月1日至今件数
                                     ,count(DISTINCT 推荐人工号)                             AS 1月1日至今破冰人数
                                     ,count(DISTINCT 推荐人所属支行)                           AS 1月1日至今破冰支行数
                                     ,ROUND(sum(商品应付现金总额) / sum(购买数量), 2)               AS 1月1日至今件均规模元
                                     ,ROUND(sum(商品应付现金总额) / count(DISTINCT 推荐人所属支行), 2) AS 1月1日至今网均规模元
                             FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_TRX_SUM_DD
                             WHERE   查询日期 >= '20240101'
                             AND     查询日期 <= '@@{yyyyMMdd}'
                             AND     推荐人所属分行 REGEXP '分行'
                             GROUP BY 推荐人所属分行
                         ) T3
            ON      t1.推荐人所属分行 = t3.推荐人所属分行
        ) A
LEFT JOIN    (
                 SELECT  推荐人所属分行
                         ,sum(CASE
                                WHEN 入围奖励 <> '' THEN 1
                                ELSE 0
                              END) AS 营销达人奖入围奖励人数
                 FROM    lab_bigdata_dev.SJXQ_SJ2024040981_GOLD_MONITOR_EMPE_01
                 GROUP BY 推荐人所属分行
             ) B
ON      a.分行 = b.推荐人所属分行
LEFT JOIN    (
                 SELECT  分行
                         ,sum(CASE
                                WHEN 入围奖项 <> '' THEN 1
                                ELSE 0
                              END) AS 优秀机构奖入围机构数
                 FROM    lab_bigdata_dev.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_01
                 GROUP BY 分行
             ) c
ON      a.分行 = c.分行
LEFT JOIN (
        SELECT  t1.brc_org_id
                ,t1.brc_org_nm
                ,count(DISTINCT empe_id) empe_num
                ,count(DISTINCT sbr_org_id) sbr_org_num
        FROM    edw.dws_hr_empe_inf_dd t
        LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t1
        ON      t.org_id = t1.org_id
        AND     t1.dt = '@@{yyyyMMdd}'
        WHERE   t.dt = '@@{yyyyMMdd}'
        AND     t.HC_TYP_CD = '1' --编制内
        AND     t.lbr_typ_cd <> '07' --剔除合作用工
        GROUP BY t1.brc_org_id, t1.brc_org_nm
) D
ON     a.分行 = d.brc_org_nm
;
--加上总计
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_02 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_02 AS
SELECT  *
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_01
UNION ALL
SELECT  '总计' AS 分行
        ,sum(当日规模) 当日规模
        ,sum(当日中收) 当日中收
        ,sum(当月规模) 当月规模
        ,sum(当月中收) 当月中收
        ,sum(1月1日至今规模) 1月1日至今规模
        ,sum(1月1日至今中收) 1月1日至今中收
        ,sum(1月1日至今件数) 1月1日至今件数
        ,sum(当前在职销售人力) 当前在职销售人力
        ,sum(1月1日至今破冰人数) 1月1日至今破冰人数
        ,ROUND(AVG(员工破冰率),2) 员工破冰率
        ,sum(当前支行数) 当前支行数
        ,sum(1月1日至今破冰支行数) 1月1日至今破冰支行数
        ,ROUND(avg(支行破冰率),2) 支行破冰率
        ,avg(1月1日至今件均规模元) 1月1日至今件均规模元
        ,avg(1月1日至今网均规模元) 1月1日至今网均规模元
        ,'' 优秀专员奖
        ,sum(营销达人奖入围奖励人数) 营销达人奖入围奖励人数
        ,sum(优秀机构奖入围机构数) 优秀机构奖入围机构数
FROM    LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_01;
--结果表
-- 个人维度 LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_EMPE_01
-- 支行维度 LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_SBR_01
-- 分行维度 LAB_BIGDATA_DEV.SJXQ_SJ2024040981_GOLD_MONITOR_BRC_02
SELECT * FROM SJXQ_SJ2024040981_GOLD_MONITOR_BRC_02***SJ2024041101_湖州分行信贷户信息.sql
-- 湖州分行 全量信贷客户
-- 客户号、最新合同号、最新预评估结果、他行贷款余额
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041101_CST_01;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041101_CST_01 AS
select B.cst_ID,b.cst_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,B.BUSI_APL_ID
    ,c.pre_apl_srl_nbr
    ,D.PREEVALUATERESULT                    pre_ases_res_CD
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT end        pre_ases_res
    ,E.BRC_ORG_NM,E.SBR_ORG_NM,E.TEM_ORG_NM,E.ORG_NM
from edw.DIM_BUS_LOAN_CTR_INF_DD        B --信贷合同信息
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='@@{yyyyMMdd}'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd       E --考核机构树
on  B.pfm_blg_org=E.org_id         --业绩归属机构
and e.BRC_ORG_NM='湖州分行'
and E.dt='@@{yyyyMMdd}'
LEFT JOIN (
    SELECT BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        ,sum(prcp_bal) LOAN_BAL     --本金余额
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT ='@@{yyyyMMdd}'
    GROUP BY DT,BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
WHERE NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND   B.DT ='@@{yyyyMMdd}'
;
-- 最新他行贷款余额
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041101_CST_02;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041101_CST_02 AS
select t1.cst_id
    ,t2.oth_bank_loan_credit_bal cur_othbnk_loan_bal       --他行授信贷款余额
    ,t2.report_dt
FROM (select distinct cst_id from SJXQ_SJ2024041101_CST_01)  t1
inner JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd   t2 --个人征信指标信息表
ON  t1.cst_id = t2.cst_id
AND t2.report_dsc_rn = 1    --最新
AND t2.dt = '@@{yyyyMMdd}'
;
--输出结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041101_CST_03;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041101_CST_03 AS
SElECT t1.cst_ID                客户号
    ,t1.cst_nm                  客户名称
    ,t1.REG_DT                  申请日期
    ,t1.busi_ctr_id             申请合同号
    ,t1.pre_ases_res            预评估结果
    ,t2.cur_othbnk_loan_bal     他行贷款余额
    ,t2.report_dt               他行贷款余额查询日期
    ,t1.BRC_ORG_NM              分行
    ,t1.ORG_NM                  机构
    ,row_number() over(partition by t1.cst_ID order by t1.REG_DT) 申请序号
from SJXQ_SJ2024041101_CST_01       t1
left join SJXQ_SJ2024041101_CST_02  t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt, count(distinct BUSI_CTR_ID) custs
from SJXQ_SJ2024041101_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_ID) custs
from SJXQ_SJ2024041101_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024041101_CST_03
;
/*
01	37626	37626
02	25529	25529
03	37626	26014
*/***SJ2024041191_员工持证情况.sql
-- 20240410 台州分行 理财和保险相关证书
--行内理财
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_01;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_01 AS
SELECT  a.client_manager empe_id
    ,b.ctf_get_id	--证书取得编号|C250
    ,b.ctf_nm	    --证书名称|C250
    -- ,row_number() over(partition by b.cm_id,b.ctf_get_id order by b.inpt_srl_nbr desc) rn
FROM    edw.finc_tbclientmanager                    a --客户经理信息表
left join edw.dim_hr_empe_fin_mng_intlg_ctf_inf_dd  b --客户经理理财资质证书信息
on  a.client_manager = b.cm_id
and b.bus_typ = '1'     --理财资质
and b.dt='20240410'
WHERE   a.prd_rights LIKE '%1%' --理财
AND     a.dt = '20240410'
;
--行内保险
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_02;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_02 AS
SELECT  distinct a.cm_id empe_id
    ,a.ctf_get_id	--证书取得编号|C250
    ,a.ctf_nm	    --证书名称|C250
FROM    edw.dim_hr_empe_fin_mng_intlg_ctf_inf_dd a --客户经理理财资质证书信息
inner JOIN    edw.finc_tbclientmanager b
ON      a.cm_id = b.client_manager
AND     b.dt = '20240410'
WHERE   a.dt = '20240410'
AND     a.bus_typ = '4'     --保险资质
;
--行外证书
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_03;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_03 AS
select *
    ,row_number() over(partition by t1.empe_id,t1.ctf_id order by t1.aprv_dt desc) rn
from(
    select t1.empe_id,t1.get_tm,t1.ctf_id,t1.ctf_isu_org
        ,t1.ind_bus_ind	--职业资格类别|C32
        ,t1.cmt
        ,t1.std_ctf_nm
        ,c1.cd_val_dscr std_ctf
        ,t1.pro_ctg,t1.pro_ctg_nm   --专业类别 名称
        ,t1.aprv_dt
        ,row_number() over(partition by t1.empe_id,t1.std_ctf_nm order by t1.get_tm desc,t1.pro_ctg desc) rn1
    from edw.dim_hr_empe_ctf_ttl_dd     t1 --员工证书职称信息
    LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C1
    ON  t1.std_ctf_nm = C1.CD_VAL
    AND C1.DT = '20240410'
    where t1.dt='20240410'
    and nvl(t1.std_ctf_nm,'')<>''   --证书名称 非空 证书编号有缺失
    and (t1.orig_ctf_nm regexp '理财|保险' or c1.cd_val_dscr regexp '理财|保险'
        or t1.pro_ctg_nm regexp '理财|保险' or t1.cmt regexp '理财|保险' or t1.ctf_isu_org='中国银行业协会')
)t1 where rn1=1
;
-- --有理财资质，但无证书客户 133
-- DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_03_1;
-- CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_03_1 AS
-- SELECT distinct a.empe_id
-- from SJXQ_SJ2024041191_CST_01       a
-- left join SJXQ_SJ2024041191_CST_03  b
-- on a.empe_id=b.empe_id
-- where a.ctf_get_id is null
-- and b.empe_id is null
-- ;
--客户汇总
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_04;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_04 AS
select t1.empe_id,t1.ctf_get_id,t1.ctf_nm,'行内理财' bus_typ
    ,case when t1.ctf_get_id is null then '有理财资质，但无证书信息' else '' end cmt
from SJXQ_SJ2024041191_CST_01   t1
left join (
    select distinct ctf_id
    from SJXQ_SJ2024041191_CST_03
    where rn=1 and nvl(ctf_id,'')<>''
)t2 on t1.ctf_get_id=t2.ctf_id
where t2.ctf_id is null          --不在 行外证书 里面
union all
select t1.empe_id,t1.ctf_get_id,t1.ctf_nm,'保险' bus_typ,'' cmt
from SJXQ_SJ2024041191_CST_02   t1
left join (
    select distinct ctf_id
    from SJXQ_SJ2024041191_CST_03
    where rn=1 and nvl(ctf_id,'')<>''
)t2 on t1.ctf_get_id=t2.ctf_id
where t2.ctf_id is null          --不在 行外证书 里面
union all
select empe_id,ctf_id,std_ctf,'行外证书' bus_typ,concat(ctf_isu_org,cmt,pro_ctg_nm) cmt
from SJXQ_SJ2024041191_CST_03
where rn=1
;
--输出结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_05;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041191_CST_05 AS
SElECT t3.BRC_ORG_NM 		分行
    ,t3.SBR_ORG_NM          支行名称
    ,t3.SBR_ORG_ID          支行机构号
    ,t3.TEM_ORG_NM          团队名称
    ,t3.TEM_ORG_ID          团队机构号
    ,t1.empe_nm             姓名
    ,t1.empe_id             工号
    ,t2.ctf_nm              证书名称
    ,t2.ctf_get_id          证书编号
    ,t2.bus_typ             证书类别
    ,t2.cmt                 备注
FROM EDW.DWS_HR_EMPE_INF_DD					T1	--员工汇总信息
inner join SJXQ_SJ2024041191_CST_04         t2
on t1.empe_id=t2.empe_id
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t1.org_id=t3.org_id
and t3.BRC_ORG_NM = '台州分行'
and t3.dt='20240410'
where T1.DT = '20240410'
;
SElECT '01' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024041191_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024041191_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct ctf_id) custs
from SJXQ_SJ2024041191_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt, count(distinct ctf_get_id) custs
from SJXQ_SJ2024041191_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 工号,证书编号) custs
from SJXQ_SJ2024041191_CST_05
;
/*
问题：
行外证书编号比较乱，编号缺失、重复、失真
行内、行外证书编号有重叠
证书编号、证书名称 不能一一对应
01	7864	7864
02	8241	8241
03	8218	8090
04	24257	22313
05	4684	4211
SElECT ctf_get_id,REGEXP_SUBSTR(ctf_get_id,'[a-zA-Z0-9]{10,}',1,1) c1
    ,REGEXP_SUBSTR(ctf_get_id,'[a-zA-Z0-9]{10,}',1,2) c2
    ,REGEXP_SUBSTR(ctf_get_id,'[a-zA-Z0-9]{10,}',1,3) c3
from SJXQ_SJ2024041191_CST_04
;
*/***SJ2024041217_理财新客营销.sql
-- 客户号	是否为我行员工	如是，对应我行员工工号	是否购买过理财	客户财富星级
--是否我行高管
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_01;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_01 AS
SELECT  distinct t.cst_id
FROM    adm_pub.adm_csm_cbas_idv_bas_inf_dd t
INNER JOIN    app_ado.T_DCDP_USER_UNION t1
ON      t1.user_id = t.own_emp_id
AND     t1.SEQNO = '1'
WHERE   t.dt = '@@{yyyyMMdd}'
AND     t1.rolename LIKE '%高层管理者%'
;
/*
--222 数量不对
select DISTINCT empe_id
from edw.dwd_hr_empe_exct_crr_inf_dd          --员工高管履职信息
where dt='@@{yyyyMMdd}'
and exct_qua_ind='1'    --高管资格标志|C384
*/
--历史购买过理财客户
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_02;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_02 AS
SElECT DISTINCT t1.cst_id
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI T1 --理财交易确认流水明细 立英修改
where T1.DT<='@@{yyyyMMdd}'
AND t1.trx_sts_cd ='8'              --确认成功
and t1.trx_amt<>0
;
--结果表
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_03;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_03 AS
select t1.cst_id            --客户编号|C20
	,t1.ctr_dt              --签约日期|C8
    ,CASE WHEN LENGTH(t2.own_emp_id)>0 THEN '是' else '否' end is_empe
    ,t2.own_emp_id	        --本行员工号|C10
    ,case when t4.cst_id is not null THEN '是' else '否' end is_buy_fina
    ,decode(t5.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星') aum_grd
    ,row_number() over(order by t1.ctr_dt,t1.cst_id) rn
from edw.dwd_bus_chm_ctr_inf_dd         t1  --理财客户签约信息 全量理财签约客户
left join edw.dim_cst_idv_bas_inf_dd	t2  --个人客户基本信息
on  t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024041217_CST_01      t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2024041217_CST_02      t4
on t1.cst_id=t4.cst_id
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd t5 --客户等级信息
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.sal_rcd_sts_cd = '0' --未解约 销售商记录状态代码
and t1.ctr_dt<>'0'          --剔除异常数据
and t3.cst_id is null       --剔除我行高管
;
--输出结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04 AS
select cst_id               客户编号
	,ctr_dt                 签约日期
    ,is_empe                是否行员
    ,own_emp_id	            本行员工号
    ,is_buy_fina            是否购买过理财
    ,aum_grd                客户财富星级
    ,rn
from SJXQ_SJ2024041217_CST_03
;
--分10万一组出结果
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_1;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_1 AS
SElECT *
from SJXQ_SJ2024041217_CST_04
where rn<=100000
;
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_2;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_2 AS
SElECT *
from SJXQ_SJ2024041217_CST_04
where rn>100000 and rn<=200000
;
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_3;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_3 AS
SElECT *
from SJXQ_SJ2024041217_CST_04
where rn>200000 and rn<=300000
;
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_4;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_4 AS
SElECT *
from SJXQ_SJ2024041217_CST_04
where rn>300000 and rn<=400000
;
DROP    TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_5;
CREATE  TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041217_CST_04_5 AS
SElECT *
from SJXQ_SJ2024041217_CST_04
where rn>400000
;
SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041217_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_ID) custs
from SJXQ_SJ2024041217_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_ID) custs
from SJXQ_SJ2024041217_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户编号) custs
from SJXQ_SJ2024041217_CST_04
union all
SElECT '01' seq, count(1) cnt, count(distinct 客户编号) custs
from SJXQ_SJ2024041217_CST_04_1
union all
SElECT '02' seq, count(1) cnt, count(distinct 客户编号) custs
from SJXQ_SJ2024041217_CST_04_2
union all
SElECT '03' seq, count(1) cnt, count(distinct 客户编号) custs
from SJXQ_SJ2024041217_CST_04_3
union all
SElECT '04' seq, count(1) cnt, count(distinct 客户编号) custs
from SJXQ_SJ2024041217_CST_04_4
union all
SElECT '05' seq, count(1) cnt, count(distinct 客户编号) custs
from SJXQ_SJ2024041217_CST_04_5
;
/*
01	17	17
02	344313	344313
04	499324	499324
03	499324	499324
01	100000	100000
02	100000	100000
03	100000	100000
04	100000	100000
05	99324	99324
*/***SJ2024041511_二期外呼分析.sql
-- 监测大盘 客户转化情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_01 AS
SELECT distinct case_no,case_name,case_phase,cst_id,exec_date
    ,rel_cst_id,is_slf,sample_class
    ,connect_chnl,sum_score,prm_fh_org_nm,is_convert
    ,call_rslt              --外呼小结
    ,call_status            --外呼状态
FROM LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_AFF_ANLS_DAPAN
WHERE CASE_PHASE='allround202402'   --期数
;
-- 客户名单
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_02 AS
SELECT t2.case_name CASE_NM,t2.cst_id,t2.brc_org_nm
    ,t2.is_convert,t2.call_rslt,t2.call_status
from (
    select cst_id,case_name,max(is_convert)     is_convert --1转化 0 未转化
        ,min(call_status)                       call_status
    FROM SJXQ_SJ2024041511_CST_01
    where CASE_NO = 'USE_CASE_14' --理财客户拉新
    group by cst_id,case_name
)t2
;
-- 基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_03 AS
select t1.cst_id                                 --客户号
	,t1.cst_chn_nm                               --客户中文名称
	,t1.gdr_cd                                   --性别代码
    ,decode(t1.gdr_cd,'1','男','2','女','未知') gdr_nm
	,t1.age                                      --年龄
    ,CASE WHEN T1.AGE<=30 THEN '1 [0,30]'
        WHEN T1.AGE>30 AND T1.AGE<=40 THEN '2 (30,40]'
        WHEN T1.AGE>40 AND T1.AGE<=50 THEN '3 (40,50]'
        WHEN T1.AGE>50 AND T1.AGE<=60 THEN '4 (50,60]'
        WHEN T1.AGE>60 AND T1.AGE<=70 THEN '5 (60,70]'
        WHEN T1.AGE>70 THEN '6 70+' ELSE '' END AGE_GRD
	,t1.mrg_situ_cd                             --婚姻状况
	,t1.file_dt                                 --建档日期
    ,t2.ctr_dt                                  --理财签约日期
    ,t4.pd_hld_nbr                               --产品持有数
    ,case when t5.cst_id is not null then 1 else 0 end is_djk_cst
    ,case when t6.cst_id is not null then 1 else 0 end is_dfgz_cst
    ,t7.dep_bal_avg_6m
from adm_pub.adm_csm_cbas_idv_bas_inf_dd    t1  --客户集市-客户基础-对私客户基础信息
inner join SJXQ_SJ2024041511_CST_02         t0
on t1.cst_id=t0.cst_id
left join edw.dwd_bus_chm_ctr_inf_dd        t2  --理财客户签约信息
on  t1.cst_id=t2.cst_id
and t2.dt='20240427'
left join edw.dwd_bus_chm_cst_rsk_ases_dd   T3 	--理财风评表
on T1.CST_ID=T3.cst_id
and T3.dt='20240427'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd t4 --客户集市-标签信息-客户持有产品信息表
on T1.CST_ID=T4.cst_id
and t4.dt='20240427'
left join(
    select  DISTINCT cst_id
    FROM    app_ado.FCT_CC_AR_DTL_SMY_DD
    WHERE   dt = '20240427'
    AND     crd_ctg_cd = '1' --贷记卡
    AND     cr_crd_sts_cd NOT IN ( 'Q' , '2' ) --剔除销户、到期未续
    AND     ac_sts_cd <> 'V' --剔除核销
)t5 on t1.cst_id=t5.cst_id
left join (
    SELECT  DISTINCT T2.CST_ID
    FROM    EDW.CORE_KDPL_ZHMINX                T1
    INNER JOIN    EDW.DWS_BUS_DEP_ACT_INF_DD    T2
    ON      T2.DEP_ACT_ID = T1.ZHANGHAO
    AND     T1.dt = T2.dt
    AND     T2.DT = '20240427'
    WHERE   T1.DT <= '20240427'
    AND     T1.ZHAIYODM = 'IB0047' --代发工资
)t6 on t1.cst_id=t6.cst_id
left join(
    select cst_id
        ,round(sum(last_180_days_gl_bal_acml)/180,2) dep_bal_avg_6m
    from   edw.dws_bus_dep_act_inf_dd
    where dt = '20240427'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
where T1.dt='20240427'
;
--外呼情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_04 AS
SElECT cst_id,call_dt,cst_res,CALL_STATUS
    ,ROW_NUMBER() over(partition by cst_id order by call_dt asc) rn  --拒接客户会2次电销，取最早一次
FROM(
    SElECT t1.cst_id,replace(substr(t2.call_end_tm,1,10),'-','') call_dt
    from(
        select t1.data_id,t1.custno cst_id           --客户号
        FROM    edw.cout_tb_outbound_data   t1 --新外呼数据表
        inner join edw.cout_tb_out_project  t2
        on  t1.project_id = t2.project_id
        and t2.project_name = '电销商机' -- project_id = '367'
        and t2.dt='20240427'
        WHERE t1.dt >= '20240311'   -- 二级项目名称 呼叫起始日期
        AND   t1.field3 = '淘金行动之一星客户中台外呼（理财新客场景3月份）'
    ) t1 left join(
        SELECT T1.DAT_ID                                   --数据ID|C22
            ,t1.call_start_tm,t1.call_end_tm,t1.tlk_tm
            ,CASE
                WHEN T2.DIC_VALUE = '有效接通' OR ( T2.DIC_VALUE = '话务条异常' AND T1.DEAL_OPNN_SYS_CHC_CNTNT IN ( '分期成功' , '可再次追踪' ) ) THEN '有效接通'
                WHEN T2.DIC_VALUE IS NULL AND T1.DEAL_OPNN_SYS_CHC_CNTNT IS NULL                                                THEN '未外呼'
                ELSE '无效外呼' END     CALL_STATUS      --外呼状态/是否有效接通
            ,concat(T1.CST_OPNN,T1.RFS_RSN,T1.DEAL_OPNN_SYS_CHC_CNTNT) cst_res
        from edw.dwd_bus_cmpn_cout_rcd_di           t1  --人工外呼外拨记录
        LEFT JOIN EDW.COUT_TB_OUTBOUND_SERVERSULT   T2
        ON      T1.CALL_RSL = T2.ID
        AND     T2.DT = '20240427'
        where t1.dt>='20240311'
    )t2 on t1.data_id=t2.dat_id
    group by t1.cst_id,call_dt
)A
;
-- 开户天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_05 AS
select t2.dep_act_id,t2.act_nm,t2.cst_act_id,t2.cst_id
    ,t2.opn_dt,t2.ACT_STS_CD
from SJXQ_SJ2024041511_CST_02          t1
INNER join edw.DIM_BUS_DEP_ACT_INF_DD   t2
on  t1.cst_id=t2.cst_id
and t2.dt='20240427'
and t2.ACT_CTG_CD_2 = '301'  --I类账户
-- and t2.stl_act_ind='1'       --结算账户
and t2.ACT_STS_CD <> 'C'
AND t2.ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' ) --账户状态正常
;
-- 安装金融理财app的数量
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_06 AS
select t1.cst_ID,t2.fina_app_cnt_1y
from SJXQ_SJ2024041511_CST_02              t1
inner join(
    select t2.cst_id,count(distinct t2.package_name) fina_app_cnt_1y
    from wushan_adm_papp_app_data_di        t2
    inner join edw.nout_app_class_info      t3
    on lower(trim(t2.package_name)) = lower(trim(t3.pkg_name)) -- app分类表
    and t3.dt='20240427'
    and t3.category_name = '金融理财'
    where t2.dt<='20240427'
    group by t2.cst_id
)T2 on  t1.cst_ID=t2.cst_id
;
-- 借记卡 近六个月交易次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_07 AS
SELECT T1.CST_ID
    ,count(case when t3.trx_amt>0 then t3.dtl_seq_nbr end)              trx_cnt_6m
    ,max(case when t3.crd_and_dbt_ind='C' then t3.trx_amt else 0 end)   max_in_amt_6m
FROM SJXQ_SJ2024041511_CST_02               T1
INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD       T2  --存款账户信息
ON  T1.CST_ID=T2.CST_ID
AND T2.DT='20240427'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3  --交易表
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T3.DT<='20240427'
group by T1.CST_ID
;
--近六个月手机银行登录次数、天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_08 AS
select t1.alg_userid        cst_id
    ,count(T1.dt)           login_cnt_6m
    ,count(distinct t1.dt)  login_days_6m
from edw.ebnk_mb_audit_log             T1
inner join SJXQ_SJ2024041511_CST_02    t2
on t1.alg_userid=t2.cst_id
and T1.dt<='20240427'
and T1.ALG_BSNCODE='100001'
AND T1.ALG_ERRORCODE IS NULL
and T1.ALG_SYSID ='MBC'
AND LENGTH(T1.ALG_USERID) = 10
group by T1.alg_userid
;
-- 近三个月浏览理财页面次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_09 AS
SELECT  a.distinct_id cst_id
        ,a.event
        ,a.time
        ,a.a_event_duration duration
        ,a.product_id
        ,a.product_name
        ,a.click_name
        ,a.is_success
        ,a.page_name
        ,a.dt
FROM    edw.aubs_events_ibnk            a
inner join SJXQ_SJ2024041511_CST_02    t2
on a.distinct_id=t2.cst_id
WHERE a.dt<='20240427'
AND a.event REGEXP '^financial'
AND a.event REGEXP '_pageview$'
;
--历史购买理财次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_10 AS
SELECT t1.cst_id          --cst_ID
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on  t1.pd_cd=t2.pd_cd
and t2.dt='20240427'
inner join SJXQ_SJ2024041511_CST_02    t3
on  t1.cst_id=t3.cst_id
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt <='20240427'
;
-- 近六个月存款日均 近六个月活期存款日均 近六个月定期存款日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_11 AS
select t1.cst_id                                       --客户编号
	,round(sum(t1.dep_bal)     /183,4)      dep_bal_avg_6m          --存款余额
	,round(sum(t1.dmnd_dep_bal)/183,4)      dmnd_dep_bal_avg_6m     --活期存款余额
	,round(sum(t1.tm_dep_bal)  /183,4)      tm_dep_bal_avg_6m       --定期存款余额
    ,count(1)               days_cnt
from adm_pub.adm_csm_cbus_dep_inf_dd  t1        --客户集市-业务信息-客户存款业务信息表
inner join SJXQ_SJ2024041511_CST_02   t2
on  t1.cst_id=t2.cst_id
where t1.dt<='20240427'
group by t1.cst_id
;
--结果字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_12 AS
SElECT t1.case_nm,t1.cst_id,T1.brc_org_nm,t1.is_convert
    ,t1.call_rslt,t1.call_status
    ,t3.cst_chn_nm,t3.gdr_nm,t3.age,t3.AGE_GRD
    ,t3.ctr_dt                                  --理财签约日期
    ,t3.fina_ctr_days
    ,t3.fina_rsk_lvl
    ,t3.pd_hld_nbr                               --产品持有数
    ,t3.is_djk_cst,t3.is_dfgz_cst,t3.dep_bal_avg_6m
    ,t4.call_dt,t4.cst_res,t4.CALL_STATUS CALL_STATUS_old
    ,t5.opn_days
    ,t6.fina_app_cnt_1y
    ,t7.trx_cnt_6m,t7.max_in_amt_6m
    ,t8.login_cnt_6m,t8.login_days_6m
    ,t9.view_fina_cnt_3m,t9.view_fina_cnt_1m,t9.view_fina_cnt_7d
    ,t10.fina_trx_cnt,t10.bf_jkq_buy_amt,t10.fina_trx_cnt_1y
    ,t10.max_trx_amt,t10.jkq_hq_fina_buy_amt,t10.jkq_dq_fina_buy_amt
    ,t11.dep_bal_avg_6m dep_bal_avg_6m2
    ,t11.dmnd_dep_bal_avg_6m,t11.tm_dep_bal_avg_6m
from SJXQ_SJ2024041511_CST_02       t1
left join SJXQ_SJ2024041511_CST_03  t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024041511_CST_04  t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join (
    select cst_id,max(opn_days) opn_days
    from SJXQ_SJ2024041511_CST_05
    GROUP by cst_id
)t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2024041511_CST_06  t6 on t1.cst_id=t6.cst_id
left join SJXQ_SJ2024041511_CST_07  t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ2024041511_CST_08  t8 on t1.cst_id=t8.cst_id
left join(
    SElECT cst_id,count(a.event)                                                                                     view_fina_cnt_3m
    from SJXQ_SJ2024041511_CST_09 a
    group by cst_id
)t9 on t1.cst_id=t9.cst_id
left join(
    SElECT cst_id,count(1) fina_trx_cnt
        ,sum(case when trx_dt<'20240311' then cfm_amt else 0 end)   bf_jkq_buy_amt
        ,max(cfm_amt) max_trx_amt
        ,sum(case when trx_dt>='20240311' and is_fix=0 then cfm_amt else 0 end)  jkq_hq_fina_buy_amt
        ,sum(case when trx_dt>='20240311' and is_fix=1 then cfm_amt else 0 end)  jkq_dq_fina_buy_amt
    from SJXQ_SJ2024041511_CST_10
    where cfm_amt>0
    group by cst_id
)t10 on t1.cst_id=t10.cst_id
left join SJXQ_SJ2024041511_CST_11 t11
on t1.cst_id=t11.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_13 AS
SElECT case_nm                  案例名称
    ,cst_id                     客户号
    ,cst_chn_nm                 客户名称
    ,brc_org_nm                 所属分行
    ,gdr_nm                     性别
    ,AGE_GRD                    年龄层
    ,coalesce(cst_res,call_rslt)  呼叫小结
    ,CALL_STATUS                呼叫状态
    ,is_convert                 是否成功转化
    ,opn_days                   I类卡开户天数
    ,fina_ctr_days              理财签约天数
    ,fina_rsk_lvl               理财风评
    ,pd_hld_nbr                 产品持有数
    ,is_djk_cst                 是否持有贷记卡
    ,is_dfgz_cst                是否代发工资户
    ,dep_bal_avg_6m             近六个月存款日均
    ,dmnd_dep_bal_avg_6m        近六个月活期存款日均
    ,tm_dep_bal_avg_6m          近六个月定期存款日均
    ,fina_app_cnt_1y            近1年安装金融理财app的数量
    ,trx_cnt_6m                 近六个月交易次数
    ,max_in_amt_6m              近六个月流入最高金额
    ,login_days_6m              近六个月手机银行登录天数
    ,view_fina_cnt_3m           近三个月浏览理财页面次数
    ,view_fina_cnt_1m           近一个月浏览理财页面次数
    ,view_fina_cnt_7d           近一周浏览理财页面次数
    ,case when bf_jkq_buy_amt>0 then '是' else '否' end 监测期前是否购买过理财
    ,fina_trx_cnt_1y            近一年的理财交易笔数
    ,max_trx_amt                历史理财投资单笔最大金额
    ,jkq_hq_fina_buy_amt        监测期内活期理财累计购买金额
    ,jkq_dq_fina_buy_amt        监测期内定期理财购买金额
from SJXQ_SJ2024041511_CST_12
;
SElECT '01' seq, count(1) cnt, count(distinct case_no,cst_id) custs
from SJXQ_SJ2024041511_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_08
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_12
union all
SElECT '13' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024041511_CST_13
;
/*
01	14601	11000
02	11000	11000  客群
03	11000	11000  基本信息
04	4970	4970   外呼情况
05	11292	10906  开户天数
06	2502	2502   app安装
07	9214	9214   借记卡交易
08	5111	5111   app登录
09	15318	736    理财浏览
10	2884	361    历史理财购买
11	11000	11000
12	11000	11000
13	11000	11000
*/
***SJ2024041511_二期外呼分析0429.sql
-- 监测大盘 客户转化情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_01 AS
SELECT distinct case_no,case_name,case_phase,cst_id,exec_date
    ,rel_cst_id,is_slf,sample_class
    ,connect_chnl,sum_score,prm_fh_org_nm,is_convert
    ,call_rslt              --外呼小结
    ,call_status            --外呼状态
FROM LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_AFF_ANLS_DAPAN
WHERE CASE_PHASE='allround202402'   --期数
;
-- 客户名单
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_02 AS
SELECT t2.case_name CASE_NM,t2.cst_id,t2.brc_org_nm
    ,t2.is_convert,t2.call_rslt,t2.call_status
from (
    select cst_id,case_name,max(is_convert)     is_convert --1转化 0 未转化
        ,min(call_status)                       call_status
    FROM SJXQ_SJ2024041511_CST_01
    where CASE_NO = 'USE_CASE_14' --理财客户拉新
    group by cst_id,case_name
)t2
;
-- 基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_03 AS
select t1.cst_id                                 --客户号
	,t1.cst_chn_nm                               --客户中文名称
	,t1.gdr_cd                                   --性别代码
    ,decode(t1.gdr_cd,'1','男','2','女','未知') gdr_nm
	,t1.age                                      --年龄
    ,CASE WHEN T1.AGE<=30 THEN '1 [0,30]'
        WHEN T1.AGE>30 AND T1.AGE<=40 THEN '2 (30,40]'
        WHEN T1.AGE>40 AND T1.AGE<=50 THEN '3 (40,50]'
        WHEN T1.AGE>50 AND T1.AGE<=60 THEN '4 (50,60]'
        WHEN T1.AGE>60 AND T1.AGE<=70 THEN '5 (60,70]'
        WHEN T1.AGE>70 THEN '6 70+' ELSE '' END AGE_GRD
	,t1.mrg_situ_cd                             --婚姻状况
	,t1.file_dt                                 --建档日期
    ,t2.ctr_dt                                  --理财签约日期
    ,t4.pd_hld_nbr                               --产品持有数
    ,case when t5.cst_id is not null then 1 else 0 end is_djk_cst
    ,case when t6.cst_id is not null then 1 else 0 end is_dfgz_cst
    ,t7.dep_bal_avg_6m
from adm_pub.adm_csm_cbas_idv_bas_inf_dd    t1  --客户集市-客户基础-对私客户基础信息
inner join SJXQ_SJ2024041511_CST_02         t0
on t1.cst_id=t0.cst_id
left join edw.dwd_bus_chm_ctr_inf_dd        t2  --理财客户签约信息
on  t1.cst_id=t2.cst_id
and t2.dt='20240429'
left join edw.dwd_bus_chm_cst_rsk_ases_dd   T3 	--理财风评表
on T1.CST_ID=T3.cst_id
and T3.dt='20240429'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd t4 --客户集市-标签信息-客户持有产品信息表
on T1.CST_ID=T4.cst_id
and t4.dt='20240429'
left join(
    select  DISTINCT cst_id
    FROM    app_ado.FCT_CC_AR_DTL_SMY_DD
    WHERE   dt = '20240429'
    AND     crd_ctg_cd = '1' --贷记卡
    AND     cr_crd_sts_cd NOT IN ( 'Q' , '2' ) --剔除销户、到期未续
    AND     ac_sts_cd <> 'V' --剔除核销
)t5 on t1.cst_id=t5.cst_id
left join (
    SELECT  DISTINCT T2.CST_ID
    FROM    EDW.CORE_KDPL_ZHMINX                T1
    INNER JOIN    EDW.DWS_BUS_DEP_ACT_INF_DD    T2
    ON      T2.DEP_ACT_ID = T1.ZHANGHAO
    AND     T1.dt = T2.dt
    AND     T2.DT = '20240429'
    WHERE   T1.DT <= '20240429'
    AND     T1.ZHAIYODM = 'IB0047' --代发工资
)t6 on t1.cst_id=t6.cst_id
left join(
    select cst_id
        ,round(sum(last_180_days_gl_bal_acml)/180,2) dep_bal_avg_6m
    from   edw.dws_bus_dep_act_inf_dd
    where dt = '20240429'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
where T1.dt='20240429'
;
--外呼情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_04 AS
SElECT cst_id,call_dt,cst_res,CALL_STATUS
    ,ROW_NUMBER() over(partition by cst_id order by call_dt asc) rn  --拒接客户会2次电销，取最早一次
FROM(
    SElECT t1.cst_id,replace(substr(t2.call_end_tm,1,10),'-','') call_dt
    from(
        select t1.data_id,t1.custno cst_id           --客户号
        FROM    edw.cout_tb_outbound_data   t1 --新外呼数据表
        inner join edw.cout_tb_out_project  t2
        on  t1.project_id = t2.project_id
        and t2.project_name = '电销商机' -- project_id = '367'
        and t2.dt='20240429'
        WHERE t1.dt >= '20240311'   -- 二级项目名称 呼叫起始日期
        AND   t1.field3 = '淘金行动之一星客户中台外呼（理财新客场景3月份）'
    ) t1 left join(
        SELECT T1.DAT_ID                                   --数据ID|C22
            ,t1.call_start_tm,t1.call_end_tm,t1.tlk_tm
            ,CASE
                WHEN T2.DIC_VALUE = '有效接通' OR ( T2.DIC_VALUE = '话务条异常' AND T1.DEAL_OPNN_SYS_CHC_CNTNT IN ( '分期成功' , '可再次追踪' ) ) THEN '有效接通'
                WHEN T2.DIC_VALUE IS NULL AND T1.DEAL_OPNN_SYS_CHC_CNTNT IS NULL                                                THEN '未外呼'
                ELSE '无效外呼' END     CALL_STATUS      --外呼状态/是否有效接通
            ,concat(T1.CST_OPNN,T1.RFS_RSN,T1.DEAL_OPNN_SYS_CHC_CNTNT) cst_res
        from edw.dwd_bus_cmpn_cout_rcd_di           t1  --人工外呼外拨记录
        LEFT JOIN EDW.COUT_TB_OUTBOUND_SERVERSULT   T2
        ON      T1.CALL_RSL = T2.ID
        AND     T2.DT = '20240429'
        where t1.dt>='20240311'
    )t2 on t1.data_id=t2.dat_id
    group by t1.cst_id,call_dt
)A
;
-- 开户天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_05 AS
select t2.dep_act_id,t2.act_nm,t2.cst_act_id,t2.cst_id
    ,t2.opn_dt,t2.ACT_STS_CD
from SJXQ_SJ2024041511_CST_02          t1
INNER join edw.DIM_BUS_DEP_ACT_INF_DD   t2
on  t1.cst_id=t2.cst_id
and t2.dt='20240429'
and t2.ACT_CTG_CD_2 = '301'  --I类账户
-- and t2.stl_act_ind='1'       --结算账户
and t2.ACT_STS_CD <> 'C'
AND t2.ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' ) --账户状态正常
;
-- 安装金融理财app的数量
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_06 AS
select t1.cst_ID,t2.fina_app_cnt_1y
from SJXQ_SJ2024041511_CST_02              t1
inner join(
    select t2.cst_id,count(distinct t2.package_name) fina_app_cnt_1y
    from wushan_adm_papp_app_data_di        t2
    inner join edw.nout_app_class_info      t3
    on lower(trim(t2.package_name)) = lower(trim(t3.pkg_name)) -- app分类表
    and t3.dt='20240429'
    and t3.category_name = '金融理财'
    where t2.dt<='20240429'
    group by t2.cst_id
)T2 on  t1.cst_ID=t2.cst_id
;
-- 借记卡 近六个月交易次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_07 AS
SELECT T1.CST_ID
    ,count(case when t3.trx_amt>0 then t3.dtl_seq_nbr end)              trx_cnt_6m
    ,max(case when t3.crd_and_dbt_ind='C' then t3.trx_amt else 0 end)   max_in_amt_6m
FROM SJXQ_SJ2024041511_CST_02               T1
INNER JOIN EDW.DIM_BUS_DEP_ACT_INF_DD       T2  --存款账户信息
ON  T1.CST_ID=T2.CST_ID
AND T2.DT='20240429'
INNER JOIN EDW.DWD_BUS_DEP_BAL_CHG_DTL_DI   T3  --交易表
ON  T2.DEP_ACT_ID=T3.DEP_ACT_ID
AND T3.DT<='20240429'
group by T1.CST_ID
;
--近六个月手机银行登录次数、天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_08 AS
select t1.alg_userid        cst_id
    ,count(T1.dt)           login_cnt_6m
    ,count(distinct t1.dt)  login_days_6m
from edw.ebnk_mb_audit_log             T1
inner join SJXQ_SJ2024041511_CST_02    t2
on t1.alg_userid=t2.cst_id
and T1.dt<='20240429'
and T1.ALG_BSNCODE='100001'
AND T1.ALG_ERRORCODE IS NULL
and T1.ALG_SYSID ='MBC'
AND LENGTH(T1.ALG_USERID) = 10
group by T1.alg_userid
;
-- 近三个月浏览理财页面次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_09 AS
SELECT  a.distinct_id cst_id
        ,a.event
        ,a.time
        ,a.a_event_duration duration
        ,a.product_id
        ,a.product_name
        ,a.click_name
        ,a.is_success
        ,a.page_name
        ,a.dt
FROM    edw.aubs_events_ibnk            a
inner join SJXQ_SJ2024041511_CST_02    t2
on a.distinct_id=t2.cst_id
WHERE a.dt<='20240429'
AND a.event REGEXP '^financial'
AND a.event REGEXP '_pageview$'
;
--历史购买理财次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_10 AS
SELECT t1.cst_id          --cst_ID
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,t1.trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on  t1.pd_cd=t2.pd_cd
and t2.dt='20240429'
inner join SJXQ_SJ2024041511_CST_02    t3
on  t1.cst_id=t3.cst_id
WHERE t1.dt = '@@{yyyyMMdd}'
and t1.trx_dt <='20240429'
;
-- 近六个月存款日均 近六个月活期存款日均 近六个月定期存款日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_11 AS
select t1.cst_id                                       --客户编号
	,round(sum(t1.dep_bal)     /183,4)      dep_bal_avg_6m          --存款余额
	,round(sum(t1.dmnd_dep_bal)/183,4)      dmnd_dep_bal_avg_6m     --活期存款余额
	,round(sum(t1.tm_dep_bal)  /183,4)      tm_dep_bal_avg_6m       --定期存款余额
    ,count(1)               days_cnt
from adm_pub.adm_csm_cbus_dep_inf_dd  t1        --客户集市-业务信息-客户存款业务信息表
inner join SJXQ_SJ2024041511_CST_02   t2
on  t1.cst_id=t2.cst_id
where t1.dt<='20240429'
group by t1.cst_id
;
--结果字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_12 AS
SElECT t1.case_nm,t1.cst_id,T1.brc_org_nm,t1.is_convert
    ,t1.call_rslt,t1.call_status
    ,t3.cst_chn_nm,t3.gdr_nm,t3.age,t3.AGE_GRD
    ,t3.ctr_dt                                  --理财签约日期
    ,t3.fina_ctr_days
    ,t3.fina_rsk_lvl
    ,t3.pd_hld_nbr                               --产品持有数
    ,t3.is_djk_cst,t3.is_dfgz_cst,t3.dep_bal_avg_6m
    ,t4.call_dt,t4.cst_res,t4.CALL_STATUS CALL_STATUS_old
    ,t5.opn_days
    ,t6.fina_app_cnt_1y
    ,t7.trx_cnt_6m,t7.max_in_amt_6m
    ,t8.login_cnt_6m,t8.login_days_6m
    ,t9.view_fina_cnt_3m,t9.view_fina_cnt_1m,t9.view_fina_cnt_7d
    ,t10.fina_trx_cnt,t10.bf_jkq_buy_amt,t10.fina_trx_cnt_1y
    ,t10.max_trx_amt,t10.jkq_hq_fina_buy_amt,t10.jkq_dq_fina_buy_amt
    ,t11.dep_bal_avg_6m dep_bal_avg_6m2
    ,t11.dmnd_dep_bal_avg_6m,t11.tm_dep_bal_avg_6m
from SJXQ_SJ2024041511_CST_02       t1
left join SJXQ_SJ2024041511_CST_03  t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024041511_CST_04  t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join (
    select cst_id,max(opn_days) opn_days
    from SJXQ_SJ2024041511_CST_05
    GROUP by cst_id
)t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2024041511_CST_06  t6 on t1.cst_id=t6.cst_id
left join SJXQ_SJ2024041511_CST_07  t7 on t1.cst_id=t7.cst_id
left join SJXQ_SJ2024041511_CST_08  t8 on t1.cst_id=t8.cst_id
left join(
    SElECT cst_id,count(a.event)                                                                                     view_fina_cnt_3m
    from SJXQ_SJ2024041511_CST_09 a
    group by cst_id
)t9 on t1.cst_id=t9.cst_id
left join(
    SElECT cst_id,count(1) fina_trx_cnt
        ,sum(case when trx_dt<'20240311' then cfm_amt else 0 end)   bf_jkq_buy_amt
        ,max(cfm_amt) max_trx_amt
        ,sum(case when trx_dt>='20240311' and is_fix=0 then cfm_amt else 0 end)  jkq_hq_fina_buy_amt
        ,sum(case when trx_dt>='20240311' and is_fix=1 then cfm_amt else 0 end)  jkq_dq_fina_buy_amt
    from SJXQ_SJ2024041511_CST_10
    where cfm_amt>0
    group by cst_id
)t10 on t1.cst_id=t10.cst_id
left join SJXQ_SJ2024041511_CST_11 t11
on t1.cst_id=t11.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024041511_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041511_CST_13 AS
SElECT case_nm                  案例名称
    ,cst_id                     客户号
    ,cst_chn_nm                 客户名称
    ,brc_org_nm                 所属分行
    ,gdr_nm                     性别
    ,AGE_GRD                    年龄层
    ,coalesce(cst_res,call_rslt)  呼叫小结
    ,CALL_STATUS                呼叫状态
    ,is_convert                 是否成功转化
    ,opn_days                   I类卡开户天数
    ,fina_ctr_days              理财签约天数
    ,fina_rsk_lvl               理财风评
    ,pd_hld_nbr                 产品持有数
    ,is_djk_cst                 是否持有贷记卡
    ,is_dfgz_cst                是否代发工资户
    ,dep_bal_avg_6m             近六个月存款日均
    ,dmnd_dep_bal_avg_6m        近六个月活期存款日均
    ,tm_dep_bal_avg_6m          近六个月定期存款日均
    ,fina_app_cnt_1y            近1年安装金融理财app的数量
    ,trx_cnt_6m                 近六个月交易次数
    ,max_in_amt_6m              近六个月流入最高金额
    ,login_days_6m              近六个月手机银行登录天数
    ,view_fina_cnt_3m           近三个月浏览理财页面次数
    ,view_fina_cnt_1m           近一个月浏览理财页面次数
    ,view_fina_cnt_7d           近一周浏览理财页面次数
    ,case when bf_jkq_buy_amt>0 then '是' else '否' end 监测期前是否购买过理财
    ,fina_trx_cnt_1y            近一年的理财交易笔数
    ,max_trx_amt                历史理财投资单笔最大金额
    ,jkq_hq_fina_buy_amt        监测期内活期理财累计购买金额
    ,jkq_dq_fina_buy_amt        监测期内定期理财购买金额
from SJXQ_SJ2024041511_CST_12
;
SElECT '01' seq, count(1) cnt, count(distinct case_no,cst_id) custs
from SJXQ_SJ2024041511_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_08
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024041511_CST_12
union all
SElECT '13' seq, count(1) cnt, count(distinct 客户号) custs
from SJXQ_SJ2024041511_CST_13
;
/*
01	14611	11000
02	11000	11000  客群
03	11000	11000  基本信息
04	4970	4970   外呼情况
05	11292	10906  开户天数
06	2509	2509   app安装
07	9236	9236   借记卡交易
08	5119	5119   app登录
09	15763	738    理财浏览
10	2899	361    历史理财购买
11	11000	11000
12	11000	11000
13	11000	11000
*/
***SJ20240415121_台州经济开发区支行客户清单.sql
--台州经济开发区支行 客群
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_01 AS
select t1.cst_id                                --客户号|C20
	,t1.cst_chn_nm                              --客户中文名称|C200
	,t1.file_dt                                 --建档日期|C8
    ,t2.cur_year_ftp_inc	                    --当年FTP利润收入
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.SBR_ORG_NM,T4.TEM_ORG_ID,T4.TEM_ORG_NM
    ,t5.dep_bal_mon_avg	                         --存款余额月日均
    ,t6.loan_bal_acs_mon_avg    	             --贷款余额月日均
	,t7.efe_cst_ind                              --有效户标识
	,t7.efe_loan_cst_ind                         --有效信贷户标识
from edw.dim_cst_bas_inf_dd                         t1 --客户基本信息
left join adm_pub.adm_csm_cbus_ftp_inf_dd           t2 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.SBR_ORG_NM='台州经济开发区支行'
left join adm_pub.adm_csm_cbus_dep_inf_dd 		    t5 --存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_loan_inf_dd 		    t6 --贷款业务信息
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_ind_inf_dd           t7 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
--客户FTP业务
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_02 AS
select t1.cst_id                                 --客户号
        then t2.acm_ftp_inc else 0 end)  l3m_ftp_inc
	,sum(t2.acm_ftp_inc)                 l6m_ftp_inc
from LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_01               t1
inner join adm_pub.adm_csm_cbus_ftp_inf_dd  t2 --客户集市-业务信息-客户FTP业务
on t1.cst_id=t2.cst_id
and t2.dt<='@@{yyyyMMdd}'
group by t1.cst_id
;
-- 授信金额 用信余额 近3个月用信率
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_04 AS
select t1.cst_id                                 --客户编号
	,t2.crd_amt                                  --授信金额
	,t2.use_crd_bal                              --用信余额
    ,t2.dt
from LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_01   t1
inner join adm_pub.adm_csm_cbus_loan_crd_inf_dd t2 --客户集市-业务信息-贷款-授信与额度
on  t1.cst_id=t2.cst_id
and t2.crd_amt is not null
;
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_05 AS
SElECT cst_id
    ,max(case when dt='@@{yyyyMMdd}' then crd_amt else 0 end)       crd_amt
    ,max(case when dt='@@{yyyyMMdd}' then use_crd_bal else 0 end)   use_crd_bal
    ,round(sum(use_crd_bal)/count(distinct dt),2)       l3m_use_crd_bal_avg
    ,case when sum(use_crd_bal)>0 then round(sum(use_crd_bal)/count(distinct case when use_crd_bal<>0 then dt end),2)
        else 0 end                                      l3m_use_crd_bal_avg_real
from LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_04
group by cst_id
;
--最新 征信分
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_06 AS
SElECT t1.cst_id
    ,t2.digital_unscr   cst_cur_zxscore
    ,t2.dt              cur_report_dt
    ,row_number() over(partition by t1.cst_id order by t2.dt desc) rn
from LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_01           t1
inner join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di t2
on t1.cst_id=t2.cst_id
and t2.dt<='@@{yyyyMMdd}'
;
--近6个月逾期借据
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_07 AS
SElECT t2.dbil_srl_no                            --借据流水号
	,t2.dbil_amt                                 --借据金额
	,t2.cny_dbil_bal                             --借据余额(折人民币)
	,t2.nrm_prcp                                 --正常本金
	,t2.ovd_prcp                                 --逾期本金
	,t2.ovd_intr                                 --逾期利息
	,t2.dbil_grant_date                          --借据发放日期
	,t2.dbil_actl_stlm_date                      --借据实际结清日期
	,t2.cst_id                                   --客户编号
	,t2.cst_nm                                   --客户名称
	,t2.prcp_ovd_date                            --本金逾期日期
	,t2.intr_ovd_date                            --利息逾期日期
	,t2.is_ovd                                   --是否逾期
	,t2.crrt_ovd_day                             --当前逾期天数
from LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_01       t1
inner join adm_rsk.adm_rsk_ast_loan_dbil_inf_dd	    t2 --风险集市信贷业务借据信息表
ON  t1.cst_id=t2.cst_id
AND t2.dt ='@@{yyyyMMdd}'
;
--近6个月利息逾期天数、金额
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_08 AS
SElECT t1.cst_id,t1.dbil_srl_no
    ,t2.crrt_ovd_day,t2.lx_ovd_days,t2.ovd_intr,t2.dt
from LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_07 t1
left join (
    SElECT dbil_srl_no
        ,crrt_ovd_day                             --当前逾期天数
        ,ovd_intr,dt
        ,DATEDIFF(TO_DATE(dt, 'yyyyMMdd'), TO_DATE(intr_ovd_date, 'yyyyMMdd'), 'dd')+1  lx_ovd_days
        ,row_number() over(partition by dbil_srl_no order by dt desc) rn
    from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd
    and is_ovd='1'  --逾期借据
)t2 on t1.dbil_srl_no=t2.dbil_srl_no
and t2.rn = 1
where t1.is_l6m_lx_ovd=1    --近6月利息逾期
;
--字段汇总
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_09 AS
select t1.cst_id                                --客户号|C20
	,t1.cst_chn_nm                              --客户中文名称|C200
    ,round(t1.cur_year_ftp_inc,2)   cur_year_ftp_inc --当年FTP利润收入
    ,round(t1.ftp_budget,2)         ftp_budget
    ,T1.PRM_MGR_ID ,T1.PRM_MGR_NM ,T1.PRM_ORG_ID
    ,T1.SBR_ORG_NM ,T1.TEM_ORG_ID ,T1.TEM_ORG_NM
    ,t1.dep_bal_mon_avg	                         --存款余额月日均
    ,round(t1.loan_bal_acs_mon_avg,2) loan_bal_acs_mon_avg --贷款余额月日均
	,t1.efe_cst_ind                              --有效户标识
	,t1.efe_loan_cst_ind                         --有效信贷户标识
    ,round(t2.l3m_ftp_inc,2)    l3m_ftp_inc
    ,round(t2.l6m_ftp_inc,2)    l6m_ftp_inc
    ,t5.crd_amt,t5.use_crd_bal
    ,t5.l3m_use_crd_bal_avg,t5.l3m_use_crd_bal_avg_real
    ,case when t5.crd_amt<>0 then round(t5.l3m_use_crd_bal_avg/t5.crd_amt,4)
        else 0 end      use_crd_ratio
    ,case when t5.crd_amt<>0 then round(t5.l3m_use_crd_bal_avg_real/t5.crd_amt,4)
        else 0 end      use_crd_ratio_real
    ,t6.cst_cur_zxscore,t6.cur_report_dt
    ,case when t7.is_l6m_bj_ovd>0 then '是' else '否' end is_l6m_bj_ovd
    ,case when t7.is_l6m_lx_ovd>0 then '是' else '否' end is_l6m_lx_ovd
    ,t8.l6m_lx_ovd_days ,t8.l6m_lx_ovd_amt
from SJXQ_SJ2024041571_CST_01       t1
left join SJXQ_SJ2024041571_CST_02  t2 on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024041571_CST_05  t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2024041571_CST_06  t6 on t1.cst_id=t6.cst_id and t6.rn=1
left join(
    SElECT cst_id
        ,sum(is_l6m_bj_ovd) is_l6m_bj_ovd
        ,sum(is_l6m_lx_ovd) is_l6m_lx_ovd
    from SJXQ_SJ2024041571_CST_07
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
left join(
    SElECT cst_id
        ,sum(crrt_ovd_day)  l6m_lx_ovd_days
        ,sum(ovd_intr)      l6m_lx_ovd_amt
    from SJXQ_SJ2024041571_CST_08
    group by cst_id
)t8 on t1.cst_id=t8.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ2024041571_CST_10 AS
select cst_id 						客户号
	,cst_chn_nm                     客户名称
    ,SBR_ORG_NM                     主管户支行
    ,TEM_ORG_ID                     主管户团队ID
    ,TEM_ORG_NM                     主管户团队
    ,l3m_ftp_inc                    近3个月FTP累计利润收入
    ,l6m_ftp_inc                    近6个月FTP累计利润收入
    ,round(cur_year_ftp_inc,2)      当年FTP累计利润收入
    ,ftp_budget                     当年FTP反算值
    ,dep_bal_mon_avg                存款余额月日均
    ,loan_bal_acs_mon_avg           贷款余额月日均
	,efe_cst_ind                    有效户标识
	,efe_loan_cst_ind               有效信贷户标识
    ,crd_amt                        授信金额
    ,use_crd_bal                    用信余额
    ,use_crd_ratio                  近3个月用信率
    ,use_crd_ratio_real             放贷后用信率
    ,cst_cur_zxscore                最近一次征信分
    ,cur_report_dt                  最近一次征信查询时间
    ,is_l6m_bj_ovd                  近6个月是否存在本金逾期
    ,is_l6m_lx_ovd                  近6个月是否存在利息逾期
    ,l6m_lx_ovd_days                近6个月利息逾期天数累计
    ,l6m_lx_ovd_amt                 近6个月利息逾期金额累计
from SJXQ_SJ2024041571_CST_09
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_02
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ2024041571_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024041571_CST_09
;
/*
01	131273	131273
02	131261	131261
04	419285	4711
05	4711	4711
06	16537	16537
07	422799	422799
08	403	80
09	131273	131273
*/
***SJ2024041571_宁波分行账户排查.sql
-- 宁波分行 近几个月以 20240331为限，其余字段 取数日期
--非柜面限额
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_01 AS
SELECT cengcgjz     cst_act_id
    ,edsxriqi	    fg_efe_dt   --额度生效日期
    ,danciedu       fg_per_lmt  --单笔限额
    ,leijiedu       fg_day_lmt  --累计限额
    ,row_number() over(partition by cengcgjz order by edsxriqi desc) as rn
FROM    edw.core_kdpa_zheddy    -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE'   -- 非柜面限额
AND     edkzzhqi = '1D'         -- 日限额
;
--最近一次调整非柜额度的日期和渠道
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_02 AS
select accp_dt                                --受理日期
	,acct_no        cst_act_id                --客户账号
	,client_name                              --账户名称
	,channel_code
    ,row_number() over(partition by ACCT_NO order by ACCP_DT desc)  as rn
from edw.qdrh_aecip_rmc_modifylimitflow       --非柜面限额维护登记表
where dt<='@@{yyyyMMdd}'
and   MAINTAIN_TYPE='1' --维护类型:0-快捷支付开关；1-限额维护
;
--账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_03 AS
select t1.cst_act_id                             --客户账号|C32
	,t1.cst_act_nm                               --客户账户名称|C200
	,t1.act_sts_cd                               --账户状态代码|C1
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_org_id                               --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
    ,t2.dq_dep_bal
    ,t4.ORG_NM
from edw.dim_bus_dep_cst_act_inf_dd      t1 --客户存款账户信息
left join (
    select cst_act_id                              --客户账号|C32
        ,sum(cur_act_bal)               dq_dep_bal --0:活期 1:定期
    FROM    EDW.DWS_BUS_DEP_ACT_INF_DD		    t1 --存款账户信息表
    WHERE   t1.DT='@@{yyyyMMdd}'
    AND     t1.ACT_STS_CD <> 'C'        --存款账户状态代码
    and     t1.lbl_prod_typ_cd<>'0'     --0:活期 1:定期
    group by cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
inner join edw.dim_cst_idv_bas_inf_dd     t3 --个人客户基本信息
on t1.cst_id=t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
on  t1.opn_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm='宁波分行'
inner join (
    select  distinct cst_act_id                              --客户账号|C32
    FROM    EDW.DWS_BUS_DEP_ACT_INF_DD              t1 --存款账户信息表
    WHERE   t1.DT='@@{yyyyMMdd}'
    AND     t1.stl_act_ind='1'          --结算账户
    AND     T1.BAL_GL_IND <> '0'        -- 剔除虚户
    AND     T1.CST_ID <> '2000394435'   -- 剔除验资户，该客户是验资户专户
)t5 on t1.cst_act_id=t5.cst_act_id
where t1.dt='@@{yyyyMMdd}'
and t1.act_sts_cd<> 'C'       --'C','销户'
;
--动账
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_04 AS
select cst_act_id
    ,count(dep_act_id)                                          l6m_dz_cnt
    ,count(case when trx_dt>='20240101' then dep_act_id end)    l3m_dz_cnt
from edw.dwd_bus_dep_bal_chg_dtl_di      	--存款账户余额发生明细
where dt between '20231001' and '20240331'
and trx_dt>='20231001'
and CONCAT(smr_dscr, cmt) not regexp '利息|付息|贴息|结息|入息|取息'  --剔除付息
GROUP by cst_act_id
;
--近6月交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_05 AS
select cst_act_id
    ,sum(trx_cnt)   l6m_trx_cnt
    ,sum(trx_amt)   l6m_trx_amt
    ,max(trx_amt)   l6m_max_trx_amt
from(
    select cst_act_id,trx_dt
        ,count(1)               trx_cnt
        ,sum(trx_amt)           trx_amt
    from edw.dwd_bus_dep_bal_chg_dtl_di      	--存款账户余额发生明细 2023数据量 1040770 dep_act_id,dtl_seq_nbr 唯一
    where dt between '20231001' and '20240331'
    and trx_dt>='20231001'
    and crd_and_dbt_ind='D'     --'D'支取 D借 C贷
    GROUP by cst_act_id,trx_dt
)a group by cst_act_id
;
-- 是否持有贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_06 AS
select   PAYBACKACCOUNT as  cst_act_id
        ,SUM(balance)   as  balance_sum     --当前贷款余额
from   edw.loan_business_duebill
where dt='@@{yyyyMMdd}'
and    duebillstatus='0' --贷款帐户状态 0 正常 1 销户 2 已核销 3 准销户 4 录入 5 已减免
GROUP BY PAYBACKACCOUNT
;
-- 是否持有理财
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_07 AS
select   bnk_act_id   as  cst_act_id
        ,sum(fnc_amt) as  fnc_amt_sum --部分理财余额
from  edw.dws_bus_chm_act_acm_inf_dd
where DT = '@@{yyyyMMdd}'
group by bnk_act_id
having  sum(fnc_amt)>0
;
-- 是否持有保险
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_08 AS
select trx_zhng_id          as  cst_act_id
    ,sum(insu_fee)          as  insure_fee_sum --当前保费金额
from edw.dwd_bus_insu_plcy_insu_inf_dd t1
WHERE t1.dt='@@{yyyyMMdd}'
GROUP BY  trx_zhng_id
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_09 AS
SElECT t1.cst_act_id
    ,t1.cst_act_nm
    ,t1.opn_dt
    ,t1.ORG_NM
    ,case when t1.dq_dep_bal>=10000 then '是' else '否' end is_dq_more_1w
    ,t2.fg_efe_dt   --额度生效日期
    ,t2.fg_day_lmt  --累计限额
    ,t3.accp_dt
    ,case when t4.l6m_dz_cnt>0 then '是' else '否' end is_l6m_dz
    ,case when t4.l3m_dz_cnt>0 then '是' else '否' end is_l3m_dz
    ,t5.l6m_trx_cnt,t5.l6m_trx_amt,t5.l6m_max_trx_amt
    ,case when t6.cst_act_id is not null then '是' else '否' end is_loan_cst
    ,case when t7.cst_act_id is not null then '是' else '否' end is_fina_cst
    ,case when t8.cst_act_id is not null then '是' else '否' end is_insu_cst
    ,case when t9.cst_id     is not null then '是' else '否' end is_fund_cst
from SJXQ_SJ2024041571_CST_03       t1
left join SJXQ_SJ2024041571_CST_01  t2 on t1.cst_act_id=t2.cst_act_id and t2.rn=1
left join SJXQ_SJ2024041571_CST_02  t3 on t1.cst_act_id=t3.cst_act_id and t3.rn=1
left join SJXQ_SJ2024041571_CST_04  t4 on t1.cst_act_id=t4.cst_act_id
left join SJXQ_SJ2024041571_CST_05  t5 on t1.cst_act_id=t5.cst_act_id
left join SJXQ_SJ2024041571_CST_06  t6 on t1.cst_act_id=t6.cst_act_id
left join SJXQ_SJ2024041571_CST_07  t7 on t1.cst_act_id=t7.cst_act_id
left join SJXQ_SJ2024041571_CST_08  t8 on t1.cst_act_id=t8.cst_act_id
left join adm_pub.adm_csm_cbus_fnd_bal_inf_dd t9 --客户集市-业务信息-财富-基金-业务信息
on t1.cst_id=t9.cst_id and t9.dt='@@{yyyyMMdd}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024041571_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024041571_CST_10 AS
SElECT cst_act_id				客户账号
    ,cst_act_nm                 客户名称
    ,opn_dt                     开户时间
    ,ORG_NM                     开户机构
    ,fg_day_lmt                 非柜面日累计限额
    ,fg_efe_dt                  最近一次非柜面限额生效日期
    ,accp_dt                    最近一次非柜面限额受理日期
    ,is_l6m_dz                  近6个月是否有动账_不含付息
    ,is_l3m_dz                  近3个月是否有动账_不含付息
    ,l6m_trx_cnt                近6个月借方累计交易笔数
    ,l6m_trx_amt                近6个月借方累计交易金额
    ,l6m_max_trx_amt            近6个月最大日累计支出金额
    ,is_dq_more_1w              名下是否有定期大于等于1万
    ,is_loan_cst                是否持有贷款
    ,is_fina_cst                是否持有理财
    ,is_insu_cst                是否持有保险
    ,is_fund_cst                是否持有基金
from SJXQ_SJ2024041571_CST_09
;
SElECT '01' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_06
union all
SElECT '07' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_07
union all
SElECT '08' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_08
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024041571_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct 客户账号) custs
from SJXQ_SJ2024041571_CST_10
;
/*
01	3887624	3887624
02	2440602	2440602
03	622320	622320
04	4410769	4410769
05	3480358	3480358
06	455112	455112
07	205074	205074
08	44895	44895
09	622320	622320
10	622320	622320
问题：
1. 保险状态 是否正确
2. 基金余额是否需要非0
*/***SJ2024042101_基金实盘大赛.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_01 AS
SElECT col_1     cst_id
    ,col_2       cst_nm
    ,col_3       wlth_mng_id
    ,col_4       wlth_mng_nm
    ,col_5       wlth_tem_org
    ,col_6       wlth_sbr_org
    ,col_7       wlth_brc_org
    ,col_8       is_empe
    ,col_9       is_bm
FROM qbi_file_20240423_15_18_43
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_02 AS
SElECT t1.cst_id
    ,t2.prod_cd,t2.trx_act_id
    ,t2.tot_lot,t2.tot_cost,t2.TOT_AMT
    ,t2.acm_ern_amt	    --累计总收益|decimal(16,2)
    ,t2.nav_dt	        --净值日期|c8
    ,t2.unt_nav	        --单位净值|decimal(10,7)
    ,t2.pos_cost_prc	--持仓成本价|decimal(10,7)
    ,t2.pos_pft_los	    --持仓盈亏|decimal(16,2)
    ,t2.pos_yld	        --持仓收益率|decimal(10,7)
FROM SJXQ_SJ2024042101_CST_01                       t1
inner join edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd   t2 --基金账户份额信息
on  t1.cst_id=t2.cst_id
and t2.tot_lot<>0       -- 持仓
and t2.dt='20240331'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_03 AS
SElECT t1.cst_id,t1.prod_cd,t3.pd_nm
    ,t1.tot_lot
    ,t1.tot_cost
    ,t1.TOT_AMT
    ,t1.acm_ern_amt
    ,t1.pos_cost_prc
    ,t1.pos_pft_los
    ,t1.pos_yld
    ,case when t4.cst_id is not null then 1 else 0 end is_his_aip
from(
    SElECT cst_id,prod_cd
        ,sum(tot_lot)                   tot_lot
        ,sum(tot_cost)                  tot_cost
        ,sum(TOT_AMT)                   TOT_AMT
        ,sum(acm_ern_amt)	            acm_ern_amt     --累计总收益|decimal(16,2)
        ,case when sum(tot_lot)<>0 then sum(tot_cost)/sum(tot_lot)
            else sum(tot_cost) end      pos_cost_prc    --持仓成本价
        ,sum(pos_pft_los)               pos_pft_los	    --持仓盈亏|decimal(16,2)
        ,case when sum(tot_cost)<>0 then sum(pos_pft_los)/sum(tot_cost)
            else sum(pos_pft_los) end   pos_yld	        --持仓收益率
    from SJXQ_SJ2024042101_CST_02
    group by cst_id,prod_cd
)t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd            t3 --dt不更新当日净值
on  t1.prod_cd = t3.pd_cd
and t3.dt = '20240331'
and t3.fnd_typ_cd<>'04'     --非货
left join (
    -- 是否有过定投协议
    SELECT cst_id,pd_cd
        ,agr_sts_cd
        ,decode(agr_sts_cd,'0','正常','1','暂停','2','客户终止','3','异常终止','4','到期终止','') agr_sts_nm
        ,dt     agr_sts_final_updt
        ,row_number() over(partition by cst_id,pd_cd order by dt desc)rn
    FROM EDW.DIM_BUS_CHM_FND_AIP_AGR_INF_DD
    WHERE DT <= '20240331'
)t4 on t1.cst_ID=t4.cst_id
and t1.prod_cd=t4.pd_cd
and t4.rn=1
;
-- 连续持仓天数 日均持有份额 日均持有市值
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_04 AS
SElECT *
    ,sum(is_hld) over(partition by cst_id,prod_cd order by dt desc) continue_days
from(
    SElECT t1.dt,t1.cst_id,t1.prod_cd
        ,sum(t1.tot_lot)                   tot_lot
        ,sum(t1.TOT_AMT)                   TOT_AMT
        ,case when sum(t1.TOT_AMT)<>0 then 1 else 0 end is_hld
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd t1 --基金账户份额信息
    inner join SJXQ_SJ2024042101_CST_03         t2
    on t1.cst_id=t2.cst_id
    and t1.prod_cd=t2.prod_cd
    where t1.dt<='20240331'
    group by t1.dt,t1.cst_id,t1.prod_cd
)t1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_05 AS
SElECT t1.cst_id,t1.prod_cd,t1.continue_days
    ,sum(t2.tot_lot)        tot_lot
    ,sum(t2.TOT_AMT)        TOT_AMT
from(
    --中间有清仓的
    SELECT cst_id,prod_cd,continue_days
        ,ROW_NUMBER() over(partition by cst_id,prod_cd order by continue_days)rn
    from SJXQ_SJ2024042101_CST_04
    GROUP BY cst_id,prod_cd,continue_days
    having count(1)>1
    union all --一直持仓客户
    SElECT cst_id,prod_cd,sum(is_hld) continue_days,1
    from SJXQ_SJ2024042101_CST_04
    GROUP BY cst_id,prod_cd
    having count(1)=max(continue_days)
)t1 left join SJXQ_SJ2024042101_CST_04 t2
on t1.cst_id=t2.cst_id
and t1.prod_cd=t2.prod_cd
and t2.continue_days<=t1.continue_days
where t1.rn=1
GROUP by t1.cst_id,t1.prod_cd,t1.continue_days
;
--2.29持仓市值	2.29持仓收益率
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_06 AS
SElECT t1.dt,t1.cst_id,t1.prod_cd
    ,sum(t1.TOT_AMT)                   TOT_AMT
    ,case when sum(t1.tot_cost)<>0 then round(sum(t1.pos_pft_los)/sum(t1.tot_cost),6)
        else sum(t1.pos_pft_los) end   pos_yld	        --持仓收益率
from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd t1 --基金账户份额信息
inner join SJXQ_SJ2024042101_CST_03         t2
on t1.cst_id=t2.cst_id
and t1.prod_cd=t2.prod_cd
group by t1.dt,t1.cst_id,t1.prod_cd
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_07 AS
SElECT t1.cst_id 			客户号
    ,t1.cst_nm              客户姓名
    ,t1.wlth_mng_id         财富管户人工号
    ,t1.wlth_mng_nm         财富管户人姓名
    ,t1.wlth_tem_org        财富管户人所属团队
    ,t1.wlth_sbr_org        财富管户人所属支行
    ,t1.wlth_brc_org        财富管户人所属分行
    ,t1.is_empe             是否行内员工
    ,t1.is_bm               是否报名
    ,t2.prod_cd 			持仓产品代码
    ,t2.pd_nm               持仓产品名称
    ,t2.tot_lot             持仓份额_0331
    ,t2.TOT_AMT             持仓市值_0331
    ,t2.tot_cost            持仓成本
    ,t2.pos_cost_prc        持仓成本单价
    ,t2.pos_pft_los         持仓盈亏
    ,t2.pos_yld             持仓收益率_0331
    ,t2.acm_ern_amt         累计收益
    ,t2.is_his_aip          是否有过定投协议
    ,t3.continue_days 		连续持仓天数
    ,round(t3.tot_lot/t3.continue_days,4) 	日均持有份额
    ,round(t3.TOT_AMT/t3.continue_days,4)   日均持有市值
    ,t3.TOT_AMT/t3.continue_days/(sum(t3.TOT_AMT/t3.continue_days) over(partition by t1.cst_id)) 同一客户各持仓非货基金份额占比
    ,t4.TOT_AMT 			持仓市值_0229
    ,t4.pos_yld             持仓收益率_0229
    ,t5.TOT_AMT             持仓市值_0131
    ,t5.pos_yld             持仓收益率_0131
    ,t6.TOT_AMT             持仓市值_1231
    ,t6.pos_yld             持仓收益率_1231
    ,t7.TOT_AMT             持仓市值_1130
    ,t7.pos_yld             持仓收益率_1130
    ,t8.TOT_AMT             持仓市值_1031
    ,t8.pos_yld             持仓收益率_1031
FROM SJXQ_SJ2024042101_CST_01       T1
LEFT JOIN SJXQ_SJ2024042101_CST_03  T2 ON  T1.CST_ID=T2.CST_ID
LEFT JOIN SJXQ_SJ2024042101_CST_05  T3 ON  T1.CST_ID=T3.CST_ID AND T2.PROD_CD=T3.PROD_CD
LEFT JOIN SJXQ_SJ2024042101_CST_06  T4 ON  T1.CST_ID=T4.CST_ID AND T2.PROD_CD=T4.PROD_CD AND T4.DT='20240229'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T5 ON  T1.CST_ID=T5.CST_ID AND T2.PROD_CD=T5.PROD_CD AND T5.DT='20240131'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T6 ON  T1.CST_ID=T6.CST_ID AND T2.PROD_CD=T6.PROD_CD AND T6.DT='20231231'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T7 ON  T1.CST_ID=T7.CST_ID AND T2.PROD_CD=T7.PROD_CD AND T7.DT='20231130'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T8 ON  T1.CST_ID=T8.CST_ID AND T2.PROD_CD=T8.PROD_CD AND T8.DT='20231031'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,prod_cd) custs
from SJXQ_SJ2024042101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,prod_cd) custs
from SJXQ_SJ2024042101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,prod_cd) custs
from SJXQ_SJ2024042101_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,prod_cd) custs
from SJXQ_SJ2024042101_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct dt,cst_id,prod_cd) custs
from SJXQ_SJ2024042101_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号,持仓产品代码) custs
from SJXQ_SJ2024042101_CST_07
;
/*
01	7138	7138
02	12830	12716
03	12051	12051
04	3842259	12051
05	12051	12051
06	56709	56709
07	12051	12051
*/
-----------------------------------------------------以下为个人分析部分----------------------------------------------
-- 宽表
DROP   TABLE IF     EXISTS SJXQ_SJ2024042101_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042101_CST_08 AS
SElECT t1.cst_id
    ,t1.cst_nm
    ,t1.wlth_mng_id
    ,t1.wlth_mng_nm
    ,t1.wlth_tem_org
    ,t1.wlth_sbr_org
    ,t1.wlth_brc_org
    ,t1.is_empe
    ,t1.is_bm
    ,t2.prod_cd
    ,t2.pd_nm
    ,t2.tot_lot             tot_lot_0331
    ,t2.TOT_AMT             TOT_AMT_0331
    ,t2.tot_cost
    ,case when t2.tot_cost>1   and t2.tot_cost<=1000    then '0 (1,1000]'
        when t2.tot_cost>1000  and t2.tot_cost<=5000    then '1 (1000,5000]'
        when t2.tot_cost>5000  and t2.tot_cost<=10000   then '2 (5000,10000]'
        when t2.tot_cost>10000 and t2.tot_cost<=50000   then '3 (10000,50000]'
        when t2.tot_cost>50000 and t2.tot_cost<=300000  then '4 (50000,300000]'
        when t2.tot_cost>300000 then '5 (300000,+inf]' else '' end tot_cost_lvl
    ,t2.pos_cost_prc
    ,t2.pos_pft_los
    ,t2.pos_yld             pos_yld_0331
    ,case when t2.pos_yld<=-0.3 then '0 (-inf,-30%]'
        when t2.pos_yld>-0.3 and t2.pos_yld<=-0.2 then '1 (-30%,-20%]'
        when t2.pos_yld>-0.2 and t2.pos_yld<=-0.1 then '2 (-20%,-10%]'
        when t2.pos_yld>-0.1 and t2.pos_yld<=0    then '3 (-10%,0]'
        when t2.pos_yld>0    and t2.pos_yld<=0.1  then '4 (0,10%]'
        when t2.pos_yld>0.1  and t2.pos_yld<=0.2  then '5 (10%,20%]'
        when t2.pos_yld>0.2  and t2.pos_yld<=0.3  then '6 (20%,30%]'
        when t2.pos_yld>0.3 then '7 (-30%,+inf]' else '' end pos_yld_lvl
    ,t2.acm_ern_amt
    ,t2.is_his_aip
    ,t3.continue_days
    ,round(t3.tot_lot/t3.continue_days,4)   day_avg_lot
    ,round(t3.TOT_AMT/t3.continue_days,4)   day_avg_amt
    ,t3.TOT_AMT/t3.continue_days/(sum(t3.TOT_AMT/t3.continue_days) over(partition by t1.cst_id)) cst_hld_ratio
    ,t4.TOT_AMT 			TOT_AMT_0229
    ,t4.pos_yld             pos_yld_0229
    ,t5.TOT_AMT             TOT_AMT_0131
    ,t5.pos_yld             pos_yld_0131
    ,t6.TOT_AMT             TOT_AMT_1231
    ,t6.pos_yld             pos_yld_1231
    ,t7.TOT_AMT             TOT_AMT_1130
    ,t7.pos_yld             pos_yld_1130
    ,t8.TOT_AMT             TOT_AMT_1031
    ,t8.pos_yld             pos_yld_1031
FROM SJXQ_SJ2024042101_CST_01       T1
LEFT JOIN SJXQ_SJ2024042101_CST_03  T2 ON  T1.CST_ID=T2.CST_ID
LEFT JOIN SJXQ_SJ2024042101_CST_05  T3 ON  T1.CST_ID=T3.CST_ID AND T2.PROD_CD=T3.PROD_CD
LEFT JOIN SJXQ_SJ2024042101_CST_06  T4 ON  T1.CST_ID=T4.CST_ID AND T2.PROD_CD=T4.PROD_CD AND T4.DT='20240229'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T5 ON  T1.CST_ID=T5.CST_ID AND T2.PROD_CD=T5.PROD_CD AND T5.DT='20240131'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T6 ON  T1.CST_ID=T6.CST_ID AND T2.PROD_CD=T6.PROD_CD AND T6.DT='20231231'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T7 ON  T1.CST_ID=T7.CST_ID AND T2.PROD_CD=T7.PROD_CD AND T7.DT='20231130'
LEFT JOIN SJXQ_SJ2024042101_CST_06  T8 ON  T1.CST_ID=T8.CST_ID AND T2.PROD_CD=T8.PROD_CD AND T8.DT='20231031'
;
SELECT prod_cd,pd_nm,pos_yld_lvl,count(1) cnt
from SJXQ_SJ2024042101_CST_08
where tot_cost_lvl<>''  --剔除异常数据
GROUP BY prod_cd,pd_nm,pos_yld_lvl
order by prod_cd,pos_yld_lvl
***SJ20240422111_宁波分行黑MAC账号排查.sql
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_01 AS
SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn                   --止付原因
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
    ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c2
on t1.frz_cls_cd = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt='@@{yyyyMMdd}'
WHERE   t1.DT = '@@{yyyyMMdd}'
AND     t1.FRZ_SRC_CD='2'   --止付
AND     t1.NFRZ_IND = '0'   --解冻标志
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_02 AS
SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
    ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.FRZ_SRC_CD='1'  --冻结
AND     T1.NFRZ_IND = '0'
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_03 AS
SELECT  cst_act_id,lmt_cmt close_fg_rsn
        ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '@@{yyyyMMdd}'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_04 AS
SELECT  cengcgjz    cst_act_id
    ,danciedu       fg_per_lmt
    ,leijiedu       fg_day_lmt
    ,row_number() over(partition by cengcgjz order by edsxriqi desc) as rn
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '@@{yyyyMMdd}'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
;
--涉诈可疑黑mac 2259 20210315 20200630
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_05 AS
SElECT mac_id,act_num,case_num,start_dt,end_dt
FROM qbi_file_20240423_10_20_24
;
--mac明细
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_06 AS
select  a.客户账号,日期,地区,replace(mac,'-','') mac,ip
    ,usr_sbm_tm,trx_amt
from (
        -- IP/MAC
        select
            pmt_act_id 客户账号,
            dt 日期,
            if(cnr_nm='中国',concat(pvc_nm,' ',cty_nm),cnr_nm) as 地区,
            case
            when cst_end_ip regexp '@' then split_part(cst_end_ip,'@',1)
            when cst_end_ip regexp ':' and cst_end_ip not regexp '^\\d{1,3}\\.|^\\w{4}:' or cst_end_ip regexp '^null:' then split_part(cst_end_ip,':',1)
            when cst_end_ip NOT regexp '^\\d{1,3}\\.|^\\w{4}:' then cst_end_ip
            end as mac,
            case
            when cst_end_ip regexp '@' then split_part(cst_end_ip,'@',2,100)
            when cst_end_ip regexp ':' and cst_end_ip not regexp '^\\d{1,3}\\.|^\\w{4}:' or cst_end_ip regexp '^null:' then split_part(cst_end_ip,':',2,100)
            when cst_end_ip regexp '^\\d{1,3}\\.|^\\w{4}:' then cst_end_ip
            end as ip
            ,usr_sbm_tm	        --用户提交时间|C14
            ,trx_amt	    --交易金额|DECIMAL(18,2)
        from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di --个人网银各渠道汇总流水信息
        -- from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di -- 企业网银各渠道汇总流水信息
        where dt>='20200630'
        -- and dt<='20230327'
        union all
        select
            pmt_act_id   客户账号,
            dt 日期,
            if(cnr_nm='中国',concat(pvc_nm,' ',cty_nm),cnr_nm) as 地区,
            case
            when cst_end_ip regexp '@' then split_part(cst_end_ip,'@',1)
            when cst_end_ip regexp ':' and cst_end_ip not regexp '^\\d{1,3}\\.|^\\w{4}:' or cst_end_ip regexp '^null:' then split_part(cst_end_ip,':',1)
            when cst_end_ip NOT regexp '^\\d{1,3}\\.|^\\w{4}:' then cst_end_ip
            end as mac,
            case
            when cst_end_ip regexp '@' then split_part(cst_end_ip,'@',2,100)
            when cst_end_ip regexp ':' and cst_end_ip not regexp '^\\d{1,3}\\.|^\\w{4}:' or cst_end_ip regexp '^null:' then split_part(cst_end_ip,':',2,100)
            when cst_end_ip regexp '^\\d{1,3}\\.|^\\w{4}:' then cst_end_ip
            end as ip
            ,usr_sbm_tm	        --用户提交时间|C14
            ,trx_amt	    --交易金额|DECIMAL(18,2)
        -- from edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di --个人网银各渠道汇总流水信息
        from edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di -- 企业网银各渠道汇总流水信息
        where dt>='20200630'
        -- and dt<='20230327'
)a
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_06_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_06_1 AS
SElECT a.客户账号,b.mac_id
    ,sum(a.trx_amt)                             trx_amt_tot
from SJXQ_SJ20240422111_CST_06          A
inner join SJXQ_SJ20240422111_CST_05    b
on lower(a.mac)=lower(b.mac_id)
group by a.客户账号,b.mac_id
;
--宁波分行 客户账号
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_07 AS
select t1.cst_act_id                             --客户账号|C32
	,t1.act_sts_cd                               --账户状态代码|C1
    ,decode(t1.act_sts_cd,'A','正常','B','不动户','D','久悬户','E','封闭冻结','F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts_nm
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_org_id                               --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
    ,t3.mgr_id	    --管护人编号|C200
    ,t4.empe_nm     mgr_nm
    ,decode(t5.cst_typ_cd,'1','对私','2','对公') cst_typ_nm	--客户类型|C1
from edw.dim_bus_dep_cst_act_inf_dd             t1 --客户存款账户信息
inner join edw.dim_hr_org_mng_org_tree_dd       t2 --考核机构树
on  t1.opn_org_id=t2.org_id
and t2.dt='@@{yyyyMMdd}'
and t2.BRC_ORG_NM='宁波分行'
left join edw.dwd_bus_dep_cst_act_mgr_inf_dd    t3 --客户存款账户管护信息
on t1.cst_act_id=t3.cst_act_id
and t3.dt='@@{yyyyMMdd}'
and t3.mgr_rto=1                --不考虑多人管户情况
left join edw.dws_hr_empe_inf_dd                t4 --员工信息汇总
on  t3.mgr_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd	            t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.act_sts_cd<>'C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_08 AS
select t1.cst_act_id                               --客户账号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.act_afl_org                              --核算机构编号|C12
	,t1.opn_org                                  --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
	,t1.prod_id                                  --存款产品代码|C24
	,t1.cst_tp                                   --所属客户类型代码|C1
	,t1.lbl_prod_typ_cd                          --存款产品类型代码|C1
    ,decode(t1.lbl_prod_typ_cd,'0','活期','1','定期') lbl_prod_typ_nm
	,t1.dep_cls_cd                               --存款种类|C4
    ,c1.cd_val_dscr     dep_cls_nm
	,t1.act_sts_cd                               --存款账户状态代码|C1
	,t1.stl_act_ind                              --结算账户标志|C1
	,t1.act_ctg_cd_1                             --账户分类代码1|C32
    ,c2.cd_val_dscr     act_ctg_nm_1
    ,t1.act_ctg_cd_2                             --账户分类代码2|C32
    ,c3.cd_val_dscr     act_ctg_nm_2
    ,t2.pd_cmt                                   --产品说明|c200
from edw.dws_bus_dep_act_inf_dd         t1 --存款账户信息汇总
left join edw.dim_bus_dep_pd_bas_inf_dd t2 --存款产品基础信息表
on t1.prod_id=t2.pd_id
and t2.dt='@@{yyyyMMdd}'
-- inner join edw.dim_hr_org_mng_org_tree_dd t3 --考核机构树
-- on  t1.opn_org=t3.org_id
-- and t3.dt='@@{yyyyMMdd}'
-- and t3.BRC_ORG_NM='宁波分行'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON t1.dep_cls_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C2
ON t1.act_ctg_cd_1 = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C3
ON t1.act_ctg_cd_2 = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.ACT_STS_CD <> 'C'
and t1.STL_ACT_IND = '1' --非销户且为结算账户
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240422111_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240422111_CST_09 AS
select t1.cst_act_id            客户账号
    ,t1.opn_dt                  开户日期
    ,t1.opn_org_id              开户机构号
    ,t1.mgr_id                  管护客户经理工号
    ,t1.mgr_nm                  管护客户经理姓名
    ,t1.cst_id                  客户号
    ,t3.pd_cmt                  产品说明
    ,t3.act_ctg_nm_1            对公账户分类
    ,t3.act_ctg_nm_2            对私账户分类
    ,t1.act_sts_nm              账户分类
    ,t1.cst_typ_nm              客户类型
    ,t3.lbl_prod_typ_nm         存款产品类型
    ,t3.dep_cls_nm              存款种类
    ,t2.mac_id                  命中的黑MAC地址
    ,t2.trx_dt_seg              命中黑MAC地址时的交易日期
    ,t2.trx_amt_seg             命中黑MAC地址时的交易金额
    ,t2.trx_amt_tot             命中黑MAC地址时交易总金额
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END               AS 是否止付
    ,T5.frz_dt                      AS 止付日期
    ,T5.act_stop_pmt_typ_cd         AS 止付类型代码
    ,T5.act_stop_pmt_typ            AS 止付类型
    ,T5.frz_cls_cd                  AS 止付种类代码
    ,T5.frz_cls                     AS 止付种类
    ,T5.frz_rsn                     AS 止付原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                AS 是否冻结
    ,T6.frz_dt                       AS 冻结日期
    ,T6.frz_cls                      AS 冻结种类
    ,T6.frz_rsn                      AS 冻结原因
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'
        ELSE '否' END                   AS 是否关闭非柜面
    ,T7.close_fg_rsn                    AS 关闭原因
    ,CASE WHEN T8.cst_act_id IS NULL     THEN '否'
           WHEN T8.cst_act_id IS NOT NULL THEN '是'
           ELSE '其他' END              AS 是否设置非柜限额
    ,T8.fg_per_lmt                      AS 非柜单笔限额
    ,T8.fg_day_lmt                      AS 非柜日累计限额
from SJXQ_SJ20240422111_CST_07          t1
inner join SJXQ_SJ20240422111_CST_06_1  t2
on t1.cst_act_id=t2.客户账号
inner join(
    select distinct cst_act_id,cst_tp,lbl_prod_typ_nm
        ,dep_cls_nm,act_ctg_nm_1,act_ctg_nm_2,pd_cmt
    from SJXQ_SJ20240422111_CST_08
)t3 on t1.cst_act_id=t3.cst_act_id
left join SJXQ_SJ20240422111_CST_01     t5 --止付
on t1.cst_act_id=t5.cst_act_id
and t5.rn=1
left join SJXQ_SJ20240422111_CST_02     t6 --冻结
on t1.cst_act_id=t6.cst_act_id
and t6.rn=1
left join SJXQ_SJ20240422111_CST_03     t7 --关闭非柜面
on t1.cst_act_id=t7.cst_act_id
and t7.rn=1
left join SJXQ_SJ20240422111_CST_04     t8 --非柜面限额
on t1.cst_act_id=t8.cst_act_id
and t8.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240422111_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240422111_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240422111_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240422111_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct mac_id) custs
from SJXQ_SJ20240422111_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20240422111_CST_06
union all
SElECT '061' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20240422111_CST_06_1
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240422111_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240422111_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户账号,命中的黑MAC地址) custs
from SJXQ_SJ20240422111_CST_09
;
/*
01	2652428	2652428
02	38841	38841
03	3757240	3757240
04	3920724	3920724
05	2259	2259
06	320666795	2525951
061	3713	3562
07	719980	719980
08	7074708	7006277
09	245	242
*/
***SJ20240423116_保险双录识别码.sql
--保险业务交易流水信息
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_01 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_01 AS
select t1.bsn_serno	                        --业务流水号|c32
    ,t1.trx_dt                                   --交易日期|c8
	,t1.bsn_typ_nm                               --业务类型名称|c20
	,t1.insu_cmp_cd                              --保险公司代码|c20
	,t1.prd_no                                   --产品代码|c20
	,t1.insu_poly_no                             --保单编号|c32
	,t1.cst_magr_id                              --客户经理id|c32
	,t1.cst_id                                   --客户编号|c24
	,t1.trx_amt                                  --交易金额|decimal(18,2)
	,t1.trx_tm                                   --交易时间|c20
	,t1.insu_poly_prt_no                         --投保单号|c32
	,t1.dbl_rcd_rcg_no                           --双录识别码|c32
    ,concat(replace(t1.trx_dt,'-',''),' ',t1.trx_tm) trx_dt_tm
from edw.dwd_bus_insu_bus_trx_srl_inf_dd    t1    --保险业务交易流水信息
inner join edw.vdrp_qualitytrade            T2
on t1.bsn_serno=t2.tradeno
and t2.BusinessStatus=2     --未使用
AND t2.BusType ='BXCP'
and t2.dt<='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and concat(replace(t1.trx_dt,'-',''),t1.trx_tm)<='20240423200000'
and replace(t1.trx_dt,'-','')>='20240417'
and nvl(t1.dbl_rcd_rcg_no,'')<>''  --双录识别码 非空
;
--被保人 国籍、性别、出生日期
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_02 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_02 AS
SElECT t1.insu_plcy_id	        --保单号|C30
    ,t1.bbr_doc_nbr	            --被保人证件号码|C30
    ,t2.cst_id
    ,t3.gdr_cd	                --性别代码|C1
    ,decode(t3.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t3.bth_dt	                --出生日期|C8
    ,t3.ntn_cd	                --国籍代码|C3
    ,c1.cd_val_dscr     ntn_nm
from edw.dwd_bus_insu_plcy_insu_inf_dd  t1 --保险保单投保信息
left join edw.dws_cst_bas_inf_dd        t2 --客户基础信息汇总表
on  t1.bbr_doc_nbr=t2.doc_nbr
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd	t3 --个人客户基本信息
on  t2.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON  t3.ntn_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_03 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_03 AS
SElECT insu_plcy_id
from SJXQ_SJ20240423116_CST_02
group by insu_plcy_id
;
--结果
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_04 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240423116_CST_04 AS
SElECT t1.dbl_rcd_rcg_no    双录识别码
    ,insu_plcy_id	        保单号
    ,trx_dt_tm              交易时间
    ,gdr_nm                 被保人性别
    ,bth_dt                 被保人出生日期
    ,ntn_nm                 被保人国籍
from SJXQ_SJ20240423116_CST_01      t1
left join SJXQ_SJ20240423116_CST_03 t2
on t1.insu_poly_no=t2.insu_plcy_id
;
SElECT '01' seq, count(1) cnt,count(distinct insu_poly_no) custs
from SJXQ_SJ20240423116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct insu_plcy_id) custs
from SJXQ_SJ20240423116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct insu_plcy_id) custs
from SJXQ_SJ20240423116_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 保单号) custs
from SJXQ_SJ20240423116_CST_04
;
/*
01	0 0
02	61472	61258
03	61258	61258
*/
***SJ20240423131_庆元村行未终结信贷.sql
--贷款合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240423131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240423131_CST_01 AS
select t1.busi_ctr_id                            --业务合同编号|C32
    ,t1.busi_apl_id                              --业务申请编号
    ,t1.pre_apl_srl_nbr                          --预申请流水号
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.intr_rat                                 --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                              --贷款用途代码|C4
    ,c1.cd_val_dscr     loan_usg_nm
	,t1.usg_cmt                                  --用途备注|c4
    ,t1.five_ctg_cd                              --五级分类代码
    ,c2.cd_val_dscr     five_ctg_nm
    ,t1.sgn_spus_com_dbt_ind                    --签订夫妻共同债务标志
    ,t2.acs_org_id,t2.acs_mngr_id
    ,t3.empe_nm acs_mngr_nm
    ,t4.org_nm,t4.BRC_ORG_NM,t4.BRC_ORG_ID
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t2 --信贷合同管护信息
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='20240423'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  T2.acs_mngr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.acs_org_id=t4.org_id
and t4.BRC_ORG_NM like '%庆元泰隆村镇银行%'
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd c1 -- 码值表
ON  T1.loan_usg_cd = c1.cd_val
AND c1.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND c1.fld_nm = 'LOAN_USG_CD'
AND c1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd c2 --码值表
ON      t1.five_ctg_cd = c2.cd_val
AND     c2.DT = '@@{yyyyMMdd}'
where t1.dt='20240423'
AND (
        (
            ( t1.ctr_bal > 0
                OR ( t1.ctr_bal IS NULL AND nvl(t1.crc_ind, '0') = '0') --非循环贷
                OR (
                    (nvl(t1.crc_ind, '0') <> '0' OR t1.pd_cd LIKE '2010503%' )
                    AND ( t1.ctr_bal = 0 OR t1.ctr_bal IS NULL )
                    AND t1.apnt_mtu_dt >= '20240423'
                )
            ) AND nvl(t1.frz_sts_cd, ' ') NOT IN ( '3' , '4' )
        )
        OR
        (   t1.ctr_bal > 0
            AND     t1.pd_cd LIKE '2010503%'
            AND     t1.apnt_mtu_dt <= '20240423'
            AND     t1.frz_sts_cd IN ( '3' , '4' )
        )
    ) ----未终结、未到期业务
;
-- 预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240423131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240423131_CST_02 AS
SElECT t1.pre_apl_srl_nbr,t1.busi_ctr_id
    ,t3.pre_ases_srl_nbr
    ,case t3.pre_ases_rsl
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else t3.pre_ases_rsl end as 预评估结果
    ,T6.sgs_inf       AS 征信规则触发逾期内容
    ,T8.tsk_mak_dt    AS 最近一次精准贷后触犯时间
    ,T8.brk_rsn       AS 最近一次精准贷后触犯原因
from SJXQ_SJ20240423131_CST_01              t1
LEFT JOIN edw.dwd_bus_loan_pre_ases_rsl_dd  T3 --预评估最终结果信息
ON      T1.pre_apl_srl_nbr = T3.srl_nbr
AND     T3.DT = '20240423'
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,sgs_inf
                         ,ROW_NUMBER() OVER ( PARTITION BY apl_srl_nbr ORDER BY srl_nbr DESC ) AS RN
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     sgs_inf RLIKE '逾期'
                 AND     qry_cntnt = '07' --征信规则
             ) T6
ON      T3.pre_ases_srl_nbr = T6.apl_srl_nbr
AND     T6.RN = 1
LEFT JOIN    (
                 SELECT  cst_id
                         ,vio_rsn_ana
                         ,tsk_mak_dt
                         ,brk_rsn
                         ,RANK() OVER ( PARTITION BY cst_id ORDER BY srl_nbr DESC ) AS RN
                 FROM    edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd  --精准贷后结果信息表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     rsk_trg_typ_cd <> ''
             ) T8
ON      T1.cst_id = T8.cst_id
AND     T8.RN = 1
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240423131_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240423131_CST_03 AS
select t1.BRC_ORG_NM            机构分行
    ,t1.org_nm                  机构名称
    ,t1.acs_mngr_nm             客户经理名称
    ,t1.acs_mngr_id             客户经理工号
	,t1.cst_id                  客户编号
	,t1.cst_nm                  客户名称
    ,t1.busi_ctr_id             业务合同编号
	,t1.apnt_start_dt           约定开始日期
	,t1.apnt_mtu_dt             约定到期日期
	,t1.ctr_amt                 合同金额
	,t1.ctr_bal                 合同余额
	,t1.intr_rat                利率
    ,t1.five_ctg_nm             五级分类
    ,case when t1.sgn_spus_com_dbt_ind='1' then '是' else '否' end    配偶是否签署共债
    ,t2.预评估结果
    ,T2.征信规则触发逾期内容
    ,T2.最近一次精准贷后触犯时间
    ,T2.最近一次精准贷后触犯原因
from SJXQ_SJ20240423131_CST_01      t1
left join SJXQ_SJ20240423131_CST_02 t2
on t1.busi_ctr_id=t2.busi_ctr_id
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ20240423131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ20240423131_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 业务合同编号) custs
from SJXQ_SJ20240423131_CST_03
;
/*
01	12892	12892
02	12892	12892
03	12892	12892
*/***SJ2024042336_理财基金反洗钱监测.sql
--签约理财或基金的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_01 AS
select cst_id                                 --客户编号|C20
from edw.dwd_bus_chm_ctr_inf_dd               --理财客户签约信息
where dt='@@{yyyyMMdd}'
and sal_rcd_sts_cd = '0'    --未解约
union
select cst_id                                 --客户号|c32
from edw.dim_bus_chm_fnd_cst_ctr_inf_dd       --基金客户签约信息表
where dt='@@{yyyyMMdd}'
-- and ctr_sts_cd='1'       --签约状态代码 不确定
;
--理财交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_02 AS
select t1.cst_ID,t1.PD_CD,t1.trx_dt,t1.trx_tm,t1.CFM_AMT
    ,t1.mgr_id sale_empe_id,t1.ori_trx_act_id --客户账号
    ,t2.pd_nm
from edw.dwd_bus_chm_trx_cfm_dtl_di         t1  --只有近7天分区 cst_id,pd_cd,trx_dt,trx_tm 不唯一
inner join edw.dim_bus_chm_pd_inf_dd 	    t2  --理财产品信息
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
and t2.pd_ctg_cd='1' --理财
inner join SJXQ_SJ2024042336_CST_01         t3
on t1.cst_id=t3.cst_id
WHERE t1.dt <= '@@{yyyyMMdd}'
and t1.trx_dt between '20230101' and '20231231' --2023年度
;
--基金交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_03 AS
SELECT  A.cst_id,substr(replace(A.apl_tm,'-',''),1,8) trx_dt
    ,substr(a.apl_tm,12,19)     trx_tm
	,apl_amt                                  --申请金额|decimal(16,2)
	,cfm_amt                                  --确认金额|decimal(16,2)
	,cst_typ_cd                               --客户类型代码|c1
	,pd_cd                                    --产品代码|c32
FROM    edw.dwd_bus_chm_fnd_trx_cfm_dtl_di         A --基金交易确认流水明细
LEFT JOIN LAB_BIGDATA_DEV.SJXQ_SJ2024042336_CST_01 D
ON      a.cst_id = d.cst_id
WHERE   A.dt <= '@@{yyyyMMdd}'
AND     replace(replace(replace(A.apl_tm,'-',''),':',''),' ','') >= '20230101000000'
AND     replace(replace(replace(A.apl_tm,'-',''),':',''),' ','') < '20240101000000'
and A.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND A.BUS_CD IN ( '120' , '122' , '136' , '139' , '138' ) --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND A.CFM_AMT > 0
;
--交易汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_04 AS
SElECT cst_id,trx_dt,sum(cfm_amt) cfm_amt
from(
    SElECT cst_id,trx_dt,cfm_amt
    from SJXQ_SJ2024042336_CST_02
    union all
    SElECT cst_id,trx_dt,cfm_amt
    from SJXQ_SJ2024042336_CST_03
)t1 group by cst_id,trx_dt
;
-- 2023年任意连续30天内，累计购买基金产品及理财产品最大总金额（万元）
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_05 AS
SElECT t1.cst_id,t1.trx_dt,sum(t2.CFM_AMT) cum_CFM_AMT_30d
from SJXQ_SJ2024042336_CST_04       t1
inner join SJXQ_SJ2024042336_CST_04 t2
on  t1.cst_id=t2.cst_id
and t2.trx_dt<=t1.trx_dt
and t2.trx_dt>TO_CHAR(DATEADD(TO_DATE(t1.trx_dt,'yyyymmdd'),-30,'dd'),'yyyymmdd')
group by t1.cst_id,t1.trx_dt
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_06 AS
SElECT t1.cst_id
    ,t2.per_fina_max_amt
    ,t3.per_fund_max_amt
    ,t4.trx_dt
    ,t4.cum_CFM_AMT_30d
    ,t5.cst_typ_cd	        --客户类型|C1
    ,decode(t5.cst_typ_cd,'1','个人','2','机构','') cst_typ_nm	--客户类型|C1
from SJXQ_SJ2024042336_CST_01       t1
left join (--2023年单笔购买理财产品最大金额（万元）
    SElECT cst_id,max(cfm_amt)  per_fina_max_amt
    from SJXQ_SJ2024042336_CST_02
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
left join (--2023年单笔购买基金产品最大金额（万元）
    SElECT cst_id,max(cfm_amt)  per_fund_max_amt
    from SJXQ_SJ2024042336_CST_03
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
left join (
    SElECT cst_id,trx_dt,cum_CFM_AMT_30d
        ,row_number() over(partition by cst_id order by cum_CFM_AMT_30d desc)rn
    from SJXQ_SJ2024042336_CST_05
)t4 on t1.cst_id=t4.cst_id
and t4.rn=1
left join edw.dws_cst_bas_inf_dd	t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
;
--需求1
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_07 AS
SElECT cst_id                           客户号
    ,cst_typ_nm	                        客户类型
    ,round(cum_CFM_AMT_30d/10000,2)     2023年任意连续30天内累计购买基金产品及理财产品最大总金额_万元
    ,round(per_fina_max_amt/10000,2)    2023年单笔购买理财产品最大金额_万元
    ,round(per_fund_max_amt/10000,2)    2023年单笔购买基金产品最大金额_万元
from SJXQ_SJ2024042336_CST_06
where cum_CFM_AMT_30d>=5000000
;
--需求2
DROP   TABLE IF     EXISTS SJXQ_SJ2024042336_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042336_CST_08 AS
SElECT t1.cltr_cst_id                               客户号
    ,decode(t5.cst_typ_cd,'1','个人','2','机构','')  客户类型
    ,round(t1.ases_val/10000,2)                     理财质押入库价值_万元
from(
    SElECT cltr_cst_id,sum(ases_val) ases_val
    from edw.dim_bus_grnt_cltr_inf_dd   t1 --抵质押物信息
    where t1.dt='20231231'          --截至2023年12月31日
    and t1.cltr_nm regexp '理财'    --cltr_typ_cd:A070101
    and t1.sts_cd='02'              -- 01:未入库 02:入库
    group by cltr_cst_id
)t1 left join edw.dws_cst_bas_inf_dd	t5 --客户基础信息汇总表
on  t1.cltr_cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042336_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024042336_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024042336_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024042336_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042336_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042336_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024042336_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024042336_CST_08
;
/*
01	511030	511030
02	1244127	666250
03	198988	168778
04	1443115	830976
05	830976	172726
06	511030	511030
07	4693	4693
08	47	47
--20240426更新 临时表4没有 groupby 临时表5关联会重复计算
01	511030	511030
02	1244127	666250
03	198988	168778
04	835028	830976
05	830976	172726
06	511030	511030
07	1256	1256
08	47	47
04	830976	830976
05	830976	172726
06	511030	511030
07	1250	1250
*/
***SJ2024042341_温州分行泰惠收商户营销.sql
--客群
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_01 AS
SElECT t1.cst_id
    ,coalesce(t2.sam_rsk_ctrl_id,t1.cst_id) sam_rsk_ctrl_id --同一风险控制号
FROM qbi_file_20240424_10_49_59     t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on  t1.cst_id=t2.cst_id
AND nvl(T2.sam_rsk_ctrl_id,'')<>''
and t2.dt='20240422'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_02 AS
select t1.mch_id                                --商户编号|C32
	,t1.mch_nm                                  --商户名称|C200
    ,t1.mch_sts_cd                              --商户状态代码|C32
    ,c1.cd_val_dscr     mch_sts_nm
	,t1.con_tel_nbr                             --联系电话|C32
	,t1.cst_id                                  --客户号|C20
    ,t2.cprh_cmnt_id                            --综合社区编号
    ,t2.sub_cmnt_id                             --子社区编号
from edw.dim_bus_chnl_ths_mch_inf_dd    t1 --泰惠收商户基本信息
left join edw.dwd_cst_mng_cmnt_rel_dd   t2 --客户社区信息
on t1.cst_id=t2.cst_id
AND t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
and t2.dt='20240422'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON  t1.mch_sts_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.dt='20240422'
;
--最新 征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_03 AS
SElECT t1.cst_id
    ,t2.digital_unscr   cst_cur_zxscore
    ,t2.dt              cur_report_dt
    ,row_number() over(partition by t1.cst_id order by t2.dt desc) rn
from LAB_BIGDATA_DEV.SJXQ_SJ2024042341_CST_01           t1
inner join adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di t2
on t1.cst_id=t2.cst_id
and t2.dt<='@@{yyyyMMdd}'
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_04 AS
SELECT   COALESCE(T2.sam_rsk_ctrl_id,T1.cst_id) AS sam_rsk_ctrl_id
        ,SUM(CASE
               WHEN T3.pd_nm RLIKE '国内信用证' THEN T1.ctr_amt
             END) AS 国内信用证风险敞口
        ,SUM(CASE
               WHEN  T1.crc_ind IN ( '1' , '2' ) OR (SUBSTR(T1.pd_cd, 1, 7) = '2010403' AND T3.pd_nm NOT RLIKE '国内信用证' ) THEN T1.tot_xpos_amt
             END) AS 循环贷款风险敞口
        ,SUM(CASE
               WHEN SUBSTR(T1.pd_cd, 1, 7) IN ( '2010401' , '2010501' ) THEN T1.ctr_bal
             END) AS 普通贷款风险敞口
        ,SUM(CASE
               WHEN SUBSTR(T1.pd_cd, 1, 7) = '2010503' THEN T1.ctr_amt
             END) AS 随贷通风险敞口
        ,SUM(CASE
               WHEN T1.pd_cd IN ( '2010402010102' , '201040201010201' , '201040201010202' , '201040201010203' , '201040202010105' ) THEN T1.tot_xpos_amt
             END) AS E票通风险敞口
        ,SUM(CASE
               WHEN T1.pd_cd LIKE '2010402%' AND T1.pd_cd NOT IN ( '2010402010102' , '201040201010201' , '201040201010202' , '201040201010203' , '201040202010105' ) THEN T1.mrgn_amt
             END) AS 其它承兑风险敞口
FROM   edw.dim_bus_loan_ctr_inf_dd  T1
LEFT JOIN edw.dws_cst_bas_inf_dd    T2 --客户基础信息汇总表
ON   T1.cst_id	= T2.cst_id
AND  nvl(T2.sam_rsk_ctrl_id,'')<>''
AND  T2.DT='20240422'
LEFT JOIN edw.dim_bus_loan_pd_inf_dd T3 --信贷产品信息
ON   T1.pd_cd = T3.pd_cd
AND  T3.DT = '20240422'
WHERE T1.DT='20240422'
AND  ( T1.hpn_dt <= T1.dt AND T1.apnt_mtu_dt >= T1.dt AND T1.end_dt = '18991231' ) --限制合同未结清
GROUP BY COALESCE(T2.sam_rsk_ctrl_id,T1.cst_id)
;
-- 泰惠收注销_中止原因
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_05 AS
SELECT A.CRT_DATE_TIME, A.MCHT_ID
    ,CASE WHEN A.BUSINESS_TYPE='01' THEN '结算业务'
        WHEN A.BUSINESS_TYPE='02' THEN '支付业务-微信'
        WHEN A.BUSINESS_TYPE='03' THEN '支付业务-支付宝'
        WHEN A.BUSINESS_TYPE='04' THEN '支付业务-手机银行'
        WHEN A.BUSINESS_TYPE='05' THEN '支付业务-银联'
        WHEN A.BUSINESS_TYPE='06' THEN '提现业务'
        WHEN A.BUSINESS_TYPE='07' THEN '信用卡支付'
        WHEN A.BUSINESS_TYPE='08' THEN '商户中止'
        WHEN A.BUSINESS_TYPE='09' THEN '商户恢复'
        WHEN A.BUSINESS_TYPE='10' THEN '商户注销'
        WHEN A.BUSINESS_TYPE='11' THEN '智慧经营'
        WHEN A.BUSINESS_TYPE='12' THEN '储值协议'
        ELSE '' END BUSINESS_TYPE
    ,CASE WHEN A.BUSINESS_STATE='00' THEN '已禁用'
        WHEN A.BUSINESS_STATE='01' THEN '已开启'
        WHEN A.BUSINESS_STATE='02' THEN '中止'
        WHEN A.BUSINESS_STATE='03' THEN '恢复'
        WHEN A.BUSINESS_STATE='04' THEN '注销'
        ELSE '' END BUSINESS_STATE,
    A.MSG,
    A.CRT_TLR,
    A.BLACK_LIST,
    ROW_NUMBER() OVER (PARTITION BY A.MCHT_ID,A.BUSINESS_STATE ORDER BY A.CRT_DATE_TIME DESC) ROW_NO
FROM EDW.DPSS_PBS_MCHT_BUSIN_MOD_RECORD A
WHERE A.DT='20240422'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_06 AS
SElECT t1.cst_id,t1.sam_rsk_ctrl_id
    ,t2.mch_id ,t2.mch_nm ,t2.con_tel_nbr
    ,t2.sub_cmnt_id,t2.mch_sts_nm
    ,t3.cst_cur_zxscore
    ,t3.cur_report_dt
    ,COALESCE(T4.国内信用证风险敞口,0)+COALESCE(T4.循环贷款风险敞口,0)+COALESCE(T4.普通贷款风险敞口,0)+COALESCE(T4.随贷通风险敞口,0)
        +COALESCE(T4.E票通风险敞口,0)+COALESCE(T4.其它承兑风险敞口,0) AS 同一风险控制号下风险敞口
    ,t5.MSG     zz_msg
    ,t6.MSG     zx_msg
    ,t7.lst_hpn_dt
from SJXQ_SJ2024042341_CST_01       t1
left join SJXQ_SJ2024042341_CST_02  t2 --部分客户没有 商户号
on  t1.cst_id=t2.cst_id
left join SJXQ_SJ2024042341_CST_03  t3
on  t1.cst_id=t3.cst_id
and t3.rn=1
left join SJXQ_SJ2024042341_CST_04  t4
on  t1.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
left join SJXQ_SJ2024042341_CST_05  t5
on  t2.mch_id=t5.MCHT_ID
and t5.BUSINESS_STATE='中止'
and t5.ROW_NO=1
left join SJXQ_SJ2024042341_CST_05  t6
on  t2.mch_id=t6.MCHT_ID
and t6.BUSINESS_STATE='注销'
and t6.ROW_NO=1
left join (
    select max(hpn_dt)  lst_hpn_dt                --发生日期|C8
        ,cst_id                                   --客户编号|C20
    from edw.dwd_bus_loan_apl_inf_dd              --信贷业务申请信息
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024042341_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042341_CST_07 AS
SElECT cst_id                       客户号
    ,mch_id                         商户编号
    ,mch_nm                         商户名称
    ,zz_msg                         商户中止原因
    ,zx_msg                         商户注销原因
    ,sub_cmnt_id                    所属子社区编号
    ,con_tel_nbr                    客户手机号
    ,lst_hpn_dt                     最近一次我行贷款申请日期
    ,''                             系统内最新一次征信分        --征信分不能给营销
    ,同一风险控制号下风险敞口
from SJXQ_SJ2024042341_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042341_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ2024042341_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042341_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024042341_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct MCHT_ID) custs
from SJXQ_SJ2024042341_CST_05 where ROW_NO=1
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042341_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024042341_CST_07
;
/*
01	21120	21120
02	333061	333061
03	10373	10373
04	666663	666663
05	236439	192936
06	23890	21120
07	23890	21120
*/
***SJ20240424101_2024保险代销考核明细.sql
--保险代销业务考核明细表
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240424101_CST_01 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240424101_CST_01 AS
select trx_dt                                   --交易日期
	,cst_id                                   --客户号
	,prod_cd                                  --产品代码
	,prod_nm                                  --产品名称
	,insu_ord_nbr                             --投保单号
	,insu_plcy_id                             --保单号
	,insu_plcy_sts                            --保单状态
	,frs_trm_insu_fee                         --首期保费
	,mng_cnv_insu_fee                         --管护折算保费
	,cmsn_fee                                 --手续费
	,mng_cnv_cmsn_fee                         --管护折算手续费
	,mng_mgr_id                               --管护客户经理工号
	,mng_mgr_nm                               --管护客户经理姓名
	,mng_rto                                  --管护比例
	,mng_org_id                               --管护机构号
	,mng_org_nm                               --管护机构名称
	,sal_ppl_id                               --销售人员工号
	,sal_ppl_nm                               --销售人员姓名
	,sal_ppl_pst_id                           --销售人员岗位编号
	,sal_ppl_pst_nm                           --销售人员岗位名称
	,sal_ppl_afl_org_id                       --销售人员所属机构号
	,sal_ppl_afl_org_nm                       --销售人员所属机构名称
	,trx_sts                                  --交易状态
	,trx_tm                                   --交易时间 hh:mm:ss
	,sal_org_id_fh                            --销售人员所属机构所属分行
from app_rpt.fct_insu_agn_bus_acs_dtl_tbl     --保险代销业务考核明细表
where dt='@@{yyyyMMdd}'
and replace(trx_dt,'-','') between '20240101' and '20240424'
;
--出结果
DROP   TABLE IF     EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240424101_CST_02 purge;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJXQ_SJ20240424101_CST_02 AS
select t1.trx_dt                                交易日期
	,t1.insu_ord_nbr                            投保单号
	,t1.insu_plcy_id                            保单号
	,t1.insu_plcy_sts                           保单状态
	,t1.mng_cnv_insu_fee                        管护折算保费
	,t1.mng_cnv_cmsn_fee                        管护折算手续费
	,t1.mng_mgr_id                              管护客户经理工号
	,t1.mng_mgr_nm                              管护客户经理姓名
	,t1.mng_rto                                 管护比例
	,t1.mng_org_id                              管护机构号
	,t1.mng_org_nm                              管护机构名称
	,t1.sal_ppl_id                              销售人员工号
	,t1.sal_ppl_nm                              销售人员姓名
	,t1.sal_org_id_fh                           销售人员所属机构所属分行
	,t1.trx_sts                                 交易状态
    ,decode(t2.QUALF_LVL,'1','保险鼓励','2','保险稳健','3','保险审慎','4','保险禁止') 客户所属资质等级
from LAB_BIGDATA_DEV.SJXQ_SJ20240424101_CST_01          t1
left join LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD t2
on t1.insu_plcy_id=t2.INSU_POLY_NO
and t2.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct insu_plcy_id) custs
from SJXQ_SJ20240424101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 保单号) custs
from SJXQ_SJ20240424101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct INSU_POLY_NO) custs
from TMP_ADM_PUB_INSU_QUALF_LAB_DD
where dt='@@{yyyyMMdd}'
;
/*
01	5759	5730
02	5759	5730
03	60919	60919
*/***SJ20240424101_保险标签.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 童林斌
-- 创建日期: 2024-04-11 11:43:34
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD
(
    INSU_POLY_NO STRING COMMENT '保单号'
    ,CST_ID      STRING COMMENT '客户号'
    ,TRX_DT      STRING COMMENT '投保日期'
    ,QUALF_LVL   STRING COMMENT '资质水平1保险鼓励2保险稳健3保险审慎4保险禁止'
)
COMMENT
'保险资质标签'
PARTITIONED BY
(
    DT STRING COMMENT '日期分区'
)
LIFECYCLE 36000;
-- 保单手续费
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_01;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_01
(
    INSU_ID       STRING  COMMENT '保单号'
    ,CMSN_FEE     DECIMAL COMMENT '结算手续费'
    ,PFM_CMSN_FEE DECIMAL COMMENT '绩效手续费'
);
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_01
SELECT  T1.INSU_POLY_NO
        ,SUM(COALESCE(T3.SETL_CMSN_FEE_AMT, 0))
        ,SUM(COALESCE(T3.PRFM_CMSN_FEE_AMT, 0))
FROM    edw.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD T1 -- 保险业务交易流水信息
LEFT JOIN    edw.DWD_BUS_INSU_BRED_SRL_INF_TBL_DD T2 -- 险种流水信息表
ON      T2.DT = '@@{yyyyMMdd}'
AND     T2.BSN_SERNO = T1.BSN_SERNO
AND     T2.PRD_NO = T1.PRD_NO
LEFT JOIN    edw.DWD_BUS_INSU_BRED_CMSN_FEE_STL_REG_RCD_DD T3
ON      T3.DT = '@@{yyyyMMdd}'
AND     T3.BSN_SERNO = T1.BSN_SERNO
AND     T3.INSU_POLY_NO = T1.INSU_POLY_NO
AND     T3.INSU_VRTY_CD = T2.INSU_VRTY_CD
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.BSN_TYP_NM = '订单'
AND     T3.ADD_FEE_IND IN ( '0' , '1' ) -- 加费标志 1-加费 0-非加费
AND     T3.CLC_CPL_STS_CD = '1' -- 计算完成标志 1-已完成 0-未完成
GROUP BY T1.INSU_POLY_NO;
-- 保险保单信息
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02
(
    INSU_ID          STRING COMMENT '保单号'
    ,CST_ID          STRING COMMENT '客户号'
    ,TRX_DT          STRING COMMENT '交易日期'
    ,BF_TRX_DT       STRING COMMENT '投保日期前15天日期'
    ,AF_TRX_DT       STRING COMMENT '投保日期后15天日期'
    ,SAM_RSK_CTRL_ID STRING COMMENT '风险控制号'
    ,SETLB_TM        STRING COMMENT '可结算日期'
    ,CAL_DT          STRING COMMENT '计算日期'
    ,REL_DT          STRING COMMENT '关联DT'
);
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02
SELECT  A.INSU_ID -- 保单号
        ,A.CST_ID -- 客户号
        ,A.TRX_DT -- 交易日期
        ,A.BF_TRX_DT -- 投保日期前15天日期
        ,A.AF_TRX_DT -- 投保日期后15天日期
        ,CASE
           WHEN B.SAM_RSK_CTRL_ID = '' OR B.SAM_RSK_CTRL_ID IS NULL THEN A.CST_ID
           ELSE B.SAM_RSK_CTRL_ID
         END AS SAM_RSK_CTRL_ID -- 风险控制号 -- 风险控制号
        ,A.SETLB_TM -- 可结算日期
        ,A.CAL_DT -- 计算日期
        ,CASE
           WHEN A.CAL_DT >= '@@{yyyyMMdd}' THEN '@@{yyyyMMdd}'
           ELSE A.CAL_DT
         END AS REL_DT -- 关联DT
FROM    (
            SELECT  T2.INSU_POLY_NO                                                           AS INSU_ID -- 保单号
                    ,T2.CST_ID                                                                AS CST_ID -- 客户号
                    ,T1.TRX_DT                                                                AS TRX_DT --交易日期
                    ,TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), - 15, 'DD'), 'yyyyMMdd') AS BF_TRX_DT -- 投保日期前15天日期
                    ,TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 15, 'DD'), 'yyyyMMdd')   AS AF_TRX_DT -- 投保日期后15天日期
                    ,COALESCE(REPLACE(SUBSTR(T4.SETLB_TM, 1, 10), '-', ''), '')               AS SETLB_TM -- 可结算日期
                    ,CASE
                       WHEN COALESCE(T4.SETLB_TM, '') = ''                                                                                                                                                       THEN TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 15, 'DD'), 'yyyyMMdd')
                       WHEN REPLACE(SUBSTR(T4.SETLB_TM, 1, 10), '-', '') >= T1.TRX_DT AND REPLACE(SUBSTR(T4.SETLB_TM, 1, 10), '-', '') <= TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 15, 'DD'), 'yyyyMMdd') THEN REPLACE(SUBSTR(T4.SETLB_TM, 1, 10), '-', '')
                       WHEN REPLACE(SUBSTR(T4.SETLB_TM, 1, 10), '-', '') > TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 15, 'DD'), 'yyyyMMdd')                                                                THEN TO_CHAR(DATEADD(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 15, 'DD'), 'yyyyMMdd')
                       ELSE REPLACE(SUBSTR(T4.SETLB_TM, 1, 10), '-', '')
                     END                                                                      AS CAL_DT -- 计算日期
            FROM    edw.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD T1 --保险业务交易流水信息
            INNER JOIN    edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T2 --保单信息表
            ON      T2.INSU_POLY_NO = T1.INSU_POLY_NO --保单编号关联
            AND     T2.DT = '@@{yyyyMMdd}'
            LEFT JOIN    edw.DWD_BUS_INSU_HDL_CHRG_RAT_SET_TBL_DD T4 -- 保单手续费结算登记记录
            ON      T4.INSU_POLY_NO = T1.INSU_POLY_NO
            AND     T4.BSN_SERNO = T1.BSN_SERNO
            AND     T4.DT = '@@{yyyyMMdd}'
            WHERE   T1.DT = '@@{yyyyMMdd}'
            AND     T1.BSN_TYP_NM = '订单'
        ) A
LEFT JOIN    edw.DWS_CST_BAS_INF_DD B -- 客户汇总信息
ON      A.CST_ID = B.CST_ID
AND     B.DT = (
               CASE
                 WHEN A.CAL_DT >= '@@{yyyyMMdd}' THEN '@@{yyyyMMdd}'
                 ELSE A.CAL_DT
               END
);
-- 风险控制号下客户信息
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03
(
    INSU_ID          STRING COMMENT '保单号'
    ,CST_ID          STRING COMMENT '客户号'
    ,TRX_DT          STRING COMMENT '投保日期'
    ,BF_TRX_DT       STRING COMMENT '投保日期前15天日期'
    ,AF_TRX_DT       STRING COMMENT '投保日期后15天日期'
    ,SAM_RSK_CTRL_ID STRING COMMENT '风险控制号'
    ,SAM_CST_ID      STRING COMMENT '风险控制号下客户编号'
    ,REL_DT          STRING COMMENT '关联DT'
)
COMMENT
'风险控制号下客户信息';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03
SELECT  T1.INSU_ID -- 保单号
        ,T1.CST_ID -- 客户号
        ,T1.TRX_DT -- 投保日期
        ,T1.BF_TRX_DT -- 投保日期前15天日期
        ,T1.AF_TRX_DT -- 投保日期后15天日期
        ,T1.SAM_RSK_CTRL_ID -- 风险控制号
        ,T2.CST_ID AS SAM_CST_ID -- 风险控制号下客户编号
        ,T1.REL_DT AS REL_DT -- 关联DT
FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02 T1 -- 客户投保信息
INNER JOIN    edw.DWS_CST_BAS_INF_DD T2 -- 客户汇总信息
ON      T1.SAM_RSK_CTRL_ID = (
                             CASE
                               WHEN T2.SAM_RSK_CTRL_ID = '' OR T2.SAM_RSK_CTRL_ID IS NULL THEN T2.CST_ID
                               ELSE T2.SAM_RSK_CTRL_ID
                             END
)
AND     T1.REL_DT = T2.DT
WHERE   T1.CST_ID <> ''
AND     T1.CST_ID IS NOT NULL ;
-- 风险控制号客户贷款信息
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04
(
    INSU_ID           STRING  COMMENT '保单号'
    ,BUSI_CTR_ID      STRING  COMMENT '业务合同编号'
    ,PD_CD            STRING  COMMENT '产品代码'
    ,CST_ID           STRING  COMMENT '客户编号'
    ,TRX_DT           STRING  COMMENT '投保日期'
    ,BF_TRX_DT        STRING  COMMENT '投保日期前15天日期'
    ,AF_TRX_DT        STRING  COMMENT '投保日期后15天日期'
    ,SAM_RSK_CTRL_ID  STRING  COMMENT '风险控制号'
    ,SAM_CST_ID       STRING  COMMENT '风险控制号下客户编号'
    ,REL_DT           STRING  COMMENT '关联DT'
    ,APNT_START_DT    STRING  COMMENT '约定开始日期'
    ,APNT_MTU_DT      STRING  COMMENT '约定到期日期'
    ,CTR_AMT          DECIMAL COMMENT '合同金额'
    ,CTR_BAL          DECIMAL COMMENT '合同余额'
    ,CTR_BAL_CNY      DECIMAL COMMENT '合同余额'
    ,INTR_RAT         DECIMAL COMMENT '执行年利率'
    ,REF_MON_INTR_RAT DECIMAL COMMENT '参考年利率'
    ,DIFF_TM          BIGINT  COMMENT '投保日期与约定开始日期之间天数'
    ,TRM_MON          BIGINT  COMMENT '贷款期限月'
    ,LN_DT            STRING  COMMENT '贷款数据日期'
)
COMMENT
'风险控制号客户贷款信息';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04
SELECT  T2.INSU_ID -- 保单号
        ,T1.BUSI_CTR_ID --  业务合同编号
        ,T1.PD_CD --  产品代码
        ,T2.CST_ID --  客户编号
        ,T2.TRX_DT --  投保日期
        ,T2.BF_TRX_DT --  投保日期前15天日期
        ,T2.AF_TRX_DT --  投保日期后15天日期
        ,T2.SAM_RSK_CTRL_ID --  风险控制号
        ,T2.SAM_CST_ID --  风险控制号客户
        ,T2.REL_DT --关联DT
        ,T1.APNT_START_DT --  约定开始日期
        ,T1.APNT_MTU_DT --  约定到期日期
        ,T1.CTR_AMT --  合同金额
        ,T1.CTR_BAL --  合同余额
        ,T1.CTR_BAL * T3.AVG_PRC / T3.QUO_UNT -- 合同余额折人民币
        ,T1.INTR_RAT * 12.00 / 10.00 -- 执行年利率
        ,T1.REF_MON_INTR_RAT * 12.00 / 10.00 -- 参考年利率
        ,ABS(DATEDIFF(TO_DATE(T2.TRX_DT, 'YYYYMMDD'), TO_DATE(T1.APNT_START_DT, 'yyyyMMdd'), 'dd')) AS DIFF_TM
        ,T1.TRM_MON -- 贷款期限月
        ,T1.DT -- 贷款数据日期
FROM    edw.DIM_BUS_LOAN_CTR_INF_DD T1 -- 信贷合同信息
INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03 T2 -- 风险控制号客户信息
ON      T2.SAM_CST_ID = T1.CST_ID
AND     T1.DT <= T2.REL_DT
AND     T1.DT >= T2.BF_TRX_DT
INNER JOIN    edw.DIM_BUS_COM_EXR_INF_DD T3 -- 汇率表
ON      T3.CCY_CD = T1.CCY_CD
AND     T3.DT = T1.DT
WHERE   SUBSTR(T1.PD_CD, 1, 9) IN ( '201040101' , '201040102' , '201040106' , '201050101' , '201050102' ) -- 流动资金贷款+固定资产贷款+法人购房贷款+个人消费性贷款+个人经营性贷款
    OR SUBSTR(T1.PD_CD, 1, 7) IN ( '2010404' , '2010503' ) -- 保理业务+随贷通
    OR SUBSTR(T1.PD_CD, 1, 5) = '20108';
-- 20108 垫款
-- 当前笔
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05
(
    INSU_ID           STRING  COMMENT '保单号'
    ,BUSI_CTR_ID      STRING  COMMENT '业务合同编号'
    ,PD_CD            STRING  COMMENT '产品代码'
    ,CST_ID           STRING  COMMENT '客户编号'
    ,TRX_DT           STRING  COMMENT '投保日期'
    ,BF_TRX_DT        STRING  COMMENT '投保日期前15天日期'
    ,AF_TRX_DT        STRING  COMMENT '投保日期后15天日期'
    ,SAM_RSK_CTRL_ID  STRING  COMMENT '风险控制号'
    ,SAM_CST_ID       STRING  COMMENT '风险控制号下客户编号'
    ,APNT_START_DT    STRING  COMMENT '约定开始日期'
    ,APNT_MTU_DT      STRING  COMMENT '约定到期日期'
    ,CTR_AMT          DECIMAL COMMENT '合同金额'
    ,CTR_BAL          DECIMAL COMMENT '合同余额'
    ,CTR_BAL_CNY      DECIMAL COMMENT '合同余额'
    ,INTR_RAT         DECIMAL COMMENT '执行年利率'
    ,REF_MON_INTR_RAT DECIMAL COMMENT '参考年利率'
    ,DIFF_TM          BIGINT  COMMENT '投保日期与约定开始日期之间天数'
    ,TRM_MON          BIGINT  COMMENT '贷款期限月'
)
COMMENT
'当前笔贷款信息';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05
SELECT  INSU_ID --保单号
        ,BUSI_CTR_ID -- 业务合同编号
        ,PD_CD -- 产品代码
        ,CST_ID -- 客户编号
        ,TRX_DT -- 投保日期
        ,BF_TRX_DT -- 投保日期前15天日期
        ,AF_TRX_DT -- 投保日期后15天日期
        ,SAM_RSK_CTRL_ID -- 风险控制号
        ,SAM_CST_ID -- 风险控制号下客户编号
        ,APNT_START_DT -- 约定开始日期
        ,APNT_MTU_DT -- 约定到期日期
        ,CTR_AMT -- 合同金额
        ,CTR_BAL -- 合同余额
        ,CTR_BAL_CNY -- 合同余额
        ,INTR_RAT -- 执行年利率
        ,REF_MON_INTR_RAT -- 参考年利率
        ,DIFF_TM -- 投保日期与约定开始日期之间天数
        ,TRM_MON -- 贷款期限月
FROM    (
            SELECT  INSU_ID -- 保单号
                    ,BUSI_CTR_ID -- 业务合同编号
                    ,PD_CD -- 产品代码
                    ,CST_ID -- 客户编号
                    ,TRX_DT -- 投保日期
                    ,BF_TRX_DT -- 投保日期前15天日期
                    ,AF_TRX_DT -- 投保日期后15天日期
                    ,SAM_RSK_CTRL_ID -- 风险控制号
                    ,SAM_CST_ID -- 风险控制号下客户编号
                    ,APNT_START_DT -- 约定开始日期
                    ,APNT_MTU_DT -- 约定到期日期
                    ,CTR_AMT -- 合同金额
                    ,CTR_BAL -- 合同余额
                    ,CTR_BAL_CNY -- 合同余额
                    ,INTR_RAT -- 执行年利率
                    ,REF_MON_INTR_RAT -- 参考年利率
                    ,DIFF_TM -- 投保日期与约定开始日期之间天数
                    ,TRM_MON -- 贷款期限月
                    ,ROW_NUMBER() OVER ( PARTITION BY INSU_ID ORDER BY DIFF_TM ASC , CTR_BAL_CNY DESC , LN_DT ASC ) AS RN
            FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 --风险控制号的贷款信息
            WHERE   APNT_START_DT <= AF_TRX_DT
            AND     APNT_START_DT >= BF_TRX_DT
            AND     CTR_BAL_CNY > 0
        ) T
WHERE   T.RN = 1;
-- 上一笔
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_06;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_06
(
    INSU_ID           STRING  COMMENT '保单号'
    ,BUSI_CTR_ID      STRING  COMMENT '业务合同编号'
    ,PD_CD            STRING  COMMENT '产品代码'
    ,CST_ID           STRING  COMMENT '客户编号'
    ,TRX_DT           STRING  COMMENT '投保日期'
    ,BF_TRX_DT        STRING  COMMENT '投保日期前15天日期'
    ,AF_TRX_DT        STRING  COMMENT '投保日期后15天日期'
    ,SAM_RSK_CTRL_ID  STRING  COMMENT '风险控制号'
    ,SAM_CST_ID       STRING  COMMENT '风险控制号下客户编号'
    ,APNT_START_DT    STRING  COMMENT '约定开始日期'
    ,APNT_MTU_DT      STRING  COMMENT '约定到期日期'
    ,CTR_AMT          DECIMAL COMMENT '合同金额'
    ,CTR_BAL          DECIMAL COMMENT '合同余额'
    ,CTR_BAL_CNY      DECIMAL COMMENT '合同余额'
    ,INTR_RAT         DECIMAL COMMENT '执行年利率'
    ,REF_MON_INTR_RAT DECIMAL COMMENT '参考年利率'
    ,DIFF_TM          BIGINT  COMMENT '投保日期与约定开始日期之间天数'
)
COMMENT
'上一笔贷款信息';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_06
SELECT  INSU_ID --保单号
        ,BUSI_CTR_ID -- 业务合同编号
        ,PD_CD -- 产品代码
        ,CST_ID -- 客户编号
        ,TRX_DT -- 投保日期
        ,BF_TRX_DT -- 投保日期前15天日期
        ,AF_TRX_DT -- 投保日期后15天日期
        ,SAM_RSK_CTRL_ID -- 风险控制号
        ,SAM_CST_ID -- 风险控制号下客户编号
        ,APNT_START_DT -- 约定开始日期
        ,APNT_MTU_DT -- 约定到期日期
        ,CTR_AMT -- 合同金额
        ,CTR_BAL -- 合同余额
        ,CTR_BAL_CNY -- 合同余额
        ,INTR_RAT -- 执行年利率
        ,REF_MON_INTR_RAT -- 参考年利率
        ,DIFF_TM -- 投保日期与约定开始日期之间天数
FROM    (
            SELECT  T1.INSU_ID -- 保单号
                    ,T1.BUSI_CTR_ID -- 业务合同编号
                    ,T1.PD_CD -- 产品代码
                    ,T1.CST_ID -- 客户编号
                    ,T1.TRX_DT -- 投保日期
                    ,T1.BF_TRX_DT -- 投保日期前15天日期
                    ,T1.AF_TRX_DT -- 投保日期后15天日期
                    ,T1.SAM_RSK_CTRL_ID -- 风险控制号
                    ,T1.SAM_CST_ID -- 风险控制号下客户编号
                    ,T1.APNT_START_DT -- 约定开始日期
                    ,T1.APNT_MTU_DT -- 约定到期日期
                    ,T1.CTR_AMT -- 合同金额
                    ,T1.CTR_BAL -- 合同余额
                    ,T1.CTR_BAL_CNY -- 合同余额
                    ,T1.INTR_RAT -- 执行年利率
                    ,T1.REF_MON_INTR_RAT -- 参考年利率
                    ,T1.DIFF_TM -- 投保日期与约定开始日期之间天数
                    ,ROW_NUMBER() OVER ( PARTITION BY T1.INSU_ID ORDER BY T1.DIFF_TM ASC , T1.CTR_BAL_CNY DESC , T1.LN_DT ASC ) AS RN
            FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 T1 -- 风险控制号客户贷款明细
            INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05 T2 -- 当前笔
            ON      T2.INSU_ID = T1.INSU_ID
            AND     SUBSTR(T1.PD_CD, 1, 9) = SUBSTR(T2.PD_CD, 1, 9) -- 按照贷款种类产品三级目录种类一致
            WHERE   T1.APNT_START_DT < T2.APNT_START_DT
        ) T
WHERE   T.RN = 1;
-- 下一笔
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_07;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_07
(
    INSU_ID           STRING  COMMENT '保单号'
    ,BUSI_CTR_ID      STRING  COMMENT '业务合同编号'
    ,PD_CD            STRING  COMMENT '产品代码'
    ,CST_ID           STRING  COMMENT '客户编号'
    ,TRX_DT           STRING  COMMENT '投保日期'
    ,BF_TRX_DT        STRING  COMMENT '投保日期前15天日期'
    ,AF_TRX_DT        STRING  COMMENT '投保日期后15天日期'
    ,SAM_RSK_CTRL_ID  STRING  COMMENT '风险控制号'
    ,SAM_CST_ID       STRING  COMMENT '风险控制号下客户编号'
    ,APNT_START_DT    STRING  COMMENT '约定开始日期'
    ,APNT_MTU_DT      STRING  COMMENT '约定到期日期'
    ,CTR_AMT          DECIMAL COMMENT '合同金额'
    ,CTR_BAL          DECIMAL COMMENT '合同余额'
    ,CTR_BAL_CNY      DECIMAL COMMENT '合同余额'
    ,INTR_RAT         DECIMAL COMMENT '执行年利率'
    ,REF_MON_INTR_RAT DECIMAL COMMENT '参考年利率'
    ,DIFF_TM          BIGINT  COMMENT '投保日期与约定开始日期之间天数'
)
COMMENT
'下一笔贷款信息';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_07
SELECT  INSU_ID --保单号
        ,BUSI_CTR_ID -- 业务合同编号
        ,PD_CD -- 产品代码
        ,CST_ID -- 客户编号
        ,TRX_DT -- 投保日期
        ,BF_TRX_DT -- 投保日期前15天日期
        ,AF_TRX_DT -- 投保日期后15天日期
        ,SAM_RSK_CTRL_ID -- 风险控制号
        ,SAM_CST_ID -- 风险控制号下客户编号
        ,APNT_START_DT -- 约定开始日期
        ,APNT_MTU_DT -- 约定到期日期
        ,CTR_AMT -- 合同金额
        ,CTR_BAL -- 合同余额
        ,CTR_BAL_CNY -- 合同余额
        ,INTR_RAT -- 执行年利率
        ,REF_MON_INTR_RAT -- 参考年利率
        ,DIFF_TM -- 投保日期与约定开始日期之间天数
FROM    (
            SELECT  T1.BUSI_CTR_ID -- 业务合同编号
                    ,T1.PD_CD -- 产品代码
                    ,T1.CST_ID -- 客户编号
                    ,T1.TRX_DT -- 投保日期
                    ,T1.BF_TRX_DT -- 投保日期前15天日期
                    ,T1.AF_TRX_DT -- 投保日期后15天日期
                    ,T1.SAM_RSK_CTRL_ID -- 风险控制号
                    ,T1.SAM_CST_ID -- 风险控制号下客户编号
                    ,T1.APNT_START_DT -- 约定开始日期
                    ,T1.APNT_MTU_DT -- 约定到期日期
                    ,T1.CTR_AMT -- 合同金额
                    ,T1.CTR_BAL -- 合同余额
                    ,T1.CTR_BAL_CNY -- 合同余额
                    ,T1.INTR_RAT -- 执行年利率
                    ,T1.REF_MON_INTR_RAT -- 参考年利率
                    ,T1.DIFF_TM -- 投保日期与约定开始日期之间天数
                    ,T1.INSU_ID -- 保单号
                    ,ROW_NUMBER() OVER ( PARTITION BY T1.INSU_ID ORDER BY T1.DIFF_TM ASC , T1.CTR_BAL_CNY DESC , T1.LN_DT ASC ) AS RN
            FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 T1 -- 风险控制号客户贷款明细
            INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05 T2 -- 当前笔
            ON      T2.INSU_ID = T1.INSU_ID
            AND     SUBSTR(T1.PD_CD, 1, 9) = SUBSTR(T2.PD_CD, 1, 9) -- 按照产品三级目录种类一致
            WHERE   T1.APNT_START_DT > T2.APNT_START_DT
        ) T
WHERE   T.RN = 1;
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_08;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_08
(
    INSU_ID              STRING  COMMENT '保单号'
    ,BUSI_CTR_ID         STRING  COMMENT '当前业务合同编号'
    ,CST_ID              STRING  COMMENT '客户编号'
    ,TRX_DT              STRING  COMMENT '投保日期'
    ,CTR_BAL_CNY         DECIMAL COMMENT '当前合同余额'
    ,INTR_RAT            DECIMAL COMMENT '当前执行年利率'
    ,REF_MON_INTR_RAT    DECIMAL COMMENT '当前参考年利率'
    ,BUSI_CTR_ID_BF      STRING  COMMENT '上一笔业务合同编号'
    ,CTR_BAL_CNY_BF      DECIMAL COMMENT '上一笔合同余额'
    ,INTR_RAT_BF         DECIMAL COMMENT '上一笔执行年利率'
    ,REF_MON_INTR_RAT_BF DECIMAL COMMENT '上一笔参考年利率'
    ,BUSI_CTR_ID_AF      STRING  COMMENT '下一笔业务合同编号'
    ,CTR_BAL_CNY_AF      DECIMAL COMMENT '下一笔合同余额'
    ,INTR_RAT_AF         DECIMAL COMMENT '下一笔执行年利率'
    ,REF_MON_INTR_RAT_AF DECIMAL COMMENT '下一笔参考年利率'
    ,DIFF_TM             BIGINT  COMMENT '上下两笔贷款间隔天数'
    ,IS_CTN              STRING  COMMENT '是否续贷户'
    ,MNG_CMSN_FEE        DECIMAL COMMENT '当天保险中收'
    ,LN_DCNT_FAV1        DECIMAL COMMENT '贷款让利优惠1'
    ,LN_DCNT_FAV2        DECIMAL COMMENT '贷款让利优惠2'
)
COMMENT
'客户当前上下笔贷款信息';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_08
SELECT  T1.INSU_ID
        ,T1.BUSI_CTR_ID
        ,T1.CST_ID
        ,T1.TRX_DT
        ,T1.CTR_BAL_CNY
        ,T1.INTR_RAT
        ,T1.REF_MON_INTR_RAT
        ,T2.BUSI_CTR_ID
        ,T2.CTR_BAL_CNY
        ,T2.INTR_RAT
        ,T2.REF_MON_INTR_RAT
        ,T3.BUSI_CTR_ID
        ,T3.CTR_BAL_CNY
        ,T3.INTR_RAT
        ,T3.REF_MON_INTR_RAT
        ,ABS(DATEDIFF(TO_DATE(T3.APNT_START_DT, 'YYYYMMDD'), TO_DATE(T2.APNT_START_DT, 'yyyyMMdd'), 'dd')) + 1 AS DIFF_TM
        ,CASE
           WHEN ABS(DATEDIFF(TO_DATE(T3.APNT_START_DT, 'YYYYMMDD'), TO_DATE(T2.APNT_START_DT, 'yyyyMMdd'), 'dd')) + 1 < 365 THEN '是'
           ELSE '否'
         END                                                                                                   AS IS_CTN
        ,COALESCE(T4.PFM_CMSN_FEE, 0)                                                                          AS MNG_CMSN_FEE
        ,T1.CTR_BAL_CNY * T1.TRM_MON * ( T2.INTR_RAT - T1.INTR_RAT ) / 100.00                                  AS LN_DCNT_FAV1
        ,T1.CTR_BAL_CNY * T1.TRM_MON * ( T1.REF_MON_INTR_RAT - T1.INTR_RAT ) / 100.00                          AS LN_DCNT_FAV2
FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05 T1 -- 当前笔贷款信息
INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_06 T2 -- 上一笔笔贷款信息
ON      T1.INSU_ID = T2.INSU_ID
INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_07 T3 -- 下一笔贷款信息
ON      T1.INSU_ID = T3.INSU_ID
LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_01 T4 -- 保单手续费
ON      T4.INSU_ID = T1.INSU_ID;
-- 客户保险稳健与审慎标签
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_09;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_09
(
    INSU_ID       STRING COMMENT '保单号'
    ,CST_ID       STRING COMMENT '客户编号'
    ,IS_INSU_STD1 STRING COMMENT '是否保险稳健1'
    ,IS_INSU_STD2 STRING COMMENT '是否保险稳健2'
    ,IS_INSU_STD3 STRING COMMENT '是否保险稳健3'
    ,IS_INSU_PRDT STRING COMMENT '是否保险审慎'
)
COMMENT
'客户保险稳健与审慎标签';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_09
SELECT  T1.INSU_ID
        ,T1.CST_ID
        ,CASE
           WHEN T3.INSU_ID IS NULL OR COALESCE(T2.DIFF_TM, 0) >= 365 THEN '是'
           ELSE '否'
         END AS IS_INSU_STD1 -- 是否保险稳健1
        ,CASE
           WHEN T2.IS_CTN = '是' AND ( T2.INTR_RAT_BF <= T2.INTR_RAT OR T2.REF_MON_INTR_RAT <= T2.INTR_RAT ) THEN '是'
           WHEN ( T2.IS_CTN = '否' OR T2.CST_ID IS NULL ) AND COALESCE(T4.CTR_BAL_CNY, 0) > 0                THEN '是'
           ELSE '否'
         END AS IS_INSU_STD2 -- 是否保险稳健2
        ,CASE
           WHEN T2.IS_CTN = '是' AND T2.LN_DCNT_FAV1 > 0 AND T2.LN_DCNT_FAV2 > 0 AND ( T2.MNG_CMSN_FEE * 0.7 / LEAST(T2.LN_DCNT_FAV1, T2.LN_DCNT_FAV2) ) >= 1.3 THEN '是'
           WHEN T2.IS_CTN = '是' AND T2.LN_DCNT_FAV1 > 0 AND T2.LN_DCNT_FAV2 = 0 AND ( T2.MNG_CMSN_FEE * 0.7 / T2.LN_DCNT_FAV1 ) >= 1.3                         THEN '是'
           WHEN T2.IS_CTN = '是' AND T2.LN_DCNT_FAV1 = 0 AND T2.LN_DCNT_FAV2 > 0 AND ( T2.MNG_CMSN_FEE * 0.7 / T2.LN_DCNT_FAV2 ) >= 1.3                         THEN '是'
           WHEN T2.IS_CTN = '是' AND ( T2.INTR_RAT >= T2.REF_MON_INTR_RAT OR T2.INTR_RAT >= T2.INTR_RAT_BF )                                                    THEN '是'
           WHEN ( T2.IS_CTN = '否' OR T2.CST_ID IS NULL ) AND COALESCE(T4.CTR_BAL_CNY, 0) > 0                                                                   THEN '是'
           ELSE '否'
         END AS IS_INSU_STD3 -- 是否保险稳健3
        ,CASE
           WHEN T3.INSU_ID IS NOT NULL AND T2.IS_CTN = '是' AND T2.LN_DCNT_FAV1 > 0 AND T2.LN_DCNT_FAV2 > 0 AND ( T2.MNG_CMSN_FEE * 0.7 / T2.LN_DCNT_FAV1 ) < 1.3 AND ( T2.MNG_CMSN_FEE * 0.7 / T2.LN_DCNT_FAV2 ) < 1.3 THEN '是'
           ELSE '否'
         END AS IS_INSU_PRDT -- 是否保险审慎
FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_05 T1 -- 当前笔贷款信息
LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_08 T2 -- 客户当前上下笔贷款信息
ON      T2.INSU_ID = T1.INSU_ID
LEFT JOIN    (
                 SELECT  INSU_ID
                 FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 -- 风险控制号客户贷款明细 历史投保
                 WHERE   APNT_START_DT < BF_TRX_DT
                 GROUP BY INSU_ID
             ) T3
ON      T3.INSU_ID = T1.INSU_ID
LEFT JOIN    (
                 SELECT  INSU_ID
                         ,SUM(CTR_BAL_CNY) AS CTR_BAL_CNY
                 FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 -- 风险控制号客户贷款明细 投保前后15天
                 WHERE   APNT_START_DT >= BF_TRX_DT
                 AND     APNT_START_DT <= AF_TRX_DT
                 GROUP BY INSU_ID
             ) T4
ON      T4.INSU_ID = T1.INSU_ID;
-- 客户保险鼓励标签
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_10;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_10
(
    INSU_ID       STRING COMMENT '保单号'
    ,BUS_TYP      STRING COMMENT '保险鼓励1保险鼓励2'
    ,IS_INSU_ECRG STRING COMMENT '是否保险鼓励'
)
COMMENT
'客户保险鼓励标签';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_10
SELECT  T.INSU_ID --保单号
        ,T.BUS_TYP -- 保险鼓励1保险鼓励2
        ,'是' AS IS_AF_LOAN_HIS -- 是否保险鼓励
FROM    (
            -- 投保后15天投保人 同一风险控制号下在我行无任何信贷业务
            SELECT  T1.INSU_ID
                    ,'1' AS BUS_TYP -- 保险鼓励1
            FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02 T1 -- 客户投保日期
            LEFT JOIN    (
                             SELECT  DISTINCT T2.INSU_ID -- 保单号
                             FROM    edw.DIM_BUS_LOAN_CTR_INF_DD T1 -- 信贷合同信息
                             INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03 T2 -- 风险控制号客户信息
                             ON      T2.SAM_CST_ID = T1.CST_ID
                             AND     T1.DT = T2.REL_DT
                             WHERE   SUBSTR(T1.PD_CD, 1, 9) IN ( '201040101' , '201040102' , '201040106' , '201050101' , '201050102' ) -- 流动资金贷款+固定资产贷款+法人购房贷款+个人消费性贷款+个人经营性贷款
                                 OR SUBSTR(T1.PD_CD, 1, 7) IN ( '2010404' , '2010503' ) -- 保理业务+随贷通
                                 OR SUBSTR(T1.PD_CD, 1, 5) = '20108'
                         ) T3
            ON      T3.INSU_ID = T1.INSU_ID
            WHERE   T3.INSU_ID IS NULL
            GROUP BY T1.INSU_ID
            UNION ALL
            -- 投保前后15天内同一风险控制号下的每个客户均无贷款余额
            SELECT  T1.INSU_ID
                    ,'2' AS BUS_TYP -- 保险鼓励2
            FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02 T1 -- 客户投保日期
            LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 T2 -- 风险控制号客户贷款明细
            ON      T2.INSU_ID = T1.INSU_ID
            AND     T2.APNT_START_DT <= T1.AF_TRX_DT
            AND     T2.APNT_START_DT >= T1.BF_TRX_DT
            WHERE   T2.INSU_ID IS NULL
            GROUP BY T1.INSU_ID
            UNION ALL
            SELECT  T1.INSU_ID
                    ,'2' AS BUS_TYP -- 保险鼓励2
            FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02 T1 -- 客户投保日期
            INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_04 T2 -- 风险控制号客户贷款明细
            ON      T2.INSU_ID = T1.INSU_ID
            AND     T2.APNT_START_DT <= T1.AF_TRX_DT
            AND     T2.APNT_START_DT >= T1.BF_TRX_DT
            GROUP BY T1.INSU_ID
             HAVING SUM(T2.CTR_BAL_CNY) = 0
        ) T
GROUP BY T.INSU_ID , T.BUS_TYP;
-- 保险禁止客户
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_11;
CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_11
(
    INSU_ID STRING COMMENT '保单号'
)
COMMENT
'保险禁止客户';
INSERT INTO LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_11
SELECT  DISTINCT T.INSU_ID
FROM    (
            SELECT  DISTINCT T3.INSU_ID
            FROM    (
                        SELECT  T2.INSU_ID
                                ,T1.IDV_CRD_SCO_VAL
                                ,ROW_NUMBER() OVER ( PARTITION BY T2.INSU_ID , T1.CST_ID ORDER BY REPORT_NO DESC ) AS RN
                        FROM    edw.DWS_CST_CCRC_IDV_IND_INF_DD T1 -- 个人征信分
                        INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03 T2 -- 风险控制号下客户
                        ON      T2.SAM_CST_ID = T1.CST_ID
                        WHERE   T2.TRX_DT = T1.DT
                        AND   SUBSTR(T1.REPORT_NO, 1, 8) > '20240325'  -- 新征信报告
                    ) T3
            WHERE   T3.RN = 1
            AND     T3.IDV_CRD_SCO_VAL < 500
            AND     T3.IDV_CRD_SCO_VAL >0
            -- 征信分
            UNION ALL
            SELECT  DISTINCT T2.INSU_ID
            FROM    edw.DWD_BUS_LOAN_CUSTOMER_SPECIAL_DD T1 -- 我行预保预报名单库明细表
            INNER JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_03 T2 -- 风险控制号下客户
            ON      T2.SAM_CST_ID = T1.CUSTOMERID
            WHERE   T2.TRX_DT = T1.DT
            AND     T1.SECTIONTYPE = '40'
            AND     T1.ATTRIBUTE2 IN ( '50' , '60' ) -- 50禁止类60提示类
            AND     T1.INLISTSTATUS = '2' -- 有效
            AND     T1.CUSTOMERID <> ''
        ) T;
ALTER TABLE LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD DROP IF EXISTS PARTITION ( DT = '@@{yyyyMMdd}' );
INSERT INTO TABLE LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD PARTITION (DT = '@@{yyyyMMdd}')
SELECT  T1.INSU_ID AS INSU_ID -- 保单号
        ,T1.CST_ID AS CST_ID -- 客户编号
        ,T1.TRX_DT AS TRX_DT -- 投保日期
        ,CASE
           WHEN T5.INSU_ID IS NOT NULL                                                  THEN '4'
           WHEN T3.IS_INSU_ECRG = '是' OR T4.IS_INSU_ECRG = '是'                          THEN '1'
           WHEN T2.IS_INSU_STD1 = '是' OR T2.IS_INSU_STD2 = '是' OR T2.IS_INSU_STD3 = '是' THEN '2'
           WHEN T2.IS_INSU_PRDT = '是'                                                   THEN '3'
           ELSE ''
         END       AS INSU_LOAN_QUA -- 保险_信贷资质
FROM    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_02 T1 -- 客户投保日期
LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_09 T2 -- 客户稳建与审慎
ON      T2.INSU_ID = T1.INSU_ID
LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_10 T3 -- 客户保险鼓励1
ON      T3.INSU_ID = T1.INSU_ID
AND     T3.BUS_TYP = '1'
LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_10 T4 -- 客户保险鼓励2
ON      T4.INSU_ID = T1.INSU_ID
AND     T4.BUS_TYP = '2'
LEFT JOIN    LAB_BIGDATA_DEV.TMP_ADM_PUB_INSU_QUALF_LAB_DD_11 T5 -- 客户保险禁止
ON      T5.INSU_ID = T1.INSU_ID;***SJ2024042426_公务员贷款清单.sql
--客户职业分类
DROP   TABLE IF     EXISTS SJXQ_SJ2024042426_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042426_CST_01 AS
SElECT cst_id
        else '其他' end ocp_nm
from edw.dws_cst_idv_bas_inf_dd --个人客户基本信息汇总表
where dt = '@@{yyyyMMdd}'
;
--贷款合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042426_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042426_CST_02 AS
select t1.busi_ctr_id                            --业务合同编号|C32
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.intr_rat                                 --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                              --贷款用途代码|C4
    ,t5.cd_val_dscr loan_usg_nm
	,t1.usg_cmt                                  --用途备注|c4
    ,t2.acs_org_id,t2.acs_mngr_id
    ,t3.empe_nm acs_mngr_nm
    ,t4.org_nm,t4.BRC_ORG_NM,t4.BRC_ORG_ID
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t2 --信贷合同管护信息
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='20240423'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  T2.acs_mngr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.acs_org_id=t4.org_id
and t4.BRC_ORG_NM like '%庆元泰隆村镇银行%'
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表
ON  T1.loan_usg_cd = T5.cd_val
AND T5.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND T5.fld_nm = 'LOAN_USG_CD'
AND T5.dt = '@@{yyyyMMdd}'
where t1.dt='20240423'
;
--结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024042426_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042426_CST_03 AS
select BRC_ORG_NM               机构分行
    ,t1.org_nm                  机构名称
    ,t1.acs_mngr_nm             客户经理名称
    ,t1.acs_mngr_id             客户经理工号
	,t1.cst_id                  客户编号
	,t1.cst_nm                  客户名称
    ,t1.busi_ctr_id             业务合同编号
	,t1.apnt_start_dt           约定开始日期
	,t1.apnt_mtu_dt             约定到期日期
	,t1.ctr_amt                 合同金额
	,t1.ctr_bal                 合同余额
	,t1.intr_rat                利率
	,t1.loan_usg_nm             贷款用途
	,t1.usg_cmt                 用途备注
    ,case when t2.ocp_nm='公务员' then '是' else '否' end 是否为公务员贷款
    ,t2.ocp_nm                  职业类别
from SJXQ_SJ2024042426_CST_02       t1
left join SJXQ_SJ2024042426_CST_01  t2
on t1.cst_id=t2.cst_ID
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042426_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024042426_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 业务合同编号) custs
from SJXQ_SJ2024042426_CST_03
;
/*
01	14881405	14881405
02	57811	57811
03	57811	57811
*/***SJ20240425101_银保通手机号.sql
DROP   TABLE IF     EXISTS SJXQ_SJ20240425101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240425101_CST_01 AS
SElECT t1.cst_id                客户号
    ,t1.order_tm                出单时间
    ,case when nvl(t2.mbl_nbr,'')<>'' then t2.mbl_nbr
        else t2.fml_tel_nbr end 手机号
FROM qbi_file_20240428_11_25_29     t1
left join edw.dws_cst_bas_inf_dd    t2  --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
;
***SJ2024042561_眉县村行社区企业信息.sql
--陕西眉县村镇银行 下辖社区
DROP   TABLE IF     EXISTS SJXQ_SJ2024042561_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042561_CST_01 AS
select t1.id                                     --系统id
	,t1.org_id                                   --所属机构id
	,t1.com_name                                 --社区名称
	,t1.branch_id                                --所属分行
	,t1.subbranch_id                             --所属支行
	,t1.team_id                                  --所属团队
	,t1.com_type                                 --社区类型:01: 综合社区，02：综合社区版块，03子社区，04社区单元，05虚拟子社区
    ,decode(t1.com_type,'01','综合社区','02','综合社区版块','03','子社区','04','社区单元','05','虚拟子社区','') com_type_nm
	,t1.com_vindicate_id                         --主维护人id
	,t3.empe_nm             com_vindicate_name   --主维护人名称
	,t1.com_code                                 --社区编码（社区唯一标识）
	,t1.com_state                                --社区状态：1潜在，2正在开发，3有效，4关闭
	,t1.com_genry                                --社区类型
    ,t2.brc_org_nm,t2.SBR_ORG_NM,t2.TEM_ORG_NM
from edw.xwdt_xw_community                  t1    --社区信息表
inner join edw.dim_hr_org_mng_org_tree_dd   t2    --机构树_考核维度
on  t1.org_id = t2.org_id
and t2.dt = '20240424'
and t2.brc_org_nm like '%陕西眉县%'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.com_vindicate_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
where t1.dt = '20240424'
;
--村镇银行 下辖企业
DROP   TABLE IF     EXISTS SJXQ_SJ2024042561_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042561_CST_02 AS
select t1.entid                                  --主体唯一键
	,t1.entname                                  --企业名称
	,t1.socialcreditcode                         --统一社会信用代码
	,t1.legalname                                --法人姓名
	,t1.regcapital                               --注册资金
	,t1.address         reg_addr                 --注册地址
	,t1.entstatuscode                            --企业状态码值 正常 1、异常 2、其他 3
    ,decode(t1.entstatuscode,'1','正常','2','异常','其他') entstatus_nm
	,t1.tel                                      --企业电话
	,t1.enttype                                  --企业类型
    ,decode(t1.enttype,'1','个体工商户','2','注册企业','其他') enttype_nm
	,t1.industrycode                             --行业类型
	,t1.industryname                             --行业名称
	,t1.entsize                                  --企业规模 (1大型企业2中型企业3小型企业4微型企业)
	,t1.com_id                                   --社区ID
    ,t2.brc_org_nm,t2.SBR_ORG_NM,t2.TEM_ORG_NM
    ,t2.com_type_nm,t2.com_name,t2.com_vindicate_name
	,t3.is_official                              --正式/潜在/灰色  0：正式  1：潜在 2：灰色
    ,decode(t3.is_official,'0','正式','1','潜在','未建档客户') cst_type
from edw.xwdt_xw_com_nearbyent      t1              --社区企业信息表
inner join SJXQ_SJ2024042561_CST_01 t2
on t1.com_id=t2.id
left join edw.xwdt_xw_customer      t3
on 	t1.cust_no=t3.cust_no
and t3.dt='20240424'
where t1.dt='20240424'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042561_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042561_CST_03 AS
SElECT brc_org_nm           所属分行
    ,SBR_ORG_NM             所属支行
    ,TEM_ORG_NM             所属团队
	,entname                企业名称
	,legalname              法人姓名
	,socialcreditcode       统一社会信用代码
	,enttype_nm             企业类型
	,reg_addr               注册地址
	,industrycode           行业类型
	,industryname           行业名称
    ,cst_type               客户类型
    ,com_type_nm            社区类型
    ,com_name               社区名称
    ,com_vindicate_name     主维护人名称
from SJXQ_SJ2024042561_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ2024042561_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct entid) custs
from SJXQ_SJ2024042561_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 统一社会信用代码) custs
from SJXQ_SJ2024042561_CST_03
;
/*
01	107	107
02	30655	30655
03	30655	30655
*/
***SJ2024042581_积分物资来源.sql
/*
sunyardmall_orderform  订单表
fundaccounts_no 预算科目：综合积分对应科目编号：810101(生产环境)
payType支付方式：budgetPay（预算支付）
tenant_code 租户（该字段用于区分优选和商城等）：优选的租户对应的字段值为：tloffice
sunyardmall_goods 商品表
business_type：业务类型  对应优选商品字段值为:youxuan
sunyardmall_organzation_adminstration 机构表
orgcode:组织机构代码
org_name:组织机构名称
*/
--行政维度机构信息表
DROP   TABLE IF     EXISTS SJXQ_SJ202402581_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ202402581_CST_01 AS
select id                                     --主键
	,org_code                                 --组织机构代码
	,org_name                                 --组织机构名称
	,xz_level                                 --1、分行、职能部门属于总行 2、村行职能部门、支行属于对应的村行
	,dep_leader                               --部门负责人
	,dep_leader_name                          --部门负责人姓名
from edw.tlsc_sunyardmall_organzation_adminstration --行政维度机构信息表
where dt='@@{yyyyMMdd}'
;
-- 订单信息
DROP   TABLE IF     EXISTS SJXQ_SJ202402581_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ202402581_CST_03 AS
SELECT t1.id
    ,t1.order_id            --订单号
    ,t1.addTime             --下单日期
    ,REPLACE(substr(T1.addtime,1,10),'-','') order_dt
    ,t1.order_status        --订单状态
    ,t1.paytime             --付款时间
    ,t1.shiptime            --发货时间
	,t1.goods_amount                             -- 商品总价格
	,t1.totalprice                               -- 订单总价格
	,t1.user_name                                -- 买家用户姓名
	,t1.integral_all                             --总积分
	,t1.openid                                   --客户号
	,t1.sale_total_price                         --销售总价
	,t1.settle_total_price                       --结算总价
	,t1.settle_commission_amount                 --结算佣金总额
	,t1.integral_price                           --积分对应的现金
	,t1.budget_item                              --预算项目名称
	,t1.budget_item_code                         --预算项目编码
	,t1.budget_org_code                          --预算支付机构
	,t1.org_code                                 --当前用户机构号
	,t1.tenant_code                              --多租户标识
    ,case when t1.tenant_code='tloffice' then 1 else 0 end is_select
	,t1.fundaccounts_no                          --预算科目号
	,t1.channel                                  --渠道类型，超柜：chaogui，手机银行：mobilebank，微信银行：wxbank
	,t1.budget_item_name                         --预算项目名称
	,t1.original_total_price                     --原订单现金总价
	,t1.original_integral_all                    --原订单积分总价
    ,t1.finishtime          --交易完成时间
    ,t1.msg                 --备注
    ,t1.payType
from  edw.tlsc_sunyardmall_orderform    t1
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     REPLACE(substr(T1.addtime,1,10),'-','') between '20230101' and '20240331'
AND     T1.order_status <> '0' --剔除取消订单
and     t1.order_status <>'10' --剔除已提交待付款
and     t1.fundaccounts_no='810101'    --预算科目：综合积分对应科目编号：810101
and     t1.payType='budgetPay'         --支付方式：budgetPay（预算支付）
-- and     t1.tenant_code='tloffice' --租户（该字段用于区分优选和商城等）：优选的租户对应的字段值为：tloffice
;
-- 订单明细 t.id = t2.oid
DROP   TABLE IF     EXISTS SJXQ_SJ202402581_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ202402581_CST_04 AS
SELECT t2.oid               --订单id
    ,t2.goods_id
    ,t2.goods_name          --商品名称
    ,t2.goods_gsp_val       --商品规格
    ,t2.goods_price         --销售价格
    ,t2.goods_count         --销售件数
    ,t2.goods_all_price     --销售金额
from  SJXQ_SJ202402581_CST_03                   t1
inner join edw.tlsc_sunyardmall_orderform_goods t2
on t1.id = t2.oid
and t2.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ202402581_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ202402581_CST_05 AS
SElECT t2.xz_level      分村行名称
    ,t3.goods_name      商品名称
    ,sum(case when is_select=1 and order_dt <='20231231' then t3.goods_all_price else 0 end)    泰隆优选采购金额_2023
    ,sum(case when is_select=1 and order_dt > '20231231' then t3.goods_all_price else 0 end)    泰隆优选采购金额_2024Q1
    ,sum(case when is_select=0 and order_dt <='20231231' then t3.goods_all_price else 0 end)    其他渠道采购金额_2023
    ,sum(case when is_select=0 and order_dt > '20231231' then t3.goods_all_price else 0 end)    其他渠道采购金额_2024Q1
from SJXQ_SJ202402581_CST_03        t1
left join SJXQ_SJ202402581_CST_01   t2
on t1.budget_org_code=t2.org_code
left join SJXQ_SJ202402581_CST_04   t3
on t1.id=t3.oid
group by t2.xz_level ,t3.goods_name
;
-- 输出明细
DROP   TABLE IF     EXISTS SJXQ_SJ202402581_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ202402581_CST_06 AS
SELECT t1.id                        订单id
    ,t1.order_id                    订单号
    ,t1.addTime                     下单日期
    ,t1.order_status                订单状态
	,t1.goods_amount                商品总价格
	,t1.totalprice                  订单总价格
	,t1.sale_total_price            销售总价
	,t1.settle_total_price          结算总价
	,t1.budget_org_code             预算支付机构
    ,t1.tenant_code                 多租户标识
	,t1.fundaccounts_no             预算科目号
	,t1.budget_item_name            预算项目名称
    ,t1.msg                         备注
    ,t1.payType                     支付方式
    ,t2.org_name                    组织机构名称
	,t2.xz_level                    分村行名称
    ,t3.goods_id                    商品ID
    ,t3.goods_name                  商品名称
    ,t3.goods_gsp_val               商品规格
    ,t3.goods_price                 销售价格
    ,t3.goods_count                 销售件数
    ,t3.goods_all_price             销售金额
from SJXQ_SJ202402581_CST_03        t1
left join SJXQ_SJ202402581_CST_01   t2
on t1.budget_org_code=t2.org_code
left join SJXQ_SJ202402581_CST_04   t3
on t1.id=t3.oid
;
SElECT '01' seq, count(1) cnt,count(distinct org_code) custs
from SJXQ_SJ202402581_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ202402581_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct oid,goods_id) custs
from SJXQ_SJ202402581_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 分村行名称,商品名称) custs
from SJXQ_SJ202402581_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 订单id,商品ID) custs
from SJXQ_SJ202402581_CST_06
;
/*
01	4402	4402
03	188	188
04	360	360
05	128	128
06	360	360
--商品信息表
DROP   TABLE IF     EXISTS SJXQ_SJ202402581_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ202402581_CST_02 AS
select id                                       --ID
	,addtime                                  --添加时间，这里为长时间格式
	,goods_choice_type                        --0实体商品，1为虚拟商品
	,goods_current_price                      --商品当前价格,默认等于store_price，参加团购即为团购价，如团购、活动结束后,改价格自动变为store_price
	,goods_name                               --商品名称
	,goods_price                              --style2样式显示9个图像,可以是商品，图片，广告，格式为[{&quot;module_id&quot;:1,&quot;type&quot;:&quot;goods&quot;,&quot;goods_id&quot;:1,&quot;img_url&quot;:&quot;xxxx&quot;,&quot;goods_price&quot;:xxx,&quot;store_price&quot;:xxxx,&quot;href_url&quot;:&quot;xxxx&quot;},{&quot;type&quot;:&quot;adv&quot;,&quot;adv_id&quot;:1},{&quot;type&quot;:&quot;img&quot;,&quot;img_id&quot;:1,&quot;
	,goods_salenum                            --商品售出数量
	,well_evaluate                            --商品好评率,例如：该值为0.96，好评率即为96%
	,gc_id                                    --商品对应的大分类id
	,tenant_code                              --多租户标识
	,display_channel                          --渠道展示，超柜：chaogui，手机银行：mobilebank，微信银行：wxbank,泰e贷:tydloan ,逗号分隔
	,on_sale_time                             --商品上架时间
	,goods_num                                --商品编号
	,business_type                            --业务类型BUSINESS_TYPE（TLSH：生活、TLSC：商城、MEAL：商圈、TUANGOU：团购、GUIJINSHU：贵金属、YOUXUAN：优选、AIXINJUANZHU：爱心捐助、NISHICHUANQI：你是传奇、XINYUANJIA：心愿家、TAIHUISHOU：泰惠收租户销售收款工具商品场景）
from edw.tlsc_sunyardmall_goods               --商品信息表,用来描述系统商品信息
where dt='@@{yyyyMMdd}'
and business_type='youxuan'
and tenant_code='tloffice'
;
*/***SJ2024042616_台州分行代发工资户.sql
--客群
DROP   TABLE IF     EXISTS SJXQ_SJ2024042616_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042616_CST_01 AS
SElECT t1.cst_id                        --客户号|C20
	,t1.act_nm                                   --账户名称|C300
	,t1.act_sts_cd                               --存款账户状态代码|C1
	,t1.stl_act_ind                              --结算账户标志|C1
	,t1.cur_act_bal                              --当前账户余额|DECIMAL(20,2)
	,t1.opn_org                                  --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
	,T2.trx_dt                                   --交易日期|C8
	,T2.trx_tm                                   --交易时间|C9
	,T2.crd_and_dbt_ind                          --借贷标志|C1
	,T2.trx_amt                                  --交易金额|DECIMAL(21,2)
	,T2.act_bal                                  --账户余额|DECIMAL(21,2)
    ,T2.txt_code	                            --摘要代码
    ,T2.smr_dscr	                            --摘要描述
    ,T2.cnt_pty_act_nm	                        --对方户名
    ,T2.cnt_pty_cst_typ_cd	                    --对方客户类型代码
    ,T2.bal_fld_nm	                            --余额字段名称
    ,T2.cmt,t2.dt
    ,t3.cst_act_id,t3.cst_act_nm
    ,t3.opn_dt  cst_opn_dt
from edw.dws_bus_dep_act_inf_dd             T1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   T2
ON  T1.dep_act_id=T2.dep_act_id
AND T2.dt >='20230101'
AND T2.dt <='20240425'
inner join edw.dim_bus_dep_cst_act_inf_dd   T3 --客户存款账户信息
ON  T1.cst_act_id=T3.cst_act_id
and T3.dt='20240425'
WHERE T1.dt ='20240425'
AND (T1.opn_org like  '3301%' or  T1.opn_org like  '9999%')     --台州分行、总行营业部
and concat(T2.smr_dscr,T2.cmt) regexp '代发|工资'
,'2603311521','2603267224','2608630314','2603128280','2000011615','2600683448'
,'2001976195','2002851224','2600932294','2000395681','2000412371') --虚拟账户  不是来我行开户的
;
--客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042616_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042616_CST_02 AS
select t1.cst_id,t1.act_nm
    ,t2.hld_efe_wlth_pd_cnt	                    --持有有效财富产品数
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
	,t5.fund_amt                                 --基金金额
	,t5.fnc_amt                                  --理财金额
	,t5.insu_amt                                 --保险保费
	,t5.wlth_bal                                 --财富资产余额
	,t5.aum_bal                                  --客户综合金融资产aum
	,t5.gold_amt                                 --贵金属近一年金额
	,t5.gold_buy_amt                             --贵金属购买金额 源于 adm_pub.adm_csm_cbus_wlth_nob_met_bus_inf_dd 数据有问题 历史购买小于近1年购买
	,t6.dep_bal                                  --存款余额
	,t6.dep_bal_mon_avg                          --存款余额月日均
	,t7.loan_bal_acs                             --贷款余额
	,t7.loan_bal_acs_mon_avg                    --贷款余额月日均
from(
    SElECT distinct cst_id,act_nm
    from SJXQ_SJ2024042616_CST_01
)t1 left join adm_pub.adm_csm_cbus_pd_hld_inf_dd    t2 --客户集市-标签信息-客户持有产品信息表
on t1.cst_id=t2.cst_id
and t2.dt='20240425'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240425'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240425'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t5 --客户集市-业务信息-客户金融资产信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240425'
left join adm_pub.adm_csm_cbus_dep_inf_dd           t6 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t6.cst_id
and t6.dt='20240425'
left join adm_pub.adm_csm_cbus_loan_inf_dd          t7 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t7.cst_id
and t7.dt='20240425'
;
--贵金属购买金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024042616_CST_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042616_CST_03 AS
SELECT  T1.cst_id
        ,SUM(T1.cmdt_pay_unt_prc)                       gold_buy_amt --购买金额
        ,sum(case when REPLACE(ord_tm,'-','')>'20230425' then cmdt_pay_unt_prc else 0 end) gold_amt_1y
FROM    adm_pub.adm_pub_cst_nob_met_trx_sum_di T1 --贵金属交易整合表
WHERE   dt<= '20240425'
and REPLACE(ord_tm,'-','')<= '20240425'
GROUP BY T1.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024042616_CST_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042616_CST_04 AS
select t1.cst_id                              代发客户号
    ,act_nm                                   客户名字
    ,PRM_MGR_ID                               管户客户经理工号
    ,PRM_MGR_NM                               管户客户经理名字
    ,PRM_ORG_ID                               管户机构号
    ,ORG_NM                                   管户机构名称
	,aum_bal                                  客户综合金融资产aum
	,wlth_bal                                 财富资产余额
	,dep_bal                                  存款余额
	,dep_bal_mon_avg                          存款余额月日均
	,loan_bal_acs                             贷款余额
	,loan_bal_acs_mon_avg                     贷款余额月日均
	,fnc_amt                                  理财金额
	,fund_amt                                 基金金额
	,insu_amt                                 保险保费
	,nvl(t2.gold_buy_amt,0)                   贵金属购买金额
    ,hld_efe_wlth_pd_cnt	                  持有有效财富产品数
from SJXQ_SJ2024042616_CST_02       t1
left join SJXQ_SJ2024042616_CST_03  t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042616_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042616_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042616_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 代发客户号) custs
from SJXQ_SJ2024042616_CST_04
;
/*
01	941051	100595
02	100595	100595
03	51613	51613
04	100595	100595
*/
***SJ2024042691_政和村行他行贷款信息.sql
--征信 贷款明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024042691_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042691_CST_01 AS
select id           --账务ID
    ,report_id      --报告编号
    ,cst_id         --客户号
    ,start_dt       --贷款开始日期
    ,mtu_dt         --贷款结束日期
    ,case when grnt_mth_cd='1' then '质押'
        when grnt_mth_cd='2' then '抵押'
        when grnt_mth_cd='3' then '保证'
        when grnt_mth_cd='4' then '信用/无担保'
        when grnt_mth_cd='5' then '组合(含保证)'
        when grnt_mth_cd='6' then '组合(不含保证)'
        when grnt_mth_cd='7' then '农户联保'
        when grnt_mth_cd='9' then '其他'
        else grnt_mth_cd
        end grnt_mth_cd     --担保方式
    ,ctr_amt                --贷款金额
    ,ctr_bal                --贷款余额
    ,act_crd_lmt	        --账户授信额度
    ,ACT_TYP_CD
    ,SUBSTR(report_id,1,8)  report_dt
    ,DENSE_RANK() over(partition by cst_id order by SUBSTR(report_id,1,8) desc) as rk
from edw.dim_cst_ccrc_idv_loan_inf_dd --个人征信客户贷款信息
where dt='20240508'
and nvl(cst_id,'')<>''
and dtrb_org <> 'ZJTLCB'                   --他行
union all
select id --账务ID
    ,report_id --报告编号
    ,cst_id --客户号
    ,loan_start_dt --贷款开始日期
    ,loan_mtu_dt  --贷款结束日期
    ,CASE
        WHEN grnt_mth_cd = '0' THEN '信用/免担保'
        WHEN grnt_mth_cd = '1' THEN '保证'
        WHEN grnt_mth_cd = '2' THEN '质押'
        WHEN grnt_mth_cd = '3' THEN '抵押'
        WHEN grnt_mth_cd = '4' THEN '组合'
        ELSE grnt_mth_cd
        END  GRNT_MTH_NM --担保方式
    ,loan_amt	--贷款金额
    ,loan_bal   --贷款余额
    ,crd_lmt	--信用额度
    ,ACT_TYP
    ,SUBSTR(report_id,1,8)  report_dt
    ,DENSE_RANK() over(partition by cst_id order by SUBSTR(report_id,1,8) desc) as rk
from  edw.dim_cst_ccrc_entp_loan_inf_dd --企业征信客户贷款信息
where dt='20240508'
and nvl(cst_id,'')<>''
and length(DTRB_ORG_CD)='4' --他行
;
--征信 利率
DROP   TABLE IF     EXISTS SJXQ_SJ2024042691_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042691_CST_02 AS
select cst_id,report_no,irr,id
--,DENSE_RANK()over(partition by cst_id order by SUBSTR(report_no,1,8) desc) as rk
from lab_bigdata_dev.zx_rate_result_all_di
where dt<='20240508'
union all
select cst_id,report_no,irr,id
--,DENSE_RANK()over(partition by cst_id order by SUBSTR(report_no,1,8) desc) as rk
from lab_bigdata_dev.zx_rate_result_ent_di
where dt<='20240508'
;
-- 征信查询时间
DROP   TABLE IF     EXISTS SJXQ_SJ2024042691_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042691_CST_03 AS
select coalesce(SUBSTR(a.customer_id, 1, 10), b.cst_id) as cst_id
    ,a.query_time
from edw.ncip_cpq_resultinfo as a
left join (
    SELECT  DOC_NBR
        ,MAX(CST_ID) AS CST_ID
    FROM    edw.DIM_CST_BAS_DOC_INF_DD
    WHERE   DT = '20240508'
    GROUP BY DOC_NBR
) as b
on a.cert_no = b.doc_nbr
where a.dt<='20240508'
AND a.ERROR_INFO = '查询成功'
union all
SELECT DISTINCT COALESCE(SUBSTR(T1.customer_id, 1, 10), T4.CST_ID, C1.CST_ID, C2.CST_ID, C3.CST_ID, C4.CST_ID, C5.CST_ID) 客户号
    ,T1.query_time
FROM    edw.ncip_ceq_resultinfo T1 --企业信用报告查询记录
LEFT JOIN    (
    SELECT  'ZHONGZHENGMA'   AS DOC_TYP_CD --无此证件类型
            ,LOANCARDNO
            ,MAX(CUSTOMERID) AS CST_ID
    FROM    edw.LOAN_CUSTOMER_INFO
    WHERE   DT = '20240508'
    GROUP BY LOANCARDNO
) T4
ON      T1.loancard_code = T4.LOANCARDNO
LEFT JOIN    edw.DIM_CST_BAS_DOC_INF_DD C1
ON      T1.US_CREDIT_CODE = C1.DOC_NBR
AND     C1.DOC_TYP_CD = 'A0100' --统一社会信用代码
AND     C1.DT = '20240508'
LEFT JOIN    edw.DIM_CST_BAS_DOC_INF_DD C2
ON      T1.COPR_CODE = C2.DOC_NBR
AND     C2.DOC_TYP_CD = 'A0200' --组织机构代码
AND     C2.DT = '20240508'
LEFT JOIN    edw.DIM_CST_BAS_DOC_INF_DD C3
ON      T1.ORG_CREDIT_CODE = C3.DOC_NBR
AND     C3.DOC_TYP_CD = 'A2200' --机构信用代码
AND     C3.DT = '20240508'
LEFT JOIN    edw.DIM_CST_BAS_DOC_INF_DD C4
ON      T1.GS_REGI_CODE = C4.DOC_NBR
AND     C4.DOC_TYP_CD = 'A1400' --国税
AND     C4.DT = '20240508'
LEFT JOIN    edw.DIM_CST_BAS_DOC_INF_DD C5
ON      T1.DS_REGI_CODE = C5.DOC_NBR
AND     C5.DOC_TYP_CD = 'A1500' --地税
AND     C5.DT = '20240508'
WHERE   T1.DT <= '20240508'
AND     T1.ERROR_INFO = '查询成功'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042691_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042691_CST_04 AS
SELECT t1.cst_id,t1.cst_nm
    ,T1.PRM_MGR_ID,T1.PRM_MGR_NM,T1.PRM_ORG_ID
    ,T2.BRC_ORG_NM,T2.SBR_ORG_NM,T2.TEM_ORG_NM,T2.ORG_NM
    ,t3.report_id               --报告编号
    ,t3.start_dt                --贷款开始日期
    ,t3.mtu_dt                  --贷款结束日期
    ,t3.grnt_mth_cd             --担保方式
    ,t3.ctr_amt                 --贷款金额
    ,t3.ctr_bal                 --贷款余额
    ,t3.act_crd_lmt	            --账户授信额度
    ,t3.act_typ_cd              --账户类型
    ,decode(t3.act_typ_cd,'R1','循环贷账户' ,'R2','贷记卡账户' ,'R3','准贷记卡账户' ,'R4','循环额度下分账户') act_typ_nm
    ,t3.report_dt               --最新报告日期
    ,case when t4.irr='-9999' or t4.irr is null then '' else irr end 他行贷款利率
    ,t5.query_time
from adm_pub_app.adm_pblc_cst_prm_mng_inf_dd    t1 --客户`主管户`信息
inner join edw.dim_hr_org_mng_org_tree_dd       t2 --考核机构树
on  t1.prm_org_id = t2.org_id
and t2.dt = '20240508'
and t2.brc_org_nm regexp '福建政和泰隆村镇'
inner join SJXQ_SJ2024042691_CST_01             t3
on t1.cst_id=t3.cst_id
and t3.rk=1
left join SJXQ_SJ2024042691_CST_02              t4
on  t3.report_id=t4.report_no
and t3.id=t4.id
left join(
    SElECT cst_id,query_time
        ,row_number() over(partition by cst_id order by query_time desc) rn
    from SJXQ_SJ2024042691_CST_03
)t5 on t1.cst_id=t5.cst_id
and t5.rn=1                 --取最近一次查询时间
where t1.dt = '20240508'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024042691_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042691_CST_05 AS
SELECT cst_id               客户号
    ,cst_nm                 客户名称
    ,BRC_ORG_NM             分行
    ,report_id              报告编号
    ,start_dt               贷款开始日期
    ,mtu_dt                 贷款结束日期
    ,grnt_mth_cd            担保方式
    ,ctr_amt                贷款金额
    ,ctr_bal                贷款余额
    ,act_crd_lmt	        账户授信额度
    ,act_typ_cd             账户类型代码
    ,act_typ_nm             账户类型名称
    ,他行贷款利率
    ,query_time             最近一次征信查询时间
from SJXQ_SJ2024042691_CST_04
where ctr_amt<=200000
;
SElECT '01' seq, count(1) cnt,count(distinct report_id,cst_id,start_dt) custs
from SJXQ_SJ2024042691_CST_01 where rk=1
union all
SElECT '02' seq, count(1) cnt,count(distinct report_no,id) custs
from SJXQ_SJ2024042691_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,query_time) custs
from SJXQ_SJ2024042691_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042691_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024042691_CST_05
;
/*
01	41009483	30953180
02	54070232	54070232
03	27167740	27079074
04	263951	22355
05	259513	22245
*/
***SJ2024042901_泰隆生活黄金团购剔员工.sql
--客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_01;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_01 AS
select t1.cst_id                                 --客户号
	,t1.gdr_cd                                   --性别代码
    ,decode(t1.gdr_cd,'1','男','2','女','未知')     gdr_nm
	,t1.age                                      --年龄
    ,case when t1.age<=30               then '1 <=30'
        when t1.age >30 and t1.age <=40 then '2 30<x<=40'
        when t1.age >40 and t1.age <=50 then '3 40<x<=50'
        when t1.age >50 and t1.age <=60 then '4 50<x<=60'
        when t1.age >60                 then '5 >60'
        else '' end age_grd
	,t1.org_mngr_id                              --管户机构         主管护机构号
	,t1.org_mngr_nm                              --管户机构名称
	,t1.acs_mngr_id                              --管户客户经理     主管护客户经理工号
	,t1.acs_mngr_nm                              --管户客户经理名称
	,t2.prm_mgr_id                               --主管护客户经理工号
	,t2.prm_mgr_nm                               --主管护客户经理姓名
	,t2.prm_org_id                               --主管护机构号
	,t2.prm_org_nm                               --主管户机构名称
	,t2.forml_cst_ind                            --正式客户标识
    ,t1.own_emp_id
    ,case when length(t1.own_emp_id)>0 then 1 else 0 end is_empe
	,t3.aum_grd                                  --财富等级:1-一星客户,2-二星客户,3-三星客户,4-四星客户,5-五星客户,6-六星客户
	,t3.cst_typ_cd                               --客户类型代码:1对私,2对公
    ,t4.brc_org_id,t4.brc_org_nm,t4.sbr_org_nm
    ,t5.cst_seg_flg
    ,decode(t5.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') cst_seg
	,t6.pnt_bal                                  --积分余额|decimal(21,2)
    ,round(t6.pnt_bal/100,2)    pnt_bal_rmb
    ,case when t6.pnt_bal>=10000 and t6.pnt_bal<=50000    then '1 100<=x<=500'
        when t6.pnt_bal>50000  and t6.pnt_bal<=100000     then '2 500<x<=1000'
        when t6.pnt_bal>100000 and t6.pnt_bal<=300000     then '3 1000<x<=3000'
        when t6.pnt_bal>300000 and t6.pnt_bal<=500000     then '4 3000<x<=5000'
        when t6.pnt_bal>500000 and t6.pnt_bal<=1000000    then '5 5000<x<=10000'
        when t6.pnt_bal>1000000 and t6.pnt_bal<=5000000   then '6 10000<x<=50000'
        when t6.pnt_bal>5000000                           then '7 >50000'
        else '' end pnt_bal_grd
from adm_pub.adm_csm_cbas_idv_bas_inf_dd        t1 --客户集市-客户基础-对私客户基础信息
left join adm_pub.adm_csm_cbas_mng_inf_dd       t2 --客户集市-客户基础-客户管户信息
on  t1.cst_id=t2.cst_id
and t2.dt='20240429'
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd   t3 --客户集市-基础信息-客户等级信息
on  t1.cst_id=t3.cst_id
and t3.dt='20240429'
inner join edw.dim_hr_org_mng_org_tree_dd       t4 --考核机构树
on  t1.org_mngr_id = t4.org_id
and t4.dt = '20240429'
and t4.brc_org_nm not like '%村镇银行%'     --剔除村行
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t5 --客户标签信息
on  t1.cst_id=t5.cst_id
and t5.dt='20240429'
left join edw.dim_bus_cmpn_pnt_act_inf_dd       t6 --积分账户信息
on t1.cst_id=t6.cst_id
and t6.dt='20240429'
and t6.pnt_typ_cd='0001'
where t1.dt='20240429'
;
--泰隆生活交易客户画像
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_02;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_02 AS
select ord_id                                 --订单号|C255
	,prm_ord_id                               --主订单标识|C11
	,ord_sts_cd                               --订单状态代码|C11
	,add_tm                                   --添加时间|C30
    ,substr(replace(add_tm,'-',''),1,8)     add_dt
	,del_ind                                  --删除标志|C11
	,cfm_tm                                   --确认收货时间|C30
	,cmdt_tot_prc                             --商品总价格|decimal(12,2)
	,ord_tot_prc                              --订单总价格|decimal(12,2)
	,trx_seq                                  --交易流水号|C255
	,cst_id                                   --客户号|C20
	,actv_id                                  --活动ID|C11
	,actv_nm                                  --活动名称|C255
	,cmdt_inf                                 --商品信息|LONGTEXT
	,cmdt_spec                                --商品规格|C50
	,cmdt_spec_chn                            --商品规格中文|500
	,cmdt_nm                                  --商品名称|C255
from edw.dwd_bus_cmpn_pnt_mall_ord_srl_dd     --积分商城订单流水明细
where dt='20240429'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_03;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_03 AS
SElECT t1.cst_id,t1.fst_view_dt
	,t2.efe_dep_cst_ind                          --有效存款户标识
	,t2.efe_loan_cst_ind                         --有效信贷户标识
	,t2.efe_chm_cst_ind                          --有效理财户标识
from(
    SElECT cst_id,min(add_dt) fst_view_dt
    from SJXQ_SJ2024042901_CST_02
    group by cst_id
)t1 inner join adm_pub.adm_csm_cbas_ind_inf_dd	t2 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t2.cst_id
and t1.fst_view_dt=t2.dt
and t2.dt<='20240429'
;
-- 黄金、珍珠团购浏览客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_04;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_04 AS
SELECT t1.event	                --事件名
    ,t1.offical_customerid cst_id --正客客户号
    ,t1.province	            --省份
    ,t1.title	                --页面标题
    ,t1.activity_id	            --活动ID
    ,case when t1.activity_id='181' then '黄金团购'
        else '珍珠团购' end     tg_typ
    ,t1.activity_name	        --活动名称
    ,t1.page_name	            --页面名称
    ,t1.commodity_sku	        --商品规格
    ,t1.dt                  --最小 20240424
from edw.aubs_events_tlsh       t1 --泰隆商城事件表
where dt>='20240401'
and source_channel = 'tlshxcx'  --渠道来源
and system_connect = '泰隆生活'  --接入系统
and scene_type ='团购'          --场景、频道类型
and t1.event <> 'life_commodity_exposure'   --剔除曝光
and nvl(t1.offical_customerid,'')<>''       --客户号非空
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_05;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_05 AS
SElECT t1.cst_id,t1.tg_typ,t1.fst_view_dt
	,t2.efe_dep_cst_ind                          --有效存款户标识
	,t2.efe_loan_cst_ind                         --有效信贷户标识
	,t2.efe_chm_cst_ind                          --有效理财户标识
from(
    SElECT cst_id,tg_typ,min(dt) fst_view_dt
    from SJXQ_SJ2024042901_CST_04
    group by cst_id,tg_typ
)t1 inner join adm_pub.adm_csm_cbas_ind_inf_dd	t2 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t2.cst_id
and t1.fst_view_dt=t2.dt
and t2.dt<='20240429'
;
--客户历史保险金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_06;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_06 AS
SElECT cst_id,sum(insu_fee) his_insu_fee
from edw.dwd_bus_insu_plcy_insu_inf_dd
where dt = '20240429'
and insu_dt < '20240429'
and insu_fee<>0
group by cst_id
;
--贵金属交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_07;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_07 AS
SELECT CST_ID,SUM(cmdt_pay_unt_prc) GOLD_TRX_TOT_AMT
FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di	--贵金属交易整合表
WHERE DT<='20240429'
and nvl(cst_id,'')<>''   --客户号非空
and cmdt_pay_unt_prc<>0
GROUP BY CST_ID
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_08;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_08 AS
-- 黄金团购浏览客户信息
SElECT t1.cst_id,t1.fst_view_dt,t1.tg_typ
	,t1.efe_dep_cst_ind                          --有效存款户标识
	,t1.efe_loan_cst_ind                         --有效信贷户标识
	,t1.efe_chm_cst_ind                          --有效理财户标识
	,t2.gdr_cd                                   --性别代码
    ,t2.gdr_nm
	,t2.age                                      --年龄
    ,t2.age_grd,t2.aum_grd
    ,t2.brc_org_id,t2.brc_org_nm,t2.sbr_org_nm,t2.acs_mngr_id  --客户经理工号
    ,t2.forml_cst_ind
    ,case when t2.pnt_bal<>0 then 1 else 0 end is_jf_cst
    ,case when t3.cst_id is not null then 1 else 0 end is_hisinsu_cst
    ,case when t4.cst_id is not null then 1 else 0 end is_hisgold_cst
from SJXQ_SJ2024042901_CST_05       t1
inner join SJXQ_SJ2024042901_CST_01 t2
on t1.cst_id=t2.cst_id
and t2.is_empe=0        --剔除员工
left join SJXQ_SJ2024042901_CST_06  t3 --保险
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024042901_CST_07  t4 --贵金属
on t1.cst_id=t4.cst_id
where t1.tg_typ='黄金团购'
union all
-- 珍珠团购浏览客户信息 字段汇总
SElECT t1.cst_id,t1.fst_view_dt,t1.tg_typ
	,t1.efe_dep_cst_ind                          --有效存款户标识
	,t1.efe_loan_cst_ind                         --有效信贷户标识
	,t1.efe_chm_cst_ind                          --有效理财户标识
	,t2.gdr_cd                                   --性别代码
    ,t2.gdr_nm
	,t2.age                                      --年龄
    ,t2.age_grd,t2.aum_grd
    ,t2.brc_org_id,t2.brc_org_nm,t2.sbr_org_nm,t2.acs_mngr_id  --客户经理工号
    ,t2.forml_cst_ind
    ,case when t2.pnt_bal<>0 then 1 else 0 end is_jf_cst
    ,case when t3.cst_id is not null then 1 else 0 end is_hisinsu_cst
    ,case when t4.cst_id is not null then 1 else 0 end is_hisgold_cst
from SJXQ_SJ2024042901_CST_05       t1
inner join SJXQ_SJ2024042901_CST_01 t2
on t1.cst_id=t2.cst_id
and t2.is_empe=0        --剔除员工
left join SJXQ_SJ2024042901_CST_06  t3 --保险
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024042901_CST_07  t4 --贵金属
on t1.cst_id=t4.cst_id
where t1.tg_typ='珍珠团购'
union all
-- 泰隆生活历史交易客户画像
SElECT t1.cst_id,t1.fst_view_dt,'泰隆生活' tg_typ
	,t1.efe_dep_cst_ind                          --有效存款户标识
	,t1.efe_loan_cst_ind                         --有效信贷户标识
	,t1.efe_chm_cst_ind                          --有效理财户标识
	,t2.gdr_cd                                   --性别代码
    ,t2.gdr_nm
	,t2.age                                      --年龄
    ,t2.age_grd,t2.aum_grd
    ,t2.brc_org_id,t2.brc_org_nm,t2.sbr_org_nm,t2.acs_mngr_id  --客户经理工号
    ,t2.forml_cst_ind
    ,case when t2.pnt_bal<>0 then 1 else 0 end is_jf_cst
    ,case when t3.cst_id is not null then 1 else 0 end is_hisinsu_cst
    ,case when t4.cst_id is not null then 1 else 0 end is_hisgold_cst
from SJXQ_SJ2024042901_CST_03       t1
inner join SJXQ_SJ2024042901_CST_01 t2
on t1.cst_id=t2.cst_id
and t2.is_empe=0        --剔除员工
left join SJXQ_SJ2024042901_CST_06  t3 --保险
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024042901_CST_07  t4 --贵金属
on t1.cst_id=t4.cst_id
;
-- 单个客户经理最多客户数
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_09;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_09 AS
SElECT tg_typ,brc_org_nm,acs_mngr_id,count(distinct cst_id) per_mng_csts
    ,row_number() over(partition by tg_typ,brc_org_nm order by count(distinct cst_id) desc)rn
from SJXQ_SJ2024042901_CST_08
group by tg_typ,brc_org_nm,acs_mngr_id
union all
SElECT tg_typ,'全行',acs_mngr_id,count(distinct cst_id) per_mng_csts
    ,row_number() over(partition by tg_typ order by count(distinct cst_id) desc)rn
from SJXQ_SJ2024042901_CST_08
group by tg_typ,acs_mngr_id
;
--输出结果
-- 1. 黄金团购
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_10;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_10 AS
SElECT '黄金团购' as type
    ,t1.*
    ,t2.per_mng_csts            单个客户经理最多客户数
    ,t2.acs_mngr_id             最多客户数经理工号
from(
    SElECT brc_org_id,brc_org_nm                                            分行
        ,count(cst_id)                                                      总人数
        ,count(case when forml_cst_ind='1' then cst_id end)                 正式客户数
        ,sum(is_jf_cst)                                                     有积分客户数
        ,round(avg(case when gdr_cd='2' then age end),2)                        平均年龄_女性
        ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
        ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
        ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
        ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
        ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
        ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
        ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
        ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
        ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
        ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
        ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
        ,count(case when efe_dep_cst_ind    ='1' then cst_id end)   最早浏览时点有效存款户数
        ,count(case when efe_chm_cst_ind    ='1' then cst_id end)   最早浏览时点有效理财户数
        ,count(case when efe_loan_cst_ind   ='1' then cst_id end)   最早浏览时点有效信贷户数
        ,sum(is_hisinsu_cst)                                历史有保险订单客户数
        ,sum(is_hisgold_cst)                                历史有贵金属交易客户数
        ,count(distinct acs_mngr_id)                        客户背后的客户经理数
        ,count(distinct sbr_org_nm)                         客户背后的支行数
        ,count(case when aum_grd='1' then cst_id end)       一星客户数
        ,count(case when aum_grd='2' then cst_id end)       二星客户数
        ,count(case when aum_grd='3' then cst_id end)       三星客户数
        ,count(case when aum_grd='4' then cst_id end)       四星客户数
        ,count(case when aum_grd='5' then cst_id end)       五星客户数
        ,count(case when aum_grd='6' then cst_id end)       六星客户数
    from SJXQ_SJ2024042901_CST_08 t1
    where tg_typ='黄金团购'
    group by brc_org_id,brc_org_nm
    union all
    SElECT 'ALL','全行'                                                     分行
        ,count(cst_id)                                                      总人数
        ,count(case when forml_cst_ind='1' then cst_id end)                 正式客户数
        ,sum(is_jf_cst)                                                     有积分客户数
        ,round(avg(case when gdr_cd='2' then age end),2)                        平均年龄_女性
        ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
        ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
        ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
        ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
        ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
        ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
        ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
        ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
        ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
        ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
        ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
        ,count(case when efe_dep_cst_ind    ='1' then cst_id end)   最早浏览时点有效存款户数
        ,count(case when efe_chm_cst_ind    ='1' then cst_id end)   最早浏览时点有效理财户数
        ,count(case when efe_loan_cst_ind   ='1' then cst_id end)   最早浏览时点有效信贷户数
        ,sum(is_hisinsu_cst)                                历史有保险订单客户数
        ,sum(is_hisgold_cst)                                历史有贵金属交易客户数
        ,count(distinct acs_mngr_id)                        客户背后的客户经理数
        ,count(distinct sbr_org_nm)                         客户背后的支行数
        ,count(case when aum_grd='1' then cst_id end)       一星客户数
        ,count(case when aum_grd='2' then cst_id end)       二星客户数
        ,count(case when aum_grd='3' then cst_id end)       三星客户数
        ,count(case when aum_grd='4' then cst_id end)       四星客户数
        ,count(case when aum_grd='5' then cst_id end)       五星客户数
        ,count(case when aum_grd='6' then cst_id end)       六星客户数
    from SJXQ_SJ2024042901_CST_08 t1
    where tg_typ='黄金团购'
)t1 left join SJXQ_SJ2024042901_CST_09 t2
on t1.分行=t2.brc_org_nm
and t2.tg_typ='黄金团购'
and t2.rn=1
;
-- 2. 泰隆生活
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_11;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_11 AS
SElECT '泰隆生活' as type
    , t1.*
    ,t2.per_mng_csts            单个客户经理最多客户数
    ,t2.acs_mngr_id             最多客户数经理工号
from(
    SElECT brc_org_id,brc_org_nm                                            分行
        ,count(cst_id)                                                      总人数
        ,count(case when forml_cst_ind='1' then cst_id end)                 正式客户数
        ,sum(is_jf_cst)                                                     有积分客户数
        ,round(avg(case when gdr_cd='2' then age end),2)                        平均年龄_女性
        ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
        ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
        ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
        ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
        ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
        ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
        ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
        ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
        ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
        ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
        ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
        ,count(case when efe_dep_cst_ind    ='1' then cst_id end)   最早浏览时点有效存款户数
        ,count(case when efe_chm_cst_ind    ='1' then cst_id end)   最早浏览时点有效理财户数
        ,count(case when efe_loan_cst_ind   ='1' then cst_id end)   最早浏览时点有效信贷户数
        ,sum(is_hisinsu_cst)                                历史有保险订单客户数
        ,sum(is_hisgold_cst)                                历史有贵金属交易客户数
        ,count(distinct acs_mngr_id)                        客户背后的客户经理数
        ,count(distinct sbr_org_nm)                         客户背后的支行数
        ,count(case when aum_grd='1' then cst_id end)       一星客户数
        ,count(case when aum_grd='2' then cst_id end)       二星客户数
        ,count(case when aum_grd='3' then cst_id end)       三星客户数
        ,count(case when aum_grd='4' then cst_id end)       四星客户数
        ,count(case when aum_grd='5' then cst_id end)       五星客户数
        ,count(case when aum_grd='6' then cst_id end)       六星客户数
    from SJXQ_SJ2024042901_CST_08 t1
    where tg_typ='泰隆生活'
    group by brc_org_id,brc_org_nm
    union all
    SElECT 'ALL','全行'                                                     分行
        ,count(cst_id)                                                      总人数
        ,count(case when forml_cst_ind='1' then cst_id end)                 正式客户数
        ,sum(is_jf_cst)                                                     有积分客户数
        ,round(avg(case when gdr_cd='2' then age end),2)                        平均年龄_女性
        ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
        ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
        ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
        ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
        ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
        ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
        ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
        ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
        ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
        ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
        ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
        ,count(case when efe_dep_cst_ind    ='1' then cst_id end)   最早浏览时点有效存款户数
        ,count(case when efe_chm_cst_ind    ='1' then cst_id end)   最早浏览时点有效理财户数
        ,count(case when efe_loan_cst_ind   ='1' then cst_id end)   最早浏览时点有效信贷户数
        ,sum(is_hisinsu_cst)                                历史有保险订单客户数
        ,sum(is_hisgold_cst)                                历史有贵金属交易客户数
        ,count(distinct acs_mngr_id)                        客户背后的客户经理数
        ,count(distinct sbr_org_nm)                         客户背后的支行数
        ,count(case when aum_grd='1' then cst_id end)       一星客户数
        ,count(case when aum_grd='2' then cst_id end)       二星客户数
        ,count(case when aum_grd='3' then cst_id end)       三星客户数
        ,count(case when aum_grd='4' then cst_id end)       四星客户数
        ,count(case when aum_grd='5' then cst_id end)       五星客户数
        ,count(case when aum_grd='6' then cst_id end)       六星客户数
    from SJXQ_SJ2024042901_CST_08 t1
    where tg_typ='泰隆生活'
)t1 left join SJXQ_SJ2024042901_CST_09 t2
on t1.分行=t2.brc_org_nm
and t2.tg_typ='泰隆生活'
and t2.rn=1
;
-- 3. 珍珠团购
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_12;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_12 AS
SElECT '珍珠团购' as type
    , t1.*
    ,t2.per_mng_csts            单个客户经理最多客户数
    ,t2.acs_mngr_id             最多客户数经理工号
from(
    SElECT brc_org_id,brc_org_nm                                            分行
        ,count(cst_id)                                                      总人数
        ,count(case when forml_cst_ind='1' then cst_id end)                 正式客户数
        ,sum(is_jf_cst)                                                     有积分客户数
        ,round(avg(case when gdr_cd='2' then age end),2)                        平均年龄_女性
        ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
        ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
        ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
        ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
        ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
        ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
        ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
        ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
        ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
        ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
        ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
        ,count(case when efe_dep_cst_ind    ='1' then cst_id end)   最早浏览时点有效存款户数
        ,count(case when efe_chm_cst_ind    ='1' then cst_id end)   最早浏览时点有效理财户数
        ,count(case when efe_loan_cst_ind   ='1' then cst_id end)   最早浏览时点有效信贷户数
        ,sum(is_hisinsu_cst)                                历史有保险订单客户数
        ,sum(is_hisgold_cst)                                历史有贵金属交易客户数
        ,count(distinct acs_mngr_id)                        客户背后的客户经理数
        ,count(distinct sbr_org_nm)                         客户背后的支行数
        ,count(case when aum_grd='1' then cst_id end)       一星客户数
        ,count(case when aum_grd='2' then cst_id end)       二星客户数
        ,count(case when aum_grd='3' then cst_id end)       三星客户数
        ,count(case when aum_grd='4' then cst_id end)       四星客户数
        ,count(case when aum_grd='5' then cst_id end)       五星客户数
        ,count(case when aum_grd='6' then cst_id end)       六星客户数
    from SJXQ_SJ2024042901_CST_08 t1
    where tg_typ='珍珠团购'
    group by brc_org_id,brc_org_nm
    union all
    SElECT 'ALL','全行'                                                     分行
        ,count(cst_id)                                                      总人数
        ,count(case when forml_cst_ind='1' then cst_id end)                 正式客户数
        ,sum(is_jf_cst)                                                     有积分客户数
        ,round(avg(case when gdr_cd='2' then age end),2)                        平均年龄_女性
        ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
        ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
        ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
        ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
        ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
        ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
        ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
        ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
        ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
        ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
        ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
        ,count(case when efe_dep_cst_ind    ='1' then cst_id end)   最早浏览时点有效存款户数
        ,count(case when efe_chm_cst_ind    ='1' then cst_id end)   最早浏览时点有效理财户数
        ,count(case when efe_loan_cst_ind   ='1' then cst_id end)   最早浏览时点有效信贷户数
        ,sum(is_hisinsu_cst)                                历史有保险订单客户数
        ,sum(is_hisgold_cst)                                历史有贵金属交易客户数
        ,count(distinct acs_mngr_id)                        客户背后的客户经理数
        ,count(distinct sbr_org_nm)                         客户背后的支行数
        ,count(case when aum_grd='1' then cst_id end)       一星客户数
        ,count(case when aum_grd='2' then cst_id end)       二星客户数
        ,count(case when aum_grd='3' then cst_id end)       三星客户数
        ,count(case when aum_grd='4' then cst_id end)       四星客户数
        ,count(case when aum_grd='5' then cst_id end)       五星客户数
        ,count(case when aum_grd='6' then cst_id end)       六星客户数
    from SJXQ_SJ2024042901_CST_08 t1
    where tg_typ='珍珠团购'
)t1 left join SJXQ_SJ2024042901_CST_09 t2
on t1.分行=t2.brc_org_nm
and t2.tg_typ='珍珠团购'
and t2.rn=1
;
-- 4. 积分大于100人民币的客户数情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_13;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_13 AS
SElECT ' 积分大于100人民币' as type,
    brc_org_id,brc_org_nm                                            分行
    ,count(distinct cst_id)                                             总人数
    ,count(case when pnt_bal_grd='1 100<=x<=500' then cst_id end)       客户数_100_500
    ,count(case when pnt_bal_grd='2 500<x<=1000' then cst_id end)       客户数_500_1000
    ,count(case when pnt_bal_grd='3 1000<x<=3000' then cst_id end)      客户数_1000_3000
    ,count(case when pnt_bal_grd='4 3000<x<=5000' then cst_id end)      客户数_3000_5000
    ,count(case when pnt_bal_grd='5 5000<x<=10000' then cst_id end)     客户数_5000_1万
    ,count(case when pnt_bal_grd='6 10000<x<=50000' then cst_id end)    客户数_1万_5万
    ,count(case when pnt_bal_grd='7 >50000' then cst_id end)            客户数大于5万
    ,round(avg(pnt_bal_rmb),2)                                          平均等值人民币金额
    ,round(avg(case when gdr_cd='2' then age end),2)                         平均年龄_女性
    ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
    ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
    ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
    ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
    ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
    ,round(avg(case when gdr_cd='2' then pnt_bal_rmb end),2)                            平均积分等值人民币_女性
    ,round(avg(case when gdr_cd='2' and age_grd='1 <=30'     then pnt_bal_rmb end),2)   小于30_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='2 30<x<=40' then pnt_bal_rmb end),2)   30_40_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='3 40<x<=50' then pnt_bal_rmb end),2)   40_50_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='4 50<x<=60' then pnt_bal_rmb end),2)   50_60_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='5 >60'      then pnt_bal_rmb end),2)   大于60_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
    ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
    ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
    ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
    ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
    ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
    ,round(avg(case when gdr_cd='1' then pnt_bal_rmb end),2)                            平均积分等值人民币_男性
    ,round(avg(case when gdr_cd='1' and age_grd='1 <=30'     then pnt_bal_rmb end),2)   小于30_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='2 30<x<=40' then pnt_bal_rmb end),2)   30_40_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='3 40<x<=50' then pnt_bal_rmb end),2)   40_50_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='4 50<x<=60' then pnt_bal_rmb end),2)   50_60_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='5 >60'      then pnt_bal_rmb end),2)   大于60_男性平均积分等值人民币
from SJXQ_SJ2024042901_CST_01
where pnt_bal>=10000
and is_empe=0 --剔除员工
group by brc_org_id,brc_org_nm
union all
SElECT ' 积分大于100人民币' as type,
    'ALL','全行'                                                     分行
    ,count(distinct cst_id)                                             总人数
    ,count(case when pnt_bal_grd='1 100<=x<=500' then cst_id end)       客户数_100_500
    ,count(case when pnt_bal_grd='2 500<x<=1000' then cst_id end)       客户数_500_1000
    ,count(case when pnt_bal_grd='3 1000<x<=3000' then cst_id end)      客户数_1000_3000
    ,count(case when pnt_bal_grd='4 3000<x<=5000' then cst_id end)      客户数_3000_5000
    ,count(case when pnt_bal_grd='5 5000<x<=10000' then cst_id end)     客户数_5000_1万
    ,count(case when pnt_bal_grd='6 10000<x<=50000' then cst_id end)    客户数_1万_5万
    ,count(case when pnt_bal_grd='7 >50000' then cst_id end)            客户数大于5万
    ,round(avg(pnt_bal_rmb),2)                                          平均等值人民币金额
    ,round(avg(case when gdr_cd='2' then age end),2)                         平均年龄_女性
    ,count(case when gdr_cd='2' and age_grd='1 <=30'     then cst_id end)   小于30_女性客户数
    ,count(case when gdr_cd='2' and age_grd='2 30<x<=40' then cst_id end)   30_40_女性客户数
    ,count(case when gdr_cd='2' and age_grd='3 40<x<=50' then cst_id end)   40_50_女性客户数
    ,count(case when gdr_cd='2' and age_grd='4 50<x<=60' then cst_id end)   50_60_女性客户数
    ,count(case when gdr_cd='2' and age_grd='5 >60'      then cst_id end)   大于60_女性客户数
    ,round(avg(case when gdr_cd='2' then pnt_bal_rmb end),2)                            平均积分等值人民币_女性
    ,round(avg(case when gdr_cd='2' and age_grd='1 <=30'     then pnt_bal_rmb end),2)   小于30_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='2 30<x<=40' then pnt_bal_rmb end),2)   30_40_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='3 40<x<=50' then pnt_bal_rmb end),2)   40_50_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='4 50<x<=60' then pnt_bal_rmb end),2)   50_60_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='2' and age_grd='5 >60'      then pnt_bal_rmb end),2)   大于60_女性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' then age end),2)                        平均年龄_男性
    ,count(case when gdr_cd='1' and age_grd='1 <=30'     then cst_id end)   小于30_男性客户数
    ,count(case when gdr_cd='1' and age_grd='2 30<x<=40' then cst_id end)   30_40_男性客户数
    ,count(case when gdr_cd='1' and age_grd='3 40<x<=50' then cst_id end)   40_50_男性客户数
    ,count(case when gdr_cd='1' and age_grd='4 50<x<=60' then cst_id end)   50_60_男性客户数
    ,count(case when gdr_cd='1' and age_grd='5 >60'      then cst_id end)   大于60_男性客户数
    ,round(avg(case when gdr_cd='1' then pnt_bal_rmb end),2)                            平均积分等值人民币_男性
    ,round(avg(case when gdr_cd='1' and age_grd='1 <=30'     then pnt_bal_rmb end),2)   小于30_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='2 30<x<=40' then pnt_bal_rmb end),2)   30_40_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='3 40<x<=50' then pnt_bal_rmb end),2)   40_50_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='4 50<x<=60' then pnt_bal_rmb end),2)   50_60_男性平均积分等值人民币
    ,round(avg(case when gdr_cd='1' and age_grd='5 >60'      then pnt_bal_rmb end),2)   大于60_男性平均积分等值人民币
from SJXQ_SJ2024042901_CST_01
where pnt_bal>=10000
and is_empe=0 --剔除员工
;
-- 5. 积分大于1000人民币的客户数情况
DROP   TABLE IF     EXISTS SJXQ_SJ2024042901_CST_14;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042901_CST_14 AS
select ' 积分大于1000人民币' as type,
    brc_org_id,brc_org_nm                                        分行
    ,count(case when cst_seg_flg='2' then cst_id end)               客户数_个体工商户
    ,round(avg(case when cst_seg_flg='2' then pnt_bal_rmb end),2)   平均积分等值人民币_个体工商户
    ,count(case when cst_seg_flg='1' then cst_id end)               客户数_企业主
    ,round(avg(case when cst_seg_flg='1' then pnt_bal_rmb end),2)   平均积分等值人民币_企业主
from SJXQ_SJ2024042901_CST_01
where pnt_bal>=100000
and is_empe=0 --剔除员工
group by brc_org_id,brc_org_nm
union all
select ' 积分大于1000人民币' as type,
     'ALL','全行'                                                 分行
    ,count(case when cst_seg_flg='2' then cst_id end)               客户数_个体工商户
    ,round(avg(case when cst_seg_flg='2' then pnt_bal_rmb end),2)   平均积分等值人民币_个体工商户
    ,count(case when cst_seg_flg='1' then cst_id end)               客户数_企业主
    ,round(avg(case when cst_seg_flg='1' then pnt_bal_rmb end),2)   平均积分等值人民币_企业主
from SJXQ_SJ2024042901_CST_01
where pnt_bal>=100000
and is_empe=0 --剔除员工
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042901_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042901_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042901_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,tg_typ) custs
from SJXQ_SJ2024042901_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,tg_typ) custs
from SJXQ_SJ2024042901_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042901_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042901_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id,tg_typ) custs
from SJXQ_SJ2024042901_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct tg_typ,brc_org_nm) custs
from SJXQ_SJ2024042901_CST_09 where rn=1
union all
SElECT '10' seq, count(1) cnt,count(distinct brc_org_id) custs
from SJXQ_SJ2024042901_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct brc_org_id) custs
from SJXQ_SJ2024042901_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct brc_org_id) custs
from SJXQ_SJ2024042901_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct brc_org_id) custs
from SJXQ_SJ2024042901_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct brc_org_id) custs
from SJXQ_SJ2024042901_CST_14
;
/*
--剔除员工
01	13406113	13406113
02	2253364	672727
03	559065	559065
04	6560	1250
05	1250	1250
06	49004	49004
07	51824	51824
08	538123	538123
09	47	47
10	17	17
11	18	18
12	12	12
13	19	19
14	17	17
*/***SJ2024042911_存量保险画像.sql
/*
1. 是否信贷户怎么定义的？ 有效信贷户
2. 客户经理管户时间 怎么算的？建档时间
3. 持有我行产品情况，取 存款、理财、基金、保险、贷款 的 当前余额？年日均
*/
--历史所有保单
DROP   TABLE IF     EXISTS SJXQ_SJ2024042911_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042911_CST_01 AS
select t1.pd_cd                                 --产品代码|C20
	,t1.insu_plcy_id                            --保单号|C30
	,t1.mgr                                     --客户经理|C32
	,t1.cst_id                                  --客户编号|C24
	,t1.insu_hld_nm                             --投保人名称|C50
    ,t1.insu_hld_doc_nbr	                    --投保人证件号码|C30
    ,t1.bbr_nm	                                --被保人名称 17条本人名称为空
    ,t1.bbr_doc_nbr	                            --被保人证件号码|C30
	,t1.insu_hld_bbr_rel                        --投保人被保人关系|C2
    ,t3.insu_hld_insu_rel
	,t1.pay_year                                --缴费年限|C10
	,t1.eft_dt                                  --生效日期|C16
	,t1.insu_fee                                --保险费用|DECIMAL(18,2)
    ,t3.frs_trm_insu_fee
    ,t3.mng_cnv_insu_fee
	,t2.prd_nm                                  --产品名称|C250
	,t2.PRD_LVL2_CL_CD                          --险种
    ,c1.cd_val_dscr     insu_type_NM
    ,T3.insu_hld_bth_dt
    ,t3.sal_ppl_id,t3.sal_ppl_nm,t3.pos_nm
from edw.dwd_bus_insu_plcy_insu_inf_dd  t1 --保险保单投保信息
left join edw.dim_bus_insu_pd_inf_dd    t2 --保险产品信息
on t1.pd_cd=t2.prd_no
and t2.dt='20240507'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON  t2.PRD_LVL2_CL_CD = C1.CD_VAL
AND C1.DT = '20240507'
LEFT JOIN(
    SElECT T1.insu_plcy_id
        ,AVG(T1.frs_trm_insu_fee)                           frs_trm_insu_fee
        ,sum(T1.mng_cnv_insu_fee)                           mng_cnv_insu_fee    --管护折算保费
    FROM app_rpt.fct_insu_agn_bus_acs_dtl_tbl   T1 --保险代销业务考核明细表 insu_plcy_id
    LEFT JOIN edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
    on t1.sal_ppl_id=t2.empe_id
    and t2.dt='20240507'
    LEFT JOIN edw.dim_hr_org_job_inf_dd         t3
    ON      t2.pos_enc = t3.pos_id
    AND     t3.dt = '20240507'
    WHERE T1.dt = '20240507'
    GROUP BY T1.insu_plcy_id
)T3 ON T1.insu_plcy_id = T3.insu_plcy_id
where t1.dt='20240507'
;
--客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042911_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042911_CST_02 AS
select t1.cst_id,t1.insu_hld_doc_nbr,t2.doc_nbr  --11个客户不同 以 cst_id 为准
	,t2.cst_chn_nm                               --客户中文名称
	,t2.idt_cd                                   --行业代码
    ,c1.cd_val_dscr     idt_nm
	,t2.gdr_cd                                   --性别代码
    ,decode(t2.gdr_cd,'1','男','2','女','未知')     gdr_nm
	,t2.age                                      --年龄
    ,case
        when t2.age>=18 and t2.age<25 then '1 [18,25)'
        when t2.age>=25 and t2.age<35 then '2 [25,35)'
        when t2.age>=35 and t2.age<45 then '3 [35,45)'
        when t2.age>=45 and t2.age<55 then '4 [45,55)'
        when t2.age>=55 and t2.age<65 then '5 [55,65)'
        when t2.age>=65 then '6 65岁及以上' else '' end age_grd
	,t2.mrg_situ_cd                              --婚姻状况
    ,c3.cd_val_dscr     mrg_situ_nm
	,t2.chd_nbr                                  --子女数
	,t2.ocp_cd                                   --职业代码
    ,c2.cd_val_dscr     ocp_nm
	,t2.file_dt                                  --建档日期
    ,t3.efe_loan_cst_ind
    ,t4.rlty_cnt	                        --客户持有房产数量
    ,t4.rlty_amt	                        --客户持有房产价值
    ,t4.veh_cnt	                            --客户持有汽车数量
    ,t4.veh_amt	                            --客户持有汽车价值
    ,t5.fund_year_avg_amt	            --基金金额年日均
    ,t5.fnc_year_avg_amt	            --理财金额年日均
    ,t5.insu_year_avg_amt	            --保险保费年日均
    ,t5.wlth_year_avg	                --财富资产余额年日均
    ,t5.aum_year_avg	                --客户综合金融资产(aum)年日均
	,t5.aum_mon_avg
    ,case when t5.aum_mon_avg<200000 then '1 20万以下'
        when t5.aum_mon_avg>=200000 and t5.aum_mon_avg<500000       then '2 [20,50)'
        when t5.aum_mon_avg>=500000 and t5.aum_mon_avg<1000000      then '3 [50,100)'
        when t5.aum_mon_avg>=1000000 and t5.aum_mon_avg<3000000     then '4 [100,300)'
        when t5.aum_mon_avg>=3000000 and t5.aum_mon_avg<6000000     then '5 [300,600)'
        when t5.aum_mon_avg>=6000000 then '6 600万及以上' else '' end aum_mon_avg_grd
	,t6.dep_bal_year_avg                        --存款余额年日均
	,t7.loan_bal_acs_year_avg                   --贷款余额年日均
    ,t8.crd_amt	                                --授信金额
from(
    SElECT distinct cst_id,insu_hld_doc_nbr
    from SJXQ_SJ2024042911_CST_01
)t1 left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2   --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt ='20240507'
left join adm_pub.adm_csm_cbas_ind_inf_dd 		    t3 --客户基础标识信息
on t1.cst_id=t3.cst_id
and t3.dt='20240507'
left join adm_pub.adm_csm_cbus_ast_smy_dd           t4 --客户资产汇总信息
on t1.cst_id=t4.cst_id
and t4.dt='20240507'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t5 --客户集市-业务信息-客户金融资产信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240507'
left join adm_pub.adm_csm_cbus_dep_inf_dd           t6 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t6.cst_id
and t6.dt='20240507'
left join adm_pub.adm_csm_cbus_loan_inf_dd          t7 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t7.cst_id
and t7.dt='20240507'
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	    t8 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t8.cst_id
and t8.dt='20240507'
left join edw.dwd_code_library_dd                   c1
on t2.idt_cd =  c1.cd_val
and c1.dt='20240507'
LEFT JOIN    edw.dwd_code_library_dd                c2 -- 码值表
ON      T2.ocp_cd = c2.cd_val
AND     c2.tbl_nm = 'DWS_CST_IDV_BAS_INF_DD'
AND     c2.fld_nm = 'OCP_CD'
AND     c2.dt = '20230215'
LEFT JOIN    edw.dwd_code_library_dd                c3
ON      t2.mrg_situ_cd = c3.cd_val
AND     c3.dt = '20230417'
AND     c3.fld_nm = 'MRG_SITU_CD' --婚姻状况代码
AND     c3.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042911_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042911_CST_03 AS
SELECT  T1.CST_ID AS 客户号
        ,round(REPLACE(T2.dt_zf_indexa, '%', '') / 100, 2)  AS 全险种指数
        ,round(REPLACE(T2.dt_zf_indexb, '%', '') / 100, 2)  AS 团险指数
        ,round(REPLACE(T2.dt_zf_indexc, '%', '') / 100, 2)  AS 个险指数
        ,round(REPLACE(T2.dt_zf_indexdk, '%', '') / 100, 2) AS 储蓄型保险指数
        ,round(REPLACE(T2.dt_zf_indexde, '%', '') / 100, 2) AS 终身寿险指数
        ,round(REPLACE(T2.dt_zf_indexdd, '%', '') / 100, 2) AS 定期寿险指数
        ,round(REPLACE(T2.dt_zf_indexdf, '%', '') / 100, 2) AS 两全保险指数
        ,round(REPLACE(T2.dt_zf_indexdg, '%', '') / 100, 2) AS 年金保险指数
        ,round(REPLACE(T2.dt_zf_indexdh, '%', '') / 100, 2) AS 重大疾病保险指数
        ,round(REPLACE(T2.dt_zf_indexdi, '%', '') / 100, 2) AS 医疗保险指数
        ,round(REPLACE(T2.dt_zf_indexdj, '%', '') / 100, 2) AS 一年期及以上意外伤害保险指数
        ,round(REPLACE(T2.dt_zf_indexda, '%', '') / 100, 2) AS 车损险指数
        ,round(REPLACE(T2.dt_zf_indexdb, '%', '') / 100, 2) AS 三责险指数
        ,round(REPLACE(T2.dt_zf_indexdc, '%', '') / 100, 2) AS 家财险指数
        ,T2.insert_time_chinadaas
FROM SJXQ_SJ2024042911_CST_02       T1
LEFT JOIN edw.nout_zybx_fxgk        T2 --中银保信-风险管控评估指数表
ON      T1.doc_nbr = T2.in_sfzh
AND     T2.dt_zf_ifrichard = '1' --查得
AND     T2.DT = '20240507'
AND     t2.dt_zf_indexa IS NOT NULL
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042911_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042911_CST_04 AS
SELECT  t.客户号
        ,t0.全险种指数
        ,t1.团险指数
        ,t2.个险指数
        ,t3.储蓄型保险指数
        ,t4.终身寿险指数
        ,t5.定期寿险指数
        ,t6.两全保险指数
        ,t7.年金保险指数
        ,t8.重大疾病保险指数
        ,t9.医疗保险指数
        ,t10.意外伤害保险指数 as 一年期及以上意外伤害保险指数
        ,t11.车损险指数
        ,t12.三责险指数
        ,t13.家财险指数
FROM    SJXQ_SJ2024042911_CST_03            t
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t0
ON      t.全险种指数 = t0.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t1
ON      t.团险指数 = t1.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t2
ON      t.个险指数 = t2.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t3
ON      t.储蓄型保险指数 = t3.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t4
ON      t.终身寿险指数 = t4.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t5
ON      t.定期寿险指数 = t5.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t6
ON      t.两全保险指数 = t6.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t7
ON      t.年金保险指数 = t7.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t8
ON      t.重大疾病保险指数 = t8.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t9
ON      t.医疗保险指数 = t9.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t10
ON      t.一年期及以上意外伤害保险指数 = t10.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t11
ON      t.车损险指数 = t11.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t12
ON      t.三责险指数 = t12.比例
LEFT JOIN    024547_cfgl_zybx_amt_lvl_mid01 t13
ON      t.家财险指数 = t13.比例
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024042911_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042911_CST_05 AS
select t1.cst_id                                投保人
    ,t1.insu_plcy_id                            保单号
    ,t1.pd_cd                                   产品代码
	,t1.prd_nm                                  产品名称
    ,t1.insu_type_NM                            险种
    ,t1.insu_hld_insu_rel                       投保人被保人关系
    ,nvl(t1.mng_cnv_insu_fee,t1.insu_fee)       首期保费
	,t1.pay_year                                缴费年限
    ,t1.pos_nm                                  销售人岗位
	,t2.idt_nm                                  行业
	,t2.gdr_nm                                  性别
	,t2.age                                     年龄
    ,t2.age_grd                                 年龄层级
	,t2.mrg_situ_nm                             婚姻状况
	,t2.chd_nbr                                 子女数
	,t2.ocp_nm                                  职业
	,t2.aum_mon_avg                             AUM月日均
    ,t2.aum_mon_avg_grd                         AUM月日均层级
    ,t2.rlty_cnt	                            客户持有房产数量
    ,t2.rlty_amt	                            客户持有房产价值
    ,t2.veh_cnt	                                客户持有汽车数量
    ,t2.veh_amt	                                客户持有汽车价值
	,t2.dep_bal_year_avg                        存款余额年日均
    ,t2.fnc_year_avg_amt	                    理财金额年日均
    ,t2.fund_year_avg_amt	                    基金金额年日均
    ,t2.insu_year_avg_amt	                    保险保费年日均
	,t2.loan_bal_acs_year_avg                   贷款余额年日均
    ,t2.efe_loan_cst_ind                        是否有效信贷户
    ,t2.crd_amt	                                授信金额
	,t2.file_dt                                 建档日期
    ,t3.全险种指数
    ,t3.团险指数
    ,t3.个险指数
    ,t3.储蓄型保险指数
    ,t3.终身寿险指数
    ,t3.定期寿险指数
    ,t3.两全保险指数
    ,t3.年金保险指数
    ,t3.重大疾病保险指数
    ,t3.医疗保险指数
    ,t3.一年期及以上意外伤害保险指数
    ,t3.车损险指数
    ,t3.三责险指数
    ,t3.家财险指数
from SJXQ_SJ2024042911_CST_01       t1
left join SJXQ_SJ2024042911_CST_02  t2
on  t1.cst_id=t2.cst_id
left join SJXQ_SJ2024042911_CST_04  t3
on  t1.cst_id=t3.客户号
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042911_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024042911_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024042911_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024042911_CST_04
;
/*
01	54807	49004
02	49004	49004
03	49004	49004
04	49004	49004
*/
***SJ2024042936_挂钩型理财劳动竞赛.sql
-- 2023年11月1日&mdash;2024年3月31日之间募集的钱潮系列挂钩型理财产品，去掉撤单
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_01 AS
select pd_cd                                    --产品代码|C24
	,pd_nm                                    --产品名称|C256
	,clc_start_dt                             --募集开始日期|C8
	,clc_end_dt                               --募集结束日期|C8
	,pd_found_dt                              --产品成立日期|C8
	,pd_end_dt                                --产品结束日期|C8
	,actl_found_dt                            --实际成立日期|C8
	,cur_siz                                  --当前规模|DECIMAL(20,2)
	,pfm_comp_bas                             --业绩比较基准|C250
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='@@{yyyyMMdd}'
and ta_cd='TL'                  --自营理财
and pd_nm regexp '钱潮'
and pd_nm regexp '挂钩型理财'
and clc_end_dt>='20231101'      --募集结束日期
and clc_start_dt<='20240331'    --募集开始日期
and pd_sts_cd<>'3'              --发行失败
;
--管户人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_02 AS
SElECT t1.cst_id,t1.pd_cd,t1.mgr_id,t1.bnk_act_id
    ,t1.acs_rto,t1.cur_fnc_amt
    ,t3.empe_nm mgr_nm,t3.org_id
    ,T4.BRC_ORG_NM,t4.sbr_org_id,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t5.org_chrg_id sbr_chrg_id
    ,t5.org_chrg_nm sbr_chrg_nm
    ,t6.org_chrg_id tem_chrg_id
    ,t6.org_chrg_nm tem_chrg_nm
from edw.DWS_BUS_CHM_ACT_MGR_INF_DD     t1 --理财账户管护汇总信息 一个客户经理可以归属多个机构
inner join SJXQ_SJ2024042936_CST_01     t2
on t1.pd_cd=t2.pd_cd
left join edw.dws_hr_empe_inf_dd                    t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20240331'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树 4537 org_id 唯一
on  t3.org_id = t4.org_id
and t4.dt = '20240331'
left join edw.dim_hr_org_bas_inf_dd	                t5 --机构基本信息 --支行
on  t4.sbr_org_id = t5.org_id
and t5.dt = '20240331'
LEFT JOIN edw.dim_hr_org_bas_inf_dd                 T6 --机构基本信息 --团队
ON  T4.tem_org_id = T6.org_id
AND T6.DT = '20240331'
WHERE t1.dt = '20240331'
and t1.MNG_TYP_CD = '1'    --考核
AND t1.PD_TP_CD = '1'      --理财
and t1.acs_rto<>0
-- and t1.cur_fnc_amt<>0      --不限制 管户比例和为2 1017654961	CC150	2
;
-- 挂钩理财销量及规模
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_03 AS
SELECT t1.srl_nbr,T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.trx_cd                                   --交易代码|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,T1.pd_cd                                    --产品代码|C20
    ,t1.bnk_act_id
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
    ,T1.cfm_ern                                  --确认收益|DECIMAL(20,2)
    ,T1.trx_sts_cd                               --交易状态代码|C1
    ,C1.cd_val_dscr trx_sts_nm
    ,T1.mgr_id      cfm_mgr_id                   --客户经理编号|C32
    ,T1.cmsn_fee                                 --手续费|number(18,2)
    ,sum(T1.cfm_amt) over(order by t1.srl_nbr) cum_cfm_amt
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                 T1 --理财交易确认流水明细 立英修改
INNER JOIN SJXQ_SJ2024042936_CST_01                 t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
left join edw.dwd_code_library_dd                   c1
on t1.trx_sts_cd=c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where T1.DT>='20231031'
and t1.trx_dt>='20231101'           --严格按文档要求日期，不确定需询问，不要自己做主
and t1.trx_dt<=t2.clc_end_dt
AND t1.trx_sts_cd ='8'              --确认成功
;
/*
--验证 另一种口径 挂钩理财产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_03_1 AS
SELECT T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,T1.trx_dt                                   --交易日期|C8
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.trx_cd                                   --交易代码|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,T1.pd_cd                                    --产品代码|C20
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
    ,T1.cfm_ern                                  --确认收益|DECIMAL(20,2)
    ,T1.trx_sts_cd                               --交易状态代码|C1
    ,C1.cd_val_dscr trx_sts_nm
    ,T1.mgr_id      cfm_mgr_id                   --客户经理编号|C32
    ,T1.cmsn_fee                                 --手续费|number(18,2)
    ,sum(T1.cfm_amt) over(order by t1.trx_dt,t1.trx_tm) cum_cfm_amt
	,CASE WHEN f.pd_parm_val = '1' AND f2.pd_parm_val = '1' THEN '挂钩型理财'
		ELSE '' END is_hook
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                 T1 --理财交易确认流水明细 立英修改
LEFT JOIN    edw.DWD_BUS_CHM_PD_PARM_INF_DD f
ON      t1.pd_cd = f.PD_CD
AND     f.PD_PARM_CD = 'hook_prd_flag'
AND     f.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.DWD_BUS_CHM_PD_PARM_INF_DD f2
ON      t1.pd_cd = f2.PD_CD
AND     f2.PD_PARM_CD = 'bank_certificate'
AND     f2.DT = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd                   c1
on t1.trx_sts_cd=c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where T1.DT>='20231031'
and t1.trx_dt>='20231031'
and t1.trx_dt<='20240331'
AND t1.trx_sts_cd ='8'              --确认成功
;
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_04 AS
SElECT t1.cst_id,t1.pd_cd,t1.bnk_act_id,t1.cfm_amt
    ,t2.mgr_id,t2.mgr_nm,t2.acs_rto,t2.cur_fnc_amt
    ,t1.cfm_amt*t2.acs_rto  acs_rto_amt
    ,t2.org_id,t2.org_nm,t2.brc_org_nm
    ,case when nvl(t2.tem_chrg_id,'')<>'' then t2.tem_chrg_id else t2.sbr_chrg_id end tem_chrg_id
    ,case when nvl(t2.tem_chrg_nm,'')<>'' then t2.tem_chrg_nm else t2.sbr_chrg_nm end tem_chrg_nm
    ,row_number() over(partition by t1.cst_id,t1.pd_cd,t1.bnk_act_id order by t2.mgr_id) rn
from(
    SElECT cst_id,pd_cd,bnk_act_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024042936_CST_03
    where cum_cfm_amt<=2000030000
    group by cst_id,pd_cd,bnk_act_id
)t1 left join SJXQ_SJ2024042936_CST_02 t2
on  t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.bnk_act_id=t2.bnk_act_id
;
-- 输出结果1
-- 1024815007	CC168 20240130 交易 管户人为空
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_05 AS
SElECT mgr_id 									管户客户经理工号
    ,mgr_nm                                     管户客户经理名称
    ,round(sum(acs_rto_amt)/10000,4)            挂钩型产品累计销量_万元 --求和不等于20亿，剔除无管户交易
    ,round(sum(acs_rto_amt)*5/10000,2)          管户客户经理奖励金额_元
    ,org_id                                     所在机构号
    ,org_nm                                     所在机构名称
    ,brc_org_nm                                 所在分行
    ,tem_chrg_id                                管户人团队负责人工号
    ,tem_chrg_nm                                管户人团队负责人姓名
    ,round(sum(acs_rto_amt)/10000,2)            管户人团队负责人奖励金额_元
from SJXQ_SJ2024042936_CST_04
where nvl(mgr_id,'')<>''
group by mgr_id,mgr_nm,org_id,org_nm
    ,brc_org_nm,tem_chrg_id,tem_chrg_nm
;
--管户支行信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_06 AS
SElECT t1.cst_id,t1.pd_cd,t1.mgr_id,t1.bnk_act_id
    ,t1.acs_rto,t1.cur_fnc_amt
    ,t1.acs_org_id
    ,t3.empe_nm mgr_nm,t3.org_id
    ,T4.BRC_ORG_NM,t4.sbr_org_id,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t5.org_chrg_id sbr_chrg_id
    ,t5.org_chrg_nm sbr_chrg_nm
from edw.DWS_BUS_CHM_ACT_MGR_INF_DD     t1 --理财账户管护汇总信息 一个客户经理可以归属多个机构
inner join SJXQ_SJ2024042936_CST_01     t2
on t1.pd_cd=t2.pd_cd
left join edw.dws_hr_empe_inf_dd                    t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20240331'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树 4537 org_id 唯一
on  t1.acs_org_id = t4.org_id
and t4.dt = '20240331'
left join edw.dim_hr_org_bas_inf_dd	                t5 --机构基本信息 --支行
on  t4.sbr_org_id = t5.org_id
and t5.dt = '20240331'
WHERE t1.dt = '20240331'
and t1.MNG_TYP_CD = '1'    --考核
AND t1.PD_TP_CD = '1'      --理财
and t1.acs_rto<>0
-- and t1.cur_fnc_amt<>0      --3月底交易的 4月初确认则该值在0331为0
;
--支行 营销人员数
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_07 AS
SElECT sbr_org_id,count(distinct empe_id) empe_num
FROM qbi_file_20240507_16_18_25
group by sbr_org_id
;
/*
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_07_1 AS
SElECT t4.sbr_org_id,count(distinct t1.empe_id) empe_num
from edw.dws_hr_empe_inf_dd                     t1 --员工信息汇总
LEFT JOIN    edw.dim_hr_org_job_inf_dd          t2
ON      t1.pos_enc = t2.pos_id
AND     t2.dt = '20240331'
left join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树 4537 org_id 唯一
on  t1.org_id = t4.org_id
and t4.dt = '20240331'
where t1.dt='20240331'
and t1.pos_dt<='20231031'                  --之前转正
and t1.empe_sts_cd IN ( '2' , '5' , '11' ) --在职员工
and t1.DTY_ENC LIKE 'P30%'                 --营销序列
group by t4.sbr_org_id
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_08 AS
SElECT t1.cst_id,t1.pd_cd,t1.bnk_act_id,t1.cfm_amt
    ,t2.mgr_id,t2.mgr_nm,t2.acs_rto,t2.cur_fnc_amt
    ,t1.cfm_amt*t2.acs_rto  acs_rto_amt
    ,t2.org_id,t2.org_nm,t2.brc_org_nm,t2.sbr_org_id,t2.sbr_org_nm
    ,t2.sbr_chrg_id
    ,t2.sbr_chrg_nm
from(
    SElECT cst_id,pd_cd,bnk_act_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024042936_CST_03
    group by cst_id,pd_cd,bnk_act_id
)t1 left join SJXQ_SJ2024042936_CST_06 t2
on t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.bnk_act_id=t2.bnk_act_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_09 AS
SElECT t1.sbr_chrg_id 				支行行长工号
    ,t1.sbr_chrg_nm                 支行行长名称
    ,t1.sbr_org_nm                  支行名称
    ,t1.sbr_org_id                  支行机构号
    ,t1.brc_org_nm                  所在分行
    ,t1.acs_rto_amt                 支行累计销售金额_万元
    ,T2.empe_num                    支行人数
    ,round(t1.acs_rto_amt/T2.empe_num,2)     支行人均销售金额_万元
    ,row_number() over(order by t1.acs_rto_amt/T2.empe_num desc) rn
from(
    SElECT sbr_chrg_id,sbr_chrg_nm,sbr_org_nm,sbr_org_id,brc_org_nm
        ,sum(acs_rto_amt)/10000     acs_rto_amt
    from SJXQ_SJ2024042936_CST_08
    where nvl(sbr_chrg_id,'')<>''
    and sbr_org_nm like '%支行%'
    and sbr_org_nm not like '%虚拟%'
    and sbr_org_nm not like '%部%'
    group by sbr_chrg_id,sbr_chrg_nm,sbr_org_nm,sbr_org_id,brc_org_nm
)t1 left join SJXQ_SJ2024042936_CST_07 t2
on t1.sbr_org_id=t2.sbr_org_id
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST_10 AS
SElECT 管户客户经理工号
    ,sum(管户客户经理奖励金额_元)   奖励金额_元
from(
    select 管户客户经理工号,管户客户经理奖励金额_元
    from SJXQ_SJ2024042936_CST_05
    where nvl(管户客户经理工号,'')<>''
    union all
    select 管户人团队负责人工号,管户人团队负责人奖励金额_元
    from SJXQ_SJ2024042936_CST_05
    where nvl(管户人团队负责人工号,'')<>''
)t1 group by 管户客户经理工号
;
SElECT '01' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024042936_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,pd_cd,bnk_act_id,mgr_id) custs
from SJXQ_SJ2024042936_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,pd_cd,bnk_act_id) custs
from SJXQ_SJ2024042936_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,pd_cd,bnk_act_id,mgr_id) custs
from SJXQ_SJ2024042936_CST_04 where mgr_id is not null
union all
SElECT '05' seq, count(1) cnt,count(distinct 管户客户经理工号) custs
from SJXQ_SJ2024042936_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,pd_cd,bnk_act_id,mgr_id) custs
from SJXQ_SJ2024042936_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct sbr_org_id) custs
from SJXQ_SJ2024042936_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id,pd_cd,bnk_act_id,mgr_id) custs
from SJXQ_SJ2024042936_CST_08 where mgr_id is not null
union all
SElECT '09' seq, count(1) cnt,count(distinct 支行行长工号) custs
from SJXQ_SJ2024042936_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 管户客户经理工号) custs
from SJXQ_SJ2024042936_CST_10
;
/*
01	72	72
02	11702	11702
03	12932	12334
04	7169	7149
05	3092	3092
06	13052	13052
07	463	463
08	12378	12378
09	371	371
10	4027	4027
*/***SJ2024042936_挂钩型理财劳动竞赛0510.sql
/*20240511日问题
1. 9点 两次交易 记录数对不上，查原因。理财交易请求流水明细 包含客户撤单记录。在后面剔除了，没看到，想着一步一步核对看问题出在哪里
2. 10点 核查管户是否存在重复记录
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_01 AS
select ta_cd
    ,pd_cd                                  --产品代码|C24
	,pd_nm                                  --产品名称|C256
	,clc_start_dt                           --募集开始日期|C8
	,clc_end_dt                             --募集结束日期|C8
	,pd_found_dt                            --产品成立日期|C8
    ,pd_val_dt                              --产品起息日期
	,pd_end_dt                              --产品结束日期|C8
	,actl_found_dt                          --实际成立日期|C8
	,cur_siz                                --当前规模|DECIMAL(20,2)
    ,rsk_grd          --风险等级
    ,pfm_comp_bas     --业绩比较基准
    ,pd_actl_clc_amt  --产品实际募集金额
    ,chm_inv_typ_cd	                        --产品模板|C32
from edw.dim_bus_chm_pd_inf_dd  --理财产品信息
where dt='@@{yyyyMMdd}'
and ta_cd='TL'                  --自营理财
and pd_nm regexp '钱潮'
and pd_nm regexp '挂钩型理财'
and clc_end_dt>='20231101'      --募集结束日期
and clc_start_dt<='20240331'    --募集开始日期
and pd_sts_cd<>'3'              --发行失败
;
--理财交易请求流水明细（含撤单）
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_02 AS
SELECT  流水号
        ,cst_id
        ,客户账号
        ,产品代码
        ,产品名称
        ,交易日期
        ,trx_amt
        ,交易状态
        ,ta代码
        ,理财类型
        ,是否封闭式理财
        ,mgr_id
        ,mgr_rto
        ,acs_org_id
        ,管户认购金额
        ,封闭式产品期限
        ,募集开始日期
        ,募集结束日期
        ,产品成立日期
        ,产品起息日期
        ,产品结束日期
        ,风险等级
        ,业绩比较基准
        ,产品实际募集金额
        ,CASE
           WHEN 产品代码 LIKE 'CC%' AND 封闭式产品期限 < 120                     THEN '3个月封闭式理财'
           WHEN 产品代码 LIKE 'CC%' AND 封闭式产品期限 >= 120 AND 封闭式产品期限 < 300  THEN '6个月封闭式理财'
           WHEN 产品代码 LIKE 'CC%' AND 封闭式产品期限 >= 300 AND 封闭式产品期限 < 500  THEN '1年期封闭式理财'
           WHEN 产品代码 LIKE 'CC%' AND 封闭式产品期限 >= 500 AND 封闭式产品期限 <= 600 THEN '1.5年期封闭式理财'
           WHEN 产品代码 LIKE 'CC%' AND 封闭式产品期限 > 600 AND 封闭式产品期限 <= 1000 THEN '2年期封闭式理财'
           WHEN 产品代码 LIKE 'CC%' AND 封闭式产品期限 > 1000                    THEN '3年期封闭式理财'
           ELSE '其他封闭式理财'
         END AS 封闭式理财类型
FROM    (
            SELECT  a.srl_nbr       流水号
                    ,a.cst_id
                    ,a.bnk_act_id   客户账号
                    ,a.pd_cd        产品代码
                    ,b.pd_nm        产品名称
                    ,SUBSTR(a.srl_nbr, 1, 8)                            AS 交易日期
                    ,A.trx_amt      --认购金额
                    ,A.trx_sts_cd                                       AS 交易状态
                    ,b.ta_cd        ta代码
                    ,CASE
                       WHEN b.ta_cd LIKE 'TL%' THEN '自营'
                       ELSE '代销'
                     END                                                AS 理财类型
                    ,CASE
                       WHEN b.CHM_INV_TYP_CD IN ( '1303' , 'D303' ) THEN '封闭式'
                       ELSE '开放式'
                     END                                                AS 是否封闭式理财
                    --                      自营  产品模版代码：1303（封闭式净值型：钱潮系列1号）
                    -- 代销  产品模版代码：D303（封闭式净值型）
                    ,COALESCE(bb.MGR_ID, C.MGR_ID, '')                  AS MGR_ID -- 管户人 理财签约可能是二类户
                    ,COALESCE(bb.MGR_RTO, C.MGR_RTO, 1)                 AS MGR_RTO --考核比例
                    ,COALESCE(bb.ACS_ORG_ID, C.ACS_ORG_ID, '990000000') AS ACS_ORG_ID -- 账户考核机构
                    ,A.trx_amt * COALESCE(bb.MGR_RTO, C.MGR_RTO, 1) 管户认购金额
                    ,CASE
                       WHEN a.PD_CD LIKE 'CC%' THEN datediff(to_date(b.pd_end_dt, 'yyyymmdd'), to_date(b.pd_val_dt, 'yyyymmdd'), 'dd')
                       ELSE 0
                     END                                                AS 封闭式产品期限
                    ,b.clc_start_dt     募集开始日期
                    ,b.clc_end_dt       募集结束日期
                    ,b.pd_found_dt      产品成立日期
                    ,b.pd_val_dt        产品起息日期
                    ,b.pd_end_dt        产品结束日期
                    ,b.rsk_grd          风险等级
                    ,b.pfm_comp_bas     业绩比较基准
                    ,b.pd_actl_clc_amt  产品实际募集金额
            FROM    edw.dwd_bus_chm_trx_rqs_srl_dtl_di A --理财交易请求流水明细
INNER JOIN SJXQ_SJ2024042936_CST2_01                 b --理财产品信息
ON  a.pd_cd = b.pd_cd
            LEFT JOIN    edw.DWD_BUS_DEP_CST_ACT_MGR_INF_DD bb --客户存款账户管护信息
            ON      A.BNK_ACT_ID = bb.CST_ACT_ID -- 客户账号
            AND     bb.DT = '20240331'
            LEFT JOIN    edw.DWS_BUS_DEP_ACT_MGR_INF_DD C --存款账户管护汇总信息
            ON      A.BNK_ACT_ID = C.DEP_ACT_ID --存款账号
            AND     C.DEP_ACT_ID <> C.CST_ACT_ID
            AND     C.DT = '20240331'
            WHERE   A.dt >= '20231031'
            AND     A.trx_cd IN ( '100200' , '100201' , '100213' , '100211' , '100214' , '100257' , '100256' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
            AND     A.trx_sts_cd IN ( '0' , '1' , '5' , '6' , '7' , 'A' , 'G' , 'Z' , '8' ) --交易状态：0：预受理,1：受理,5：确认中,6：部分确认未全部返回,7：部分确认已全部返回,8：确认成功,A：认购确认,G：受理中,Z：处理中 撤销的流水在后面的逻辑会剔除
            AND     SUBSTR(A.srl_nbr, 1, 8) >= '20231101'
            AND     SUBSTR(A.srl_nbr, 1, 8) <=b.clc_end_dt
) a;
--理财交易请求流水明细 岗位（剔除撤单）
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_03 AS
SELECT  a.流水号
        ,a.cst_id
        ,a.客户账号
        ,a.产品代码
        ,a.产品名称
        ,a.交易日期
        ,a.trx_amt
        ,a.交易状态
        ,a.ta代码
        ,a.理财类型
        ,a.是否封闭式理财
        ,a.mgr_id
        ,a.mgr_rto
        ,a.acs_org_id
        ,org.org_nm 账户考核机构名称
        ,CASE
           WHEN org.sbs_org_id = '330205200' THEN '330299999'
           ELSE org.brc_org_id
         END                             AS 账户考核机构分行编号
        ,CASE
           WHEN org.sbs_org_id = '330205200' THEN '杭州分行'
           ELSE org.brc_org_nm
         END                             AS 账户考核机构分行名称
        ,org.sbs_org_id 账户考核机构区域机构编号
        ,org.sbs_org_nm 账户考核机构区域机构名称
        ,org.sbr_org_id 账户考核机构支行编号
        ,org.sbr_org_nm 账户考核机构支行名称
        ,org.tem_org_id 账户考核机构团队编号
        ,org.tem_org_nm 账户考核机构团队名称
        ,a.管户认购金额
        ,a.封闭式产品期限
        ,a.募集开始日期
        ,a.募集结束日期
        ,a.产品成立日期
        ,a.产品起息日期
        ,a.产品结束日期
        ,a.风险等级
        ,a.业绩比较基准
        ,a.产品实际募集金额
        ,a.封闭式理财类型
        ,b.员工所在分行编号
        ,b.员工所在分行名称
        ,b.员工所在区域机构编号
        ,b.员工所在区域机构名称
        ,b.员工所在支行编号
        ,b.员工所在支行名称
        ,b.员工所在团队编号
        ,b.员工所在团队名称
        ,b.员工所在机构号
        ,b.员工所在机构名称
        ,b.pos_nm
        ,员工状态
        ,用工状态
        ,t3.org_chrg_nm                     员工所在团队负责人姓名
        ,nvl(t3.org_chrg_id, t3.empe_id) AS 员工所在团队负责人工号
        ,t3.pos_nm                          员工所在团队负责人职位名称
        ,t4.org_chrg_nm                     员工所在支行负责人姓名
        ,t4.empe_id                      AS 员工所在支行负责人工号
        ,t4.pos_nm                          员工所在支行负责人职位名称
        ,b.empe_nm                       AS 员工姓名
        ,CASE
           WHEN a.产品名称 REGEXP '交银理财稳享鑫荣三年封闭式'                THEN '交银三年期'
           WHEN f.pd_parm_val = '1' AND f2.pd_parm_val = '1' THEN '挂钩型理财'
           WHEN ttb.DVD_GRP_CD = 'TTB001'                    THEN '天添宝'
           ELSE '其他产品'
         END 重点产品
        ,sum(a.管户认购金额) over(order by a.流水号)    cum_trx_amt
FROM    SJXQ_SJ2024042936_CST2_02 a
LEFT JOIN    edw.DWD_BUS_CHM_PD_PARM_INF_DD f
ON      A.产品代码 = f.PD_CD
AND     f.PD_PARM_CD = 'hook_prd_flag'
AND     f.DT = '20240331'
LEFT JOIN    edw.DWD_BUS_CHM_PD_PARM_INF_DD f2
ON      A.产品代码 = f2.PD_CD
AND     f2.PD_PARM_CD = 'bank_certificate'
AND     f2.DT = '20240331'
LEFT JOIN    edw.DWD_BUS_CHM_PTFL_CPN_PD_REL_INF_DD ttb
ON      A.产品代码 = ttb.PD_CD
AND     ttb.DVD_GRP_CD = 'TTB001'
AND     ttb.DT = '20240331'
LEFT JOIN    (
                 SELECT  a3.brc_org_id 员工所在分行编号
                         ,a3.brc_org_nm 员工所在分行名称
                         ,a3.sbs_org_id 员工所在区域机构编号
                         ,a3.sbs_org_nm 员工所在区域机构名称
                         ,a3.sbr_org_id 员工所在支行编号
                         ,a3.sbr_org_nm 员工所在支行名称
                         ,a3.tem_org_id 员工所在团队编号
                         ,a3.tem_org_nm 员工所在团队名称
                         ,a3.org_id 员工所在机构号
                         ,a3.org_nm 员工所在机构名称
                         ,a2.pos_nm
                         ,a1.empe_id
                         ,a1.empe_nm
                         ,a1.empe_sts_cd 员工状态
                         ,a1.lbr_tp_sts 用工状态
                 FROM    edw.dws_hr_empe_inf_dd a1 --员工汇总信息
                 JOIN    edw.dim_hr_org_job_inf_dd a2 --职位信息
                 ON      a1.pos_enc = a2.pos_id
                 AND     a2.dt = '20240331'
                 LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a3 --机构树_考核维度
                 ON      a3.dt = '20240331'
                 AND     a3.org_id = a1.org_id
                 WHERE   a1.dt = '20240331'
                 -- AND     a1.empe_sts_cd = '2' --在职
                 -- AND     a1.lbr_tp_sts IN ( '3' , '4' ) --已转正,已上岗
                --  AND     a3.brc_org_nm NOT LIKE '%村镇%'
             -- AND     a2.pos_nm IN ( '客户经理' , '服务经理' , '理财经理','营业经理' )
             ) b
ON      a.mgr_id = b.empe_id
LEFT JOIN    (
                 SELECT  a1.org_id --机构编号
                         ,a1.org_chrg_nm --机构负责人名称
                         ,a1.org_chrg_pos_id --机构负责人职位编号
                         ,a1.org_chrg_id --机构负责人工号
                         ,a2.pos_enc --职位编号|C32
                         ,a3.pos_nm --职位名称|C128
                         ,a2.empe_id --员工工号
                         ,a2.empe_nm
                 FROM    edw.dim_hr_org_bas_inf_dd a1 --机构信息
                 LEFT JOIN    edw.dws_hr_empe_inf_dd a2 --员工汇总信息
                 ON      a2.dt = '20240331'
                 AND     a1.org_chrg_id = a2.empe_id --人员工号关联
                 AND     a2.empe_sts_cd IN ( '2' , '5' , '11' ) --在职员工
                 LEFT JOIN    edw.dim_hr_org_job_inf_dd a3 --职位信息
                 ON      a2.pos_enc = a3.pos_id
                 AND     a3.dt = '20240331'
                 WHERE   a1.dt = '20240331'
             ) t3 --客户经理所在团队负责人
ON      t3.org_id = b.员工所在机构号
LEFT JOIN    (
                 SELECT  a1.org_id --机构编号
                         ,a1.org_chrg_nm --机构负责人名称
                         ,a1.org_chrg_pos_id --机构负责人职位编号
                         ,a2.pos_enc --职位编号|C32
                         ,a3.pos_nm --职位名称|C128
                         ,a2.empe_id --员工工号
                         ,a2.empe_nm
                 FROM    edw.dim_hr_org_bas_inf_dd a1 --机构信息
                 LEFT JOIN    edw.dws_hr_empe_inf_dd a2 --员工汇总信息
                 ON      a2.dt = '20240331'
                 AND     a1.org_chrg_id = a2.empe_id --人员工号关联
                 AND     a2.empe_sts_cd IN ( '2' , '5' , '11' ) --在职员工
                 LEFT JOIN    edw.dim_hr_org_job_inf_dd a3 --职位信息
                 ON      a2.pos_enc = a3.pos_id
                 AND     a3.dt = '20240331'
                 WHERE   a1.dt = '20240331'
             ) t4 --支行行长
ON      t4.org_id = b.员工所在支行编号 -- 员工所在支行的支行行长
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org --机构树_考核维度
ON      a.acs_org_id = org.org_id
AND     org.dt = '20240331'
LEFT JOIN    (
                 SELECT  SRL_NBR
                         ,TRX_CD
                         ,TRX_STS_CD
                 FROM    (
                             SELECT  REPLACE(REPLACE(REPLACE(COALESCE(TRIM(SERIAL_NO), ''), CHR(13), ''), CHR(10), ''), '&quot;', '')   AS SRL_NBR --流水号
                                     ,REPLACE(REPLACE(REPLACE(COALESCE(TRIM(TRANS_CODE), ''), CHR(13), ''), CHR(10), ''), '&quot;', '') AS TRX_CD
                                     ,REPLACE(REPLACE(REPLACE(COALESCE(TRIM(STATUS), ''), CHR(13), ''), CHR(10), ''), '&quot;', '')     AS TRX_STS_CD
                             FROM    edw.FINC_TBHISTRANSREQ
                             WHERE   dt >= '20231031'
                         --流水号中发生过撤单、确认失败就删除
                         ) a
                 WHERE   a.TRX_CD IN ( '100200' , '100256' ) --交易代码 理财产品购买,定向购买
                 AND     TRX_STS_CD IN ( '2' , '9' )
                 GROUP BY SRL_NBR , TRX_CD , TRX_STS_CD
             ) tt
ON      a.流水号 = tt.SRL_NBR
WHERE   tt.SRL_NBR IS NULL
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_04 AS
SElECT cst_id,产品代码
    ,mgr_id
    ,员工姓名           mgr_nm
    ,管户认购金额       acs_rto_amt
    ,员工所在机构号     org_id
    ,员工所在机构名称   org_nm
    ,员工所在分行名称   brc_org_nm
    ,case when nvl(员工所在团队负责人工号,'')<>'' then 员工所在团队负责人工号 else 员工所在支行负责人工号 end tem_chrg_id
    ,case when nvl(员工所在团队负责人姓名,'')<>'' then 员工所在团队负责人姓名 else 员工所在支行负责人姓名 end tem_chrg_nm
from SJXQ_SJ2024042936_CST2_03
where cum_trx_amt <= 2000130000     --最后一笔 39万
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_05 AS
SElECT mgr_id 									管户客户经理工号
    ,mgr_nm                                     管户客户经理名称
    ,round(sum(acs_rto_amt)/10000,4)            挂钩型产品累计销量_万元 --求和不等于20亿，剔除无管户交易
    ,round(sum(acs_rto_amt)*5/10000,2)          管户客户经理奖励金额_元
    ,org_id                                     所在机构号
    ,org_nm                                     所在机构名称
    ,brc_org_nm                                 所在分行
    ,tem_chrg_id                                管户人团队负责人工号
    ,tem_chrg_nm                                管户人团队负责人姓名
    ,round(sum(acs_rto_amt)/10000,2)            管户人团队负责人奖励金额_元
from SJXQ_SJ2024042936_CST2_04
where nvl(mgr_id,'')<>''
group by mgr_id,mgr_nm,org_id,org_nm
    ,brc_org_nm,tem_chrg_id,tem_chrg_nm
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_06 AS
SElECT 管户客户经理工号
    ,sum(管户客户经理奖励金额_元)   奖励金额_元
from(
    select 管户客户经理工号,管户客户经理奖励金额_元
    from SJXQ_SJ2024042936_CST2_05
    where nvl(管户客户经理工号,'')<>''
    union all
    select 管户人团队负责人工号,管户人团队负责人奖励金额_元
    from SJXQ_SJ2024042936_CST2_05
    where nvl(管户人团队负责人工号,'')<>''
)t1 group by 管户客户经理工号
;
--支行 营销人员数
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_07 AS
SElECT sbr_org_id,count(distinct empe_id) empe_num
FROM qbi_file_20240507_16_18_25
group by sbr_org_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_08 AS
SElECT t1.sbr_chrg_id 				支行行长工号
    ,t1.sbr_chrg_nm                 支行行长名称
    ,t1.sbr_org_nm                  支行名称
    ,t1.sbr_org_id                  支行机构号
    ,t1.brc_org_nm                  所在分行
    ,t1.acs_rto_amt                 支行累计销售金额_万元
    ,T2.empe_num                    支行人数
    ,round(t1.acs_rto_amt/T2.empe_num,2)     支行人均销售金额_万元
    ,row_number() over(order by t1.acs_rto_amt/T2.empe_num desc) rn
from(
    SElECT  t4.empe_id sbr_chrg_id
        ,t4.org_chrg_nm sbr_chrg_nm
        ,t1.账户考核机构支行名称           sbr_org_nm
        ,t1.账户考核机构支行编号           sbr_org_id
        ,t1.账户考核机构分行名称           brc_org_nm
        ,sum(t1.管户认购金额)/10000       acs_rto_amt
    from SJXQ_SJ2024042936_CST2_03 t1
inner JOIN    (
                 SELECT  a1.org_id --机构编号
                         ,a1.org_chrg_nm --机构负责人名称
                         ,a1.org_chrg_pos_id --机构负责人职位编号
                         ,a2.pos_enc --职位编号|C32
                         ,a3.pos_nm --职位名称|C128
                         ,a2.empe_id --员工工号
                         ,a2.empe_nm
                 FROM    edw.dim_hr_org_bas_inf_dd a1 --机构信息
                 LEFT JOIN    edw.dws_hr_empe_inf_dd a2 --员工汇总信息
                 ON      a2.dt = '20240331'
                 AND     a1.org_chrg_id = a2.empe_id --人员工号关联
                 AND     a2.empe_sts_cd IN ( '2' , '5' , '11' ) --在职员工
                 LEFT JOIN    edw.dim_hr_org_job_inf_dd a3 --职位信息
                 ON      a2.pos_enc = a3.pos_id
                 AND     a3.dt = '20240331'
                 WHERE   a1.dt = '20240331'
             ) t4 --支行行长
             ON      t4.org_id = t1.账户考核机构支行编号
    where nvl(t4.empe_id,'')<>''
    and t1.账户考核机构支行名称 like '%支行%'
    and t1.账户考核机构支行名称 not like '%虚拟%'
    and t1.账户考核机构支行名称 not like '%部%'
    group by t4.empe_id,t4.org_chrg_nm,t1.账户考核机构支行名称 ,t1.账户考核机构支行编号 ,t1.账户考核机构分行名称
)t1 left join SJXQ_SJ2024042936_CST2_07 t2
on t1.sbr_org_id=t2.sbr_org_id
;
--325万无管户记录
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_09 AS
SELECT *
from SJXQ_SJ2024042936_CST2_03
where cum_trx_amt <= 2000130000
and nvl(mgr_id,'')=''
;
SElECT '01' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024042936_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 流水号) custs
from SJXQ_SJ2024042936_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 流水号,mgr_id) custs
from SJXQ_SJ2024042936_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,mgr_id) custs
from SJXQ_SJ2024042936_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 管户客户经理工号) custs
from SJXQ_SJ2024042936_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 管户客户经理工号) custs
from SJXQ_SJ2024042936_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct sbr_org_id) custs
from SJXQ_SJ2024042936_CST2_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 支行行长工号) custs
from SJXQ_SJ2024042936_CST2_08
;
/*
01	72	72
02	13281	13173
03	12959	12959
04	7556	6549
05	3099	3099
06	4034	4034
07	463	463
08	371	371
*/
/*
DROP   TABLE IF     EXISTS SJXQ_SJ2024042936_CST2_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024042936_CST2_03_1 AS
SELECT  a3.brc_org_id 员工所在分行编号
    ,a3.brc_org_nm 员工所在分行名称
    ,a3.sbs_org_id 员工所在区域机构编号
    ,a3.sbs_org_nm 员工所在区域机构名称
    ,a3.sbr_org_id 员工所在支行编号
    ,a3.sbr_org_nm 员工所在支行名称
    ,a3.tem_org_id 员工所在团队编号
    ,a3.tem_org_nm 员工所在团队名称
    ,a3.org_id 员工所在机构号
    ,a3.org_nm 员工所在机构名称
    ,a2.pos_nm
    ,a1.empe_id
    ,a1.empe_nm
    ,empe_sts_cd 员工状态
    ,lbr_tp_sts 用工状态
FROM    edw.dws_hr_empe_inf_dd a1 --员工汇总信息
JOIN    edw.dim_hr_org_job_inf_dd a2 --职位信息
ON      a1.pos_enc = a2.pos_id
AND     a2.dt = '20240331'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a3 --机构树_考核维度
ON      a3.dt = '20240331'
AND     a3.org_id = a1.org_id
WHERE   a1.dt = '20240331'
-- AND     a1.empe_sts_cd = '2' --在职
-- AND     a1.lbr_tp_sts IN ( '3' , '4' ) --已转正,已上岗
AND     a3.brc_org_nm NOT LIKE '%村镇%'
-- AND     a2.pos_nm IN ( '客户经理' , '服务经理' , '理财经理','营业经理' )
;
*/***SJ20240506121_非现金理财.sql
/*
全行 4月底数据 分行维度
1. 非现金理财购买是 100万元以上 还是 100万元及以上？
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20240506121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240506121_CST_01 AS
select t1.cst_id                                   --客户号
	,t1.aum_grd                                  --财富等级:1-一星客户,2-二星客户,3-三星客户,4-四星客户,5-五星客户,6-六星客户
    ,decode(t1.aum_grd,'1','1星','2','2星','3','3星','4','4星','5','5星','6','6星','') aum_grd_nm
	,t1.cst_typ_cd                               --客户类型代码:1对私,2对公
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
from adm_pub.adm_csm_cbas_cst_grd_inf_dd            t1 --客户集市-基础信息-客户等级信息
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240430'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240430'
where t1.dt='20240430'
;
-- 指定理财产品
DROP   TABLE IF     EXISTS SJXQ_SJ20240506121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240506121_CST_02 AS
select pd_cd                                  --产品代码
	,pd_nm                                    --产品名称
	,pd_sts_cd                                --产品状态代码
	,ta_cd                                    --ta代码
	,clc_start_dt                             --募集开始日期
	,clc_end_dt                               --募集结束日期
	,pd_found_dt                              --产品成立日期
	,pd_val_dt                                --产品起息日期
	,pd_end_dt                                --产品结束日期
	,actl_found_dt                            --实际成立日期
	,rsk_grd                                  --风险等级
    ,case when pd_nm regexp '招银理财招睿焦点联动' then '招银理财招睿焦点联动'
        when pd_nm regexp '招银理财招睿焦点联动'    then '招银理财招睿焦点联动'
        when pd_nm regexp '交银理财稳享鑫荣三年'    then '交银理财稳享鑫荣三年'
        when pd_nm regexp '招银理财招睿增利精选'    then '招银理财招睿增利精选'
        when pd_nm regexp '丰利兴动多策略'          then '丰利兴动多策略'
        when pd_nm regexp '钱潮&middot;稳享3年期挂钩'      then '钱潮&middot;稳享3年期挂钩'
        when pd_nm regexp '钱潮&middot;稳享5年期挂钩'      then '钱潮&middot;稳享5年期挂钩'
        when pd_nm regexp '钱潮&middot;致远5年期挂钩'      then '钱潮&middot;致远5年期挂钩' else '' end pd_cls
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='20240509'
and pd_ctg_cd='1'               --'1','理财'
and pd_nm regexp '招银理财招睿焦点联动|交银理财稳享鑫荣三年|招银理财招睿增利精选|丰利兴动多策略|钱潮&middot;稳享3年期挂钩|钱潮&middot;稳享5年期挂钩|钱潮&middot;致远5年期挂钩'
order by pd_cd
;
-- 20240430日余额
DROP   TABLE IF     EXISTS SJXQ_SJ20240506121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240506121_CST_03 AS
select t1.ta_cd                                    --ta代码|C32
	,t1.pd_cd                                    --产品代码|C24
	,t1.bnk_act_id                               --银行账号|C32
	,t1.ccy_cd                                   --币种代码|C3
	,t1.invst_mat_dt                             --投资到期日|C8
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_dt                                   --签约日期|C8
	,t1.cur_lot                                  --当前份额|DECIMAL(20,2)
	,t1.ar_sts_cd                                --合约状态替代吗|C1
	,t1.fnc_amt                                  --当前理财金额|DECIMAL(21,2)
	,t1.mgr_id                                   --销售客户经理工号|c32
	,case when t2.pd_cd is not null then 1 else 0 end is_select
from edw.dws_bus_chm_act_acm_inf_dd     t1      --理财账户份额汇总信息
left join SJXQ_SJ20240506121_CST_02     t2
on t1.pd_cd=t2.pd_cd
where t1.dt='20240430'
and PD_TP_CD='1'      --'1','理财'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240506121_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240506121_CST_04 AS
select t1.cst_id                                   --客户号
	,t1.aum_grd,t1.aum_grd_nm,T1.BRC_ORG_NM
    ,t2.fnc_amt_1
    ,t3.fnc_amt_0
    ,case when t2.cst_id is not null or t3.cst_id is not null then 1 else 0 end is_fnc_cst
from SJXQ_SJ20240506121_CST_01        t1
left join(
    SElECT cst_id,sum(fnc_amt) fnc_amt_1
    from SJXQ_SJ20240506121_CST_03
    where is_select=1
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
left join(
    SElECT cst_id,sum(fnc_amt) fnc_amt_0
    from SJXQ_SJ20240506121_CST_03
    where is_select=0
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240506121_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240506121_CST_05 AS
SElECT BRC_ORG_NM                   主管户分行
    ,aum_grd_nm                     财富客群等级
    ,round(sum(fnc_amt_1),2)        截至0430非现金理财时点余额
    ,count(case when fnc_amt_1>=1000000 then cst_id end) 100万及以上客户数
    ,round(sum(fnc_amt_0),2)        截至0430其余理财时点余额
from SJXQ_SJ20240506121_CST_04
where BRC_ORG_NM not like '%村镇银行%'
and aum_grd_nm<>''
and is_fnc_cst=1
group by BRC_ORG_NM,aum_grd_nm
order by BRC_ORG_NM,aum_grd_nm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240506121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ20240506121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,pd_cd) custs
from SJXQ_SJ20240506121_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240506121_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 主管户分行,财富客群等级) custs
from SJXQ_SJ20240506121_CST_05
;
/*
01	16927820	16927820
02	119	119
03	2032885	2031480
04	16927820	16927820
05	100	100
*/
***SJ2024050621_全家活动用卡情况.sql
--主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_01 AS
SElECT col_1    --优惠类型
    ,col_2      --优惠金额（元）
    ,col_3      --订单总金额（元）
    ,col_4      --交易类型
    ,col_5      --支付单号
    ,col_6      --消耗时间
    ,col_7      --消耗商户号
    ,col_8      --设备号
    ,substr(col_9,2,50)  trx_seq --银行流水号
    ,card_type
FROM qbi_file_20240510_11_02_17
and nvl(col_9,'')<>''
;
--匹配账号
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_02 AS
select t1.trx_seq                               --交易流水号|C31
    ,t1.card_type
	,t2.act                                      --账户|C72
	,t2.act_nm                                   --账户名称 6214806601001198078 有2个账户名称
	,t2.trx_dt                                   --交易日期|C8
	,t2.trx_tm                                   --交易时间|C6
	,t2.ccy_cd                                   --货币代码|C3
	,t2.trx_amt                                  --交易金额|DECIMAL(15,2)
	,t2.core_trx_amt                             --核心交易金额|DECIMAL(15,2)
	,t2.dbt_act                                  --借方账户|C34
	,t2.dbt_act_nm                               --借方账户名称|C120
	,t2.crd_act                                  --贷方账户|C34
	,t2.crd_act_nm                               --贷方账户名称|C120
	,t2.bus_rtn_inf                              --业务返回信息|C120
	,t2.rcv_act                                  --收款方账户|C34
	,t2.rcv_nm                                   --收款方名称|C60
    ,t2.dt
from SJXQ_SJ2024050621_CST_01                   t1
left join edw.dwd_bus_chnl_epc_pay_srl_dtl_di   t2 --支付流水表
on t1.trx_seq=t2.trx_seq
and t2.dt >= '20230501'
where t1.col_4='支付'
;
-- 客户账号 会随着dt 的增加而丢失 5min
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_03 AS
select t2.act,t2.card_type
    ,t1.cst_act_id,t1.dt
    ,t1.cst_id,t1.mgr_id      --管护人编号|C200
    ,t1.acs_org_id	        --考核机构编号|C12
    ,t1.mgr_rto
    ,dense_rank() over(partition by t1.cst_act_id order by t1.dt desc) rn
from edw.dwd_bus_dep_cst_act_mgr_inf_dd  t1   --存款客户账户`管户`信息 信用卡全空 借记卡 19条空 1030589934
inner join(
    select distinct act,card_type
    from SJXQ_SJ2024050621_CST_02
    where card_type='jjk'
)t2 on t1.cst_act_id=t2.act
where t1.dt<='@@{yyyyMMdd}'
and t1.dt>='20230917'
;
--借记卡 账户管户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_04 AS
SElECT t1.act,t1.card_type
    ,t1.cst_id,t1.mgr_id    --管护人编号|C200
    ,t1.acs_org_id	        --考核机构编号|C12
    ,t1.mgr_rto
    ,t3.empe_nm mgr_nm
    ,t5.cst_act_nm
    ,t5.opn_dt	            --开户日期|C8
from SJXQ_SJ2024050621_CST_03               t1
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_bus_dep_cst_act_inf_dd  	t5 --客户存款账户信息
on t1.cst_act_id=t5.cst_act_id
and t1.dt=t5.dt
and t5.dt>='20230917'
where t1.rn=1
;
--信用卡 近3月透支日均 余额日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_05 AS
select cr_crd_act_id                                --信用卡账号|C10
	,avg(bal)           xyk_90d_bal_avg             --余额
	,avg(ovdr_bal)      xyk_90d_ovdrbal_avg         --透支余额
    ,count(1)           cnt
from edw.dim_bus_crd_cr_crd_act_inf_dd  --信用卡账户信息
where dt>='@@{yyyyMMdd-90d}'
group by cr_crd_act_id
;
--信用卡
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_06 AS
SElECT t1.act,t1.card_type
    ,t2.cr_crd_card_nbr                         --信用卡卡号|C19
	,t2.main_crd_ind                            --主附卡标志|C1
	,t2.card_sts_cd                             --卡片状态代码|C2
	,t2.cst_id                                  --客户编号|C20
	,t2.cst_nm                                  --客户名称|C200
	,t2.mtu_day                                 --到期日|C8
	,t2.isu_dt                                  --发卡日期|C8
	,t2.card_actv_dt                            --卡片激活日期|C8
	,t2.cr_crd_act_id                           --信用卡账号|C10
	,t2.frs_card_nbr                            --首卡卡号|C19
	,t2.main_card_card_nbr                      --主卡卡号|C19
	,t2.cst_crd_lmt	                            --客户信用额度|C10
    ,t3.acs_org_id	                    --考核机构编号|C12
    ,t3.frs_mgr_id	                    --第一管护人编号|C32
    ,t3.scd_mgr_id	                    --第二管护人编号|C32
    ,t3.mgr_nm	                        --管护人名称|C200
    ,t3.mgr_typ_cd	                    --管护类型代码|C1
    ,t3.scd_mgr_nm	                    --第二管护人名称|200
    ,t3.frs_mgr_nm	                    --第一管护人名称|200
    ,round(t4.xyk_90d_bal_avg,2)      xyk_90d_bal_avg       --余额
    ,round(t4.xyk_90d_ovdrbal_avg,2)  xyk_90d_ovdrbal_avg   --透支余额
from(
    select distinct act,card_type
    from SJXQ_SJ2024050621_CST_02
    where card_type='xyk'
)t1 left join edw.dim_bus_crd_cr_crd_inf_dd t2 --信用卡卡片信息
on t1.act=t2.cr_crd_card_nbr
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t3 --信用卡管护信息
on t1.act=t3.cr_crd_card_nbr
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024050621_CST_05          t4
on t2.cr_crd_act_id=t4.cr_crd_act_id
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_07 AS
SElECT t1.*
    ,t4.org_nm acs_org_nm
    ,t6.dep_bal_6m_avg	                            --存款余额近6个月日均
    ,round(t7.chm_bal_6m_avg,2) chm_bal_6m_avg	    --理财余额近6个月日均
from (
    SElECT act,card_type,cst_id,mgr_id
        ,acs_org_id,mgr_rto,mgr_nm,cst_act_nm,opn_dt
        ,NULL card_actv_dt
        ,NULL cst_crd_lmt
        ,NULL xyk_90d_bal_avg
        ,NULL xyk_90d_ovdrbal_avg
    from SJXQ_SJ2024050621_CST_04
    union all
    SElECT act,card_type,cst_id
        ,case when nvl(scd_mgr_id,'')<>'' then concat(frs_mgr_id,'|',scd_mgr_id)
            else frs_mgr_id end     mgr_id
        ,acs_org_id,NULL mgr_rto,mgr_nm,cst_nm,isu_dt
        ,card_actv_dt                           --卡片激活日期|C8
        ,cst_crd_lmt	                        --客户信用额度|C10
        ,xyk_90d_bal_avg                        --余额
        ,xyk_90d_ovdrbal_avg                    --透支余额
    from SJXQ_SJ2024050621_CST_06
)t1 left join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树
on  t1.acs_org_id=t4.org_id
and t4.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_dep_acm_inf_dd       t6 --客户日均存款
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_chm_inf_dd	        t7 --客户集市-业务信息-客户理财业务信息表
on t1.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024050621_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050621_CST_08 AS
SElECT t1.col_1                 优惠类型
    ,t1.col_2                   优惠金额_元
    ,t1.col_3                   订单总金额_元
    ,t1.col_4                   交易类型
    ,t1.col_5                   支付单号
    ,t1.col_6                   消耗时间
    ,t1.col_7                   消耗商户号
    ,t1.col_8                   设备号
    ,t1.trx_seq                 银行流水号
    ,t1.card_type               卡片类型
	,t2.act                     卡号
    ,t3.cst_id                  客户号
    ,t3.cst_act_nm              客户名称
    ,t3.mgr_id                  管户人工号
    ,t3.mgr_nm                  管户人名称
    ,t3.mgr_rto                 管户比例
    ,t3.acs_org_nm              管户机构
    ,t3.opn_dt                  开户日期
    ,t3.card_actv_dt            卡片激活日期
    ,t3.cst_crd_lmt	            客户信用额度
    ,t3.xyk_90d_bal_avg         近3月信用卡余额日均
    ,t3.xyk_90d_ovdrbal_avg     近3月信用卡透支余额日均
    ,t3.dep_bal_6m_avg	        存款余额近6个月日均
    ,t3.chm_bal_6m_avg	        理财余额近6个月日均
from SJXQ_SJ2024050621_CST_01       t1
left join SJXQ_SJ2024050621_CST_02  t2
on t1.trx_seq=t2.trx_seq
left join SJXQ_SJ2024050621_CST_07  t3
on t2.act=t3.act
;
SElECT '01' seq, count(1) cnt,count(distinct trx_seq) custs
from SJXQ_SJ2024050621_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct act) custs
from SJXQ_SJ2024050621_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct act) custs
from SJXQ_SJ2024050621_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct act,mgr_id) custs
from SJXQ_SJ2024050621_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cr_crd_act_id) custs
from SJXQ_SJ2024050621_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct act) custs
from SJXQ_SJ2024050621_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct act,mgr_id) custs
from SJXQ_SJ2024050621_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 银行流水号,交易类型,管户人工号) custs
from SJXQ_SJ2024050621_CST_08
;
/*
01	20750	20654
02	20654	6486
03	5642	5639
04	5642	5642
05	858822	858822
06	847	847
07	6489	6489
08	20759	20759
--核验重复记录支付 退款 是否  一一对应
SElECT trx_seq,count(1) cnt,sum(col_2) col_2
from SJXQ_SJ2024050621_CST_01
GROUP BY trx_seq
order by cnt desc
;
*/***SJ2024050811_温州分行信用卡数据.sql
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2024050811_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050811_CST_01 AS
SElECT cst_id,card_id,cr_crd_act_id cr_crd_act_id2
    ,sj_crdt_lmt,sj_avg_bal_90d
FROM qbi_file_20240509_15_08_26
;
-- 24年4月末-信用额度	24年4月末-近90天垫款日均	24年4月末逾期金额（M0/M1）
DROP   TABLE IF     EXISTS SJXQ_SJ2024050811_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050811_CST_02 AS
SElECT t1.cst_id,t1.cr_crd_act_id
    ,t2.crd_lmt	                                 --信用额度
    ,t2.cur_90day_adv_mny_day_avg	             --近90天垫款日均
    ,t3.crd_lmt                     crd_lmt2
    ,t3.act_sts_cd                               --信用卡账户状态|C2
	,t3.bin_sng_day                              --账单日|C2
	,t3.opn_dt                                   --开户日期|C8
	,t3.bal                                      --信用卡余额|Decimal(20,2)
	,t3.late_bil_amt                             --上期账单金额|Decimal(20,2)
	,t3.ovdr_bal                                 --透支余额|Decimal(20,2)
	,t3.ovd_hi_trm                               --逾期期数|BIGINT
	,t3.ovd_amt                                  --逾期金额|Decimal(20,2)
	,t3.instl_rmn_not_paid_prcp_bal              --分期剩余未还本金|Decimal(20,2)
	,t3.fst_od_amt                               --第1次逾期金额|Decimal(20,2)
	,t3.scd_od_amt                               --第2次逾期金额|Decimal(20,2)
	,t3.thd_od_amt                               --第3次逾期金额|Decimal(20,2)
	,t3.foth_od_amt                              --第4次逾期金额|Decimal(20,2)
	,t3.fth_od_amt                               --第5次逾期金额|Decimal(20,2)
	,t3.sth_od_amt                               --第6次逾期金额|Decimal(20,2)
	,t3.seth_od_amt                              --第7次逾期金额|Decimal(20,2)
	,t3.orig_crd_lmt                             --信用额度|DECIMAL(12,2)
	,t3.ini_actv_tm                              --初始激活时间|C8
	,t3.act_late_trx_dt                          --账户最近交易日期|C8
from SJXQ_SJ2024050811_CST_01                           t1
inner join app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd  t2 --信用卡账户信息汇总表
on t1.cst_id=t2.cst_id
and t1.cr_crd_act_id=t2.cr_crd_act_id
and t2.dt='20240430'
inner join edw.dws_bus_crd_cr_crd_act_inf_dd   		    t3 --信用卡账户信息汇总
on t1.cst_id=t3.cst_id
and t1.cr_crd_act_id=t3.cr_crd_act_id
and t3.dt='20240430'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024050811_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050811_CST_03 AS
SElECT t1.card_id							信用卡卡号
    ,t1.cr_crd_act_id                       信用卡账号
    ,t1.cst_id                              客户号
    ,t1.sj_crdt_lmt                         上缴时_信用额度
    ,t1.sj_avg_bal_90d                      上缴时_近90天垫款日均
    ,t2.crd_lmt	                            24年4月末_信用额度
    ,round(t2.cur_90day_adv_mny_day_avg,2)	24年4月末_近90天垫款日均
    ,t2.fst_od_amt+t2.scd_od_amt            24年4月末M0和M1逾期金额
    ,t2.ovd_hi_trm                          逾期期数
    ,t2.ovd_amt                             24年4月末逾期金额
from SJXQ_SJ2024050811_CST_01       t1
inner join SJXQ_SJ2024050811_CST_02 t2
on t1.cr_crd_act_id=t2.cr_crd_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct cr_crd_act_id) custs
from SJXQ_SJ2024050811_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cr_crd_act_id) custs
from SJXQ_SJ2024050811_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 信用卡账号) custs
from SJXQ_SJ2024050811_CST_03
;
/*
01	2255	2255
02	2255	2255
03	2255	2255
*/
/*
--信用卡 交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2024050811_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050811_CST_11 AS
select t1.cr_crd_act_id                          --信用卡账号|C32
	,t1.cr_crd_card_nbr                          --信用卡卡号|C32
	,t1.trx_typ_cd                               --交易类型代码|C32
	,t1.trx_typ_dscr                             --交易类型描述|C32
	,t1.trx_amt                                  --交易金额|DECIMAL(20,2)
	,t1.mch_typ                                  --商户类型|C32
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C32
	,t1.mon_id                                   --月份编号|C32
	,t1.trx_amt_ovp_part_amt                     --交易金额溢缴款部分金额|DECIMAL(20,2)
	,t1.trx_ind                                  --交易标志|C10
	,t1.trx_dscr_1                               --交易描述1|C64
	,t1.trx_dscr_2                               --交易描述2|C64
	,t1.cur_un_intr_bal                          --当前不含利息余额|NUMBER(12,2)
    ,sum(t1.trx_amt) over(partition by t1.cr_crd_act_id order by t1.trx_dt,t1.trx_tm) trx_amt_cum
    ,t1.dt
from edw.dwd_bus_crd_cr_crd_trx_dtl_di  t1   --信用卡客户交易流水
inner join SJXQ_SJ2024050811_CST_02     t2
on t1.cr_crd_act_id=t2.cr_crd_act_id
where t1.dt<='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024050811_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050811_CST_12 AS
select t1.cr_crd_act_id
    ,t1.crd_lmt                     crd_lmt2
    ,t1.act_sts_cd                               --信用卡账户状态|C2
	,t1.bin_sng_day                              --账单日|C2
	,t1.opn_dt                                   --开户日期|C8
	,t1.bal                                      --信用卡余额|Decimal(20,2)
	,t1.late_bil_amt                             --上期账单金额|Decimal(20,2)
	,t1.ovdr_bal                                 --透支余额|Decimal(20,2)
	,t1.ovd_hi_trm                               --逾期期数|BIGINT
	,t1.ovd_amt                                  --逾期金额|Decimal(20,2)
	,t1.instl_rmn_not_paid_prcp_bal              --分期剩余未还本金|Decimal(20,2)
	,t1.fst_od_amt                               --第1次逾期金额|Decimal(20,2)
	,t1.scd_od_amt                               --第2次逾期金额|Decimal(20,2)
	,t1.thd_od_amt                               --第3次逾期金额|Decimal(20,2)
	,t1.foth_od_amt                              --第4次逾期金额|Decimal(20,2)
	,t1.fth_od_amt                               --第5次逾期金额|Decimal(20,2)
	,t1.sth_od_amt                               --第6次逾期金额|Decimal(20,2)
	,t1.seth_od_amt                              --第7次逾期金额|Decimal(20,2)
	,t1.orig_crd_lmt                             --信用额度|DECIMAL(12,2)
	,t1.ini_actv_tm                              --初始激活时间|C8
	,t1.act_late_trx_dt                          --账户最近交易日期|C8
    ,t1.dt
from edw.dws_bus_crd_cr_crd_act_inf_dd   	t1 --信用卡账户信息汇总
inner join SJXQ_SJ2024050811_CST_02         t2
on t1.cr_crd_act_id=t2.cr_crd_act_id
and (t2.ovd_hi_trm<>0 or t2.ovd_amt<>0)
where t1.dt<='20240508'
and (t1.ovd_hi_trm<>0 or t1.ovd_amt<>0)
order by t1.dt
;
*/***SJ2024050936_挂钩理财线上推动.sql
/* 客群1
截止当前购买过重要产品的客户信息，按每笔统计
【挂钩型理财】：名称中包含&ldquo;挂钩&rdquo;
【交银三年期】：名称中包含&ldquo;交银稳享新荣三年期封闭式&rdquo;
【招睿增利精选】：660190TL
【小雪球】：名称中包含丰利兴动多策略封闭式、12740TT、12740TL
*/
-- 客群1 产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_01 AS
select ta_cd
    ,pd_cd                                  --产品代码|C24
	,pd_nm                                  --产品名称|C256
	,clc_start_dt                           --募集开始日期|C8
	,clc_end_dt                             --募集结束日期|C8
	,pd_found_dt                            --产品成立日期|C8
    ,pd_val_dt                              --产品起息日期
	,pd_end_dt                              --产品结束日期|C8
	,actl_found_dt                          --实际成立日期|C8
	,cur_siz                                --当前规模|DECIMAL(20,2)
    ,rsk_grd                                --风险等级
    ,pfm_comp_bas                           --业绩比较基准
    ,pd_actl_clc_amt                        --产品实际募集金额
    ,chm_inv_typ_cd	                        --产品模板|C32
    ,case when pd_nm regexp '挂钩'                        then '挂钩型理财'
        when pd_nm regexp '交银理财稳享鑫荣三年封闭式'      then '交银三年期'
        when pd_nm regexp '招睿增利精选'                   then '招睿增利精选'
        when pd_nm regexp '丰利兴动多策略封闭式|招银理财招睿焦点联动中证' then '小雪球'
        else '' end pd_cls
from edw.dim_bus_chm_pd_inf_dd  --理财产品信息
where dt='20240512'
and pd_nm regexp '挂钩|交银理财稳享鑫荣三年封闭式|招睿增利精选|丰利兴动多策略封闭式|招银理财招睿焦点联动中证'
and pd_sts_cd<>'3'              --发行失败
;
-- 客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_02 AS
SElECT t1.cst_id
    ,t1.age
    ,decode(t1.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t2.rsk_lvl_cd	    --	风险等级代码|decimal
        else t2.rsk_lvl_cd end chm_rsk_lvl_nm
from adm_pub.adm_csm_cbas_idv_bas_inf_dd    t1 --对私客户基础信息
left join edw.dwd_bus_chm_cst_rsk_ases_dd   t2 --理财风评
on t1.cst_id=t2.cst_id
and t2.dt='20240512'
where t1.dt='20240512'
;
-- 主表：指定理财 交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_03 AS
SElECT t1.srl_nbr
    ,t1.bnk_act_id ,t1.cst_id ,t1.pd_cd
    ,t2.pd_nm ,t2.pd_cls
	,SUBSTR(t1.srl_nbr,1,8) trx_dt
	,t1.cfm_amt
	,t1.trx_cd ,t1.bus_cd
    ,t3.invst_mat_dt
from EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI         t1 --理财交易确认流水明细
inner JOIN SJXQ_SJ2024050936_CST_01         t2
on t1.pd_cd=t2.pd_cd
left join edw.dws_bus_chm_act_acm_inf_dd 	t3 --理财账户份额汇总信息
on t1.cst_id=t3.cst_id
and t1.pd_cd=t3.pd_cd
and t1.bnk_act_id=t3.bnk_act_id
and t3.dt='20240512'
where t1.dt<='20240512'         --确认日期
AND t1.trx_sts_cd ='8'          --确认成功
AND T1.cfm_amt <> 0              --交易金额
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_04 AS
SElECT t1.srl_nbr           流水号
    ,t1.cst_id 			    客户号
    ,t2.age                 年龄
    ,t2.gdr_nm              性别
    ,t2.chm_rsk_lvl_nm      客户当前风险评级
    ,t1.pd_cd               购买产品代码
    ,t1.pd_nm               购买产品名称
    ,t1.pd_cls              产品类别
	,t1.trx_dt              购买时间
    ,t1.cfm_amt             购买金额
    ,t1.invst_mat_dt        到期时间
    ,t3.mgr_id              管户人工号
    ,t3.mgr_nm              管户人姓名
    ,t3.pos_nm              管户人岗位
    ,t3.brc_org_nm          管户人所在分行
    ,t3.sbr_org_nm          管户人所在支行
    ,t3.tem_org_nm          管户人所在团队
    ,t4.mgr_id              销售人工号
    ,t4.mgr_nm              销售人姓名
    ,t4.pos_nm              销售人岗位
    ,t4.brc_org_nm          销售人所在分行
    ,t4.sbr_org_nm          销售人所在支行
    ,t4.tem_org_nm          销售人所在团队
from SJXQ_SJ2024050936_CST_03               t1
left join SJXQ_SJ2024050936_CST_02          t2
on t1.cst_id=t2.cst_id
left join(
    select t3.cst_id,t3.pd_cd,t3.bnk_act_id
        ,sum(t3.acs_rto)                            acs_rto
    from EDW.DWS_BUS_CHM_ACT_MGR_INF_DD t3
    LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t4
    ON      t3.acs_org_id = t4.org_id
    AND     t4.dt = '20240512'
    LEFT JOIN    edw.dws_hr_empe_inf_dd         t5 --员工信息汇总
    ON      t3.mgr_id = t5.empe_id
    AND     t5.dt = '20240512'
    LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      t6 --职位信息
    ON      T5.POS_ENC = t6.POS_ID
    AND     t6.DT = '20240512'
    where t3.dt = '20240512'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --理财类型：0基金 1理财
    group by t3.cst_id,t3.pd_cd,t3.bnk_act_id
)t3 on t1.cst_id=t3.cst_id
and t1.pd_cd=t3.pd_cd
and t1.bnk_act_id=t3.bnk_act_id
left join(
    select t3.cst_id,t3.pd_cd,t3.bnk_act_id
        ,sum(t3.acs_rto)                            acs_rto
    from EDW.DWS_BUS_CHM_ACT_MGR_INF_DD t3
    LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t4
    ON      t3.acs_org_id = t4.org_id
    AND     t4.dt = '20240512'
    LEFT JOIN    edw.dws_hr_empe_inf_dd         t5 --员工信息汇总
    ON      t3.mgr_id = t5.empe_id
    AND     t5.dt = '20240512'
    LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD      t6 --职位信息
    ON      T5.POS_ENC = t6.POS_ID
    AND     t6.DT = '20240512'
    where t3.dt = '20240512'
    and t3.MNG_TYP_CD = '2'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --理财类型：0基金 1理财
    group by t3.cst_id,t3.pd_cd,t3.bnk_act_id
)t4 on t1.cst_id=t4.cst_id
and t1.pd_cd=t4.pd_cd
and t1.bnk_act_id=t4.bnk_act_id
;
/* 客群2
购买过理财和三年期存款的客户清单
需满足：
1、客户理财风险评级为稳健型及以上客户
2、客户购买过理财，且购买过3年期及以上存款
*/
-- 存款账户管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_10 AS
Select t3.dep_act_id
    ,t3.mgr_id,t3.mgr_rto,t3.acs_org_id,t3.dep_trm mng_dep_trm
    ,t4.empe_nm mgr_nm
    ,T5.BRC_ORG_NM,T5.SBR_ORG_NM,T5.TEM_ORG_NM,T5.ORG_NM
from edw.dws_bus_dep_act_mgr_inf_dd	        t3 --存款账户管护汇总信息
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t3.mgr_id=t4.empe_id
and t4.dt='20240512'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.acs_org_id=t5.org_id
and t5.dt='20240512'
where t3.dt='20240512'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_11 AS
Select dep_act_id,count(1) mgr_num
        ,sum(mgr_rto)                            mgr_rto
from SJXQ_SJ2024050936_CST_10
group by dep_act_id
;
-- 购买过3年期及以上存款
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_12 AS
select t1.dep_act_id                               --存款账号|C32
	,t1.cst_act_id                               --客户账号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.act_nm                                   --账户名称|C300
	,t1.dep_trm                                  --存期|C6
	,t1.int_val_dt                               --起息日期|C8
	,t1.mtu_dt                                   --到期日期|C8
	,t1.opn_dt                                   --开户日期|C8
	,t1.act_dstr_act_dt                          --销户日期|C8
	,t1.gl_bal                                   --账户总账余额|DECIMAL(20,2)
	,t1.prod_id                                  --存款产品代码|C24
    ,t2.pd_cmt
	,t1.dep_cls_cd                               --存款种类|C4
    ,c1.cd_val_dscr     dep_cls_nm
	,t1.opn_amt                                  --开户金额|DECIMAL(20,2)
	,t1.cur_act_bal                              --当前账户余额|DECIMAL(20,2)
    ,t3.mgr_id,t3.mgr_rto,t3.mgr_nm,t3.brc_org_nm,t3.sbr_org_nm,t3.tem_org_nm,t3.mgr_num
    ,row_number() over(partition by t1.CST_ID order by t1.opn_dt desc) rn
FROM EDW.DWS_BUS_DEP_ACT_INF_DD	            t1 --存款账户信息表
left join edw.dim_bus_dep_pd_bas_inf_dd	    t2 --存款产品基础信息表
on t1.prod_id=t2.pd_id
and t2.dt='20240512'
left join SJXQ_SJ2024050936_CST_11          t3
on t1.dep_act_id=t3.dep_act_id
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON t1.dep_cls_cd = C1.CD_VAL
AND C1.DT = '20240512'
WHERE t1.DT='20240512'
and  t1.lbl_prod_typ_cd<>'0' --存款产品类型代码 0:活期 1:定期 非活期外的存款
-- or DATEDIFF(TO_DATE( t1.mtu_dt,'yyyymmdd'),TO_DATE( t1.opn_dt,'yyyymmdd'),'DD')>1080) 存款会存在转存，直接用存期
and  t1.opn_amt<>0
;
-- 购买过理财
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_13 AS
select distinct cst_id
from EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI         t1 --理财交易确认流水明细
inner JOIN edw.dim_bus_chm_pd_inf_dd        t2
on t1.pd_cd=t2.pd_cd
and t2.pd_ctg_cd='1' --理财
and t2.dt='20240512'
where t1.dt<='20240512'         --确认日期
AND t1.trx_sts_cd ='8'          --确认成功
AND T1.cfm_amt <> 0              --交易金额 trx_amt <> 0 等价
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_14 AS
SElECT t1.cst_id 			客户号
    ,t1.age                 年龄
    ,t1.gdr_nm              性别
    ,t1.chm_rsk_lvl_nm      客户当前风险评级
	,t2.prod_id             购买存款代码
    ,t2.pd_cmt              购买存款名称
	,t2.opn_dt              开户日期
	,t2.int_val_dt          起息日期
	,t2.opn_amt             开户金额
	,t2.mtu_dt              到期日期
    ,t2.mgr_id              管户人工号
    ,t2.mgr_nm              管户人姓名
    ,T2.BRC_ORG_NM          管户人所在分行
    ,T2.SBR_ORG_NM          管户人所在支行
    ,T2.TEM_ORG_NM          管户人所在团队
from SJXQ_SJ2024050936_CST_02       t1 --稳健型及以上
inner join SJXQ_SJ2024050936_CST_12 t2 --购买过3年期及以上存款
on t1.cst_id=t2.cst_id
inner join SJXQ_SJ2024050936_CST_13 t3 --购买过理财
on t1.cst_id=t3.cst_id
where t1.rsk_lvl_cd>='2'
;
/*
客群3
4月份购买过大额存单的客户清单
*/
--4月份购买过大额存单的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_21 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_21 AS
SELECT  t1.cst_id
    ,t1.dep_act_id	            --存款账号|C8
    ,t1.act_nm	                --账户名称|C200
    ,t1.cst_act_id	            --客户账号|C32
    ,t1.prod_id	                --产品编号|C24
    ,t1.act_sts_cd	            --账户状态代码|C1
    ,decode(t1.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结','F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts_nm
    ,t1.opn_dt          --开户时间
    ,t1.opn_amt         --开户金额
    ,t1.dep_trm	        --存期
    ,t1.mtu_dt	        --到期日期
    ,t1.stl_act_ind
    ,t1.ACT_CTG_CD_1
    ,t3.mgr_id,t3.mgr_rto,t3.mgr_nm
    ,t3.brc_org_nm,t3.sbr_org_nm,t3.tem_org_nm,t3.mgr_num
FROM    edw.dim_bus_dep_act_inf_dd          t1
left join SJXQ_SJ2024050936_CST_11          t3
on t1.dep_act_id=t3.dep_act_id
WHERE   t1.dt = '20240512'
and     t1.opn_dt between '20240401' and '20240430'
and     t1.opn_amt<>0
-- and ACT_STS_CD <> 'C' and stl_act_ind='1'   --结算账户 6914401 cst_act_id 99%近似唯一
-- and ACT_CTG_CD_1 NOT IN ( '0501' , '0509' , '0601' )    --账户状态正常
;
--输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_22 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_22 AS
Select t1.cst_id            客户号
    ,t2.age                 年龄
    ,t2.gdr_nm              性别
    ,t1.prod_id             产品编号
    ,t1.opn_dt              开户时间
    ,t1.opn_amt             开户金额
    ,t1.dep_trm	            存期
    ,t1.mtu_dt	            到期日期
    ,t1.act_sts_nm          账户状态
    ,t1.mgr_id 				管户人工号
    ,t1.mgr_nm              管户人姓名
    ,t1.BRC_ORG_NM          管户人所在分行
    ,T1.SBR_ORG_NM          管户人所在支行
    ,T1.TEM_ORG_NM          管户人所在团队
    ,t3.aum_bal             客户AUM_含存款
    ,t3.aum_bal-t4.dep_bal  客户AUM_不含存款
from SJXQ_SJ2024050936_CST_21       t1
left join SJXQ_SJ2024050936_CST_02  t2
on t1.cst_id=t2.cst_id
LEFT JOIN adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t3
ON      t1.cst_id = t3.cst_id
AND     t3.dt = '20240512'
LEFT JOIN adm_pub.ADM_CSM_CBUS_DEP_INF_DD           T4
ON      T1.cst_id = T4.cst_id
AND     t4.dt = '20240512'
;
SElECT '01' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024050936_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024050936_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct srl_nbr) custs
from SJXQ_SJ2024050936_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 流水号) custs
from SJXQ_SJ2024050936_CST_04
union all
SElECT '10' seq, count(1) cnt,count(distinct dep_act_id,acs_org_id,mgr_id) custs
from SJXQ_SJ2024050936_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024050936_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024050936_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024050936_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024050936_CST_14
union all
SElECT '21' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024050936_CST_21
union all
SElECT '22' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024050936_CST_22
;
/*
01	218	218
02	14977670	14977670
03	49335	49335
04	49335	49335
10	21112388	21112388
11	20959716	20959716
12	5806988	5806988
13	308984	308984
14	1048987	109350
21	5196	5196
22	5196	4280
SJ2024050936_挂钩理财线上推动 问题
需求表3. 4月份购买过大额存单 要限制 账户状态正常吗？ 不限制
*/
/*
脏数据核查 DEP_TRM 与 opn_dt mtu_dt 天数不一致 用 int_val_dt 119364 条存款有问题 opn_dt 394332 条存款有问题
结论：客户提前解封定存。
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_12_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_12_1 AS
Select t1.dep_act_id,t1.cst_id,t1.act_nm,t1.pd_cmt
	,t1.dep_trm dep_trm1                         --存期|C6
    ,t1.int_val_dt
	,t1.mtu_dt mtu_dt1                           --到期日期|C8
	,t1.opn_dt opn_dt1                           --开户日期|C8
    ,t2.dep_trm	            --存期|C6
    ,t2.mtu_dt	            --到期日期|C8
    ,t2.ini_mtu_dt	        --初始到期日期|C8
    ,t2.opn_dt	            --开户日期|C8
    ,t2.act_dstr_act_dt	    --账户销户日期|C8
    ,t2.gl_bal	            --总账余额|DECIMAL(20,2)
    ,t2.bal_late_upd_dt	    --余额最近更新日期|DECIMAL(20,2)
    ,t2.frs_dep_dt	        --首次存入日期|C8
from SJXQ_SJ2024050936_CST_12           t1
left join edw.dim_bus_dep_act_inf_dd    t2 --存款账户信息
on t1.dep_act_id=t2.dep_act_id
and t2.dt='20240512'
where t1.is_3y_dep=0
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024050936_CST_12_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050936_CST_12_2 AS
select t1.dep_act_id,t2.cst_id                               --存款账号|C32
    ,t2.dep_trm,t2.opn_dt,t2.mtu_dt
	,t1.dtl_seq_nbr                              --明细序号|INTEGER
	,t1.trx_dt                                   --交易日期|C8
	,t1.trx_tm                                   --交易时间|C9
	,t1.crd_and_dbt_ind                          --借贷标志|C1
	,t1.trx_amt                                  --交易金额|DECIMAL(21,2)
	,t1.act_bal                                  --账户余额|DECIMAL(21,2)
	,t1.txt_code                                 --摘要代码|C10
	,t1.smr_dscr                                 --摘要描述|C512
	,t1.cnt_pty_act_nm                           --对方户名|c200
	,t1.cnt_pty_fin_instt_nm                     --对方金融机构名称|C200
	,t1.agn_nm                                   --代理人姓名|C200
	,t1.cmt                                      --备注|C200
	,t1.act_nm                                   --账户名称|C200
	,t1.bal_fld_nm                               --余额字段名称|C32
	,t1.prod_id                                  --产品编号|C24
from edw.dwd_bus_dep_bal_chg_dtl_di   t1         --存款账户余额发生明细
inner join SJXQ_SJ2024050936_CST_12_1 t2
on t1.dep_act_id=t2.dep_act_id
where t1.dt<='20240512'
;
*/***SJ2024050996_2024第二期举一反三.sql
/*
1.数据范围
丽水分行截至2024年4月30日授信状态&ldquo;正常&rdquo;的、授信余额＞50的贷款和卡业务
2.数据需求字段
合同流水号、客户编号、客户名称、业务类型、行业投向、贷款用途备注、发生类型、执行利率、合同金额、合同余额、合同起始日、合同到期日、结清日期、
是否异地、客户经营地址（省市区县-具体地址）、客户居住地址（省市区县-具体地址）、资产负债率、总资产金额、
资产-不动产评估价值合计、资产&mdash;车辆评估价值合计、资产&mdash;存货评估价值合计、资产&mdash;应收账款评估价值合计、
负总负债金额、经营基本情况分析、财务状况分析、资产负债情况分析、管户机构号、管户人姓名、经办机构号、经办人姓名、业务部门审查人姓名、最终审批人姓名。
3.针对上述范围，数据需求的重点是具备以下特征的业务，每一个特征形成一张疑点数据表单，谢谢！
一是排查【虚构客户资产】，业务特征有：
1）借款人资产-不动产模块中详细地址不明确没有具体门牌号，
2）借款人征信数据查询无&ldquo;个人住房商业贷款&rdquo;的，系统中有资产-不动产信息录入；
3）在2023年，借款人年龄小于等于25岁的，系统中有资产-不动产信息录入；
4）个人借款人在我行近5年申请信贷业务过程中，调查报告的调查痕迹为居住地走访的且地址有变化的。
二是排查【夸大客户的实际资产（价值虚高）】，业务特征有：
1）近三笔业务客户名下资产-不动产评估价值合计且变化幅度＜10%的业务；
2）近一笔客户资产-不动产评估价值合计大于上一笔或上上一笔的合计业务；
3）借款人资产-不动产模块中评估价值＞购买价值的70%以上；
三是排查【存货、应收账款、对外投资超过总资产的50%，未进行交叉验证】，业务特征有：
1）资产负债率大于70%的业务；
2）存货、应收账款、对外投资合计超过总资产的50%的业务。
问题：
1. 丽水分行 管户机构？是
2. 授信余额＞50万的贷款和随贷通卡业务
3. 经营基本情况分析、财务状况分析、资产负债情况分析，这几个分析有具体字段吗？自己探索
4. 资产-不动产模块 edw.loan_survey_customer_assets 客户资产信息表 无数据？edw.LOAN_SURVEY_CUSTOMER_REALTY
5. 对外投资是 资产-短期投资+资产-长期投资？ app_rpt.adm_subl_search_report_cst_all_asset_invest 对外投资 inv_asset_net
1.1 详细地址不明确如何定义？地址字段加密，客户会存在多个房产
1.4 调查方式为现场调查，同一笔业务会存在调查多个地点？
2.1 是绝对值小于10%？价值虚高 不应该是变化幅度大于 10%吗？客户没有3笔业务，默认之前为0？
2.2 客户没有3笔业务，默认之前为0？
*/
-- 信贷合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_01 AS
select t1.busi_ctr_id                      --业务合同编号 BC
	,t1.busi_apl_id                        --业务申请编号 BA
	,t1.crd_ctr_id                         --授信合同编号 空
	,t1.pd_cd                              --产品代码|C4
	,t1.cst_id                             --客户编号|C20
	,t1.cst_nm                             --客户名称|C200
	,t1.apnt_start_dt                      --约定开始日期|C8
	,t1.apnt_mtu_dt                        --约定到期日期|C8
	,t1.ccy_cd                             --币种代码|C3
	,t1.ctr_amt                            --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                            --合同余额|DECIMAL(20,2)
	,t1.intr_rat                           --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                        --贷款用途代码|C4
    ,c3.cd_val_dscr     loan_usg_nm
	,t1.usg_cmt                            --用途备注|c4
	,t1.cmt                                --备注|c1000
	,t1.hpn_typ_cd                         --发生类型代码|C32
    ,c4.cd_val_dscr     hpn_typ_nm
	,t1.prcp_pyf_dt                        --本金结清日期|C10
	,t1.loan_dir_cd                        --贷款投向代码|C5
    ,t1.sub_loan_dir_cd	                   --行业投向细分|C32
    ,c2.cd_val_dscr     sub_loan_dir_nm
	,t1.bus_typ                            --业务类型|C10
    ,decode(t1.bus_typ,'010','贷款类业务','090','随贷通卡业务') bus_typ_nm
    ,t1.rmt_loan_ind	                   --异地贷款标志|C3
	,t2.acs_org_id                         --管护机构编号|C12
	,t2.acs_mngr_id                        --管户客户经理编号|C32
    ,c1.empe_nm         acs_mngr_nm
	,t2.rcm_org_id                         --推荐机构编号|C32
	,t2.rcm_psn_id                         --推荐人编号|C32
	,t2.rcm_psn_nm                         --推荐人姓名|C200
    ,t3.brc_org_nm
	,t4.cst_chn_nm              --客户姓名|C200
    ,t4.reg_adr	                --户籍地址|注册地址|C256
    ,t4.cmn_adr	                --通讯地址|C256
	,t4.wrk_adr                 --工作单位地址|经营所在地地址|C256
	,t4.fml_adr                 --家庭地址|C256
    ,t5.age
    ,t6.is_hse_loan	            --是否有房贷
	,t7.opr_org_id                               --经办机构号
    ,CONCAT(T7.OPR_USER_ID, T7.OPR_USER_NM)           AS OPR_USER_NM        --经办客户经理
    ,CONCAT(T7.OPR_ORG_CHGER_ID, T7.OPR_ORG_CHGER_NM) AS OPR_ORG_CHGER_NM   --经办部门负责人
    ,CONCAT(T7.OPR_PR_USER_ID, T7.OPR_PR_USER_NM)     AS OPR_PR_USER_NM     --经办支行行长
    ,CONCAT(T7.OPR_ADTER_ID, T7.OPR_ADTER_NM)         AS OPR_ADTER_NM       --经办审查人
    ,CONCAT(T7.FNL_APV_ID, T7.FNL_APV_NM)             AS FNL_APV_NM         --最终审批人
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同管护信息
on  t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='20240430'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t2.acs_org_id=t3.org_id
and t3.dt='20240430'
and t3.brc_org_nm='丽水分行'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t2.acs_mngr_id=c1.empe_id
and c1.dt='20240430'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.SUB_LOAN_DIR_CD = C2.CD_VAL
AND C2.DT = '20240430'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t1.loan_usg_cd = C3.CD_VAL
AND C3.DT = '20240430'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON  t1.hpn_typ_cd = C4.CD_VAL
AND C4.DT = '20240430'
left join edw.dws_cst_bas_inf_dd                t4 --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20240430'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t5 --对私客户基础信息
on t1.cst_id=t5.cst_id
and t5.dt='20231231'   --23年底年龄
left join adm_pub.adm_csm_cbas_ccrc_inf_dd	    t6 --客户集市-基础信息-客户征信基础信息表
on t1.cst_id=t6.cst_id
and t6.dt='20240430'
LEFT join adm_pub.adm_rsk_bus_loan_mngmt_flow_mdl_dd t7 --风险集市信贷业务合同信息模型表
on t1.busi_apl_id=t7.busi_apl_id
and t7.dt='20240430'
where t1.dt='20240430'
and t1.ctr_bal>500000           --余额 >50万
-- AND     t1.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
-- AND     (t1.chnl_cd <> 'L08' OR t1.pd_cd <> '201050101040335' )  --剔除 小鱼分期
-- AND     t1.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
-- AND     t1.pd_cd <> '201050101040319'                            --剔除 百度分期贷
AND(
    (
        (t1.ctr_bal > 0 OR (t1.ctr_bal IS NULL AND nvl(t1.crc_ind,'0')='0')    --非循环贷有余额
            OR((nvl(t1.crc_ind, '0') <> '0' OR t1.pd_cd LIKE '2010503%')      --随贷通
                AND (t1.ctr_bal = 0 OR t1.ctr_bal IS NULL)
                AND t1.apnt_mtu_dt >= '20240430'
            ) --（循环贷 或 随贷通） 且 余额为0 且 未到期
        ) AND nvl(t1.frz_sts_cd,'') NOT IN ( '3' , '4' ) --3到期失效 4终止失效
    ) OR (t1.ctr_bal > 0 AND t1.pd_cd LIKE '2010503%'
        AND t1.apnt_mtu_dt <= '20240430'
        AND t1.frz_sts_cd IN ( '3' , '4' )
    ) --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
) --未终结、未到期业务
;
--客户资产概况
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_02 AS
SElECT customerid cst_id
    ,businessno	--业务编号 SRI
    ,serialno	--记录编号
    ,recorddate	--记录日期
	,sum1                                   --总资产金额
	,sum2                                   --总负债金额
	,sum3                                   --净资产金额
	,sum4                                   --本人资产总额
	,sum5                                   --本人负债总额
	,sum6                                   --本人净资产总额
    ,sum7                                   --对外担保总余额
    ,sum8                                   --资产负债率
    ,row_number() over(partition by customerid order by recorddate desc,businessno desc) rn
FROM edw.loan_survey_customer_assetsgeneral   --客户资产概况
where dt='20240430'
-- and status = '1' --'0','不可修改','1','可修改','2','暂不修改'(暂不限定资产状态)
;
-- 调查报告-客户资产信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_03 AS
SELECT  businessno,assettype    --SRI
        ,sum(nvl(presentvalue,0))   presentvalue
FROM    edw.loan_survey_customer_assets --客户资产信息表
WHERE   dt = '20240430'
-- '090'不动产,'100'车辆 2023年以来数据均为空
GROUP BY businessno,assettype
;
--调查报告财报信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_04 AS
select t1.busi_ctr_id
    ,t2.serialno            --报告流水号 SRI
	,t2.businessno          --申请流水号 BA
	,t2.customertype        --客户类型
    ,t2.exposureamount	    --敞口金额
	,t2.businesstype        --产品类型
	,t2.istakeeffect        --是否有效
    ,t2.datasource	        --报告数据来源
    ,t3.presentvalue    eval_yszk
    ,t4.presentvalue    eval_cunh
    ,t5.inv_asset_net
    ,case when t6.businessno is not null then 1 else 0 end is_has_realty
    ,t6.evalp_realty,t6.buyp_realty
    ,t7.evalp_vehicle
from SJXQ_SJ2024050996_CST_01           t1
inner join edw.loan_survey_report_info  t2 --调查报告财报信息
on  t1.busi_apl_id=t2.businessno
and t2.dt='20240430'
left join SJXQ_SJ2024050996_CST_03      t3
on  t2.serialno=t3.businessno
and t3.assettype='050'
left join SJXQ_SJ2024050996_CST_03      t4
on  t2.serialno=t4.businessno
and t4.assettype='070'  --存货
left join(
    SElECT bus_id
        ,sum(nvl(inv_asset_net, 0))  inv_asset_net
    from app_rpt.adm_subl_search_report_cst_all_asset_invest --调查报告表_对外投资
    where dt = '20230430'
    group by bus_id
)t5 on t2.serialno=t5.bus_id
left join(
    SELECT  businessno
            ,sum(nvl(evaluateprice, 0)) evalp_realty
            ,sum(nvl(buildprice,0))     buyp_realty
    FROM    edw.loan_survey_customer_realty --客户房产资产信息
    WHERE   dt = '20230430'
    GROUP BY businessno
)t6 on t2.serialno=t6.businessno
left join(
    SELECT  businessno
            ,sum(nvl(estimateprice, 0)) evalp_vehicle
    FROM    edw.loan_survey_customer_vehicle --客户车辆资产信息
    WHERE   dt = '20230430'
    GROUP BY businessno
)t7 on t2.serialno=t7.businessno
;
--客户经营基本情况表
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_05 AS
select businessno           --SRI
	,customerid             --客户号
	,serialno               --流水号
    ,project	            --经营项目
    ,employeesnum	        --员工人数
    ,outputvalue	        --今年产值（人民币元）
    ,sales	                --今年销售额（人民币元）
    ,profit	                --今年利润总额（人民币元）
    ,profitrate	            --今年利润率
    ,remark	                --备注
    ,monavgsalary	        --员工月平均工资
    ,workyear	            --经营年限
from edw.loan_survey_customer_operation       --客户经营基本情况表
where dt='20240430'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_06 AS
SElECT t1.busi_ctr_id                      --业务合同编号 BC
	,t1.busi_apl_id                        --业务申请编号 BA
	,t1.cst_id                             --客户编号|C20
	,t1.cst_nm                             --客户名称|C200
	,t1.apnt_start_dt                      --约定开始日期|C8
	,t1.apnt_mtu_dt                        --约定到期日期|C8
	,t1.ctr_amt                            --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                            --合同余额|DECIMAL(20,2)
	,t1.intr_rat                           --利率|DECIMAL(14,8)
	,t1.loan_usg_nm                        --贷款用途代码|C4
	,t1.usg_cmt                            --用途备注|c4
	,t1.cmt                                --备注|c1000
	,t1.hpn_typ_nm                         --发生类型代码|C32
	,t1.prcp_pyf_dt                        --本金结清日期|C10
    ,t1.sub_loan_dir_nm	                   --行业投向细分|C32
	,t1.bus_typ_nm                         --业务类型|C10
    ,t1.rmt_loan_ind	                   --异地贷款标志|C3
	,T1.acs_org_id                         --管护机构编号|C12
	,T1.acs_mngr_id                        --管户客户经理编号|C32
    ,t1.acs_mngr_nm
    ,t1.reg_adr	                --户籍地址|注册地址|C256
    ,t1.cmn_adr	                --通讯地址|C256
	,t1.wrk_adr                 --工作单位地址|经营所在地地址|C256
	,t1.fml_adr                 --家庭地址|C256
    ,t1.age
    ,t1.is_hse_loan	            --是否有房贷
	,t1.opr_org_id              --经办机构号
    ,T1.OPR_USER_NM             --经办客户经理
    ,T1.OPR_ORG_CHGER_NM        --经办部门负责人
    ,T1.OPR_PR_USER_NM          --经办支行行长
    ,T1.OPR_ADTER_NM            --经办审查人
    ,T1.FNL_APV_NM              --最终审批人
    ,T2.sum1,t2.sum2,t2.sum3,t2.sum4,t2.sum5,t2.sum6,t2.sum7,t2.sum8
    ,t3.serialno            --报告流水号 SRI
    ,t3.exposureamount	    --敞口金额
    ,t3.eval_yszk ,t3.eval_cunh ,t3.inv_asset_net
    ,t3.is_has_realty,t3.evalp_realty,t3.buyp_realty
    ,t3.evalp_vehicle
    ,t4.businessno
    ,t4.project,t4.employeesnum,t4.outputvalue,t4.sales,t4.profit
    ,t4.profitrate,t4.remark,t4.monavgsalary,t4.workyear
from SJXQ_SJ2024050996_CST_01       t1
left join SJXQ_SJ2024050996_CST_02  t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ2024050996_CST_04  t3
on t1.busi_ctr_id=t3.busi_ctr_id
left join SJXQ_SJ2024050996_CST_05  t4
on t3.serialno=t4.businessno
;
--输出字段
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_07 AS
SElECT busi_ctr_id                  业务合同编号
	,cst_id                         客户编号
	,cst_nm                         客户名称
	,bus_typ_nm                     业务类型
    ,sub_loan_dir_nm	            行业投向细分
	,loan_usg_nm                    贷款用途
	,usg_cmt                        用途备注
	,cmt                            备注
	,hpn_typ_nm                     发生类型
	,intr_rat                       利率
	,ctr_amt                        合同金额
	,ctr_bal                        合同余额
	,apnt_start_dt                  约定开始日期
	,apnt_mtu_dt                    约定到期日期
	,prcp_pyf_dt                    本金结清日期
    ,rmt_loan_ind	                异地贷款标志
	,wrk_adr                        工作单位地址
    ,reg_adr	                    户籍地址
	,fml_adr                        家庭地址
	,sum1                           总资产金额
	,sum2                           总负债金额
	,sum3                           净资产金额
	,sum4                           本人资产总额
	,sum5                           本人负债总额
	,sum6                           本人净资产总额
    ,sum7                           对外担保总余额
    ,sum8                           资产负债率
    ,evalp_realty                   资产_不动产评估价值合计
    ,evalp_vehicle                  资产_车辆评估价值合计
    ,eval_cunh                      资产_存货评估价值合计
    ,eval_yszk                      资产_应收账款评估价值合计
    ,project	                    经营项目
    ,employeesnum	                员工人数
    ,outputvalue	                今年产值_人民币元
    ,sales	                        今年销售额_人民币元
    ,profit	                        今年利润总额_人民币元
    ,profitrate	                    今年利润率
    ,monavgsalary	                员工月平均工资
    ,workyear	                    经营年限
	,acs_org_id                     管护机构编号
    ,acs_mngr_nm                    管户人姓名
	,opr_org_id                     经办机构号
    ,OPR_USER_NM                    经办客户经理
    ,OPR_ADTER_NM                   经办审查人
    ,FNL_APV_NM                     最终审批人
from SJXQ_SJ2024050996_CST_06
;
-- 一是排查【虚构客户资产】，业务特征有：
-- 1）借款人资产-不动产模块中详细地址不明确没有具体门牌号
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_08 AS
select businessno                             --业务编号
	,customerid                               --客户编号
	,serialno                                 --流水号
    ,realtyname
	,realtyadd                                --房屋地址
    ,case when realtyadd regexp '[0-9]+室'          then '室'
        when realtyadd regexp '[0-9]{3,}$'          then '数字结尾'
        when realtyadd regexp '[A-Z0-9-]{2,}房号'   then '房号'
        when realtyadd regexp '[0-9-]{2,}号'        then '房号'
        when realtyadd regexp '[0-9-]{2,}层'        then '层'
        when realtyadd regexp '村$'         then '村结尾'   --暂定以下为不明确
        when realtyadd regexp '[0-9]号'     then '号'
        when realtyadd regexp '村'          then '含村'
        else '' end house_cls
	,evaluateprice                            --评估价格(元)
	,remark                                   --备注
	,inputtime                                --录入时间
from edw.loan_survey_customer_realty          --客户房产资产信息
where dt='20240430'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_09 AS
SElECT t1.realtyadd 资产_不动产详细地址
    ,t3.*
from (
    -- 存在任一房产地址不明
    SElECT businessno
    from SJXQ_SJ2024050996_CST_08
    group by businessno
)t1 inner join SJXQ_SJ2024050996_CST_06        t2
on t1.businessno=t2.businessno
inner join SJXQ_SJ2024050996_CST_07 t3
on t2.busi_ctr_id=t3.业务合同编号
;
-- 2）借款人征信数据查询无&ldquo;个人住房商业贷款&rdquo;的，系统中有资产-不动产信息录入；
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_10 AS
SElECT t2.*
from SJXQ_SJ2024050996_CST_06       t1
inner join SJXQ_SJ2024050996_CST_07 t2
on t1.busi_ctr_id=t2.业务合同编号
where t1.is_hse_loan='0'   --征信数据查询无&ldquo;个人住房商业贷款&rdquo;
and t1.is_has_realty=1     --系统中有资产-不动产信息
;
-- 3）在2023年，借款人年龄小于等于25岁的，系统中有资产-不动产信息录入；
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_11 AS
SElECT t2.*
from SJXQ_SJ2024050996_CST_06       t1
inner join SJXQ_SJ2024050996_CST_07 t2
on t1.busi_ctr_id=t2.业务合同编号
where t1.age<=25            --2023年底
and t1.is_has_realty=1      --系统中有资产-不动产信息
;
-- 4）个人借款人在我行近5年申请信贷业务过程中，调查报告的调查痕迹为居住地走访的且地址有变化的。
-- 同一个业务调查，也会调查不同地点，比如：借款人、担保人的住所、经营地
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_12 AS
left join edw.dwd_bus_loan_apl_inf_dd   t3 --信贷业务申请信息
on  t2.busi_apl_id = t3.apl_id
and t3.dt='@@{yyyyMMdd}'
SELECT *
from edw.loan_survey_customer_survey
where dt='20240430'
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD C
ON      B.SURFIELDTYPE = C.CD_VAL
AND     C.DT = '20231007'
AND     UPPER(C.FLD_NM) = 'SURFIELDTYPE'
-- 二是排查【夸大客户的实际资产（价值虚高）】，业务特征有：
/* 1）近三笔业务客户名下资产-不动产评估价值合计且变化幅度＜10%的业务；
2. 近三笔业务客户名下资产-不动产评估价值合计且变化幅度＜10%的业务：变化幅度1=（最近一笔-上笔）/最近一笔；
    变化幅度2=（上笔-上上笔）/上笔；变化幅度3=（最近一笔-上上笔）/上上笔；
    3个变化幅度，任意一个<10%,就纳入到名单里。取数时把变化幅度1、2、3也放到名单里。
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_15 AS
SElECT customerid cst_id
    ,evalp_realty
    ,row_number() over(partition by customerid order by businessno desc) rn
from(
    SELECT  businessno,customerid	                    --客户编号
        ,sum(nvl(evaluateprice, 0))     evalp_realty    --资产-不动产评估价值
    FROM    edw.loan_survey_customer_realty --客户房产资产信息
    WHERE   dt = '20230430'
    GROUP BY businessno,customerid
)t1 where evalp_realty<>0
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_16 AS
SElECT t1.cst_id
    ,t1.evalp_realty    lst1_realty
    ,t2.evalp_realty    lst2_realty
    ,t3.evalp_realty    lst3_realty
    ,case when nvl(t1.evalp_realty,0)<>0 then round((t1.evalp_realty-t2.evalp_realty)/t1.evalp_realty,4)
        else 0 end rate1
    ,case when nvl(t2.evalp_realty,0)<>0 then round((t2.evalp_realty-t3.evalp_realty)/t2.evalp_realty,4)
        else 0 end rate2
    ,case when nvl(t3.evalp_realty,0)<>0 then round((t1.evalp_realty-t3.evalp_realty)/t3.evalp_realty,4)
        else 0 end rate3
from SJXQ_SJ2024050996_CST_15       t1
left join SJXQ_SJ2024050996_CST_15  t2
on t1.cst_id=t2.cst_id
and t2.rn=2     --上笔
left join SJXQ_SJ2024050996_CST_15  t3
on t1.cst_id=t3.cst_id
and t3.rn=3     --上上笔
where t1.rn=1   --最近一笔
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_17 AS
SElECT t1.rate1,t1.rate2,t1.rate3
    ,t2.*
from SJXQ_SJ2024050996_CST_16       t1
inner join SJXQ_SJ2024050996_CST_07 t2
on t1.cst_id=t2.客户编号
where t1.rate1<0.1
or t1.rate2<0.1
or t1.rate3<0.1
;
-- 2）近一笔客户资产-不动产评估价值合计大于上一笔或上上一笔的合计业务；
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_18 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_18 AS
SElECT t1.lst1_realty,t1.lst2_realty,t1.lst3_realty
    ,t2.*
from SJXQ_SJ2024050996_CST_16       t1
inner join SJXQ_SJ2024050996_CST_07 t2
on t1.cst_id=t2.客户编号
where  t1.lst1_realty>t1.lst2_realty
or t1.lst1_realty>t1.lst3_realty
;
-- 3）借款人资产-不动产模块中评估价值＞购买价值的70%以上；
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_19 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_19 AS
SElECT t2.*
from SJXQ_SJ2024050996_CST_06       t1
inner join SJXQ_SJ2024050996_CST_07 t2
on t1.busi_ctr_id=t2.业务合同编号
where t1.evalp_realty>t1.buyp_realty*0.7
;
-- 三是排查【存货、应收账款、对外投资超过总资产的50%，未进行交叉验证】，业务特征有：
-- 1）资产负债率大于70%的业务；
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_20 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_20 AS
SElECT *
from SJXQ_SJ2024050996_CST_07
where 资产负债率 > 0.7
;
-- 2）存货、应收账款、对外投资合计超过总资产的50%的业务。
DROP   TABLE IF     EXISTS SJXQ_SJ2024050996_CST_21 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024050996_CST_21 AS
SElECT t2.*
from SJXQ_SJ2024050996_CST_06       t1
inner join SJXQ_SJ2024050996_CST_07 t2
on t1.busi_ctr_id=t2.业务合同编号
where nvl(t1.eval_cunh,0) + nvl(t1.eval_yszk,0) + nvl(t1.inv_asset_net,0) > nvl(sum1,0)*0.5
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024050996_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024050996_CST_02 WHERE rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct businessno,assettype) custs
from SJXQ_SJ2024050996_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024050996_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct businessno) custs
from SJXQ_SJ2024050996_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct businessno) custs
from SJXQ_SJ2024050996_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 业务合同编号) custs
from SJXQ_SJ2024050996_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct businessno) custs
from SJXQ_SJ2024050996_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024050996_CST_09
/*
01	5015	5015
02	546388	546388
03	1300316	1300316
04	4900	4900
05	485085	485085
06	5015	2642
07	5015	5015
*/***SJ2024051071-蔡含露-010694.sql
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_chl_20240510_001;
CREATE TABLE lab_bigdata_dev.tmp_yxw_chl_20240510_001 AS
SELECT  T1.trx_dt       as  签约日期
       ,T7.ctr_dt       as  首次签约日期
       ,T1.cst_id       as  签约客户号
       ,T5.cd_val_dscr  as  交易类型
       ,CASE  WHEN  T1.trx_dt=T7.ctr_dt  THEN  '是'
              WHEN  T1.trx_dt>T7.ctr_dt  THEN  '否'
              ELSE  '异常' end   AS  是否首次签约
       ,T6.cd_val_dscr  as  交易渠道
       ,2024-SUBSTR(T2.bth_dt,1,4)  as 签约客户年龄
       ,T1.trx_tlr_id   as  交易柜员工号
       ,T3.empe_nm      as  交易柜员名字
       ,T1.trx_org_id   as  签约机构号
       ,T4.sbr_org_nm       as 签约支行
FROM   edw.dwd_bus_chm_act_rqs_srl_dtl_di  T1  --理财账户类请求流水明细
left JOIN edw.dws_cst_idv_bas_inf_dd       T2 ON  T1.cst_id=T2.cst_id  and T2.dt='@@{yyyyMMdd}'
left JOIN edw.dim_hr_empe_bas_inf_dd       T3 ON  T1.trx_tlr_id=T3.empe_id  and T3.dt='@@{yyyyMMdd}'
left JOIN edw.dim_hr_org_mng_org_tree_dd   T4 ON  T1.trx_org_id=T4.org_id  and T4.dt='@@{yyyyMMdd}'
left join (
    select DISTINCT cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where dt='@@{yyyyMMdd}'
)  T5 on  T1.trx_cd=T5.cd_val
left join (
    select DISTINCT cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where dt='@@{yyyyMMdd}'
)  T6 on  T1.TRX_CHNL_CD=T6.cd_val
left JOIN (
    select A1.cst_id
          ,A1.ctr_dt
          ,ROW_NUMBER()over(partition by A1.cst_id ORDER by A1.ctr_dt asc) as RN
    from edw.dwd_bus_chm_ctr_inf_dd  A1
    WHERE   A1.dt='@@{yyyyMMdd}'
)  T7 on  T1.cst_id=T7.cst_id and   T7.rn=1
WHERE  T1.dt>='20240101'
AND    T1.dt<='20240430'
AND    T2.cst_id is not null
AND    T5.cd_val_dscr='客户签约'
***SJ2024051091_理财基金合规销售.sql
-- 2024年3月新增的定期理财认购/申购，非货基金认购/申购交易，交易申请确认状态为成功
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_01 AS
SELECT '定期理财'   bus_type  --业务类型
    -- ,decode(trx_cd,'100200','理财产品购买','100201','理财产品申购') --交易代码
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,t1.srl_nbr --流水号
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    -- , 销售人员姓名
    -- , brc_org_nm
    -- , sbr_org_nm
    -- ,bnk_act_id 银行账号
    ,t1.tatrx_act_nbr
    ,t1.tacd    --ta代码
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
    ,t1.cst_id          --cst_ID
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
WHERE t1.dt = '@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8) between '20240301' and '20240331'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t1.trx_cd IN ( '100200' , '100201' )
;
-- 客户上一次理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_02 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,a.rsk_lvl_cd,a.late_ases_dt
        ,row_number() over(partition by a.cst_id order by late_ases_dt desc) rn
    from edw.dwd_bus_chm_cst_rsk_ases_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024051091_CST_01)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,rsk_lvl_cd,late_ases_dt
) a where rn=2
;
-- 客户交易时理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_03 AS
select T1.srl_nbr,T1.trx_dt
    ,T2.rsk_lvl_cd         trx_rsk_lvl      --客户交易日风险等级
    ,T2.late_ases_dt       trx_rsk_ases_dt  --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_01 T1
inner join edw.dwd_bus_chm_cst_rsk_ases_dd T2
on T1.cst_ID=T2.cst_id and T1.trx_dt=T2.dt
where T2.dt between '20240301' and '20240331'
;
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_04 AS
SELECT '非货基金' BUS_TYPE
    ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.CST_ID          --CST_ID
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='@@{yyyyMMdd}'
    and T1.CHANNEL_DATE between '20240301' and '20240331'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20240301' and '20240331'
    and T1.CHANNEL_DATE between '20240301' and '20240331'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_05 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,cst_rsk_grd_cd rsk_lvl_cd,ases_dt late_ases_dt,
        row_number() over(partition by a.cst_id order by ases_dt desc) rn
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024051091_CST_04)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,cst_rsk_grd_cd,ases_dt
) a where rn=2
;
-- 客户交易时基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_06 AS
select a.srl_nbr,a.trx_dt
    ,b.cst_rsk_grd_cd       trx_rsk_lvl     --客户交易日风险等级
    ,b.ases_dt              trx_rsk_ases_dt --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_04           a
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    b
on a.cst_ID=b.cst_id and a.trx_dt=b.dt
where b.dt between '20240301' and '20240331'
;
--定期理财+基金
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_07 AS
select T1.*
    ,T4.rsk_lvl_cd,T4.late_ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_01           T1		--理财交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024051091_CST_02      T2      --上次理财风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024051091_CST_03      T3      --交易时理财风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dwd_bus_chm_cst_rsk_ases_dd               T4 		--理财风评表
on T1.CST_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
union all
select T1.*
    ,T4.cst_rsk_grd_cd,T4.ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_04           T1      --基金交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024051091_CST_05      T2      --上次基金风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024051091_CST_06      T3      --交易时基金风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd        T4      --基金风评表
on t1.cst_ID=t4.cst_ID and t4.dt='@@{yyyyMMdd}'
;
--关联其他字段（主表）
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_08 AS
SElECT T1.*
    ,T2.ta_name --发行机构
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    ,T7.credit_rsk_grd
    ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    ,T9.aum_avg_360d
    ,T10.aum_bal TRX_aum_bal
    ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ2024051091_CST_07   T1
left join edw.finc_tbtainfo                 T2 on t1.tacd=T2.ta_code  and T2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_ID=T3.cst_id and T3.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='@@{yyyyMMdd}'
left join (
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='@@{yyyyMMdd}'
) T7 on T1.CST_ID=T7.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.CST_ID=T8.cst_id and T8.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.CST_ID=T9.cst_id and T9.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
on T1.CST_ID=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20240301' and '20240331'
left join (
    SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
    inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '@@{yyyyMMdd}'
    WHERE a.dt between '20240301' and '20240331' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
    group by a.cst_id, a.dt
) t11 on T1.cst_ID=t11.cst_id and T1.trx_dt=t11.dt
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_09 AS
select distinct a.cst_ID,trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,b.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_08 a
left join edw.dws_cst_bas_inf_dd b
on a.cst_ID=b.cst_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd c
on b.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='@@{yyyyMMdd}'
and NVL(c.sam_rsk_ctrl_id,'')<>''
;
-- 前后5天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_10 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,rel_cust_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                         --贷款用途代码
    ,B.USG_CMT                             --用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt --贷款利率优惠备注
    ,case
        when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_09   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.CRC_IND <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '@@{yyyyMMdd}'
left outer join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '@@{yyyyMMdd}'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '@@{yyyyMMdd}'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_11 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_11 AS
select cst_ID,trx_dt
    ,a.rel_cst_id
    ,rel_cust_nm
    ,BUSI_CTR_ID                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,stdinr                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,INTR_RAT                            --执行利率
    ,REF_MON_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,a.REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,pre_ases_res
    ,HPN_TYP
    ,USG_CMT
    ,intr_rat_adj_cmt
    ,is_wfdk
    ,is_zc_loan
    ,lst_BUSI_CTR_ID
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.BUSI_CTR_ID            	lst_BUSI_CTR_ID
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.INTR_RAT                 lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ2024051091_CST_10
        where DIFF_TM<=5
    ) a
    left join lab_bigdata_dev.SJXQ_SJ2024051091_CST_10 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.pd_cd=b.pd_cd and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_12 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024051091_CST_12 AS
select a.bus_type              业务类型
    ,a.trx_type                交易类型
    ,a.srl_nbr                 交易流水号
    ,a.trx_sts                 交易状态
    ,concat(a.trx_dt,' ',a.trx_tm) 申请日期
    ,a.cfm_dt                  确认日期
    ,a.trx_chnl                交易渠道
    ,a.trx_amt                 交易金额
    ,a.cfm_amt                 确认金额
    ,a.trx_lot                 交易份额
    ,a.cfm_lot                 确认份额
    ,a.sale_empe_id            销售人员工号
    ,a.sale_empe_nm            销售人员姓名
    ,a.brc_org_nm              所属分行
    ,a.sbr_org_nm              所属支行
    ,a.tatrx_act_nbr           交易账号
    ,a.pd_cd                   产品代码
    ,a.pd_nm                   产品名称
    ,a.ta_name                 发行机构
    ,a.prod_type               产品类型
    ,a.pd_rsk_grd              产品风险等级
    ,a.pfm_comp_bas            业绩比较基准
    ,a.pd_found_dt             产品扣款日
    ,a.pd_val_dt               产品起息日
    ,a.pd_end_dt               产品到期日
    ,a.CST_ID                  客户号
    ,a.cst_nm                  客户名称
    ,a.age                     客户年龄
    ,a.gender                  客户性别
    ,''                        客户手机号码
    ,a.rsk_lvl_cd                                           	客户当前风险测评结果
    ,decode(a.late_ases_dt,'18991231','',a.late_ases_dt)    	客户当前结果测评时间
    ,a.lst_rsk_lvl                                          	客户上一次风险测评结果
    ,decode(a.lst_rsk_ases_dt,'18991231','',a.lst_rsk_ases_dt)  客户上一次风险测评时间
    ,a.trx_rsk_lvl                                              客户交易日风险等级
    ,decode(a.trx_rsk_ases_dt,'18991231','',a.trx_rsk_ases_dt)  客户交易日风险测评时间
    ,a.is_farm								是否农户
    ,a.efe_loan_cst_ind                     是否信贷有效户
    ,a.efe_dep_cst_ind                      是否存款有效户
    ,a.is_empe                              是否行内员工
    ,a.aum_avg_360d                         客户近一年AUM
    ,a.trx_ncr_fnd_bal                      客户交易时非货基金保有量
    ,a.TRX_aum_bal                          客户交易时AUM
    ,if(b.cst_ID is not null,'是','') 		交易日前后5天内同一风险控制号下是否存在贷款
    ,b.rel_cust_nm                  		贷款客户名称
    ,c.loan_apl_credit_rsk_grd      		当前贷款申请时客户信用风险等级
    ,a.credit_rsk_grd               		当前客户信用风险等级
    ,b.BUSI_CTR_ID                   		当前笔贷款合同流水号
    ,b.reg_dt                       		当前笔贷款申请日期
    ,b.DTRB_DT                      		当前笔贷款发放日期
    ,b.CTR_AMT                      		当前笔贷款金额
    ,ref_year_intr_rat              		当前笔贷款参考年利率
    ,INTR_RAT                       		当前笔贷款执行年利率
    ,aprv_exe_mon_intr_rat          		当前笔贷款执行月利率
    ,b.pre_ases_res                 		当前笔贷款预审批结果
    ,b.FIVE_CTG                     		当前笔贷款五级分类
    ,b.HPN_TYP                      		贷款类型
    ,b.is_zc_loan                   		是否为政策性贷款
    ,b.is_wfdk                      		是否为接力贷
    ,b.intr_rat_adj_cmt             		贷款利率优惠备注
    ,b.USG_CMT                      		贷款用途备注
    ,b.lst_BUSI_CTR_ID              		上一笔贷款合同流水号
    ,b.lst_CTR_AMT                  		上一笔贷款合同金额
    ,b.lst_INTR_RAT                 		上一笔贷款执行年利率
    ,b.lst_aprv_exe_mon_intr_rat    		上一笔贷款执行月利率
    ,b.lst_DTRB_DT                   		上一笔贷款发放日期
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_08       a
left join lab_bigdata_dev.SJXQ_SJ2024051091_CST_11  b
on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
left join (
    select distinct dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') loan_apl_credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt<='@@{yyyyMMdd}'
) c on b.rel_cst_id=c.cst_id and b.reg_dt=c.dt
;
SElECT '01' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_01
union all
SElECT '04' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_04
union all
SElECT '07' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_07
union all
SElECT '08' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_08
;
SElECT '02' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_02
union all
SElECT '03' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_03
union all
SElECT '05' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_05
union all
SElECT '06' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ2024051091_CST_06
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024051091_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024051091_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024051091_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 客户号,申请日期) custs
from SJXQ_SJ2024051091_CST_12
;
/*
01	6373	6132	6373
04	770	681	770
07	7143	6799	7143
08	7148	6799	7143
02	4497	4497
03	6373	6373
05	203	203
06	770	770
09	10111	6799
10	17304	6799
11	11	11
12	7148	7143
*/***SJ20240513131_员工岗位比对.sql
-- 在职员工信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240513131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513131_CST_01 AS
select t1.empe_id                               --员工号|C10
	,t1.empe_nm                                 --员工姓名|C100
	,t1.pos_enc                                 --职位编号|C32
    ,t2.pos_nm                                  --岗位
	,t1.join_cmp_dt                             --加入公司日期|C8
	,t1.pos_dt                                  --转正日期|C8
    ,t3.pos_enc     pos_enc_20191020
    ,t4.pos_nm      pos_nm_20191020
from edw.dws_hr_empe_inf_dd         t1          --员工汇总信息
LEFT JOIN edw.dim_hr_org_job_inf_dd t2
ON      t1.pos_enc = t2.pos_id
AND     t2.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd    t3 --20191020
on  t1.empe_id=t3.empe_id
and t3.dt='20191020'
LEFT JOIN edw.dim_hr_org_job_inf_dd t4
ON      t3.pos_enc = t4.pos_id
AND     t4.dt = '@@{yyyyMMdd}'
left join(
    SELECT empe_id,empe_actv_sts_cd,empe_sts_cd,start_dt,end_dt
        ,ROW_NUMBER() over (partition by empe_id order by end_dt desc)  as  rn
    from  edw.dim_hr_empe_org_inf_dd
    where dt='@@{yyyyMMdd}'
)t5 on t1.empe_id=T5.empe_id
and t5.rn=1
and t5.empe_sts_cd='3'          --离职
WHERE   t1.dt = '@@{yyyyMMdd}'
and     length(t1.empe_id)>0    --本行员工号
AND     T5.empe_id is null      --剔除离职员工
;
-- 数据结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240513131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513131_CST_02 AS
select t1.empe_id           员工号
	,t1.empe_nm             员工姓名
	,t1.join_cmp_dt         加入公司日期
    ,t3.pos_nm              入行岗位
    ,t1.pos_nm_20191020     岗位_20191020
    ,t1.pos_nm              岗位_20240613
FROM SJXQ_SJ20240513131_CST_01      t1
LEFT JOIN edw.dws_hr_empe_inf_dd    t2 --员工汇总信息
ON t1.empe_id = t2.empe_id
AND t1.join_cmp_dt = t2.dt
AND t2.dt <= '@@{yyyyMMdd}'
LEFT JOIN edw.dim_hr_org_job_inf_dd t3
ON t2.pos_enc = t3.pos_id
AND t3.dt = '@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ20240513131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 员工号) custs
from SJXQ_SJ20240513131_CST_02
***SJ20240513141_反洗钱数据分析.sql
/*
客户号	客户名称	所属机构号	所属机构名称	周期内贷方交易笔数	周期内贷方交易金额	是否有查冻扣记录
1	开户日期在近2年的
2	职业包含&ldquo;社区&rdquo;或&ldquo;居委会&rdquo;或&ldquo;公职&rdquo;等字样的，或职业是退休人员的
3	近一年贷方累计金额在300万元及以上的
4	流水备注栏含&ldquo;工资&rdquo;、&ldquo;补贴&rdquo;、&ldquo;志愿&rdquo;、&ldquo;慰问&rdquo;、&ldquo;人口普查&rdquo;、&ldquo;垃圾分类&rdquo;、&ldquo;健康知识&rdquo;、&ldquo;保洁&rdquo;字样的。
5	账户状态正常的，而非已销户、非已转久悬、非已转不动户的
1. 开户日期：客户账户
2. 机构类型：开户机构 上海分行
3. 周期内 贷方 C_贷D_借，多久？2年
4. 取数时间
5. 近一年贷方累计金额 是否包含备注？
*/
--个人客户基本信息汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ20240513141_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513141_CST_01 AS
select t1.cst_id                                 --客户号|C20
	,t1.cst_chn_nm                               --客户中文名称|C200
	,t1.ocp_cd                                   --职业代码|C5
    ,c1.cd_val_dscr     ocp_nm
        else 0 end select_ocp
from edw.dws_cst_idv_bas_inf_dd     t1 --个人客户基本信息汇总表
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C1
ON  t1.ocp_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and (t1.ocp_cd='80004' or t1.ocp_cd like '10%')     -- 80004退休人员 10公职
;
--客户存款账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240513141_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513141_CST_02 AS
select t1.cst_act_id                               --客户账号|C32
	,t1.cst_act_nm                               --客户账户名称|C200
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_org_id                               --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
    ,case when t1.opn_dt >= '@@{yyyyMMdd-2y}' then 1 else 0 end opn_l2y
    ,t2.cst_chn_nm,t2.ocp_cd,t2.ocp_nm,t2.select_ocp
    ,T3.BRC_ORG_NM,T3.SBR_ORG_NM,T3.TEM_ORG_NM,T3.ORG_NM
    ,case when t4.cst_act_id is not null then 1 else 0 end is_frz
from edw.dim_bus_dep_cst_act_inf_dd     t1 --客户存款账户信息
inner join SJXQ_SJ20240513141_CST_01    t2
on t1.cst_id=t2.cst_id
inner join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t1.opn_org_id=t3.org_id
and t3.dt='@@{yyyyMMdd}'
and t3.brc_org_nm='上海分行'
left join(
    select distinct cst_act_id
    from edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd
    WHERE dt = '@@{yyyyMMdd}'
)t4 on t1.cst_act_id=t4.cst_act_id
where t1.dt='@@{yyyyMMdd}'
and t1.opn_dt >= '@@{yyyyMMdd-2y}'  --近2年开户
and t1.ACT_STS_CD ='A'              --正常
;
--存款账户余额发生明细
DROP   TABLE IF     EXISTS SJXQ_SJ20240513141_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513141_CST_03 AS
SElECT t1.cst_id,t1.cst_act_id,t2.dep_act_id
    ,t2.dtl_seq_nbr
	,t2.trx_dt                                  --交易日期|C8
	,t2.trx_tm                                  --交易时间|C9
	,t2.crd_and_dbt_ind                         --借贷标志|C1
	,t2.trx_amt                                 --交易金额|DECIMAL(21,2)
	,t2.act_bal                                 --账户余额|DECIMAL(21,2)
	,t2.txt_code                                --摘要代码|C10
	,t2.smr_dscr                                --摘要描述|C512
    ,t2.cmt
    ,case when CONCAT(t2.smr_dscr,t2.cmt) regexp '工资|补贴|志愿|慰问|人口普查|垃圾分类|健康知识|保洁' then 1
        else 0 end select_cmt
from SJXQ_SJ20240513141_CST_02              t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细
on t1.cst_act_id=t2.cst_act_id
and t2.dt >= '@@{yyyyMMdd-2y}'
and t2.trx_dt >= '@@{yyyyMMdd-2y}'
and t2.crd_and_dbt_ind='C'  --贷方
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240513141_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513141_CST_04 AS
select t1.cst_id
    ,t1.cst_chn_nm                               --客户中文名称|C200
	,t1.ocp_cd                                   --职业代码|C5
    ,t1.ocp_nm
    ,t2.opn_org_id
    ,t2.ORG_NM
    ,t2.opn_dt
    ,t2.is_frz
    ,t3.trx_num,t3.trx_amt
from SJXQ_SJ20240513141_CST_01          t1
inner join(
    SElECT cst_id
        ,max(is_frz)  is_frz
    from SJXQ_SJ20240513141_CST_02
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
inner join (
    SElECT cst_id
        ,count(1)           trx_num
        ,sum(trx_amt)       trx_amt
        ,max(select_cmt)    select_cmt
    from SJXQ_SJ20240513141_CST_03
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
where t3.trx_amt>=3000000       --贷方交易是否 300万及以上
and t3.select_cmt=1             --贷方交易是否 包含关键词
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240513141_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513141_CST_05 AS
select cst_id               客户号
	,cst_chn_nm             客户名称
	,opn_org_id             开户机构编号
    ,ORG_NM                 开户机构名称
	,opn_dt                 开户日期
    ,ocp_cd                 职业代码
    ,ocp_nm                 职业名称
    ,trx_num                2年内贷方交易笔数
    ,trx_amt                2年内贷方交易金额
    ,is_frz                 是否有司法查冻扣记录
from SJXQ_SJ20240513141_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20240513141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dep_act_id,dtl_seq_nbr) custs
from SJXQ_SJ20240513141_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513141_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240513141_CST_05
;
/*
01	679406	679406
02	17497	17497
03	105371	105371
04	26	26
05	26	26
*/
***SJ20240513156_非现金理财资产配置.sql
/*截止4.30日 剔除村行*/
-- 历史购买过保险
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_01 AS
SElECT cst_id,sum(insu_fee)     his_insu_fee
from edw.dwd_bus_insu_plcy_insu_inf_dd  --购买过保险
where dt ='20240430'
and insu_fee<>0
group by cst_id
;
-- 历史购买过贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_02 AS
SELECT  T1.cst_id
    ,max(replace(ord_tm,'-',''))    max_trx_dt
    ,SUM(T1.cmdt_pay_unt_prc)       gold_buy_amt  --购买金额
FROM    adm_pub.adm_pub_cst_nob_met_trx_sum_di T1 --贵金属交易整合表
WHERE   dt<= '20240430'
and T1.cmdt_pay_unt_prc<>0
GROUP BY T1.cst_id
;
-- 历史有过基金账户
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_03 AS
SELECT  DISTINCT cst_id
FROM    edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd
WHERE   dt = '20240430'
;
-- 非现金理财 产品
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_04 AS
select pd_cd                                  --产品代码
	,pd_nm                                    --产品名称
	,pd_sts_cd                                --产品状态代码
	,ta_cd                                    --ta代码
	,clc_start_dt                             --募集开始日期
	,clc_end_dt                               --募集结束日期
	,pd_found_dt                              --产品成立日期
	,pd_val_dt                                --产品起息日期
	,pd_end_dt                                --产品结束日期
	,actl_found_dt                            --实际成立日期
	,rsk_grd                                  --风险等级
    ,case when pd_nm regexp '丰利兴动多策略'        then '丰利兴动多策略'
        when pd_nm regexp '交银理财稳享鑫荣三年'    then '交银理财稳享鑫荣三年'
        when pd_nm regexp '钱潮&middot;稳享3年期挂钩'      then '钱潮&middot;稳享3年期挂钩'
        when pd_nm regexp '钱潮&middot;稳享5年期挂钩'      then '钱潮&middot;稳享5年期挂钩'
        when pd_nm regexp '钱潮&middot;致远5年期挂钩'      then '钱潮&middot;致远5年期挂钩'
        when pd_nm regexp '招银理财招睿焦点联动' and pd_nm regexp '黄金'        then '招银理财招睿焦点联动黄金'
        when pd_nm regexp '招银理财招睿焦点联动' and pd_nm regexp '中证1000'    then '招银理财招睿焦点联动中证1000'
        when pd_nm regexp '招银理财招睿增利精选'    then '招银理财招睿增利精选'
        else '' end pd_cls
from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
where dt='20240430'
and pd_ctg_cd='1'               --'1','理财'
and PD_STS_CD <>'3'             --3发行失败 a产品终止
and pd_nm regexp '招银理财招睿焦点联动|交银理财稳享鑫荣三年|招银理财招睿增利精选|丰利兴动多策略|钱潮&middot;稳享3年期挂钩|钱潮&middot;稳享5年期挂钩|钱潮&middot;致远5年期挂钩'
;
-- 非现金理财交易
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_05 AS
SELECT t1.srl_nbr,T1.CST_ID
    ,T1.cfm_dt                                   --确认日期|C8
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.trx_cd                                   --交易代码|C6
    ,T1.bus_cd                                   --业务代码|C6
    ,T1.pd_cd                                    --产品代码|C20
    ,t1.bnk_act_id
    ,T1.trx_amt                                  --交易金额|DECIMAL(20,2)
    ,T1.cfm_amt                                  --确认金额|DECIMAL(20,2)
    ,T1.cfm_ern                                  --确认收益|DECIMAL(20,2)
    ,T1.trx_sts_cd                               --交易状态代码|C1
    ,C1.cd_val_dscr trx_sts_nm
    ,T1.mgr_id      cfm_mgr_id                   --客户经理编号|C32
    ,T1.cmsn_fee                                 --手续费|number(18,2)
    ,t2.pd_cls
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                T1 --理财交易确认流水明细 立英修改
INNER JOIN SJXQ_SJ20240513156_CST_04               t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
left join edw.dwd_code_library_dd                  c1
on t1.trx_sts_cd=c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where T1.DT<='20240513' and T1.cfm_amt<>0
and SUBSTR(t1.srl_nbr,1,8)<='20240430'
AND t1.trx_sts_cd ='8'              --确认成功
;
-- 20240430日余额
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_06 AS
select t1.cst_id                                   --客户编号|C20
	,sum(case when t2.pd_cd is not null then t1.fnc_amt else 0 end )   nocash_fnc_bal   --当前理财金额|DECIMAL(21,2)
    ,sum(case when t2.pd_cd is     null then t1.fnc_amt else 0 end )   cash_fnc_bal     --当前理财金额|DECIMAL(21,2)
    ,sum(t1.fnc_amt)    fnc_amt
from edw.dws_bus_chm_act_acm_inf_dd     t1      --理财账户份额汇总信息
left join SJXQ_SJ20240513156_CST_04    t2
on t1.pd_cd=t2.pd_cd
where t1.dt='20240430'
and   t1.PD_TP_CD='1'      --'1','理财'
group by t1.cst_id
;
-- 是否历史购买过现金理财
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_08 AS
SElECT distinct t1.cst_id
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI  T1 --理财交易确认流水明细
inner JOIN edw.dim_bus_chm_pd_inf_dd t2 --理财产品信息
ON  t1.pd_cd = t2.pd_cd
and t2.dt='20240430'
and t2.pd_ctg_cd='1'               --'1','理财'
and t2.PD_STS_CD <>'3'             --3发行失败
and t2.pd_nm not regexp '招银理财招睿焦点联动|交银理财稳享鑫荣三年|招银理财招睿增利精选|丰利兴动多策略|钱潮&middot;稳享3年期挂钩|钱潮&middot;稳享5年期挂钩|钱潮&middot;致远5年期挂钩'
where T1.DT<='20240513'
and SUBSTR(t1.srl_nbr,1,8)<='20240430'
AND t1.trx_sts_cd ='8'              --确认成功
;
-- 基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_09 AS
select t1.cst_id                                   --客户号
	,t1.aum_grd                                  --财富等级:1-一星客户,2-二星客户,3-三星客户,4-四星客户,5-五星客户,6-六星客户
    ,decode(t1.aum_grd,'1','1星','2','2星','3','3星','4','4星','5','5星','6','6星','') aum_grd_nm
	,t1.cst_typ_cd                               --客户类型代码:1对私,2对公
    ,t2.fund_amt	            --基金金额
    ,t2.fnc_amt	                --理财金额
    ,t2.insu_amt	            --保险保费
    ,t2.gold_buy_amt
    ,t2.gold_fin_buy_amt_12m    --近12个月贵金属购买金额
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,case when t2.insu_amt>0        then 1 else 0 end is_insu_cst
    -- ,t5.his_insu_fee
    ,case when t2.gold_buy_amt>0    then 1 else 0 end is_gold_cst
    -- ,t6.gold_buy_amt      gold_buy_amt1     --贵金属购买金额
    ,case when t7.cst_id is not null then 1 else 0 end is_fund_cst
    ,case when t8.cst_id is not null then 1 else 0 end is_cash_cst
    ,case when t9.cst_id is not null then 1 else 0 end is_nocash_cst
    ,t9.pd_num  nocash_pd_num
    ,t10.nocash_fnc_bal,t10.cash_fnc_bal
    ,nvl(t10.nocash_fnc_bal,0) + nvl(t2.fund_amt,0) + nvl(t2.insu_amt,0) +nvl(t2.gold_buy_amt,0) nocash_aum_bal
from adm_pub.adm_csm_cbas_cst_grd_inf_dd            t1 --客户集市-基础信息-客户等级信息
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t2 --客户集市-业务信息-客户金融资产信息表
on t1.cst_id=t2.cst_id
and t2.dt='20240430'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240430'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240430'
and t4.BRC_ORG_NM not like '%村镇银行%'
-- left join SJXQ_SJ20240513156_CST_01        t5
-- on t1.cst_id=t5.cst_id
-- left join SJXQ_SJ20240513156_CST_02        t6
-- on t1.cst_id=t6.cst_id
left join SJXQ_SJ20240513156_CST_03        t7
on t1.cst_id=t7.cst_id
left join SJXQ_SJ20240513156_CST_08        t8
on t1.cst_id=t8.cst_id
left join(
    SElECT cst_id,count(distinct pd_cls) pd_num
    from SJXQ_SJ20240513156_CST_05
    group by cst_id
)t9 on t1.cst_id=t9.cst_id
left join SJXQ_SJ20240513156_CST_06    t10
on t1.cst_id=t10.cst_id
where t1.dt='20240430'
and t1.aum_grd >= '1'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_10 AS
SElECT BRC_ORG_NM           分行机构
    ,aum_grd_nm             客户财富等级
    ,count(case when nocash_pd_num>2 then cst_id end)      购买过三种及以上非现金理财的客户数
    ,round(sum(case when nocash_aum_bal > 1000000 then nocash_aum_bal
        else 0 end),2)      非现金AUM大于100万的客户的非现金AUM余额合计
from SJXQ_SJ20240513156_CST_09
group by BRC_ORG_NM,aum_grd_nm
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_11 AS
SElECT BRC_ORG_NM           分行机构
    ,aum_grd_nm             客户财富等级
    ,count(case when is_insu_cst + is_gold_cst + is_fund_cst + is_nocash_cst>0 then cst_id end)     购买过非现金AUM的客户数
    ,round(sum(case when is_insu_cst + is_gold_cst + is_fund_cst + is_nocash_cst >0
        then nocash_aum_bal else 0 end),2)                                  购买过非现金AUM的客户的非现金AUM余额合计
    ,count(case when is_cash_cst=1 then cst_id end)                         购买过现金理财的客户数
    ,round(sum(case when is_cash_cst=1 then cash_fnc_bal else 0 end),2)     购买过现金理财的客户的现金理财余额合计
from SJXQ_SJ20240513156_CST_09
group by BRC_ORG_NM,aum_grd_nm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ20240513156_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_06
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240513156_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 分行机构,客户财富等级) custs
from SJXQ_SJ20240513156_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct 分行机构,客户财富等级) custs
from SJXQ_SJ20240513156_CST_11
;
/*
01	49004	49004
02	51965	51965
03	59318	59318
04	117	117
05	23075	17733
06	296826	296826
08	303868	303868
09	6197591	6197591
10	32	32
11	34	34
DROP   TABLE IF     EXISTS SJXQ_SJ20240513156_CST_09_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240513156_CST_09_1 AS
SElECT cst_id,aum_grd,fund_amt,fnc_amt,insu_amt,gold_buy_amt1,gold_buy_amt,gold_fin_buy_amt_12m
    ,is_insu_cst,is_gold_cst,is_fund_cst,is_cash_cst,is_nocash_cst
    ,nocash_pd_num,nocash_fnc_bal,cash_fnc_bal,nocash_aum_bal
from SJXQ_SJ20240513156_CST_09
;
*/***SJ2024051341_国泰基金客户信息查询.sql
--个人客户基本信息汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024051341_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051341_CST_01 AS
select t1.cst_id                    --客户号|C20
	,t1.cst_chn_nm                  --客户中文名称|C200
	,t1.gdr_cd                      --性别代码|C1
    ,t1.bth_dt	                    --出生日期|C8
	,t1.ntn_cd                      --国籍代码|C3
    ,c1.cd_val_dscr     ntn_nm
    ,t1.bth_cnr_cd	                --出生国家代码|C3
    ,c2.cd_val_dscr     bth_cnr_nm
    ,t1.bth_cty_cd	                --出生城市代码|C256
	,t1.hmt                         --籍贯|C256
	,t1.doc_nbr                     --主证件号码|C60
	,t1.doc_typ_cd                  --主证件类型代码|C5
	,t1.doc_mtu_dt                  --主证件到期日期|C8
	,t1.reg_adr                     --户籍地址|C256
	,t1.cmn_adr                     --通讯地址|C256
	,t1.wrk_adr                     --工作单位地址|C256
	,t1.fml_adr                     --家庭地址|C256
	,t1.file_dt                     --建档日期|C8
    ,t1.dms_ovs_ind	                --境内境外标志|C1
    ,t1.job_unt_nm	                --工作单位名称|C200
    ,t1.eng_fml_nm	                --英文姓|C200
    ,t1.eng_lst_nm	                --英文名|C200
    ,t1.tax_rsd_typ_cd	            --涉税居民类型代码|C3
from edw.dws_cst_idv_bas_inf_dd     t1 --个人客户基本信息汇总表
LEFT JOIN edw.dwd_code_library_dd   c1 --码值表
ON      c1.cd_val = t1.ntn_cd
AND     c1.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
AND     c1.fld_nm = 'NTN_CD'
AND     c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C2
ON bth_cnr_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
-- 资产信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024051341_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051341_CST_02 AS
select cst_id                                   --客户编号
	,fnc_amt                                    --理财金额
    ,fnc_mon_avg_amt	                        --理财金额月日均
    ,fund_amt                                   --基金金额
    ,fund_mon_avg_amt	                        --基金金额月日均
    ,gold_buy_amt                               --贵金属购买金额
    ,gold_mon_avg_amt	                        --贵金属金额月日均
    ,insu_amt                                   --保险保费
    ,insu_mon_avg_amt	                        --保险保费月日均
	,wlth_bal                                   --财富资产余额
	,wlth_mon_avg                               --财富资产余额月日均
	,aum_bal                                    --客户综合金融资产(aum)
	,aum_mon_avg                                --客户当月综合金融资产(aum)月日均
from adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd    --客户集市-业务信息-客户金融资产信息表
where dt='@@{yyyyMMdd}'
;
-- 理财账户份额
DROP   TABLE IF     EXISTS SJXQ_SJ2024051341_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051341_CST_03 AS
select t1.ta_cd                                    --ta代码|C32
	,t1.pd_cd                                    --产品代码|C24
    ,t2.pd_nm
	,t1.bnk_act_id                               --银行账号|C32
	,t1.ccy_cd                                   --币种代码|C3
	,t1.invst_mat_dt                             --投资到期日|C8
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_dt                                   --签约日期|C8
	,t1.cur_lot                                  --当前份额|DECIMAL(20,2)
	,t1.fnc_amt                                  --当前理财金额|DECIMAL(21,2)
	,t1.pd_tp_cd                                 --产品类别代码|C1
	,t1.agn_ind                                  --代销标志|c1
from edw.dws_bus_chm_act_acm_inf_dd t1 --理财账户份额汇总信息
left join edw.dim_bus_chm_pd_inf_dd t2 --理财产品信息
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.fnc_amt<>0
;
-- 基金账户份额
DROP   TABLE IF     EXISTS SJXQ_SJ2024051341_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051341_CST_04 AS
SELECT t1.prod_cd	                --产品代码|c32
    ,t2.pd_nm
    ,t1.ta_cd	                    --ta代码|c16
    ,t1.trx_act_id	                --交易账号|c32
    ,t1.cst_id	                    --客户号|c32
    ,t1.tot_lot	                    --总份额|decimal(16,2)
    ,t1.avl_lot	                    --可用份额|decimal(16,2)
    ,t1.ta_act_id	                --ta账号|c32
    ,t1.tot_cost	                --总成本|decimal(16,2)
    ,t1.tot_amt	                --总金额|decimal(16,2)
    ,t1.acm_buy_amt	            --累计购买金额|decimal(16,2)
    ,t1.acm_buy_lot	            --累计购买份额|decimal(16,2)
    ,t1.acm_buy_fee	            --累计购买费用|decimal(16,2)
    ,t1.acm_rdm_amt	            --累计赎回金额|decimal(16,2)
    ,t1.acm_rdm_lot	            --累计赎回份额|decimal(16,2)
    ,t1.acm_rdm_fee	            --累计赎回费用|decimal(16,2)
    ,t1.lot_late_chg_dt	        --份额最后变动日期|timestamp
    ,t1.cst_typ_cd	                --客户类型代码|c1
    ,t1.pos_cost_prc	            --持仓成本价|decimal(10,7)
    ,t1.pos_pft_los	            --持仓盈亏|decimal(16,2)
    ,t1.pos_yld	                --持仓收益率|decimal(10,7)
from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd t1 --基金账户份额信息
left join edw.dim_bus_chm_fnd_pd_inf_dd     t2 --基金产品基础信息表
on t1.prod_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024051341_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051341_CST_05 AS
SElECT t4.ta_act_id                 投资人基金帐号
    ,1                              个人_机构标志
	,t1.cst_chn_nm                  客户中文名称
	,decode(t1.gdr_cd,'1','男','2','女','未知') 性别
    ,t1.bth_dt	                    出生日期
	,t1.ntn_cd                      国籍代码
    ,t1.ntn_nm                      国籍
    ,t1.bth_cnr_cd	                出生国家代码
    ,t1.bth_cnr_nm                  出生国家
    ,t1.bth_cty_cd	                出生城市代码
	,t1.hmt                         籍贯
	,t1.doc_nbr                     主证件号码
	,t1.doc_typ_cd                  主证件类型代码
    ,decode(t1.doc_typ_cd,'B0400','港澳居民来往内地通行证','B0600','台湾居民来往大陆通行证') 主证件类型
	,t1.doc_mtu_dt                  主证件到期日期
	,t1.reg_adr                     户籍地址
	,t1.cmn_adr                     通讯地址
	,t1.wrk_adr                     工作单位地址
	,t1.fml_adr                     家庭地址
	,t1.file_dt                     建档日期
    ,t1.dms_ovs_ind	                境内境外标志
    ,decode(t1.dms_ovs_ind,'0','否','1','是') 境内境外标志码值
    ,t1.job_unt_nm	                工作单位名称
    ,t1.eng_fml_nm	                英文姓
    ,t1.eng_lst_nm	                英文名
    ,t1.tax_rsd_typ_cd	            涉税居民类型代码
    ,t2.fnc_amt                     理财金额
    ,t2.fund_amt                    基金金额
    ,t2.gold_buy_amt                贵金属购买金额
    ,t2.insu_amt                    保险保费
	,t2.wlth_bal                    财富资产余额
	,t2.aum_bal                     客户综合金融资产aum
	,t3.pd_cd                       理财产品代码
    ,t3.pd_nm                       理财产品名称
	,t3.opn_dt                      签约日期
	,t3.fnc_amt                     当前理财金额
    ,t4.prod_cd	                    基金产品代码
    ,t4.pd_nm                       基金产品名称
    ,t4.tot_amt	                    基金总金额
from SJXQ_SJ2024051341_CST_01       t1
left join SJXQ_SJ2024051341_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024051341_CST_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024051341_CST_04  t4
on t1.cst_id=t4.cst_id
;
***SJ2024051606_分行财顾陪访产效.sql
-- 4.1-5.15产生的中收（包含理财、基金、保险、贵金属中收）
DROP   TABLE IF     EXISTS SJXQ_SJ2024051606_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051606_CST_01 AS
SElECT COL_1    brc_org_nm
    ,COL_2      wlth_advsr_id
    ,COL_3      cst_id
FROM qbi_file_20240521_10_42_52
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024051606_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051606_CST_02 AS
SElECT t1.brc_org_nm    分行
    ,t1.wlth_advsr_id   我行财顾
    ,t1.cst_id          客户号
    ,t2.chm_mid_inc     理财中收
    ,t3.FUD_MID_INCM    基金中收
    ,t4.INS_MID_INCM    保险中收
    ,t5.GOD_MID_INCM    贵金属中收
    ,nvl(t2.chm_mid_inc,0) +nvl(t3.FUD_MID_INCM,0)
        +nvl(t4.INS_MID_INCM,0) +nvl(t5.GOD_MID_INCM,0) 中收合计0401_0415
from SJXQ_SJ2024051606_CST_01   t1
left join(
    --理财中收
    SELECT  cst_id
            ,sum(COALESCE(mid_amt, 0)) AS chm_mid_inc --理财中收
    FROM    edw.dws_bus_chm_act_mgr_inf_dd
    WHERE   dt BETWEEN '20240401' and '20240515'
    AND     mng_typ_cd = '1' --1考核 2销售
    GROUP BY cst_id
)t2 on t1.cst_id=t2.cst_id
left join(
    --基金中收
    SELECT cst_id,sum(tot_mid_inc)   FUD_MID_INCM    --中收合计(认购费+申购费+管理费分成+销售服务费)
    FROM    edw.dwd_bus_chm_fnd_mid_inc_fee_dtl_di
    WHERE   dt BETWEEN '20240401' and '20240515'
    GROUP BY cst_id
)t3 on t1.cst_id=t3.cst_id
left join(
    --保险中收
    SELECT cst_id,SUM(mng_cnv_cmsn_fee) INS_MID_INCM
    FROM APP_RPT.FCT_INSU_AGN_BUS_ACS_DTL_TBL --保险代销业务考核明细表
    WHERE DT='@@{yyyyMMdd}'
    AND replace(TRX_DT,'-','') BETWEEN '20240401' and '20240515'
    GROUP BY cst_id
)t4 on t1.cst_id=t4.cst_id
left join(
    --贵金属中收
    SELECT cst_id,sum(MID_INC_TOT_AMT) GOD_MID_INCM     --当年中收
    FROM    adm_pub.ADM_PUB_CST_NOB_MET_TRX_SUM_DI      --贵金属交易整合表
    WHERE   dt BETWEEN '20240401' and '20240515'
    AND     CMDT_PAY_UNT_PRC<>0 			--存在未付钱且有中收，需剔除
    GROUP by cst_id
)t5 on t1.cst_id=t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024051606_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024051606_CST_02
;
/*
01	119	118
02	119	118
*/***SJ2024051681_监管先评估后交易验证.sql
-- 客户理财、基金风评 历史首次风险测评日期	历史首次风险测评时间	历史首次风险测评结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_01 AS
SElECT *,row_number() over(partition by cst_id order by ases_dt,case when rsk_ases_srl_nbr is null then 1 else 0 end
                            ,rsk_ases_srl_nbr,cst_rsk_grd desc) rn
    ,dense_rank() over(partition by cst_id order by ases_dt,case when ases_tm is null then 1 else 0 end,ases_tm
        ,case when rsk_ases_srl_nbr is null then 1 else 0 end,rsk_ases_srl_nbr,cst_rsk_grd desc) dr
from(
    select cst_id                           --客户号|C32
        ,cst_rsk_grd_cd     cst_rsk_grd     --客户风险等级代码 1-5
        ,ases_dt                            --评估日期 均正常，没有18991231
        ,null               ases_tm
        ,rsk_ases_srl_nbr                   --风险评估流水号|C32
        ,'1'    rsk_tbl
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd --基金客户风险等级信息表
    where dt<='20240430'
    and ases_dt<>'18991231'         --没有过风险评估
    union
    select cst_id
        ,rsk_lvl_cd                               --风险等级代码  0-5，其中=0时，rsk_vld_prd_stop_dt=1899
        ,late_ases_dt                             --最后评估日期
        ,null
        ,null
        ,'2'    rsk_tbl
    from edw.dwd_bus_chm_cst_rsk_ases_dd          --理财客户风险评估结果表
    where dt<='20240430'
    and late_ases_dt<>'18991231'    --没有过风险评估
    union
    select cust_no                          --客户号
        ,cust_risk_level                    --客户风险等级
        ,assess_date                        --评估日期
        ,channel_time	                    --渠道时间
        ,assess_serno	                    --风险评估流水号
        ,'3'    rsk_tbl
    from edw.cfin_cust_risk_assess_log      --客户风险评估流水表
    where dt<='20240430'
    union
    select t1.cst_id
        ,cast(cst_rsk_grd_cd as string)	            --客户风险等级代码|number(22,0)
        ,cast(t1.trx_dt as string)
        ,t1.trx_tm
        ,t1.srl_nbr
        ,'4'    rsk_tbl
    from edw.dwd_bus_chm_trx_rqs_srl_dtl_di     t1 --理财交易请求流水明细
    where t1.dt<='@@{yyyyMMdd}'
    and cast(t1.trx_dt as string) <= '20240430'
)t1 where nvl(cst_id,'')<>''
;
-- 没有上表全
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_01_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_01_2 AS
select client_no   --客户编号
    ,risk_date	            --评级日期
    ,risk_time	            --评级时间
	,channel                --渠道
    ,row_number() over(partition by client_no order by risk_date,risk_time,question) rn
from edw.finc_tbhisclientrisklist --客户风险等级评估记录
where dt='@@{yyyyMMdd}'
and nvl(client_no,'')<>''
-- and channel='6'         --低柜 '0','1','6','7','B','Q'
;
/*
表1	edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd	基金客户风险等级信息表 	上游表：edw.CFIN_CUST_RISK_ASSESS_INFO 	客户风险等级信息表
表2	edw.dwd_bus_chm_cst_rsk_ases_dd	理财客户风险评估结果表 			上游表：edw.FINC_TBCLIENTRISKINFO 		客户风险评估结果表
表3	edw.cfin_cust_risk_assess_log	客户风险评估流水表
表4	edw.dwd_bus_chm_trx_rqs_srl_dtl_di	理财交易请求流水明细
其中：表1客户不在表3 中 20777,表3不在表1 中 3 ；表1客户更全
表4不在表2 中 9368,表2不在表4 中 106915 ；表2客户更全
表12客户不在表3 中 352091,表3不在表12 中 0 ；表12加一起客户更全
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_01_1 AS
select cust_no                          --客户号
	,cust_risk_level                    --客户风险等级
	,assess_date                        --评估日期
    ,channel_date                       --渠道日期
    ,channel_time                       --渠道时间
    ,global_serno                       --系统全局流水号
    ,assess_serno	                    --风险评估流水号
    ,update_time	                    --更新时间
    ,dt
    ,ROW_NUMBER() OVER(PARTITION BY cust_no ORDER BY dt desc,update_time,assess_serno) rn
from edw.cfin_cust_risk_assess_log            --客户风险评估流水表
where dt<='20240430'
;
-- 首次风险测评交易系统流水号
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_02 AS
SElECT *,row_number() over(partition by cst_id order by srl_nbr) rn
from(
    select t1.cst_id
        ,cast(cst_rsk_grd_cd as string)	            --客户风险等级代码|number(22,0)
        ,cast(t1.trx_dt as string)
        ,t1.trx_tm
        ,t1.srl_nbr
        ,'4'    rsk_tbl
    from edw.dwd_bus_chm_trx_rqs_srl_dtl_di     t1 --理财交易请求流水明细
    where t1.dt<='@@{yyyyMMdd}'
    and cast(t1.trx_dt as string) <= '20240430'
)t1
;
*/
-- 首次财富产品购买日期	首次财富产品购买时间	首次财富产品购买类型	首次购买产品代码	首次购买产品名称	首次购买渠道
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_03 AS
-- 理财交易
SELECT distinct t1.srl_nbr,T1.CST_ID
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt               --交易日期|C8
    ,T1.trx_tm                                   --交易时间|C6
    ,T1.pd_cd                                    --产品代码|C20
    ,t2.pd_nm
    ,T1.trx_chnl_cd                              --交易渠道代码|C1
    ,c1.cd_val_dscr trx_chnl_nm
    ,'理财'     prd_cls
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI     T1 --理财交易确认流水明细
left join edw.dim_bus_chm_pd_inf_dd 	t2 --理财产品信息
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON t1.trx_chnl_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where T1.DT<='@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8)<='20240430'
AND t1.trx_sts_cd ='8'              --确认成功
union all
-- 基金交易
SELECT t1.orig_apl_id,t1.cst_id
    ,replace(substr(t1.apl_tm,1,10),'-','')  trx_dt
    ,substr(t1.apl_tm,12,19)                 trx_tm
	,t1.pd_cd                                    --产品代码|c32
    ,t2.pd_nm
    ,t1.trx_chnl_cd                              --交易渠道代码
    ,c1.cd_val_dscr trx_chnl_nm
    ,'基金'     prd_cls
FROM edw.dwd_bus_chm_fnd_trx_cfm_dtl_di     t1 --基金交易确认流水明细
left join edw.dim_bus_chm_fnd_pd_inf_dd     t2 --基金产品基础信息表
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON T1.TRX_CHNL_CD=C1.CD_VAL
AND C1.DT='@@{yyyyMMdd}'
AND C1.TBL_NM='DIM_BUS_CHM_FND_AIP_AGR_INF_DD'
AND C1.FLD_NM='CHNL_CD'
WHERE   t1.dt <= '@@{yyyyMMdd}'
AND replace(substr(t1.apl_tm,1,10),'-','') <= '20240430'
and t1.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND t1.BUS_CD IN ( '120' , '122' , '136' , '139' , '138' ) --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND t1.CFM_AMT > 0
union all
-- 保险交易
SELECT T1.bsn_serno,T2.CST_ID
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.prd_no
    ,T3.prd_nm
    ,t1.chnl_typ_cd	    --渠道类型代码
    ,c1.cd_val_dscr chnl_typ_nm
    ,'保险'     prd_cls
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD    T1 --保险业务交易流水信息
INNER JOIN edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T2 --保单信息表
ON      T2.INSU_POLY_NO = T1.INSU_POLY_NO      --保单编号关联
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD     T3 --保险产品信息表
ON      T1.prd_no = T3.prd_no  --产品代码
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON t1.chnl_typ_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.TRX_DT <='20240430'
AND     T1.BSN_TYP_NM = '订单'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_04 AS
SELECT row_number() over(order by t1.ases_dt) seq
    ,'20240430'     data_dt
    ,t1.cst_id
    ,t2.cst_chn_nm	                            --客户姓名|C200
    ,t1.rsk_ases_srl_nbr
    ,T1.ases_dt                                 --评估日期
    ,t1.ases_tm
    ,T4.srl_nbr     trx_srl_nbr
    ,t4.trx_dt ,t4.trx_tm ,t4.prd_cls
    ,t4.pd_cd ,t4.pd_nm ,t4.trx_chnl_nm
from SJXQ_SJ2024051681_CST_01       t1
left join edw.dws_cst_bas_inf_dd	t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
INNER JOIN(
    -- 有风评 且 有财富产品交易
    SELECT *,row_number() over(partition by cst_id order by trx_dt,trx_tm,srl_nbr) rn
    FROM SJXQ_SJ2024051681_CST_03
)T4 on t1.cst_id=t4.cst_id
and t4.rn=1     --首次
where t1.dr=1   --最早评估日期
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024051681_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024051681_CST_05 AS
SELECT seq 				编号
    ,data_dt            数据日期
    ,cst_id             客户号
    ,cst_chn_nm         客户姓名
    ,rsk_ases_srl_nbr   首次风险评估流水号      --44939为空，占比11.4%
    ,ases_dt            历史首次风险测评日期
    ,ases_tm            历史首次风险测评时间
    ,rsk_grd            历史首次风险测评结果
    ,trx_srl_nbr        首次财富产品购买交易流水号
    ,trx_dt             首次财富产品购买日期
    ,trx_tm             首次财富产品购买时间
    ,prd_cls            首次财富产品购买类型
    ,pd_cd              首次购买产品代码
    ,pd_nm              首次购买产品名称
    ,trx_chnl_nm        首次购买渠道
from SJXQ_SJ2024051681_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024051681_CST_01 where dr=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,trx_dt,trx_tm,srl_nbr) custs
from SJXQ_SJ2024051681_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024051681_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024051681_CST_05
;
/*
01	505636	505636
03	7759823	7759823
04	394512	394512
05	394512	394512
输出结果为有风评且存在首笔财富交易工 394512，增加了首次风险评估流水号，首次财富产品购买交易流水号。
其中 首次风险评估流水号 缺失率49014 12.4%
*/***SJ20240522146_贵金属监管销量.sql
-- 贵金属交易明细 贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ20240522146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240522146_CST_01 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源 历史导入+金城
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,LENGTH(ORD_TM) ORD_TM_LEN
    ,CASE WHEN cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '@@{yyyyMMdd}'
AND replace(ORD_TM,'-','') >='20211201'   --交易时间
AND replace(ORD_TM,'-','') <='20240521'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号    均为无
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源 退款手工导入+柜面手工导入
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,LENGTH(ORD_TM) ORD_TM_LEN
    ,CASE WHEN ORD_TM like '%.%' OR ORD_TM like '%/%' OR LENGTH(ORD_TM)=8 OR cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '@@{yyyyMMdd}'
AND replace(ORD_TM,'-','') >='20211201'   --交易时间
AND replace(ORD_TM,'-','') <='20240521'   --交易时间
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240522146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240522146_CST_02 AS
SElECT PVD_NM                   商铺名称
    ,CMDT_NM                    商品名称
    ,CMDT_SPEC                  商品规格
    ,min(TRX_DT)                第一笔订单时间
    ,MAX(TRX_DT)                最后一笔订单时间
    ,SUM(QTY)                   累计销售数量
from SJXQ_SJ20240522146_CST_01
where IS_DEL=0
group by PVD_NM,CMDT_NM,CMDT_SPEC
;
/*
SELECT DATA_SRC,COUNT(1) CNT
    ,count(case when is_del=0 then CST_ID end) custs
FROM SJXQ_SJ20240522146_CST_01
GROUP BY DATA_SRC
历史导入	12376	12376
柜面手工导入	4240	4228
退款手工导入	2187	2187
金城	64120	64119
金城	64120 -1
2024 35741 -1
202403 6660 -1
20240301	393 -1
-- 以下记录报表缺失
SELECT *
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt = '20240301'
and DATA_SRC='金城'
and cst_id='1025723381'
柜面手工导入	4240 -12
2024	3398 -12 其中4条下单日期格式不统一，见如下sql
202401	1071 -7
202403	2168 -1
-- 以下记录存在4条重复记录，可通过 and ORD_TM not like '%.%' and ORD_TM not like '%/%' 剔除4
SELECT *
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '@@{yyyyMMdd}'
AND substr(ORD_TM,1,4)='2024'   --交易时间
and  DATA_SRC='柜面手工导入'
order by cst_nm,ORD_TM,cmdt_nm
-- 以下记录重复录入
SELECT *
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '@@{yyyyMMdd}'
AND substr(ORD_TM,1,4)='2024'   --交易时间
and  DATA_SRC='柜面手工导入'
order by cst_nm,ORD_TM,cmdt_nm
*/
***SJ2024052271_贵金属反洗钱排除.sql
/*
edw.amls_t37_party_result_curr          --风险评级结果表 8704134 resulekey 唯一
adm_upss.aml_t37_party_result_curr      --评级当前结果表 8704134 resulekey 唯一
adm_upss.aml_t37_level_audit_curr       --评级等级调整当前表
*/
-- 订单+商品维度 220条无客户号或订单号 13066无订单号
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_01 AS
SElECT col_1    --序号
    ,col_2      --数据来源
    ,col_3      --商铺名称
    ,col_4      --订单号 22010 非空
    ,col_5      --买家名称
    ,col_6      --客户号
    ,col_7      --真实姓名
    ,col_8      --邮寄方式
    ,col_9      --下单时间
    ,col_10     --付款时间
    ,col_11     --支付方式
    ,col_12     --渠道
    ,col_13     --订单状态
    ,col_14     --商品名称
    ,col_15     --商品规格
    ,col_16     --购买数量
    ,col_17     --商品分类
    ,col_18     --商品退款状态
    ,col_19     --商品现金单价
    ,col_20     --商品应付现金总额
    ,col_21     --推荐人工号
    ,col_22     --推荐人姓名
    ,col_23     --推荐人所属部门团队id
    ,col_24     --推荐人所属部门团队
    ,col_25     --支行名称
    ,col_26     --分行名称
    ,case when t2.order_id is not null then 1 else 0 end is_order
    ,t2.order_id,t2.order_status
FROM qbi_file_20240527_10_03_18     t1 --35296
left join(
    SElECT distinct order_id,order_status
    FROM    edw.tlsc_sunyardmall_orderform T1 --订单表
    WHERE   DT = '20240526'
    and nvl(order_id,'')<>''
)t2 on t1.col_4 = t2.order_id
and (LENGTH(col_6)=10           --客户号正常
    or LENGTH(order_id) >=25    --订单号正常
) --35076
;
-- 反洗钱表
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_02 AS
SELECT T1.PARTY_ID
    ,T1.cst_id           AS 客户号
    ,t1.party_chn_name
    ,t3.cst_chn_nm      --19717 与 party_chn_name 不等，占比0.28%
    ,T1.RISK_LEVEL       as 洗钱风险等级
    ,T1.PARTY_CLASS_CD   as 客户对公或对私
    ,T1.TEMPLATEKEY      as 模板编号
    ,T1.GSKEY            as 公式编号
    ,T1.Score            as 分值
    ,T1.ADJUST_REASON    as 编辑岗意见
FROM (
    SELECT T1.PARTY_ID,SUBSTR(T1.PARTY_ID,3,10) cst_id
        ,t1.party_chn_name	        --客户名称
        ,T1.LEVELKEY           AS RISK_LEVEL
        ,T1.PARTY_CLASS_CD     AS PARTY_CLASS_CD
        ,T1.TEMPLATEKEY
        ,T1.GSKEY
        ,T1.Score
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER(PARTITION BY SUBSTR(T1.PARTY_ID,3,10) ORDER BY t2.LAST_UPD_DT DESC) AS rn
    FROM adm_upss.aml_t37_party_result_curr      t1 --评级当前结果表
    inner join adm_upss.aml_t37_level_audit_curr t2 --评级等级调整当前表
    on T1.RESULEKEY = t2.RSLTKEY
    and t2.dt='20240526'
    and t2.POST_ID = 'P2001'        --提交岗位编辑岗
    WHERE t1.dt='20240526'
    and T1.LEVELKEY IS NOT NULL
) T1 inner join edw.dws_cst_bas_inf_dd           t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20240526'
WHERE T1.rn = 1
;
-- 订单维度
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_03 AS
SELECT t1.id
    ,T2.openid cst_id       --客户号
    ,t1.order_id            --订单号
    ,T1.order_status
    ,decode(t1.order_status,20,'已付款',30,'已发货',50,'已完成','') order_status_nm
    ,T1.receiver_name	    --收货人姓名,确认订单后，将买家的收货地址所有信息添加到订单中，该订单与买家收货地址没有任何关联
    ,T1.receiver_mobile	    --收货人手机号码
    ,REPLACE(substr(T1.addtime,1,10),'-','') trx_dt
    ,T1.addtime             --添加时间，这里为长时间格式
    ,t1.confirmtime
    ,t1.goods_amount	    --商品总价格
    ,T1.totalPrice + T1.integral_all * 0.01  tot_trx_amt
    ,T1.receiver_area	        --收货人详细地址，例如：凌空二街56-1号，4单元2楼1号
    ,T1.receiver_area_info	    --收货人详细地址，例如：凌空二街56-1号，4单元2楼1号
    ,t1.customer_manager_no
    ,t1.customer_manager_name
    ,ROW_NUMBER() over(partition by T2.openid,REPLACE(substr(T1.addtime,1,10),'-',''),T1.customer_manager_no,T1.goods_amount order by T1.addtime) rn
FROM    edw.tlsc_sunyardmall_orderform T1 --订单表
inner JOIN   edw.tlsc_sunyardmall_user T2 --用户表
ON      T1.user_id = T2.id --用户id
AND     T2.DT = '20240526'
WHERE   T1.DT = '20240526'
AND     REPLACE(substr(T1.addtime,1,10),'-','') between '20211201' and '20230630'
AND     T1.order_status <> '0' --剔除取消订单
and     t1.order_status <>'10' --剔除已提交待付款
and     t1.order_status <>'25' --13024 报表剔除
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_04 AS
-- 订单号可匹配 22010
SElECT t1.col_1    序号
    ,t1.col_2      数据来源
    ,t1.col_3      商铺名称
    ,t1.col_4      订单号
    ,t1.col_5      买家名称
    ,t1.col_6      客户号
    ,t1.col_7      真实姓名
    ,t1.col_8      邮寄方式
    ,t1.col_9      下单时间
    ,t1.col_10     付款时间
    ,t1.col_11     支付方式
    ,t1.col_12     渠道
    ,t1.col_13     订单状态
    ,t1.col_14     商品名称
    ,t1.col_15     商品规格
    ,t1.col_16     购买数量
    ,t1.col_17     商品分类
    ,t1.col_18     商品退款状态
    ,t1.col_19     商品现金单价
    ,t1.col_20     商品应付现金总额
    ,t1.col_21     推荐人工号
    ,t1.col_22     推荐人姓名
    ,t1.col_23     推荐人所属部门团队id
    ,t1.col_24     推荐人所属部门团队
    ,t1.col_25     支行名称
    ,t1.col_26     分行名称
    ,T2.洗钱风险等级
    ,T2.客户对公或对私
    ,T2.模板编号
    ,T2.公式编号
    ,T2.分值
    ,T2.编辑岗意见
    ,T3.receiver_name	        收货人姓名
    ,T3.receiver_mobile	        收货人手机号码
    ,T3.receiver_area	        收货人地址
    ,T3.receiver_area_info	    收货人详细地址
    ,t3.trx_dt,t3.goods_amount,t3.tot_trx_amt --一致
    ,t3.customer_manager_no,t1.is_order
from SJXQ_SJ2024052271_CST_01       t1
left join SJXQ_SJ2024052271_CST_02  t2
on t1.col_6=t2.客户号
left join SJXQ_SJ2024052271_CST_03  t3
on t1.col_4=t3.order_id
where t1.is_order=1
union all
-- 客户号匹配 9817
SElECT t1.col_1    序号
    ,t1.col_2      数据来源
    ,t1.col_3      商铺名称
    ,t1.col_4      订单号
    ,t1.col_5      买家名称
    ,t1.col_6      客户号
    ,t1.col_7      真实姓名
    ,t1.col_8      邮寄方式
    ,t1.col_9      下单时间
    ,t1.col_10     付款时间
    ,t1.col_11     支付方式
    ,t1.col_12     渠道
    ,t1.col_13     订单状态
    ,t1.col_14     商品名称
    ,t1.col_15     商品规格
    ,t1.col_16     购买数量
    ,t1.col_17     商品分类
    ,t1.col_18     商品退款状态
    ,t1.col_19     商品现金单价
    ,t1.col_20     商品应付现金总额
    ,t1.col_21     推荐人工号
    ,t1.col_22     推荐人姓名
    ,t1.col_23     推荐人所属部门团队id
    ,t1.col_24     推荐人所属部门团队
    ,t1.col_25     支行名称
    ,t1.col_26     分行名称
    ,T2.洗钱风险等级
    ,T2.客户对公或对私
    ,T2.模板编号
    ,T2.公式编号
    ,T2.分值
    ,T2.编辑岗意见
    ,T3.receiver_name	        收货人姓名
    ,T3.receiver_mobile	        收货人手机号码
    ,T3.receiver_area	        收货人地址
    ,T3.receiver_area_info	    收货人详细地址
    ,t3.trx_dt,t3.goods_amount,t3.tot_trx_amt --一致
    ,t3.customer_manager_no,t1.is_order
from SJXQ_SJ2024052271_CST_01       t1
left join SJXQ_SJ2024052271_CST_02  t2
on t1.col_6=t2.客户号
left join SJXQ_SJ2024052271_CST_03  t3
on t1.col_6=t3.cst_id
and replace(t1.col_9,'-','')=t3.trx_dt
and t1.col_21=t3.customer_manager_no
and abs(t1.col_20-t3.goods_amount)<1
and t3.rn=1
where t1.is_order=0
;
SElECT '01' seq, count(1) cnt,count(distinct col_6,col_21) custs
from SJXQ_SJ2024052271_CST_01
union all
SElECT '011' seq, count(1) cnt,count(distinct col_4) custs
from SJXQ_SJ2024052271_CST_01 where nvl(col_4,'')<>'' --订单号
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024052271_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052271_CST_03
union all
SElECT '031' seq, count(1) cnt,count(distinct order_id) custs
from SJXQ_SJ2024052271_CST_03 where nvl(order_id,'')<>''
union all
SElECT '04' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024052271_CST_04
;
SElECT sum(is_order)    订单匹配数
    ,sum(case when is_order=0 and 收货人姓名 is not null then 1 else 0 end) 客户号匹配数
    ,sum(case when 收货人姓名 is null then 1 else 0 end) 无法匹配数
from SJXQ_SJ2024052271_CST_04
;
/*
01	35076	24627
011	22754	20496
02	7080516	7080516
03	786081	296517
031	786081	786074
04	35076	35076
订单匹配数	客户号匹配数	无法匹配数
22010	9793	3273
SELECT col_6,col_9,col_14,col_20,count(1) cnt
from SJXQ_SJ2024052271_CST_01
GROUP BY col_6,col_9,col_14,col_20
ORDER BY cnt desc
limit 100
;
SELECT *
from SJXQ_SJ2024052271_CST_01
where col_6 ='1039547023'
and col_9 ='2022-01-20'
and col_14='柿柿如意'
-- 反洗钱表 不正常客户号用 身份证号关联，容易存在一个客户2个不同风险等级。
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_02_1 AS
SELECT T1.PARTY_ID
    ,T1.cst_id           AS 客户号
    ,t1.cst_chn_nm,t1.party_chn_name
    ,T1.RISK_LEVEL       as 洗钱风险等级
    ,T1.PARTY_CLASS_CD   as 客户对公或对私
    ,T1.TEMPLATEKEY      as 模板编号
    ,T1.GSKEY            as 公式编号
    ,T1.Score            as 分值
    ,T1.ADJUST_REASON    as 编辑岗意见
    ,t1.cst_id_doc
FROM (
    SELECT T1.PARTY_ID
        ,coalesce(t3.cst_id,t4.cst_id)         cst_id
        ,coalesce(t3.cst_chn_nm,t4.cst_chn_nm) cst_chn_nm
        ,t1.party_chn_name	        --客户名称
        ,T1.LEVELKEY           AS RISK_LEVEL
        ,T1.PARTY_CLASS_CD     AS PARTY_CLASS_CD
        ,T1.TEMPLATEKEY
        ,T1.GSKEY
        ,T1.Score
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER(PARTITION BY SUBSTR(T1.PARTY_ID,3,10) ORDER BY t2.LAST_UPD_DT DESC) AS rn
        ,t4.cst_id cst_id_doc
    FROM adm_upss.aml_t37_party_result_curr      t1 --评级当前结果表
    inner join adm_upss.aml_t37_level_audit_curr t2 --评级等级调整当前表
    on T1.RESULEKEY = t2.RSLTKEY
    and t2.dt='20240526'
    and t2.POST_ID = 'P2001'        --提交岗位编辑岗
    left join edw.dws_cst_bas_inf_dd             t3 --客户基础信息汇总表
    on SUBSTR(T1.PARTY_ID,3,10)=t3.cst_id
    and t3.dt='20240526'
    left join edw.dws_cst_bas_inf_dd             t4 --客户基础信息汇总表
    on T1.PARTY_ID=t4.doc_nbr
    and t4.dt='20240526'
    and nvl(t4.doc_nbr,'')<>''
    WHERE t1.dt='20240526'
    and T1.LEVELKEY IS NOT NULL
) T1 WHERE T1.rn = 1
and cst_id is not null
;
1. 取得最新日期（20240526）反洗钱风险等级。客户号非空或订单非空 35076，282  条反洗钱风险等级为空，3273 条收货人信息为空
2. 探索发现 反洗钱表中 PARTY_ID 大部分为客户号，部分为证件号。用 证件号关联，容易存在一个客户2个不同风险等级。维持原代码，只用客户号关联
3. 给的excel客群的订单时间为 20211201-20230630
*/***SJ2024052271_贵金属反洗钱排除0529.sql
/*
edw.amls_t37_party_result_curr          --风险评级结果表 8704134 resulekey 唯一
adm_upss.aml_t37_party_result_curr      --评级当前结果表 8704134 resulekey 唯一
adm_upss.aml_t37_level_audit_curr       --评级等级调整当前表
*/
-- 订单+商品维度 220条无客户号或订单号 13066无订单号
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_01 AS
SElECT col_1    --序号
    ,col_2      --数据来源
    ,col_3      --商铺名称
    ,col_4      --订单号 22010 非空
    ,col_5      --买家名称
    ,col_6      --客户号
    ,col_7      --真实姓名
    ,col_8      --邮寄方式
    ,col_9      --下单时间
    ,col_10     --付款时间
    ,col_11     --支付方式
    ,col_12     --渠道
    ,col_13     --订单状态
    ,col_14     --商品名称
    ,col_15     --商品规格
    ,col_16     --购买数量
    ,col_17     --商品分类
    ,col_18     --商品退款状态
    ,col_19     --商品现金单价
    ,col_20     --商品应付现金总额
    ,col_21     --推荐人工号
    ,col_22     --推荐人姓名
    ,col_23     --推荐人所属部门团队id
    ,col_24     --推荐人所属部门团队
    ,col_25     --支行名称
    ,col_26     --分行名称
    ,case when t2.order_id is not null then 1 else 0 end is_order
    ,t2.order_id,t2.order_status
    -- ,case when LENGTH(col_6)=10 or LENGTH(order_id) >=25 then 1 else 0 end   --客户号或订单号正常
FROM qbi_file_20240527_10_03_18     t1 --35296
left join(
    SElECT  distinct order_id,order_status
    FROM    edw.tlsc_sunyardmall_orderform T1 --订单表
    WHERE   DT = '20240526'
    and     nvl(order_id,'')<>''
)t2 on t1.col_4 = t2.order_id
;
-- 反洗钱表
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_02 AS
SELECT T1.PARTY_ID
    ,T1.cst_id           AS 客户号
    ,t1.party_chn_name
    ,t3.cst_chn_nm      --19717 与 party_chn_name 不等，占比0.28%
    ,T1.RISK_LEVEL       as 洗钱风险等级
    ,T1.PARTY_CLASS_CD   as 客户对公或对私
    ,T1.TEMPLATEKEY      as 模板编号
    ,T1.GSKEY            as 公式编号
    ,T1.Score            as 分值
    ,T1.ADJUST_REASON    as 编辑岗意见
FROM (
    SELECT T1.PARTY_ID,SUBSTR(T1.PARTY_ID,3,10) cst_id
        ,t1.party_chn_name	        --客户名称
        ,T1.LEVELKEY           AS RISK_LEVEL
        ,T1.PARTY_CLASS_CD     AS PARTY_CLASS_CD
        ,T1.TEMPLATEKEY
        ,T1.GSKEY
        ,T1.Score
        ,t2.ADJUST_REASON
        ,ROW_NUMBER() OVER(PARTITION BY SUBSTR(T1.PARTY_ID,3,10) ORDER BY t2.LAST_UPD_DT DESC) AS rn
    FROM adm_upss.aml_t37_party_result_curr      t1 --评级当前结果表
    inner join adm_upss.aml_t37_level_audit_curr t2 --评级等级调整当前表
    on T1.RESULEKEY = t2.RSLTKEY
    and t2.dt='20240526'
    and t2.POST_ID = 'P2001'        --提交岗位编辑岗
    WHERE t1.dt='20240526'
    and T1.LEVELKEY IS NOT NULL
) T1 inner join edw.dws_cst_bas_inf_dd           t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20240526'
WHERE T1.rn = 1
;
-- 订单维度
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_03 AS
SELECT t1.id
    ,T2.openid cst_id       --客户号
    ,t1.order_id            --订单号
    ,T1.order_status
    ,decode(t1.order_status,20,'已付款',30,'已发货',50,'已完成','') order_status_nm
    ,T1.receiver_name	    --收货人姓名,确认订单后，将买家的收货地址所有信息添加到订单中，该订单与买家收货地址没有任何关联
    ,T1.receiver_mobile	    --收货人手机号码
    ,REPLACE(substr(T1.addtime,1,10),'-','') trx_dt
    ,T1.addtime             --添加时间，这里为长时间格式
    ,t1.confirmtime
    ,t1.goods_amount	    --商品总价格
    ,T1.totalPrice + T1.integral_all * 0.01  tot_trx_amt
    ,T1.receiver_area	        --收货人详细地址，例如：凌空二街56-1号，4单元2楼1号
    ,T1.receiver_area_info	    --收货人详细地址，例如：凌空二街56-1号，4单元2楼1号
    ,t1.customer_manager_no
    ,t1.customer_manager_name
    ,ROW_NUMBER() over(partition by T2.openid,REPLACE(substr(T1.addtime,1,10),'-',''),T1.customer_manager_no,T1.goods_amount order by T1.addtime) rn
    ,ROW_NUMBER() over(partition by t1.order_id order by t1.order_status desc) rn2
FROM    edw.tlsc_sunyardmall_orderform T1 --订单表
inner JOIN   edw.tlsc_sunyardmall_user T2 --用户表
ON      T1.user_id = T2.id --用户id
AND     T2.DT = '20240526'
WHERE   T1.DT = '20240526'
AND     REPLACE(substr(T1.addtime,1,10),'-','') between '20211201' and '20230630'
and     nvl(t1.order_id,'')<>''     --订单非空
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024052271_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052271_CST_04 AS
-- 订单号可匹配 22010
SElECT t1.col_1    序号
    ,t1.col_2      数据来源
    ,t1.col_3      商铺名称
    ,t1.col_4      订单号
    ,t1.col_5      买家名称
    ,t1.col_6      客户号
    ,t1.col_7      真实姓名
    ,T2.洗钱风险等级
    ,T2.客户对公或对私
    ,T2.模板编号
    ,T2.公式编号
    ,T2.分值
    ,T2.编辑岗意见
    ,t1.col_8      邮寄方式
    ,t1.col_9      下单时间
    ,t1.col_10     付款时间
    ,t1.col_11     支付方式
    ,t1.col_12     渠道
    ,t1.col_13     订单状态
    ,t1.col_14     商品名称
    ,t1.col_15     商品规格
    ,t1.col_16     购买数量
    ,t1.col_17     商品分类
    ,t1.col_18     商品退款状态
    ,t1.col_19     商品现金单价
    ,t1.col_20     商品应付现金总额
    ,t1.col_21     推荐人工号
    ,t1.col_22     推荐人姓名
    ,t1.col_23     推荐人所属部门团队id
    ,t1.col_24     推荐人所属部门团队
    ,t1.col_25     支行名称
    ,t1.col_26     分行名称
    ,T3.receiver_name	        收货人姓名
    ,T3.receiver_mobile	        收货人手机号码
    ,T3.receiver_area	        收货人地址
    ,T3.receiver_area_info	    收货人详细地址
from SJXQ_SJ2024052271_CST_01       t1
left join SJXQ_SJ2024052271_CST_02  t2
on t1.col_6=t2.客户号
left join SJXQ_SJ2024052271_CST_03  t3
on t1.col_4=t3.order_id
and t3.rn2=1    --有7个订单号重复，但收货信息均为空
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024052271_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024052271_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct order_id) custs
from SJXQ_SJ2024052271_CST_03 where rn2=1
union all
SElECT '04' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024052271_CST_04
;
/*
01	35296	35296
02	7080516	7080516
03	943131	943131
04	35296	35296
*/***SJ2024052431_行业信息大地-1财险.sql
/*
&quot;1.在我行开户-edw.dim_cst_entp_bas_inf_dd-统一社会信用代码关联-edw.nout_gs_label_total_sub -enttype（个体工商户
，非&lsquo;个体工商户&rsquo;）-行业小类industrycode、industryname -- 筛选企业状态
2. 未在我行开户 - 参考代码1--统一社会信用代码--edw.dim_cst_entp_bas_inf_dd（剔除已在开户）-一社会信用代码关联-edw.nout_gs_label_total_sub -enttype（个体工商户
，非&lsquo;个体工商户&rsquo;）-行业小类industrycode、industryname -- 筛选企业状态&quot;
*/
-- 企业 统一社会信用代码
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_01 AS
SElECT *
from(
    SELECT entid,enttype
        ,esdate
        ,legalname
        ,socialcreditcode
        ,entname
        ,entstatuscode	    --企业状态码值
        ,industrycode
        ,industryname
        ,industryphycode
        ,industryphyname
        ,use_flag	        --使用标志
        ,dt
        ,ROW_NUMBER() over(partition by socialcreditcode order by dt desc) rn
    from edw.nout_gs_label_total_sub    --企业标签总表
    where dt<='@@{yyyyMMdd}'
    and nvl(socialcreditcode,'')<>''
    and socialcreditcode<>'null'
    and nvl(industryphycode,'')<>''
    and industryphycode<>'null'
    and entstatuscode= '1' --1 正常  2 吊销 21 吊销未注销 22 吊销已注销 3 注销 4 迁出 5 撤销 6 废止 7 歇业 8 停业  ELSE9
)t1 where rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_02 AS
SElECT col_1    --序号
    ,col_2      --代码
    ,col_3      --码值
    ,col_4      --风险等级
    ,case when col_4 regexp '一' then 1
        when col_4 regexp '二' then 2
        when col_4 regexp '三' then 3
        when col_4 regexp '四' then 4 else 0 end ind_rsk_grd
FROM qbi_file_20240530_09_04_15
;
-- 在我行开户
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_03 AS
select t1.cst_id                               --客户号|C20
	,t1.cst_nm                                 --客户名称|C200
	,t1.cst_typ_cd                             --客户类型代码|C1
	,t1.opr_situ_cd                            --经营状况代码 ,该码值不能用
	,t1.org_org_found_dt                       --组织机构成立日期|C8
	,t1.idt_ctg_cd                             --行业分类代码|C10
    ,c1.cd_val_dscr idt_ctg_nm
    ,t1.lctax_cert_no                          --地税证件号 6个客户共用3个统一社会信用号
    ,case when t2.enttype='个体工商户' then 1 else 0 end is_idv
    ,t2.industrycode
    ,t2.industryname
from edw.dim_cst_entp_bas_inf_dd    t1  --企业客户基本信息
inner join SJXQ_SJ2024052431_CST_01 t2
on  t1.lctax_cert_no=t2.socialcreditcode
inner join adm_pub.adm_csm_cbas_mng_inf_dd t3 --客户`管户`基础信息
on  t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
and t3.FORML_CST_IND = '1'  --限制正式客户
left join edw.dwd_code_library_dd   c1  --132058
on t1.idt_ctg_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
-- and t1.opr_situ_cd like '01%'   --营业中
;
-- 未在我行开户
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_04 AS
select *
from(
    SELECT cst_id,doc_nbr,uscc,entp_typ,entp_nm,entp_sts,pvc,idt_nm
        ,ROW_NUMBER() over(partition by uscc order by dat_tm desc,dat_ins_tm desc) rn
    from lab_bigdata_dev.wushan_024547_kequn_gs_prsn -- 工商个人人员法人信息
    where nvl(uscc,'')<>''
)t1 where rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_05 AS
select t1.uscc,t1.cst_id
    ,case when t3.enttype='个体工商户' then 1 else 0 end is_idv
    ,t3.industrycode
    ,t3.industryname
from SJXQ_SJ2024052431_CST_04 t1
left join(
    SElECT distinct lctax_cert_no
    from edw.dim_cst_entp_bas_inf_dd
    where dt='@@{yyyyMMdd}'
)t2 on t1.uscc=t2.lctax_cert_no
inner join SJXQ_SJ2024052431_CST_01 t3
on t1.uscc=t3.socialcreditcode
where t2.lctax_cert_no is null    --剔除已在我行开户
;
-- 客群 合并
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_06 AS
SElECT t1.uscc,t1.cst_id,t1.is_idv,t1.industrycode,t1.industryname,is_opn_cst
    ,t2.crd_tot_amt	                --授信总额
    ,t2.crd_bal	                    --授信余额
    ,t3.crd_lmt     sdt_crdt_amt    --随贷通授信额度
    ,t4.is_hld_okv	                --持有泰惠收产品
    ,case when t5.cst_id is not null then 1 else 0 end is_tz_prm
    ,case when t6.cst_id is not null then 1 else 0 end is_tz_opn
    ,case when t7.cst_id is not null then 1 else 0 end is_tz_loan
from(
    SElECT lctax_cert_no uscc,cst_id,is_idv,industrycode,industryname,1 is_opn_cst
    from SJXQ_SJ2024052431_CST_03
    union all
    select uscc,cst_id,is_idv,industrycode,industryname,0
    from SJXQ_SJ2024052431_CST_05
    where nvl(cst_id,'')<>''        --法人是我行客户
)t1 left join adm_pub.adm_csm_clab_ln_inf_dd    t2 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_fnc_crd_lmt_inf_dd   t3 --随贷通授信额度信息
on t1.cst_id=t3.cst_id
and t3.lmt_sts_cd='0' --,'0','正常' ,'1','停用' ,'2','已解约' ,'3','未激活' ,'4','止付' ,'5','未签约'
and t3.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd    t4 --客户集市-标签信息-客户持有产品信息表
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join(
    SElECT distinct t1.cst_id
    from adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t1 --客户`主管户`信息
    inner join edw.dim_hr_org_mng_org_tree_dd      t4 --考核机构树
    on  t1.prm_org_id = t4.org_id
    and t4.dt = '@@{yyyyMMdd}'
    and t4.brc_org_nm='台州分行'
    where t1.dt = '@@{yyyyMMdd}'
)t5 on t1.cst_id=t5.cst_id
left join(
    SElECT distinct t1.cst_id
    from edw.dim_bus_dep_cst_act_inf_dd	        t1 --客户存款账户信息
    inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
    on  t1.opn_org_id = t4.org_id   --开户机构编号
    and t4.dt = '@@{yyyyMMdd}'
    and t4.brc_org_nm='台州分行'
    where t1.dt = '@@{yyyyMMdd}'
)t6 on t1.cst_id=t6.cst_id
left join(
    SElECT distinct t1.cst_id
    from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
    INNER join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
    on t1.busi_ctr_id = t3.busi_ctr_id
    and t3.dt = '@@{yyyyMMdd}'
    INNER join  edw.dim_hr_org_mng_org_tree_dd  t4 --考核机构树
    on t3.acs_org_id = t4.org_id
    and t4.dt = '@@{yyyyMMdd}'
    and t4.BRC_ORG_NM='台州分行'
    where t1.dt = '@@{yyyyMMdd}'
)t7 on t1.cst_id=t7.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_07 AS
SElECT t1.col_1    序号
    ,t1.col_2      代码
    ,t1.col_3      码值
    ,t1.col_4      风险等级
    ,t2.全部_非个体工商户
    ,t2.已在我行开户_非个体工商户
    ,t2.未在我行开户_非个体工商户
    ,t2.开户授信公司数_非个体工商户
    ,t2.开户有余额公司数_非个体工商户
    ,t2.开户有余额平均贷款余额_非个体工商户
    ,t2.未开户企业主有余额客户数_非个体工商户
    ,t2.全部客户数_个体工商户
    ,t2.个人信贷额度剔除信用卡客户数_个体工商户
    ,t2.随贷通授信金额客户数_个体工商户
    ,t2.泰惠收客户数_个体工商户
from SJXQ_SJ2024052431_CST_02 t1
left join(
    SElECT industrycode
        -- 非个体工商户
        ,count(distinct case when is_idv=0 then uscc end)                                       全部_非个体工商户
        ,count(distinct case when is_idv=0 and is_opn_cst=1 then cst_id end)                    已在我行开户_非个体工商户
        ,count(distinct case when is_idv=0 and is_opn_cst=0 then uscc end)                      未在我行开户_非个体工商户
        ,count(distinct case when is_idv=0 and is_opn_cst=1 and crd_tot_amt>0 then cst_id end)  开户授信公司数_非个体工商户
        ,count(distinct case when is_idv=0 and is_opn_cst=1 and crd_bal>0 then cst_id end)      开户有余额公司数_非个体工商户
        ,case when count(case when is_idv=0 and is_opn_cst=1 and crd_bal>0 then cst_id end)<>0
            then sum(case when is_idv=0 and is_opn_cst=1 then crd_bal else 0 end)/count(distinct case when is_idv=0 and is_opn_cst=1 and crd_bal>0 then cst_id end)
            else 0 end                                                                          开户有余额平均贷款余额_非个体工商户
        ,count(distinct case when is_idv=0 and is_opn_cst=0 and crd_bal>0 then uscc end)        未开户企业主有余额客户数_非个体工商户
        -- 个体工商户
        ,count(distinct case when is_idv=1 then cst_id end)                                     全部客户数_个体工商户
        ,count(distinct case when is_idv=1 and crd_tot_amt>0 then cst_id end)                   个人信贷额度剔除信用卡客户数_个体工商户
        ,count(distinct case when is_idv=1 and sdt_crdt_amt>0 then cst_id end)                  随贷通授信金额客户数_个体工商户
        ,count(distinct case when is_idv=1 and is_hld_okv='1' then cst_id end)                  泰惠收客户数_个体工商户
    from SJXQ_SJ2024052431_CST_06
    where is_tz_prm+is_tz_opn+is_tz_loan>=1     --主管户或者信贷管户或者开户行是台州分行
    group by industrycode
)t2 on substr(t1.col_2,2,4)=t2.industrycode
order by t1.col_1
;
-- 全行不限制行业
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST_08 AS
SElECT industrycode,industryname
    -- 非个体工商户
    ,count(distinct case when is_idv=0 then uscc end)                                       全部_非个体工商户
    ,count(distinct case when is_idv=0 and is_opn_cst=1 then cst_id end)                    已在我行开户_非个体工商户
    ,count(distinct case when is_idv=0 and is_opn_cst=0 then uscc end)                      未在我行开户_非个体工商户
    ,count(distinct case when is_idv=0 and is_opn_cst=1 and crd_tot_amt>0 then cst_id end)  开户授信公司数_非个体工商户
    ,count(distinct case when is_idv=0 and is_opn_cst=1 and crd_bal>0 then cst_id end)      开户有余额公司数_非个体工商户
    ,case when count(case when is_idv=0 and is_opn_cst=1 and crd_bal>0 then cst_id end)<>0
        then sum(case when is_idv=0 and is_opn_cst=1 then crd_bal else 0 end)/count(distinct case when is_idv=0 and is_opn_cst=1 and crd_bal>0 then cst_id end)
        else 0 end                                                                          开户有余额平均贷款余额_非个体工商户
    ,count(distinct case when is_idv=0 and is_opn_cst=0 and crd_bal>0 then uscc end)        未开户企业主有余额客户数_非个体工商户
    -- 个体工商户
    ,count(distinct case when is_idv=1 then cst_id end)                                     全部客户数_个体工商户
    ,count(distinct case when is_idv=1 and crd_tot_amt>0 then cst_id end)                   个人信贷额度剔除信用卡客户数_个体工商户
    ,count(distinct case when is_idv=1 and sdt_crdt_amt>0 then cst_id end)                  随贷通授信金额客户数_个体工商户
    ,count(distinct case when is_idv=1 and is_hld_okv='1' then cst_id end)                  泰惠收客户数_个体工商户
from SJXQ_SJ2024052431_CST_06
group by industrycode,industryname
;
SElECT '01' seq, count(1) cnt,count(distinct socialcreditcode) custs
from SJXQ_SJ2024052431_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024052431_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052431_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct uscc) custs
from SJXQ_SJ2024052431_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct uscc) custs
from SJXQ_SJ2024052431_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct uscc) custs
from SJXQ_SJ2024052431_CST_06
union all
SElECT '061' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052431_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024052431_CST_07
;
/*
01	18472836	18472836
02	714	714
03	387316	387316
04	3280277	3280277
05	2062982	2062982
06	2375771	2375728
061	2375771	1855501
07	714	714
1. 对私客户的贷款是 授信、还是有贷款余额？有贷款余额
2. 未在我行开户-企业主-在我行贷款-去重企业主数量：统一社会信用、客户号去重？客户号去重
3. 公司数按统一社会信用、客户数按客户号 去重计数？已开户就会有客户，一个客户号对应一个公司
*/***SJ2024052431_行业信息大地-2寿险.sql
-- 13021 保险代销业务考核明细表
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_01 AS
SELECT  '20240523'                                                                AS ACT_DT --会计日期
        ,TO_CHAR(TO_DATE(COALESCE(T3.INSU_DT, '18991231'), 'yyyyMMdd'), 'yyyyMMdd')   AS TRX_DT --交易日期
        ,TO_CHAR(LASTDAY(TO_DATE(T3.INSU_DT, 'yyyymmdd')),'yyyymmdd')                 as trx_lst_dt
        ,COALESCE(T1.CST_ID, '')                                                      AS CST_ID --客户号
        ,COALESCE(T1.CST_ACT_ID, '')                                                  AS CST_ACT_NBR --客户账号
        ,COALESCE(T1.INSU_HLD_NM, '')                                                 AS INSU_HLD_NM --投保人姓名
        ,COALESCE(T1.INSU_HLD_GDR_NM, '')                                             AS INSU_HLD_GDR --投保人性别  翻译  修改
        ,COALESCE(REPLACE(T1.INSU_HLD_AGE, '-', ''), '')                              AS INSU_HLD_BTH_DT --投保人出生日期
        ,COALESCE(T1.INSU_WTH_INSU_REL_NM, '')                                        AS INSU_HLD_INSU_REL --投保人与被保险人关系  B_BDZT
        ,COALESCE(T1.WTH_INSU_NM, '')                                                 AS INSU_NM --被保险人姓名
        ,COALESCE(T1.WTH_INSU_GDR_NM, '')                                             AS INSU_GDR --被保险人性别
        ,COALESCE(REPLACE(T1.WTH_INSU_AGE, '-', ''), '')                              AS INSU_BTH_DT --被保险人出生日期
        ,COALESCE(T1.CMP_CD, '')                                                      AS CMP_CD --公司代码
        ,COALESCE(T1.CMP_NM, '')                                                      AS CMP_NM --公司名称
        ,COALESCE(T6.CD_VAL_DSCR, '')                                                 AS CMP_TYP --公司类型   T6 1 人寿 2 财险 3 混合 4 其它
        ,COALESCE(T1.PD_CD, '')                                                       AS PROD_CD --产品代码
        ,COALESCE(T1.PD_NM, '')                                                       AS PROD_NM --产品名称
        ,COALESCE(T1.INSU_BRED_NM, '')                                                AS PROD_INSU_BRED --产品险种
        ,COALESCE(T1.INSU_PLCY_ID, '')                                                AS INSU_ORD_NBR --投保单号
        ,COALESCE(T1.INSU_ID, '')                                                     AS INSU_PLCY_ID --保单号
        ,COALESCE(T1.INSU_PLCY_STS_NM, '')                                            AS INSU_PLCY_STS --保单状态   翻译
        ,COALESCE(T1.CUR_INSU_PLCY_STS_NM, '')                                        AS CUR_INSU_PLCY_STS_NM --新保单状态
        ,COALESCE(T20.INSU_TOT_AMT, 0)                                                AS INSU_AMT --保额
        ,COALESCE(T24.INSU_VRTY_PREM, 0)                                              AS FRS_TRM_INSU_FEE --首期保费
        ,COALESCE(T20.INSU_AMT * COALESCE(T1.MNG_RTO, 1), 0)                          AS MNG_CNV_INSU_FEE --管护折算保费
        ,COALESCE(T1.PAY_MTH_NM, '')                                                  AS PAY_YEAR_PRD_TYP --缴费年期类型
        ,CASE
           WHEN T1.PAY_MTH_CD = '0' THEN '1'
           ELSE COALESCE(T1.PAY_YEAR, '')
         END                                                                          AS PAY_YEAR --缴费年限
        ,COALESCE(T1.PROT_YR_PERD_TYP, '')                                            AS GUAR_YEAR_PRD_TYP --保障年期类型
        ,CASE
           WHEN T1.PROT_YR_PERD_TYP = '终身' THEN '终身'
           ELSE COALESCE(T1.BZ_YEAR_PRD, '')
         END                                                                          AS GUAR_YEAR_PRD --保障年期
        ,COALESCE(T8.CD_VAL_DSCR, '')                                                 AS CMSN_FEE_CALC_TYP --手续费计算类型  /*HS_KEY = B_JSLX 0 免收 1 单笔固定金额 2 按百分比计收3 每批固定金额*/
        ,COALESCE(T1.PFM_FEE_RAT, 0)                                                  AS HDL_CHRG_RAT --手续费率 章陵 给的
        ,COALESCE(T1.PFM_CMSN_FEE, 0)                                                 AS CMSN_FEE --手续费
        ,COALESCE(T1.ADD_FEE_IND, '')                                                 AS ADD_FEE_IND --加费标志
        ,COALESCE(T1.MNG_PFM_CMSN_FEE, 0)                                             AS MNG_CNV_CMSN_FEE --管护折算绩效手续费
        ,1                                                                            AS NBR_NUM --件数   --固定默认值
        ,COALESCE(T1.MNG_RTO, 1)                                                      AS MNG_CNV_NBR_NUM --管护折算件数
        ,COALESCE(T1.MNG_ID, '')                                                      AS MNG_MGR_ID --管护客户经理工号  X330200121  20210423
        ,COALESCE(T1.MNG_NM, '')                                                      AS MNG_MGR_NM --管护客户经理姓名
        ,COALESCE(T1.MNG_RTO, 0)                                                      AS MNG_RTO --管护比例
        ,COALESCE(T1.MNG_ORG_ID, '')                                                  AS MNG_ORG_ID --管护机构号
        ,COALESCE(T1.MNG_ORG_NM, '')                                                  AS MNG_ORG_NM --管护机构名称
        ,COALESCE(T12.MNG_ID, '')                                                     AS SAL_PPL_ID --销售人员工号
        ,COALESCE(T13.EMPE_NM, '')                                                    AS SAL_PPL_NM --销售人员姓名
        ,COALESCE(T14.CERT_ACQ_NO, '')                                                AS SAL_PPL_REG_ID --销售人员执业登记编号
        ,COALESCE(T12.POS_ID, '')                                                     AS SAL_PPL_PST_ID --销售人员岗位编号  有空  pos_enc
        ,COALESCE(T15.POS_NM, '')                                                     AS SAL_PPL_PST_NM  --销售人员岗位名称
        -------------------------MOD BY 20211214 LQJ 销售人员所属机构为销售人员当时所在机构------------------------------------------------------
        ,COALESCE(T12.MNG_ORG_ID, '')                                                 AS SAL_PPL_AFL_ORG_ID --销售人员所属机构号
        ,COALESCE(T16.ORG_NM, '')                                                     AS SAL_PPL_AFL_ORG_NM --销售人员所属机构名称
        ,COALESCE(T1.TXN_CHN_NM, '')                                                  AS TRX_CHNL --交易渠道
        ,COALESCE(T1.ORG_ID, '')                                                      AS TRX_ORG_ID --交易机构号
        ,COALESCE(T17.UNT_ORG_NM, '')                                                 AS TRX_ORG_NM --交易机构名称
        ,COALESCE(T17.SUM_ORG_ID, '')                                                 AS TRX_BRA --交易分行
        ,COALESCE(T17.SUM_ORG_NM, '')                                                 AS TRX_BRA_NM --交易分行名称  新增字段
        ,CASE
           WHEN T17.SUM_ORG_NM LIKE '%宁波%'                                                                                                                                                                      THEN '宁波'
           WHEN T17.SUM_ORG_NM LIKE '%上海%'                                                                                                                                                                      THEN '上海'
           WHEN T17.SUM_ORG_NM LIKE '%苏州%'                                                                                                                                                                      THEN '苏州'
           WHEN T17.SUM_ORG_NM IN ( '台州分行' , '杭州分行' , '温州分行' , '丽水分行' , '绍兴分行' , '金华分行' , '嘉兴分行' , '湖州分行' , '衢州分行' , '舟山分行' , '浙江庆元泰隆村镇银行' , '国际合作与创新部' , '消费金融部' , '浙江泰隆商业银行总行' , '总行营业部' , '浙江泰隆商业银行总行清算中心' ) THEN '浙江省（除宁波）'
           ELSE ''
         END                                                                          AS SPVS_RPT_RGN --监管报送区域   通过交易分行名称来区分
        ,COALESCE(T1.ISU_MOD_CD, '')                                                  AS TRX_CD --交易代码
        ,COALESCE(T1.ISU_MOD_NM, '')                                                  AS TRX_NM --交易名称
        ,COALESCE(T2.OPRR_ID, '')                                                     AS OPR_ID --操作员号
        ,COALESCE(T18.TLR_NM, '')                                                     AS TLR_NM --柜员名称
        ,COALESCE(T9.CD_VAL_DSCR, '')                                                 AS VCH_CLS --凭证种类
        ,COALESCE(T10.CD_VAL_DSCR, '')                                                AS TRX_STS --交易状态
        ,COALESCE(T2.TRX_TM, '')                                                      AS TRX_TM --交易时间
        ,CASE
           WHEN T3.BNFR_WTHR_LGL_CD = '1' THEN '法定继承人'
           ELSE COALESCE(T1.BNF_NM, '')
         END                                                                          AS BNF_INF --受益人信息
        ,COALESCE(T1.MAIN_RISK_IND, '')                                               AS MAIN_RISK_IND --附加险标志
        ,COALESCE(T1.MGR_ID_SUP_ID, '')                                               AS MGR_ID_SUP_ID -- 管护客户经理上级工号
        ,COALESCE(T1.MGR_ID_SUP_NM, '')                                               AS MGR_ID_SUP_NM -- 管护客户经理上级名称
        ,COALESCE(T12.ACS_ORG_ID_FH, '')                                              AS SAL_ORG_ID_FH -- 销售机构所属分行
        ,COALESCE(T1.ACS_ORG_ID_FH, '')                                               AS ACS_ORG_ID_FH -- 考核机构所属分行
        ,COALESCE(T2.DBL_RCD_RCG_NO, '')                                              AS DOU_REC_IDEN_CODE -- 双录识别码
        ,COALESCE(T1.STL_STS_CD, '')                                                  AS STL_STS_CD --保司结算状态
        ,COALESCE(T1.DTRB_STS_CD, '')                                                 AS DTRB_STS_CD --绩效发放状态
        ,COALESCE(T1.ABL_STL_DT, '')                                                  AS DTRB_STL_DT --绩效发放月份
        ,CASE
           WHEN T19.QUALF_LVL = '0' THEN 0
           WHEN T19.QUALF_LVL = '1' THEN 0.3
           ELSE 0
         END                                                                          AS LOAN_QUA_RWD_RAT -- 信贷资质折后计奖比例
        ,CASE
           WHEN T19.QUALF_LVL = '0' THEN 0
           WHEN T19.QUALF_LVL = '1' THEN 1
           ELSE 0
         END                                                                          AS LOAN_QUA_MID_RAT -- 信贷资质折后中收比例
        ,CASE
           WHEN T19.QUALF_LVL = '0' THEN '禁止类'
           WHEN T19.QUALF_LVL = '1' THEN '其他类'
           ELSE ''
         END                                                                          AS LOAN_QUA_GRD -- 信贷资质等级
        ,CASE
           WHEN T1.TXN_CHN_NM = '手机银行' THEN (
                                            CASE
                                              WHEN T22.SUM_ORG_NM LIKE '%宁波%'                                                                                                                                                                      THEN '宁波'
                                              WHEN T22.SUM_ORG_NM LIKE '%上海%'                                                                                                                                                                      THEN '上海'
                                              WHEN T22.SUM_ORG_NM LIKE '%苏州%'                                                                                                                                                                      THEN '苏州'
                                              WHEN T22.SUM_ORG_NM IN ( '台州分行' , '杭州分行' , '温州分行' , '丽水分行' , '绍兴分行' , '金华分行' , '嘉兴分行' , '湖州分行' , '衢州分行' , '舟山分行' , '浙江庆元泰隆村镇银行' , '国际合作与创新部' , '消费金融部' , '浙江泰隆商业银行总行' , '总行营业部' , '浙江泰隆商业银行总行清算中心' ) THEN '浙江省（除宁波）'
                                              ELSE ''
                                            END
        )
           WHEN T1.TXN_CHN_NM = '柜面'   THEN (
                                          CASE
                                            WHEN T23.SUM_ORG_NM LIKE '%宁波%'                                                                                                                                                                      THEN '宁波'
                                            WHEN T23.SUM_ORG_NM LIKE '%上海%'                                                                                                                                                                      THEN '上海'
                                            WHEN T23.SUM_ORG_NM LIKE '%苏州%'                                                                                                                                                                      THEN '苏州'
                                            WHEN T23.SUM_ORG_NM IN ( '台州分行' , '杭州分行' , '温州分行' , '丽水分行' , '绍兴分行' , '金华分行' , '嘉兴分行' , '湖州分行' , '衢州分行' , '舟山分行' , '浙江庆元泰隆村镇银行' , '国际合作与创新部' , '消费金融部' , '浙江泰隆商业银行总行' , '总行营业部' , '浙江泰隆商业银行总行清算中心' ) THEN '浙江省（除宁波）'
                                            ELSE ''
                                          END
        )
           ELSE ''
         END                                                                          AS CMSN_FEE_SETL_ORG --手续费结算机构
    ,case when nvl(t25.sam_rsk_ctrl_id,'')='' then t1.cst_id else t25.sam_rsk_ctrl_id end sam_rsk_ctrl_id
FROM    adm_pub.ADM_PUB_INSU_CST_PD_LIST T1 --保险代销客户产品清单-全量
INNER JOIN    edw.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD T2 --业务流水表 --流水号关联
ON      T2.DT = '20240523'
AND     T1.TRX_SEQ = T2.BSN_SERNO
AND     T2.BSN_TYP_NM = '订单'
INNER JOIN    edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T3 -- 保单信息表  pk   insure_no   serial_no  FINC_TBSHAREINSURE
ON      T1.INSU_ID = T3.INSU_POLY_NO
AND     T3.DT = '20240523'
AND     COALESCE(T3.INSU_POLY_STS_CD) <> '' --保单状态非空
AND     COALESCE(T3.ORI_INSU_POLY_STS_CD, '') <> '' --保单状态非空
LEFT JOIN    edw.DIM_BUS_INSU_CMP_INF_DD T4 -- 保险公司信息表 TA_CODE  FINC_TBINSURERINFO
ON      T3.INSU_CMP_CD = T4.INSU_CMP_CD
AND     T4.DT = '20240523'
LEFT JOIN    edw.DWD_BUS_INSU_HDL_CHRG_RAT_SET_TBL_DD T5
ON      T5.DT = '20240523'
AND     T5.BSN_SERNO = T2.BSN_SERNO
AND     T5.CLC_CPL_STS_CD = '1'
--保司类别
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T6
ON      T6.CD_VAL = T4.COMPANY_CTG_CD
AND     T6.FLD_NM = 'COMPANY_CTG_CD'
AND     T6.TBL_NM = 'DIM_BUS_INSU_CMP_INF_DD'
AND     T6.DT = '20240523'
--绩效手续费计算类型
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T8
ON      T8.CD_VAL = COALESCE(T1.PRFM_CMSN_FEE_CLC_MOD, '')
AND     T8.FLD_NM = 'PRFM_CMSN_FEE_CLC_MOD'
AND     T8.TBL_NM = 'DWD_BUS_INSU_BRED_CMSN_FEE_STL_REG_RCD_DD'
AND     T8.DT = '20240523'
--凭证种类
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T9
ON      T9.CD_VAL = COALESCE(T2.VCH_CTG_CD, '')
AND     T9.FLD_NM = 'VCH_CTG_CD'
AND     T9.TBL_NM = 'DWD_BUS_INSU_BUS_TRX_SRL_INF_DD'
AND     T9.DT = '20240523'
--交易状态
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T10
ON      T10.CD_VAL = COALESCE(T2.TRX_STS_CD, '')
AND     T10.FLD_NM = 'TRX_STS_CD'
AND     T10.TBL_NM = 'DWD_BUS_INSU_BUS_TRX_SRL_INF_DD'
AND     T10.DT = '20240523'
LEFT JOIN    adm_pub.ADM_PUB_INSU_CST_PD_LIST_MNG T12
ON      T1.TRX_SEQ = T12.TRX_SEQ
AND     T12.MNG_TYP = '2' --销售
AND     T12.DT = '20240523'
LEFT JOIN    edw.DWS_HR_EMPE_INF_DD T13 --员工
ON      T12.MNG_ID = T13.EMPE_ID
AND     T13.DT = '20240523'
LEFT JOIN    (
                 SELECT  T1.CST_MAGR_ID AS CLIENT_MANAGER --客户经理
                         ,T1.CERT_ACQ_NO --销售人员执业登记编号
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.CST_MAGR_ID ORDER BY T1.CERT_ACQ_DT DESC ) RN
                 FROM    edw.DIM_HR_EMPE_FIN_MNG_INTLG_CTF_INF_DD T1 --  FINC_TBCLIENTMANQUALITY 客户经理理财资质证书信息
                 WHERE   T1.DT = '20240523'
                 AND     T1.BSN_TYP = '4'
             --保险销售从业人员执业证书
             ) T14
ON      T12.MNG_ID = T14.CLIENT_MANAGER
AND     T14.RN = 1
--销售人员职位
LEFT JOIN    (
                 SELECT  POS_ID
                         ,POS_NM
                         ,ROW_NUMBER() OVER ( PARTITION BY POS_ID ORDER BY POS_NM DESC ) RN
                 FROM    edw.DIM_HR_ORG_JOB_HIS_INF_DD
                 WHERE   DT = '20240523'
             ) T15
ON      T12.POS_ID = T15.POS_ID
--销售机构名称
LEFT JOIN    edw.DIM_HR_ORG_BAS_INF_DD T16
ON      T16.DT = '20240523'
AND     T12.MNG_ORG_ID = T16.ORG_ID
LEFT JOIN    edw.DIM_HR_ORG_SUM_ORG_REL_DD T17 --机构表
ON      T17.ORG_RLTN_DIM_CD = 'WD3'
AND     T17.SUM_ORG_LVL = 'F' --  分行
AND     T17.DT = '20240523'
AND     COALESCE(T1.ORG_ID, '') = T17.UNT_ORG_ID
LEFT JOIN    edw.DIM_BUS_CHNL_CNT_TLR_INF_DD T18 --柜员表
ON      T18.DT = '20240523'
AND     T18.TLR_ID = T2.OPRR_ID
LEFT JOIN    adm_pub.ADM_PUB_INSU_QUALF_LAB_DD T19 -- 保险信贷资质等级
ON      T19.INSU_POLY_NO = T1.INSU_ID
AND     T19.DT = '20240523'
LEFT JOIN    edw.DWD_BUS_INSU_BRED_SRL_INF_TBL_DD T20 --险种流水信息表
ON      T1.TRX_SEQ = T20.BSN_SERNO
AND     T1.INSU_BRED_CD = T20.INSU_VRTY_CD
AND     T20.DT = '20240523'
LEFT JOIN    edw.DWS_HR_EMPE_INF_DD T21 --员工
ON      T2.CST_MAGR_ID = T21.EMPE_ID
AND     T21.DT = '20240523'
LEFT JOIN    edw.DIM_HR_ORG_SUM_ORG_REL_DD T22 --机构表
ON      T22.ORG_RLTN_DIM_CD = 'WD3'
AND     T22.SUM_ORG_LVL = 'F' --  分行
AND     T22.DT = '20240523'
AND     COALESCE(T21.ORG_ID, '') = T22.UNT_ORG_ID
LEFT JOIN    edw.DIM_HR_ORG_SUM_ORG_REL_DD T23 --机构表
ON      T23.ORG_RLTN_DIM_CD = 'WD3'
AND     T23.SUM_ORG_LVL = 'F' --  分行
AND     T23.DT = '20240523'
AND     COALESCE(T18.BUS_ORG_ID, '') = T23.UNT_ORG_ID --选择柜员的营业机构编号还是账务机构编号需要确认
LEFT JOIN    edw.DWD_BUS_INSU_BRED_CMSN_FEE_STL_REG_RCD_DD T24 --险种手续费结算登记记录
ON      T1.TRX_SEQ = T24.BSN_SERNO
AND     T1.INSU_BRED_CD = T24.INSU_VRTY_CD
AND     T1.ADD_FEE_IND = T24.ADD_FEE_IND
AND     T24.CLC_CPL_STS_CD = '1' --计算完成状态代码,1(已完成)
AND     T24.TRX_TYP_CD <> '3' --续期
AND     T24.DT = '20240523'
left join edw.dws_cst_bas_inf_dd 	    t25 --客户基础信息汇总表
on      t1.cst_id=t25.cst_id
and     t25.dt='20240523'
WHERE   T1.DT = '20240523'
AND     T1.MNG_TYP = '1' --考核 -- 新保承保，非实时出单，保险补录
AND     T1.ISU_MOD_CD IN ( '0' , '1','2' )
and TO_CHAR(TO_DATE(COALESCE(T3.INSU_DT, '18991231'), 'yyyyMMdd'), 'yyyyMMdd') between '20220101' and '20240523'
and T1.PD_NM REGEXP '两全|终身寿险'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_02 AS
SElECT *,row_number() over(partition by cst_id,substr(rel_typ_cd,1,2),rel_cst_id order by rel_typ_cd desc) rn
from(
    SElECT cst_id,rel_typ_cd,rel_cst_id
    from edw.dim_cst_rel_inf_dd         --客户关联关系信息
    where DT = '20240530'
    union
    SElECT rel_cst_id,rel_typ_cd,cst_id
    from edw.dim_cst_rel_inf_dd         --客户关联关系信息
    where DT = '20240530'
    --因dwd_cst_rel_inf_dd和dim_cst_rel_inf_dd两张表数据有交叉又有遗漏，都取了
    union
    SElECT cst_id,REL_REL_CD,rel_cst_id
    from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20240530'
    union
    SElECT rel_cst_id,REL_REL_CD,cst_id
    from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20240530'
)t1
;
-- 统一风险控制客户号
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_03 AS
SElECT t1.cst_id,t1.sam_rsk_ctrl_id,t1.TRX_DT
    ,max(nvl(t4.ind_rsk_grd,0))        ind_rsk_grd_max
    ,sum(nvl(t5.dep_bal_mon_avg,0))    dep_bal_mon_avg     --存款余额月日均
    ,sum(nvl(t6.fnc_mon_avg_amt,0))    fnc_mon_avg_amt     --理财金额月日均
    ,sum(nvl(t7.loan_bal_acs,0))       loan_bal_acs        --贷款余额
    ,sum(case when t1.cst_id=t2.cst_id    then nvl(t7.loan_bal_acs,0) else 0 end) br_loan_bal_acs
    ,sum(case when t8.cst_id is not null  then nvl(t7.loan_bal_acs,0) else 0 end) po_loan_bal_acs
    ,sum(case when t9.cst_id is not null  then nvl(t7.loan_bal_acs,0) else 0 end) fr_loan_bal_acs
from(
    SElECT distinct t1.cst_id,t1.sam_rsk_ctrl_id,TRX_DT
    from SJXQ_SJ2024052431_CST2_01              t1
    where nvl(t1.sam_rsk_ctrl_id,'')<>''
)t1 left join edw.dws_cst_bas_inf_dd 	        t2 --客户基础信息汇总表
on      t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and     t2.dt='20240523'
left join edw.dim_cst_entp_bas_inf_dd           t3
on  t2.cst_id=t3.cst_id
and t3.dt='20240523'
left join edw.dwd_code_library_dd               c1
on  t3.idt_ctg_cd = c1.cd_val
and c1.dt='20240523'
left join SJXQ_SJ2024052431_CST_02              t4
on t3.idt_ctg_cd=t4.col_2
left join adm_pub.adm_csm_cbus_dep_inf_dd 		t5 --存款业务信息表
on  t2.cst_id=t5.cst_id
and t1.TRX_DT=t5.dt
and t5.dt<='20240523' and t5.dt>='20220101'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd t6 --客户金融资产信息表
on  t2.cst_id=t6.cst_id
and t1.TRX_DT=t6.dt
and t6.dt<='20240523' and t6.dt>='20220101'
left join adm_pub.adm_csm_cbus_loan_inf_dd 		t7 --贷款业务信息
on  t2.cst_id=t7.cst_id
and t1.TRX_DT=TO_CHAR(DATEADD(TO_DATE(t7.dt,'yyyymmdd'),-15,'dd'),'yyyymmdd')
and t7.dt<='20240531' and t7.dt>='20220101'
left join SJXQ_SJ2024052431_CST2_02             t8  --客户关联关系信息
on t1.cst_id=t8.cst_id
and t2.cst_id=t8.rel_cst_id
and t8.rel_typ_cd='0301'    --配偶
left join SJXQ_SJ2024052431_CST2_02             t9  --客户关联关系信息
on t1.cst_id=t9.cst_id
and t2.cst_id=t9.rel_cst_id
and substr(t9.rel_typ_cd,1,2)='01'
and t9.rn=1     --先取 实际控制人 其次按法人
group by t1.cst_id,t1.sam_rsk_ctrl_id,t1.TRX_DT
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_04 AS
SElECT case when t1.PROD_NM REGEXP '终身寿险' then '终身寿险' else '两全' end insu_type
    ,t1.TRX_DT                  --交易日期
    ,t1.CST_ID                  --客户号
    ,t1.CST_ACT_NBR             --客户账号
    ,t1.INSU_HLD_NM             --投保人姓名
    ,t1.INSU_HLD_GDR            --投保人性别
    ,t1.INSU_HLD_BTH_DT         --投保人出生日期
    ,t1.CMP_CD                  --公司代码
    ,t1.CMP_NM                  --公司名称
    ,t1.PROD_CD                 --产品代码
    ,t1.PROD_NM                 --产品名称
    ,t1.PROD_INSU_BRED          --产品险种
    ,t1.INSU_PLCY_ID            --保单号
    ,t1.INSU_PLCY_STS           --保单状态
    ,t1.CUR_INSU_PLCY_STS_NM    --新保单状态
    ,t1.MNG_CNV_INSU_FEE        --管护折算保费
    ,t1.INSU_AMT                --保额
    ,t1.PAY_YEAR                --缴费年限
    ,t1.MNG_CNV_CMSN_FEE        --管护折算绩效手续费
    ,t1.SAL_PPL_ID              --销售人员工号
    ,t1.SAL_PPL_NM              --销售人员姓名
    ,t1.TRX_ORG_ID              --交易机构号
    ,t1.TRX_CD                  --交易代码
    ,t1.TRX_TM                  --交易时间
    ,t1.LOAN_QUA_GRD            --信贷资质等级
    ,t2.empe_age    SAL_PPL_age	--交易时销售人年龄
    ,T3.tem_org_id,t3.tem_org_nm--交易时销售人所属机构
    ,t3.sbr_org_nm,t3.brc_org_nm
    ,t4.org_chrg_id tem_chrg_id --交易时团队负责人
    ,t4.org_chrg_nm tem_chrg_nm
    ,t5.empe_age    tem_chrg_age--交易时团队负责人年龄
    ,t6.idt_ctg_nm ,t6.ind_rsk_grd_max
    ,decode(t6.ind_rsk_grd_max,1,'一类风险',2,'二类风险',3,'三类风险',4,'四类风险') ind_rsk_grd_max_nm
    ,t6.dep_bal_mon_avg ,t6.fnc_mon_avg_amt
    ,t6.loan_bal_acs ,t6.br_loan_bal_acs ,t6.po_loan_bal_acs ,t6.fr_loan_bal_acs
    ,decode(t7.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') cst_seg_nm
    ,t8.age,decode(t8.gdr_cd,'1','男','2','女','未知') gdr_nm
from SJXQ_SJ2024052431_CST2_01              t1
LEFT JOIN edw.DWS_HR_EMPE_INF_DD            T2 --员工
ON      T1.SAL_PPL_ID = T2.EMPE_ID
and     t1.TRX_DT=t2.dt     --交易时
AND     T2.DT <= '20240523' and t2.dt>='20220101'
left join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t2.org_id=t3.org_id
and t3.dt='20240523'
LEFT JOIN edw.dim_hr_org_bas_inf_dd         T4 --机构基本信息 --团队
ON  T3.tem_org_id = T4.org_id
and t1.TRX_DT=t4.dt     --交易时
AND T4.DT <= '20240331' and t4.dt>='20220101'
LEFT JOIN edw.DWS_HR_EMPE_INF_DD            T5 --员工
ON      t4.org_chrg_id = T5.EMPE_ID
and     t1.TRX_DT=t5.dt     --交易时
AND     T5.DT <= '20240523' and t5.dt>='20220101'
left join SJXQ_SJ2024052431_CST2_03         t6
on t1.cst_id=t6.cst_id
and t1.trx_dt=t6.trx_dt
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t7 --客户标签信息
on t1.cst_id=t7.cst_id
and t7.dt='20240523'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t8 --对私客户基础信息
on t1.cst_id=t8.cst_id
and t8.dt='20240523'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_05 AS
SElECT insu_type                保险类型
    ,CST_ID                     客户号
    ,INSU_HLD_NM                投保人姓名
    ,PROD_NM                    产品名称
    ,CMP_NM                     公司名称
    ,INSU_PLCY_ID               保单号
    ,TRX_DT                     交易日期
    ,MNG_CNV_INSU_FEE           管护折算保费
    ,PAY_YEAR                   缴费年限
    ,INSU_AMT                   保障金额
    ,MNG_CNV_CMSN_FEE           管护折算绩效手续费
    ,INSU_PLCY_STS              保单状态
    ,CUR_INSU_PLCY_STS_NM       新保单状态
    ,SAL_PPL_NM                 销售人员姓名
    ,SAL_PPL_age	            销售人订单时年龄员工年龄
    ,tem_org_nm                 销售人订单时点_所属团队名称
    ,sbr_org_nm                 销售人订单时点_所属支行名称
    ,brc_org_nm                 销售人订单时点_所属分行名称
    ,tem_chrg_nm                销售人订单时点_团队负责人名称
    ,tem_chrg_age               销售人订单时点_团队负责人年龄
    ,cst_seg_nm                 投保人所属客群
    ,age                        年龄
    ,gdr_nm                     性别
    ,LOAN_QUA_GRD               信贷资质等级
    ,idt_ctg_nm                 同一风险控制号下三级行业
    ,ind_rsk_grd_max_nm         同一风险控制号下行业最高风险等级
    ,dep_bal_mon_avg            同一风险控制号下投保日月日均存款累计
    ,fnc_mon_avg_amt            同一风险控制号下投保日月日均理财累计
    ,loan_bal_acs               同一风险控制号下贷款余额累计_投保后第15天
    ,po_loan_bal_acs            配偶_贷款余额_投保后第15天
    ,fr_loan_bal_acs            公司_贷款余额_投保后第15天
    ,br_loan_bal_acs            本人_贷款余额_投保后第15天
from SJXQ_SJ2024052431_CST2_04
;
SElECT '01' seq, count(1) cnt,count(distinct INSU_PLCY_ID) custs
from SJXQ_SJ2024052431_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,rel_typ_cd,rel_cst_id) custs
from SJXQ_SJ2024052431_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,TRX_DT) custs
from SJXQ_SJ2024052431_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct INSU_PLCY_ID) custs
from SJXQ_SJ2024052431_CST2_04
;
/*
01	40158	40067
02	4936328	4936328
03	38374	38374
04	40158	40067
0. 保单状态：保单状态  or 新保单状态？都给
1. 期限 ：缴费年限？ 是
2. 中收：手续费or管护折算绩效手续费？ 后者
3. 投保人所属客群：八大客群？是
4. 是否高风险客户（禁止类、黑名单）？换 信贷资质等级
5. 三级行业（是同一风险控制号企业主/经营户列出行业）？统一风险控制号下的 公司（包含个体工商户）所属行业的集合
6. 行业最高风险等级
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_04_1 AS
SELECT t1.*,t4.org_chrg_id,t4.org_chrg_nm
from(
    SELECT DISTINCT tem_org_id,tem_org_nm--交易时销售人所属机构
    from SJXQ_SJ2024052431_CST2_04
    where nvl(tem_chrg_nm,'')=''
)t1 LEFT JOIN edw.dim_hr_org_bas_inf_dd         T4 --机构基本信息 --团队
ON  T1.tem_org_id = T4.org_id
and t4.dt='20240523'
;
*/***SJ2024052431_行业信息大地-3专项取数.sql
-- 有征信权限客户
-- 存款户-AUM大于30万
-- 贷款户-企业主、个体户 剔除高风险、黑名单 贷款余额大于10万 或 授信超100万 近1年用信金额为0
-- 义乌开发区支行、义乌支行、永康支行、金华分行营业部
-- 有征信权限客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST3_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST3_01 AS
-- 有效信用卡 卡片状态为空并且账户状态为空
SELECT  a.cst_id
FROM    edw.DIM_BUS_CRD_CR_CRD_INF_DD           A --信用卡卡片信息
inner JOIN   edw.DWS_BUS_CRD_CR_CRD_ACT_INF_DD  B --信用卡账户信息汇总
ON      A.CR_CRD_CARD_NBR = B.LATE_MAIN_CARD_CARD_NBR
AND     B.DT = '@@{yyyyMMdd}'
WHERE   A.DT = '@@{yyyyMMdd}'
AND     a.CARD_STS_CD = ''
AND     b.ACT_STS_CD = ''
union
-- 未到期未终结的贷款授信
SELECT  t.cst_id
        -- ,sum(t.ctr_amt) AS sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd t
WHERE   t.dt = '@@{yyyyMMdd}'
AND     ( ( ( t.ctr_bal > 0
    OR ( t.ctr_bal IS NULL
AND     nvl(t.crc_ind, '0') = '0' )
    OR ( ( nvl(t.crc_ind, '0') <> '0'
    OR t.pd_cd LIKE '2010503%' )
AND     ( t.ctr_bal = 0
    OR t.ctr_bal IS NULL )
AND     t.apnt_mtu_dt >= '@@{yyyyMMdd}' ) )
AND     nvl(t.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
    OR ( t.ctr_bal > 0
AND     t.pd_cd LIKE '2010503%'
AND     t.apnt_mtu_dt <= '@@{yyyyMMdd}'
AND     t.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
;
-- 近1年用信金额为0
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST3_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST3_02 AS
SELECT t1.cst_id
from(
    SELECT distinct cst_id
    from adm_pub.adm_csm_clab_ln_inf_dd             --客户集市-标签层-信贷客户标签信息表
    WHERE dt between '@@{yyyyMMdd-1y}' and '@@{yyyyMMdd}'
)t1 left join(
    SELECT distinct cst_id
    from adm_pub.adm_csm_clab_ln_inf_dd             --客户集市-标签层-信贷客户标签信息表
    WHERE dt between '@@{yyyyMMdd-1y}' and '@@{yyyyMMdd}'
    and crd_bal<>0
)t2 on t1.cst_id=t2.cst_id
where t2.cst_id is NULL
;
-- 保险资质标签 保险禁止客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST3_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST3_03 AS
SELECT  T3.CST_ID
FROM    (
            SELECT  T1.CST_ID
                    ,T1.IDV_CRD_SCO_VAL
                    ,ROW_NUMBER() OVER ( PARTITION BY T1.CST_ID ORDER BY REPORT_NO DESC) AS RN
            FROM    edw.DWS_CST_CCRC_IDV_IND_INF_DD T1      --个人征信分
            WHERE   SUBSTR(T1.REPORT_NO, 1, 8) > '20240325' --新征信报告
            AND     T1.DT >= '20240326'
        ) T3
WHERE   T3.RN = 1
AND     T3.IDV_CRD_SCO_VAL <= 500
AND     T3.IDV_CRD_SCO_VAL > 0
-- 征信分
UNION
-- 黑名单
SELECT  T1.CUSTOMERID
FROM    edw.DWD_BUS_LOAN_CUSTOMER_SPECIAL_DD T1 -- 我行预保预报名单库明细表
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.SECTIONTYPE = '40'
AND     T1.ATTRIBUTE2 IN ( '50' , '60' ) -- 50禁止类60提示类
AND     T1.INLISTSTATUS = '2' -- 有效
AND     T1.CUSTOMERID <> ''
;
-- 主管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST3_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST3_04 AS
SELECT t1.cst_id
    ,t2.cst_chn_nm	                --客户中文名称
    ,t2.age
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t5.aum_bal	                    --客户综合金融资产(aum)
    ,t6.crd_tot_amt	                --授信总额
    ,t6.crd_bal	                    --授信余额
    ,decode(t7.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') cst_seg_flg_nm
    ,case when t8.cst_id is not null then 1 else 0 end is_lst1y_0loan
    ,case when t9.cst_id is not null then 1 else 0 end is_blst_cst --剔除禁止类、黑名单客户 即符合 保险资质标签
from SJXQ_SJ2024052431_CST3_01                      t1 --存款账户信息汇总
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	    t2 --对私客户基础信息
on  t1.cst_id = t2.cst_id
and t2.dt = '@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.sbr_org_nm regexp '义乌开发区|义乌支行|永康支行|金华分行营业部'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd	t5 --客户集市-业务信息-客户金融资产信息表
on  t1.cst_id = t5.cst_id
and t5.dt = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_clab_ln_inf_dd            t6 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_clab_cst_jc_inf_dd        t7 --客户标签信息
on t1.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024052431_CST3_02                 t8
on  t1.cst_id=t8.cst_id
left join SJXQ_SJ2024052431_CST3_03                 t9
on  t1.cst_id=t9.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST3_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST3_05 AS
SELECT cst_id           客户号
    ,cst_chn_nm	        客户名称
    ,age                客户年龄
    ,PRM_MGR_ID         主管户人工号
    ,PRM_MGR_NM         主管户人名字
    ,BRC_ORG_NM         主管户分行
    ,SBR_ORG_NM         主管户支行
    ,TEM_ORG_NM         主管户团队
    ,aum_bal	        AUM余额
    ,crd_tot_amt	    授信总额
    ,crd_bal	        授信余额
    ,cst_seg_flg_nm     九大客群
    ,decode(is_lst1y_0loan,0,'否',1,'是')       是否近1年用信金额为0
    ,decode(is_blst_cst,0,'非禁止类',1,'禁止类') 保险资质标签
    ,case when aum_bal>300000 then '存款户' else '贷款户' end 客户类别
from SJXQ_SJ2024052431_CST3_04
    crd_bal > 100000 or (crd_tot_amt>1000000 and is_lst1y_0loan=1)
))
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052431_CST3_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052431_CST3_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052431_CST3_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024052431_CST3_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024052431_CST3_05
;
/*
01	950110	950110
02	16599290	16599290
03	669438	669438
04	17136	17136
05	5777	5777
专项取数问题：
1. 有征信权限：有征信报告数据？不对，可查询客户
2. 所在机构？开户 账户管户 主管户？主管户
3. 贷款户 (企业主、个体户) 既是 贷款客户 又在 九大客群的企业主、个体户中？是的
4. 剔除高风险禁止类、黑名单，信贷风险等级为 5、6的客户？ 改成 保险资质标签
5. 存款户、贷款户要 有效 还是历史办过存款、贷款就算？ 后面已解释，无需筛选
*/
***SJ2024052436_对客回访.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024052436_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052436_CST_01 AS
SElECT t1.seq,t1.cst_id
    ,replace(t1.order_id,'-','') trx_dt
    ,t2.cst_chn_nm
    ,t2.sam_rsk_ctrl_id             --同一风险控制号
FROM qbi_file_20240603_14_26_45     t1
left join edw.dws_cst_bas_inf_dd    t2
on t1.cst_ID=t2.cst_id
and t2.dt='20240531'
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_02 AS
select distinct a.cst_ID,a.trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,a.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ2024052436_CST_01   a
left join edw.dws_cst_bas_inf_dd                c
on  a.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='20240531'
and NVL(c.sam_rsk_ctrl_id,'')<>''
where LENGTH(a.cst_id)=10
;
-- 前后5天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_03 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,rel_cust_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                         --贷款用途代码
    ,B.USG_CMT                             --用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt --贷款利率优惠备注
    ,case
        when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from lab_bigdata_dev.SJXQ_SJ2024052436_CST_02   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.CRC_IND <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '20240531'
LEFT JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '20240531'
left outer join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '20240531'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='20240531'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '20240531'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '20240531'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_04 AS
select cst_ID,trx_dt
    ,a.rel_cst_id
    ,rel_cust_nm
    ,BUSI_CTR_ID                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,stdinr                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,INTR_RAT                            --执行利率
    ,REF_MON_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,a.REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,pre_ases_res
    ,HPN_TYP
    ,USG_CMT
    ,intr_rat_adj_cmt
    ,is_wfdk
    ,is_zc_loan
    ,lst_BUSI_CTR_ID
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.BUSI_CTR_ID            	lst_BUSI_CTR_ID
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.INTR_RAT                 lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ2024052436_CST_03
        where DIFF_TM<=5
    ) a
    left join lab_bigdata_dev.SJXQ_SJ2024052436_CST_03 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.pd_cd=b.pd_cd and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
-- 输出结果
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024052436_CST_05 AS
SElECT t1.seq           序号
    ,t1.cst_id          客户号
    ,t1.trx_dt          下单时间
    ,case when t2.cst_id is not null then '是' else '否' end 购买日前后5天内同一风险控制号是否有贷款申请且有合同号
    ,t2.REG_DT          申请日期
    ,t2.BUSI_CTR_ID     合同号
from lab_bigdata_dev.SJXQ_SJ2024052436_CST_01       t1
left join lab_bigdata_dev.SJXQ_SJ2024052436_CST_04  t2
on  t1.cst_ID=t2.cst_ID
and t1.trx_dt=t2.trx_dt
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024052436_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024052436_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024052436_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024052436_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024052436_CST_05
;
/*
01	3603	3442
02	11627	3431
03	24546	3431
04	774	774
05	3603	3603
*/***SJ20240603161_眉县村行逾期清收.sql
--2023-2024 逾期借据
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST_01 AS
select t1.dbil_id	            --借据编号|C50
    ,t1.bus_ctr_id	            --信贷合同编号|C32
    ,t1.cst_id	                --客户编号|C20
    ,t1.cst_nm	                --客户名称|C200
    ,t1.acs_org_id	            --考核机构编号|C12
    ,t1.acs_org_nm	            --考核机构名称|C200
    ,t1.dtrb_dt	                --发放日期|C8
    ,t1.amt	                    --发放金额|DECIMAL(20,2)
    ,t1.prcp_bal	            --本金余额|DECIMAL(20,2)
    ,t1.norm_bal	            --正常余额|DECIMAL(20,2)
    ,t1.ovd_amt	                --逾期金额|DECIMAL(20,2)
    ,t1.idle_bal,t1.bad_bal
    ,t1.dt
    ,CASE WHEN NVL(T3.businessflag,'') = 'J' THEN '是' ELSE '否' END is_chzu
    ,row_number() over(partition by t1.bus_ctr_id,t1.cst_id,t1.cst_nm,t1.acs_org_id,t1.acs_org_nm
        ,t1.dtrb_dt,t1.amt,t1.prcp_bal,t1.norm_bal,t1.ovd_amt,t1.idle_bal,t1.bad_bal
        order by t1.dt) rn
from edw.dws_bus_loan_dbil_inf_dd           t1 --贷款借据信息汇总
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.acs_org_id=t2.org_id
and t2.dt='@@{yyyyMMdd}'
and t2.brc_org_nm='陕西眉县泰隆村镇银行'
left join edw.loan_business_contract        t3 --业务合同表
on  t1.bus_ctr_id=t3.serialno
and t1.dt=t3.dt
and t3.dt<='@@{yyyyMMdd}'
where t1.dt<='@@{yyyyMMdd}'
and t1.dt>='20230101'
and t1.ovd_amt <> 0   --发生过逾期
;
-- 是否风险贷款客户
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST_02 AS
select distinct t1.cst_id,t1.dt
from adm_pub.adm_rsk_app_inter_all  T1
inner join (
    SElECT distinct cst_id
    from SJXQ_SJ20240603161_CST_01
)t2 on t1.cst_id=t2.cst_id
where t1.dt>='20230101'
and t1.is_rsk_loan='Y'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST_03 AS
select t1.dt                    发生日期
    ,t1.cst_id	                客户编号
    ,t1.cst_nm	                客户名称
    ,t1.dbil_id	                借据编号
    ,t1.acs_org_nm	            考核机构名称
    ,t1.amt	                    发放金额
    ,t1.prcp_bal	            本金余额
    ,t1.norm_bal	            正常余额
    ,t1.ovd_amt	                逾期金额
    ,t1.is_chzu                 是否重组
    ,if(t2.cst_id is not null,'是','') 是否风险贷款
from SJXQ_SJ20240603161_CST_01      t1
left join SJXQ_SJ20240603161_CST_02 t2
on  t1.cst_id=t2.cst_id
and t1.dt=t2.dt
where t1.rn=1   --去除重复记录
;
SElECT '01' seq, count(1) cnt,count(distinct dbil_id) custs
from SJXQ_SJ20240603161_CST_01 where rn=1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,dt) custs
from SJXQ_SJ20240603161_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 借据编号,日期) custs
from SJXQ_SJ20240603161_CST_03
;
/*
01	577	459
02	13811	13811
03	577	577
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST_01_1 AS
select distinct t1.dbil_id	            --借据编号|C50
from edw.dws_bus_loan_dbil_inf_dd           t1 --贷款借据信息汇总
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.acs_org_id=t2.org_id
and t2.dt='@@{yyyyMMdd}'
and t2.brc_org_nm='陕西眉县泰隆村镇银行'
where t1.dt<='@@{yyyyMMdd}'
and t1.dt>='20230101'
and t1.ovd_amt<>0   --发生过逾期
;
*/
***SJ20240603161_眉县村行逾期清收2.sql
--2023-2024 逾期借据
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST3_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST3_01 AS
select distinct t1.bus_ctr_id,t1.dbil_id	   --借据编号|C50
from edw.dws_bus_loan_dbil_inf_dd           t1 --贷款借据信息汇总
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.acs_org_id=t2.org_id
and t2.dt='@@{yyyyMMdd}'
and t2.brc_org_nm='陕西眉县泰隆村镇银行'
where t1.dt<='@@{yyyyMMdd}'
and t1.dt>='20230101'
and t1.ovd_amt <> 0   --发生过逾期
;
-- 逾期借据还款记录
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST3_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST3_02 AS
select t1.dbil_id	            --借据编号|C50
    ,t1.bus_ctr_id	            --信贷合同编号|C32
    ,t1.cst_id	                --客户编号|C20
    ,t1.cst_nm	                --客户名称|C200
    ,t1.acs_org_id	            --考核机构编号|C12
    ,t1.acs_org_nm	            --考核机构名称|C200
    ,t1.dtrb_dt	                --发放日期|C8
    ,t1.amt	                    --发放金额|DECIMAL(20,2)
    ,t1.prcp_bal	            --本金余额|DECIMAL(20,2)
    ,t1.norm_bal	            --正常余额|DECIMAL(20,2)
    ,t1.ovd_amt	                --逾期金额|DECIMAL(20,2)
    ,t1.idle_bal,t1.bad_bal
    ,t1.dt
    ,CASE WHEN NVL(T3.businessflag,'') = 'J' THEN '是' ELSE '否' END is_chzu
from edw.dws_bus_loan_dbil_inf_dd           t1 --贷款借据信息汇总
inner join SJXQ_SJ20240603161_CST3_01       t2
on  t1.bus_ctr_id=t2.bus_ctr_id
and t1.dbil_id=t2.dbil_id
left join edw.loan_business_contract        t3 --业务合同表
on  t1.bus_ctr_id=t3.serialno
and t1.dt=t3.dt
and t3.dt<='@@{yyyyMMdd}'
where t1.dt<='@@{yyyyMMdd}'
and t1.dt>='20230101'
;
-- 逾期借据变动情况
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST3_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST3_03 AS
select t1.*
    ,t2.norm_bal	norm_bal2
    ,t2.ovd_amt	    ovd_amt2
    ,t2.idle_bal    idle_bal2
    ,t2.bad_bal     bad_bal2
    ,t2.dt  dt2
    ,case when t1.ovd_amt-nvl(t2.ovd_amt,0) <> 0 then 1 else 0 end is_var
from SJXQ_SJ20240603161_CST3_02         t1
left join SJXQ_SJ20240603161_CST3_02    t2  --上一条记录
on  t1.dbil_id=t2.dbil_id
and t1.dt = TO_CHAR(DATEADD(TO_DATE(t2.dt,'yyyymmdd'),1,'dd'),'yyyymmdd')
;
-- 是否风险贷款客户
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST3_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST3_04 AS
select distinct t1.cst_id,t1.dt
from adm_pub.adm_rsk_app_inter_all  T1
inner join (
    SElECT distinct cst_id
    from SJXQ_SJ20240603161_CST3_03
)t2 on t1.cst_id=t2.cst_id
where t1.dt>='20230101'
and t1.is_rsk_loan='Y'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST3_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST3_05 AS
select t1.dt                    发生日期
    ,t1.cst_id	                客户编号
    ,t1.cst_nm	                客户名称
    ,t1.dbil_id	                借据编号
    ,t1.acs_org_nm	            考核机构名称
    ,t1.amt	                    发放金额
    ,t1.prcp_bal	            本金余额
    ,t1.norm_bal	            正常余额
    ,t1.ovd_amt	                逾期金额
    ,t1.is_chzu                 是否重组
    ,if(t2.cst_id is not null,'是','') 是否风险贷款
from SJXQ_SJ20240603161_CST3_03      t1
left join SJXQ_SJ20240603161_CST3_04 t2
on  t1.cst_id=t2.cst_id
and t1.dt=t2.dt
where t1.is_var=1   --逾期金额发生变化记录
;
-- 借据还款明细
DROP   TABLE IF     EXISTS SJXQ_SJ20240603161_CST3_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603161_CST3_06 AS
SElECT t1.dbil_id     贷款借据号
    ,t3.dtl_seq_nbr   明细序号
    ,t3.cst_id        客户号
    ,t3.cst_nm        客户名称
    ,t3.trx_dt        交易日期
    ,t3.trx_dir       交易方向 --0放款 1还款
    ,t3.trx_amt       交易金额
    ,t3.bal           余额
    ,t3.loan_bal_fld  贷款余额字段
    ,t3.bal_fld_cmt   余额字段说明
	,t3.trx_evt       交易事件
	,t3.evt_cmt       事件说明
	,t3.smr           摘要
from SJXQ_SJ20240603161_CST3_01             t1
inner join edw.dwd_bus_loan_act_trx_dtl_di  t3 --贷款账户交易明细
on  t1.dbil_id=t3.loan_dbil_id
and t3.dt<='@@{yyyyMMdd}'
and t3.dt>='20230101'
;
SElECT '01' seq, count(1) cnt,count(distinct dbil_id) custs
from SJXQ_SJ20240603161_CST3_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dbil_id,dt) custs
from SJXQ_SJ20240603161_CST3_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dbil_id,dt) custs
from SJXQ_SJ20240603161_CST3_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,dt) custs
from SJXQ_SJ20240603161_CST3_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 借据编号,发生日期) custs
from SJXQ_SJ20240603161_CST3_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 贷款借据号,明细序号) custs
from SJXQ_SJ20240603161_CST3_06
;
/*
01	473	473
02	197840	197840
03	197840	197840
04	13854	13854
05	1049	1049
06	13159	13159
问题
1. 没有逾期借据还清记录
2. 记录变化与之前记录排序 存在错误？根据逾期字段错位相减
SElECT distinct  t1.*
from SJXQ_SJ20240603161_CST3_05 t1
left join SJXQ_SJ20240603161_CST_03 t2
on t1.借据编号=t2.借据编号
where t2.借据编号 is null
ORDER BY t1.借据编号,t1.发生日期
*/
***SJ20240603171_商城泰惠收对账.sql
-- 5月泰惠收商城交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ20240603171_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603171_CST_01 AS
SELECT  T2.TXN_ORDER_ID                  AS 流水号
       ,T1.stlm_date                     AS 清算日期
       ,T2.txn_dt                        AS 交易日期
       ,T2.TXN_ORDER_AMT                 AS 订单金额
       ,T1.TXN_AMT                       AS 清算金额
       ,T1.SETL_AMT                      AS 入账金额
       ,T1.SETL_FEE_AMT                  AS 手续费
       ,T2.TXN_ORDER_AMT-nvl(T2.CARD_HOLDER_ACTV_MCHT_EXP_AMT,0)-nvl(T2.CARD_HOLDER_ACTV_EXP_AMT,0)-nvl(T2.ORDER_GOODS_TAG,0)-nvl(T2.C_PORT_CON_DEDUCTIO_AMT,0) AS 客户实付金额
       ,T2.C_PORT_CON_DEDUCTIO_AMT       AS 积分抵扣金额
       ,T2.CARD_HOLDER_ACTV_EXP_AMT      AS 营销泰隆出资
       ,T2.CARD_HOLDER_ACTV_MCHT_EXP_AMT AS 营销商户出资
       ,T2.ORDER_GOODS_TAG               AS 权益卡卷抵扣
FROM edw.dpss_bth_mer_in_acc_dtl    T1 --商户入账明细表
LEFT JOIN edw.dpss_pbs_order_info   T2 --支付平台订单信息登记表
ON T1.CHL_TXN_SSN = T2.txn_seq_id
and t2.dt=t1.dt
AND T2.DT BETWEEN '20240501' and '20240531'
WHERE T1.DT BETWEEN '20240501' and '20240531'
AND T1.stlm_date BETWEEN '20240501' AND '20240531' --清算日期
AND T2.TXN_ORDER_ID IS NOT NULL
;
-- 查商城5月正向订单
DROP   TABLE IF     EXISTS SJXQ_SJ20240603171_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603171_CST_02 AS
SELECT  T1.id
       ,T1.order_id                                        AS 订单号
       ,T1.order_main                                      AS 是否为主订单
       ,T1.child_order_detail                              AS 子订单详情
       ,T1.order_sign                                      AS 订单标签
       ,T1.trade_no                                        AS 交易流水号
       ,T2.store_name                                      AS 商户名称
       ,T1.payTime                                         AS 付款时间
       ,CASE T1.mail_type WHEN 0 THEN '在线邮寄' ELSE '自提' END AS 邮寄方式
       ,T1.integral_all                                    AS 订单实付积分
       ,T1.totalPrice                                      AS 订单实付现金
       ,T1.settle_total_price                              AS 商户结算价
       ,T1.channel                                         AS 渠道
       ,T1.parent_order_id                                 AS 子订单对应的主订单id
       ,T1.total_coupon_amount                             AS 优惠总金额
       ,T1.total_coupon_integral                           AS 优惠总积分
FROM edw.tlsc_sunyardmall_orderform     T1 --订单表
INNER JOIN edw.tlsc_sunyardmall_store   T2 --店铺表
ON T1.store_id = T2.id
AND T2.DT='20240531'
WHERE T1.DT BETWEEN '20240501' and '20240531'
AND T1.payTime > '2024-05-01 00:00:00'
AND T1.payTime < '2024-06-01 00:00:00'
AND T1.tenant_code = 'tlcard'
AND T1.payment_mark = 'taihuishou'
;
-- 5月泰惠收退款脚本
DROP   TABLE IF     EXISTS SJXQ_SJ20240603171_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240603171_CST_03 AS
SELECT  T2.order_id                                        AS 订单号
       ,T2.order_sign                                      AS 订单标签
       ,T2.trade_no                                        AS 交易流水号
       ,T3.store_name                                      AS 商户名称
       ,T2.payTime                                         AS 付款时间
       ,CASE T2.mail_type WHEN 0 THEN '在线邮寄' ELSE '自提' END AS 邮寄方式
       ,T2.integral_all                                    AS 订单实付积分
       ,T2.totalPrice                                      AS 订单实付现金
       ,T2.settle_total_price                              AS 商户结算价
       ,T2.channel                                         AS 渠道
       ,T1.audit_time                                      AS 退款时间
       ,T1.integral_all                                    AS 退款积分
       ,T1.goods_all_price                                 AS 退款现金
       ,T1.refund_order_no                                 AS 退款交易流水号
FROM edw.tlsc_sunyardmall_returngoods_log   T1 --退货商品日志表, 用来记录所有退货操作
LEFT JOIN edw.tlsc_sunyardmall_orderform    T2 --订单表
ON T1.return_order_id = T2.id
and t2.dt BETWEEN '20240501' and '20240531'
AND T2.DT=t1.dt
LEFT JOIN edw.tlsc_sunyardmall_store        T3 --店铺表
ON T3.id = T2.store_id
AND T3.DT='20240531'
WHERE T1.DT BETWEEN '20240501' and '20240531'
AND T1.goods_return_status = '11'
AND T1.audit_time > '2024-05-01 00:00:00'
AND T1.audit_time < '2024-06-01 00:00:00'
AND T2.tenant_code = 'tlcard'
AND T2.payment_mark = 'taihuishou'
;
SElECT '01' seq, count(1) cnt,count(distinct 流水号) custs
from SJXQ_SJ20240603171_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 订单号) custs
from SJXQ_SJ20240603171_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 订单号) custs
from SJXQ_SJ20240603171_CST_03
;
/*
edw.dpss_bth_mer_in_acc_dtl 商户入账明细表
edw.dpss_pbs_order_info 支付平台订单信息登记表
edw.tlsc_sunyardmall_returngoods_log 退货商品日志表, 用来记录所有退货操作
edw.tlsc_sunyardmall_orderform 订单表
edw.tlsc_sunyardmall_store 店铺表
*/***SJ2024060336_金华分行5月走访记录.sql
DROP   TABLE IF EXISTS SJXQ_SJ2024060336_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024060336_CST_01 as
select  t1.bus_seq_id                                 as id
        ,t1.create_emp                                 as employ_no
        ,t1.srv_cntnt                                  as visit_content
        ,t1.comments                                   as remark
        ,t1.create_emp                                 as create_employ_id
        ,to_char(t1.create_tm,'yyyy-mm-dd hh24:mi:ss') as create_time
        ,t1.update_emp                                 as update_employ_id
        ,to_char(t1.update_tm)                         as update_time
        ,'' address
        ,t1.srv_tm                                     as visiting_time
        ,t1.bus_typ                                    as visit_type
        ,'' com_name
        ,t2.cust_name                                   as cust_name
        ,'' com_code
        ,t1.cst_id                                     as cust_no
        ,t1.source_flag                                as sourceflag
        ,t1.emp_sign_addr                              as emp_sign_addr
        ,t1.com_cust_id                                as com_cust_id
        ,t1.com_cust_name                              as com_cust_name
        ,t1.cst_dmnd                                   as cst_dmnd
        ,t1.srv_type                                   as srv_type
        ,t1.need_assign
        ,t1.assign_person
        ,t3.employ_name                                as assign_person_name
        ,t1.plan_end_tm
        ,t1.assign_reason
        ,t1.plan_tm
from edw.xwdt_xw_cst_vst_dtl_di t1
left join edw.xwdt_xw_customer  t2
on t1.cst_id = t2.cust_no
and t2.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_employ    t3
on t1.assign_person = t3.employ_no
and t3.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.srv_tm LIKE '%2024-05%'
;
DROP   TABLE IF EXISTS SJXQ_SJ2024060336_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2024060336_CST_02 as
select  t1.cust_name 客户名
       ,t1.id         as 业务流水号
       ,t1.cust_no 客户号
       ,t1.employ_no 客户经理
       ,t1.visiting_time 访问时间
       ,t1.visit_type 服务目的
       ,t1.visit_content 服务内容
       ,t1.remark 工作备注
       ,t1.create_employ_id 创建人
       ,t2.employ_name 创建人姓名
       ,t1.create_time 创建时间
       ,t1.update_employ_id 修改人
       ,t1.sourceflag as 数据来源标识
       ,t7.employ_name 修改人姓名
       ,t1.update_time 修改时间
       ,t1.address 地点
    --    ,t1.com_name
    --    ,t1.com_code   as comcode
       ,t5.org_name 团队名
       ,t5.id  as orgid
       ,t6.org_name 支行名
       ,t1.emp_sign_addr 签到地点
       ,t1.com_cust_id 共同服务人
       ,t1.com_cust_name 共同服务人名称
       ,t1.cst_dmnd   as 客户需求
       ,t1.srv_type 触客类型
       ,t3.com_son_no 子社区id
       ,t4.com_name 社区
       ,t1.need_assign 是否派遣
       ,t1.assign_person 派遣人
       ,t1.assign_person_name 派遣人姓名
       ,t1.plan_end_tm 计划结束时间
       ,t1.assign_reason 派遣理由
       ,t1.plan_tm    as 计划面试时间
from SJXQ_SJ2024060336_CST_01       t1
left join edw.xwdt_xw_employ        t2
on t2.id = t1.create_employ_id
and t2.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_cust_com      t3
on t1.cust_no = t3.cust_no
and t3.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_community     t4
on t3.com_son_no = t4.id
and t4.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_orgn          t5
on t5.id = t2.org_id
and t5.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_orgn          t6
on t6.id = t5.parent_orgn_code
and t6.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_employ        t7
on t7.id = t1.update_employ_id
and t7.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_employ        t8
on t8.employ_no = t1.create_employ_id
and t8.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd t9 --机构树_考核维度
on t8.org_id=t9.org_id
and t9.dt='@@{yyyyMMdd}'
WHERE t9.BRC_ORG_NM = '金华分行'
ORDER BY t1.create_time DESC
***SJ2024060501_厅堂营销竞赛.sql
/*
1. 时间：理财确认日期 5.1-5.31
2. 字段：产品代码 产品名称 首购日期 购买金额
日期 销售人工号 销售人姓名 销售人所在机构 机构营业经理工号 名字 笔数
3. 字段：
日期 销售人工号 销售人姓名 销售人所在机构 机构营业经理工号 名字 理财产品 销售额
问题：机构营业经理 一个机构只有一个吗？
理财产品：大类、产品名称？大类
*/
-- 机构营业经理工号 名字
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_01 AS
SELECT t1.org_id,t1.empe_id,t1.empe_nm
    ,t2.pos_id,t2.pos_nm
    ,t3.sbr_org_id,T3.BRC_ORG_NM,T3.SBR_ORG_NM,T3.TEM_ORG_NM,T3.ORG_NM
FROM edw.dws_hr_empe_inf_dd                 t1
inner JOIN edw.dim_hr_org_job_inf_dd        t2
ON  t1.pos_enc = t2.pos_id
AND t2.dt = '20240531'
and t2.pos_nm ='营业经理'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd    t3
ON  t1.org_id = t3.org_id
AND t3.dt = '20240531'
left join(
    SELECT empe_id,empe_actv_sts_cd,empe_sts_cd,start_dt,end_dt
        ,ROW_NUMBER() over (partition by empe_id order by end_dt desc)  as  rn
    from  edw.dim_hr_empe_org_inf_dd
    where dt='20240531'
)t4 on t1.empe_id=T4.empe_id
and t4.rn=1
and t4.empe_sts_cd='3' --离职
WHERE   t1.dt = '20240531'
and     length(t1.empe_id)>0    -- 本行员工号
AND     T4.empe_id is null  --剔除离职员工
;
-- 天添宝 历史购买过客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_02 AS
SElECT t1.cst_id
    ,t1.cfm_dt	        --确认日期
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,T1.trx_amt
    ,t1.cfm_amt
    ,t1.bnk_act_id	    --银行账号
    ,t1.pd_cd	        --产品代码
    ,ROW_NUMBER() OVER(PARTITION BY T1.CST_ID ORDER BY T1.cfm_dt ASC) RN
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                 T1 --理财交易确认流水明细 立英修改
INNER JOIN edw.dwd_bus_chm_ptfl_cpn_pd_rel_inf_dd   t2 --组合宝成分产品信息映射表
ON      t1.pd_cd = t2.pd_cd
and     t2.DVD_GRP_CD = 'TTB001'     --分组代码 天添宝 代销理财
AND     t2.dt = '@@{yyyyMMdd}'
where T1.DT<='@@{yyyyMMdd}'
AND t1.trx_sts_cd ='8'              --确认成功
and t1.cfm_dt <='20240531'
;
-- 理财确认日期 5.1-5.31 首购天添宝 客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_03 AS
SElECT t1.cst_id
    ,t1.bnk_act_id	    --银行账号
    ,t1.pd_cd	        --产品代码
    ,t1.cfm_dt	        --确认日期
    ,T1.trx_amt
    ,t1.cfm_amt
    ,T2.mgr_id  sale_empe_id
    ,t3.empe_nm sale_empe_nm
    ,t3.org_id
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,nvl(t5.empe_id,'') empe_id
    ,nvl(t5.empe_nm,'') empe_nm
    ,t6.mgr_mng_id,t6.mgr_mng_nm
FROM SJXQ_SJ2024060501_CST_02               T1
left join edw.DWS_BUS_CHM_ACT_MGR_INF_DD    t2 --理财账户管护汇总信息
on  t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.bnk_act_id=t2.bnk_act_id
and t2.dt = '20240531'
and t2.MNG_TYP_CD = '2'    --`管户`类型 1考核 2销售
AND t2.PD_TP_CD = '1'      --理财
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t2.mgr_id=t3.empe_id
and t3.dt='20240531'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on  t3.org_id = t4.org_id
and t4.dt = '20240531'
left join SJXQ_SJ2024060501_CST_01          T5
on  t3.org_id = t5.org_id
and t5.ORG_NM <> '杭州分行待分配'       --多个营业经理，置空
left join(
    select t1.bnk_act_id,t1.cst_id,t1.pd_cd
    from edw.DWS_BUS_CHM_ACT_MGR_INF_DD    t1 --理财账户管护汇总信息
    left join edw.dws_hr_empe_inf_dd       t2 --员工信息汇总
    on  t1.mgr_id=t2.empe_id
    and t2.dt='20240531'
    where t1.dt = '20240531'
    and t1.MNG_TYP_CD = '1'    --`管户`类型 1考核 2销售
    AND t1.PD_TP_CD = '1'      --理财
    group by t1.bnk_act_id,t1.cst_id,t1.pd_cd
)t6 on t1.cst_id=t6.cst_id
and t1.pd_cd =t6.pd_cd
and t1.bnk_act_id=t6.bnk_act_id
WHERE t1.cfm_dt>='20240501'            --历史首次购买TTB日期
AND T1.TRX_AMT >= 200                  --首笔交易金额>=200
AND T1.RN=1                            --首笔
;
-- 存款账户管户 第一联系人
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_03_1 AS
select t4.cst_id
from edw.dwd_bus_dep_cst_act_mgr_inf_dd    T4
left join edw.dws_hr_empe_inf_dd           t5 --员工信息汇总
on  t4.mgr_id=t5.empe_id
and t5.dt='20240531'
WHERE T4.dt='@@{yyyyMMdd}'
and T4.frs_ctc_ind = '1'
and nvl(t4.cst_id,'')<>''
group by t4.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_04 AS
SElECT t1.cfm_dt 	  	    日期
    ,t1.sale_empe_id        销售人工号
    ,t1.sale_empe_nm        销售人姓名
    ,t1.ORG_NM              销售人所在机构
    ,t1.empe_id             机构营业经理工号
    ,t1.empe_nm             机构营业经理姓名
    ,t1.mgr_mng_id          管户人工号
    ,t1.mgr_mng_nm          管户人姓名
    ,t2.fst_mng_id          第一联系人工号
    ,t2.fst_mng_nm          第一联系人姓名
    ,'天添宝'               理财产品
    ,count(1)               笔数
from SJXQ_SJ2024060501_CST_03           t1
left join SJXQ_SJ2024060501_CST_03_1    t2
on t1.cst_id=t2.cst_id
-- where sale_empe_id is not null  --剔除账号变更的记录 即销售人为空
group by t1.cfm_dt,t1.sale_empe_id,t1.sale_empe_nm,t1.ORG_NM,t1.empe_id,t1.empe_nm
    ,t1.mgr_mng_id,t1.mgr_mng_nm,t2.fst_mng_id,t2.fst_mng_nm
;
-- 重点理财产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_05 AS
select ta_cd
    ,pd_cd                                  --产品代码|C24
	,pd_nm                                  --产品名称|C256
	,clc_start_dt                           --募集开始日期|C8
	,clc_end_dt                             --募集结束日期|C8
	,pd_found_dt                            --产品成立日期|C8
    ,pd_val_dt                              --产品起息日期
	,pd_end_dt                              --产品结束日期|C8
	,actl_found_dt                          --实际成立日期|C8
	,cur_siz                                --当前规模|DECIMAL(20,2)
    ,rsk_grd                                --风险等级
    ,pfm_comp_bas                           --业绩比较基准
    ,pd_actl_clc_amt                        --产品实际募集金额
    ,chm_inv_typ_cd	                        --产品模板|C32
    ,case when pd_nm regexp '挂钩'                        then '挂钩型理财'
        when pd_nm regexp '交银理财稳享鑫荣三年封闭式'      then '交银三年期'
        when pd_nm regexp '招睿增利精选'                   then '招睿增利精选'
        when pd_nm regexp '丰利兴动多策略封闭式|招银理财招睿焦点联动中证' then '小雪球'
        else '' end pd_cls
from edw.dim_bus_chm_pd_inf_dd  --理财产品信息
where dt='20240531'
and pd_nm regexp '挂钩|交银理财稳享鑫荣三年封闭式|招睿增利精选|丰利兴动多策略封闭式|招银理财招睿焦点联动中证'
and pd_sts_cd<>'3'              --发行失败
;
-- 重点理财交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_06 AS
SElECT t1.srl_nbr
    ,t1.bnk_act_id ,t1.cst_id ,t1.pd_cd
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,t1.cfm_dt	        --确认日期
    ,T1.trx_amt
	,t1.cfm_amt
	,t1.trx_cd
    ,t1.bus_cd
    ,p1.pd_nm,p1.pd_cls
    ,T2.mgr_id  sale_empe_id
    ,t3.empe_nm sale_empe_nm
    ,t3.org_id
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,nvl(t5.empe_id,'') empe_id
    ,nvl(t5.empe_nm,'') empe_nm
    ,t6.mgr_mng_id,t6.mgr_mng_nm
from EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI         t1 --理财交易确认流水明细
inner JOIN SJXQ_SJ2024060501_CST_05         p1
on t1.pd_cd=p1.pd_cd
left join edw.DWS_BUS_CHM_ACT_MGR_INF_DD    t2 --理财账户管护汇总信息
on t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.bnk_act_id=t2.bnk_act_id
and t2.dt = '20240531'
and t2.MNG_TYP_CD = '2'    --`管户`类型 1考核 2销售
AND t2.PD_TP_CD = '1'      --理财
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t2.mgr_id=t3.empe_id
and t3.dt='20240531'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树 4537 org_id 唯一
on  t3.org_id = t4.org_id
and t4.dt = '20240531'
left join SJXQ_SJ2024060501_CST_01          T5
on  t3.org_id = t5.org_id
left join(
    select t1.bnk_act_id,t1.cst_id,t1.pd_cd
    from edw.DWS_BUS_CHM_ACT_MGR_INF_DD    t1 --理财账户管护汇总信息
    left join edw.dws_hr_empe_inf_dd       t2 --员工信息汇总
    on  t1.mgr_id=t2.empe_id
    and t2.dt='20240531'
    where t1.dt = '20240531'
    and t1.MNG_TYP_CD = '1'    --`管户`类型 1考核 2销售
    AND t1.PD_TP_CD = '1'      --理财
    group by t1.bnk_act_id,t1.cst_id,t1.pd_cd
)t6 on t1.cst_id=t6.cst_id
and t1.pd_cd =t6.pd_cd
and t1.bnk_act_id=t6.bnk_act_id
where T1.DT<='@@{yyyyMMdd}'     --确认日期
AND t1.trx_sts_cd ='8'          --确认成功
and t1.cfm_dt between '20240501' and '20240531'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_07 AS
SElECT t1.cfm_dt 	  	    日期
    ,t1.sale_empe_id        销售人工号
    ,t1.sale_empe_nm        销售人姓名
    ,t1.ORG_NM              销售人所在机构
    ,t1.empe_id             机构营业经理工号
    ,t1.empe_nm             机构营业经理姓名
    ,t1.mgr_mng_id          管户人工号
    ,t1.mgr_mng_nm          管户人姓名
    ,t2.fst_mng_id          第一联系人工号
    ,t2.fst_mng_nm          第一联系人姓名
    ,t1.pd_cls                 理财产品
    ,sum(cfm_amt)           确认金额
from SJXQ_SJ2024060501_CST_06           t1
left join SJXQ_SJ2024060501_CST_03_1    t2
on t1.cst_id=t2.cst_id
-- where sale_empe_id is not null  --剔除账号变更的记录 即销售人为空
group by t1.cfm_dt,t1.sale_empe_id,t1.sale_empe_nm,t1.ORG_NM,t1.empe_id,t1.empe_nm
    ,t1.mgr_mng_id,t1.mgr_mng_nm,t2.fst_mng_id,t2.fst_mng_nm,t1.pd_cls
;
-- 理财首次风评
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_08 AS
SELECT  T1.trx_dt       as  签约日期
       ,T7.ctr_dt       as  首次签约日期
       ,T1.cst_id       as  签约客户号
       ,T5.cd_val_dscr  as  交易类型
       ,CASE  WHEN  T1.trx_dt=T7.ctr_dt  THEN  '是'
              WHEN  T1.trx_dt>T7.ctr_dt  THEN  '否'
              ELSE  '异常' end   AS  是否首次签约
       ,T6.cd_val_dscr  as  交易渠道
       ,2024-SUBSTR(T2.bth_dt,1,4)  as 签约客户年龄
       ,T1.trx_tlr_id   as  交易柜员工号
       ,T3.empe_nm      as  交易柜员名字
       ,T1.trx_org_id   as  签约机构号
       ,T4.sbr_org_nm       as 签约支行
FROM   edw.dwd_bus_chm_act_rqs_srl_dtl_di  T1  --理财账户类请求流水明细
left JOIN edw.dws_cst_idv_bas_inf_dd       T2 ON  T1.cst_id=T2.cst_id  and T2.dt='20240531'
left JOIN edw.dim_hr_empe_bas_inf_dd       T3 ON  T1.trx_tlr_id=T3.empe_id  and T3.dt='20240531'
left JOIN edw.dim_hr_org_mng_org_tree_dd   T4 ON  T1.trx_org_id=T4.org_id  and T4.dt='20240531'
left join (
    select DISTINCT cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where dt='20240531'
)  T5 on  T1.trx_cd=T5.cd_val
left join (
    select DISTINCT cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where dt='20240531'
)  T6 on  T1.TRX_CHNL_CD=T6.cd_val
left JOIN (
    select A1.cst_id
          ,A1.ctr_dt
          ,ROW_NUMBER()over(partition by A1.cst_id ORDER by A1.ctr_dt asc) as RN
    from edw.dwd_bus_chm_ctr_inf_dd  A1
    WHERE   A1.dt='20240531'
)  T7 on  T1.cst_id=T7.cst_id and   T7.rn=1
WHERE  T1.dt>='20240101'
AND    T1.dt<='20240430'
AND    T2.cst_id is not null
AND    T5.cd_val_dscr='客户签约'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_09 AS
select client_no        cst_id      --客户编号
    ,min(risk_date) 	risk_date   --评级日期
from edw.finc_tbhisclientrisklist   --客户风险等级评估记录
where dt='20240531'
and nvl(client_no,'')<>''
-- and channel='6'         --低柜 '0','1','6','7','B','Q'
group by client_no
having min(risk_date)>='20240527'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024060501_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060501_CST_10 AS
SELECT t1.*,t2.risk_date    首次风评日期
from SJXQ_SJ2024060501_CST_08       t1
left join SJXQ_SJ2024060501_CST_09  T2
on t1.签约客户号=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct org_id) custs
from SJXQ_SJ2024060501_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024060501_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024060501_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 日期,销售人工号) custs
from SJXQ_SJ2024060501_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060501_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,pd_cls) custs
from SJXQ_SJ2024060501_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 日期,销售人工号,理财产品) custs
from SJXQ_SJ2024060501_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 签约客户号) custs
from SJXQ_SJ2024060501_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024060501_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 签约客户号) custs
from SJXQ_SJ2024060501_CST_10
;
/*
01	448	446
02	128207	128207
03	5337	5337
04	5181	2295
05	239	239
06	3656	3233
07	3177	2441
08	33528	33506
09	1290	1290
10	33528	33506
*/
***SJ2024060676_财富5月合规销售.sql
-- 2024年3月新增的定期理财认购/申购，非货基金认购/申购交易，交易申请确认状态为成功
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_01 AS
SELECT '定期理财'   bus_type  --业务类型
    -- ,decode(trx_cd,'100200','理财产品购买','100201','理财产品申购') --交易代码
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,t1.srl_nbr --流水号
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    -- , 销售人员姓名
    -- , brc_org_nm
    -- , sbr_org_nm
    -- ,bnk_act_id 银行账号
    ,t1.tatrx_act_nbr
    ,t1.tacd    --ta代码
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
    ,t1.cst_id          --cst_ID
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
WHERE t1.dt = '@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8) between '20240501' and '20240531'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t1.trx_cd IN ( '100200' , '100201' )
;
-- 客户上一次理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_02 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,a.rsk_lvl_cd,a.late_ases_dt
        ,row_number() over(partition by a.cst_id order by late_ases_dt desc) rn
    from edw.dwd_bus_chm_cst_rsk_ases_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024060676_CST_01)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,rsk_lvl_cd,late_ases_dt
) a where rn=2
;
-- 客户交易时理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_03 AS
select T1.srl_nbr,T1.trx_dt
    ,T2.rsk_lvl_cd         trx_rsk_lvl      --客户交易日风险等级
    ,T2.late_ases_dt       trx_rsk_ases_dt  --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_01 T1
inner join edw.dwd_bus_chm_cst_rsk_ases_dd T2
on T1.cst_ID=T2.cst_id and T1.trx_dt=T2.dt
where T2.dt between '20240501' and '20240531'
;
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_04 AS
SELECT '非货基金' BUS_TYPE
    ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.CST_ID          --CST_ID
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='@@{yyyyMMdd}'
    and T1.CHANNEL_DATE between '20240501' and '20240531'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20240501' and '20240531'
    and T1.CHANNEL_DATE between '20240501' and '20240531'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_05 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,cst_rsk_grd_cd rsk_lvl_cd,ases_dt late_ases_dt,
        row_number() over(partition by a.cst_id order by ases_dt desc) rn
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024060676_CST_04)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,cst_rsk_grd_cd,ases_dt
) a where rn=2
;
-- 客户交易时基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_06 AS
select a.srl_nbr,a.trx_dt
    ,b.cst_rsk_grd_cd       trx_rsk_lvl     --客户交易日风险等级
    ,b.ases_dt              trx_rsk_ases_dt --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_04           a
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    b
on a.cst_ID=b.cst_id and a.trx_dt=b.dt
where b.dt between '20240501' and '20240531'
;
--定期理财+基金
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_07 AS
select T1.*
    ,T4.rsk_lvl_cd,T4.late_ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_01           T1		--理财交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024060676_CST_02      T2      --上次理财风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024060676_CST_03      T3      --交易时理财风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dwd_bus_chm_cst_rsk_ases_dd               T4 		--理财风评表
on T1.CST_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
union all
select T1.*
    ,T4.cst_rsk_grd_cd,T4.ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_04           T1      --基金交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024060676_CST_05      T2      --上次基金风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024060676_CST_06      T3      --交易时基金风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd        T4      --基金风评表
on t1.cst_ID=t4.cst_ID and t4.dt='@@{yyyyMMdd}'
;
--关联其他字段（主表）
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_08 AS
SElECT T1.*
    ,T2.ta_name --发行机构
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    ,T7.credit_rsk_grd
    ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    ,T9.aum_avg_360d
    ,T10.aum_bal TRX_aum_bal
    ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ2024060676_CST_07   T1
left join edw.finc_tbtainfo                 T2 on t1.tacd=T2.ta_code  and T2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_ID=T3.cst_id and T3.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='@@{yyyyMMdd}'
left join (
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='@@{yyyyMMdd}'
) T7 on T1.CST_ID=T7.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.CST_ID=T8.cst_id and T8.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.CST_ID=T9.cst_id and T9.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
on T1.CST_ID=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20240501' and '20240531'
left join (
    SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
    inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '@@{yyyyMMdd}'
    WHERE a.dt between '20240501' and '20240531' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
    group by a.cst_id, a.dt
) t11 on T1.cst_ID=t11.cst_id and T1.trx_dt=t11.dt
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_09 AS
select distinct a.cst_ID,trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,b.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_08 a
left join edw.dws_cst_bas_inf_dd b
on a.cst_ID=b.cst_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd c
on b.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='@@{yyyyMMdd}'
and NVL(c.sam_rsk_ctrl_id,'')<>''
;
-- 前后5天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_10 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,rel_cust_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                         --贷款用途代码
    ,B.USG_CMT                             --用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt --贷款利率优惠备注
    ,case
        when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_09   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.CRC_IND <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '@@{yyyyMMdd}'
left outer join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '@@{yyyyMMdd}'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '@@{yyyyMMdd}'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_11 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_11 AS
select cst_ID,trx_dt
    ,a.rel_cst_id
    ,rel_cust_nm
    ,BUSI_CTR_ID                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,stdinr                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,INTR_RAT                            --执行利率
    ,REF_MON_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,a.REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,pre_ases_res
    ,HPN_TYP
    ,USG_CMT
    ,intr_rat_adj_cmt
    ,is_wfdk
    ,is_zc_loan
    ,lst_BUSI_CTR_ID
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.BUSI_CTR_ID            	lst_BUSI_CTR_ID
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.INTR_RAT                 lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ2024060676_CST_10
        where DIFF_TM<=5
    ) a
    left join lab_bigdata_dev.SJXQ_SJ2024060676_CST_10 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.pd_cd=b.pd_cd and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_12 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024060676_CST_12 AS
select a.bus_type              业务类型
    ,a.trx_type                交易类型
    ,a.srl_nbr                 交易流水号
    ,a.trx_sts                 交易状态
    ,concat(a.trx_dt,' ',a.trx_tm) 申请日期
    ,a.cfm_dt                  确认日期
    ,a.trx_chnl                交易渠道
    ,a.trx_amt                 交易金额
    ,a.cfm_amt                 确认金额
    ,a.trx_lot                 交易份额
    ,a.cfm_lot                 确认份额
    ,a.sale_empe_id            销售人员工号
    ,a.sale_empe_nm            销售人员姓名
    ,a.brc_org_nm              所属分行
    ,a.sbr_org_nm              所属支行
    ,a.tatrx_act_nbr           交易账号
    ,a.pd_cd                   产品代码
    ,a.pd_nm                   产品名称
    ,a.ta_name                 发行机构
    ,a.prod_type               产品类型
    ,a.pd_rsk_grd              产品风险等级
    ,a.pfm_comp_bas            业绩比较基准
    ,a.pd_found_dt             产品扣款日
    ,a.pd_val_dt               产品起息日
    ,a.pd_end_dt               产品到期日
    ,a.CST_ID                  客户号
    ,a.cst_nm                  客户名称
    ,a.age                     客户年龄
    ,a.gender                  客户性别
    ,''                        客户手机号码
    ,a.rsk_lvl_cd                                           	客户当前风险测评结果
    ,decode(a.late_ases_dt,'18991231','',a.late_ases_dt)    	客户当前结果测评时间
    ,a.lst_rsk_lvl                                          	客户上一次风险测评结果
    ,decode(a.lst_rsk_ases_dt,'18991231','',a.lst_rsk_ases_dt)  客户上一次风险测评时间
    ,a.trx_rsk_lvl                                              客户交易日风险等级
    ,decode(a.trx_rsk_ases_dt,'18991231','',a.trx_rsk_ases_dt)  客户交易日风险测评时间
    ,a.is_farm								是否农户
    ,a.efe_loan_cst_ind                     是否信贷有效户
    ,a.efe_dep_cst_ind                      是否存款有效户
    ,a.is_empe                              是否行内员工
    ,a.aum_avg_360d                         客户近一年AUM
    ,a.trx_ncr_fnd_bal                      客户交易时非货基金保有量
    ,a.TRX_aum_bal                          客户交易时AUM
    ,if(b.cst_ID is not null,'是','') 		交易日前后5天内同一风险控制号下是否存在贷款
    ,b.rel_cust_nm                  		贷款客户名称
    ,c.loan_apl_credit_rsk_grd      		当前贷款申请时客户信用风险等级
    ,a.credit_rsk_grd               		当前客户信用风险等级
    ,b.BUSI_CTR_ID                   		当前笔贷款合同流水号
    ,b.reg_dt                       		当前笔贷款申请日期
    ,b.DTRB_DT                      		当前笔贷款发放日期
    ,b.CTR_AMT                      		当前笔贷款金额
    ,ref_year_intr_rat              		当前笔贷款参考年利率
    ,INTR_RAT                       		当前笔贷款执行年利率
    ,aprv_exe_mon_intr_rat          		当前笔贷款执行月利率
    ,b.pre_ases_res                 		当前笔贷款预审批结果
    ,b.FIVE_CTG                     		当前笔贷款五级分类
    ,b.HPN_TYP                      		贷款类型
    ,b.is_zc_loan                   		是否为政策性贷款
    ,b.is_wfdk                      		是否为接力贷
    ,b.intr_rat_adj_cmt             		贷款利率优惠备注
    ,b.USG_CMT                      		贷款用途备注
    ,b.lst_BUSI_CTR_ID              		上一笔贷款合同流水号
    ,b.lst_CTR_AMT                  		上一笔贷款合同金额
    ,b.lst_INTR_RAT                 		上一笔贷款执行年利率
    ,b.lst_aprv_exe_mon_intr_rat    		上一笔贷款执行月利率
    ,b.lst_DTRB_DT                   		上一笔贷款发放日期
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_08       a
left join lab_bigdata_dev.SJXQ_SJ2024060676_CST_11  b
on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
left join (
    select distinct dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') loan_apl_credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt<='@@{yyyyMMdd}'
) c on b.rel_cst_id=c.cst_id and b.reg_dt=c.dt
;
SElECT '01' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_01
union all
SElECT '04' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_04
union all
SElECT '07' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_07
union all
SElECT '08' seq,count(1) cnt,count(DISTINCT cst_id,trx_dt) CST_TRX_CNT,COUNT(DISTINCT srl_nbr) SRL_NBR
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_08
;
SElECT '02' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_02
union all
SElECT '03' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_03
union all
SElECT '05' seq,count(1) cnt,count(DISTINCT cst_id)
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_05
union all
SElECT '06' seq,count(1) cnt,count(DISTINCT srl_nbr)
from lab_bigdata_dev.SJXQ_SJ2024060676_CST_06
union all
SElECT '09' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024060676_CST_09
union all
SElECT '10' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024060676_CST_10
union all
SElECT '11' seq, count(1) cnt, count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024060676_CST_11
union all
SElECT '12' seq, count(1) cnt, count(distinct 客户号,申请日期) custs
from SJXQ_SJ2024060676_CST_12
;
/*
01	4832	4625	4832
04	535	461	535
07	5367	5077	5367
08	5368	5077	5367
02	3026	3026
03	4832	4832
05	155	155
06	535	535
09	7595	5077
10	11159	5077
11	11	11
12	5368	5367
*/***SJ2024060711_理财产品分类监测代码.sql
--理财考核汇总信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024060711_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060711_CST_01 AS
select t1.cst_id                                 --客户编号
	,t1.pd_cd                                    --产品代码
	,t1.bnk_act_id                               --银行账号
	,t1.mgr_id                                   --管护人编号
	,t1.acs_org_id                               --考核机构编号
	,t1.ccy_cd                                   --币种代码
	,t1.chm_typ_cd                               --理财类型代码
	,case when t1.agn_ind='1' then '代销' else '自营' end cls_1
	,t1.pd_nav                                   --产品净值|decimal(31,15)
	,t1.mng_typ_cd                               --管户类型代码|c1
	,t1.acs_rto                                  --考核比例|decimal(7,3)
	,t1.mid_amt                                  --当日中收|decimal(26,4)
	,t1.cur_fnc_amt                              --理财金额余额|DECIMAL(21,2)
    ,t1.dt
    ,case t2.TRX_MTH_CD when '0' then '开放式' when '2' then '封闭式' else '其他' end cls_2
    ,CASE
        WHEN t2.TRX_MTH_CD='2' and DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') <= 180                                                                                             THEN '6个月（含）以下'
        WHEN t2.TRX_MTH_CD='2' and DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') > 180 AND DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') <= 360  THEN '6个月（不含）-1年（含）'
        WHEN t2.TRX_MTH_CD='2' and DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') > 360 AND DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') <= 720  THEN '1年（不含）-2年（含）'
        WHEN t2.TRX_MTH_CD='2' and DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') > 720 AND DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') <= 1080 THEN '2年（不含）-3年（含）'
        WHEN t2.TRX_MTH_CD='2' and DATEDIFF(TO_DATE(t2.PD_END_DT, 'yyyyMMdd'), TO_DATE(t2.PD_FOUND_DT, 'yyyyMMdd'), 'dd') > 1080                                                                                             THEN '3年（不含）以上'
        when t1.agn_ind<>'1' and t2.TRX_MTH_CD='0' then t2.pd_nm
        when t1.agn_ind='1'  and t2.TRX_MTH_CD='0' and t2.pd_nm regexp '定开|季季开' then '定期开放式'
        when t1.agn_ind='1'  and t2.TRX_MTH_CD='0' and t2.pd_nm regexp '持有'       then '最短持有期'
        ELSE '其他' END     cls_3
    ,t2.pd_nm
    ,T3.empe_nm     mgr_nm
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
from wb_bigdata_manager_dev.dsj_v_dws_bus_chm_act_mgr_inf_dd         t1 --理财考核汇总信息
left join wb_bigdata_manager_dev.dsj_v_dim_bus_chm_pd_inf_dd         t2 --理财产品信息
on  t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
and pd_ctg_cd='1' --理财
left join wb_bigdata_manager_dev.dsj_v_dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join wb_bigdata_manager_dev.dsj_v_dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.acs_org_id=t4.org_id
and t4.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.PD_TP_CD='1'      --理财类型：0基金 1理财
-- and t1.MNG_TYP_CD = '1'  --`管户`类型 1考核 2销售
;
/*
--理财账户份额汇总信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024060711_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060711_CST_02 AS
select dt,cst_id                              --客户编号|C20
    ,pd_cd                                    --产品代码|C24
	,bnk_act_id                               --银行账号|C32
	,fnc_amt                                  --当前理财金额|DECIMAL(21,2)
    ,sum(fnc_amt) over(partition by substr(dt,1,6),cst_id,pd_cd,bnk_act_id order by dt) curr_mon_fnc_amt_acml --当月理财金额积数
    ,sum(fnc_amt) over(partition by substr(dt,1,4),cst_id,pd_cd,bnk_act_id order by dt) curr_year_fnc_amt_acml --当年理财金额积数
from wb_bigdata_manager_dev.dsj_v_dws_bus_chm_act_acm_inf_dd           --理财账户份额汇总信息
where dt<='@@{yyyyMMdd}'
and dt>='20240101'
;*/
--中收
DROP   TABLE IF     EXISTS SJXQ_SJ2024060711_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060711_CST_03 AS
select t1.dt,t1.MNG_TYP_CD
    ,t1.cst_id                                   --客户编号|C20
    ,t1.pd_cd                                    --产品代码|C24
	,t1.bnk_act_id                               --银行账号|C32
	,t1.mgr_id                                   --管护人编号
	,t1.acs_org_id                               --考核机构编号
    ,t1.mid_amt                                  --当日中收
    ,sum(t1.mid_amt) over(partition by substr(dt,1,6),cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id order by dt) curr_mon_mid_amt_acml --当月中收
    ,sum(t1.mid_amt) over(partition by case when month(TO_DATE(dt,'yyyymmdd')) in(1,2,3) then 1
        when month(TO_DATE(dt,'yyyymmdd')) in(4,5,6) then 2
        when month(TO_DATE(dt,'yyyymmdd')) in(7,8,9) then 3
        when month(TO_DATE(dt,'yyyymmdd')) in(10,11,12) then 4 else 0 end
        ,cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id order by dt) curr_sea_mid_amt_acml --当季中收
    ,sum(t1.mid_amt) over(partition by substr(dt,1,4),cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id order by dt) curr_year_mid_amt_acml --当年中收
	,t1.cur_fnc_amt                              --理财金额余额
    ,sum(cur_fnc_amt) over(partition by substr(dt,1,6),cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id order by dt) curr_mon_fnc_amt_acml --当月理财金额积数
    ,sum(cur_fnc_amt) over(partition by substr(dt,1,4),cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id order by dt) curr_year_fnc_amt_acml --当年理财金额积数
from wb_bigdata_manager_dev.dsj_v_dws_bus_chm_act_mgr_inf_dd         t1 --理财考核汇总信息
where t1.dt<='@@{yyyyMMdd}'
and t1.dt>='20240101'
and t1.PD_TP_CD='1'      --理财类型：0基金 1理财
;
-- 当月、当年天数
DROP   TABLE IF     EXISTS SJXQ_SJ2024060711_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060711_CST_04 AS
SElECT dt
    -- ,dayofmonth(to_char(TO_DATE(dt,'yyyymmdd'),'yyyy-MM-dd'))   curr_mon_days2   --放一起建表报错
    ,DATEDIFF(TO_DATE(dt,'yyyymmdd'),LASTDAY(TO_DATE(ADD_MONTHS(TO_DATE(dt,'yyyymmdd'),-1),'yyyy-mm-dd')),'DD') curr_mon_days
    ,DATEDIFF(TO_DATE(dt,'yyyymmdd'),TO_DATE(concat(substr(dt,1,4),'0101'),'yyyymmdd'),'DD')+1 curr_year_days
from(
    SElECT distinct dt from SJXQ_SJ2024060711_CST_03
)t1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024060711_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060711_CST_05 AS
select t1.BRC_ORG_NM,T1.SBR_ORG_NM,T1.TEM_ORG_NM,t1.acs_org_id,T1.ORG_NM
    ,t1.mgr_id,t1.mgr_nm,t1.mng_typ_cd
    ,deocde(t1.mng_typ_cd,'1','考核','2','销售','') mng_typ_nm
    ,t1.cst_id                                  --客户编号
	,t1.pd_cd                                   --产品代码
	,t1.bnk_act_id                              --银行账号
	,t1.cls_1,t1.cls_2,t1.cls_3
	,t1.mid_amt                                 --当日中收|decimal(26,4)
	,t1.cur_fnc_amt                             --理财金额余额|DECIMAL(21,2)
    ,t2.curr_mon_mid_amt_acml                   --当月中收
    ,t2.curr_sea_mid_amt_acml                   --当季中收
    ,t2.curr_year_mid_amt_acml                  --当年中收
    ,t2.curr_mon_fnc_amt_acml                   --当月理财金额积数
    ,round(t2.curr_mon_fnc_amt_acml/t3.curr_mon_days,2)  fnc_amt_mon_avg
    ,t2.curr_year_fnc_amt_acml                  --当年理财金额积数
    ,round(t2.curr_year_fnc_amt_acml/t3.curr_year_days,2) fnc_amt_year_avg
    ,t4.cur_fnc_amt     mon_1d_fnc_amt
    ,t5.cur_fnc_amt     year_1d_fnc_amt
from SJXQ_SJ2024060711_CST_01       t1
left join SJXQ_SJ2024060711_CST_03  t2 --当前
on  t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.MNG_TYP_CD=t2.mng_typ_cd
and t1.mgr_id=t2.mgr_id
and t1.bnk_act_id=t2.bnk_act_id
and t1.acs_org_id=t2.acs_org_id
and t1.dt=t2.dt
left join SJXQ_SJ2024060711_CST_04  t3
on t2.dt=t3.dt
left join SJXQ_SJ2024060711_CST_03  t4 --月初
on  t1.cst_id=t4.cst_id
and t1.pd_cd=t4.pd_cd
and t1.MNG_TYP_CD=t4.mng_typ_cd
and t1.mgr_id=t4.mgr_id
and t1.bnk_act_id=t4.bnk_act_id
and t1.acs_org_id=t4.acs_org_id
and t4.dt=concat(substr(t1.dt,1,6),'01')
left join SJXQ_SJ2024060711_CST_03  t5 --年初
on  t1.cst_id=t5.cst_id
and t1.pd_cd=t5.pd_cd
and t1.MNG_TYP_CD=t5.mng_typ_cd
and t1.mgr_id=t5.mgr_id
and t1.bnk_act_id=t5.bnk_act_id
and t1.acs_org_id=t5.acs_org_id
and t5.dt=concat(substr(t1.dt,1,4),'0101')
;
-- 输出结果 当前日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024060711_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060711_CST_06 AS
select BRC_ORG_NM           分行
    ,SBR_ORG_NM             支行
    ,TEM_ORG_NM             团队
    ,acs_org_id             机构ID
    ,ORG_NM                 机构名称
    ,mgr_id                 管户人编号
    ,mgr_nm                 管户人姓名
    ,mng_typ_nm             管户类型
	,cls_1                  一级分类
    ,cls_2                  二级分类
    ,cls_3                  三级分类
	,sum(cur_fnc_amt)                               当日余额
    ,sum(cur_fnc_amt)-sum(fnc_amt_mon_avg)          当日余额较月均
    ,sum(cur_fnc_amt)-sum(fnc_amt_year_avg)         当日余额较年均
    ,sum(fnc_amt_mon_avg)                           月日均
    ,sum(fnc_amt_mon_avg)-sum(mon_1d_fnc_amt)       月日均较月初
    ,sum(fnc_amt_mon_avg)-sum(year_1d_fnc_amt)      月日均较年初
	,sum(mid_amt)                                   当日中收
    ,sum(curr_mon_mid_amt_acml )                    当月中收
    ,sum(curr_sea_mid_amt_acml )                    当季中收
    ,sum(curr_year_mid_amt_acml)                    当年中收
from SJXQ_SJ2024060711_CST_05
group by BRC_ORG_NM,SBR_ORG_NM,TEM_ORG_NM,acs_org_id,ORG_NM
    ,mgr_id,mgr_nm,mng_typ_nm,cls_1,cls_2,cls_3
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id) custs
from SJXQ_SJ2024060711_CST_01
-- union all
-- SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
-- from SJXQ_SJ2024060711_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dt,cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id) custs
from SJXQ_SJ2024060711_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct dt) custs
from SJXQ_SJ2024060711_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,pd_cd,MNG_TYP_CD,mgr_id,bnk_act_id,acs_org_id) custs
from SJXQ_SJ2024060711_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 分行) custs
from SJXQ_SJ2024060711_CST_06
;
/*
问题1：TRX_MTH_CD = '0' 开放式理财 '0','开放式' ,'1','半封闭式' ,'1','新增' ,'2','封闭式' ,'3','半开放式'
这里的 二级分类 开放式 封闭式是指 0,2 吗？是
2. 自营封闭式的三级分类 是按计息天数=收益到期日-产品起息日 区分 还是 产品名称 区分？
3. 代销开放式的三级分类 （现金管理类 T+1日开 ）如何区分？
4. 数据日期最新
5. quickBI
*/
***SJ2024060726_代销产品风险等级.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_01 AS
SElECT col_1    bus_typ
    ,col_2      pd_nm
    ,case when nvl(t1.col_3,'')<>'' then t1.col_3 else t2.prd_no end pd_cd
FROM qbi_file_20240607_17_18_08         t1
left join edw.dim_bus_insu_pd_inf_dd    t2 --保险产品信息
on  t1.col_2=t2.prd_nm
and t2.dt='@@{yyyyMMdd}'
;
-- 我行产品系统里初次录入的日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_02 AS
select *
from(
    select pd_cd                    --产品代码|C24
        ,pd_nm                      --产品名称|C256
        ,pd_found_dt                --产品成立日期|C8
        ,pd_val_dt                  --产品起息日期|C8
        ,actl_found_dt              --实际成立日期|C8
        ,rsk_grd                    --风险等级|INTEGER
        ,dt
        ,row_number() over(partition by pd_cd order by dt asc) rn
    from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
    where dt<='@@{yyyyMMdd}'
    and pd_ctg_cd='1' --理财
)t1 where rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_03 AS
select *
from(
    select pd_cd                                  --产品代码|text
        ,pd_nm                                    --产品名称|text
        ,found_dt                                 --成立日期|text
        ,rsk_grd_cd                               --风险等级代码|text
        ,dt
        ,row_number() over(partition by pd_cd order by dt asc) rn
    from edw.dim_bus_chm_fnd_pd_inf_dd            --基金产品基础信息表
    where dt<='@@{yyyyMMdd}'
    and nvl(rsk_grd_cd,'')<>''
)t1 where rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_04 AS
select *
from(
    select prd_no                   --产品代码
        ,prd_nm                     --产品名称
        ,prd_typ_nm                 --产品类型名称
        ,prd_lvl1_cl_cd             --产品一级分类代码
        ,prd_lvl2_cl_cd             --产品二级分类代码
        ,prd_rsk_lvl_cd	            --产品风险等级代码
        ,isu_tm	                    --发布时间
        ,dt
        ,row_number() over(partition by prd_no order by dt asc) rn
    from edw.dim_bus_insu_pd_inf_dd               --保险产品信息
    where dt<='@@{yyyyMMdd}'
)t1 where rn=1
;
--主表探索
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_05 AS
SElECT t1.bus_typ,t2.bus_typ2,t1.pd_cd
    ,t1.pd_nm,t2.pd_nm pd_nm_sys
    ,t2.dt
from SJXQ_SJ2024060726_CST_01       t1
left join(
    select pd_cd,pd_nm,dt,rsk_grd,'理财' bus_typ2
    from SJXQ_SJ2024060726_CST_02
    union all
    select pd_cd,pd_nm,dt,rsk_grd_cd,'基金' bus_typ2
    from SJXQ_SJ2024060726_CST_03
    union all
    select prd_no,prd_nm,dt,prd_rsk_lvl_cd,'保险' bus_typ2
    from SJXQ_SJ2024060726_CST_04
)t2 on t1.pd_cd=t2.pd_cd
;
--第一笔销售的时间
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_06 AS
SElECT t1.pd_cd,t1.min_trx_dt
    ,t3.rsk_grd
from(
    SELECT t1.pd_cd,min(t1.trx_dt) min_trx_dt
    FROM edw.dwd_bus_chm_trx_rqs_srl_dtl_di     t1
    INNER JOIN SJXQ_SJ2024060726_CST_05         t2
    ON  t1.pd_cd = t2.pd_cd
    and t2.bus_typ='代销理财'
    WHERE t1.dt <= '@@{yyyyMMdd}'
    group by t1.pd_cd
)t1 left join edw.dim_bus_chm_pd_inf_dd         t3       --理财产品信息
on t1.pd_cd=t3.pd_cd
and t3.dt=t1.min_trx_dt
and t3.dt<='@@{yyyyMMdd}'
and t3.pd_ctg_cd='1' --理财
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_07 AS
SElECT t1.pd_cd,t1.min_trx_dt
    ,t3.rsk_grd_cd
from(
    select t1.pd_cd,min(t1.chnl_dt) min_trx_dt
    from edw.dwd_bus_chm_fnd_cst_rqs_srl_dd     t1 --基金客户资金类交易申请流水
    INNER JOIN SJXQ_SJ2024060726_CST_05         t2
    ON  t1.pd_cd = t2.pd_cd
    and t2.bus_typ='代销基金'
    where t1.dt='@@{yyyyMMdd}'
    and t1.chnl_dt<>'18991231'
    group by t1.pd_cd
)t1 left join edw.dim_bus_chm_fnd_pd_inf_dd     t3
on t1.pd_cd=t3.pd_cd
and t3.dt=t1.min_trx_dt
and t3.dt<='@@{yyyyMMdd}'
;
--基金交易确认流水明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_07_1 AS
SElECT t1.pd_cd,t1.min_trx_dt
    ,t3.rsk_grd_cd
from(
    select t1.pd_cd,min(t1.bus_dt) min_trx_dt
    from edw.dwd_bus_chm_fnd_trx_cfm_dtl_di  t1
    INNER JOIN SJXQ_SJ2024060726_CST_05      t2
    ON  t1.pd_cd = t2.pd_cd
    and t2.bus_typ='代销基金'
    where t1.dt<='@@{yyyyMMdd}'
    GROUP BY t1.pd_cd
)t1 left join edw.dim_bus_chm_fnd_pd_inf_dd     t3
on t1.pd_cd=t3.pd_cd
and t3.dt=t1.min_trx_dt
and t3.dt<='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_08 AS
SElECT t1.pd_cd,t1.min_trx_dt
    ,t3.prd_rsk_lvl_cd
from(
    SELECT t3.pd_cd,min(t1.TRX_DT) min_trx_dt
    FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD    T1 --保险业务交易流水信息
    -- INNER JOIN edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T2 --保单信息表
    -- ON      T2.INSU_POLY_NO = T1.INSU_POLY_NO      --保单编号关联
    -- AND     T2.DT = '@@{yyyyMMdd}'
    INNER JOIN SJXQ_SJ2024060726_CST_05         t3
    ON  t1.prd_no = t3.pd_cd
    and t3.bus_typ='代销保险'
    WHERE   T1.DT = '@@{yyyyMMdd}'
    AND     T1.BSN_TYP_NM = '订单'
    group by t3.pd_cd
)t1 left join edw.dim_bus_insu_pd_inf_dd        t3  --20240418之前只有月末数据
on t1.pd_cd=t3.prd_no
and t3.dt=t1.min_trx_dt
and t3.dt<='@@{yyyyMMdd}'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_09 AS
SElECT t1.bus_typ,t1.pd_nm,t1.pd_cd
    ,t1.pd_nm_sys
    ,t1.dt
    ,t1.rsk_grd_sys_fst
    ,t2.min_trx_dt
from SJXQ_SJ2024060726_CST_05           t1
left join(
    select pd_cd,min_trx_dt,rsk_grd,'代销理财' bus_typ2
    from SJXQ_SJ2024060726_CST_06
    union all
    select pd_cd,min_trx_dt,rsk_grd_cd,'代销基金' bus_typ2
    from (
        SElECT *,row_number() over(partition by pd_cd order by min_trx_dt asc) rn
        from(
            select pd_cd,min_trx_dt,rsk_grd_cd
            from SJXQ_SJ2024060726_CST_07
            union all
            select pd_cd,min_trx_dt,rsk_grd_cd
            from SJXQ_SJ2024060726_CST_07_1
        )t1
    )t1 where t1.rn=1
    union all
    select pd_cd,min_trx_dt,prd_rsk_lvl_cd,'代销保险' bus_typ2
    from SJXQ_SJ2024060726_CST_08
)t2 on t1.pd_cd=t2.pd_cd
and t1.bus_typ=t2.bus_typ2
left join(
    select pd_cd                    --产品代码|C24
        ,rsk_grd                    --风险等级|INTEGER
        ,'代销理财' bus_typ2
    from edw.dim_bus_chm_pd_inf_dd                --理财产品信息
    where dt='20240524'
    and pd_ctg_cd='1' --理财
    union all
    select pd_cd                                  --产品代码|text
        ,rsk_grd_cd                               --风险等级代码|text
        ,'代销基金' bus_typ2
    from edw.dim_bus_chm_fnd_pd_inf_dd            --基金产品基础信息表
    where dt='20240524'
    union all
    select prd_no                   --产品代码
        ,prd_rsk_lvl_cd	            --产品风险等级代码
        ,'代销保险' bus_typ2
    from edw.dim_bus_insu_pd_inf_dd               --保险产品信息
    where dt='20240524'
)t3 on t1.pd_cd=t3.pd_cd
and t1.bus_typ=t3.bus_typ2
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024060726_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060726_CST_10 AS
SElECT bus_typ 				业务
    ,pd_nm_sys              产品名称
    ,pd_cd                  产品代码
    ,dt                     产品系统初次录入风险等级日期
    ,rsk_grd_sys_fst        产品系统初次录入风险等级
    ,min_trx_dt             第一笔销售日期
    ,fst_trx_rsk_grd        第一笔销售时的风险等级
    ,rsk_grd_20240524       产品20240524风险等级
from SJXQ_SJ2024060726_CST_09
;
SElECT '01' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct prd_no) custs
from SJXQ_SJ2024060726_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_07
union all
SElECT '071' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_07_1
union all
SElECT '08' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024060726_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct 产品代码) custs
from SJXQ_SJ2024060726_CST_10
;
/*
01	486	486
02	2100	2100
03	328	328
04	72	72
05	486	486
06	152	152
07	185	185
071	267	267
08	62	62
09	486	486
10	486	486
select bus_typ,count(1) cnt
from SJXQ_SJ2024060726_CST_01
GROUP BY bus_typ
代销保险	63
代销基金	271
代销理财	152
1. 保险产品表20240418之前只有月末数据
2. 基金交易申请流水表中 仅包含185个产品，确认流水表包含 267个产品。取两者交易日期最小值
*/
***SJ2024060791_庆元村行授信客户清单.sql
﻿--贷款合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024060791_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060791_CST_01 AS
select t1.busi_ctr_id                            --业务合同编号|C32
    ,t1.busi_apl_id                              --业务申请编号
    ,t1.pre_apl_srl_nbr                          --预申请流水号
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.intr_rat                                 --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                              --贷款用途代码|C4
    ,c1.cd_val_dscr     loan_usg_nm
	,t1.usg_cmt                                  --用途备注|c4
    ,t1.five_ctg_cd                              --五级分类代码
    ,c2.cd_val_dscr     five_ctg_nm
    ,t1.sgn_spus_com_dbt_ind                    --签订夫妻共同债务标志
    ,t2.acs_org_id,t2.acs_mngr_id
    ,t3.empe_nm acs_mngr_nm
    ,t4.org_nm,t4.BRC_ORG_NM,t4.BRC_ORG_ID
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t2 --信贷合同管护信息
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='20240531'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  T2.acs_mngr_id=t3.empe_id
and t3.dt='20240531'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.acs_org_id=t4.org_id
and t4.BRC_ORG_NM like '%庆元泰隆村镇银行%'
and t4.dt='20240531'
LEFT JOIN    edw.dwd_code_library_dd c1 -- 码值表
ON  T1.loan_usg_cd = c1.cd_val
AND c1.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND c1.fld_nm = 'LOAN_USG_CD'
AND c1.dt = '20240531'
LEFT JOIN    edw.dwd_code_library_dd c2 --码值表
ON      t1.five_ctg_cd = c2.cd_val
AND     c2.DT = '20240531'
where t1.dt='20240531'
;
-- 农村城市标志
DROP   TABLE IF     EXISTS SJXQ_SJ2024060791_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060791_CST_02 AS
SElECT t1.cst_id
    ,t2.vlg_cty_ind
from(
    SElECT distinct cst_id from SJXQ_SJ2024060791_CST_01
)t1 left join (
    select cst_id,vlg_cty_ind	        --农村城市标志
    from edw.dim_cst_entp_bas_inf_dd    --企业客户基本信息
    where dt='20240531'
    union
    select customerid,addressflag	        --农村城市标志
    from edw.loan_ind_info	            --个人信息表
    where dt='20240531'
)t2 on t1.cst_id=t2.cst_id
;
-- 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024060791_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060791_CST_03 AS
SElECT t1.cst_id
    ,t2.fm_ind	        --农户标志|C1
    ,t2.ind_bus_ind	    --个体工商户标志|C1
    ,case when nvl(t3.lctax_cert_no,'')<>''  then '是' else '否' end is_uscc
    ,t4.reg_adr	        --户籍地址|注册地址
    ,t4.fml_adr	        --家庭地址
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024060791_CST_01
)t1 left join edw.dim_cst_idv_bas_inf_dd t2 --个人客户基本信息
on  t1.cst_id=t2.cst_id
and t2.dt='20240531'
left join edw.dim_cst_entp_bas_inf_dd   t3 --企业客户基本信息
on  t1.cst_id=t3.cst_id
and t3.dt='20240531'
left join edw.dws_cst_bas_inf_dd	    t4 --客户基础信息汇总表
on  t1.cst_id=t4.cst_id
and t4.dt='20240531'
;
-- 未在我行开户
DROP   TABLE IF     EXISTS SJXQ_SJ2024060791_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060791_CST_04 AS
select *
from(
    SELECT cst_id,doc_nbr,uscc,entp_typ,entp_nm,entp_sts,pvc,idt_nm
        ,ROW_NUMBER() over(partition by uscc order by dat_tm desc,dat_ins_tm desc) rn
    from lab_bigdata_dev.wushan_024547_kequn_gs_prsn -- 工商个人人员法人信息
    where nvl(uscc,'')<>''
)t1 where rn=1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024060791_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060791_CST_05 AS
SElECT t1.cst_id,t1.cst_nm,t1.org_nm,t1.acs_mngr_nm
    ,t1.ctr_amt,t1.ctr_bal
    ,t2.vlg_cty_ind
    ,t3.fm_ind,t3.ind_bus_ind,t3.is_uscc,t3.reg_adr,t3.fml_adr
    ,t4.entp_nm
    ,case when  m.operate_cust_type_cbrc='A'  and substr(n.acct_typ,1,4)='0102' then '个体工商户'
        when  m.operate_cust_type_cbrc='B'  and substr(n.acct_typ,1,4)='0102'  then  '小微企业主'
        else  '其他'
        end  as  CBRC个人经营性
from(
    SElECT cst_id,cst_nm,acs_mngr_nm,org_nm
        ,sum(ctr_amt) ctr_amt           --合同金额|DECIMAL(20,2)
        ,sum(ctr_bal) ctr_bal           --合同余额|DECIMAL(20,2)
    from SJXQ_SJ2024060791_CST_01
    group by cst_id,cst_nm,acs_mngr_nm,org_nm
)t1 left join SJXQ_SJ2024060791_CST_02   t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024060791_CST_03          t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024060791_CST_04          t4
on t1.cst_id=t4.cst_id
LEFT JOIN  adm_upss.l_cust_p as m
        ON     t1.cst_id=m.cust_id
        and m.dt='20240531'
left join  (
     SELECT DISTINCT cust_id,acct_typ
     from  adm_upss.l_acct_loan
     where dt='20240531'
     and   substr(acct_typ,1,4)='0102' --经营性
 ) as n
        on  t1.cst_id=n.cust_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024060791_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024060791_CST_06 AS
SElECT cst_id 							客户号
    ,cst_nm                             客户名称
    ,org_nm                             管护机构
    ,acs_mngr_nm                        管护客户经理
    ,ctr_amt                            授信总额
    ,ctr_bal                            贷款余额_20240531
    ,if(fm_ind='1','是','')             是否农户
    ,if(vlg_cty_ind='1','农村','')      农村城市标志
    ,CBRC个人经营性
    ,ind_bus_ind                        是否个体工商户户主
    ,entp_nm                            外部关联企业名称
    ,reg_adr                            注册地址
    ,fml_adr                            居住地址
    ,is_uscc                            是否有统一社会信用代码
from SJXQ_SJ2024060791_CST_05
;
SELECT *
from SJXQ_SJ2024060791_CST_06***SJ20240612106_随贷通卡风险管理.sql
-- 当前未到期未终结客户有授信金额的客户 非随贷通
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_01 AS
SELECT  distinct t1.cst_id             --客户号
FROM edw.dim_bus_loan_ctr_inf_dd t1 --信贷合同信息
WHERE t1.dt = '20240611'
and nvl(t1.cst_id,'')<>''
AND(
    (
        (t1.ctr_bal > 0 OR (t1.ctr_bal IS NULL AND nvl(t1.crc_ind,'0')='0')   --非循环贷有余额
            OR((nvl(t1.crc_ind, '0') <> '0' OR t1.pd_cd LIKE '2010503%')      --随贷通
                AND (t1.ctr_bal = 0 OR t1.ctr_bal IS NULL)
                AND t1.apnt_mtu_dt >= '20240611'
            ) --（循环贷 或 随贷通） 且 余额为0 且 未到期
        ) AND nvl(t1.frz_sts_cd,'') NOT IN ( '3' , '4' ) --3到期失效 4终止失效
    ) OR (t1.ctr_bal > 0 AND t1.pd_cd LIKE '2010503%'
        AND t1.apnt_mtu_dt <= '20240611'
        AND t1.frz_sts_cd IN ( '3' , '4' )
    ) --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
) --未终结、未到期业务
and t1.ctr_amt<>0                   --当前有授信金额
and t1.pd_cd not like '2010503%'    --剔除随贷通
;
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_02 AS
select t1.lmt_sts_cd                            --额度状态代码|C32
	,t1.bus_ctr_id                              --业务合同编号|C32
	,t1.eft_dt                                  --生效日期|C8
    ,t1.norm_intr_rat	                        --正常利率|DECIMAL(20,2)
    ,t1.cmpd_intr_rat	                        --复利利率|DECIMAL(20,2)
	,t1.crd_lmt                                 --授信额度|DECIMAL(20,2)
	,t1.bind_lmt                                --绑定额度|DECIMAL(20,2)
	,t1.use_lmt                                 --已用额度|DECIMAL(20,2)
	,t1.cst_id                                  --客户号|C20
	,t2.acs_org_id                              --管护机构编号|C12
	,t2.acs_mngr_id                             --管户客户经理编号|C32
    ,t3.org_nm
    ,t5.cst_chn_nm
    ,t6.hgh_cr_lmt_amt	                        --最高授信额度
    ,t8.nocontinuereson                         --不续贷原因说明
    ,t9.IDV_CRD_SCO_VAL
from edw.dwd_bus_loan_fnc_crd_lmt_inf_dd    t1 --随贷通授信额度信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同`管户`信息
on t1.bus_ctr_id=t2.busi_ctr_id
and t2.dt='20240611'
INNER join  edw.dim_hr_org_mng_org_tree_dd  t3 --考核机构树 4481 org_id 唯一
on t2.acs_org_id = t3.org_id
and t3.dt = '20240611'
and t3.BRC_ORG_NM='绍兴分行'
left join SJXQ_SJ20240612106_CST_01         t4
on t1.cst_id=t4.cst_id
left join edw.dws_cst_bas_inf_dd            t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt = '20240611'
left join edw.edw_old_smy_fnc_svc_db_crd_ar_smy t6 --随贷通账务信息表
on t1.bus_ctr_id=t6.ln_lmt_ctr_id
and t6.dt='20240611'
left join  edw.loan_business_entryform      t7  --续贷表
on   t1.bus_ctr_id=t7.oldcontractno
and  t7.dt ='20240611'
left join  edw.loan_entryform_register      t8  --续贷表
on   t7.SerialNo=t8.RelativeSerialNo
and  t8.iscontinue = '050'
and  t8.dt ='20240611'
left join(
    SELECT T1.CST_ID
        ,T1.IDV_CRD_SCO_VAL
        ,ROW_NUMBER() OVER (PARTITION BY T1.CST_ID ORDER BY  REPORT_NO DESC ) AS RN
    FROM edw.dws_cst_ccrc_idv_ind_inf_dd t1 -- 个人征信分
    WHERE T1.DT = '20240611'
)t9 on t1.cst_id=t9.cst_id
and t9.rn=1
where t1.dt='20240611'
and t4.cst_id is null   --仅随贷通
;
-- 历史首次办理随贷通
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_02_1 AS
select t1.cst_id                             --客户编号|C20
    ,t1.busi_ctr_id                          --业务合同编号
	,t1.apnt_start_dt    fst_eft_dt          --约定开始日期|C8
    ,row_number() over(partition by t1.cst_id order by t1.apnt_start_dt) rn
FROM edw.dim_bus_loan_ctr_inf_dd        t1 --信贷合同信息
where t1.dt='20240611'
and t1.pd_cd like '2010503%'   --剔除随贷通
;
-- 6月11日前到期贷款到期客户 剔除随贷通
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_03 AS
select t1.busi_ctr_id                              --业务合同编号|C32
	,t1.busi_apl_id                              --业务申请编号|C32
	,t1.crd_ctr_id                               --授信合同编号|C32
	,t1.pd_cd                                    --产品代码|C4
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.ref_mon_intr_rat                         --参考月利率|DECIMAL(14,8)
	,t1.intr_rat                                 --利率|DECIMAL(14,8)
	,t1.end_dt                                   --终结日期|C8
	,t1.bus_cd                                   --业务标识代码|C32
	,t1.frz_sts_cd                               --冻结状态代码|C1
	,t1.inp_dt                                   --输入日期|C8
	,t1.ctr_typ                                  --合同类型|C10
	,t1.prcp_pyf_dt                              --本金结清日期|C10
	,t1.bus_typ                                  --业务类型|C10
    ,c1.cd_val_dscr     bus_typ_nm
	,CASE WHEN t1.end_dt = '18991231' THEN nvl(t1.apnt_mtu_dt, '') ELSE nvl(t1.end_dt, '') END mtu_dt --到期日期|C10
    ,t2.pd_nm
    ,row_number() over(partition by t1.cst_id order by CASE WHEN t1.end_dt = '18991231' THEN nvl(t1.apnt_mtu_dt, '') ELSE nvl(t1.end_dt, '') END desc) rn
FROM edw.dim_bus_loan_ctr_inf_dd        t1 --信贷合同信息
left join edw.dim_bus_loan_pd_inf_dd 	t2 --信贷产品信息
on  t1.pd_cd=t2.pd_cd
and t2.dt='20240611'
LEFT JOIN edw.dwd_code_library_dd       c1
ON  t1.bus_typ = c1.cd_val
AND c1.tbl_nm = 'BUSINESS_CONTRACT'
AND c1.fld_nm = 'BUSINESSTYPECLASS'
AND c1.dt = '20240611'
where t1.dt='20240611'
and t1.pd_cd not like '2010503%'   --剔除随贷通
AND CASE WHEN t1.end_dt = '18991231' THEN nvl(t1.apnt_mtu_dt, '') ELSE nvl(t1.end_dt, '') END <= '20240611'
;
-- 预评估结果_随贷通
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_04 AS
select B.cst_ID,b.cst_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,B.BUSI_APL_ID
    ,c.pre_apl_srl_nbr
    ,D.PREEVALUATERESULT                    pre_ases_res_CD
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT end        pre_ases_res
from edw.DIM_BUS_LOAN_CTR_INF_DD        B --信贷合同信息
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20240611'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20240611'
LEFT JOIN (
    SELECT BUS_CTR_ID,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
        ,sum(prcp_bal) LOAN_BAL     --本金余额
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT ='20240611'
    GROUP BY DT,BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
WHERE NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND   B.DT ='20240611'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_05 AS
select decode(t1.lmt_sts_cd,'0','正常','3','未激活','4','止付')  lmt_sts_nm   --额度状态
	,t1.bus_ctr_id                              --业务合同编号|C32
	,t1.eft_dt                                  --生效日期|C8
    ,t1.norm_intr_rat	                        --正常利率|DECIMAL(20,2)
    ,t1.cmpd_intr_rat	                        --复利利率|DECIMAL(20,2)
	,t1.crd_lmt                                 --授信额度|DECIMAL(20,2)
	,t1.bind_lmt                                --绑定额度|DECIMAL(20,2)
	,t1.use_lmt                                 --已用额度|DECIMAL(20,2)
	,t1.cst_id                                  --客户号|C20
	,t1.acs_org_id                              --管护机构编号|C12
	,t1.acs_mngr_id                             --管户客户经理编号|C32
    ,t1.org_nm
    ,t1.cst_chn_nm
    ,t1.hgh_cr_lmt_amt	                        --最高授信额度
    ,t1.nocontinuereson                         --不续贷原因说明
    ,t1.IDV_CRD_SCO_VAL
    ,t2.busi_ctr_id                              --业务合同编号|C32
	,t2.ctr_amt                                  --合同金额|DECIMAL(20,2)
    ,t2.bus_typ_nm
	,t2.mtu_dt                                  --到期日期|C10
    ,t2.pd_nm
    ,t3.pre_ases_res
    ,case when t4.cst_id is not null then '是' else '' end is_chufa
    ,T4.tsk_mak_dt
    ,T4.brk_rsn                                     --精准贷后触发内容
    ,t5.fst_eft_dt
from SJXQ_SJ20240612106_CST_02      t1 --客群
LEFT join SJXQ_SJ20240612106_CST_03 t2 --到期贷款
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ20240612106_CST_04 t3 --预评估结果
on t1.bus_ctr_id=t3.BUSI_CTR_ID
left JOIN(
    select cst_ID,tsk_mak_dt,brk_rsn
        ,row_number() OVER (PARTITION BY cst_id ORDER BY tsk_mak_dt DESC) rn
    from edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd
    where dt = '20240611'
) T4 --精准贷后结果信息表
ON  t1.cst_id = T4.cst_id
AND T4.rn=1
left join SJXQ_SJ20240612106_CST_02_1 t5
on t1.cst_ID=t5.cst_ID
and t5.rn=1
;
-- 输出结果1 贷款到期前，客户有随贷通卡
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_06 AS
SELECT  cst_id              AS 客户号
       ,cst_chn_nm          AS 客户姓名
       ,acs_org_id          AS 信贷管户机构号
       ,acs_mngr_id         AS 管户客户经理工号
       ,busi_ctr_id         AS 到期合同号
       ,bus_typ_nm          AS 到期业务类型
       ,pd_nm               AS 到期产品名称
       ,ctr_amt             AS 到期合同金额
       ,bus_ctr_id          AS 合同号_随贷通
       ,eft_dt              as 生效日期_随贷通
       ,lmt_sts_nm          AS 授信状态_随贷通
       ,norm_intr_rat       AS 正常利率_随贷通
       ,cmpd_intr_rat       AS 复利利率_随贷通
       ,hgh_cr_lmt_amt      AS 最高授信额度_随贷通
       ,crd_lmt             AS 授信额度_随贷通
       ,pre_ases_res        AS 预评估结果_随贷通
       ,is_chufa            AS 是否触发精准贷后
       ,tsk_mak_dt          AS 触发日期
       ,brk_rsn             AS 触发内容
       ,IDV_CRD_SCO_VAL     AS 征信分
       ,nocontinuereson     AS 不续贷原因
       ,mtu_dt             as 最近贷款到期日
       ,fst_eft_dt          as 首笔随贷通生效日
from SJXQ_SJ20240612106_CST_05
where mtu_dt > fst_eft_dt
;
-- 输出结果2 贷款到期前，客户没有随贷通卡
DROP   TABLE IF     EXISTS SJXQ_SJ20240612106_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240612106_CST_07 AS
SELECT  cst_id              AS 客户号
       ,cst_chn_nm          AS 客户姓名
       ,acs_org_id          AS 信贷管户机构号
       ,acs_mngr_id         AS 管户客户经理工号
       ,busi_ctr_id         AS 到期合同号
       ,bus_typ_nm          AS 到期业务类型
       ,pd_nm               AS 到期产品名称
       ,ctr_amt             AS 到期合同金额
       ,bus_ctr_id          AS 合同号_随贷通
       ,eft_dt              as 生效日期_随贷通
       ,lmt_sts_nm          AS 授信状态_随贷通
       ,norm_intr_rat       AS 正常利率_随贷通
       ,cmpd_intr_rat       AS 复利利率_随贷通
       ,hgh_cr_lmt_amt      AS 最高授信额度_随贷通
       ,crd_lmt             AS 授信额度_随贷通
       ,pre_ases_res        AS 预评估结果_随贷通
       ,is_chufa            AS 是否触发精准贷后
       ,tsk_mak_dt          AS 触发日期
       ,brk_rsn             AS 触发内容
       ,IDV_CRD_SCO_VAL     AS 征信分
       ,nocontinuereson     AS 不续贷原因
       ,mtu_dt              as 最近贷款到期日
       ,fst_eft_dt          as 首笔随贷通生效日
from SJXQ_SJ20240612106_CST_05
where mtu_dt <= fst_eft_dt
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240612106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240612106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240612106_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct BUSI_CTR_ID) custs
from SJXQ_SJ20240612106_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240612106_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240612106_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240612106_CST_07
;
/*
01	447841	447841
02	13232	13232
03	1366099	1366099
04	5603882	5603882
05	13232	13232
06	1418	1418
07	2183	2183
01	447841	447841
02	13232	13232
03	1366099	1366099
04	5603882	5603882
05	13232	13232
06	2013	2013
07	1588	1588
绍兴分行
6.11 随贷通状态为 正常、未激活、止付，且 仅随贷通授信客户
需求1: 贷款到期前，客户有随贷通卡
需求2：贷款到期前，客户没有随贷通卡
1. 仅随贷通授信：当前持有随贷通，其他贷款到期或终结 算 仅随贷通授信客户吗？算
不续贷原因
SELECT er.nocontinuereson FROM ENTRYFORM_REGISTER er where er.iscontinue = '050';
*/
***SJ2024061271_母亲节贵金属外呼.sql
DROP   TABLE IF EXISTS SJXQ_SJ2024061271_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024061271_CST_01
(
cst_id	    string --客户号
,cst_chn_nm	string --客户姓名
,kf_id	    string --客服人员工号
,kf_nm	    string --客服人员姓名
,cal_tm	    string --通话时长
,ans_sts	string --呼叫状态
,deal_rsl	string --处理结果
)
;
insert into SJXQ_SJ2024061271_CST_01
values
;
-- 客户基础信息
DROP   TABLE IF EXISTS SJXQ_SJ2024061271_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2024061271_CST_02 as
SElECT t1.cst_id
    ,t2.age,decode(t2.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t3.aum_mon_avg	    --AUM月日均
    ,T4.PRM_MGR_ID,T4.PRM_MGR_NM,T4.PRM_ORG_ID
    ,T5.BRC_ORG_NM,T5.SBR_ORG_NM,T5.TEM_ORG_NM,T5.ORG_NM
from SJXQ_SJ2024061271_CST_01                   t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240610'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t3 --客户金融资产信息表
on t1.cst_id=t3.cst_id
and t3.dt='20240610'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t4 --客户`主管户`信息
on  t1.cst_id = t4.cst_id
and t4.dt = '20240610'
left join edw.dim_hr_org_mng_org_tree_dd            t5 --考核机构树
on  t4.prm_org_id = t5.org_id
and t5.dt = '20240610'
;
--近六个月手机银行登录次数
DROP   TABLE IF EXISTS SJXQ_SJ2024061271_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ2024061271_CST_03 as
select alg_userid       as cst_id
    ,count(1)           as LOGIN_CNT
from edw.ebnk_mb_audit_log
where dt>'20240510'
and dt<='20240610'  --取近一个月
and ALG_BSNCODE='100001'
AND ALG_ERRORCODE IS NULL
and ALG_SYSID ='MBC'
AND LENGTH(ALG_USERID) = 10
group by alg_userid
;
-- 贵金属交易明细 贵金属成功购买交易
DROP   TABLE IF EXISTS SJXQ_SJ2024061271_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ2024061271_CST_04 as
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源 历史导入+金城
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,LENGTH(ORD_TM) ORD_TM_LEN
    ,CASE WHEN cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '20240610'
AND replace(ORD_TM,'-','') >='20211201'   --交易时间
AND replace(ORD_TM,'-','') <='20240610'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号    均为无
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源 退款手工导入+柜面手工导入
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,LENGTH(ORD_TM) ORD_TM_LEN
    ,CASE WHEN ORD_TM like '%.%' OR ORD_TM like '%/%' OR LENGTH(ORD_TM)=8 OR cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '20240610'
AND replace(ORD_TM,'-','') >='20211201'   --交易时间
AND replace(ORD_TM,'-','') <='20240610'   --交易时间
;
-- 字段汇总
DROP   TABLE IF EXISTS SJXQ_SJ2024061271_CST_05 PURGE;
CREATE TABLE           SJXQ_SJ2024061271_CST_05 as
SElECT t1.cst_id	        --客户号
    ,t1.cst_chn_nm	        --客户姓名
    ,t1.kf_id	            --客服人员工号
    ,t1.kf_nm	            --客服人员姓名
    ,t1.cal_tm	            --通话时长
    ,t1.ans_sts	            --呼叫状态
    ,t1.deal_rsl	        --处理结果
    ,t2.age,t2.gdr_nm ,t2.aum_mon_avg
    ,T2.BRC_ORG_NM,T2.SBR_ORG_NM
    ,t3.LOGIN_CNT
    ,t4.TRX_DT  --订单时间
    ,t4.CMDT_NM --商品名称
    ,t4.TRX_AMT --商品应付现金总额
    ,t5.TRX_AMT_tot
from SJXQ_SJ2024061271_CST_01       t1
left join SJXQ_SJ2024061271_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024061271_CST_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024061271_CST_04  t4
on t1.cst_id=t4.cst_id
and t4.TRX_DT >= '20240510'     -- 此处包含 20240510
left join(
    SElECT cst_id,sum(TRX_AMT)  TRX_AMT_tot
    from SJXQ_SJ2024061271_CST_04
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ2024061271_CST_06 PURGE;
CREATE TABLE           SJXQ_SJ2024061271_CST_06 as
SElECT cst_id	        客户号
    ,cst_chn_nm	        客户姓名
    ,gdr_nm             性别
    ,age                年龄
    ,aum_mon_avg        AUM日均
    ,LOGIN_CNT          近30天手机银行登录次数
    ,TRX_AMT_tot        贵金属累计购买金额
    ,CMDT_NM            购买产品名称
    ,TRX_DT             购买时间
    ,TRX_AMT            购买金额
    ,kf_id	            客服人员工号
    ,kf_nm	            客服人员姓名
    ,cal_tm	            通话时长
    ,ans_sts	        呼叫状态
    ,deal_rsl	        处理结果
    ,BRC_ORG_NM         主管户分行
    ,SBR_ORG_NM         主管户支行
from SJXQ_SJ2024061271_CST_05
;
***SJ2024061376_台州分行柜台重复业务清单.sql
-- 20230101-20240612的台州分行辖内所有支行含总行营业部，客户当天重复来营业厅办理业务的信息、支行晚于营业结束后发生客户业务的信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024061376_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061376_CST_01 AS
SELECT t1.cst_act_id                             --客户账号|C32
    ,t1.dep_act_id                               --存款账号|C32
	,t1.trx_dt                                   --交易日期|C8
	,substr(t1.trx_tm,1,6)    trx_tm             --交易时间|C9
	,t1.crd_and_dbt_ind                          --借贷标志|C1
	,t1.trx_amt                                  --交易金额|DECIMAL(21,2)
	,t1.txt_code                                 --摘要代码|C10
	,t1.smr_dscr                                 --摘要描述|C512
	,t1.trx_chnl_cd                              --交易渠道代码|C3
    ,c1.cd_val_dscr     trx_chnl_nm
	,t1.tlr_srl_nbr                              --柜员流水号|C32
	,t1.trx_bus_org                              --交易营业机构|C12
    ,t1.opn_org                                  --开户机构|C12
    ,t3.ORG_NM
	,t1.opr_tlr                                  --操作柜员|C10
    ,t4.empe_nm         opr_tlr_nm
	,t1.cmt                                      --备注|C200
	,t1.act_nm          act_nm2                  --账户名称|C200
	,t1.bal_fld_nm                               --余额字段名称|C32
	,t1.prod_id                                  --产品编号|C24
	,t2.cst_id                                   --客户号|C20
	,t2.act_nm                                   --账户名称|C300
    ,if(T7.srl_nbr is NULL,'否','是')   是否抵现交易
from edw.dwd_bus_dep_bal_chg_dtl_di         t1
left join edw.dws_bus_dep_act_inf_dd        t2
on t1.dep_act_id=t2.dep_act_id
and t2.dt='20240612'
left join edw.dim_hr_org_mng_org_tree_dd    t3 --考核机构树
on  t1.trx_bus_org=t3.org_id
and t3.dt='20240612'
left join edw.dwd_code_library_dd           c1
on t1.trx_chnl_cd=c1.cd_val
and c1.dt='20240612'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t1.opr_tlr=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN edw.dwd_bus_chnl_cnt_alc_mny_trx_dtl_di T7 --配钞交易明细
ON      T1.tlr_srl_nbr = T7.srl_nbr
AND     T1.trx_dt  =  T7.trx_dt
AND     T1.trx_amt =  T7.unt_amt
AND     T7.dt between '20230101' and '20240612'
AND     T7.par_typ = '抵现'
where t1.dt between '20230101' and '20240612'
AND (T1.trx_bus_org like  '3301%' or T1.trx_bus_org='999900099') --台州分行、总行营业部
and t1.trx_amt<>0   --金额变动
;
-- 输出结果1 晚于营业结束办理
DROP   TABLE IF     EXISTS SJXQ_SJ2024061376_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061376_CST_02 AS
SELECT  trx_bus_org     AS 交易营业机构ID
       ,ORG_NM          AS 交易营业机构
       ,cst_id          AS 客户号
       ,act_nm          AS 账户名称
       ,cst_act_id      AS 客户账号
       ,dep_act_id      AS 存款账号
       ,trx_dt          AS 交易日期
       ,trx_tm          AS 交易时间
       ,trx_chnl_nm     AS 交易渠道
       ,txt_code        AS 摘要代码
       ,smr_dscr        AS 摘要描述
       ,crd_and_dbt_ind AS 借贷标志
       ,trx_amt         AS 交易金额
       ,opr_tlr         AS 操作柜员
       ,opr_tlr_nm      AS 柜员名称
       ,tlr_srl_nbr     AS 柜员流水号
       ,cmt             AS 备注
       ,bal_fld_nm      AS 余额字段名称
       ,prod_id         AS 产品编号
       ,是否抵现交易
       ,row_number() over(partition by cst_id,trx_dt,trx_tm) rn
from SJXQ_SJ2024061376_CST_01
where trx_tm>='170000'
;
-- 输出结果2 当天重复办理业务
DROP   TABLE IF     EXISTS SJXQ_SJ2024061376_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061376_CST_03 AS
SELECT  t1.cst_id                          AS 客户号
       ,t1.act_nm                          AS 客户姓名
       ,t3.doc_nbr                         AS 证件号
       ,t1.opn_org                         AS 开户机构ID
       ,t4.ORG_NM                          AS 开户机构
       ,t1.trx_dt                          AS 17点后交易日期
       ,t1.trx_tm                          AS 17点后交易时间
       ,t1.trx_amt                         AS 17点后交易金额
       ,t1.trx_chnl_nm                     AS 17点后交易渠道
       ,t1.smr_dscr                        AS 17点后摘要描述
       ,t1.ORG_NM                          AS 17点后交易营业机构
       ,coalesce(t1.opr_tlr_nm,t1.opr_tlr) AS 17点后操作柜员
       ,t1.cst_act_id                      AS 客户账号
       ,t2.trx_dt                          AS 17点前交易日期
       ,t2.trx_tm                          AS 17点前交易时间
       ,t2.trx_amt                         AS 17点前交易金额
       ,t2.trx_chnl_nm                     AS 17点前交易渠道
       ,t2.smr_dscr                        AS 17点前摘要描述
       ,t2.ORG_NM                          AS 17点前交易营业机构
       ,coalesce(t2.opr_tlr_nm,t2.opr_tlr) AS 17点前操作柜员
       ,t5.own_empe_ind                    as 是否本行员工
       ,(substr(t1.trx_tm,1,2)-substr(t2.trx_tm,1,2))*60 + substr(t1.trx_tm,3,2) - substr(t2.trx_tm,3,2) as 时间差分钟
       ,row_number() over(partition by t1.cst_id,t1.trx_dt,t1.trx_tm,t2.trx_dt,t2.trx_tm) rn
from SJXQ_SJ2024061376_CST_01           t1
inner join SJXQ_SJ2024061376_CST_01     t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
and t2.trx_tm < '170000'
left join edw.dws_cst_bas_inf_dd        t3
on t1.cst_id=t3.cst_id
and t3.dt='20240612'
left join edw.dim_hr_org_mng_org_tree_dd t4 --考核机构树
on  t1.opn_org=t4.org_id
and t4.dt='20240612'
left join edw.dws_cst_idv_bas_inf_dd  	t5 --个人客户基本信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='20240612'
where t1.trx_tm>='170000'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,trx_dt,trx_tm) custs
from SJXQ_SJ2024061376_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号,交易日期) custs
from SJXQ_SJ2024061376_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号,17点后交易日期) custs
from SJXQ_SJ2024061376_CST_03
;
/*
01	3895570	3201742
02	140314	96103
03	134848	12901
*/***SJ2024061441_金华分行内部客群分析.sql
-- 客群（含非正式客户）
DROP   TABLE IF     EXISTS SJXQ_SJ2024061441_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061441_CST_01 AS
select t1.cst_id                                    --客户编号
	,t1.aum_mon_avg                                 --客户当月综合金融资产(aum)月日均
    ,t1.fund_mon_avg_amt	                        --基金金额月日均
    ,t1.fnc_mon_avg_amt	                            --理财金额月日均
    ,t1.gold_mon_avg_amt	                        --贵金属金额月日均
    ,t1.insu_mon_avg_amt	                        --保险保费月日均
    ,t1.wlth_mon_avg	                            --财富资产余额月日均
    ,decode(t2.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星','') aum_grd_nm
    ,T3.PRM_MGR_ID,T3.PRM_MGR_NM,T3.PRM_ORG_ID
    ,T4.BRC_ORG_ID,T4.SBR_ORG_ID,T4.TEM_ORG_ID
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t5.OPN_DT_MIN  jjk_opn_dt
    ,t6.sub_cmnt_id                 --子社区编号
    ,t7.cmnt_nm   sub_cmnt_nm       --社区名称
from adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd  t1 --客户集市-业务信息-客户金融资产信息表
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd t2 --客户等级信息 16065131 cst_id 唯一
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm = '金华分行'
LEFT JOIN
(
	SELECT  CST_ID
	       ,MIN(OPN_DT) OPN_DT_MIN
	FROM EDW.DIM_BUS_DEP_CST_ACT_INF_DD --客户存款账户信息
	WHERE DT = '@@{yyyyMMdd}'
	AND CST_ACT_TYP_CD = '1' --卡
	AND CST_ID <> ''
	GROUP BY  CST_ID
) T5 ON T5.CST_ID = T1.CST_ID
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.aum_mon_avg>=5000
;
-- 理财最近一次签约
DROP   TABLE IF     EXISTS SJXQ_SJ2024061441_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061441_CST_02 AS
select a.cst_id
        ,coalesce(h1.trx_dt, h2.trans_date, '') 最近一次签约日期
        ,coalesce(h1.trx_chl, h2.channel, '')   最近一次签约渠道
from SJXQ_SJ2024061441_CST_01                   a
LEFT JOIN
(
	SELECT  t.cst_id
	       ,t.trx_dt
	       ,t.trx_chl
	       ,t.bnk_act_id
	FROM
	(
		SELECT  t1.cst_id
		       ,t1.trx_dt
		       ,t1.trx_chl
		       ,t1.bnk_act_id
		       ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id ORDER BY  t1.trx_dt DESC ,t1.trx_tm DESC ) rnk
		FROM edw.dwd_bus_chm_trx_act_req_dtl_di t1 --理财账户类请求交易流水
		WHERE dt <= '@@{yyyyMMdd}'
		AND t1.trx_cd = '100001'
		--AND t1.trx_chl = '6'
		AND t1.trx_sts IN ( '8' , 'S' )
		AND t1.cst_id <> ''
	) t
	WHERE t.rnk = 1
) h1 --最近一次签约1
ON h1.cst_id = a.cst_id
LEFT JOIN
(
	SELECT  t.client_no
	       ,t.trans_date
	       ,t.channel
	       ,t.bank_acc
	FROM
	(
		SELECT  t1.client_no
		       ,t1.trans_date
		       ,t1.channel
		       ,t1.bank_acc
		       ,ROW_NUMBER() OVER ( PARTITION BY t1.client_no ORDER BY  t1.trans_date DESC ,t1.trans_time DESC ) rnk
		FROM edw.finc_tbaccreq t1
		WHERE t1.dt = '@@{yyyyMMdd}'
		AND t1.trans_code = '100001'
		AND t1.client_no = ''
		AND status IN ( '8' , 'S' )
	) t
	WHERE t.rnk = 1
) h2 --最近一次签约（补充）
ON h2.client_no = a.cst_id
;
--其余字段
DROP   TABLE IF     EXISTS SJXQ_SJ2024061441_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061441_CST_03 AS
SElECT t1.cst_id
    ,decode(t2.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','') cst_seg_flg_nm
    ,decode(t2.cst_seg_sps_flg,'1','企业主配偶','2','个体工商户配偶','')    cst_seg_sps_flg_nm
    ,t3.age
    ,decode(t3.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t3.mrg_situ_cd	            --婚姻状况
    ,decode(t3.mrg_situ_cd,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','')  mrg_situ
    ,t3.chd_nbr	                --子女数
    ,t3.ocp_cd	                --职业代码
    ,c1.cd_val_dscr     ocp_nm
    ,t3.job_unt_nm              --工作单位名称
    ,t4.rsk_lvl_cd
    ,t5.pd_hld_nbr	            --产品持有数
    ,CASE WHEN t6.cst_id IS NULL THEN '否' ELSE '是' END AS 是否持有信用卡
	,t7.efe_dep_cst_ind         --有效存款户标识
	,t7.efe_loan_cst_ind        --有效信贷户标识
	,t7.efe_chm_cst_ind         --有效理财户标识
	,t7.efe_wlth_cst_ind        --有效财富户标识
	,t7.efe_insu_cst_ind        --有效保险户标识
	,t7.efe_nob_met_cst_ind     --有效贵金属户标识
	,t7.efe_fnd_cst_ind         --有效基金户标识
    ,t8.hpn_dt,t8.ctr_amt
from SJXQ_SJ2024061441_CST_01                   t1
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t2 --客户标签信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t3 --对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd               c1
on  t3.ocp_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_chm_cst_rsk_ases_dd	    t4 --理财客户风险评估结果表
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd	t5 --客户集市-标签信息-客户持有产品信息表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  DISTINCT f1.cst_id --客户号
	FROM edw.dim_bus_crd_cr_crd_inf_dd f1 --信用卡卡片信息
	WHERE f1.dt = '@@{yyyyMMdd}'
	AND f1.CARD_STS_CD <> 'Q' --Q表示销卡申请
) t6 ON t1.cst_id = t6.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd       t7 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  cst_id --客户号
	       ,hpn_dt --发生日期
	       ,ctr_amt
	       ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY hpn_dt DESC) rn
	FROM edw.dim_bus_loan_ctr_inf_dd t --信贷合同信息
	WHERE dt = '@@{yyyyMMdd}'
    and nvl(cst_id,'')<>''
) t8 ON t1.cst_id = t8.cst_id
AND t8.rn = 1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024061441_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061441_CST_04 AS
select t1.cst_id 					客户号
    ,T1.SBR_ORG_ID                  主管户支行号
    ,T1.SBR_ORG_NM                  主管户支行名称
    ,T1.TEM_ORG_ID                  主管户团队号
    ,T1.TEM_ORG_NM                  主管户团队名称
    ,T1.PRM_MGR_ID                  主管户客户经理工号
    ,T1.PRM_MGR_NM                  主管户客户经理姓名
    ,t1.aum_grd_nm                  财富等级
    ,t3.age                         年龄
    ,t3.gdr_nm                      性别
    ,t3.mrg_situ                    婚姻状态
    ,t3.chd_nbr                     子女数
    ,t3.rsk_lvl_cd                  最近一次理财风险评级
    ,t2.最近一次签约渠道             最近一次理财签约渠道
    ,t1.jjk_opn_dt                  第一次借记卡开卡时间
    ,t3.ocp_nm                      职业
    ,t3.cst_seg_flg_nm              客群标签
    ,t3.cst_seg_sps_flg_nm          客群配偶标签
    ,t3.pd_hld_nbr                  产品持有数
    ,t3.是否持有信用卡
	,t3.efe_dep_cst_ind             有效存款户标识
	,t3.efe_loan_cst_ind            有效信贷户标识
	,t3.efe_chm_cst_ind             有效理财户标识
	,t3.efe_wlth_cst_ind            有效财富户标识
	,t3.efe_insu_cst_ind            有效保险户标识
	,t3.efe_nob_met_cst_ind         有效贵金属户标识
	,t3.efe_fnd_cst_ind             有效基金户标识
    ,t3.hpn_dt                      最近一笔贷款发放日期
    ,t3.ctr_amt                     最近一笔贷款发放金额
	,t1.aum_mon_avg                 AUM月日均
    ,t1.fund_mon_avg_amt            基金金额月日均
    ,t1.fnc_mon_avg_amt             理财金额月日均
    ,t1.gold_mon_avg_amt            贵金属金额月日均
    ,t1.insu_mon_avg_amt            保险保费月日均
    ,t1.wlth_mon_avg                财富资产余额月日均
    ,t3.job_unt_nm                  工作单位名称
    ,t1.sub_cmnt_nm                 客户挂靠子社区
from SJXQ_SJ2024061441_CST_01       t1
left join SJXQ_SJ2024061441_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024061441_CST_03  t3
on t1.cst_id=t3.cst_id
;
-- 理财最近一次签约
DROP TABLE IF EXISTS SJXQ_SJ2024061441_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061441_CST_02 AS
SELECT  a.cst_id
       ,coalesce(T.trx_dt,'')      AS 最近一次签约日期
       ,coalesce(B.cd_val_dscr,'') AS 最近一次签约渠道
FROM SJXQ_SJ2024061441_CST_01 a
LEFT JOIN
(
	SELECT  cst_id
	       ,trx_chnl_cd
	       ,trx_dt,trx_tm
	       ,substr(smr_cmt,- 2,1) finc_rsk_grd
	       ,REGEXP_EXTRACT(T1.smr_cmt,'总分\\[([0-9.]+)\\]',1) finc_rsk_sco
	       ,ROW_NUMBER() OVER ( PARTITION BY CST_ID ORDER BY  trx_dt DESC ,trx_tm DESC ,substr(smr_cmt,- 2,1) DESC ) AS RN
	FROM wb_bigdata_manager_dev.dsj_v_dwd_bus_chm_trx_rqs_srl_dtl_di t1 --理财交易请求流水明细
	WHERE dt >= '20240630'
	AND t1.trx_cd IN ( '100353' , '100010' ) --交易代码:100353客户风险等级评估, 100010客户风险等级修改
) T
ON T.cst_id = A.cst_id
AND T.RN = '1'
LEFT JOIN wb_bigdata_manager_dev.dsj_v_dwd_code_library_dd B
ON T.trx_chnl_cd = B.cd_val
AND B.DT = '20240630'
***SJ2024061731_理财系统与ecif不一致数据.sql
-- 理财系统 客户信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2024061731_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061731_CST_01 AS
select t1.in_client_no	    cst_id              --客户编号
    ,t1.id_type                                 --证件类型
	,t1.id_code                                 --证件号码
	,t1.id_code_date                            --证件有效截止日期
	,t2.doc_nbr                                 --证件号码|C60
	,t2.doc_typ_cd                              --证件类型代码|C5
	,t2.doc_mtu_dt                              --证件到期日期|C8
from edw.finc_tbclient              t1          --客户信息表
left join edw.dws_cst_bas_inf_dd    t2
on t1.in_client_no=t2.cst_id
and t2.dt='20240616'
where t1.dt='20240616'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024061731_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061731_CST_02 AS
SELECT  cst_id       AS 客户号
       ,id_type      AS 证件类型_理财系统
       ,id_code      AS 证件号码_理财系统
       ,id_code_date AS 证件有效期_理财系统
       ,doc_typ_cd   AS 证件类型_ECIF系统
       ,doc_nbr      AS 证件号码_ECIF系统
       ,doc_mtu_dt   AS 证件有效期_ECIF系统
FROM SJXQ_SJ2024061731_CST_01
WHERE id_type <> doc_typ_cd
or id_code <> doc_nbr
or id_code_date <> doc_mtu_dt
***SJ2024061741_保金取数.sql
/*
1. 贵金属业务清单
首饰金交易清单	2024.1.1-2024.6.15贵金属成交订单，首饰金成交客户画像报表:13024交易明细表首饰金:[佣金类型]=&ldquo;按克重&rdquo;且[商品分类]不等于&ldquo;投资金条&rdquo;或&ldquo;能猫金币&ldquo;
投资金交易清单	2024.1.1-2024.6.15，13024交易明细表，商品分类等于&ldquo;投资金条&quot;或&rdquo;熊猫金币&quot;
版画摆件交易清单	2024.1.1-2024.6.15，13024交易明细表，商品分类等于&ldquo;版画&quot;或&rdquo;摆件&quot;
财富等级：取购买日等级
是否有效信贷户：取购买日
是否有效存款户：取购买日
购买前后7天内新增贷款：有7天内新增贷款，写贷款金额（剔除信用卡）
所属客群：企业主、个体工商户、持家女性、工新、养老等等
贵金属业务问题：
1. 所在分行 所在支行 所在团队 是 主管户吗？推荐人的
2. 客户经理工号：推荐人 还是 主管户经理？推荐人
*/
-- 贵金属交易明细 贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST_01 AS
SELECT ORD_ID               --订单号
    ,replace(ORD_TM,'-','') TRX_DT --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间 可代替下单时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,ACCT_ID                --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源 历史导入+金城
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,LENGTH(ORD_TM) ORD_TM_LEN
    ,CASE WHEN cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
WHERE dt <= '20240615'
-- AND replace(ORD_TM,'-','') >='20240101'   --交易时间
AND replace(ORD_TM,'-','') <='20240615'   --交易时间
UNION ALL
SELECT ORD_ID               --订单号    均为无
    ,replace(ORD_TM,'-','') TRX_DT  --订单时间
    ,CST_ID                 --客户号
    ,CST_NM                 --客户名称
    ,USR_NM                 --用户名
    ,PVD_NM                 --商铺名称
    ,PST_MTH                --邮寄方式
    ,PMT_TM                 --付款时间
    ,PMT_MTH                --支付方式
    ,CHNL_NM                --渠道
    ,ORD_STS                --订单状态
    ,CMDT_NM                --商品名称
    ,CMDT_SPEC              --商品规格
    ,QTY                    --数量
    ,GOODS_TYP              --商品分类
    ,GOODS_RETURN_STATUS    --商品退款状态
    ,CMDT_UNT_PRC           --商品现金单价
    ,CMDT_PAY_UNT_PRC       --商品应付现金总额
    ,CMSN_TYP               --佣金类型
    ,MID_INC_RTO            --佣金比例/金额
    ,MID_INC_TOT_AMT        --佣金总额
    ,''                     --交易账号
    ,RCM_PSN_ID             --推荐人工号
    ,RCM_PSN_NM             --推荐人姓名
    ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
    ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
    ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
    ,RCM_PSN_AFL_BRN        --推荐人所属分行
    ,DATA_SRC               --数据来源 退款手工导入+柜面手工导入
    ,RCM_PSN_POS            --员工岗位
    ,DT
    ,LENGTH(ORD_TM) ORD_TM_LEN
    ,CASE WHEN ORD_TM like '%.%' OR ORD_TM like '%/%' OR LENGTH(ORD_TM)=8 OR cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
WHERE dt <= '20240615'
-- AND replace(ORD_TM,'-','') >='20240101'   --交易时间
AND replace(ORD_TM,'-','') <='20240615'   --交易时间
;
-- 购买前后7天内新增贷款金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST_02 AS
SELECT  a.cst_ID
       ,a.trx_dt
       ,B.BUSI_CTR_ID       --合同流水号
       ,B.CTR_AMT           --合同金额
       ,B.CTR_BAL           --合同余额
       ,C.REG_DT            --申请日期
       ,ABS(DATEDIFF(TO_DATE(C.REG_DT,'yyyyMMdd'),TO_DATE(A.trx_dt,'yyyyMMdd'),'dd')) AS DIFF_TM --贷款申请与交易间隔日期
FROM
(
	SELECT  distinct cst_ID
	       ,trx_dt
	FROM SJXQ_SJ2024061741_CST_01
    where IS_DEL=0 and trx_dt>='20240101'   --交易时间
) a inner JOIN edw.DIM_BUS_LOAN_CTR_INF_DD B --信贷合同信息
ON A.cst_ID = B.CST_ID
AND NVL(B.CST_ID, '') <> '' --剔除空值和空
AND B.CRC_IND <> '1' --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND B.DT = '@@{yyyyMMdd}'
inner JOIN edw.DWD_BUS_LOAN_APL_INF_DD C --信贷业务申请信息
ON B.BUSI_APL_ID = C.APL_ID --业务申请编号
AND NVL(C.APL_ID, '') <> '' --剔除空值和空
AND C.DT = '@@{yyyyMMdd}'
where ABS(DATEDIFF(TO_DATE(C.REG_DT,'yyyyMMdd'),TO_DATE(A.trx_dt,'yyyyMMdd'),'dd'))<=7
;
-- 客户基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST_03 AS
SElECT t1.cst_id,t1.trx_dt
    ,t2.age,decode(t2.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,decode(t3.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星','') aum_grd
    ,decode(t4.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') cst_seg_flg_nm
	,t5.efe_dep_cst_ind         --有效存款户标识
	,t5.efe_loan_cst_ind        --有效信贷户标识
    ,t6.CTR_AMT_7D
    ,t7.dep_bal	                --存款余额
    ,t7.loan_bal_acs	        --贷款余额
    ,t7.fnc_amt	                --理财余额
    ,t8.trx_days
FROM
(
	SELECT  distinct cst_ID
	       ,trx_dt
	FROM SJXQ_SJ2024061741_CST_01
    where IS_DEL=0 and trx_dt>='20240101'   --交易时间
)t1 left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240615'
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd       t3 --客户等级信息
on t1.cst_id=t3.cst_id
and t1.trx_dt=t3.dt
and t3.dt between '20240101' and '20240615'
left join adm_pub.adm_csm_clab_cst_jc_inf_dd        t4 --客户标签信息
on t1.cst_id=t4.cst_id
and t4.dt='20240615'
left join adm_pub.adm_csm_cbas_ind_inf_dd 		    t5 --客户基础标识信息
on t1.cst_id=t5.cst_id
and t1.trx_dt=t5.dt
and t5.dt between '20240101' and '20240615'
left join(
    SElECT cst_id,trx_dt,sum(CTR_AMT) CTR_AMT_7D
    from SJXQ_SJ2024061741_CST_02
    group by cst_id,trx_dt
)t6 on t1.cst_id=t6.cst_id
and t1.trx_dt=t6.trx_dt
left join app_rpt.adm_subl_cst_wlth_bus_inf_dd	    t7 --正式客户财富业务信息表
on t1.cst_id=t7.cst_id
and t1.trx_dt=TO_CHAR(DATEADD(TO_DATE(t7.dt,'yyyymmdd'),1,'dd'),'yyyymmdd')
and t7.dt between '20240101' and '20240615'
left join(
    SElECT cst_id,count(distinct trx_dt) trx_days
    from SJXQ_SJ2024061741_CST_01
    where IS_DEL=0
    group by cst_id
)t8 on t1.cst_id=t8.cst_id
;
-- 输出结果1 首饰金
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST_04 AS
SELECT  t1.TRX_DT              AS 购买日期
       ,t1.TRX_AMT             AS 购买金额
       ,t1.CMDT_NM             AS 商品名称
       ,t1.MID_INC_TOT_AMT     AS 佣金总额
       ,t1.PVD_NM              AS 商铺名称
       ,t1.CST_ID              AS 客户号
       ,t2.age                 AS 年龄
       ,t2.gdr_nm              AS 性别
       ,t1.RCM_PSN_AFL_DEPT    AS 推荐人所属部门团队
       ,t1.RCM_PSN_AFL_SUB_BRN AS 推荐人所属支行
       ,t1.RCM_PSN_AFL_BRN     AS 推荐人所属分行
       ,t1.RCM_PSN_ID          AS 推荐人工号
       ,t1.RCM_PSN_NM          AS 推荐人姓名
       ,t2.aum_grd             AS 财富等级
       ,t2.cst_seg_flg_nm      AS 所属客群
       ,t2.efe_loan_cst_ind    AS 有效信贷户标识
       ,t2.efe_dep_cst_ind     AS 有效存款户标识
       ,t2.CTR_AMT_7D          AS 购买前后7天内新增贷款金额
       ,t2.dep_bal             AS 购买前一日存款余额
       ,t2.loan_bal_acs        AS 购买前一日贷款余额
       ,t2.fnc_amt             AS 购买前一日理财余额
       ,t2.trx_days            AS 客户复购天数
from SJXQ_SJ2024061741_CST_01       t1
left join SJXQ_SJ2024061741_CST_03  t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
where IS_DEL=0 and t1.trx_dt>='20240101'   --交易时间
and t1.CMSN_TYP='按克重' --佣金类型
;
-- 输出结果2 投资金
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST_05 AS
SELECT  t1.TRX_DT              AS 购买日期
       ,t1.TRX_AMT             AS 购买金额
       ,t1.CMDT_NM             AS 商品名称
       ,t1.MID_INC_TOT_AMT     AS 佣金总额
       ,t1.PVD_NM              AS 商铺名称
       ,t1.CST_ID              AS 客户号
       ,t2.age                 AS 年龄
       ,t2.gdr_nm              AS 性别
       ,t1.RCM_PSN_AFL_DEPT    AS 推荐人所属部门团队
       ,t1.RCM_PSN_AFL_SUB_BRN AS 推荐人所属支行
       ,t1.RCM_PSN_AFL_BRN     AS 推荐人所属分行
       ,t1.RCM_PSN_ID          AS 推荐人工号
       ,t1.RCM_PSN_NM          AS 推荐人姓名
       ,t2.aum_grd             AS 财富等级
       ,t2.cst_seg_flg_nm      AS 所属客群
       ,t2.efe_loan_cst_ind    AS 有效信贷户标识
       ,t2.efe_dep_cst_ind     AS 有效存款户标识
       ,t2.CTR_AMT_7D          AS 购买前后7天内新增贷款金额
       ,t2.dep_bal             AS 购买前一日存款余额
       ,t2.loan_bal_acs        AS 购买前一日贷款余额
       ,t2.fnc_amt             AS 购买前一日理财余额
       ,t2.trx_days            AS 客户复购天数
from SJXQ_SJ2024061741_CST_01       t1
left join SJXQ_SJ2024061741_CST_03  t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
where IS_DEL=0 and t1.trx_dt>='20240101'   --交易时间
;
-- 输出结果3 版画摆件
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST_06 AS
SELECT  t1.TRX_DT              AS 购买日期
       ,t1.TRX_AMT             AS 购买金额
       ,t1.CMDT_NM             AS 商品名称
       ,t1.MID_INC_TOT_AMT     AS 佣金总额
       ,t1.PVD_NM              AS 商铺名称
       ,t1.CST_ID              AS 客户号
       ,t2.age                 AS 年龄
       ,t2.gdr_nm              AS 性别
       ,t1.RCM_PSN_AFL_DEPT    AS 推荐人所属部门团队
       ,t1.RCM_PSN_AFL_SUB_BRN AS 推荐人所属支行
       ,t1.RCM_PSN_AFL_BRN     AS 推荐人所属分行
       ,t1.RCM_PSN_ID          AS 推荐人工号
       ,t1.RCM_PSN_NM          AS 推荐人姓名
       ,t2.aum_grd             AS 财富等级
       ,t2.cst_seg_flg_nm      AS 所属客群
       ,t2.efe_loan_cst_ind    AS 有效信贷户标识
       ,t2.efe_dep_cst_ind     AS 有效存款户标识
       ,t2.CTR_AMT_7D          AS 购买前后7天内新增贷款金额
       ,t2.dep_bal             AS 购买前一日存款余额
       ,t2.loan_bal_acs        AS 购买前一日贷款余额
       ,t2.fnc_amt             AS 购买前一日理财余额
       ,t2.trx_days            AS 客户复购天数
from SJXQ_SJ2024061741_CST_01       t1
left join SJXQ_SJ2024061741_CST_03  t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
where IS_DEL=0 and t1.trx_dt>='20240101'   --交易时间
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024061741_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024061741_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,trx_dt) custs
from SJXQ_SJ2024061741_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号,购买日期) custs
from SJXQ_SJ2024061741_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号,购买日期) custs
from SJXQ_SJ2024061741_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号,购买日期) custs
from SJXQ_SJ2024061741_CST_06
;
/*
2. 保险业务清单
20220101-20240615
增额终身寿/两全险
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST2_01 AS
SELECT  '20240615'                                                                AS ACT_DT --会计日期
        ,TO_CHAR(TO_DATE(COALESCE(T3.INSU_DT, '18991231'), 'yyyyMMdd'), 'yyyyMMdd')   AS TRX_DT --交易日期
        ,COALESCE(T1.CST_ID, '')                                                      AS CST_ID --客户号
        ,COALESCE(T1.CST_ACT_ID, '')                                                  AS CST_ACT_NBR --客户账号
        ,COALESCE(T1.INSU_HLD_NM, '')                                                 AS INSU_HLD_NM --投保人姓名
        ,COALESCE(T1.INSU_HLD_GDR_NM, '')                                             AS INSU_HLD_GDR --投保人性别  翻译  修改
        ,COALESCE(REPLACE(T1.INSU_HLD_AGE, '-', ''), '')                              AS INSU_HLD_BTH_DT --投保人出生日期
        ,COALESCE(T1.INSU_WTH_INSU_REL_NM, '')                                        AS INSU_HLD_INSU_REL --投保人与被保险人关系  B_BDZT
        ,COALESCE(T1.WTH_INSU_NM, '')                                                 AS INSU_NM --被保险人姓名
        ,COALESCE(T1.WTH_INSU_GDR_NM, '')                                             AS INSU_GDR --被保险人性别
        ,COALESCE(REPLACE(T1.WTH_INSU_AGE, '-', ''), '')                              AS INSU_BTH_DT --被保险人出生日期
        ,COALESCE(T1.CMP_CD, '')                                                      AS CMP_CD --公司代码
        ,COALESCE(T1.CMP_NM, '')                                                      AS CMP_NM --公司名称
        ,COALESCE(T6.CD_VAL_DSCR, '')                                                 AS CMP_TYP --公司类型   T6 1 人寿 2 财险 3 混合 4 其它
        ,COALESCE(T1.PD_CD, '')                                                       AS PROD_CD --产品代码
        ,COALESCE(T1.PD_NM, '')                                                       AS PROD_NM --产品名称
        ,COALESCE(T1.INSU_BRED_NM, '')                                                AS PROD_INSU_BRED --产品险种
        ,COALESCE(T1.INSU_PLCY_ID, '')                                                AS INSU_ORD_NBR --投保单号
        ,COALESCE(T1.INSU_ID, '')                                                     AS INSU_PLCY_ID --保单号
        ,COALESCE(T1.INSU_PLCY_STS_NM, '')                                            AS INSU_PLCY_STS --保单状态   翻译
        ,COALESCE(T1.CUR_INSU_PLCY_STS_NM, '')                                        AS CUR_INSU_PLCY_STS_NM --新保单状态
        ,COALESCE(T20.INSU_TOT_AMT, 0)                                                AS INSU_AMT --保额
        ,COALESCE(T24.INSU_VRTY_PREM, 0)                                              AS FRS_TRM_INSU_FEE --首期保费
        ,COALESCE(T20.INSU_AMT * COALESCE(T1.MNG_RTO, 1), 0)                          AS MNG_CNV_INSU_FEE --管护折算保费
        ,COALESCE(T1.PAY_MTH_NM, '')                                                  AS PAY_YEAR_PRD_TYP --缴费年期类型
        ,CASE
           WHEN T1.PAY_MTH_CD = '0' THEN '1'
           ELSE COALESCE(T1.PAY_YEAR, '')
         END                                                                          AS PAY_YEAR --缴费年限
        ,COALESCE(T1.PROT_YR_PERD_TYP, '')                                            AS GUAR_YEAR_PRD_TYP --保障年期类型
        ,CASE
           WHEN T1.PROT_YR_PERD_TYP = '终身' THEN '终身'
           ELSE COALESCE(T1.BZ_YEAR_PRD, '')
         END                                                                          AS GUAR_YEAR_PRD --保障年期
        ,COALESCE(T1.PFM_FEE_RAT, 0)                                                  AS HDL_CHRG_RAT --手续费率 章陵 给的
        ,COALESCE(T1.PFM_CMSN_FEE, 0)                                                 AS CMSN_FEE --手续费
        ,COALESCE(T1.ADD_FEE_IND, '')                                                 AS ADD_FEE_IND --加费标志
        ,COALESCE(T1.MNG_PFM_CMSN_FEE, 0)                                             AS MNG_CNV_CMSN_FEE --管护折算绩效手续费
        ,1                                                                            AS NBR_NUM --件数   --固定默认值
        ,COALESCE(T1.MNG_RTO, 1)                                                      AS MNG_CNV_NBR_NUM --管护折算件数
        ,COALESCE(T1.MNG_ID, '')                                                      AS MNG_MGR_ID --管护客户经理工号  X330200121  20210423
        ,COALESCE(T1.MNG_NM, '')                                                      AS MNG_MGR_NM --管护客户经理姓名
        ,COALESCE(T1.MNG_RTO, 0)                                                      AS MNG_RTO --管护比例
        ,COALESCE(T1.MNG_ORG_ID, '')                                                  AS MNG_ORG_ID --管护机构号
        ,COALESCE(T1.MNG_ORG_NM, '')                                                  AS MNG_ORG_NM --管护机构名称
        ,COALESCE(T12.MNG_ID, '')                                                     AS SAL_PPL_ID --销售人员工号
        ,COALESCE(T13.EMPE_NM, '')                                                    AS SAL_PPL_NM --销售人员姓名
        ,COALESCE(T14.CERT_ACQ_NO, '')                                                AS SAL_PPL_REG_ID --销售人员执业登记编号
        ,COALESCE(T12.POS_ID, '')                                                     AS SAL_PPL_PST_ID --销售人员岗位编号  有空  pos_enc
        ,COALESCE(T15.POS_NM, '')                                                     AS SAL_PPL_PST_NM  --销售人员岗位名称
        -------------------------MOD BY 20211214 LQJ 销售人员所属机构为销售人员当时所在机构------------------------------------------------------
        ,COALESCE(T12.MNG_ORG_ID, '')                                                 AS SAL_PPL_AFL_ORG_ID --销售人员所属机构号
        ,COALESCE(T16.ORG_NM, '')                                                     AS SAL_PPL_AFL_ORG_NM --销售人员所属机构名称
        ,COALESCE(T1.TXN_CHN_NM, '')                                                  AS TRX_CHNL --交易渠道
        ,COALESCE(T1.ORG_ID, '')                                                      AS TRX_ORG_ID --交易机构号
        ,COALESCE(T17.UNT_ORG_NM, '')                                                 AS TRX_ORG_NM --交易机构名称
        ,COALESCE(T17.SUM_ORG_ID, '')                                                 AS TRX_BRA --交易分行
        ,COALESCE(T17.SUM_ORG_NM, '')                                                 AS TRX_BRA_NM --交易分行名称  新增字段
        ,CASE
           WHEN T17.SUM_ORG_NM LIKE '%宁波%'                                                                                                                                                                      THEN '宁波'
           WHEN T17.SUM_ORG_NM LIKE '%上海%'                                                                                                                                                                      THEN '上海'
           WHEN T17.SUM_ORG_NM LIKE '%苏州%'                                                                                                                                                                      THEN '苏州'
           WHEN T17.SUM_ORG_NM IN ( '台州分行' , '杭州分行' , '温州分行' , '丽水分行' , '绍兴分行' , '金华分行' , '嘉兴分行' , '湖州分行' , '衢州分行' , '舟山分行' , '浙江庆元泰隆村镇银行' , '国际合作与创新部' , '消费金融部' , '浙江泰隆商业银行总行' , '总行营业部' , '浙江泰隆商业银行总行清算中心' ) THEN '浙江省（除宁波）'
           ELSE ''
         END                                                                          AS SPVS_RPT_RGN --监管报送区域   通过交易分行名称来区分
        ,COALESCE(T1.ISU_MOD_CD, '')                                                  AS TRX_CD --交易代码
        ,COALESCE(T1.ISU_MOD_NM, '')                                                  AS TRX_NM --交易名称
        ,COALESCE(T2.OPRR_ID, '')                                                     AS OPR_ID --操作员号
        ,COALESCE(T18.TLR_NM, '')                                                     AS TLR_NM --柜员名称
        ,COALESCE(T9.CD_VAL_DSCR, '')                                                 AS VCH_CLS --凭证种类
        ,COALESCE(T10.CD_VAL_DSCR, '')                                                AS TRX_STS --交易状态
        ,COALESCE(T2.TRX_TM, '')                                                      AS TRX_TM --交易时间
        ,CASE
           WHEN T3.BNFR_WTHR_LGL_CD = '1' THEN '法定继承人'
           ELSE COALESCE(T1.BNF_NM, '')
         END                                                                          AS BNF_INF --受益人信息
        ,COALESCE(T1.MAIN_RISK_IND, '')                                               AS MAIN_RISK_IND --附加险标志
        ,COALESCE(T1.MGR_ID_SUP_ID, '')                                               AS MGR_ID_SUP_ID -- 管护客户经理上级工号
        ,COALESCE(T1.MGR_ID_SUP_NM, '')                                               AS MGR_ID_SUP_NM -- 管护客户经理上级名称
        ,COALESCE(T12.ACS_ORG_ID_FH, '')                                              AS SAL_ORG_ID_FH -- 销售机构所属分行
        ,COALESCE(T1.ACS_ORG_ID_FH, '')                                               AS ACS_ORG_ID_FH -- 考核机构所属分行
        ,COALESCE(T2.DBL_RCD_RCG_NO, '')                                              AS DOU_REC_IDEN_CODE -- 双录识别码
        ,COALESCE(T1.STL_STS_CD, '')                                                  AS STL_STS_CD --保司结算状态
        ,COALESCE(T1.DTRB_STS_CD, '')                                                 AS DTRB_STS_CD --绩效发放状态
        ,COALESCE(T1.ABL_STL_DT, '')                                                  AS DTRB_STL_DT --绩效发放月份
        ,CASE
           WHEN T19.QUALF_LVL = '0' THEN 0
           WHEN T19.QUALF_LVL = '1' THEN 0.3
           ELSE 0
         END                                                                          AS LOAN_QUA_RWD_RAT -- 信贷资质折后计奖比例
        ,CASE
           WHEN T19.QUALF_LVL = '0' THEN 0
           WHEN T19.QUALF_LVL = '1' THEN 1
           ELSE 0
         END                                                                          AS LOAN_QUA_MID_RAT -- 信贷资质折后中收比例
        ,CASE
           WHEN T19.QUALF_LVL = '0' THEN '禁止类'
           WHEN T19.QUALF_LVL = '1' THEN '其他类'
           ELSE ''
         END                                                                          AS LOAN_QUA_GRD -- 信贷资质等级
        ,CASE
           WHEN T1.TXN_CHN_NM = '手机银行' THEN (
                                            CASE
                                              WHEN T22.SUM_ORG_NM LIKE '%宁波%'                                                                                                                                                                      THEN '宁波'
                                              WHEN T22.SUM_ORG_NM LIKE '%上海%'                                                                                                                                                                      THEN '上海'
                                              WHEN T22.SUM_ORG_NM LIKE '%苏州%'                                                                                                                                                                      THEN '苏州'
                                              WHEN T22.SUM_ORG_NM IN ( '台州分行' , '杭州分行' , '温州分行' , '丽水分行' , '绍兴分行' , '金华分行' , '嘉兴分行' , '湖州分行' , '衢州分行' , '舟山分行' , '浙江庆元泰隆村镇银行' , '国际合作与创新部' , '消费金融部' , '浙江泰隆商业银行总行' , '总行营业部' , '浙江泰隆商业银行总行清算中心' ) THEN '浙江省（除宁波）'
                                              ELSE ''
                                            END
        )
           WHEN T1.TXN_CHN_NM = '柜面'   THEN (
                                          CASE
                                            WHEN T23.SUM_ORG_NM LIKE '%宁波%'                                                                                                                                                                      THEN '宁波'
                                            WHEN T23.SUM_ORG_NM LIKE '%上海%'                                                                                                                                                                      THEN '上海'
                                            WHEN T23.SUM_ORG_NM LIKE '%苏州%'                                                                                                                                                                      THEN '苏州'
                                            WHEN T23.SUM_ORG_NM IN ( '台州分行' , '杭州分行' , '温州分行' , '丽水分行' , '绍兴分行' , '金华分行' , '嘉兴分行' , '湖州分行' , '衢州分行' , '舟山分行' , '浙江庆元泰隆村镇银行' , '国际合作与创新部' , '消费金融部' , '浙江泰隆商业银行总行' , '总行营业部' , '浙江泰隆商业银行总行清算中心' ) THEN '浙江省（除宁波）'
                                            ELSE ''
                                          END
        )
           ELSE ''
         END                                                                          AS CMSN_FEE_SETL_ORG --手续费结算机构
    ,case when nvl(t25.sam_rsk_ctrl_id,'')='' then t1.cst_id else t25.sam_rsk_ctrl_id end sam_rsk_ctrl_id
FROM    adm_pub.ADM_PUB_INSU_CST_PD_LIST T1 --保险代销客户产品清单-全量
INNER JOIN    edw.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD T2 --业务流水表 --流水号关联
ON      T2.DT = '20240615'
AND     T1.TRX_SEQ = T2.BSN_SERNO
AND     T2.BSN_TYP_NM = '订单'
INNER JOIN    edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T3 -- 保单信息表  pk   insure_no   serial_no  FINC_TBSHAREINSURE
ON      T1.INSU_ID = T3.INSU_POLY_NO
AND     T3.DT = '20240615'
AND     COALESCE(T3.INSU_POLY_STS_CD) <> '' --保单状态非空
AND     COALESCE(T3.ORI_INSU_POLY_STS_CD, '') <> '' --保单状态非空
LEFT JOIN    edw.DIM_BUS_INSU_CMP_INF_DD T4 -- 保险公司信息表 TA_CODE  FINC_TBINSURERINFO
ON      T3.INSU_CMP_CD = T4.INSU_CMP_CD
AND     T4.DT = '20240615'
LEFT JOIN    edw.DWD_BUS_INSU_HDL_CHRG_RAT_SET_TBL_DD T5
ON      T5.DT = '20240615'
AND     T5.BSN_SERNO = T2.BSN_SERNO
AND     T5.CLC_CPL_STS_CD = '1'
--保司类别
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T6
ON      T6.CD_VAL = T4.COMPANY_CTG_CD
AND     T6.FLD_NM = 'COMPANY_CTG_CD'
AND     T6.TBL_NM = 'DIM_BUS_INSU_CMP_INF_DD'
AND     T6.DT = '20240615'
--凭证种类
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T9
ON      T9.CD_VAL = COALESCE(T2.VCH_CTG_CD, '')
AND     T9.FLD_NM = 'VCH_CTG_CD'
AND     T9.TBL_NM = 'DWD_BUS_INSU_BUS_TRX_SRL_INF_DD'
AND     T9.DT = '20240615'
--交易状态
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T10
ON      T10.CD_VAL = COALESCE(T2.TRX_STS_CD, '')
AND     T10.FLD_NM = 'TRX_STS_CD'
AND     T10.TBL_NM = 'DWD_BUS_INSU_BUS_TRX_SRL_INF_DD'
AND     T10.DT = '20240615'
LEFT JOIN    adm_pub.ADM_PUB_INSU_CST_PD_LIST_MNG T12
ON      T1.TRX_SEQ = T12.TRX_SEQ
AND     T12.MNG_TYP = '2' --销售
AND     T12.DT = '20240615'
LEFT JOIN    edw.DWS_HR_EMPE_INF_DD T13 --员工
ON      T12.MNG_ID = T13.EMPE_ID
AND     T13.DT = '20240615'
LEFT JOIN
(
	SELECT  T1.CST_MAGR_ID AS CLIENT_MANAGER --客户经理
	       ,T1.CERT_ACQ_NO --销售人员执业登记编号
	       ,ROW_NUMBER() OVER ( PARTITION BY T1.CST_MAGR_ID ORDER BY  T1.CERT_ACQ_DT DESC ) RN
	FROM edw.DIM_HR_EMPE_FIN_MNG_INTLG_CTF_INF_DD T1 -- FINC_TBCLIENTMANQUALITY 客户经理理财资质证书信息
	WHERE T1.DT = '20240615'
	AND T1.BSN_TYP = '4' --保险销售从业人员执业证书
) T14
ON      T12.MNG_ID = T14.CLIENT_MANAGER
AND     T14.RN = 1
--销售人员职位
LEFT JOIN
(
	SELECT  POS_ID
	       ,POS_NM
	       ,ROW_NUMBER() OVER ( PARTITION BY POS_ID ORDER BY  POS_NM DESC ) RN
	FROM edw.DIM_HR_ORG_JOB_HIS_INF_DD
	WHERE DT = '20240615'
) T15
ON T12.POS_ID = T15.POS_ID
--销售机构名称
LEFT JOIN    edw.DIM_HR_ORG_BAS_INF_DD T16
ON      T16.DT = '20240615'
AND     T12.MNG_ORG_ID = T16.ORG_ID
LEFT JOIN    edw.DIM_HR_ORG_SUM_ORG_REL_DD T17 --机构表
ON      T17.ORG_RLTN_DIM_CD = 'WD3'
AND     T17.SUM_ORG_LVL = 'F' --  分行
AND     T17.DT = '20240615'
AND     COALESCE(T1.ORG_ID, '') = T17.UNT_ORG_ID
LEFT JOIN    edw.DIM_BUS_CHNL_CNT_TLR_INF_DD T18 --柜员表
ON      T18.DT = '20240615'
AND     T18.TLR_ID = T2.OPRR_ID
LEFT JOIN    adm_pub.ADM_PUB_INSU_QUALF_LAB_DD T19 -- 保险信贷资质等级
ON      T19.INSU_POLY_NO = T1.INSU_ID
AND     T19.DT = '20240615'
LEFT JOIN    edw.DWD_BUS_INSU_BRED_SRL_INF_TBL_DD T20 --险种流水信息表
ON      T1.TRX_SEQ = T20.BSN_SERNO
AND     T1.INSU_BRED_CD = T20.INSU_VRTY_CD
AND     T20.DT = '20240615'
LEFT JOIN    edw.DWS_HR_EMPE_INF_DD T21 --员工
ON      T2.CST_MAGR_ID = T21.EMPE_ID
AND     T21.DT = '20240615'
LEFT JOIN    edw.DIM_HR_ORG_SUM_ORG_REL_DD T22 --机构表
ON      T22.ORG_RLTN_DIM_CD = 'WD3'
AND     T22.SUM_ORG_LVL = 'F' --  分行
AND     T22.DT = '20240615'
AND     COALESCE(T21.ORG_ID, '') = T22.UNT_ORG_ID
LEFT JOIN    edw.DIM_HR_ORG_SUM_ORG_REL_DD T23 --机构表
ON      T23.ORG_RLTN_DIM_CD = 'WD3'
AND     T23.SUM_ORG_LVL = 'F' --  分行
AND     T23.DT = '20240615'
AND     COALESCE(T18.BUS_ORG_ID, '') = T23.UNT_ORG_ID --选择柜员的营业机构编号还是账务机构编号需要确认
LEFT JOIN    edw.DWD_BUS_INSU_BRED_CMSN_FEE_STL_REG_RCD_DD T24 --险种手续费结算登记记录
ON      T1.TRX_SEQ = T24.BSN_SERNO
AND     T1.INSU_BRED_CD = T24.INSU_VRTY_CD
AND     T1.ADD_FEE_IND = T24.ADD_FEE_IND
AND     T24.CLC_CPL_STS_CD = '1' --计算完成状态代码,1(已完成)
AND     T24.TRX_TYP_CD <> '3' --续期
AND     T24.DT = '20240615'
left join edw.dws_cst_bas_inf_dd 	    t25 --客户基础信息汇总表
on      t1.cst_id=t25.cst_id
and     t25.dt='20240615'
WHERE   T1.DT = '20240615'
AND     T1.MNG_TYP = '1' --考核 -- 新保承保，非实时出单，保险补录
AND     T1.ISU_MOD_CD IN ( '0' , '1','2' )
and TO_CHAR(TO_DATE(COALESCE(T3.INSU_DT, '18991231'), 'yyyyMMdd'), 'yyyyMMdd') between '20220101' and '20240615'
and T1.PD_NM REGEXP '两全|终身寿险'
;
-- 投保前后7天是否有新增贷款 投保前后7天有新增贷款金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST2_02 AS
SELECT  a.cst_ID
       ,a.trx_dt
       ,B.BUSI_CTR_ID       --合同流水号
       ,B.CTR_AMT           --合同金额
       ,B.CTR_BAL           --合同余额
       ,C.REG_DT            --申请日期
       ,ABS(DATEDIFF(TO_DATE(C.REG_DT,'yyyyMMdd'),TO_DATE(A.trx_dt,'yyyyMMdd'),'dd')) AS DIFF_TM --贷款申请与交易间隔日期
FROM
(
	SELECT  distinct cst_ID,trx_dt
	FROM SJXQ_SJ2024061741_CST2_01
) a inner JOIN edw.DIM_BUS_LOAN_CTR_INF_DD B --信贷合同信息
ON A.cst_ID = B.CST_ID
AND NVL(B.CST_ID, '') <> '' --剔除空值和空
AND B.CRC_IND <> '1' --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND B.DT = '@@{yyyyMMdd}'
inner JOIN edw.DWD_BUS_LOAN_APL_INF_DD C --信贷业务申请信息
ON B.BUSI_APL_ID = C.APL_ID --业务申请编号
AND NVL(C.APL_ID, '') <> '' --剔除空值和空
AND C.DT = '@@{yyyyMMdd}'
where ABS(DATEDIFF(TO_DATE(C.REG_DT,'yyyyMMdd'),TO_DATE(A.trx_dt,'yyyyMMdd'),'dd'))<=7
;
-- 投后15天是否有效信贷户 投保前一天是否有效存款户
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_03 AS
SELECT  t1.cst_ID
       ,t1.trx_dt
       ,t2.efe_loan_cst_ind --有效信贷户标识
       ,t3.efe_dep_cst_ind --有效存款户标识
FROM
(
	SELECT  distinct cst_ID,trx_dt
	FROM SJXQ_SJ2024061741_CST2_01
) t1
left join adm_pub.adm_csm_cbas_ind_inf_dd 		    t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t1.trx_dt=TO_CHAR(DATEADD(TO_DATE(t2.dt,'yyyymmdd'),-15,'dd'),'yyyymmdd')   --投后15天
and t2.dt between '20220101' and '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_ind_inf_dd 		    t3 --客户基础标识信息
on t1.cst_id=t3.cst_id
and t1.trx_dt=TO_CHAR(DATEADD(TO_DATE(t3.dt,'yyyymmdd'),1,'dd'),'yyyymmdd')   --投保前一天
and t3.dt between '20211231' and '20240615'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_04 AS
SElECT case when t1.PROD_NM REGEXP '终身寿险' then '终身寿险' else '两全' end insu_type
    ,t1.TRX_DT                  --交易日期
    ,t1.CST_ID                  --客户号
    ,t1.CST_ACT_NBR             --客户账号
    ,t1.INSU_HLD_NM             --投保人姓名
    ,t1.INSU_HLD_GDR            --投保人性别
    ,t1.INSU_HLD_BTH_DT         --投保人出生日期
    ,t1.CMP_CD                  --公司代码
    ,t1.CMP_NM                  --公司名称
    ,t1.PROD_CD                 --产品代码
    ,t1.PROD_NM                 --产品名称
    ,t1.PROD_INSU_BRED          --产品险种
    ,t1.INSU_PLCY_ID            --保单号
    ,t1.INSU_PLCY_STS           --保单状态
    ,t1.CUR_INSU_PLCY_STS_NM    --新保单状态
    ,t1.MNG_CNV_INSU_FEE        --管护折算保费
    ,t1.INSU_AMT                --保额
    ,t1.PAY_YEAR                --缴费年限
    ,t1.MNG_CNV_CMSN_FEE        --管护折算绩效手续费
    ,t1.SAL_PPL_ID              --销售人员工号
    ,t1.SAL_PPL_NM              --销售人员姓名
    ,t1.TRX_ORG_ID              --交易机构号
    ,t1.TRX_CD                  --交易代码
    ,t1.TRX_TM                  --交易时间
    ,t1.LOAN_QUA_GRD            --信贷资质等级
    ,T2.tem_org_id,t2.tem_org_nm--交易时销售人所属机构
    ,t2.sbr_org_nm,t2.brc_org_nm
    ,decode(t3.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') cst_seg_nm
    ,t4.age,decode(t4.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,decode(t5.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星','') aum_grd
from SJXQ_SJ2024061741_CST2_01              t1
left join edw.dim_hr_org_mng_org_tree_dd    t2 --考核机构树
on  t2.org_id=t2.org_id
and t2.dt='20240615'
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t3 --客户标签信息
on t1.cst_id=t3.cst_id
and t3.dt='20240615'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t4 --对私客户基础信息
on t1.cst_id=t4.cst_id
and t4.dt='20240615'
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd   t5 --客户等级信息
on t1.cst_id=t5.cst_id
and t5.dt='20240615'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024052431_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024052431_CST2_05 AS
SELECT  t1.insu_type            AS 保险类型
       ,t1.PROD_NM              AS 产品名称
       ,t1.CMP_NM               AS 公司名称
       ,t1.INSU_PLCY_ID         AS 保单号
       ,t1.TRX_DT               AS 交易日期
       ,t1.MNG_CNV_INSU_FEE     AS 管护折算保费
       ,t1.PAY_YEAR             AS 缴费年限
       ,t1.INSU_AMT             AS 保障金额
       ,t1.MNG_CNV_CMSN_FEE     AS 管护折算绩效手续费
       ,t1.INSU_PLCY_STS        AS 保单状态_20240615
       ,t1.CUR_INSU_PLCY_STS_NM AS 新保单状态_20240615
       ,t1.SAL_PPL_ID           AS 销售人员工号
       ,t1.SAL_PPL_NM           AS 销售人员姓名
       ,t1.tem_org_nm           AS 销售人订单时点_所属团队
       ,t1.sbr_org_nm           AS 销售人订单时点_所属支行
       ,t1.brc_org_nm           AS 销售人订单时点_所属分行
       ,t1.aum_grd              AS 投保人财富等级
       ,t1.cst_seg_nm           AS 投保人所属客群
       ,t1.age                  AS 投保人年龄
       ,t1.gdr_nm               AS 投保人性别
       ,t1.LOAN_QUA_GRD         AS 信贷资质等级
       ,CASE WHEN t2.cst_ID is not null THEN '是'  ELSE '否' END AS 投保前后7天是否有新增贷款
       ,t2.CTR_AMT_7D           AS 投保前后7天有新增贷款金额
       ,t3.efe_loan_cst_ind     AS 投后15天是否有效信贷户
       ,t3.efe_dep_cst_ind      AS 投保前一天是否有效存款户
from SJXQ_SJ2024052431_CST2_04
left join(
    SElECT cst_id,trx_dt,sum(CTR_AMT) CTR_AMT_7D
    from SJXQ_SJ2024061741_CST2_02
    group by cst_id,trx_dt
)t2 on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
left join SJXQ_SJ2024052431_CST2_03 t3
on t1.cst_id=t3.cst_ID
and t1.trx_dt=t3.trx_dt
;
/*
3. 全行客户画像 20240531
-- 贵金属交易明细 贵金属成功购买交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_01 AS
SElECT cst_ID,sum(TRX_AMT) GOLD_TRX_TOT_AMT
from SJXQ_SJ2024061741_CST_01
where IS_DEL=0 and trx_dt<='20240531'
group by cst_ID
;
-- 保险交易总金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_02 AS
    SELECT  TO_CHAR(TO_DATE(COALESCE(T3.INSU_DT,'18991231'),'yyyyMMdd'),'yyyyMMdd') AS TRX_DT --交易日期
        ,COALESCE(T1.CST_ID,'')                                                  AS CST_ID --客户号
        ,COALESCE(T1.INSU_ID,'')                                                 AS INSU_PLCY_ID --保单号
        ,COALESCE(T20.INSU_TOT_AMT,0)                                            AS INSU_AMT --保额
        ,COALESCE(T24.INSU_VRTY_PREM,0)                                          AS FRS_TRM_INSU_FEE --首期保费
        ,COALESCE(T20.INSU_AMT * COALESCE(T1.MNG_RTO,1),0)                       AS MNG_CNV_INSU_FEE --管护折算保费
        ,COALESCE(T1.PFM_CMSN_FEE,0)                                             AS CMSN_FEE --手续费
        ,COALESCE(T1.MNG_PFM_CMSN_FEE,0)                                         AS MNG_CNV_CMSN_FEE --管护折算绩效手续费
    FROM    adm_pub.ADM_PUB_INSU_CST_PD_LIST T1 --保险代销客户产品清单-全量
    INNER JOIN    edw.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD T2 --业务流水表 --流水号关联
    ON      T2.DT = '20240531'
    AND     T1.TRX_SEQ = T2.BSN_SERNO
    AND     T2.BSN_TYP_NM = '订单'
    INNER JOIN    edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T3 -- 保单信息表  pk   insure_no   serial_no  FINC_TBSHAREINSURE
    ON      T1.INSU_ID = T3.INSU_POLY_NO
    AND     T3.DT = '20240531'
    AND     COALESCE(T3.INSU_POLY_STS_CD) <> '' --保单状态非空
    AND     COALESCE(T3.ORI_INSU_POLY_STS_CD, '') <> '' --保单状态非空
    LEFT JOIN    edw.DWD_BUS_INSU_BRED_SRL_INF_TBL_DD T20 --险种流水信息表
    ON      T1.TRX_SEQ = T20.BSN_SERNO
    AND     T1.INSU_BRED_CD = T20.INSU_VRTY_CD
    AND     T20.DT = '20240531'
    LEFT JOIN    edw.DWD_BUS_INSU_BRED_CMSN_FEE_STL_REG_RCD_DD T24 --险种手续费结算登记记录
    ON      T1.TRX_SEQ = T24.BSN_SERNO
    AND     T1.INSU_BRED_CD = T24.INSU_VRTY_CD
    AND     T1.ADD_FEE_IND = T24.ADD_FEE_IND
    AND     T24.CLC_CPL_STS_CD = '1' --计算完成状态代码,1(已完成)
    AND     T24.TRX_TYP_CD <> '3' --续期
    AND     T24.DT = '20240531'
    WHERE   T1.DT = '20240531'
    AND     T1.MNG_TYP = '1' --考核 -- 新保承保，非实时出单，保险补录
    AND     T1.ISU_MOD_CD IN ( '0' , '1','2' )
    and TO_CHAR(TO_DATE(COALESCE(T3.INSU_DT, '18991231'), 'yyyyMMdd'), 'yyyyMMdd') <= '20240531'
;
问题：
1. AUM>5000(存款+理财）是 存款+理财 余额大于5000吗？
*/
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_03 AS
select t1.cst_id                                 --客户编号
	,t1.fund_amt                                 --基金金额
	,t1.fnc_amt                                  --理财金额
	,t1.insu_amt                                 --保险保费
	,t1.gold_buy_amt                             --贵金属购买金额
    ,t1.aum_bal
    ,t2.age
    ,case when t2.age <= 30 then '1 <=30'
        when t2.age>30 and t2.age<=40 then '2 (30,40]'
        when t2.age>40 and t2.age<=50 then '3 (40,50]'
        when t2.age>50 and t2.age<=60 then '4 (50,60]'
        when t2.age>60 and t2.age<70  then '5 (60,70)'
        when t2.age>=70 then '6 >=70' else '' end age_grd
    ,t3.aum_grd
    ,decode(t3.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星','') aum_grd_nm
    ,t4.cst_seg_flg
    ,decode(t4.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','未知') cst_seg_flg_nm
    ,t5.dep_bal	    --存款余额
from adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd    t1 --客户集市-业务信息-客户金融资产信息表
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240531'
left join adm_pub.adm_csm_cbas_cst_grd_inf_dd   t3 --客户等级信息
on t1.cst_id=t3.cst_id
and t3.dt ='20240531'
left join adm_pub.adm_csm_clab_cst_jc_inf_dd    t4 --客户标签信息
on t1.cst_id=t4.cst_id
and t4.dt='20240531'
left join adm_pub.adm_csm_cbus_dep_inf_dd	    t5 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240531'
where t1.dt='20240531'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_04 AS
SElECT age_grd
    ,count(case when aum_grd='1' then cst_id end)   一星客户数
    ,count(case when aum_grd='2' then cst_id end)   二星客户数
    ,count(case when aum_grd='3' then cst_id end)   三星客户数
    ,count(case when aum_grd='4' then cst_id end)   四星客户数
    ,count(case when aum_grd='5' then cst_id end)   五星客户数
    ,count(case when aum_grd='6' then cst_id end)   六星客户数
    ,case when count(case when aum_grd='1' then cst_id end) <>0 then sum(case when aum_grd='1' then aum_bal else 0 end)/count(case when aum_grd='1' then cst_id end) else 0 end 一星客户平均AUM
    ,case when count(case when aum_grd='2' then cst_id end) <>0 then sum(case when aum_grd='2' then aum_bal else 0 end)/count(case when aum_grd='2' then cst_id end) else 0 end 二星客户平均AUM
    ,case when count(case when aum_grd='3' then cst_id end) <>0 then sum(case when aum_grd='3' then aum_bal else 0 end)/count(case when aum_grd='3' then cst_id end) else 0 end 三星客户平均AUM
    ,case when count(case when aum_grd='4' then cst_id end) <>0 then sum(case when aum_grd='4' then aum_bal else 0 end)/count(case when aum_grd='4' then cst_id end) else 0 end 四星客户平均AUM
    ,case when count(case when aum_grd='5' then cst_id end) <>0 then sum(case when aum_grd='5' then aum_bal else 0 end)/count(case when aum_grd='5' then cst_id end) else 0 end 五星客户平均AUM
    ,case when count(case when aum_grd='6' then cst_id end) <>0 then sum(case when aum_grd='6' then aum_bal else 0 end)/count(case when aum_grd='6' then cst_id end) else 0 end 六星客户平均AUM
from SJXQ_SJ2024061741_CST3_03
group by age_grd
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_05 AS
SElECT age_grd
    ,count(case when aum_grd='1' then cst_id end)   一星客户数
    ,count(case when aum_grd='2' then cst_id end)   二星客户数
    ,count(case when aum_grd='3' then cst_id end)   三星客户数
    ,count(case when aum_grd='4' then cst_id end)   四星客户数
    ,count(case when aum_grd='5' then cst_id end)   五星客户数
    ,count(case when aum_grd='6' then cst_id end)   六星客户数
    ,case when count(case when aum_grd='1' then cst_id end) <>0 then sum(case when aum_grd='1' then aum_bal else 0 end)/count(case when aum_grd='1' then cst_id end) else 0 end 一星客户平均AUM
    ,case when count(case when aum_grd='2' then cst_id end) <>0 then sum(case when aum_grd='2' then aum_bal else 0 end)/count(case when aum_grd='2' then cst_id end) else 0 end 二星客户平均AUM
    ,case when count(case when aum_grd='3' then cst_id end) <>0 then sum(case when aum_grd='3' then aum_bal else 0 end)/count(case when aum_grd='3' then cst_id end) else 0 end 三星客户平均AUM
    ,case when count(case when aum_grd='4' then cst_id end) <>0 then sum(case when aum_grd='4' then aum_bal else 0 end)/count(case when aum_grd='4' then cst_id end) else 0 end 四星客户平均AUM
    ,case when count(case when aum_grd='5' then cst_id end) <>0 then sum(case when aum_grd='5' then aum_bal else 0 end)/count(case when aum_grd='5' then cst_id end) else 0 end 五星客户平均AUM
    ,case when count(case when aum_grd='6' then cst_id end) <>0 then sum(case when aum_grd='6' then aum_bal else 0 end)/count(case when aum_grd='6' then cst_id end) else 0 end 六星客户平均AUM
from SJXQ_SJ2024061741_CST3_03
where aum_bal>5000
group by age_grd
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_06 AS
SElECT age_grd
    ,count(case when cst_seg_flg='1' then cst_id end)           企业主_客户数
    ,count(case when cst_seg_flg='2' then cst_id end)           个体工商户_客户数
    ,count(case when cst_seg_flg='3' then cst_id end)           企事业高管_客户数
    ,count(case when cst_seg_flg='4' then cst_id end)           非持牌个体户_客户数
    ,count(case when cst_seg_flg='5' then cst_id end)           工薪族_客户数
    ,count(case when cst_seg_flg='6' then cst_id end)           退休养老_客户数
    ,count(case when cst_seg_flg='7' then cst_id end)           持家女性_客户数
    ,count(case when cst_seg_flg_nm='未知' then cst_id end)     未知_客户数
    ,case when count(case when cst_seg_flg='1' then cst_id end) <>0 then sum(case when cst_seg_flg='1' then aum_bal else 0 end)/count(case when cst_seg_flg='1' then cst_id end) else 0 end 企业主_平均AUM
    ,case when count(case when cst_seg_flg='2' then cst_id end) <>0 then sum(case when cst_seg_flg='2' then aum_bal else 0 end)/count(case when cst_seg_flg='2' then cst_id end) else 0 end 个体工商户_平均AUM
    ,case when count(case when cst_seg_flg='3' then cst_id end) <>0 then sum(case when cst_seg_flg='3' then aum_bal else 0 end)/count(case when cst_seg_flg='3' then cst_id end) else 0 end 企事业高管_平均AUM
    ,case when count(case when cst_seg_flg='4' then cst_id end) <>0 then sum(case when cst_seg_flg='4' then aum_bal else 0 end)/count(case when cst_seg_flg='4' then cst_id end) else 0 end 非持牌个体户_平均AUM
    ,case when count(case when cst_seg_flg='5' then cst_id end) <>0 then sum(case when cst_seg_flg='5' then aum_bal else 0 end)/count(case when cst_seg_flg='5' then cst_id end) else 0 end 工薪族_平均AUM
    ,case when count(case when cst_seg_flg='6' then cst_id end) <>0 then sum(case when cst_seg_flg='6' then aum_bal else 0 end)/count(case when cst_seg_flg='6' then cst_id end) else 0 end 退休养老_平均AUM
    ,case when count(case when cst_seg_flg='7' then cst_id end) <>0 then sum(case when cst_seg_flg='7' then aum_bal else 0 end)/count(case when cst_seg_flg='7' then cst_id end) else 0 end 持家女性_平均AUM
    ,case when count(case when cst_seg_flg_nm='未知' then cst_id end) <>0 then sum(case when cst_seg_flg_nm='未知' then aum_bal else 0 end)/count(case when cst_seg_flg_nm='未知' then cst_id end) else 0 end 未知_平均AUM
from SJXQ_SJ2024061741_CST3_03
group by age_grd
;
-- 输出结果4
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_07 AS
SElECT age_grd
    ,count(case when cst_seg_flg='1' then cst_id end)           企业主_客户数
    ,count(case when cst_seg_flg='2' then cst_id end)           个体工商户_客户数
    ,count(case when cst_seg_flg='3' then cst_id end)           企事业高管_客户数
    ,count(case when cst_seg_flg='4' then cst_id end)           非持牌个体户_客户数
    ,count(case when cst_seg_flg='5' then cst_id end)           工薪族_客户数
    ,count(case when cst_seg_flg='6' then cst_id end)           退休养老_客户数
    ,count(case when cst_seg_flg='7' then cst_id end)           持家女性_客户数
    ,count(case when cst_seg_flg_nm='未知' then cst_id end)     未知_客户数
    ,case when count(case when cst_seg_flg='1' then cst_id end) <>0 then sum(case when cst_seg_flg='1' then aum_bal else 0 end)/count(case when cst_seg_flg='1' then cst_id end) else 0 end 企业主_平均AUM
    ,case when count(case when cst_seg_flg='2' then cst_id end) <>0 then sum(case when cst_seg_flg='2' then aum_bal else 0 end)/count(case when cst_seg_flg='2' then cst_id end) else 0 end 个体工商户_平均AUM
    ,case when count(case when cst_seg_flg='3' then cst_id end) <>0 then sum(case when cst_seg_flg='3' then aum_bal else 0 end)/count(case when cst_seg_flg='3' then cst_id end) else 0 end 企事业高管_平均AUM
    ,case when count(case when cst_seg_flg='4' then cst_id end) <>0 then sum(case when cst_seg_flg='4' then aum_bal else 0 end)/count(case when cst_seg_flg='4' then cst_id end) else 0 end 非持牌个体户_平均AUM
    ,case when count(case when cst_seg_flg='5' then cst_id end) <>0 then sum(case when cst_seg_flg='5' then aum_bal else 0 end)/count(case when cst_seg_flg='5' then cst_id end) else 0 end 工薪族_平均AUM
    ,case when count(case when cst_seg_flg='6' then cst_id end) <>0 then sum(case when cst_seg_flg='6' then aum_bal else 0 end)/count(case when cst_seg_flg='6' then cst_id end) else 0 end 退休养老_平均AUM
    ,case when count(case when cst_seg_flg='7' then cst_id end) <>0 then sum(case when cst_seg_flg='7' then aum_bal else 0 end)/count(case when cst_seg_flg='7' then cst_id end) else 0 end 持家女性_平均AUM
    ,case when count(case when cst_seg_flg_nm='未知' then cst_id end) <>0 then sum(case when cst_seg_flg_nm='未知' then aum_bal else 0 end)/count(case when cst_seg_flg_nm='未知' then cst_id end) else 0 end 未知_平均AUM
from SJXQ_SJ2024061741_CST3_03
where aum_bal>5000
group by age_grd
;
-- 输出结果5
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_08 AS
SElECT aum_grd_nm
    ,count(case when cst_seg_flg='1' then cst_id end)           企业主_客户数
    ,count(case when cst_seg_flg='2' then cst_id end)           个体工商户_客户数
    ,count(case when cst_seg_flg='3' then cst_id end)           企事业高管_客户数
    ,count(case when cst_seg_flg='4' then cst_id end)           非持牌个体户_客户数
    ,count(case when cst_seg_flg='5' then cst_id end)           工薪族_客户数
    ,count(case when cst_seg_flg='6' then cst_id end)           退休养老_客户数
    ,count(case when cst_seg_flg='7' then cst_id end)           持家女性_客户数
    ,count(case when cst_seg_flg_nm='未知' then cst_id end)     未知_客户数
    ,case when count(case when cst_seg_flg='1' then cst_id end) <>0 then sum(case when cst_seg_flg='1' then aum_bal else 0 end)/count(case when cst_seg_flg='1' then cst_id end) else 0 end 企业主_平均AUM
    ,case when count(case when cst_seg_flg='2' then cst_id end) <>0 then sum(case when cst_seg_flg='2' then aum_bal else 0 end)/count(case when cst_seg_flg='2' then cst_id end) else 0 end 个体工商户_平均AUM
    ,case when count(case when cst_seg_flg='3' then cst_id end) <>0 then sum(case when cst_seg_flg='3' then aum_bal else 0 end)/count(case when cst_seg_flg='3' then cst_id end) else 0 end 企事业高管_平均AUM
    ,case when count(case when cst_seg_flg='4' then cst_id end) <>0 then sum(case when cst_seg_flg='4' then aum_bal else 0 end)/count(case when cst_seg_flg='4' then cst_id end) else 0 end 非持牌个体户_平均AUM
    ,case when count(case when cst_seg_flg='5' then cst_id end) <>0 then sum(case when cst_seg_flg='5' then aum_bal else 0 end)/count(case when cst_seg_flg='5' then cst_id end) else 0 end 工薪族_平均AUM
    ,case when count(case when cst_seg_flg='6' then cst_id end) <>0 then sum(case when cst_seg_flg='6' then aum_bal else 0 end)/count(case when cst_seg_flg='6' then cst_id end) else 0 end 退休养老_平均AUM
    ,case when count(case when cst_seg_flg='7' then cst_id end) <>0 then sum(case when cst_seg_flg='7' then aum_bal else 0 end)/count(case when cst_seg_flg='7' then cst_id end) else 0 end 持家女性_平均AUM
    ,case when count(case when cst_seg_flg_nm='未知' then cst_id end) <>0 then sum(case when cst_seg_flg_nm='未知' then aum_bal else 0 end)/count(case when cst_seg_flg_nm='未知' then cst_id end) else 0 end 未知_平均AUM
from SJXQ_SJ2024061741_CST3_03
group by aum_grd_nm
;
-- 输出结果6
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_09 AS
SElECT age_grd
    ,count(case when cst_seg_flg='1' then cst_id end)           企业主_贵金属客户数
    ,count(case when cst_seg_flg='2' then cst_id end)           个体工商户_贵金属客户数
    ,count(case when cst_seg_flg='3' then cst_id end)           企事业高管_贵金属客户数
    ,count(case when cst_seg_flg='4' then cst_id end)           非持牌个体户_贵金属客户数
    ,count(case when cst_seg_flg='5' then cst_id end)           工薪族_贵金属客户数
    ,count(case when cst_seg_flg='6' then cst_id end)           退休养老_贵金属客户数
    ,count(case when cst_seg_flg='7' then cst_id end)           持家女性_贵金属客户数
    ,count(case when cst_seg_flg_nm='未知' then cst_id end)     未知_贵金属客户数
    ,sum(case when cst_seg_flg='1' then gold_buy_amt else 0 end)        企业主_贵金属交易金额
    ,sum(case when cst_seg_flg='2' then gold_buy_amt else 0 end)        个体工商户_贵金属交易金额
    ,sum(case when cst_seg_flg='3' then gold_buy_amt else 0 end)        企事业高管_贵金属交易金额
    ,sum(case when cst_seg_flg='4' then gold_buy_amt else 0 end)        非持牌个体户_贵金属交易金额
    ,sum(case when cst_seg_flg='5' then gold_buy_amt else 0 end)        工薪族_贵金属交易金额
    ,sum(case when cst_seg_flg='6' then gold_buy_amt else 0 end)        退休养老_贵金属交易金额
    ,sum(case when cst_seg_flg='7' then gold_buy_amt else 0 end)        持家女性_贵金属交易金额
    ,sum(case when cst_seg_flg_nm='未知' then gold_buy_amt else 0 end)  未知_贵金属交易金额
from SJXQ_SJ2024061741_CST3_03
where gold_buy_amt<>0
group by age_grd
;
-- 输出结果7
DROP   TABLE IF     EXISTS SJXQ_SJ2024061741_CST3_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061741_CST3_10 AS
SElECT age_grd
    ,count(case when cst_seg_flg='1' then cst_id end)           企业主_保险客户数
    ,count(case when cst_seg_flg='2' then cst_id end)           个体工商户_保险客户数
    ,count(case when cst_seg_flg='3' then cst_id end)           企事业高管_保险客户数
    ,count(case when cst_seg_flg='4' then cst_id end)           非持牌个体户_保险客户数
    ,count(case when cst_seg_flg='5' then cst_id end)           工薪族_保险客户数
    ,count(case when cst_seg_flg='6' then cst_id end)           退休养老_保险客户数
    ,count(case when cst_seg_flg='7' then cst_id end)           持家女性_保险客户数
    ,count(case when cst_seg_flg_nm='未知' then cst_id end)     未知_保险客户数
    ,sum(case when cst_seg_flg='1' then insu_amt else 0 end)        企业主_保险规模
    ,sum(case when cst_seg_flg='2' then insu_amt else 0 end)        个体工商户_保险规模
    ,sum(case when cst_seg_flg='3' then insu_amt else 0 end)        企事业高管_保险规模
    ,sum(case when cst_seg_flg='4' then insu_amt else 0 end)        非持牌个体户_保险规模
    ,sum(case when cst_seg_flg='5' then insu_amt else 0 end)        工薪族_保险规模
    ,sum(case when cst_seg_flg='6' then insu_amt else 0 end)        退休养老_保险规模
    ,sum(case when cst_seg_flg='7' then insu_amt else 0 end)        持家女性_保险规模
    ,sum(case when cst_seg_flg_nm='未知' then insu_amt else 0 end)  未知_保险规模
from SJXQ_SJ2024061741_CST3_03
where insu_amt<>0
group by age_grd
***SJ2024061801_二季度财顾负责客户产效.sql
-- 4.1-5.15产生的中收（包含理财、基金、保险、贵金属中收）
DROP   TABLE IF EXISTS SJXQ_SJ2024061801_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024061801_CST_01
(
brc_org_nm         string --分行
,wlth_advsr_nm     string --我行财顾
,cst_id            string --客户号
)
;
insert into SJXQ_SJ2024061801_CST_01
values
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024061801_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024061801_CST_02 AS
SElECT t1.brc_org_nm    分行
    ,t1.wlth_advsr_nm   我行财顾
    ,t1.cst_id          客户号
    ,t2.chm_mid_inc     理财中收
    ,t3.FUD_MID_INCM    基金中收
    ,t4.INS_MID_INCM    保险中收
    ,t5.GOD_MID_INCM    贵金属中收
    ,nvl(t2.chm_mid_inc,0) +nvl(t3.FUD_MID_INCM,0)
        +nvl(t4.INS_MID_INCM,0) +nvl(t5.GOD_MID_INCM,0) 中收合计0401_0616
from SJXQ_SJ2024061801_CST_01   t1
left join(
    --理财中收
    SELECT  cst_id
            ,sum(COALESCE(mid_amt, 0)) AS chm_mid_inc --理财中收
    FROM    edw.dws_bus_chm_act_mgr_inf_dd
    WHERE   dt BETWEEN '20240401' and '20240616'
    AND     mng_typ_cd = '1' --1考核 2销售
    GROUP BY cst_id
)t2 on t1.cst_id=t2.cst_id
left join(
    --基金中收
    SELECT cst_id,sum(tot_mid_inc)   FUD_MID_INCM    --中收合计(认购费+申购费+管理费分成+销售服务费)
    FROM    edw.dwd_bus_chm_fnd_mid_inc_fee_dtl_di
    WHERE   dt BETWEEN '20240401' and '20240616'
    GROUP BY cst_id
)t3 on t1.cst_id=t3.cst_id
left join(
    --保险中收
    SELECT cst_id,SUM(mng_cnv_cmsn_fee) INS_MID_INCM
    FROM APP_RPT.FCT_INSU_AGN_BUS_ACS_DTL_TBL --保险代销业务考核明细表
    WHERE DT='@@{yyyyMMdd}'
    AND replace(TRX_DT,'-','') BETWEEN '20240401' and '20240616'
    GROUP BY cst_id
)t4 on t1.cst_id=t4.cst_id
left join(
    --贵金属中收
    SELECT cst_id,sum(MID_INC_TOT_AMT) GOD_MID_INCM     --当年中收
    FROM    adm_pub.ADM_PUB_CST_NOB_MET_TRX_SUM_DI      --贵金属交易整合表
    WHERE   dt BETWEEN '20240401' and '20240616'
    AND     CMDT_PAY_UNT_PRC<>0 			--存在未付钱且有中收，需剔除
    GROUP by cst_id
)t5 on t1.cst_id=t5.cst_id
;
***SJ20240618101_数币推广奖励统计.sql
/*
-- FCT_SZRMB_BUS_DTL
-- TMP_FCT_SZRMB_BUS_DTL_01 主键 RCV_ACT_ID
数字人民币协议信息 当日签约数据
-- TMP_FCT_SZRMB_BUS_DTL_02
当日新增 + 昨日未绑定当日绑定 + 昨日全量数据
-- TMP_FCT_SZRMB_BUS_DTL_03
个人、对公 去除非绑定记录 + 商户全量（商户不存在绑定）
问题
1. 数据关联字段 牵涉敏感字段，这边无法复现和核对数据。换思路，自己取，每个字段口径参考代码
2.
*/
-- 首次签约记录信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240618101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240618101_CST_01 AS
SELECT   RCV_ACT_ID
        ,PAY_ACT_ID
        ,EFT_DT
FROM    (
            SELECT   RCV_ACT_ID
                    ,PAY_ACT_ID
                    ,EFT_DT
                    ,ROW_NUMBER() OVER (PARTITION BY RCV_ACT_ID ORDER BY CRT_TM ) AS RN -- 签约时间最早的一条记录
            FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_DCEP_AGR_INF_DD   -- 数字人民币协议信息
            WHERE   DT = '@@{yyyyMMdd}'
        ) A
WHERE   A.RN = 1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240618101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240618101_CST_02 AS
--个人钱包当日新增
SELECT  '@@{yyyy-MM-dd}'                                AS ACG_DT
        ,'1'                                            AS BUS_TYP -- 1-个人钱包 2-对公钱包 3-商户
        ,COALESCE(B.CST_ID, D.CST_ID, A.CST_ID)         AS CST_ID
        ,COALESCE(A.CST_NM, B.CST_CHN_NM)               AS CST_NM
        ,A.WAL_ID                                       AS WLT_ID
        ,IF(C.PAY_ACT_ID IS NULL, '0', '1')             AS IS_BIND
        ,COALESCE(C.PAY_ACT_ID, '')                     AS CST_ACT_ID
        ,A.TEL_NBR                                      AS MBL_NBR
        ,SUBSTR(TO_DATE(A.OPN_DT, 'yyyyMMdd'), 1, 10)   AS APL_DT
        ,A.MGR_ID                                       AS RCM_ID --推荐人
        ,COALESCE(F.ORG_ID, '')                         AS RCM_ORG_ID --推荐人所属机构
        ,COALESCE(E.MGR_ID, '')                         AS MGR_ID --账户存款主管护客户经理
        ,COALESCE(E.ACS_ORG_ID, '')                     AS MGR_ORG_ID --账户存款主管户经理所在机构
        ,COALESCE(F.ORG_ID, E.ACS_ORG_ID, G.PRM_ORG_ID) AS ACS_ORG_ID --考核口径机构
        ,COALESCE(D.OPN_ORG_ID, G.PRM_ORG_ID)           AS OPN_ORG_ID --存款帐号开户机构 报送口径机构
        ,''                                             AS IS_ACS -- 废弃
        ,COALESCE(C.EFT_DT, '')                         AS BIND_DT
FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_DCEP_WAL_INF_DD A    -- 数字人民币钱包信息
-- LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_CST_BAS_INF_DD B         -- 客户基础信息汇总表
-- ON      B.DT = '@@{yyyyMMdd}'
-- AND     A.DOC_NBR = B.DOC_NBR
-- AND     B.DOC_TYP_CD = 'B0101'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_ADM_PBLC_CST_PRM_MNG_INF_DD G --客户管户信息
ON      B.CST_ID = G.CST_ID
AND     G.DT = '@@{yyyyMMdd}'
LEFT JOIN    TMP_FCT_SZRMB_BUS_DTL_01 C
ON      C.RCV_ACT_ID = A.WAL_ID
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DIM_BUS_DEP_CST_ACT_INF_DD D      -- 客户存款账户信息
ON      D.DT = '@@{yyyyMMdd}'
AND     C.PAY_ACT_ID = D.CST_ACT_ID
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWD_BUS_DEP_CST_ACT_MGR_INF_DD E  -- 客户存款账户管护信息
ON      E.DT = '@@{yyyyMMdd}'
AND     C.PAY_ACT_ID = E.CST_ACT_ID
AND     E.FRS_CTC_IND = '1'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_HR_EMPE_INF_DD F    -- 员工汇总信息
ON      F.DT = '@@{yyyyMMdd}'
AND     A.MGR_ID = F.EMPE_ID
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.WAL_TYP_CD = '01'     --个人
AND     A.WAL_STS_TYP_CD = '1'
AND     A.OPN_DT = '@@{yyyyMMdd}'
--对公钱包当日新增
UNION ALL
SELECT  '@@{yyyy-MM-dd}'                              AS ACG_DT
        ,'2'                                          AS BUS_TYP -- 1-个人钱包 2-对公钱包 3-商户
        ,COALESCE(B.CST_ID, A.CST_ID)                 AS CST_ID
        ,COALESCE(A.CST_NM, B.CST_CHN_NM)             AS CST_NM
        ,A.WAL_ID                                     AS WLT_ID
        ,IF(C.PAY_ACT_ID IS NULL, '0', '1')           AS IS_BIND
        ,COALESCE(C.PAY_ACT_ID, '')                   AS CST_ACT_ID
        ,A.TEL_NBR                                    AS MBL_NBR
        ,SUBSTR(TO_DATE(A.OPN_DT, 'yyyyMMdd'), 1, 10) AS APL_DT
        ,''                                           AS RCM_ID --推荐人
        ,''                                           AS RCM_ORG_ID --推荐人所属机构
        ,COALESCE(E.MGR_ID, '')                       AS MGR_ID --账户存款主管护客户经理
        ,COALESCE(E.ACS_ORG_ID, '')                   AS MGR_ORG_ID --账户存款主管户经理所在机构
        ,A.TRX_ORG_ID                                 AS ACS_ORG_ID --考核口径机构
        ,''                                           AS OPN_ORG_ID --存款帐号开户机构 报送口径机构
        ,''                                           AS IS_ACS --废弃
        ,COALESCE(C.EFT_DT, '')                       AS BIND_DT
FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_DCEP_WAL_INF_DD A
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_CST_BAS_INF_DD B
ON      B.DT = '@@{yyyyMMdd}'
AND     A.DOC_NBR = B.DOC_NBR
LEFT JOIN    TMP_FCT_SZRMB_BUS_DTL_01 C
ON      C.RCV_ACT_ID = A.WAL_ID
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWD_BUS_DEP_CST_ACT_MGR_INF_DD E
ON      E.DT = '@@{yyyyMMdd}'
AND     C.PAY_ACT_ID = E.CST_ACT_ID
AND     E.FRS_CTC_IND = '1'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_HR_EMPE_INF_DD F
ON      F.DT = '@@{yyyyMMdd}'
AND     A.MGR_ID = F.EMPE_ID
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.WAL_TYP_CD = '09'     --对公
AND     A.WAL_STS_TYP_CD = '1'
AND     A.OPN_DT = '@@{yyyyMMdd}'
--此处没有限制最新一天，如何是新增？
--受理商当日新增
UNION ALL
SELECT  '@@{yyyy-MM-dd}'                               AS ACG_DT
        ,'3'                                           AS BUS_TYP -- 1-个人钱包 2-对公钱包 3-商户
        ,D.MCH_ID                                      AS CST_ID
        ,D.MCH_NM                                      AS CST_NM
        ,D.WAL_ID                                      AS WLT_ID
        ,''                                            AS IS_BIND
        ,''                                            AS CST_ACT_ID
        ,D.UNT_CTC_TEL                                 AS MBL_NBR
        ,SUBSTR(TO_DATE(D.CHNL_DT, 'yyyyMMdd'), 1, 10) AS APL_DT
        ,''                                            AS RCM_ID
        ,''                                            AS RCM_ORG_ID
        ,COALESCE(B.MGR_ID, '')                        AS MGR_ID
        ,''                                            AS MGR_ORG_ID
        ,COALESCE(B.AFL_ORG_ID, '')                    AS ACS_ORG_ID
        ,''                                            AS OPN_ORG_ID
        ,''                                            AS IS_ACS --是否计入考核
        ,''                                            AS BIND_DT
FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_THS_SUB_MCH_INF_DD A   -- 泰惠收子商户基本信息
INNER JOIN    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_THS_MCH_INF_DD B -- 泰惠收商户基本信息
ON      A.CHNL_MCH_ID = B.MCH_ID
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_THS_CHNL_MCH_INF_DD C  -- 泰惠收渠道商信息
ON      B.CHNL_NO = C.CHNL_MCH_ID
AND     C.DT = '@@{yyyyMMdd}'
INNER JOIN    wb_bigdata_manager_dev.dsj_v_DWD_BUS_CHNL_DCEP_MCH_APL_SRL_INF_DI D  -- 商户进件流水信息
ON      B.MCH_ID = D.MCH_ID
AND     D.DT = '@@{yyyyMMdd}'
AND     D.RSP_CD = '00000' --交易成功
AND     D.TRX_STS_CD = '2' -- 0-初始化、1-处理中、2-交易成功、3-交易失败、4-交易超时、5-支付中
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.CHNL_TYP_ID = '310' -- 数字人民币
AND     A.APL_STS_CD = '02'   -- 申请状态为02-成功
AND     C.BUS_CLS NOT LIKE '12'  --业务种类不为线上
--商户状态不为02-注销  00正常 01冻结 02注销 03添加待审核 04修改待审核 05冻结待审核 06恢复待审核 07注销待审核 08新增被拒绝 09修改被拒绝 98 入网中
AND     B.MCH_STS_CD <> '02'
***SJ20240618101_数币推广奖励统计_底表.sql
DROP TABLE IF EXISTS FCT_SZRMB_BUS_DTL;
CREATE TABLE IF NOT EXISTS FCT_SZRMB_BUS_DTL
(
     ACG_DT      STRING COMMENT '数据日期'
    ,BUS_TYP    STRING COMMENT '业务类型' -- 1-个人钱包 2-对公钱包 3-商户
    ,CST_ID     STRING COMMENT '客户/商户号'
    ,CST_NM     STRING COMMENT '客户/商户名称'
    ,WLT_ID     STRING COMMENT '钱包ID'
    ,IS_BIND    STRING COMMENT '是否绑定本行借记卡' --1是 0否
    ,CST_ACT_ID STRING COMMENT '客户账号'
    ,MBL_NBR    STRING COMMENT '手机号'
    ,APL_DT     STRING COMMENT '申请日期'
    ,RCM_ID     STRING COMMENT '推荐人姓名'
    ,RCM_ORG_ID STRING COMMENT '推荐人所属机构号'
    ,MGR_ID     STRING COMMENT '账户存款主管户客户经理'
    ,MGR_ORG_ID STRING COMMENT '账户存款主管护客户经理所属机构号'
    ,ACS_ORG_ID STRING COMMENT '考核口径机构号'
    ,OPN_ORG_ID STRING COMMENT '报送机构号' --个人钱包按报送口径取的机构：负债账号开户机构    对公钱包：6600开立机构
    ,IS_ACS     STRING COMMENT '是否计入考核' --后绑定至同一钱包下不计入考核
    ,BIND_DT    STRING COMMENT '绑定日期'
    ,SBR_ORG_ID STRING COMMENT '支行机构'
    ,SBR_ORG_NM STRING COMMENT '支行机构名称'
    ,BRC_ORG_ID STRING COMMENT '分行机构'
    ,BRC_ORG_NM STRING COMMENT '分行机构名称'
)
COMMENT
'数字人民币钱包明细'
PARTITIONED BY
(
    DT STRING COMMENT '日期分区'
);
DROP TABLE IF EXISTS TMP_FCT_SZRMB_BUS_DTL_01;
CREATE TABLE IF NOT EXISTS TMP_FCT_SZRMB_BUS_DTL_01
(
     RCV_ACT_ID  STRING COMMENT '钱包ID'
    ,PAY_ACT_ID  STRING COMMENT '绑定卡号'
    ,EFT_DT      STRING COMMENT '绑定生效日期'
)
COMMENT
'首次签约记录信息';
INSERT OVERWRITE TABLE TMP_FCT_SZRMB_BUS_DTL_01
SELECT   RCV_ACT_ID
        ,PAY_ACT_ID
        ,EFT_DT
FROM    (
            SELECT   RCV_ACT_ID
                    ,PAY_ACT_ID
                    ,EFT_DT
                    ,ROW_NUMBER() OVER ( PARTITION BY RCV_ACT_ID ORDER BY CRT_TM ) AS RN -- 签约时间最早的一条记录
            FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_DCEP_AGR_INF_DD   -- 数字人民币协议信息
            WHERE   DT = '@@{yyyyMMdd}'
        ) A
WHERE   A.RN = 1;
DROP TABLE IF EXISTS TMP_FCT_SZRMB_BUS_DTL_02;
CREATE TABLE IF NOT EXISTS TMP_FCT_SZRMB_BUS_DTL_02
(
     ACG_DT     STRING COMMENT '数据日期'
    ,BUS_TYP    STRING COMMENT '业务类型' -- 1-个人钱包 2-对公钱包 3-商户
    ,CST_ID     STRING COMMENT '客户/商户号'
    ,CST_NM     STRING COMMENT '客户/商户名称'
    ,WLT_ID     STRING COMMENT '钱包ID'
    ,IS_BIND    STRING COMMENT '是否绑定本行借记卡' --1是 0否
    ,CST_ACT_ID STRING COMMENT '客户账号'
    ,MBL_NBR    STRING COMMENT '手机号'
    ,APL_DT     STRING COMMENT '申请日期'
    ,RCM_ID     STRING COMMENT '推荐人姓名'
    ,RCM_ORG_ID STRING COMMENT '推荐人所属机构号'
    ,MGR_ID     STRING COMMENT '账户存款主管户客户经理'
    ,MGR_ORG_ID STRING COMMENT '账户存款主管护客户经理所属机构号'
    ,ACS_ORG_ID STRING COMMENT '考核口径机构号'
    ,OPN_ORG_ID STRING COMMENT '报送机构号' --个人钱包按报送口径取的机构：负债账号开户机构    对公钱包：6600开立机构
    ,IS_ACS     STRING COMMENT '是否计入考核' --后绑定至同一钱包下不计入考核
    ,BIND_DT    STRING COMMENT '绑定日期'
)
COMMENT
'数字人民币钱包明细-临时表';
INSERT OVERWRITE TABLE TMP_FCT_SZRMB_BUS_DTL_02
--个人钱包当日新增
SELECT  '@@{yyyy-MM-dd}'                                AS ACG_DT
        ,'1'                                            AS BUS_TYP -- 1-个人钱包 2-对公钱包 3-商户
        ,COALESCE(B.CST_ID, D.CST_ID, A.CST_ID)         AS CST_ID
        ,COALESCE(A.CST_NM, B.CST_CHN_NM)               AS CST_NM
        ,A.WAL_ID                                       AS WLT_ID
        ,IF(C.PAY_ACT_ID IS NULL, '0', '1')             AS IS_BIND
        ,COALESCE(C.PAY_ACT_ID, '')                     AS CST_ACT_ID
        ,A.TEL_NBR                                      AS MBL_NBR
        ,SUBSTR(TO_DATE(A.OPN_DT, 'yyyyMMdd'), 1, 10)   AS APL_DT
        ,A.MGR_ID                                       AS RCM_ID --推荐人
        ,COALESCE(F.ORG_ID, '')                         AS RCM_ORG_ID --推荐人所属机构
        ,COALESCE(E.MGR_ID, '')                         AS MGR_ID --账户存款主管护客户经理
        ,COALESCE(E.ACS_ORG_ID, '')                     AS MGR_ORG_ID --账户存款主管户经理所在机构
        ,COALESCE(F.ORG_ID, E.ACS_ORG_ID, G.PRM_ORG_ID) AS ACS_ORG_ID --考核口径机构
        ,COALESCE(D.OPN_ORG_ID, G.PRM_ORG_ID)           AS OPN_ORG_ID --存款帐号开户机构 报送口径机构
        ,''                                             AS IS_ACS -- 废弃
        ,COALESCE(C.EFT_DT, '')                         AS BIND_DT
FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_DCEP_WAL_INF_DD A    -- 数字人民币钱包信息
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_CST_BAS_INF_DD B         -- 客户基础信息汇总表
ON      B.DT = '@@{yyyyMMdd}'
AND     A.DOC_NBR = B.DOC_NBR
AND     B.DOC_TYP_CD = 'B0101'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_ADM_PBLC_CST_PRM_MNG_INF_DD G --客户管户信息
ON      B.CST_ID = G.CST_ID
AND     G.DT = '@@{yyyyMMdd}'
LEFT JOIN    TMP_FCT_SZRMB_BUS_DTL_01 C
ON      C.RCV_ACT_ID = A.WAL_ID
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DIM_BUS_DEP_CST_ACT_INF_DD D      -- 客户存款账户信息
ON      D.DT = '@@{yyyyMMdd}'
AND     C.PAY_ACT_ID = D.CST_ACT_ID
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWD_BUS_DEP_CST_ACT_MGR_INF_DD E  -- 客户存款账户管护信息
ON      E.DT = '@@{yyyyMMdd}'
AND     C.PAY_ACT_ID = E.CST_ACT_ID
AND     E.FRS_CTC_IND = '1'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_HR_EMPE_INF_DD F    -- 员工汇总信息
ON      F.DT = '@@{yyyyMMdd}'
AND     A.MGR_ID = F.EMPE_ID
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.WAL_TYP_CD = '01'     --个人
AND     A.WAL_STS_TYP_CD = '1'
AND     A.OPN_DT = '@@{yyyyMMdd}'
--对公钱包当日新增
UNION ALL
SELECT  '@@{yyyy-MM-dd}'                              AS ACG_DT
        ,'2'                                          AS BUS_TYP -- 1-个人钱包 2-对公钱包 3-商户
        ,COALESCE(B.CST_ID, A.CST_ID)                 AS CST_ID
        ,COALESCE(A.CST_NM, B.CST_CHN_NM)             AS CST_NM
        ,A.WAL_ID                                     AS WLT_ID
        ,IF(C.PAY_ACT_ID IS NULL, '0', '1')           AS IS_BIND
        ,COALESCE(C.PAY_ACT_ID, '')                   AS CST_ACT_ID
        ,A.TEL_NBR                                    AS MBL_NBR
        ,SUBSTR(TO_DATE(A.OPN_DT, 'yyyyMMdd'), 1, 10) AS APL_DT
        ,''                                           AS RCM_ID --推荐人
        ,''                                           AS RCM_ORG_ID --推荐人所属机构
        ,COALESCE(E.MGR_ID, '')                       AS MGR_ID --账户存款主管护客户经理
        ,COALESCE(E.ACS_ORG_ID, '')                   AS MGR_ORG_ID --账户存款主管户经理所在机构
        ,A.TRX_ORG_ID                                 AS ACS_ORG_ID --考核口径机构
        ,''                                           AS OPN_ORG_ID --存款帐号开户机构 报送口径机构
        ,''                                           AS IS_ACS --废弃
        ,COALESCE(C.EFT_DT, '')                       AS BIND_DT
FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_DCEP_WAL_INF_DD A
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_CST_BAS_INF_DD B
ON      B.DT = '@@{yyyyMMdd}'
AND     A.DOC_NBR = B.DOC_NBR
LEFT JOIN    TMP_FCT_SZRMB_BUS_DTL_01 C
ON      C.RCV_ACT_ID = A.WAL_ID
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWD_BUS_DEP_CST_ACT_MGR_INF_DD E
ON      E.DT = '@@{yyyyMMdd}'
AND     C.PAY_ACT_ID = E.CST_ACT_ID
AND     E.FRS_CTC_IND = '1'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DWS_HR_EMPE_INF_DD F
ON      F.DT = '@@{yyyyMMdd}'
AND     A.MGR_ID = F.EMPE_ID
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.WAL_TYP_CD = '09'     --对公
AND     A.WAL_STS_TYP_CD = '1'
AND     A.OPN_DT = '@@{yyyyMMdd}'
--此处没有限制最新一天，如何是新增？
--受理商当日新增
UNION ALL
SELECT  '@@{yyyy-MM-dd}'                               AS ACG_DT
        ,'3'                                           AS BUS_TYP -- 1-个人钱包 2-对公钱包 3-商户
        ,D.MCH_ID                                      AS CST_ID
        ,D.MCH_NM                                      AS CST_NM
        ,D.WAL_ID                                      AS WLT_ID
        ,''                                            AS IS_BIND
        ,''                                            AS CST_ACT_ID
        ,D.UNT_CTC_TEL                                 AS MBL_NBR
        ,SUBSTR(TO_DATE(D.CHNL_DT, 'yyyyMMdd'), 1, 10) AS APL_DT
        ,''                                            AS RCM_ID
        ,''                                            AS RCM_ORG_ID
        ,COALESCE(B.MGR_ID, '')                        AS MGR_ID
        ,''                                            AS MGR_ORG_ID
        ,COALESCE(B.AFL_ORG_ID, '')                    AS ACS_ORG_ID
        ,''                                            AS OPN_ORG_ID
        ,''                                            AS IS_ACS --是否计入考核
        ,''                                            AS BIND_DT
FROM    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_THS_SUB_MCH_INF_DD A   -- 泰惠收子商户基本信息
INNER JOIN    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_THS_MCH_INF_DD B -- 泰惠收商户基本信息
ON      A.CHNL_MCH_ID = B.MCH_ID
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DIM_BUS_CHNL_THS_CHNL_MCH_INF_DD C  -- 泰惠收渠道商信息
ON      B.CHNL_NO = C.CHNL_MCH_ID
AND     C.DT = '@@{yyyyMMdd}'
INNER JOIN    wb_bigdata_manager_dev.dsj_v_DWD_BUS_CHNL_DCEP_MCH_APL_SRL_INF_DI D  -- 商户进件流水信息
ON      B.MCH_ID = D.MCH_ID
AND     D.DT = '@@{yyyyMMdd}'
AND     D.RSP_CD = '00000' --交易成功
AND     D.TRX_STS_CD = '2' -- 0-初始化、1-处理中、2-交易成功、3-交易失败、4-交易超时、5-支付中
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.CHNL_TYP_ID = '310' -- 数字人民币
AND     A.APL_STS_CD = '02'   -- 申请状态为02-成功
AND     C.BUS_CLS NOT LIKE '12'  --业务种类不为线上
--商户状态不为02-注销  00正常 01冻结 02注销 03添加待审核 04修改待审核 05冻结待审核 06恢复待审核 07注销待审核 08新增被拒绝 09修改被拒绝 98 入网中
AND     B.MCH_STS_CD <> '02'
;
DROP TABLE IF EXISTS TMP_FCT_SZRMB_BUS_DTL_03;
CREATE TABLE IF NOT EXISTS TMP_FCT_SZRMB_BUS_DTL_03
(
    ACG_DT      STRING COMMENT '数据日期'
    ,BUS_TYP    STRING COMMENT '业务类型' -- 1-个人钱包 2-对公钱包 3-商户
    ,CST_ID     STRING COMMENT '客户/商户号'
    ,CST_NM     STRING COMMENT '客户/商户名称'
    ,WLT_ID     STRING COMMENT '钱包ID'
    ,IS_BIND    STRING COMMENT '是否绑定本行借记卡' --1是 0否
    ,CST_ACT_ID STRING COMMENT '客户账号'
    ,MBL_NBR    STRING COMMENT '手机号'
    ,APL_DT     STRING COMMENT '申请日期'
    ,RCM_ID     STRING COMMENT '推荐人姓名'
    ,RCM_ORG_ID STRING COMMENT '推荐人所属机构号'
    ,MGR_ID     STRING COMMENT '账户存款主管户客户经理'
    ,MGR_ORG_ID STRING COMMENT '账户存款主管护客户经理所属机构号'
    ,ACS_ORG_ID STRING COMMENT '考核口径机构号'
    ,OPN_ORG_ID STRING COMMENT '报送机构号' --个人钱包按报送口径取的机构：负债账号开户机构    对公钱包：6600开立机构
    ,IS_ACS     STRING COMMENT '是否计入考核' --后绑定至同一钱包下不计入考核
    ,BIND_DT    STRING COMMENT '绑定日期'
    ,SBR_ORG_ID STRING COMMENT '支行机构'
    ,SBR_ORG_NM STRING COMMENT '支行机构名称'
    ,BRC_ORG_ID STRING COMMENT '分行机构'
    ,BRC_ORG_NM STRING COMMENT '分行机构名称'
    ,RANK       INT    COMMENT '序号'
)
COMMENT
'数字人民币钱包明细-临时表2';
INSERT OVERWRITE TABLE TMP_FCT_SZRMB_BUS_DTL_03
SELECT  '@@{yyyy-MM-dd}'                                                                  AS ACG_DT
        ,A.BUS_TYP                                                                        AS BUS_TYP
        ,A.CST_ID                                                                         AS CST_ID
        ,A.CST_NM                                                                         AS CST_NM
        ,A.WLT_ID                                                                         AS WLT_ID
        ,A.IS_BIND                                                                        AS IS_BIND
        ,A.CST_ACT_ID                                                                     AS CST_ACT_ID
        ,A.MBL_NBR                                                                        AS MBL_NBR
        ,A.APL_DT                                                                         AS APL_DT
        ,A.RCM_ID                                                                         AS RCM_ID
        ,A.RCM_ORG_ID                                                                     AS RCM_ORG_ID
        ,A.MGR_ID                                                                         AS MGR_ID
        ,A.MGR_ORG_ID                                                                     AS MGR_ORG_ID
        ,A.ACS_ORG_ID                                                                     AS ACS_ORG_ID
        ,A.OPN_ORG_ID                                                                     AS OPN_ORG_ID
        ,A.IS_ACS                                                                         AS IS_ACS
        ,A.BIND_DT                                                                        AS BIND_DT
        ,B.SBR_ORG_ID                                                                     AS SBR_ORG_ID
        ,B.SBR_ORG_NM                                                                     AS SBR_ORG_NM
        ,COALESCE(B.BRC_ORG_ID, CONCAT(SUBSTR(A.ACS_ORG_ID, 1, 4), '99999'), '999999999') AS BRC_ORG_ID
        ,COALESCE(B.BRC_ORG_NM, '')                                                       AS BRC_ORG_NM
        ,ROW_NUMBER() OVER ( PARTITION BY WLT_ID , BUS_TYP ORDER BY BIND_DT DESC )        AS RANK
FROM    TMP_FCT_SZRMB_BUS_DTL_02 A
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DIM_HR_ORG_MNG_ORG_TREE_DD B   -- 机构树_考核维度
ON      B.DT = '@@{yyyyMMdd}'
AND     A.ACS_ORG_ID = B.ORG_ID
WHERE   A.BUS_TYP IN ( '1' , '2' )
--对公无需更新：此句什么意思？
UNION ALL
SELECT  '@@{yyyy-MM-dd}'                                                                  AS ACG_DT
        ,A.BUS_TYP                                                                        AS BUS_TYP
        ,A.CST_ID                                                                         AS CST_ID
        ,A.CST_NM                                                                         AS CST_NM
        ,A.WLT_ID                                                                         AS WLT_ID
        ,A.IS_BIND                                                                        AS IS_BIND
        ,A.CST_ACT_ID                                                                     AS CST_ACT_ID
        ,A.MBL_NBR                                                                        AS MBL_NBR
        ,A.APL_DT                                                                         AS APL_DT
        ,A.RCM_ID                                                                         AS RCM_ID
        ,A.RCM_ORG_ID                                                                     AS RCM_ORG_ID
        ,A.MGR_ID                                                                         AS MGR_ID
        ,A.MGR_ORG_ID                                                                     AS MGR_ORG_ID
        ,A.ACS_ORG_ID                                                                     AS ACS_ORG_ID
        ,A.OPN_ORG_ID                                                                     AS OPN_ORG_ID
        ,A.IS_ACS                                                                         AS IS_ACS
        ,A.BIND_DT                                                                        AS BIND_DT
        ,B.SBR_ORG_ID                                                                     AS SBR_ORG_ID
        ,B.SBR_ORG_NM                                                                     AS SBR_ORG_NM
        ,COALESCE(B.BRC_ORG_ID, CONCAT(SUBSTR(A.ACS_ORG_ID, 1, 4), '99999'), '999999999') AS BRC_ORG_ID
        ,COALESCE(B.BRC_ORG_NM, '')                                                       AS BRC_ORG_NM
        ,1                                                                                AS RANK
FROM    TMP_FCT_SZRMB_BUS_DTL_02 A
LEFT JOIN    wb_bigdata_manager_dev.dsj_v_DIM_HR_ORG_MNG_ORG_TREE_DD B
ON      B.DT = '@@{yyyyMMdd}'
AND     A.ACS_ORG_ID = B.ORG_ID
WHERE   A.BUS_TYP = '3';
ALTER TABLE FCT_SZRMB_BUS_DTL DROP IF EXISTS PARTITION ( DT = '@@{yyyyMMdd}' );
--输出到结果表
INSERT INTO TABLE FCT_SZRMB_BUS_DTL PARTITION (DT = '@@{yyyyMMdd}')
SELECT  ACG_DT
        ,BUS_TYP
        ,CST_ID
        ,CST_NM
        ,WLT_ID
        ,IS_BIND
        ,CST_ACT_ID
        ,MBL_NBR
        ,APL_DT
        ,RCM_ID
        ,RCM_ORG_ID
        ,MGR_ID
        ,MGR_ORG_ID
        ,ACS_ORG_ID
        ,OPN_ORG_ID
        ,IS_ACS
        ,BIND_DT
        ,SBR_ORG_ID
        ,SBR_ORG_NM
        ,BRC_ORG_ID
        ,BRC_ORG_NM
FROM    TMP_FCT_SZRMB_BUS_DTL_03
WHERE   RANK = 1
***SJ20240618101_数币推广奖励统计_结果.sql
-- 数币统计表
/*
1. 20240601-20240615 对公、个人
2. 杭州、宁波、温州、绍兴、金华、湖州
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20240618101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240618101_CST_01 AS
SELECT  t2.brc_org_id AS 分行机构号
       ,t2.brc_org_nm AS 分行机构名称
       ,t2.sbr_org_id AS 支行机构号
       ,t2.sbr_org_nm AS 支行机构名称
        -- 线下受理商
        ,case when IND_ID='030000' then CUR_AMT else 0 end      线下受理商个数
        -- 对公钱包
        ,case when IND_ID='020001' then CUR_AMT else 0 end      对公钱包个数_已绑定
        ,case when IND_ID='020002' then CUR_AMT else 0 end      对公钱包个数_未绑定
        ,case when IND_ID='02000001' then CUR_AMT else 0 end    对公钱包个数_月活数
        -- 个人钱包
        ,case when IND_ID='010101' then CUR_AMT else 0 end      个人钱包个数_已绑定_报送
        ,case when IND_ID='010102' then CUR_AMT else 0 end      个人钱包个数_未绑定_报送
        ,case when IND_ID='01010001' then CUR_AMT else 0 end    个人钱包个数_月活数_报送
        ,case when IND_ID='010201' then CUR_AMT else 0 end      个人钱包个数_已绑定_考核
        ,case when IND_ID='010202' then CUR_AMT else 0 end      个人钱包个数_未绑定_考核
        ,case when IND_ID='01020001' then CUR_AMT else 0 end    个人钱包个数_月活数_考核
        ,case when IND_ID='010204' then CUR_AMT else 0 end      个人钱包个数_绑定维度
        ,case when IND_ID='020204' then CUR_AMT else 0 end      对公钱包个数_绑定维度
        -- 交易笔数
        ,case when IND_ID='01000402' then CUR_AMT else 0 end    交易笔数_兑出兑回
        ,case when IND_ID='01000404' then CUR_AMT else 0 end    交易笔数_转账
        ,case when IND_ID='03000406' then CUR_AMT else 0 end    交易笔数_消费
        -- 交易金额
        ,case when IND_ID='01000403' then CUR_AMT else 0 end    交易金额_兑出兑回
        ,case when IND_ID='01000405' then CUR_AMT else 0 end    交易金额_转账
        ,case when IND_ID='03000407' then CUR_AMT else 0 end    交易金额_消费
        -- 贷款
        ,case when IND_ID='04000009' then CUR_AMT else 0 end    数币贷款发放_笔数
        ,case when IND_ID='04000008' then CUR_AMT else 0 end    数币贷款发放_金额
from lab_bigdata_dev.FCT_SZRMB_BUS_STAT             t1
inner JOIN edw.DIM_HR_ORG_MNG_ORG_TREE_DD   t2
AND     t1.ORG_ID = t2.ORG_ID
ON      t2.DT = '20240615'
and t2.brc_org_nm regexp '杭州|宁波|温州|绍兴|金华|湖州'
where t1.dt = '20240615'
and t1.APL_DT between '20240601' and '20240615'
GROUP BY t2.brc_org_id,t2.brc_org_nm,t2.sbr_org_id,t2.sbr_org_nm
;
-- 数币明细表
DROP   TABLE IF     EXISTS SJXQ_SJ20240618101_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240618101_CST_10 AS
SELECT row_number() over(order by t1.SBR_ORG_ID,t1.CST_ID) 序号
    ,t1.BRC_ORG_ID   分行机构号
    ,t1.BRC_ORG_NM   分行机构名称
    ,t1.SBR_ORG_ID   支行机构号
    ,t1.SBR_ORG_NM   支行机构名称
    ,t1.CST_ID       客户号
    ,t1.CST_NM       客户名称
    ,t1.BUS_TYP      业务类型
    ,t1.WLT_ID       钱包ID
    ,t1.IS_BIND      是否绑定本行借记卡
    ,t1.CST_ACT_ID   绑定客户账号
    ,t1.MBL_NBR      手机号
    ,t1.APL_DT       申请日期
	,t1.BIND_DT      绑定日期
    ,t2.empe_nm       推荐人
    ,t3.empe_nm       管户客户经理
from lab_bigdata_dev.FCT_SZRMB_BUS_DTL      t1  --当前dt 为历史所有数据合并
LEFT JOIN edw.DWS_HR_EMPE_INF_DD    t2    -- 员工汇总信息
AND     t1.RCM_ID = t2.EMPE_ID
ON      t2.DT = '20240615'
LEFT JOIN edw.DWS_HR_EMPE_INF_DD    t3    -- 员工汇总信息
AND     t1.MGR_ID = t3.EMPE_ID
ON      t3.DT = '20240615'
where t1.dt ='20240615'
and t1.APL_DT between '20240601' and '20240615'
and t1.brc_org_nm regexp '杭州|宁波|温州|绍兴|金华|湖州'
;
***SJ2024062016_征信异常查询.sql
/*
问题：
1. 近2年贷后征信查询 仅泰隆银行查询3次及以上？是
2. 无贷前授权记录，指当前无、近2年最早查询无、近3次查询前无？当前无
*/
-- 近2年泰隆 贷后管理 查询征信3次及以上客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024062016_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062016_CST_01 AS
select qry_cst_id    cst_id     --被查询者客户号|c20
    ,count(distinct rpt_id)     qry_num_lst2y
from edw.dwd_cst_ccrc_ipcr_qry_rcd_di         --人行征信报告查询记录明细
where dt<='@@{yyyyMMdd}'
and dt>='@@{yyyyMMdd-2y}'
and QRY_ORG ='ZJTLCB'   --泰隆银行
and qry_rsn_cd='01'     --贷后管理
group by qry_cst_id
having count(distinct rpt_id)>=3    --3次及以上
;
-- 最近2年内的查询次数（贷后管理）
DROP   TABLE IF     EXISTS SJXQ_SJ2024062016_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062016_CST_02 AS
select t1.cst_id                             --被查询者客户号|c20
    ,t1.qry_num_lst2y
	,t2.qry_nm                               --被查询者姓名|c90
    ,t2.2year_loan_mng_qry_tms      --最近2年内的查询次数（贷后管理）
from SJXQ_SJ2024062016_CST_01               t1
left join(
    select qry_cst_id,qry_nm,2year_loan_mng_qry_tms
        ,row_number() over(partition by qry_cst_id order by dt desc)rn
    from edw.dwd_cst_ccrc_ipcr_qry_inf_di --人行征信报告查询概要信息
    where dt<='@@{yyyyMMdd}'
)t2 on t1.cst_id=t2.qry_cst_id
and t2.rn=1     --最新征信
;
-- 当前有授权记录客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024062016_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062016_CST_03 AS
SElECT customerid	cst_id --客户号
from edw.loan_authorization_records --信贷授权记录表
where dt='@@{yyyyMMdd}'
and iseffective='1'
;
-- 查询人 近2年记录
DROP   TABLE IF     EXISTS SJXQ_SJ2024062016_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062016_CST_04 AS
SELECT  cast(CC.CUSTOMER_ID as string)  AS cst_id
       ,CC.CLIENT_NAME   AS 客户名称
       ,CC.CALL_SYS_USER AS 查询人
       ,CC.ext2          AS 查询人所在机构
FROM    edw.ncip_cpq_resultinfo cc
WHERE   CC.STATUS = '1' --查询成功
AND     CC.SOURCE = '2' --查询人行
AND     CC.oper_org IN ( '990000000' , '426199999' , '336199999' ) --我行
AND     CC.CALL_SYS_USER NOT RLIKE '^[A-Za-z]+$' --NOT REGEXP_LIKE(CC.CALL_SYS_USER, '^[A-Za-z]+$') --剔除批量
AND     replace(substr(CC.QUERY_TIME,1,10),'-','') BETWEEN '@@{yyyyMMdd-2y}' and '@@{yyyyMMdd}'
AND     CC.dt between '@@{yyyyMMdd-2y}' and '@@{yyyyMMdd}'
union
SELECT  CC.CUSTOMER_ID   AS cst_id
       ,CC.CLIENT_NAME   AS 客户名称
       ,CC.CALL_SYS_USER AS 查询人
       ,CC.ext2          AS 查询人所在机构
FROM    edw.ncip_ceq_resultinfo cc
WHERE   CC.STATUS = '1' --查询成功
AND     CC.SOURCE = '2' --查询人行
AND     CC.oper_org IN ( '990000000' , '426199999' , '336199999' ) --我行
AND     CC.CALL_SYS_USER NOT RLIKE '^[A-Za-z]+$' --剔除批量
AND     replace(substr(CC.QUERY_TIME,1,10),'-','') BETWEEN '@@{yyyyMMdd-2y}' and '@@{yyyyMMdd}'
AND     CC.dt between '@@{yyyyMMdd-2y}' and '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024062016_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062016_CST_05 AS
SElECT t1.cst_id 			as 客户号
    ,t3.客户名称             as 客户姓名
    ,t3.查询人               as 征信查询人
    ,t4.org_id              as 查询人所在机构号
    ,t3.查询人所在机构       as 查询人所在机构名称
    ,T5.PRM_MGR_NM          as 主管户客户经理
    ,T5.PRM_ORG_ID          as 主管户机构号
    ,T6.ORG_NM              as 主管户机构名称
from SJXQ_SJ2024062016_CST_01       t1
left join SJXQ_SJ2024062016_CST_03  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024062016_CST_04  t3
on t1.cst_id=t3.cst_id
left join edw.dws_hr_empe_inf_dd    t4 --员工信息汇总
on  t3.查询人=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t5 --客户`主管户`信息
on  t1.cst_id = t5.cst_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t5.prm_org_id = t6.org_id
and t6.dt = '@@{yyyyMMdd}'
where t2.cst_id is null     --当前未授权
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062016_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062016_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062016_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062016_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024062016_CST_05
***SJ2024062036_泰惠收受益人排查.sql
-- 客群
DROP   TABLE IF EXISTS SJXQ_SJ2024062036_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024062036_CST_01
(
mch_nm string       --商户名称
,mch_id string      --商户号
,bus_lcn_nbr string --营业执照号
)
;
insert into SJXQ_SJ2024062036_CST_01
values
;
-- 匹配客户号
DROP   TABLE IF EXISTS SJXQ_SJ2024062036_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2024062036_CST_02 AS
SELECT t1.mch_id,t1.mch_nm,t1.bus_lcn_nbr,T1.CST_ID
	,t2.cst_nm                                   --客户名称
	,t2.lgp_cst_id                               --对公客户法人客户号
	,t2.lgp_nm                                   --对公客户法人客户名称
	,t2.lgp_doc_id                               --对公客户法人证件号
    ,ROW_NUMBER() OVER(PARTITION BY T1.mch_id ORDER BY typ) rn
FROM(
    SElECT T1.mch_id,t1.mch_nm,t1.bus_lcn_nbr,t2.cst_id,'1' typ --优先
        ,row_number() over(partition by t1.bus_lcn_nbr order by t2.late_upd_dt desc)rn
    from SJXQ_SJ2024062036_CST_01           t1
    inner join edw.dim_cst_entp_bas_inf_dd	t2 --企业客户基本信息
    on t1.bus_lcn_nbr=t2.lctax_cert_no
    and t2.dt='@@{yyyyMMdd}'
    union all
    SElECT T1.mch_id,t1.mch_nm,t1.bus_lcn_nbr,t2.cst_id,'2' typ
        ,row_number() over(partition by t1.mch_nm order by t2.late_upd_dt desc)rn
    from SJXQ_SJ2024062036_CST_01           t1
    inner join edw.dim_cst_entp_bas_inf_dd	t2 --企业客户基本信息
    on t1.mch_nm=t2.cst_nm
    and t2.dt='@@{yyyyMMdd}'
)T1 left join edw.dim_cst_entp_lgp_inf_dd   t2          --对公客户法人信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
WHERE t1.RN=1
;
-- 法人，受益人信息
DROP   TABLE IF EXISTS SJXQ_SJ2024062036_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ2024062036_CST_03 AS
SElECT t1.mch_id,t1.mch_nm,t1.bus_lcn_nbr
    ,T2.CST_ID
	,t2.cst_nm                                   --客户名称
	,t2.lgp_cst_id                               --对公客户法人客户号
	,t2.lgp_nm                                   --对公客户法人客户名称
	,t2.lgp_doc_id                               --对公客户法人证件号
    ,t5.rel_cst_id
    ,t6.entp_syr_doc_nbr
    ,t6.cst_chn_nm
    ,case when t2.lgp_doc_id=t6.entp_syr_doc_nbr or t2.lgp_cst_id=t5.rel_cst_id then '是' else '' end is_equal
from SJXQ_SJ2024062036_CST_01               t1
LEFT JOIN SJXQ_SJ2024062036_CST_02          T2
ON  T1.mch_id=t2.mch_id
AND T2.rn=1
LEFT JOIN    EDW.DIM_CST_REL_INF_DD         t5
ON      t2.cst_id = t5.CST_ID
AND     t5.REL_TYP_CD LIKE '09%' --受益人
AND     t5.DT = '@@{yyyyMMdd}'
left join(
    SElECT t1.cst_id,t2.cst_chn_nm,t1.doc_nbr   entp_syr_doc_nbr
    from edw.dim_cst_bas_doc_inf_dd         t1
    inner join edw.dim_cst_idv_bas_inf_dd   t2
    on t1.cst_id=t2.cst_id
    and t2.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    union
    SElECT relation_id,rel_per_name,cert_no
    from edw.ecif_t01_org_relationer_info --对公关系人信息表
    where dt='@@{yyyyMMdd}'
    and UPDATED_TS = '9999-12-31 00:00:00'
)t6 on t5.rel_cst_id=t6.cst_id
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ2024062036_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ2024062036_CST_04 AS
SELECT  t1.mch_nm      AS 商户名称
       ,t1.mch_id      AS 商户号
       ,t1.bus_lcn_nbr AS 营业执照号
       ,t2.status      AS 门店状态
       ,t1.lgp_cst_id  AS 法人客户号
       ,t1.lgp_nm      AS 法人姓名
       ,t1.rel_cst_id  AS 企业受益人客户号
       ,t1.cst_chn_nm  AS 企业受益人姓名
       ,t1.is_equal    AS 企业法人和受益人是否一致
from SJXQ_SJ2024062036_CST_03 t1
left join edw.shlm_biz_shop     t2
on  t1.mch_id=t2.merchant_id
and t2.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ2024062036_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ2024062036_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ2024062036_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 商户号) custs
from SJXQ_SJ2024062036_CST_04
***SJ2024062146_同一风险控制号是否关联配偶.sql
-- 客群 客户号重复较多
DROP   TABLE IF EXISTS SJXQ_SJ2024062146_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024062146_CST_01
(
busi_ctr_id string
,cst_id     string
,cst_nm     string
)
;
insert into SJXQ_SJ2024062146_CST_01
values
;
-- 配偶关系
DROP   TABLE IF     EXISTS SJXQ_SJ2024062146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062146_CST_02 AS
SElECT cst_id,rel_cst_id
from edw.dim_cst_rel_inf_dd         --客户关联关系信息
where DT = '@@{yyyyMMdd}'
and rel_typ_cd = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
union
SElECT rel_cst_id,cst_id
from edw.dim_cst_rel_inf_dd         --客户关联关系信息
where DT = '@@{yyyyMMdd}'
and rel_typ_cd = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
--因 dwd_cst_rel_inf_dd 和 dim_cst_rel_inf_dd 两张表数据有交叉又有遗漏，都取了
union
SElECT cst_id,rel_cst_id
from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
where DT = '@@{yyyyMMdd}'
and REL_REL_CD = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
union
SElECT rel_cst_id,cst_id
from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
where DT = '@@{yyyyMMdd}'
and REL_REL_CD = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
;
-- 同一风险控制号
DROP   TABLE IF EXISTS SJXQ_SJ2024062146_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ2024062146_CST_03 AS
SElECT t1.cst_id
    ,t2.mrg_situ_cd	        --婚姻状况代码
    ,decode(t2.mrg_situ_cd,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','')  mrg_situ
    ,t3.sam_rsk_ctrl_id     --同一风险控制号
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024062146_CST_01
)t1 left join edw.dim_cst_idv_bas_inf_dd    t2 --个人客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd 		    t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
-- 关联客户是否为配偶
DROP   TABLE IF EXISTS SJXQ_SJ2024062146_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ2024062146_CST_04 AS
SElECT t1.cst_id
    ,sum(case when t4.cst_id is not null then 1 else 0 end) is_po
from SJXQ_SJ2024062146_CST_03       t1
left join edw.dws_cst_bas_inf_dd 	t3 --客户基础信息汇总表
on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024062146_CST_02  t4
on t1.cst_id=t4.cst_id
and t3.cst_id=t4.rel_cst_id
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ2024062146_CST_05 PURGE;
CREATE TABLE           SJXQ_SJ2024062146_CST_05 AS
SELECT  t1.busi_ctr_id AS 合同流水号
       ,t1.cst_id      AS 客户编号
       ,t1.cst_nm      AS 客户名称
       ,t2.mrg_situ    AS 婚姻状况
       ,case when t3.is_po>=1 then '是' else '' end as 同一风险控制号关联客户是否包含配偶
from SJXQ_SJ2024062146_CST_01       t1
left join SJXQ_SJ2024062146_CST_03  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024062146_CST_04  t3
on t1.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062146_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062146_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062146_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户编号) custs
from SJXQ_SJ2024062146_CST_05
;
/*
*/***SJ2024062156_双录数据.sql
问题：
1. 保险业务交易流水信息表有 双录识别码，理财、基金没听说过有双录，没搜到
2. 录音录像相关字段缺失，只看到双录日期、时间
3. 序列号：双录编号
找到双录相关表
edw.vdrp_qualitytrade	流水表
edw.vdrp_qualitytradeaudit	流水审核表(主表)
edw.vdrp_qualitytradetagaudit	流水审核表(从表  流水标签审核表)
edw.dwd_bus_chnl_cos_vdrp_quat_srl_inf_dd	双录系统质检流水信息
edw.dwd_bus_chnl_cos_vdrp_quat_rvw_srl_inf_dd	双录系统质检流水审核信息
edw.dwd_bus_chnl_cos_vdrp_quat_rvw_lab_inf_dd	双录系统质检流水审核标签信息
edw.dwd_bus_chnl_cos_vdo_rcd_tsk_tm_inf_dd	集中作业平台视频双录任务提醒时间信息
edw.cfin_cust_double_record_log	客户双录流水表
双录类型（1：手机双录，2：财富双录，3：客户级双录）
双录子类型（1：标准财富双录 ，2 ：特殊财富双录，3.风险等级评估双录，4.客户等级评定双录，5.合格投资者认定双录 ）
***SJ2024062171_保险交易信息.sql
保险交易信息问题：
1. 保险产品表的风险评级是 发行机构产品风险评级，还是 本行产品风险评级？
2. 采集日期：取数日期吗？
3. 表名product_plan_solution ，没有找到相关表
4. 目标客户类型：一般个人客户、高资产净值客户、私人银行客户、机构客户、金融同业客户，没搜到
5. 银行机构名称：保险的管户机构、还是推荐人所属机构？
***SJ2024062176_未销过复杂理财清单.sql
-- 客群 客户号重复较多
DROP   TABLE IF EXISTS SJXQ_SJ2024062176_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024062176_CST_01
(
empe_id     string
,empe_nm    string
)
;
insert into SJXQ_SJ2024062176_CST_01
values
;
-- 重点理财产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024062176_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062176_CST_02 AS
select ta_cd
    ,pd_cd                                  --产品代码|C24
	,pd_nm                                  --产品名称|C256
	,clc_start_dt                           --募集开始日期|C8
	,clc_end_dt                             --募集结束日期|C8
	,pd_found_dt                            --产品成立日期|C8
    ,pd_val_dt                              --产品起息日期
	,pd_end_dt                              --产品结束日期|C8
	,actl_found_dt                          --实际成立日期|C8
	,cur_siz                                --当前规模|DECIMAL(20,2)
    ,rsk_grd                                --风险等级
    ,pfm_comp_bas                           --业绩比较基准
    ,pd_actl_clc_amt                        --产品实际募集金额
    ,chm_inv_typ_cd	                        --产品模板|C32
    ,case when pd_nm regexp '挂钩'                        then '挂钩型理财'
        when pd_nm regexp '中证1000自动触发'      then '中证1000自动触发'
        when pd_nm regexp '黄金二元'                   then '黄金二元'
        when pd_nm regexp '丰利兴动多策略封闭式' then '丰利兴动多策略封闭式'
        else '' end pd_cls
from edw.dim_bus_chm_pd_inf_dd  --理财产品信息
where dt='@@{yyyyMMdd}'
and pd_nm regexp '挂钩|丰利兴动多策略封闭式|黄金二元|中证1000自动触发'
and pd_sts_cd<>'3'              --发行失败
;
-- 重点理财交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024062176_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062176_CST_03 AS
SElECT t1.srl_nbr
    ,t1.bnk_act_id ,t1.cst_id ,t1.pd_cd
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,t1.cfm_dt	        --确认日期
    ,T1.trx_amt
	,t1.cfm_amt
	,t1.trx_cd
    ,t1.bus_cd
    ,p1.pd_nm,p1.pd_cls
    ,T2.mgr_id  sale_empe_id
from EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI         t1 --理财交易确认流水明细
inner JOIN SJXQ_SJ2024062176_CST_02         p1
on t1.pd_cd=p1.pd_cd
inner join edw.DWS_BUS_CHM_ACT_MGR_INF_DD   t2 --理财账户管护汇总信息
on t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.bnk_act_id=t2.bnk_act_id
and t2.dt = '20240522'
and t2.MNG_TYP_CD = '2'    --`管户`类型 1考核 2销售
AND t2.PD_TP_CD = '1'      --理财
where T1.DT<='@@{yyyyMMdd}'     --确认日期
AND t1.trx_sts_cd ='8'          --确认成功
and SUBSTR(t1.srl_nbr,1,8) <= '20240522'    --截止20240522
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024062176_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062176_CST_04 AS
SElECT t1.empe_id   as 工号
    ,t1.empe_nm     as 姓名
    ,case when t2.sale_empe_id is not null then '是' else '' end as 是否销售过复杂型理财产品
    ,t2.pd_cls      as 销售复杂型理财产品
from SJXQ_SJ2024062176_CST_01       t1
left join(
    from SJXQ_SJ2024062176_CST_03
    group by sale_empe_id
) t2 on t1.empe_id=t2.sale_empe_id
;
SElECT '01' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ2024062176_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct pd_cd) custs
from SJXQ_SJ2024062176_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062176_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 工号) custs
from SJXQ_SJ2024062176_CST_04
;
/*
*/***SJ2024062466_政和村行信贷客户地址.sql
-- 客群
DROP   TABLE IF EXISTS SJXQ_SJ2024062466_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024062466_CST_01
(
cst_id     string
,cst_nm    string
)
;
insert into SJXQ_SJ2024062466_CST_01
values
;
-- 信贷地址
-- ,'10','注册地址' ,'20','办公地址' ,'30','永久地址' ,'40','经营场所地址' ,'50','户籍地址' ,'60','居住地址' ,'70','其他' ,'80','线上客户维护地址'
DROP   TABLE IF     EXISTS SJXQ_SJ2024062466_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062466_CST_02 AS
SElECT t1.cst_id
    ,t2.address4    addr_office
    ,t3.address4    addr_native
    ,t4.address4    addr_house
    ,t5.address4    addr_operate
from(
    SElECT distinct customerid as cst_id
    from edw.loan_customer_address                --客户联系地址
    where dt='20240622'
)t1 left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240531'
    where t1.dt='20240622' and t1.isnew = '1' -- 最新
    and t1.addtype = '20' -- 办公地址
)t2 on t1.cst_id=t2.cst_id and t2.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240531'
    where t1.dt='20240622' and t1.isnew = '1' -- 最新
    and t1.addtype = '50' -- 户籍地址
)t3 on t1.cst_id=t3.cst_id and t3.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240531'
    where t1.dt='20240622' and t1.isnew = '1' -- 最新
    and t1.addtype = '60' -- 居住地址
)t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240531'
    where t1.dt='20240622' and t1.isnew = '1' -- 最新
    and t1.addtype = '40' -- 经营场所地址
)t5 on t1.cst_id=t5.cst_id and t5.rn=1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024062466_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062466_CST_03 AS
SElECT t1.cst_id,t1.cst_nm
    ,t2.fam_adr_dtl_inf	    --家庭地址
    ,t2.reg_adr_dtl_inf	    --户籍地址
    ,t2.wrk_adr_dtl_inf	    --工作单位地址
    ,t2.fm_ind	            --农户标志
    ,t3.farmer	            --是否农户
    ,t4.addr_office,t4.addr_native,t4.addr_house,t4.addr_operate
from SJXQ_SJ2024062466_CST_01                   t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240622'
left join(
    SElECT customerid cst_id
        ,farmer	                --是否农户
        ,row_number() over(partition by customerid order by updatedate desc) rn
    from edw.loan_survey_ind_info	--客户基本信息
    where dt='20240622'
)t3 on t1.cst_id=t3.cst_id and t3.rn=1
left join SJXQ_SJ2024062466_CST_02 t4
on t1.cst_id=t4.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024062466_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062466_CST_04 AS
SELECT  cst_id                  AS 客户号
       ,cst_nm                  AS 客户名称
       ,if(fm_ind = '1','是','') AS 农户标志_客户集市
       ,if(farmer = '1','是','') AS 是否农户_信贷调查
       ,addr_office             AS 办公地址
       ,addr_native             AS 户籍地址
       ,addr_house              AS 居住地址
       ,addr_operate            AS 经营场所地址
FROM SJXQ_SJ2024062466_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062466_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024062466_CST_03
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024062466_CST_04
***SJ2024062571_监管一季度基金理财数据.sql
/*
表名的话
SJXQ_SJ2024062571_FUND2024_xx
SJXQ_SJ2024062571_FUND2023_xx
SJXQ_SJ2024062571_CHM2024_xx
;...这样子来分表
*/
-- 1. 代理代销产品信息表-基金202403
-- 基金产品上线、停售日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_FUND2024_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_FUND2024_01 AS
SElECT T1.PD_CD
    ,t2.para_value  fund_sale_start_dt
    ,t3.para_value  fund_sale_start_tm
    ,case when nvl(t4.para_value,'')<>'' then t4.para_value when nvl(t5.para_value,'')<>'' then t5.para_value
        else '99991231'     fund_sale_end_dt
from(
    select distinct SUBSTR(T2.pk_value,9,6) PD_CD
        ,pk_value
    from edw.cfin_prod_para_detail
    where dt='@@{yyyyMMdd}'
    and pk_value like 'FUND%'
)t1 left join  edw.cfin_prod_para_detail T2 --产品参数明细表
ON T1.pk_value=T2.pk_value
AND T2.para_code = 'first_online_date'  --首次上线日期
AND T2.dt='@@{yyyyMMdd}'
LEFT JOIN edw.cfin_prod_para_detail T3  --产品参数明细表
ON T1.pk_value=T3.pk_value
AND T3.para_code = 'first_online_time'  --首次上线时间
AND T3.dt='@@{yyyyMMdd}'
LEFT JOIN edw.cfin_prod_para_detail T4  --产品参数明细表
ON T1.pk_value=T4.pk_value
AND T4.para_code = 'end_date'       --到期日
AND T4.dt='@@{yyyyMMdd}'
LEFT JOIN edw.cfin_prod_para_detail T5  --产品参数明细表
ON T1.pk_value=T5.pk_value
AND T5.para_code = 'winding_date'   --清盘日
AND T5.dt='@@{yyyyMMdd}'
;
-- 基金时点存续产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_FUND2024_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_FUND2024_02 AS
SELECT  ''            AS 序列号
       ,''            AS 金融许可证号
       ,''            AS 内部机构号
       ,''            AS 银行机构名称
       ,T1.pd_cd      AS 产品代码
       ,T1.pd_nm      AS 代销产品名称
       ,'基金'        AS 产品类型
       ,''            AS 目标客户类型 --个人客户/机构客户是否允许购买
       ,'公募'        AS 产品募集方式
       ,T1.ta_cd      AS 发行机构代码
       ,T1.ta_nm      AS 发行机构名称
       ,t2.fund_sale_start_dt   AS 首次上线日期
       ,t2.fund_sale_start_tm   as 首次上线时间
       ,t2.fund_sale_end_dt     as 停售日期
       ,T1.rsk_grd_cd            AS 发行机构产品风险评级
       ,''              AS 本行产品风险评级
       ,'存续'          AS 产品状态
       ,'@@{yyyyMMdd}'            AS 采集日期
from edw.dim_bus_chm_fnd_pd_inf_dd      t1 --基金产品基础信息表
LEFT JOIN SJXQ_SJ2024062571_FUND2024_01 t2
on t1.pd_cd=t2.pd_cd
where t1.dt='20240331'
-- and t1.pd_sts_cd<>'8' --产品状态代码 ,'0','可申购赎回' ,'1','发行' ,'4','停止申购赎回' ,'5','停止申购' ,'6','停止赎回' ,'8','基金终止' ,'9','基金封闭'
;
-- 2. 代理代销产品信息表-理财202403
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_CHM2024_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_CHM2024_01 AS
SELECT  ''              AS 序列号
       ,''              AS 金融许可证号
       ,''              AS 内部机构号
       ,''              AS 银行机构名称
       ,T1.pd_cd        AS 产品代码
       ,T1.pd_nm        AS 代销产品名称
       ,'理财'            AS 产品类型
       ,''              AS 目标客户类型 --个人客户/机构客户是否允许购买
       ,'公募'            AS 产品募集方式
       ,t1.ta_cd        AS 发行机构代码
       ,t2.ta_name      AS 发行机构名称
       ,t1.clc_start_dt AS 募集开始日期
       ,t1.clc_end_dt   AS 募集结束日期
-- , pd_found_dt --产品成立日期|C8
-- , pd_val_dt --产品起息日期|C8
-- , pd_end_dt --产品结束日期|C8
-- , actl_found_dt --实际成立日期|C8
       ,t1.rsk_grd     AS 发行机构产品风险评级
       ,''             AS 本行产品风险评级
       ,'存续'           AS 产品状态
       ,'@@{yyyyMMdd}' AS 采集日期
from edw.dim_bus_chm_pd_inf_dd t1 --理财产品信息
left join edw.finc_tbtainfo    t2 --TA信息表
on t1.ta_cd=t2.ta_code
and t2.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.pd_ctg_cd='1' --理财
--,'6','停止赎回','7','权益登记','8','红利发放','9','产品封闭期','a','产品终止' ,'b','预约认购期'
;
-- 3. 客户风险承受能力评估明细
-- 20200101 以来风评次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_FUND2024_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_FUND2024_11 AS
SElECT cst_id,count(distinct ases_dt) ases_num
from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd   --基金客户风险等级信息表
where dt<='@@{yyyyMMdd}'
group by cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_FUND2024_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_FUND2024_12 AS
SELECT  ''                AS 序列号
       ,t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.sco            AS 风险评估得分
       ,t1.cst_rsk_grd_cd AS 风险评估等级
       ,CASE WHEN nvl(ases_num,0) <= 1 THEN '是'  ELSE '否' END AS 是否首次风评
       ,t1.ases_dt        AS 评估日期
       ,''                AS 评估时间
       ,c1.cd_val_dscr    AS chnl_typ_nm
       ,t1.inpt_tlr_id    AS 经办人工号
       ,t3.bnk_org_cd     AS 银行机构代码
       ,t3.fin_lcn_id     AS 金融许可证号
       ,t1.trx_org_id     AS 交易机构号
       ,t3.org_nm         AS 交易机构名称
       ,'@@{yyyyMMdd}'    AS 采集日期
from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd t1 --基金客户风险等级信息表
left join SJXQ_SJ2024062571_FUND2024_11     t2
on t1.cst_id=t2.cst_id
LEFT JOIN    edw.dim_hr_org_bas_inf_dd      t3
ON      t1.trx_org_id = t3.org_id
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON t1.chnl_typ_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
-- 4. 理财风评
-- 历史评估次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_CHM2024_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_CHM2024_11 AS
select cst_id
    ,rsk_lvl_cd                               --风险等级代码  0-5，其中=0时，rsk_vld_prd_stop_dt=1899
    ,late_ases_dt                             --最后评估日期
    ,null
    ,null
    ,'2'    rsk_tbl
from edw.dwd_bus_chm_cst_rsk_ases_dd          --理财客户风险评估结果表
where dt<='20240430'
and late_ases_dt<>'18991231'    --没有过风险评估
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024062571_CHM2024_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062571_CHM2024_12 AS
SELECT  ''              AS 序列号
       ,t1.cust_no         AS 客户号
       ,t1.cust_name       AS 客户名称
       ,t1.point           AS 评分
       ,t1.cust_risk_level AS 客户风险等级
       ,''              AS 是否首次风评
       ,t1.assess_date     AS 评估日期
       ,t1.channel_time    AS 渠道时间
       ,t1.channel_flag    AS 渠道标识
       ,t1.inputuser       AS 交易柜员
       ,t3.bnk_org_cd   AS 银行机构代码
       ,t3.fin_lcn_id   AS 金融许可证号
       ,t1.trans_orgno
       ,t3.org_nm       AS 交易机构名称
       ,'@@{yyyyMMdd}'  AS 采集日期
    --    ,t1.assess_serno    AS 风险评估流水号
from edw.cfin_cust_risk_assess_log      t1 --客户风险评估流水表
LEFT JOIN    edw.dim_hr_org_bas_inf_dd  t3
ON      t1.trans_orgno = t3.org_id
AND     t3.dt = '@@{yyyyMMdd}'
where dt<='20240430'
;
edw.dwd_bus_chm_cst_rsk_ases_dd          --理财客户风险评估结果表
edw.dwd_bus_chm_trx_rqs_srl_dtl_di     t1 --理财交易请求流水明细
SELECT T1.pd_cd,t2.pd_nm
    ,min(T1.trx_dt)                                   --交易日期|C8
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DI                 T1 --理财交易确认流水明细 立英修改
left JOIN edw.dim_bus_chm_pd_inf_dd                 t2 --理财产品信息
ON      t1.pd_cd = t2.pd_cd
AND     t2.dt = '@@{yyyyMMdd}'
where T1.DT<='@@{yyyyMMdd}'
AND t1.trx_sts_cd ='8'              --确认成功
and t1.trx_dt<>'18991231'
group by T1.pd_cd,t2.pd_nm
***SJ2024062706_绍兴分行举一反三第二期.sql
/*
1.数据范围
绍兴分行截止2024年5月31日未结清授信业务；
2.具备以下特征之一的客户在我行的业务情况：
（1）由同个人员代理开立我行账户，在我行有授信，且授信客户间未纳入关联管理的客户；
（2）在我行有授信的客户间有夫妻关系或持股关系或担任高管的（法人、董事、股东、监事），且未纳入关联管理的客户在我行的业务情况。
3.具备以下特征之一的业务：
（1）担保人是支行关键人的业务;
（2）担保人为我行3个及以上客户担保的业务；
（3）未结清业务里5笔及以上业务侧面打听对象是同一人的业务
数据需求字段
未纳入关联管理的客户是指同一风险控制号为空或者只有客户自己
*/
-- 信贷合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_01 AS
select t1.busi_ctr_id                      --业务合同编号 BC
	,t1.busi_apl_id                        --业务申请编号 BA
	,t1.pd_cd                              --产品代码|C4
	,t1.cst_id                             --客户号|C20
	,t1.cst_nm                             --客户名称|C200
	,t1.apnt_start_dt                      --约定开始日期|C8
	,t1.apnt_mtu_dt                        --约定到期日期|C8
	,t1.ctr_amt                            --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                            --合同余额|DECIMAL(20,2)
	,t1.intr_rat                           --利率|DECIMAL(14,8)
	,t1.loan_usg_cd                        --贷款用途代码|C4
    ,c3.cd_val_dscr     loan_usg_nm
	,t1.usg_cmt                            --用途备注|c4
	,t1.cmt                                --备注|c1000
	,t1.hpn_typ_cd                         --发生类型代码|C32
    ,c4.cd_val_dscr     hpn_typ_nm
    ,t1.hdl_org_id	                        --经办机构编号|C12
    ,t4.org_nm          hdl_org_nm
    ,t1.opr_id	                            --经办人编号|C10
    ,c6.empe_nm         opr_nm
    ,t1.sub_loan_dir_cd	                   --行业投向细分|C32
    ,c2.cd_val_dscr     sub_loan_dir_nm
	,t1.bus_typ                            --业务类型|C10
    ,c5.cd_val_dscr     bus_typ_nm
    ,t1.rmt_loan_ind	                   --异地贷款标志|C3
    ,c7.cd_val_dscr     rmt_loan_nm
	,t2.acs_org_id                         --管护机构编号|C12
	,t2.acs_mngr_id                        --管户客户经理编号|C32
    ,c1.empe_nm         acs_mngr_nm
    ,t3.org_nm          acs_org_nm         --管护机构名称
    ,case when nvl(t5.sam_rsk_ctrl_id,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同管护信息
on  t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='20240531'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t2.acs_org_id=t3.org_id
and t3.dt='20240531'
and t3.brc_org_nm='绍兴分行'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.hdl_org_id=t4.org_id
and t4.dt='20240531'
left join edw.dws_cst_bas_inf_dd 			t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='20240531'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t2.acs_mngr_id=c1.empe_id
and c1.dt='20240531'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.SUB_LOAN_DIR_CD = C2.CD_VAL
AND C2.DT = '20240531'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t1.loan_usg_cd = C3.CD_VAL
AND C3.DT = '20240531'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON  t1.hpn_typ_cd = C4.CD_VAL
AND C4.DT = '20240531'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C5
ON  t1.bus_typ = C5.CD_VAL
AND C5.DT = '20240531'
left join edw.dws_hr_empe_inf_dd            c6 --员工信息汇总
on  t1.opr_id=c6.empe_id
and c6.dt='20240531'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C7
ON  t1.rmt_loan_ind = C7.CD_VAL
AND C7.DT = '20240531'
where t1.dt='20240531'
-- AND     t1.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
-- AND     (t1.chnl_cd <> 'L08' OR t1.pd_cd <> '201050101040335' )  --剔除 小鱼分期
-- AND     t1.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
-- AND     t1.pd_cd <> '201050101040319'                            --剔除 百度分期贷
AND(
    (
        (t1.ctr_bal > 0 OR (t1.ctr_bal IS NULL AND nvl(t1.crc_ind,'0')='0')    --非循环贷有余额
            OR((nvl(t1.crc_ind, '0') <> '0' OR t1.pd_cd LIKE '2010503%')      --随贷通
                AND (t1.ctr_bal = 0 OR t1.ctr_bal IS NULL)
                AND t1.apnt_mtu_dt >= '20240531'
            ) --（循环贷 或 随贷通） 且 余额为0 且 未到期
        ) AND nvl(t1.frz_sts_cd,'') NOT IN ( '3' , '4' ) --3到期失效 4终止失效
    ) OR (t1.ctr_bal > 0 AND t1.pd_cd LIKE '2010503%'
        AND t1.apnt_mtu_dt <= '20240531'
        AND t1.frz_sts_cd IN ( '3' , '4' )
    ) --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
) --未终结、未到期业务
;
-- 结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_02 AS
SELECT  busi_ctr_id     AS 业务合同编号
       ,cst_id          AS 客户号
       ,cst_nm          AS 客户名称
       ,bus_typ_nm      AS 业务类型
       ,loan_usg_nm     AS 贷款用途
       ,usg_cmt         AS 用途备注
       ,cmt             AS 备注
       ,ctr_amt         AS 合同金额
       ,ctr_bal         AS 合同余额
       ,rmt_loan_nm     AS 异地贷款
       ,acs_org_id      AS 管户机构号
       ,acs_org_nm      AS 管户机构名称
       ,acs_mngr_id     AS 管户人工号
       ,acs_mngr_nm     AS 管户人姓名
       ,hdl_org_id      AS 经办机构号
       ,hdl_org_nm      AS 经办机构名称
       ,opr_id          AS 经办人工号
       ,opr_nm          AS 经办人姓名
       ,sam_rsk_ctrl_id AS 同一风险控制号
FROM SJXQ_SJ2024062706_CST_01
;
-- 客户关联关系
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_03 AS
SElECT t1.cst_id,t1.rel_cst_id,t1.rel_typ_cd
    ,c1.cd_val_dscr as rel_typ_nm
    ,row_number() over(partition by t1.cst_id,t1.rel_cst_id order by t1.rel_typ_cd) rn
from(
    -- SElECT cst_id,rel_cst_id,rel_typ_cd
    -- from edw.dim_cst_rel_inf_dd         --客户关联关系信息
    -- where DT = '20240531'
    -- union
    -- SElECT rel_cst_id,cst_id,rel_typ_cd
    -- from edw.dim_cst_rel_inf_dd         --客户关联关系信息
    -- where DT = '20240531'
    --因 dwd_cst_rel_inf_dd 和 dim_cst_rel_inf_dd 两张表数据有交叉又有遗漏，都取了
    union
    SElECT cst_id,rel_cst_id,REL_REL_CD
    from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20240531'
    union
    SElECT rel_cst_id,cst_id,REL_REL_CD
    from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20240531'
)t1 LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON  cast(t1.REL_TYP_CD as int) = cast(C1.CD_VAL as int)
AND C1.DT = '20240531'
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024062706_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 业务合同编号) custs
from SJXQ_SJ2024062706_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024062706_CST_03
;
-- 2.具备以下特征之一的客户在我行的业务情况：
-- （1）由同个人员代理开立我行账户，在我行有授信，且授信客户间未纳入关联管理的客户；
-- 客群代理人
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_04 AS
SELECT distinct cst_id
    ,agn_nm      -- 代理开户人员姓名
    ,agn_doc_nbr  --代理人证件号码
FROM edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd --代理业务交易登记簿
WHERE dt = '20240531'
AND agn_bus_typ = '1' --代理业务类型代码:1代理开户,2代理开卡,3代理开大额存单,4代理现金存款,5代理现金取款,6代理存款部提,7代理存款销户
and rcd_sts_cd = '0'  --正常
AND cst_id IN (SELECT distinct cst_id FROM SJXQ_SJ2024062706_CST_01)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_05 AS
select t3.*,t1.agn_nm,t1.agn_doc_nbr
from(
    select agn_nm,agn_doc_nbr,count(cst_id) cnt
    from SJXQ_SJ2024062706_CST_04
    group by agn_nm,agn_doc_nbr
    having count(cst_id)>1  --同个人员代理开户
)t1 inner join SJXQ_SJ2024062706_CST_04 t2
on t1.agn_doc_nbr=t2.agn_doc_nbr
inner join SJXQ_SJ2024062706_CST_02     t3
on t2.cst_id=t3.客户号
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_06 AS
select distinct t1.*
       ,t3.agn_nm     as 代理开户人员姓名
       ,t2.客户号     AS 关联人客户号
       ,t2.客户名称     AS 关联人客户名称
       ,t4.rel_typ_nm AS 关联关系
from SJXQ_SJ2024062706_CST_05       t1
inner join SJXQ_SJ2024062706_CST_05 t2
on t1.agn_doc_nbr=t2.agn_doc_nbr
left join(
    FROM edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd --代理业务交易登记簿
    WHERE dt = '20240531'
    AND agn_bus_typ = '1' --代理业务类型代码:1代理开户,2代理开卡,3代理开大额存单,4代理现金存款,5代理现金取款,6代理存款部提,7代理存款销户
    and rcd_sts_cd = '0'  --正常
    group by cst_id
)t3 on t1.客户号=t3.cst_id
left join(
    select t1.cst_id,t1.rel_cst_id
    from SJXQ_SJ2024062706_CST_03 t1
    group by t1.cst_id,t1.rel_cst_id
)t4 on t1.客户号=t4.cst_id
and t2.客户号=t4.rel_cst_id
where t1.客户号<>t2.客户号  --非本人
and t1.同一风险控制号<>t2.同一风险控制号    --未纳入关联管理
;
-- （2）在我行有授信的客户间有夫妻关系或持股关系或担任高管的（法人、董事、股东、监事），且未纳入关联管理的客户在我行的业务情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_07 AS
SELECT  t1.*
       ,t2.客户号       AS 关联人客户号
       ,t2.客户名称     AS 关联人客户名称
       ,t3.rel_typ_nm  AS 关联关系
from SJXQ_SJ2024062706_CST_02   t1
left join (
    select distinct 客户号,客户名称,同一风险控制号
    from SJXQ_SJ2024062706_CST_02
)t2 on t1.客户号<>t2.客户号
inner join(
    select cst_id,rel_cst_id
    from SJXQ_SJ2024062706_CST_03
    where rel_typ_cd ='301' or rel_typ_cd like '2%' or rel_typ_nm like '%高管%'
    group by cst_id,rel_cst_id
)t3 on t1.客户号=t3.cst_id
and t2.客户号=t3.rel_cst_id
where t1.同一风险控制号<>t2.同一风险控制号 --未纳入关联管理
;
-- 3.具备以下特征之一的业务：
-- （1）担保人是支行关键人的业务;
-- 风险集市客户业务社区关键人信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_08 AS
--业务类型1：普惠
SELECT  A.CMNT_ENC            AS CMNT_ID --社区编码
        ,A.CMNT_NM            AS CMNT_NM --社区名称
        ,A.KEY_CST_ID         AS MAIN_CST_ID --关键人客户号
        ,A.KEY_NM             AS MAIN_CST_NM --关键人名称
        ,A.GDR_CD             AS SEX_CD --性别代码
        ,A.BTH_DT             AS BIRTH_DATE --出生日期
        ,A.DOC_NBR            AS CTFC_ID --证件号码
        ,A.CTC_TEL            AS MAIN_PHONE --联系电话
        ,A.ADR                AS MAIN_ADDR --地址
        ,A.WTHR_OWN_CST       AS IS_OUR_BANK_CST --行内客户标识
        ,A.KEY_TYP_CD         AS MAIN_TYPE_CD --关键人类型代码
        ,A.KEY_SITU_CMT       AS MAIN_STN_EXPN --关键人情况说明
        ,A.RCM_CST_NBR        AS RCMD_CST_CNT --推荐客户数
        ,A.VLD_CST_NBR        AS VALID_CST_CNT --有效户数
        ,A.DEP_LOAN_SIZ       AS DEP_LOAN_SIZE --存贷规模
        ,A.PULL_IN_CST_ID_SET AS ACCS_CST_ID_SMR --引入客户号集合
        ,A.PULL_IN_CST_NM_SET AS ACCS_CST_NM_SMR --引入客户名称集合
        ,A.STS_CD             AS MAIN_STS_CD --状态代码
FROM    edw.DWD_CST_MNG_ICSV_CMNT_KEY_PSN_REL_INF_DD A --普惠社区关键人关联信息
WHERE   A.DT = '20240531' --STS_CD: -1是删除，0是正常，1是退出
AND     A.STS_CD = '4'
UNION
--业务类型2：小企业
SELECT  B.CMNT_ENC        AS CMNT_ID --社区编码
        ,B.CMNT_NM        AS CMNT_NM --社区名称
        ,B.KEY_CST_ID     AS MAIN_CST_ID --关键人客户号
        ,B.KEY_NM         AS MAIN_CST_NM --关键人名称
        ,B.GDR_CD         AS SEX_CD --性别代码
        ,B.BTH_DT         AS BIRTH_DATE --出生日期
        ,B.DOC_NBR        AS CTFC_ID --证件号码
        ,B.CTC_TEL        AS MAIN_PHONE --联系电话
        ,B.ADR            AS MAIN_ADDR --地址
        ,B.WTHR_OWN_CST   AS IS_OUR_BANK_CST --是否我行客户
        ,B.KEY_TYP        AS MAIN_TYPE_CD --关键人类型
        ,B.KEY_SITU_CMT   AS MAIN_STN_EXPN --关键人情况说明
        ,B.RCM_CST_NBR    AS RCMD_CST_CNT --推荐客户数
        ,B.VLD_CST_NBR    AS VALID_CST_CNT --有效户数
        ,B.DEP_LOAN_SIZ   AS DEP_LOAN_SIZE --存贷规模
        ,B.PULL_IN_CST_ID AS ACCS_CST_ID_SMR --引入客户号集合
        ,B.PULL_IN_CST_NM AS ACCS_CST_NM_SMR --引入客户名称
        ,B.STS_CMT        AS MAIN_STS_CD --状态说明
FROM    edw.DWD_CST_MNG_ENTP_CMNT_KEY_PSN_REL_INF_DD B --小企业社区关键人关联信息
WHERE   B.DT = '20240531';
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_09 AS
select t2.*
    ,t1.wrnt_cst_id     as 担保社区关键人ID
    ,t1.wrnt_cst_nm     as 担保社区关键人
from (
    select distinct t1.busi_ctr_id
        ,t2.wrnt_cst_id
        ,t2.wrnt_cst_nm
    from SJXQ_SJ2024062706_CST_01           t1
    inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
    ON  t1.busi_ctr_id=t2.bus_ctr_id           --业务合同编号
    and t2.dt = '20240531'
    inner join SJXQ_SJ2024062706_CST_08     t3 --社区关键人
    on t2.wrnt_cst_id = t3.MAIN_CST_ID
)t1 inner join SJXQ_SJ2024062706_CST_02 t2
on t1.busi_ctr_id=t2.业务合同编号
;
-- （2）担保人为我行3个及以上客户担保的业务；
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_10 AS
select distinct t1.cst_id
    ,t2.wrnt_cst_id
    ,t2.wrnt_cst_nm
from SJXQ_SJ2024062706_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.busi_ctr_id=t2.bus_ctr_id           --业务合同编号
and t2.dt = '20240531'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_11 AS
SELECT  t3.*
       ,t2.wrnt_cst_id AS 担保人ID
       ,t2.wrnt_cst_nm AS 担保人
from(
    select wrnt_cst_id
    from SJXQ_SJ2024062706_CST_10
    group by wrnt_cst_id
    having count(distinct cst_id)>=3    --3个及以上客户
)t1 inner join SJXQ_SJ2024062706_CST_10 t2
on t1.wrnt_cst_id=t2.wrnt_cst_id
inner join SJXQ_SJ2024062706_CST_02     t3
on t2.cst_id=t3.客户号
;
-- （3）未结清业务里5笔及以上业务侧面打听对象是同一人的业务
-- 绍兴分行侧面打听
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_12 AS
SELECT  distinct t2.cst_id AS 客户号
       ,t2.cst_nm          AS 客户名称
       ,t2.busi_ctr_id     AS 合同编号
       ,t2.ctr_amt         AS 合同金额
       ,t2.ctr_bal         AS 合同余额
       ,t2.apnt_start_dt   AS 约定开始日期
       ,t2.intr_rat        AS 利率
       ,t4.tem_org_nm      AS 管护团队名称
       ,t3.ln_mgr_id       AS 信贷归属客户经理
       ,t3.ln_mgr_nm       AS 信贷归属客户经理名称
       ,t0.SVY_OBJ_NM      AS 侧面打听对象名称
FROM
(
	SELECT  T2.SVY_OBJ_NM --符合条件的侧面打听对象
	FROM edw.dwd_cst_asst_crd_cst_svy_inf_dd T2 -- 信贷客户调查信息
	WHERE T2.SVY_TYP_CD = '020'
	AND COALESCE(T2.SVY_OBJ_NM, '') <> '' --调查类型：020侧面打听记录（侧面打听对象不为空） --
	AND T2.DT = '20240531'
	GROUP BY  T2.SVY_OBJ_NM
	-- HAVING COUNT(distinct t2.obj_id) >= 5 --5笔及以上业务
) t0
INNER JOIN EDW.DWD_CST_ASST_CRD_CST_SVY_INF_DD t1 -- 信贷客户调查信息
ON t0.SVY_OBJ_NM = t1.SVY_OBJ_NM
AND t1.dt = '20240531'
INNER JOIN edw.dim_bus_loan_ctr_inf_dd t2 --信贷合同信息
ON t1.obj_id = t2.busi_apl_id
AND t2.dt = '20240531'
AND t2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
 AND ( t2.chnl_cd <> 'L08' OR t2.pd_cd <> '201050101040335' ) --剔除 小鱼分期
 AND t2.pd_cd <> '201050101040332' --剔除 蚂蚁借呗
 AND t2.pd_cd <> '201050101040319' --剔除百度分期贷
--AND t2.pd_cd NOT IN ( '20105010104035301' , '20105010201015001' ) --剔除双贷卡
 AND ( t2.pd_cd NOT IN ( '201050102010146' , '201050101040348' ) OR t2.frz_sts_cd <> '' ) --剔除未签约的泰e贷
 AND ( ( ( t2.ctr_bal > 0 OR ( t2.ctr_bal IS NULL AND nvl(t2.crc_ind, '0') = '0' ) OR ( ( nvl(t2.crc_ind, '0') <> '0' OR t2.pd_cd LIKE '2010503%' ) AND ( t2.ctr_bal = 0 OR t2.ctr_bal IS NULL ) AND t2.apnt_mtu_dt >= '20240531' ) ) AND nvl(t2.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) ) OR ( t2.ctr_bal > 0 AND t2.pd_cd LIKE '2010503%' AND t2.apnt_mtu_dt <= '20240531' AND t2.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
LEFT JOIN adm_pub.adm_csm_cbas_mng_inf_dd t3 --客户集市-客户基础-客户管户信息
ON t1.cst_id = t3.cst_id
AND t3.dt = '20240531'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd t4 --机构树_考核维度
ON t3.ln_org_id = t4.org_id
AND t4.dt = '20240531'
WHERE t4.brc_org_nm = '绍兴分行'
;
SElECT '12' seq, count(1) cnt,count(distinct 合同编号) custs
from SJXQ_SJ2024062706_CST_12
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024062706_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024062706_CST_13 AS
select distinct t3.*
    ,t1.侧面打听对象名称
from(
    SElECT t2.侧面打听对象名称
    from SJXQ_SJ2024062706_CST_01       t1
    inner join SJXQ_SJ2024062706_CST_12 t2
    on t1.busi_ctr_id=t2.合同编号
    group by t2.侧面打听对象名称
    having count(distinct t2.合同编号)>=5     --5笔及以上业务
)t1 inner join SJXQ_SJ2024062706_CST_12 t2
on t1.侧面打听对象名称=t2.侧面打听对象名称
inner join SJXQ_SJ2024062706_CST_02     t3
on t2.合同编号=t3.业务合同编号
;
-- 存在多人代理开户、多人担保的情况、多人为打听人的情况，代码已修改好***SJ20240627146_小鱼管家走访记录.sql
-- 客群
DROP   TABLE IF EXISTS SJXQ_SJ20240627146_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20240627146_CST_01 as
select t1.bus_seq_id	--业务流水号
    ,t1.cst_id	        --客户号
    ,t1.cst_name	    --客户姓名
    ,t1.srv_tm	        --服务时间
    ,t1.bus_typ	        --服务目的:服务目的（走访时间）:A0001营销触达、A0002贷款调查-贷前、A0003贷款调查-贷中、A0004贷款调查-贷后、A0005节日慰问、A0006客户交接、A0007逾期催收、A0008业务办理、A0009其他 A0010 送礼物  A0011 商机触达
    ,t1.srv_cntnt	    --服务内容:
    ,t1.cst_dmnd	    --客户需求:1贷款、2存款、3理财、4基金、5保险、6信托、7贵金属、8暂无
    ,t1.dmnd_typ	    --需求类型:11贷款21存款（活期)22存款（定期）31理财（封闭式)21理财（开放式）41基金（货币型）42基金（股票型）43基金（债券型）44基金（指数型）51保险（重疾）52保险（年金）53保险（意外）54保险（医疗）55保险（定寿）
    ,t1.comments	    --备注
    ,t1.create_emp	    --创建人 客户经理
    ,t1.create_tm	    --创建时间
    ,t1.update_tm	    --更新时间
    ,t1.cst_pref_trend	--客户偏好趋势：1产品优势、2价格水平、3服务质量、4专业能力
    ,t1.weal_dmnd	    --财富需求：111子女教育/婚嫁、112资产增值保值、113意外保障、114财富传承、115家企隔离、116养老规划、117其他
    ,t1.plan_tm	        --计划服务开始时间
    ,t1.plan_end_tm	    --计划服务结束时间
    ,t1.emp_sign_addr	--员工签到地点
    ,t1.srv_type	    --服务类型（01-拜访 02-接待）
    ,t1.com_cust_id	    --共同服务人ID
    ,t1.com_cust_name   --共同服务人名称
    ,t1.need_assign	    --是否需要指派 y 是 n 否
    ,t1.assign_person	--指派人（员工号）
    ,t1.assign_reason	--指定原因
    ,t1.plan_sign_tm	--签到完成日期
    -- ,t2.feed_back	    --反馈结果(1:已办理业务  1-1 普贷  1-2 随贷通卡 1-3存款 1-4理财 1-5其他     2:非子社区客户 3:无法成功联系 4:无实际需求 5:客户不符合准入 5-1有负面评价   5-2信用记录不好  5-3家庭关系不稳定    5-4无真实贷款用途/贷款用途不明确   5-5 经营情况不好/无经营主体   5-6 负债较高  5-7找不到担保人  5-8其他        6:已交接给其他客户经理   7 其他      8已查看工单，未联系客户    9沟通阶段   10 调查阶段  11办理阶段   12  其他   )
    ,t3.com_son_no      --子社区
    ,t4.com_name        --社区名称
    ,t8.employ_name     --客户经理
    ,t9.sbr_org_nm,t9.tem_org_nm
from edw.xwdt_xw_cst_vst_dtl_di     t1  --并非增量表
-- left   join edw.xwdt_xw_message     T2 cust_no 存在重复
-- on  T1.cst_id=T2.cust_no
-- and  T2.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_cust_com      t3
on t1.cst_id = t3.cust_no
and t3.dt='@@{yyyyMMdd}'
left join edw.xwdt_xw_community     t4
on t3.com_son_no = t4.id
and t4.dt='@@{yyyyMMdd}'
inner join edw.xwdt_xw_employ               t8
on t8.employ_no = t1.create_emp
and t8.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t9 --机构树_考核维度
on t8.org_id=t9.org_id
and t9.dt='@@{yyyyMMdd}'
and t9.brc_org_nm='绍兴分行'
where t1.dt='@@{yyyyMMdd}'
and substr(replace(t1.srv_tm,'-',''),1,6)>='202404' --4月以来
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ20240627146_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ20240627146_CST_02 as
select t1.bus_seq_id	走访业务流水号
    ,t1.cst_id	        客户号
    ,t1.cst_name	    客户姓名
    ,t1.com_son_no      所属子社区
    ,t1.com_name        所属子社区名称
    ,t1.employ_name     客户经理
    ,t1.create_emp	    客户经理工号
    ,t1.sbr_org_nm      支行机构名称
    ,t1.tem_org_nm      团队机构名称
    ,t1.srv_type	    服务类型CD
    ,decode(t1.srv_type,'01','拜访','02','接待','') 服务类型
    ,t1.need_assign	    是否需要指派
    ,t1.assign_person	指派人工号
    ,t1.assign_reason	指定原因
    ,t1.srv_tm	        访问时间
    ,t1.plan_tm	        计划服务开始时间
    ,t1.plan_end_tm	    计划服务结束时间
    ,t1.plan_sign_tm	签到完成日期
    ,t1.create_tm	    创建时间
    ,t1.update_tm	    更新时间
    ,t1.com_cust_id	    共同服务人ID
    ,t1.com_cust_name   共同服务人名称
    ,t1.bus_typ	        服务目的CD
    ,decode(t1.bus_typ,'A0001','营销触达' ,'A0002','贷款调查-贷前' ,'A0003','贷款调查-贷中' ,'A0004','贷款调查-贷后' ,'A0005','节日慰问' ,'A0006','客户交接' ,'A0007','逾期催收' ,'A0008','业务办理' ,'A0009','其他' ,'A0010','送礼物' ,'A0011','商机触达','') 服务目的
    ,t1.srv_cntnt	    服务内容
    ,t1.cst_dmnd	    客户需求CD
    ,decode(t1.cst_dmnd,'1','贷款' ,'2','存款' ,'3','理财' ,'4','基金' ,'5','保险' ,'6','信托' ,'7','贵金属' ,'8','暂无','') 客户需求
    ,t1.dmnd_typ	    需求类型CD
    ,decode(t1.dmnd_typ,'11','贷款' ,'21','存款_活期' ,'22','存款_定期' ,'31','理财_封闭式' ,'21','理财_开放式' ,'41','基金_货币型' ,'42','基金_股票型' ,'43','基金_债券型' ,'44','基金_指数型' ,'51','保险_重疾' ,'52','保险_年金' ,'53','保险_意外' ,'54','保险_医疗' ,'55','保险_定寿','') 需求类型
    ,t1.cst_pref_trend	客户偏好趋势CD
    ,decode(t1.cst_pref_trend,'1','产品优势' ,'2','价格水平' ,'3','服务质量' ,'4','专业能力','') 客户偏好趋势
    ,t1.weal_dmnd	    财富需求CD
    ,decode(t1.weal_dmnd,'111','子女教育_婚嫁' ,'112','资产增值保值' ,'113','意外保障' ,'114','财富传承' ,'115','家企隔离' ,'116','养老规划' ,'117','其他','') 财富需求
    ,t1.comments	    备注
    ,t1.emp_sign_addr	员工签到地点
from SJXQ_SJ20240627146_CST_01 t1
;
***SJ20240701191_杭州分行隐患业务管理.sql
-- 导入客群
DROP   TABLE IF EXISTS SJXQ_SJ20240701191_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20240701191_CST_01 AS
select cst_id,busi_ctr_id
from edw.dim_bus_loan_ctr_inf_dd
where dt='20240630'
;
-- 基础字段
DROP   TABLE IF EXISTS SJXQ_SJ20240701191_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ20240701191_CST_02 AS
select t1.cst_id,t1.busi_ctr_id
    ,nvl(t2.sam_rsk_ctrl_id,t1.cst_id)  sam_rsk_ctrl_id	--同一风险控制号
    ,t2.xpos_amt	                                    --同一风险控制号下客户贷款敞口金额
    ,t3.trm_mon	    --期限月
    ,t3.rpay_mth	--还款方式
    ,CONCAT(T4.FNL_APV_ID, T4.FNL_APV_NM)             AS FNL_APV_NM         --最终审批人
    ,t6.org_nm  as FNL_APV_NM_org_nm
    ,t7.opr_nm,t7.hdl_org_nm,t7.rnln_bfr_aprv_opnn
    ,t7.rnln_bfr_aprv_opnn_spl_cmt
from (
    select distinct cst_id,busi_ctr_id
    from SJXQ_SJ20240701191_CST_01
)t1
left join adm_pub.adm_csm_crisk_sam_rsk_ctrl_inf_dd	t2 --客户同一风险控制号信息
on t1.cst_id=t2.cst_id
and t2.dt='20240630'
LEFT join edw.dim_bus_loan_ctr_inf_dd               t3 --信贷合同信息
on t1.busi_ctr_id=t3.busi_ctr_id
and t3.dt='20240630'
LEFT join adm_pub.adm_rsk_bus_loan_mngmt_flow_mdl_dd t4 --风险集市信贷业务合同信息模型表
on t3.busi_apl_id=t4.busi_apl_id
and t4.dt='20240630'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  T4.FNL_APV_ID=t5.empe_id
and t5.dt='20240630'
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t5.org_id=t6.org_id
and t6.dt='20240630'
LEFT JOIN
(
	SELECT  obj_id
        ,opr_nm	            --经办人姓名|C100
        ,hdl_org_id	        --经办机构编号|C12
        ,hdl_org_nm	        --经办机构名称|C80
        ,rnln_bfr_aprv_opnn	                --续贷前批复意见|c20
        ,rnln_bfr_aprv_opnn_spl_cmt	        --续贷前批复意见补充说明|c1000
	    ,ROW_NUMBER() OVER ( PARTITION BY obj_id ORDER BY  cpl_exe_tm DESC ) rn
	FROM edw.dwd_bus_loan_aprv_inf_dd --信贷审批信息
	WHERE DT = '20240630'
	AND opr_id <> 'system'
) t7 --审批流程表
on t3.busi_apl_id=t7.obj_id
and t7.rn=1
;
-- 连续使用接力贷次数
DROP   TABLE IF EXISTS SJXQ_SJ20240701191_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ20240701191_CST_03 AS
select busi_ctr_id                              --业务合同编号|C32
	,cst_id                                   --客户编号|C20
	,cst_nm                                   --客户名称|C200
	,apnt_start_dt                            --约定开始日期|C8
	,apnt_mtu_dt                              --约定到期日期|C8
	,ctr_amt                                  --合同金额|DECIMAL(20,2)
	,ctr_bal                                  --合同余额|DECIMAL(20,2)
	,hpn_dt                                   --发生日期|C8
from edw.dim_bus_loan_ctr_inf_dd              --信贷合同信息
where dt='20240630'
and hpn_dt<>'18991231'
;
-- 同一风险控制号下近6月存款日均
DROP   TABLE IF EXISTS SJXQ_SJ20240701191_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ20240701191_CST_04 AS
select t1.cst_id
    ,t1.sam_rsk_ctrl_id
    ,sum(nvl(t3.客户近6个月存款日均,0)) 同一风险控制号下近6月存款日均
from(
    select distinct cst_id,sam_rsk_ctrl_id
    from SJXQ_SJ20240701191_CST_02
)t1
left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t2.dt='20240630'
left join(
    SELECT  cst_id
            ,SUM(last_180_days_gl_bal_acml) / 180 AS 客户近6个月存款日均
    FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
    WHERE   DT = '20240630'
    GROUP BY cst_id
)t3 on t2.cst_id=t3.cst_id
where nvl(t1.sam_rsk_ctrl_id,'')<>''
group by  t1.cst_id ,t1.sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ20240701191_CST_05 PURGE;
CREATE TABLE           SJXQ_SJ20240701191_CST_05 AS
SELECT  t1.cst_id                     AS 客户号
       ,t1.busi_ctr_id                AS 合同号
       ,t2.sam_rsk_ctrl_id            AS 同一风险控制号
       ,t2.xpos_amt                   AS 同一风险控制号下客户贷款敞口金额
       ,t2.trm_mon                    AS 期限月
       ,t2.rpay_mth                   AS 还款方式
       ,t2.是否接力贷
       ,t2.FNL_APV_NM                 AS 最终审批人
       ,t2.FNL_APV_NM_org_nm          AS 最终审批人所属机构
       ,t2.opr_nm                     AS 最终审批人2
       ,t2.hdl_org_nm                 AS 最终审批人所属机构2
       ,t2.rnln_bfr_aprv_opnn         AS 最终审批人续贷前批复意见
       ,t2.rnln_bfr_aprv_opnn_spl_cmt AS 续贷前批复意见补充说明
       ,t3.jld_cnt                     as 历史使用接力贷次数
       ,t4.同一风险控制号下近6月存款日均
from SJXQ_SJ20240701191_CST_01      t1
left join SJXQ_SJ20240701191_CST_02 t2
on t1.busi_ctr_id=t2.busi_ctr_id
left join(
    -- 并非全是接力贷
    select cst_id,min(jld_cum_cnt) jld_cnt
    from(
        select cst_id,jld_cum_cnt
        from SJXQ_SJ20240701191_CST_03
        group by cst_id,jld_cum_cnt
        having count(1)>1
    )t1 group by cst_id
    union all
    -- 全是接力贷
    SElECT cst_id,jld_cnt
    from (
        select cst_id,count(1) loan_cnt,sum(is_jld) jld_cnt
        from SJXQ_SJ20240701191_CST_03
        group by cst_id
    )t1 where loan_cnt=jld_cnt
) t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ20240701191_CST_04 t4
on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ20240701191_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ20240701191_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240701191_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240701191_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ20240701191_CST_05
;
***SJ20240702126.sql
-- 徐舒月023731 --SJ20240702126
--截止2024.5.31，长乐村行信贷业务合同未终结、工商信息内有未注销企业的个人客户
DROP TABLE IF EXISTS lab_bigdata_dev.SJ20240702126_01 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ20240702126_01 AS
SELECT  t.cst_id
        ,t1.doc_nbr
        ,t1.cst_chn_nm
        ,t1.sam_rsk_ctrl_id
        ,sum(t.ctr_amt) AS sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd t
INNER JOIN    edw.dws_cst_bas_inf_dd t1
ON      t.cst_id = t1.cst_id
AND     t1.dt = '20240531'
AND     cst_typ_cd = '1' ---对私客户
WHERE   t.dt = '20240531'
-- AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
-- AND     ( t.chnl_cd <> 'L08'
--     OR t.pd_cd <> '201050101040335' ) --剔除 小鱼分期
-- AND     t.pd_cd <> '201050101040332' --剔除 蚂蚁借呗
-- AND     t.pd_cd <> '201050101040319'  --剔除百度分期贷
--AND     t.pd_cd NOT IN ( '20105010104035301' , '20105010201015001' ) --剔除双贷卡
AND     ( t.pd_cd NOT IN ( '201050102010146' , '201050101040348' )
    OR t.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( ( ( t.ctr_bal > 0
    OR ( t.ctr_bal IS NULL
AND     nvl(t.crc_ind, '0') = '0' )
    OR ( ( nvl(t.crc_ind, '0') <> '0'
    OR t.pd_cd LIKE '2010503%' )
AND     ( t.ctr_bal = 0
    OR t.ctr_bal IS NULL )
AND     t.apnt_mtu_dt >= '20240531' ) )
AND     nvl(t.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
    OR ( t.ctr_bal > 0
AND     t.pd_cd LIKE '2010503%'
AND     t.apnt_mtu_dt <= '20240531'
AND     t.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
AND     substr(hdl_org_id, 1, 4) = '3562' ---长乐村行
GROUP BY t.cst_id , t1.doc_nbr , t1.cst_chn_nm , t1.sam_rsk_ctrl_id
 HAVING sum(t.ctr_amt) > 0;
--select * from lab_bigdata_dev.SJ20240702126_01;
drop table if exists lab_bigdata_dev.SJ20240702126_02 purge;
create table if not exists lab_bigdata_dev.SJ20240702126_02 as
SELECT  t1.*
        ,t2.gpr_hostsendtime ---交易发送主机时间
        ,t2.gpr_creditcode ---统一社会信用代码
        ,t2.gpr_entname ---企业(机构)名称
        ,t2.gpr_entstatus ---企业状态
        ,t2.gpr_enttype ---企业(机构)类型
        ,t2.gpr_industryphyname ---行业名称
FROM    lab_bigdata_dev.SJ20240702126_01 t1
LEFT JOIN
(
        SELECT  otdt_query_no
                ,gpr_hostsendtime ---交易发送主机时间
                ,dt_gpr_creditcode as gpr_creditcode ---统一社会信用代码
                ,dt_gpr_entname as gpr_entname ---企业(机构)名称
                ,dt_gpr_entstatus as gpr_entstatus ---企业状态
                ,dt_gpr_enttype as gpr_enttype ---企业(机构)类型
                ,dt_gpr_industryphyname as gpr_industryphyname ---行业名称
                ,row_number() over(partition by otdt_query_no,IF(dt_gpr_creditcode IS NULL,dt_gpr_entname,dt_gpr_creditcode) order by gpr_hostsendtime desc) as rk
        FROM   edw.nout_gs_prsn_ryposfrtd     ---- edw.noutd_gs_prsn_ryposfr
        WHERE   dt >'00000000' and replace(dt_gpr_esdate,'-','') <='@@{yyyyMMdd}'
) t2
on lower(md5(t1.doc_nbr)) = lower(t2.otdt_query_no)
and rk = 1;
drop table if exists lab_bigdata_dev.SJ20240702126_03 purge;
create table if not exists lab_bigdata_dev.SJ20240702126_03 as
select t.cst_id as 客户号
      ,t.cst_chn_nm as 客户姓名
      ,t1.gpr_entname as 工商信息下未注销的企业
      ,t1.gpr_creditcode as 统一社会信用代码
      ,max(case when t2.doc_nbr = t1.gpr_creditcode then 1 else 0 end) as 信贷系统是否关联
      ,t3.prm_mgr_id as 主管护人工号
      ,t3.prm_org_id as 主管护机构号
      ,t3.prm_mgr_nm as 主管护人名称
      ,t3.prm_org_nm as 主管护机构名称
from lab_bigdata_dev.SJ20240702126_01 t
left join lab_bigdata_dev.SJ20240702126_02 t1
on t.cst_id = t1.cst_id
and t1.gpr_entstatus rlike '在营'
left join edw.dws_cst_bas_inf_dd t2
on t1.sam_rsk_ctrl_id = t2.sam_rsk_ctrl_id
and t2.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3
on t.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
group by
    t.cst_id
      ,t.cst_chn_nm
      ,t1.gpr_entname
      ,t1.gpr_creditcode
      ,t3.prm_mgr_id
      ,t3.prm_org_id
      ,t3.prm_mgr_nm
      ,t3.prm_org_nm
;
select * from lab_bigdata_dev.SJ20240702126_03
***SJ2024070286_闸弄口支行预算占用分析.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024070286_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070286_CST_01 AS
SELECT t2.hostcustno    as cst_id
    ,t2.customersname	as cst_nm --客户名称
    ,t1.transno         --交易流水号，自动递增，关联积分交易流水表
    ,t1.transdate       as trx_dt
    ,t1.transtime       as trx_tm
    ,t1.pointsamount    as trx_amt --积分金额 交易金额
    ,t1.transtypeno
    ,t3.budgetitems	    --预算项目
    ,t3.prdname	        --产品名称
    ,t3.description     --交易类型说明
FROM edw.sirs_pointstransminutes    t1
LEFT JOIN edw.sirs_customers        t2
ON t2.customersid = t1.customersid
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN edw.sirs_transtype        t3
ON t3.transtypeno = t1.transtypeno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd  t4         --机构树_考核维度
on  t1.budgetoccupyorg=t4.org_id
and t4.dt='@@{yyyyMMdd}'
and t4.sbr_org_nm like '%闸弄口%'   --闸弄口支行2024年预算
WHERE t1.dt='@@{yyyyMMdd}'
AND t1.transdate LIKE '2024%'
AND t1.creditlimitflag = '1' --是否计入额度 0否 1是
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024070286_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070286_CST_02 AS
SELECT  cst_id                    AS 客户号
       ,cst_nm                    AS 客户名称
       ,transno                   AS 交易流水号
       ,concat(trx_dt,' ',trx_tm) AS 交易时间
       ,trx_amt                   AS 交易金额
       ,t1.transtypeno            AS 交易类型
       ,t1.budgetitems            AS 预算项目
       ,t1.prdname                AS 产品名称
       ,t1.description            AS 交易类型说明
FROM SJXQ_SJ2024070286_CST_01 t1
;
SElECT '01' seq, count(1) cnt,count(distinct transno) custs
from SJXQ_SJ2024070286_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 交易流水号) custs
from SJXQ_SJ2024070286_CST_02
;
-- 核查 主键是否唯一，如果 cnt<>1 则根据需要选择
select 'sirs_customers' tbl_nm,customersid,count(1) cnt
from edw.sirs_customers
where dt='@@{yyyyMMdd}'
group by customersid
order by cnt desc
limit 5
;
select 'sirs_transtype' tbl_nm,transtypeno,count(1) cnt
from edw.sirs_transtype
where dt='@@{yyyyMMdd}'
group by transtypeno
order by cnt desc
limit 5
***SJ2024070341_长乐村行贷款数据.sql
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ2024070341_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024070341_CST_01
(
    busi_ctr_id     string COMMENT ''
    ,cst_id         string COMMENT ''
    ,cst_nm         string COMMENT ''
)
;
insert into SJXQ_SJ2024070341_CST_01
values
;
-- 配偶关系
DROP   TABLE IF     EXISTS SJXQ_SJ2024070341_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070341_CST_02 AS
SElECT cst_id,rel_cst_id
from edw.DWD_CST_REL_INF_DD         --客户关联关系信息 LOAN_CUSTOMER_RELATIVE 视图为空
where DT = '20240630'
and REL_REL_CD = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
union
SElECT rel_cst_id,cst_id
from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
where DT = '20240630'
and REL_REL_CD = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
;
/*
-- 担保信息
DROP   TABLE IF EXISTS SJXQ_SJ2024070341_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ2024070341_CST_03 as
select a.objecttype
      ,a.objectno	      业务申请流水号
      ,a.contractno       担保合同编号     --- '020' : 抵押
      ,a.guarantyid       担保物编号
      ,b.guarantytype     担保类型
      ,b.guarantyvalue    担保合同总金额
      ,c.maxguarantysum   最高担保额度
      ,c.guarantytype     担保物类型
      ,c.guarantystatus   担保物状态
      ,c.ownerid          担保人编号
      ,c.ownername        担保人名称
      ,c.confirmvalue     认定价值
      ,d.mccustomerid     抵押人同一风险控制号
FROM edw.loan_guaranty_relative         a
LEFT JOIN edw.loan_guaranty_contract    b
ON a.contractno = b.serialno
AND b.dt = a.dt
LEFT JOIN edw.loan_guaranty_info c
ON a.guarantyid = c.guarantyid
AND c.dt = a.dt ----担保物信息表
LEFT JOIN edw.loan_customer_info d
ON c.ownerid = d.customerid
AND d.dt = a.dt
WHERE a.dt = '20240630'
;
*/
-- 基本信息
DROP   TABLE IF EXISTS SJXQ_SJ2024070341_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ2024070341_CST_04 as
select t1.cst_id
    ,t2.mrg_situ_cd	    --婚姻状况代码
    ,c1.cd_val_dscr     mrg_situ_nm
    ,case when t3.cst_id is not null then '是' else '否' end is_lr_po --是否录入配偶
    ,t4.age
from (
    select distinct cst_id
    from SJXQ_SJ2024070341_CST_01
)t1 left join edw.dim_cst_idv_bas_inf_dd    t2 --个人客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt='20240630'
left join edw.dwd_code_library_dd       c1
on t2.mrg_situ_cd = c1.cd_val
and c1.dt = '20240630'
left join(
    select distinct cst_id from SJXQ_SJ2024070341_CST_02
)t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t4	--对私客户基础信息
on t1.cst_id=t4.cst_id
and t4.dt='20240630'
;
-- 信贷合同信息
DROP   TABLE IF EXISTS SJXQ_SJ2024070341_CST_05 PURGE;
CREATE TABLE           SJXQ_SJ2024070341_CST_05 as
select t1.busi_ctr_id                            --业务合同编号|C32
    ,t2.busi_apl_id
	,t2.cst_id                                   --客户编号|C20
	,t2.cst_nm                                   --客户名称|C200
	,t2.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t2.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t2.main_grnt_mth_cd                         --主要担保方式代码|C3
    ,c1.cd_val_dscr         main_grnt_mth_nm
	,t2.oth_grnt_mth_cd                          --其他担保方式代码|C3
    ,c2.cd_val_dscr         oth_grnt_mth_nm
	,t2.hpn_dt                                   --发生日期|C8
	,t2.bus_cd                                   --业务标识代码|C32
    ,c4.cd_val_dscr         bus_nm
	,t2.bus_lab_cd                               --营销标签代码|C2048
    ,c3.cd_val_dscr         bus_lab_nm
	,t2.bus_typ                                  --业务类型|C10
    ,c5.cd_val_dscr         bus_typ_nm
	,t2.apnt_start_dt                            --约定开始日期|C8
	,t2.apnt_mtu_dt                              --约定到期日期|C8
	,t2.end_dt                                   --终结日期|C8
    ,case when t3.cst_id is not null then '是' else '否' end is_fst_loan
	,t4.acs_org_id                               --管护机构编号|C12
    ,t6.org_nm              acs_org_nm
	,t4.acs_mngr_id                              --管户客户经理编号|C32
    ,t5.empe_nm             acs_mngr_nm
from SJXQ_SJ2024070341_CST_01           t1
left join edw.dim_bus_loan_ctr_inf_dd   t2 --信贷合同信息
on  t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='20240630'
left join(
    select cst_id,busi_ctr_id
        ,row_number() over(partition by cst_id order by hpn_dt asc) rn
    from edw.dim_bus_loan_ctr_inf_dd --信贷合同信息
    where dt='20240630'
)t3 on t1.busi_ctr_id=t3.busi_ctr_id
and t3.rn=1
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t4        --信贷合同管护信息
on  t1.busi_ctr_id=t4.busi_ctr_id
and t4.dt='20240630'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t4.acs_mngr_id=t5.empe_id
and t5.dt='20240630'
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t4.acs_org_id=t6.org_id
and t6.dt='20240630'
left join edw.dwd_code_library_dd       c1
on  t2.main_grnt_mth_cd = c1.cd_val
and c1.dt = '20240630'
left join edw.dwd_code_library_dd       c2
on  t2.oth_grnt_mth_cd = c2.cd_val
and c2.dt = '20240630'
left join edw.dwd_code_library_dd       c3
on  t2.bus_lab_cd = c3.cd_val
and c3.dt = '20240630'
left join edw.dwd_code_library_dd       c4
on  t2.bus_cd = c4.cd_val
and c4.dt = '20240630'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C5
ON  t2.bus_typ = C5.CD_VAL
AND C5.DT = '20240531'
;
-- 字段汇总
DROP   TABLE IF EXISTS SJXQ_SJ2024070341_CST_06 PURGE;
CREATE TABLE           SJXQ_SJ2024070341_CST_06 as
select t1.busi_ctr_id ,t1.cst_id ,t1.cst_nm
    ,t2.mrg_situ_nm
    ,t2.is_lr_po --是否录入配偶
    ,t2.age
	,t3.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t3.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t3.main_grnt_mth_cd                         --主要担保方式代码|C3
    ,t3.main_grnt_mth_nm
	,t3.oth_grnt_mth_cd                          --其他担保方式代码|C3
    ,t3.oth_grnt_mth_nm
	,t3.hpn_dt                                   --发生日期|C8
	,t3.bus_cd                                   --业务标识代码|C32
    ,t3.bus_nm
	,t3.bus_lab_cd                               --营销标签代码|C2048
    ,t3.bus_lab_nm
	,t3.bus_typ                                  --业务类型|C10
    ,t3.bus_typ_nm
	,t3.apnt_start_dt                            --约定开始日期|C8
	,t3.apnt_mtu_dt                              --约定到期日期|C8
	,t3.end_dt                                   --终结日期|C8
    ,t3.is_fst_loan
	,t3.acs_org_id                               --管护机构编号|C12
    ,t3.acs_org_nm
	,t3.acs_mngr_id                              --管户客户经理编号|C32
    ,t3.acs_mngr_nm
from SJXQ_SJ2024070341_CST_01       t1
left join SJXQ_SJ2024070341_CST_04  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024070341_CST_05  t3
on t1.busi_ctr_id=t3.busi_ctr_id
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ2024070341_CST_07 PURGE;
CREATE TABLE           SJXQ_SJ2024070341_CST_07 as
SELECT  busi_ctr_id      AS 合同号
       ,cst_id           AS 客户号
       ,cst_nm           AS 客户名称
       ,mrg_situ_nm      AS 婚姻状况
       ,is_lr_po         AS 关联关系中配偶信息是否录入
       ,null             AS 配偶是否签入担保_身份证关联_涉及敏感
       ,age              AS 年龄
       ,main_grnt_mth_nm AS 主要担保方式
       ,oth_grnt_mth_nm  AS 其他担保方式
       ,hpn_dt           AS 发生日期
       ,bus_nm           AS 业务标识
       ,bus_lab_nm       AS 营销标签
       ,bus_typ_nm       AS 业务类型
       ,is_fst_loan      AS 是否首笔
       ,ctr_amt          AS 合同金额
       ,ctr_bal          AS 合同余额
       ,acs_mngr_nm      AS 信贷管户经理
       ,acs_org_nm       AS 信贷管户部门
       ,apnt_start_dt    AS 约定开始日期
       ,apnt_mtu_dt      AS 约定到期日期
       ,end_dt           AS 终结日期
FROM SJXQ_SJ2024070341_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024070341_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070341_CST_02
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070341_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024070341_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024070341_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2024070341_CST_07
;
***SJ2024070381_衢州分行百年好合卡客户.sql
/*
截止2024年6月底，衢州分行百年好合卡发卡客户的客户画像、在我行的产效情况（存款、贷款、理财、aum）。
注：百年好合卡分为定制卡面款、通用卡面款两种
发卡日期、首次定存日期、首次贷款签约日期、是否存量客户、产效情况（存款、贷款、理财、aum）月日均
*/
-- 衢州分行百年好合卡发卡客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024070381_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070381_CST_01 as
select t1.busi_ctr_id                            --业务合同编号|C32
	,t1.busi_apl_id                              --业务申请编号|C32
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.hpn_dt	                                 --发生日期|C8
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
    ,t4.acs_org_id
    ,t6.org_nm
from edw.dim_bus_loan_ctr_inf_dd            t1 --信贷合同信息
inner join edw.dim_bus_loan_pd_inf_dd 	    t2 			--信贷产品信息
on t1.pd_cd=t2.pd_cd
and t2.dt='20240630'
and t2.pd_nm='百年好合卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t4        --信贷合同管护信息
on  t1.busi_ctr_id=t4.busi_ctr_id
and t4.dt='20240630'
inner join edw.dim_hr_org_mng_org_tree_dd   t6 --考核机构树
on  t4.acs_org_id=t6.org_id
and t6.dt='20240630'
and t6.brc_org_nm='衢州分行'
where t1.dt='20240630'
;
-- 首次定存日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024070381_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070381_CST_02 as
SElECT T1.dep_act_id,T1.cst_act_id,T1.cst_id,T1.ACT_NM
    ,T1.OPN_DT,T1.INT_VAL_DT,T1.MTU_DT
    ,cur_act_bal,gl_bal
    ,C1.cd_val_dscr PROD_NM
    ,T1.act_sts_cd
    ,decode(T1.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结'
        ,'F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
    ,t1.ACT_CTG_CD_2
    ,decode(t1.ACT_CTG_CD_2,'301','I类户','302','II类户','303','III类户') act_typ
    ,row_number() over(partition by t1.cst_id order by t1.OPN_DT) rn
from edw.dws_bus_dep_act_inf_dd     T1  --存款账户信息汇总 dep_act_id
left JOIN EDW.DWD_CODE_LIBRARY_DD   C1
ON T1.prod_id=C1.CD_VAL
AND C1.DT='20240630'
AND C1.TBL_NM='DIM_BUS_DEP_ACT_INF_DD'
AND C1.FLD_NM='PROD_ID'
where T1.dt = '20240630'
and T1.lbl_prod_typ_cd<>'0' --存款产品类型代码 0:活期 1:定期 非活期外的存款
;
-- 首次贷款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024070381_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070381_CST_03 as
select t1.cst_id,min(hpn_dt) fst_loan_dt
from edw.dim_bus_loan_ctr_inf_dd  t1 --信贷合同信息
where t1.dt='20240630'
group by cst_id
;
-- 存款、贷款、理财、aum）月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024070381_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070381_CST_04 as
select t1.cst_id                                 --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.hpn_dt	                                 --发生日期|C8
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
    ,t2.OPN_DT
    ,t3.fst_loan_dt
    ,t4.fnc_mon_avg_amt	            --理财金额月日均
    ,t4.aum_mon_avg	                --客户当月综合金融资产(aum)月日均 aum月日均
    ,t5.dep_bal_mon_avg	            --存款余额月日均
    ,t6.loan_bal_acs_mon_avg	    --贷款余额月日均
    ,case when t2.OPN_DT<t1.hpn_dt or t3.fst_loan_dt<t1.hpn_dt then '是' else '否' end is_cunl
from SJXQ_SJ2024070381_CST_01       t1
left join SJXQ_SJ2024070381_CST_02  t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ2024070381_CST_03  t3
on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t4 --客户金融资产信息表
on  t1.cst_id=t4.cst_id
and t4.dt='20240630'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t5 --存款业务信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20240630'
left join adm_pub.adm_csm_cbus_loan_inf_dd 		t6 --贷款业务信息
on  t1.cst_id=t6.cst_id
and t6.dt='20240630'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024070381_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070381_CST_05 as
SELECT  cst_id               AS 客户编号
       ,cst_nm               AS 客户名称
       ,hpn_dt               AS 发生日期
       ,apnt_start_dt        AS 约定开始日期
       ,apnt_mtu_dt          AS 约定到期日期
       ,ctr_amt              AS 合同金额
       ,OPN_DT               AS 首次定存日期
       ,fst_loan_dt          AS 首次贷款日期
       ,is_cunl              AS 是否存量客户
       ,fnc_mon_avg_amt      AS 理财金额月日均
       ,aum_mon_avg          AS aum月日均
       ,dep_bal_mon_avg      AS 存款余额月日均
       ,loan_bal_acs_mon_avg AS 贷款余额月日均
from SJXQ_SJ2024070381_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070381_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070381_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070381_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070381_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户编号) custs
from SJXQ_SJ2024070381_CST_05
***SJ2024070386_湖州分行信贷业务数据.sql
/*
数据摘取2023年1月1日至2024年6月30日，湖州分行信贷业务数据。用于分析在湖州分行新增的业务，曾经在杭州分行办理过业务。主要包括以下几种情形：
1.借款人为对公的，对公客户的实控人、主要股东本人或其配偶、子女、父母在杭州分行办理过业务；
2.借款人为对私的，对私客户控制的企业或占股50%的企业或配偶、子女、父母在杭州分行办理过业务。
办理业务是指在杭州分行办理信贷业务，有敞口的
主要股东是指占股50%以上
edw.dim_cst_out_geb_shh_inf_dd 股权
*/
-- 湖州分行、杭州分行 信贷信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_01 AS
select B.cst_ID,b.cst_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,C.REG_DT                              --申请日期
    ,B.BUSI_APL_ID
    ,c.pre_apl_srl_nbr
    ,t3.crd_xpos_lmt                             --信贷敞口额度
	,t4.acs_org_id                               --管护机构编号|C12
    ,t6.brc_org_nm
    ,case when t7.cst_ID is not null then '对私' else '对公' end cust_type
from edw.DIM_BUS_LOAN_CTR_INF_DD        B --信贷合同信息
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='@@{yyyyMMdd}'
left join wb_bigdata_manager_dev.dsj_v_dim_bus_loan_crd_lmt_inf_dd t3          --授信额度信息
on b.busi_ctr_id=t3.crd_ctr_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd t4 --信贷合同管护信息
on B.busi_ctr_id=t4.busi_ctr_id
and t4.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd  t6 --考核机构树
on  t4.acs_org_id=t6.org_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd       t7       --个人客户基本信息
on b.cst_ID=t7.cst_ID
and t7.dt='@@{yyyyMMdd}'
WHERE NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND   B.DT ='@@{yyyyMMdd}'
and   C.REG_DT between '20230101' and '20240630'
;
-- 客户关联关系
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_02 AS
SElECT t1.cst_id,t1.rel_cst_id,t1.rel_typ_cd
    ,c1.cd_val_dscr as rel_typ_nm
    ,row_number() over(partition by t1.cst_id,t1.rel_cst_id order by t1.rel_typ_cd) rn
from(
    SElECT cst_id,rel_cst_id,REL_REL_CD as REL_TYP_CD
    from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20240630'
    union
    SElECT rel_cst_id,cst_id,REL_REL_CD
    from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
    where DT = '20240630'
)t1 LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON  cast(t1.REL_TYP_CD as int) = cast(C1.CD_VAL as int)
AND C1.DT = '20240630'
;
-- 湖州分行对公客户的实控人、主要股东本人或其配偶、子女、父母
-- 主要股东
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_03 AS
select t1.cst_ID,t1.shh_nm
    ,t2.cst_ID rel_cst_id       --股东客户号
    ,t3.rel_typ_cd,t3.rel_typ_nm
from(
    select distinct t1.cst_ID,t2.shh_nm	--股东名称
    from SJXQ_SJ2024070386_CST_01 t1
    inner join edw.dim_cst_out_geb_shh_inf_dd t2 --股权 --outd_gs_person_rypossha
    on t1.cst_ID=t2.cst_ID
    and t2.dt = '20240630'
    and nvl(t2.shh_nm,'')<>''   --股东非空
    and cast(REGEXP_SUBSTR(t2.ctrb_rto,'[0-9\\.]+') as double)>=50 --出资比例50%及以上
    where t1.brc_org_nm='湖州分行'
    and t1.cust_type='对公'
)t1 inner join edw.dim_cst_idv_bas_inf_dd t2 --个人客户基本信息
on t1.shh_nm=t2.cst_chn_nm
and t2.dt='20240630'
inner join SJXQ_SJ2024070386_CST_02 t3
on t1.cst_ID=t3.cst_ID
and t2.cst_ID=t3.rel_cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_04 AS
SElECT cst_id,rel_cst_id
FROM(
    select cst_id,rel_cst_id,rel_typ_nm
    from SJXQ_SJ2024070386_CST_02
        ,'0301' ,'0302' ,'0303') --配偶 父母 子女
    union all
    select cst_id,rel_cst_id,rel_typ_nm
    from SJXQ_SJ2024070386_CST_03
    where rel_typ_nm regexp '股权'
)T1 group BY cst_id,rel_cst_id
;
-- 湖州分行对私客户 对私客户控制的企业或占股50%的企业或配偶、子女、父母
-- 占股50%的企业
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_05 AS
select t1.cst_ID
    ,t1.rel_cst_id
    ,t3.rel_typ_cd,t3.rel_typ_nm
from(
    select distinct t1.cst_ID   --股东
        ,t2.cst_ID rel_cst_id   --对公客户号
    from (
        select distinct cst_ID,cst_nm
        from SJXQ_SJ2024070386_CST_01
        where brc_org_nm='湖州分行'
        and cust_type='对私'
    )t1 inner join edw.dim_cst_out_geb_shh_inf_dd t2 --股权
    on t1.cst_nm=t2.shh_nm
    and t2.dt = '20240630'
    and cast(REGEXP_SUBSTR(t2.ctrb_rto,'[0-9\\.]+') as double)>=50 --出资比例50%及以上
)t1 inner join SJXQ_SJ2024070386_CST_02 t3
on t1.cst_ID=t3.cst_ID
and t1.rel_cst_id=t3.rel_cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_06 AS
SElECT cst_id,rel_cst_id
FROM(
    select cst_id,rel_cst_id,rel_typ_nm
    from SJXQ_SJ2024070386_CST_02
        ,'0301' ,'0302' ,'0303') --配偶 父母 子女
    union all
    select cst_id,rel_cst_id,rel_typ_nm
    from SJXQ_SJ2024070386_CST_05
    where rel_typ_nm regexp '股权'
)T1 group BY cst_id,rel_cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST_07 AS
-- 对公
SELECT  t1.BUSI_CTR_ID   合同流水号
       ,t1.cst_ID        客户号
       ,t1.cst_nm        客户名称
       ,t2.rel_cst_id    关联客户号
       ,t3.cst_nm        关联人
       ,t2.rel_typ_nm    关联关系
       ,t3.busi_ctr_id   关联合同流水号
from SJXQ_SJ2024070386_CST_01       t1
inner join SJXQ_SJ2024070386_CST_04 t2
on t1.cst_ID=t2.cst_ID
inner join SJXQ_SJ2024070386_CST_01 t3
on t2.rel_cst_id=t3.cst_ID
and t3.brc_org_nm='杭州分行'
and t3.crd_xpos_lmt<>0          --有信贷敞口
where t1.brc_org_nm='湖州分行'
and t1.cust_type='对公'
union all
-- 对私
SELECT  t1.BUSI_CTR_ID   合同流水号
       ,t1.cst_ID        客户号
       ,t1.cst_nm        客户名称
       ,t2.rel_cst_id    关联客户号
       ,t3.cst_nm        关联人
       ,t2.rel_typ_nm    关联关系
       ,t3.busi_ctr_id   关联合同流水号
from SJXQ_SJ2024070386_CST_01       t1
inner join SJXQ_SJ2024070386_CST_06 t2
on t1.cst_ID=t2.cst_ID
inner join SJXQ_SJ2024070386_CST_01 t3
on t2.rel_cst_id=t3.cst_ID
and t3.brc_org_nm='杭州分行'
and t3.crd_xpos_lmt<>0          --有信贷敞口
where t1.brc_org_nm='湖州分行'
and t1.cust_type='对私'
;
SElECT '01' seq, count(1) cnt,count(distinct BUSI_CTR_ID) custs
from SJXQ_SJ2024070386_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024070386_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024070386_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024070386_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024070386_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024070386_CST_06
***SJ2024070386_湖州分行信贷业务数据2.sql
-- 借款人本人在杭州结清后，又在我们湖州贷的？
-- 杭州结清贷款客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST2_01 AS
select t1.cst_ID
    ,max(t1.prcp_pyf_dt) prcp_pyf_dt --本金结清日期
from edw.DIM_BUS_LOAN_CTR_INF_DD            t1 --信贷合同信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同管护信息
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t2.acs_org_id=t3.org_id
and t3.dt='@@{yyyyMMdd}'
and t3.brc_org_nm ='杭州分行'
WHERE NVL(t1.CST_ID,'') <> ''  --剔除空值和空
AND   t1.DT ='@@{yyyyMMdd}'
and   t1.hpn_dt>='20230101' 	--发生日期|C8
group by t1.cst_id
;
-- 湖州分行贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2024070386_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070386_CST2_02 AS
select t.cst_ID
    ,t.prcp_pyf_dt
    ,t1.cst_nm
    ,t1.BUSI_CTR_ID         --合同流水号
    ,t1.apnt_start_dt
    ,t1.apnt_mtu_dt
    ,t1.ctr_amt	            --合同金额|DECIMAL(20,2)
    ,t1.ctr_bal	            --合同余额|DECIMAL(20,2)
    ,t1.intr_rat	        --利率|DECIMAL(14,8)
    ,t1.hpn_dt	            --发生日期|C8
from SJXQ_SJ2024070386_CST2_01              t
left join edw.DIM_BUS_LOAN_CTR_INF_DD       t1 --信贷合同信息
on t.cst_ID=t1.cst_ID
and t2.DT ='@@{yyyyMMdd}'
and t.prcp_pyf_dt<=t1.hpn_dt    --结清后办理
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同管护信息
on t1.busi_ctr_id=t2.busi_ctr_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t2.acs_org_id=t3.org_id
and t3.dt='@@{yyyyMMdd}'
and t3.brc_org_nm ='湖州分行'
;
***SJ2024070406_台州分行客户预评估结果.sql
-- 台州分行20240630
DROP   TABLE IF     EXISTS SJXQ_SJ2024070406_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070406_CST_01 AS
select B.cst_ID,b.cst_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,C.REG_DT                              --申请日期
    ,B.BUSI_APL_ID
    ,c.pre_apl_srl_nbr
    ,D.PREEVALUATERESULT        pre_ases_res_CD
    ,c1.cd_val_dscr             pre_ases_res
	,t4.acs_org_id                               --管护机构编号|C12
	,t4.acs_mngr_id                              --管户客户经理编号|C32
from edw.DIM_BUS_LOAN_CTR_INF_DD        B --信贷合同信息
INNER JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20240630'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20240630'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd   t4        --信贷合同管护信息
on B.busi_ctr_id=t4.busi_ctr_id
and t4.dt='20240630'
inner join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t4.acs_org_id=t6.org_id
and t6.dt='20240630'
and t6.brc_org_nm='台州分行'
left join edw.dwd_code_library_dd       c1
on  d.PREEVALUATERESULT = c1.cd_val
and c1.dt = '20240630'
WHERE NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND   B.DT ='20240630'
AND(
    (
        (B.ctr_bal > 0 OR (B.ctr_bal IS NULL AND nvl(B.crc_ind,'0')='0')    --非循环贷有余额
            OR((nvl(B.crc_ind, '0') <> '0' OR B.pd_cd LIKE '2010503%')      --随贷通
                AND (B.ctr_bal = 0 OR B.ctr_bal IS NULL)
                AND B.apnt_mtu_dt >= '20240630'
            ) --（循环贷 或 随贷通） 且 余额为0 且 未到期
        ) AND nvl(B.frz_sts_cd,'') NOT IN ( '3' , '4' ) --3到期失效 4终止失效
    ) OR (B.ctr_bal > 0 AND B.pd_cd LIKE '2010503%'
        AND B.apnt_mtu_dt <= '20240630'
        AND B.frz_sts_cd IN ( '3' , '4' )
    ) --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
) --未终结、未到期业务
;
-- 同一风险控制号贷款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024070406_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070406_CST_02 AS
SELECT  A1.cst_id
        ,SUM(A3.ctr_amt) AS 同一风险控制号授信金额
        ,SUM(A3.ctr_bal) AS 同一风险控制号贷款余额
FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
INNER JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
ON      A1.sam_rsk_ctrl_id = A2.sam_rsk_ctrl_id
AND     A2.sam_rsk_ctrl_id <> ''
AND     A2.dt = '20240630'
INNER JOIN    edw.dim_bus_loan_ctr_inf_dd A3 --信贷合同信息
ON      A2.cst_id = A3.cst_id
AND     A3.apnt_mtu_dt >= A3.DT
AND     A3.hpn_dt <= A3.DT
AND     A3.end_dt = '18991231'
AND     A3.dt = '20240630'
WHERE   A1.dt = '20240630'
and     nvl(A1.sam_rsk_ctrl_id,'') <> ''
GROUP BY A1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024070406_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070406_CST_03 AS
SELECT  t1.cst_id          AS 客户编号
       ,t1.pre_ases_res    AS 预评估结果
       ,t1.acs_org_id      AS 信贷管户机构号
       ,t1.acs_mngr_id     AS 信贷管户人工号
       ,t2.sam_rsk_ctrl_id AS 同一风险控制号
       ,t3.同一风险控制号贷款余额
from SJXQ_SJ2024070406_CST_01       t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20240630'
left join SJXQ_SJ2024070406_CST_02  t3
on t1.cst_id=t3.cst_id
;
***SJ2024070531_睡眠户激活.sql
-- 20230701-20240630 发生信贷业务的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_01 as
select distinct cst_id
from edw.dim_bus_loan_ctr_inf_dd   --信贷合同信息
where dt='20240630'
and nvl(cst_id,'') <> ''    --剔除空值和空
and hpn_dt between '20230701' and '20240630'  --发生日期
;
-- 管理人变更记录
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_02 as
SELECT  cst_id
       ,MDF_DT
       ,mdf_qorg_cd ---变更前机构代码
       ,mdf_qppl_cd ---变更前人员代码
       ,aft_mdf_org_cd ---变更后机构代码
       ,aft_mdf_ppl_cd ---变更后人员代码
       ,busi_ctr_id
       ,'交接客户' mdf_type --全量客户类型：全量客户 未全量客户
       ,ctr_amt        AS mdf_ctr_amt
       ,ROW_NUMBER() over(PARTITION BY cst_id ORDER BY  MDF_DT DESC) AS ranking
FROM
(
	SELECT  t1.obj_id          AS busi_ctr_id
	       ,t2.cst_id
	       ,SUBSTR(MDF_TM,1,8) AS MDF_DT --变更时间
	       ,mdf_qorg_cd ---变更前机构代码
	       ,mdf_qppl_cd -----变更前人员代码
	       ,aft_mdf_org_cd ----变更后机构代码
	       ,aft_mdf_ppl_cd ----变更后人员代码
	       ,t2.ctr_amt
	FROM EDW.DWD_BUS_LOAN_MNG_MDF_RCD_DD t1 --管理人变更记录
	LEFT JOIN edw.dim_bus_loan_ctr_inf_dd t2
	ON t1.obj_id = t2.busi_ctr_id AND t2.dt = '20240630'
	WHERE t1.DT = '20240630'
	AND t1.OBJ_TYP = 'Loan' -- AND SUBSTR(t1.MDF_TM, 1, 8) >= '20221101' --变更时间
	AND SUBSTR(t1.MDF_TM, 1, 8) <= '20240630'
	AND t1.obj_id is not null
) ss
WHERE nvl(cst_id, '') <> ''
;
-- 20230630 前发生信贷业务的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_03 as
select t1.cst_id,t1.cst_nm                       --客户名称|C200
    ,t1.prcp_pyf_dt                              --本金结清日期|C10
	,t1.apnt_start_dt                            --约定开始日期|C8
    ,round(datediff(to_date(t1.prcp_pyf_dt,'yyyyMMdd'),to_date(t1.apnt_start_dt,'yyyyMMdd'),'dd')/365,2) jq_years
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.trm_mon                                  --期限月|INTEGER
    ,case when nvl(t2.sam_rsk_ctrl_id,'')='' then t1.cst_id else t2.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,row_number() over(partition by t1.cst_id order by t1.hpn_dt desc) rn
from edw.dim_bus_loan_ctr_inf_dd t1 --信贷合同信息
left join edw.dws_cst_bas_inf_dd t2 --客户基础信息汇总表
on  t1.cst_id=t2.cst_id
and t2.dt='20240630'
where t1.dt='20240630'
and nvl(t1.cst_id,'') <> ''    --剔除空值和空
and t1.hpn_dt <'20230701'      --发生日期
;
-- 基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_04 as
select t1.cst_id,t1.cst_nm                       --客户名称|C200
    ,t1.prcp_pyf_dt                              --本金结清日期|C10
	,t1.apnt_start_dt                            --约定开始日期|C8
    ,t1.jq_years
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.trm_mon                                  --期限月|INTEGER
    ,t1.sam_rsk_ctrl_id
    ,t2.age,decode(t2.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t2.bth_dt	--	出生日期
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
from SJXQ_SJ2024070531_CST_03                   t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2 	--对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240630'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240630'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240630'
where t1.rn=1
;
-- 同一风险控制号下近6个月日均存款
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_05 as
select t1.cst_id
    ,t1.sam_rsk_ctrl_id
    ,sum(nvl(t3.客户近6个月存款日均,0)) 同一风险控制号下近6月存款日均
from SJXQ_SJ2024070531_CST_04       t1
left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.sam_rsk_ctrl_id= case when nvl(t2.sam_rsk_ctrl_id,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end
and t2.dt='20240630'
left join(
    SELECT  cst_id
            ,SUM(last_180_days_gl_bal_acml) / 180 AS 客户近6个月存款日均
    FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
    WHERE   DT = '20240630'
    GROUP BY cst_id
)t3 on t2.cst_id=t3.cst_id
group by  t1.cst_id ,t1.sam_rsk_ctrl_id
;
-- 担保合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_06 as
SELECT  t.busi_ctr_id
       ,t.cst_id --被担保人客户号
       ,t1.CONTRACTNO --担保合同流水号
       ,t1.GUARANTYID --担保物编号
       ,CASE WHEN t2.GUARANTORID = '' or t2.GUARANTORID is null THEN t1.OWNERID  ELSE t2.GUARANTORID END   AS CUSTOMERID --担保人编号
       ,CASE WHEN t.dt >= t.hpn_dt AND (t.dt < t.apnt_mtu_dt AND t.end_dt = '18991231') THEN 1  ELSE 0 END AS is_loan_eff --合同是否在有效期内
       ,t.ctr_amt --合同金额
       ,t.ctr_bal --合同余额
       ,t.main_grnt_mth_cd --主要担保方式
       ,t.apnt_start_dt --约定开始日期
       ,t.apnt_mtu_dt --约定到期日期
       ,t.end_dt --合同终结日期
FROM edw.dim_bus_loan_ctr_inf_dd t
LEFT JOIN
(
	SELECT  a.objecttype
	       ,a.objectno
	       ,a.contractno
	       ,a.guarantyid
	       ,b.ownerid
	FROM edw.LOAN_GUARANTY_RELATIVE a
	INNER JOIN edw.LOAN_GUARANTY_INFO b
	ON a.GUARANTYID = b.GUARANTYID
	WHERE a.dt = '20240630'
	AND (a.OBJECTTYPE = 'BusinessContract' or a.OBJECTTYPE = 'ReinforceContract')
	AND b.dt = '20240630'
	AND b.GUARANTYTYPE = '030010' --担保-保证
) t1
ON t.busi_ctr_id = t1.OBJECTNO
LEFT JOIN edw.LOAN_GUARANTY_CONTRACT t2
ON t1.CONTRACTNO = t2.SERIALNO AND t2.dt = '20240630'
WHERE t.dt = '20240630'
;
--6.2 担保笔数、客户数、合同金额统计
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_07 as
SELECT  t.CUSTOMERID                                        AS cst_id
       ,COUNT(distinct busi_ctr_id)                         AS grnt_ctr_num
       ,COUNT(distinct cst_id)                              AS grnt_cst_num
       ,SUM(case WHEN t.is_loan_eff = 1 THEN t.ctr_amt end) AS grnt_occur_amt --有效期内的担保金额
       ,SUM(case WHEN t.is_loan_eff = 1 THEN t.ctr_bal end) AS grnt_occur_bal --有效期内的担保余额
FROM SJXQ_SJ2024070531_CST_06 t
WHERE t.CUSTOMERID is not null
AND t.main_grnt_mth_cd = '010' --保证担保
GROUP BY  t.CUSTOMERID
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_08 as
select t1.cst_id,t1.cst_nm                       --客户名称|C200
    ,t1.prcp_pyf_dt                              --本金结清日期|C10
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
    ,t1.jq_years
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
	,t1.trm_mon                                  --期限月|INTEGER
    ,t1.sam_rsk_ctrl_id
    ,t1.age,t1.gdr_nm
    ,t1.bth_dt	--	出生日期
    ,t1.prm_mgr_id,t1.prm_mgr_nm,t1.prm_org_id
    ,t1.brc_org_nm,t1.sbr_org_nm,t1.tem_org_nm,t1.org_nm
    ,t3.jj_cnt
    ,t4.同一风险控制号下近6月存款日均
    ,t5.grnt_ctr_num ,t5.grnt_cst_num ,t5.grnt_occur_amt ,t5.grnt_occur_bal
from SJXQ_SJ2024070531_CST_04       t1
left join SJXQ_SJ2024070531_CST_01  t2
on t1.cst_id=t2.cst_id
left join(
    select cst_id,count(distinct MDF_DT) jj_cnt
    from SJXQ_SJ2024070531_CST_02
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024070531_CST_05  t4
on t1.cst_id=t4.cst_id
left join SJXQ_SJ2024070531_CST_07  t5
on t1.cst_id=t5.cst_id
where t2.cst_id is null     --剔除 20230701-20240630 发生信贷业务的客户
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024070531_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024070531_CST_09 as
SELECT  t1.cst_id                    AS 客户号
       ,t1.cst_nm                    AS 客户名称
       ,t1.age                       AS 性别
       ,t1.bth_dt                    AS 出生日期
       ,t1.gdr_nm                    AS 年龄
       ,t1.prcp_pyf_dt               AS 最近一笔结清的贷款合同结清日期
       ,t1.apnt_start_dt             AS 最近一笔结清的贷款合同起始日期
       ,t1.apnt_mtu_dt               AS 最近一笔结清的贷款合同到期日期
       ,t1.jq_years                  AS 结清年限
       ,t1.ctr_amt                   AS 最近一笔结清的贷款合同金额
       ,t1.jj_cnt                    AS 交接次数
       ,t1.grnt_ctr_num              AS 有效期内担保合同数
       ,t1.grnt_cst_num              AS 有效期内担保客户数
       ,t1.grnt_occur_amt            AS 有效期内的担保金额
       ,t1.grnt_occur_bal            AS 有效期内的担保余额
       ,t1.同一风险控制号下近6月存款日均
       ,t1.prm_mgr_id                AS 主管户客户经理
       ,t1.prm_mgr_nm                AS 主管户客户经理名称
       ,t1.prm_org_id                AS 主管户机构
       ,t1.org_nm                    AS 主管户机构名称
       ,t2.report_dt                 AS 征信报告日期
       ,t2.curr_loan_bank_num        AS 现有贷款授信银行数
       ,t2.guar_contr_amt            AS 对外担保金额
       ,t2.guar_contr_balan          AS 对外担保本金余额
       ,t2.cl_prod_l_5_y_num         AS 历史信贷产品数_5年内历史
       ,t2.late_mon_enqu_count       AS 最近一个月内的查询次数
       ,t2.late_year_enqu_count      AS 最近一年内的查询次数
       ,t2.c_cred_card_use_frequ     AS 当前信用卡额度使用率
       ,t2.c_od_amt                  AS 当前逾期总额
       ,t2.l_2_y_od_max_time         AS 过去2年内最高逾期期数
       ,t2.c_max_od_num              AS 历史最大逾期_透支_期数
       ,t2.l_2_y_od_2_time_cred_num  AS 过去两年内逾期三期以上_包括三期_信用卡张数
       ,t2.un_settl_loan_num         AS 未结清贷款笔数
       ,t2.un_settl_jyx_loan_num     AS 未结清经营性贷款笔数
       ,t2.loan_total_amt            AS 贷款总授信额度
       ,t2.loan_total_balan          AS 贷款总余额
       ,t2.housing_loan_amt          AS 个人住房贷款余额
       ,t2.car_loan_amt              AS 个人汽车贷款余额
       ,t2.per_jyx_loan_balan        AS 个人经营性贷款余额
       ,t2.force_do_record_num       AS 强制执行记录条数
       ,t2.sett_jyx_loan_od_amt      AS 已结清经营性贷款逾期金额
       ,t2.curr_bad_extguan_loan_amt AS 当前非正常对外贷款担保金额
       ,t2.qry_rsn                   AS 查询原因
       ,t2.case_sts                  AS 法院执行案件状态
       ,t2.five_cgy_cd               AS 五级分类状态
FROM SJXQ_SJ2024070531_CST_08               t1
LEFT JOIN edw.dws_cst_ccrc_idv_ind_inf_di   t2 --个人征信指标信息表
ON t1.cst_id = t2.cst_id
AND t2.dt = '20240630'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024070531_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024070531_CST_09
;
-- lab_bigdata_dev.SJXQ_SJ2024070531_CST_09***SJ20240708101_异地业务分析.sql
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ20240708101_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20240708101_CST_01
(
    mng_org_id 			string COMMENT '管护机构号'
    ,mng_mgr_id         string COMMENT '管户人工号'
    ,cst_id             string COMMENT '客户号'
    ,cst_nm             string COMMENT '客户名称'
    ,busi_ctr_id        string COMMENT '合同号'
)
;
insert into SJXQ_SJ20240708101_CST_01
values
;
-- 信贷地址
-- ,'10','注册地址' ,'20','办公地址' ,'30','永久地址' ,'40','经营场所地址' ,'50','户籍地址' ,'60','居住地址' ,'70','其他' ,'80','线上客户维护地址'
DROP   TABLE IF     EXISTS SJXQ_SJ20240708101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240708101_CST_02 AS
SElECT t1.cst_id
    ,t2.address4    addr_office
    ,t2.addr_office_prov
    ,t2.addr_office_city
    ,t5.address4    addr_operate
    ,t5.addr_operate_prov
    ,t5.addr_operate_city
from(
    SElECT distinct customerid as cst_id
    from edw.loan_customer_address                --客户联系地址
    where dt='20240430'
)t1 left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,case   WHEN  c1.cd_val_dscr LIKE  '%省%'    then   CONCAT(substring_index(c1.cd_val_dscr, '省', 1),'省')
            WHEN  c1.cd_val_dscr LIKE  '%市%'    and    c1.cd_val_dscr  REGEXP '上海|重庆|天津|北京'  then CONCAT(substring_index(c1.cd_val_dscr, '市', 1),'市')
            WHEN  c1.cd_val_dscr REGEXP '内蒙古|广西|西藏|宁夏|新疆'    then   CONCAT(substr(c1.cd_val_dscr, 1,2),'自治区')
            WHEN  c1.cd_val_dscr REGEXP '内蒙古'    then   CONCAT(substr(c1.cd_val_dscr, 1,3),'自治区')
            WHEN  c1.cd_val_dscr LIKE  '%特别行政区%'    and    c1.cd_val_dscr REGEXP '香港|澳门'    then   CONCAT(substring_index(c1.cd_val_dscr, '特别行政区', 1),'特别行政区')
            WHEN  c1.cd_val_dscr LIKE  '%杭州市%'    then   '浙江省'
            WHEN  c1.cd_val_dscr LIKE  '%武汉市%'    then   '湖北省'
            ELSE  c1.cd_val_dscr  end  AS   addr_office_prov
        ,case when c1.cd_val_dscr LIKE  '%市%' and c1.cd_val_dscr not REGEXP '上海|重庆|天津|北京' then CONCAT(substring_index(c1.cd_val_dscr, '市', 1),'市')
            when c1.cd_val_dscr not LIKE '%省%' and c1.cd_val_dscr LIKE '%区%' then CONCAT(substring_index(c1.cd_val_dscr, '区', 1),'区')
            when c1.cd_val_dscr LIKE '%省%' and c1.cd_val_dscr not regexp '区|市' and c1.cd_val_dscr regexp '县' then CONCAT(substring_index(c1.cd_val_dscr, '县', 1),'县')
            when c1.cd_val_dscr LIKE '%省%' and c1.cd_val_dscr not regexp '区|市' and c1.cd_val_dscr regexp '州' then CONCAT(substring_index(c1.cd_val_dscr, '州', 1),'州')
            else '' end addr_office_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240430'
    where t1.dt='20240430' and t1.isnew = '1' -- 最新
    and t1.addtype = '20' -- 办公地址
)t2 on t1.cst_id=t2.cst_id and t2.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,case   WHEN  c1.cd_val_dscr LIKE  '%省%'    then   CONCAT(substring_index(c1.cd_val_dscr, '省', 1),'省')
            WHEN  c1.cd_val_dscr LIKE  '%市%'    and    c1.cd_val_dscr  REGEXP '上海|重庆|天津|北京'  then CONCAT(substring_index(c1.cd_val_dscr, '市', 1),'市')
            WHEN  c1.cd_val_dscr REGEXP '内蒙古|广西|西藏|宁夏|新疆'    then   CONCAT(substr(c1.cd_val_dscr, 1,2),'自治区')
            WHEN  c1.cd_val_dscr REGEXP '内蒙古'    then   CONCAT(substr(c1.cd_val_dscr, 1,3),'自治区')
            WHEN  c1.cd_val_dscr LIKE  '%特别行政区%'    and    c1.cd_val_dscr REGEXP '香港|澳门'    then   CONCAT(substring_index(c1.cd_val_dscr, '特别行政区', 1),'特别行政区')
            WHEN  c1.cd_val_dscr LIKE  '%杭州市%'    then   '浙江省'
            WHEN  c1.cd_val_dscr LIKE  '%武汉市%'    then   '湖北省'
            ELSE  c1.cd_val_dscr  end  AS   addr_operate_prov
        ,case when c1.cd_val_dscr LIKE  '%市%' and c1.cd_val_dscr not REGEXP '上海|重庆|天津|北京' then CONCAT(substring_index(c1.cd_val_dscr, '市', 1),'市')
            when c1.cd_val_dscr not LIKE '%省%' and c1.cd_val_dscr LIKE '%区%' then CONCAT(substring_index(c1.cd_val_dscr, '区', 1),'区')
            when c1.cd_val_dscr LIKE '%省%' and c1.cd_val_dscr not regexp '区|市' and c1.cd_val_dscr regexp '县' then CONCAT(substring_index(c1.cd_val_dscr, '县', 1),'县')
            when c1.cd_val_dscr LIKE '%省%' and c1.cd_val_dscr not regexp '区|市' and c1.cd_val_dscr regexp '州' then CONCAT(substring_index(c1.cd_val_dscr, '州', 1),'州')
            else '' end addr_operate_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240430'
    where t1.dt='20240430' and t1.isnew = '1' -- 最新
    and t1.addtype = '40' -- 经营场所地址
)t5 on t1.cst_id=t5.cst_id and t5.rn=1
;
-- 管理人变更记录
DROP   TABLE IF EXISTS SJXQ_SJ20240708101_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ20240708101_CST_03 as
SELECT  cst_id
       ,MDF_DT
       ,mdf_qorg_cd ---变更前机构代码
       ,mdf_qppl_cd ---变更前人员代码
       ,aft_mdf_org_cd ---变更后机构代码
       ,aft_mdf_ppl_cd ---变更后人员代码
       ,busi_ctr_id
       ,'交接客户' mdf_type --全量客户类型：全量客户 未全量客户
       ,ctr_amt AS mdf_ctr_amt
FROM
(
	SELECT  *
	       ,ROW_NUMBER() over(PARTITION BY cst_id ORDER BY  MDF_DT desc) AS ranking
	FROM
	(
		SELECT  t1.obj_id          AS busi_ctr_id
		       ,t2.cst_id
		       ,SUBSTR(MDF_TM,1,8) AS MDF_DT --变更时间
		       ,mdf_qorg_cd ---变更前机构代码
		       ,mdf_qppl_cd -----变更前人员代码
		       ,aft_mdf_org_cd ----变更后机构代码
		       ,aft_mdf_ppl_cd ----变更后人员代码
		       ,t2.ctr_amt
		FROM EDW.DWD_BUS_LOAN_MNG_MDF_RCD_DD    t1 --管理人变更记录
		LEFT JOIN edw.dim_bus_loan_ctr_inf_dd   t2
		ON t1.obj_id = t2.busi_ctr_id
        AND t2.dt = '20240430'
		WHERE t1.DT = '20240430'
		AND t1.OBJ_TYP = 'Loan'
		-- AND SUBSTR(t1.MDF_TM, 1, 8) >= '20221101' --变更时间
		AND SUBSTR(t1.MDF_TM, 1, 8) <= '20240430'
		AND t1.obj_id is not null
	) ss
) sss
WHERE ranking = 1 ----全量客户226726 226725
AND coalesce(cst_id, '') <> ''
;
-- 信贷客户调查信息
DROP   TABLE IF EXISTS SJXQ_SJ20240708101_CST_04 PURGE;
CREATE TABLE           SJXQ_SJ20240708101_CST_04 as
select t1.cst_id                                   --客户号|c20
	,t1.srl_nbr                                  --流水号|c32
	,t1.obj_id                                   --对象编号|c32
	,t1.obj_typ                                  --对象类型|c32
	,t1.svy_typ_cd                               --调查类型代码|c18
    ,c2.cd_val_dscr     svy_typ_nm  --客户、侧面、网站
	,t1.svy_mth_cd                               --调查方式代码|c18
    ,c1.cd_val_dscr     svy_mth_nm
	,t1.svy_tm                                   --调查时间|c8
	,t1.svy_ppl_id                               --调查参与人工号|c200
	,t1.svy_ppl_nm                               --调查人员名称|c500
	,t1.svy_act_typ_cd                           --调查实地类型代码|c100
	,'' svy_adr                                  --调查地址|c80
	,t1.svy_cntnt                                --调查内容|c800
	,t1.svy_rsl                                  --调查结果|c800
	,t1.svy_obj_nm                               --调查对象名称|c80
from edw.dwd_cst_asst_crd_cst_svy_inf_dd t1 --信贷客户调查信息
left join edw.dwd_code_library_dd c1
on  t1.svy_mth_cd = c1.cd_val
and c1.dt = '20240630'
left join edw.dwd_code_library_dd c2
on  t1.svy_typ_cd = c2.cd_val
and c2.dt = '20240630'
where t1.dt='20240630'
-- and t1.svy_mth_cd='010'     --现场
;
-- 字段汇总
DROP   TABLE IF EXISTS SJXQ_SJ20240708101_CST_05 PURGE;
CREATE TABLE           SJXQ_SJ20240708101_CST_05 as
select t1.mng_org_id 	   --管护机构号
    ,t1.mng_mgr_id         --管户人工号
    ,t1.cst_id             --客户号
    ,t1.cst_nm             --客户名称
    ,t1.busi_ctr_id        --合同号
    ,t2.addr_office
    ,t2.addr_office_prov
    ,t2.addr_office_city
    ,t2.addr_operate
    ,t2.addr_operate_prov
    ,t2.addr_operate_city
    ,t3.MDF_DT
    ,t4.unt_nm  operate_unt_nm
from SJXQ_SJ20240708101_CST_01      t1
left join SJXQ_SJ20240708101_CST_02 t2
on  t1.cst_id=t2.cst_id
left join SJXQ_SJ20240708101_CST_03 t3
on t1.cst_id=t3.cst_id
left join (
    select cst_id,unt_nm	--单位名称|C80
		,row_number() over(partition by cst_id order by upd_dt desc) as rn
		from edw.dwd_bus_loan_cvy_opr_inf_dd
		where dt = '20240630'
) t4 on t1.cst_id = t4.cst_id
and t4.rn = 1
;
-- 输出结果
DROP   TABLE IF EXISTS SJXQ_SJ20240708101_CST_06 PURGE;
CREATE TABLE           SJXQ_SJ20240708101_CST_06 as
SELECT  t1.mng_org_id        AS 管护机构号
       ,t1.mng_mgr_id        AS 管户人工号
       ,t1.cst_id            AS 客户号
       ,t1.cst_nm            AS 客户名称
       ,t1.busi_ctr_id       AS 合同号
       ,t1.operate_unt_nm    AS 经营单位名称
       ,t1.addr_operate      AS 经营地址
       ,t1.addr_operate_prov AS 经营地址的具体省级
       ,t1.addr_operate_city AS 经营地址的具体市级
       ,t1.addr_office       AS 工作单位地址
       ,t1.addr_office_prov  AS 工作地址的具体省级
       ,t1.addr_office_city  AS 工作地址的具体市级
       ,t1.MDF_DT            AS 交接时间
       ,t2.svy_tm            AS 交接后调查时间
       ,t2.svy_mth_nm        AS 交接后调查方式
       ,t2.svy_adr           AS 交接后调查地点
       ,t2.svy_ppl_nm        AS 交接后参与调查人
from SJXQ_SJ20240708101_CST_05      t1
left join SJXQ_SJ20240708101_CST_04 t2
on t1.cst_id=t2.cst_id
and t1.MDF_DT <= t2.svy_tm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240708101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240708101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240708101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240708101_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240708101_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240708101_CST_06
***SJ2024071071_泰惠收客户成本管理.sql
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024071071_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071071_CST_01
(
    seq         string comment '序号'
    ,org_nm     string comment '所属机构'
    ,chnnl      string comment '所属渠道'
    ,mch_id     string comment '商户编号'
    ,mch_nm     string comment '商户简称'
    ,mch_typ    string comment '商户类型'
    ,mch_chl    string comment '商户进件渠道'
    ,mgr_id     string comment '客户经理工号'
    ,mch_sts    string comment '商户状态'
    ,reg_dt     string comment '注册日期'
)
;
insert into SJXQ_SJ2024071071_CST_01
values
;
-- 泰惠收商户订单信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024071071_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071071_CST_02 AS
SELECT  t1.TXN_SEQ_ID       AS 内部流水号
       ,t1.MER_ID
       ,t1.TXN_DT           AS 交易日期
       ,t1.TXN_TM           AS 交易时间
       ,t2.ecif_client_no   AS cst_id
       ,t2.mcht_name        AS 商户名称
       ,t2.mcht_simple_name AS 商户简称
       ,t2.MCHT_ORG_ID      AS 机构号
       ,t2.MCHT_AMR_NO      AS 客户经理工号
       ,t2.MCHT_AMR_NAME    AS 客户经理姓名
       ,CASE WHEN sign(nvl(t3.FEE_IN_AMT,0) - 100) = - 1 THEN nvl(t3.FEE_IN_AMT,0) / 100  ELSE t3.FEE_IN_AMT / 100 END                  AS 应收手续费 --TXN_AMT_FEE
       ,CASE WHEN sign(nvl((t3.SETL_FEE_AMT ),0) - 100) = - 1 THEN nvl(( t3.SETL_FEE_AMT ),0) / 100  ELSE ( t3.SETL_FEE_AMT ) / 100 END AS 实收手续费 --AMT_FEE
FROM edw.dpss_pbs_order_info            t1
LEFT JOIN edw.dpss_pbs_mcht_base_info   t2
ON t1.MER_ID = t2.MCHT_ID
AND t2.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dpss_bth_mer_in_acc_dtl   t3
ON t1.TXN_SEQ_ID = t3.CHL_TXN_SSN
AND t3.dt = t1.dt
WHERE t1.dt >= '20240101'
AND t1.dt <= '20240630'
AND t1.TXN_SUB_TYPE IN ( '100601' , '100603' , '100604' , '100701' , '100702' , '100704' , '100800'
, '101000' , '110603' , '110702' , '110704' , '100411' , '100412' , '100413' , '100414' , '100417'
, '100419' , '100423' , '100499' , '201003' , '201002' , '201001' , '201007' )
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024071071_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071071_CST_03 AS
SELECT  t1.seq                  AS 序号
       ,t1.org_nm               AS 所属机构
       ,t1.chnnl                AS 所属渠道
       ,t1.mch_id               AS 商户编号
       ,t1.mch_nm               AS 商户简称
       ,t1.mch_typ              AS 商户类型
       ,t1.mch_chl              AS 商户进件渠道
       ,t1.mgr_id               AS 客户经理工号
       ,t1.mch_sts              AS 商户状态
       ,t1.reg_dt               AS 注册日期
       ,t2.butie                AS 成本贴补总金额_2024_1_6月
       ,t3.dmnd_dep_bal_180_avg AS 活期存款日均_2024_1_6月
from SJXQ_SJ2024071071_CST_01 t1
left join(
    SElECT MER_ID,cst_id
        ,sum(nvl(应收手续费,0)) - sum(nvl(实收手续费,0))    butie
    from SJXQ_SJ2024071071_CST_02
    group by MER_ID,cst_id
)t2 on t1.mch_id=t2.MER_ID
left join adm_pub.adm_csm_cbus_minie_ind_inf_dd	t3 --客户集市-业务信息-客户MINI泰存理指标信息表	21
on t2.cst_id=t3.cst_id
and t3.dt='20240630'
;
SElECT '01' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ2024071071_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct MER_ID) custs
from SJXQ_SJ2024071071_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 商户编号) custs
from SJXQ_SJ2024071071_CST_03
***SJ20240712146_舟山分行未用信客户清单.sql
-- 1.截止2024年6月30日，舟山分行未结清授信中，超过6个月未用信客户清单
-- 近6月用信客户
DROP   TABLE IF     EXISTS SJXQ_SJ20240712146_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712146_CST_01 as
select distinct cst_id                                   --客户编号|C20
from edw.dws_bus_loan_dbil_inf_dd             --贷款借据信息汇总
where dt='20240630'
and dtrb_dt>='20240101' --发放日期
and amt<>0              --发放金额
;
-- 舟山分行未结清授信
DROP   TABLE IF     EXISTS SJXQ_SJ20240712146_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712146_CST_02 as
select t1.busi_ctr_id                              --业务合同编号|C32
	,t1.busi_apl_id                              --业务申请编号|C32
	,t1.cst_id                                   --客户编号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
    ,t4.acs_org_id
    ,t4.acs_mngr_id
    ,t5.empe_nm     acs_mngr_nm
    ,t6.org_nm
    ,t6.tem_org_nm
from edw.dim_bus_loan_ctr_inf_dd t1 --信贷合同信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd    t4        --信贷合同管护信息
on  t1.busi_ctr_id=t4.busi_ctr_id
and t4.dt='20240630'
left join edw.dws_hr_empe_inf_dd             t5 --员工信息汇总
on  t4.acs_mngr_id=t5.empe_id
and t5.dt='20240630'
inner join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t4.acs_org_id=t6.org_id
and t6.dt='20240630'
and t6.brc_org_nm='舟山分行'
where t1.dt='20240630'
and  NVL(t1.CST_ID,'') <> ''  --剔除空值和空
AND(
    (
        (t1.ctr_bal > 0 OR (t1.ctr_bal IS NULL AND nvl(t1.crc_ind,'0')='0')    --非循环贷有余额
            OR((nvl(t1.crc_ind, '0') <> '0' OR t1.pd_cd LIKE '2010503%')      --随贷通
                AND (t1.ctr_bal = 0 OR t1.ctr_bal IS NULL)
                AND t1.apnt_mtu_dt >= '20240630'
            ) --（循环贷 或 随贷通） 且 余额为0 且 未到期
        ) AND nvl(t1.frz_sts_cd,'') NOT IN ( '3' , '4' ) --3到期失效 4终止失效
    ) OR (t1.ctr_bal > 0 AND t1.pd_cd LIKE '2010503%'
        AND t1.apnt_mtu_dt <= '20240630'
        AND t1.frz_sts_cd IN ( '3' , '4' )
    ) --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
) --未终结、未到期业务
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240712146_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712146_CST_03 as
select t1.cst_id,t1.org_nm,t1.tem_org_nm,t1.acs_mngr_nm
    ,t1.ctr_amt,t1.ctr_bal
    ,nvl(t1.ctr_amt,0)-nvl(t1.ctr_bal,0)    unuse_bal
    ,t2.digital_unscr
from(
    select t1.cst_id,t1.org_nm,t1.tem_org_nm,t1.acs_mngr_nm
        ,sum(t1.ctr_amt) ctr_amt
        ,sum(t1.ctr_bal) ctr_bal
    from SJXQ_SJ20240712146_CST_02      t1
    left join SJXQ_SJ20240712146_CST_01 t2
    on t1.cst_id=t2.cst_id
    where t2.cst_id is null
    group by t1.cst_id,t1.org_nm,t1.tem_org_nm,t1.acs_mngr_nm
)t1 left join(
    select cst_id	    --客户号
        ,digital_unscr	--数字解读 征信分
        ,row_number() over(partition by cst_id order by report_id desc) rn
    from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di --个人征信基本概要信息
    where dt <= '20240630'
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240712146_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712146_CST_04 as
select cst_id 				客户号
    ,ctr_amt                授信金额
    ,ctr_bal                当前余额
    -- ,unuse_bal              超过6个月未用信金额
    ,org_nm                 管户机构
    ,tem_org_nm             管户团队
    ,acs_mngr_nm            管户人
    ,digital_unscr          客户征信分
from SJXQ_SJ20240712146_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240712146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ20240712146_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240712146_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240712146_CST_04
;
/*
01	421375	421375
02	11990	11990
03	4286	4286
04	4286	4286
*/
-- 最新征信分
SELECT  t.cst_id
       ,t.prd_dt
       ,t.cst_cr_grd_val
       ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  prd_dt DESC ) AS rn
FROM
(
	SELECT  cst_id
	       ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyymmdd') AS prd_dt
	       ,cr_sco_val                                              AS cst_cr_grd_val
	FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
	WHERE dt <= '20240715'
	UNION
	SELECT  cst_id
	       ,to_date(prd_dt,'yyyymmdd') AS prd_dt
	       ,cst_cr_grd_val
	FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
	WHERE dt <= '20240715'
) t***SJ20240712151_金华分行社区客户.sql
/*
前提：社区所属机构：金华分行  分行机构名称：金华分行
1.存量客户存贷规模较年初：6月30日是正式客户，挂靠社区是A社区，23年12月31日是正式客户，挂靠社区是A社区，按社区统计，该部分客户存款月日均和贷款月日均的变化情况
2.新增客户存贷规模较年初：6月30日是正式客户，挂靠社区是A社区，23年12月31日不是正式客户，按社区统计，该部分客户存款月日均和贷款月日均的变化情况
字段：分行 支行 子社区名 社区状态 存量客户存贷规模较年初；新增客户存贷规模较年初
*/
-- 6月30日是正式客户
DROP   TABLE IF     EXISTS SJXQ_SJ20240712151_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712151_CST_01 AS
select t1.cst_id                                 --客户号
	,t1.prm_org_id                               --主管护机构号
	,t1.prm_org_nm                               --主管户机构名称
    ,t1.forml_cst_ind_cur_1y	            --当年新增正式客户
    ,t2.sub_cmnt_id                         --子社区编号
    ,t2.sub_cmnt_nm	                        --子社区名称
    ,t3.cmnt_nm                             --社区名称
    ,t3.cmnt_sts_cd	                        --社区状态代码|C2
    ,c1.cd_val_dscr         cmnt_sts_nm
    ,t4.sbr_org_id,t4.sbr_org_nm
    ,t4.brc_org_nm
    ,t5.dep_bal_mon_avg	                    --存款余额月日均
    ,t6.loan_bal_acs_mon_avg	            --贷款余额月日均
from adm_pub.adm_csm_cbas_mng_inf_dd        t1 --客户集市-客户基础-客户管户信息
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
AND     t2.dt = '20240630'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd    t3
ON      t2.sub_cmnt_id = t3.cmnt_enc
AND     t3.dt = '20240630'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.afl_org_id = t4.org_id
and t4.dt = '20240630'
and t4.brc_org_nm='金华分行'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	t5	--存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240630'
left join adm_pub.adm_csm_cbus_loan_inf_dd 	t6 	--贷款业务信息
on t1.cst_id=t6.cst_id
and t6.dt='20240630'
left join edw.dwd_code_library_dd           c1
on t3.cmnt_sts_cd = c1.cd_val
and c1.dt = '20240630'
where t1.dt='20240630'
and t1.forml_cst_ind = '1'  --限制正式客户
;
-- 23年12月31日
DROP   TABLE IF     EXISTS SJXQ_SJ20240712151_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712151_CST_02 AS
select t1.cst_id                                 --客户号
    ,t5.dep_bal_mon_avg	                    --存款余额月日均
    ,t6.loan_bal_acs_mon_avg	            --贷款余额月日均
from (
    select distinct cst_id
    from SJXQ_SJ20240712151_CST_01
)t1 left join adm_pub.adm_csm_cbus_dep_inf_dd 	t5	--存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='20231231'
left join adm_pub.adm_csm_cbus_loan_inf_dd 	    t6 	--贷款业务信息
on t1.cst_id=t6.cst_id
and t6.dt='20231231'
;
--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240712151_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712151_CST_03 AS
select t1.brc_org_nm
    ,t1.sbr_org_nm
    ,t1.sub_cmnt_nm	                        --子社区名称
    ,t1.cmnt_sts_nm
    -- 20240630
    ,sum(case when t1.forml_cst_ind_cur_1y<>'1' then t1.dep_bal_mon_avg else 0 end)         cl_cst_dep_mon_avg
    ,sum(case when t1.forml_cst_ind_cur_1y<>'1' then t1.loan_bal_acs_mon_avg else 0 end)    cl_cst_loan_mon_avg
    ,sum(case when t1.forml_cst_ind_cur_1y='1'  then t1.dep_bal_mon_avg else 0 end)         new_cst_dep_mon_avg
    ,sum(case when t1.forml_cst_ind_cur_1y='1'  then t1.loan_bal_acs_mon_avg else 0 end)    new_cst_loan_mon_avg
    -- 20231231
    ,sum(case when t1.forml_cst_ind_cur_1y<>'1' then t2.dep_bal_mon_avg else 0 end)         cl_cst_dep_mon_avg2
    ,sum(case when t1.forml_cst_ind_cur_1y<>'1' then t2.loan_bal_acs_mon_avg else 0 end)    cl_cst_loan_mon_avg2
    ,sum(case when t1.forml_cst_ind_cur_1y='1'  then t2.dep_bal_mon_avg else 0 end)         new_cst_dep_mon_avg2
    ,sum(case when t1.forml_cst_ind_cur_1y='1'  then t2.loan_bal_acs_mon_avg else 0 end)    new_cst_loan_mon_avg2
from SJXQ_SJ20240712151_CST_01      t1
left join SJXQ_SJ20240712151_CST_02 t2
on t1.cst_id=t2.cst_id
group by t1.brc_org_nm ,t1.sbr_org_nm ,t1.sub_cmnt_nm ,t1.cmnt_sts_nm
;
-- 分行 支行 子社区名 社区状态 存量客户存贷规模较年初；新增客户存贷规模较年初
DROP   TABLE IF     EXISTS SJXQ_SJ20240712151_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240712151_CST_04 AS
SELECT  brc_org_nm                                   AS 分行
       ,sbr_org_nm                                   AS 支行
       ,sub_cmnt_nm                                  AS 子社区名
       ,cmnt_sts_nm                                  AS 社区状态
       ,cl_cst_dep_mon_avg - cl_cst_dep_mon_avg2     AS 存量客户存款月日均较年初
       ,cl_cst_loan_mon_avg - cl_cst_loan_mon_avg2   AS 存量客户贷款月日均较年初
       ,new_cst_dep_mon_avg - new_cst_dep_mon_avg2   AS 新增客户存款月日均较年初
       ,new_cst_loan_mon_avg - new_cst_loan_mon_avg2 AS 新增客户贷款月日均较年初
from SJXQ_SJ20240712151_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240712151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240712151_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct sub_cmnt_nm) custs
from SJXQ_SJ20240712151_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 子社区名) custs
from SJXQ_SJ20240712151_CST_04
;
***SJ2024071276_他行贷款利率.sql
-- 沟通确认为：取征信数据：征信中银行名称，授信金额，余额，利率
-- 有贷款余额客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024071276_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071276_CST_01 as
select cst_id
from adm_pub.adm_csm_cbus_loan_inf_dd --贷款业务信息
WHERE dt='@@{yyyyMMdd}'
and loan_bal_acs<>0    --贷款余额（k）
-- and com_loan_bal<>0    --一般贷款余额
union -- 睡眠户
select cst_id
from app_ado.adm_subl_cst_bus_inf_dd
where dt='@@{yyyyMMdd}'
and QEFE_SLP_CST_IND='1'  --睡眠客户标识
;
select count(1) cnt,count(distinct cst_id) custs
    ,sum(case when loan_bal_acs<>0 then 1 else 0 end) loan_custs
    ,sum(case when com_loan_bal<>0 then 1 else 0 end) com_loan_custs
from adm_pub.adm_csm_cbus_loan_inf_dd 		t6 --贷款业务信息
WHERE t6.dt='@@{yyyyMMdd}'
and loan_bal_acs<>0    --贷款余额（k）
-- and com_loan_bal<>0    --一般贷款余额
;
--征信 利率
DROP   TABLE IF     EXISTS SJXQ_SJ2024071276_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071276_CST_03 AS
select report_no,id,irr,cst_id
--,DENSE_RANK()over(partition by cst_id order by SUBSTR(report_no,1,8) desc) as rk
from lab_bigdata_dev.zx_rate_result_all_di
where dt<='@@{yyyyMMdd}'
union all
select report_no,id,irr,cst_id
--,DENSE_RANK()over(partition by cst_id order by SUBSTR(report_no,1,8) desc) as rk
from lab_bigdata_dev.zx_rate_result_ent_di
where dt<='@@{yyyyMMdd}'
;
-- 个人征信客户贷款信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024071276_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071276_CST_04 AS
SELECT t.cst_id
    ,T1.ID
    ,T1.PD_CD
    ,CASE WHEN T1.DTRB_ORG LIKE '%ZJTLCB%' THEN '泰隆' ELSE T1.DTRB_ORG END AS DTRB_ORG
    ,T1.START_DT
    ,T1.MTU_DT
    ,T1.CTR_AMT
    ,T1.CTR_BAL
    ,COALESCE(T2.RATE,0) RATE
    ,case when t3.irr='-9999' or t3.irr is null then '' else irr end 他行贷款利率
FROM SJXQ_SJ2024071276_CST_01               T
LEFT JOIN EDW.DIM_CST_CCRC_IDV_LOAN_INF_DD  T1 -- 个人征信客户贷款信息
ON  T.cst_id = T1.cst_id
AND T1.DT = '@@{yyyyMMdd}'
AND T1.ACT_TYP_CD NOT IN ( 'R2' , 'R3' , 'C1' )  --过滤掉贷记卡、准贷记卡、催收账户???
LEFT JOIN
(
	SELECT  DISTINCT REPORT_ID
	       ,ID
	       ,RATE
	FROM EDW.NCIP_CPQ_ACCOUNT_CALCULATE
	WHERE DT <= '@@{yyyyMMdd}'
)T2 ON T1.REPORT_ID = T2.REPORT_ID
AND T1.ID = T2.ID
left join SJXQ_SJ2024071276_CST_03 t3
ON T1.REPORT_ID = T3.report_no
AND T1.ID = T2.ID
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024071276_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071276_CST_05 AS
SELECT  t.cst_id AS 客户号
       ,DTRB_ORG AS 发放机构
       ,START_DT AS 贷款开始日期
       ,MTU_DT   AS 贷款结束日期
       ,CTR_AMT  AS 贷款金额
       ,CTR_BAL  AS 贷款余额
       ,他行贷款利率
from SJXQ_SJ2024071276_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024071276_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct report_no,id) custs
from SJXQ_SJ2024071276_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024071276_CST_04
;
***SJ2024071631_接力贷清单.sql
-- 主表(借据号去重)
DROP   TABLE IF     EXISTS SJXQ_SJ2024071631_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071631_CST_01
(
    dbil_id         string comment '借据号'
)
;
insert into SJXQ_SJ2024071631_CST_01
;
-- 借据明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024071631_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071631_CST_02 as
select t1.dbil_id
    ,t2.bus_ctr_id
    ,t3.hpn_typ_cd          --发生类型代码
    ,c1.cd_val_dscr         hpn_typ_nm
from SJXQ_SJ2024071631_CST_01           t1
left join edw.dws_bus_loan_dbil_inf_dd 	t2 --贷款借据信息汇总 46251719 bus_ctr_id,dbil_id 唯一
on  t1.dbil_id=t2.dbil_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_inf_dd   t3 --信贷合同信息
on  t2.bus_ctr_id=t3.busi_ctr_id
and t3.dt='@@{yyyymmdd}'
left join edw.dwd_code_library_dd       c1
on t3.hpn_typ_cd = c1.cd_val
and c1.dt = '20240630'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024071631_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071631_CST_03 as
SELECT  dbil_id    AS 借据号
       ,bus_ctr_id AS 合同号
       ,hpn_typ_nm AS 发生类型
       ,is_jl_loan AS 是否接力贷
FROM SJXQ_SJ2024071631_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct dbil_id) custs
from SJXQ_SJ2024071631_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dbil_id) custs
from SJXQ_SJ2024071631_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 借据号) custs
from SJXQ_SJ2024071631_CST_03
;
***SJ2024071826_眉县会员清单.sql
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ2024071826_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024071826_CST_01
(
    seq             int     COMMENT '序号'
    ,manager_nm     string  COMMENT '总经理姓名'
    ,entp_nm        string  COMMENT '单位名称'
)
;
insert into SJXQ_SJ2024071826_CST_01
values
    (1,'韦登峰','陕西美以森工贸有限公司'),
    (2,'逯峰','宝鸡燎原机械制造有限公司'),
    (3,'李晓涛','陕西渤泰欣装饰工程有限公司'),
    (4,'华震中','陕西小华牛汽车修理有限公司'),
    (5,'武少敏','陕西农邦优品农业科技有限公司'),
    (6,'李宏军','陕西宏军现代牧业有限公司'),
    (7,'贺文轩','眉县秦岭泵业有限公司'),
    (8,'王超','眉县亿丰果业有限公司'),
    (9,'陈嘉泰','陕西长达纺织有限公司'),
    (10,'王金山','阳瑜轩体育文化有限责任公司'),
    (11,'张卫军','卫军扫把行'),
    (12,'豆亮','眉县横渠镇移动餐饮服务队'),
    (13,'梁明','满天星艺术培训学校有限公司'),
    (14,'刘博远','宝鸡景茂腾商贸有限公司'),
    (15,'周星光','眉县首善街道星光体育运动服饰店'),
    (16,'杨恒','老班长物流'),
    (17,'刘剑峰','老板厨房电器眉县专卖店'),
    (18,'张豪','宝鸡神风科美工贸有限公司'),
    (19,'李建刚','眉县安祥建筑劳务分包有限公司'),
    (20,'王纯','陕西城建科技实业有限公司'),
    (21,'杨健','眉县首善街道焕新室内清洁服务部'),
    (22,'杨洁','眉县首善镇非凡汽修厂'),
    (23,'何文泽','宝鸡唯爱蝶影文化传媒有限公司'),
    (24,'宋丹','宝鸡宋家园商贸有限公司'),
    (25,'王学军','眉县山九涂料有限公司'),
    (26,'王鹏飞','宝鸡鹏聚德建设工程有限公司'),
    (27,'马克','眉县有缘顺商行'),
    (28,'王涛东','宝鸡美果源果业有限公司'),
    (29,'王哲','眉县梧桐树网吧'),
    (30,'陈宏刚','首善镇迅洁汽车装饰部'),
    (31,'苏卫国','陕西省宝鸡千百川工程建设有限公司'),
    (32,'王德路','宝鸡富天诚建筑装饰有限公司'),
    (33,'高升建','宝鸡锦周园林绿化有限责任公司'),
    (34,'温超','眉县聆尚音乐培训学校有限公司'),
    (35,'魏建军','贝蒙特润滑油眉县店'),
    (36,'杨伟岗','陕西眉县老兵早餐'),
    (37,'夏路','海沃母婴'),
    (38,'赵云堂','宝鸡市宝云机电有限公司眉县分公司'),
    (39,'刘冬勃','無烊烧烤'),
    (40,'张永军','宝鸡天润丰运输有限公司'),
    (41,'李天成','秦光机械设备厂'),
    (42,'李巍','眉县张子礼面餐饮管理有限公司'),
    (43,'乔文涛','无名酒吧'),
    (44,'刘凯峰','深圳市佰毅豪电子科技有限公司'),
    (45,'侯红盈','眉县首善街道老吉祥馄饨店'),
    (46,'刘锦锋','陕西润锦盛旺工程项目管理有限公司'),
    (47,'王广超','眉县常兴镇侯家手工面皮'),
    (48,'张团结','陕西凯宝乐建筑工程劳务有限公司'),
    (49,'马春林','宝鸡金鑫龙养殖专业合作社'),
    (50,'马兴科','水磨经典服装店'),
    (51,'张生良','眉县常兴镇坡口综合商店'),
    (52,'苟红玉','眉县安仁堂药店'),
    (53,'何海涛','喜洋洋婚庆店'),
    (54,'余凡','陕西恒瑞祥汽车服务有限公司'),
    (55,'何腊怀','常兴何呵炒货行'),
    (56,'王宝雷','王家手擀面'),
    (57,'赵少帅','新景睿商行'),
    (58,'李高强','眉县强盛路基工程队'),
    (59,'侯春雷','陕西郿坞工贸有限公司'),
    (60,'赵小乾','宝鸡叁拾柒号餐饮服务有限公司'),
    (61,'赵小乾','陕西天机云锦商贸有限公司'),
    (62,'赵小乾','宝鸡市海之翼广告传媒有限公司'),
    (63,'杜科锋','五金产品批发零售商店'),
    (64,'崔红军','物流/仓储公司'),
    (65,'祁杰','眉县鑫胜兴畜牧养殖有限公司'),
    (66,'王嘉','岐山县纤衣美内衣店'),
    (67,'康欢欢','母婴天地母婴用品店'),
    (68,'白晓辉','眉县常兴镇佳惠超市'),
    (69,'王红军','槐芽西街红军化肥农药经销部'),
    (70,'王铁平','铁平五金铺'),
    (71,'张新龙','槐芽新龙农资经销部'),
    (72,'师明生','明生五金'),
    (73,'王志敏','槐芽生虎农资服务部'),
    (74,'王长征','长征批发部'),
    (75,'张继虎','继虎瓷砖'),
    (76,'崔建龙','宝鸡盛隆工贸有限公司'),
    (77,'闵润田','宝鸡堑通机械化施工有限公司'),
    (78,'黄维江','宝鸡亿帛商贸有限公司'),
    (79,'刘攀','眉县首善镇富士山下甜品店'),
    (80,'张义龙','眉县首善镇小张蔬菜批发部'),
    (81,'陈涛','眉县首善镇恒通汽车修理厂'),
    (82,'张成辉','眉县果益农农民专业合作社'),
    (83,'严俊','陕西晨春建筑劳务工程有限公司'),
    (84,'严俊','陕西六建兴泰建筑有限公司'),
    (85,'张喜仓','宝鸡大山创绿有限公司'),
    (86,'史永强','远征胶鞋厂'),
    (87,'李双林','陕西金茂建材有限公司'),
    (88,'张飞','眉县鸿飞生猪屠宰'),
    (89,'张宏星','优牌自愈系护肤店'),
    (90,'张宏星','西关村小春电商服务站'),
    (91,'汶瑞红','眉县琪琪猕猴桃专业合作社'),
    (92,'尹少杰','陕西双骏建设工程有限公司'),
    (93,'王振军','眉县众邦精密钣金有限公司'),
    (94,'王振军','眉县锋泰机械有限公司'),
    (95,'苟强','扶风县安能达物流有限公司'),
    (96,'杨力','宝鸡胜力安能物流有限公司'),
    (97,'高源','齐镇胡桃源主题餐厅'),
    (98,'张刚','秦亿爻商贸有限公司'),
    (99,'雷军旗','东海铝合金装潢部'),
    (100,'郭腾','眉县首善街道港州布艺窗帘店'),
    (101,'张勇','眉县汤峪镇小法仪张勇手机店'),
    (102,'王栋','眉县汤峪镇小法仪轩轩果蔬粮油超市'),
    (103,'刘建林','楼观塬村股份经济合作社'),
    (104,'邱永宏','眉县八庄果蔬专业合作社'),
    (105,'李哲','眉县汤峪美人鱼泳装专卖就有店'),
    (106,'张保军','眉县汤峪成都昊轩冷锅鱼店'),
    (107,'屈有劳','眉县金岭猕猴桃专业合作社'),
    (108,'张科','眉县汤峪镇小法仪张科农资经营部'),
    (109,'孙超群','眉县金渠镇一品香饭店'),
    (110,'杨辉','琼海卓晟建筑装饰工程有限公司'),
    (111,'孙志宏','眉县汤峪红艳商行'),
    (112,'岳智华','眉县汤峪天天红面屋'),
    (113,'杨震','眉县横渠镇小杨早餐店'),
    (114,'张永永','眉县横渠镇阳光超市'),
    (115,'吴铮','宝鸡和盛农业科技有限公司'),
    (116,'王靖军','陕西壵鑫农业有限公司'),
    (117,'武新社','横渠镇长华诊所'),
    (118,'郭宏岗','养鸡厂')
;
-- 法人姓名	统一社会信用代码	企业类型	注册地址	行业名称
DROP   TABLE IF EXISTS SJXQ_SJ2024071826_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2024071826_CST_02
(
    entp_id     string COMMENT '企业ID'
    ,entp_nm    string COMMENT '企业名称'
    ,uscc       string COMMENT '统一社会信用代码'
    ,lgp_nm     string COMMENT '法人姓名'
    ,entp_typ   string COMMENT '企业类型'
    ,reg_adr    string COMMENT '注册地址'
    ,found_dt   string COMMENT '成立日期'
    ,reg_amt    string COMMENT '注册金额'
    ,idt_1      string COMMENT '一级行业'
    ,idt_2      string COMMENT '二级行业'
    ,idt_3      string COMMENT '三级行业'
    ,idt_4      string COMMENT '四级行业'
)
;
insert into SJXQ_SJ2024071826_CST_02
values
;
-- 眉县 社区信息表
DROP   TABLE IF EXISTS SJXQ_SJ2024071826_CST_03 PURGE;
CREATE TABLE           SJXQ_SJ2024071826_CST_03 as
select t1.id                                     --系统id
	,t1.org_id                                   --所属机构id
	,t1.com_name                                 --社区名称
	,t1.branch_id                                --所属分行
	,t1.subbranch_id                             --所属支行
	,t1.team_id                                  --所属团队
	,t1.com_type                                 --社区类型:01: 综合社区，02：综合社区版块，03子社区，04社区单元，05虚拟子社区
    ,decode(t1.com_type,'01','综合社区','02','综合社区版块','03','子社区','04','社区单元','05','虚拟子社区','') com_type_nm
	,t1.com_vindicate_id                         --主维护人id
	,t3.empe_nm             com_vindicate_name   --主维护人名称
	,t1.com_code                                 --社区编码（社区唯一标识）
	,t1.com_state                                --社区状态：1潜在，2正在开发，3有效，4关闭
	,t1.com_genry                                --社区类型
    ,t2.brc_org_nm,t2.SBR_ORG_NM,t2.TEM_ORG_NM
from edw.xwdt_xw_community                  t1    --社区信息表
inner join edw.dim_hr_org_mng_org_tree_dd   t2    --机构树_考核维度
on  t1.org_id = t2.org_id
and t2.dt = '@@{yyyyMMdd}'
and t2.brc_org_nm like '%陕西眉县%'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.com_vindicate_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
where t1.dt = '@@{yyyyMMdd}'
;
--村镇银行 下辖企业
DROP   TABLE IF     EXISTS SJXQ_SJ2024071826_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071826_CST_04 AS
select t1.entid                                  --主体唯一键
	,t1.entname                                  --企业名称
	,t1.socialcreditcode                         --统一社会信用代码
	,t1.legalname                                --法人姓名
	,t1.regcapital                               --注册资金
	,t1.address         reg_addr                 --注册地址
	,t1.entstatuscode                            --企业状态码值 正常 1、异常 2、其他 3
    ,decode(t1.entstatuscode,'1','正常','2','异常','其他') entstatus_nm
	,t1.tel                                      --企业电话
	,t1.enttype                                  --企业类型
    ,decode(t1.enttype,'1','个体工商户','2','注册企业','其他') enttype_nm
	,t1.industrycode                             --行业类型
	,t1.industryname                             --行业名称
	,t1.entsize                                  --企业规模 (1大型企业2中型企业3小型企业4微型企业)
	,t1.com_id                                   --社区ID
    ,t2.brc_org_nm,t2.SBR_ORG_NM,t2.TEM_ORG_NM
    ,t2.com_type_nm,t2.com_name,t2.com_vindicate_name,t2.com_genry
	,t3.is_official                              --正式/潜在/灰色  0：正式  1：潜在 2：灰色
    ,decode(t3.is_official,'0','正式','1','潜在','未建档客户') cst_type
from edw.xwdt_xw_com_nearbyent      t1              --社区企业信息表
inner join SJXQ_SJ2024071826_CST_03 t2
on t1.com_id=t2.id
left join edw.xwdt_xw_customer      t3
on 	t1.cust_no=t3.cust_no
and t3.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
--  法人姓名	统一社会信用代码	企业类型	注册地址	行业名称
-- 客户类型	社区类型	社区名称	主维护人名称	所属团队
DROP   TABLE IF     EXISTS SJXQ_SJ2024071826_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071826_CST_05 AS
SELECT  t1.seq                AS 序号
       ,t1.manager_nm         AS 总经理姓名
       ,t1.entp_nm            AS 单位名称
       ,t2.legalname          AS 法人姓名
       ,t2.socialcreditcode   AS 统一社会信用代码
       ,t2.enttype_nm         AS 企业类型
       ,t2.reg_addr           AS 注册地址
       ,t2.industryname       AS 行业名称
       ,t2.cst_type           AS 客户类型
       ,t2.com_genry          AS 社区类型
       ,t2.com_name           AS 社区名称
       ,t2.com_vindicate_name AS 主维护人名称
       ,t2.TEM_ORG_NM         AS 所属团队
from SJXQ_SJ2024071826_CST_01       t1
left join SJXQ_SJ2024071826_CST_04  t2
on t1.entp_nm=t2.entname
;
SElECT '01' seq, count(1) cnt,count(distinct entp_nm) custs
from SJXQ_SJ2024071826_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct entp_nm) custs
from SJXQ_SJ2024071826_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct id) custs
from SJXQ_SJ2024071826_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct com_id) custs
from SJXQ_SJ2024071826_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024071826_CST_05
;
***SJ2024071891_龙海村行社区挂靠检查.sql
/*
-- 是否为定人子社区:
-- 1.有挂靠子社区的客户，判断客户管护人是否是子社区的定人之一，一致则为&ldquo;是&rdquo;，其他均为&ldquo;否&rdquo;；
-- 3.未挂靠子社区的客户，该处空白&quot;
*/
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ2024071891_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024071891_CST_01
(
    cst_id             string COMMENT '客户号'
    ,cst_nm            string COMMENT '客户名称'
)
;
insert into SJXQ_SJ2024071891_CST_01
values
;
-- 客户号     客户名     主地址     目前挂靠子社区名称     目前挂靠社区是否为定人子社区
DROP   TABLE IF     EXISTS SJXQ_SJ2024071891_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071891_CST_02 AS
SElECT t1.cst_id,t1.cst_nm
    ,t2.main_add        --主地址
    ,t2.com_son_code	--所属子社区编号
    ,t2.com_son_name	--所属子社区名称
    ,t3.prm_mgr_id
    ,t3.prm_mgr_nm
    ,t4.sub_cmnt_id     --子社区编号
    ,t4.sub_cmnt_nm     --子社区名称
    ,decode(t2.main_add_flag,'1','经营','2','通讯','3','家庭','4','户籍','5','办公','6','注册','') as 主地址类型
    ,case when (t4.sub_cmnt_id is not null and t3.prm_mgr_id regexp t5.employ_no_dr ) then '是'
        when (t4.sub_cmnt_id is null or t4.sub_cmnt_id = '') then ''
        else '否' end as 是否为定人子社区
FROM SJXQ_SJ2024071891_CST_01       t1
LEFT JOIN edw.xwdt_xw_customer   t2 --客户表(正潜灰)
ON  t1.cst_id = t2.cust_no
AND t2.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3 --客户`主管户`信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
---- 社区信息（仅看 普惠社区）
left join edw.dwd_cst_mng_cmnt_rel_dd t4
on  t1.cst_id = t4.cst_id
and t4.dt ='@@{yyyyMMdd}'
and t4.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
---- 社区定人(普惠社区定人信息表) ---- 一个社区会有多个定人
left join
(
      select community_code
      from   edw.xwdt_etl_xw_community_per
      where  dt = '@@{yyyyMMdd}'
      and    is_main_person = '2'   ---- 1主维护人，2社区定人
      group by community_code
)t5 on t4.sub_cmnt_id = t5.community_code
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024071891_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024071891_CST_03 AS
SELECT  cst_id      AS 客户号
       ,cst_nm      AS 客户名称
       ,main_add    AS 主地址
       ,sub_cmnt_id AS 子社区编号
       ,sub_cmnt_nm AS 子社区名称
       ,主地址类型
       ,是否为定人子社区
       ,prm_mgr_nm  as 主管户经理
from SJXQ_SJ2024071891_CST_02
***SJ20240722101_长乐村行举一反三.sql
-- 数据日期	核心客户编号	客户名称	配偶是否关联
DROP   TABLE IF EXISTS SJXQ_SJ20240722101_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ20240722101_CST_01
(
    cst_id             string COMMENT '客户号'
    ,cst_nm             string COMMENT '客户名称'
)
;
insert into SJXQ_SJ20240722101_CST_01
values
;
-- 信贷关联关系 配偶关系
DROP   TABLE IF     EXISTS SJXQ_SJ20240722101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240722101_CST_02 AS
SElECT cst_id,rel_cst_id
from edw.DWD_CST_REL_INF_DD         --客户关联关系信息 LOAN_CUSTOMER_RELATIVE 视图为空
where DT = '@@{yyyyMMdd}'
and REL_REL_CD = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
union
SElECT rel_cst_id,cst_id
from edw.DWD_CST_REL_INF_DD         --客户关联关系信息
where DT = '@@{yyyyMMdd}'
and REL_REL_CD = '0301' -- 配偶 ,'0101','0109'法人 实际控制人的企业
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240722101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240722101_CST_03 AS
SElECT t1.cst_id,t1.cst_nm
    ,t2.sam_rsk_ctrl_id
    ,max(case when t4.cst_id is not null then 1 else 0 end)  is_sam_ctr_po
from SJXQ_SJ20240722101_CST_01      t1
left join edw.dws_cst_bas_inf_dd    t2	--客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd    t3	--客户基础信息汇总表
on case when nvl(t2.sam_rsk_ctrl_id,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end =
case when nvl(t3.sam_rsk_ctrl_id,'')='' then t3.cst_id else t3.sam_rsk_ctrl_id end
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20240722101_CST_02 t4
on t1.cst_id=t4.cst_id
and t3.cst_id=t4.rel_cst_id
group by t1.cst_id,t1.cst_nm,t2.sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240722101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240722101_CST_04 AS
SELECT  '@@{yyyyMMdd}' AS 数据日期
       ,cst_id         AS 客户号
       ,cst_nm         AS 客户名称
       ,is_sam_ctr_po  AS 配偶是否关联
FROM SJXQ_SJ20240722101_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240722101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240722101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240722101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240722101_CST_04
;
-- 数据日期	核心客户编号	客户名称	客户名下是否有工商信息下未注销企业未关联	未关联企业名称
DROP   TABLE IF      EXISTS SJXQ_SJ20240722101_CST_10 purge;
CREATE TABLE  IF NOT EXISTS SJXQ_SJ20240722101_CST_10
(
    cst_id              string COMMENT '客户号'
    ,cst_nm             string COMMENT '客户名称'
)
;
insert into SJXQ_SJ20240722101_CST_10
values
;
DROP   TABLE IF      EXISTS SJXQ_SJ20240722101_CST_11 purge;
CREATE TABLE  IF NOT EXISTS SJXQ_SJ20240722101_CST_11 as
SELECT  t1.cst_id,t1.cst_nm,t1.doc_nbr,t1.sam_rsk_ctrl_id
        ,t2.gpr_hostsendtime ---交易发送主机时间
        ,t2.gpr_creditcode ---统一社会信用代码
        ,t2.gpr_entname ---企业(机构)名称
        ,t2.gpr_entstatus ---企业状态
        ,t2.gpr_enttype ---企业(机构)类型
        ,t2.gpr_industryphyname ---行业名称
FROM (
    SElECT t1.cst_id,t1.cst_nm,t2.doc_nbr
        ,case when nvl(t2.sam_rsk_ctrl_id,'')='' then t1.cst_id else t2.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    from SJXQ_SJ20240722101_CST_10      t1
    left join edw.dws_cst_bas_inf_dd    t2
    ON      t1.cst_id = t2.cst_id
    AND     t2.dt = '@@{yyyyMMdd}'
) t1 LEFT JOIN
(
    SELECT  otdt_query_no
        ,gpr_hostsendtime           ---交易发送主机时间
        ,dt_gpr_creditcode      AS gpr_creditcode ---统一社会信用代码
        ,dt_gpr_entname         AS gpr_entname ---企业(机构)名称
        ,dt_gpr_entstatus       AS gpr_entstatus ---企业状态
        ,dt_gpr_enttype         AS gpr_enttype ---企业(机构)类型
        ,dt_gpr_industryphyname AS gpr_industryphyname ---行业名称
        ,row_number() over(partition by otdt_query_no,IF(dt_gpr_creditcode IS NULL,dt_gpr_entname,dt_gpr_creditcode) order by gpr_hostsendtime desc) as rk
        FROM   edw.nout_gs_prsn_ryposfrtd     ---- edw.noutd_gs_prsn_ryposfr
        WHERE   dt >'00000000' and replace(dt_gpr_esdate,'-','') <='@@{yyyyMMdd}'
) t2 on lower(md5(t1.doc_nbr)) = lower(t2.otdt_query_no)
and rk = 1
;
DROP   TABLE IF      EXISTS SJXQ_SJ20240722101_CST_12 purge;
CREATE TABLE  IF NOT EXISTS SJXQ_SJ20240722101_CST_12 as
SELECT  t1.cst_id           --客户号
       ,t1.cst_nm           --客户姓名
       ,t1.gpr_entname      --工商信息下未注销的企业
       ,t1.gpr_creditcode   --统一社会信用代码
      ,max(case when t2.doc_nbr = t1.gpr_creditcode then 1 else 0 end) as 信贷系统是否关联
from SJXQ_SJ20240722101_CST_11      t1
left join edw.dws_cst_bas_inf_dd    t2
on t1.sam_rsk_ctrl_id = t2.sam_rsk_ctrl_id
and t2.dt = '@@{yyyyMMdd}'
where t1.gpr_entstatus rlike '在营'
group by t1.cst_id ,t1.cst_nm ,t1.gpr_entname ,t1.gpr_creditcode
;
-- 字段汇总
DROP   TABLE IF      EXISTS SJXQ_SJ20240722101_CST_13 purge;
CREATE TABLE  IF NOT EXISTS SJXQ_SJ20240722101_CST_13 as
SELECT  '@@{yyyyMMdd}' AS 数据日期
       ,cst_id         AS 客户号
       ,cst_nm         AS 客户名称
       ,case when gpr_entname is not null and 信贷系统是否关联=0 then '是' else '否' end 客户是否有工商信息下未注销企业未关联
       ,gpr_entname    AS 工商信息下未注销的企业名称
from SJXQ_SJ20240722101_CST_12
;
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240722101_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240722101_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240722101_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240722101_CST_13
***SJ2024072231_半山支行逾期业务清单.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024072231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072231_CST_01 AS
SElECT ctr_serno,max_ovd_amt,dt
from(
    SElECT ctr_serno,ovd_amt max_ovd_amt,dt
        ,ROW_NUMBER() over(partition by ctr_serno order by ovd_amt desc) rn
    from edw.dim_bus_loan_ctr_bse_inf_dd --合同基础信息
    where dt<='20240722'
    and dt>='20220701'
    and ovd_amt<>0  --有过逾期
)t1 where rn=1
;
-- 当前未结清合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024072231_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072231_CST_02 AS
SELECT  t1.ctr_serno               --合同流水号
       ,t1.rel_serno               --用信申请流水号
       ,t1.cst_id                  --客户号
       ,t1.cst_nm                  --客户名称
       ,t1.prd_no                  --产品编号
       ,t1.ctr_amt                 --合同金额
       ,t1.ctr_epsr_amt            --合同敞口金额
       ,t1.ctr_mtu_dt              --合同到期日期
       ,t1.ctr_bgn_dt              --合同起始日期
       ,t1.facl_trm                --授信期限
       ,t1.ctr_sts_cd              --合同状态代码
       ,t1.mgr_id                  --管户人工号
       ,t4.empe_nm  mgr_nm
       ,t1.mgr_org_id              --管户机构号
       ,t1.smls_reloan_ind         --无缝续贷标志
       ,t1.exec_intr_rat           --执行利率
       ,t1.hpn_typ_cd              --发生类型代码|c6
       ,t1.inv_in_indy_cd          --投向行业代码|c5
       ,t1.ctr_bal                 --合同余额
       ,t1.tmt_dt                  --终结日期
       ,t1.ovd_amt                 --逾期金额
       ,t1.ctr_epsr_bal            --合同敞口余额
       ,t1.ctr_eff_dt              --合同生效日期
       ,t1.prcp_setl_dt            --本金结清日期
       ,t3.brc_org_nm
       ,t3.org_nm
FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD            t1 --合同基础信息
LEFT JOIN EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD   t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '20240722'
inner join edw.dim_hr_org_mng_org_tree_dd       t3 --考核机构树
on  t1.mgr_org_id=t3.org_id
and t3.dt='20240722'
and t3.sbr_org_nm ='杭州半山小微企业专营支行'
left join edw.dws_hr_empe_inf_dd                t4 --员工信息汇总
on  t1.mgr_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
WHERE   t1.dt = '20240722'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024072231_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072231_CST_03 AS
SELECT  t2.cst_id      AS 客户号
       ,t2.cst_nm      AS 客户名称
       ,t2.ctr_amt     AS 合同金额
       ,t2.ctr_bal     AS 合同余额
       ,t2.ctr_bgn_dt  AS 合同起始日期
       ,t2.ctr_mtu_dt  AS 合同到期日期
       ,t2.mgr_nm      AS 信贷管户经理
       ,t2.org_nm      AS 管户部门
       ,t1.max_ovd_amt AS 历史最大逾期金额
       ,t1.dt          AS 历史逾期日期
       ,t2.ovd_amt     AS 当前逾期金额
from SJXQ_SJ2024072231_CST_01       t1
inner join SJXQ_SJ2024072231_CST_02 t2  --有过逾期
on t1.CTR_SERNO=t2.CTR_SERNO
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024072231_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024072231_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024072231_CST_03
;
-- lab_bigdata_dev.SJXQ_SJ2024072231_CST_03***SJ2024072281_龙海村行随贷通新客明细.sql
-- 截至7月18日，龙海村行新发放随贷通卡客户，起始日6月1日至7月18日
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_01 AS
SElECT t1.busi_ctr_id
    ,t1.cst_id,t1.cst_nm                       --客户名称|C200
	,t1.apnt_start_dt                            --约定开始日期|C8
	,t1.apnt_mtu_dt                              --约定到期日期|C8
	,t1.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t1.ctr_bal                                  --合同余额|DECIMAL(20,2)
    ,t4.brc_org_nm
from edw.dim_bus_loan_ctr_inf_dd      t1  --信贷合同信息 5820863 busi_ctr_id
INNER join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3  --信贷合同管护信息 5846462 busi_ctr_id
on t1.busi_ctr_id = t3.busi_ctr_id
and t3.dt = '@@{yyyyMMdd}'
INNER join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4481 org_id 唯一
on t3.acs_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM like '福建龙海泰隆村镇%'       --龙海村行
where t1.dt='@@{yyyyMMdd}'
and t1.hpn_dt between '20240601' and '20240718' --起始日6月1日至7月18日
and t1.pd_cd like '2010503%'                    --随贷通
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_02 AS
SELECT  t1.cst_id
    ,t2.prd_dt
    ,t2.cst_cr_grd_val
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 inner join(
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240718'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240718'
)t2 on t1.cst_id=t2.cst_id
;
-- 子社区
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_03 AS
select t1.cst_id
    ,t6.cprh_cmnt_id                        --综合社区编号
    ,t6.cprh_cmnt_plt_id                    --综合社区板块编号
    ,t6.sub_cmnt_id                         --子社区编号
    ,t7.cmnt_nm                             --社区名称
    ,t7.adr                                 --社区地址
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 inner join edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20240718'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20240718'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_04 AS
SElECT t1.cst_id
    ,t2.age
    ,t3.dep_bal	        --存款余额
    ,t4.loan_bal_acs	--贷款余额（k）
    ,t5.cred_card_num	--信用卡张数
    ,t6.cst_cr_grd_val
    ,t7.cmnt_nm
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2 	--对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240718'
left join adm_pub.adm_csm_cbus_dep_inf_dd	        t3 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt='20240718'
left join adm_pub.adm_csm_cbus_loan_inf_dd	        t4 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20240718'
left join edw.dws_cst_ccrc_idv_ind_inf_di	        t5 --个人征信指标信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240718'
left join SJXQ_SJ2024072281_CST_02 t6
on t1.cst_id=t6.cst_id
and t6.rn=1
left join SJXQ_SJ2024072281_CST_03 t7
on t1.cst_id=t7.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_05 AS
SELECT  cst_id         AS 客户号
       ,cmnt_nm        AS 子社区
       ,age            AS 年龄
       ,cst_cr_grd_val AS 征信分
       ,dep_bal        AS 存款余额
       ,loan_bal_acs   AS 贷款余额（k）
       ,cred_card_num  AS 信用卡张数
FROM SJXQ_SJ2024072281_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024072281_CST_05
***SJ2024072281_龙海村行随贷通新客明细2_新信贷.sql
﻿--黄瑄妮028508-龙海村行新发放随贷通卡客户相关数据
--SJ2024072281
-- 截至7月18日，龙海村行新发放随贷通卡客户，起始日6月1日至7月18日
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_01 AS
SELECT  t1.ctr_serno               --合同流水号
       ,t1.cst_id                  --客户号
       ,t1.cst_nm                  --客户名称
       ,t1.ctr_mtu_dt              --合同到期日期
       ,t1.ctr_bgn_dt              --合同起始日期
       ,t1.ctr_amt                 --合同金额
       ,t1.ctr_bal                 --合同余额
       ,t4.brc_org_nm
from edw.DIM_BUS_LOAN_CTR_BSE_INF_DD        t1
INNER join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3  --信贷合同管护信息
on t1.ctr_serno = t3.CTR_SERNO
and t3.dt = '@@{yyyyMMdd}'
INNER join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4481 org_id 唯一
on t3.MGR_ORG_ID = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.BRC_ORG_NM like '福建龙海泰隆村镇%'       --龙海村行
where t1.dt='@@{yyyyMMdd}'
and t1.ctr_bgn_dt between '20240601' and '20240718' --合同起始日6月1日至7月18日
    ,'2001020101003')               -- 随贷通-经营
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_02 AS
SELECT  t1.cst_id
    ,t2.prd_dt
    ,t2.cst_cr_grd_val
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 inner join(
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240718'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240718'
)t2 on t1.cst_id=t2.cst_id
;
-- 子社区
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_03 AS
select t1.cst_id
    ,t6.cprh_cmnt_id                        --综合社区编号
    ,t6.cprh_cmnt_plt_id                    --综合社区板块编号
    ,t6.sub_cmnt_id                         --子社区编号
    ,t7.cmnt_nm                             --社区名称
    ,t7.adr                                 --社区地址
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 inner join edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20240718'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '20240718'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_04 AS
SElECT t1.cst_id
    ,t2.age
    ,t3.dep_bal	        --存款余额
    ,t4.loan_bal_acs	--贷款余额（k）
    ,t5.cred_card_num	--信用卡张数
    ,t6.cst_cr_grd_val
    ,t7.cmnt_nm
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2 	--对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240718'
left join adm_pub.adm_csm_cbus_dep_inf_dd	        t3 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt='20240718'
left join adm_pub.adm_csm_cbus_loan_inf_dd	        t4 --客户集市-业务信息-客户贷款业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20240718'
left join edw.dws_cst_ccrc_idv_ind_inf_dd	        t5 --个人征信指标信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240718'
and t5.report_dsc_rn=1
left join SJXQ_SJ2024072281_CST_02 t6
on t1.cst_id=t6.cst_id
and t6.rn=1
left join SJXQ_SJ2024072281_CST_03 t7
on t1.cst_id=t7.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024072281_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072281_CST_05 AS
SELECT  cst_id         AS 客户号
       ,cmnt_nm        AS 子社区
       ,age            AS 年龄
       ,cst_cr_grd_val AS 征信分
       ,dep_bal        AS 我行存款余额
       ,loan_bal_acs   AS 我行贷款余额
       ,cred_card_num  AS 他行信用卡张数
FROM SJXQ_SJ2024072281_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072281_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024072281_CST_05
;
***SJ2024072351_泾阳村行隐患客户盘点.sql
-- 陕西泾阳泰隆村镇 截止7月22日 所有逾期过 且 未结清的贷款业务
-- 所有逾期过合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024072351_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072351_CST_01 AS
SElECT ctr_serno,min(ovd_dt)    min_ovd_dt
from edw.dim_bus_loan_ctr_bse_inf_dd --合同基础信息
where dt<='20240722'
and ovd_amt<>0  --有过逾期
group by ctr_serno
;
-- 当前未结清合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024072351_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072351_CST_02 AS
SELECT  t1.ctr_serno               --合同流水号
       ,t1.rel_serno               --用信申请流水号
       ,t1.cst_id                  --客户号
       ,t1.cst_nm                  --客户名称
       ,t1.prd_no                  --产品编号
       ,t1.ctr_amt                 --合同金额
       ,t1.ctr_epsr_amt            --合同敞口金额
       ,t1.ctr_mtu_dt              --合同到期日期
       ,t1.ctr_bgn_dt              --合同起始日期
       ,t1.facl_trm                --授信期限
       ,t1.ctr_sts_cd              --合同状态代码
       ,t1.mgr_id                  --管户人工号
       ,t1.mgr_org_id              --管户机构号
       ,t1.smls_reloan_ind         --无缝续贷标志
       ,t1.exec_intr_rat           --执行利率
       ,t1.hpn_typ_cd              --发生类型代码|c6
       ,t1.inv_in_indy_cd          --投向行业代码|c5
       ,c2.cd_val_dscr      inv_in_indy_nm
       ,t1.ctr_bal                 --合同余额
       ,t1.tmt_dt                  --终结日期
       ,t1.ovd_amt                 --逾期金额
       ,t1.ovd_dt                  --逾期日期
       ,t1.ctr_epsr_bal            --合同敞口余额
       ,t1.ctr_eff_dt              --合同生效日期
       ,t1.prcp_setl_dt            --本金结清日期
       ,t3.brc_org_nm
       ,t3.org_nm
       ,t4.mfcustomerid	           --核心客户号
FROM EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD            t1 --合同基础信息
LEFT JOIN EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD   t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '20240722'
inner join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t1.mgr_org_id=t3.org_id
and t3.dt='20240722'
and t3.brc_org_nm regexp '陕西泾阳泰隆村镇'
left join edw.loan_customer_info	        t4 --客户基本信息
on t1.cst_id=t4.customerid
and t4.dt='20240722'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.inv_in_indy_cd = C2.CD_VAL
AND C2.DT = '20240722'
WHERE   t1.dt = '20240722'
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08' OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' ) OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024072351_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072351_CST_03 AS
SElECT t1.ctr_serno
    ,t1.min_ovd_dt
    ,t2.org_nm         --机构
    ,t2.cst_id         --客户号
    ,t2.cst_nm         --客户名称
    ,t2.mfcustomerid   --核心客户号
    ,t2.ctr_amt        --合同金额
    ,t2.ctr_bal        --合同余额
    ,t2.ctr_mtu_dt     --合同到期日期
    ,t2.inv_in_indy_nm --投向行业
from SJXQ_SJ2024072351_CST_01       t1
inner join SJXQ_SJ2024072351_CST_02 t2  --有过逾期
on t1.CTR_SERNO=t2.CTR_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024072351_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072351_CST_04 AS
SELECT  org_nm         AS 机构
       ,cst_id         AS 客户号
       ,cst_nm         AS 客户名称
       ,mfcustomerid   AS 核心客户号
       ,ctr_amt        AS 合同金额
       ,ctr_bal        AS 合同余额
       ,ctr_mtu_dt     AS 合同到期日期
       ,inv_in_indy_nm AS 投向行业
       ,'是'           AS 是否逾期过
       ,ovd_days       AS 逾期天数
FROM SJXQ_SJ2024072351_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024072351_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024072351_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024072351_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024072351_CST_04
;
-- lab_bigdata_dev.SJXQ_SJ2024072351_CST_04***SJ2024072381_汝南村行他行数据.sql
-- 截止7.23日 河南汝南泰隆村镇银行
DROP   TABLE IF     EXISTS SJXQ_SJ2024072381_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072381_CST_01 AS
SElECT t1.cst_id
    ,t1.report_dt	                --报告日期
    ,t1.cred_total_balan	        --授信余额（信用总余额）
    ,t1.cred_card_total_balan	    --信用卡总余额
    ,t1.un_settl_loan_num	        --未结清贷款笔数
    ,t1.o_b_un_sett_loan_fdzy_amt	--他行未结清非抵质押贷款余额
    ,t1.loan_total_balan	        --贷款总余额
    ,t1.curr_unsett_fyh_loan_bal	--当前未结清非银行贷款余额
    ,t2.zxqu_l6m_cnt	            --最近6个月内查询次数
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.cst_chn_nm	                --客户姓名|C200
    ,row_number() over(partition by t1.cst_id order by t1.report_no desc) rn
from edw.dws_cst_ccrc_idv_ind_inf_di	            t1 --个人征信指标信息表
left join adm_pub.adm_csm_cbus_out_crd_idv_qry_dd	t2 --客户集市-业务信息-个人征信-查询信息表
on t1.cst_id=t2.cst_id
and t2.dt='20240723'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240723'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240723'
and t4.brc_org_nm regexp '河南汝南泰隆村镇'
left join edw.dws_cst_bas_inf_dd 				    t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='20240723'
where t1.dt<='20240723'
;
-- 利率
DROP   TABLE IF     EXISTS SJXQ_SJ2024072381_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072381_CST_02 AS
SElECT t1.cst_id
from SJXQ_SJ2024072381_CST_01               t1
LEFT JOIN EDW.DIM_CST_CCRC_IDV_LOAN_INF_DD  T2 -- 个人征信客户贷款信息
ON  T1.cst_id = T2.cst_id
AND T2.DT = '20240723'
left join(
	SELECT  DISTINCT REPORT_ID
	       ,ID
	       ,RATE
	FROM EDW.NCIP_CPQ_ACCOUNT_CALCULATE
	WHERE DT <= '20240723'
)t3 on t2.id=t3.id
and t2.report_id=t3.report_id
where t1.rn=1
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024072381_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072381_CST_03 AS
SELECT  t1.cst_id                    AS 客户号
       ,t1.cst_chn_nm                AS 客户姓名
       ,concat(t1.prm_mgr_id, ' ', t1.prm_mgr_nm) AS 主管户客户经理
       ,t1.org_nm                    AS 主管户机构
       ,t1.report_dt                 AS 报告日期
       ,t1.cred_total_balan          AS 授信余额_信用总余额
       ,t1.cred_card_total_balan     AS 信用卡总余额
       ,t1.un_settl_loan_num         AS 未结清贷款笔数
       ,t1.o_b_un_sett_loan_fdzy_amt AS 他行未结清非抵质押贷款余额
       ,t1.loan_total_balan          AS 贷款总余额
       ,t1.curr_unsett_fyh_loan_bal  AS 当前未结清非银行贷款余额
       ,t1.zxqu_l6m_cnt              AS 最近6个月内查询次数
       ,t2.rate_s                    AS 征信报告利率汇总
from SJXQ_SJ2024072381_CST_01       t1
left join SJXQ_SJ2024072381_CST_02  t2
on t1.cst_id=t2.cst_id
where t1.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072381_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072381_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024072381_CST_03
***SJ20240724131-吴丹娜-013561.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 杨相伟
-- 创建日期: 2024-07-24 18:03:44
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 截止取数日，嘉兴分行开立的存量个人账户，近半年日均小于2万元（含）
-- 1.员工和员工直系亲属账户（同人力资源系统数据）
-- 2.虚拟账户（如银承驾校农民工）
-- 3.在我行存在定期、理财有余额的或购买保险的客户名下账户
-- 4.贷款在授信期内的，贷款的还款账户、签约随贷通、随贷通的主卡账户、信用卡自扣还款
-- 5.公共事业费账户，①缴纳税费②水、电、燃气、通讯费、港务费等公共事业费用的代扣代缴账户③路桥水费、天然气代扣账户
-- 6.已经被止付、冻结、暂停非柜
-- 7.账户状态为销户、不动户、营业外收入
-- 注：1-7为剔除口径
SELECT COUNT(*)
FROM  lab_bigdata_dev.tmp_yxw_wdn_20240724_ds_001;
SELECT *
FROM  lab_bigdata_dev.tmp_yxw_wdn_20240724_ds_001;
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_wdn_20240724_ds_001 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_wdn_20240724_ds_001 AS
SELECT  DISTINCT
         T1.cst_id        as  客户号
        ,T1.cst_act_id    as  客户账号
        ,T1.dep_act_id    as  存款账号
        ,T1.ACT_STS_CD    as  账户状态代码
        ,T19.cd_val_dscr  as  账户状态
        ,T1.act_nm        as  账户名称
        ,T1.opn_dt        as  开户日期
        ,2024-SUBSTR(T3.doc_nbr,7,4)  as 年龄
        ,concat(substr(regexp_replace(T3.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.reg_adr,'\\s|,',''))-6,0)),'******')   户籍地址脱敏
        ,CASE WHEN  T9.cst_id is null then  '否'
              WHEN  T9.cst_id is not null THEN  '是'
              else  '其他'  end  AS   手机银行是否签约
        ,T9.手机单笔限额
        ,T9.手机日累计限额
        ,CASE WHEN  T91.cst_id is null then  '否'
              WHEN  T91.cst_id is not null THEN  '是'
              else  '其他'  end          AS   网上银行是否签约
        ,T91.网银单笔限额
        ,T91.网银日累计限额
        ,CASE WHEN  T8.客户账号 is null then  '否'
              WHEN  T8.客户账号 is not null THEN  '是'
              else  '其他'  end  AS   是否设置非柜限额
        ,T8.单笔限额        as 非柜单笔限额
        ,T8.累计限额        as 非柜汇总日累计限额
        ,T7.efe_dep_cst_ind  as 有效存款户标识_1是_空否
        ,T7.efe_loan_cst_ind as 有效贷款户标识_1是_空否
        ,T7.efe_chm_cst_ind  as 有效理财户标识_1是_空否
        ,if(T13.cst_id is NOT NULL ,'是','否')      as  	当前是否定期客户
        ,if(T14.cst_act_id is NOT NULL ,'是','否')  as  	是否有保险基金等强关联业务
        ,T1.gl_bal        AS  总账余额
        ,T1.last_180_days_gl_bal_acml/180  AS  近半年日均
        ,T1.last_360_days_gl_bal_acml/360  AS  近一年日均
        ,T1.opn_org       as  开户机构编号
        ,T2.org_nm        as  开户机构名称
        ,T2.sbr_org_nm    as  开户支行名称
        ,T4.mgr_id        as  存款管户客户经理编号
        ,T5.empe_nm       as  存款管户客户经理名称
        ,T4.acs_org_id    as  存款管户客户经理考核机构编号
        ,a4.org_nm        as  存款管户客户经理考核机构
        ,a4.sbr_org_nm    as  存款管户客户经理考核支行
        ,T21.trx_amt_sum_max        AS   非柜面渠道近半年日转出金额最大值
        ,T21.dtl_seq_nbr_D_days     AS   非柜面渠道近半年使用笔数出账
        ,T21.dtl_seq_nbr_C_days     AS   非柜面渠道近半年使用笔数入账
        ,T31.trx_amt_sum_max        AS   非柜面渠道近一年日转出金额最大值
        ,T31.dtl_seq_nbr_D_days     AS   非柜面渠道近一年使用笔数出账
        ,T31.dtl_seq_nbr_C_days     AS   非柜面渠道近一年使用笔数入账
        ,T29.trx_amt_sum_C          AS   全渠道近半年入账笔数
        ,T29.trx_amt_sum_C_numbers  AS   全渠道近半年入账金额加总
        ,T29.trx_amt_sum_D          AS   全渠道近半年出账笔数
        ,T29.trx_amt_sum_D_numbers  AS   全渠道近半年出账金额加总
        ,T30.trx_amt_sum_C          AS   全渠道近一年入账笔数
        ,T30.trx_amt_sum_C_numbers  AS   全渠道近一年入账金额加总
        ,T30.trx_amt_sum_D          AS   全渠道近一年出账笔数
        ,T30.trx_amt_sum_D_numbers  AS   全渠道近一年出账金额加总
FROM       edw.dws_bus_dep_act_inf_dd T1           -- 存款账户信息表
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd  T2      ON  T1.opn_org=T2.org_id  and T2.dt='@@{yyyyMMdd}'
left JOIN  edw.dws_cst_bas_inf_dd          T3      ON  T1.cst_id =T3.cst_id  and T3.dt='@@{yyyyMMdd}'
left JOIN  edw.dwd_bus_dep_cst_act_mgr_inf_dd T4   ON  T1.cst_act_id =T4.cst_act_id  and T4.dt='@@{yyyyMMdd}'  and T4.frs_ctc_ind = '1'
left join  edw.dws_hr_empe_inf_dd          T5      ON  T4.mgr_id=T5.empe_id  and  T5.dt='@@{yyyyMMdd}'
left JOIN  edw.dim_hr_org_mng_org_tree_dd  a4      ON  T4.acs_org_id=a4.org_id  and a4.dt='@@{yyyyMMdd}'
left join  (
                 SELECT b1.*
				 from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
                 FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     NFRZ_IND = '0') b1 where b1.rn=1
             ) T6 --账户冻结登记
on T1.cst_act_id=T6.cst_act_id
left join (select *
          from edw.dwd_code_library_dd
          where dt='@@{yyyyMMdd}'
          and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
          and fld_nm='FRZ_CLS_CD') a2
on T6.frz_cls_cd=a2.cd_val
left join adm_pub.adm_csm_cbas_ind_inf_dd  T7 ON  T1.cst_id=T7.cst_id  and T7.dt='@@{yyyyMMdd}'
left  JOIN  (
        select
          cengcgjz 客户账号,
          danciedu 单笔限额,
          leijiedu 累计限额
        from edw.core_kdpa_zheddy -- 负债账户额度定义表
        where dt = '@@{yyyyMMdd}'
        and  zhxeleix='2'
        and shijbhao='FGMXIANE' -- 非柜面限额
        and edkzzhqi='1D' -- 日限额
)   T8  on  T1.cst_act_id=T8.客户账号
left JOIN  lab_bigdata_dev.tmp_yxw_20230324_s_p1  T9  on  T1.cst_id=T9.cst_id
left JOIN  lab_bigdata_dev.tmp_hyx_20230324_s_w1  T91 ON  T1.cst_id=T91.cst_id
left join  ( SELECT a1.*
			 from
                 (SELECT  *,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
                  FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                  WHERE   DT = '@@{yyyyMMdd}'
                  AND     NFRZ_IND = '0'  ) a1
                  where  a1.rn=1
             ) T11        --账户冻结登记
    on T1.cst_act_id=T11.cst_act_id
left join (select * from edw.dwd_code_library_dd where dt='@@{yyyyMMdd}' and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD' and fld_nm='FRZ_CLS_CD') a1
    on T11.frz_cls_cd=a1.cd_val
left  JOIN  (
    select cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where  dt='@@{yyyyMMdd}'
    AND    fld_nm='ACT_STOP_PMT_TYP_CD'
    AND    tbl_nm='DWD_BUS_DEP_FRZ_INF_DD') a11   on T11.ACT_STOP_PMT_TYP_CD=a11.cd_val
left join ( SELECT c1.*
		from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
                 FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     ACT_THRS_TYP = '2'      --暂停非柜面
				 and evt_id='DPDRAW') c1 where c1.rn=1
             ) T12 --账户额度控制
on     T1.cst_act_id=T12.cst_act_id
left join (
    select  cst_id
        -- ,sum(gl_bal)  定期余额
    from edw.dws_bus_dep_act_inf_dd
    where dt='@@{yyyyMMdd}'
    and lbl_prod_typ_cd='1'
    group by cst_id
    -- HAVING sum(gl_bal)>10000
    HAVING  sum(gl_bal)>0
) T13 on T1.cst_id=T13.cst_id
left join (
    --理财自营存在余额的账号
    select  bnk_act_id  as cst_act_id
    from   edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}'
    and  LOT_TOT_NBR>0
    and TA_CD='TL'
    group by bnk_act_id
    having sum(LOT_TOT_NBR)>0
    union
    ---理财代销存在余额的账号
    select  bnk_act_id as cst_act_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}'
    and  LOT_TOT_NBR>0
    and PD_CD in (select prd_code  from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='1'  and substr(control_flag,75,1)='1')  group by bnk_act_id having sum(LOT_TOT_NBR)>0
    union
    --保险 保单状态（正常 已质押 ）
    select  A.trx_act_id  as  cst_act_id
            -- ,SUM(A.insu_fee)  as insu_fee_sum
    from   edw.dim_bus_insu_plcy_bas_inf_dd A
    WHERE  A.dt='@@{yyyyMMdd}'
    GROUP BY  A.trx_act_id
    HAVING  SUM(A.insu_fee)>0
    union
    select  cst_act_id
        -- ,sum(gl_bal)  定期余额
    from edw.dws_bus_dep_act_inf_dd
    where dt='@@{yyyyMMdd}'
    and lbl_prod_typ_cd='1'
    group by cst_act_id
    -- HAVING  sum(gl_bal)>10000
    HAVING  sum(gl_bal)>0
) T14 on T1.cst_act_id=T14.cst_act_id
left join  (
     select  cd_val,cd_val_dscr
     from    edw.dwd_code_library_dd
     where   dt='@@{yyyyMMdd}'
     and     cd_nm like '%存款账户状态%'
     AND     tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
      )   T19  on T1.act_sts_cd=T19.cd_val
left join  (
    select cd_val,cd_val_dscr
    from   edw.dwd_code_library_dd
    where  dt='@@{yyyyMMdd}'
    AND    fld_nm='DOC_TYP_CD'
    AND    tbl_nm='DIM_CST_BAS_DOC_INF_DD'
      )   T20   on T3.doc_typ_cd=T20.cd_val
left JOIN (
     SELECT  A.cst_act_id
            ,A.dep_act_id
            ,sum(if(A.crd_and_dbt_ind='C',A.trx_amt,0))  trx_amt_sum_C
            ,sum(if(A.crd_and_dbt_ind='C',1,0))          trx_amt_sum_C_numbers
            ,sum(if(A.crd_and_dbt_ind='D',A.trx_amt,0))  trx_amt_sum_D
            ,sum(if(A.crd_and_dbt_ind='D',1,0))          trx_amt_sum_D_numbers
    FROM  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI  A
    WHERE A.dt>='@@{yyyyMMdd-6m}'
    AND   A.dt<='@@{yyyyMMdd}'
    GROUP BY  A.cst_act_id,A.dep_act_id
)    T29  on T1.cst_act_id=T29.CST_ACT_ID   and   T1.dep_act_id=T29.dep_act_id
left JOIN (
     SELECT  A.cst_act_id
            ,A.dep_act_id
            ,sum(if(A.crd_and_dbt_ind='C',A.trx_amt,0))  trx_amt_sum_C
            ,sum(if(A.crd_and_dbt_ind='C',1,0))          trx_amt_sum_C_numbers
            ,sum(if(A.crd_and_dbt_ind='D',A.trx_amt,0))  trx_amt_sum_D
            ,sum(if(A.crd_and_dbt_ind='D',1,0))          trx_amt_sum_D_numbers
    FROM  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI  A
    WHERE A.dt>='@@{yyyyMMdd-1y}'
    AND   A.dt<='@@{yyyyMMdd}'
    GROUP BY  A.cst_act_id,A.dep_act_id
)    T30  on T1.cst_act_id=T30.CST_ACT_ID   and   T1.dep_act_id=T30.dep_act_id
LEFT JOIN    (
                 SELECT   B.cst_act_id
                         ,B.dep_act_id
                         ,MAX(trx_amt_sum_day)    AS trx_amt_sum_max        --T21.trx_amt_sum_max
                         ,SUM(dtl_seq_nbr_D_day)  as dtl_seq_nbr_D_days     --T21.dtl_seq_nbr_D_days
                         ,SUM(dtl_seq_nbr_C_day)  as dtl_seq_nbr_C_days     --T21.dtl_seq_nbr_C_days
                 FROM    (
                             SELECT   A.cst_act_id
                                     ,A.dep_act_id
                                     ,A.trx_dt
                                --      ,sum(trx_amt) trx_amt_sum_day
                                     ,sum(case when A.crd_and_dbt_ind = 'D' then trx_amt else 0 end )         as trx_amt_sum_day
                                     ,sum(case when A.crd_and_dbt_ind = 'D' then 1       else 0 end )         as dtl_seq_nbr_D_day
                                     ,sum(case when A.crd_and_dbt_ind = 'C' then 1       else 0 end )         as dtl_seq_nbr_C_day
                             FROM    edw.DWD_BUS_DEP_BAL_CHG_DTL_DI A --存款账户余额发生明细
                             WHERE   A.dt >= '@@{yyyyMMdd-6m}'
                             AND     A.dt <= '@@{yyyyMMdd}'
                        --      AND     A.crd_and_dbt_ind = 'D'
                             AND     A.TRX_CHNL_CD NOT IN ( 'A01' , 'M08' , 'C03' , 'C10' )
                             AND     A.int_trx_no NOT IN ( 'dp2265' , 'dp2101' , 'dp15' )
                             AND     A.txt_code NOT IN ( 'LQSF01' , 'SBKF01' , 'BA0004' , 'FD0001' , 'FD0002' , 'FD0003' , 'FD0004' , 'FD0005' , 'FD0010' , 'FD0011' , 'FD0012' , 'FD0013' , 'FD0014' , 'FD0015' , 'FD0016' , 'FD0017' , 'FD0018' , 'FD0019' , 'LC0009' , 'LN0002' , 'LN0003' , 'LN0004' , 'THKHK1' , 'XE1207' , 'XYKHK1' , 'YL0035' , 'TY0033' )
                             AND     A.smr_dscr NOT REGEXP '代发|代扣'
                             AND     A.bal_fld_nm = 'DPLDGBAL'
                             GROUP BY A.cst_act_id , A.dep_act_id , A.trx_dt
                         ) B
                 GROUP BY B.cst_act_id , B.dep_act_id
             ) T21
ON      T1.cst_act_id = T21.cst_act_id  and   T1.dep_act_id=T21.dep_act_id
LEFT JOIN    (
                 SELECT   B.cst_act_id
                         ,B.dep_act_id
                         ,MAX(trx_amt_sum_day)    AS trx_amt_sum_max        --T21.trx_amt_sum_max
                         ,SUM(dtl_seq_nbr_D_day)  as dtl_seq_nbr_D_days     --T21.dtl_seq_nbr_D_days
                         ,SUM(dtl_seq_nbr_C_day)  as dtl_seq_nbr_C_days     --T21.dtl_seq_nbr_C_days
                 FROM    (
                             SELECT   A.cst_act_id
                                     ,A.dep_act_id
                                     ,A.trx_dt
                                --      ,sum(trx_amt) trx_amt_sum_day
                                     ,sum(case when A.crd_and_dbt_ind = 'D' then trx_amt else 0 end )         as trx_amt_sum_day
                                     ,sum(case when A.crd_and_dbt_ind = 'D' then 1       else 0 end )         as dtl_seq_nbr_D_day
                                     ,sum(case when A.crd_and_dbt_ind = 'C' then 1       else 0 end )         as dtl_seq_nbr_C_day
                             FROM    edw.DWD_BUS_DEP_BAL_CHG_DTL_DI A --存款账户余额发生明细
                             WHERE   A.dt >= '@@{yyyyMMdd-1y}'
                             AND     A.dt <= '@@{yyyyMMdd}'
                        --      AND     A.crd_and_dbt_ind = 'D'
                             AND     A.TRX_CHNL_CD NOT IN ( 'A01' , 'M08' , 'C03' , 'C10' )
                             AND     A.int_trx_no NOT IN ( 'dp2265' , 'dp2101' , 'dp15' )
                             AND     A.txt_code NOT IN ( 'LQSF01' , 'SBKF01' , 'BA0004' , 'FD0001' , 'FD0002' , 'FD0003' , 'FD0004' , 'FD0005' , 'FD0010' , 'FD0011' , 'FD0012' , 'FD0013' , 'FD0014' , 'FD0015' , 'FD0016' , 'FD0017' , 'FD0018' , 'FD0019' , 'LC0009' , 'LN0002' , 'LN0003' , 'LN0004' , 'THKHK1' , 'XE1207' , 'XYKHK1' , 'YL0035' , 'TY0033' )
                             AND     A.smr_dscr NOT REGEXP '代发|代扣'
                             AND     A.bal_fld_nm = 'DPLDGBAL'
                             GROUP BY A.cst_act_id , A.dep_act_id , A.trx_dt
                         ) B
                 GROUP BY B.cst_act_id , B.dep_act_id
             ) T31
ON      T1.cst_act_id = T31.cst_act_id  and   T1.dep_act_id=T31.dep_act_id
left JOIN
    (
    select distinct customerid  as  cst_id
    from edw.loan_business_contract  --信贷合同信息
    where dt='@@{yyyyMMdd}'
    and   (REPLACE(MATURITY, '/', '')>'@@{yyyyMMdd}' or balance>0)
     union
     SELECT sd.cst_id      as  cst_id
     from  edw.dwd_bus_loan_fnc_crd_lmt_inf_dd  as sd
     where sd.dt='@@{yyyyMMdd}'
     and   sd.lmt_sts_cd='0'
    )  T22 on   T1.cst_id=T22.cst_id
left JOIN
 (
      SELECT distinct  cst_act_id
      from  edw.dwd_bus_dep_bal_chg_dtl_di
      where dt>='@@{yyyyMMdd-1y}'
      and   dt<='@@{yyyyMMdd}'
                         ,'TY0164','TY1923','WWB004','WWB005','WWB006','IB0049','TY1924','TY1927','IB0050'
                         ,'TY1925','IB0004','IB0015','IB0016','TS0001','TS0002','SBKF01')
)   T23  on  T1.cst_act_id=T23.cst_act_id
left JOIN
(
    select  distinct cst_id
    from   edw.dim_cst_idv_bas_inf_dd t5
    LEFT JOIN  (
      SELECT empe_id
            ,empe_actv_sts_cd
            ,empe_sts_cd
            ,start_dt
            ,end_dt
            ,ROW_NUMBER() over (partition by empe_id order by end_dt desc)  as  rn
      from  edw.dim_hr_empe_org_inf_dd
      where dt='@@{yyyyMMdd}'
     )  T3  on  t5.own_emp_id=T3.empe_id   and  T3.rn=1   and  T3.empe_sts_cd='3'
    where   t5.dt='@@{yyyyMMdd}'
    and     length(t5.own_emp_id)>0    -- 本行员工号
    AND     T3.empe_id is null
    union
    SELECT DISTINCT   c2.cst_id
    from       edw.dim_hr_empe_invl_pty_inf_dd c1   --员工家庭成员与关联人信息
    inner join edw.dws_cst_bas_inf_dd          c2
      on    c1.invl_pty_id_card_id=c2.doc_nbr  --身份证关联
      and   c2.dt='@@{yyyyMMdd}'
    LEFT JOIN  (
      SELECT empe_id
            ,empe_actv_sts_cd
            ,empe_sts_cd
            ,start_dt
            ,end_dt
            ,ROW_NUMBER() over (partition by empe_id order by end_dt desc)  as  rn
      from  edw.dim_hr_empe_org_inf_dd
      where dt='@@{yyyyMMdd}'
     )  T3  on  c1.empe_id=T3.empe_id   and  T3.rn=1   and  T3.empe_sts_cd='3'
    where   c1.dt='@@{yyyyMMdd}'
    AND     T3.empe_id is null
)  T24  on  T1.cst_id=T24.cst_id
left JOIN   (
        SELECT a1.cst_act_id
		from  (SELECT  *,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
               FROM    edw.dwd_bus_dep_frz_inf_dd    --账户冻结登记
               WHERE   DT = '@@{yyyyMMdd}'
               AND     NFRZ_IND = '0') a1
               where   a1.rn=1
       union
       SELECT c1.cst_act_id
	   from  (   SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
                 FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     ACT_THRS_TYP = '2'      --暂停非柜面
				 and     evt_id='DPDRAW') c1
        where c1.rn=1
        union
        SELECT b1.cst_act_id
	    from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
                 FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     NFRZ_IND = '0') b1
                 where   b1.rn=1
                 )  T25  on  T1.cst_act_id=T25.cst_act_id     --账户额度控制
LEFT JOIN    edw.dwd_code_library_dd D1 --账户分类代码1
ON      T1.act_ctg_cd_1 = D1.cd_val
AND     D1.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     D1.fld_nm = 'ACT_CTG_CD_1'
AND     D1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd D2 --账户分类代码2
ON      T1.act_ctg_cd_2 = D2.cd_val
AND     D2.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     D2.fld_nm = 'ACT_CTG_CD_2'
AND     D2.dt = '@@{yyyyMMdd}'
and      T1.opn_org  like '3309%'
AND      T1.ccy_cd='156'
AND      T1.DT = '@@{yyyyMMdd}'
AND      T1.STL_ACT_IND = '1'  --结算账户
-- and      T15.cst_act_id  is not null
-- and      T15.trx_income_3m_numbers=0
AND      T1.cst_act_id not IN  (
    SELECT DISTINCT  mrgn_act_id
    FROM   edw.dwd_bus_bill_acc_mrgn_inf_dd
    WHERE  dt='@@{yyyyMMdd}'
     )
AND      T1.BAL_GL_IND <> '0'       -- 剔除虚户
AND      T1.CST_ID <> '2000394435'  -- 剔除验资户，该客户是验资户专户
AND      T13.cst_id is null         -- 剔除定期
AND      T14.cst_act_id is null     -- 34714  在我行存在定期、理财有余额的或购买保险的客户名下账户
AND      T22.cst_id is null         -- 随贷通和信贷
AND      T23.cst_act_id is null     -- 公共事业费账户，①缴纳税费②水、电、燃气、通讯费、港务费等公共事业费用的代扣代缴账户③路桥水费、天然气代扣账户
AND      T24.cst_id    is null      -- 员工和员工直系亲属账户（同人力资源系统数据）
AND      T25.cst_act_id is null     -- 剔除已经被止付、冻结、暂停非柜
AND      T1.act_sts_cd='A'          -- -- 剔除账户状态为销户、不动户、营业外收入
AND      D1.cd_val_dscr NOT LIKE '%保证金%' --账户分类代码1
AND      D2.cd_val_dscr NOT LIKE '%保证金%' --账户分类代码2
-- AND      T8.累计限额<=100000
-- AND      T8.累计限额>=0
-- AND      T1.opn_dt<='20231231'
-- AND      T1.opn_dt>='20200101'
AND      T1.last_180_days_gl_bal_acml/180<=20000
;
***SJ2024072576_理财质押行为.sql
-- 主表（客户号去重，原表有重复）
DROP   TABLE IF EXISTS SJXQ_SJ2024072576_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024072576_CST_01
(
    cst_id             string COMMENT '客户号'
)
;
insert into SJXQ_SJ2024072576_CST_01
values
;
-- 客户号     客户名     放款日期   贷款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024072576_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072576_CST_02 AS
SELECT t1.cst_id
    ,t2.ctr_serno               --合同流水号
    ,t2.cst_nm                  --客户名称
    ,t2.ctr_bgn_dt              --合同起始日期
    ,t2.ctr_mtu_dt              --合同到期日期
    ,t2.ctr_amt                 --合同金额
    ,t2.ctr_bal                 --合同余额
    ,t2.tmt_dt                  --终结日期
    ,t2.ctr_eff_dt              --合同生效日期
    ,t2.prcp_setl_dt            --本金结清日期
    ,t2.PCTR_DTRB_DT	        --预约放款日期
    ,t3.LVE_ACT_BGN_DT          --出账起始日期
from SJXQ_SJ2024072576_CST_01               t1
left join EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD   t2 --合同基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join(
    SELECT CTR_SERNO,min(LVE_ACT_BGN_DT) LVE_ACT_BGN_DT --出账起始日期
    from edw.DIM_BUS_LOAN_DBIL_INF_DD
    where dt='@@{yyyyMMdd}'
    group by CTR_SERNO
)t3 on t2.ctr_serno=t3.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072576_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072576_CST_02
***SJ20240729131-任  烨-006443_底表1.sql
-- ODPS SQL
--
-- 功能描述
--
-- 创建者 杨相伟
-- 创建日期 2024-07-30 111727
--
-- 修改日志
-- 修改日期          修改人          修改内容
--
--
-- 分行内部开展&ldquo;非柜面限额分级审批流程&ldquo;合规性检查
-- 排查开户时间在2024年1月-7月，非柜面日累计支付限额100万的个人Ⅰ类户、非柜面日累计支付限额100万的企业账户的非柜面支付限额分级审批情况（调额日期：2024.1.1-2024.7.31）
-- 对公是全量
-- 客户号	客户账号	账户名称	客户名称	开户年份	开户日期	分行机构名称	开户机构号	支行机构名称	总账余额	是否关闭非柜	关闭非柜原因
-- 是否设置非柜限额	非柜单笔限额	非柜日累计限额	近一年非柜面最大日累计支出金额	网银是否签约	网银签约时间	网银单笔限额	网银日累计限额
-- 手机是否签约	手机签约时间	手机单笔限额	手机日累计限额	快捷支付日累计限额	账户过去30天日均余额	是否保密账户
-- 存款管户客户经理	存款管户客户经理名称	管户机构号	管户机构名称	客户是否持有定期2	客户名下是否持有大额存单贷款理财保险基金2	授信金额
-- 年龄	法人代表证件号码前6位	法人代表性别	法定代表人年龄	账户分类1	法人户籍省份	法人户籍城市	注册省份	注册城市	经营省份	经营城市
-- 20231118至20231231期间非柜限额大于等于500万第一次出现的日期	20231118至20231231期间非柜限额大于等于500万第一次出现的非柜额度	提额后日期	提额前日期	提额后额度	提额前额度
-- 币种156是人民币	非柜交易占比	是否本行在职员工	提额经办机构号	提额经办机构名称	提额经办柜员号	维护渠道	受理时间
DROP TABLE IF EXISTS lab_bigdata_dev.qwj_dep_cst_20240521 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.qwj_dep_cst_20240521 as
select
distinct
    '@@{yyyyMMdd}' dt,
    if(cst_tp='1','个人','企业') 客户类型,
    ccy_cd  币种,
    opn_org 开户机构号,
    b.org_nm 开户机构名称,
    b.brc_org_id 分行机构号,
    b.brc_org_nm 分行机构名称,
    b.sbr_org_nm 支行机构名称,
    a.cst_id 客户号,
    a.cst_act_id 客户账号,
    a.dep_act_id 存款账号,
    act_nm 账户名称,
    if(cst_tp='1',rpad(substr(act_nm,1,1),length(act_nm),''),act_nm) 账户名称脱敏,
    opn_dt 开户日期,
    act_opn_tlr 开户柜员,
    gl_bal 总账余额,
    cur_act_bal 当前账户余额,
    last_day_act_bal 上日账户余额,
    bal_late_upd_dt 上次动户日期,
    act_ctg_cd_1 账户分类代码1,
    cd1.cd_val_dscr 账户分类1,
    act_ctg_cd_2 账户分类代码2,
    cd2.cd_val_dscr 账户分类2,
    prod_id 存款产品代码,
    cp.cd_val_dscr 存款产品,
    dep_cls_cd 存款种类代码,
    cd.cd_val_dscr 存款种类,
    opn_chnl_cd 开户渠道代码,
    co.cd_val_dscr 开户渠道,
    CASE
        WHEN a.act_sts_cd = 'A' THEN '正常'
        WHEN a.act_sts_cd = 'B' THEN '不动户'
        WHEN a.act_sts_cd = 'C' THEN '销户'
        WHEN a.act_sts_cd = 'D' THEN '久悬户'
        WHEN a.act_sts_cd = 'E' THEN '封闭冻结'
        WHEN a.act_sts_cd = 'F' THEN '金额冻结'
        WHEN a.act_sts_cd = 'G' THEN '未启用'
        WHEN a.act_sts_cd = 'H' THEN '待启用'
        WHEN a.act_sts_cd = 'I' THEN '转营业外收入'
        WHEN a.act_sts_cd = 'Y' THEN '预销户'
    END AS 账户状态,
    act_mth_acm_balsubstr(a.dt,7,2) 月日均,
    act_year_acm_bal(datediff(to_date(a.dt,'yyyyMMdd'),to_date(concat(substr(a.dt,1,4),'0101'),'yyyyMMdd'),'DD')+1) 年日均,
    last_360_days_gl_bal_acml360 近一年日均,
    a3.mgr_id 存款管户客户经理,
    yg.empe_nm 存款管户客户经理名称,
    a3.acs_org_id 管户机构号,
    b1.org_nm 管户机构名称,
    网银是否签约,
    网银签约时间,
    网银单笔限额,
    网银日累计限额,
    手机是否签约,
    手机签约时间,
    手机单笔限额,
    手机日累计限额,
    if(非柜日累计限额 is not null,'是','') 是否设置非柜限额,
    非柜额度生效日期,
    非柜单笔限额,
    非柜日累计限额,
    是否关闭非柜,
    关闭非柜日期,
    关闭非柜原因,
    是否冻结,
    冻结日期,
    冻结种类,
    冻结原因,
    是否止付,
    止付日期,
    止付类型,
    止付种类,
    止付原因,
    c.cst_chn_nm 客户名称,
    if(cst_tp='1',rpad(substr(c.cst_chn_nm,1,1),length(c.cst_chn_nm),''),c.cst_chn_nm) 客户名称脱敏,
    cc.prm_mgr_id 主管户客户经理,
    cc.prm_mgr_nm 主管户客户经理名称,
    cc.prm_org_id 主管户机构,
    cc.prm_org_nm 主管户机构名称,
    case substr(c.idt_cd,1,1)
        when 'J' then '金融业'
        when 'T' then '国际组织'
        when 'A' then '农、林、牧、渔业'
        when 'E' then '建筑业'
        when 'F' then '批发和零售业'
        when 'K' then '房地产业'
        when 'P' then '教育'
        when 'D' then '电力、热力、燃气及水生产和供应业'
        when 'I' then '信息传输、软件和信息技术服务业'
        when 'G' then '交通运输、仓储和邮政业'
        when 'N' then '水利、环境和公共设施管理业'
        when 'R' then '文化、体育和娱乐业'
        when 'B' then '采矿业'
        when 'S' then '公共管理、社会保障和社会组织'
        when 'Q' then '卫生和社会工作'
        when 'C' then '制造业'
        when 'H' then '住宿和餐饮业'
        when 'L' then '租赁和商务服务业'
        when 'M' then '科学研究和技术服务业'
        when 'O' then '居民服务、修理和其他服务业'
    end 行业,
    c.doc_nbr 证件号码,
    concat(substr(c.doc_nbr,1,6),'',substr(c.doc_nbr,-3)) 证件号脱敏,
    c.doc_typ_cd 证件类型代码,
    c.mbl_nbr 手机号,
    concat(substr(c.mbl_nbr,1,3),'',substr(c.mbl_nbr,-4)) 手机号脱敏,
    reg_adr 户籍地址,
    concat(substr(regexp_replace(reg_adr,'s,',''),1,greatest(length(regexp_replace(reg_adr,'s,',''))-6,0)),'') 户籍地址脱敏,
    cmn_adr 通讯地址,
    concat(substr(regexp_replace(cmn_adr,'s,',''),1,greatest(length(regexp_replace(cmn_adr,'s,',''))-6,0)),'') 通讯地址脱敏,
    wrk_adr 工作地址,
    concat(substr(regexp_replace(wrk_adr,'s,',''),1,greatest(length(regexp_replace(wrk_adr,'s,',''))-6,0)),'') 工作地址脱敏,
    fml_adr 家庭地址,
    concat(substr(regexp_replace(fml_adr,'s,',''),1,greatest(length(regexp_replace(fml_adr,'s,',''))-6,0)),'') 家庭地址脱敏,
    c1.bth_dt 出生日期,
    if(gdr_cd='1','男','女') 性别,
    nvl(c1.fm_ind,c2.fm_ind) 农户标志,
    ind_bus_ind 个体工商户标志,
    mic_entp_own_ind 小微企业主标志,
    cz.cd_val_dscr 职业,
    job_unt_nm 工作单位,
    own_emp_id 本行员工号,
    lgp_cst_id 法人客户号,
    lgp_nm 法人名称,
    lgp_doc_typ_cd 法人证件类型代码,
    lgp_doc_id 法人证件号,
    concat(substr(lgp_doc_id,1,6),'',substr(lgp_doc_id,-3)) 法人证件号脱敏,
    lgp_tel 法人手机号,
    concat(substr(lgp_tel,1,3),'',substr(lgp_tel,-4)) 法人手机号脱敏
from edw.dws_bus_dep_act_inf_dd a
left join edw.dws_cst_bas_inf_dd c on a.cst_id=c.cst_id and c.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd cc on a.cst_id=cc.cst_id and cc.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd c1 on a.cst_id=c1.cst_id and c1.dt='@@{yyyyMMdd}'
left join edw.dim_cst_entp_bas_inf_dd c2 on a.cst_id=c2.cst_id and c2.dt='@@{yyyyMMdd}'
left JOIN edw.dim_cst_entp_lgp_inf_dd fr ON a.cst_id = fr.cst_id AND  fr.DT = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd b on a.opn_org=b.org_id and b.dt='@@{yyyyMMdd}'
LEFT JOIN (
    select ,row_number() over(partition by cst_act_id order by mgr_rto desc) rk
    from edw.dwd_bus_dep_cst_act_mgr_inf_dd A3
    where a3.frs_ctc_ind = '1' AND a3.DT = '@@{yyyyMMdd}' --存款管户
) a3 on a.cst_act_id = a3.cst_act_id and a3.rk=1
left join edw.dws_hr_empe_inf_dd yg on a3.mgr_id=yg.empe_id and yg.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd b1 on a3.acs_org_id=b1.org_id and b1.dt='@@{yyyyMMdd}'
left join (
    -- 非柜面限额&amp;暂停非柜
    select
        cst_act_id,
        max(if(evt_id='FGMXIANE' and lmt_ctrl_prd='1D',sng_tm_trx_lmt,null)) 非柜单笔限额,
        max(if(evt_id='FGMXIANE' and lmt_ctrl_prd='1D',acm_trx_lmt,null))    非柜日累计限额,
        max(if(evt_id='FGMXIANE' and lmt_ctrl_prd='1D',lmt_eft_dt,null))     非柜额度生效日期,
        max(if(evt_id='DPDRAW','是',''))     是否关闭非柜,
        min(if(evt_id='DPDRAW',lmt_eft_dt,null)) 关闭非柜日期,
    from edw.dwd_bus_dep_act_lmt_inf_dd -- 账户额度控制
    where dt = '@@{yyyyMMdd}'
    and   ACT_THRS_TYP='2' -- and evt_id='FGMXIANE' -- 非柜面限额
        -- and lmt_ctrl_prd='1D' -- 日限额
    group by cst_act_id
) fg on a.cst_act_id=fg.cst_act_id
left join (
    select
        distinct
        a.dep_act_id,
        a.cst_id,
        网银是否签约,
        网银签约时间,
        if(网银是否签约='是',网银单笔限额,null)   网银单笔限额,
        if(网银是否签约='是',网银日累计限额,null) 网银日累计限额,
        手机是否签约,
        手机签约时间,
        if(手机是否签约='是',手机单笔限额,null)   手机单笔限额,
        if(手机是否签约='是',手机日累计限额,null) 手机日累计限额
    from edw.dws_bus_dep_act_inf_dd a
    left join edw.dim_hr_org_mng_org_tree_dd b on a.opn_org=b.org_id and b.dt='@@{yyyyMMdd}'
    left join (
        -- 个人手机银行
        select
            a.cst_id,
            case a.lgp_id
                when '020200' then '浙江泰隆商业银行'
                when '020201' then '浙江庆元泰隆村镇银行'
                when '020202' then '湖北大冶泰隆村镇银行'
                when '020203' then '福建政和泰隆村镇银行'
                when '020204' then '福建长乐泰隆村镇银行'
                when '020205' then '福建龙海泰隆村镇银行'
                when '020206' then '福建福清泰隆村镇银行'
                when '020207' then '广东英德泰隆村镇银行'
                when '020208' then '广东四会泰隆村镇银行'
                when '020209' then '陕西旬阳泰隆村镇银行'
                when '020210' then '陕西眉县泰隆村镇银行'
                when '020211' then '陕西泾阳泰隆村镇银行'
                when '020212' then '河南汝南泰隆村镇银行'
                when '020213' then '河南叶县泰隆村镇银行'
            end 法人机构,
            chnl_opn_tm 客户手机开通时间,
            case
                when mbl_cst_apnt_sng_thrs0 and nvl(is_uk,'0')='0' then least(mbl_cst_apnt_sng_thrs,c.pos_singlemax) -- 设置了约定限额,但没有UK，取约定和标准的较小值
                when mbl_cst_apnt_sng_thrs0  then mbl_cst_apnt_sng_thrs -- 设置了约定限额
                else c.pos_singlemax
            end as 手机单笔限额,
            case
                when mbl_cst_apnt_day_acm_thrs0 and nvl(is_uk,'0')='0' then least(mbl_cst_apnt_day_acm_thrs,c.pos_singledaymax) -- 设置了约定限额,但没有UK，取约定和标准的较小值
                when mbl_cst_apnt_day_acm_thrs0 then mbl_cst_apnt_day_acm_thrs -- 设置了约定限额
                else c.pos_singledaymax
            end as 手机日累计限额
        from edw.dim_bus_chnl_elec_idv_inf_dd a
        left join (
            select
                a.cif_cstno cst_id,
                a.cif_bankid lgp_id,
                case
                    when substr(a.cif_catype,1,1)='1' and b.cip_cliptype is not null then '10'
                    when c.cti_keytype='EnterSafe ePass3003A CSP For TLBank V3.0' then '10'
                    when substr(a.cif_catype,2,1)='1' then '11'
                    else d.pcc_defaulttype
                end as chnl_atst_mth, -- 最高认证方式
                substr(a.cif_catype,1,1) is_uk
            from edw.ebnk_pb_cstinf a
            left join edw.ebnk_pb_cstinf_main b on a.cif_cstno=b.cip_cstno and a.cif_bankid=b.cip_bankid and b.dt='@@{yyyyMMdd}'
            left join (
                select cti_cstno,cti_bankid,cti_keytype,row_number() over(partition by cti_cstno,cti_bankid order by cti_signdate desc) rk
                from edw.ebnk_pb_cert_inf
                where dt='@@{yyyyMMdd}'
            ) c on a.cif_cstno=c.cti_cstno and a.cif_bankid=c.cti_bankid and c.rk=1 -- 取最新的
            left join edw.ebnk_pb_cstinf_channel d on a.cif_cstno=d.pcc_cstno and a.cif_bankid=d.pcc_bankid and d.pcc_channel='2' and d.dt='@@{yyyyMMdd}'
            where a.dt='@@{yyyyMMdd}'
        ) b on a.cst_id = b.cst_id and a.lgp_id=b.lgp_id
        left join edw.ebnk_pub_out_limit c on a.lgp_id=c.pos_bankid and a.opn_chnl_cd=c.pos_channel and b.chnl_atst_mth=c.pos_catype and c.dt='@@{yyyyMMdd}'
        where a.dt='@@{yyyyMMdd}'
            and a.opn_chnl_cd='2' -- 0 网银 1 微信 2 手机
        union all
        -- 企业手机银行
        select
            cst_id,
            case a.lgp_id
                when '020200' then '浙江泰隆商业银行'
                when '020201' then '浙江庆元泰隆村镇银行'
                when '020202' then '湖北大冶泰隆村镇银行'
                when '020203' then '福建政和泰隆村镇银行'
                when '020204' then '福建长乐泰隆村镇银行'
                when '020205' then '福建龙海泰隆村镇银行'
                when '020206' then '福建福清泰隆村镇银行'
                when '020207' then '广东英德泰隆村镇银行'
                when '020208' then '广东四会泰隆村镇银行'
                when '020209' then '陕西旬阳泰隆村镇银行'
                when '020210' then '陕西眉县泰隆村镇银行'
                when '020211' then '陕西泾阳泰隆村镇银行'
                when '020212' then '河南汝南泰隆村镇银行'
                when '020213' then '河南叶县泰隆村镇银行'
            end 法人机构,
            chnl_opn_tm 客户手机开通时间,
            case
                when ext_trsf_sng_thrs0 then ext_trsf_sng_thrs
                else entp_mbl_bnk_rcm_sng_thrs
            end 手机单笔限额,
            case
                when ext_trsf_day_acm_thrs0 then ext_trsf_day_acm_thrs
                else entp_mbl_bnk_rcm_day_acm_thrs
            end 手机日累计限额
        from  edw.dim_bus_chnl_elec_entp_inf_dd a
        where dt='@@{yyyyMMdd}'
            and a.opn_chnl_cd = '4' -- 0 网上银行 4 手机银行
    ) sj on a.cst_id=sj.cst_id and if(brc_org_nm regexp '村镇银行',brc_org_nm,'浙江泰隆商业银行')=sj.法人机构
    left join (
        -- 个人网银
        select
            a.cst_id,
            case a.lgp_id
                when '020200' then '浙江泰隆商业银行'
                when '020201' then '浙江庆元泰隆村镇银行'
                when '020202' then '湖北大冶泰隆村镇银行'
                when '020203' then '福建政和泰隆村镇银行'
                when '020204' then '福建长乐泰隆村镇银行'
                when '020205' then '福建龙海泰隆村镇银行'
                when '020206' then '福建福清泰隆村镇银行'
                when '020207' then '广东英德泰隆村镇银行'
                when '020208' then '广东四会泰隆村镇银行'
                when '020209' then '陕西旬阳泰隆村镇银行'
                when '020210' then '陕西眉县泰隆村镇银行'
                when '020211' then '陕西泾阳泰隆村镇银行'
                when '020212' then '河南汝南泰隆村镇银行'
                when '020213' then '河南叶县泰隆村镇银行'
            end 法人机构,
            chnl_opn_tm 客户网银开通时间,
            case
                when ext_trsf_sng_thrs0 and nvl(is_uk,'0')='0' then least(ext_trsf_sng_thrs,c.pos_singlemax) -- 设置了约定限额,但没有UK，取约定和标准的较小值
                when ext_trsf_sng_thrs0  then ext_trsf_sng_thrs -- 设置了约定限额
                when b.chnl_atst_mth='10' then double(d.apr_showmsg)
                else c.pos_singlemax
            end as 网银单笔限额,
            case
                when ext_trsf_day_acm_thrs0 and nvl(is_uk,'0')='0' then least(ext_trsf_day_acm_thrs,c.pos_singledaymax) -- 设置了约定限额,但没有UK，取约定和标准的较小值
                when ext_trsf_day_acm_thrs0 then ext_trsf_day_acm_thrs -- 设置了约定限额
                when b.chnl_atst_mth='10' then double(d1.apr_showmsg)
                else c.pos_singledaymax
            end as 网银日累计限额
        from  edw.dim_bus_chnl_elec_idv_inf_dd a
        left join (
            select
                a.cif_cstno cst_id,
                a.cif_bankid lgp_id,
                case
                    when substr(a.cif_catype,1,1)='1' then '10'
                    when substr(a.cif_catype,2,1)='1' then '11'
                    else d.pcc_defaulttype
                end as chnl_atst_mth, -- 最高认证方式
                substr(a.cif_catype,1,1) is_uk
            from edw.ebnk_pb_cstinf a
            left join edw.ebnk_pb_cstinf_channel d on a.cif_cstno=d.pcc_cstno and a.cif_bankid=d.pcc_bankid and d.pcc_channel='0' and d.dt='@@{yyyyMMdd}'
            where a.dt='@@{yyyyMMdd}'
        ) b on a.cst_id = b.cst_id and a.lgp_id=b.lgp_id
        left join edw.ebnk_pub_out_limit c on a.lgp_id=c.pos_bankid and a.opn_chnl_cd=c.pos_channel and b.chnl_atst_mth=c.pos_catype and c.dt='@@{yyyyMMdd}'
        left join edw.ebnk_pub_apppar d on a.lgp_id=d.apr_bankid and d.apr_code='PBUK_RECOMMEND_SINGLE_LIMIT' and d.apr_value='10' and d.dt='@@{yyyyMMdd}'
        left join edw.ebnk_pub_apppar d1 on a.lgp_id=d1.apr_bankid and d1.apr_code='PBUK_RECOMMEND_DAY_LIMIT' and d1.apr_value='10' and d1.dt='@@{yyyyMMdd}'
        where a.dt='@@{yyyyMMdd}'
            and a.opn_chnl_cd ='0' -- 0 网银 1 微信 2 手机
        union all
        -- 企业网银
        select
            cst_id,
            case a.lgp_id
                when '020200' then '浙江泰隆商业银行'
                when '020201' then '浙江庆元泰隆村镇银行'
                when '020202' then '湖北大冶泰隆村镇银行'
                when '020203' then '福建政和泰隆村镇银行'
                when '020204' then '福建长乐泰隆村镇银行'
                when '020205' then '福建龙海泰隆村镇银行'
                when '020206' then '福建福清泰隆村镇银行'
                when '020207' then '广东英德泰隆村镇银行'
                when '020208' then '广东四会泰隆村镇银行'
                when '020209' then '陕西旬阳泰隆村镇银行'
                when '020210' then '陕西眉县泰隆村镇银行'
                when '020211' then '陕西泾阳泰隆村镇银行'
                when '020212' then '河南汝南泰隆村镇银行'
                when '020213' then '河南叶县泰隆村镇银行'
            end 法人机构,
            chnl_opn_tm 客户网银开通时间,
            case
                when ext_trsf_sng_thrs0 then ext_trsf_sng_thrs
                else entp_nb_rcm_sng_thrs
            end 网银单笔限额,
            case
                when ext_trsf_day_acm_thrs0 then ext_trsf_day_acm_thrs
                else entp_nb_rcm_day_acm_thrs
            end 网银日累计限额
        from  edw.dim_bus_chnl_elec_entp_inf_dd a
        where dt='@@{yyyyMMdd}'
            and a.opn_chnl_cd = '0' -- 0 网上银行 4 手机银行
    ) wy on a.cst_id=wy.cst_id and if(brc_org_nm regexp '村镇银行',brc_org_nm,'浙江泰隆商业银行')=wy.法人机构
    left join (
        select
            aif_cstno cst_id,
            aif_accno cst_act_id,
            max(if(aif_channel='0','是',''))          网银是否签约,
            min(if(aif_channel='0',aif_regtime,null)) 网银签约时间,
            max(if(aif_channel='1','是',''))          手机是否签约,
            min(if(aif_channel='1',aif_regtime,null)) 手机签约时间
        from edw.ebnk_pb_accinf --个人客户注册账户表
        where dt = '@@{yyyyMMdd}'
        group by aif_cstno,aif_accno
        union all
        select
            aif_cstno cst_id,
            aif_accno cst_act_id,
            max(if(aif_channel='0','是',''))          网银是否签约,
            min(if(aif_channel='0',aif_regtime,null)) 网银签约时间,
            max(if(aif_channel='4','是',''))          手机是否签约,
            min(if(aif_channel='4',aif_regtime,null)) 手机签约时间
        from edw.ebnk_cb_acc_inf -- 企业账户信息表
        where dt = '@@{yyyyMMdd}'
        group by aif_cstno,aif_accno
    ) qy on a.cst_act_id=qy.cst_act_id and a.cst_id=qy.cst_id
    where a.dt = '@@{yyyyMMdd}'
        -- and a.ccy_cd='156'
        -- and a.stl_act_ind='1' and a.lbl_prod_typ_cd='0'  --活期结算
        -- and a.BAL_GL_IND  '0' --剔除虚拟户
        -- and a.act_sts_cd  'C'
) wy on a.dep_act_id=wy.dep_act_id
left join (
    SELECT
        CST_ACT_ID, -- 冻结
        max(if(FRZ_SRC_CD='1','是',''))  as 是否冻结,
        max(if(FRZ_SRC_CD='2','是',''))  as 是否止付,
        min(if(FRZ_SRC_CD='1',frz_dt,null)) 冻结日期,
        min(if(FRZ_SRC_CD='2',frz_dt,null)) 止付日期,
    FROM    edw.dwd_bus_dep_frz_inf_dd a --账户冻结登记
    WHERE   DT = '@@{yyyyMMdd}'
    AND     FRZ_SRC_CD IN ( '1' , '2' ) --冻结来源 1冻结 2止付
    AND     NFRZ_IND = '0'  --未解冻
    GROUP BY CST_ACT_ID
) dj on a.cst_act_id=dj.cst_act_id
where a.dt='@@{yyyyMMdd}'
    -- and a.cst_tp='1'
    and a.ccy_cd='156'
    and a.stl_act_ind='1'      --结算
    and a.lbl_prod_typ_cd='0'  --活期
    and a.BAL_GL_IND  '0'    --剔除虚拟户
    and a.act_sts_cd  'C';***SJ20240729131-任  烨-006443_底表2.sql
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qwj_0720_all_20240521 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qwj_0720_all_20240521 AS
select
    客户类型,
    分行机构名称,
    开户机构号,
    开户机构名称,
    支行机构名称,
    客户号,
    证件类型代码,
    客户名称脱敏  客户名称,
    -- 证件号码,
    -- doc_mtu_dt 证件到期日期,
    户籍地址,
    户籍地址脱敏,
    -- 通讯地址脱敏,
    手机号,
    手机号脱敏,
    工作地址,
    工作地址脱敏,
    开户日期,
    账户分类1,
    账户分类代码1,
    账户分类2,
    账户分类代码2,
    a.客户账号,
    证件号码,
    币种,
    账户名称,
    账户状态,
    总账余额,
    -- 上次动户日期,
    网银是否签约,
    网银签约时间,
    网银单笔限额,
    cast(if(网银日累计限额 is null,'-1',网银日累计限额) as double )   as 网银日累计限额,   --  cast(系统批量变更金额 as double )
    手机是否签约,
    手机签约时间,
    手机单笔限额,
    cast(if(手机日累计限额 is null,'-1',手机日累计限额) as double )  as 手机日累计限额,
    是否设置非柜限额,
    非柜额度生效日期,
    非柜单笔限额,
    cast(if(非柜日累计限额 is null,'-1',非柜日累计限额) as double )   as 非柜日累计限额,
    是否关闭非柜,
    关闭非柜原因,
    是否冻结,
    冻结日期,
    冻结种类,
    冻结原因,
    是否止付,
    -- 止付日期,
    -- 止付类型,
    -- 止付种类,
    -- 止付原因,
    存款管户客户经理,
    存款管户客户经理名称,
    管户机构号,
    管户机构名称,
    职业,
    出生日期,
    性别,
    本行员工号,
    if(nvl(本行员工号,'')='','否','是')   是否本行员工,
    if(T7.cst_id is not null,'是','否')  是否本行在职员工,
    if(T8.cst_id is not null,'是','否')  是否本行在职员工亲属,
    cast(if(快捷支付日累计限额 is null,'-1',快捷支付日累计限额) as double )    as 快捷支付日累计限额  ,
    cast(if(最大日累计转出 is null,'-1',最大日累计转出) as double )          as              额度最大日累计转出,
    cast(if(最大日累计转出不含随贷通 is null,'-1',最大日累计转出不含随贷通) as double )      as   流水最大日累计转出,
    -- cast(if(nvl(是否设置非柜限额,'')<>'是',最大日累计转出不含随贷通,c2.TRX_AMT_DAY_MAX) as double )   as   非柜流水最大日累计转出,
    CASE WHEN  nvl(是否设置非柜限额,'')<>'是'  THEN   最大日累计转出不含随贷通
          WHEN  nvl(是否设置非柜限额,'')='是'   AND    非柜额度生效日期>='20230601' THEN  最大日累计转出不含随贷通
          WHEN  nvl(是否设置非柜限额,'')='是'   AND    非柜额度生效日期<'20230601'  THEN  c2.TRX_AMT_DAY_MAX
          END   AS  非柜流水最大日累计转出,
    最大日累计转出不含随贷通,
    c2.TRX_AMT_DAY_MAX,
    if(baomibzz='1','是','否')     是否保密账户,
    if(bind_lmt is null,'否','是') 是否随贷通账户或签约随贷通功能,
    bind_lmt          随贷通绑定额度,
    nvl(dq.定期余额,-1)   定期余额,
     if(cy.cst_act_id is null,'否','是')     是否持有大额存单贷款理财保险基金
    ,if(T1.cst_act_id is null,'否','是')     是否持有大额存单
    ,cast(if(T1.zhhuyuee is null,'-1',T1.zhhuyuee) as double )             大额存单余额
    ,if(T2.cst_act_id is null,'否','是')                  是否持有理财
    ,cast(if(T2.fnc_amt_sum is null,'-1',T2.fnc_amt_sum) as double )       当前理财金额
    ,cast(if(T6.ZHB_trx_amt_sum is null,'0',T6.ZHB_trx_amt_sum) as double )       当前组合宝理财金额
    ,cast(if(T2.fnc_amt_sum is null,'-1',T2.fnc_amt_sum) as double )+ cast(if(T6.ZHB_trx_amt_sum is null,'0',T6.ZHB_trx_amt_sum) as double)  当前理财金额汇总
    ,if(T3.cst_act_id is null,'否','是')                  是否持有保险
    ,cast(if(T3.insure_fee_sum is null,'-1',T3.insure_fee_sum)as double )    当前保费金额
    ,if(T4.cst_act_id is null,'否','是')                     是否有贷款
    ,cast(if(T4.balance_sum is null,'-1',T4.balance_sum) as double )         当前贷款余额
    ,cast(if(T5.last_30_days_gl_bal_acml_avg is null,'-1',T5.last_30_days_gl_bal_acml_avg) as double ) as 账户过去30天日均余额
    -- ,T25.is_hld_tm_dep    客户是否持有定期
    -- ,T25.is_hld_advs_dep  客户是否持有通知存款    --是否持有大额存单贷款理财保险基金
    -- ,T25.is_hld_lrg_dep   客户是否持有大额存单
    -- ,T25.is_hld_chm	     客户是否持有理财
    -- ,T25.is_hld_fnd       客户是否持有基金
    -- ,T25.is_hld_insu_pd   客户是否持有保险
    -- ,T25.is_hld_com_loan  客户是否持有一般贷款
    -- ,T25.is_hld_trd       客户是否持有贸易融资贷款
    ,if(T26.cst_id IS NOT NULL,'1','') 客户是否持有贷款
    ,T26.ctr_amt_sum    客户名下当前未到期的信贷授信金额
    ,if(T27.cst_id IS NOT NULL,'1','') 客户是否持有定期2
    ,T27.定期余额   客户名下持有定期余额
--     ,CASE WHEN T25.is_hld_lrg_dep='1' or T26.cst_id IS NOT NULL or  T25.is_hld_chm='1' or T25.is_hld_insu_pd='1' or T25.is_hld_fnd='1' then '是' else '否' end  as   客户名下是否持有大额存单贷款理财保险基金2
    ,CASE WHEN  T25.cst_id IS NOT NULL  then '是' else '否' end  as   客户名下是否持有大额存单贷款理财保险基金2
    ,法人证件号
    ,法人客户号
    -- ,账户分类1
from lab_bigdata_dev.qwj_dep_cst_20240521 a
left join edw.core_kdpa_kehuzh   bm on a.客户账号=bm.kehuzhao and bm.dt = '@@{yyyyMMdd}'
left join (
    select act_id,max(day_lmt_amt) 快捷支付日累计限额
    from edw.dwd_bus_chnl_epc_pay_agr_inf_dd -- 快捷支付
    WHERE dt = '@@{yyyyMMdd}'
    group by act_id
) b on a.客户账号=b.act_id
left join (
    select
    cengcgjz,
    max(交易金额) 最大日累计转出
    from (
        SELECT cengcgjz,
            b.jiaoyirq 日期,
            sum(jiaoyije) 交易金额
        FROM  edw.core_kdpl_zhedmx b
        group by cengcgjz,
            b.jiaoyirq
    ) a
    group by cengcgjz
) c on a.客户账号=cengcgjz
left join (
    select
        cst_act_id,dep_act_id,max(日累计转出)   最大日累计转出不含随贷通
    from (
        select
            cst_act_id,dep_act_id,dt,sum(trx_amt) 日累计转出
        from edw.dwd_bus_dep_bal_chg_dtl_di
        where dt>'@@{yyyyMMdd -1y}'
            and crd_and_dbt_ind='D'
            and smr_dscr NOT regexp '代发|代扣'
            and bal_fld_nm='DPLDGBAL'
        group by cst_act_id,dep_act_id,dt
    )a
    group by cst_act_id,dep_act_id
) c1 on a.客户账号=c1.cst_act_id and a.存款账号=c1.dep_act_id
left join (
                        SELECT  T1.CST_ACT_ID
						       ,MAX(T1.TRX_AMT_DAY)  as TRX_AMT_DAY_MAX
                        FROM (
							  SELECT   A.DT
                                      ,A.LVL_KEY_ID AS CST_ACT_ID --客户账户
                                      ,SUM(A.LMT_DAY_USE_AMT) AS TRX_AMT_DAY --交易金额
                              FROM    edw.DWD_BUS_DEP_ACT_LMT_DAY_USE_DTL_DI A -- 存款账户额度日使用明细
                              LEFT JOIN    edw.DWD_BUS_DEP_ACT_LMT_DEF_DTL_DD B --负债账户额度定义明细 该表存在手工插入数据，额度控制周期为空的情况，需要DWD_BUS_DEP_ACT_LMT_INF_DD来补
                              ON      A.LMT_ID = B.LMT_ID
                              AND     A.LGP_ID = B.LGP_ID
                              AND     B.DT = '@@{yyyyMMdd}'
                              AND     B.LMT_CTRL_PRD = '1D' --额度控制周期
                              LEFT JOIN edw.DWD_BUS_DEP_ACT_LMT_INF_DD C --账户额度控制
                              ON      C.DT = '@@{yyyyMMdd}'
                              AND     A.LMT_ID = C.LMT_ID
                              AND     A.LGP_ID = C.LGP_ID
                              AND     C.LMT_CTRL_PRD = '1D' --额度控制周期
                              WHERE   A.EVT_ID = 'FGMXIANE' --事件为非柜面限额
                              AND     A.DT <= '@@{yyyyMMdd}'
                              AND     A.DT >= '@@{yyyyMMdd-360d}'
                              AND    (B.LMT_CTRL_PRD IS NOT NULL OR C.LMT_CTRL_PRD IS NOT NULL) --筛选额度控制周期为1d的
                              GROUP BY A.DT,A.LVL_KEY_ID
						) T1 GROUP BY CST_ACT_ID
)  c2 on a.客户账号=c2.cst_act_id
left join edw.dwd_bus_loan_fnc_crd_lmt_inf_dd sd on a.客户账号=sd.cst_act_id and sd.dt='@@{yyyyMMdd}' and sd.lmt_sts_cd='0'
left join (
    select
         cst_act_id
        ,sum(gl_bal)  定期余额
    from edw.dws_bus_dep_act_inf_dd
    where dt='@@{yyyyMMdd}'
    and  lbl_prod_typ_cd='1'
    group by cst_act_id
    HAVING sum(gl_bal)>0
) dq on a.客户账号=dq.cst_act_id
left join (
    -- 大额存单
    SELECT  distinct kehuzhao  as cst_act_id
    FROM edw.core_kdpb_decdsj --大额存单
    WHERE   DT = '@@{yyyyMMdd}'
    and zhhuyuee>0 -- 当前账户余额
    union
    --理财自营存在余额的账号
    select  bnk_act_id  as cst_act_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and TA_CD='TL' group by bnk_act_id having sum(LOT_TOT_NBR)>0
    union
    ----基金存在余额的账号
    select  bnk_act_id as cst_act_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and PD_CD  IN (select prd_code from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='0')  group by bnk_act_id having sum(LOT_TOT_NBR)>0
    union
    ---理财代销存在余额的账号
    select  bnk_act_id as cst_act_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and PD_CD in (select prd_code  from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='1'  and substr(control_flag,75,1)='1')  group by bnk_act_id having sum(LOT_TOT_NBR)>0
    union
    select  A.trx_act_id  as  cst_act_id
    from   edw.dim_bus_insu_plcy_bas_inf_dd A
    WHERE  A.dt='@@{yyyyMMdd}'
    --保险 保单状态（正常 已质押 ）
    -- SELECT distinct bank_acc  as cst_act_id
    -- FROM edw.finc_tbshareinsure t3, edw.finc_tbclient t1, edw.finc_tbclientseller t2
    -- WHERE t1.dt='@@{yyyyMMdd}' and t2.dt='@@{yyyyMMdd}' and t3.dt='@@{yyyyMMdd}'
    -- and t1.in_client_no = t2.finc_tbclientseller
    -- AND t2.client_no=t3.client_no
    union
    ---未结清的贷款的还款账户
    select
        distinct PAYBACKACCOUNT  cst_act_id
    from edw.loan_business_duebill where dt='@@{yyyyMMdd}'
    and  duebillstatus='0'
) cy on a.客户账号=cy.cst_act_id
left join
(
    -- 大额存单
    SELECT  distinct  kehuzhao  as cst_act_id
                     ,zhhuyuee
    FROM edw.core_kdpb_decdsj --大额存单
    WHERE   DT = '@@{yyyyMMdd}'
    and   zhhuyuee>0 -- 当前账户余额
)   T1  on  a.客户账号=T1.cst_act_id
left join
(
    select   bnk_act_id   as  cst_act_id
            ,sum(fnc_amt) as  fnc_amt_sum
    from  edw.dws_bus_chm_act_acm_inf_dd
    where DT = '@@{yyyyMMdd}'
    -- and   sum(fnc_amt)>0
    -- and   TA_CD='TL'
    group by bnk_act_id
    having  sum(fnc_amt)>0
)   T2  on  a.客户账号=T2.cst_act_id
left join
(
    --保险 保单状态（正常 已质押 ）
      select  A.trx_act_id     as cst_act_id
             ,SUM(A.insu_fee)  as insure_fee_sum
      from   edw.dim_bus_insu_plcy_bas_inf_dd A
      WHERE  A.dt='@@{yyyyMMdd}'
      GROUP BY  A.trx_act_id
)   T3  on  a.客户账号=T3.cst_act_id
left join
(
    ---未结清的贷款的还款账户
    select   PAYBACKACCOUNT as  cst_act_id
            ,SUM(balance)   as  balance_sum
    from   edw.loan_business_duebill where dt='@@{yyyyMMdd}'
    and    duebillstatus='0'
    GROUP BY PAYBACKACCOUNT
)   T4  on  a.客户账号=T4.cst_act_id
left JOIN
(
    SELECT  a.cst_act_id
           ,sum(a.gl_bal)
           ,sum(a.last_30_days_gl_bal_acml)/30    as  last_30_days_gl_bal_acml_avg
           ,sum(a.last_180_days_gl_bal_acml)/180  as  last_180_days_gl_bal_acml_avg
           ,sum(a.last_360_days_gl_bal_acml)/360  as  last_360_days_gl_bal_acml_avg
    from  edw.dws_bus_dep_act_inf_dd   a
    WHERE  a.dt='@@{yyyyMMdd}'
    -- and   lbl_prod_typ_cd='0'
    group by cst_act_id
) T5  on   a.客户账号=T5.cst_act_id
left JOIN
(
    SELECT   A.cst_act_id
            ,sum(T1.trx_amt)    as  ZHB_trx_amt_sum   -- T6.ZHB_trx_amt_sum
    from  edw.DIM_BUS_DEP_ACT_INF_DD              A
    left  JOIN  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI   T1     on   A.cst_act_id=T1.cst_act_id   and   A.dep_act_id=T1.dep_act_id  and   T1.dt>='20230425'
    where A.dt='@@{yyyyMMdd}'
    AND   T1.crd_and_dbt_ind='D'
    AND   T1.txt_code='ZHB001'
    GROUP BY  A.cst_act_id
)   T6  on   a.客户账号=T6.cst_act_id
left JOIN (
        SELECT  distinct A1.cst_id
        FROM    edw.dim_cst_idv_bas_inf_dd A1
        LEFT JOIN  (
           SELECT empe_id
            ,empe_actv_sts_cd
            ,empe_sts_cd
            ,start_dt
            ,end_dt
            ,ROW_NUMBER() over (partition by empe_id order by end_dt desc)  as  rn
          from  edw.dim_hr_empe_org_inf_dd
          where dt='@@{yyyyMMdd}'
               )  A2  on  A1.own_emp_id=A2.empe_id   and  A2.rn=1   and  A2.empe_sts_cd='3'
        where  A1.dt='@@{yyyyMMdd}'
        AND    length(A1.own_emp_id)>0    -- 本行员工号
        AND    A2.empe_id is null
)   T7 on  a.客户号=T7.cst_id
left JOIN (
    SELECT  distinct  A4.cst_id  AS  cst_id
    FROM    edw.dim_cst_idv_bas_inf_dd A1
    LEFT JOIN  (
      SELECT empe_id
            ,empe_actv_sts_cd
            ,empe_sts_cd
            ,start_dt
            ,end_dt
            ,ROW_NUMBER() over (partition by empe_id order by end_dt desc)  as  rn
      from  edw.dim_hr_empe_org_inf_dd
      where dt='@@{yyyyMMdd}'
              )  A2  on  A1.own_emp_id=A2.empe_id   and  A2.rn=1   and  A2.empe_sts_cd='3'
    LEFT JOIN  edw.dim_hr_empe_invl_pty_inf_dd   A3
       ON   A1.own_emp_id=A3.empe_id
       AND  A3.dt='@@{yyyyMMdd}'
    left JOIN  edw.dws_cst_idv_bas_inf_dd        A4
       ON    A3.invl_pty_id_card_id=A4.doc_nbr
       AND   A4.dt='@@{yyyyMMdd}'
    where  A1.dt='@@{yyyyMMdd}'
    AND    length(A1.own_emp_id)>0    -- 本行员工号
    AND    A2.empe_id   is null
    AND    A4.doc_nbr  is not null
)   T8 on  a.客户号=T8.cst_id
-- left JOIN  adm_pub.adm_csm_cbus_pd_hld_inf_dd  T25  on  a.客户号=T25.cst_id  and   T25.dt='@@{yyyyMMdd}'
left join (
    -- 大额存单
    SELECT  distinct kehuhaoo  as  cst_id
    FROM edw.core_kdpb_decdsj --大额存单
    WHERE   DT = '@@{yyyyMMdd}'
    and     zhhuyuee>0 -- 当前账户余额
    union
    --理财自营存在余额的账号
    select   bnk_cst_id  as cst_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and TA_CD='TL' group by bnk_cst_id having sum(LOT_TOT_NBR)>0
    union
    ----基金存在余额的账号
    select  bnk_cst_id  as cst_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and PD_CD  IN (select prd_code from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='0')  group by bnk_cst_id having sum(LOT_TOT_NBR)>0
    union
    ---理财代销存在余额的账号
    select  bnk_cst_id  as cst_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and PD_CD in (select prd_code  from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='1'  and substr(control_flag,75,1)='1')  group by bnk_cst_id having sum(LOT_TOT_NBR)>0
    union
    --保险 保单状态（正常 已质押 ）
      select  A.cst_id
      from   edw.dim_bus_insu_plcy_bas_inf_dd A
      WHERE  A.dt='@@{yyyyMMdd}'
    -- SELECT distinct t3.client_no  as cst_id
    -- FROM edw.finc_tbshareinsure t3, edw.finc_tbclient t1, edw.finc_tbclientseller t2
    -- WHERE t1.dt='@@{yyyyMMdd}' and t2.dt='@@{yyyyMMdd}' and t3.dt='@@{yyyyMMdd}'
    -- and t1.in_client_no = t2.in_client_no
    -- AND t2.client_no=t3.client_no
    union
    ---未结清的贷款的还款账户
    select distinct customerid  as  cst_id
    from edw.loan_business_duebill where dt='@@{yyyyMMdd}'
    and  duebillstatus='0'
)  T25  on  a.客户号=T25.cst_id
left JOIN  (
            select  cst_id
                   ,sum(crd_tot_lmt) crd_tot_lmt_sum
                   ,SUM(ctr_amt)     ctr_amt_sum
           from   edw.dim_bus_loan_ctr_inf_dd
           WHERE  dt='@@{yyyyMMdd}'
           AND    apnt_mtu_dt>'@@{yyyyMMdd}'
        --    AND  cst_id='1711781419'
           GROUP BY  cst_id
           ) T26  on  a.客户号=T26.cst_id
left join (
    select
         cst_id
        ,sum(gl_bal)  定期余额
    from edw.dws_bus_dep_act_inf_dd
    where dt='@@{yyyyMMdd}'
    and  lbl_prod_typ_cd='1'
    group by cst_id
    HAVING sum(gl_bal)>0
) T27 on a.客户号=T27.cst_id
-- where 客户类型='个人' and 账户分类代码2='301'
-- -- and 账户状态='正常' and nvl(是否冻结,'')<>'是' and nvl(是否止付,'')<>'是' and nvl(是否关闭非柜,'')<>'是'
-- and 账户分类1 not regexp '支票户'
;
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qwj_0720_gr purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qwj_0720_gr AS
select * from lab_bigdata_dev.tmp_qwj_0720_all_20240521
where 客户类型='个人'
and   账户分类代码2='301'
and   账户状态='正常'
-- and nvl(是否冻结,'')<>'是' and nvl(是否止付,'')<>'是' and nvl(是否关闭非柜,'')<>'是'
and   账户分类1 not regexp '支票户'
;
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qwj_0720_qy purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qwj_0720_qy AS
select * from lab_bigdata_dev.tmp_qwj_0720_all_20240521
where 客户类型='企业'
and   账户状态='正常'
;
SELECT DISTINCT 客户名下当前未到期的信贷授信金额
FROM  lab_bigdata_dev.tmp_qwj_0720_qy***SJ2024072946_挂钩型理财客户来源.sql
--理财交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024072946_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_01 AS
select t1.cst_ID,t1.PD_CD,t1.trx_dt,t1.trx_tm,t1.CFM_AMT
    ,t1.mgr_id sale_empe_id,t1.ori_trx_act_id --客户账号
    ,t2.pd_nm
    ,case when t2.pd_nm regexp '挂钩型' and t2.ta_cd='TL' then 1 else 0 end is_gglc
    ,row_number() over(partition by t1.cst_id order by t1.trx_dt,t1.trx_tm) rn
from edw.dwd_bus_chm_trx_cfm_dtl_di         t1  --只有近7天分区 cst_id,pd_cd,trx_dt,trx_tm 不唯一
inner join edw.dim_bus_chm_pd_inf_dd 	    t2  --理财产品信息
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
and t2.pd_ctg_cd='1' --理财
WHERE t1.dt <= '@@{yyyyMMdd}'
and t1.trx_dt <= '20240731'
;
-- 客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024072946_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_02 AS
SElECT t1.cst_id
    ,t1.is_gglc     is_fst_gg
    ,t2.fst_opn_dt	    --最早存款账户开户日期
from SJXQ_SJ2024072946_CST_01       t1
left join (
    SElECT cst_id,min(opn_dt) fst_opn_dt --开户日期|C8
    from edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
    where dt = '@@{yyyyMMdd}'
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
where t1.rn=1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024072946_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_03 AS
SElECT '20231231' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20231231'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240131' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240131'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240229' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240229'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240331' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240331'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240430' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240430'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240531' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240531'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240630' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240630'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
union all
SElECT '20240731' data_dt
    ,case when cfm_amt<300000 then '1 销售金额30万以内'
        when cfm_amt>=300000 and cfm_amt<1000000 then '2 销售金额30万到100万'
        when cfm_amt>=1000000 then '3 销售金额100万及以上' else '' end sale_amt_grd
        when t2.is_fst_gg=1 then '2 存量非理财客户'
        when t2.is_fst_gg=0 then '3 存量理财客户' else '' end cst_typ
    ,cfm_amt
from(
    SElECT cst_id,sum(cfm_amt) cfm_amt
    from SJXQ_SJ2024072946_CST_01
    where trx_dt<='20240731'
    and is_gglc=1   --挂钩型理财
    group by cst_id
)t1 left join SJXQ_SJ2024072946_CST_02 t2
on t1.cst_id=t2.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024072946_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_04 AS
SELECT  t1.sale_amt_grd AS 销售挂钩理财等级
       ,t1.cst_typ      AS 客户类型
       ,t1.custs        AS 购买客户数_20231231
       ,t1.sale_amt     AS 销售挂钩理财金额_20231231
       ,t2.custs        AS 购买客户数_20240131
       ,t2.sale_amt     AS 销售挂钩理财金额_20240131
       ,t3.custs        AS 购买客户数_20240229
       ,t3.sale_amt     AS 销售挂钩理财金额_20240229
       ,t4.custs        AS 购买客户数_20240331
       ,t4.sale_amt     AS 销售挂钩理财金额_20240331
       ,t5.custs        AS 购买客户数_20240430
       ,t5.sale_amt     AS 销售挂钩理财金额_20240430
       ,t6.custs        AS 购买客户数_20240531
       ,t6.sale_amt     AS 销售挂钩理财金额_20240531
       ,t7.custs        AS 购买客户数_20240630
       ,t7.sale_amt     AS 销售挂钩理财金额_20240630
       ,t8.custs        AS 购买客户数_20240731
       ,t8.sale_amt     AS 销售挂钩理财金额_20240731
from(
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20231231'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20231231'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20231231'
)t1 left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240131'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240131'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240131'
)t2 on t1.sale_amt_grd=t2.sale_amt_grd
and t1.cst_typ=t2.cst_typ
left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240229'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240229'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240229'
)t3 on t1.sale_amt_grd=t3.sale_amt_grd
and t1.cst_typ=t3.cst_typ
left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240331'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240331'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240331'
)t4 on t1.sale_amt_grd=t4.sale_amt_grd
and t1.cst_typ=t4.cst_typ
left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240430'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240430'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240430'
)t5 on t1.sale_amt_grd=t5.sale_amt_grd
and t1.cst_typ=t5.cst_typ
left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240531'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240531'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240531'
)t6 on t1.sale_amt_grd=t6.sale_amt_grd
and t1.cst_typ=t6.cst_typ
left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240630'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240630'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240630'
)t7 on t1.sale_amt_grd=t7.sale_amt_grd
and t1.cst_typ=t7.cst_typ
left join (
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,cst_typ            --客户类型
        ,count(1)           custs --客户数
        ,sum(cfm_amt)       sale_amt --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240731'
    group by sale_amt_grd,cst_typ
    union all
    SElECT sale_amt_grd     --销售挂钩理财等级
        ,'4 合计'           -- 客户类型
        ,count(1)           --客户数
        ,sum(cfm_amt)       --销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240731'
    group by sale_amt_grd
    union all
    SElECT '4 汇总'        --销售挂钩理财等级
        ,'4 总计'          --客户类型
        ,count(1)          -- 客户数
        ,sum(cfm_amt)      -- 销售金额
    from SJXQ_SJ2024072946_CST_03
    where data_dt='20240731'
)t8 on t1.sale_amt_grd=t8.sale_amt_grd
and t1.cst_typ=t8.cst_typ
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072946_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024072946_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct data_dt) custs
from SJXQ_SJ2024072946_CST_03
***SJ2024072946_挂钩型理财客户来源_mod.sql
--理财交易明细
DROP TABLE IF EXISTS SJXQ_SJ2024072946_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_01 AS
SELECT  t1.cst_id
        ,t1.PD_CD
        ,t1.trx_dt
        ,t1.trx_tm
        ,t1.CFM_AMT
        ,t1.mgr_id sale_empe_id
        ,t1.ori_trx_act_id --客户账号
        ,t2.pd_nm
        ,CASE
           WHEN t2.pd_nm REGEXP '挂钩型' AND t2.ta_cd = 'TL' THEN 1
           ELSE 0
         END is_gglc
        ,row_number() OVER ( PARTITION BY t1.cst_id ORDER BY t1.trx_dt , t1.trx_tm ) rn
FROM    edw.dwd_bus_chm_trx_cfm_dtl_di t1 -- cst_id,pd_cd,trx_dt,trx_tm 不唯一
INNER JOIN    edw.dim_bus_chm_pd_inf_dd t2 --理财产品信息
ON      t1.pd_cd = t2.pd_cd
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.pd_ctg_cd = '1' --理财
WHERE   t1.dt <= '@@{yyyyMMdd}'
AND     t1.trx_dt <= '20240731'
AND     t1.trx_sts_cd IN ( '6' , '7' , '8' , 'S' ) -- 交易成功
AND     t1.bus_cd IN ( '122' , '130' );
 -- 130 认购 122 申购
-- 客户基本信息
DROP TABLE IF EXISTS SJXQ_SJ2024072946_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_02 AS
SELECT  t1.cst_id
        ,t1.is_gglc AS is_fst_gg
        ,t1.trx_dt  AS chm_fst_trx_dt --理财最早交易日期
        ,t2.fst_opn_dt --最早存款账户开户日期
        ,datediff(to_date(t1.trx_dt, 'yyyyMMdd'), to_date(t2.fst_opn_dt, 'yyyyMMdd'), 'dd') as 交易时间差
FROM    SJXQ_SJ2024072946_CST_01 t1
LEFT JOIN    (
                 SELECT  cst_id
                         ,min(opn_dt) fst_opn_dt --开户日期|C8
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   dt = '@@{yyyyMMdd}'
                 GROUP BY cst_id
             ) t2
ON      t1.cst_id = t2.cst_id
WHERE   t1.rn = 1;
-- 字段汇总
DROP TABLE IF EXISTS SJXQ_SJ2024072946_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072946_CST_03 AS
SELECT  '20231231' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20231231'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240131' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240131'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240229' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240229'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240331' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240331'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240430' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240430'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240531' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240531'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240630' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240630'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id
UNION ALL
SELECT  '20240731' data_dt
        ,CASE
           WHEN cfm_amt < 300000                        THEN '1 销售金额30万以内'
           WHEN cfm_amt >= 300000 AND cfm_amt < 1000000 THEN '2 销售金额30万到100万'
           WHEN cfm_amt >= 1000000                      THEN '3 销售金额100万及以上'
           ELSE ''
         END sale_amt_grd
        ,CASE
           WHEN 交易时间差 <= 10 THEN '1 新行外客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 1 THEN '2 存量非理财客户'
           WHEN 交易时间差 > 10 and t2.is_fst_gg = 0 THEN '3 存量理财客户'
           ELSE ''
         END cst_typ
        ,cfm_amt
FROM    (
            SELECT  cst_id
                    ,sum(cfm_amt) cfm_amt
            FROM    SJXQ_SJ2024072946_CST_01
            WHERE   trx_dt <= '20240731'
            AND     is_gglc = 1 --挂钩型理财
            GROUP BY cst_id
        ) t1
LEFT JOIN    SJXQ_SJ2024072946_CST_02 t2
ON      t1.cst_id = t2.cst_id;
DROP TABLE IF EXISTS SJXQ_SJ2024072576_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072576_CST_01 AS
SELECT  cst_id
        ,bank_act_id
        ,pd_cd
        ,concat(bank_act_id, pd_cd) AS wrnt_id
FROM    qbi_file_20240802_14_38_13
-- 汇总
DROP TABLE IF EXISTS SJXQ_SJ2024072576_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024072576_CST_02 AS
SELECT  s.cst_id         AS 客户号
        ,s.pd_cd         AS 理财产品代码
        ,t2.grnt_tot_amt AS 担保总金额
        ,t2.hi_mrgn_amt  AS 最高担保金额
        ,t2.busi_ctr_id  AS 业务合同编号
        ,t3.amt          AS 发放金额
        ,t3.norm_bal     AS 正常余额
        ,t3.dtrb_dt      AS 发放日期
        ,t3.end_dt       AS 终结日期
FROM    SJXQ_SJ2024072576_CST_01 s
LEFT JOIN    edw.dim_bus_grnt_cltr_inf_dd t1 --cltr_id 押品编号, wrnt_id 权证编号
ON      s.wrnt_id = t1.wrnt_id
AND     t1.dt = '20240718'
LEFT JOIN    edw.dws_bus_grnt_itm_inf_dd t2
ON      t1.cltr_id = t2.grnt_id
AND     t2.dt = '20240718'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd t3
ON      t2.busi_ctr_id = t3.bus_ctr_id
AND     t3.dt = '20240718';
***SJ2024073056_四会村行信贷数据.sql
-- SJ2024073056
DROP   TABLE IF     EXISTS SJXQ_SJ2024073056_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024073056_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '广东四会泰隆村镇'
where t1.dt='20240731'
;
-- 是否去过澳门 触发次数
DROP   TABLE IF     EXISTS SJXQ_SJ2024073056_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024073056_CST_02 AS
SElECT cst_id
    ,count(cty_nm)  tot_trx_cnt
    ,sum(case when trx_dt>='20240101' then 1 else 0 end) curr_y_trx_cnt
from(
    SELECT  cst_id,substr(usr_sbm_tm,1,8) trx_dt,cty_nm
    FROM    edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di --个人网银各渠道汇总流水信息
    WHERE   DT <= '20240731'
    AND     cty_nm regexp '澳门'
    union all
    SELECT  cst_id,substr(usr_sbm_tm,1,8) trx_dt,cty_nm
    FROM    edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di --企业网银各渠道汇总流水信息
    WHERE   DT <= '20240731'
    AND     cty_nm regexp '澳门'
)t1 group by cst_ID
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024073056_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024073056_CST_03 AS
SELECT  t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t3.sam_rsk_ctrl_id          AS 同一风险控制号
       ,t1.ctr_serno                AS 合同流水号
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,t1.ctr_bgn_dt               AS 合同起始日期
       ,t1.ctr_mtu_dt               AS 合同到期日期
       ,t1.org_nm                   AS 管户部门
       ,concat(t1.mgr_id,t1.mgr_nm) AS 管户客户经理
       ,CASE WHEN t2.cst_id is not null THEN '是'  ELSE '' END AS 是否去过澳门
       ,t2.tot_trx_cnt              AS 触发次数
       ,t2.curr_y_trx_cnt           AS 今年触发次数
from SJXQ_SJ2024073056_CST_01       t1
left join SJXQ_SJ2024073056_CST_02  t2
on t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd 	t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20240731'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024073056_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024073056_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024073056_CST_03
***SJ2024080266_合同对应调查地址.sql
-- DWD_BUS_LOAN_CST_SVY_RCD_DD     客户调查记录信息
-- 客户号     客户名称     信贷合同流水号
-- 1600966637     牟德珍     BC2018011000002022
DROP   TABLE IF     EXISTS SJXQ_SJ2024080266_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080266_CST_01 AS
SELECT  1                    AS seq --序号
       ,'1600966637'         AS cst_id
       ,'BC2018011000002022' AS ctr_serno --合同号
-- from qbi_file_20240806_11_13_14
-- where pt <> ''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024080266_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080266_CST_02 AS
SElECT t1.seq,t1.cst_id,t1.ctr_serno
    ,t2.ctr_bgn_dt      --合同起始日期
    ,t3.svy_dt	        --调查日期
    ,t3.svy_addr	    --调查地址
    ,row_number() over(partition by t1.seq order by t3.svy_dt desc ) rn
from SJXQ_SJ2024080266_CST_01               t1
inner join edw.dim_bus_loan_ctr_bse_inf_dd  t2 --合同基础信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
inner join edw.DWD_BUS_LOAN_CST_SVY_RCD_DD  t3 --客户调查记录信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
where t2.ctr_bgn_dt >= t3.svy_dt    --合同日期 大于 调查日期
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080266_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080266_CST_03 AS
SELECT  t1.seq       AS 序号
       ,t1.cst_id    AS 客户号
       ,t1.ctr_serno AS 合同号
       ,t2.svy_dt    AS 调查日期
       ,t2.svy_addr  AS 调查地址
from SJXQ_SJ2024080266_CST_01       t1
left join SJXQ_SJ2024080266_CST_02  t2
on t1.seq=t2.seq
and t2.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080266_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080266_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024080266_CST_03
***SJ20240805101_抵押贷款抵押品种类.sql
﻿---- 截止7.31日 抵押贷款抵押品种类 工业厂房 商业店铺
DROP   TABLE IF     EXISTS SJXQ_SJ20240805101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240805101_CST_01 AS
SElECT col_1 as 序号
    ,col_2 as 客户名称
    ,col_3 as 合同号 --有重复
    ,col_4 as 贷款编号
    ,col_5 as 客户号
from qbi_file_20240806_11_13_14
where pt <> ''
;
-- 抵押品
DROP   TABLE IF     EXISTS SJXQ_SJ20240805101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240805101_CST_02 AS
SElECT t1.合同号
    ,t2.CTR_SERNO
    ,t2.GRNT_GDS_TYP_CD
    ,t3.GRNT_CTR_NO
    ,t3.CLTR_NO	    --押品编号|C32
    ,t3.CLTR_NM	    --押品名称|C200
    ,t3.CLTR_TYP_CD	--押品类型代码|C7
    ,c1.cd_val_dscr CLTR_TYP_nm
from (
    select DISTINCT 合同号
    from SJXQ_SJ20240805101_CST_01
)t1 left join (
    SELECT DISTINCT CTR_SERNO,grnt_ctr_no,GRNT_GDS_TYP_CD
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD
    where dt='20240731'
    and GRNT_GDS_TYP_CD='2' -- 押品
) t2 on t1.合同号=t2.CTR_SERNO
left join edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD    t3
on t2.grnt_ctr_no=t3.GRNT_CTR_NO
and t3.dt='20240731'
left join edw.dwd_code_library_dd c1
on t3.CLTR_TYP_CD=c1.cd_val
and c1.dt='20240731'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240805101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240805101_CST_03 AS
SELECT t1.*
    ,t2.CLTR_TYP_nm     as 押品类型
from SJXQ_SJ20240805101_CST_01 t1
left join(
    SELECT 合同号
    from SJXQ_SJ20240805101_CST_02
    GROUP BY 合同号
)t2 on t1.合同号=t2.合同号
;
SELECT *
from SJXQ_SJ20240805101_CST_03***SJ2024080556_嘉兴分行资产业务.sql
-- 截止7.31日 嘉兴分行全量资产业务
DROP   TABLE IF     EXISTS SJXQ_SJ2024080556_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080556_CST_01 AS
select t1.ctr_serno                                --合同流水号|C32
	,t1.rel_serno                                --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.prd_no                                   --产品编号|C32
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期|C8
	,t1.ctr_mtu_dt                               --合同到期日期|C8
	,t1.smls_reloan_ind                          --无缝续贷标志|C1
	,t1.smls_reloan_typ_cd                       --无缝续贷类型代码|C1
    ,c1.cd_val_dscr         smls_reloan_typ_nm
	,t1.hpn_typ_cd                               --发生类型代码|C6
    ,c2.cd_val_dscr         hpn_typ_nm
	,t1.rel_main_ctr_no                          --关联主合同编号|C32
	,t1.pst_loan_mdf_ctr_serno                   --贷后变更合同流水号|C32
	,t1.rel_ast_pool_ctr_serno                   --关联资产池合同流水号
	,t1.ctr_eff_dt                               --合同生效日期
    ,t3.rul_set_rslt_cd
    ,c3.cd_val_dscr         rul_set_rslt_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t2 --信贷合同管护信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t2.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm = '嘉兴分行'
left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd t3 --授信关联预评估信息表
on t1.rel_serno = t3.usc_aply_serno
and t3.dt='20240731'
left join edw.dwd_code_library_dd           c1
on t1.smls_reloan_typ_cd = c1.cd_val
and c1.dt = '20240731'
left join edw.dwd_code_library_dd           c2
on t1.hpn_typ_cd = c2.cd_val
and c2.dt = '20240731'
left join edw.dwd_code_library_dd           c3
on t3.rul_set_rslt_cd = c3.cd_val
and c3.dt = '20240731'
where t1.dt='20240731'
;
/*
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD    C1 --码值表(发生类型)
ON      T1.HPN_TYP_CD = C1.CD_VAL --发生类型 码值
AND     C1.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     C1.FLD_NM = 'HPN_TYP_CD'
AND     C1.DT = '20240131'
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024080556_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080556_CST_02 AS
SELECT  t1.ctr_serno              AS 合同号
       ,t1.ctr_eff_dt             AS 合同生效日期
       ,t2.dbil_id                AS 借据号
       ,t1.ctr_bgn_dt             AS 合同起始日期
       ,t1.ctr_mtu_dt             AS 合同到期日期
       ,t1.rul_set_rslt_nm        AS 预评估结果
       ,t1.hpn_typ_nm             AS 发生类型
       ,t1.prd_no                 AS 产品编号
       ,t3.pd_nm                  AS 产品名称
       ,t1.smls_reloan_ind        AS 无缝续贷标志
       ,t1.smls_reloan_typ_nm     AS 无缝续贷类型
       ,t1.rel_main_ctr_no        AS 关联主合同编号
       ,t1.pst_loan_mdf_ctr_serno AS 贷后变更合同流水号
       ,t1.rel_ast_pool_ctr_serno AS 关联资产池合同流水号
from SJXQ_SJ2024080556_CST_01 t1
left join(
    select ctr_serno                                --合同流水号|C32
    from edw.dim_bus_loan_dbil_inf_dd             --信贷借据信息
    where dt='20240731'
    group by ctr_serno
)t2 on t1.ctr_serno=t2.ctr_serno
left join edw.dim_bus_loan_prd_frml_dd  t3 --产品信息
on t1.prd_no=t3.prd_no
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024080556_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2024080556_CST_02
***SJ20240806111_长乐村行担保人数据.sql
-- 合同流水号     客户名称
-- BC2022101800000160     李增彬
-- BC2020080700002949     郑崇
-- BC2020111900000058     陈杰
DROP   TABLE IF     EXISTS SJXQ_SJ20240806111_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240806111_CST_01 AS
SELECT  1                     as seq --序号
       ,'BC2022101800000160'  as ctr_serno --合同流水号
       ,'李增彬'              as cst_nm  --客户名称
-- from qbi_file_20240806_11_13_14
-- where pt <> ''
;
--合同基础信息 借款人电话
DROP   TABLE IF     EXISTS SJXQ_SJ20240806111_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240806111_CST_02 AS
select t1.ctr_serno                                --合同流水号|C32
	,t1.rel_serno                                --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期|C8
	,t1.ctr_mtu_dt                               --合同到期日期|C8
    ,t3.CTC_TEL         --联系电话
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join SJXQ_SJ20240806111_CST_01        t2
on t1.ctr_serno=t2.ctr_serno
left join (
    SElECT cst_id
    from edw.DIM_CST_ASST_LOAN_CST_TEL_INF_DD
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t3 --信贷客户电话信息
on t1.cst_id=t3.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 担保人
DROP   TABLE IF     EXISTS SJXQ_SJ20240806111_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240806111_CST_03 AS
SElECT t1.CTR_SERNO
    ,t2.GRNT_CTR_NO
    ,t2.gtor_no	--保证人编号|C20
    ,t2.gtor_nm	--保证人名称|C200
    ,t3.CTC_TEL
    ,concat(substr(regexp_replace(T4.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T4.reg_adr,'\\s|,',''))-6,0)),'******')   户籍地址脱敏
from(
    SElECT distinct t1.CTR_SERNO	--合同流水号|C32
        ,t1.GRNT_CTR_NO	        --担保合同编号|C32
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD  t1
    inner join SJXQ_SJ20240806111_CST_01        t2
    on t1.ctr_serno=t2.ctr_serno
    where t1.dt='@@{yyyyMMdd}'
)t1 left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t2 --担保合同保证人信息
on t1.GRNT_CTR_NO=t2.GRNT_CTR_NO
and t2.dt='@@{yyyyMMdd}'
left join (
    SElECT cst_id
    from edw.DIM_CST_ASST_LOAN_CST_TEL_INF_DD
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t3 --信贷客户电话信息
on t2.gtor_no=t3.cst_id
left join edw.DWS_CST_BAS_INF_DD	t4 --客户基础信息汇总表	REG_ADR	户籍地址|注册地址|C256
on t2.gtor_no=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240806111_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240806111_CST_04 AS
SElECT t1.seq as 序号
    ,t1.ctr_serno as 合同号
    ,t1.cst_nm as 客户名称
    ,t2.CTC_TEL as 借款人电话
    ,t3.gtor_nm as 保证人名称
    ,t3.CTC_TEL as 保证人电话
    ,t3.户籍地址脱敏
from SJXQ_SJ20240806111_CST_01      t1
left join SJXQ_SJ20240806111_CST_02 t2
on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240806111_CST_03 t3
on t1.ctr_serno=t3.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240806111_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240806111_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240806111_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ20240806111_CST_04
***SJ2024080626_改新信贷系统表.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-08-06 16:24:51
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 2024年3月新增的定期理财认购/申购，非货基金认购/申购交易，交易申请确认状态为成功
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_01 AS
SELECT '定期理财'   bus_type  --业务类型
    -- ,decode(trx_cd,'100200','理财产品购买','100201','理财产品申购') --交易代码
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,t1.srl_nbr --流水号
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    -- , 销售人员姓名
    -- , brc_org_nm
    -- , sbr_org_nm
    -- ,bnk_act_id 银行账号
    ,t1.tatrx_act_nbr
    ,t1.tacd    --ta代码
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
    ,t1.cst_id          --cst_ID
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
WHERE t1.dt = '@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8) between '20240701' and '20240731'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t1.trx_cd IN ( '100200' , '100201' )
;
-- 客户上一次理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_02 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,a.rsk_lvl_cd,a.late_ases_dt
        ,row_number() over(partition by a.cst_id order by late_ases_dt desc) rn
    from edw.dwd_bus_chm_cst_rsk_ases_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024080626_CST_01)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,rsk_lvl_cd,late_ases_dt
) a where rn=2
;
-- 客户交易时理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_03 AS
select T1.srl_nbr,T1.trx_dt
    ,T2.rsk_lvl_cd         trx_rsk_lvl      --客户交易日风险等级
    ,T2.late_ases_dt       trx_rsk_ases_dt  --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_01 T1
inner join edw.dwd_bus_chm_cst_rsk_ases_dd T2
on T1.cst_ID=T2.cst_id and T1.trx_dt=T2.dt
where T2.dt between '20240701' and '20240731'
;
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_04 AS
SELECT '非货基金' BUS_TYPE
    ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.CST_ID          --CST_ID
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='@@{yyyyMMdd}'
    and T1.CHANNEL_DATE between '20240701' and '20240731'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20240701' and '20240731'
    and T1.CHANNEL_DATE between '20240701' and '20240731'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_05 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,cst_rsk_grd_cd rsk_lvl_cd,ases_dt late_ases_dt,
        row_number() over(partition by a.cst_id order by ases_dt desc) rn
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024080626_CST_04)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,cst_rsk_grd_cd,ases_dt
) a where rn=2
;
-- 客户交易时基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_06 AS
select a.srl_nbr,a.trx_dt
    ,b.cst_rsk_grd_cd       trx_rsk_lvl     --客户交易日风险等级
    ,b.ases_dt              trx_rsk_ases_dt --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_04           a
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    b
on a.cst_ID=b.cst_id and a.trx_dt=b.dt
where b.dt between '20240701' and '20240731'
;
--定期理财+基金
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_07 AS
select T1.*
    ,T4.rsk_lvl_cd,T4.late_ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_01           T1		--理财交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_02      T2      --上次理财风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_03      T3      --交易时理财风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dwd_bus_chm_cst_rsk_ases_dd               T4 		--理财风评表
on T1.CST_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
union all
select T1.*
    ,T4.cst_rsk_grd_cd,T4.ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_04           T1      --基金交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_05      T2      --上次基金风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_06      T3      --交易时基金风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd        T4      --基金风评表
on t1.cst_ID=t4.cst_ID and t4.dt='@@{yyyyMMdd}'
;
--关联其他字段（主表）
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_08 AS
SElECT T1.*
    ,T2.ta_name --发行机构
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    ,T7.credit_rsk_grd
    ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    ,T9.aum_avg_360d
    ,T10.aum_bal TRX_aum_bal
    ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ2024080626_CST_07   T1
left join edw.finc_tbtainfo                 T2 on t1.tacd=T2.ta_code  and T2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_ID=T3.cst_id and T3.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='@@{yyyyMMdd}'
left join (
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='@@{yyyyMMdd}'
) T7 on T1.CST_ID=T7.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.CST_ID=T8.cst_id and T8.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.CST_ID=T9.cst_id and T9.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
on T1.CST_ID=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20240701' and '20240731'
left join (
    SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
    inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '@@{yyyyMMdd}'
    WHERE a.dt between '20240701' and '20240731' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
    group by a.cst_id, a.dt
) t11 on T1.cst_ID=t11.cst_id and T1.trx_dt=t11.dt
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_09 AS
select distinct a.cst_ID,trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,b.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_08 a
left join edw.dws_cst_bas_inf_dd b
on a.cst_ID=b.cst_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd c
on b.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='@@{yyyyMMdd}'
and NVL(c.sam_rsk_ctrl_id,'')<>''
;
-- 前后5天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_10 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,rel_cust_nm
    ,B.BUSI_CTR_ID                         --合同流水号
    ,B.CTR_AMT                             --合同金额
    ,B.CTR_BAL                             --合同余额
    ,B.TRM_MON                             --期限月
    ,b.stdinr                              --基准利率
    ,c.ref_year_intr_rat                   --参考年利率
    ,B.INTR_RAT                            --执行利率
    ,B.REF_MON_INTR_RAT                    --参考月利率
    ,c.aprv_exe_mon_intr_rat               --执行月利率
    ,C.REG_DT                              --申请日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,case D.PREEVALUATERESULT
        when '1010' then '通过'
        when '1020' then '抗辩通过'
        when '1030' then '上诉通过'
        when '2010' then '未通过'
        when '2020' then '抗辩未通过'
        when '2030' then '上诉未通过'
        when '3010' then '待审查岗确认'
        when '3020' then '转客户经理'
        when '3030' then '转中台'
        when '4010' then '申请详情补充'
        when '4020' then '抗辩详情补充'
        when '4030' then '上诉详情补充'
        else D.PREEVALUATERESULT
    end as                                  pre_ases_res
    ,F.CD_VAL_DSCR                          HPN_TYP
    ,B.LOAN_USG_CD                         --贷款用途代码
    ,B.USG_CMT                             --用途备注
    ,nvl(b.intr_rat_adj_cmt,c.intr_rat_adj_cmt) intr_rat_adj_cmt --贷款利率优惠备注
    ,case
        when b.bus_lab_cd regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PD_CD, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PD_CD
    ,B.CMT                                 --备注
    ,B.BUSI_APL_ID                         --业务申请编号
    ,B.DT                                  --合同日期
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_09   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''  --剔除空值和空
AND     B.CRC_IND <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PD_CD, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.DWD_BUS_LOAN_APL_INF_DD       C --信贷业务申请信息
ON      B.BUSI_APL_ID = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT = '@@{yyyyMMdd}'
left outer join edw.loan_customer_preevaluate_result D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd E
on b.FIVE_CTG_CD=E.cd_val
AND e.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD            F --码值表(发生类型)
ON      C.HPN_TYP_CD = F.CD_VAL                 --发生类型 码值
AND     F.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     F.FLD_NM = 'HPN_TYP_CD'
AND     F.DT = '@@{yyyyMMdd}'
LEFT JOIN (
    SELECT  BUS_CTR_ID ,MIN(DTRB_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DWS_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '@@{yyyyMMdd}'
    GROUP BY BUS_CTR_ID
) G ON B.BUSI_CTR_ID = G.BUS_CTR_ID
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_11 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_11 AS
select cst_ID,trx_dt
    ,a.rel_cst_id
    ,rel_cust_nm
    ,BUSI_CTR_ID                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,stdinr                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,INTR_RAT                            --执行利率
    ,REF_MON_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,a.REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,pre_ases_res
    ,HPN_TYP
    ,USG_CMT
    ,intr_rat_adj_cmt
    ,is_wfdk
    ,is_zc_loan
    ,lst_BUSI_CTR_ID
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.BUSI_CTR_ID            	lst_BUSI_CTR_ID
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.INTR_RAT                 lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ2024080626_CST_10
        where DIFF_TM<=5
    ) a
    left join lab_bigdata_dev.SJXQ_SJ2024080626_CST_10 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.pd_cd=b.pd_cd and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_12 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_12 AS
select a.bus_type              业务类型
    ,a.trx_type                交易类型
    ,a.srl_nbr                 交易流水号
    ,a.trx_sts                 交易状态
    ,concat(a.trx_dt,' ',a.trx_tm) 申请日期
    ,a.cfm_dt                  确认日期
    ,a.trx_chnl                交易渠道
    ,a.trx_amt                 交易金额
    ,a.cfm_amt                 确认金额
    ,a.trx_lot                 交易份额
    ,a.cfm_lot                 确认份额
    ,a.sale_empe_id            销售人员工号
    ,a.sale_empe_nm            销售人员姓名
    ,a.brc_org_nm              所属分行
    ,a.sbr_org_nm              所属支行
    ,a.tatrx_act_nbr           交易账号
    ,a.pd_cd                   产品代码
    ,a.pd_nm                   产品名称
    ,a.ta_name                 发行机构
    ,a.prod_type               产品类型
    ,a.pd_rsk_grd              产品风险等级
    ,a.pfm_comp_bas            业绩比较基准
    ,a.pd_found_dt             产品扣款日
    ,a.pd_val_dt               产品起息日
    ,a.pd_end_dt               产品到期日
    ,a.CST_ID                  客户号
    ,a.cst_nm                  客户名称
    ,a.age                     客户年龄
    ,a.gender                  客户性别
    ,''                        客户手机号码
    ,a.rsk_lvl_cd                                           	客户当前风险测评结果
    ,decode(a.late_ases_dt,'18991231','',a.late_ases_dt)    	客户当前结果测评时间
    ,a.lst_rsk_lvl                                          	客户上一次风险测评结果
    ,decode(a.lst_rsk_ases_dt,'18991231','',a.lst_rsk_ases_dt)  客户上一次风险测评时间
    ,a.trx_rsk_lvl                                              客户交易日风险等级
    ,decode(a.trx_rsk_ases_dt,'18991231','',a.trx_rsk_ases_dt)  客户交易日风险测评时间
    ,a.is_farm								是否农户
    ,a.efe_loan_cst_ind                     是否信贷有效户
    ,a.efe_dep_cst_ind                      是否存款有效户
    ,a.is_empe                              是否行内员工
    ,a.aum_avg_360d                         客户近一年AUM
    ,a.trx_ncr_fnd_bal                      客户交易时非货基金保有量
    ,a.TRX_aum_bal                          客户交易时AUM
    ,if(b.cst_ID is not null,'是','') 		交易日前后5天内同一风险控制号下是否存在贷款
    ,b.rel_cust_nm                  		贷款客户名称
    ,c.loan_apl_credit_rsk_grd      		当前贷款申请时客户信用风险等级
    ,a.credit_rsk_grd               		当前客户信用风险等级
    ,b.BUSI_CTR_ID                   		当前笔贷款合同流水号
    ,b.reg_dt                       		当前笔贷款申请日期
    ,b.DTRB_DT                      		当前笔贷款发放日期
    ,b.CTR_AMT                      		当前笔贷款金额
    ,ref_year_intr_rat              		当前笔贷款参考年利率
    ,INTR_RAT                       		当前笔贷款执行年利率
    ,aprv_exe_mon_intr_rat          		当前笔贷款执行月利率
    ,b.pre_ases_res                 		当前笔贷款预审批结果
    ,b.FIVE_CTG                     		当前笔贷款五级分类
    ,b.HPN_TYP                      		贷款类型
    ,b.is_zc_loan                   		是否为政策性贷款
    ,b.is_wfdk                      		是否为接力贷
    ,b.intr_rat_adj_cmt             		贷款利率优惠备注
    ,b.USG_CMT                      		贷款用途备注
    ,b.lst_BUSI_CTR_ID              		上一笔贷款合同流水号
    ,b.lst_CTR_AMT                  		上一笔贷款合同金额
    ,b.lst_INTR_RAT                 		上一笔贷款执行年利率
    ,b.lst_aprv_exe_mon_intr_rat    		上一笔贷款执行月利率
    ,b.lst_DTRB_DT                   		上一笔贷款发放日期
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_08       a
left join lab_bigdata_dev.SJXQ_SJ2024080626_CST_11  b
on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
left join (
    select distinct dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') loan_apl_credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt<='@@{yyyyMMdd}'
) c on b.rel_cst_id=c.cst_id and b.reg_dt=c.dt
;
SELECT * FROM SJXQ_SJ2024080626_CST_12***SJ2024080626_改新信贷系统表_res.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-08-06 16:24:51
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 2024年3月新增的定期理财认购/申购，非货基金认购/申购交易，交易申请确认状态为成功
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_01 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_01 AS
SELECT '定期理财'   bus_type  --业务类型
    -- ,decode(trx_cd,'100200','理财产品购买','100201','理财产品申购') --交易代码
    ,decode(t1.bus_cd,'122','申购','130','认购')   trx_type  --业务代码 交易类型
    ,t1.srl_nbr --流水号
    ,decode(t1.trx_sts_cd,'6','部分确认未全部返回','7','部分确认已全部返回','8','确认成功','S','成功') trx_sts --交易状态
    ,SUBSTR(t1.srl_nbr,1,8) trx_dt
    ,t1.trx_tm
    ,t1.cfm_dt --确认日期
    ,t1.trx_chnl_cd
    ,decode(t1.trx_chnl_cd,'v','纵深支付','0','柜台交易','1','网上银行','2','自助查询终端','3','电话银行'
        ,'4','云上厅堂','5','TA发起','6','低柜','7','手机银行','8','质押系统','9','批量发起'
        ,'B','微信银行','G','WEB管理台','Q','直销银行','Z','投融理财','a','贴膜卡','b','薪箐乐'
        ,'c','智能投顾','s','司法对接','T','泰惠收渠道','e','信贷系统','')  trx_chnl --交易渠道
    ,t1.trx_amt --交易金额
    ,t1.cfm_amt --确认金额
    ,t1.trx_lot --交易份额
    ,t1.cfm_lot --确认份额
    ,t1.mgr_id sale_empe_id2 --销售人员工号
    ,case when t1.mgr_id='000000' then t3.mgr_id else t1.mgr_id end sale_empe_id
    -- , 销售人员姓名
    -- , brc_org_nm
    -- , sbr_org_nm
    -- ,bnk_act_id 银行账号
    ,t1.tatrx_act_nbr
    ,t1.tacd    --ta代码
    ,t1.pd_cd   --产品代码
    ,t2.pd_nm   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      prod_type --产品类型
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
    ,t1.cst_id          --cst_ID
FROM edw.dwd_bus_chm_trx_cfm_dtl_dd     t1  -- 理财交易确认流水明细
inner join edw.dim_bus_chm_pd_inf_dd    t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}'
left join(
    select cst_ID,pd_cd,bnk_act_id,mgr_id
        ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc) rn
    from edw.dws_bus_chm_act_mgr_inf_dd t3
    where t3.dt = '@@{yyyyMMdd}'
    and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
    and t3.PD_TP_CD='1'         --'0','基金','1','理财'
) t3 on  t1.cst_ID=t3.cst_ID and t1.pd_cd=t3.pd_cd and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
WHERE t1.dt = '@@{yyyyMMdd}'
and SUBSTR(t1.srl_nbr,1,8) between '20240701' and '20240731'
--交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
-- AND t1.trx_cd IN ( '100200' , '100201' )
;
-- 客户上一次理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_02 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_02 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,a.rsk_lvl_cd,a.late_ases_dt
        ,row_number() over(partition by a.cst_id order by late_ases_dt desc) rn
    from edw.dwd_bus_chm_cst_rsk_ases_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024080626_CST_01)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,rsk_lvl_cd,late_ases_dt
) a where rn=2
;
-- 客户交易时理财风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_03 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_03 AS
select T1.srl_nbr,T1.trx_dt
    ,T2.rsk_lvl_cd         trx_rsk_lvl      --客户交易日风险等级
    ,T2.late_ases_dt       trx_rsk_ases_dt  --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_01 T1
inner join edw.dwd_bus_chm_cst_rsk_ases_dd T2
on T1.cst_ID=T2.cst_id and T1.trx_dt=T2.dt
where T2.dt between '20240701' and '20240731'
;
--基金交易明细
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_04 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_04 AS
SELECT '非货基金' BUS_TYPE
    ,DECODE(T1.BUS_CD,'020','认购','022','申购') TRX_TYPE
    ,T1.BUS_GLO_SRL_NBR SRL_NBR
    ,DECODE(TRANS_STATUS,'S','成功','3','确认成功','4','部分确认成功','0','申请成功') TRX_STS
    ,CHNL_DT        TRX_DT
    ,TRX_TM
    ,CFM_DT
    ,CHNL_CD
    ,C1.CD_VAL_DSCR TRX_CHNL
    ,T1.APL_AMT     TRX_AMT
    ,CFM_AMT                    --确认金额
    ,APL_LOT        TRX_LOT     --交易份额
    ,CFM_LOT        CFM_LOT     --确认份额
    ,RCM_PSN_ID                 --推荐人工号
    ,case when LENGTH(CUST_WEALTH_ADVISOR)>0 then CUST_WEALTH_ADVISOR
          else CUST_WEALTH_MANAGER end SALE_EMPE_ID --销售人员工号
    ,T1.TAACT_ID       --TA交易账号
    ,T1.TA_CD
    ,T1.PD_CD       --产品代码
    ,T2.PD_NM       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','基金中基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.FOUND_DT        --产品成立日期
    ,'' PD_VAL_DT       --产品起息日期
    ,T2.MTU_DT          --产品结束日期
    ,T1.CST_ID          --CST_ID
FROM (
    -- edw.dwd_bus_chm_fnd_cst_rqs_srl_dd t1  -- 基金客户资金类交易申请流水 没有交易时分秒数据
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR     --财富顾问工号
        ,t2.CUST_WEALTH_MANAGER     --财富管护人工号
    from edw.cfin_fund_cust_trans_req_log           T1 --基金客户交易流水申请表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG     T2 --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt='@@{yyyyMMdd}'
    and T1.CHANNEL_DATE between '20240701' and '20240731'
    union all
    SELECT T1.BUSI_CODE    BUS_CD
        ,T1.BUSS_SERNO     BUS_GLO_SRL_NBR
        ,T1.CHANNEL_DATE   CHNL_DT
        ,T1.CHANNEL_TIME   TRX_TM
        ,T1.ACK_DATE       CFM_DT
        ,T1.CHANNEL_FLAG   CHNL_CD
        ,T1.APP_AMT        APL_AMT
        ,T1.APP_VOL        APL_LOT
        ,T1.ACK_AMT        CFM_AMT
        ,T1.ACK_VOL        CFM_LOT
        ,T1.CUST_MANAGER   RCM_PSN_ID
        ,T1.TRANS_ACCT_NO  TRX_ACT_ID
        ,T1.TA_ACCT_NO     TAACT_ID
        ,T1.PROD_CODE      PD_CD
        ,T1.CUST_NO        CST_ID
        ,T1.TANO           TA_CD
        ,T1.TRANS_STATUS
        ,t2.CUST_WEALTH_ADVISOR
        ,t2.CUST_WEALTH_MANAGER
    from edw.cfin_fund_cust_trans_req_log_h       T1  --基金客户交易流水申请历史表
    inner join edw.CFIN_FUND_CUST_TRANS_CFM_LOG_H T2  --基金客户交易流水确认表历史
    ON  T1.APP_SERNO = T2.APP_SERNO AND T1.ACK_DATE=T2.ACK_DATE AND T1.DT = T2.DT
    where T1.dt between '20240701' and '20240731'
    and T1.CHANNEL_DATE between '20240701' and '20240731'
) t1 inner join edw.dim_bus_chm_fnd_pd_inf_dd t2
on t1.pd_cd=t2.pd_cd and t2.dt='@@{yyyyMMdd}' and t2.fnd_typ_cd<>'04' -- 非货基金
LEFT JOIN (
    select distinct cd_val,cd_val_dscr
    from edw.dwd_code_library_dd
) C1 ON T1.CHNL_CD=C1.cd_val
;
-- 客户上一次基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_05 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_05 AS
select cst_id
    ,rsk_lvl_cd     lst_rsk_lvl
    ,late_ases_dt   lst_rsk_ases_dt
from (
    select a.cst_id,cst_rsk_grd_cd rsk_lvl_cd,ases_dt late_ases_dt,
        row_number() over(partition by a.cst_id order by ases_dt desc) rn
    from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd a
    inner join (select distinct cst_ID from lab_bigdata_dev.SJXQ_SJ2024080626_CST_04)b on a.cst_ID=b.cst_ID
    where a.dt<='@@{yyyyMMdd}'
    group by a.cst_id,cst_rsk_grd_cd,ases_dt
) a where rn=2
;
-- 客户交易时基金风险评测
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_06 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_06 AS
select a.srl_nbr,a.trx_dt
    ,b.cst_rsk_grd_cd       trx_rsk_lvl     --客户交易日风险等级
    ,b.ases_dt              trx_rsk_ases_dt --客户交易日风险测评时间
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_04           a
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd    b
on a.cst_ID=b.cst_id and a.trx_dt=b.dt
where b.dt between '20240701' and '20240731'
;
--定期理财+基金
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_07 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_07 AS
select T1.*
    ,T4.rsk_lvl_cd,T4.late_ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_01           T1		--理财交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_02      T2      --上次理财风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_03      T3      --交易时理财风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dwd_bus_chm_cst_rsk_ases_dd               T4 		--理财风评表
on T1.CST_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
union all
select T1.*
    ,T4.cst_rsk_grd_cd,T4.ases_dt
    ,T2.lst_rsk_lvl,T2.lst_rsk_ases_dt
    ,T3.trx_rsk_lvl,T3.trx_rsk_ases_dt
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_04           T1      --基金交易
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_05      T2      --上次基金风评
ON T1.cst_ID=t2.cst_ID
LEFT JOIN lab_bigdata_dev.SJXQ_SJ2024080626_CST_06      T3      --交易时基金风评
ON T1.srl_nbr=t3.srl_nbr and t1.trx_dt=t3.trx_dt
left join edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd        T4      --基金风评表
on t1.cst_ID=t4.cst_ID and t4.dt='@@{yyyyMMdd}'
;
--关联其他字段（主表）
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_08 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_08 AS
SElECT T1.*
    ,T2.ta_name --发行机构
    ,DECODE(T3.gdr_cd,'1','男','2','女','') gender
    ,if(T3.fm_ind='1','是','')              is_farm
    ,if(nvl(T3.own_emp_id,'')<>'','是','')  is_empe
    ,T4.cst_chn_nm                          cst_nm
    ,T5.empe_id
    ,T5.empe_nm                             sale_empe_nm
    ,T6.brc_org_nm
    ,T6.sbr_org_nm
    ,T7.credit_rsk_grd
    ,if(T8.efe_loan_cst_ind='1','是','')    efe_loan_cst_ind
    ,if(T8.efe_dep_cst_ind='1','是','')     efe_dep_cst_ind
    ,T9.aum_avg_360d
    ,T10.aum_bal TRX_aum_bal
    ,t11.trx_ncr_fnd_bal
FROM lab_bigdata_dev.SJXQ_SJ2024080626_CST_07   T1
left join edw.finc_tbtainfo                 T2 on t1.tacd=T2.ta_code  and T2.dt='@@{yyyyMMdd}'
left join edw.dim_cst_idv_bas_inf_dd        T3 on T1.cst_ID=T3.cst_id and T3.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd            T4 on T1.cst_ID=T4.cst_id and T4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            T5 on T1.sale_empe_id=T5.empe_id and T5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    T6 on T5.org_id=T6.org_id and T6.dt='@@{yyyyMMdd}'
left join (
    select cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt='@@{yyyyMMdd}'
) T7 on T1.CST_ID=T7.cst_id
left join adm_pub.adm_csm_cbas_ind_inf_dd           T8 on T1.CST_ID=T8.cst_id and T8.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T9 on T1.CST_ID=T9.cst_id and T9.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   T10
on T1.CST_ID=T10.cst_id and T1.trx_dt=T10.dt and T10.dt between '20240701' and '20240731'
left join (
    SELECT a.cst_id, a.dt, sum(A.TOT_AMT) trx_ncr_fnd_bal
    from edw.dim_bus_chm_fnd_act_lot_dtl_inf_dd a --基金账户份额信息
    inner join edw.dim_bus_chm_fnd_pd_inf_dd c on a.prod_cd = c.pd_cd and c.dt = '@@{yyyyMMdd}'
    WHERE a.dt between '20240701' and '20240731' and C.fnd_typ_cd<>'04' and A.TOT_AMT>0
    group by a.cst_id, a.dt
) t11 on T1.cst_ID=t11.cst_id and T1.trx_dt=t11.dt
;
--同一风险控制号客户
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_09 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_09 AS
select distinct a.cst_ID,trx_dt
    ,nvl(c.cst_id,a.cst_ID)             rel_cst_id
    ,nvl(c.cst_chn_nm,b.cst_chn_nm)     rel_cust_nm
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_08 a
left join edw.dws_cst_bas_inf_dd b
on a.cst_ID=b.cst_id
and b.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd c
on b.sam_rsk_ctrl_id=c.sam_rsk_ctrl_id
and c.dt='@@{yyyyMMdd}'
and NVL(c.sam_rsk_ctrl_id,'')<>''
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_09_1 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_09_1 AS
select t1.AHN_LTR_APLY_SERNO	--授用信申请流水号|C32
    ,t1.cst_id	--客户号|C20
    ,t1.cst_nm	--客户名称|C200
    ,t1.cst_typ_cd	--客户类型代码|C4
    ,t1.sam_rsk_ctrl_no	--同一风险控制号|C24
    ,t1.apl_dt	            REG_DT--申请日期|C8
    ,t1.exec_intr_rat	    --执行利率DECIMAL(13, 7)
    ,'' aprv_exe_mon_intr_rat --执行月利率 ???没找到
    ,t3.rul_set_rslt_cd
    ,c3.cd_val_dscr         rul_set_rslt_nm
    ,t3.PRE_ASES_SERNO	    --预评估流水号
    ,t4.HPN_TYP_CD	        --发生类型代码
    ,c4.cd_val_dscr         HPN_TYP
    ,'' ref_year_intr_rat --参考年利率
    ,'' intr_rat_adj_cmt
from edw.DWD_BUS_LOAN_LMT_APLY_INFO_DD	        t1 --授用信申请信息
left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd t3 --授信关联预评估信息表
on t1.AHN_LTR_APLY_SERNO = t3.usc_aply_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd               c3
on t3.rul_set_rslt_cd = c3.cd_val
and c3.dt = '@@{yyyyMMdd}'
left join edw.dwd_bus_loan_lmt_aply_biz_dd	    t4 --用信方案
on t1.AHN_LTR_APLY_SERNO=t4.usc_aply_serno	--用信申请流水号|C32
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD               c4 --码值表(发生类型)
ON      t4.HPN_TYP_CD = c4.CD_VAL                 --发生类型 码值
AND     c4.TBL_NM = 'DIM_BUS_LOAN_CTR_INF_DD'     -- DWD_BUS_LOAN_APL_INF_DD 该表码值表错误
AND     c4.FLD_NM = 'HPN_TYP_CD'
AND     c4.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
-- 前后5天贷款
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_10 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_10 AS
select a.cst_ID,trx_dt
    ,a.rel_cst_id,a.rel_cust_nm
    ,B.CTR_SERNO                         --合同流水号
    ,B.CTR_AMT                           --合同金额
    ,B.CTR_BAL                           --合同余额
    ,B.FACL_TRM                          --授信期限
    ,b.LOAN_BSS_INTR_RAT                    --基准利率
    ,B.EXEC_INTR_RAT                        --执行利率
    ,B.REF_INTR_RAT                         --参考月利率
    ,B.CPT_USG_CD                        --资金用途代码
    ,B.CPT_USG_RMK                       --用途备注
    ,case
        when b.PRD_TAG regexp '2021092200000001|2021072900000001|2020051500000003|2020051500000004|2020051500000002|2020041400000002|2020030900000003|2021092200000002|2020051800000005|2020042200000001|2020030900000001' --政策性贷款
        then '是' else '否' end is_zc_loan
    ,CASE SUBSTR(b.PRD_NO, 1, 9)
         WHEN '201050101' THEN '1'
         WHEN '201050102' THEN '2'
         WHEN '201040101' THEN '3'
         WHEN '201040102' THEN '4'
         ELSE '5' END              AS PRD_NO
    ,B.REL_SERNO                         --业务申请编号
    ,B.DT                                  --合同日期
    ,c.ref_year_intr_rat                   --参考年利率         ???没找到
    ,c.aprv_exe_mon_intr_rat               --执行月利率      ???没找到
    ,C.REG_DT                               --申请日期
    ,nvl(b.EXEC_INTR_RAT_PRFT_DTL,c.intr_rat_adj_cmt)  EXEC_INTR_RAT_PRFT_DTL --执行利率优惠详情
    ,ABS(DATEDIFF(TO_DATE(C.REG_DT, 'yyyyMMdd'), TO_DATE(A.trx_dt, 'yyyyMMdd'), 'dd')) AS DIFF_TM --贷款申请与交易间隔日期
    ,G.DTRB_DT                             --发放日期
    ,E.cd_val_dscr                       FIVE_CTG
    ,c.HPN_TYP
    ,c.rul_set_rslt_cd
    ,c.rul_set_rslt_nm
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_09   a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD    B --信贷合同信息
ON      A.rel_cst_id = B.CST_ID
AND     NVL(B.CST_ID,'') <> ''      --剔除空值和空
AND     B.RVLG_TYP_CD <> '1'        --剔除循环贷款
--普通贷款:-20105010100 个人消费性贷款 20105010200 个人经营性贷款 20104010100 流动资金贷款 20104010200 固定资产贷款 20104010600 法人购房贷款
AND     SUBSTR(B.PRD_NO, 1, 9) IN ( '201050101' , '201050102' , '201040101' , '201040102' , '201040106' )
AND     B.DT = '@@{yyyyMMdd}'
LEFT JOIN SJXQ_SJ2024080626_CST_09_1            c
on b.REL_SERNO=c.AHN_LTR_APLY_SERNO
left join edw.dwd_code_library_dd               E
on b.CUR_RSK_CTG_RSLT_CD=E.cd_val 	--当前风险分类结果代码
AND e.dt='@@{yyyyMMdd}'
LEFT JOIN (
    SELECT  CTR_SERNO ,MIN(LVE_ACT_BGN_DT) AS DTRB_DT  --最早发放日期
    FROM edw.DIM_BUS_LOAN_DBIL_INF_DD   --贷款借据信息汇总
    WHERE DT = '@@{yyyyMMdd}'
    GROUP BY CTR_SERNO
) G ON B.CTR_SERNO = G.CTR_SERNO
;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_11 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_11 AS
select cst_ID,trx_dt
    ,rel_cst_id
    ,rel_cust_nm
    ,CTR_SERNO                         --合同流水号
    ,CTR_AMT                             --合同金额
    ,LOAN_BSS_INTR_RAT                              --基准利率
    ,ref_year_intr_rat                   --参考年利率
    ,EXEC_INTR_RAT                            --执行利率
    ,REF_INTR_RAT                    --参考月利率
    ,aprv_exe_mon_intr_rat               --执行月利率
    ,REG_DT							 --申请日期
    ,DTRB_DT                             --发放日期
    ,FIVE_CTG
    ,rul_set_rslt_nm
    ,HPN_TYP
    ,CPT_USG_RMK
    ,EXEC_INTR_RAT_PRFT_DTL
    ,is_wfdk
    ,is_zc_loan
    ,lst_CTR_SERNO
    ,lst_CTR_AMT
    ,lst_INTR_RAT
    ,lst_aprv_exe_mon_intr_rat
    ,lst_REG_DT
    ,lst_DTRB_DT
from (
    select a.*
        ,b.CTR_SERNO            	lst_CTR_SERNO
        ,b.CTR_AMT                  lst_CTR_AMT
        ,b.EXEC_INTR_RAT            lst_INTR_RAT
        ,b.aprv_exe_mon_intr_rat    lst_aprv_exe_mon_intr_rat
        ,b.REG_DT                   lst_REG_DT
        ,b.DTRB_DT                  lst_DTRB_DT
        ,row_number() over(partition by a.cst_ID,a.trx_dt order by b.REG_DT desc) rn2
    from (
        select *,row_number() over(partition by cst_ID,trx_dt order by DIFF_TM asc) rn
        from lab_bigdata_dev.SJXQ_SJ2024080626_CST_10
        where DIFF_TM<=5
    ) a
    left join lab_bigdata_dev.SJXQ_SJ2024080626_CST_10 b on a.cst_ID=b.cst_ID and a.trx_dt=b.trx_dt
        and a.PRD_NO=b.PRD_NO and a.REG_DT>b.REG_DT
    where a.rn=1
) a
where rn2=1;
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_12 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024080626_CST_12 AS
select a.bus_type              业务类型
    ,a.trx_type                交易类型
    ,a.srl_nbr                 交易流水号
    ,a.trx_sts                 交易状态
    ,concat(a.trx_dt,' ',a.trx_tm) 申请日期
    ,a.cfm_dt                  确认日期
    ,a.trx_chnl                交易渠道
    ,a.trx_amt                 交易金额
    ,a.cfm_amt                 确认金额
    ,a.trx_lot                 交易份额
    ,a.cfm_lot                 确认份额
    ,a.sale_empe_id            销售人员工号
    ,a.sale_empe_nm            销售人员姓名
    ,a.brc_org_nm              所属分行
    ,a.sbr_org_nm              所属支行
    ,a.tatrx_act_nbr           交易账号
    ,a.pd_cd                   产品代码
    ,a.pd_nm                   产品名称
    ,a.ta_name                 发行机构
    ,a.prod_type               产品类型
    ,a.pd_rsk_grd              产品风险等级
    ,a.pfm_comp_bas            业绩比较基准
    ,a.pd_found_dt             产品扣款日
    ,a.pd_val_dt               产品起息日
    ,a.pd_end_dt               产品到期日
    ,a.CST_ID                  客户号
    ,a.cst_nm                  客户名称
    ,a.age                     客户年龄
    ,a.gender                  客户性别
    ,''                        客户手机号码
    ,a.rsk_lvl_cd                                           	客户当前风险测评结果
    ,decode(a.late_ases_dt,'18991231','',a.late_ases_dt)    	客户当前结果测评时间
    ,a.lst_rsk_lvl                                          	客户上一次风险测评结果
    ,decode(a.lst_rsk_ases_dt,'18991231','',a.lst_rsk_ases_dt)  客户上一次风险测评时间
    ,a.trx_rsk_lvl                                              客户交易日风险等级
    ,decode(a.trx_rsk_ases_dt,'18991231','',a.trx_rsk_ases_dt)  客户交易日风险测评时间
    ,a.is_farm								是否农户
    ,a.efe_loan_cst_ind                     是否信贷有效户
    ,a.efe_dep_cst_ind                      是否存款有效户
    ,a.is_empe                              是否行内员工
    ,a.aum_avg_360d                         客户近一年AUM
    ,a.trx_ncr_fnd_bal                      客户交易时非货基金保有量
    ,a.TRX_aum_bal                          客户交易时AUM
    ,if(b.cst_ID is not null,'是','') 		交易日前后5天内同一风险控制号下是否存在贷款
    ,b.rel_cust_nm                  		贷款客户名称
    ,c.loan_apl_credit_rsk_grd      		当前贷款申请时客户信用风险等级
    ,a.credit_rsk_grd               		当前客户信用风险等级
    ,b.CTR_SERNO                   		    当前笔贷款合同流水号
    ,b.reg_dt                       		当前笔贷款申请日期
    ,b.DTRB_DT                      		当前笔贷款发放日期
    ,b.CTR_AMT                      		当前笔贷款金额
    ,ref_year_intr_rat              		当前笔贷款参考年利率
    ,EXEC_INTR_RAT                       	当前笔贷款执行年利率
    ,aprv_exe_mon_intr_rat          		当前笔贷款执行月利率
    ,b.rul_set_rslt_nm                 		当前笔贷款预审批结果
    ,b.FIVE_CTG                     		当前笔贷款五级分类
    ,b.HPN_TYP                      		贷款类型
    ,b.is_zc_loan                   		是否为政策性贷款
    ,b.is_wfdk                      		是否为接力贷
    ,b.EXEC_INTR_RAT_PRFT_DTL               执行利率优惠详情
    ,b.CPT_USG_RMK                      	资金用途备注
    ,b.lst_CTR_SERNO              		    上一笔贷款合同流水号
    ,b.lst_CTR_AMT                  		上一笔贷款合同金额
    ,b.lst_INTR_RAT                 		上一笔贷款执行年利率
    ,b.lst_aprv_exe_mon_intr_rat    		上一笔贷款执行月利率
    ,b.lst_DTRB_DT                   		上一笔贷款发放日期
from lab_bigdata_dev.SJXQ_SJ2024080626_CST_08       a
left join lab_bigdata_dev.SJXQ_SJ2024080626_CST_11  b
on a.cst_ID=b.cst_ID
and a.trx_dt=b.trx_dt
left join (
    select distinct dt,cst_id,decode(risk_level,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险') loan_apl_credit_rsk_grd
    from app_rpt.INTER_BATCH_HIGH_RISK_LST_IDV_DLM_ALL
    where dt<='@@{yyyyMMdd}'
) c on b.rel_cst_id=c.cst_id
and b.reg_dt=c.dt
;
SELECT * FROM SJXQ_SJ2024080626_CST_12
/*
问题：1. aprv_exe_mon_intr_rat --执行月利率 没找到，好像废弃了
2. ref_year_intr_rat --参考年利率
intr_rat_adj_cmt	--利率调整备注
这两个字段在 LMT_BIZ_INTR_RAT	利率信息表 中，不知道咋关联
-- 以下 利率信息 的字段不知道咋关联？？？
-- ref_year_intr_rat --参考年利率
-- LMT_BIZ_INTR_RAT	利率信息	REF_INTR_RAT	参考利率
-- intr_rat_adj_cmt
-- LMT_BIZ_INTR_RAT	利率信息	EXEC_INTR_RAT_PRFT_DTL	执行利率优惠详情
*/
***SJ2024080641_苏州分行大额征信负债客户.sql
-- SJ2024080641：截至7月末，苏州分行有信贷业务的客户中
-- 其个人和同一风险控制号下主体的征信中负债达到1亿元的客户编号和姓名、管户机构、我行授信金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024080641_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080641_CST_01 AS
select t1.cst_id                                 --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t4.brc_org_nm,t4.org_nm
    ,sum(t1.ctr_amt)  as  ctr_amt                --合同金额DECIMAL(21,2)
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm = '苏州分行'
where t1.dt='20240731'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
group by t4.brc_org_nm,t4.org_nm,t1.cst_id,t1.cst_nm
;
-- 新征信表 征信汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080641_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080641_CST_01_1 AS
SElECT cst_id,cred_total_amt,cred_total_balan
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
union
SElECT cst_id,cred_total_amt,cred_total_balan
from edw.dws_cst_ccrc_entp_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
;
-- 客户（包括对公对私）的征信负债大于等于1个亿
DROP   TABLE IF     EXISTS SJXQ_SJ2024080641_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080641_CST_02 AS
SELECT  t1.cst_id  AS 客户号
       ,t1.cst_nm  AS 客户名称
       ,t1.org_nm  AS 管户机构
       ,t1.ctr_amt AS 我行授信金额
       ,t2.cred_total_amt   as 征信授信总额
       ,t2.cred_total_balan as 征信授信余额
from SJXQ_SJ2024080641_CST_01               t1
inner join SJXQ_SJ2024080641_CST_01_1	    t2 --个人+对公征信指标信息表
on t1.cst_id=t2.cst_id
and t2.cred_total_balan>=100000000	--授信余额（信用总余额）
;
-- 客户同一风险控制号中所有客户的征信负债总和大于等于1个亿
DROP   TABLE IF     EXISTS SJXQ_SJ2024080641_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080641_CST_03 AS
select t1.cst_id
    ,case when nvl(t2.sam_rsk_ctrl_id,'')<>'' then t2.sam_rsk_ctrl_id else t2.cst_id end sam_rsk_cst_id
    ,count(distinct t3.cst_id)  sam_rsk_custs
    ,sum(t4.cred_total_balan)   cred_total_balan
from(
    select distinct cst_id
    from SJXQ_SJ2024080641_CST_01
)t1 left join edw.dws_cst_bas_inf_dd t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20240731'
left join edw.dws_cst_bas_inf_dd    t3
on case when nvl(t2.sam_rsk_ctrl_id,'')<>'' then t2.sam_rsk_ctrl_id else t2.cst_id end
    = case when nvl(t3.sam_rsk_ctrl_id,'')<>'' then t3.sam_rsk_ctrl_id else t3.cst_id end
and t3.dt='20240731'
left join SJXQ_SJ2024080641_CST_01_1	t4 --个人+对公征信指标信息表
on t1.cst_id=t4.cst_id
group by t1.cst_id,sam_rsk_cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080641_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080641_CST_04 AS
SELECT  t1.cst_id  AS 客户号
       ,t1.cst_nm  AS 客户名称
       ,t1.org_nm  AS 管户机构
       ,t1.ctr_amt AS 我行授信金额
       ,t2.cred_total_amt   as 同一风险控制号下征信授信总额
       ,t2.cred_total_balan as 同一风险控制号下征信授信余额
from SJXQ_SJ2024080641_CST_01           t1
inner join SJXQ_SJ2024080641_CST_03	    t2 --个人征信指标信息表
on t1.cst_id=t2.cst_id
and t2.cred_total_balan>=100000000	--授信余额（信用总余额）
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080641_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024080641_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080641_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024080641_CST_04
***SJ20240807101_抵押物信息.sql
-- 担保物编号     GUARANTYTYPE     GUARANTYSTATUS     权属人编号     OWNERNAME
-- 2021101800001590     C010101     02     1668939638     徐文江
DROP   TABLE IF     EXISTS SJXQ_SJ20240807101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240807101_CST_01 AS
SELECT  col_1 AS guarantyid
       ,col_2 AS GUARANTYTYPE
       ,col_3 AS GUARANTYSTATUS
       ,col_4 AS 权属人编号
       ,col_5 AS OWNERNAME
from
where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240807101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240807101_CST_02 AS
SELECT  t1.guarantyid   AS 担保物编号
        ,t1.GUARANTYTYPE
        ,t1.GUARANTYSTATUS
        ,t1.权属人编号
        ,t1.OWNERNAME
       ,t2.dtl_lct      AS 详细坐落位置
       ,t2.mort_area    AS 抵押面积
       ,t3.ases_dt      AS 评估日期
       ,t3.ases_vld_prd AS 评估有效期
       ,t3.id_val       AS 认定价值
       ,t3.ases_val     AS 评估价值_20240630
from SJXQ_SJ20240807101_CST_01                  t1
left join edw.DIM_BUS_LOAN_CLTR_PRPT_SPCL_DD    t2
on t1.guarantyid=t2.CLTR_NO
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_bus_grnt_cltr_inf_dd          t3
on t1.guarantyid=t3.cltr_id	            --押品编号|C32
and t3.dt='20240630'
;
SElECT '01' seq, count(1) cnt,count(distinct guarantyid) custs
from SJXQ_SJ20240807101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 担保物编号) custs
from SJXQ_SJ20240807101_CST_02
***SJ20240807101_抵押物信息_new.sql
﻿--郑云飞-取担保物信息
--SJ20240807101
--qbi_file_20240808_10_04_42
-- 担保物编号     GUARANTYTYPE     GUARANTYSTATUS     权属人编号     OWNERNAME
-- 2021101800001590     C010101     02     1668939638     徐文江
DROP   TABLE IF     EXISTS SJXQ_SJ20240807101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240807101_CST_01 AS
SELECT  col_1 AS guarantyid
       ,col_2 AS GUARANTYTYPE
       ,col_3 AS GUARANTYSTATUS
       ,col_4 AS 权属人编号
       ,col_5 AS OWNERNAME
from  qbi_file_20240808_10_04_42
where pt<>''
;
DROP TABLE IF EXISTS SJXQ_SJ20240807101_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240807101_CST_02 AS
SELECT  t1.guarantyid    AS 担保物编号
        ,t1.GUARANTYTYPE
        ,t1.GUARANTYSTATUS
        ,t1.权属人编号
        ,t1.OWNERNAME
        ,t2.dtl_lct      AS 详细坐落位置
        ,t2.bld_area     AS 建筑面积
        ,t3.ases_dt      AS 评估日期
        ,t3.ases_vld_prd AS 评估有效期
        ,t3.id_val       AS 认定价值
        ,t3.ases_val     AS 评估价值_20240630
FROM    SJXQ_SJ20240807101_CST_01 t1
LEFT JOIN    (
                 SELECT  CLTR_NO --AS 押品编号
                         ,dtl_lct --AS 详细坐落位置
                         ,bld_area --AS 建筑面积
                 FROM    edw.DIM_BUS_LOAN_CLTR_PRPT_SPCL_DD
                 WHERE   CLTR_NO IN (
                                        SELECT  guarantyid
                                        FROM    SJXQ_SJ20240807101_CST_01
                                    )
                 AND     dt = '@@{yyyyMMdd}'
                 UNION
                 SELECT  CLTR_NO --AS 押品编号
                         ,dtl_lct --AS 详细坐落位置
                         ,bld_area --AS 建筑面积
                 FROM    edw.DIM_BUS_LOAN_CLTR_CMRC_PRPT_SPCL_DD
                 WHERE   CLTR_NO IN (
                                        SELECT  guarantyid
                                        FROM    SJXQ_SJ20240807101_CST_01
                                    )
                 AND     dt = '@@{yyyyMMdd}'
                 UNION
                 SELECT  CLTR_NO --AS 押品编号
                         ,dtl_lct --AS 详细坐落位置
                         ,bld_area --AS 建筑面积
                 FROM    edw.DIM_BUS_LOAN_CLTR_PLT_WHS_SPCL_DD
                 WHERE   CLTR_NO IN (
                                        SELECT  guarantyid
                                        FROM    SJXQ_SJ20240807101_CST_01
                                    )
                 AND     dt = '@@{yyyyMMdd}'
             ) t2
ON      t1.guarantyid = t2.CLTR_NO
LEFT JOIN    edw.dim_bus_grnt_cltr_inf_dd t3
ON      t1.guarantyid = t3.cltr_id --押品编号|C32
AND     t3.dt = '20240630';
***SJ2024080711_苏州分行前十授信客户.sql
-- SJ2024080711 ：7月末，苏州分行前十大授信客户的名字、授信金额、用信金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024080711_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080711_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t4.brc_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
-- LEFT JOIN EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD   t2 --合同其它明细信息
-- ON      t1.CTR_SERNO = t2.CTR_SERNO
-- AND     t2.dt = '20240731'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm = '苏州分行'
where t1.dt='20240731'
-- AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
-- AND     ( t2.APLY_CHNL_CD <> 'L08' OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
-- AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
-- AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
-- AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' ) OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024080711_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080711_CST_02 AS
SELECT  brc_org_nm   AS 管户分行
       ,cst_id       AS 客户号
       ,cst_nm       AS 客户名称
       ,SUM(ctr_amt) AS 授信金额
       ,SUM(ctr_bal) AS 用信余额
from SJXQ_SJ2024080711_CST_01
group by brc_org_nm,cst_id,cst_nm
;
--结果表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080711_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080711_CST_03 AS
SELECT 管户分行
       ,客户号
       ,客户名称
       ,授信金额
       ,用信余额
from SJXQ_SJ2024080711_CST_02
order by 授信金额 desc
limit 10
***SJ2024080771_杭州分行信贷担保数据.sql
-- 主表 杭州分行 所有 未到期未终结 合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024080771_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080771_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称0
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,case when t1.ovd_amt<>0 then '是' else '否' end is_ovd	--逾期金额
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名0
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '杭州分行'
where t1.dt='@@{yyyyMMdd}'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 担保信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024080771_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080771_CST_02 AS
select t1.ctr_serno
    ,t2.grnt_ctr_id	    --担保合同编号
    ,t2.grnt_typ_cd	    --担保类型代码
    ,c1.cd_val_dscr     grnt_typ_nm
    ,t2.grnt_tot_amt	--担保总金额
    ,case when t3.cst_id is not null then '是' else '否' end as 是否公司担保
    ,t3.cst_nm as 公司名称
	,t4.grnt_ctr_no                              --担保合同编号
	,t4.grnt_ctr_typ_cd                          --担保合同类型代码|C3
	,t4.wrat_cst_id                              --被担保人客户号
	,t4.wrat_nm                                  --被担保人名称0
	,t4.grnt_mod_cd                              --担保方式代码|C3
	,t4.grnt_ctr_amt                             --担保合同金额
	,t4.grnt_ctr_bgn_dt                          --担保合同起始日期|C8
	,t4.grnt_ctr_mtu_dt                          --担保合同到期日期|C8
from SJXQ_SJ2024080771_CST_01               t1
left join edw.dws_bus_grnt_prsn_inf_dd      t2 --担保人汇总信息
on t1.ctr_serno = t2.bus_ctr_id
and t2.dt = '@@{yyyyMMdd}'
left join edw.dim_cst_entp_bas_inf_dd       t3 --企业客户基本信息
on t2.wrnt_cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.DIM_BUS_LOAN_CTR_GRNT_INF_DD	t4 --担保合同信息
on t2.grnt_ctr_id=t4.grnt_ctr_no
and t4.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd  c1
on t2.grnt_typ_cd = c1.cd_val
and c1.dt = '20220504'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080771_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080771_CST_03 AS
SELECT  t1.ctr_serno                AS 合同号
       ,t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,t1.ctr_bgn_dt               AS 合同起始日期
       ,t1.ctr_mtu_dt               AS 合同到期日期
       ,t1.TMT_DT                   AS 终结日期
       ,t1.is_ovd                   AS 是否逾期
       ,concat(t1.mgr_id,t1.mgr_nm) AS 管户人
       ,t1.org_nm                   AS 管户机构
       ,t2.grnt_typ_nm              AS 担保类型
       ,t2.grnt_ctr_amt             AS 担保合同金额
       ,t2.grnt_ctr_bgn_dt          AS 担保合同起始日期
       ,t2.grnt_ctr_mtu_dt          AS 担保合同到期日期
from SJXQ_SJ2024080771_CST_01       t1
inner join SJXQ_SJ2024080771_CST_02 t2
on t1.ctr_serno=t2.ctr_serno
and t2.是否公司担保 = '是'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024080771_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024080771_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2024080771_CST_03
***SJ2024080771_杭州分行信贷担保数据_mod.sql
﻿--王菲梵023606-杭州分行所有未结清信贷业务中涉及公司担保的数据
--SJ2024080771
--截至8月份，杭州分行所有未结清信贷业务中，涉及公司担保的数据。
--目前有效的所有公司担保业务，包括被担保债务人名称、客户号；被担保主合同金额、有效期、是否逾期；担保类型、担保合同金额、担保合同有效期；管护情况
/*20240816
加上质押、抵押
加字段：管户支行、担保公司名称、担保客户号
*/
-- 主表 杭州分行 所有 未到期未终结 合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024080771_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080771_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称0
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,case when t1.ovd_amt<>0 then '是' else '否' end is_ovd	--逾期金额
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名0
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '杭州分行'
where t1.dt='@@{yyyyMMdd}'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 担保信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024080771_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080771_CST_02 AS
select t1.cst_id,t1.ctr_serno
    ,t2.GRNT_CTR_NO	    --担保合同编号
	,t3.grnt_ctr_typ_cd                          --担保合同类型代码|C3
	,t3.wrat_cst_id                              --被担保人客户号
	,t3.wrat_nm                                  --被担保人名称
	,t3.grnt_mod_cd                              --担保类型
    ,c1.cd_val_dscr     grnt_typ_nm
	,t3.grnt_ctr_amt                             --担保合同金额
	,t3.grnt_ctr_bgn_dt                          --担保合同起始日期|C8
	,t3.grnt_ctr_mtu_dt                          --担保合同到期日期|C8
    ,nvl(t4.GTOR_NO,t6.OBG_ID) as GTOR_NO	                                    --保证人编号|C20
    ,nvl(t4.GTOR_NM,t6.OBG_NM) as GTOR_NM	                                    --保证人名称|C200
    ,t4.WITH_BRWR_REL	                            --与借款人关系
    ,t4.EFF_STS_CD	                                --生效状态代码
    ,case when t5.cst_id is not null then '是' else '否' end as 是否公司担保
    ,t6.OBG_ID	--权利人编号|C20
    ,t6.OBG_NM	--权利人名称|C200
from SJXQ_SJ2024080771_CST_01               t1
left join(
    SElECT distinct CTR_SERNO,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '@@{yyyyMMdd}'
) t2 on t1.ctr_serno = t2.CTR_SERNO
left join edw.DIM_BUS_LOAN_CTR_GRNT_INF_DD	t3 --担保合同信息
on t2.GRNT_CTR_NO=t3.grnt_ctr_no
and t3.dt='@@{yyyyMMdd}'
left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t4 --担保合同保证人信息
on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
and t4.dt='@@{yyyyMMdd}'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='@@{yyyyMMdd}'
) t6 on t2.GRNT_CTR_NO=t6.GRNT_CTR_NO
left join edw.dim_cst_entp_bas_inf_dd       t5 --企业客户基本信息
on nvl(t4.GTOR_NO,t6.OBG_ID) = t5.cst_id
and t5.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd  c1
on t3.grnt_mod_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080771_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080771_CST_03 AS
SELECT  t1.ctr_serno                AS 合同号
       ,t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,t1.ctr_bgn_dt               AS 合同起始日期
       ,t1.ctr_mtu_dt               AS 合同到期日期
       ,t1.TMT_DT                   AS 终结日期
       ,t1.is_ovd                   AS 是否逾期
       ,concat(t1.mgr_id,t1.mgr_nm) AS 管户人
       ,t1.org_nm                   AS 管户机构
       ,t1.sbr_org_nm               as 管户支行
       ,t2.grnt_typ_nm              AS 担保类型
       ,t2.grnt_ctr_amt             AS 担保合同金额
       ,t2.grnt_ctr_bgn_dt          AS 担保合同起始日期
       ,t2.grnt_ctr_mtu_dt          AS 担保合同到期日期
       ,t2.GTOR_NO   as 担保公司客户号
       ,t2.GTOR_NM   as 担保公司名称
from SJXQ_SJ2024080771_CST_01       t1
inner join SJXQ_SJ2024080771_CST_02 t2
on t1.ctr_serno=t2.ctr_serno
and t2.是否公司担保 = '是'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024080771_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024080771_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2024080771_CST_03
***SJ2024080926_泰e贷资质人员.sql
--有泰e贷资质的人员名单
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_01 AS
select distinct a.empe_id,a.empe_nm
FROM    edw.dws_hr_empe_inf_dd                  a
INNER JOIN    edw.dim_hr_empe_mgr_qua_inf_dd    b -- 客户经理资质信息
ON      b.empe_id = a.empe_id
AND     b.vld_sts_cd = '1' -- 1最新状态
AND     b.sts_cd = '1' -- 1启用
AND     b.qua_sub_cls_cd = '0070001' -- 资质子类
AND     b.dt = '@@{yyyyMMdd}'
where   a.dt = '@@{yyyyMMdd}'
AND     a.org_id LIKE '3305%' --温州分行
;
-- 线上业务熔断信息明细表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_02 AS
SELECT  t2.empe_id      --客户经理工号
       ,t2.empe_nm     --客户经理姓名
       ,t2.join_cmp_dt AS 入行日期
       ,'是'            AS 是否有泰e贷2资质
FROM    edw.loan_online_fuse_info   t1
INNER JOIN   edw.dws_hr_empe_inf_dd t2
ON      t1.userid = t2.empe_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.org_id LIKE '3305%'      --温州分行
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.notdefusereason = '02'   --解熔断
AND     t1.subtype = '060040'       --泰e贷2.0
;
--用户资质表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_03 AS
SELECT  user_code         AS empe_id
       ,org_id            AS 信贷所属机构编号
       ,qualf_typ         AS 资质类型
       ,qualf_sub_clss    AS 资质子类
       ,tmp_qualf_ind     AS 是否临时资质
       ,qualf_obsv_mtu_dt AS 资质观察期到期日期
       ,qualf_sts         AS 资质状态
where edw.loan_tlcb_usr_qualf_info  --用户资质表
where dt='@@{yyyyMMdd}'
and org_id LIKE '3305%' --温州分行
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_04 AS
SELECT  empe_id AS 客户经理工号
       ,empe_nm AS 客户经理姓名
from SJXQ_SJ2024080926_CST_01
union
SElECT empe_id
    ,empe_nm
from SJXQ_SJ2024080926_CST_02
;
SElECT '01' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ2024080926_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ2024080926_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ2024080926_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户经理工号) custs
from SJXQ_SJ2024080926_CST_04
***SJ2024080926_泰e贷资质人员_mod.sql
﻿--潘滔017696-泰e贷资质
--SJ2024080926
--温州分行泰e贷1.0、2.0人员清单
/*
--有泰e贷资质的人员名单 授予泰e贷业务权限 2024年无数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_01 AS
select distinct a.empe_id,a.empe_nm
FROM    edw.dws_hr_empe_inf_dd                  a
INNER JOIN    edw.dim_hr_empe_mgr_qua_inf_dd    b -- 客户经理资质信息
ON      b.empe_id = a.empe_id
--AND     b.vld_sts_cd = '1' -- 1最新状态
AND     b.sts_cd = '1' -- 1启用
AND     b.qua_sub_cls_cd = '0070001' -- 资质子类 0070001 授予泰e贷业务权限
AND     b.dt = '20240810'
where   a.dt = '20240810'
AND     a.org_id LIKE '3305%' --温州分行
;
SELECT *
FROM edw.dwd_code_library_dd
WHERE dt= '@@{yyyyMMdd}'
-- 线上业务熔断信息明细表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_02 AS
SELECT  t2.empe_id      --客户经理工号
       ,t2.empe_nm     --客户经理姓名
       ,t2.join_cmp_dt AS 入行日期
       ,'是'            AS 是否有泰e贷2资质
FROM    edw.loan_online_fuse_info   t1
INNER JOIN   edw.dws_hr_empe_inf_dd t2
ON      t1.userid = t2.empe_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.org_id LIKE '3305%'      --温州分行
WHERE   t1.dt = '20240719'
AND     t1.notdefusereason = '02'   --解熔断
AND     t1.subtype = '060040'       --泰e贷2.0
;
*/
--用户资质表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080926_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_03 AS
SELECT  user_code         AS empe_id
       ,org_id            AS 信贷所属机构编号
       ,qualf_typ         AS 资质类型
       ,qualf_sub_clss    AS 资质子类 -- 只有 一级到六级 调查资质
       ,tmp_qualf_ind     AS 是否临时资质
       ,qualf_obsv_mtu_dt AS 资质观察期到期日期
       ,qualf_sts         AS 资质状态
       ,frbd_mod_no	as	禁用模式编码
       ,case when frbd_mod_no regexp '01' and frbd_mod_no regexp '02'
                    and frbd_mod_no regexp '04' and frbd_mod_no regexp '06' then 'no_1_2'
            when frbd_mod_no regexp '01' and frbd_mod_no regexp '02' then 'no_1'
            when  frbd_mod_no regexp '04' and frbd_mod_no regexp '06' then 'no_2'
            when  frbd_mod_no regexp '01' then 'only01'
            when  frbd_mod_no regexp '02' then 'only02'
            when  frbd_mod_no regexp '04' then 'only04'
            when  frbd_mod_no regexp '06' then 'only06' else '' end frbd_mod_cls
from edw.loan_tlcb_usr_qualf_info  --用户资质表
where dt='@@{yyyyMMdd}'
and org_id LIKE '3305%' --温州分行
;
/*
01     人工预授信-单户
02     人工预授信-批量
04     面对面单户
06     面对面团办
05     自然流量-单户
09     预先跑批-新场景
07     自然流量-团办
08     预先跑批-存量
03     普通业务申请
*/
-- 输出结果 DROP TABLE IF EXISTS SJXQ_SJ2024080926_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080926_CST_04 AS
SELECT  t1.empe_id AS 客户经理工号
       ,t2.empe_nm AS 客户经理姓名
       ,t1.禁用模式编码
       ,CASE WHEN frbd_mod_cls = '' THEN '有泰e贷1和2'
             WHEN frbd_mod_cls = 'no_1' THEN '没有泰e贷1'
             WHEN frbd_mod_cls = 'no_2' THEN '没有泰e贷2'
             WHEN frbd_mod_cls = 'no_1_2' THEN '没有泰e贷'  ELSE '' END 资质类型
FROM SJXQ_SJ2024080926_CST_03       t1
INNER JOIN edw.dws_hr_empe_inf_dd   t2
ON t1.empe_id = t2.empe_id
AND t2.dt = '@@{yyyyMMdd}'
;
-- SElECT '01' seq, count(1) cnt,count(distinct empe_id) custs
-- from SJXQ_SJ2024080926_CST_01
-- union all
-- SElECT '02' seq, count(1) cnt,count(distinct empe_id) custs
-- from SJXQ_SJ2024080926_CST_02
-- union all
SElECT '03' seq, count(1) cnt,count(distinct empe_id) custs
from SJXQ_SJ2024080926_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户经理工号) custs
from SJXQ_SJ2024080926_CST_04
;
***SJ2024080936_鹿城支行全量个人清单.sql
--截止8.9日 鹿城支行
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024080936_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080936_CST_01 AS
select distinct  T1.cst_id      -- 客户号
    ,t1.cst_act_id              --  客户账号
    ,t1.act_nm           as   账户名称
    ,A1.cd_val_dscr      as   性别
    ,t2.age              as   年龄
    ,t4.sbr_org_id       as   客户账号支行层级机构编号
    ,t4.sbr_org_nm       as   客户账号支行层级机构名称
    ,t4_1.sbr_org_id     as   存款账号支行层级机构编号
    ,t4_1.sbr_org_nm     as   存款账号支行层级机构名称
    ,t4_1.org_nm            as 开户机构名称
    ,A2.cd_val_dscr      as   职业
    ,t1.cd_val_dscr      as   存款账号状态代码
    ,t1.opn_dt           as   存款账号开户日期
    ,t1.act_dstr_act_dt  as   存款账号销户日期
    ,t1.opn_org         as 开户机构编号
    ,A3.cd_val_dscr      as   客户账号账户状态
    ,t3.opn_dt           as   客户账号开户日期
    ,t3.dstr_act_dt      as   客户账号销户日期
    ,case when T12.cst_act_id is not null then '是' else '否' end  as 是否关闭非柜面
    ,T12.lmt_cmt     as  关闭非柜面原因
    ,t12.lmt_eft_dt  as  关闭非柜面日期
    ,case when T11.cst_act_id is not null then '是' else '否' end  as 是否止付
    ,T11.frz_dt      AS  止付日期
    ,T11.act_stop_pmt_typ_cd   AS  止付类型代码
    ,a11.cd_val_dscr     AS    止付类型
    ,T11.frz_cls_cd   AS  止付种类代码
    ,A8.cd_val_dscr   as  止付种类
    ,T11.frz_rsn      as  止付原因
    ,T5.mgr_id        as  存款管户客户经理编号
    ,T6.empe_nm       as  存款管户客户经理名称
    ,t5.acs_org_id      as 存款管户客户经理考核支行编号
    ,t9.sbr_org_nm      as 存款管户客户经理考核支行名称
    ,T8.ACCP_DT       as  调额日期
    ,t7.cur_year_ftp_inc   AS  当年FTP利润收入
    ,t7.last_12_mon_own_ftp_ctb	as	近12个月我行综合FTP贡献
    ,t2.job_unt_nm    as   工作单位名称
    ,CASE  WHEN  T18.kehuhaoo  is null or  T18.kehuhaoo ='' THEN  '否'
                else  '是'  end AS  新柜面标签是否工资户
FROM
(
SELECT  distinct t1.cst_id --客户号
       ,t1.dep_act_id      --存款账号
       ,t1.cst_act_id      --客户账号
       ,t1.act_nm          --账户名称
       ,t2.cd_val_dscr     --存款账户状态代码
       ,t1.opn_dt          --开户日期
       ,t1.act_dstr_act_dt --销户日期
       ,t1.opn_org         --开户机构编号
	FROM edw.dws_bus_dep_act_inf_dd t1 -- 存款账户信息汇总
	LEFT JOIN
	(
		SELECT  cd_val
		       ,cd_val_dscr
		FROM edw.dwd_code_library_dd
		WHERE dt = '@@{yyyyMMdd}'
		AND fld_nm = 'ACT_STS_CD'
		AND tbl_nm = 'DWS_BUS_DEP_ACT_INF_DD'
	) t2
	ON t1.act_sts_cd = t2.cd_val
	WHERE t1.STL_ACT_IND = '1' --结算账户
	AND t1.DT = '@@{yyyyMMdd}'
	AND t1.opn_org LIKE '3305013%' --温州鹿城小微专营支行
	AND t1.cst_tp = '1'
) T1
left join  adm_pub.adm_csm_cbas_idv_bas_inf_dd  T2   --客户集市-客户基础-对私客户基础信息
ON  T1.cst_id =T2.cst_id
and T2.dt='@@{yyyyMMdd}'
left join (
    select  distinct cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='GDR_CD'
    --and     tbl_nm='ADM_CSM_CBAS_IDV_BAS_INF_DD'
) A1  on   T2.gdr_cd=A1.cd_val
left join (
    select  distinct cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='OCP_CD'
    --and    tbl_nm='ADM_CSM_CBAS_IDV_BAS_INF_DD'
) A2 on   T2.ocp_cd=A2.cd_val
left join  edw.dim_bus_dep_cst_act_inf_dd   t3  --客户存款账户信息
on t1.cst_act_id = t3.cst_act_id
and t3.dt = '@@{yyyyMMdd}'
and t3.dstr_act_dt <> '18991231'
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='ACT_STS_CD'
    and    tbl_nm='DIM_BUS_DEP_CST_ACT_INF_DD'
) A3  on  t3.act_sts_cd = A3.cd_val
left join edw.dim_hr_org_mng_org_tree_dd   t4     --机构树_考核维度
on t3.opn_org_id =  t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd   t4_1     --机构树_考核维度
on t1.opn_org =  t4_1.org_id
and t4_1.dt = '@@{yyyyMMdd}'
left join  ( SELECT a1.*
			 from
                 (SELECT  *,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
                  FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                  WHERE   DT = '@@{yyyyMMdd}'
                  AND     NFRZ_IND = '0'  ) a1
                  where   a1.rn=1
             ) T11        --账户冻结登记
on T1.cst_act_id=T11.cst_act_id
left join (select *
          from edw.dwd_code_library_dd
          where dt='@@{yyyyMMdd}'
          and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
          and fld_nm='FRZ_CLS_CD'
          ) A8
    on T11.frz_cls_cd=A8.cd_val
left  JOIN  (
    select cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where  dt='@@{yyyyMMdd}'
    AND    fld_nm='ACT_STOP_PMT_TYP_CD'
    AND    tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
    ) a11   on T11.ACT_STOP_PMT_TYP_CD=a11.cd_val
left join ( SELECT c1.*
		    from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
                 FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     ACT_THRS_TYP = '2'      --暂停非柜面
				 and evt_id='DPDRAW') c1 where c1.rn=1
             ) T12 --账户额度控制
on     T1.cst_act_id=T12.cst_act_id
left JOIN  edw.dwd_bus_dep_cst_act_mgr_inf_dd    T5     --客户存款账户管护信息
 ON  T1.cst_act_id =T5.cst_act_id
 and T5.dt='@@{yyyyMMdd}'
 and T5.frs_ctc_ind = '1'
left join  edw.dws_hr_empe_inf_dd          T6        --员工汇总信息
  ON  T5.mgr_id=T6.empe_id     and  T6.dt='@@{yyyyMMdd}'
left  join adm_pub.adm_csm_cbus_ftp_inf_dd   t7
on   t1.cst_id = t7.cst_id
and  T7.dt='@@{yyyyMMdd}'
left JOIN (
    select ACCT_NO
          ,ACCP_DT
          ,channel_code
          ,row_number() over(partition by ACCT_NO order by ACCP_DT desc)  as rn
    from  edw.qdrh_aecip_rmc_modifylimitflow    --非柜面限额维护登记表
    where dt >= '20200101'
    and MAINTAIN_TYPE='1'
)  T8
on   T1.cst_act_id=T8.ACCT_NO
and  T8.rn=1
left join edw.dim_hr_org_mng_org_tree_dd    t9 --考核机构树
on  t5.acs_org_id=t9.org_id
and t9.dt='@@{yyyyMMdd}'
left join  edw.core_kcpb_zhbzxx   T18    --账户备注信息
ON  T1.cst_id = T18.kehuhaoo
and  T18.dt='@@{yyyyMMdd}'
;
-- 非柜面渠道 日转出金额总和 日转出金额最大值 使用笔数出账 使用笔数入账
DROP   TABLE IF     EXISTS SJXQ_SJ2024080936_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080936_CST_02 AS
SELECT   b.trx_year,B.cst_act_id,B.dep_act_id
        ,sum(trx_amt_sum_day)    as trx_amt_sum_D_days
        ,MAX(trx_amt_sum_day)    AS trx_amt_sum_max        --T21.trx_amt_sum_max
        ,SUM(dtl_seq_nbr_D_day)  as dtl_seq_nbr_D_days     --T21.dtl_seq_nbr_D_days
        ,SUM(dtl_seq_nbr_C_day)  as dtl_seq_nbr_C_days     --T21.dtl_seq_nbr_C_days
FROM    (
            SELECT   substr(a.dt,1,4) trx_year,A.cst_act_id
                    ,A.dep_act_id
                    ,A.trx_dt
                    ,sum(case when A.crd_and_dbt_ind = 'D' then trx_amt else 0 end )         as trx_amt_sum_day
                    ,sum(case when A.crd_and_dbt_ind = 'D' then 1       else 0 end )         as dtl_seq_nbr_D_day
                    ,sum(case when A.crd_and_dbt_ind = 'C' then 1       else 0 end )         as dtl_seq_nbr_C_day
            FROM    edw.DWD_BUS_DEP_BAL_CHG_DTL_DI A --存款账户余额发生明细
            WHERE   A.dt >= '20220101'
            AND     A.dt <= '@@{yyyyMMdd}'
            AND     A.TRX_CHNL_CD NOT IN ( 'A01' , 'M08' , 'C03' , 'C10' )
            AND     A.int_trx_no NOT IN ( 'dp2265' , 'dp2101' , 'dp15' )
            AND     A.txt_code NOT IN ( 'LQSF01' , 'SBKF01' , 'BA0004' , 'FD0001' , 'FD0002' , 'FD0003' , 'FD0004' , 'FD0005' , 'FD0010' , 'FD0011' , 'FD0012' , 'FD0013' , 'FD0014' , 'FD0015' , 'FD0016' , 'FD0017' , 'FD0018' , 'FD0019' , 'LC0009' , 'LN0002' , 'LN0003' , 'LN0004' , 'THKHK1' , 'XE1207' , 'XYKHK1' , 'YL0035' , 'TY0033' )
            AND     A.smr_dscr NOT REGEXP '代发|代扣'
            AND     A.bal_fld_nm = 'DPLDGBAL'
            GROUP BY trx_year,A.cst_act_id , A.dep_act_id , A.trx_dt
        ) B
GROUP BY b.trx_year,B.cst_act_id , B.dep_act_id
;
--主表2
DROP   TABLE IF     EXISTS SJXQ_SJ2024080936_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080936_CST_03 AS
SELECT  DISTINCT
        T1.cst_id     -- 客户号
    ,T1.cst_act_id    -- 客户账号
    ,T1.dep_act_id    -- 存款账号
    ,T1.ACT_STS_CD    as  账户状态代码
    ,T1.act_nm        as  账户名称
    ,T1.opn_dt        as  开户日期
    ,2024-SUBSTR(T3.doc_nbr,7,4)  as 年龄
    ,T3.reg_adr as 户籍地址
    ,T3.fml_adr as 居住地址
    ,concat(substr(regexp_replace(T3.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.reg_adr,'\\s|,',''))-6,0)),'******')   户籍地址脱敏
    ,concat(substr(regexp_replace(T3.fml_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.fml_adr,'\\s|,',''))-6,0)),'******')   居住地址脱敏
    ,case when T6.cst_act_id is not null then '是' else '否'  end  as 是否冻结
    ,T6.frz_dt      AS 冻结日期
    ,a2.cd_val_dscr AS 冻结类型
    ,T6.frz_rsn     AS 冻结原因
    ,CASE WHEN  T8.客户账号 is null then  '否'
            WHEN  T8.客户账号 is not null THEN  '是'
            else  '其他'  end  AS   是否设置非柜限额
    ,T8.单笔限额        as 非柜单笔限额
    ,T8.累计限额        as 非柜汇总日累计限额
    ,if(T13.cst_id is NOT NULL ,'是','否')      as  	客户是否持有定期存款
    ,T1.gl_bal        AS  总账余额
    ,T1.last_180_days_gl_bal_acml/180  AS  近半年日均
    ,T1.last_360_days_gl_bal_acml/360  AS  近一年日均
    ,T1.opn_org       as  开户机构编号
    ,if(T14.cst_id is NOT NULL ,'是','否')  as  	客户名下是否持有大额存单贷款理财保险基金
FROM       edw.dws_bus_dep_act_inf_dd       T1           -- 存款账户信息表
left JOIN  edw.dws_cst_bas_inf_dd          T3      ON  T1.cst_id =T3.cst_id  and T3.dt='@@{yyyyMMdd}'
left join  (
                 SELECT b1.*
				 from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
                 FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     NFRZ_IND = '0') b1 where b1.rn=1
             ) T6 --账户冻结登记
on T1.cst_act_id=T6.cst_act_id
left join (select *
          from edw.dwd_code_library_dd
          where dt='@@{yyyyMMdd}'
          and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
          and fld_nm='FRZ_CLS_CD') a2
on T6.frz_cls_cd=a2.cd_val
left  JOIN  (
        select
          cengcgjz 客户账号,
          danciedu 单笔限额,
          leijiedu 累计限额
        from edw.core_kdpa_zheddy -- 负债账户额度定义表
        where dt = '@@{yyyyMMdd}'
        and  zhxeleix='2'
        and shijbhao='FGMXIANE' -- 非柜面限额
        and edkzzhqi='1D' -- 日限额
)   T8  on  T1.cst_act_id=T8.客户账号
left join (
    select  cst_id
        ,sum(gl_bal)  定期余额
    from edw.dws_bus_dep_act_inf_dd
    where dt='@@{yyyyMMdd}'
    and lbl_prod_typ_cd='1'
    group by cst_id
    HAVING  sum(gl_bal)>0
) T13 on T1.cst_id=T13.cst_id
left join (
    -- 大额存单
    SELECT  distinct kehuhaoo  as  cst_id
    FROM edw.core_kdpb_decdsj --大额存单
    WHERE   DT = '@@{yyyyMMdd}'
    and     zhhuyuee>0 -- 当前账户余额
    union
    --理财自营存在余额的账号
    select   bnk_cst_id  as cst_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and TA_CD='TL' group by bnk_cst_id having sum(LOT_TOT_NBR)>0
    union
    ----基金存在余额的账号
    select  bnk_cst_id  as cst_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and PD_CD  IN (select prd_code from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='0')  group by bnk_cst_id having sum(LOT_TOT_NBR)>0
    union
    ---理财代销存在余额的账号
    select  bnk_cst_id  as cst_id
    from edw.dwd_bus_chm_lot_inf_dd
    where DT = '@@{yyyyMMdd}' and  LOT_TOT_NBR>0 and PD_CD in (select prd_code  from edw.finc_tbproduct where DT = '@@{yyyyMMdd}' and prd_type='1'  and substr(control_flag,75,1)='1')  group by bnk_cst_id having sum(LOT_TOT_NBR)>0
    union
    --保险 保单状态（正常 已质押 ）
      select  A.cst_id
      from   edw.dim_bus_insu_plcy_bas_inf_dd A
      WHERE  A.dt='@@{yyyyMMdd}'
      GROUP BY  A.cst_id
      HAVING   SUM(A.insu_fee)>0
    union
    ---未结清的贷款的还款账户
    select distinct customerid  as  cst_id
    from edw.loan_business_duebill where dt='@@{yyyyMMdd}'
    and  duebillstatus='0'
) T14 on T1.cst_id=T14.cst_id
and      T1.opn_org  LIKE '3305013%' --温州鹿城小微专营支行
AND      T1.ccy_cd='156'
AND      T1.DT = '@@{yyyyMMdd}'
AND      T1.STL_ACT_IND = '1'  --结算账户
AND      T1.cst_act_id not IN  (
    SELECT DISTINCT  mrgn_act_id
    FROM   edw.dwd_bus_bill_acc_mrgn_inf_dd --承兑保证金信息
    WHERE  dt='@@{yyyyMMdd}'
     )
AND      T1.BAL_GL_IND <> '0'       -- 剔除虚户
AND      T1.CST_ID <> '2000394435'  -- 剔除验资户，该客户是验资户专户
AND      T1.act_sts_cd='A'          -- -- 剔除账户状态为销户、不动户、营业外收入
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024080936_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080936_CST_04 AS
SELECT  T1.cst_id   as  客户号
    ,t1.cst_act_id  as  客户账号
    ,t1.账户名称
    ,t1.客户账号账户状态
    ,t1.客户账号开户日期
    ,t1.客户账号销户日期
    ,t1.开户机构编号
    ,t1.开户机构名称
    ,t1.存款管户客户经理名称
    ,t1.存款管户客户经理考核支行编号
    ,t1.存款管户客户经理考核支行名称
    ,t1.是否关闭非柜面
    ,t1.关闭非柜面原因
    ,t1.是否止付
    ,t1.止付日期
    ,t1.止付类型
    ,t1.止付种类
    ,t1.止付原因
    ,t1.近12个月我行综合FTP贡献
    ,t1.性别
    ,t1.年龄
    ,t1.职业
    ,t1.新柜面标签是否工资户
    ,t2.年龄 as 年龄2
    ,t2.户籍地址
    ,t2.居住地址
    ,t2.是否冻结
    ,t2.冻结类型
    ,t2.冻结原因
    ,t2.是否设置非柜限额
    ,T2.非柜单笔限额
    ,T2.非柜汇总日累计限额
    ,t2.总账余额
    ,t2.近半年日均
    ,t2.近一年日均
    ,t2.客户是否持有定期存款
    ,t2.客户名下是否持有大额存单贷款理财保险基金
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,t5.trx_amt_sum_D_days as 非柜面渠道2022年日转出金额总和
    ,t5.trx_amt_sum_max    as 非柜面渠道2022年日转出金额最大值
    ,t5.dtl_seq_nbr_D_days as 非柜面渠道2022年使用笔数出账
    ,t5.dtl_seq_nbr_C_days as 非柜面渠道2022年使用笔数入账
    ,t6.trx_amt_sum_D_days as 非柜面渠道2023年日转出金额总和
    ,t6.trx_amt_sum_max    as 非柜面渠道2023年日转出金额最大值
    ,t6.dtl_seq_nbr_D_days as 非柜面渠道2023年使用笔数出账
    ,t6.dtl_seq_nbr_C_days as 非柜面渠道2023年使用笔数入账
    ,t7.trx_amt_sum_D_days as 非柜面渠道2024年日转出金额总和
    ,t7.trx_amt_sum_max    as 非柜面渠道2024年日转出金额最大值
    ,t7.dtl_seq_nbr_D_days as 非柜面渠道2024年使用笔数出账
    ,t7.dtl_seq_nbr_C_days as 非柜面渠道2024年使用笔数入账
    ,if(t8.bind_lmt is null,'否','是') as 是否随贷通账户或签约随贷通功能
    ,t8.bind_lmt          as 随贷通绑定额度
    ,t9.ctr_amt_sum       as 未到期未终结授信金额
from SJXQ_SJ2024080936_CST_01       t1
left join SJXQ_SJ2024080936_CST_03  t2
on t1.cst_id=t2.cst_id
and t1.cst_act_id=t2.cst_act_id
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ2024080936_CST_02  t5
on t1.cst_act_id=t5.cst_act_id
and t2.dep_act_id=t5.dep_act_id
and t5.trx_year='2022'
left join SJXQ_SJ2024080936_CST_02  t6
on t1.cst_act_id=t6.cst_act_id
and t2.dep_act_id=t6.dep_act_id
and t6.trx_year='2023'
left join SJXQ_SJ2024080936_CST_02  t7
on t1.cst_act_id=t7.cst_act_id
and t2.dep_act_id=t7.dep_act_id
and t7.trx_year='2024'
left join edw.dwd_bus_loan_fnc_crd_lmt_inf_dd t8
on t1.cst_act_id=t8.cst_act_id
and t8.dt='@@{yyyyMMdd}'
and t8.lmt_sts_cd='0'
left JOIN  ( -- 授信金额
    select  cst_id
            ,SUM(ctr_amt)     ctr_amt_sum
    from   edw.dim_bus_loan_ctr_bse_inf_dd t1
    WHERE  dt='@@{yyyyMMdd}'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    GROUP BY  cst_id
) T9  on  t1.cst_id=T9.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080936_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080936_CST_05 AS
SELECT  客户号
    ,客户账号
    ,账户名称
    ,客户账号账户状态
    ,客户账号开户日期
    ,客户账号销户日期
    ,开户机构编号
    ,开户机构名称
    ,存款管户客户经理名称
    ,存款管户客户经理考核支行编号
    ,存款管户客户经理考核支行名称
    ,prm_mgr_nm as 主管户客户经理名称
    ,sbr_org_id as 主管户客户经理支行编号
    ,sbr_org_nm as 主管户客户经理支行名称
    ,是否设置非柜限额
    ,非柜单笔限额
    ,非柜汇总日累计限额
    ,是否关闭非柜面
    ,关闭非柜面原因
    ,是否冻结
    ,冻结类型
    ,冻结原因
    ,是否止付
    ,止付日期
    ,止付类型
    ,止付种类
    ,止付原因
    ,总账余额
    ,近半年日均
    ,近一年日均
    ,近12个月我行综合FTP贡献
    ,非柜面渠道2022年日转出金额总和
    ,非柜面渠道2022年日转出金额最大值
    ,非柜面渠道2022年使用笔数出账
    ,非柜面渠道2022年使用笔数入账
    ,非柜面渠道2023年日转出金额总和
    ,非柜面渠道2023年日转出金额最大值
    ,非柜面渠道2023年使用笔数出账
    ,非柜面渠道2023年使用笔数入账
    ,非柜面渠道2024年日转出金额总和
    ,非柜面渠道2024年日转出金额最大值
    ,非柜面渠道2024年使用笔数出账
    ,非柜面渠道2024年使用笔数入账
    ,客户是否持有定期存款
    ,客户名下是否持有大额存单贷款理财保险基金
    ,未到期未终结授信金额
    ,是否随贷通账户或签约随贷通功能
    ,随贷通绑定额度
    ,case when   户籍地址 LIKE  '%省%'    then   CONCAT(substring_index(户籍地址, '省', 1),'省')
               WHEN  户籍地址 LIKE  '%市%'    and    户籍地址  REGEXP '上海|重庆|天津|北京'  then CONCAT(substring_index(户籍地址, '市', 1),'市')
               WHEN  户籍地址 REGEXP '内蒙古|广西|西藏|宁夏|新疆'    then   CONCAT(substr(户籍地址, 1,2),'自治区')
               WHEN  户籍地址 REGEXP '内蒙古'    then   CONCAT(substr(户籍地址, 1,3),'自治区')
               WHEN  户籍地址 LIKE  '%特别行政区%'    and    户籍地址 REGEXP '香港|澳门'    then   CONCAT(substring_index(户籍地址, '特别行政区', 1),'特别行政区')
               when  户籍地址 LIKE  '%杭州市%'    then   '浙江省'
               WHEN  户籍地址 LIKE  '%武汉市%'    then   '湖北省'
               else  户籍地址  end  AS   户籍省份
    ,case when  户籍地址 LIKE  '%市%'    then   CONCAT(substring_index(户籍地址, '市', 1),'市')
               WHEN  户籍地址 LIKE  '%州%'    and    户籍地址 not LIKE  '%贵州%'  then CONCAT(substring_index(户籍地址, '州', 1),'州')
               WHEN  户籍地址 LIKE  '%县%'    and    户籍地址 not LIKE  '%州%'    and    户籍地址 not LIKE  '%市%'  then   CONCAT(substring_index(户籍地址, '县', 1),'县')
               else  户籍地址  end  AS   户籍城市
    ,case when   居住地址 LIKE  '%省%'    then   CONCAT(substring_index(居住地址, '省', 1),'省')
               WHEN  居住地址 LIKE  '%市%'    and    居住地址  REGEXP '上海|重庆|天津|北京'  then CONCAT(substring_index(居住地址, '市', 1),'市')
               WHEN  居住地址 REGEXP '内蒙古|广西|西藏|宁夏|新疆'    then   CONCAT(substr(居住地址, 1,2),'自治区')
               WHEN  居住地址 REGEXP '内蒙古'    then   CONCAT(substr(居住地址, 1,3),'自治区')
               WHEN  居住地址 LIKE  '%特别行政区%'    and    居住地址 REGEXP '香港|澳门'    then   CONCAT(substring_index(居住地址, '特别行政区', 1),'特别行政区')
               when  居住地址 LIKE  '%杭州市%'    then   '浙江省'
               WHEN  居住地址 LIKE  '%武汉市%'    then   '湖北省'
               else  居住地址  end  AS   居住省份
    ,case when  居住地址 LIKE  '%市%'    then   CONCAT(substring_index(居住地址, '市', 1),'市')
               WHEN  居住地址 LIKE  '%州%'    and    居住地址 not LIKE  '%贵州%'  then CONCAT(substring_index(居住地址, '州', 1),'州')
               WHEN  居住地址 LIKE  '%县%'    and    居住地址 not LIKE  '%州%'    and    居住地址 not LIKE  '%市%'  then   CONCAT(substring_index(居住地址, '县', 1),'县')
               else  居住地址  end  AS   居住城市
    ,性别
    ,年龄
    ,职业
    ,新柜面标签是否工资户
from SJXQ_SJ2024080936_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id,cst_act_id) custs
from SJXQ_SJ2024080936_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct trx_year,cst_act_id,dep_act_id) custs
from SJXQ_SJ2024080936_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_act_id,dep_act_id) custs
from SJXQ_SJ2024080936_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号,客户账号) custs
from SJXQ_SJ2024080936_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号,客户账号) custs
from SJXQ_SJ2024080936_CST_05
***SJ2024080941_四会村行存量贷款客户.sql
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024080941_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080941_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '广东四会泰隆村镇'
where t1.dt='20240731'
;
-- 信贷地址
-- ,'10','注册地址' ,'20','办公地址' ,'30','永久地址' ,'40','经营场所地址' ,'50','户籍地址' ,'60','居住地址' ,'70','其他' ,'80','线上客户维护地址'
DROP   TABLE IF     EXISTS SJXQ_SJ2024080941_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080941_CST_02 AS
SElECT t1.cst_id
    ,t2.address4    addr_office
    ,t3.address4    addr_native
    ,t4.address4    addr_house
    -- ,t5.address4    addr_operate
from(
    SElECT distinct customerid as cst_id
    from edw.loan_customer_address                --客户联系地址
    where dt='20240731'
)t1 left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240731'
    where t1.dt='20240731' and t1.isnew = '1' -- 最新
    and t1.addtype = '20' -- 办公地址
)t2 on t1.cst_id=t2.cst_id and t2.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240731'
    where t1.dt='20240731' and t1.isnew = '1' -- 最新
    and t1.addtype = '50' -- 户籍地址
)t3 on t1.cst_id=t3.cst_id and t3.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240731'
    where t1.dt='20240731' and t1.isnew = '1' -- 最新
    and t1.addtype = '60' -- 居住地址
)t4 on t1.cst_id=t4.cst_id and t4.rn=1
-- left join(
--     SELECT  t1.customerid                   AS cst_id
--         ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
--         ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
--     from edw.loan_customer_address    t1            --客户联系地址
--     left join edw.dwd_code_library_dd c1
--     on  t1.city = c1.cd_val
--     and c1.dt = '20240531'
--     where t1.dt='20240622' and t1.isnew = '1' -- 最新
--     and t1.addtype = '40' -- 经营场所地址
-- )t5 on t1.cst_id=t5.cst_id and t5.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080941_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080941_CST_03 AS
SELECT  t1.ctr_serno                AS 合同流水号
       ,t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,t1.ctr_bgn_dt               AS 合同起始日期
       ,t1.ctr_mtu_dt               AS 合同到期日期
       ,concat(t1.mgr_id,t1.mgr_nm) AS 管户人
       ,t1.org_nm                   AS 管户部门
       ,t2.addr_house               AS 居住地址
       ,t2.addr_native              AS 户籍地址
       ,t2.addr_office              AS 办公地址
FROM SJXQ_SJ2024080941_CST_01 t1
LEFT JOIN SJXQ_SJ2024080941_CST_02 t2
ON t1.cst_id = t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080941_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080941_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024080941_CST_03
***SJ2024080976_台州分行配偶法人信息.sql
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024080976_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080976_CST_01 AS
select t1.cst_id                                 --客户号
	,t1.cst_nm                                   --客户名称0
	,sum(t1.ctr_amt)  ctr_amt                    --合同金额
	,sum(t1.ctr_bal)  ctr_bal                    --合同余额
    -- ,t3.mgr_org_id	                         --管户机构号|C12
    ,t4.brc_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd       t1 --合同基础信息
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
group by t1.cst_id,t1.cst_nm,t4.brc_org_nm
;
-- 历史 配偶关系 含前妻
DROP   TABLE IF     EXISTS SJXQ_SJ2024080976_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080976_CST_02 AS
SElECT cst_id,rel_cst_id
from edw.loan_cst_rel         --客户关联关系信息
where DT <= '@@{yyyyMMdd}'
and rel_typ = '0301'
union
SElECT rel_cst_id,cst_id
from edw.loan_cst_rel         --客户关联关系信息
where DT <= '@@{yyyyMMdd}'
and rel_typ = '0301'
;
-- 个人客户担任法定代表人或股东的企业信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024080976_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080976_CST_03 AS
SElECT t1.cst_id,t1.rel_cst_id
from(
    SElECT t1.cst_id,t1.rel_cst_id,t1.rel_typ
        ,c1.cd_val_dscr as rel_typ_nm
    from(
        SElECT cst_id,rel_cst_id,rel_typ
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
        union
        SElECT rel_cst_id,cst_id,rel_typ
        from edw.loan_cst_rel         --客户关联关系信息
        where DT = '@@{yyyyMMdd}'
    )t1 LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
    ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
    AND C1.DT = '@@{yyyyMMdd}'
or rel_typ like '2%'     --股东
or rel_typ_nm like '%高管%' --高管
group by t1.cst_id,t1.rel_cst_id
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024080976_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080976_CST_04 AS
SElECT t1.cst_id,t1.cst_nm
    ,t1.ctr_amt,t1.ctr_bal
    ,t2.mrg_situ_cd	            --婚姻状况
    ,c1.cd_val_dscr         mrg_situ_nm
    ,case when nvl(t3.sam_rsk_ctrl_id,'')='' then t1.cst_id else t3.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,t4.rel_cst_id  po_cst_id
    ,t5.cst_chn_nm	po_cst_nm   --客户姓名
    ,case when nvl(t5.sam_rsk_ctrl_id,'')='' then t4.rel_cst_id else t5.sam_rsk_ctrl_id end po_rsk_id
    ,t6.ctr_amt as po_ctr_amt
    ,t6.ctr_bal as po_ctr_bal
    ,t7.rel_typ_nm
    ,t8.cst_chn_nm  entp_cst_nm
    ,case when nvl(t8.sam_rsk_ctrl_id,'')='' then t7.rel_cst_id else t8.sam_rsk_ctrl_id end entp_rsk_id
    ,t7.rel_cst_id  entp_cst_id
    ,t9.ctr_amt as  entp_ctr_amt
    ,t9.ctr_bal as  entp_ctr_bal
from SJXQ_SJ2024080976_CST_01           t1
left join edw.dim_cst_idv_bas_inf_dd	t2 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd	    t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
-- 配偶信息
left join SJXQ_SJ2024080976_CST_02      t4
on t1.cst_id=t4.cst_id
left join edw.dws_cst_bas_inf_dd	    t5 --客户基础信息汇总表
on t4.rel_cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024080976_CST_01      t6
on t4.rel_cst_id=t6.cst_id
-- 对公信息
left join SJXQ_SJ2024080976_CST_03      t7
on t1.cst_id=t7.cst_id
left join edw.dws_cst_bas_inf_dd	    t8 --客户基础信息汇总表
on t7.rel_cst_id=t8.cst_id
and t8.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024080976_CST_01      t9
on t7.rel_cst_id=t9.cst_id
left join edw.dwd_code_library_dd       c1
on t2.mrg_situ_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
where t1.brc_org_nm regexp '台州分行|总行营业部'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024080976_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024080976_CST_05 AS
SElECT cst_id 			as 客户号
    ,cst_nm             as 客户名称
    ,ctr_bal            as 贷款余额
    ,ctr_amt            as 授信总额
    ,mrg_situ_nm        as 婚姻状况
    ,po_cst_nm          as 配偶姓名
    ,po_cst_id          as 配偶客户号
    ,case when sam_rsk_ctrl_id=po_rsk_id then '是' else '' end  as 配偶是否与客户同一风险控制号
    ,po_ctr_bal 		as 配偶贷款余额
    ,po_ctr_amt         as 配偶授信总额
    ,rel_typ_nm         as 客户担任职务
    ,entp_cst_nm        as 企业名称
    ,entp_cst_id        as 企业客户号
    ,entp_ctr_bal       as 企业贷款余额
    ,entp_ctr_amt       as 企业授信总额
    ,case when sam_rsk_ctrl_id=entp_rsk_id then '是' else '' end  as 企业与客户是否同一风险控制号
from SJXQ_SJ2024080976_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080976_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080976_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080976_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024080976_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024080976_CST_05
;
***SJ2024081216_绍兴分行农村信贷数据.sql
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024081216_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081216_CST_01 AS
select distinct t1.cst_id                        --客户号
	,t1.cst_nm                                   --客户名称0
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名0
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '绍兴分行'
where t1.dt='@@{yyyyMMdd}'
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081216_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081216_CST_02 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_nm      AS 客户名称
       ,t1.mgr_id      AS 管户人工号
       ,t1.mgr_nm      AS 管户人姓名
       ,t1.mgr_org_id  AS 管户机构号
       ,t1.org_nm      AS 管户机构
       ,t3.fm_ind      AS 农户标志
       ,t3.fm_ind_loan AS 是否农户信贷
from SJXQ_SJ2024081216_CST_01           t1
inner join AI_tmp_hc_ecif_nhbs_20240813 t2
on t1.cst_id=t2.cst_id
and t2.is_jz = 1  --满足这个条件就是根据地址跑出来的农户
left join edw.dws_cst_idv_bas_inf_dd	t3 --个人客户基本信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081216_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024081216_CST_02
***SJ2024081311_嘉兴分行信贷数据.sql
-- 核心客户编号     所属机构     截至20240731余额
-- 1040781935     3309003     29.77
-- 1030915607     3309020     29.99
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024081311_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081311_CST_01 AS
SELECT  1            as seq --序号
       ,'1040781935' as cst_id
       ,'3309003'    as org_id
       , 29.77       as loan_bal
-- from qbi_file_20240806_11_13_14
-- where pt <> ''
;
-- 历史有过3天以上贷款逾期的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024081311_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081311_CST_02 AS
select t1.cst_id,max(t3.dt) max_dt
from edw.dim_bus_loan_ctr_bse_inf_dd    t1 --合同基础信息
inner join SJXQ_SJ2024081311_CST_01     t2
on t1.cst_id=t2.cst_id
inner join edw.DIM_BUS_LOAN_DBIL_INF_DD t3
on t1.ctr_serno=t3.CTR_SERNO
and t3.dt<='20240731'
and t3.OVD_DAY>3	--逾期天数
-- and t3.dt='20240731'
where t1.dt='20240731'
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081311_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081311_CST_03 AS
SELECT  t1.seq      AS 序号
       ,t1.cst_id   AS 客户号
       ,t1.org_id   AS 所属机构
       ,t1.loan_bal AS 截至20240731余额
       ,case when t2.cst_id is not null then '是' else '' end 是否有过3天以上逾期记录
       ,t2.max_dt   AS 最近一次3天以上逾期日期
from SJXQ_SJ2024081311_CST_01       t1
left join SJXQ_SJ2024081311_CST_02  t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081311_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081311_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024081311_CST_03
***SJ20240814161_龙海村行贷款客户.sql
-- 龙海村行首笔贷款客户 20240101-20240810
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no                                   --产品编号|C32
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.PCTR_DTRB_DT	--预约放款日期|C8
    ,t1.USC_APLY_DT	    --用信申请日期|C8
    ,t1.CTR_EFF_DT	    --合同生效日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率DECIMAL(13,7)
    ,t1.EXST_JNT_BRWR_OR_RPAY_ACPTOR_IND	--存在共同借款人或还款承诺人标志
    ,t2.PD_NM	--产品名称
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.rul_set_rslt_cd
    ,c1.cd_val_dscr         rul_set_rslt_nm     --预评估结果
    ,row_number() over(partition by t1.cst_id order by t1.PCTR_DTRB_DT asc) rn
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240810'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240810'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240810'
and t4.brc_org_nm regexp '福建龙海泰隆村镇'
left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd t5 --授信关联预评估信息表
on t1.REL_SERNO = t5.usc_aply_serno
and t5.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd               c1
on t5.rul_set_rslt_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
where t1.dt='20240810'
;
-- 基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_02 AS
SELECT  t1.cst_id
    ,t1.ctr_serno
    ,t2.age                 --年龄
    ,t2.idt_cd              --行业代码
    ,c1.cd_val_dscr     idt_nm
    ,t2.cprh_cmnt_id        --综合社区编号
    ,t2.cprh_cmnt_plt_id    --综合社区板块编号
    ,t2.sub_cmnt_id         --子社区编号
    ,t3.sub_cmnt_nm         --子社区名称|C900
    ,t3.sub_cmnt_typ_cd     --子社区类型代码|C96
    ,t4.GRNT_CTR_NO         --担保合同编号|C32
    ,t5.GRNT_MOD_CD	        --担保方式代码|C3 GRNT_MOD
    ,c2.cd_val_dscr     GRNT_MOD_nm
    ,t5.GRNT_CTR_STS_CD	    --担保合同状态代码 1-未生效 2-已生效 3-终止 4-冻结 5-作废
    ,t6.GTOR_NO                         --保证人编号|C20
    ,t6.GTOR_NM                         --保证人名称|C200
    ,t6.WITH_BRWR_IDTC_RSK_CTRL_NO_IND  --与借款人同一风险控制号标志|C1
    ,t6.WITH_BRWR_REL                   --与借款人关系|C3
    ,t6.EFF_STS_CD                      --生效状态代码
    ,t7.tgt_loan_cnt
from SJXQ_SJ20240814161_CST_01                  t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd	t2 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240810'
left join edw.dwd_code_library_dd               c1
on t2.idt_cd =  c1.cd_val
and c1.dt='20240810'
left join edw.dwd_cst_mng_cmnt_rel_dd	        t3 --客户社区信息
on t1.cst_id=t3.cst_id
and t3.dt='20240810'
left join(
    SElECT distinct ctr_serno,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_REL_GRNT_DD --主合同、担保合同关系
    where dt='20240810'
    and BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
)t4 on t1.ctr_serno=t4.ctr_serno
left join edw.DIM_BUS_LOAN_CTR_GRNT_INF_DD	    t5 --担保合同信息
on t4.GRNT_CTR_NO=t5.GRNT_CTR_NO
and t5.dt='20240810'
left join edw.dwd_code_library_dd               c2
on t5.GRNT_MOD_CD =  c2.cd_val
and c2.dt='20240810'
left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t6 --担保合同保证人信息
on t4.GRNT_CTR_NO=t6.GRNT_CTR_NO
and t6.dt='20240810'
left join(
    SElECT cst_id
        ,count(1)   tgt_loan_cnt
    from edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd T2 --精准贷后结果信息表
    where dt = '@@{yyyyMMdd}'
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
where t1.PCTR_DTRB_DT>='20240101'
and t1.rn=1
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_03 AS
SELECT  t1.cst_id
    ,t2.prd_dt
    ,t2.cst_cr_grd_val
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 inner join(
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240810'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240810'
)t2 on t1.cst_id=t2.cst_id
;
/*
逾期本金：BD.OverdueBalance+BD.DullBalance+BD.BadBalance
逾期利息：BD.INTERESTBALANCE1+BD.INTERESTBALANCE2
逾期金额：BD.OverdueBalance+BD.DullBalance+BD.BadBalance+BD.INTERESTBALANCE1+BD.INTERESTBALANCE2
罚息：BD.Finebalance1+BD.Finebalance2
本金逾期日期：当 BD.AgreementType = '3' 且  BD.OverDueDate 为空   且 逾期本金大于0时  取 BD.ActualMaturity    否则取 BD.OverDueDate
利息逾期日期：BD.OWEINTERESTDATE
逾期天数：BD.overduedays
*/
-- 逾期记录
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_04 AS
SELECT  t1.cst_id            --客户编号
    ,t1.dbil_id           --借据号
    ,t1.OVD_AMT           --逾期金额
    ,t1.DULL_BAL          --呆滞余额
    ,t1.STGN_DBT_BAL      --呆账余额
    ,t1.ONBS_OVD_INTR_BAL --表内欠息余额
    ,t1.OFBS_OVD_INTR_BAL --表外欠息余额
    ,t1.OVD_AMT+t1.DULL_BAL+t1.STGN_DBT_BAL+t1.ONBS_OVD_INTR_BAL+t1.OFBS_OVD_INTR_BAL    as ovd_tot_amt
    ,case when t1.AGR_TYP='3' --协议类型代码
        and nvl(t1.ovd_dt,'')='' and t1.OVD_AMT+t1.DULL_BAL+t1.STGN_DBT_BAL>0 then t1.EXEC_MTU_DT
        else t1.ovd_dt end  as bj_ovd_dt
    ,t1.OVD_INTR_DT         as lx_ovd_dt
    ,t1.TMT_DT	    --终结日期
    ,t1.OVD_DAY	    --逾期天数
from edw.DIM_BUS_LOAN_DBIL_INF_DD	    t1 --信贷借据信息
inner join SJXQ_SJ20240814161_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt = '20240810'
and t1.prcp_bal > 0
;
-- 结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_05 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no                                   --产品编号|C32
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.PCTR_DTRB_DT	--预约放款日期|C8
    ,t1.USC_APLY_DT	    --用信申请日期|C8
    ,t1.CTR_EFF_DT	    --合同生效日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率DECIMAL(13,7)
    ,t1.EXST_JNT_BRWR_OR_RPAY_ACPTOR_IND	--存在共同借款人或还款承诺人标志
    ,t1.PD_NM	--产品名称
    ,t1.mgr_id	                                 --管户人工号|C10
    ,t1.mgr_nm	                                 --管户人姓名
    ,t1.mgr_org_id	                             --管户机构号|C12
    ,t1.brc_org_nm,t1.sbr_org_nm,t1.tem_org_nm,t1.org_nm
    ,t1.rul_set_rslt_cd
    ,t1.rul_set_rslt_nm     --预评估结果
    ,t2.age                 --年龄
    ,t2.idt_nm              --行业
    ,t2.sub_cmnt_nm         --子社区名称|C900
    ,t2.GRNT_MOD_nm	        --担保方式
    ,t2.GRNT_CTR_STS_CD	    --担保合同状态代码 1-未生效 2-已生效 3-终止 4-冻结 5-作废
    ,t2.GTOR_NO                         --保证人编号|C20
    ,t2.GTOR_NM                         --保证人名称|C200
    ,t2.tgt_loan_cnt
    ,t3.prd_dt
    ,t3.cst_cr_grd_val
    ,t4.curr_unsett_fyh_loan_org_num	    --当前未结清非银行贷款机构数
    ,t4.c_od_amt	        --当前逾期总额
    ,t4.c_od_total_amt	    --贷款当前逾期总额
    ,t4.cds	                --当前逾期
    ,t4.od_reco_total_num	--逾期记录_历史逾期标识
    ,t5.loan_apl_cnt
    ,t6.ovd_cnt
from SJXQ_SJ20240814161_CST_01      t1
left join SJXQ_SJ20240814161_CST_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20240814161_CST_03 t3
on t1.cst_id=t3.cst_id
and t3.rn=1
left join edw.dws_cst_ccrc_idv_ind_inf_dd t4 --个人征信指标信息表
on t1.cst_id=t4.cst_id
and t4.dt='20240810'
and t4.report_dsc_rn=1	--报告降序排序号
left join(
    select qry_cst_id	--被查询者客户号|c20
        ,count(1) loan_apl_cnt
    from edw.dwd_cst_ccrc_ipcr_qry_inf_di	--人行征信报告查询概要信息
    where dt<='20240810'
    and dt>'20230810'   --一年内
    and qry_rsn_cd='2'	--查询原因代码 2贷款审批
    group by qry_cst_id
)t5 on t1.cst_id=t5.qry_cst_id
left join(
    SElECT cst_id,count(1) ovd_cnt
    from SJXQ_SJ20240814161_CST_04
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
where t1.PCTR_DTRB_DT>='20240101'
and t1.rn=1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_06 AS
SELECT  ctr_serno                        AS 合同流水号
       ,cst_id                           AS 客户号
       ,cst_nm                           AS 客户名称
       ,age                              AS 年龄
       ,sub_cmnt_nm                      AS 子社区名称
       ,idt_nm                           AS 行业
       ,PD_NM                            AS 产品名称
       ,ctr_amt                          AS 合同金额
       ,ctr_bal                          AS 合同余额
       ,exec_intr_rat                    AS 执行利率
       ,ctr_bgn_dt                       AS 合同起始日期
       ,ctr_mtu_dt                       AS 合同到期日期
       ,GRNT_MOD_nm                      AS 担保方式
       ,concat(GTOR_NO,GTOR_NM)          AS 保证人名称
       ,EXST_JNT_BRWR_OR_RPAY_ACPTOR_IND AS 存在共同借款人或还款承诺人标志
       ,cst_cr_grd_val                   AS 征信分
       ,rul_set_rslt_nm                  AS 预评估结果
       ,loan_apl_cnt                     AS 一年内贷款申请次数
       ,curr_unsett_fyh_loan_org_num     AS 当前未结清非银行贷款机构数
       ,c_od_amt                         AS 当前逾期总额_征信
       ,c_od_total_amt                   AS 贷款当前逾期总额_征信
       ,cds                              AS 当前逾期_征信
       ,od_reco_total_num                AS 逾期记录_历史逾期标识_征信
       ,ovd_cnt                          AS 本行结息逾期次数
       ,tgt_loan_cnt                     AS 本行精准贷后次数
       ,org_nm                           AS 管护机构
       ,sbr_org_nm                       AS 管护部门
       ,mgr_id                           AS 管户人工号
       ,mgr_nm                           AS 管户人姓名
from SJXQ_SJ20240814161_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240814161_CST_06
;
***SJ20240814161_龙海村行贷款客户_mod.sql
﻿--黄瑄妮028508-龙海村行首笔贷款情况
--SJ20240814161
-- 龙海首笔贷款发生时间：2024.01.01-2024.08.10
-- 数据需求：
-- 客户号，客户名字，年龄，社区，行业，产品类型，授信金额，授信余额，执行利率，合同起始日，合同到期日，担保方式，担保人，
-- 是否签订共债，征信分，预评估是否通过，一年内贷款申请次数，他行非银行家数，他行是否有逾期，本行结息逾期次数，本行精准贷后次数，
-- 管护机构，管护部门，管护人工号，管护人姓名，
-- 龙海村行首笔贷款客户 20240101-20240810
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no                                   --产品编号|C32
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.PCTR_DTRB_DT	--预约放款日期|C8
    ,t1.USC_APLY_DT	    --用信申请日期|C8
    ,t1.CTR_EFF_DT	    --合同生效日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率DECIMAL(13,7)
    ,t1.EXST_JNT_BRWR_OR_RPAY_ACPTOR_IND	--存在共同借款人或还款承诺人标志
    ,t2.PD_NM	--产品名称
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    -- ,t5.usc_aply_serno
    -- ,t5.rul_set_rslt_cd
    -- ,c1.cd_val_dscr         rul_set_rslt_nm     --预评估结果
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240810'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240810'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240810'
and t4.brc_org_nm regexp '福建龙海泰隆村镇'
-- left join edw.dwd_bus_loan_lmt_aply_rel_ases_dd t5 --授信关联预评估信息表
-- on t1.REL_SERNO = t5.usc_aply_serno
-- and t5.dt='@@{yyyyMMdd}'
-- left join edw.dwd_code_library_dd               c1
-- on t5.rul_set_rslt_cd = c1.cd_val
-- and c1.dt = '@@{yyyyMMdd}'
where t1.dt='20240810'
and t1.HPN_TYP_CD = '010' --发生类型代码首笔
;
--------标准代码块：新信贷客户最近一年最新的预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_01_1 AS
SELECT  T1.CST_ID
        ,T1.PRE_ASES_SERNO
FROM    EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD           T1
LEFT JOIN    EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   T2
ON      T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND     T2.DT = '20240810'
INNER JOIN    (
                  SELECT  CST_ID
                          ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
                  FROM    EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
                  WHERE   DT = '20240810'
                  GROUP BY CST_ID
              ) T3
ON      T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN    edw.dwd_code_library_dd T4
ON      t2.RUL_SET_RSLT_CD = t4.cd_val
AND     T4.DT = '20240810'
AND     t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE   T1.DT = '20240810'
GROUP BY T1.CST_ID , T1.PRE_ASES_SERNO
;
-- 基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_02 AS
SELECT  t1.cst_id
    ,t1.ctr_serno
    ,t2.age                 --年龄
    ,coalesce(t2.idt_cd,t21.idt_ctg_cd) idt_cd             --行业代码
    ,c1.cd_val_dscr     idt_nm
    ,t2.cprh_cmnt_id        --综合社区编号
    ,t2.cprh_cmnt_plt_id    --综合社区板块编号
    ,t2.sub_cmnt_id         --子社区编号
    ,t3.sub_cmnt_nm         --子社区名称|C900
    ,t3.sub_cmnt_typ_cd     --子社区类型代码|C96
    ,t4.GRNT_CTR_NO         --担保合同编号|C32
    ,t5.GRNT_MOD_CD	        --担保方式代码|C3 GRNT_MOD
    ,c2.cd_val_dscr     GRNT_MOD_nm
    ,t5.GRNT_CTR_STS_CD	    --担保合同状态代码 1-未生效 2-已生效 3-终止 4-冻结 5-作废
    ,t6.GTOR_NO                         --保证人编号|C20
    ,t6.GTOR_NM                         --保证人名称|C200
    ,t6.WITH_BRWR_IDTC_RSK_CTRL_NO_IND  --与借款人同一风险控制号标志|C1
    ,t6.WITH_BRWR_REL                   --与借款人关系|C3
    ,t6.EFF_STS_CD                      --生效状态代码
    ,t7.tgt_loan_cnt
from SJXQ_SJ20240814161_CST_01                  t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd	t2 --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20240810'
left join edw.dim_cst_entp_bas_inf_dd t21
on t1.cst_id=t21.cst_id
and t21.dt='20240810'
left join edw.dwd_code_library_dd               c1
on coalesce(t2.idt_cd,t21.idt_ctg_cd) =  c1.cd_val
and c1.dt='20240810'
left join edw.dwd_cst_mng_cmnt_rel_dd	        t3 --客户社区信息
on t1.cst_id=t3.cst_id
and t3.dt='20240810'
left join(
    SElECT distinct ctr_serno,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_REL_GRNT_DD --主合同、担保合同关系
    where dt='20240810'
    and BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
)t4 on t1.ctr_serno=t4.ctr_serno
left join edw.DIM_BUS_LOAN_CTR_GRNT_INF_DD	    t5 --担保合同信息
on t4.GRNT_CTR_NO=t5.GRNT_CTR_NO
and t5.dt='20240810'
left join edw.dwd_code_library_dd               c2
on t5.GRNT_MOD_CD =  c2.cd_val
and c2.dt='20240810'
left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t6 --担保合同保证人信息
on t4.GRNT_CTR_NO=t6.GRNT_CTR_NO
and t6.dt='20240810'
left join(
    SElECT cst_id
        ,count(1)   tgt_loan_cnt
    from edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd T2 --精准贷后结果信息表
    where dt = '20240719'
    and nvl(cst_id,'')<>''
    group by cst_id
)t7 on t1.cst_id=t7.cst_id
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_03 AS
SELECT  t1.cst_id
    ,t2.prd_dt
    ,t2.cst_cr_grd_val
    ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
FROM (
    select distinct cst_id
    from SJXQ_SJ2024072281_CST_01
)t1 inner join(
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240810'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240810'
)t2 on t1.cst_id=t2.cst_id
;
/*
逾期本金：BD.OverdueBalance+BD.DullBalance+BD.BadBalance
逾期利息：BD.INTERESTBALANCE1+BD.INTERESTBALANCE2
逾期金额：BD.OverdueBalance+BD.DullBalance+BD.BadBalance+BD.INTERESTBALANCE1+BD.INTERESTBALANCE2
罚息：BD.Finebalance1+BD.Finebalance2
本金逾期日期：当 BD.AgreementType = '3' 且  BD.OverDueDate 为空   且 逾期本金大于0时  取 BD.ActualMaturity    否则取 BD.OverDueDate
利息逾期日期：BD.OWEINTERESTDATE
逾期天数：BD.overduedays
*/
-- 逾期记录
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_04 AS
SELECT  t1.cst_id            --客户编号
    ,t1.dbil_id           --借据号
    ,t1.OVD_AMT           --逾期金额
    ,t1.DULL_BAL          --呆滞余额
    ,t1.STGN_DBT_BAL      --呆账余额
    ,t1.ONBS_OVD_INTR_BAL --表内欠息余额
    ,t1.OFBS_OVD_INTR_BAL --表外欠息余额
    ,t1.OVD_AMT+t1.DULL_BAL+t1.STGN_DBT_BAL+t1.ONBS_OVD_INTR_BAL+t1.OFBS_OVD_INTR_BAL    as ovd_tot_amt
    ,case when t1.agr_typ_cd='3' --协议类型代码
        and nvl(t1.ovd_dt,'')='' and t1.OVD_AMT+t1.DULL_BAL+t1.STGN_DBT_BAL>0 then t1.EXEC_MTU_DT
        else t1.ovd_dt end  as bj_ovd_dt
    ,t1.OVD_INTR_DT         as lx_ovd_dt
    ,t1.TMT_DT	    --终结日期
    ,t1.OVD_DAY	    --逾期天数
from edw.DIM_BUS_LOAN_DBIL_INF_DD	    t1 --信贷借据信息
inner join SJXQ_SJ20240814161_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt = '20240810'
and t1.prcp_bal > 0
;
-- 结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_05 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no                                   --产品编号|C32
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.PCTR_DTRB_DT	--预约放款日期|C8
    ,t1.USC_APLY_DT	    --用信申请日期|C8
    ,t1.CTR_EFF_DT	    --合同生效日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率DECIMAL(13,7)
    ,t1.EXST_JNT_BRWR_OR_RPAY_ACPTOR_IND	--存在共同借款人或还款承诺人标志
    ,t1.PD_NM	--产品名称
    ,t1.mgr_id	                                 --管户人工号|C10
    ,t1.mgr_nm	                                 --管户人姓名
    ,t1.mgr_org_id	                             --管户机构号|C12
    ,t1.brc_org_nm,t1.sbr_org_nm,t1.tem_org_nm,t1.org_nm
    ,t2.age                 --年龄
    ,t2.idt_nm              --行业
    ,t2.sub_cmnt_nm         --子社区名称|C900
    ,t2.GRNT_MOD_nm	        --担保方式
    ,t2.GRNT_CTR_STS_CD	    --担保合同状态代码 1-未生效 2-已生效 3-终止 4-冻结 5-作废
    ,t2.GTOR_NO                         --保证人编号|C20
    ,t2.GTOR_NM                         --保证人名称|C200
    ,t2.tgt_loan_cnt
    ,t3.prd_dt
    ,t3.cst_cr_grd_val
    ,t4.curr_unsett_fyh_loan_org_num	    --当前未结清非银行贷款机构数
    ,t4.c_od_amt	        --当前逾期总额
    ,t4.c_od_total_amt	    --贷款当前逾期总额
    ,t4.cds	                --当前逾期
    ,t4.od_reco_total_num	--逾期记录_历史逾期标识
    ,t5.loan_apl_cnt
    ,t6.ovd_cnt
    ,t7.rul_set_rslt_nm     --预评估结果
from SJXQ_SJ20240814161_CST_01      t1
left join SJXQ_SJ20240814161_CST_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20240814161_CST_03 t3
on t1.cst_id=t3.cst_id
and t3.rn=1
left join edw.dws_cst_ccrc_idv_ind_inf_dd t4 --个人征信指标信息表
on t1.cst_id=t4.cst_id
and t4.dt='20240810'
and t4.report_dsc_rn=1	--报告降序排序号
left join(
    select qry_cst_id	--被查询者客户号|c20
        ,count(1) loan_apl_cnt
    from edw.dwd_cst_ccrc_ipcr_qry_inf_di	--人行征信报告查询概要信息
    where dt<='20240810'
    and dt>'20230810'   --一年内
    and nvl(qry_cst_id,'')<>''
    and qry_rsn_cd='02'	--查询原因代码 2贷款审批
    group by qry_cst_id
)t5 on t1.cst_id=t5.qry_cst_id
left join(
    SElECT cst_id,count(1) ovd_cnt
    from SJXQ_SJ20240814161_CST_04
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
left join SJXQ_SJ20240814161_CST_01_1 t7
on t1.cst_id=t7.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814161_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814161_CST_06 AS
SELECT  ctr_serno                        AS 合同流水号
       ,cst_id                           AS 客户号
       ,cst_nm                           AS 客户名称
       ,age                              AS 年龄
       ,sub_cmnt_nm                      AS 子社区名称
       ,idt_nm                           AS 行业
       ,PD_NM                            AS 产品名称
       ,ctr_amt                          AS 合同金额
       ,ctr_bal                          AS 合同余额
       ,exec_intr_rat                    AS 执行利率
       ,ctr_bgn_dt                       AS 合同起始日期
       ,ctr_mtu_dt                       AS 合同到期日期
       ,GRNT_MOD_nm                      AS 担保方式
       ,concat(GTOR_NO,GTOR_NM)          AS 保证人名称
       ,EXST_JNT_BRWR_OR_RPAY_ACPTOR_IND AS 存在共同借款人或还款承诺人标志
       ,cst_cr_grd_val                   AS 征信分
       ,rul_set_rslt_nm                  AS 预评估结果
       ,loan_apl_cnt                     AS 一年内贷款申请次数
       ,curr_unsett_fyh_loan_org_num     AS 当前未结清非银行贷款机构数
       ,c_od_amt                         AS 当前逾期总额_征信
       ,c_od_total_amt                   AS 贷款当前逾期总额_征信
       ,cds                              AS 当前逾期_征信
       ,od_reco_total_num                AS 逾期记录_历史逾期标识_征信
       ,ovd_cnt                          AS 本行结息逾期次数
       ,tgt_loan_cnt                     AS 本行精准贷后次数
       ,org_nm                           AS 管护机构
       ,sbr_org_nm                       AS 管护部门
       ,mgr_id                           AS 管户人工号
       ,mgr_nm                           AS 管户人姓名
from SJXQ_SJ20240814161_CST_05
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814161_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240814161_CST_06
;
***SJ20240814176_宁波分行普惠业务.sql
-- 20231231 20240731 宁波分行 未到期未终结
-- 普惠业务：仅有消费业务、经营+消费业务 总授信敞口150万内
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when bsn_mark_cd='03' then 1 else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '宁波分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240731'
where t1.dt='20240731'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_02 AS
SELECT  t1.ctr_serno
       ,t2.dbil_srl_no               --借据流水号
       ,t2.mng_org_id                --管户机构号
       ,t2.cst_nm                    --客户名称
       ,t2.dbil_bal_cny              --余额
       ,t2.grant_amt                 --发放金额
       ,t2.grant_date                --发放日期
       ,t2.end_date                  --到期日期
       ,t2.prcp_ovd_date             --本金逾期日期
       ,t2.intr_ovd_date             --利息逾期日期
       ,t2.ovd_day	                 --逾期天数
       ,t2.bsn_sts                   --业务状态
       ,c1.cd_val_dscr  bsn_sts_nm
       ,t2.cst_id                    --核心客户编号
       ,t2.mng_empe_id               --管户人工号
       ,t2.vouch_type	            --担保分类
       ,t2.opr_cst_type              --经营性客户类型
       ,t2.cst_authr_crdt_amt        --客户授信总额
       ,t2.cst_authr_crdt_bal        --客户授信余额
       ,t2.ctr_apnt_yr_intr_rate     --实际利率
       ,t2.ovd_prcp_bal	            --逾期本金余额
       ,t2.rfin_ctg	                --重组分类
       ,t2.is_yr_new_hpn             --是否年度新发生
       ,t2.hpn_rsk_date	            --出险日期
       ,case when nvl(t2.hpn_rsk_date,'')<>'' and t2.hpn_rsk_date>=replace(add_months(to_date(t2.dt,'yyyyMMdd'),-12),'-','')
            then 1 else 0 end   is_lst1y_rsk_loan
    --    ,case when t3.dbil_srl_no is not null then 1 else 0 end is_lst1y_rsk_loan
       ,t2.is_rsk_loan               --是否风险贷款
       ,t2.opr_empe_id               --经办客户经理
       ,t2.opr_dept_lead_empe_id     --经办部门负责人
       ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
       ,t2.rvw_empe_id               --经办审查人
       ,t2.final_aprv_empe_id        --最终审批人
       ,t2.opr_org_id                --经办机构号
       ,t2.rsk_lvl                   --贷后风险判断
from SJXQ_SJ20240814176_CST_01          t1
left join adm_pub.adm_rsk_app_inter_all	t2 --风险集市应用表-资产质量日常监测源表
on t1.ctr_serno=t2.ctr_srl_no
and t2.dt='20240731'
-- left join(
--     SElECT dbil_srl_no
--     from adm_pub.adm_rsk_app_inter_all
--     where dt<='20240731' and dt>'20230731'
--     and is_rsk_loan='1'
--     group by dbil_srl_no
-- )t3 on t2.dbil_srl_no=t3.dbil_srl_no
left join edw.dwd_code_library_dd       c1
on t2.bsn_sts = c1.cd_val
and c1.dt = '20240731'
;
-- 用信申请
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_03 AS
SELECT  t1.ctr_serno            --合同流水号|C32
       ,t1.rel_serno            --用信申请流水号|C32
       ,t2.ahn_ltr_aply_serno   --授用信申请流水号|C32
       ,t2.cst_id               --客户号|C20
       ,t2.cst_nm               --客户名称|C200
       ,t2.cst_typ_cd           --客户类型代码|C4
       ,t2.sam_rsk_ctrl_no      --同一风险控制号|C24
       ,t2.lmt_nxt_use_cr_ind   --额度下用信标志|C2
       ,t2.csld_cr_lmt          --统一授信额度DECIMAL(21,2)
       ,t2.csld_cr_xpos         --统一授信敞口DECIMAL(21,2)
       ,t2.exec_intr_rat        --执行利率DECIMAL(13,7)
       ,row_number() over(partition by t1.ctr_serno order by t2.ahn_ltr_aply_serno desc) rn
FROM SJXQ_SJ20240814176_CST_01              t1
LEFT JOIN edw.dwd_bus_loan_lmt_aply_info_dd t2 --授用信申请信息
ON t1.rel_serno = t2.ahn_ltr_aply_serno
AND t2.dt = '20240731'
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_04 AS
SELECT  distinct t2.DBIL_ID  --借据编号
from SJXQ_SJ20240814176_CST_01          t1
left join edw.DIM_BUS_LOAN_DBIL_INF_DD	t2 --信贷借据信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20240731'
and t2.DBT_RSTC_TMS<>0  --重组
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_05 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240731'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240731'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240731'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240731'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 客户维度信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_06 AS
select t1.cst_id                                   --客户号
	,t1.sam_rsk_ctrl_id                            --同一风险控制号
    ,t1.xpos_amt	                                --同一风险控制号下客户贷款敞口金额
    ,t2.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when t3.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt
    ,t4.cny_authr_crdt_amt
    ,t4.cny_authr_crdt_bal
    ,t5.xfd_cnt,t5.jyd_cnt
    ,t6.cmn_rsk_ctrl_id
    ,t6.authr_crdt_amt as 授信金额
    ,t6.authr_crdt_bal as 授信余额
    ,t6.exps_amt as 敞口金额
    ,t6.exps_bal as 敞口余额
    ,t7.授信金额 as 同一风险控制号下授信金额
    ,t7.授信余额 as 同一风险控制号下授信余额
from adm_pub.adm_csm_crisk_sam_rsk_ctrl_inf_dd  t1 --客户同一风险控制号信息
left join adm_pub.adm_csm_clab_ln_inf_dd	    t2 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t2.cst_id
and t2.dt='20240731'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20240731'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join(
    SElECT cst_id
        ,sum(cny_authr_crdt_amt) as  cny_authr_crdt_amt	--授信金额_折人民币
        ,sum(cny_authr_crdt_bal) as  cny_authr_crdt_bal	--授信余额_折人民币
    from adm_upss.adm_rsk_apl_cst_use_crdt_ctr_info_dd        t1 --风险集市客户授信用信合同维度信息表
    where t1.dt='20240731'
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
left join(
    SElECT cst_id
        ,sum(is_xfd) xfd_cnt
        ,sum(is_jyd) jyd_cnt
    from SJXQ_SJ20240814176_CST_01 t1
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
LEFT JOIN adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd t6 -- 当前授信敞口
ON t1.cst_id = t6.cst_id
AND t6.dt = '20240731'
LEFT JOIN
(
	SELECT  cmn_rsk_ctrl_id
	       ,SUM(authr_crdt_amt) 授信金额
	       ,SUM(authr_crdt_bal) 授信余额
	FROM adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd -- 同一风险控制号下授信金额余额
    where dt='20240731'
	GROUP BY  cmn_rsk_ctrl_id
) t7 ON t6.cmn_rsk_ctrl_id = t7.cmn_rsk_ctrl_id
where t1.dt='20240731'
;
-- 字段汇总 借据维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_07 AS
SELECT  t1.ctr_serno                 --合同流水号|C32
       ,t1.cst_id                    --客户号|C20
       ,t1.cst_nm                    --客户名称|C200
       ,t1.is_xfd                    --对私一般贷款 ：个人消费性贷款
       ,t1.is_jyd                    --对私一般贷款 ：个人经营性贷款
       ,t1.ctr_amt                   --合同金额DECIMAL(21,2)
       ,t1.ctr_bal                   --合同余额DECIMAL(21,2)
       ,t1.ctr_bgn_dt                --合同起始日期
       ,t1.ctr_mtu_dt                --合同到期日期
       ,t1.exec_intr_rat             --执行利率DECIMAL(13,7)
       ,t1.ovd_amt                   --逾期金额DECIMAL(21,2)
       ,t1.ovd_dt                    --逾期日期|C8
       ,t1.onbs_ovd_intr_bal         --表内欠息余额DECIMAL(21,2)
       ,t1.ofbs_ovd_intr_bal         --表外欠息余额DECIMAL(21,2)
       ,t1.ovd_intr_dt               --欠息日期|C8
       ,t1.ref_intr_rat              --参考利率DECIMAL(13,2)
       ,t1.PD_NM
       ,t1.is_sdt
       ,t1.is_tyd
       ,t1.mgr_id                    --管户人工号|C10
       ,t1.mgr_nm                    --管户人姓名|C200
       ,t1.mgr_org_id                --管户机构号|C12
       ,t1.sbr_org_id
       ,t1.sbr_org_nm
       ,t1.org_nm
        ,t1.pre_dfd_pre_rpt_ind	    --预保预报标识
        ,t1.bsn_mark_nm             --业务标识
       ,t2.dbil_srl_no               --借据流水号
       ,t2.dbil_bal_cny              --余额
       ,t2.grant_amt                 --发放金额
       ,t2.grant_date                --发放日期
       ,t2.end_date                  --到期日期
       ,t2.prcp_ovd_date             --本金逾期日期
       ,t2.intr_ovd_date             --利息逾期日期
       ,t2.ovd_day                   --逾期天数
       ,t2.bsn_sts_nm                --业务状态
       ,t2.mng_empe_id               --管户人工号
       ,t2.vouch_type                --担保分类
       ,t2.opr_cst_type              --经营性客户类型
       ,t2.cst_authr_crdt_amt        --客户授信总额
       ,t2.cst_authr_crdt_bal        --客户授信余额
       ,t2.ctr_apnt_yr_intr_rate     --实际利率
       ,t2.ovd_prcp_bal              --逾期本金余额
       ,t2.rfin_ctg                  --重组分类
       ,t2.is_yr_new_hpn             --是否年度新发生
       ,t2.is_lst1y_rsk_loan
       ,t2.is_rsk_loan               --是否风险贷款
       ,t2.opr_empe_id               --经办客户经理
       ,c1.empe_nm      as opr_empe_nm
       ,t2.opr_dept_lead_empe_id     --经办部门负责人
       ,c2.empe_nm      as opr_dept_lead_empe_nm
       ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
       ,c3.empe_nm      as opr_sub_brch_prsd_empe_nm
       ,t2.rvw_empe_id               --经办审查人
       ,c4.empe_nm      as rvw_empe_nm
       ,t2.final_aprv_empe_id        --最终审批人
       ,c5.empe_nm      as final_aprv_empe_nm
       ,t3.rel_serno                 --用信申请流水号|C32
       ,t3.cst_typ_cd                --客户类型代码|C4
       ,t3.sam_rsk_ctrl_no           --同一风险控制号|C24
       ,t3.lmt_nxt_use_cr_ind        --额度下用信标志|C2
       ,t3.csld_cr_lmt               --统一授信额度DECIMAL(21,2)
       ,t3.csld_cr_xpos              --统一授信敞口DECIMAL(21,2)
       ,t3.exec_intr_rat             exec_intr_rat2 --执行利率DECIMAL(13,7)
       ,CASE WHEN t4.DBIL_ID is not null THEN 1  ELSE 0 END is_chongzu
       ,t5.rul_set_rslt_nm
       ,t6.sam_rsk_ctrl_id           --同一风险控制号
       ,t6.xpos_amt                  --同一风险控制号下客户贷款敞口金额
       ,t6.is_his_dft_cst            --历史违约客户标识（1是，0否）
       ,t6.是否触发处置类精准贷后
       ,t6.lst_czl_jzdt
       ,t6.cny_authr_crdt_amt
       ,t6.cny_authr_crdt_bal
       ,t6.xfd_cnt
       ,t6.jyd_cnt
       ,t6.cmn_rsk_ctrl_id
       ,t6.授信金额
       ,t6.授信余额
       ,t6.敞口金额
       ,t6.敞口余额
       ,t6.同一风险控制号下授信金额
       ,t6.同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST_01      t1
left join SJXQ_SJ20240814176_CST_02 t2
on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST_03 t3
on t1.ctr_serno=t3.ctr_serno
and t3.rn=1     --取合同号对应的 最近一次申请
left join SJXQ_SJ20240814176_CST_04 t4
on t2.dbil_srl_no=t4.DBIL_ID
left join SJXQ_SJ20240814176_CST_05 t5
on t1.cst_id=t5.cst_id
left join SJXQ_SJ20240814176_CST_06 t6
on t1.cst_id=t6.cst_id
left join edw.dws_hr_empe_inf_dd    c1 --员工信息汇总
on  t2.opr_empe_id=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd    c2 --员工信息汇总
on  t2.opr_dept_lead_empe_id=c2.empe_id
and c2.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd    c3 --员工信息汇总
on  t2.opr_sub_brch_prsd_empe_id=c3.empe_id
and c3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd    c4 --员工信息汇总
on  t2.rvw_empe_id=c4.empe_id
and c4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd    c5 --员工信息汇总
on  t2.final_aprv_empe_id=c5.empe_id
and c5.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST_08 AS
SELECT  '20240731' AS 时间分区
    ,case when xfd_cnt<>0 and jyd_cnt=0 then '是'   --仅消费业务
        when jyd_cnt<>0 and cny_authr_crdt_amt<=1500000 then '是'
        else '' end as 是否普惠业务
    ,mgr_id                    AS 管户人工号
    ,mgr_nm                    AS 管户人姓名
    ,mgr_org_id                AS 管户机构号
    ,org_nm                    AS 管护机构
    ,sbr_org_id                AS 管护支行机构号
    ,sbr_org_nm                AS 管护支行
    ,cst_id                    AS 客户号
    ,cst_nm                    AS 客户名称
    ,ctr_serno                 AS 合同流水号
    ,PD_NM                     AS 产品名称
    ,is_sdt                    AS 是否随贷通
    ,is_tyd                    AS 是否泰e贷
    ,is_xfd                    AS 是否消费性
    ,ctr_amt                   AS 合同金额
    ,ctr_bal                   AS 合同余额
    ,ctr_bgn_dt                AS 合同起始日期
    ,ctr_mtu_dt                AS 合同到期日期
    ,dbil_srl_no               AS 借据流水号
    ,prcp_ovd_date             AS 本金逾期日期
    ,intr_ovd_date             AS 利息逾期日期
    ,bsn_sts_nm                AS 业务状态
    ,vouch_type                AS 担保分类
    ,ctr_apnt_yr_intr_rate     AS 实际利率
    ,rul_set_rslt_nm           AS 预评估是否通过
    ,是否触发处置类精准贷后
    ,lst_czl_jzdt              AS 最近一次触发时间
    ,ovd_prcp_bal              AS 逾期本金余额
    ,pre_dfd_pre_rpt_ind       AS 预保预报标识
    ,bsn_mark_nm               AS 业务标识
    ,is_chongzu                AS 是否重组
    ,is_yr_new_hpn             AS 是否年度新发生
    ,is_lst1y_rsk_loan         AS 是否近一年新发生风险
    ,is_rsk_loan               AS 是否风险贷款
    ,CASE WHEN ovd_day >= 7 AND is_rsk_loan <> '1' THEN cst_authr_crdt_bal
        ELSE 0 END AS 逾期七天含以上非风险贷款规模
        AND is_rsk_loan <> '1' THEN cst_authr_crdt_bal
        ELSE 0 END AS 利息逾期七天含以上非风险贷款规模
    ,is_his_dft_cst            AS 历史违约客户标识
    ,opr_empe_nm               AS 经办客户经理
    ,opr_dept_lead_empe_nm     AS 经办部门负责人
    ,opr_sub_brch_prsd_empe_nm AS 经办支行行长
    ,rvw_empe_nm               AS 经办审查人
    ,final_aprv_empe_nm        AS 最终审批人
    ,csld_cr_xpos              AS 统一授信敞口
    ,cny_authr_crdt_bal        AS 客户号下总授信余额
    ,sam_rsk_ctrl_id           AS 同一风险控制号
    ,xpos_amt                  AS 同一风险控制号下客户贷款敞口金额
    ,同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ20240814176_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ20240814176_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 借据流水号) custs
from SJXQ_SJ20240814176_CST_08
;
***SJ20240814176_宁波分行普惠业务_20231231.sql
/*
刘璐005037-消费贷款经营贷款相关信息
SJ20240814176
1、截止20240731和截止20231231的宁波分行存续业务清单
2、是否普惠业务字段口径：
包含两类客户名下的业务合计：
1.名下仅有消费业务的客户；
2.名下有经营业务（含同时有经营和消费业务的情况），总授信敞口金额为150 万元（含）以下的客户。
20231231 20240731 宁波分行 未到期未终结
普惠业务：仅有消费业务、经营+消费业务 总授信敞口150万内
1. 本金逾期日期、利息逾期日期 取 合同第一笔借据的数据
2. 业务状态：正常、核销，按借据汇总。还是取最新？ 借据汇总
3. 合同对应的借据有时间限制吗？还是需要历史所有借据？ 所有借据
4. 是否年度新发生、是否近一年风险贷款、是否风险贷款：存在多笔借据取不同值如何取值？ 汇总+借据号
*/
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                        --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t1.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,d.preevaluateresult
    ,c2.cd_val_dscr     preevaluateresult_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20231231'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20231231'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20231231'
-- and t4.brc_org_nm regexp '宁波分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20231231'
left join edw.DWS_CST_BAS_INF_DD t5
on t1.cst_id=t5.cst_id
and t5.dt='20231231'
left JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      t1.rel_serno = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20231231'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20231231'
left join edw.dwd_code_library_dd       c2
on  d.PREEVALUATERESULT = c2.cd_val
and c2.dt = '20231231'
where t1.dt='20231231'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_02 AS
SELECT *
from(
    SELECT  t1.ctr_serno
        ,t2.dbil_srl_no               --借据流水号
        ,t2.dbil_bal_cny              --余额
        ,t2.grant_amt                 --发放金额
        ,t2.grant_date                --发放日期
        ,t2.end_date                  --到期日期
        ,t2.prcp_ovd_date             --本金逾期日期
        ,t2.intr_ovd_date             --利息逾期日期
        ,t2.bsn_sts                   --业务状态
        ,t2.mng_empe_id               --管户人工号
        ,t2.vouch_type	              --担保分类
        ,t2.ctr_apnt_yr_intr_rate     --实际利率
        ,t2.ovd_prcp_bal	          --逾期本金余额
        ,t2.is_yr_new_hpn             --是否年度新发生
        ,t2.hpn_rsk_date	          --出险日期
        ,case when nvl(t2.hpn_rsk_date,'')<>'' and t2.hpn_rsk_date>=replace(add_months(to_date(t2.dt,'yyyyMMdd'),-12),'-','')
                then '是' else '否' end   is_lst1y_rsk_loan
        ,t2.is_rsk_loan               --是否风险贷款
        ,t2.dt
        ,row_number() over(partition by t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ20240814176_CST1231_01          t1
    left join adm_pub.adm_rsk_app_inter_all	    t2 --风险集市应用表-资产质量日常监测源表
    on t1.ctr_serno=t2.ctr_srl_no
    and t2.dt>='20230101'
    and t2.dt<='20231231'
    where t1.brc_org_nm regexp '宁波分行'
)t1 where rn=1
;
-- 用信申请
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_03 AS
select busi_apl_id                            --信贷申请编号
	,opr_user_id                              --经办客户经理工号
	,opr_user_nm                              --经办客户经理名称
	,opr_org_chger_id                         --经办部门负责人工号
	,opr_org_chger_nm                         --经办部门负责人名称
	,opr_org_chger_id2                        --经办部门负责人工号2
	,opr_org_chger_nm2                        --经办部门负责人名称2
	,pr_apv_flg                               --是否经办行长审批
	,opr_pr_user_id                           --经办管理支行行长工号
	,opr_pr_user_nm                           --经办管理支行行长名称
	,opr_pr_user_id2                          --经办管理支行行长工号2
	,opr_pr_user_nm2                          --经办管理支行行长名称2
	,opr_adter_id                             --经办审查人工号
	,opr_adter_nm                             --经办审查人名称
	,opr_adter_id2                            --经办审查人工号2
	,opr_adter_nm2                            --经办审查人名称2
	,fnl_apv_id                               --最终审批人工号
	,fnl_apv_nm                               --最终审批人名称
from adm_pub.adm_rsk_bus_loan_mngmt_flow_mdl_dd t1 --风险集市信贷业务合同信息模型表
inner join(
    select distinct rel_serno
    from SJXQ_SJ20240814176_CST1231_01
    where brc_org_nm regexp '宁波分行'
)t2 on t1.busi_apl_id=t2.rel_serno
where dt='@@{yyyyMMdd}'
;
-- 客户维度信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_06 AS
select t1.cst_id                                   --客户号
	,t1.sam_rsk_ctrl_id                            --同一风险控制号
    ,t1.xfd_cnt,t1.jyd_cnt
    ,t1.cst_ctr_amt
    ,t1.cst_ctr_bal
    ,t1.cst_ctr_epsr_amt
    ,t2.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when t3.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt
    ,t4.cny_authr_crdt_amt
    ,t4.cny_authr_crdt_bal
    ,t5.同一风险控制号下授信敞口
    ,t5.同一风险控制号下授信余额
from (
    SElECT cst_id,sam_rsk_ctrl_id
        ,sum(ctr_amt) as  cst_ctr_amt	--授信金额
        ,sum(ctr_bal) as  cst_ctr_bal	--授信余额
        ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt
        ,sum(is_xfd) xfd_cnt
        ,sum(is_jyd) jyd_cnt
    from SJXQ_SJ20240814176_CST1231_01
    where brc_org_nm regexp '宁波分行'
    group by cst_id,sam_rsk_ctrl_id
)t1
left join adm_pub.adm_csm_clab_ln_inf_dd	    t2 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t2.cst_id
and t2.dt='20231231'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20231231'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join(
    SElECT cst_id
        ,sum(cny_authr_crdt_amt) as  cny_authr_crdt_amt	--授信金额_折人民币
        ,sum(cny_authr_crdt_bal) as  cny_authr_crdt_bal	--授信余额_折人民币
    from adm_upss.adm_rsk_apl_cst_use_crdt_ctr_info_dd        t1 --风险集市客户授信用信合同维度信息表
    where t1.dt='20231231'
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST1231_01 -- 同一风险控制号下授信金额余额
	GROUP BY  sam_rsk_ctrl_id
) t5 ON t1.sam_rsk_ctrl_id = t5.sam_rsk_ctrl_id
;
-- 字段汇总 借据维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_07 AS
SELECT  t1.ctr_serno                    --合同流水号|C32
       ,t1.cst_id                       --客户号|C20
       ,t1.cst_nm                       --客户名称|C200
       ,t1.is_xfd                       --对私一般贷款 ：个人消费性贷款
       ,t1.is_jyd                       --对私一般贷款 ：个人经营性贷款
       ,t1.ctr_amt                      --合同金额DECIMAL(21,2)
       ,t1.ctr_bal                      --合同余额DECIMAL(21,2)
       ,t1.ctr_bgn_dt                   --合同起始日期
       ,t1.ctr_mtu_dt                   --合同到期日期
       ,t1.exec_intr_rat                --执行利率DECIMAL(13,7)
       ,t1.ovd_amt                      --逾期金额DECIMAL(21,2)
       ,t1.ovd_dt                       --逾期日期|C8
       ,t1.onbs_ovd_intr_bal            --表内欠息余额DECIMAL(21,2)
       ,t1.ofbs_ovd_intr_bal            --表外欠息余额DECIMAL(21,2)
       ,t1.ovd_intr_dt                  --欠息日期|C8
       ,t1.ref_intr_rat                 --参考利率DECIMAL(13,2)
       ,t1.PD_NM
       ,t1.is_sdt
       ,t1.is_tyd
       ,t1.mgr_id                       --管户人工号|C10
       ,t1.mgr_nm                       --管户人姓名|C200
       ,t1.mgr_org_id                   --管户机构号|C12
       ,t1.sbr_org_id
       ,t1.sbr_org_nm
       ,t1.org_nm
       ,t1.pre_dfd_pre_rpt_ind          --预保预报标识
       ,t1.bsn_mark_nm                  --业务标识
       ,t1.is_chongzu
       ,t1.preevaluateresult_nm
       ,t2.prcp_ovd_date                --本金最早逾期日期
       ,t2.intr_ovd_date                --利息最早逾期日期
       ,t2.rsk_loan_bal
       ,t2.bsn_sts                      --业务状态
       ,t2.vouch_type                   --担保分类
       ,t2.ovd_prcp_bal                 --逾期本金余额
       ,t2.is_yr_new_hpn                --是否年度新发生
       ,t2.is_lst1y_rsk_loan
       ,t2.is_rsk_loan                  --是否风险贷款
       ,t3.opr_user_id                  --经办客户经理工号
       ,t3.opr_user_nm                  --经办客户经理名称
       ,t3.opr_org_chger_id             --经办部门负责人工号
       ,t3.opr_org_chger_nm             --经办部门负责人名称
       ,t3.opr_org_chger_id2            --经办部门负责人工号2
       ,t3.opr_org_chger_nm2            --经办部门负责人名称2
       ,t3.pr_apv_flg                   --是否经办行长审批
       ,t3.opr_pr_user_id               --经办管理支行行长工号
       ,t3.opr_pr_user_nm               --经办管理支行行长名称
       ,t3.opr_pr_user_id2              --经办管理支行行长工号2
       ,t3.opr_pr_user_nm2              --经办管理支行行长名称2
       ,t3.opr_adter_id                 --经办审查人工号
       ,t3.opr_adter_nm                 --经办审查人名称
       ,t3.opr_adter_id2                --经办审查人工号2
       ,t3.opr_adter_nm2                --经办审查人名称2
       ,t3.fnl_apv_id                   --最终审批人工号
       ,t3.fnl_apv_nm                   --最终审批人名称
       ,t6.sam_rsk_ctrl_id              --同一风险控制号
       ,t6.xfd_cnt
       ,t6.jyd_cnt
       ,t6.cst_ctr_amt
       ,t6.cst_ctr_bal
       ,t6.cst_ctr_epsr_amt
       ,t6.is_his_dft_cst               --历史违约客户标识（1是，0否）
       ,t6.是否触发处置类精准贷后
       ,t6.lst_czl_jzdt
       ,t6.cny_authr_crdt_amt
       ,t6.cny_authr_crdt_bal
       ,t6.同一风险控制号下授信敞口
       ,t6.同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST1231_01      t1
left join (
    SElECT ctr_serno
        ,min(prcp_ovd_date) as prcp_ovd_date --本金逾期日期
        ,min(intr_ovd_date) as intr_ovd_date --利息逾期日期
        ,sum(case when is_rsk_loan='Y' then dbil_bal_cny else 0 end) rsk_loan_bal
        ,concat_ws(&quot;|&quot;,collect_set(bsn_sts))    as bsn_sts
        ,concat_ws(&quot;|&quot;,collect_set(vouch_type)) as vouch_type
        ,sum(case when nvl(prcp_ovd_date,'')<>'' then ovd_prcp_bal else 0 end) as ovd_prcp_bal
        ,concat_ws(&quot;|&quot;,collect_set(concat(dbil_srl_no,':',is_yr_new_hpn)))      as is_yr_new_hpn             --是否年度新发生
        ,concat_ws(&quot;|&quot;,collect_set(concat(dbil_srl_no,':',is_lst1y_rsk_loan)))  as is_lst1y_rsk_loan
        ,concat_ws(&quot;|&quot;,collect_set(concat(dbil_srl_no,':',is_rsk_loan)))        as is_rsk_loan               --是否风险贷款
    from SJXQ_SJ20240814176_CST1231_02
    group by ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST1231_03 t3
on t1.rel_serno=t3.busi_apl_id
left join SJXQ_SJ20240814176_CST1231_06 t6
on t1.cst_id=t6.cst_id
where t1.brc_org_nm regexp '宁波分行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_08 AS
SELECT  '20231231' AS 时间分区
    ,case when xfd_cnt<>0 and jyd_cnt=0 then '是'   --仅消费业务
        when jyd_cnt<>0 and cny_authr_crdt_amt<=1500000 then '是'
        else '' end as 是否普惠业务
    ,mgr_id                    AS 管户人工号
    ,mgr_nm                    AS 管户人姓名
    ,mgr_org_id                AS 管户机构号
    ,org_nm                    AS 管护机构
    ,sbr_org_id                AS 管护支行机构号
    ,sbr_org_nm                AS 管护支行
    ,cst_id                    AS 客户号
    ,cst_nm                    AS 客户名称
    ,ctr_serno                 AS 合同流水号
    ,PD_NM                     AS 产品名称
    ,is_sdt                    AS 是否随贷通
    ,is_tyd                    AS 是否泰e贷
    ,is_xfd                    AS 是否消费性
    ,ctr_amt                   AS 合同金额
    ,ctr_bal                   AS 合同余额
    ,ctr_bgn_dt                AS 合同起始日期
    ,ctr_mtu_dt                AS 合同到期日期
    ,prcp_ovd_date             AS 本金逾期日期_最早
    ,intr_ovd_date             AS 利息逾期日期_最早
    ,bsn_sts                   AS 业务状态_汇总
    ,vouch_type                AS 担保分类_汇总
    ,exec_intr_rat             AS 执行利率
    ,preevaluateresult_nm      AS 预评估结果
    ,是否触发处置类精准贷后
    ,lst_czl_jzdt              AS 最近一次触发时间
    ,ovd_prcp_bal              AS 逾期本金余额
    ,pre_dfd_pre_rpt_ind       AS 预保预报标识
    ,bsn_mark_nm               AS 业务标识
    ,is_chongzu                AS 是否重组
    ,is_yr_new_hpn             AS 是否年度新发生
    ,is_lst1y_rsk_loan         AS 是否近一年新发生风险
    ,is_rsk_loan               AS 是否风险贷款
    ,is_his_dft_cst            AS 历史违约客户标识
    ,concat(opr_user_id,opr_user_nm)           AS 经办客户经理
    ,concat(opr_org_chger_id,opr_org_chger_nm) AS 经办部门负责人
    ,concat(opr_pr_user_id,opr_pr_user_nm)     AS 经办支行行长
    ,concat(opr_adter_id,opr_adter_nm)         AS 经办审查人
    ,concat(fnl_apv_id,fnl_apv_nm)             AS 最终审批人
    ,cst_ctr_epsr_amt                          AS 客户号下统一授信敞口
    ,cst_ctr_bal                               AS 客户号下总授信余额
    ,sam_rsk_ctrl_id                           AS 同一风险控制号
    ,同一风险控制号下授信敞口
    ,同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST1231_07
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_02
union all
SElECT '03' seq, count(1) cnt,count(distinct busi_apl_id) custs
from SJXQ_SJ20240814176_CST1231_03
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST1231_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST1231_08
***SJ20240814176_宁波分行普惠业务_20231231_0909.sql
/*
刘璐005037-消费贷款经营贷款相关信息
SJ20240814176
1、截止20240731和截止20231231的宁波分行存续业务清单
2、是否普惠业务字段口径：
包含两类客户名下的业务合计：
1.名下仅有消费业务的客户；
2.名下有经营业务（含同时有经营和消费业务的情况），总授信敞口金额为150 万元（含）以下的客户。
20231231 20240731 宁波分行 未到期未终结
普惠业务：仅有消费业务、经营+消费业务 总授信敞口150万内
1. 本金逾期日期、利息逾期日期 取 合同第一笔借据的数据
2. 业务状态：正常、核销，按借据汇总。还是取最新？ 借据汇总
3. 合同对应的借据有时间限制吗？还是需要历史所有借据？ 所有借据
4. 是否年度新发生、是否近一年风险贷款、是否风险贷款：存在多笔借据取不同值如何取值？ 汇总+借据号
20240909 加字段 经办、出险社区
*/
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                        --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t1.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,d.preevaluateresult
    ,c2.cd_val_dscr     preevaluateresult_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20231231'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20231231'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20231231'
-- and t4.brc_org_nm regexp '宁波分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20231231'
left join edw.DWS_CST_BAS_INF_DD t5
on t1.cst_id=t5.cst_id
and t5.dt='20231231'
left JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      t1.rel_serno = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20231231'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20231231'
left join edw.dwd_code_library_dd       c2
on  d.PREEVALUATERESULT = c2.cd_val
and c2.dt = '20231231'
where t1.dt='20231231'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_02 AS
SELECT *
from(
    SELECT  t1.cst_id,t1.ctr_serno
        ,t2.dbil_srl_no               --借据流水号
        ,t2.dbil_bal_cny              --余额
        ,t2.grant_amt                 --发放金额
        ,t2.grant_date                --发放日期
        ,t2.end_date                  --到期日期
        ,t2.prcp_ovd_date             --本金逾期日期
        ,t2.intr_ovd_date             --利息逾期日期
        ,t2.bsn_sts                   --业务状态
        ,t2.mng_empe_id               --管户人工号
        ,t2.vouch_type	              --担保分类
        ,t2.ctr_apnt_yr_intr_rate     --实际利率
        ,t2.ovd_prcp_bal	          --逾期本金余额
        ,t2.is_yr_new_hpn             --是否年度新发生
        ,t2.hpn_rsk_date	          --出险日期
        ,case when nvl(t2.hpn_rsk_date,'')<>'' and t2.hpn_rsk_date>=replace(add_months(to_date(t2.dt,'yyyyMMdd'),-12),'-','')
                then '是' else '否' end   is_lst1y_rsk_loan
        ,t2.is_rsk_loan               --是否风险贷款
        ,t2.dt
        ,row_number() over(partition by t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ20240814176_CST1231_01          t1
    left join adm_pub.adm_rsk_app_inter_all	    t2 --风险集市应用表-资产质量日常监测源表
    on t1.ctr_serno=t2.ctr_srl_no
    and t2.dt>='20230101'
    and t2.dt<='20231231'
    where t1.brc_org_nm regexp '宁波分行'
)t1 where rn=1
;
-- 用信申请
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_03 AS
select busi_apl_id                            --信贷申请编号
	,opr_user_id                              --经办客户经理工号
	,opr_user_nm                              --经办客户经理名称
	,opr_org_chger_id                         --经办部门负责人工号
	,opr_org_chger_nm                         --经办部门负责人名称
	,opr_org_chger_id2                        --经办部门负责人工号2
	,opr_org_chger_nm2                        --经办部门负责人名称2
	,pr_apv_flg                               --是否经办行长审批
	,opr_pr_user_id                           --经办管理支行行长工号
	,opr_pr_user_nm                           --经办管理支行行长名称
	,opr_pr_user_id2                          --经办管理支行行长工号2
	,opr_pr_user_nm2                          --经办管理支行行长名称2
	,opr_adter_id                             --经办审查人工号
	,opr_adter_nm                             --经办审查人名称
	,opr_adter_id2                            --经办审查人工号2
	,opr_adter_nm2                            --经办审查人名称2
	,fnl_apv_id                               --最终审批人工号
	,fnl_apv_nm                               --最终审批人名称
from adm_pub.adm_rsk_bus_loan_mngmt_flow_mdl_dd t1 --风险集市信贷业务合同信息模型表
inner join(
    select distinct rel_serno
    from SJXQ_SJ20240814176_CST1231_01
    where brc_org_nm regexp '宁波分行'
)t2 on t1.busi_apl_id=t2.rel_serno
where dt='20231231'
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_04 AS
SElECT t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt
    ,t1.sub_cmnt_id,t1.sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,t2.com_vindicate_name	    --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,t2.com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST1231_01          t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dt <= '20240131'
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.ctr_bgn_dt,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20231231'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_05 AS
SElECT t1.cst_id,t1.ctr_serno,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,t2.sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,t3.com_vindicate_name	    --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,t3.com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT cst_id,ctr_serno,min(hpn_rsk_date) as hpn_rsk_date
    from SJXQ_SJ20240814176_CST1231_02
    group by cst_id,ctr_serno
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20231231'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20231231'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_serno=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20231231'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20231231'
;
-- 客户维度信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_06 AS
select t1.cst_id                                   --客户号
	,t1.sam_rsk_ctrl_id                            --同一风险控制号
    ,t1.xfd_cnt,t1.jyd_cnt
    ,t1.cst_ctr_amt
    ,t1.cst_ctr_bal
    ,t1.cst_ctr_epsr_amt
    ,t2.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when t3.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt
    ,t4.cny_authr_crdt_amt
    ,t4.cny_authr_crdt_bal
    ,t5.同一风险控制号下授信敞口
    ,t5.同一风险控制号下授信余额
from (
    SElECT cst_id,sam_rsk_ctrl_id
        ,sum(ctr_amt) as  cst_ctr_amt	--授信金额
        ,sum(ctr_bal) as  cst_ctr_bal	--授信余额
        ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt
        ,sum(is_xfd) xfd_cnt
        ,sum(is_jyd) jyd_cnt
    from SJXQ_SJ20240814176_CST1231_01
    where brc_org_nm regexp '宁波分行'
    group by cst_id,sam_rsk_ctrl_id
)t1
left join adm_pub.adm_csm_clab_ln_inf_dd	    t2 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t2.cst_id
and t2.dt='20231231'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20231231'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join(
    SElECT cst_id
        ,sum(cny_authr_crdt_amt) as  cny_authr_crdt_amt	--授信金额_折人民币
        ,sum(cny_authr_crdt_bal) as  cny_authr_crdt_bal	--授信余额_折人民币
    from adm_upss.adm_rsk_apl_cst_use_crdt_ctr_info_dd        t1 --风险集市客户授信用信合同维度信息表
    where t1.dt='20231231'
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST1231_01 -- 同一风险控制号下授信金额余额
	GROUP BY  sam_rsk_ctrl_id
) t5 ON t1.sam_rsk_ctrl_id = t5.sam_rsk_ctrl_id
;
-- 字段汇总 借据维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_07 AS
SELECT  t1.ctr_serno                    --合同流水号|C32
       ,t1.cst_id                       --客户号|C20
       ,t1.cst_nm                       --客户名称|C200
       ,t1.is_xfd                       --对私一般贷款 ：个人消费性贷款
       ,t1.is_jyd                       --对私一般贷款 ：个人经营性贷款
       ,t1.ctr_amt                      --合同金额DECIMAL(21,2)
       ,t1.ctr_bal                      --合同余额DECIMAL(21,2)
       ,t1.ctr_bgn_dt                   --合同起始日期
       ,t1.ctr_mtu_dt                   --合同到期日期
       ,t1.exec_intr_rat                --执行利率DECIMAL(13,7)
       ,t1.ovd_amt                      --逾期金额DECIMAL(21,2)
       ,t1.ovd_dt                       --逾期日期|C8
       ,t1.onbs_ovd_intr_bal            --表内欠息余额DECIMAL(21,2)
       ,t1.ofbs_ovd_intr_bal            --表外欠息余额DECIMAL(21,2)
       ,t1.ovd_intr_dt                  --欠息日期|C8
       ,t1.ref_intr_rat                 --参考利率DECIMAL(13,2)
       ,t1.PD_NM
       ,t1.is_sdt
       ,t1.is_tyd
       ,t1.mgr_id                       --管户人工号|C10
       ,t1.mgr_nm                       --管户人姓名|C200
       ,t1.mgr_org_id                   --管户机构号|C12
       ,t1.sbr_org_id
       ,t1.sbr_org_nm
       ,t1.org_nm
       ,t1.pre_dfd_pre_rpt_ind          --预保预报标识
       ,t1.bsn_mark_nm                  --业务标识
       ,t1.is_chongzu
       ,t1.preevaluateresult_nm
       ,t2.prcp_ovd_date                --本金最早逾期日期
       ,t2.intr_ovd_date                --利息最早逾期日期
       ,t2.rsk_loan_bal
       ,t2.bsn_sts                      --业务状态
       ,t2.vouch_type                   --担保分类
       ,t2.ovd_prcp_bal                 --逾期本金余额
       ,t2.is_yr_new_hpn                --是否年度新发生
       ,t2.is_lst1y_rsk_loan
       ,t2.is_rsk_loan                  --是否风险贷款
       ,t3.opr_user_id                  --经办客户经理工号
       ,t3.opr_user_nm                  --经办客户经理名称
       ,t3.opr_org_chger_id             --经办部门负责人工号
       ,t3.opr_org_chger_nm             --经办部门负责人名称
       ,t3.opr_org_chger_id2            --经办部门负责人工号2
       ,t3.opr_org_chger_nm2            --经办部门负责人名称2
       ,t3.pr_apv_flg                   --是否经办行长审批
       ,t3.opr_pr_user_id               --经办管理支行行长工号
       ,t3.opr_pr_user_nm               --经办管理支行行长名称
       ,t3.opr_pr_user_id2              --经办管理支行行长工号2
       ,t3.opr_pr_user_nm2              --经办管理支行行长名称2
       ,t3.opr_adter_id                 --经办审查人工号
       ,t3.opr_adter_nm                 --经办审查人名称
       ,t3.opr_adter_id2                --经办审查人工号2
       ,t3.opr_adter_nm2                --经办审查人名称2
       ,t3.fnl_apv_id                   --最终审批人工号
       ,t3.fnl_apv_nm                   --最终审批人名称
       ,t6.sam_rsk_ctrl_id              --同一风险控制号
       ,t6.xfd_cnt
       ,t6.jyd_cnt
       ,t6.cst_ctr_amt
       ,t6.cst_ctr_bal
       ,t6.cst_ctr_epsr_amt
       ,t6.is_his_dft_cst               --历史违约客户标识（1是，0否）
       ,t6.是否触发处置类精准贷后
       ,t6.lst_czl_jzdt
       ,t6.cny_authr_crdt_amt
       ,t6.cny_authr_crdt_bal
       ,t6.同一风险控制号下授信敞口
       ,t6.同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST1231_01      t1
left join (
    SElECT ctr_serno
        ,min(prcp_ovd_date) as prcp_ovd_date --本金逾期日期
        ,min(intr_ovd_date) as intr_ovd_date --利息逾期日期
        ,sum(case when is_rsk_loan='Y' then dbil_bal_cny else 0 end) rsk_loan_bal
        ,concat_ws(&quot;|&quot;,collect_set(bsn_sts))    as bsn_sts
        ,concat_ws(&quot;|&quot;,collect_set(vouch_type)) as vouch_type
        ,sum(case when nvl(prcp_ovd_date,'')<>'' then ovd_prcp_bal else 0 end) as ovd_prcp_bal
        ,concat_ws(&quot;|&quot;,collect_set(concat(dbil_srl_no,':',is_yr_new_hpn)))      as is_yr_new_hpn             --是否年度新发生
        ,concat_ws(&quot;|&quot;,collect_set(concat(dbil_srl_no,':',is_lst1y_rsk_loan)))  as is_lst1y_rsk_loan
        ,concat_ws(&quot;|&quot;,collect_set(concat(dbil_srl_no,':',is_rsk_loan)))        as is_rsk_loan               --是否风险贷款
    from SJXQ_SJ20240814176_CST1231_02
    group by ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST1231_03 t3
on t1.rel_serno=t3.busi_apl_id
left join SJXQ_SJ20240814176_CST1231_06 t6
on t1.cst_id=t6.cst_id
where t1.brc_org_nm regexp '宁波分行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_08 AS
SELECT  '20231231' AS 时间分区
    ,case when xfd_cnt<>0 and jyd_cnt=0 then '是'   --仅消费业务
        when jyd_cnt<>0 and cny_authr_crdt_amt<=1500000 then '是'
        else '' end as 是否普惠业务
    ,t1.mgr_id                    AS 管户人工号
    ,t1.mgr_nm                    AS 管户人姓名
    ,t1.mgr_org_id                AS 管户机构号
    ,t1.org_nm                    AS 管护机构
    ,t1.sbr_org_id                AS 管护支行机构号
    ,t1.sbr_org_nm                AS 管护支行
    ,t1.cst_id                    AS 客户号
    ,t1.cst_nm                    AS 客户名称
    ,t1.ctr_serno                 AS 合同流水号
    ,t1.PD_NM                     AS 产品名称
    ,t1.is_sdt                    AS 是否随贷通
    ,t1.is_tyd                    AS 是否泰e贷
    ,t1.is_xfd                    AS 是否消费性
    ,t1.ctr_amt                   AS 合同金额
    ,t1.ctr_bal                   AS 合同余额
    ,t1.ctr_bgn_dt                AS 合同起始日期
    ,t1.ctr_mtu_dt                AS 合同到期日期
    ,t1.prcp_ovd_date             AS 本金逾期日期_最早
    ,t1.intr_ovd_date             AS 利息逾期日期_最早
    ,t1.bsn_sts                   AS 业务状态_汇总
    ,t1.vouch_type                AS 担保分类_汇总
    ,t1.exec_intr_rat             AS 执行利率
    ,t1.preevaluateresult_nm      AS 预评估结果
    ,t1.是否触发处置类精准贷后
    ,t1.lst_czl_jzdt              AS 最近一次触发时间
    ,t1.ovd_prcp_bal              AS 逾期本金余额
    ,t1.pre_dfd_pre_rpt_ind       AS 预保预报标识
    ,t1.bsn_mark_nm               AS 业务标识
    ,t1.is_chongzu                AS 是否重组
    ,t1.is_yr_new_hpn             AS 是否年度新发生
    ,t1.is_lst1y_rsk_loan         AS 是否近一年新发生风险
    ,t1.is_rsk_loan               AS 是否风险贷款
    ,t1.is_his_dft_cst            AS 历史违约客户标识
    ,concat(opr_user_id,opr_user_nm)           AS 经办客户经理
    ,concat(opr_org_chger_id,opr_org_chger_nm) AS 经办部门负责人
    ,concat(opr_pr_user_id,opr_pr_user_nm)     AS 经办支行行长
    ,concat(opr_adter_id,opr_adter_nm)         AS 经办审查人
    ,concat(fnl_apv_id,fnl_apv_nm)             AS 最终审批人
    ,t1.cst_ctr_epsr_amt                          AS 客户号下统一授信敞口
    ,t1.cst_ctr_bal                               AS 客户号下总授信余额
    ,t1.sam_rsk_ctrl_id                           AS 同一风险控制号
    ,t1.同一风险控制号下授信敞口
    ,t1.同一风险控制号下授信余额
    ,t2.sub_cmnt_nm                 as  经办时所在社区名称
    ,t2.com_vindicate_id	        as  经办时所在社区主维人工号
    ,t2.com_vindicate_name	        as  经办时所在社区主维人
    ,t2.com_order_id	            as  经办时所在社区定人工号
    ,t2.com_order_name	            as  经办时所在社区定人
    ,t3.sub_cmnt_nm	                as  出险时所在社区名称
    ,t3.com_vindicate_id	        as  出险时所在社区主维人工号
    ,t3.com_vindicate_name	        as  出险时所在社区主维人
    ,t3.com_order_id	            as  出险时所在社区定人工号
    ,t3.com_order_name	            as  出险时所在社区定人
    ,t3.mgr_id	                    as  出险时管护人工号
    ,t3.mgr_nm	                    as  出险时管护人
    ,t3.mgr_org_id	                as  出险时管护部门机构号
    ,t3.org_nm                      as  出险时管护部门
from SJXQ_SJ20240814176_CST1231_07      t1
left join SJXQ_SJ20240814176_CST1231_04 t2
on  t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST1231_05 t3
on  t1.ctr_serno=t3.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_02
union all
SElECT '03' seq, count(1) cnt,count(distinct busi_apl_id) custs
from SJXQ_SJ20240814176_CST1231_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST1231_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST1231_08
;
***SJ20240814176_宁波分行普惠业务_20231231_1015.sql
-- 近一年新发生风险贷款客户数/本年新发生风险贷款客户数 逻辑两者搞反了 后续需要调整回来
-- DROP   TABLE IF     EXISTS DIM_BUS_DBIL_LABEL_INTER_INF_DD purge;
-- CREATE TABLE IF NOT EXISTS DIM_BUS_DBIL_LABEL_INTER_INF_DD
-- (    ctr_srl_no                          STRING COMMENT '合同流水号'
--     ,dbil_srl_no                         STRING COMMENT '借据流水号'
--     ,mng_org_id                          STRING COMMENT '管户机构号'
--     ,mng_brch_id                         STRING COMMENT '分行'
--     ,acc_type                            STRING COMMENT '账户类型'
--     ,cst_nm                              STRING COMMENT '客户名称'
--     ,dbil_bal_cny                        STRING COMMENT '余额'
--     ,grant_amt                           STRING COMMENT '发放金额'
--     ,grant_date                          STRING COMMENT '发放日期'
--     ,end_date                            STRING COMMENT '到期日期'
--     ,five_level_ctg                      STRING COMMENT '五级分类'
--     ,indsy_inv_drc                       STRING COMMENT '行业投向'
--     ,indsy_cbn                           STRING COMMENT '行业组合'
--     ,bsn_label                           STRING COMMENT '业务标识'
--     ,ovd_day                             STRING COMMENT '逾期天数'
--     ,prcp_ovd_date                       STRING COMMENT '本金逾期日期'
--     ,intr_ovd_date                       STRING COMMENT '利息逾期日期'
--     ,cpn_size                            STRING COMMENT '企业规模'
--     ,bsn_sts                             STRING COMMENT '业务状态'
--     ,cst_id                              STRING COMMENT '核心客户编号'
--     ,core_org_id                         STRING COMMENT '核心机构号'
--     ,mng_empe_id                         STRING COMMENT '管户人工号'
--     ,grant_org_id                        STRING COMMENT '发放机构号'
--     ,grant_empe_id                       STRING COMMENT '发放人工号'
--     ,bsn_line                            STRING COMMENT '条线'
--     ,main_vouch_type                     STRING COMMENT '主担保方式'
--     ,cltrl_type                          STRING COMMENT '抵押物类型'
--     ,vouch_type                          STRING COMMENT '担保分类'
--     ,start_vouch_type                    STRING COMMENT '初始担保分类'
--     ,loan_usg                            STRING COMMENT '贷款用途'
--     ,rtrn_prcp_calc_intr_cd              STRING COMMENT '还本计息代码'
--     ,pblc_cst_ctg                        STRING COMMENT '对公客户分类'
--     ,opr_cst_type                        STRING COMMENT '经营性客户类型'
--     ,cst_authr_crdt_amt                  DOUBLE COMMENT '客户授信总额'
--     ,cst_authr_crdt_bal                  DOUBLE COMMENT '客户授信余额'
--     ,nrm_prcp_bal_sbj_id                 STRING COMMENT '正常科目号'
--     ,ovd_prcp_amt_sbj_id                 STRING COMMENT '逾期科目号'
--     ,ctr_apnt_yr_intr_rate               DOUBLE COMMENT '实际利率'
--     ,ovd_prcp_bal                        DOUBLE COMMENT '逾期本金余额'
--     ,shd_calc_intr                       DOUBLE COMMENT '应计利息'
--     ,table_extn_debt_intr                DOUBLE COMMENT '表外欠息'
--     ,start_ctr_srl_no_1                  STRING COMMENT '初始合同号1'
--     ,start_dbil_srl_no_1                 STRING COMMENT '初始借据号1'
--     ,start_cst_nm_1                      STRING COMMENT '初始客户名称1'
--     ,start_ctr_srl_no_2                  STRING COMMENT '初始合同号2'
--     ,start_dbil_srl_no_2                 STRING COMMENT '初始借据号2'
--     ,start_cst_nm_2                      STRING COMMENT '初始客户名称2'
--     ,mrgn_amt                            DOUBLE COMMENT '保证金金额'
--     ,cltrl_value                         DOUBLE COMMENT '抵押物价值'
--     ,wvr_rspns_rsn                       STRING COMMENT '免责原因'
--     ,other_and_memo                      STRING COMMENT '其他及备注'
--     ,rfin_ctg                            STRING COMMENT '重组分类'
--     ,rsk_cost                            DOUBLE COMMENT '风险成本'
--     ,is_yr_new_hpn                       STRING COMMENT '是否年度新发生'
--     ,hpn_rsk_date                        STRING COMMENT '出险日期'
--     ,is_rsk_loan                         STRING COMMENT '是否风险贷款'
--     ,apl_srl_no                          STRING COMMENT '申请流水号'
--     ,opr_empe_id                         STRING COMMENT '经办客户经理'
--     ,opr_dept_lead_empe_id               STRING COMMENT '经办部门负责人'
--     ,opr_sub_brch_prsd_empe_id           STRING COMMENT '经办支行行长'
--     ,rvw_empe_id                         STRING COMMENT '经办审查人'
--     ,final_aprv_empe_id                  STRING COMMENT '最终审批人'
--     ,opr_org_id                          STRING COMMENT '经办机构号'
--     ,start_cst_id                        STRING COMMENT '初始客户编号'
--     ,start_cst_nm                        STRING COMMENT '初始客户名称'
--     ,rsk_lvl                             STRING COMMENT '贷后风险判断'
--     ,chk_opnn                            STRING COMMENT '贷后管理意见'
--     ,start_dt                            STRING COMMENT '任务生成日期'
--     ,rsk_lvl_bef                         STRING COMMENT '出险前贷后风险判断'
--     ,start_dt_bef                        STRING COMMENT '出险前任务生成日期'
--     ,start_ctr_mng_emp_id                STRING COMMENT '初始合同客户经理工号'
--     ,start_ctr_opr_dept_lead_empe_id     STRING COMMENT '初始合同经办部门负责人'
--     ,start_ctr_opr_sub_brch_prsd_empe_id STRING COMMENT '初始合同经办支行行长'
--     ,hpn_typ_cd                          STRING COMMENT '发生类型'
--     ,ctr_start_dt                        STRING COMMENT '合同生效日期'
--     ,ctr_mtu_dt                          STRING COMMENT '合同到期日期'
--     ,indsy_cbn_new                       STRING COMMENT '行业组合_新'
--     ,cmn_risk_ctrl_id                    STRING COMMENT '同一风险控制号'
--     ,sam_rsk_ctrl_cst_xpos_amt           STRING COMMENT '同一风险控制号授信总额'
--     ,bsn_type_cd                         STRING COMMENT '业务品种'
--     ,fh_ch                               STRING COMMENT '分行/村行'
--     ,brc_org_id                          STRING COMMENT '分行层级机构编号'
--     ,brc_org_nm                          STRING COMMENT '分行层级机构编号'
--     ,sbr_org_id                          STRING COMMENT '支行层级机构编号'
--     ,sbr_org_nm                          STRING COMMENT '支行层级机构名称'
--     ,tem_org_id                          STRING COMMENT '团队层级机构编号'
--     ,tem_org_nm                          STRING COMMENT '团队层级机构名称'
--     ,ovd_type                            STRING COMMENT '逾期结构'
--     ,period_type_dbil                    STRING COMMENT '借据期限结构'
--     ,period_type_ctr                     STRING COMMENT '合同期限结构'
--     ,intst_rate_type_dbil                STRING COMMENT '借据利率结构'
--     ,intst_rate_type_ctr                 STRING COMMENT '合同利率结构'
--     ,hpn_type                            STRING COMMENT '发生类型'
--     ,is_rmot                             STRING COMMENT '是否异地'
--     ,rvlv_loan                           STRING COMMENT '循环贷款'
--     ,sdt                                 STRING COMMENT '随贷通'
--     ,credit_card                         STRING COMMENT '信用卡'
--     ,wsk                                 STRING COMMENT '网申卡'
--     ,jld                                 STRING COMMENT '接力贷'
--     ,quota_type                          STRING COMMENT '额度结构'
--     ,ted                                 STRING COMMENT '泰e贷'
--     ,is_rsk_loan_thsm                    STRING COMMENT '本月底是否风险贷款'
--     ,is_rsk_loan_nxtm                    STRING COMMENT '下月底是否风险贷款'
--     ,not_crdt_card_exps_amt              STRING COMMENT '不含信用卡客户授信总额度'
--     ,is_ph                               STRING COMMENT '普惠/小企业'
--     ,jy_gx_tag                           STRING COMMENT '经营/工薪'
--     ,is_farm                             STRING COMMENT '农民/市民'
--     ,amt_tag                             STRING COMMENT '客户级敞口金额_不含信用卡'
--     ,jy_tag                              STRING COMMENT '消费/经营'
--     ,emplye_loan                         STRING COMMENT '是否员工贷款'
--     ,is_yh                               STRING COMMENT '烟火标签'
--     ,is_rrkd                             STRING COMMENT '人人可贷标签'
-- ) COMMENT '风险部口径-线下INTER表（带标签）'
-- PARTITIONED BY ( dt STRING COMMENT '分区日期' )
-- ;
ALTER TABLE DIM_BUS_DBIL_LABEL_INTER_INF_DD DROP IF EXISTS PARTITION ( DT = '20231231' );
INSERT INTO TABLE DIM_BUS_DBIL_LABEL_INTER_INF_DD PARTITION (DT = '20231231')
SELECT  p.ctr_srl_no
        ,p.dbil_srl_no
        ,p.mng_org_id
        ,p.mng_brch_id
        ,p.acc_type
        ,p.cst_nm
        ,p.dbil_bal_cny
        ,p.grant_amt
        ,p.grant_date
        ,p.end_date
        ,p.five_level_ctg
        ,p.indsy_inv_drc
        ,p.indsy_cbn
        ,p.bsn_label
        ,p.ovd_day
        ,p.prcp_ovd_date
        ,p.intr_ovd_date
        ,p.cpn_size
        ,p.bsn_sts
        ,p.cst_id
        ,p.core_org_id
        ,p.mng_empe_id
        ,p.grant_org_id
        ,p.grant_empe_id
        ,p.bsn_line
        ,p.main_vouch_type
        ,p.cltrl_type
        ,p.vouch_type
        ,p.start_vouch_type
        ,p.loan_usg
        ,p.rtrn_prcp_calc_intr_cd
        ,p.pblc_cst_ctg
        ,p.opr_cst_type
        ,p.cst_authr_crdt_amt
        ,p.cst_authr_crdt_bal
        ,p.nrm_prcp_bal_sbj_id
        ,p.ovd_prcp_amt_sbj_id
        ,p.ctr_apnt_yr_intr_rate
        ,p.ovd_prcp_bal
        ,p.shd_calc_intr
        ,p.table_extn_debt_intr
        ,p.start_ctr_srl_no_1
        ,p.start_dbil_srl_no_1
        ,p.start_cst_nm_1
        ,p.start_ctr_srl_no_2
        ,p.start_dbil_srl_no_2
        ,p.start_cst_nm_2
        ,p.mrgn_amt
        ,p.cltrl_value
        ,p.wvr_rspns_rsn
        ,p.other_and_memo
        ,p.rfin_ctg
        ,p.rsk_cost
        ,p.is_yr_new_hpn
        ,p.hpn_rsk_date
        ,p.is_rsk_loan
        ,p.apl_srl_no
        ,p.opr_empe_id
        ,p.opr_dept_lead_empe_id
        ,p.opr_sub_brch_prsd_empe_id
        ,p.rvw_empe_id
        ,p.final_aprv_empe_id
        ,p.opr_org_id
        ,p.start_cst_id
        ,p.start_cst_nm
        ,p.rsk_lvl
        ,p.chk_opnn
        ,p.start_dt
        ,p.rsk_lvl_bef
        ,p.start_dt_bef
        ,p.start_ctr_mng_emp_id
        ,p.start_ctr_opr_dept_lead_empe_id
        ,p.start_ctr_opr_sub_brch_prsd_empe_id
        ,p.hpn_typ_cd
        ,p.ctr_start_dt
        ,p.ctr_mtu_dt
        ,'' indsy_cbn_new
        ,c2.cmn_risk_ctrl_id --同一风险控制号
        ,c6.sam_rsk_ctrl_cst_xpos_amt --同一风险控制号授信总额
        ,c2.bsn_type_cd ---业务品种
        ,(
         CASE
           WHEN length(p.mng_brch_id) = 2                                     THEN '分行'
           WHEN p.mng_brch_id IN ( '总行部门' , '科技企业' ) OR p.mng_brch_id IS NULL THEN '其他'
           ELSE '村行'
         END
        )    AS fh_ch ---分行/村行
        ,c10.brc_org_id --分行层级机构编号
        ,C10.brc_org_nm --分行层级机构名称
        ,c10.sbr_org_id --支行层级机构编号
        ,C10.sbr_org_nm --支行层级机构名称
        ,c10.tem_org_id --团队层级机构编号
        ,C10.tem_org_nm --团队层级机构名称
        ,(
         CASE
           WHEN p.ovd_day > 0 AND p.ovd_day <= 30     THEN '1-逾期0-30天'
           WHEN p.ovd_day > 30 AND p.ovd_day <= 60    THEN '2-逾期30-60天'
           WHEN p.ovd_day > 60 AND p.ovd_day <= 180   THEN '3-逾期60-180天'
           WHEN p.ovd_day > 180 AND p.ovd_day <= 360  THEN '4-逾期180-360天'
           WHEN p.ovd_day > 360 AND p.ovd_day <= 720  THEN '5-逾期360-720天'
           WHEN p.ovd_day > 720 AND p.ovd_day <= 1080 THEN '6-逾期720-1080天'
           WHEN p.ovd_day > 1080                      THEN '7-逾期1080天以上'
           WHEN p.ovd_day = 0                         THEN '8-未逾期'
         END
        )    AS ovd_type --逾期结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 6                                                                                              THEN '1-借据期限6个月（含）以内'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 6 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 12  THEN '2-借据期限6个月-12个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 12 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 24 THEN '3-借据期限12个月-24个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 24 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 36 THEN '4-借据期限24个月-36个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 36 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 48 THEN '5-借据期限36个月-48个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 48                                                                                              THEN '6-借据期限48个月以上'
           ELSE '信用卡'
         END
        )    AS period_type_dbil --借据期限结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 6                                                                                                        THEN '1-合同期限6个月（含）以内'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 6 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 12  THEN '2-合同期限6个月-12个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 12 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 24 THEN '3-合同期限12个月-24个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 24 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 36 THEN '4-合同期限24个月-36个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 36 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 48 THEN '5-合同期限36个月-48个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 48                                                                                                        THEN '6-合同期限48个月以上'
           ELSE '信用卡'
         END
        )    AS period_type_ctr --合同期限结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 >= 0 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 6    THEN '1-年化利率[0,6]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 6 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 8     THEN '2-年化利率(6,8]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 8 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 10    THEN '3-年化利率(8,10]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 10 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 12   THEN '4-年化利率(10,12]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 12 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 14.4 THEN '5-年化利率(12,14.4]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 14.4                                         THEN '6-年化利率(14.4,&infin;)'
           ELSE '信用卡'
         END
        )    AS intst_rate_type_dbil --借据利率结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 >= 0 AND c2.ctr_yr_intr_rate * 100 <= 6    THEN '1-年化利率[0,6]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 6 AND c2.ctr_yr_intr_rate * 100 <= 8     THEN '2-年化利率(6,8]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 8 AND c2.ctr_yr_intr_rate * 100 <= 10    THEN '3-年化利率(8,10]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 10 AND c2.ctr_yr_intr_rate * 100 <= 12   THEN '4-年化利率(10,12]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 12 AND c2.ctr_yr_intr_rate * 100 <= 14.4 THEN '5-年化利率(12,14.4]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 14.4                                     THEN '6-年化利率(14.4,&infin;)'
           ELSE '信用卡'
         END
        )    AS intst_rate_type_ctr -- 合同利率结构
        ,(
         CASE
           WHEN c2.hpn_type_cd = '010' THEN '1-首笔'
           WHEN c2.hpn_type_cd = '011' THEN '2-续做'
           WHEN c2.hpn_type_cd = '070' THEN '3-垫款'
           WHEN c2.hpn_type_cd = '610' THEN '4-卡片申请'
           WHEN c2.hpn_type_cd = '650' THEN '5-卡片续卡'
           ELSE '6-其他'
         END
        )    AS hpn_type --发生类型
        ,(
         CASE
           WHEN SUBSTR(A6.cnr_lvl_id_cd, 1, 4) <> SUBSTR(A8.cnr_cd, 1, 4) THEN '异地'
           ELSE '非异地'
         END
        )    AS is_rmot --是否异地
        ,(
         CASE
           WHEN ( c2.rcyc_loan_label_cd = '1' OR c2.bsn_type_cd LIKE '2010503%' ) AND c2.bsn_type_cd NOT LIKE '2010402%' AND c2.bsn_type_cd NOT LIKE '20108%' THEN '循环'
           ELSE '非循环'
         END
        )    AS rvlv_loan --循环贷款
        ,(
         CASE
           WHEN c2.bsn_type_cd LIKE '2010503%' THEN '随贷通'
           ELSE '非随贷通'
         END
        )    AS sdt --随贷通
        ,(
         CASE
           WHEN p.acc_type = '信用卡' THEN '信用卡'
           ELSE '非信用卡'
         END
        )    AS credit_card --信用卡
        ,(
         CASE
           WHEN c9.is_ntw_apl_card = '1' THEN '网申卡'
           ELSE '非网申卡'
         END
        )    AS wsk --网申卡
        ,(
         CASE
           WHEN c2.not_gap_reloan_type_cd IN ( '1' , '3' ) THEN '接力贷'
           ELSE '非接力贷'
         END
        )    AS jld --接力贷
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt <= 100000                                             THEN '1-额度10万（含）以下'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 100000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 300000   THEN '2-额度10万-30万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 300000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 500000   THEN '3-额度30万-50万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 500000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 1000000  THEN '4-额度50万-100万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 1000000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 1500000 THEN '5-额度100万-150万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 1500000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 3000000 THEN '6-额度150万-300万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 3000000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 5000000 THEN '7-额度300万-500万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 5000000                                             THEN '8-额度500万以上'
           ELSE '信用卡'
         END
        )    AS quota_type  ----额度结构
        ,CASE
           WHEN coalesce(C11.busi_ctr_id, '') <> '' THEN '泰e贷'
           ELSE '非泰e贷'
         END AS ted --泰e贷
        ,(
         CASE
           ELSE '否'
         END
        )    AS is_rsk_loan_thsm --本月底是否风险贷款
        ,(
         CASE
           ELSE '否'
         END
        )    AS is_rsk_loan_nxtm  --下月底是否风险贷款
        ,m7.not_crdt_card_exps_amt
        ,CASE
           WHEN p.acc_type LIKE '%信用卡%' AND COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) NOT LIKE '201050203%' THEN '信用卡'
           WHEN yw.num_xf > 0 AND yw.num_jy = 0                                                            THEN '普惠' -- 客户为只有消费业务
           WHEN yw.num_jy > 0 AND m7.not_crdt_card_exps_amt <= 1500000                                     THEN '普惠' -- 客户为经营类业务（经营或消费同时存在），办理业务总敞口金额 150 万元（含）以下的信贷业务。
           WHEN yw.num_jy > 0 AND m7.not_crdt_card_exps_amt > 1500000                                      THEN '小企业'
           WHEN yw.num_jy > 0 AND COALESCE(m7.not_crdt_card_exps_amt, '') = ''                             THEN '无授信额度'
         END AS is_ph ---普惠/小企业
        ,CASE
           WHEN b2.loan_cst_typ_cd = '0704' THEN '工薪'
           WHEN b2.loan_cst_typ_cd = '0705' THEN '其他'
           ELSE '经营'
         END AS jy_gx_tag --经营/工薪
        ,CASE
           WHEN p.cst_id LIKE '2%'       THEN '对公客户'
           WHEN m11.two_people_ind = '2' THEN '农民'
           WHEN m11.two_people_ind = '1' THEN '市民'
           ELSE '其他'
         END AS is_farm --农民/市民
        ,CASE
           WHEN coalesce(t2.not_crdt_card_exps_amt, '') = '' OR t2.not_crdt_card_exps_amt <= 0 THEN '1.未授信'
           WHEN t2.not_crdt_card_exps_amt > 0 AND t2.not_crdt_card_exps_amt <= 500000          THEN '2.授信<=50万'
           WHEN t2.not_crdt_card_exps_amt > 500000 AND t2.not_crdt_card_exps_amt <= 1500000    THEN '3.授信<=150万'
           WHEN t2.not_crdt_card_exps_amt > 1500000                                            THEN '4.授信>150万'
           ELSE '5.其他'
         END AS amt_tag --客户级敞口金额_不含信用卡
        ,CASE
           WHEN COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201050101%'                                 THEN '消费'
           WHEN COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '2010503%' AND money_usg_cd LIKE '02%'       THEN '消费'
           WHEN ( COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201050102%' ---一般经营性贷款，个人+对公
OR COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201040101%' --流动资金贷款
OR COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201040102%' --固定资产贷款
OR COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201040106%' --法人购房贷款
OR ( COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '2010503%' AND money_usg_cd LIKE '01%' ) ) --随贷通经营
                                                                                                           THEN '经营'
           WHEN p.acc_type LIKE '%信用卡%' AND COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) NOT LIKE '201050203%' THEN '信用卡'
           ELSE '其他'
         END jy_tag ---消费/经营
        ,CASE
           WHEN spc_bsn_label_cd IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) THEN '员工贷款'
           ELSE '非员工贷款'
         END AS emplye_loan -- 是否员工贷款
        ,CASE
           WHEN m8.cst_id IS NOT NULL THEN '烟火商户'
           ELSE '非烟火商户'
         END AS is_yh ---烟火标签
        ,CASE
           WHEN coalesce(T9.CST_ID, '') <> '' THEN '人人可贷'
           ELSE '非人人可贷'
         END IS_RRKD --人人可贷标签
FROM    adm_pub.adm_rsk_app_inter_all p
LEFT JOIN    adm_rsk.adm_rsk_ast_loan_dbil_inf_dd c1 --风险集市信贷业务借据信息表
ON      p.dbil_srl_no = c1.dbil_srl_no
AND     c1.dt = '20231231'
LEFT JOIN    adm_rsk.adm_rsk_ast_loan_ctr_inf_dd c2 --风险集市信贷业务合同信息表
ON      p.ctr_srl_no = c2.ctr_srl_no
AND     c2.dt = '20231231'
LEFT JOIN    adm_rsk.ADM_RSK_AST_CARD_CRDT_ACC_INF_DD c5 --风险集市信用卡账户信息表
ON      c5.crdt_card_acc = p.ctr_srl_no
AND     c5.dt = '20231231'
LEFT JOIN    adm_rsk.ADM_RSK_AST_CARD_CRDT_CARD_BAS_INF_DD c9 --风险集市信用卡卡片基本信息表
ON      p.dbil_srl_no = c9.crdt_card_id
AND     c9.dt = '20231231'
LEFT JOIN    edw.dws_bus_loan_sam_rsk_ctrl_inf_dd c6 --贷款同一风险控制号信息
ON      c6.sam_rsk_ctrl_id = c2.cmn_risk_ctrl_id
AND     c6.dt = '20231231'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd A6 --客户户籍地址
ON      p.cst_id = A6.cst_id
AND     A6.dt = '20231231'
AND     A6.phy_adr_typ_cd = '050100'
LEFT JOIN    edw.dim_hr_org_bas_inf_dd A8
ON      p.mng_org_id = A8.org_id
AND     A8.dt = '20231231'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd C10 ---机构树_考核维度  团队
ON      p.mng_org_id = C10.org_id --主管护机构号=org_id
AND     C10.DT = '20231231'
LEFT JOIN    (
                 SELECT  T1.apl_srl_nbr -- 进件流水号
                         ,COALESCE(t3.busi_ctr_id, t1.RELOAN_CTR_ID) AS busi_ctr_id -- 合同流水号
                 FROM    EDW.DWD_BUS_LOAN_ENTR_FORM_DD T1 -- 信贷业务进件单信息
                 LEFT JOIN    EDW.DWD_BUS_LOAN_REL_APL_INF_DD T2 -- 信贷业务关联申请信息
                 ON      T1.APL_SRL_NBR = T2.REL_OBJ_ID -- 进件流水号
                 AND     T2.REL_OBJ_TYP = 'EntryForm' -- 关联类型为进件
                 AND     T2.DT = '20231231'
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_INF_DD T3 -- 信贷合同信息
                 ON      T2.APL_SRL_NBR = T3.BUSI_APL_ID -- 业务申请流水号
                 AND     T3.DT = '20231231'
                 WHERE   T1.DT = '20231231'
                 AND     ( T1.APL_SRC_TYP_CD = '060' -- 进件业务来源 等于 060泰e贷
                     OR ( T1.APL_SRC_TYP_CD = '050'
                 AND     T1.APL_STYP = '050010' ) -- 泰e贷-随贷通卡进件
                     OR ( T1.APL_SRC_TYP_CD = '090'
                 AND     T1.APL_STYP = '090010' ) -- 泰e贷-备用金
)
             ) C11
ON      p.ctr_srl_no = C11.busi_ctr_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20231231'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) m7
ON      p.cst_id = m7.cst_id
AND     m7.RANK1 = 1
LEFT JOIN    (
                 SELECT  y.cst_id
                         ,SUM(CASE
                                WHEN y.jy_tag = '消费' THEN 1
                                ELSE 0
                              END) num_xf
                         ,SUM(CASE
                                WHEN y.jy_tag = '经营' THEN 1
                                ELSE 0
                              END) num_jy
                         ,COUNT(y.busi_ctr_id) num_ctr
                 FROM    (
                             SELECT  cst_id
                                     ,busi_ctr_id
                                     -- 消费性业务
                                     -- 贷款类
                                     -- 个人消费
                                     -- 随贷通消费
                                     -- 经营性业务
                                     -- 贷款类
                                     -- 一般经营性贷款，个人+对公|流动资金贷款|固定资产贷款|法人购房贷款
                                     -- 随贷通经营
                                     -- 其他
                                     -- 票据承兑|票据贴现|承兑垫款|保函垫款|信用证垫款|代付垫款|贸易融资
                                     ,CASE
                                        WHEN pd_cd LIKE '201050101%' OR ( pd_cd LIKE '2010503%' AND loan_usg_cd LIKE '02%' )                                                                                                                             THEN '消费'
                                        WHEN ( pd_cd REGEXP '^201050102|^201040101|^201040102|^201040106' OR ( pd_cd LIKE '2010503%' AND loan_usg_cd LIKE '01%' ) OR pd_cd REGEXP '^201040201|^201040202|^2010801|^2010802|^2010803|^2010804|^2010403' ) THEN '经营'
                                        WHEN pd_cd LIKE '2010502%' AND pd_cd NOT LIKE '201050203%'                                                                                                                                                       THEN '信用卡'
                                        ELSE '其他'
                                      END jy_tag
                             FROM    edw.dim_bus_loan_ctr_inf_dd
                             WHERE   dt = '20231231'
                         ) y
                 GROUP BY y.cst_id
             ) yw
ON      m7.cst_id = yw.cst_id
LEFT JOIN    edw.dws_cst_bas_inf_dd b2
ON      b2.cst_id = p.cst_id
AND     b2.dt = '20231231'
LEFT JOIN    (
                 SELECT  DISTINCT dt
                                  ,cst_id
                                  ,two_people_ind
                                  ,new_citizen
                 FROM    adm_pub.adm_csm_clab_cst_inf_cmpn_idv_inf_dd --客户集市-客户标签信息-客户信息-营销-对私客户
                 WHERE   dt = '20231231'
             ) m11
ON      p.cst_id = m11.cst_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20231231'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) t2
ON      t2.cst_id = p.cst_id
AND     t2.RANK1 = 1
LEFT JOIN    (
                 SELECT  DISTINCT dt
                                  ,cst_id
                 FROM    adm_pub.adm_csm_clab_cst_jc_inf_dd ----客户集市-客户标签信息-客户信息-决策
                 WHERE   dt = '20231231'
                 AND     yh_mch IN ( '1' , '2' , '3' )
             ) m8
ON      p.cst_id = m8.cst_id
LEFT JOIN    (
                 --判断是否人人可贷
                 SELECT  T2.cst_id
                 FROM    edw.dwd_cst_mng_cmnt_rel_dd T2 -- 客户社区信息
                 INNER JOIN    EDW.dim_cst_mng_cmnt_inf_dd T3 -- 社区信息
                 ON      T3.cmnt_enc = T2.sub_cmnt_id -- 子社区编号
                 AND     ( ( T3.APRV_STS_CD <> '-1' -- 社区审批状态: -1删除 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过) 7审批中(审批拒绝修改) 9暂转移
                 AND     T3.OPR_TYP_CD >= '2' -- 操作类型: 1增加 2修改 3删除 4转移 5认领
)
                     OR T3.APRV_STS_CD IN ( '5' , '9' ) )
                 AND     T3.CMNT_TYP_CD IN ( '03' , '05' ) -- 社区类型为 子社区 或 虚拟子社区
                 AND     COALESCE(TRIM(T3.AFL_ORG_ID), ' ') <> ' ' -- 所属机构id 不为 空
                 AND     T3.VLG_LOAN_SUB_CMNT_IND = '1' -- 是否农村人人可贷子社区1：是 0否
                 AND     T3.DT = '20231231'
                 -- 查询子社区所属的综合社区板块
                 INNER JOIN    EDW.dim_cst_mng_cmnt_inf_dd T4 -- 社区信息
                 ON      T4.cmnt_enc = T2.cprh_cmnt_plt_id
                 AND     ( ( T4.APRV_STS_CD <> '-1' -- 社区审批状态: -1删除 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过) 7审批中(审批拒绝修改) 9暂转移
                 AND     T4.OPR_TYP_CD >= '2' -- 操作类型: 1增加 2修改 3删除 4转移 5认领
)
                     OR T4.APRV_STS_CD IN ( '5' , '9' ) )
                 AND     T4.CMNT_TYP_CD = '02' -- 社区类型为 综合社区版块
                 AND     COALESCE(TRIM(T4.AFL_ORG_ID), ' ') <> ' ' -- 所属机构id 不为 空
                 AND     T4.DT = '20231231'
                 -- 查询综合社区板块所属的综合社区
                 INNER JOIN    EDW.dim_cst_mng_cmnt_inf_dd T5 -- 社区信息
                 ON      T5.cmnt_enc = T2.cprh_cmnt_id
                 AND     ( ( T5.APRV_STS_CD <> '-1' -- 社区审批状态: -1删除 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过) 7审批中(审批拒绝修改) 9暂转移
                 AND     T5.OPR_TYP_CD >= '2' -- 操作类型: 1增加 2修改 3删除 4转移 5认领
)
                     OR T5.APRV_STS_CD IN ( '5' , '9' ) )
                 AND     T5.CMNT_TYP_CD = '01' -- 社区类型为 综合社区
                 AND     COALESCE(TRIM(T5.AFL_ORG_ID), ' ') <> ' ' -- 所属机构id 不为 空
                 AND     T5.DT = '20231231'
                 WHERE   T2.DT = '20231231'
             ) T9
ON      T9.cst_id = p.cst_id
WHERE   p.dt = '20231231'
;
-- 借据汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1015_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1015_01 AS
select ctr_srl_no                        --合同流水号
    ,sum(case when bsn_sts NOT LIKE '%核销%' then dbil_bal_cny else 0 end) as  dbil_bal_cny 	--余额
    ,sum(grant_amt) as  grant_amt 	--发放金额
    ,min(grant_date) as  grant_date 	--发放日期
    ,max(end_date) as  end_date 	--到期日期
    ,min(prcp_ovd_date) as  prcp_ovd_date 	--本金逾期日期
    ,min(intr_ovd_date) as  intr_ovd_date 	--利息逾期日期
    ,max(cst_authr_crdt_amt) as  cst_authr_crdt_amt 	--客户授信总额
    ,max(cst_authr_crdt_bal) as  cst_authr_crdt_bal 	--客户授信余额
    ,sum(ovd_prcp_bal) as  ovd_prcp_bal 	--逾期本金余额
    ,min(hpn_rsk_date) as  hpn_rsk_date 	--出险日期
    ,min(ctr_start_dt) as  ctr_start_dt 	--合同生效日期
    ,max(ctr_mtu_dt) as  ctr_mtu_dt 	--合同到期日期
    ,sum(amt_tag) as  amt_tag 	--客户级敞口金额_不含信用卡
from DIM_BUS_DBIL_LABEL_INTER_INF_DD        t1
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  t1.mng_empe_id=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd C10 ---机构树_考核维度  团队
ON      t1.mng_org_id = C10.org_id --主管护机构号=org_id
AND     C10.DT = '20231231'
where t1.dt='20231231'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t1.brc_org_nm ='宁波分行'
group by t1.ctr_srl_no
;
-- 合同维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1015_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1015_02 AS
SElECT t1.ctr_srl_no
    ,T2.rel_serno
    ,t2.prd_no
	,t2.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t2.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t2.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t2.ctr_bgn_dt                               --合同起始日期
	,t2.ctr_mtu_dt                               --合同到期日期
    ,t2.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t2.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,CASE WHEN NVL(T2.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t2.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t2.ovd_dt	                                --逾期日期
    ,t3.pd_nm
    ,c.pre_apl_srl_nbr
    ,d.PREEVALUATERESULT
    ,c2.cd_val_dscr     preevaluateresult_nm
    ,case when t4.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t4.lst_czl_jzdt
    ,t5.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when nvl(t6.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t6.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from(
    select distinct ctr_srl_no
    from SJXQ_SJ20240814176_CST1231_1015_01
)t1 left join edw.dim_bus_loan_ctr_bse_inf_dd        t2 --合同基础信息
ON T1.ctr_srl_no=T2.ctr_serno
AND T2.DT='20231231'
left join edw.dim_bus_loan_prd_frml_dd     t3
on t2.prd_no=t3.prd_no
and t3.dt='20231231'
left JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      t2.rel_serno = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20231231'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20231231'
left join edw.dwd_code_library_dd       c2
on  d.PREEVALUATERESULT = c2.cd_val
and c2.dt = '20231231'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20231231'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t4 on t2.cst_id=t4.cst_id
left join adm_pub.adm_csm_clab_ln_inf_dd	    t5 --客户集市-标签层-信贷客户标签信息表
on t2.cst_id=t5.cst_id
and t5.dt='20231231'
left join edw.DWS_CST_BAS_INF_DD t6
on t2.cst_id=t6.cst_id
and t6.dt='20231231'
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1015_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1015_04 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.ctr_start_dt
    ,t1.sub_cmnt_id,t1.sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,t2.com_vindicate_name	    --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,t2.com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_srl_no,t1.ctr_start_dt
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_srl_no,t1.ctr_start_dt order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST1231_1015_01     t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dt <= '20240131'
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.ctr_start_dt,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20231231'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1015_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1015_05 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,t2.sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,t3.com_vindicate_name	    --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,t3.com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT DISTINCT cst_id,ctr_srl_no,hpn_rsk_date
    from SJXQ_SJ20240814176_CST1231_1015_01
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20231231'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20231231'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_srl_no=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20231231'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20231231'
;
-- 输出结果 20231231
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1015_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1015_06 AS
SELECT  '20231231'                   AS 时间分区
       ,is_ph                        AS 是否普惠业务
       ,t1.mng_empe_id               AS 管户人工号
       ,t1.mng_empe_nm               AS 管户人姓名
       ,t1.mng_org_id                AS 管户机构号
       ,t1.mng_org_nm                AS 管护机构
       ,t1.sbr_org_id                AS 管护支行机构号
       ,t1.sbr_org_nm                AS 管护支行
       ,t1.cst_id                    AS 客户号
       ,t1.cst_nm                    AS 客户名称
       ,t1.ctr_srl_no                AS 合同流水号
       ,t2.PD_NM                     AS 产品名称
       ,t1.sdt                       AS 是否随贷通
       ,t1.ted                       AS 是否泰e贷
       ,t1.jy_tag                    AS 是否消费性
       ,t2.ctr_amt                   AS 合同金额
       ,t2.ctr_bal                   AS 合同余额
       ,t2.ctr_bgn_dt                AS 合同起始日期
       ,t2.ctr_mtu_dt                AS 合同到期日期
       ,t1.prcp_ovd_date             AS 本金逾期日期_最早
       ,t1.intr_ovd_date             AS 利息逾期日期_最早
       ,t1.bsn_sts                   AS 业务状态_汇总
       ,t1.vouch_type                AS 担保分类_汇总
       ,t2.exec_intr_rat             AS 执行利率
       ,t2.preevaluateresult_nm      AS 预评估结果
       ,t2.是否触发处置类精准贷后
       ,t2.lst_czl_jzdt              AS 最近一次触发时间
       ,t1.ovd_prcp_bal              AS 逾期本金余额
       ,T2.pre_dfd_pre_rpt_ind       AS 预保预报标识
       ,t1.bsn_label                 AS 业务标识
       ,t2.is_chongzu                AS 是否重组
       ,t1.is_yr_new_hpn             AS 是否年度新发生
       ,t1.is_lst1y_rsk_loan         AS 是否近一年新发生风险
       ,t1.is_rsk_loan               AS 是否风险贷款
       ,t2.is_his_dft_cst            AS 历史违约客户标识
       ,t1.opr_empe_id               AS 经办客户经理
       ,t1.opr_dept_lead_empe_id     AS 经办部门负责人
       ,t1.opr_sub_brch_prsd_empe_id AS 经办支行行长
       ,t1.rvw_empe_id               AS 经办审查人
       ,t1.final_aprv_empe_id        AS 最终审批人
       ,t1.amt_tag                   AS 客户级敞口金额
       ,t1.cst_authr_crdt_bal        AS 客户授信余额
       ,t1.cmn_risk_ctrl_id          AS 同一风险控制号
       ,t5.同一风险控制号下授信敞口
       ,t5.同一风险控制号下授信余额
       ,t3.sub_cmnt_nm               AS 经办时所在社区名称
       ,t3.com_vindicate_id          AS 经办时所在社区主维人工号
       ,t3.com_vindicate_name        AS 经办时所在社区主维人
       ,t3.com_order_id              AS 经办时所在社区定人工号
       ,t3.com_order_name            AS 经办时所在社区定人
       ,t4.sub_cmnt_nm               AS 出险时所在社区名称
       ,t4.com_vindicate_id          AS 出险时所在社区主维人工号
       ,t4.com_vindicate_name        AS 出险时所在社区主维人
       ,t4.com_order_id              AS 出险时所在社区定人工号
       ,t4.com_order_name            AS 出险时所在社区定人
       ,t4.mgr_id                    AS 出险时管护人工号
       ,t4.mgr_nm                    AS 出险时管护人
       ,t4.mgr_org_id                AS 出险时管护部门机构号
       ,t4.org_nm                    AS 出险时管护部门
from SJXQ_SJ20240814176_CST1231_1015_01      t1
left join SJXQ_SJ20240814176_CST1231_1015_02 t2
on  t1.ctr_srl_no=t2.ctr_srl_no
left join SJXQ_SJ20240814176_CST1231_1015_04 t3
on  t1.ctr_srl_no=t3.ctr_srl_no
left join SJXQ_SJ20240814176_CST1231_1015_05 t4
on  t1.ctr_srl_no=t4.ctr_srl_no
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST1231_1015_02 -- 同一风险控制号下授信金额余额
	GROUP BY  sam_rsk_ctrl_id
) t5 ON t1.cmn_risk_ctrl_id = t5.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST1231_1015_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST1231_1015_02
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST1231_1015_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST1231_1015_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST1231_1015_06
;
SElECT '06' seq, *
from SJXQ_SJ20240814176_CST1231_1015_06
***SJ20240814176_宁波分行普惠业务_20231231_1018.sql
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.bsn_mark_cd
    ,case when t1.bsn_mark_cd='03' then '是' ELSE '否' end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN T1.bsn_mark_cd = '04' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then '是' else '' end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then '是' else '' end is_tyd
    ,coalesce(t3.mgr_id,t6.frs_mgr_id) 	 as mgr_id  --管户人工号|C10
    ,coalesce(t3.mgr_nm,t6.frs_mgr_nm) 	 as mgr_nm	--管户人姓名|C200
    ,coalesce(t3.mgr_org_id,t6.acs_org_id) 	 as mgr_org_id --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,d.preevaluateresult
    ,c2.cd_val_dscr     preevaluateresult_nm
        then 1 else 0 end is_not_mtu
    ,case when t2.PD_NM regexp '信用卡' then 1 else 0 end is_xyk
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240831'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20231231'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240831'
left join edw.DWS_CST_BAS_INF_DD t5
on t1.cst_id=t5.cst_id
and t5.dt='20231231'
left join(
    SELECT distinct cst_id,usc_aply_serno
        ,acs_org_id,frs_mgr_id,frs_mgr_nm
    from edw.dwd_bus_crd_cr_crd_mgr_inf_dd
    where dt='20231231'
) t6 --信用卡管护信息
on t1.rel_serno=t6.usc_aply_serno
and t1.cst_id=t6.cst_id
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  coalesce(t3.mgr_org_id,t6.acs_org_id) = t4.org_id
and t4.dt = '20231231'
left JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      t1.rel_serno = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20231231'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20231231'
left join edw.dwd_code_library_dd       c2
on  d.PREEVALUATERESULT = c2.cd_val
and c2.dt = '20231231'
where t1.dt='20231231'
-- and t4.brc_org_nm regexp '宁波分行' --借据为主表所以不需要限制
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 合同 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_02 AS
SElECT cst_id
    ,sum(is_xfd)        as xfd_num
    ,sum(is_jyd)        as jyd_num
    ,count(ctr_serno)   as ctr_num
    ,sum(ctr_amt)       as cst_ctr_amt	--授信金额
    ,sum(ctr_bal)       as cst_ctr_bal	--授信余额
    -- ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt 不能用均为0
    -- ,sum(case when is_xyk<>1 then ctr_epsr_amt else 0 end) as not_crdt_card_exps_amt
from SJXQ_SJ20240814176_CST1231_1018_01
where LENGTH(cst_id)=10
and is_not_mtu=1
group by cst_ID
;
-- 借据 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_03 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
	,t1.mng_org_id                               --管户机构号
	,t1.mng_brch_id                              --分行
	,t1.acc_type                                 --账户类型
	,t1.cst_nm                                   --客户名称
	,t1.dbil_bal_cny                             --余额
	,t1.grant_amt                                --发放金额
	,t1.grant_date                               --发放日期
	,t1.end_date                                 --到期日期
	,t1.bsn_label                                --业务标识
	,t1.ovd_day                                  --逾期天数
	,t1.prcp_ovd_date                            --本金逾期日期
	,t1.intr_ovd_date                            --利息逾期日期
	,t1.bsn_sts                                  --业务状态
	,t1.cst_id                                   --核心客户编号
	,t1.mng_empe_id                              --管户人工号
	,t1.bsn_line                                 --条线
	,t1.vouch_type                               --担保分类
	,t1.opr_cst_type                             --经营性客户类型
	-- ,t1.cst_authr_crdt_amt                       --客户授信总额
	-- ,t1.cst_authr_crdt_bal                       --客户授信余额
	,t1.ctr_apnt_yr_intr_rate                    --实际利率
	,t1.ovd_prcp_bal                             --逾期本金余额
	,t1.rfin_ctg                                 --重组分类
	,t1.is_yr_new_hpn                            --是否年度新发生
	,t1.hpn_rsk_date                             --出险日期
	,t1.is_rsk_loan                              --是否风险贷款
	,t1.apl_srl_no                               --申请流水号
	,t1.opr_empe_id                              --经办客户经理
	,t1.opr_dept_lead_empe_id                    --经办部门负责人
	,t1.opr_sub_brch_prsd_empe_id                --经办支行行长
	,t1.rvw_empe_id                              --经办审查人
	,t1.final_aprv_empe_id                       --最终审批人
	,t1.opr_org_id                               --经办机构号
	,t1.rsk_lvl                                  --贷后风险判断
	,t1.chk_opnn                                 --贷后管理意见
	,t1.start_dt                                 --任务生成日期
	,t1.rsk_lvl_bef                              --出险前贷后风险判断
	,t1.start_dt_bef                             --出险前任务生成日期
	,t1.hpn_typ_cd                               --发生类型
	,t1.ctr_start_dt                             --合同生效日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t2.empe_nm as mng_empe_nm
    ,t3.org_nm  as mng_org_nm
    ,t3.sbr_org_id,t3.sbr_org_nm
from adm_pub.adm_rsk_app_inter_all          t1 --风险集市应用表-资产质量日常监测源表
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  substr(t1.mng_empe_id,1,6)=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 ---机构树_考核维度  团队
ON      t1.mng_org_id = t3.org_id --主管护机构号=org_id
AND     t3.DT = '20231231'
where t1.dt='20231231'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t3.brc_org_nm ='宁波分行'
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_04 AS
SElECT t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT
    ,t1.sub_cmnt_id,coalesce(t1.sub_cmnt_nm,t5.cmnt_nm) as sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,coalesce(t2.com_vindicate_name,t3.empe_nm)	as  com_vindicate_name   --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,coalesce(t2.com_order_name,t4.empe_nm)	as com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST1231_1018_01     t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.SYS_REG_DT,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20231231'
left join edw.dws_hr_empe_inf_dd t3
on t2.com_vindicate_id = t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd t4
on substr(t2.com_order_id,1,6) = t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_cst_mng_cmnt_inf_dd t5
on t1.sub_cmnt_id=t5.cmnt_enc
and t5.dt='20231231'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_05 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,coalesce(t2.sub_cmnt_nm,t8.cmnt_nm) as sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,coalesce(t3.com_vindicate_name,t6.empe_nm)	as  com_vindicate_name   --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,coalesce(t3.com_order_name,t7.empe_nm)	as com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT distinct cst_id,ctr_srl_no,hpn_rsk_date
    from SJXQ_SJ20240814176_CST1231_1018_03
    where nvl(hpn_rsk_date,'')<>''
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20231231'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20231231'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_srl_no=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20231231'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20231231'
left join edw.dws_hr_empe_inf_dd            t6
on t3.com_vindicate_id = t6.empe_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t7
on substr(t3.com_order_id,1,6) = t7.empe_id
and t7.dt='@@{yyyyMMdd}'
left join edw.dim_cst_mng_cmnt_inf_dd       t8
on t2.sub_cmnt_id=t8.cmnt_enc
and t8.dt='20231231'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_06 AS
SELECT  '20231231' AS 时间分区
    ,case when t5.xfd_num>0 and t5.jyd_num=0 then '是'   --仅消费业务
        when t5.jyd_num>0 and t10.not_crdt_card_exps_amt<=1500000 then '是'
        else '' end as 是否普惠业务
    ,t1.bsn_line              as 条线
    ,t1.mng_empe_id           AS 管户人工号
    ,t1.mng_empe_nm           AS 管户人
    ,t1.mng_org_id            AS 管户机构号
    ,t1.mng_org_nm            AS 管户机构
    ,t1.sbr_org_id            AS 管护支行机构号
    ,t1.sbr_org_nm            AS 管护支行
    ,t1.cst_id                AS 客户号
    ,t1.cst_nm                AS 客户名称
    ,t1.ctr_srl_no            AS 合同流水号
    ,t1.dbil_srl_no           AS 借据流水号
    ,t1.dbil_bal_cny as 贷款规模
    ,t2.PD_NM                 AS 产品名称
    ,t2.is_sdt                AS 是否随贷通
    ,t2.is_tyd                AS 是否泰e贷
    ,t2.is_xfd                AS 是否消费性
    ,t2.ctr_amt               AS 合同金额
    ,t2.ctr_bal               AS 合同余额
    ,t2.ctr_bgn_dt            AS 合同起始日期
    ,t2.ctr_mtu_dt            AS 合同到期日期
    ,t1.prcp_ovd_date         AS 本金逾期日期
    ,t1.intr_ovd_date         AS 利息逾期日期
    ,t1.bsn_sts               AS 业务状态
    ,t1.vouch_type            AS 担保分类
    ,t1.ctr_apnt_yr_intr_rate AS 实际利率
    ,t2.preevaluateresult_nm  AS 预评估结果
    ,CASE WHEN t3.cst_id is not null THEN '是' else '' END AS 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt        AS 最近一次触发时间
    ,t1.ovd_prcp_bal        AS 逾期本金余额
    ,t2.pre_dfd_pre_rpt_ind AS 预保预报标识
    ,t2.bsn_mark_nm         AS 业务标识
    ,t2.is_chongzu          AS 是否重组
    ,t1.is_yr_new_hpn       AS 是否年度新发生
    ,case when t1.hpn_rsk_date>='20230101' then '是' else '' end as 是否近一年新发生风险
    ,t1.is_rsk_loan               AS 是否风险贷款
    ,t4.is_his_dft_cst            AS 历史违约客户标识
    ,t1.opr_empe_id               AS 经办客户经理
    ,t1.opr_dept_lead_empe_id     AS 经办部门负责人
    ,t1.opr_sub_brch_prsd_empe_id AS 经办支行行长
    ,t1.rvw_empe_id               AS 经办审查人
    ,t1.final_aprv_empe_id        AS 最终审批人
    -- ,t5.cst_ctr_epsr_amt          AS 客户号下统一授信敞口
        ,t10.crdt_card_exps_amt     as 信用卡敞口金额
        ,t10.not_crdt_card_exps_amt as 不含信用卡敞口金额
        ,t10.exps_amt               as 客户号下敞口金额
    ,t5.cst_ctr_bal               AS 客户号下总授信余额
    ,t2.sam_rsk_ctrl_id           AS 同一风险控制号
    -- ,t6.同一风险控制号下授信敞口
    ,t9.sam_rsk_ctrl_nbr_credit_amt     as 同一风险控制号下授信总敞口额度
    ,t6.同一风险控制号下授信余额
    ,t7.sub_cmnt_nm               AS 经办时所在社区名称
    ,t7.com_vindicate_id          AS 经办时所在社区主维人工号
    ,t7.com_vindicate_name        AS 经办时所在社区主维人
    ,t7.com_order_id              AS 经办时所在社区定人工号
    ,t7.com_order_name            AS 经办时所在社区定人
    ,t8.sub_cmnt_nm               AS 出险时所在社区名称
    ,t8.com_vindicate_id          AS 出险时所在社区主维人工号
    ,t8.com_vindicate_name        AS 出险时所在社区主维人
    ,t8.com_order_id              AS 出险时所在社区定人工号
    ,t8.com_order_name            AS 出险时所在社区定人
    ,t8.mgr_id                    AS 出险时管护人工号
    ,t8.mgr_nm                    AS 出险时管护人
    ,t8.mgr_org_id                AS 出险时管护部门机构号
    ,t8.org_nm                    AS 出险时管护部门
from SJXQ_SJ20240814176_CST1231_1018_03         t1
left join SJXQ_SJ20240814176_CST1231_1018_01    t2
on t1.ctr_srl_no=t2.ctr_serno
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20231231'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_clab_ln_inf_dd	    t4 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t4.cst_id
and t4.dt='20231231'
left join SJXQ_SJ20240814176_CST1231_1018_02    t5
on t1.cst_id=t5.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST1231_1018_01 -- 同一风险控制号下授信金额余额
    where is_not_mtu=1
	GROUP BY  sam_rsk_ctrl_id
) t6 ON t2.sam_rsk_ctrl_id = t6.sam_rsk_ctrl_id
left join SJXQ_SJ20240814176_CST1231_1018_04 t7
on  t1.ctr_srl_no=t7.ctr_serno
left join SJXQ_SJ20240814176_CST1231_1018_05 t8
on  t1.ctr_srl_no=t8.ctr_srl_no
and t1.hpn_rsk_date=t8.hpn_rsk_date
left join edw.dwd_bus_loan_cre_loa_bal_dd    t9 --客户敞口信息表
on t1.cst_id=t9.cst_id
and t9.dt='20231231'
left join adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd    t10 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
on t1.cst_id=t10.cst_id
and t10.dt='20231231'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST1231_1018_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST1231_1018_08 AS
       ,合同流水号
       ,sum(贷款规模) as 贷款规模
       ,MAX(是否消费性)                               AS 是否消费性
       ,MAX(合同金额)                                AS 合同金额
       ,MAX(合同余额)                                AS 合同余额
       ,MIN(nvl(本金逾期日期,'99991231'))                              AS 本金逾期日期
       ,MIN(nvl(利息逾期日期,'99991231'))                              AS 利息逾期日期
       ,MAX(nvl(最近一次触发时间,''))                            AS 最近一次触发时间
       ,SUM(逾期本金余额)                              AS 逾期本金余额
       ,MAX(客户号下敞口金额)                          AS 客户号下敞口金额
       ,MAX(客户号下总授信余额)                           AS 客户号下总授信余额
       ,MAX(同一风险控制号下授信总敞口额度)                        AS 同一风险控制号下授信总敞口额度
       ,MAX(同一风险控制号下授信余额)                        AS 同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST1231_1018_06
group by 合同流水号
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_1018_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST1231_1018_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ20240814176_CST1231_1018_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST1231_1018_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_srl_no,hpn_rsk_date) custs
from SJXQ_SJ20240814176_CST1231_1018_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 借据流水号) custs
from SJXQ_SJ20240814176_CST1231_1018_06
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST1231_1018_08
;
-- 新信贷 借据维度数据
SElECT '06' seq, *
from SJXQ_SJ20240814176_CST1231_1018_06
;
-- 新信贷 合同维度数据
SElECT '08' seq, *
from SJXQ_SJ20240814176_CST1231_1018_08
;
-- SELECT 管护支行
--         ,sum(CASE
--                WHEN 业务状态 NOT LIKE '%核销%' THEN 贷款规模
--                ELSE 0
--              END) / 10000 AS 贷款规模
-- FROM    SJXQ_SJ20240814176_CST1231_1018_06 a
-- GROUP BY 管护支行
-- ;***SJ20240814176_宁波分行普惠业务_20240731.sql
/*
刘璐005037-消费贷款经营贷款相关信息
SJ20240814176
1、截止20240731和截止20240731的宁波分行存续业务清单
2、是否普惠业务字段口径：
包含两类客户名下的业务合计：
1.名下仅有消费业务的客户；
2.名下有经营业务（含同时有经营和消费业务的情况），总授信敞口金额为150 万元（含）以下的客户。
20240731 20240731 宁波分行 未到期未终结
普惠业务：仅有消费业务、经营+消费业务 总授信敞口150万内
1. 本金逾期日期、利息逾期日期 取 合同第一笔借据的数据
2. 业务状态：正常、核销，按借据汇总。还是取最新？ 借据汇总
3. 合同对应的借据有时间限制吗？还是需要历史所有借据？ 所有借据
4. 是否年度新发生、是否近一年风险贷款、是否风险贷款：存在多笔借据取不同值如何取值？ 汇总
*/
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                        --合同敞口金额|decimal(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t1.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
-- and t4.brc_org_nm regexp '宁波分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240731'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='20240731'
where t1.dt='20240731'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_02 AS
SELECT *
from(
    SELECT  t1.ctr_serno
        ,t2.dbil_srl_no               --借据流水号
        ,t2.dbil_bal_cny              --余额
        ,t2.grant_amt                 --发放金额
        ,t2.grant_date                --发放日期
        ,t2.end_date                  --到期日期
        ,t2.prcp_ovd_date             --本金逾期日期
        ,t2.intr_ovd_date             --利息逾期日期
        ,t2.bsn_sts                   --业务状态
        ,t2.mng_empe_id               --管户人工号
        ,t2.vouch_type	              --担保分类
        ,t2.ctr_apnt_yr_intr_rate     --实际利率
        ,t2.ovd_prcp_bal	          --逾期本金余额
        ,t2.is_yr_new_hpn             --是否年度新发生
        ,t2.hpn_rsk_date	          --出险日期
    ,t2.opr_empe_id               --经办客户经理
    ,t2.opr_dept_lead_empe_id     --经办部门负责人
    ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
    ,t2.rvw_empe_id               --经办审查人
    ,t2.final_aprv_empe_id        --最终审批人
        ,case when nvl(t2.hpn_rsk_date,'')<>'' and t2.hpn_rsk_date>=replace(add_months(to_date(t2.dt,'yyyyMMdd'),-12),'-','')
                then '是' else '否' end   is_lst1y_rsk_loan
        ,t2.is_rsk_loan               --是否风险贷款
        ,t2.dt
        ,row_number() over(partition by t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ20240814176_CST0731_01              t1
    left join adm_rsk.adm_rsk_apl_inter_all	    t2 --风险集市应用表-资产质量日常监测源表
    on t1.ctr_serno=t2.ctr_srl_no
    and t2.dt>='20230101'
    and t2.dt<='20240731'
)t1 where rn=1
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_05 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240731'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240731'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240731'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240731'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 客户维度信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_06 AS
select t1.cst_id                                   --客户号
	,t1.sam_rsk_ctrl_id                            --同一风险控制号
    ,t1.xfd_cnt,t1.jyd_cnt
    ,t1.cst_ctr_amt
    ,t1.cst_ctr_bal
    ,t1.cst_ctr_epsr_amt
    ,t2.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when t3.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt
    ,t4.cny_authr_crdt_amt
    ,t4.cny_authr_crdt_bal
    ,t5.同一风险控制号下授信敞口
    ,t5.同一风险控制号下授信余额
from (
    SElECT cst_id,sam_rsk_ctrl_id
        ,sum(ctr_amt) as  cst_ctr_amt	--授信金额
        ,sum(ctr_bal) as  cst_ctr_bal	--授信余额
        ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt
        ,sum(is_xfd) xfd_cnt
        ,sum(is_jyd) jyd_cnt
    from SJXQ_SJ20240814176_CST0731_01
    where brc_org_nm regexp '宁波分行'
    group by cst_id,sam_rsk_ctrl_id
)t1
left join adm_pub.adm_csm_clab_ln_inf_dd	    t2 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t2.cst_id
and t2.dt='20240731'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt              --任务生成日期
	FROM adm_rsk.ADM_RSK_APL_PRC_PST_LOAN_MNT_DD    --精准贷后-任务宽表
	WHERE dt = '20240731'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join(
    SElECT cst_id
        ,sum(cny_authr_crdt_amt) as  cny_authr_crdt_amt	--授信金额_折人民币
        ,sum(cny_authr_crdt_bal) as  cny_authr_crdt_bal	--授信余额_折人民币
    from adm_rsk.adm_rsk_apl_cst_use_crdt_ctr_info_dd        t1 --风险集市客户授信用信合同维度信息表
    where t1.dt='20240731'
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST0731_01 -- 同一风险控制号下授信金额余额
	GROUP BY  sam_rsk_ctrl_id
) t5 ON t1.sam_rsk_ctrl_id = t5.sam_rsk_ctrl_id
;
-- 字段汇总 借据维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_07 AS
SELECT  t1.ctr_serno                    --合同流水号|C32
       ,t1.cst_id                       --客户号|C20
       ,t1.cst_nm                       --客户名称|C200
       ,t1.is_xfd                       --对私一般贷款 ：个人消费性贷款
       ,t1.is_jyd                       --对私一般贷款 ：个人经营性贷款
       ,t1.ctr_amt                      --合同金额DECIMAL(21,2)
       ,t1.ctr_bal                      --合同余额DECIMAL(21,2)
       ,t1.ctr_bgn_dt                   --合同起始日期
       ,t1.ctr_mtu_dt                   --合同到期日期
       ,t1.exec_intr_rat                --执行利率DECIMAL(13,7)
       ,t1.ovd_amt                      --逾期金额DECIMAL(21,2)
       ,t1.ovd_dt                       --逾期日期|C8
       ,t1.onbs_ovd_intr_bal            --表内欠息余额DECIMAL(21,2)
       ,t1.ofbs_ovd_intr_bal            --表外欠息余额DECIMAL(21,2)
       ,t1.ovd_intr_dt                  --欠息日期|C8
       ,t1.ref_intr_rat                 --参考利率DECIMAL(13,2)
       ,t1.PD_NM
       ,t1.is_sdt
       ,t1.is_tyd
       ,t1.mgr_id                       --管户人工号|C10
       ,t1.mgr_nm                       --管户人姓名|C200
       ,t1.mgr_org_id                   --管户机构号|C12
       ,t1.sbr_org_id
       ,t1.sbr_org_nm
       ,t1.org_nm
       ,t1.pre_dfd_pre_rpt_ind          --预保预报标识
       ,t1.bsn_mark_nm                  --业务标识
       ,t1.is_chongzu
       ,t2.prcp_ovd_date                --本金最早逾期日期
       ,t2.intr_ovd_date                --利息最早逾期日期
       ,t2.rsk_loan_bal
       ,t2.bsn_sts                      --业务状态
       ,t2.vouch_type                   --担保分类
       ,t2.ovd_prcp_bal                 --逾期本金余额
       ,t2.is_yr_new_hpn                --是否年度新发生
       ,t2.is_lst1y_rsk_loan
       ,t2.is_rsk_loan                  --是否风险贷款
       ,t2.opr_empe_id               --经办客户经理
       ,t2.opr_dept_lead_empe_id     --经办部门负责人
       ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
       ,t2.rvw_empe_id               --经办审查人
       ,t2.final_aprv_empe_id        --最终审批人
       ,t5.rul_set_rslt_nm
       ,t6.sam_rsk_ctrl_id              --同一风险控制号
       ,t6.xfd_cnt
       ,t6.jyd_cnt
       ,t6.cst_ctr_amt
       ,t6.cst_ctr_bal
       ,t6.cst_ctr_epsr_amt
       ,t6.is_his_dft_cst               --历史违约客户标识（1是，0否）
       ,t6.是否触发处置类精准贷后
       ,t6.lst_czl_jzdt
       ,t6.cny_authr_crdt_amt
       ,t6.cny_authr_crdt_bal
       ,t6.同一风险控制号下授信敞口
       ,t6.同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST0731_01      t1
left join (
    SElECT ctr_serno
        ,min(prcp_ovd_date) as prcp_ovd_date --本金逾期日期
        ,min(intr_ovd_date) as intr_ovd_date --利息逾期日期
        ,sum(case when is_rsk_loan='Y' then dbil_bal_cny else 0 end) rsk_loan_bal
        ,sum(case when nvl(prcp_ovd_date,'')<>'' then ovd_prcp_bal else 0 end) as ovd_prcp_bal
    from SJXQ_SJ20240814176_CST0731_02
    group by ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST0731_05 t5
on t1.cst_id=t5.cst_id
left join SJXQ_SJ20240814176_CST0731_06 t6
on t1.cst_id=t6.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_08 AS
SELECT  '20240731' AS 时间分区
    ,case when xfd_cnt<>0 and jyd_cnt=0 then '是'   --仅消费业务
        when jyd_cnt<>0 and cny_authr_crdt_amt<=1500000 then '是'
        else '' end as 是否普惠业务
    ,mgr_id                    AS 管户人工号
    ,mgr_nm                    AS 管户人姓名
    ,mgr_org_id                AS 管户机构号
    ,org_nm                    AS 管护机构
    ,sbr_org_id                AS 管护支行机构号
    ,sbr_org_nm                AS 管护支行
    ,cst_id                    AS 客户号
    ,cst_nm                    AS 客户名称
    ,ctr_serno                 AS 合同流水号
    ,PD_NM                     AS 产品名称
    ,is_sdt                    AS 是否随贷通
    ,is_tyd                    AS 是否泰e贷
    ,is_xfd                    AS 是否消费性
    ,ctr_amt                   AS 合同金额
    ,ctr_bal                   AS 合同余额
    ,ctr_bgn_dt                AS 合同起始日期
    ,ctr_mtu_dt                AS 合同到期日期
    ,prcp_ovd_date             AS 本金逾期日期
    ,intr_ovd_date             AS 利息逾期日期
    ,bsn_sts                   AS 业务状态
    ,vouch_type                AS 担保分类
    ,exec_intr_rat             AS 执行利率
    ,rul_set_rslt_nm           AS 新预评估结果
    ,是否触发处置类精准贷后
    ,lst_czl_jzdt              AS 最近一次触发时间
    ,ovd_prcp_bal              AS 逾期本金余额
    ,pre_dfd_pre_rpt_ind       AS 预保预报标识
    ,bsn_mark_nm               AS 业务标识
    ,is_chongzu                AS 是否重组
    ,is_yr_new_hpn             AS 是否年度新发生
    ,is_lst1y_rsk_loan         AS 是否近一年新发生风险
    ,is_rsk_loan               AS 是否风险贷款
    ,is_his_dft_cst            AS 历史违约客户标识
    ,opr_empe_id               AS 经办客户经理
    ,opr_dept_lead_empe_id     AS 经办部门负责人
    ,opr_sub_brch_prsd_empe_id AS 经办支行行长
    ,rvw_empe_id               AS 经办审查人
    ,final_aprv_empe_id        AS 最终审批人
    ,cst_ctr_epsr_amt          AS 客户号下统一授信敞口
    ,cst_ctr_bal               AS 客户号下总授信余额
    ,sam_rsk_ctrl_id           AS 同一风险控制号
    ,同一风险控制号下授信敞口
    ,同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST0731_07
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_02
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0731_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0731_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST0731_08
;
***SJ20240814176_宁波分行普惠业务_20240731_0909.sql
/*
刘璐005037-消费贷款经营贷款相关信息
SJ20240814176
1、截止20240731和截止20240731的宁波分行存续业务清单
2、是否普惠业务字段口径：
包含两类客户名下的业务合计：
1.名下仅有消费业务的客户；
2.名下有经营业务（含同时有经营和消费业务的情况），总授信敞口金额为150 万元（含）以下的客户。
20240731 20240731 宁波分行 未到期未终结
普惠业务：仅有消费业务、经营+消费业务 总授信敞口150万内
1. 本金逾期日期、利息逾期日期 取 合同第一笔借据的数据
2. 业务状态：正常、核销，按借据汇总。还是取最新？ 借据汇总
3. 合同对应的借据有时间限制吗？还是需要历史所有借据？ 所有借据
4. 是否年度新发生、是否近一年风险贷款、是否风险贷款：存在多笔借据取不同值如何取值？ 汇总
*/
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                        --合同敞口金额|decimal(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t1.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
-- and t4.brc_org_nm regexp '宁波分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240731'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='20240731'
where t1.dt='20240731'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_02 AS
SELECT *
from(
    SELECT  t1.cst_id,t1.ctr_serno
        ,t2.dbil_srl_no               --借据流水号
        ,t2.dbil_bal_cny              --余额
        ,t2.grant_amt                 --发放金额
        ,t2.grant_date                --发放日期
        ,t2.end_date                  --到期日期
        ,t2.prcp_ovd_date             --本金逾期日期
        ,t2.intr_ovd_date             --利息逾期日期
        ,t2.bsn_sts                   --业务状态
        ,t2.mng_empe_id               --管户人工号
        ,t2.vouch_type	              --担保分类
        ,t2.ctr_apnt_yr_intr_rate     --实际利率
        ,t2.ovd_prcp_bal	          --逾期本金余额
        ,t2.is_yr_new_hpn             --是否年度新发生
        ,t2.hpn_rsk_date	          --出险日期
    ,t2.opr_empe_id               --经办客户经理
    ,t2.opr_dept_lead_empe_id     --经办部门负责人
    ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
    ,t2.rvw_empe_id               --经办审查人
    ,t2.final_aprv_empe_id        --最终审批人
        ,case when nvl(t2.hpn_rsk_date,'')<>'' and t2.hpn_rsk_date>=replace(add_months(to_date(t2.dt,'yyyyMMdd'),-12),'-','')
                then '是' else '否' end   is_lst1y_rsk_loan
        ,t2.is_rsk_loan               --是否风险贷款
        ,t2.dt
        ,row_number() over(partition by t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ20240814176_CST0731_01              t1
    left join adm_rsk.adm_rsk_apl_inter_all	    t2 --风险集市应用表-资产质量日常监测源表
    on t1.ctr_serno=t2.ctr_srl_no
    and t2.dt>='20230101'
    and t2.dt<='20240731'
)t1 where rn=1
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_03 AS
SElECT t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt
    ,t1.sub_cmnt_id,t1.sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,t2.com_vindicate_name	    --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,t2.com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_serno,t1.ctr_bgn_dt order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST0731_01          t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dt <= '20240831'
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.ctr_bgn_dt,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20240731'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_04 AS
SElECT t1.cst_id,t1.ctr_serno,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,t2.sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,t3.com_vindicate_name	    --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,t3.com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT cst_id,ctr_serno,min(hpn_rsk_date) as hpn_rsk_date
    from SJXQ_SJ20240814176_CST0731_02
    group by cst_id,ctr_serno
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20240731'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20240731'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_serno=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20240731'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20240731'
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_05 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240731'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240731'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240731'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240731'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 客户维度信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_06 AS
select t1.cst_id                                   --客户号
	,t1.sam_rsk_ctrl_id                            --同一风险控制号
    ,t1.xfd_cnt,t1.jyd_cnt
    ,t1.cst_ctr_amt
    ,t1.cst_ctr_bal
    ,t1.cst_ctr_epsr_amt
    ,t2.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when t3.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt
    ,t4.cny_authr_crdt_amt
    ,t4.cny_authr_crdt_bal
    ,t5.同一风险控制号下授信敞口
    ,t5.同一风险控制号下授信余额
from (
    SElECT cst_id,sam_rsk_ctrl_id
        ,sum(ctr_amt) as  cst_ctr_amt	--授信金额
        ,sum(ctr_bal) as  cst_ctr_bal	--授信余额
        ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt
        ,sum(is_xfd) xfd_cnt
        ,sum(is_jyd) jyd_cnt
    from SJXQ_SJ20240814176_CST0731_01
    where brc_org_nm regexp '宁波分行'
    group by cst_id,sam_rsk_ctrl_id
)t1
left join adm_pub.adm_csm_clab_ln_inf_dd	    t2 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t2.cst_id
and t2.dt='20240731'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt              --任务生成日期
	FROM adm_rsk.ADM_RSK_APL_PRC_PST_LOAN_MNT_DD    --精准贷后-任务宽表
	WHERE dt = '20240731'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join(
    SElECT cst_id
        ,sum(cny_authr_crdt_amt) as  cny_authr_crdt_amt	--授信金额_折人民币
        ,sum(cny_authr_crdt_bal) as  cny_authr_crdt_bal	--授信余额_折人民币
    from adm_rsk.adm_rsk_apl_cst_use_crdt_ctr_info_dd        t1 --风险集市客户授信用信合同维度信息表
    where t1.dt='20240731'
    group by cst_id
)t4 on t1.cst_id=t4.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST0731_01 -- 同一风险控制号下授信金额余额
	GROUP BY  sam_rsk_ctrl_id
) t5 ON t1.sam_rsk_ctrl_id = t5.sam_rsk_ctrl_id
;
-- 字段汇总 借据维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_07 AS
SELECT  t1.ctr_serno                    --合同流水号|C32
       ,t1.cst_id                       --客户号|C20
       ,t1.cst_nm                       --客户名称|C200
       ,t1.is_xfd                       --对私一般贷款 ：个人消费性贷款
       ,t1.is_jyd                       --对私一般贷款 ：个人经营性贷款
       ,t1.ctr_amt                      --合同金额DECIMAL(21,2)
       ,t1.ctr_bal                      --合同余额DECIMAL(21,2)
       ,t1.ctr_bgn_dt                   --合同起始日期
       ,t1.ctr_mtu_dt                   --合同到期日期
       ,t1.exec_intr_rat                --执行利率DECIMAL(13,7)
       ,t1.ovd_amt                      --逾期金额DECIMAL(21,2)
       ,t1.ovd_dt                       --逾期日期|C8
       ,t1.onbs_ovd_intr_bal            --表内欠息余额DECIMAL(21,2)
       ,t1.ofbs_ovd_intr_bal            --表外欠息余额DECIMAL(21,2)
       ,t1.ovd_intr_dt                  --欠息日期|C8
       ,t1.ref_intr_rat                 --参考利率DECIMAL(13,2)
       ,t1.PD_NM
       ,t1.is_sdt
       ,t1.is_tyd
       ,t1.mgr_id                       --管户人工号|C10
       ,t1.mgr_nm                       --管户人姓名|C200
       ,t1.mgr_org_id                   --管户机构号|C12
       ,t1.sbr_org_id
       ,t1.sbr_org_nm
       ,t1.org_nm
       ,t1.pre_dfd_pre_rpt_ind          --预保预报标识
       ,t1.bsn_mark_nm                  --业务标识
       ,t1.is_chongzu
       ,t2.prcp_ovd_date                --本金最早逾期日期
       ,t2.intr_ovd_date                --利息最早逾期日期
       ,t2.rsk_loan_bal
       ,t2.bsn_sts                      --业务状态
       ,t2.vouch_type                   --担保分类
       ,t2.ovd_prcp_bal                 --逾期本金余额
       ,t2.is_yr_new_hpn                --是否年度新发生
       ,t2.is_lst1y_rsk_loan
       ,t2.is_rsk_loan                  --是否风险贷款
       ,t2.opr_empe_id               --经办客户经理
       ,t2.opr_dept_lead_empe_id     --经办部门负责人
       ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
       ,t2.rvw_empe_id               --经办审查人
       ,t2.final_aprv_empe_id        --最终审批人
       ,t5.rul_set_rslt_nm
       ,t6.sam_rsk_ctrl_id              --同一风险控制号
       ,t6.xfd_cnt
       ,t6.jyd_cnt
       ,t6.cst_ctr_amt
       ,t6.cst_ctr_bal
       ,t6.cst_ctr_epsr_amt
       ,t6.is_his_dft_cst               --历史违约客户标识（1是，0否）
       ,t6.是否触发处置类精准贷后
       ,t6.lst_czl_jzdt
       ,t6.cny_authr_crdt_amt
       ,t6.cny_authr_crdt_bal
       ,t6.同一风险控制号下授信敞口
       ,t6.同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST0731_01      t1
left join (
    SElECT ctr_serno
        ,min(prcp_ovd_date) as prcp_ovd_date --本金逾期日期
        ,min(intr_ovd_date) as intr_ovd_date --利息逾期日期
        ,sum(case when is_rsk_loan='Y' then dbil_bal_cny else 0 end) rsk_loan_bal
        ,sum(case when nvl(prcp_ovd_date,'')<>'' then ovd_prcp_bal else 0 end) as ovd_prcp_bal
    from SJXQ_SJ20240814176_CST0731_02
    group by ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST0731_05 t5
on t1.cst_id=t5.cst_id
left join SJXQ_SJ20240814176_CST0731_06 t6
on t1.cst_id=t6.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_08 AS
SELECT  '20240731' AS 时间分区
    ,case when xfd_cnt<>0 and jyd_cnt=0 then '是'   --仅消费业务
        when jyd_cnt<>0 and cny_authr_crdt_amt<=1500000 then '是'
        else '' end as 是否普惠业务
    ,t1.mgr_id                    AS 管户人工号
    ,t1.mgr_nm                    AS 管户人姓名
    ,t1.mgr_org_id                AS 管户机构号
    ,t1.org_nm                    AS 管护机构
    ,t1.sbr_org_id                AS 管护支行机构号
    ,t1.sbr_org_nm                AS 管护支行
    ,t1.cst_id                    AS 客户号
    ,t1.cst_nm                    AS 客户名称
    ,t1.ctr_serno                 AS 合同流水号
    ,t1.PD_NM                     AS 产品名称
    ,t1.is_sdt                    AS 是否随贷通
    ,t1.is_tyd                    AS 是否泰e贷
    ,t1.is_xfd                    AS 是否消费性
    ,t1.ctr_amt                   AS 合同金额
    ,t1.ctr_bal                   AS 合同余额
    ,t1.ctr_bgn_dt                AS 合同起始日期
    ,t1.ctr_mtu_dt                AS 合同到期日期
    ,t1.prcp_ovd_date             AS 本金逾期日期
    ,t1.intr_ovd_date             AS 利息逾期日期
    ,t1.bsn_sts                   AS 业务状态
    ,t1.vouch_type                AS 担保分类
    ,t1.exec_intr_rat             AS 执行利率
    ,t1.rul_set_rslt_nm           AS 新预评估结果
    ,t1.是否触发处置类精准贷后
    ,t1.lst_czl_jzdt              AS 最近一次触发时间
    ,t1.ovd_prcp_bal              AS 逾期本金余额
    ,t1.pre_dfd_pre_rpt_ind       AS 预保预报标识
    ,t1.bsn_mark_nm               AS 业务标识
    ,t1.is_chongzu                AS 是否重组
    ,t1.is_yr_new_hpn             AS 是否年度新发生
    ,t1.is_lst1y_rsk_loan         AS 是否近一年新发生风险
    ,t1.is_rsk_loan               AS 是否风险贷款
    ,t1.is_his_dft_cst            AS 历史违约客户标识
    ,t1.opr_empe_id               AS 经办客户经理
    ,t1.opr_dept_lead_empe_id     AS 经办部门负责人
    ,t1.opr_sub_brch_prsd_empe_id AS 经办支行行长
    ,t1.rvw_empe_id               AS 经办审查人
    ,t1.final_aprv_empe_id        AS 最终审批人
    ,t1.cst_ctr_epsr_amt          AS 客户号下统一授信敞口
    ,t1.cst_ctr_bal               AS 客户号下总授信余额
    ,t1.sam_rsk_ctrl_id           AS 同一风险控制号
    ,t1.同一风险控制号下授信敞口
    ,t1.同一风险控制号下授信余额
    ,t2.sub_cmnt_nm                 as  经办时所在社区名称
    ,t2.com_vindicate_id	        as  经办时所在社区主维人工号
    ,t2.com_vindicate_name	        as  经办时所在社区主维人
    ,t2.com_order_id	            as  经办时所在社区定人工号
    ,t2.com_order_name	            as  经办时所在社区定人
    ,t3.sub_cmnt_nm	                as  出险时所在社区名称
    ,t3.com_vindicate_id	        as  出险时所在社区主维人工号
    ,t3.com_vindicate_name	        as  出险时所在社区主维人
    ,t3.com_order_id	            as  出险时所在社区定人工号
    ,t3.com_order_name	            as  出险时所在社区定人
    ,t3.mgr_id	                    as  出险时管护人工号
    ,t3.mgr_nm	                    as  出险时管护人
    ,t3.mgr_org_id	                as  出险时管护部门机构号
    ,t3.org_nm                      as  出险时管护部门
from SJXQ_SJ20240814176_CST0731_07      t1
left join SJXQ_SJ20240814176_CST0731_03 t2
on  t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20240814176_CST0731_04 t3
on  t1.ctr_serno=t3.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0731_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0731_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST0731_08
;
***SJ20240814176_宁波分行普惠业务_20240731_1015.sql
-- 近一年新发生风险贷款客户数/本年新发生风险贷款客户数 逻辑两者搞反了 后续需要调整回来
ALTER TABLE DIM_BUS_DBIL_LABEL_INTER_INF_DD DROP IF EXISTS PARTITION ( DT = '20240731' );
INSERT INTO TABLE DIM_BUS_DBIL_LABEL_INTER_INF_DD PARTITION (DT = '20240731')
SELECT  p.ctr_srl_no
        ,p.dbil_srl_no
        ,p.mng_org_id
        ,p.mng_brch_id
        ,p.acc_type
        ,p.cst_nm
        ,p.dbil_bal_cny
        ,p.grant_amt
        ,p.grant_date
        ,p.end_date
        ,p.five_level_ctg
        ,p.indsy_inv_drc
        ,p.indsy_cbn
        ,p.bsn_label
        ,p.ovd_day
        ,p.prcp_ovd_date
        ,p.intr_ovd_date
        ,p.cpn_size
        ,p.bsn_sts
        ,p.cst_id
        ,p.core_org_id
        ,p.mng_empe_id
        ,p.grant_org_id
        ,p.grant_empe_id
        ,p.bsn_line
        ,p.main_vouch_type
        ,p.cltrl_type
        ,p.vouch_type
        ,p.start_vouch_type
        ,p.loan_usg
        ,p.rtrn_prcp_calc_intr_cd
        ,p.pblc_cst_ctg
        ,p.opr_cst_type
        ,p.cst_authr_crdt_amt
        ,p.cst_authr_crdt_bal
        ,p.nrm_prcp_bal_sbj_id
        ,p.ovd_prcp_amt_sbj_id
        ,p.ctr_apnt_yr_intr_rate
        ,p.ovd_prcp_bal
        ,p.shd_calc_intr
        ,p.table_extn_debt_intr
        ,p.start_ctr_srl_no_1
        ,p.start_dbil_srl_no_1
        ,p.start_cst_nm_1
        ,p.start_ctr_srl_no_2
        ,p.start_dbil_srl_no_2
        ,p.start_cst_nm_2
        ,p.mrgn_amt
        ,p.cltrl_value
        ,p.wvr_rspns_rsn
        ,p.other_and_memo
        ,p.rfin_ctg
        ,p.rsk_cost
        ,p.is_yr_new_hpn
        ,p.hpn_rsk_date
        ,p.is_rsk_loan
        ,p.apl_srl_no
        ,p.opr_empe_id
        ,p.opr_dept_lead_empe_id
        ,p.opr_sub_brch_prsd_empe_id
        ,p.rvw_empe_id
        ,p.final_aprv_empe_id
        ,p.opr_org_id
        ,p.start_cst_id
        ,p.start_cst_nm
        ,p.rsk_lvl
        ,p.chk_opnn
        ,p.start_dt
        ,p.rsk_lvl_bef
        ,p.start_dt_bef
        ,p.start_ctr_mng_emp_id
        ,p.start_ctr_opr_dept_lead_empe_id
        ,p.start_ctr_opr_sub_brch_prsd_empe_id
        ,p.hpn_typ_cd
        ,p.ctr_start_dt
        ,p.ctr_mtu_dt
        ,'' indsy_cbn_new
        ,c2.cmn_risk_ctrl_id --同一风险控制号
        ,c6.sam_rsk_ctrl_cst_xpos_amt --同一风险控制号授信总额
        ,c2.bsn_type_cd ---业务品种
        ,(
         CASE
           WHEN length(p.mng_brch_id) = 2                                     THEN '分行'
           WHEN p.mng_brch_id IN ( '总行部门' , '科技企业' ) OR p.mng_brch_id IS NULL THEN '其他'
           ELSE '村行'
         END
        )    AS fh_ch ---分行/村行
        ,c10.brc_org_id --分行层级机构编号
        ,C10.brc_org_nm --分行层级机构名称
        ,c10.sbr_org_id --支行层级机构编号
        ,C10.sbr_org_nm --支行层级机构名称
        ,c10.tem_org_id --团队层级机构编号
        ,C10.tem_org_nm --团队层级机构名称
        ,(
         CASE
           WHEN p.ovd_day > 0 AND p.ovd_day <= 30     THEN '1-逾期0-30天'
           WHEN p.ovd_day > 30 AND p.ovd_day <= 60    THEN '2-逾期30-60天'
           WHEN p.ovd_day > 60 AND p.ovd_day <= 180   THEN '3-逾期60-180天'
           WHEN p.ovd_day > 180 AND p.ovd_day <= 360  THEN '4-逾期180-360天'
           WHEN p.ovd_day > 360 AND p.ovd_day <= 720  THEN '5-逾期360-720天'
           WHEN p.ovd_day > 720 AND p.ovd_day <= 1080 THEN '6-逾期720-1080天'
           WHEN p.ovd_day > 1080                      THEN '7-逾期1080天以上'
           WHEN p.ovd_day = 0                         THEN '8-未逾期'
         END
        )    AS ovd_type --逾期结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 6                                                                                              THEN '1-借据期限6个月（含）以内'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 6 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 12  THEN '2-借据期限6个月-12个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 12 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 24 THEN '3-借据期限12个月-24个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 24 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 36 THEN '4-借据期限24个月-36个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 36 AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') <= 48 THEN '5-借据期限36个月-48个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(p.end_date, 'yyyymmdd'), to_date(p.grant_date, 'yyyymmdd'), 'MM') > 48                                                                                              THEN '6-借据期限48个月以上'
           ELSE '信用卡'
         END
        )    AS period_type_dbil --借据期限结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 6                                                                                                        THEN '1-合同期限6个月（含）以内'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 6 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 12  THEN '2-合同期限6个月-12个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 12 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 24 THEN '3-合同期限12个月-24个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 24 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 36 THEN '4-合同期限24个月-36个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 36 AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') <= 48 THEN '5-合同期限36个月-48个月（含）'
           WHEN p.acc_type <> '信用卡' AND datediff(to_date(c2.ctr_end_date, 'yyyymmdd'), to_date(c2.ctr_start_date, 'yyyymmdd'), 'MM') > 48                                                                                                        THEN '6-合同期限48个月以上'
           ELSE '信用卡'
         END
        )    AS period_type_ctr --合同期限结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 >= 0 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 6    THEN '1-年化利率[0,6]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 6 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 8     THEN '2-年化利率(6,8]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 8 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 10    THEN '3-年化利率(8,10]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 10 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 12   THEN '4-年化利率(10,12]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 12 AND p.ctr_apnt_yr_intr_rate * 1.2 <= 14.4 THEN '5-年化利率(12,14.4]'
           WHEN p.acc_type <> '信用卡' AND p.ctr_apnt_yr_intr_rate * 1.2 > 14.4                                         THEN '6-年化利率(14.4,&infin;)'
           ELSE '信用卡'
         END
        )    AS intst_rate_type_dbil --借据利率结构
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 >= 0 AND c2.ctr_yr_intr_rate * 100 <= 6    THEN '1-年化利率[0,6]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 6 AND c2.ctr_yr_intr_rate * 100 <= 8     THEN '2-年化利率(6,8]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 8 AND c2.ctr_yr_intr_rate * 100 <= 10    THEN '3-年化利率(8,10]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 10 AND c2.ctr_yr_intr_rate * 100 <= 12   THEN '4-年化利率(10,12]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 12 AND c2.ctr_yr_intr_rate * 100 <= 14.4 THEN '5-年化利率(12,14.4]'
           WHEN p.acc_type <> '信用卡' AND c2.ctr_yr_intr_rate * 100 > 14.4                                     THEN '6-年化利率(14.4,&infin;)'
           ELSE '信用卡'
         END
        )    AS intst_rate_type_ctr -- 合同利率结构
        ,(
         CASE
           WHEN c2.hpn_type_cd = '010' THEN '1-首笔'
           WHEN c2.hpn_type_cd = '011' THEN '2-续做'
           WHEN c2.hpn_type_cd = '070' THEN '3-垫款'
           WHEN c2.hpn_type_cd = '610' THEN '4-卡片申请'
           WHEN c2.hpn_type_cd = '650' THEN '5-卡片续卡'
           ELSE '6-其他'
         END
        )    AS hpn_type --发生类型
        ,(
         CASE
           WHEN SUBSTR(A6.cnr_lvl_id_cd, 1, 4) <> SUBSTR(A8.cnr_cd, 1, 4) THEN '异地'
           ELSE '非异地'
         END
        )    AS is_rmot --是否异地
        ,(
         CASE
           WHEN ( c2.rcyc_loan_label_cd = '1' OR c2.bsn_type_cd LIKE '2010503%' ) AND c2.bsn_type_cd NOT LIKE '2010402%' AND c2.bsn_type_cd NOT LIKE '20108%' THEN '循环'
           ELSE '非循环'
         END
        )    AS rvlv_loan --循环贷款
        ,(
         CASE
           WHEN c2.bsn_type_cd LIKE '2010503%' THEN '随贷通'
           ELSE '非随贷通'
         END
        )    AS sdt --随贷通
        ,(
         CASE
           WHEN p.acc_type = '信用卡' THEN '信用卡'
           ELSE '非信用卡'
         END
        )    AS credit_card --信用卡
        ,(
         CASE
           WHEN c9.is_ntw_apl_card = '1' THEN '网申卡'
           ELSE '非网申卡'
         END
        )    AS wsk --网申卡
        ,(
         CASE
           WHEN c2.not_gap_reloan_type_cd IN ( '1' , '3' ) THEN '接力贷'
           ELSE '非接力贷'
         END
        )    AS jld --接力贷
        ,(
         CASE
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt <= 100000                                             THEN '1-额度10万（含）以下'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 100000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 300000   THEN '2-额度10万-30万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 300000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 500000   THEN '3-额度30万-50万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 500000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 1000000  THEN '4-额度50万-100万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 1000000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 1500000 THEN '5-额度100万-150万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 1500000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 3000000 THEN '6-额度150万-300万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 3000000 AND c6.sam_rsk_ctrl_cst_xpos_amt <= 5000000 THEN '7-额度300万-500万（含）'
           WHEN p.acc_type <> '信用卡' AND c6.sam_rsk_ctrl_cst_xpos_amt > 5000000                                             THEN '8-额度500万以上'
           ELSE '信用卡'
         END
        )    AS quota_type  ----额度结构
        ,CASE
           WHEN coalesce(C11.busi_ctr_id, '') <> '' THEN '泰e贷'
           ELSE '非泰e贷'
         END AS ted --泰e贷
        ,(
         CASE
           ELSE '否'
         END
        )    AS is_rsk_loan_thsm --本月底是否风险贷款
        ,(
         CASE
           ELSE '否'
         END
        )    AS is_rsk_loan_nxtm  --下月底是否风险贷款
        ,m7.not_crdt_card_exps_amt
        ,CASE
           WHEN p.acc_type LIKE '%信用卡%' AND COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) NOT LIKE '201050203%' THEN '信用卡'
           WHEN yw.num_xf > 0 AND yw.num_jy = 0                                                            THEN '普惠' -- 客户为只有消费业务
           WHEN yw.num_jy > 0 AND m7.not_crdt_card_exps_amt <= 1500000                                     THEN '普惠' -- 客户为经营类业务（经营或消费同时存在），办理业务总敞口金额 150 万元（含）以下的信贷业务。
           WHEN yw.num_jy > 0 AND m7.not_crdt_card_exps_amt > 1500000                                      THEN '小企业'
           WHEN yw.num_jy > 0 AND COALESCE(m7.not_crdt_card_exps_amt, '') = ''                             THEN '无授信额度'
         END AS is_ph ---普惠/小企业
        ,CASE
           WHEN b2.loan_cst_typ_cd = '0704' THEN '工薪'
           WHEN b2.loan_cst_typ_cd = '0705' THEN '其他'
           ELSE '经营'
         END AS jy_gx_tag --经营/工薪
        ,CASE
           WHEN p.cst_id LIKE '2%'       THEN '对公客户'
           WHEN m11.two_people_ind = '2' THEN '农民'
           WHEN m11.two_people_ind = '1' THEN '市民'
           ELSE '其他'
         END AS is_farm --农民/市民
        ,CASE
           WHEN coalesce(t2.not_crdt_card_exps_amt, '') = '' OR t2.not_crdt_card_exps_amt <= 0 THEN '1.未授信'
           WHEN t2.not_crdt_card_exps_amt > 0 AND t2.not_crdt_card_exps_amt <= 500000          THEN '2.授信<=50万'
           WHEN t2.not_crdt_card_exps_amt > 500000 AND t2.not_crdt_card_exps_amt <= 1500000    THEN '3.授信<=150万'
           WHEN t2.not_crdt_card_exps_amt > 1500000                                            THEN '4.授信>150万'
           ELSE '5.其他'
         END AS amt_tag --客户级敞口金额_不含信用卡
        ,CASE
           WHEN COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201050101%'                                 THEN '消费'
           WHEN COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '2010503%' AND money_usg_cd LIKE '02%'       THEN '消费'
           WHEN ( COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201050102%' ---一般经营性贷款，个人+对公
OR COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201040101%' --流动资金贷款
OR COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201040102%' --固定资产贷款
OR COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '201040106%' --法人购房贷款
OR ( COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) LIKE '2010503%' AND money_usg_cd LIKE '01%' ) ) --随贷通经营
                                                                                                           THEN '经营'
           WHEN p.acc_type LIKE '%信用卡%' AND COALESCE(c2.bsn_type_cd, c9.bsn_type_cd) NOT LIKE '201050203%' THEN '信用卡'
           ELSE '其他'
         END jy_tag ---消费/经营
        ,CASE
           WHEN spc_bsn_label_cd IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) THEN '员工贷款'
           ELSE '非员工贷款'
         END AS emplye_loan -- 是否员工贷款
        ,CASE
           WHEN m8.cst_id IS NOT NULL THEN '烟火商户'
           ELSE '非烟火商户'
         END AS is_yh ---烟火标签
        ,CASE
           WHEN coalesce(T9.CST_ID, '') <> '' THEN '人人可贷'
           ELSE '非人人可贷'
         END IS_RRKD --人人可贷标签
FROM    adm_rsk.adm_rsk_apl_inter_all p
LEFT JOIN    adm_rsk.adm_rsk_ast_loan_dbil_inf_dd c1 --风险集市信贷业务借据信息表
ON      p.dbil_srl_no = c1.dbil_srl_no
AND     c1.dt = '20240731'
LEFT JOIN    adm_rsk.adm_rsk_ast_loan_ctr_inf_dd c2 --风险集市信贷业务合同信息表
ON      p.ctr_srl_no = c2.ctr_srl_no
AND     c2.dt = '20240731'
LEFT JOIN    adm_rsk.ADM_RSK_AST_CARD_CRDT_ACC_INF_DD c5 --风险集市信用卡账户信息表
ON      c5.crdt_card_acc = p.ctr_srl_no
AND     c5.dt = '20240731'
LEFT JOIN    adm_rsk.ADM_RSK_AST_CARD_CRDT_CARD_BAS_INF_DD c9 --风险集市信用卡卡片基本信息表
ON      p.dbil_srl_no = c9.crdt_card_id
AND     c9.dt = '20240731'
LEFT JOIN    edw.dws_bus_loan_sam_rsk_ctrl_inf_dd c6 --贷款同一风险控制号信息
ON      c6.sam_rsk_ctrl_id = c2.cmn_risk_ctrl_id
AND     c6.dt = '20240731'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd A6 --客户户籍地址
ON      p.cst_id = A6.cst_id
AND     A6.dt = '20240731'
AND     A6.phy_adr_typ_cd = '050100'
LEFT JOIN    edw.dim_hr_org_bas_inf_dd A8
ON      p.mng_org_id = A8.org_id
AND     A8.dt = '20240731'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd C10 ---机构树_考核维度  团队
ON      p.mng_org_id = C10.org_id --主管护机构号=org_id
AND     C10.DT = '20240731'
LEFT JOIN    (
                 SELECT  T1.apl_srl_nbr -- 进件流水号
                         ,COALESCE(t3.busi_ctr_id, t1.RELOAN_CTR_ID) AS busi_ctr_id -- 合同流水号
                 FROM    EDW.DWD_BUS_LOAN_ENTR_FORM_DD T1 -- 信贷业务进件单信息
                 LEFT JOIN    EDW.DWD_BUS_LOAN_REL_APL_INF_DD T2 -- 信贷业务关联申请信息
                 ON      T1.APL_SRL_NBR = T2.REL_OBJ_ID -- 进件流水号
                 AND     T2.REL_OBJ_TYP = 'EntryForm' -- 关联类型为进件
                 AND     T2.DT = '20240731'
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_INF_DD T3 -- 信贷合同信息
                 ON      T2.APL_SRL_NBR = T3.BUSI_APL_ID -- 业务申请流水号
                 AND     T3.DT = '20240731'
                 WHERE   T1.DT = '20240731'
                 AND     ( T1.APL_SRC_TYP_CD = '060' -- 进件业务来源 等于 060泰e贷
                     OR ( T1.APL_SRC_TYP_CD = '050'
                 AND     T1.APL_STYP = '050010' ) -- 泰e贷-随贷通卡进件
                     OR ( T1.APL_SRC_TYP_CD = '090'
                 AND     T1.APL_STYP = '090010' ) -- 泰e贷-备用金
)
             ) C11
ON      p.ctr_srl_no = C11.busi_ctr_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20240731'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) m7
ON      p.cst_id = m7.cst_id
AND     m7.RANK1 = 1
LEFT JOIN    (
                 SELECT  y.cst_id
                         ,SUM(CASE
                                WHEN y.jy_tag = '消费' THEN 1
                                ELSE 0
                              END) num_xf
                         ,SUM(CASE
                                WHEN y.jy_tag = '经营' THEN 1
                                ELSE 0
                              END) num_jy
                         ,COUNT(y.busi_ctr_id) num_ctr
                 FROM    (
                             SELECT  cst_id
                                     ,busi_ctr_id
                                     -- 消费性业务
                                     -- 贷款类
                                     -- 个人消费
                                     -- 随贷通消费
                                     -- 经营性业务
                                     -- 贷款类
                                     -- 一般经营性贷款，个人+对公|流动资金贷款|固定资产贷款|法人购房贷款
                                     -- 随贷通经营
                                     -- 其他
                                     -- 票据承兑|票据贴现|承兑垫款|保函垫款|信用证垫款|代付垫款|贸易融资
                                     ,CASE
                                        WHEN pd_cd LIKE '201050101%' OR ( pd_cd LIKE '2010503%' AND loan_usg_cd LIKE '02%' )                                                                                                                             THEN '消费'
                                        WHEN ( pd_cd REGEXP '^201050102|^201040101|^201040102|^201040106' OR ( pd_cd LIKE '2010503%' AND loan_usg_cd LIKE '01%' ) OR pd_cd REGEXP '^201040201|^201040202|^2010801|^2010802|^2010803|^2010804|^2010403' ) THEN '经营'
                                        WHEN pd_cd LIKE '2010502%' AND pd_cd NOT LIKE '201050203%'                                                                                                                                                       THEN '信用卡'
                                        ELSE '其他'
                                      END jy_tag
                             FROM    edw.dim_bus_loan_ctr_inf_dd
                             WHERE   dt = '20240731'
                         ) y
                 GROUP BY y.cst_id
             ) yw
ON      m7.cst_id = yw.cst_id
LEFT JOIN    edw.dws_cst_bas_inf_dd b2
ON      b2.cst_id = p.cst_id
AND     b2.dt = '20240731'
LEFT JOIN    (
                 SELECT  DISTINCT dt
                                  ,cst_id
                                  ,two_people_ind
                                  ,new_citizen
                 FROM    adm_pub.adm_csm_clab_cst_inf_cmpn_idv_inf_dd --客户集市-客户标签信息-客户信息-营销-对私客户
                 WHERE   dt = '20240731'
             ) m11
ON      p.cst_id = m11.cst_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20240731'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) t2
ON      t2.cst_id = p.cst_id
AND     t2.RANK1 = 1
LEFT JOIN    (
                 SELECT  DISTINCT dt
                                  ,cst_id
                 FROM    adm_pub.adm_csm_clab_cst_jc_inf_dd ----客户集市-客户标签信息-客户信息-决策
                 WHERE   dt = '20240731'
                 AND     yh_mch IN ( '1' , '2' , '3' )
             ) m8
ON      p.cst_id = m8.cst_id
LEFT JOIN    (
                 --判断是否人人可贷
                 SELECT  T2.cst_id
                 FROM    edw.dwd_cst_mng_cmnt_rel_dd T2 -- 客户社区信息
                 INNER JOIN    EDW.dim_cst_mng_cmnt_inf_dd T3 -- 社区信息
                 ON      T3.cmnt_enc = T2.sub_cmnt_id -- 子社区编号
                 AND     ( ( T3.APRV_STS_CD <> '-1' -- 社区审批状态: -1删除 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过) 7审批中(审批拒绝修改) 9暂转移
                 AND     T3.OPR_TYP_CD >= '2' -- 操作类型: 1增加 2修改 3删除 4转移 5认领
)
                     OR T3.APRV_STS_CD IN ( '5' , '9' ) )
                 AND     T3.CMNT_TYP_CD IN ( '03' , '05' ) -- 社区类型为 子社区 或 虚拟子社区
                 AND     COALESCE(TRIM(T3.AFL_ORG_ID), ' ') <> ' ' -- 所属机构id 不为 空
                 AND     T3.VLG_LOAN_SUB_CMNT_IND = '1' -- 是否农村人人可贷子社区1：是 0否
                 AND     T3.DT = '20240731'
                 -- 查询子社区所属的综合社区板块
                 INNER JOIN    EDW.dim_cst_mng_cmnt_inf_dd T4 -- 社区信息
                 ON      T4.cmnt_enc = T2.cprh_cmnt_plt_id
                 AND     ( ( T4.APRV_STS_CD <> '-1' -- 社区审批状态: -1删除 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过) 7审批中(审批拒绝修改) 9暂转移
                 AND     T4.OPR_TYP_CD >= '2' -- 操作类型: 1增加 2修改 3删除 4转移 5认领
)
                     OR T4.APRV_STS_CD IN ( '5' , '9' ) )
                 AND     T4.CMNT_TYP_CD = '02' -- 社区类型为 综合社区版块
                 AND     COALESCE(TRIM(T4.AFL_ORG_ID), ' ') <> ' ' -- 所属机构id 不为 空
                 AND     T4.DT = '20240731'
                 -- 查询综合社区板块所属的综合社区
                 INNER JOIN    EDW.dim_cst_mng_cmnt_inf_dd T5 -- 社区信息
                 ON      T5.cmnt_enc = T2.cprh_cmnt_id
                 AND     ( ( T5.APRV_STS_CD <> '-1' -- 社区审批状态: -1删除 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过) 7审批中(审批拒绝修改) 9暂转移
                 AND     T5.OPR_TYP_CD >= '2' -- 操作类型: 1增加 2修改 3删除 4转移 5认领
)
                     OR T5.APRV_STS_CD IN ( '5' , '9' ) )
                 AND     T5.CMNT_TYP_CD = '01' -- 社区类型为 综合社区
                 AND     COALESCE(TRIM(T5.AFL_ORG_ID), ' ') <> ' ' -- 所属机构id 不为 空
                 AND     T5.DT = '20240731'
                 WHERE   T2.DT = '20240731'
             ) T9
ON      T9.cst_id = p.cst_id
WHERE   p.dt = '20240731'
;
-- 借据汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1015_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1015_01 AS
select ctr_srl_no                        --合同流水号
    ,sum(case when bsn_sts NOT LIKE '%核销%' then dbil_bal_cny else 0 end) as  dbil_bal_cny 	--余额
    ,sum(grant_amt) as  grant_amt 	--发放金额
    ,min(grant_date) as  grant_date 	--发放日期
    ,max(end_date) as  end_date 	--到期日期
    ,min(prcp_ovd_date) as  prcp_ovd_date 	--本金逾期日期
    ,min(intr_ovd_date) as  intr_ovd_date 	--利息逾期日期
    ,max(cst_authr_crdt_amt) as  cst_authr_crdt_amt 	--客户授信总额
    ,max(cst_authr_crdt_bal) as  cst_authr_crdt_bal 	--客户授信余额
    ,sum(ovd_prcp_bal) as  ovd_prcp_bal 	--逾期本金余额
    ,min(hpn_rsk_date) as  hpn_rsk_date 	--出险日期
    ,min(ctr_start_dt) as  ctr_start_dt 	--合同生效日期
    ,max(ctr_mtu_dt) as  ctr_mtu_dt 	--合同到期日期
    ,sum(amt_tag) as  amt_tag 	--客户级敞口金额_不含信用卡
from DIM_BUS_DBIL_LABEL_INTER_INF_DD        t1
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  t1.mng_empe_id=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd C10 ---机构树_考核维度  团队
ON      t1.mng_org_id = C10.org_id --主管护机构号=org_id
AND     C10.DT = '20240731'
where t1.dt='20240731'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t1.brc_org_nm ='宁波分行'
group by t1.ctr_srl_no
;
-- 合同维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1015_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1015_02 AS
SElECT t1.ctr_srl_no
    ,T2.rel_serno
    ,t2.prd_no
	,t2.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t2.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t2.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t2.ctr_bgn_dt                               --合同起始日期
	,t2.ctr_mtu_dt                               --合同到期日期
    ,t2.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t2.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,CASE WHEN NVL(T2.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t2.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t2.ovd_dt	                                --逾期日期
    ,t3.pd_nm
    ,case when t4.cst_id is not null then 1 else 0 end as 是否触发处置类精准贷后
    ,t4.lst_czl_jzdt
    ,t5.is_his_dft_cst	                    --历史违约客户标识（1是，0否）
    ,case when nvl(t6.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t6.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from(
    select distinct ctr_srl_no
    from SJXQ_SJ20240814176_CST0731_1015_01
)t1 left join edw.dim_bus_loan_ctr_bse_inf_dd        t2 --合同基础信息
ON T1.ctr_srl_no=T2.ctr_serno
AND T2.DT='20240731'
left join edw.dim_bus_loan_prd_frml_dd     t3
on t2.prd_no=t3.prd_no
and t3.dt='20240731'
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt              --任务生成日期
	FROM adm_rsk.ADM_RSK_APL_PRC_PST_LOAN_MNT_DD    --精准贷后-任务宽表
	WHERE dt = '20240731'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t4 on t2.cst_id=t4.cst_id
left join adm_pub.adm_csm_clab_ln_inf_dd	    t5 --客户集市-标签层-信贷客户标签信息表
on t2.cst_id=t5.cst_id
and t5.dt='20240731'
left join edw.DWS_CST_BAS_INF_DD t6
on t2.cst_id=t6.cst_id
and t6.dt='20240731'
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1015_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1015_03 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240731'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240731'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240731'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240731'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1015_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1015_04 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.ctr_start_dt
    ,t1.sub_cmnt_id,t1.sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,t2.com_vindicate_name	    --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,t2.com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_srl_no,t1.ctr_start_dt
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_srl_no,t1.ctr_start_dt order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST0731_1015_01     t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dt <= '20240831'
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.ctr_start_dt,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20240731'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1015_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1015_05 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,t2.sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,t3.com_vindicate_name	    --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,t3.com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT DISTINCT cst_id,ctr_srl_no,hpn_rsk_date
    from SJXQ_SJ20240814176_CST0731_1015_01
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20240731'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20240731'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_srl_no=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20240731'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20240731'
;
-- 输出结果 20240731
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1015_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1015_06 AS
SELECT  '20240731'                   AS 时间分区
       ,is_ph                        AS 是否普惠业务
       ,t1.mng_empe_id               AS 管户人工号
       ,t1.mng_empe_nm               AS 管户人姓名
       ,t1.mng_org_id                AS 管户机构号
       ,t1.mng_org_nm                AS 管护机构
       ,t1.sbr_org_id                AS 管护支行机构号
       ,t1.sbr_org_nm                AS 管护支行
       ,t1.cst_id                    AS 客户号
       ,t1.cst_nm                    AS 客户名称
       ,t1.ctr_srl_no                AS 合同流水号
       ,t2.PD_NM                     AS 产品名称
       ,t1.sdt                       AS 是否随贷通
       ,t1.ted                       AS 是否泰e贷
       ,t1.jy_tag                    AS 是否消费性
       ,t2.ctr_amt                   AS 合同金额
       ,t2.ctr_bal                   AS 合同余额
       ,t2.ctr_bgn_dt                AS 合同起始日期
       ,t2.ctr_mtu_dt                AS 合同到期日期
       ,t1.prcp_ovd_date             AS 本金逾期日期_最早
       ,t1.intr_ovd_date             AS 利息逾期日期_最早
       ,t1.bsn_sts                   AS 业务状态_汇总
       ,t1.vouch_type                AS 担保分类_汇总
       ,t2.exec_intr_rat             AS 执行利率
       ,t6.rul_set_rslt_nm      AS 预评估结果
       ,t2.是否触发处置类精准贷后
       ,t2.lst_czl_jzdt              AS 最近一次触发时间
       ,t1.ovd_prcp_bal              AS 逾期本金余额
       ,T2.pre_dfd_pre_rpt_ind       AS 预保预报标识
       ,t1.bsn_label                 AS 业务标识
       ,t2.is_chongzu                AS 是否重组
       ,t1.is_yr_new_hpn             AS 是否年度新发生
       ,t1.is_lst1y_rsk_loan         AS 是否近一年新发生风险
       ,t1.is_rsk_loan               AS 是否风险贷款
       ,t2.is_his_dft_cst            AS 历史违约客户标识
       ,t1.opr_empe_id               AS 经办客户经理
       ,t1.opr_dept_lead_empe_id     AS 经办部门负责人
       ,t1.opr_sub_brch_prsd_empe_id AS 经办支行行长
       ,t1.rvw_empe_id               AS 经办审查人
       ,t1.final_aprv_empe_id        AS 最终审批人
       ,t1.amt_tag                   AS 客户级敞口金额
       ,t1.cst_authr_crdt_bal        AS 客户授信余额
       ,t1.cmn_risk_ctrl_id          AS 同一风险控制号
       ,t5.同一风险控制号下授信敞口
       ,t5.同一风险控制号下授信余额
       ,t3.sub_cmnt_nm               AS 经办时所在社区名称
       ,t3.com_vindicate_id          AS 经办时所在社区主维人工号
       ,t3.com_vindicate_name        AS 经办时所在社区主维人
       ,t3.com_order_id              AS 经办时所在社区定人工号
       ,t3.com_order_name            AS 经办时所在社区定人
       ,t4.sub_cmnt_nm               AS 出险时所在社区名称
       ,t4.com_vindicate_id          AS 出险时所在社区主维人工号
       ,t4.com_vindicate_name        AS 出险时所在社区主维人
       ,t4.com_order_id              AS 出险时所在社区定人工号
       ,t4.com_order_name            AS 出险时所在社区定人
       ,t4.mgr_id                    AS 出险时管护人工号
       ,t4.mgr_nm                    AS 出险时管护人
       ,t4.mgr_org_id                AS 出险时管护部门机构号
       ,t4.org_nm                    AS 出险时管护部门
from SJXQ_SJ20240814176_CST0731_1015_01      t1
left join SJXQ_SJ20240814176_CST0731_1015_02 t2
on  t1.ctr_srl_no=t2.ctr_srl_no
left join SJXQ_SJ20240814176_CST0731_1015_04 t3
on  t1.ctr_srl_no=t3.ctr_srl_no
left join SJXQ_SJ20240814176_CST0731_1015_05 t4
on  t1.ctr_srl_no=t4.ctr_srl_no
left join SJXQ_SJ20240814176_CST0731_1015_03 t6
on t1.cst_id=t6.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST0731_1015_02 -- 同一风险控制号下授信金额余额
	GROUP BY  sam_rsk_ctrl_id
) t5 ON t1.cmn_risk_ctrl_id = t5.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST0731_1015_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST0731_1015_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0731_1015_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST0731_1015_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20240814176_CST0731_1015_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST0731_1015_06
;
SElECT '06' seq, *
from SJXQ_SJ20240814176_CST0731_1015_06
***SJ20240814176_宁波分行普惠业务_20240731_1018.sql
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.bsn_mark_cd
    ,case when t1.bsn_mark_cd='03' then '是' ELSE '否' end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = '04' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then'是' else '' end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then'是' else '' end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
        then 1 else 0 end is_not_mtu
    ,case when t2.PD_NM regexp '信用卡' then 1 else 0 end is_xyk
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
-- and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240731'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20240731'
left join(
    SELECT distinct cst_id,usc_aply_serno
        ,acs_org_id,frs_mgr_id,frs_mgr_nm
    from edw.dwd_bus_crd_cr_crd_mgr_inf_dd
    where dt='20240731'
) t6 --信用卡管护信息
on t1.rel_serno=t6.usc_aply_serno
and t1.cst_id=t6.cst_id
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  coalesce(t3.mgr_org_id,t6.acs_org_id) = t4.org_id
and t4.dt = '20240731'
where t1.dt='20240731'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 合同 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_02 AS
SElECT cst_id
    ,sum(is_xfd)        as xfd_num
    ,sum(is_jyd)        as jyd_num
    ,count(ctr_serno)   as ctr_num
    ,sum(ctr_amt)       as cst_ctr_amt	--授信金额
    ,sum(ctr_bal)       as cst_ctr_bal	--授信余额
    ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt
    ,sum(case when is_xyk<>1 then ctr_epsr_amt else 0 end) as not_crdt_card_exps_amt
from SJXQ_SJ20240814176_CST0731_1018_01
where LENGTH(cst_id)=10
and is_not_mtu=1
group by cst_ID
;
-- 借据 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_03 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
	,t1.mng_org_id                               --管户机构号
	,t1.mng_brch_id                              --分行
	,t1.acc_type                                 --账户类型
	,t1.cst_nm                                   --客户名称
	,t1.dbil_bal_cny                             --余额
	,t1.grant_amt                                --发放金额
	,t1.grant_date                               --发放日期
	,t1.end_date                                 --到期日期
	,t1.bsn_label                                --业务标识
	,t1.ovd_day                                  --逾期天数
	,t1.prcp_ovd_date                            --本金逾期日期
	,t1.intr_ovd_date                            --利息逾期日期
	,t1.bsn_sts                                  --业务状态
	,t1.cst_id                                   --核心客户编号
	,t1.mng_empe_id                              --管户人工号
	,t1.bsn_line                                 --条线
	,t1.vouch_type                               --担保分类
	,t1.opr_cst_type                             --经营性客户类型
	-- ,t1.cst_authr_crdt_amt                       --客户授信总额
	-- ,t1.cst_authr_crdt_bal                       --客户授信余额
	,t1.ctr_apnt_yr_intr_rate                    --实际利率
	,t1.ovd_prcp_bal                             --逾期本金余额
	,t1.rfin_ctg                                 --重组分类
	,t1.is_yr_new_hpn                            --是否年度新发生
	,t1.hpn_rsk_date                             --出险日期
	,t1.is_rsk_loan                              --是否风险贷款
	,t1.apl_srl_no                               --申请流水号
	,t1.opr_empe_id                              --经办客户经理
	,t1.opr_dept_lead_empe_id                    --经办部门负责人
	,t1.opr_sub_brch_prsd_empe_id                --经办支行行长
	,t1.rvw_empe_id                              --经办审查人
	,t1.final_aprv_empe_id                       --最终审批人
	,t1.opr_org_id                               --经办机构号
	,t1.rsk_lvl                                  --贷后风险判断
	,t1.chk_opnn                                 --贷后管理意见
	,t1.start_dt                                 --任务生成日期
	,t1.rsk_lvl_bef                              --出险前贷后风险判断
	,t1.start_dt_bef                             --出险前任务生成日期
	,t1.hpn_typ_cd                               --发生类型
	,t1.ctr_start_dt                             --合同生效日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t2.empe_nm as mng_empe_nm
    ,t3.org_nm  as mng_org_nm
    ,t3.sbr_org_id,t3.sbr_org_nm
from adm_rsk.adm_rsk_apl_inter_all          t1 --风险集市应用表-资产质量日常监测源表
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  substr(t1.mng_empe_id,1,6)=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 ---机构树_考核维度  团队
ON      t1.mng_org_id = t3.org_id --主管护机构号=org_id
AND     t3.DT = '20240731'
where t1.dt='20240731'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t3.brc_org_nm ='宁波分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_03_1 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
    ,t1.dbil_bal_cny
        ,case   WHEN yw.num_xf > 0 AND yw.num_jy = 0                                                            THEN '普惠' -- 客户为只有消费业务
           WHEN yw.num_jy > 0 AND m7.not_crdt_card_exps_amt <= 1500000                                     THEN '普惠' else '' end is_ph
from adm_rsk.adm_rsk_apl_inter_all          t1 --风险集市应用表-资产质量日常监测源表
LEFT JOIN    (
                 SELECT  y.cst_id
                         ,SUM(CASE
                                WHEN y.jy_tag = '消费' THEN 1
                                ELSE 0
                              END) num_xf
                         ,SUM(CASE
                                WHEN y.jy_tag = '经营' THEN 1
                                ELSE 0
                              END) num_jy
                         ,COUNT(y.ctr_serno) num_ctr
                 FROM    (
                             SELECT  cst_id
                                     ,ctr_serno
                                     ,CASE
                                        WHEN (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) THEN '消费'
                                        WHEN ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) THEN '经营'
                                        ELSE '其他'
                                      END jy_tag
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd t1
                             WHERE   dt = '20240731'
                         ) y
                 GROUP BY y.cst_id
             ) yw
ON      t1.cst_id = yw.cst_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20240731'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) m7
ON      t1.cst_id = m7.cst_id
AND     m7.RANK1 = 1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 ---机构树_考核维度  团队
ON      t1.mng_org_id = t3.org_id --主管护机构号=org_id
AND     t3.DT = '20240731'
where t1.dt='20240731'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t3.brc_org_nm ='宁波分行'
;
SELECT '3_1' seq,sum(dbil_bal_cny)
from SJXQ_SJ20240814176_CST0731_1018_03_1
where is_ph='普惠'
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_04 AS
SElECT t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT
    ,t1.sub_cmnt_id,coalesce(t1.sub_cmnt_nm,t5.cmnt_nm) as sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,coalesce(t2.com_vindicate_name,t3.empe_nm)	as  com_vindicate_name   --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,coalesce(t2.com_order_name,t4.empe_nm)	as com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST0731_1018_01     t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.SYS_REG_DT,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20240731'
left join edw.dws_hr_empe_inf_dd t3
on t2.com_vindicate_id = t3.empe_id
and t3.dt='20240831'
left join edw.dws_hr_empe_inf_dd t4
on substr(t2.com_order_id,1,6) = t4.empe_id
and t4.dt='20240831'
left join edw.dim_cst_mng_cmnt_inf_dd t5
on t1.sub_cmnt_id=t5.cmnt_enc
and t5.dt='20240831'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_05 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,coalesce(t2.sub_cmnt_nm,t8.cmnt_nm) as sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,coalesce(t3.com_vindicate_name,t6.empe_nm)	as  com_vindicate_name   --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,coalesce(t3.com_order_name,t7.empe_nm)	as com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT distinct cst_id,ctr_srl_no,hpn_rsk_date
    from SJXQ_SJ20240814176_CST0731_1018_03
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20240731'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20240731'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_srl_no=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20240731'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20240731'
left join edw.dws_hr_empe_inf_dd            t6
on t3.com_vindicate_id = t6.empe_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t7
on substr(t3.com_order_id,1,6) = t7.empe_id
and t7.dt='@@{yyyyMMdd}'
left join edw.dim_cst_mng_cmnt_inf_dd       t8
on t2.sub_cmnt_id=t8.cmnt_enc
and t8.dt='20231231'
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_06 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240731'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240731'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240731'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240731'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_07 AS
SELECT  '20240731' AS 时间分区
    ,case when t5.xfd_num>0 and t5.jyd_num=0 then '是'   --仅消费业务
        when t5.jyd_num>0 and m7.not_crdt_card_exps_amt<=1500000 then '是'
        else '否' end as 是否普惠业务
    ,t1.bsn_line              as 条线
    ,t1.mng_empe_id           AS 管户人工号
    ,t1.mng_empe_nm           AS 管户人
    ,t1.mng_org_id            AS 管户机构号
    ,t1.mng_org_nm            AS 管户机构
    ,t1.sbr_org_id            AS 管护支行机构号
    ,t1.sbr_org_nm            AS 管护支行
    ,t1.cst_id                AS 客户号
    ,t1.cst_nm                AS 客户名称
    ,t1.ctr_srl_no            AS 合同流水号
    ,t1.dbil_srl_no           AS 借据流水号
        ,t1.dbil_bal_cny as 贷款规模
    ,t2.PD_NM                 AS 产品名称
    ,t2.is_sdt                AS 是否随贷通
    ,t2.is_tyd                AS 是否泰e贷
    ,t2.is_xfd                AS 是否消费性
    ,t2.ctr_amt               AS 合同金额
    ,t2.ctr_bal               AS 合同余额
    ,t2.ctr_bgn_dt            AS 合同起始日期
    ,t2.ctr_mtu_dt            AS 合同到期日期
    ,t1.prcp_ovd_date         AS 本金逾期日期
    ,t1.intr_ovd_date         AS 利息逾期日期
    ,t1.bsn_sts               AS 业务状态
    ,t1.vouch_type            AS 担保分类
    ,t1.ctr_apnt_yr_intr_rate AS 实际利率
    ,T9.rul_set_rslt_nm     AS 预评估结果
    ,CASE WHEN t3.cst_id is not null THEN '是' else '' END AS 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt        AS 最近一次触发时间
    ,t1.ovd_prcp_bal        AS 逾期本金余额
    ,t2.pre_dfd_pre_rpt_ind AS 预保预报标识
    ,t2.bsn_mark_nm         AS 业务标识
    ,t2.is_chongzu          AS 是否重组
    ,t1.is_yr_new_hpn       AS 是否年度新发生
    ,case when t1.hpn_rsk_date>='20230801' then '是' else '' end as 是否近一年新发生风险
    ,t1.is_rsk_loan               AS 是否风险贷款
    ,t4.is_his_dft_cst            AS 历史违约客户标识
    ,t1.opr_empe_id               AS 经办客户经理
    ,t1.opr_dept_lead_empe_id     AS 经办部门负责人
    ,t1.opr_sub_brch_prsd_empe_id AS 经办支行行长
    ,t1.rvw_empe_id               AS 经办审查人
    ,t1.final_aprv_empe_id        AS 最终审批人
    ,t5.cst_ctr_epsr_amt          AS 客户号下统一授信敞口
    ,t5.cst_ctr_bal               AS 客户号下总授信余额
    ,t2.sam_rsk_ctrl_id           AS 同一风险控制号
    ,t6.同一风险控制号下授信敞口
    ,t6.同一风险控制号下授信余额
    ,t7.sub_cmnt_nm               AS 经办时所在社区名称
    ,t7.com_vindicate_id          AS 经办时所在社区主维人工号
    ,t7.com_vindicate_name        AS 经办时所在社区主维人
    ,t7.com_order_id              AS 经办时所在社区定人工号
    ,t7.com_order_name            AS 经办时所在社区定人
    ,t8.sub_cmnt_nm               AS 出险时所在社区名称
    ,t8.com_vindicate_id          AS 出险时所在社区主维人工号
    ,t8.com_vindicate_name        AS 出险时所在社区主维人
    ,t8.com_order_id              AS 出险时所在社区定人工号
    ,t8.com_order_name            AS 出险时所在社区定人
    ,t8.mgr_id                    AS 出险时管护人工号
    ,t8.mgr_nm                    AS 出险时管护人
    ,t8.mgr_org_id                AS 出险时管护部门机构号
    ,t8.org_nm                    AS 出险时管护部门
from SJXQ_SJ20240814176_CST0731_1018_03         t1
left join SJXQ_SJ20240814176_CST0731_1018_01    t2
on t1.ctr_srl_no=t2.ctr_serno
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20240731'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_clab_ln_inf_dd	    t4 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t4.cst_id
and t4.dt='20240731'
left join SJXQ_SJ20240814176_CST0731_1018_02    t5
on t1.cst_id=t5.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST0731_1018_01 -- 同一风险控制号下授信金额余额
    where is_not_mtu=1
	GROUP BY  sam_rsk_ctrl_id
) t6 ON t2.sam_rsk_ctrl_id = t6.sam_rsk_ctrl_id
left join SJXQ_SJ20240814176_CST0731_1018_04 t7
on  t1.ctr_srl_no=t7.ctr_serno
left join SJXQ_SJ20240814176_CST0731_1018_05 t8
on  t1.ctr_srl_no=t8.ctr_srl_no
and t1.hpn_rsk_date=t8.hpn_rsk_date
left join SJXQ_SJ20240814176_CST0731_1018_06 t9
on  t1.cst_id=t9.cst_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,dt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20240731'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) m7
ON      t1.cst_id = m7.cst_id
AND     m7.RANK1 = 1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0731_1018_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0731_1018_08 AS
       ,合同流水号
        ,sum(贷款规模) as 贷款规模
       ,MAX(是否消费性)                               AS 是否消费性
       ,MAX(合同金额)                                AS 合同金额
       ,MAX(合同余额)                                AS 合同余额
       ,MIN(nvl(本金逾期日期,'99991231'))                              AS 本金逾期日期
       ,MIN(nvl(利息逾期日期,'99991231'))                              AS 利息逾期日期
       ,MAX(nvl(最近一次触发时间,''))                            AS 最近一次触发时间
       ,SUM(逾期本金余额)                              AS 逾期本金余额
       ,MAX(客户号下统一授信敞口)                          AS 客户号下统一授信敞口
       ,MAX(客户号下总授信余额)                           AS 客户号下总授信余额
       ,MAX(同一风险控制号下授信敞口)                        AS 同一风险控制号下授信敞口
       ,MAX(同一风险控制号下授信余额)                        AS 同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST0731_1018_07
group by 合同流水号
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_1018_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0731_1018_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ20240814176_CST0731_1018_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0731_1018_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_srl_no,hpn_rsk_date) custs
from SJXQ_SJ20240814176_CST0731_1018_05
union all
SElECT '06' seq, count(1) cnt,count(distinct CST_ID) custs
from SJXQ_SJ20240814176_CST0731_1018_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 借据流水号) custs
from SJXQ_SJ20240814176_CST0731_1018_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST0731_1018_08
;
-- 新信贷 借据维度数据
SELECT '07' seq,*
from SJXQ_SJ20240814176_CST0731_1018_07
;
-- 新信贷 合同维度数据
SElECT '08' seq, *
from SJXQ_SJ20240814176_CST0731_1018_08
;
SELECT sum(CASE
               WHEN 业务状态 NOT LIKE '%核销%' THEN 贷款规模
               ELSE 0
             END) / 10000 AS 贷款规模
FROM    SJXQ_SJ20240814176_CST0731_1018_07 a
where 是否普惠业务='是'
***SJ20240814176_宁波分行普惠业务_20240831_1018.sql
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.bsn_mark_cd
    ,case when t1.bsn_mark_cd='03' then '是' ELSE '否' end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = '04' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then'是' else '' end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then'是' else '' end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
        then 1 else 0 end is_not_mtu
    ,case when t2.PD_NM regexp '信用卡' then 1 else 0 end is_xyk
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240831'
-- and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240831'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240831'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20240831'
left join(
    SELECT distinct cst_id,usc_aply_serno
        ,acs_org_id,frs_mgr_id,frs_mgr_nm
    from edw.dwd_bus_crd_cr_crd_mgr_inf_dd
    where dt='20240831'
) t6 --信用卡管护信息
on t1.rel_serno=t6.usc_aply_serno
and t1.cst_id=t6.cst_id
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  coalesce(t3.mgr_org_id,t6.acs_org_id) = t4.org_id
and t4.dt = '20240831'
where t1.dt='20240831'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 合同 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_02 AS
SElECT cst_id
    ,sum(is_xfd)        as xfd_num
    ,sum(is_jyd)        as jyd_num
    ,count(ctr_serno)   as ctr_num
    ,sum(ctr_amt)       as cst_ctr_amt	--授信金额
    ,sum(ctr_bal)       as cst_ctr_bal	--授信余额
    ,sum(ctr_epsr_amt)  as cst_ctr_epsr_amt
    ,sum(case when is_xyk<>1 then ctr_epsr_amt else 0 end) as not_crdt_card_exps_amt
from SJXQ_SJ20240814176_CST0831_1018_01
where LENGTH(cst_id)=10
and is_not_mtu=1
group by cst_ID
;
-- 借据 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_03 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
	,t1.mng_org_id                               --管户机构号
	,t1.mng_brch_id                              --分行
	,t1.acc_type                                 --账户类型
	,t1.cst_nm                                   --客户名称
	,t1.dbil_bal_cny                             --余额
	,t1.grant_amt                                --发放金额
	,t1.grant_date                               --发放日期
	,t1.end_date                                 --到期日期
	,t1.bsn_label                                --业务标识
	,t1.ovd_day                                  --逾期天数
	,t1.prcp_ovd_date                            --本金逾期日期
	,t1.intr_ovd_date                            --利息逾期日期
	,t1.bsn_sts                                  --业务状态
	,t1.cst_id                                   --核心客户编号
	,t1.mng_empe_id                              --管户人工号
	,t1.bsn_line                                 --条线
	,t1.vouch_type                               --担保分类
	,t1.opr_cst_type                             --经营性客户类型
	-- ,t1.cst_authr_crdt_amt                       --客户授信总额
	-- ,t1.cst_authr_crdt_bal                       --客户授信余额
	,t1.ctr_apnt_yr_intr_rate                    --实际利率
	,t1.ovd_prcp_bal                             --逾期本金余额
	,t1.rfin_ctg                                 --重组分类
	,t1.is_yr_new_hpn                            --是否年度新发生
	,t1.hpn_rsk_date                             --出险日期
	,t1.is_rsk_loan                              --是否风险贷款
	,t1.apl_srl_no                               --申请流水号
	,t1.opr_empe_id                              --经办客户经理
	,t1.opr_dept_lead_empe_id                    --经办部门负责人
	,t1.opr_sub_brch_prsd_empe_id                --经办支行行长
	,t1.rvw_empe_id                              --经办审查人
	,t1.final_aprv_empe_id                       --最终审批人
	,t1.opr_org_id                               --经办机构号
	,t1.rsk_lvl                                  --贷后风险判断
	,t1.chk_opnn                                 --贷后管理意见
	,t1.start_dt                                 --任务生成日期
	,t1.rsk_lvl_bef                              --出险前贷后风险判断
	,t1.start_dt_bef                             --出险前任务生成日期
	,t1.hpn_typ_cd                               --发生类型
	,t1.ctr_start_dt                             --合同生效日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t2.empe_nm as mng_empe_nm
    ,t3.org_nm  as mng_org_nm
    ,t3.sbr_org_id,t3.sbr_org_nm
from adm_rsk.adm_rsk_apl_inter_all          t1 --风险集市应用表-资产质量日常监测源表
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  substr(t1.mng_empe_id,1,6)=t2.empe_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 ---机构树_考核维度  团队
ON      t1.mng_org_id = t3.org_id --主管护机构号=org_id
AND     t3.DT = '20240831'
where t1.dt='20240831'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t3.brc_org_nm ='宁波分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_03_1 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
    ,t1.dbil_bal_cny
        ,case   WHEN yw.xfd_num > 0 AND yw.jyd_num = 0                                                            THEN '普惠' -- 客户为只有消费业务
           WHEN yw.jyd_num > 0 AND m7.not_crdt_card_exps_amt <= 1500000                                     THEN '普惠' else '' end is_ph
from adm_rsk.adm_rsk_apl_inter_all          t1 --风险集市应用表-资产质量日常监测源表
LEFT JOIN SJXQ_SJ20240814176_CST0831_1018_02 yw
ON      t1.cst_id = yw.cst_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,dt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20240831'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) m7
ON      t1.cst_id = m7.cst_id
AND     m7.RANK1 = 1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 ---机构树_考核维度  团队
ON      t1.mng_org_id = t3.org_id --主管护机构号=org_id
AND     t3.DT = '20240831'
where t1.dt='20240831'
AND     ( t1.acc_type LIKE '0%' OR t1.acc_type = '信用卡' ) -- 剔除表外
AND     t1.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     t1.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     t1.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     t3.brc_org_nm ='宁波分行'
;
SELECT '3_1' seq,sum(dbil_bal_cny)
from SJXQ_SJ20240814176_CST0831_1018_03_1
where is_ph='普惠'
;
-- 经办时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_04 AS
SElECT t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT
    ,t1.sub_cmnt_id,coalesce(t1.sub_cmnt_nm,t5.cmnt_nm) as sub_cmnt_nm
    ,t2.com_vindicate_id	    --主维护人id
    ,coalesce(t2.com_vindicate_name,t3.empe_nm)	as  com_vindicate_name   --主维护人名称
    ,t2.com_order_id	        --社区定人id
    ,coalesce(t2.com_order_name,t4.empe_nm)	as com_order_name	        --社区定人名称
from (
    SElECT t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT
        ,t6.sub_cmnt_id	    --子社区编号|C32
        ,t6.sub_cmnt_nm	    --子社区名称|C900
        ,t6.dpd_tm          --挂靠时间|C20
        ,row_number() over(partition by t1.cst_id,t1.ctr_serno,t1.SYS_REG_DT order by t6.dt desc) rn
    from SJXQ_SJ20240814176_CST0831_1018_01     t1
    LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t6
    ON      t1.cst_id = t6.cst_id
    AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
    where t1.brc_org_nm regexp '宁波分行'
    and datediff(to_date(substr(replace(t6.dpd_tm,'-',''),1,8),'yyyyMMdd'),to_date(t1.SYS_REG_DT,'yyyyMMdd'),'dd') between 0 and 30
)t1 LEFT JOIN    edw.xwdt_xw_community t2
ON      t1.sub_cmnt_id = t2.com_code
AND     t2.state <> '-1'
AND     t2.dt = '20240831'
left join edw.dws_hr_empe_inf_dd t3
on t2.com_vindicate_id = t3.empe_id
and t3.dt='20240831'
left join edw.dws_hr_empe_inf_dd t4
on substr(t2.com_order_id,1,6) = t4.empe_id
and t4.dt='20240831'
left join edw.dim_cst_mng_cmnt_inf_dd t5
on t1.sub_cmnt_id=t5.cmnt_enc
and t5.dt='20240831'
where t1.rn=1
;
-- 出险时所在社区
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_05 AS
SElECT t1.cst_id,t1.ctr_srl_no,t1.hpn_rsk_date
    ,t2.sub_cmnt_id	            --子社区编号|C32
    ,coalesce(t2.sub_cmnt_nm,t8.cmnt_nm) as sub_cmnt_nm	            --子社区名称|C900
    ,t2.dpd_tm                  --挂靠时间|C20
    ,t3.com_vindicate_id	    --主维护人id
    ,coalesce(t3.com_vindicate_name,t6.empe_nm)	as  com_vindicate_name   --主维护人名称
    ,t3.com_order_id	        --社区定人id
    ,coalesce(t3.com_order_name,t7.empe_nm)	as com_order_name	        --社区定人名称
    ,t4.mgr_id	                                 --管户人工号|C10
    ,t4.mgr_nm	                                 --管户人姓名|C200
    ,t4.mgr_org_id	                             --管户机构号|C12
    ,t5.brc_org_nm,t5.sbr_org_id,t5.sbr_org_nm,t5.org_nm
from(
    SElECT distinct cst_id,ctr_srl_no,hpn_rsk_date
    from SJXQ_SJ20240814176_CST0831_1018_03
)t1 LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd    t2
ON      t1.cst_id = t2.cst_id
and     t1.hpn_rsk_date=t2.dt
AND     t2.dt <= '20240831'
AND     t2.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.xwdt_xw_community              t3
ON      t2.sub_cmnt_id = t3.com_code
AND     t3.state <> '-1'
AND     t3.dt = '20240831'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t4 --信贷合同管护信息
on t1.ctr_srl_no=t4.ctr_serno
and t1.hpn_rsk_date = t4.dt
and t4.dt<='20240831'
left join edw.dim_hr_org_mng_org_tree_dd   t5 --考核机构树
on  t4.mgr_org_id = t5.org_id
and t5.dt = '20240831'
left join edw.dws_hr_empe_inf_dd            t6
on t3.com_vindicate_id = t6.empe_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t7
on substr(t3.com_order_id,1,6) = t7.empe_id
and t7.dt='@@{yyyyMMdd}'
left join edw.dim_cst_mng_cmnt_inf_dd       t8
on t2.sub_cmnt_id=t8.cmnt_enc
and t8.dt='20231231'
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_06 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240831'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240831'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240831'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240831'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_07 AS
SELECT  '20240831' AS 时间分区
    ,case when t5.xfd_num>0 and t5.jyd_num=0 then '是'   --仅消费业务
        when t5.jyd_num>0 and m7.not_crdt_card_exps_amt<=1500000 then '是'
        else '否' end as 是否普惠业务
    ,t1.bsn_line              as 条线
    ,t1.mng_empe_id           AS 管户人工号
    ,t1.mng_empe_nm           AS 管户人
    ,t1.mng_org_id            AS 管户机构号
    ,t1.mng_org_nm            AS 管户机构
    ,t1.sbr_org_id            AS 管护支行机构号
    ,t1.sbr_org_nm            AS 管护支行
    ,t1.cst_id                AS 客户号
    ,t1.cst_nm                AS 客户名称
    ,t1.ctr_srl_no            AS 合同流水号
    ,t1.dbil_srl_no           AS 借据流水号
        ,t1.dbil_bal_cny as 贷款规模
    ,t2.PD_NM                 AS 产品名称
    ,t2.is_sdt                AS 是否随贷通
    ,t2.is_tyd                AS 是否泰e贷
    ,t2.is_xfd                AS 是否消费性
    ,t2.ctr_amt               AS 合同金额
    ,t2.ctr_bal               AS 合同余额
    ,t2.ctr_bgn_dt            AS 合同起始日期
    ,t2.ctr_mtu_dt            AS 合同到期日期
    ,t1.prcp_ovd_date         AS 本金逾期日期
    ,t1.intr_ovd_date         AS 利息逾期日期
    ,t1.bsn_sts               AS 业务状态
    ,t1.vouch_type            AS 担保分类
    ,t1.ctr_apnt_yr_intr_rate AS 实际利率
    ,T9.rul_set_rslt_nm     AS 预评估结果
    ,CASE WHEN t3.cst_id is not null THEN '是' else '' END AS 是否触发处置类精准贷后
    ,t3.lst_czl_jzdt        AS 最近一次触发时间
    ,t1.ovd_prcp_bal        AS 逾期本金余额
    ,t2.pre_dfd_pre_rpt_ind AS 预保预报标识
    ,t2.bsn_mark_nm         AS 业务标识
    ,t2.is_chongzu          AS 是否重组
    ,t1.is_yr_new_hpn       AS 是否年度新发生
    ,case when t1.hpn_rsk_date>='20230901' then '是' else '' end as 是否近一年新发生风险
    ,t1.is_rsk_loan               AS 是否风险贷款
    ,t4.is_his_dft_cst            AS 历史违约客户标识
    ,t1.opr_empe_id               AS 经办客户经理
    ,t1.opr_dept_lead_empe_id     AS 经办部门负责人
    ,t1.opr_sub_brch_prsd_empe_id AS 经办支行行长
    ,t1.rvw_empe_id               AS 经办审查人
    ,t1.final_aprv_empe_id        AS 最终审批人
    ,t5.cst_ctr_epsr_amt          AS 客户号下统一授信敞口
    ,t5.cst_ctr_bal               AS 客户号下总授信余额
    ,t2.sam_rsk_ctrl_id           AS 同一风险控制号
    ,t6.同一风险控制号下授信敞口
    ,t6.同一风险控制号下授信余额
    ,t7.sub_cmnt_nm               AS 经办时所在社区名称
    ,t7.com_vindicate_id          AS 经办时所在社区主维人工号
    ,t7.com_vindicate_name        AS 经办时所在社区主维人
    ,t7.com_order_id              AS 经办时所在社区定人工号
    ,t7.com_order_name            AS 经办时所在社区定人
    ,t8.sub_cmnt_nm               AS 出险时所在社区名称
    ,t8.com_vindicate_id          AS 出险时所在社区主维人工号
    ,t8.com_vindicate_name        AS 出险时所在社区主维人
    ,t8.com_order_id              AS 出险时所在社区定人工号
    ,t8.com_order_name            AS 出险时所在社区定人
    ,t8.mgr_id                    AS 出险时管护人工号
    ,t8.mgr_nm                    AS 出险时管护人
    ,t8.mgr_org_id                AS 出险时管护部门机构号
    ,t8.org_nm                    AS 出险时管护部门
from SJXQ_SJ20240814176_CST0831_1018_03         t1
left join SJXQ_SJ20240814176_CST0831_1018_01    t2
on t1.ctr_srl_no=t2.ctr_serno
LEFT JOIN
(
	SELECT  cst_id
	       ,MAX(start_dt) lst_czl_jzdt --任务生成日期
	FROM adm_pub.adm_rsk_apl_prc_pst_loan_mnt_dd --精准贷后-任务宽表
	WHERE dt = '20240831'
	AND trg_typ = '2处置' --'1预警', '2处置'
	GROUP BY  cst_id
) t3 on t1.cst_id=t3.cst_id
left join adm_pub.adm_csm_clab_ln_inf_dd	    t4 --客户集市-标签层-信贷客户标签信息表
on t1.cst_id=t4.cst_id
and t4.dt='20240831'
left join SJXQ_SJ20240814176_CST0831_1018_02    t5
on t1.cst_id=t5.cst_id
LEFT JOIN
(
	SELECT  sam_rsk_ctrl_id
            ,sum(ctr_epsr_amt)  as 同一风险控制号下授信敞口
	       ,SUM(ctr_bal)        as 同一风险控制号下授信余额
	FROM SJXQ_SJ20240814176_CST0831_1018_01 -- 同一风险控制号下授信金额余额
    where is_not_mtu=1
	GROUP BY  sam_rsk_ctrl_id
) t6 ON t2.sam_rsk_ctrl_id = t6.sam_rsk_ctrl_id
left join SJXQ_SJ20240814176_CST0831_1018_04 t7
on  t1.ctr_srl_no=t7.ctr_serno
left join SJXQ_SJ20240814176_CST0831_1018_05 t8
on  t1.ctr_srl_no=t8.ctr_srl_no
and t1.hpn_rsk_date=t8.hpn_rsk_date
left join SJXQ_SJ20240814176_CST0831_1018_06 t9
on  t1.cst_id=t9.cst_id
LEFT JOIN    (
                 SELECT  b2.cst_id
                         ,b2.not_crdt_card_exps_amt
                         ,dt
                         ,ROW_NUMBER() OVER ( PARTITION BY b2.CST_ID ORDER BY b2.DT DESC ) RANK1
                 FROM    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd b2 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
                 WHERE   b2.dt <= '20240831'
                 AND     to_date(LAST_DAY(to_date(dt, 'yyyymmdd')), 'yyyy-mm-dd') = to_date(dt, 'yyyymmdd')
             ) m7
ON      t1.cst_id = m7.cst_id
AND     m7.RANK1 = 1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240814176_CST0831_1018_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240814176_CST0831_1018_08 AS
       ,合同流水号
        ,sum(贷款规模) as 贷款规模
       ,MAX(是否消费性)                               AS 是否消费性
       ,MAX(合同金额)                                AS 合同金额
       ,MAX(合同余额)                                AS 合同余额
       ,MIN(nvl(本金逾期日期,'99991231'))                              AS 本金逾期日期
       ,MIN(nvl(利息逾期日期,'99991231'))                              AS 利息逾期日期
       ,MAX(nvl(最近一次触发时间,''))                            AS 最近一次触发时间
       ,SUM(逾期本金余额)                              AS 逾期本金余额
       ,MAX(客户号下统一授信敞口)                          AS 客户号下统一授信敞口
       ,MAX(客户号下总授信余额)                           AS 客户号下总授信余额
       ,MAX(同一风险控制号下授信敞口)                        AS 同一风险控制号下授信敞口
       ,MAX(同一风险控制号下授信余额)                        AS 同一风险控制号下授信余额
from SJXQ_SJ20240814176_CST0831_1018_07
group by 合同流水号
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0831_1018_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240814176_CST0831_1018_02
union all
SElECT '03' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ20240814176_CST0831_1018_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240814176_CST0831_1018_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_srl_no,hpn_rsk_date) custs
from SJXQ_SJ20240814176_CST0831_1018_05
union all
SElECT '06' seq, count(1) cnt,count(distinct CST_ID) custs
from SJXQ_SJ20240814176_CST0831_1018_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 借据流水号) custs
from SJXQ_SJ20240814176_CST0831_1018_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240814176_CST0831_1018_08
;
-- 新信贷 借据维度数据
SELECT '07' seq,*
from SJXQ_SJ20240814176_CST0831_1018_07
;
-- 新信贷 合同维度数据
SELECT '08' seq,*
from SJXQ_SJ20240814176_CST0831_1018_08
;
SELECT sum(CASE
               WHEN 业务状态 NOT LIKE '%核销%' THEN 贷款规模
               ELSE 0
             END) / 10000 AS 贷款规模
FROM    SJXQ_SJ20240814176_CST0831_1018_07 a
where 是否普惠业务='是'
***SJ20240815101_长乐村行他行小贷客户.sql
-- SJ20240815101  数据需求字段
-- 小贷定义：<=30万的他行贷款，包含消费、经营性贷款，不含房贷、车贷
-- 客户号、客户名称、小贷家数、小贷金额合计、小贷余额合计
DROP   TABLE IF     EXISTS SJXQ_SJ20240815101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240815101_CST_01 AS
SELECT  t1.cst_id
       ,t1.report_dt                    --报告日期
       ,t1.curr_loan_bank_num           --现有贷款授信银行数
       ,t1.oth_bank_xfx_loan_org_num    --他行消费性贷款授信机构数
       ,t1.othr_bnk_mngmt_loan_org_num  --他行经营性贷款授信机构数
       ,t1.curr_unsett_xfx_loan_org_num --当前未结清消费贷款机构数_剔除车房贷
       ,t1.cred_total_amt               --授信总额_信用总额
       ,t1.cred_total_balan             --授信余额_信用总余额
       ,t1.curr_jyx_loan_balan          --个人经营性贷款余额
       ,t1.oth_bank_mngmt_loan_bal      --他行经营性贷款授信余额
       ,t1.oth_bank_xfx_loan_bal        --他行消费性贷款授信余额
       ,t1.curr_unsett_xfx_loan_amt     --当前未结清消费贷款金额_剔除车房贷
       ,t1.curr_unsett_xfx_loan_bal     --当前未结清消费贷款余额_剔除车房贷
    ,t2.zxqu_l6m_cnt	            --最近6个月内查询次数
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.cst_chn_nm	                --客户姓名|C200
    ,row_number() over(partition by t1.cst_id order by t1.report_no desc) rn
from edw.dws_cst_ccrc_idv_ind_inf_dd                t1 --个人征信指标信息表
left join adm_pub.adm_csm_cbus_out_crd_idv_qry_dd	t2 --客户集市-业务信息-个人征信-查询信息表
on t1.cst_id=t2.cst_id
and t1.report_no=t2.report_id
and t2.dt='@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '福建长乐泰隆村镇'
left join edw.dws_cst_bas_inf_dd 				    t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1	--报告降序排序号
and nvl(t1.oth_bank_mngmt_loan_bal,0)+nvl(t1.oth_bank_xfx_loan_bal,0)<=300000
;
select cst_id
    ,sum(cred_total_amt)        cred_total_amt      --授信总额（信用总额）
    ,sum(cred_total_balan)      cred_total_balan    --授信余额（信用总余额）
from edw.dws_cst_ccrc_idv_ind_inf_dd
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1	--报告降序排序号
group by cst_id
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240815101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240815101_CST_02 AS
SELECT  cst_id                       AS 客户号
       ,cst_chn_nm                   AS 客户名称
       ,report_dt                    AS 报告日期
       ,curr_loan_bank_num           AS 现有贷款授信银行数
       ,oth_bank_xfx_loan_org_num    AS 他行消费性贷款授信机构数
       ,othr_bnk_mngmt_loan_org_num  AS 他行经营性贷款授信机构数
       ,curr_unsett_xfx_loan_org_num AS 当前未结清消费贷款机构数_剔除车房贷
       ,cred_total_amt               AS 授信总额_信用总额
       ,cred_total_balan             AS 授信余额_信用总余额
       ,curr_jyx_loan_balan          AS 个人经营性贷款余额
       ,oth_bank_mngmt_loan_bal      AS 他行经营性贷款授信余额
       ,oth_bank_xfx_loan_bal        AS 他行消费性贷款授信余额
       ,curr_unsett_xfx_loan_amt     AS 当前未结清消费贷款金额_剔除车房贷
       ,curr_unsett_xfx_loan_bal     AS 当前未结清消费贷款余额_剔除车房贷
       ,zxqu_l6m_cnt                 AS 最近6个月内查询次数
from SJXQ_SJ20240815101_CST_01
where rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240815101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240815101_CST_02
***SJ2024081581_叶县村行账户排查.sql
-- 2019年8月28日-2024年8月14日，在账户开立时当日年龄在18周岁以下（含定期）。
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024081581_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081581_CST_01 AS
SELECT  T1.cst_id                        --客户号
        ,T1.act_nm                       --账户名称
        ,T1.cst_act_id                   --客户账号
        ,T1.dep_act_id                   --存款账号
        ,T1.opn_dt                       --开户日期
        ,T1.act_dstr_act_dt              --销户日期
        ,t1.dep_cls_cd
        ,c1.cd_val_dscr     dep_cls_nm   --存款种类
        ,T1.opn_org                      --开户机构编号
        ,T2.org_nm                       --开户机构名称
        ,T2.sbr_org_nm                   --开户支行名称
FROM    edw.dws_bus_dep_act_inf_dd              T1 --存款账户信息表
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd     T2 --开户机构
ON      T1.opn_org = T2.org_id
AND     T2.dt = '@@{yyyyMMdd}'
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='dep_cls_cd'
    and    tbl_nm='DIM_BUS_DEP_ACT_INF_DD'
) c1  on   T1.dep_cls_cd=c1.cd_val
WHERE   T1.DT = '@@{yyyyMMdd}'
-- AND     T1.ACT_CTG_CD_2 IN ( '301' , '302' , '303' ) -- I、II、III类账户 个人账户
-- AND     T1.STL_ACT_IND = '1'    --结算账户
AND     T1.opn_dt >= '20190828'
AND     T1.opn_dt <= '20240814'
AND     T1.opn_org LIKE '4161%' --河南叶县泰隆村镇
-- AND     T1.ACT_STS_CD = 'A'     --账户状态为正常
;
-- 客群代理人
DROP   TABLE IF     EXISTS SJXQ_SJ2024081581_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081581_CST_02 AS
SELECT  cst_id          --客户号|c20
       ,cst_nm          --客户名称|c200
       ,cst_act_id      --客户账号|c32
       ,act_id          --负债账号|c32
       ,trx_dt          --交易日期|c8
       ,trx_org         --交易机构|c12
       ,lbl_pd_typ_cd   --负债产品类型代码|c1
       ,agn_bus_typ     --代理业务类型代码|c2
       ,agn_nm          --代理人名称|c200
FROM edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd --代理业务交易登记簿
WHERE dt = '20240814'
AND agn_bus_typ = '1' --代理业务类型代码:1代理开户,2代理开卡,3代理开大额存单,4代理现金存款,5代理现金取款,6代理存款部提,7代理存款销户
and rcd_sts_cd = '0'  --正常
;
-- 主管户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024081581_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081581_CST_03 AS
SElECT t1.cst_id,t1.min_opn_dt
    ,case when t2.bth_dt>='19000101' and t2.bth_dt<='20240831' then t2.bth_dt
        when length(t2.doc_nbr)=18 then substr(t2.doc_nbr,7,8)
        else '' end 	as  bth_dt                       --出生日期|C8
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
from(
    SElECT cst_id,min(opn_dt) min_opn_dt
    from SJXQ_SJ2024081581_CST_01
    group by cst_id
)t1 left join edw.dws_cst_idv_bas_inf_dd t2 --个人客户基本信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20240814'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240814'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240814'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024081581_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081581_CST_04 AS
SElECT t1.cst_id,t1.min_opn_dt,t1.bth_dt
    ,case when cast(substr(t1.min_opn_dt,5,4) as int) >= cast(substr(t1.bth_dt,5,4) as int)
        and cast(substr(t1.min_opn_dt,1,4) as int) - cast(substr(t1.bth_dt,1,4) as int)>=18 then 1
        when cast(substr(t1.min_opn_dt,5,4) as int) < cast(substr(t1.bth_dt,5,4) as int)
        and cast(substr(t1.min_opn_dt,1,4) as int) - cast(substr(t1.bth_dt,1,4) as int)>=19 then 1
        else 0 end is_adult
    ,t1.prm_mgr_id,t1.prm_mgr_nm,t1.prm_org_id
    ,t1.brc_org_nm,t1.sbr_org_nm,t1.tem_org_nm,t1.org_nm
    ,T2.act_nm                       --账户名称
    ,T2.cst_act_id                   --客户账号
    ,T2.dep_act_id                   --存款账号
    ,T2.opn_dt                       --开户日期
    ,T2.act_dstr_act_dt              --销户日期
    ,t2.dep_cls_nm                   --存款种类
    ,T2.opn_org                      --开户机构编号
    ,T2.org_nm        opn_org_nm     --开户机构名称
    ,case when t3.act_id is not null then '是' else '' end is_agn
    ,t3.cst_nm          --客户名称|c200
    ,t3.trx_dt          --交易日期|c8
    ,t3.trx_org         --交易机构|c12
    ,t3.lbl_pd_typ_cd   --负债产品类型代码|c1
    ,t3.agn_bus_typ     --代理业务类型代码|c2
    ,t3.agn_nm          --代理人名称|c200
from SJXQ_SJ2024081581_CST_03       t1
left join SJXQ_SJ2024081581_CST_01  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024081581_CST_02  t3
on t2.dep_act_id=t3.act_id
where t1.bth_dt between '19000101' and '20240831'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081581_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081581_CST_05 AS
SELECT  cst_act_id      AS 客户账号
       ,dep_act_id      AS 存款账号
       ,cst_id          AS 客户号
       ,act_nm          AS 姓名
       ,opn_dt          AS 开户日期
       ,act_dstr_act_dt AS 销户日期
       ,opn_org_nm      AS 开户机构名称
       ,dep_cls_nm      AS 存款种类
       ,is_agn          AS 是否代理
       ,agn_nm          AS 代理人名称
       ,org_nm          AS 主管户机构名称
       ,prm_mgr_id      AS 主管户客户经理工号
       ,prm_mgr_nm      AS 主管户客户经理姓名
from SJXQ_SJ2024081581_CST_04
where is_adult=0    --开户时未成年
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024081581_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct act_id) custs
from SJXQ_SJ2024081581_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081581_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024081581_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ2024081581_CST_05
***SJ2024081656_大冶村行信贷自查.sql
﻿--王青婷810092-大冶村行-同一风险控制号敞口相关
--SJ2024081656
-- 截止2024.8.16，大冶村行，发放(包括新增,续贷）同一风险控制号敞口50万（含）-200万（不含）且当前有贷款余额的经营性贷款，合同起始日为2024年1月1日-2024年6月30日区间。
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024081656_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081656_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.hpn_typ_cd
    ,c1.cd_val_dscr     hpn_typ_nm              --发生类型
    ,t7.cst_typ_cd	                            --客户类型代码 1对私 2对公
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.org_nm
    ,t5.opr_or_csm	        --A经营/B消费
    ,t5.cny_authr_crdt_amt	--授信金额_折人民币
    ,t5.cny_authr_crdt_bal  --授信余额_折人民币
    -- ,t5.exps_amt	        --敞口金额
    -- ,t5.exps_bal	        --敞口余额
    ,t7.sam_rsk_ctrl_id
    ,t6.sam_rsk_ctrl_cst_xpos_amt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240816'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240816'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240816'
and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON  t1.hpn_typ_cd = C1.CD_VAL
AND C1.DT = '20240531'
left join adm_upss.adm_rsk_apl_cst_use_crdt_ctr_info_dd t5
on t1.ctr_serno=t5.ctr_srl_no
and t5.dt = '20240816'
left join edw.dws_cst_bas_inf_dd t7
on t1.cst_id=t7.cst_id
and t7.dt='20240816'
left join edw.dws_bus_loan_sam_rsk_ctrl_inf_dd t6
on t7.sam_rsk_ctrl_id=t6.sam_rsk_ctrl_id
and t6.dt='20240816'
where t1.dt='20240816'
and t1.ctr_bgn_dt between '20240101' and '20240630'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 客户是否查询征信
DROP   TABLE IF     EXISTS SJXQ_SJ2024081656_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081656_CST_02 AS
select cst_id         --客户号
from edw.dim_cst_ccrc_idv_loan_inf_dd --个人征信客户贷款信息
where dt='20240816'
and nvl(cst_id,'')<>''
union
select cst_id --客户号
from  edw.dim_cst_ccrc_entp_loan_inf_dd --企业征信客户贷款信息
where dt='20240816'
and nvl(cst_id,'')<>''
;
-- 客户关联关系
DROP   TABLE IF     EXISTS SJXQ_SJ2024081656_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081656_CST_03 AS
SElECT t1.cst_id,t1.rel_cst_id,t1.rel_typ
    ,c1.cd_val_dscr as rel_typ_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '20240816'
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '20240816'
)t1 LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
AND C1.DT = '20240816'
;
-- 持股50%以上
DROP   TABLE IF     EXISTS SJXQ_SJ2024081656_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081656_CST_03_1 AS
SELECT distinct t1.dt_gpr_creditcode
    ,t1.in_ctfno
    ,cast(replace(t1.dt_gpr_fundedratio,'%','') as double) dt_gpr_fundedratio
    ,t1.insert_time_chinadaas
    ,t2.cst_id
    ,t3.cst_id rel_cst_id   --持股企业客户号
from edw.nout_gs_prsn_ryposshatd  t1
inner join edw.dws_cst_bas_inf_dd t2
on t1.in_ctfno=t2.doc_nbr
and t2.dt='20240816'
and t2.doc_typ_cd in ( 'B0100' , 'B0101' , 'B0102' )    --身份证
inner join edw.dim_cst_entp_bas_inf_dd t3
on t1.dt_gpr_creditcode=t3.lctax_cert_no
and t3.dt='20240816'
where t1.dt>='20230101'
and t1.dt_gpr_fundedratio is not null
and cast(replace(t1.dt_gpr_fundedratio,'%','') as double)>=50
and t1.dt_gpr_entstatus regexp '开业'
and t1.in_ctfno is not null
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024081656_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081656_CST_04 AS
select t1.ctr_serno             --合同流水号
	,t1.cst_id                  --客户号
	,t1.cst_nm                  --客户名称
    ,t1.hpn_typ_nm              --发生类型
    ,t1.ctr_amt                 --合同金额DECIMAL(21,2)
	,t1.ctr_bal                 --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt              --合同起始日期
	,t1.ctr_mtu_dt              --合同到期日期
    ,t1.mgr_id	                --管户人工号|C10
    ,t1.mgr_nm	                --管户人姓名|C200
    ,t1.org_nm	                --管户机构
    ,t1.cst_typ_cd              --客户类型代码 1对私 2对公
    ,case when t3.cst_id is not null then 1 else 0 end is_chk_po_zx
    ,case when t4.cst_id is not null then 1 else 0 end is_chk_fr_zx
    ,case when t5.cst_id is not null then 1 else 0 end is_chk_sk_zx
    ,case when t6.cst_id is not null then 1 else 0 end is_chk_cg_zx
    ,case when t6.cst_id is not null then 1 else 0 end is_chk_frpo_zx
from SJXQ_SJ2024081656_CST_01       t1
inner join(
    SElECT distinct ctr_serno
    from SJXQ_SJ2024081656_CST_01 --当前有经营性贷款余额
    where is_jyd=1
    and ctr_bal<>0
)t2 on t1.ctr_serno=t2.ctr_serno
left join(
    select distinct t1.cst_id
    from SJXQ_SJ2024081656_CST_01       t1
    inner join SJXQ_SJ2024081656_CST_03 t2
    on t1.cst_id=t2.cst_id
    and t2.rel_typ ='0301'  --配偶
    inner join SJXQ_SJ2024081656_CST_02 t3
    on t2.rel_cst_id=t3.cst_id
    where t1.cst_typ_cd='1'
)t3 on t1.cst_id=t3.cst_id
left join(
    select distinct t1.cst_id
    from SJXQ_SJ2024081656_CST_01       t1
    inner join SJXQ_SJ2024081656_CST_03 t2
    on t1.cst_id=t2.cst_id
    and t2.rel_typ ='0101'  --法人
    inner join SJXQ_SJ2024081656_CST_02 t3
    on t2.rel_cst_id=t3.cst_id
)t4 on t1.cst_id=t4.cst_id
left join(
    select distinct t1.cst_id
    from SJXQ_SJ2024081656_CST_01       t1
    inner join SJXQ_SJ2024081656_CST_03 t2
    on t1.cst_id=t2.cst_id
    and t2.rel_typ ='0109'  --实际控制人
    inner join SJXQ_SJ2024081656_CST_02 t3
    on t2.rel_cst_id=t3.cst_id
)t5 on t1.cst_id=t5.cst_id
left join(
    select distinct t1.cst_id
    from SJXQ_SJ2024081656_CST_01           t1
    inner join(
        SELECT DISTINCT cst_id,rel_cst_id
        from SJXQ_SJ2024081656_CST_03_1
    )t2 on t1.cst_id=t2.cst_id
    inner join SJXQ_SJ2024081656_CST_02 t3
    on t2.rel_cst_id=t3.cst_id
    where t1.cst_typ_cd='1'
)t6 on t1.cst_id=t6.cst_id
left join( --实际控制人或法定代表人的配偶征信是否查询
    select distinct t1.cst_id,t2.rel_cst_id
    from SJXQ_SJ2024081656_CST_01       t1
    inner join SJXQ_SJ2024081656_CST_03 t2
    on t1.cst_id=t2.cst_id
    inner join SJXQ_SJ2024081656_CST_03 t4
    on t2.rel_cst_id=t4.cst_id
    and t4.rel_typ='0301'  --配偶
    inner join SJXQ_SJ2024081656_CST_02 t3
    on t4.rel_cst_id=t3.cst_id
    where t1.cst_typ_cd='2'     --对公
)t7 on t1.cst_id=t7.cst_id
where t1.sam_rsk_ctrl_cst_xpos_amt>=500000
and t1.sam_rsk_ctrl_cst_xpos_amt< 2000000
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081656_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081656_CST_05 AS
SELECT  ctr_serno   AS 合同流水号
    ,cst_id         AS 客户号
    ,cst_nm         AS 客户名称
    ,hpn_typ_nm     AS 发生类型
    ,ctr_amt        AS 合同金额
    ,ctr_bal        AS 合同余额
    ,ctr_bgn_dt     AS 合同起始日期
    ,ctr_mtu_dt     AS 合同到期日期
    ,mgr_id         AS 管户人工号
    ,mgr_nm         AS 管户人姓名
    ,org_nm         AS 管户机构
    ,case when cst_typ_cd='1' then '对私' when cst_typ_cd='2' then '对公' else '' end as 客户类型
    ,is_chk_po_zx   AS 借款人配偶征信是否查询
    ,is_chk_fr_zx   AS 借款人作为法定代表人的公司或公司法人征信是否查询
    ,is_chk_sk_zx   AS 借款人作为实际控制人的公司或公司实控人征信是否查询
    ,is_chk_cg_zx   AS 借款人持股占比大于一半的企业征信是否查询
    ,is_chk_frpo_zx AS 实际控制人或法定代表人的配偶征信是否查询
from SJXQ_SJ2024081656_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024081656_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081656_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ2024081656_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024081656_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024081656_CST_05
;
SElECT *
from SJXQ_SJ2024081656_CST_05
GROUP BY cst_typ_cd
***SJ2024081801_台州企业工商信息.sql
-- 企业名称、法人名称、地址、联系方式、我行是否开户、是否为存款有效户、是否为贷款有效户。
-- 外部工商数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024081801_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081801_CST_01 AS
select t1.company_id                               --主体唯一键
	,t1.company_name                             --企业名称
	,t1.credit_no                                --统一信用代码
	,t1.legal_person                             --法定代表人
	,t1.company_address                          --地址
	,t1.legal_person_type                        --法人类型，0自然人，1非自然人
	,t1.legal_person_id                          --法人ID
    ,t2.company_phone                            --联系电话
    ,t3.cst_id	--客户号|C20
    ,t3.cst_nm	--客户名称|C200
from edw.nout_company_base              t1 --企业基本信息表
left join(
    SElECT company_id,company_phone
        ,row_number() over(partition by company_id order by report_date desc) rn
    from edw.nout_annual_report_base --年报基本信息表
    WHERE dt='@@{yyyyMMdd-1d}'
    and use_flag <> '10' --10废弃数据
)t2 on t1.company_id=t2.company_id
and t2.rn=1
left join edw.dim_cst_entp_bas_inf_dd	t3 --企业客户基本信息
on t1.credit_no=t3.lctax_cert_no	--地税证件号
and t3.dt='@@{yyyyMMdd-1d}'
where t1.dt='@@{yyyyMMdd-1d}'
and substr(t1.credit_no,3,4) = '3310'    --台州
;
--行内数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024081801_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081801_CST_02 AS
SElECT t1.cst_id
    ,case when t2.cst_id is not null then 1 else 0 end is_opn_cst
	,t3.efe_dep_cst_ind         --有效存款户标识
	,t3.efe_loan_cst_ind        --有效信贷户标识
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024081801_CST_01
)t1 LEFT JOIN(
    SELECT  DISTINCT CST_ID
    FROM EDW.DIM_BUS_DEP_CST_ACT_INF_DD
    WHERE dt='@@{yyyyMMdd-1d}'
) t2 ON t1.CST_ID = t2.CST_ID
left join adm_pub.adm_csm_cbas_ind_inf_dd t3 --客户基础标识信息 16065131 cst_id 唯一
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd-1d}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081801_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081801_CST_03 AS
SELECT  t1.company_name     AS 企业名称
       ,t1.legal_person     AS 法定代表人
       ,t1.company_address  AS 地址
       ,t1.company_phone    AS 联系电话
       ,t2.is_opn_cst       AS 我行是否开户
       ,t2.efe_dep_cst_ind  AS 有效存款户标识
       ,t2.efe_loan_cst_ind AS 有效信贷户标识
from SJXQ_SJ2024081801_CST_01       t1
left join SJXQ_SJ2024081801_CST_02  t2
on t1.cst_id=t2.cst_id
where company_address regexp '路桥|新桥|路北|路南'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081801_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081801_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 企业名称) custs
from SJXQ_SJ2024081801_CST_03
***SJ2024081916_存量期限长客户风险.sql
-- 客户号 合同号
-- 1036808569、BC2021082000001592
-- 加个字段：定位是否经过中台审核
-- 导入表
DROP   TABLE IF     EXISTS SJXQ_SJ2024081916_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081916_CST_01 AS
SELECT  1                    AS seq --序号
       ,'1036808569'         AS cst_id --客户号
       ,'BC2021082000001592' AS ctr_serno --合同号
-- from qbi_file_20240806_11_13_14
-- where pt <> ''
;
-- 敞口金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024081916_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081916_CST_02 AS
SElECT t1.cst_id
    ,t2.sam_rsk_ctrl_id             --同一风险控制号
    ,t3.sam_rsk_ctrl_cst_xpos_amt	--同一风险控制号下客户贷款敞口金额
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024081916_CST_01
)t1 left join edw.dws_cst_bas_inf_dd            t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_bus_loan_sam_rsk_ctrl_inf_dd  t3
on t2.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
and t3.dt='@@{yyyyMMdd}'
;
-- 调查报告客户调查信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024081916_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081916_CST_03 AS
SELECT  t1.cst_id
       ,t2.surtype              --调查类型
       ,decode(t2.surmethod,'010','现场','020','非现场','')  surmethod --调查方式
       ,t2.surdate              --调查时间
       ,t2.surpersons           --调查人员
       ,t2.surfieldtype         --调查实地类型
       ,t2.surcontent           --调查内容
       ,t2.surresults           --调查结果
       ,t2.locationsendztflag   --定位是否需中台审核
    ,ROW_NUMBER() over(partition by t1.cst_id order by surdate desc) rn
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024081916_CST_01
)t1 left join edw.loan_survey_customer_survey t2 --调查报告客户调查信息
on t1.cst_id=t2.customerid	--客户号
and t2.dt='@@{yyyyMMdd}'
where t2.surtype='010' --调查类型: 010:客户调查记录， 020：侧面打听记录， 030：法院、税务、工商及相关网站查询
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081916_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081916_CST_04 AS
SELECT  t1.seq                       AS 序号
       ,t1.cst_id                    AS 客户号
       ,t1.ctr_serno                 AS 合同号
       ,t2.sam_rsk_ctrl_cst_xpos_amt AS 同一风险控制号下客户贷款敞口金额
       ,t3.surmethod                 AS 调查方式
       ,t3.surdate                   AS 调查时间
       ,t3.surpersons                AS 调查人员
       ,t3.surfieldtype              AS 调查实地类型
       ,t3.surcontent                AS 调查内容
       ,t3.surresults                AS 调查结果
       ,t3.locationsendztflag        AS 定位是否需中台审核
from SJXQ_SJ2024081916_CST_01       t1
left join SJXQ_SJ2024081916_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024081916_CST_03  t3
on t1.cst_id=t3.cst_id
and t3.rn=1     --最近一次
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024081916_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081916_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024081916_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2024081916_CST_04
***SJ2024081946_旬阳村行信贷自查.sql
-- 信贷合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024081946_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081946_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.tem_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd            t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240818'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240818'
and t4.brc_org_nm regexp '陕西旬阳泰隆村镇'
where t1.dt='20240818'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--批复意见表
DROP   TABLE IF     EXISTS SJXQ_SJ2024081946_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081946_CST_02 AS
select t1.ctr_serno                              --关联流水号 合同流水号
    ,case when t2.typ_cd = '1' then '放款前'
            when t2.typ_cd = '2' then '续贷前'
            when t2.typ_cd = '3' then '隐藏意见'
            when t2.typ_cd = '4' then '建议类'
            end  as  批复类型
    ,case when t2.opnn_typ_cd = '01' then '补充资料'
        when t2.opnn_typ_cd = '02' then '下笔退出'
        when t2.opnn_typ_cd = '03' then '下笔缩额'
        when t2.opnn_typ_cd = '04' then '贷后关注'
        when t2.opnn_typ_cd = '06' then '其他'
        end  as  批复意见类型
    ,regexp_replace(regexp_replace(t2.dsc,'\\s',''),',','|') 批复意见说明
    ,case when t2.actl_cpl_dt = '18991231' then null else t2.actl_cpl_dt end 实际完成日期
from SJXQ_SJ2024081946_CST_01           t1
left join edw.dwd_bus_loan_aprv_opnn_dd t2 --批复意见表
on t1.ctr_serno=t2.rel_srl_nbr	--关联流水号|C32
and t2.dt='20240818'
and t2.rel_obj_typ_cd = 'BusinessContract'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024081946_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024081946_CST_03 AS
SELECT  t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t1.ctr_serno                AS 合同流水号
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,concat(t1.mgr_id,t1.mgr_nm) AS 管户人
       ,t1.tem_org_nm               AS 管户团队
       ,t1.org_nm                   AS 管户机构
       ,t2.批复类型
       ,t2.批复意见类型
       ,t2.批复意见说明
       ,t2.实际完成日期
from SJXQ_SJ2024081946_CST_01       t1
inner join SJXQ_SJ2024081946_CST_02 t2
on t1.ctr_serno=t2.ctr_serno
and t2.实际完成日期 between '20240326' and '20240818'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024081946_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024081946_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024081946_CST_03
***SJ20240820116_衢州分行预评估结果.sql
-- SJ20240820116
-- 申请20240720至今，衢州分行层级预评估未通过的业务清单，清单能显示上诉结果和抗辩结果。
-- 包括申请流水号，合同流水号，客户，客户编号，预评估未通过，触发情形，是否上诉通过，是否抗辩通过，审批层级等
DROP   TABLE IF     EXISTS SJXQ_SJ20240820116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820116_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO                                --申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
	,t5.cst_typ_cd                               --客户类型代码|c4
	,t5.sam_rsk_ctrl_no                          --同一风险控制号|c24
	,t5.csld_cr_lmt                              --统一授信额度|decimal(21,2)
	,t5.csld_cr_xpos                             --统一授信敞口|decimal(21,2)
	,t5.apl_dt                                   --申请日期|c8
	,t5.aprv_sts_cd                              --审批状态代码|c2
    ,c1.cd_val_dscr     as aprv_sts_nm
	,t5.exec_intr_rat                            --执行利率|decimal(13,7)
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '衢州分行'
inner join edw.dwd_bus_loan_lmt_aply_info_dd  t5       --授用信申请信息
on t1.REL_SERNO	=t5.ahn_ltr_aply_serno --用信申请流水号|C32
and t5.dt='@@{yyyyMMdd}'
and t5.apl_dt >='20240720'  --申请20240720至今
LEFT JOIN edw.dwd_code_library_dd               c1
ON t5.aprv_sts_cd = c1.cd_val
AND c1.DT = '@@{yyyyMMdd}'
AND C1.TBL_NM = 'DWD_BUS_LOAN_LMT_APLY_INFO_DD'
AND C1.FLD_NM = 'APRV_STS_CD'
where t1.dt='@@{yyyyMMdd}'
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240820116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820116_CST_02 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '@@{yyyyMMdd}'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '@@{yyyyMMdd}'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '@@{yyyyMMdd}'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240820116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820116_CST_03 AS
SELECT  t1.REL_SERNO                AS 申请流水号
       ,t1.ctr_serno                AS 合同流水号
       ,t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,t1.ctr_bgn_dt               AS 合同起始日期
       ,t1.ctr_mtu_dt               AS 合同到期日期
       ,concat(t1.mgr_id,t1.mgr_nm) AS 管户人
       ,t1.org_nm                   AS 管户机构
       ,t1.apl_dt                   AS 申请日期
       ,t1.aprv_sts_nm              AS 审批状态
       ,t2.rul_set_rslt_nm          AS 新预评估结果
       ,t2.last_upd_tm              AS 最后更新时间
       ,concat(t2.last_upd_psn_id,t4.empe_nm) AS 最后更新人姓名
       ,t5.POS_NM                   AS 最后更新人岗位
       ,CASE WHEN substr(t5.POS_NM,1,2) = '总行' THEN '总行'
             WHEN substr(t5.POS_NM,1,2) = '分行' THEN '分行'
             WHEN substr(t5.POS_NM,1,2) = '支行' THEN '支行'
             WHEN substr(t5.POS_NM,1,4) = '业务团队' THEN '团队'  ELSE '其他' END AS 最后更新层级
from SJXQ_SJ20240820116_CST_01      t1
left join SJXQ_SJ20240820116_CST_02 t2
on  t1.cst_id=t2.cst_id
left join edw.dws_hr_empe_inf_dd    t4
on  t2.last_upd_psn_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN edw.DIM_HR_ORG_JOB_INF_DD t5 --职位信息
ON      t4.POS_ENC = t5.POS_ID
AND     t5.DT = '@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240820116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240820116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240820116_CST_03
***SJ20240820121_庆元村行客户调查数据.sql
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_01 AS
SELECT  1               as seq      --序号
       ,'7006036156'    as cst_id   --客户号
       ,'7006036156'    as sam_rsk_ctrl_id
-- from qbi_file_20240806_11_13_14
-- where pt <> ''
;
--客户资产概况
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_02 AS
SElECT customerid as cst_id
    ,sum1,sum2,sum3,sum4,sum5,sum6,sum7,sum8
    ,row_number() over(partition by customerid order by inputtime desc) rn
    ,dense_rank() over(partition by customerid order by inputtime desc) rn2
FROM edw.loan_survey_customer_assetsgeneral   --客户资产概况
where dt='20240819'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_03 AS
SELECT  t1.cst_id                    AS 客户号
       ,t1.sam_rsk_ctrl_id           AS 同一风险控制号
       ,t2.sam_rsk_ctrl_cst_xpos_amt AS 同一风险控制号下客户贷款敞口金额
       ,t3.sum8                      AS 最新资产负债率
       ,t4.project                   AS 经营项目
       ,t4.jyporjectname             AS 经营项目名称
       ,t4.jyporjectserialno	     as 经营项目流水号
from SJXQ_SJ20240820121_CST_01 t1
left join edw.dws_bus_loan_sam_rsk_ctrl_inf_dd  t2	--贷款同一风险控制号信息
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t2.dt='20240819'
left join SJXQ_SJ20240820121_CST_02             t3 --客户资产概况
on t1.cst_id=t3.cst_id
and t3.rn=1
left join edw.loan_survey_customer_survey	    t4 --调查报告客户调查信息
on t1.cst_id=t4.customerid	--客户号
and t4.dt='20240819'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240820121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240820121_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240820121_CST_03
;
***SJ20240820121_庆元村行客户调查数据_mod.sql
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_01 AS
SELECT  1               as seq      --序号
       ,'7006036156'    as cst_id   --客户号
       ,'7006036156'    as sam_rsk_ctrl_id
-- from qbi_file_20240806_11_13_14
-- where pt <> ''
;
--客户资产概况
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_02 AS
SElECT customerid as cst_id
    ,sum1,sum2,sum3,sum4,sum5,sum6,sum7,sum8
    ,row_number() over(partition by customerid order by inputtime desc) rn
    ,dense_rank() over(partition by customerid order by inputtime desc) rn2
FROM edw.loan_survey_customer_assetsgeneral   --客户资产概况
where dt='20240819'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_03_1 AS
SELECT  t1.ctr_serno
    ,t1.cst_id
    ,t1.CTR_EPSR_AMT   --合同敞口金额---要这个
    ,t1.CTR_EPSR_BAL   --合同敞口余额
    ,case when nvl(t2.sam_rsk_ctrl_id,'')='' then t1.cst_id else t2.sam_rsk_ctrl_id end sam_rsk_ctrl_id
FROM    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t1
left join edw.dws_cst_bas_inf_dd 		t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt = '20240819'
WHERE   t1.dt = '20240819'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240820121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240820121_CST_03 AS
SELECT  t1.cst_id            AS 客户号
       ,t1.sam_rsk_ctrl_id   AS 同一风险控制号
       ,t1.CTR_EPSR_AMT      AS 同一风险控制号合同敞口金额
       ,t1.CTR_EPSR_BAL      AS 同一风险控制号合同敞口余额
       ,t3.sum8              AS 最新资产负债率
       ,t4.project           AS 经营项目
       ,t4.jyporjectname     AS 经营项目名称
       ,t4.jyporjectserialno AS 经营项目流水号
from SJXQ_SJ20240820121_CST_01 t1
left join (
    SElECT sam_rsk_ctrl_id
        ,sum(CTR_EPSR_AMT) as CTR_EPSR_AMT
        ,sum(CTR_EPSR_BAL) as CTR_EPSR_BAL
    from SJXQ_SJ20240820121_CST_03_1
    group by sam_rsk_ctrl_id
) t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
left join SJXQ_SJ20240820121_CST_02             t3 --客户资产概况
on t1.cst_id=t3.cst_id
and t3.rn=1
left join edw.loan_survey_customer_survey	    t4 --调查报告客户调查信息
on t1.cst_id=t4.customerid	--客户号
and t4.dt='20240819'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240820121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240820121_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240820121_CST_03
;
***SJ2024082056_福清村行信贷征信数据.sql
-- 截至2024/7/31、2024/4/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '福建福清泰隆村镇'
where t1.dt='20240731'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--标准代码块：最新的中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST_02 AS
select *
from(
    SELECT  t.cst_id
        ,t.prd_dt
        ,t.cst_cr_grd_val
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  prd_dt DESC ) AS rn
    FROM
    (
        SELECT  cst_id
            ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyymmdd') AS prd_dt
            ,cr_sco_val                                              AS cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20240731'
        UNION
        SELECT  cst_id
            ,to_date(prd_dt,'yyyymmdd') AS prd_dt
            ,cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20240731'
    ) t
)t1 where rn=1
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST_03 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240731'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240731'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240731'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240731'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST_04 AS
SELECT  cst_id
       ,report_dt	                 --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
       ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
       ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
       ,cred_card_num                --信用卡张数
       ,cred_card_total_amt          --信用卡总授信额度
       ,cred_card_total_balan        --信用卡总余额
       ,late_year_enqu_count         --最近一年内的查询次数
       ,late_3mon_enqu_count         --最近3个月审批查询次数
       ,late_6mon_enqu_count         --最近6个月审批查询次数
       ,idv_crd_sco_val              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
-- union
-- SELECT  cst_id
--        ,report_dt	                 --报告日期
--        ,cred_total_amt               --授信总额（信用总额）
--        ,cred_total_balan             --授信余额（信用总余额）
--        ,OTH_BANK_BUSI_ORG_NUM        --他行贷款授信机构数
--        ,oth_bank_loan_credit_bal     --他行贷款授信余额
--        ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
--        ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
--        ,cred_card_num                --信用卡张数
--        ,cred_card_total_amt          --信用卡总授信额度
--        ,cred_card_total_balan        --信用卡总余额
--        ,late_year_enqu_count         --最近一年内的查询次数
--        ,late_3mon_enqu_count         --最近3个月审批查询次数
--        ,late_6mon_enqu_count         --最近6个月审批查询次数
--        ,idv_crd_sco_val              --个人信用评分分值|DECIMAL(4,0)
-- from edw.dws_cst_ccrc_entp_ind_inf_dd
-- where dt='20240731'
-- and report_dsc_rn='1'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST_05 AS
SELECT  t1.cst_id                       AS 客户号
       ,t1.cst_nm                       AS 客户名
       ,t1.org_nm                       AS 管户机构
       ,t1.mgr_nm                       AS 管户人
       ,t1.ctr_amt                      AS 客户号统计授信总金额
       ,t1.ctr_bal                      AS 客户号统计授信总余额
       ,t1.lst_mtu_dt                   AS 合同最近到期日
       ,t2.prd_dt                       AS 中征分日期
       ,t2.cst_cr_grd_val               AS 中征分
       ,t4.report_dt                    AS 征信报告日期
       ,t4.idv_crd_sco_val              AS 信用评分分值
       ,t5.digital_unscr
       ,t5.report_dt
       ,t4.oth_bank_loan_org_num        AS 他行贷款授信机构数
       ,t4.oth_bank_loan_credit_bal     AS 他行贷款授信余额
       ,t4.curr_unsett_fyh_loan_org_num AS 当前未结清非银行贷款机构数
       ,t4.curr_unsett_fyh_loan_bal     AS 当前未结清非银行贷款余额
       ,t4.cred_card_num                AS 信用卡张数
       ,t4.cred_card_total_amt          AS 信用卡总授信额度
       ,t4.cred_card_total_balan        AS 信用卡总余额
       ,t4.late_year_enqu_count         AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count         AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count         AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm              AS 客户预评估结果
       ,t1.sdt_amt                      AS 我行随贷通额度
       ,t1.sdt_bal                      AS 我行随贷通余额
from(
    SELECT cst_id
        ,cst_nm
        ,mgr_nm
        ,org_nm
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2024082056_CST_01
    group by cst_id ,cst_nm ,mgr_nm ,org_nm
)t1 left join SJXQ_SJ2024082056_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024082056_CST_03      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024082056_CST_04      t4
on t1.cst_id=t4.cst_id
left join(-- 征信分
    SELECT cst_id
        ,substr(report_id,1,8) as report_dt
        ,digital_unscr	        --数字解读 征信分
        ,row_number() over(partition by cst_id order by report_id desc) rn
    from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di --个人征信基本概要信息
    WHERE dt <= '20240731'
)t5 on t1.cst_id=t5.cst_id
and t5.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024082056_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082056_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082056_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082056_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082056_CST_05
***SJ2024082056_福清村行信贷征信数据_0430.sql
-- 截至2024/7/31、2024/4/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST2_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240430'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240430'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240430'
and t4.brc_org_nm regexp '福建福清泰隆村镇'
where t1.dt='20240430'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--标准代码块：最新的中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST2_02 AS
select *
from(
    SELECT  t.cst_id
        ,t.prd_dt
        ,t.cst_cr_grd_val
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  prd_dt DESC ) AS rn
    FROM
    (
        SELECT  cst_id
            ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyymmdd') AS prd_dt
            ,cr_sco_val                                              AS cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20240430'
        UNION
        SELECT  cst_id
            ,to_date(prd_dt,'yyyymmdd') AS prd_dt
            ,cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20240430'
    ) t
)t1 where rn=1
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST2_03 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240430'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240430'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240430'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240430'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST2_04 AS
SELECT  cst_id
       ,report_dt	                 --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
       ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
       ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
       ,cred_card_num                --信用卡张数
       ,cred_card_total_amt          --信用卡总授信额度
       ,cred_card_total_balan        --信用卡总余额
       ,late_year_enqu_count         --最近一年内的查询次数
       ,late_3mon_enqu_count         --最近3个月审批查询次数
       ,late_6mon_enqu_count         --最近6个月审批查询次数
       ,idv_crd_sco_val              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20240430'
and report_dsc_rn='1'
-- union
-- SELECT  cst_id
--        ,report_dt	                 --报告日期
--        ,cred_total_amt               --授信总额（信用总额）
--        ,cred_total_balan             --授信余额（信用总余额）
--        ,OTH_BANK_BUSI_ORG_NUM        --他行贷款授信机构数
--        ,oth_bank_loan_credit_bal     --他行贷款授信余额
--        ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
--        ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
--        ,cred_card_num                --信用卡张数
--        ,cred_card_total_amt          --信用卡总授信额度
--        ,cred_card_total_balan        --信用卡总余额
--        ,late_year_enqu_count         --最近一年内的查询次数
--        ,late_3mon_enqu_count         --最近3个月审批查询次数
--        ,late_6mon_enqu_count         --最近6个月审批查询次数
--        ,idv_crd_sco_val              --个人信用评分分值|DECIMAL(4,0)
-- from edw.dws_cst_ccrc_entp_ind_inf_dd
-- where dt='20240430'
-- and report_dsc_rn='1'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082056_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082056_CST2_05 AS
SELECT  t1.cst_id                       AS 客户号
       ,t1.cst_nm                       AS 客户名
       ,t1.org_nm                       AS 管户机构
       ,t1.mgr_nm                       AS 管户人
       ,t1.ctr_amt                      AS 客户号统计授信总金额
       ,t1.ctr_bal                      AS 客户号统计授信总余额
       ,t1.lst_mtu_dt                   AS 合同最近到期日
       ,t2.prd_dt                       AS 中征分日期
       ,t2.cst_cr_grd_val               AS 中征分
       ,t4.report_dt                    AS 征信报告日期
       ,t4.idv_crd_sco_val              AS 信用评分分值
       ,t5.digital_unscr
       ,t5.report_dt
       ,t4.oth_bank_loan_org_num        AS 他行贷款授信机构数
       ,t4.oth_bank_loan_credit_bal     AS 他行贷款授信余额
       ,t4.curr_unsett_fyh_loan_org_num AS 当前未结清非银行贷款机构数
       ,t4.curr_unsett_fyh_loan_bal     AS 当前未结清非银行贷款余额
       ,t4.cred_card_num                AS 信用卡张数
       ,t4.cred_card_total_amt          AS 信用卡总授信额度
       ,t4.cred_card_total_balan        AS 信用卡总余额
       ,t4.late_year_enqu_count         AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count         AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count         AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm              AS 客户预评估结果
       ,t1.sdt_amt                      AS 我行随贷通额度
       ,t1.sdt_bal                      AS 我行随贷通余额
from(
    SELECT cst_id
        ,cst_nm
        ,mgr_nm
        ,org_nm
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2024082056_CST2_01
    group by cst_id ,cst_nm ,mgr_nm ,org_nm
)t1 left join SJXQ_SJ2024082056_CST2_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024082056_CST2_03      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024082056_CST2_04      t4
on t1.cst_id=t4.cst_id
left join(-- 征信分
    SELECT cst_id
        ,substr(report_id,1,8) as report_dt
        ,digital_unscr	        --数字解读 征信分
        ,row_number() over(partition by cst_id order by report_id desc) rn
    from adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di --个人征信基本概要信息
    WHERE dt <= '20240430'
)t5 on t1.cst_id=t5.cst_id
and t5.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024082056_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082056_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082056_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082056_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082056_CST2_05
***SJ2024082091_汝南村行贷款变更信息.sql
-- 汝南村行目前授信客户的贷款变更信息。
DROP   TABLE IF     EXISTS SJXQ_SJ2024082091_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082091_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.pst_loan_mdf_ctr_serno                   --贷后变更合同流水号|C32
    ,t1.loan_aft_mdf_big_cls_cd
    ,c1.cd_val_dscr         loan_aft_mdf_big_cls_nm --贷后变更大类
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '河南汝南泰隆村镇'
left join edw.dwd_code_library_dd           c1
on t1.loan_aft_mdf_big_cls_cd = c1.cd_val
and c1.dt = '20240731'
where t1.dt='20240731'
;
-- 比如：贷后补充担保、担保人变更、贷款合同利率变更、金额变更，期限变更、还款方式等变更
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082091_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082091_CST_02 AS
SELECT  t1.cst_id                   AS 客户号
       ,t1.cst_nm                   AS 客户名称
       ,concat(t1.mgr_id,' ',t1.mgr_nm) AS 管户人
       ,t1.org_nm                   AS 管户机构
       ,t1.ctr_serno                AS 合同流水号
       ,t1.ctr_amt                  AS 合同金额
       ,t1.ctr_bal                  AS 合同余额
       ,t1.ctr_bgn_dt               AS 合同起始日期
       ,t1.ctr_mtu_dt               AS 合同到期日期
       ,t1.pst_loan_mdf_ctr_serno   AS 贷后变更合同流水号
       ,t1.loan_aft_mdf_big_cls_nm  AS 贷后变更大类
       ,t2.mdf_typ                  AS 变更类型
       ,SUBSTR(t2.MDF_TM,1,8)       AS 变更时间
       ,t2.mdf_pepl                 AS 变更人
FROM SJXQ_SJ2024082091_CST_01               t1
left join EDW.DWD_BUS_LOAN_MNG_MDF_RCD_DD   t2 --管理人变更记录
on t1.ctr_serno=t2.obj_id
and t2.dt='20240731'
and t2.OBJ_TYP = 'Loan'  --对象类型
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024082091_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024082091_CST_02
***SJ2024082346_消保销售适当性专项检查.sql
/*
1.20230815至20240815，全行在该客户贷款发放时间前3天、及后3天购买基金、理财、保险、贵金属的客户4张清单
2.20230815至20240815. 全行购买基金、理财前3天进行2次以上风险测评评估，且最终风险等级上调的客户的3张清单
3.20230815至20240815，全行年龄大于75周岁，且购买理财产品的1张清单
2024销售适当性检查-非现场检查-取数规则
1.20230815至20240815，全行在该客户贷款发放时间前3天、及后3天购买基金、理财、保险、贵金属的客户4张清单，字段包括:客户的姓名、客户号、贷款产品名
称、贷款发放时间、销售基金的时间、基金产品的名称、基金产品的封闭期、基金产品的风险等级、客户经理的姓名、工号、所在详细机构:(2)理财产品字段同
上:(3)保险产品字段同上:(4)贵金属产品字段:客户的姓名、客户号、贷款产品名称、贷款发放时间、销售贵金属的时间、贵金属产品的名称、客户经理的
名、I号、所在详细机构。
2.20230815至20240815，全行购买基金、理财前3天进行2次以上风险测评评估，且最终风险等级上调的客户的3张清单，字段包括:(1)销售基会的时间、产品名
称、基金产品的名称、基金产品的封闭期、基金产品的风险等级、客户第一次风险测评的时间、客户第一次风险测评的等级、客户第二次风险测评的时间、客户第二次
风险测评的等级、客户的姓名、客户号、客户经理的姓名、工号、所在详细机构:(2)理财产品字段同上；(3)保险产品字段同上.
3.20230815至20240815，全行年龄大于75周岁，且购买理财产品的1张清单，字段包括:销售理财产品的时间、销售理财产品时客户的年龄、姓名、客户号、理财
产品的名称、理财产品的封闭期、理财产品的风险等级、客户经理的姓名、工号、所在详细机构。
*/
-- 贷款信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,t3.DBIL_ID	        --借据编号
    ,t3.LVE_ACT_BGN_DT	--出账起始日期
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'    --剔除信用卡
inner join edw.DIM_BUS_LOAN_DBIL_INF_DD	    t3 --信贷借据信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
and t3.LVE_ACT_BGN_DT between '20230815' and '20240815' --贷款发放日期
where t1.dt='@@{yyyyMMdd}'
;
-- 自营/代销 理财交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_02 AS
SELECT T1.CST_ID
    ,T1.SRL_NBR --流水号
    ,T1.TRX_DT
    ,T1.TRX_TM
    ,T1.CFM_DT --确认日期
    ,T1.TRX_CHNL_CD
    ,T1.TRX_AMT --交易金额
    ,T1.CFM_AMT --确认金额
    ,T1.TRX_LOT --交易份额
    ,T1.CFM_LOT --确认份额
    ,T1.MGR_ID      RCM_PSN_ID --推荐人员工号
    ,t4.EMPE_NM     RCM_PSN_NM
    ,T1.TRX_ORG_ID  SALE_ORG_ID
    ,T1.BNK_ACT_ID --银行账号
    ,T1.PD_CD   --产品代码
    ,T2.PD_NM   --产品名称
    ,CASE WHEN T2.CHM_INV_TYP_CD IN ( '1307' , 'D310' )                                            THEN '现金类'
        WHEN T2.CHM_INV_TYP_CD IN ( '1300' , '1306' , 'D300' )                                     THEN '短债类'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 7 THEN '纯固收'
        WHEN T2.CHM_INV_TYP_CD = '1303' AND SUBSTR(T2.PD_CD, 1, 2) = 'CC' AND LENGTH(T2.PD_CD) = 5 THEN '固收+'
        WHEN T2.CHM_INV_TYP_CD = 'D303'                                                            THEN '代销封闭'
        ELSE '' END      PROD_TYPE --产品类型
    ,T2.PFM_COMP_BAS    --业绩比较基准
    ,T2.PD_FOUND_DT     --产品成立日期
    ,T2.PD_VAL_DT       --产品起息日期
    ,T2.PD_END_DT       --产品结束日期
    ,CASE WHEN T2.TA_CD = 'TL' THEN '自营' ELSE '代销' END AGN_IND
    ,t3.age     trx_age
FROM EDW.DWD_BUS_CHM_TRX_CFM_DTL_DD         T1  --理财交易确认流水明细
INNER JOIN EDW.DIM_BUS_CHM_PD_INF_DD        T2
ON T1.PD_CD=T2.PD_CD
and t2.dt = '@@{yyyyMMdd}'
left join ADM_PUB.ADM_CSM_CBAS_IDV_BAS_INF_DD t3
on t1.cst_id = t3.cst_ID
AND T1.TRX_DT = t3.dt
and t3.dt between '20230810' AND '20240820'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总`
on t1.MGR_ID=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
WHERE T1.DT = '@@{yyyyMMdd}'
AND T1.TRX_DT BETWEEN '20230810' AND '20240820'
;
-- 基金 20231217-20231224
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_03 AS
SELECT T0.CST_ID
    ,T1.BUS_CD
    ,DECODE(T1.BUS_CD,'020','认购','022','申购','039','定投申请') TRX_TYPE
    ,T1.bus_glo_srl_nbr TRX_SRL_NBR
    ,T1.chnl_dt TRX_DT
    ,T1.chnl_tm TRX_tm
    ,T0.CFM_DT
    ,T1.CHNL_CD         TRX_CHNL_CD
    ,T1.APL_AMT         TRX_AMT
    ,T0.CFM_AMT                     --确认金额
    ,T1.RCM_PSN_ID                  --推荐人员工号
    ,t4.EMPE_NM         RCM_PSN_NM
    ,T1.TRX_ACT_ID                  --银行账号
    ,t1.taact_id
    ,t1.ta_cd
    ,T1.PD_CD                       --产品代码
    ,T2.PD_NM                       --产品名称
    ,DECODE(T2.FND_TYP_CD,'01','股票型','02','债券型','03','混合型','04','货币型','05','其他','06','FOF基金','') PROD_TYPE
    ,T2.PFM_COMP_BAS                --业绩比较基准
    ,T2.FOUND_DT                    --产品成立日期
    ,''                             --产品起息日期
    ,T2.MTU_DT                      --产品结束日期
FROM EDW.DWD_BUS_CHM_FND_TRX_CFM_DTL_DI     t0
inner join (
    SElECT apl_id,cst_Id,BUS_CD,bus_glo_srl_nbr,chnl_dt,chnl_tm,CHNL_CD,APL_AMT,rcm_psn_id
        ,trx_act_id,taact_id,ta_cd,pd_cd
        ,row_number() OVER(PARTITION by apl_id order by dt desc) rn
    FROM edw.dwd_bus_chm_fnd_cst_rqs_srl_dd  --基金客户资金类交易申请流水
    WHERE dt<='@@{yyyyMMdd}'
    and chnl_dt between '20230810' and '20240820'   --交易时间
    -- AND trx_cd IN ( '100200' , '100201' ) --交易代码 ：100200:理财产品购买、100201:理财产品申购、100213:批量购买、100211:组合产品购买、100214:理财产品预约购买、100257:定向申购、100256:定向购买
    AND trx_sts_cd IN ( '3','S' )        -- 交易成功
)t1 on t0.orig_apl_id = t1.apl_id and t1.rn=1
INNER JOIN EDW.DIM_BUS_CHM_FND_PD_INF_DD        T2  --基金产品表
ON T1.PD_CD=T2.PD_CD
AND T2.DT='@@{yyyyMMdd}'
-- AND T2.FND_TYP_CD<>'04' -- 非货基金
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总`
on T1.RCM_PSN_ID=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
WHERE T0.DT <= '@@{yyyyMMdd}'
AND   T0.TRX_STS_CD IN ( '0' , '3' , '4' , 'S' ) --交易状态：申请成功、确认成功、部分确认成功、成功
AND   T0.BUS_CD IN ( '120' , '122' , '136' , '139' , '138') --认购确认、申购确认、产品转换确认、定时定额申购确认、快速过户确认
AND   T0.CFM_AMT > 0
;
-- 贵金属交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_04 AS
SElECT *
from(
    SELECT ORD_ID               --订单号
        ,replace(ORD_TM,'-','') TRX_DT --订单时间
        ,CST_ID                 --客户号
        ,CST_NM                 --客户名称
        ,USR_NM                 --用户名
        ,PVD_NM                 --商铺名称
        ,PST_MTH                --邮寄方式
        ,PMT_TM                 --付款时间 可代替下单时间
        ,PMT_MTH                --支付方式
        ,CHNL_NM                --渠道
        ,ORD_STS                --订单状态
        ,CMDT_NM                --商品名称
        ,CMDT_SPEC              --商品规格
        ,QTY                    --数量
        ,GOODS_TYP              --商品分类
        ,GOODS_RETURN_STATUS    --商品退款状态
        ,CMDT_UNT_PRC           --商品现金单价
        ,CMDT_PAY_UNT_PRC TRX_AMT --商品应付现金总额
        ,CMSN_TYP               --佣金类型
        ,MID_INC_RTO            --佣金比例/金额
        ,MID_INC_TOT_AMT        --佣金总额
        ,ACCT_ID                --交易账号
        ,RCM_PSN_ID             --推荐人工号
        ,RCM_PSN_NM             --推荐人姓名
        ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
        ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
        ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
        ,RCM_PSN_AFL_BRN        --推荐人所属分行
        ,DATA_SRC               --数据来源 历史导入+金城
        ,RCM_PSN_POS            --员工岗位
        ,DT
        ,LENGTH(ORD_TM) ORD_TM_LEN
        ,CASE WHEN cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
    FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_DTL_DI --贵金属交易明细表
    WHERE dt <= '@@{yyyyMMdd}'
    AND replace(ORD_TM,'-','') >='20230810'   --交易时间
    AND replace(ORD_TM,'-','') <='20240820'   --交易时间
    UNION ALL
    SELECT ORD_ID               --订单号    均为无
        ,replace(ORD_TM,'-','') TRX_DT  --订单时间
        ,CST_ID                 --客户号
        ,CST_NM                 --客户名称
        ,USR_NM                 --用户名
        ,PVD_NM                 --商铺名称
        ,PST_MTH                --邮寄方式
        ,PMT_TM                 --付款时间
        ,PMT_MTH                --支付方式
        ,CHNL_NM                --渠道
        ,ORD_STS                --订单状态
        ,CMDT_NM                --商品名称
        ,CMDT_SPEC              --商品规格
        ,QTY                    --数量
        ,GOODS_TYP              --商品分类
        ,GOODS_RETURN_STATUS    --商品退款状态
        ,CMDT_UNT_PRC           --商品现金单价
        ,CMDT_PAY_UNT_PRC       --商品应付现金总额
        ,CMSN_TYP               --佣金类型
        ,MID_INC_RTO            --佣金比例/金额
        ,MID_INC_TOT_AMT        --佣金总额
        ,''                     --交易账号
        ,RCM_PSN_ID             --推荐人工号
        ,RCM_PSN_NM             --推荐人姓名
        ,RCM_PSN_AFL_DEPT_ID    --推荐人所属部门/团队ID
        ,RCM_PSN_AFL_DEPT       --推荐人所属部门/团队
        ,RCM_PSN_AFL_SUB_BRN    --推荐人所属支行
        ,RCM_PSN_AFL_BRN        --推荐人所属分行
        ,DATA_SRC               --数据来源 退款手工导入+柜面手工导入
        ,RCM_PSN_POS            --员工岗位
        ,DT
        ,LENGTH(ORD_TM) ORD_TM_LEN
        ,CASE WHEN ORD_TM like '%.%' OR ORD_TM like '%/%' OR LENGTH(ORD_TM)=8 OR cst_id='1025723381' THEN 1 ELSE 0 END IS_DEL
    FROM ADM_PUB.ADM_PUB_CST_NOB_MET_TRX_HAND_DI	--贵金属柜面或退款交易手工表
    WHERE dt <= '@@{yyyyMMdd}'
    AND replace(ORD_TM,'-','') >='20230810'   --交易时间
    AND replace(ORD_TM,'-','') <='20240820'   --交易时间
)t1 where IS_DEL=0
;
--保险交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_05 AS
SELECT T2.CST_ID
    ,t2.poly_hldr_nm    --投保人名称
    ,t2.trx_act_id	    --交易帐号id
    ,t2.insu_dt	        --投保日期
    ,t2.pay_fee_yrs	    --缴费年限
    ,t2.fst_perd_prem	--首期保费
    ,t1.bsn_serno	    --业务流水号
    ,T1.TRX_DT
    ,T1.trx_tm
    ,T1.prd_no
    ,t1.cst_magr_id	    --客户经理id
    ,t5.EMPE_NM         cst_magr_nm
    ,T3.prd_nm
    ,T3.prd_rsk_lvl_cd	--产品风险等级代码
    ,T3.isu_tm	        --发布时间
    ,T3.put_off_tm	    --下架时间
    ,t4.cst_act_id      --客户账号
    ,'保险'     prd_cls
FROM EDW.DWD_BUS_INSU_BUS_TRX_SRL_INF_DD    T1 --保险业务交易流水信息
INNER JOIN edw.DIM_BUS_INSU_PLCY_BAS_INF_DD T2 --保单信息表
ON      T2.INSU_POLY_NO = T1.INSU_POLY_NO      --保单编号关联
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DIM_BUS_INSU_PD_INF_DD     T3 --保险产品信息表
ON      T1.prd_no = T3.prd_no  --产品代码
AND     T3.DT = '@@{yyyyMMdd}'
left join edw.dim_bus_dep_cst_act_inf_dd  	t4 --客户存款账户信息
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总`
on T1.cst_magr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.TRX_DT >='20230810'
AND     T1.TRX_DT <='20240820'
AND     T1.BSN_TYP_NM = '订单'
;
-- 理财、基金风评
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_06 AS
select cst_id                           --客户号|C32
    ,cst_rsk_grd_cd     cst_rsk_grd     --客户风险等级代码 1-5
    ,ases_dt                            --评估日期 均正常，没有18991231
from edw.dim_bus_chm_fnd_cst_rsk_grd_inf_dd --基金客户风险等级信息表
where dt<='@@{yyyyMMdd}'
and ases_dt between '20230810' and '20240815'
union
select cst_id
    ,rsk_lvl_cd                               --风险等级代码  0-5，其中=0时，rsk_vld_prd_stop_dt=1899
    ,late_ases_dt                             --最后评估日期
from edw.dwd_bus_chm_cst_rsk_ases_dd          --理财客户风险评估结果表
where dt<='@@{yyyyMMdd}'
and late_ases_dt between '20230810' and '20240815'
;
-- 输出结果1-1 全行客户在贷款发放时间前后3天购买理财的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_01_1 AS
SELECT  t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.PD_NM          AS 贷款产品名称
       ,t1.LVE_ACT_BGN_DT AS 贷款发放日期
       ,T2.TRX_DT         AS 理财购买日期
       ,T2.PD_NM          AS 理财产品名称
       ,T2.PD_FOUND_DT    AS 理财产品成立日期
       ,T2.PD_VAL_DT      AS 理财产品起息日期
       ,T2.PD_END_DT      AS 理财产品结束日期
       ,t2.PD_RSK_GRD     AS 产品风险等级
       ,T2.RCM_PSN_ID     AS 推荐人员工号
       ,t2.RCM_PSN_NM     AS 推荐人员姓名
       ,t3.prm_mgr_id     AS 主管户经理ID
       ,t3.prm_mgr_nm     AS 主管户经理姓名
       ,t4.brc_org_nm     AS 主管户分行
       ,t4.sbr_org_nm     AS 主管户支行
       ,t4.org_nm         AS 主管户机构
from SJXQ_SJ2024082346_CST_01       t1
inner join SJXQ_SJ2024082346_CST_02 t2
on t1.cst_ID=t2.cst_ID
and abs(datediff(to_date(t1.LVE_ACT_BGN_DT,'yyyyMMdd'),to_date(t2.trx_dt,'yyyyMMdd'),'dd'))<=3
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
-- 输出结果1-2 全行客户在贷款发放时间前后3天购买基金的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_01_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_01_2 AS
SELECT  t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.PD_NM          AS 贷款产品名称
       ,t1.LVE_ACT_BGN_DT AS 贷款发放日期
       ,T2.TRX_DT         AS 基金购买日期
       ,T2.PD_NM          AS 基金产品名称
       ,T2.FOUND_DT       AS 基金产品成立日期
       ,T2.MTU_DT         AS 基金产品结束日期
       ,t2.PD_RSK_GRD     AS 产品风险等级
       ,T2.RCM_PSN_ID     AS 推荐人员工号
       ,t2.RCM_PSN_NM     AS 推荐人员姓名
       ,t3.prm_mgr_id     AS 主管户经理ID
       ,t3.prm_mgr_nm     AS 主管户经理姓名
       ,t4.brc_org_nm     AS 主管户分行
       ,t4.sbr_org_nm     AS 主管户支行
       ,t4.org_nm         AS 主管户机构
from SJXQ_SJ2024082346_CST_01       t1
inner join SJXQ_SJ2024082346_CST_03 t2
on t1.cst_ID=t2.cst_ID
and abs(datediff(to_date(t1.LVE_ACT_BGN_DT,'yyyyMMdd'),to_date(t2.trx_dt,'yyyyMMdd'),'dd'))<=3
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
-- 输出结果1-3 全行客户在贷款发放时间前后3天购买贵金属的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_01_3 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_01_3 AS
SELECT  t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.PD_NM          AS 贷款产品名称
       ,t1.LVE_ACT_BGN_DT AS 贷款发放日期
       ,T2.TRX_DT         AS 贵金属购买日期
       ,T2.CMDT_NM        AS 贵金属产品名称
       ,T2.RCM_PSN_ID     AS 推荐人员工号
       ,t2.RCM_PSN_NM     AS 推荐人员姓名
       ,t3.prm_mgr_id     AS 主管户经理ID
       ,t3.prm_mgr_nm     AS 主管户经理姓名
       ,t4.brc_org_nm     AS 主管户分行
       ,t4.sbr_org_nm     AS 主管户支行
       ,t4.org_nm         AS 主管户机构
from SJXQ_SJ2024082346_CST_01       t1
inner join SJXQ_SJ2024082346_CST_04 t2
on t1.cst_ID=t2.cst_ID
and abs(datediff(to_date(t1.LVE_ACT_BGN_DT,'yyyyMMdd'),to_date(t2.trx_dt,'yyyyMMdd'),'dd'))<=3
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
-- 输出结果1-4 全行客户在贷款发放时间前后3天购买保险的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_01_4 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_01_4 AS
SELECT  t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.PD_NM          AS 贷款产品名称
       ,t1.LVE_ACT_BGN_DT AS 贷款发放日期
       ,T2.TRX_DT         AS 保险购买日期
       ,T2.prd_nm         AS 保险产品名称
       ,T2.isu_tm         AS 保险产品发布时间
       ,T2.put_off_tm     AS 保险产品下架时间
       ,t2.prd_rsk_lvl_cd AS 产品风险等级
       ,T2.cst_magr_id    AS 推荐人员工号
       ,t2.cst_magr_nm    AS 推荐人员姓名
       ,t3.prm_mgr_id     AS 主管户经理ID
       ,t3.prm_mgr_nm     AS 主管户经理姓名
       ,t4.brc_org_nm     AS 主管户分行
       ,t4.sbr_org_nm     AS 主管户支行
       ,t4.org_nm         AS 主管户机构
from SJXQ_SJ2024082346_CST_01       t1
inner join SJXQ_SJ2024082346_CST_05 t2
on t1.cst_ID=t2.cst_ID
and abs(datediff(to_date(t1.LVE_ACT_BGN_DT,'yyyyMMdd'),to_date(t2.trx_dt,'yyyyMMdd'),'dd'))<=3
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
-- 输出结果2-1 全行购买基金前3天进行2次以上风险测评，且 最终风险等级上调的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_07 AS
SElECT t1.TRX_SRL_NBR
    ,t2.ases_dt,t2.cst_rsk_grd
    ,row_number() over(partition by t1.TRX_SRL_NBR order by t2.ases_dt) rn_asc
    ,row_number() over(partition by t1.TRX_SRL_NBR order by t2.ases_dt DESC) rn_desc
from SJXQ_SJ2024082346_CST_03       t1
inner join SJXQ_SJ2024082346_CST_06 t2
on t1.cst_ID=t2.cst_ID
and datediff(to_date(t1.trx_dt,'yyyyMMdd'),to_date(t2.ases_dt,'yyyyMMdd'),'dd') between 0 and 3
where t1.trx_dt between '20230815' and '20240815'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_02_1 AS
SELECT  t1.cst_ID      AS 客户号
       ,t3.cst_chn_nm  AS 客户姓名
       ,T1.TRX_DT      AS 基金购买日期
       ,T1.PD_NM       AS 基金产品名称
       ,T1.FOUND_DT    AS 基金产品成立日期
       ,T1.MTU_DT      AS 基金产品结束日期
       ,t1.PD_RSK_GRD  AS 产品风险等级
       ,t4.ases_dt     AS 客户第一次风险测评的时间
       ,t4.cst_rsk_grd AS 客户第一次风险测评的等级
       ,t5.ases_dt     AS 客户第二次风险测评的时间
       ,t5.cst_rsk_grd AS 客户第二次风险测评的等级
       ,t8.ases_dt     AS 客户最终风险测评的时间
       ,t8.cst_rsk_grd AS 客户最终风险测评的等级
       ,T1.RCM_PSN_ID  AS 推荐人员工号
       ,t1.RCM_PSN_NM  AS 推荐人员姓名
       ,t6.prm_mgr_id  AS 主管户经理ID
       ,t6.prm_mgr_nm  AS 主管户经理姓名
       ,t7.brc_org_nm  AS 主管户分行
       ,t7.sbr_org_nm  AS 主管户支行
       ,t7.org_nm      AS 主管户机构
from SJXQ_SJ2024082346_CST_03 t1
inner join(
    select t1.TRX_SRL_NBR
    from SJXQ_SJ2024082346_CST_07 t1
    inner join(
        SElECT TRX_SRL_NBR,min(cst_rsk_grd) sml_rsk
        from SJXQ_SJ2024082346_CST_07
        group by TRX_SRL_NBR
    )t2 on t1.TRX_SRL_NBR=t2.TRX_SRL_NBR
    where t1.rn_desc=1
    and t1.cst_rsk_grd > t2.sml_rsk     --最终风险等级上调
)t2 on t1.TRX_SRL_NBR=t2.TRX_SRL_NBR
left join edw.dws_cst_bas_inf_dd 	    t3 --客户基础信息汇总表
on  t1.cst_ID=t3.cst_ID
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024082346_CST_07      t4
on t1.TRX_SRL_NBR=t4.TRX_SRL_NBR
and t4.rn_asc = 1       --第一次风险测评
left join SJXQ_SJ2024082346_CST_07      t5
on t1.TRX_SRL_NBR=t5.TRX_SRL_NBR
and t5.rn_asc = 2       --第二次风险测评
left join SJXQ_SJ2024082346_CST_07      t8
on t1.TRX_SRL_NBR=t8.TRX_SRL_NBR
and t8.rn_desc = 1       --最终风险测评
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t6 --客户`主管户`信息
on  t1.cst_id = t6.cst_id
and t6.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.prm_org_id = t7.org_id
and t7.dt = '@@{yyyyMMdd}'
where t1.trx_dt between '20230815' and '20240815'
;
-- 输出结果2-2 全行购买理财前3天进行2次以上风险测评，且 最终风险等级上调的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_08 AS
SElECT t1.SRL_NBR
    ,t2.ases_dt,t2.cst_rsk_grd
    ,row_number() over(partition by t1.SRL_NBR order by t2.ases_dt) rn_asc
    ,row_number() over(partition by t1.SRL_NBR order by t2.ases_dt DESC) rn_desc
from SJXQ_SJ2024082346_CST_02       t1
inner join SJXQ_SJ2024082346_CST_06 t2
on t1.cst_ID=t2.cst_ID
and datediff(to_date(t1.trx_dt,'yyyyMMdd'),to_date(t2.ases_dt,'yyyyMMdd'),'dd') between 0 and 3
where t1.trx_dt between '20230815' and '20240815'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_02_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_02_2 AS
SELECT  t1.cst_ID      AS 客户号
       ,t3.cst_chn_nm  AS 客户姓名
       ,T1.TRX_DT      AS 理财购买日期
       ,T1.PD_NM       AS 理财产品名称
       ,T1.PD_FOUND_DT AS 理财产品成立日期
       ,T1.PD_END_DT   AS 理财产品结束日期
       ,t1.PD_RSK_GRD  AS 产品风险等级
       ,t4.ases_dt     AS 客户第一次风险测评的时间
       ,t4.cst_rsk_grd AS 客户第一次风险测评的等级
       ,t5.ases_dt     AS 客户第二次风险测评的时间
       ,t5.cst_rsk_grd AS 客户第二次风险测评的等级
       ,t8.ases_dt     AS 客户最终风险测评的时间
       ,t8.cst_rsk_grd AS 客户最终风险测评的等级
       ,T1.RCM_PSN_ID  AS 推荐人员工号
       ,t1.RCM_PSN_NM  AS 推荐人员姓名
       ,t6.prm_mgr_id  AS 主管户经理ID
       ,t6.prm_mgr_nm  AS 主管户经理姓名
       ,t7.brc_org_nm  AS 主管户分行
       ,t7.sbr_org_nm  AS 主管户支行
       ,t7.org_nm      AS 主管户机构
from SJXQ_SJ2024082346_CST_02 t1
inner join(
    select t1.SRL_NBR
    from SJXQ_SJ2024082346_CST_08 t1
    inner join(
        SElECT SRL_NBR,min(cst_rsk_grd) sml_rsk
        from SJXQ_SJ2024082346_CST_08
        group by SRL_NBR
    )t2 on t1.SRL_NBR=t2.SRL_NBR
    where t1.rn_desc=1
    and t1.cst_rsk_grd > t2.sml_rsk     --最终风险等级上调
)t2 on t1.SRL_NBR=t2.SRL_NBR
left join edw.dws_cst_bas_inf_dd 	    t3 --客户基础信息汇总表
on  t1.cst_ID=t3.cst_ID
and t3.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024082346_CST_08      t4
on t1.SRL_NBR=t4.SRL_NBR
and t4.rn_asc = 1       --第一次风险测评
left join SJXQ_SJ2024082346_CST_08      t5
on t1.SRL_NBR=t5.SRL_NBR
and t5.rn_asc = 2       --第二次风险测评
left join SJXQ_SJ2024082346_CST_08      t8
on t1.SRL_NBR=t8.SRL_NBR
and t8.rn_desc = 1       --最终风险测评
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t6 --客户`主管户`信息
on  t1.cst_id = t6.cst_id
and t6.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.prm_org_id = t7.org_id
and t7.dt = '@@{yyyyMMdd}'
where t1.trx_dt between '20230815' and '20240815'
;
-- 输出结果2-3 全行购买保险前3天进行2次以上风险测评，且 最终风险等级上调的客户清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_09 AS
SElECT t1.bsn_serno
    ,t2.ases_dt,t2.cst_rsk_grd
    ,row_number() over(partition by t1.bsn_serno order by t2.ases_dt) rn_asc
    ,row_number() over(partition by t1.bsn_serno order by t2.ases_dt DESC) rn_desc
from SJXQ_SJ2024082346_CST_05       t1
inner join SJXQ_SJ2024082346_CST_06 t2
on t1.cst_ID=t2.cst_ID
and datediff(to_date(t1.trx_dt,'yyyyMMdd'),to_date(t2.ases_dt,'yyyyMMdd'),'dd') between 0 and 3
where t1.trx_dt between '20230815' and '20240815'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_02_3 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_02_3 AS
SELECT  t1.cst_ID         AS 客户号
       ,t1.poly_hldr_nm   AS 投保人名称
       ,T1.TRX_DT         AS 理财购买日期
       ,T1.prd_nm         AS 理财产品名称
       ,T1.isu_tm         AS 保险产品发布时间
       ,T1.put_off_tm     AS 保险产品下架时间
       ,t1.prd_rsk_lvl_cd AS 产品风险等级
       ,t4.ases_dt        AS 客户第一次风险测评的时间
       ,t4.cst_rsk_grd    AS 客户第一次风险测评的等级
       ,t5.ases_dt        AS 客户第二次风险测评的时间
       ,t5.cst_rsk_grd    AS 客户第二次风险测评的等级
       ,t8.ases_dt        AS 客户最终风险测评的时间
       ,t8.cst_rsk_grd    AS 客户最终风险测评的等级
       ,T1.cst_magr_id    AS 推荐人员工号
       ,t1.cst_magr_nm    AS 推荐人员姓名
       ,t6.prm_mgr_id     AS 主管户经理ID
       ,t6.prm_mgr_nm     AS 主管户经理姓名
       ,t7.brc_org_nm     AS 主管户分行
       ,t7.sbr_org_nm     AS 主管户支行
       ,t7.org_nm         AS 主管户机构
from SJXQ_SJ2024082346_CST_05 t1
inner join(
    select t1.bsn_serno
    from SJXQ_SJ2024082346_CST_09 t1
    inner join(
        SElECT bsn_serno,min(cst_rsk_grd) sml_rsk
        from SJXQ_SJ2024082346_CST_09
        group by bsn_serno
    )t2 on t1.bsn_serno=t2.bsn_serno
    where t1.rn_desc=1
    and t1.cst_rsk_grd > t2.sml_rsk     --最终风险等级上调
)t2 on t1.bsn_serno=t2.bsn_serno
left join SJXQ_SJ2024082346_CST_09      t4
on t1.bsn_serno=t4.bsn_serno
and t4.rn_asc = 1       --第一次风险测评
left join SJXQ_SJ2024082346_CST_09      t5
on t1.bsn_serno=t5.bsn_serno
and t5.rn_asc = 2       --第二次风险测评
left join SJXQ_SJ2024082346_CST_09      t8
on t1.bsn_serno=t8.bsn_serno
and t8.rn_desc = 1       --最终风险测评
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t6 --客户`主管户`信息
on  t1.cst_id = t6.cst_id
and t6.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.prm_org_id = t7.org_id
and t7.dt = '@@{yyyyMMdd}'
where t1.trx_dt between '20230815' and '20240815'
;
-- 输出结果3-1 全行年龄大于75周岁，且购买理财产品的清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024082346_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082346_CST_03_1 AS
SELECT  t1.cst_ID      AS 客户号
       ,t2.cst_chn_nm  AS 客户姓名
       ,T1.TRX_DT      AS 理财购买日期
       ,t1.trx_age     AS 客户购买理财时年龄
       ,T1.PD_NM       AS 理财产品名称
       ,T1.PD_FOUND_DT AS 理财产品成立日期
       ,T1.PD_VAL_DT   AS 理财产品起息日期
       ,T1.PD_END_DT   AS 理财产品结束日期
       ,t1.PD_RSK_GRD  AS 产品风险等级
       ,T1.RCM_PSN_ID  AS 推荐人员工号
       ,t1.RCM_PSN_NM  AS 推荐人员姓名
       ,t3.prm_mgr_id  AS 主管户经理ID
       ,t3.prm_mgr_nm  AS 主管户经理姓名
       ,t4.brc_org_nm  AS 主管户分行
       ,t4.sbr_org_nm  AS 主管户支行
       ,t4.org_nm      AS 主管户机构
FROM SJXQ_SJ2024082346_CST_02       t1
LEFT JOIN edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
ON t1.cst_ID = t2.cst_ID
AND t2.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
WHERE t1.trx_age >= 75 --客户购买理财时年龄
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno,DBIL_ID) custs
from SJXQ_SJ2024082346_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct SRL_NBR) custs
from SJXQ_SJ2024082346_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct TRX_SRL_NBR) custs
from SJXQ_SJ2024082346_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ORD_ID) custs
from SJXQ_SJ2024082346_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct bsn_serno) custs
from SJXQ_SJ2024082346_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082346_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct TRX_SRL_NBR) custs
from SJXQ_SJ2024082346_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct SRL_NBR) custs
from SJXQ_SJ2024082346_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct bsn_serno) custs
from SJXQ_SJ2024082346_CST_09
;
-- 结果表
SElECT '11' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_01_1
union all
SElECT '12' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_01_2
union all
SElECT '13' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_01_3
union all
SElECT '14' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_01_4
union all
SElECT '21' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_02_1
union all
SElECT '22' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_02_2
union all
SElECT '23' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_02_3
union all
SElECT '31' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082346_CST_03_1
***SJ2024082671_天添宝单项计奖.sql
-- 首次购买天添宝在7.1-8.31
-- 1. 汇总天添宝购买明细
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082671_CST_01 AS
SELECT  t.cst_id
        ,t.pd_cd
        ,t.trx_dt
        ,t.trx_tm
        ,t.bus_cd
        ,t.bnk_act_id
        ,sum(cfm_amt) AS cfm_amt_sum
FROM    edw.dwd_bus_chm_trx_cfm_dtl_di t
INNER JOIN    edw.DWD_BUS_CHM_PTFL_CPN_PD_REL_INF_DD t1
ON      t.pd_cd = t1.pd_cd
AND     t1.dt = '20240831'
and     t1.DVD_GRP_CD = 'TTB001'    --'天添宝'
WHERE   t.dt <= '20240831'
AND     t.bus_cd IN ( '120' , '122' , '130' , '134' , '139' ) --认购、申购、基金成立、非交易过户入、定期定额申购
AND     T.trx_sts_cd = '8' --确认成功
GROUP BY t.cst_id ,t.pd_cd,t.trx_dt , t.trx_tm , t.bus_cd , t.bnk_act_id;
-- 2. 首笔7.1-8.31
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_02 AS
SELECT  *
FROM    (
            SELECT  t.cst_id
                    ,t.pd_cd
                    ,t.trx_dt
                    ,t.trx_tm
                    ,t.bus_cd
                    ,t.bnk_act_id
                    ,t.cfm_amt_sum
                    ,row_number() OVER ( PARTITION BY t.cst_id ORDER BY t.trx_dt ASC , t.trx_tm ASC ) AS rn
            FROM    lab_bigdata_dev.SJXQ_SJ2024082671_CST_01 t
        ) A
WHERE   rn = 1
AND     trx_dt >= '20240701'
AND     trx_dt <= '20240831';
-- 账户考核机构
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_03 AS
SElECT t1.cst_id,t1.bnk_act_id
    ,t2.brc_org_id as 账户考核机构分行编号
    ,t2.brc_org_nm as 账户考核机构分行名称
    ,t2.sbr_org_id as 账户考核机构支行编号
    ,t2.sbr_org_nm as 账户考核机构支行名称
    ,t2.tem_org_id as 账户考核机构团队编号
    ,t2.tem_org_nm as 账户考核机构团队名称
from(
    SElECT t1.cst_id,t1.bnk_act_id
        ,COALESCE(bb.MGR_ID, C.MGR_ID, '')                  AS MGR_ID -- 管户人 理财签约可能是二类户
        ,COALESCE(bb.MGR_RTO, C.MGR_RTO, 1)                 AS MGR_RTO --考核比例
        ,COALESCE(bb.ACS_ORG_ID, C.ACS_ORG_ID, '990000000') AS ACS_ORG_ID -- 账户考核机构
    from lab_bigdata_dev.SJXQ_SJ2024082671_CST_02   t1
    LEFT JOIN    edw.DWD_BUS_DEP_CST_ACT_MGR_INF_DD bb --客户存款账户管护信息
    ON      t1.BNK_ACT_ID = bb.CST_ACT_ID -- 客户账号
    AND     bb.DT = '@@{yyyyMMdd}'
    LEFT JOIN    edw.DWS_BUS_DEP_ACT_MGR_INF_DD C --存款账户管护汇总信息
    ON      t1.BNK_ACT_ID = C.DEP_ACT_ID --存款账号
    AND     C.DEP_ACT_ID <> C.CST_ACT_ID
    AND     C.DT = '@@{yyyyMMdd}'
)t1 LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t2 --机构树_考核维度
ON      t1.acs_org_id = t2.org_id
AND     t2.dt = '@@{yyyyMMdd}'
;
-- 购买时账户考核
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_04 AS
SELECT  t1.cst_id
       ,t1.pd_cd
       ,t1.bnk_act_id
       ,t1.trx_dt
       ,t1.trx_tm
       ,t2.mgr_id
       ,t2.acs_org_id
       ,t3.empe_nm
       ,t4.org_chrg_id AS 团队负责人工号
       ,t4.org_chrg_nm AS 团队负责人姓名
       ,t5.sbr_org_id  AS 员工所在支行编号
       ,t5.sbr_org_nm  AS 员工所在支行名称
       ,t6.org_chrg_id AS 支行负责人工号
       ,t6.org_chrg_nm AS 支行负责人姓名
    ,row_number() over(partition by t1.cst_id,t1.pd_cd,t1.bnk_act_id order by acs_rto desc,mgr_id asc) rn
from lab_bigdata_dev.SJXQ_SJ2024082671_CST_02 t1
left join edw.dws_bus_chm_act_mgr_inf_dd      t2 --理财考核汇总信息 2521523 cst_id,pd_cd,mng_typ_cd,mgr_id,bnk_act_id,acs_org_id 唯一
on t1.cst_id=t2.cst_id
and t1.pd_cd=t2.pd_cd
and t1.bnk_act_id=t2.bnk_act_id
and t1.trx_dt=t2.dt     --交易日考核
and t2.dt>='20240701'
and t2.dt<='20240831'
and t2.mng_typ_cd = '1'  --`管户`类型 1考核 2销售
and t2.pd_tp_cd='1'      --理财类型：0基金 1理财
left join edw.dws_hr_empe_inf_dd            t3 --员工汇总信息
on t2.mgr_id=t3.empe_id
and t3.dt='20240831'
left join edw.dim_hr_org_bas_inf_dd         t4 --机构信息
on t2.acs_org_id=t4.org_id
and t4.dt = '20240831'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd    t5 --机构树_考核维度
ON t3.org_id = t5.org_id
AND t5.dt = '20240831'
LEFT JOIN edw.dim_hr_org_bas_inf_dd         t6 --机构信息
ON t5.sbr_org_id = t6.org_id
AND t6.dt = '20240831'
;
-- 输出结果
DROP TABLE IF EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024082671_CST_05 AS
SELECT  t2.账户考核机构分行编号
       ,t2.账户考核机构分行名称
       ,t2.账户考核机构支行编号
       ,t2.账户考核机构支行名称
       ,t2.账户考核机构团队编号
       ,t2.账户考核机构团队名称
       ,t1.pd_cd       AS 产品代码
       ,t1.trx_dt      AS 客户首次购买时间
       ,t1.cst_id      AS 客户号
       ,t1.cfm_amt_sum AS 天添宝购买金额
       ,t3.mgr_id      AS 管户人工号
       ,t3.empe_nm     AS 管户人姓名
       ,t3.团队负责人工号
       ,t3.团队负责人姓名
       ,t3.支行负责人工号
       ,t3.支行负责人姓名
from SJXQ_SJ2024082671_CST_02       t1
left join SJXQ_SJ2024082671_CST_03  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024082671_CST_04  t3
on t1.cst_id=t3.cst_id
and t1.pd_cd=t3.pd_cd
and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1     -- 用账户比例高的管户人，比例一致取工号小者
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082671_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082671_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082671_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082671_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024082671_CST_05
***SJ2024082717_支行开门红营销线索.sql
-- 1、存量随贷通可以理解为截至8.28日办理过随贷通的客户，匹配上风险程度和资金需求度
-- 2、年龄在60岁及以上，用信过指的是办理的随贷通卡有用信记录的
-- 4、在我行有大额存款或理财或基金等，（标准是300万或者500万，因为没有把握，所以希望取中位值以上的）且他行有大额信贷业务的（大额指的是100万以上）
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_01 AS
select t1.bus_ctr_id                             --业务合同编号
	,t1.cst_id                                   --客户号
	,t1.crd_lmt                                  --授信额度
	,t1.bind_lmt                                 --绑定额度
	,t1.use_lmt                                  --已用额度
	,t1.eft_dt                                   --生效日期
	,t1.mtu_dt                                   --到期日期
	,t1.norm_intr_rat                            --正常利率
	,t1.cmpd_intr_rat                            --复利利率
	,t1.loan_pd                                  --贷款产品
	,t1.trm_mon                                  --贷款期限_月
	,t1.ym_intr_rat_cd                           --年/月利率标识代码
    ,t3.mgr_id	                                 --管户人工号
    ,t3.mgr_nm	                                 --管户人姓名
    ,t3.mgr_org_id	                             --管户机构号
    ,t4.brc_org_nm,t4.org_nm
    ,t2.age
    ,t2.cst_chn_nm	--客户中文名称
    ,case when t5.CTR_SERNO is not null then 1 else 0 end is_usecrdt
from edw.dwd_bus_loan_fnc_crd_lmt_inf_dd        t1 --随贷通授信额度信息
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2	--对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.bus_ctr_id=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '台州分行'
left join (
    SElECT distinct CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd	--信贷借据信息
    where dt='@@{yyyyMMdd}'
)t5 on t1.bus_ctr_id=t5.ctr_serno
where t1.dt='@@{yyyyMMdd}'
;
--客户财富信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_02 AS
SELECT  t1.cst_id
    ,t2.dep_bal          --存款余额
    ,t2.dep_bal_mon_avg  --存款余额月日均
    ,t3.fund_amt         --基金金额
    ,t3.fnc_amt          --理财金额
    ,t3.wlth_bal         --财富资产余额
    ,t3.aum_bal          --AUM余额
    ,t3.fund_mon_avg_amt --基金金额月日均
    ,t3.fnc_mon_avg_amt  --理财金额月日均
    ,t3.wlth_mon_avg     --财富资产余额月日均
    ,t3.aum_mon_avg      --AUM月日均
    ,t4.prm_mgr_id,t4.prm_mgr_nm,t4.prm_org_id
    ,t5.brc_org_nm,t5.sbr_org_nm,t5.tem_org_nm,t5.org_nm
from edw.dws_cst_bas_inf_dd                         t1 --客户基础信息汇总表
left join adm_pub.adm_csm_cbus_dep_inf_dd	        t2 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t3 --客户集市-业务信息-客户金融资产信息表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t4 --客户`主管户`信息
on  t1.cst_id = t4.cst_id
and t4.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t5 --考核机构树
on  t4.prm_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
and t5.brc_org_nm regexp '台州分行'
where t1.dt = '@@{yyyyMMdd}'
;
-- 输出结果1  存量办理过随贷通的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_03 AS
SELECT  distinct org_nm AS 管户机构
       ,cst_id          AS 客户号
       ,cst_chn_nm      AS 客户姓名
from SJXQ_SJ2024082717_CST_01
;
-- 输出结果2  年龄在60岁及以上，随贷通用信客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_04 AS
SELECT  distinct org_nm AS 管户机构
       ,cst_id          AS 客户号
       ,cst_chn_nm      AS 客户姓名
from SJXQ_SJ2024082717_CST_01
where age>=60
and is_usecrdt=1    --用信
;
-- 财富中位数
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_05 AS
SElECT median(dep_bal        )  as 存款余额_中位数
    ,median(dep_bal_mon_avg  )  as 存款余额月日均_中位数
    ,median(fund_amt         )  as 基金金额_中位数
    ,median(fnc_amt          )  as 理财金额_中位数
    ,median(wlth_bal         )  as 财富资产余额_中位数
    ,median(aum_bal          )  as AUM余额_中位数
    ,median(fund_mon_avg_amt )  as 基金金额月日均_中位数
    ,median(fnc_mon_avg_amt  )  as 理财金额月日均_中位数
    ,median(wlth_mon_avg     )  as 财富资产余额月日均_中位数
    ,median(aum_mon_avg      )  as AUM月日均_中位数
from SJXQ_SJ2024082717_CST_02
;
***SJ2024082717_支行开门红营销线索0903.sql
-- 1、存量随贷通可以理解为截至8.28日办理过随贷通的客户，匹配上风险程度和资金需求度
-- 2、年龄在60岁及以上，用信过指的是办理的随贷通卡有用信记录的
-- 4、在我行有大额存款或理财或基金等，（标准是300万或者500万，因为没有把握，所以希望取中位值以上的）且他行有大额信贷业务的（大额指的是100万以上）
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_01 AS
select t1.bus_ctr_id                             --业务合同编号
	,t1.cst_id                                   --客户号
	,t1.crd_lmt                                  --授信额度
	,t1.bind_lmt                                 --绑定额度
	,t1.use_lmt                                  --已用额度
	,t1.eft_dt                                   --生效日期
	,t1.mtu_dt                                   --到期日期
	,t1.norm_intr_rat                            --正常利率
	,t1.cmpd_intr_rat                            --复利利率
	,t1.loan_pd                                  --贷款产品
	,t1.trm_mon                                  --贷款期限_月
	,t1.ym_intr_rat_cd                           --年/月利率标识代码
    ,t3.mgr_id	                                 --管户人工号
    ,t3.mgr_nm	                                 --管户人姓名
    ,t3.mgr_org_id	                             --管户机构号
    ,t4.brc_org_nm,t4.org_nm
    ,t2.age
    ,t2.cst_chn_nm	--客户中文名称
    ,case when t5.CTR_SERNO is not null then 1 else 0 end is_usecrdt
from edw.dwd_bus_loan_fnc_crd_lmt_inf_dd        t1 --随贷通授信额度信息
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd   t2	--对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.bus_ctr_id=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '台州分行'
left join (
    SElECT distinct CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd	--信贷借据信息
    where dt='@@{yyyyMMdd}'
)t5 on t1.bus_ctr_id=t5.ctr_serno
where t1.dt='@@{yyyyMMdd}'
;
--客户财富信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_02 AS
SELECT  t1.cst_id
    ,t2.dep_bal          --存款余额
    ,t2.dep_bal_mon_avg  --存款余额月日均
    ,t3.fund_amt         --基金金额
    ,t3.fnc_amt          --理财金额
    ,t3.wlth_bal         --财富资产余额
    ,t3.aum_bal          --AUM余额
    ,t3.fund_mon_avg_amt --基金金额月日均
    ,t3.fnc_mon_avg_amt  --理财金额月日均
    ,t3.wlth_mon_avg     --财富资产余额月日均
    ,t3.aum_mon_avg      --AUM月日均
    ,t4.prm_mgr_id,t4.prm_mgr_nm,t4.prm_org_id
    ,t5.brc_org_nm,t5.sbr_org_nm,t5.tem_org_nm,t5.org_nm
from edw.dws_cst_bas_inf_dd                         t1 --客户基础信息汇总表
left join adm_pub.adm_csm_cbus_dep_inf_dd	        t2 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t3 --客户集市-业务信息-客户金融资产信息表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd  t4 --客户`主管户`信息
on  t1.cst_id = t4.cst_id
and t4.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd           t5 --考核机构树
on  t4.prm_org_id = t5.org_id
and t5.dt = '@@{yyyyMMdd}'
and t5.brc_org_nm regexp '台州分行'
where t1.dt = '@@{yyyyMMdd}'
;
-- 输出结果1  存量办理过随贷通的客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_03 AS
SELECT  distinct org_nm AS 管户机构
       ,cst_id          AS 客户号
       ,cst_chn_nm      AS 客户姓名
from SJXQ_SJ2024082717_CST_01
;
-- 输出结果2  年龄在60岁及以上，随贷通用信客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_04 AS
SELECT  distinct org_nm AS 管户机构
       ,cst_id          AS 客户号
       ,cst_chn_nm      AS 客户姓名
from SJXQ_SJ2024082717_CST_01
where age>=60
and is_usecrdt=1    --用信
;
-- 财富中位数 取存款余额月日均或财富资产余额月日均 大于100万,且他行贷款总授信额度 大于100万
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_05 AS
SElECT median(dep_bal        )  as 存款余额_中位数
    ,median(dep_bal_mon_avg  )  as 存款余额月日均_中位数
    ,median(fund_amt         )  as 基金金额_中位数
    ,median(fnc_amt          )  as 理财金额_中位数
    ,median(wlth_bal         )  as 财富资产余额_中位数
    ,median(aum_bal          )  as AUM余额_中位数
    ,median(fund_mon_avg_amt )  as 基金金额月日均_中位数
    ,median(fnc_mon_avg_amt  )  as 理财金额月日均_中位数
    ,median(wlth_mon_avg     )  as 财富资产余额月日均_中位数
    ,median(aum_mon_avg      )  as AUM月日均_中位数
from SJXQ_SJ2024082717_CST_02
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024082717_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082717_CST_06 AS
SELECT  distinct t1.org_nm AS 管户机构
       ,t1.cst_id          AS 客户号
       ,t1.cst_chn_nm      AS 客户姓名
from SJXQ_SJ2024082717_CST_01       t1
inner join SJXQ_SJ2024082717_CST_02 t2
on t1.cst_id=t2.cst_id
inner join(
    select cst_id
        ,sum(cred_total_amt)        cred_total_amt      --授信总额（信用总额）
        ,sum(cred_total_balan)      cred_total_balan    --授信余额（信用总余额）
        ,sum(loan_total_amt)	    loan_total_amt      --贷款总授信额度
    from edw.dws_cst_ccrc_idv_ind_inf_dd
    where dt='@@{yyyyMMdd}'
    and report_dsc_rn=1	--报告降序排序号
    group by cst_id
    having sum(loan_total_amt)>1000000
)t3 on t1.cst_id=t3.cst_id
where t2.dep_bal_mon_avg >1000000 or t2.wlth_mon_avg>1000000
;
***SJ2024082781_台州分行房产抵押数据.sql
-- 数据截至2024年7月31日 台州分行
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.cur_rsk_ctg_rslt_cd	    --当前风险分类结果代码 五级分类
    ,c1.cd_val_dscr         cur_rsk_ctg_rslt_nm
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,t5.max_OVD_DAY
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '台州分行'
left join (
    SElECT CTR_SERNO	--合同流水号|C32
        ,max(OVD_DAY) 	max_OVD_DAY--逾期天数
    from DIM_BUS_LOAN_DBIL_INF_DD   --信贷借据信息
    where dt='20240731'
    group by ctr_serno
)t5 on t1.ctr_serno=t5.ctr_serno
left join edw.dwd_code_library_dd c1
on t1.cur_rsk_ctg_rslt_cd = c1.cd_val
and c1.dt = '20240731'
where t1.dt='20240731'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--标准代码块：抵质押物,三种类型要合并在一起
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST_02 AS
SELECT  CLTR_NO --AS 押品编号
        -- ,dtl_lct --AS 详细坐落位置
        -- ,bld_area --AS 建筑面积
        ,'个人商业住宅'     yp_type
FROM    edw.DIM_BUS_LOAN_CLTR_PRPT_SPCL_DD  --不动产专项信息
WHERE     dt = '20240731'
UNION
SELECT  CLTR_NO --AS 押品编号
        -- ,dtl_lct --AS 详细坐落位置
        -- ,bld_area --AS 建筑面积
        ,'商业地产'     yp_type
FROM    edw.DIM_BUS_LOAN_CLTR_CMRC_PRPT_SPCL_DD     --商业不动产专项信息
WHERE   dt = '20240731'
UNION
SELECT  CLTR_NO --AS 押品编号
        -- ,dtl_lct --AS 详细坐落位置
        -- ,bld_area --AS 建筑面积
        ,'工业地产'     yp_type
FROM    edw.DIM_BUS_LOAN_CLTR_PLT_WHS_SPCL_DD   --厂房仓库专项信息
WHERE   dt = '20240731'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST_03 AS
select t1.ctr_serno,t1.ctr_bal
	,t2.grnt_ctr_id                              --担保合同编号|c32
	,t2.grnt_tot_amt                             --担保总金额|decimal(21,2)
	,t2.grnt_id                                  --担保物编号|c32
	,t2.cltr_nm                                  --押品名称|c128
	,t2.cltr_typ_cd                              --押品类型代码|c9
    ,c1.cd_val_dscr as cltr_typ_nm
    ,t3.ases_val	    --评估价值
    ,t3.mort_pldg_rat	--抵质押率
    ,case when t3.mort_pldg_rat <= 0.7 then '1 <=70%'
        when t3.mort_pldg_rat>0.7 and t3.mort_pldg_rat<=1 then '2 70%<x<=100%'
        when t3.mort_pldg_rat>1 then '3 >100%' else '' end mort_pldg_rat_lvl
    ,row_number() over(partition by t1.ctr_serno order by t2.grnt_ctr_id desc)rn
from SJXQ_SJ2024082781_CST_01               t1
INNER join edw.dws_bus_grnt_itm_inf_dd      t2 --担保物汇总信息
on t1.ctr_serno=t2.busi_ctr_id
and t2.dt='20240731'
and t2.cltr_typ_cd in(
    'C010101','C010102'     --个人商业住房
    ,'C020202','C0102','C010206'     --商业地产
    ,'C0104','C020201'   --工业地产
)
INNER JOIN (
    select cltr_no,ases_val,mort_pldg_rat
        ,row_number() over(partition by cltr_no order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd
    where dt = '20240731'
) t3 --押品价值评估申请信息表
ON  t2.grnt_id = t3.cltr_no     --押品编号
and t3.rn=1
left join edw.dwd_code_library_dd c1
on t2.cltr_typ_cd=c1.cd_val
and c1.dt= '@@{yyyyMMdd}'
where t1.is_jyd=1  --经营性贷款
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST_04 AS
SELECT  mort_pldg_rat_lvl                                         AS 当前实际抵押率
       ,COUNT(distinct ctr_serno)                           AS 抵押贷款笔数
       ,SUM(case WHEN rn = 1 THEN ctr_bal else 0 end)/10000 AS 抵押贷款余额_万元
       ,COUNT(distinct grnt_id)                                      AS 抵押房产套数
from SJXQ_SJ2024082781_CST_03
group by mort_pldg_rat_lvl
order by mort_pldg_rat_lvl
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST_05 AS
SELECT  cltr_typ_lvl                 AS 抵押物类别
       ,COUNT(distinct grnt_id) AS 抵押房产套数
from SJXQ_SJ2024082781_CST_03
group by cltr_typ_lvl
;
-- 输出结果3 明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST_05 AS
SELECT  t1.ctr_serno     AS 合同流水号
       ,t1.cst_id        AS 客户号
       ,t1.cst_nm        AS 客户名称
       ,t1.ctr_amt       AS 合同金额
       ,t1.ctr_bal       AS 合同余额
       ,t1.ctr_bgn_dt    AS 合同起始日期
       ,t1.ctr_mtu_dt    AS 合同到期日期
       ,case when t1.ovd_dt='18991231' then '' end t1.ovd_dt end           AS 逾期日期
       ,t1.max_OVD_DAY   AS 逾期天数
       ,case when t1.ovd_intr_dt='18991231' then '' end t1.ovd_intr_dt end AS 欠息日期
       ,t1.cur_rsk_ctg_rslt_nm    AS 五级分类
       ,t2.dyp_num       AS 抵押房产套数
       ,t2.ases_val      AS 抵押物评估价
       ,t2.mort_pldg_rat AS 抵押物抵押率
from SJXQ_SJ2024082781_CST_01       t1
left join(
    SElECT ctr_serno
        ,count(distinct grnt_id)    dyp_num
        ,sum(ases_val)  as ases_val	    --评估价值
    from SJXQ_SJ2024082781_CST_03
    group by ctr_serno
)t2 on  t1.ctr_serno=t2.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024082781_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct CLTR_NO) custs
from SJXQ_SJ2024082781_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024082781_CST_03
;
***SJ2024082781_台州分行房产抵押数据2.sql
-- 根据指定合同号 匹配 合同金额、合同余额、抵押房产套数、抵押物评估价值
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST2_01 AS
SELECT  col_1 AS seq        --序号
       ,col_2 AS ctr_serno  --客户号
FROM qbi_file_20240828_15_49_13
WHERE pt <> ''
;
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST2_02 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t3.seq
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240731'
and t2.PD_NM not regexp '信用卡'
inner join SJXQ_SJ2024082781_CST2_01        t3
on t1.ctr_serno=t3.ctr_serno
where t1.dt='20240731'
;
-- 抵押表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST2_03 AS
SElECT t1.ctr_serno,t1.seq
    ,count(1)   cnt
    ,count(distinct t2.grnt_id)     dyp_num
    ,sum(t3.ases_val)               ases_val
from SJXQ_SJ2024082781_CST2_01              t1
INNER join edw.dws_bus_grnt_itm_inf_dd      t2 --担保物汇总信息
on t1.ctr_serno=t2.busi_ctr_id
and t2.dt='20240731'
INNER JOIN (
    select cltr_no,ases_val,mort_pldg_rat
        ,row_number() over(partition by cltr_no order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd  --押品价值评估申请信息表
    where dt = '20240731'
) t3 ON t2.grnt_id = t3.cltr_no     --押品编号
and t3.rn=1
group by t1.ctr_serno,t1.seq
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082781_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082781_CST2_04 AS
SELECT  t1.seq       AS 序号
       ,t1.ctr_serno AS 合同号
       ,t2.ctr_amt   AS 合同金额
       ,t2.ctr_bal   AS 合同余额
       ,t3.dyp_num   AS 抵押房产套数
       ,t3.ases_val  AS 抵押物评估价值
from SJXQ_SJ2024082781_CST2_01      t1
left join SJXQ_SJ2024082781_CST2_02 t2
on t1.seq=t2.seq
left join SJXQ_SJ2024082781_CST2_03 t3
on t1.seq=t3.seq
;
SElECT '01' seq, count(1) cnt,count(distinct seq) custs
from SJXQ_SJ2024082781_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct seq) custs
from SJXQ_SJ2024082781_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct seq) custs
from SJXQ_SJ2024082781_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024082781_CST2_04
***SJ2024082786_庆元村行随贷通数据.sql
-- 截止2024年07月31日，庆元村行随贷通客户数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_01 AS
select t1.bus_ctr_id                             --业务合同编号
	,t1.cst_id                                   --客户号
	,t1.crd_lmt                                  --授信额度
	,t1.bind_lmt                                 --绑定额度
	,t1.use_lmt                                  --已用额度
	,t1.eft_dt                                   --生效日期
	,t1.mtu_dt                                   --到期日期
	,t1.norm_intr_rat                            --正常利率
	,t1.cmpd_intr_rat                            --复利利率
	,t1.loan_pd                                  --贷款产品
	,t1.trm_mon                                  --贷款期限_月
	,t1.ym_intr_rat_cd                           --年/月利率标识代码
    ,t3.mgr_id	                                 --管户人工号
    ,t3.mgr_nm	                                 --管户人姓名
    ,t3.mgr_org_id	                             --管户机构号
    ,t4.brc_org_nm,t4.org_nm
from edw.dwd_bus_loan_fnc_crd_lmt_inf_dd    t1 --随贷通授信额度信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.bus_ctr_id=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '浙江庆元泰隆村镇'
where t1.dt='20240731'
AND t1.LMT_STS_CD NOT IN ( '1' , '2' ) --'0','正常' ,'1','停用' ,'2','已解约' ,'3','未激活' ,'4','止付' ,'5','未签约'
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_02 AS
SElECT *
from(
    SELECT  t1.cst_id
        ,t2.prd_dt
        ,t2.cst_cr_grd_val
        ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
    FROM (
        select distinct cst_id
        from SJXQ_SJ2024082786_CST_01
    )t1 inner join(
        SELECT  cst_id
            ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
            ,cr_sco_val                                              AS cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20240731'
        UNION
        SELECT  cst_id
            ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
            ,cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20240731'
    )t2 on t1.cst_id=t2.cst_id
)t1 where rn=1
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_03 AS
SELECT  cst_id
       ,report_dt	                 --报告日期
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
union
SELECT  cst_id
       ,report_dt	                --报告日期
       ,oth_bank_busi_org_num	    --他行授信机构数
       ,un_sett_loan_total_amt	    --未结清贷款总额
from edw.dws_cst_ccrc_entp_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
;
-- 个人征信客户贷款信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_04 AS
SELECT t.cst_id
    ,COALESCE(T2.RATE,0) RATE
    ,row_number() over(partition by t.cst_id order by t1.report_id desc) rn
FROM (
    select distinct cst_id
    from SJXQ_SJ2024082786_CST_01
)T LEFT JOIN EDW.DIM_CST_CCRC_IDV_LOAN_INF_DD  T1 -- 个人征信客户贷款信息
ON  T.cst_id = T1.cst_id
AND T1.DT = '20240731'
LEFT JOIN
(
	SELECT  DISTINCT REPORT_ID
	       ,ID
	       ,RATE
	FROM EDW.NCIP_CPQ_ACCOUNT_CALCULATE
	WHERE DT <= '20240731'
)T2 ON T1.REPORT_ID = T2.REPORT_ID
AND T1.ID = T2.ID
;
-- 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_05 AS
select t1.cst_id
    ,t2.sdt_loan_mon_avg	--随贷通余额月日均
    ,case when t3.cst_id is not null then '对私' else '对公' end cst_type
    ,t3.age
    ,decode(t3.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t3.mrg_situ_cd	    --婚姻状况
    ,c2.cd_val_dscr     mrg_situ_nm
    ,t4.cst_chn_nm	--客户姓名|C200
    ,t4.idt_cd	    --行业代码|C5
    ,c1.cd_val_dscr     idt_nm
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024082786_CST_01
)t1 left join adm_pub.adm_csm_cbus_loan_inf_dd	t2 --客户集市-业务信息-客户贷款业务信息表	40
on t1.cst_id=t2.cst_id
and t2.dt='20240731'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t3 --对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt='20240731'
left join edw.dws_cst_bas_inf_dd 				t4 --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20240731'
left join edw.dwd_code_library_dd c1
on t4.idt_cd = c1.cd_val
and c1.dt = '20240731'
left join edw.dwd_code_library_dd c2
on t3.mrg_situ_cd = c2.cd_val
and c2.dt = '20240731'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_06 AS
select t1.bus_ctr_id                             --业务合同编号
	,t1.cst_id                                   --客户号
	,t1.crd_lmt                                  --授信额度
	,t1.bind_lmt                                 --绑定额度
	,t1.use_lmt                                  --已用额度
	,t1.eft_dt                                   --生效日期
	,t1.mtu_dt                                   --到期日期
	,t1.norm_intr_rat                            --正常利率
	,t1.cmpd_intr_rat                            --复利利率
	,t1.loan_pd                                  --贷款产品
	,t1.trm_mon                                  --贷款期限_月
	,t1.ym_intr_rat_cd                           --年/月利率标识代码
    ,t1.mgr_id	                                 --管户人工号
    ,t1.mgr_nm	                                 --管户人姓名
    ,t1.mgr_org_id	                             --管户机构号
    ,t1.brc_org_nm,t1.org_nm
    ,t2.cst_cr_grd_val
    ,t3.oth_bank_loan_org_num        --他行贷款授信机构数
    ,t3.oth_bank_loan_credit_bal     --他行贷款授信余额
    ,t4.RATE
    ,t5.sdt_loan_mon_avg	--随贷通余额月日均
    ,t5.cst_chn_nm
    ,t5.age
    ,t5.gdr_nm
    ,t5.idt_nm	        --行业代码
    ,t5.mrg_situ_nm	    --婚姻状况
    ,t5.cst_type
from SJXQ_SJ2024082786_CST_01       t1
left join SJXQ_SJ2024082786_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024082786_CST_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024082786_CST_04  t4
on t1.cst_id=t4.cst_id and t4.rn=1
left join SJXQ_SJ2024082786_CST_05  t5
on t1.cst_id=t5.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_07 AS
SELECT  bus_ctr_id                AS 业务合同号
       ,cst_id                    AS 客户号
       ,cst_chn_nm                AS 客户姓名
       ,gdr_nm                    AS 性别
       ,age                       AS 年龄
       ,idt_nm                    AS 行业
       ,mrg_situ_nm               AS 婚姻状况
       ,cst_cr_grd_val            AS 征信分
       ,crd_lmt                   AS 授信额度
       ,bind_lmt                  AS 绑定额度
       ,use_lmt                   AS 已用额度
       ,sdt_loan_mon_avg          AS 随贷通余额月日均
       ,norm_intr_rat             AS 正常利率
       ,cmpd_intr_rat             AS 复利利率
       ,trm_mon                   AS 贷款期限_月
       ,cst_type                  AS 客户类型
       ,concat(mgr_id,' ',mgr_nm) AS 管户人
       ,org_nm                    AS 管户机构
       ,eft_dt                    AS 合同生效日期
       ,mtu_dt                    AS 合同到期日期
       ,oth_bank_loan_org_num     AS 他行贷款授信机构数
       ,oth_bank_loan_credit_bal  AS 他行贷款授信余额
       ,RATE                      AS 他行贷款利率
from SJXQ_SJ2024082786_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_06
***SJ2024082786_庆元村行随贷通数据_mod.sql
﻿--柳青-庆元存行随贷通客户相关字段
--SJ2024082786
-- 截止2024年07月31日，庆元村行随贷通客户数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_01 AS
select t1.bus_ctr_id                             --业务合同编号
	,t1.cst_id                                   --客户号
	,t1.crd_lmt                                  --授信额度
	,t1.bind_lmt                                 --绑定额度
	,t1.use_lmt                                  --已用额度
	,t1.eft_dt                                   --生效日期
	,t1.mtu_dt                                   --到期日期
	,t1.norm_intr_rat                            --正常利率
	,t1.cmpd_intr_rat                            --复利利率
	,t1.loan_pd                                  --贷款产品
	,t1.trm_mon                                  --贷款期限_月
	,t1.ym_intr_rat_cd                           --年/月利率标识代码
    ,t3.mgr_id	                                 --管户人工号
    ,t3.mgr_nm	                                 --管户人姓名
    ,t3.mgr_org_id	                             --管户机构号
    ,t4.brc_org_nm,t4.org_nm
from edw.dwd_bus_loan_fnc_crd_lmt_inf_dd    t1 --随贷通授信额度信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.bus_ctr_id=t3.ctr_serno
and t3.dt='20240731'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240731'
and t4.brc_org_nm regexp '浙江庆元泰隆村镇'
where t1.dt='20240731'
AND t1.LMT_STS_CD NOT IN ( '1' , '2' ) --'0','正常' ,'1','停用' ,'2','已解约' ,'3','未激活' ,'4','止付' ,'5','未签约'
;
-- 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_02 AS
SElECT *
from(
    SELECT  t1.cst_id
        ,t2.prd_dt
        ,t2.cst_cr_grd_val
        ,ROW_NUMBER() OVER (PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
    FROM (
        select distinct cst_id
        from SJXQ_SJ2024082786_CST_01
    )t1 inner join(
        SELECT  cst_id
            ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
            ,cr_sco_val                                              AS cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20240731'
        UNION
        SELECT  cst_id
            ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
            ,cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20240731'
    )t2 on t1.cst_id=t2.cst_id
)t1 where rn=1
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_03 AS
SELECT  cst_id
       ,report_dt	                 --报告日期
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
union
SELECT  cst_id
       ,report_dt	                --报告日期
       ,oth_bank_busi_org_num	    --他行授信机构数
       ,un_sett_loan_total_amt	    --未结清贷款总额
from edw.dws_cst_ccrc_entp_ind_inf_dd
where dt='20240731'
and report_dsc_rn='1'
;
-- 个人征信客户贷款信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_04 AS
SELECT  t.cst_id
       ,t1.report_id
       ,SUBSTR(t1.report_id,1,8) report_dt
       ,t2.org_code                                               AS 机构代码
       ,t2.business_type                                          AS 业务种类
       ,t2.ctr_amt                                                AS 借款金额或授信金额
       ,t2.issuance_date                                          AS 起始日期
       ,t2.due_date                                               AS 到期日期
       ,t2.repay_periods                                          AS 还款期数
       ,CASE WHEN t2.rate = '-9999' THEN 'null'  ELSE t2.rate END AS 月利率_千分之
       ,t2.repaymethod                                            AS 还款方式
       ,t2.guarantee_mode                                         AS 担保方式
       ,t2.accountstatus                                          AS 账户状态
       ,t2.overdueamount                                          AS 逾期金额
       ,t2.fiveassort                                             AS 五级分类
       ,t2.balance                                                AS 贷款余额
FROM (
    select distinct cst_id
    from SJXQ_SJ2024082786_CST_01
)T left JOIN (
    SELECT  cst_id,report_id
        ,ROW_NUMBER() over(partition by cst_id order by report_id desc )rn
    from EDW.DIM_CST_CCRC_IDV_LOAN_INF_DD -- 个人征信客户贷款信息
    where dt='20240731'
)  T1 ON  T.cst_id = T1.cst_id
and t1.rn=1
inner JOIN EDW.NCIP_CPQ_ACCOUNT_CALCULATE t2
on t1.REPORT_ID=t2.REPORT_ID
and t2.DT <= '20240731'
;
-- 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_05 AS
select t1.cst_id
    ,t2.sdt_loan_mon_avg	--随贷通余额月日均
    ,case when t3.cst_id is not null then '对私' else '对公' end cst_type
    ,t3.age
    ,decode(t3.gdr_cd,'1','男','2','女','未知') gdr_nm
    ,t3.mrg_situ_cd	    --婚姻状况
    ,c2.cd_val_dscr     mrg_situ_nm
    ,t4.cst_chn_nm	--客户姓名|C200
    ,t4.idt_cd	    --行业代码|C5
    ,c1.cd_val_dscr     idt_nm
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024082786_CST_01
)t1 left join adm_pub.adm_csm_cbus_loan_inf_dd	t2 --客户集市-业务信息-客户贷款业务信息表	40
on t1.cst_id=t2.cst_id
and t2.dt='20240731'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t3 --对私客户基础信息
on t1.cst_id=t3.cst_id
and t3.dt='20240731'
left join edw.dws_cst_bas_inf_dd 				t4 --客户基础信息汇总表
on t1.cst_id=t4.cst_id
and t4.dt='20240731'
left join edw.dwd_code_library_dd c1
on t4.idt_cd = c1.cd_val
and c1.dt = '20240731'
left join edw.dwd_code_library_dd c2
on t3.mrg_situ_cd = c2.cd_val
and c2.dt = '20240731'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_06 AS
select t1.bus_ctr_id                             --业务合同编号
	,t1.cst_id                                   --客户号
	,t1.crd_lmt                                  --授信额度
	,t1.bind_lmt                                 --绑定额度
	,t1.use_lmt                                  --已用额度
	,t1.eft_dt                                   --生效日期
	,t1.mtu_dt                                   --到期日期
	,t1.norm_intr_rat                            --正常利率
	,t1.cmpd_intr_rat                            --复利利率
	,t1.loan_pd                                  --贷款产品
	,t1.trm_mon                                  --贷款期限_月
	,t1.ym_intr_rat_cd                           --年/月利率标识代码
    ,t1.mgr_id	                                 --管户人工号
    ,t1.mgr_nm	                                 --管户人姓名
    ,t1.mgr_org_id	                             --管户机构号
    ,t1.brc_org_nm,t1.org_nm
    ,t2.cst_cr_grd_val
    ,t3.oth_bank_loan_org_num        --他行贷款授信机构数
    ,t3.oth_bank_loan_credit_bal     --他行贷款授信余额
    ,t4.月利率_千分之
    ,t5.sdt_loan_mon_avg	--随贷通余额月日均
    ,t5.cst_chn_nm
    ,t5.age
    ,t5.gdr_nm
    ,t5.idt_nm	        --行业代码
    ,t5.mrg_situ_nm	    --婚姻状况
    ,t5.cst_type
from SJXQ_SJ2024082786_CST_01       t1
left join SJXQ_SJ2024082786_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024082786_CST_03  t3
on t1.cst_id=t3.cst_id
left join(
    SELECT cst_id
    from SJXQ_SJ2024082786_CST_04
    where 月利率_千分之 is not null
    GROUP BY cst_id
)  t4 on t1.cst_id=t4.cst_id
left join SJXQ_SJ2024082786_CST_05  t5
on t1.cst_id=t5.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024082786_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082786_CST_07 AS
SELECT  bus_ctr_id                AS 业务合同号
       ,cst_id                    AS 客户号
       ,cst_chn_nm                AS 客户姓名
       ,gdr_nm                    AS 性别
       ,age                       AS 年龄
       ,idt_nm                    AS 行业
       ,mrg_situ_nm               AS 婚姻状况
       ,cst_cr_grd_val            AS 征信分
       ,crd_lmt                   AS 授信额度
       ,bind_lmt                  AS 绑定额度
       ,use_lmt                   AS 已用额度
       ,sdt_loan_mon_avg          AS 随贷通余额月日均
       ,norm_intr_rat             AS 正常利率
       ,cmpd_intr_rat             AS 复利利率
       ,trm_mon                   AS 贷款期限_月
       ,cst_type                  AS 客户类型
       ,concat(mgr_id,' ',mgr_nm) AS 管户人
       ,org_nm                    AS 管户机构
       ,eft_dt                    AS 合同生效日期
       ,mtu_dt                    AS 合同到期日期
       ,oth_bank_loan_org_num     AS 他行贷款授信机构数
       ,oth_bank_loan_credit_bal  AS 他行贷款授信余额
       ,月利率_千分之              AS 他行贷款利率_月利率_千分之
from SJXQ_SJ2024082786_CST_06
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_04 where 机构代码 is not null
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082786_CST_06
;
-- SELECT * from lab_bigdata_dev.SJXQ_SJ2024082786_CST_07
***SJ2024082926_台州分行专利质押业务.sql
/*
台州分行 实际业务结清日期2023年，本息均结清的一般贷款业务（不含贸易融资、承兑等业务），担保方式中包含专利质押
问题：
1. 数据日期取那一天？数据日期不需要
2. 一般贷款业务确认？贷款业务010
-- ,'010','贷款类业务'
-- ,'020','承兑类业务'
-- ,'030','贴现类业务'
-- ,'040','保函类业务'
-- ,'050','贸易融资业务'
-- ,'060','银行卡类业务'
-- ,'070','中间业务类'
-- ,'080','垫款类业务'
-- ,'090','随贷通卡业务'
-- ,'100','金融衍生类业务'
3. 数据出 合同维度 or 借据维度？借据维度
4. 包含地址敏感信息?地址脱敏到区
*/
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082926_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082926_CST_01 AS
SELECT  t1.busi_ctr_id              --业务合同编号|C32
       ,t1.pd_cd                    --产品代码|C4
       ,t1.cst_id                   --客户编号|C20
       ,t1.cst_nm                   --客户名称|C200
       ,t1.apnt_start_dt            --约定开始日期 合同起始日
       ,t1.apnt_mtu_dt              --约定到期日期 合同到期日
       ,t1.ccy_cd                   --币种代码|C3
       ,t1.ctr_amt                  --合同金额|DECIMAL(20,2)
       ,t1.ctr_bal                  --合同余额|DECIMAL(20,2)
       ,t1.hpn_dt                   --发生日期|C8
       ,t1.prcp_pyf_dt              --本金结清日期|C10
       ,t1.end_dt                   --终结日期|C8
       ,t1.main_grnt_mth_cd         --主要担保方式代码|C3
       ,decode(t1.main_grnt_mth_cd,'005','信用','010','保证','020','抵押','040','质押','') main_grnt_mth_nm
       ,t1.oth_grnt_mth_cd          --其他担保方式代码|C3
       ,c2.cd_val_dscr          as oth_grnt_mth_nm
       ,t1.grnt_ptfl_typ_cd         --担保组合类型代码|C32
       ,c3.cd_val_dscr          as grnt_ptfl_typ_nm
       ,t1.stdinr                   --基准利率|DECIMAL(14,8)
       ,t1.ref_mon_intr_rat         --参考月利率|DECIMAL(14,8)
       ,t1.intr_rat                 --利率|DECIMAL(14,8)
       ,t1.intr_rat_flt             --利率浮动|DECIMAL(14,8)
       ,t1.crc_ind                  --循环贷款标志|C1
    ,t3.mgr_id	--管户人工号|C10
    ,t3.mgr_nm	--管户人姓名|C200
    ,t3.mgr_org_id	--管户机构号|C12
    ,T4.BRC_ORG_NM,T4.SBR_ORG_NM,T4.TEM_ORG_NM,T4.ORG_NM
    ,t5.cltr_typ_cd     --质押物类型
    ,c4.cd_val_dscr     cltr_typ_nm
from edw.dim_bus_loan_ctr_inf_dd            T1 --信贷合同信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同`管户`信息
on  t1.busi_ctr_id=t3.ctr_serno
and t3.dt = '20231231'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树 4537 org_id 唯一
on      t3.mgr_org_id = t4.org_id
and     t4.BRC_ORG_NM='台州分行'
and     t4.dt = '20231231'
left JOIN    edw.dws_bus_grnt_itm_inf_dd    T5 --担保物汇总信息
ON      T1.busi_ctr_id = T5.busi_ctr_id
-- AND     T5.cltr_typ_cd IN ( 'D060101' , 'D060102' )
AND     T5.DT = '20231231'
left join edw.dwd_code_library_dd           c2
on  t1.oth_grnt_mth_cd = c2.cd_val
and c2.dt = '20231231'
left join edw.dwd_code_library_dd           c3
on  t1.grnt_ptfl_typ_cd = c3.cd_val
and c3.dt = '20231231'
left join edw.dwd_code_library_dd           c4
on  t5.cltr_typ_cd = c4.cd_val
and c4.dt = '20231231'
where   t1.dt='20231231'
and t1.bus_typ='010'	--业务类型:贷款类业务 一般贷款业务
and t1.prcp_pyf_dt between '20230101' and '20231231'
and t1.end_dt between '20230101' and '20231231'
;
-- ,'010','贷款类业务' ,'020','承兑类业务' ,'030','贴现类业务' ,'040','保函类业务' ,'050','贸易融资业务'
-- ,'060','银行卡类业务' ,'070','中间业务类' ,'080','垫款类业务' ,'090','随贷通卡业务' ,'100','金融衍生类业务'
-- 借据表
DROP   TABLE IF     EXISTS SJXQ_SJ2024082926_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082926_CST_02 AS
select t1.busi_ctr_id
    ,t2.dbil_id                                --借据编号|C50
	,t2.ccy_cd                                   --币种代码|C3
	,t2.act_org_id                               --核算机构编号|C12
	,t2.act_org_nm                               --核算机构名称|C200
	,t2.acs_org_id                               --考核机构编号|C12
	,t2.acs_org_nm                               --考核机构名称|C200
	,t2.cst_mngr_id                              --管护客户经理编号|C32
	,t2.cst_mngr_nm                              --管护客户经理名称|C100
	,t2.five_ctg_cd                              --五级分类代码|C2
    ,c2.cd_val_dscr     as five_ctg_nm
	,t2.dtrb_dt                                  --发放日期|C8
	,t2.apnt_mtu_day                             --约定到期日期|C8
	,t2.end_dt                                   --终结日期|C8
	,t2.exe_intr_rat                             --执行利率|DECIMAL(14,8)
	,t2.ctr_amt                                  --合同金额|DECIMAL(20,2)
	,t2.amt                                      --发放金额|DECIMAL(20,2)
    ,t2.amt * COALESCE(c1.CNY_EXR,1) as dtrb_amt_cny
	,t2.prcp_bal                                 --本金余额|DECIMAL(20,2)
    ,t2.prcp_bal * COALESCE(c1.CNY_EXR,1) as prcp_bal_cny
	,t2.asset_category                           --资产分类|C10
	,t2.ardy_wrt_off_prcp_intr                   --已核销本金利息|Decimal(12,7)
	,t2.exe_mtu_day                              --执行到期日|C8
	,t2.prm_bus_bred_ctg_cd                      --主业务品种分类代码|C3
    ,t3.mon_acm_prcp_bal_acml                    --月累计本金余额积数|DECIMAL(20,2)
	,t3.last_30_days_prcp_bal_acml               --近30天本金余额积数|DECIMAL(20,2)
    ,round((t3.last_30_days_prcp_bal_acml * COALESCE(c1.CNY_EXR,1))/30,2) loan_bal_mon_avg_cny
from SJXQ_SJ2024082926_CST_01           t1
left join edw.dws_bus_loan_dbil_inf_dd  t2            --贷款借据信息汇总
on t1.busi_ctr_id=t2.bus_ctr_id
and t2.dt='20231231'
left join edw.dws_bus_loan_dbil_acm_inf_dd t3 --信贷借据累计汇总信息
on t2.dbil_id=t3.dbil_id
and t3.dt='20231231'
left join edw.DIM_BUS_COM_EXR_INF_DD    c1 -- 汇率信息
on t2.ccy_cd=c1.CCY_CD
and c1.dt='20231231'
LEFT JOIN    edw.dwd_code_library_dd    c2 --码值表
ON      t2.five_ctg_cd = c2.cd_val
AND     c2.DT = '20231231'
;
-- 信贷地址
-- ,'10','注册地址' ,'20','办公地址' ,'30','永久地址' ,'40','经营场所地址' ,'50','户籍地址' ,'60','居住地址' ,'70','其他' ,'80','线上客户维护地址'
DROP   TABLE IF     EXISTS SJXQ_SJ2024082926_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082926_CST_03 AS
SElECT t1.cst_id
    ,t2.addr_reg_city
    ,t3.addr_office_city
    ,t4.addr_operate_city
    ,t5.addr_native_city
    ,t6.addr_home_city
from(
    SElECT distinct customerid as cst_id
    from edw.loan_customer_address                --客户联系地址
    where dt='20231231'
)t1 left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,c1.cd_val_dscr                     as addr_reg_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20231231'
    where t1.dt='20231231' and t1.isnew = '1' -- 最新
    and t1.addtype = '10' -- 注册地址
)t2 on t1.cst_id=t2.cst_id and t2.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,c1.cd_val_dscr                     as addr_office_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20231231'
    where t1.dt='20231231' and t1.isnew = '1' -- 最新
    and t1.addtype = '20' -- 办公地址
)t3 on t1.cst_id=t3.cst_id and t3.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,c1.cd_val_dscr                     as addr_operate_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20231231'
    where t1.dt='20231231' and t1.isnew = '1' -- 最新
    and t1.addtype = '40' -- 经营场所地址
)t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,c1.cd_val_dscr                     as addr_native_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20231231'
    where t1.dt='20231231' and t1.isnew = '1' -- 最新
    and t1.addtype = '50' -- 户籍地址
)t5 on t1.cst_id=t5.cst_id and t5.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS address4 --地址详情
        ,c1.cd_val_dscr                     as addr_home_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20231231'
    where t1.dt='20231231' and t1.isnew = '1' -- 最新
    and t1.addtype = '60' -- 居住地址
)t6 on t1.cst_id=t6.cst_id and t6.rn=1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024082926_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082926_CST_04 AS
SELECT  t1.busi_ctr_id          --业务合同编号
       ,t1.cst_id               --客户编号|C20
       ,t1.cst_nm               --客户名称|C200
       ,t1.apnt_start_dt        --约定开始日期 合同起始日
       ,t1.apnt_mtu_dt          --约定到期日期 合同到期日
       ,t1.ctr_amt              --合同金额
       ,t1.ctr_bal              --合同余额
       ,t1.hpn_dt               --发生日期
       ,t1.prcp_pyf_dt          --本金结清日期
       ,t1.main_grnt_mth_nm     --主要担保方式
       ,t1.oth_grnt_mth_nm      --其他担保方式
       ,t1.grnt_ptfl_typ_nm     --担保组合类型
       ,t1.crc_ind              --循环贷款标志
       ,T1.BRC_ORG_NM
       ,T1.SBR_ORG_NM
       ,T1.TEM_ORG_NM
       ,t1.cltr_typ_nm          --质押物类型
       ,t2.dbil_id              --借据编号|C50
       ,t2.ccy_cd               --币种代码|C3
       ,t2.act_org_id           --核算机构编号|C12
       ,t2.act_org_nm           --核算机构名称|C20
       ,t2.acs_org_id           --考核机构编号|C12
       ,t2.acs_org_nm           --考核机构名称|C200
       ,t2.cst_mngr_id          --管护客户经理编号|C32
       ,t2.cst_mngr_nm          --管护客户经理名称|C100
       ,t2.five_ctg_nm          --五级分类
       ,t2.dtrb_dt              --发放日期
       ,t2.apnt_mtu_day         --约定到期日期
       ,t2.end_dt               --终结日期
       ,t2.exe_intr_rat         --执行利率
       ,t2.amt                  --发放金额
       ,t2.dtrb_amt_cny         --发放金额折人民币
       ,t2.prcp_bal             --本金余额
       ,t2.prcp_bal_cny         --贷款余额折人民币
       ,t2.exe_mtu_day          --执行到期日
       ,t2.loan_bal_mon_avg_cny --贷款月日均折人民币
       ,t3.addr_reg_city        --注册地址
       ,t3.addr_office_city     --办公地址
       ,t3.addr_operate_city    --经营场所地址
       ,t3.addr_native_city     --户籍地址
       ,t3.addr_home_city       --居住地址
from SJXQ_SJ2024082926_CST_01       t1
left join SJXQ_SJ2024082926_CST_02  t2
on t1.busi_ctr_id=t2.busi_ctr_id
left join SJXQ_SJ2024082926_CST_03  t3
on t1.cst_id=t3.cst_id
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024082926_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024082926_CST_05 AS
SELECT  '20231231'           AS 数据日期
       ,cst_id               AS 客户号
       ,cst_nm               AS 客户名称
       ,busi_ctr_id          AS 业务合同编号
       ,dbil_id              AS 借据编号
       ,exe_intr_rat         AS 执行利率
       ,dtrb_dt              AS 发放日期
       ,amt                  AS 发放金额
       ,prcp_pyf_dt          AS 本金结清日期
       ,end_dt               AS 终结日期
       ,exe_mtu_day          AS 执行到期日
       ,apnt_start_dt        AS 合同起始日
       ,apnt_mtu_dt          AS 合同到期日
       ,ccy_cd               AS 币种代码
       ,crc_ind              AS 循环贷款标志
       ,act_org_id           AS 核算机构编号
       ,act_org_nm           AS 核算机构名称
       ,acs_org_id           AS 考核机构编号
       ,acs_org_nm           AS 考核机构名称
       ,TEM_ORG_NM           AS 管护团队名称
       ,SBR_ORG_NM           AS 管护支行名称
       ,cst_mngr_id          AS 管护客户经理编号
       ,cst_mngr_nm          AS 管护客户经理名称
       ,prcp_bal             AS 本金余额
       ,prcp_bal_cny         AS 贷款余额折人民币
       ,loan_bal_mon_avg_cny AS 贷款月日均折人民币
       ,dtrb_amt_cny         AS 发放金额折人民币
       ,apnt_mtu_day         AS 约定到期日期
       ,five_ctg_nm          AS 五级分类
       ,addr_reg_city        AS 注册地址
       ,addr_office_city     AS 办公地址
       ,addr_operate_city    AS 经营场所地址
       ,addr_native_city     AS 户籍地址
       ,addr_home_city       AS 居住地址
       ,cltr_typ_nm          AS 质押物类型
from SJXQ_SJ2024082926_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024082926_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct busi_ctr_id) custs
from SJXQ_SJ2024082926_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024082926_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct dbil_id) custs
from SJXQ_SJ2024082926_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 借据编号) custs
from SJXQ_SJ2024082926_CST_05
***SJ20240902116_温岭横峰支行客户信息.sql
/*
客户号     客户名称     证件类型
1000000078     金运良     居民身份证
客户号     客户名称     证件类型     证件编号
2000012597     台州天达物流有限公司     营业执照     913310*********484
2000026103     温岭市横峰海得利鞋厂     组织机构代码     L29310*3-0
*/
-- 对私
DROP   TABLE IF     EXISTS SJXQ_SJ20240902116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902116_CST_01 AS
SELECT  '' col_1 --序号
       ,'' col_2 --客户号
       ,'' col_3 --客户名称
       ,'' col_4 --证件类型
-- from
-- where pt<>''
;
-- 身份证
DROP   TABLE IF     EXISTS SJXQ_SJ20240902116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902116_CST_02 AS
SELECT  col_1      AS 序号
       ,col_2      AS 客户号
       ,col_3      AS 客户名称
       ,col_4      AS 证件类型
       ,t2.doc_typ_cd	as 证件类型代码
       ,c1.cd_val_dscr  as 证件类型2
       ,t2.doc_nbr      AS 证件号码
from SJXQ_SJ20240902116_CST_01      t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.col_2=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1          --132058
on t2.doc_typ_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
;
-- 对公
DROP   TABLE IF     EXISTS SJXQ_SJ20240902116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902116_CST_03 AS
SELECT  '' col_1 --序号
       ,'' col_2 --客户号
       ,'' col_3 --客户名称
       ,'' col_4 --证件类型
       ,'' col_5 --证件编号
-- from
-- where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240902116_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902116_CST_04 AS
SELECT  col_1      AS 序号
       ,col_2      AS 客户号
       ,col_3      AS 客户名称
       ,col_4      AS 证件类型
       ,t2.doc_typ_cd	as 证件类型代码
       ,c1.cd_val_dscr  as 证件类型2
       ,t2.doc_nbr      AS 证件号码
from SJXQ_SJ20240902116_CST_01      t1
left join edw.dws_cst_bas_inf_dd    t2 --客户基础信息汇总表
on t1.col_2=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd   c1          --132058
on t2.doc_typ_cd = c1.cd_val
and c1.dt='@@{yyyyMMdd}'
;
-- A0500	营业执照
-- A0200	组织机构代码
***SJ20240902136_泰e贷客户信息.sql
-- 截止2024年8月31日，我行泰e贷客户相关信息
-- 1.我行发放泰e贷客户经营地址、户籍地址、居住地址；以及同一风险控制号信息。
-- 2.担保方式为&ldquo;保证&rdquo;客户担保人相关信息。
-- 数据需求字段
-- 1.户籍地居住地经营地同一风险控制号同一风险控制号项下额度；
-- 2.客户号客户名称合同登记流水号担保方式担保人姓名与借款人关系
-- 1. 有值：客户号、客户姓名、合同号。取：户籍地、居住地、经营地、同一风险控制号、同一风险控制号下额度
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_01 AS
SELECT  '' col_1 --客户号
       ,'' col_2 --客户姓名
       ,'' col_3 --合同号
-- from
-- where pt<>''
;
-- 信贷地址
-- ,'10','注册地址' ,'20','办公地址' ,'30','永久地址' ,'40','经营场所地址' ,'50','户籍地址' ,'60','居住地址' ,'70','其他' ,'80','线上客户维护地址'
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_02 AS
SElECT t1.cst_id
    ,t4.addr_operate
    ,t5.addr_native
    ,t6.addr_home
from(
    SElECT distinct customerid as cst_id
    from edw.loan_customer_address                --客户联系地址
    where dt='20240831'
)t1 left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS addr_operate --地址详情
        ,c1.cd_val_dscr                     as addr_operate_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240831'
    where t1.dt='20240831' and t1.isnew = '1' -- 最新
    and t1.addtype = '40' -- 经营场所地址
)t4 on t1.cst_id=t4.cst_id and t4.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS addr_native --地址详情
        ,c1.cd_val_dscr                     as addr_native_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240831'
    where t1.dt='20240831' and t1.isnew = '1' -- 最新
    and t1.addtype = '50' -- 户籍地址
)t5 on t1.cst_id=t5.cst_id and t5.rn=1
left join(
    SELECT  t1.customerid                   AS cst_id
        ,concat(c1.cd_val_dscr,t1.address4) AS addr_home --地址详情
        ,c1.cd_val_dscr                     as addr_home_city
        ,ROW_NUMBER()over(partition by t1.customerid order by t1.updatedate desc,t1.inputdate desc) as rn
    from edw.loan_customer_address    t1            --客户联系地址
    left join edw.dwd_code_library_dd c1
    on  t1.city = c1.cd_val
    and c1.dt = '20240831'
    where t1.dt='20240831' and t1.isnew = '1' -- 最新
    and t1.addtype = '60' -- 居住地址
)t6 on t1.cst_id=t6.cst_id and t6.rn=1
;
-- 同一风险控制号、同一风险控制号下额度
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_03 AS
SElECT t1.col_1 as cst_id
    ,case when nvl(t2.sam_rsk_ctrl_id,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end sam_rsk_ctrl_id_all
    ,count(distinct t3.cst_id) custs
    ,sum(CTR_AMT)   as CTR_AMT	--合同金额DECIMAL(21,2)
from SJXQ_SJ20240902136_CST_01      t1
INNER join edw.dws_cst_bas_inf_dd   t2
on t1.col_1=t2.cst_id
and t2.dt='20240831'
INNER JOIN edw.dws_cst_bas_inf_dd   t3 --客户基础信息汇总表
ON  case when nvl(t2.sam_rsk_ctrl_id,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end
= case when nvl(t3.sam_rsk_ctrl_id,'')='' then t3.cst_id else t3.sam_rsk_ctrl_id end
AND t3.dt = '20240831'
INNER join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t4
on t3.cst_id=t4.cst_id
and t4.dt='20240831'
group by t1.col_1,sam_rsk_ctrl_id_all
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_04 AS
SELECT  t1.col_1        AS 客户号
       ,t1.col_2        AS 客户姓名
       ,t1.col_3        AS 合同号
       ,t2.addr_operate AS 经营地
       ,t2.addr_native  AS 户籍地
       ,t2.addr_home    AS 居住地
       ,t3.sam_rsk_ctrl_id_all as 同一风险控制号
       ,t3.CTR_AMT      as  同一风险控制号下额度
from SJXQ_SJ20240902136_CST_01      t1
left join SJXQ_SJ20240902136_CST_02 t2
on t1.col_1=t2.cst_id
left join SJXQ_SJ20240902136_CST_03 t3
on t1.col_1=t3.cst_id
;
-- 名单2. 有值：客户号、客户姓名、合同号，担保方式（保证）。取：担保人姓名、与借款人关系
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_10 AS
SELECT  '' col_1 --客户号
       ,'' col_2 --客户姓名
       ,'' col_3 --合同号
       ,'' col_4   --担保方式
-- from
-- where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_11 AS
SElECT t1.col_3
    ,t2.GRNT_CTR_NO	    --担保合同编号
    ,nvl(t4.GTOR_NO,t6.OBG_ID) as GTOR_NO	                                    --保证人编号|C20
    ,nvl(t4.GTOR_NM,t6.OBG_NM) as GTOR_NM	                                    --保证人名称|C200
    ,t4.WITH_BRWR_REL	                            --与借款人关系
from SJXQ_SJ20240902136_CST_10              t1
left join(
    SElECT distinct CTR_SERNO,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '@@{yyyyMMdd}'
) t2 on t1.col_3 = t2.CTR_SERNO
left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t4 --担保合同保证人信息
on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
and t4.dt='@@{yyyyMMdd}'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='@@{yyyyMMdd}'
) t6 on t2.GRNT_CTR_NO=t6.GRNT_CTR_NO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240902136_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240902136_CST_12 AS
SELECT  t1.col_1                          AS 客户号
       ,t1.col_2                          AS 客户姓名
       ,t1.col_3                          AS 合同号
       ,t1.col_4                          AS 担保方式
       ,concat(t2.GTOR_NO,' ',t2.GTOR_NM) AS 保证人
       ,t2.WITH_BRWR_REL                  AS 与借款人关系
from SJXQ_SJ20240902136_CST_10      t1
left join SJXQ_SJ20240902136_CST_11 t2
on t1.col_3=t2.col_3
;
SElECT '01' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ20240902136_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240902136_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240902136_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ20240902136_CST_04
union all
SElECT '10' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ20240902136_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ20240902136_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ20240902136_CST_12
***SJ2024090276_法院案件客户信息.sql
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024090276_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090276_CST_01 AS
SELECT  '' col_1 --序号
       ,'' col_2 --合同流水号
       ,'' col_3 --借款人
-- from
-- where pt<>''
;
-- 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024090276_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090276_CST_02 AS
SElECT t1.col_1
    ,t2.cst_id
    ,t3.doc_nbr	        --主证件号码|C60
    ,t3.doc_typ_cd	    --主证件类型代码|C5
    ,t3.reg_adr	        --户籍地址|C256
    ,t3.cmn_adr	        --通讯地址|C256
    ,t3.wrk_adr	        --工作单位地址|C256
from SJXQ_SJ2024090276_CST_01               t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t2 --合同基础信息
on  t1.col_2=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
on  t2.cst_id = t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024090276_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090276_CST_03 AS
SElECT t1.col_1
    ,t2.ctr_serno
    ,t2.GRNT_CTR_NO	    --担保合同编号
    ,nvl(t4.GTOR_NO,t6.OBG_ID) as GTOR_NO	                                    --保证人编号|C20
    ,nvl(t4.GTOR_NM,t6.OBG_NM) as GTOR_NM	                                    --保证人名称|C200
    ,t4.WITH_BRWR_REL	                            --与借款人关系
    ,t4.GRNT_AMT
    ,t7.doc_nbr	        --主证件号码|C60
    ,t7.doc_typ_cd	    --主证件类型代码|C5
    ,t7.reg_adr	        --户籍地址|C256
    ,t7.cmn_adr	        --通讯地址|C256
    ,t7.wrk_adr	        --工作单位地址|C256
    ,row_number() over(partition by t1.col_1,t1.col_2 ORDER by t4.GRNT_AMT desc) rn
from SJXQ_SJ2024090276_CST_01              t1
left join(
    SElECT distinct CTR_SERNO,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '@@{yyyyMMdd}'
) t2 on t1.col_2 = t2.CTR_SERNO
left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t4 --担保合同保证人信息
on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
and t4.dt='@@{yyyyMMdd}'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='@@{yyyyMMdd}'
) t6 on t2.GRNT_CTR_NO=t6.GRNT_CTR_NO
left join edw.dws_cst_idv_bas_inf_dd	t7 --个人客户基本信息汇总表
on nvl(t4.GTOR_NO,t6.OBG_ID) = t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090276_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090276_CST_04 AS
SELECT  t1.col_1   AS 序号
       ,t1.col_2   AS 合同流水号
       ,t1.col_3   AS 借款人
       ,t6.doc_nbr AS 主证件号码
       ,t6.wrk_adr AS 工作单位地址
       ,t6.reg_adr AS 户籍地址
       ,t2.GTOR_NM AS 担保人1
       ,t2.doc_nbr AS 担保人1主证件号码
       ,t2.wrk_adr AS 担保人1工作单位地址
       ,t2.reg_adr AS 担保人1户籍地址
       ,t3.GTOR_NM AS 担保人2
       ,t3.doc_nbr AS 担保人2主证件号码
       ,t3.wrk_adr AS 担保人2工作单位地址
       ,t3.reg_adr AS 担保人2户籍地址
       ,t4.GTOR_NM AS 担保人3
       ,t4.doc_nbr AS 担保人3主证件号码
       ,t4.wrk_adr AS 担保人3工作单位地址
       ,t4.reg_adr AS 担保人3户籍地址
       ,t5.GTOR_NM AS 担保人4
       ,t5.doc_nbr AS 担保人4主证件号码
       ,t5.wrk_adr AS 担保人4工作单位地址
       ,t5.reg_adr AS 担保人4户籍地址
from SJXQ_SJ2024090276_CST_01       t1
left join SJXQ_SJ2024090276_CST_03  t2
on t1.col_1=t2.col_1
and t2.rn=1
left join SJXQ_SJ2024090276_CST_03  t3
on t1.col_1=t3.col_1
and t3.rn=2
left join SJXQ_SJ2024090276_CST_03  t4
on t1.col_1=t4.col_1
and t4.rn=3
left join SJXQ_SJ2024090276_CST_03  t5
on t1.col_1=t5.col_1
and t5.rn=4
left join SJXQ_SJ2024090276_CST_02  t6
on t1.col_1=t6.col_1
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024090276_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024090276_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024090276_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024090276_CST_04
***SJ2024090286_大冶村行第四期举一反三.sql
-- 数据需要2023年1月1日到2024年7月31日期间的
DROP   TABLE IF     EXISTS SJXQ_SJ2024090286_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090286_CST_01 AS
SELECT  T.SRL_NBR               --流水号
       ,T.CST_ID                --客户号
       ,T.CST_NM                --客户名称
       ,T.LOAN_PST_CHK_TYP      --贷后检查类型 01 精准贷后 02 常规贷后 03 自主贷后(手工) 05 自主贷后(系统) 06 精准贷后（卡） 07 年审检查（泰E贷）
       ,T2.CD_VAL_DSCR                         AS LOAN_PST_CHK_TYP_NM   --贷后检查类型
       ,T.LOAN_PST_CHK_MTH      --贷后检查方式
       ,T3.CD_VAL_DSCR                         AS LOAN_PST_CHK_MTH_NM
       ,T.RSK_TRG_TYP_CD        --风险触发类型代码：CZ：处置, YJ：预警, 提示：TS
       ,T4.CD_VAL_DSCR                         AS RSK_TRG_TYP_NM --风险触发类型
       ,t.CST_RSK_GRD_OLD_CD	--客户风险等级代码_原
       ,t8.CD_VAL_DSCR                         AS CST_RSK_GRD_OLD_nm    --客户风险等级代码_原
       ,T.CST_RSK_GRD_NEW_CD    --客户风险等级代码：1低, 2中低, 3中, 4中高, 5高, 6:黑名单
       ,T5.CD_VAL_DSCR                         AS CST_RSK_GRD_NEW_NM    --客户风险等级
       ,REPLACE(T.TSK_MAK_DT,'/','')           AS TSK_MAK_DT            --任务生成日期
       ,REPLACE(T.CHK_CPL_DT,'/','')           AS CHK_CPL_DT            --检查完成日期
       ,REPLACE(T.ACTL_CPL_TM,'/','')          AS ACTL_CPL_TM           --实际完成时间
       ,T.CST_RSK_DEG_ID        --客户风险程度判断
       ,T.LOAN_PST_MNG_OPNN     --贷后管理意见
       ,REPLACE(T.EXE_DT,'/','')               AS EXE_DT                --执行日期
       ,REPLACE(T.LOAN_PST_CHK_VLD_PRD,'/','') AS LOAN_PST_CHK_VLD_PRD  --贷后检查有效期
       ,T.CHK_ORG                    --检查机构
       ,T7.ORG_NM                    --检查机构名称
       ,T7.SBR_ORG_ID                --支行层级机构编号
       ,T7.SBR_ORG_NM                --支行层级机构名称
       ,T.CHK                        --管户人工号_检查人
       ,T1.EMPE_NM                   --管户人名称
       ,T.TSK_STS                    --任务状态
       ,T6.CD_VAL_DSCR AS TSK_STS_NM --任务状态
       ,T.BRK_RULE_SRC               --触犯规则来源
       ,T.BRK_RSN                    --触犯原因
       ,T.VIO_RSN_ANA                --触犯原因分析
    ,CASE WHEN T.RSK_TRG_TYP_CD IN ( 'CZ' ,'CZ1' ) AND REPLACE(T.CHK_CPL_DT,'/','') = '18991231' AND DATEDIFF(TO_DATE(T.DT,'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') > 10 THEN '超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'CZ' ,'CZ1' ) AND REPLACE(T.CHK_CPL_DT,'/','') = '18991231' AND DATEDIFF(TO_DATE(T.DT,'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') <= 10 THEN '未超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'CZ' ,'CZ1' ) AND REPLACE(T.CHK_CPL_DT,'/','') <> '18991231' AND DATEDIFF(TO_DATE(REPLACE(T.CHK_CPL_DT,'/',''),'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') > 10 THEN '超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'CZ' ,'CZ1' ) AND REPLACE(T.CHK_CPL_DT,'/','') <> '18991231' AND DATEDIFF(TO_DATE(REPLACE(T.CHK_CPL_DT,'/',''),'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') <= 10 THEN '未超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'YJ' ) AND REPLACE(T.CHK_CPL_DT,'/','') = '18991231' AND DATEDIFF(TO_DATE(T.DT,'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') > 15 THEN '超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'YJ' ) AND REPLACE(T.CHK_CPL_DT,'/','') = '18991231' AND DATEDIFF(TO_DATE(T.DT,'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') <= 15 THEN '未超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'YJ' ) AND REPLACE(T.CHK_CPL_DT,'/','') <> '18991231' AND DATEDIFF(TO_DATE(REPLACE(T.CHK_CPL_DT,'/',''),'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') > 15 THEN '超期'
            WHEN T.RSK_TRG_TYP_CD IN ( 'YJ' ) AND REPLACE(T.CHK_CPL_DT,'/','') <> '18991231' AND DATEDIFF(TO_DATE(REPLACE(T.CHK_CPL_DT,'/',''),'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') <= 15 THEN '未超期'  ELSE '其他' END AS IS_CHAOQI --是否超期
    ,DATEDIFF(TO_DATE(REPLACE(T.CHK_CPL_DT,'/',''),'yyyyMMdd'),TO_DATE(REPLACE(T.TSK_MAK_DT,'/',''),'yyyyMMdd'),'DD') AS DIFF_DAYS   --超期天数
FROM    EDW.DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD T
LEFT JOIN    EDW.DWS_HR_EMPE_INF_DD T1
ON      T.CHK = T1.EMPE_ID
AND     T1.DT = '20240731'
LEFT JOIN    EDW.DWD_CODE_LIBRARY T2
ON      T.LOAN_PST_CHK_TYP = T2.CD_VAL
AND     T2.TBL_NM = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     T2.FLD_NM = 'LOAN_PST_CHK_TYP'
LEFT JOIN    EDW.DWD_CODE_LIBRARY T3
ON      T.LOAN_PST_CHK_MTH = T3.CD_VAL
AND     T3.TBL_NM = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     T3.FLD_NM = 'LOAN_PST_CHK_MTH'
LEFT JOIN    EDW.DWD_CODE_LIBRARY T4
ON      T.RSK_TRG_TYP_CD = T4.CD_VAL
AND     T4.TBL_NM = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     T4.FLD_NM = 'RSK_TRG_TYP_CD'
LEFT JOIN    EDW.DWD_CODE_LIBRARY T5
ON      T.CST_RSK_GRD_NEW_CD = T5.CD_VAL
AND     T5.TBL_NM = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     T5.FLD_NM = 'CST_RSK_GRD_NEW_CD'
LEFT JOIN    EDW.DWD_CODE_LIBRARY T6
ON      T.TSK_STS = T6.CD_VAL
AND     T6.TBL_NM = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     T6.FLD_NM = 'TSK_STS'
LEFT JOIN    EDW.DIM_HR_ORG_MNG_ORG_TREE_DD T7
ON      T.CHK_ORG = T7.ORG_ID
AND     T7.DT = '20240731'
LEFT JOIN    EDW.DWD_CODE_LIBRARY T8
ON      T.CST_RSK_GRD_OLD_CD = T8.CD_VAL
AND     T8.TBL_NM = 'DWD_BUS_LOAN_TGT_LOAN_POST_RSL_INF_DD'
AND     T8.FLD_NM = 'CST_RSK_GRD_OLD_CD'
WHERE   T.DT = '20240719'
-- AND     T.LOAN_PST_CHK_TYP NOT IN ( '02' ) --贷后检查类型
AND     SUBSTR(T.CHK_ORG, 1, 4) = '4261' --检查机构 湖北大冶泰隆村镇
AND     REPLACE(T.TSK_MAK_DT, '/', '') >= '20230101' --可修改
AND     REPLACE(T.TSK_MAK_DT, '/', '') <= '20240731' --可修改
-- AND     T.RSK_TRG_TYP_CD IN ( 'CZ' , 'CZ1' , 'YJ' )  --只保留了处置类和预警类
--假设取数日期为20240719，取的是任务发生日期在20230101-20240731的数据
;
-- 输出结果 老表
DROP   TABLE IF     EXISTS SJXQ_SJ2024090286_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090286_CST_02 AS
SELECT  LOAN_PST_CHK_MTH_NM  AS 贷后检查方式
       ,LOAN_PST_CHK_TYP_NM  AS 贷后检查类型
       ,CST_ID               AS 客户号
       ,CST_NM               AS 客户名称
       ,RSK_TRG_TYP_NM       AS 风险触发类型
       ,''                   AS 模型风险等级
       ,CST_RSK_GRD_OLD_nm   AS 客户风险等级_原
       ,CST_RSK_GRD_NEW_NM   AS 客户风险等级
       ,TSK_MAK_DT           AS 任务生成日期
       ,CHK_CPL_DT           AS 检查完成日期
       ,ACTL_CPL_TM          AS 实际完成时间
       ,CST_RSK_DEG_ID       AS 客户风险程度判断
       ,datediff(to_date(ACTL_CPL_TM,'yyyyMMdd'),to_date(TSK_MAK_DT,'yyyyMMdd'),'dd') AS 完成天数 --实际完成时间 - 任务生成日期?
       ,LOAN_PST_CHK_VLD_PRD AS 贷后检查有效期
       ,EXE_DT               AS 执行日期
       ,LOAN_PST_MNG_OPNN    AS 贷后管理意见
       ,VIO_RSN_ANA          AS 触犯原因分析
       ,CHK_ORG              AS 检查机构
       ,ORG_NM               AS 检查机构名称
       ,SBR_ORG_ID           AS 支行层级机构编号
       ,SBR_ORG_NM           AS 支行层级机构名称
       ,CHK                  AS 管户人工号_检查人
       ,EMPE_NM              AS 管户人名称
       ,TSK_STS_NM           AS 任务状态
       ,BRK_RSN              AS 触犯原因
       ,IS_CHAOQI            AS 是否超期
       ,DIFF_DAYS            AS 超期天数
FROM SJXQ_SJ2024090286_CST_01
;
-- 新信贷 精准贷后结果信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2024090286_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090286_CST_03 AS
SELECT t1.TSK_SERNO                                --任务流水号|C32
	,t1.BTCH_SERNO                               --批次流水号|C32
	,t1.PST_LOAN_CHK_TSK_SRC_CD                  --贷后检查任务来源代码|C2
    ,c2.cd_val_dscr     as PST_LOAN_CHK_TSK_SRC_nm --贷后检查任务来源
	,t1.PST_LOAN_CHK_TSK_TYP_CD                  --贷后检查任务类型代码|C2
	,t1.TSK_GEN_DT                               --任务生成日期|C8
	,t1.FDBK_STOP_DT                             --反馈截止日期|C8
	,t1.CST_RSK_DGR_CD                           --客户风险程度代码|C2
    ,c4.cd_val_dscr     as CST_RSK_DGR_nm --客户风险程度
	,t1.ACTL_FDBK_DT                             --实际反馈日期|C8
    ,t2.SVY_RCD_SERNO                            --调查记录流水号|C32 EDW.DWD_BUS_LOAN_CST_SVY_RCD_DD          --客户调查记录信息
    ,t2.SVY_MOD_CD                               --调查方式代码|C2
    ,c1.cd_val_dscr     as SVY_MOD_nm   --调查方式
    ,t2.SVY_DT                                   --调查日期|C8
	,t3.CST_ID                                   --客户号|C20
	,t3.CST_NM                                   --客户名称|C200
	,t3.CST_TYP_CD                               --客户类型代码|C4
	,t3.ORI_RSK_LYR_CD                           --原风险分层代码|C1
    ,c3.cd_val_dscr         as  ORI_RSK_LYR_nm
	,t3.PST_LOAN_CHK_BTCH_DEAL_DT                --贷后检查批次处理日期|C8
	,t3.APRV_STS_CD                              --审批状态代码|C2
	,t3.PST_LOAN_CHK_BTCH_TSK_STS_CD             --贷后检查批次任务状态代码|C1
	,t3.CHK_PSN_ID                               --检查人工号|C10
    ,t4.EMPE_NM         as CHK_PSN_nm            --检查人
	,t3.CHK_PSN_BEL_ORG_NO                       --检查人所属机构编号|C12
    ,t5.org_nm
    ,t5.SBR_ORG_ID
    ,t5.sbr_org_nm
	,t3.CHK_CPL_DT                               --检查完成日期|C8
	,t3.REPLY_OPNN_EXEC_SITU                     --批复意见执行情况|C4000
	,t3.EXST_CMPN_BSN_OPT_IND                    --存在营销商机标志|C1
	,t3.CST_RSK_STRTG                            --客户风险策略|C4000
	,t3.CST_LVL_PST_LOAN_MNG_PLN_CD              --客户级贷后管理方案代码|C2
    ,c6.cd_val_dscr     as CST_LVL_PST_LOAN_MNG_PLN_nm --客户级贷后管理方案
	,t3.SVY_RSK_LYR_CD                           --调查后风险分层代码|C1
    ,c5.cd_val_dscr         as SVY_RSK_LYR_nm
	,t3.PST_LOAN_PRMPT_FRQ_CD                    --贷后提示频率代码|C1
FROM EDW.DWD_BUS_LOAN_PSP_CHK_TSK_INF_DD        t1 --贷后检查任务信息
left join EDW.DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD   t2 --贷后检查批次与调查记录关联关系
on t1.BTCH_SERNO = t2.BTCH_SERNO
and t2.dt='20240731'
LEFT JOIN    EDW.dwd_code_library_dd            c1
ON      T2.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt='20240731'
LEFT JOIN    EDW.dwd_code_library_dd            c2
ON      T1.PST_LOAN_CHK_TSK_SRC_CD = c2.CD_VAL
AND     c2.TBL_NM = 'DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD'
AND     c2.FLD_NM = 'PST_LOAN_CHK_TSK_SRC_CD'
and     c2.dt='20240731'
left join EDW.DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD  t3    --贷后检查批次信息表
on t1.BTCH_SERNO = t3.BTCH_SERNO
and t3.dt='20240731'
LEFT JOIN    EDW.dwd_code_library_dd            c3
ON      T3.ORI_RSK_LYR_CD = c3.CD_VAL
AND     c3.TBL_NM = 'DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD'
AND     c3.FLD_NM = 'ORI_RSK_LYR_CD'
and     c3.dt='20240731'
LEFT JOIN    EDW.dwd_code_library_dd            c4
ON      T1.CST_RSK_DGR_CD = c4.CD_VAL
AND     c4.TBL_NM = 'DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD'
AND     c4.FLD_NM = 'CST_RSK_DGR_CD'
and     c4.dt='20240731'
LEFT JOIN    EDW.dwd_code_library_dd            c5
ON      T3.SVY_RSK_LYR_CD = c5.CD_VAL
AND     c5.TBL_NM = 'DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD'
AND     c5.FLD_NM = 'SVY_RSK_LYR_CD'
and     c5.dt='20240731'
LEFT JOIN    EDW.dwd_code_library_dd            c6
ON      T3.CST_LVL_PST_LOAN_MNG_PLN_CD = c6.CD_VAL
AND     c6.TBL_NM = 'DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD'
AND     c6.FLD_NM = 'CST_LVL_PST_LOAN_MNG_PLN_CD'
and     c6.dt='20240731'
LEFT JOIN    EDW.DWS_HR_EMPE_INF_DD             T4
ON      T3.CHK_PSN_ID = T4.EMPE_ID
AND     T4.DT = '20240731'
LEFT JOIN EDW.DIM_HR_ORG_MNG_ORG_TREE_DD        T5
ON      T3.CHK_PSN_BEL_ORG_NO = T5.ORG_ID
AND     T5.DT = '20240731'
WHERE t1.DT='20240731'
AND     SUBSTR(t3.CHK_PSN_BEL_ORG_NO, 1, 4) = '4261' --检查机构 湖北大冶泰隆村镇
AND     REPLACE(t1.TSK_GEN_DT, '/', '') >= '20230101' --可修改
AND     REPLACE(t1.TSK_GEN_DT, '/', '') <= '20240731' --可修改
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090286_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090286_CST_04 AS
SELECT  TSK_SERNO                   AS 任务流水号
       ,BTCH_SERNO                  AS 批次流水号
       ,SVY_MOD_nm                  AS 调查方式_贷后检查方式
       ,PST_LOAN_CHK_TSK_SRC_nm     AS 贷后检查任务来源_贷后检查类型
       ,CST_ID                      AS 客户号
       ,CST_NM                      AS 客户名称
       ,''                          AS 风险触发类型
       ,''                          AS 模型风险等级
       ,ORI_RSK_LYR_nm              AS 原风险分层_客户风险等级_原
       ,SVY_RSK_LYR_nm              AS 调查后风险分层_客户风险等级
       ,TSK_GEN_DT                  AS 任务生成日期
       ,CHK_CPL_DT                  AS 检查完成日期
       ,ACTL_FDBK_DT                AS 实际反馈日期_实际完成时间
       ,CST_RSK_DGR_nm              AS 客户风险程度_判断
       ,datediff(to_date(ACTL_FDBK_DT,'yyyyMMdd'),to_date(TSK_GEN_DT,'yyyyMMdd'),'dd') AS 完成天数 --实际完成时间 - 任务生成日期?
       ,FDBK_STOP_DT                AS 反馈截止日期_贷后检查有效期
       ,''                          AS 执行日期
       ,CST_LVL_PST_LOAN_MNG_PLN_nm AS 客户级贷后管理方案_贷后管理意见
       ,''                          AS 触犯原因分析
       ,CHK_PSN_BEL_ORG_NO          AS 检查人所属机构编号_检查机构
       ,ORG_NM                      AS 检查机构名称
       ,SBR_ORG_ID                  AS 支行层级机构编号
       ,SBR_ORG_NM                  AS 支行层级机构名称
       ,CHK_PSN_ID                  AS 检查人工号
       ,CHK_PSN_nm                  AS 检查人名称
       ,''                          AS 任务状态
       ,''                          AS 触犯原因
       ,''                          AS 是否超期
       ,''                          AS 超期天数
from SJXQ_SJ2024090286_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024090286_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024090286_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024090286_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024090286_CST_04
;
-- 主键是否唯一
-- tsk_serno	string	任务流水号|c32
-- btch_serno	string	批次流水号|c32
SElECT BTCH_SERNO,count(1) cnt
FROM EDW.DWD_BUS_LOAN_PSP_CHK_TSK_INF_DD        t1 --贷后检查任务信息
where dt='20240731'
group by BTCH_SERNO
order by cnt desc
;
-- btch_serno	string	批次流水号|c32
-- svy_rcd_serno	string	调查记录流水号|c32
SElECT BTCH_SERNO,count(1) cnt
FROM EDW.DWD_BUS_LOAN_PSP_CHK_REL_SVY_DD   t2 --贷后检查批次与调查记录关联关系
where dt='20240731'
group by BTCH_SERNO
order by cnt desc
;
SElECT BTCH_SERNO,count(1) cnt
FROM EDW.DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD  t3    --贷后检查批次信息表
where dt='20240731'
group by BTCH_SERNO
order by cnt desc
;
***SJ20240904137_杭州分行预评估结果.sql
/*
col_1 as 用信申请流水号
,col_2 as 合同登记流水号
,col_3 as 合同编号
,col_4 as 客户号
,col_5 as 客户名称
,col_6 as 产品名称
,col_7 as 合同金额
,col_8 as 合同余额
,col_9 as 担保方式
,col_10 as 管户机构号
,col_11 as 管户机构名称
,col_12 as 管户人工号
,col_13 as 管户人名称
,col_14 as 经办人名称
,col_15 as 经办人机构
,col_16 as 经办人机构名称
,col_17 as 合同敞口金额
,col_18 as 抵质押物类型
1	UCAN2024080600006346	HTBH2024080600004876	否	3302003052408060081964876	1723227482	何继堂	2024-08-06	2027-07-31
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --用信申请流水号
       ,col_3 --合同流水号
       ,col_4 --是否框架下子合同
       ,col_5 --合同编号
       ,col_6 --客户号
       ,col_7 --客户名称
       ,replace(col_8,'-','') as col_8 --合同起始日期
       ,col_9 --合同到期日期
-- from
-- where pt<>''
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_02 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '@@{yyyyMMdd}'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '@@{yyyyMMdd}'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '@@{yyyyMMdd}'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 合同起始日期 前中征分 最新征信分
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_03 AS
SElECT *
from (
    SELECT  t1.col_1 seq,t1.col_6 cst_id,t1.col_8 ctr_bgn_dt
        ,t2.prd_dt
        ,t2.cst_cr_grd_val
        ,ROW_NUMBER() OVER (PARTITION BY t1.col_1 ORDER BY t2.prd_dt DESC) AS rn
    FROM SJXQ_SJ20240904137_CST_01 t1
    inner join(
        SELECT  cst_id
            ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
            ,cr_sco_val                                              AS cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20240731'
        UNION
        SELECT  cst_id
            ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
            ,cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20240731'
    )t2 on t1.col_6=t2.cst_id
    where t2.prd_dt<=t1.col_8
)t where rn=1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_04 AS
SELECT  t1.col_1 --序号
       ,t1.col_2 --用信申请流水号
       ,t1.col_3 --合同流水号
       ,t1.col_4 --是否框架下子合同
       ,t1.col_5 --合同编号
       ,t1.col_6 --客户号
       ,t1.col_7 --客户名称
       ,t1.col_8 --合同起始日期
       ,t1.col_9 --合同到期日期
       ,t2.rul_set_rslt_nm
       ,t3.prd_dt
       ,t3.cst_cr_grd_val
       ,t4.lgp_cst_id                               --对公客户法人客户号
       ,t4.lgp_nm                                   --对公客户法人客户名称
       ,t5.rul_set_rslt_nm  as rul_set_rslt_nm_lgp
from SJXQ_SJ20240904137_CST_01      t1
left join SJXQ_SJ20240904137_CST_02 t2
on t1.col_6 = t2.cst_id
left join SJXQ_SJ20240904137_CST_03 t3
on t1.col_1 = t3.seq
left join edw.dim_cst_entp_lgp_inf_dd   t4           --对公客户法人信息表
on t1.col_6 = t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20240904137_CST_02     t5
on t4.lgp_cst_id = t5.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_05 AS
SELECT  col_1               AS 序号
       ,col_2               AS 用信申请流水号
       ,col_3               AS 合同流水号
       ,col_4               AS 是否框架下子合同
       ,col_5               AS 合同编号
       ,col_6               AS 客户号
       ,col_7               AS 客户名称
       ,col_8               AS 合同起始日期
       ,col_9               AS 合同到期日期
       ,rul_set_rslt_nm     AS 合同引入的借款人预评估结果
       ,prd_dt              AS 最近中征分日期
       ,cst_cr_grd_val      AS 合同经办时最近中征分
       ,lgp_cst_id          AS 对公客户法人客户号
       ,lgp_nm              AS 对公客户法人客户名称
       ,rul_set_rslt_nm_lgp AS 合同引入的法人预评估结果
from SJXQ_SJ20240904137_CST_04
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ20240904137_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240904137_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct seq) custs
from SJXQ_SJ20240904137_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ20240904137_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20240904137_CST_05
;
***SJ20240904151_绍兴分行精准贷后数据.sql
--何灵杰-绍兴分行额度压降
--SJ2024062826
--附件清单内绍兴分行客户存在的自主循环类业务如融e贷、泰e贷、随贷通业务合同流水号、授信额度、原绑定/启用额度、调整后绑定/启用额度、调整日期
--合同流水号	授信额度	原绑定/启用额度	调整后绑定/启用额度	调整日期  精准贷后反馈意见 反馈是否降额
-- 绍兴分行 6-8月 精准贷后反馈降额客户清单
-- 由于降额是模糊匹配，增加 是否降额字段
-- 精准贷后  ---- 取最近一次
DROP   TABLE IF     EXISTS SJXQ_SJ20240904151_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904151_CST_01 AS
SELECT  a.tsk_serno                 --任务流水号
       ,a.btch_serno                --批次流水号
       ,a.pst_loan_chk_tsk_src_cd   --贷后检查任务来源代码
       ,d.cd_val_dscr               as pst_loan_chk_tsk_src_nm --贷后检查任务来源 --- 1
       ,a.pst_loan_chk_tsk_typ_cd   --贷后检查任务类型代码
       ,c.cd_val_dscr               as pst_loan_chk_tsk_typ_nm --精准贷后任务类型 ---- 1
       ,a.tsk_gen_dt                --任务生成日期
       ,a.wthr_pass_mid_grd_ind     --过中台标志
       ,b.cst_id                    --客户号
       ,b.cst_rsk_dgr_cd            --客户风险程度
       ,b.reply_opnn_exec_situ	    --批复意见执行情况|c4000
       ,b.chk_psn_id	            --检查人工号|c10
       ,b.chk_psn_bel_org_no	    --检查人所属机构编号|c12
      ,row_number()over(partition by b.cst_id order by a.tsk_gen_dt desc) rn
from   edw.dwd_bus_loan_psp_chk_tsk_inf_dd      a
left join edw.dwd_bus_loan_psp_chk_btch_inf_dd  b --贷后检查批次信息
on a.btch_serno = b.btch_serno
and b.dt = a.dt
left join edw.dwd_code_library_dd               c
on a.pst_loan_chk_tsk_typ_cd = c.cd_val
and c.dt = '@@{yyyyMMdd}'   ---- 码值表取最新分区（新信贷的码值0719后才有）
left join edw.dwd_code_library_dd               d
on a.pst_loan_chk_tsk_src_cd = d.cd_val
and d.dt = '@@{yyyyMMdd}'    ---- 码值表取最新分区（新信贷的码值0719后才有）
inner join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树
on  b.chk_psn_bel_org_no = t4.org_id
and t4.dt = '20240831'
and t4.brc_org_nm regexp '绍兴分行'     --精准贷后检查人为绍兴分行
where  a.dt ='20240831'
and    a.pst_loan_chk_tsk_src_cd = '01'   ----精准贷后
and    a.tsk_gen_dt>='20240601'
;
--随贷通绑定额度调整情况
DROP   TABLE IF     EXISTS SJXQ_SJ20240904151_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904151_CST_02 AS
SELECT  t1.cst_id
       ,t1.bus_ctr_id             --业务合同编号
       ,t2.crd_lmt                --授信额度
       ,t1.bind_lmt               --绑定额度
       ,t2.bind_lmt               AS bind_lmt_new
       ,t1.bind_lmt - t2.bind_lmt AS cz
       ,t1.dt
       ,t1.lmt_sts_cd
       ,t1.mtu_dt
       ,ROW_NUMBER() over (partition by t1.bus_ctr_id order by t1.dt desc ) as rn
FROM edw.dwd_bus_loan_fnc_crd_lmt_inf_dd        t1
inner JOIN edw.dwd_bus_loan_fnc_crd_lmt_inf_dd  t2
ON      t1.bus_ctr_id = t2.bus_ctr_id
AND     t2.dt = '20240831'
and t1.bind_lmt - t2.bind_lmt > 0   --降额
and t2.use_lmt>0                    --当前有余额
inner join(
    SELECT  distinct cst_id
    FROM    SJXQ_SJ20240904151_CST_01
)t3 on t1.cst_id=t3.cst_id
WHERE t1.dt >= '20240101'
AND   t1.lmt_sts_cd = '0'       --正常
AND   t1.mtu_dt > '20240831'    --未到期
ORDER BY t1.cst_id ,t1.bus_ctr_id, t1.dt DESC
;
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ20240904151_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904151_CST_03 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.bsn_mark_cd	    --业务标识代码|c32
    ,c1.cd_val_dscr     as bsn_mark_nm
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm
    ,decode(t1.RVLG_TYP_CD,'0','非循环','1', '自助循环（融e贷）','2', '半自助','') as RVLG_TYP_nm2
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240831'
and t2.PD_NM regexp '融e贷|泰e贷|随贷通'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240831'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240831'
and t4.brc_org_nm   regexp '绍兴分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240831'
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = '20240831'
where t1.dt='20240831'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 结果汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240904151_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904151_CST_04 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t1.RVLG_TYP_nm	    --循环类型
    ,t1.PD_NM --产品名称
    ,T2.reply_opnn_exec_situ	    --批复意见执行情况|c4000
    ,case when T2.reply_opnn_exec_situ regexp '降额|降低额度|额度降低' then '是' else '否' end is_include_je
    ,t3.crd_lmt                --授信额度
    ,t3.bind_lmt               --原绑定额度
    ,t3.bind_lmt_new  --调整后绑定额度
    ,t3.dt                      --调整日期
from SJXQ_SJ20240904151_CST_03       t1
inner join SJXQ_SJ20240904151_CST_01 t2 --重组 退出 客户
on t1.cst_id=t2.cst_id
and t2.rn=1     --最近一次精准贷后
left join SJXQ_SJ20240904151_CST_02  t3 --随贷通降额客户
on t1.ctr_serno=t3.bus_ctr_id
and t3.rn=1     --最近一次降额
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240904151_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904151_CST_05 AS
SELECT  ctr_serno            AS 合同流水号
       ,cst_id               AS 客户号
       ,cst_nm               AS 客户名称
       ,ctr_amt              AS 合同金额
       ,ctr_bal              AS 合同余额
       ,RVLG_TYP_nm          AS 循环类型
       ,PD_NM                AS 产品名称
       ,reply_opnn_exec_situ AS 批复意见执行情况
       ,is_include_je        as 是否反馈降额
       ,crd_lmt              AS 授信额度
       ,bind_lmt             AS 原绑定额度
       ,bind_lmt_new         AS 调整后绑定额度
       ,dt                   AS 调整日期
from SJXQ_SJ20240904151_CST_04
;
***SJ2024090471_调查报告信息.sql
-- 用信申请流水号     合同登记流水号     合同编号     客户号
-- BA2024052100002696     BC2024052200000651     4461001132405220173960651     7718970903
DROP   TABLE IF     EXISTS SJXQ_SJ2024090471_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090471_CST_01 AS
SELECT  col_1  AS 用信申请流水号
       ,col_2  AS 合同登记流水号
       ,col_3  AS 合同编号
       ,col_4  AS 客户号
       ,col_5  AS 客户名称
       ,col_6  AS 产品名称
       ,col_7  AS 合同金额
       ,col_8  AS 合同余额
       ,col_9  AS 担保方式
       ,col_10 AS 管户机构号
       ,col_11 AS 管户机构名称
       ,col_12 AS 管户人工号
       ,col_13 AS 管户人名称
       ,col_14 AS 经办人名称
       ,col_15 AS 经办人机构
       ,col_16 AS 经办人机构名称
       ,col_17 AS 合同敞口金额
       ,col_18 AS 抵质押物类型
from qbi_file_20240906_16_42_15
where pt<>''
;
-- 综合评价
DROP TABLE IF EXISTS SJXQ_SJ2024090471_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090471_CST_02 AS
SElECT t1.用信申请流水号,t1.合同登记流水号
    ,t2.USC_APLY_SERNO
    ,t3.ahn_ltr_aply_serno,t3.sys_reg_tm
    ,t4.svy_rpt_no
    ,t4.all_cst_cprsv_evl	--所有客户综合评价
from SJXQ_SJ2024090471_CST_01               t1
left join edw.DWD_BUS_LOAN_LMT_APLY_BIZ_DD	t2 --用信方案
on t1.用信申请流水号=t2.USC_APLY_SERNO
and t2.dt='@@{yyyyMMdd}'
left join (
    SELECT ahn_ltr_aply_serno,svy_rpt_no,sys_reg_tm
        ,ROW_NUMBER() over(partition by ahn_ltr_aply_serno order by sys_reg_tm desc)rn
    from edw.loan_svy_ahn_ltr_cst_inf
    where dt='@@{yyyyMMdd}'
    and del_ind='0'  --未删除
)t3 on t2.ahn_ltr_aply_serno = t3.ahn_ltr_aply_serno	--授用信申请流水号
and t3.rn=1
left join edw.loan_svy_pln_cprsv_evl_inf t4
on t3.svy_rpt_no=t4.svy_rpt_no	--调查报告编号
and t4.dt='@@{yyyyMMdd}'
and t4.del_ind='0'  --未删除
;
DROP TABLE IF EXISTS SJXQ_SJ2024090471_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090471_CST_03 AS
SELECT  t1.用信申请流水号
        ,t1.合同登记流水号
        ,t1.合同编号
        ,t1.客户号
        ,t1.客户名称
        ,t1.产品名称
        ,t1.合同金额
        ,t1.合同余额
        ,t1.担保方式
        ,t1.管户机构号
        ,t1.管户机构名称
        ,t1.管户人工号
        ,t1.管户人名称
        ,t1.经办人名称
        ,t1.经办人机构
        ,t1.经办人机构名称
        ,t1.合同敞口金额
        ,t1.抵质押物类型
        ,t2.all_cst_cprsv_evl   AS 综合评价
        ,t3.grnt_ctr_no     as 担保合同编号
        ,t4.gtor_nm   AS 保证人
FROM    SJXQ_SJ2024090471_CST_01 t1
left join SJXQ_SJ2024090471_CST_02  t2
on t1.用信申请流水号 = t2.用信申请流水号
LEFT JOIN    (
                 SELECT  DISTINCT ctr_serno --合同流水号|c32
                                  ,grnt_ctr_no --担保合同编号|c32
                 FROM    edw.dwd_bus_loan_ctr_rel_grnt_dd --主合同、担保合同关系
                 WHERE   dt = '@@{yyyyMMdd}'
             ) t3
ON      t1.合同登记流水号 = t3.ctr_serno
LEFT JOIN    (
                 SELECT  grnt_ctr_no --担保合同编号|c32
                 FROM    edw.dim_bus_loan_grnt_ctr_gtor_inf_dd --担保合同保证人信息
                 WHERE   dt = '@@{yyyyMMdd}'
                 GROUP BY grnt_ctr_no
             ) t4
ON      t3.grnt_ctr_no = t4.grnt_ctr_no
;
SElECT '01' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from SJXQ_SJ2024090471_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from SJXQ_SJ2024090471_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from SJXQ_SJ2024090471_CST_03
;
SElECT *
from SJXQ_SJ2024090471_CST_03***SJ2024090581_政和村行涉黑涉恶账户排查.sql
/*
时间:2023年至今政和村行相关数据
对公客户:
1.经营范围为金融、快贷、融资担保、典当相关的
2.交易附言存在借款、还本、还清、过桥、返利、赎回、理财、
三方存管、保证金、手续费、骚扰、别逼我、逼死、走投无路、
报警等字眼的
对私客户:
1.有犯罪前科，刑满释放人员
2.因非法放相关数据被司法机关查冻扣的
3.登记职业为无业、服务业、自由职业、学生
4.交易附言存在借款、还本、还清、过桥、返利、赎回、理财、
第三方存管、保证金、手续费、骚扰、别逼我、逼死、走投无路
、报警等字眼的
*/
-- 政和村行 对公客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024090581_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090581_CST_01 AS
SElECT t1.dep_act_id                             --存款账号|C8
	,t1.act_nm                                   --账户名称|C200
	,t1.cst_act_id                               --客户账号|C32
	,t1.cst_id                                   --客户号|C20
    ,t3.cst_nm	--客户名称|C200
    ,t3.opr_scp_dscr
from edw.dim_bus_dep_act_inf_dd                 t1 --存款账户信息
inner join (
    select distinct t1.DEP_ACT_ID
    from edw.dws_bus_dep_act_mgr_inf_dd	        t1 --存款账户管护汇总信息
    inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
    on  t1.acs_org_id=t2.org_id
    and t2.dt='@@{yyyyMMdd}'
    and t2.brc_org_nm regexp '福建政和泰隆村镇'
    where t1.dt='@@{yyyyMMdd}'
)t2 on t1.DEP_ACT_ID=t2.DEP_ACT_ID
inner join edw.dim_cst_entp_bas_inf_dd	        t3 --企业客户基本信息
on t1.cst_id = t3.cst_id
and t3.dt='@@{yyyyMMdd}'
and t3.opr_scp_dscr	regexp '金融|快贷|融资担保|典当' --经营范围描述
;
-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024090581_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090581_CST_02 AS
SELECT  t1.cst_id
       ,t1.dep_act_id
       ,t2.trx_dt
       ,t2.trx_tm          --交易时间
       ,t2.crd_and_dbt_ind --借贷标志
       ,t2.trx_amt
       ,t2.smr_dscr        --摘要描述
       ,t2.cmt             --备注
from SJXQ_SJ2024090581_CST_01               t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细
on t1.dep_act_id=t2.dep_act_id
and t2.dt<='@@{yyyyMMdd}'
-- and t2.dt>='20230101'
and t2.trx_dt>='20230101'
and CONCAT(t2.smr_dscr,t2.cmt) regexp '借款|还本|还清|过桥|返利|赎回|理财|三方存管|保证金|手续费|骚扰|别逼我|逼死|走投无路|报警'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090581_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090581_CST_03 AS
SELECT  t1.cst_id       AS 客户号
       ,t1.cst_nm       AS 客户名称
       ,t1.dep_act_id   AS 存款账号
       ,t1.cst_act_id   AS 客户账号
       ,t1.opr_scp_dscr AS 经营范围描述
       ,t2.cnt          AS 含关键词记录数
       ,t2.min_dt       AS 最早涉关键词日期
       ,t2.max_dt       AS 最后涉关键词日期
       ,t2.smr_dscr     AS 摘要描述汇总
from SJXQ_SJ2024090581_CST_01       t1
inner join(
    SElECT dep_act_id
        ,count(1)       cnt
        ,min(trx_dt)    min_dt
        ,max(trx_dt)    max_dt
    from SJXQ_SJ2024090581_CST_02
    group by dep_act_id
) t2 on t1.dep_act_id=t2.dep_act_id
;
-- 政和村行 对私客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024090581_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090581_CST_04 AS
SElECT t1.dep_act_id                             --存款账号|C8
	,t1.act_nm                                   --账户名称|C200
	,t1.cst_act_id                               --客户账号|C32
	,t1.cst_id                                   --客户号|C20
    ,t3.cst_chn_nm	--客户中文名称|C200
    ,t3.ocp_cd
    ,t4.cd_val_dscr     as ocp_nm
from edw.dim_bus_dep_act_inf_dd                 t1 --存款账户信息
inner join (
    select distinct t1.DEP_ACT_ID
    from edw.dws_bus_dep_act_mgr_inf_dd	        t1 --存款账户管护汇总信息
    inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
    on  t1.acs_org_id=t2.org_id
    and t2.dt='@@{yyyyMMdd}'
    and t2.brc_org_nm regexp '福建政和泰隆村镇'
    where t1.dt='@@{yyyyMMdd}'
)t2 on t1.DEP_ACT_ID=t2.DEP_ACT_ID
inner join edw.dim_cst_idv_bas_inf_dd	        t3 --个人客户基本信息
on t1.cst_id = t3.cst_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dwd_code_library_dd              t4
on t3.ocp_cd = t4.cd_val
and t4.dt='@@{yyyyMMdd}'
and t4.cd_val_dscr regexp '无业|服务业|自由职业|学生' --职业
;
-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024090581_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090581_CST_05 AS
SELECT  t1.cst_id
       ,t1.dep_act_id
       ,t2.trx_dt
       ,t2.trx_tm          --交易时间
       ,t2.crd_and_dbt_ind --借贷标志
       ,t2.trx_amt
       ,t2.smr_dscr        --摘要描述
       ,t2.cmt             --备注
from SJXQ_SJ2024090581_CST_04               t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细
on t1.dep_act_id=t2.dep_act_id
and t2.dt<='@@{yyyyMMdd}'
-- and t2.dt>='20230101'
and t2.trx_dt>='20230101'
and CONCAT(t2.smr_dscr,t2.cmt) regexp '借款|还本|还清|过桥|返利|赎回|理财|第三方存管|保证金|手续费|骚扰|别逼我|逼死|走投无路|报警'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090581_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090581_CST_06 AS
SELECT  t1.cst_id     AS 客户号
       ,t1.cst_chn_nm AS 客户名称
       ,t1.dep_act_id AS 存款账号
       ,t1.cst_act_id AS 客户账号
       ,t1.ocp_nm     AS 职业
       ,t2.cnt        AS 含关键词记录数
       ,t2.min_dt     AS 最早涉关键词日期
       ,t2.max_dt     AS 最后涉关键词日期
       ,t2.smr_dscr   AS 摘要描述汇总
from SJXQ_SJ2024090581_CST_04       t1
inner join(
    SElECT dep_act_id
        ,count(1)       cnt
        ,min(trx_dt)    min_dt
        ,max(trx_dt)    max_dt
    from SJXQ_SJ2024090581_CST_05
    group by dep_act_id
) t2 on t1.dep_act_id=t2.dep_act_id
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024090581_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024090581_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ2024090581_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024090581_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024090581_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 存款账号) custs
from SJXQ_SJ2024090581_CST_06
***SJ2024090596_舟山分行泰惠收销户清单.sql
-- 截止20240831，舟山分行泰惠收2024年注销商户清单。
-- 商户编号、商户简称、客户号、管户机构、管户客户经理、管户客户经理工号、商户注销时间、注销原因等
DROP   TABLE IF     EXISTS SJXQ_SJ2024090596_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090596_CST_01 AS
SELECT  t1.mch_id                       --商户编号|C32
       ,t1.mch_nm                       --商户名称|C200
       ,t1.mch_sht_nm                   --商户简称|C200
       ,t1.mch_sts_cd                   --商户状态代码|C32
       ,c1.cd_val_dscr as mch_sts_nm    --商户状态
       ,t1.cst_id                       --客户号|C20
       ,t1.afl_org_id                   --所属机构|C20
       ,t1.mgr_id                       --客户经理工号
       ,t1.mgr_nm                       --管户客户经理名称
       ,t3.org_nm                       --管户机构
from edw.dim_bus_chnl_ths_mch_inf_dd        t1 --泰惠收商户基本信息
INNER join edw.dim_hr_org_mng_org_tree_dd   t3 --考核机构树
on  t1.afl_org_id=t3.org_id
and t3.dt='@@{yyyyMMdd}'
and t3.brc_org_nm regexp '舟山分行'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON  t1.mch_sts_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
-- 泰惠收注销原因
DROP   TABLE IF     EXISTS SJXQ_SJ2024090596_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090596_CST_02 AS
select t1.record_id                              --记录编号
	,t1.mod_type                                 --调整类型
	,t1.mcht_id                                  --商户号
	,t1.business_type                            --业务类型
    ,CASE WHEN t1.BUSINESS_STATE = '00' THEN '已禁用'
            WHEN t1.BUSINESS_STATE = '01' THEN '已开启'
            WHEN t1.BUSINESS_STATE = '02' THEN '中止'
            WHEN t1.BUSINESS_STATE = '03' THEN '恢复'
            WHEN t1.BUSINESS_STATE = '04' THEN '注销'
            ELSE '' END as BUSINESS_STATE     --业务状态
	,t1.msg                                      --调整备注
	,t1.crt_tlr                                  --创建柜员
	,t1.crt_date_time                            --创建日期时间
	,t1.black_list                               --黑名单类型   1,银联黑名单;2,行内黑名单;3,清算协会黑名单;4,企业失信黑名单;5,涉案账户黑名单;
    ,case when substr(replace(t1.crt_date_time,'-',''),1,8) between '20240101' and '20240831' then 1 else 0 end is_2024
    ,ROW_NUMBER() OVER (PARTITION BY t1.MCHT_ID ORDER BY  t1.CRT_DATE_TIME DESC) rn
from edw.dpss_pbs_mcht_busin_mod_record t1       --商户权限修改记录表
inner join SJXQ_SJ2024090596_CST_01     t2
on t1.mcht_id=t2.mch_id
where t1.dt='@@{yyyyMMdd}'
and (t1.BUSINESS_TYPE='10' --'商户注销' '08','商户中止'
or t1.BUSINESS_STATE = '04')
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090596_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090596_CST_03 AS
SELECT  t1.mch_id         AS 商户编号
       ,t1.mch_sht_nm     AS 商户简称
       ,t1.mch_sts_nm     AS 商户状态
       ,t1.cst_id         AS 客户号
       ,t1.org_nm         AS 管户机构
       ,t1.mgr_id         AS 客户经理工号
       ,t1.mgr_nm         AS 管户客户经理名称
       ,t2.BUSINESS_STATE AS 业务状态
       ,t2.msg            AS 注销原因
       ,t2.crt_date_time  AS 商户注销时间
from SJXQ_SJ2024090596_CST_01       t1
inner join SJXQ_SJ2024090596_CST_02 t2
on t1.mch_id=t2.mcht_id
where t2.is_2024=1
and t2.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct mch_id) custs
from SJXQ_SJ2024090596_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct mcht_id) custs
from SJXQ_SJ2024090596_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 商户编号) custs
from SJXQ_SJ2024090596_CST_03
;
select *
from SJXQ_SJ2024090596_CST_03
***SJ20240906101_拱墅支行举一反三.sql
-- 导入表
DROP   TABLE IF     EXISTS SJXQ_SJ20240906101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240906101_CST_01 AS
SELECT  '' col_1 --序号
       ,'' col_2 --客户号
       ,'' col_3 --客户名称
-- from
-- where pt<>''
;
-- 近6月日均存款
DROP   TABLE IF     EXISTS SJXQ_SJ20240906101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240906101_CST_02 AS
SElECT t1.col_1,t1.col_2
    ,t2.客户近6个月存款日均
from SJXQ_SJ20240906101_CST_01 t1
left join(
    SELECT  cst_id
            ,SUM(last_180_days_gl_bal_acml) / 180 AS 客户近6个月存款日均
    FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
    WHERE   DT = '20240831'
    GROUP BY cst_id
)t2 on t1.col_2=t2.cst_id
;
-- 经营单位名称
DROP   TABLE IF     EXISTS SJXQ_SJ20240906101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240906101_CST_03 AS
SElECT t1.col_1,t1.col_2
    ,t2.company_name	--经营单位名称
    ,t2.operate_project	--经营项目
    ,t3.companyname	    --单位名称
    ,t3.project	        --经营项目
    ,t4.unt_nm
    ,t4.opr_prj
from SJXQ_SJ20240906101_CST_01  t1
left join edw.xwdt_xw_grey_info t2      --客户经营信息表
on t1.col_2=t2.cust_no
and t2.dt='20240831'
left join edw.loan_customer_operation	t3 --客户经营基本情况表	56
on t1.col_2 = t3.customerid
and t3.dt='20240831'
left join (
    select cst_id,unt_nm	--单位名称|C80
        ,opr_prj	        --经营项目|C80
		,row_number() over(partition by cst_id order by upd_dt desc) as rn
		from edw.dwd_bus_loan_cvy_opr_inf_dd    --信贷业务调查报告-客户经营信息
		where dt = '20240719'
) t4 on t1.col_2 = t4.cst_id
and t4.rn = 1
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240906101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240906101_CST_04 AS
SELECT  t1.col_1           AS 序号
       ,t1.col_2           AS 客户号
       ,t1.col_3           AS 客户名称
       ,t2.客户近6个月存款日均
       ,t3.company_name    AS 经营单位名称
       ,t3.operate_project AS 经营项目
from SJXQ_SJ20240906101_CST_01      t1
left join SJXQ_SJ20240906101_CST_02 t2
on t1.col_2=t2.col_2
left join SJXQ_SJ20240906101_CST_03 t3
on t1.col_2=t3.col_2
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ20240906101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ20240906101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ20240906101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240906101_CST_04
***SJ2024090636_英德村行市场部信贷.sql
-- 林姗姗017312
-- SJ2024090636
/*
select * from loan_oca.n_wf_comment nwc where ROLE_ID ='2047';
可以通过这个方式强查
2047是这个岗位的角色编号
SELECT  *
FROM loan_biz.ctr_bse_inf cb
JOIN loan_biz.lmt_aply_biz lab
ON cb.REG_TYP = '01' AND cb.REL_SERNO = lab.USC_APLY_SERNO
JOIN loan_oca.n_wf_instance nwi
ON nwi.BIZ_ID = lab.AHN_LTR_APLY_SERNO
JOIN loan_oca.n_wf_comment_his nwc2
ON nwc2.INSTANCE_ID = nwi.INSTANCE_ID
如果是合同的话 ，得去 n_wf_comment_his 表查
审批中的申请才找 n_wf_comment
未批完的在 loan_oca.n_wf_instance.flow_param
批完的在loan_oca.n_wf_instance_his.flow_param
*/
--流程审批意见
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_01 AS
select instance_id                            --实例id
    ,user_id                                  --用户id
    ,user_name                                --用户名称
    ,start_time                               --评论时间
    ,comment_sign                             --用户结论
    ,user_comment                             --用户评论
    ,approval_time                            --办理时长
    ,role_id                                  --审批人角色id
    ,node_name
    ,org_id                                   --所属机构编号
from edw.loan_n_wf_comment_his	--流程审批意见历史
where dt = '@@{yyyyMMdd}'
and (role_id = '2047' or node_name regexp '审查岗')
and substr(replace(start_time,'-',''),1,8) between '20240701' and '20240831'
and org_id like '4461%' --广东英德泰隆村镇
union
select instance_id,user_id ,user_name ,start_time  ,comment_sign,user_comment
        ,approval_time ,role_id ,node_name,org_id
from edw.loan_n_wf_comment	    --流程审批意见
where dt = '@@{yyyyMMdd}'
and (role_id = '2047' or node_name regexp '审查岗')
and substr(replace(start_time,'-',''),1,8) between '20240701' and '20240831'    --7-8月审查岗审批
and org_id like '4461%' --广东英德泰隆村镇
;
--流程运行实例表
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_02 AS
SELECT t1.instance_id
    ,t2.BIZ_ID,t2.flow_name,t2.flow_starter,t2.flow_starter_name
    ,t2.start_time,t2.org_id,t2.biz_user_name,t2.biz_user_id
    ,t2.flow_param,t2.biz_param5
from(
    SELECT DISTINCT instance_id
    from SJXQ_SJ2024090636_CST_01
    where role_id='2047'
)t1 left join(
    select BIZ_ID,INSTANCE_ID,flow_name,flow_starter,flow_starter_name,start_time,org_id,biz_user_name,biz_user_id,flow_param,biz_param5
    from edw.loan_n_wf_instance_his	--流程运行实例历史表
    where dt = '@@{yyyyMMdd}'
    and org_id like '4461%' --广东英德泰隆村镇
    union
    select BIZ_ID,INSTANCE_ID,flow_name,flow_starter,flow_starter_name,start_time,org_id,biz_user_name,biz_user_id,flow_param,biz_param5
    from edw.loan_n_wf_instance	    --流程运行实例表
    where dt = '@@{yyyyMMdd}'
    and org_id like '4461%' --广东英德泰隆村镇
)t2 on t1.instance_id=t2.instance_id
;
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_03 AS
SELECT t1.BIZ_ID
    ,t2.usc_aply_serno                           --用信申请流水号|c32
	,t2.ahn_ltr_aply_serno                       --授用信申请流水号|c32
	,t2.cst_id                                   --客户号|c20
	,t2.cst_nm                                   --客户名称|c200
	,t2.prd_no                                   --产品编号|c32
	,t2.pd_nm                                   --产品名称|c200
	,t2.hpn_typ_cd                               --发生类型代码|c6
	,t2.crc_typ_cd                               --循环类型代码|c1
	,t2.smls_reloan_ind                          --无缝续贷标志|c1
	,t2.smls_reloan_typ_cd                       --无缝续贷类型代码|c1
	,t2.apl_amt                                  --申请金额|decimal(21,2)
	,t2.strt_use_amt                             --启用金额|decimal(21,2)
	,t2.aply_epsr_amt                            --申请敞口金额|decimal(21,2)
	,t2.grnt_mod_colc_cd                         --担保方式集合代码|c200
	,t2.aply_bgn_dt                              --申请起始日期|c8
	,t2.aply_mtu_dt                              --申请到期日期|c8
	,t2.grnt_cmt                                 --担保备注|c4000
	,t2.apl_dt                                   --申请日期|c8
	,t2.rmk                                      --备注|c4000
	,t2.mgr_id                                   --管户人工号|c10
	,t2.mgr_org_id                               --管户机构编号|c12
	,t2.rcm_psn_id                               --推荐人工号|c20
	,t2.csm_loan_ind                             --消费贷款标志|c1
	,t2.exec_intr_rat                            --执行利率|decimal(13,7)
from SJXQ_SJ2024090636_CST_02       t1
INNER JOIN edw.dwd_bus_loan_lmt_aply_biz_dd t2 --用信方案
on  t1.BIZ_ID=t2.AHN_LTR_APLY_SERNO
and t2.dt='@@{yyyyMMdd}'
-- left join edw.dim_bus_loan_ctr_bse_inf_dd t3 --合同基础信息
-- on  t2.USC_APLY_SERNO=t3.REL_SERNO
-- and t3.dt='@@{yyyyMMdd}'
;
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_04 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.bsn_mark_cd	    --业务标识代码|c32
    ,c1.cd_val_dscr     as bsn_mark_nm
    ,t1.hpn_typ_cd
    ,c2.cd_val_dscr     as hpn_typ_nm
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.reg_typ_cd	    --登记类型代码|c2
    ,c3.cd_val_dscr     as reg_typ_nm
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm   regexp '广东英德泰隆村镇'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.hpn_typ_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t1.reg_typ_cd = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_05 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '@@{yyyyMMdd}'
)t1 LEFT JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.rn=1
;
-- 新预评估结果 tmp
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_05_1 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.dim_bus_loan_pre_ases_rul_set_rel_dd  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '@@{yyyyMMdd}'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '@@{yyyyMMdd}'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '@@{yyyyMMdd}'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 预评估不通过规则
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_06 AS
SELECT  distinct t1.pre_ases_serno
       ,t2.rul_set_rslt_serno --规则集结果流水号
       ,t2.rul_set_rslt_cd    --规则集结果代码
       ,c1.cd_val_dscr        --预评估结果
       ,t3.rul_no             --规则编号
       ,t3.rul_nm             --规则名称
       ,t3.rul_rslt	          --规则结果|C256
       ,t3.prmpt_msg          --提示信息
       ,t3.svy_rslt           --调查结果
FROM SJXQ_SJ2024090636_CST_05                       t1
---- 预评估结果
LEFT JOIN edw.dim_bus_loan_pre_ases_rul_set_rel_dd  t2
ON t1.pre_ases_serno = t2.pre_ases_serno
AND t2.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd                   c1
ON t2.rul_set_rslt_cd = c1.cd_val
AND c1.dt = '@@{yyyyMMdd}'
---- 预评估规则明细
LEFT JOIN edw.dwd_bus_loan_pre_ases_rul_dtl_dd      t3
ON t2.rul_set_rslt_serno = t3.rul_set_rslt_serno
AND t3.dt = '@@{yyyyMMdd}'
;
/*
提交市场部审批原因
审批状态：是否有退回/退回补充资料
审批意见：退回原因
审查岗审批人：市场部
审批日期：审查岗
*/
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_07 AS
select t1.instance_id                            --实例id
    ,t1.user_id                                  --用户id
    ,t1.user_name                                --用户名称
    ,t1.start_time                               --评论时间
    ,t1.comment_sign                             --用户结论
    ,t1.user_comment                             --用户评论
    ,t1.approval_time                            --办理时长
    ,t1.role_id                                  --审批人角色id
    ,t1.node_name
    ,t1.org_id                                   --所属机构编号
    ,t2.BIZ_ID,t2.flow_name,t2.flow_starter,t2.flow_starter_name
    ,t2.start_time as start_time2
    ,t2.org_id as org_id2
    ,t2.biz_user_name,t2.biz_user_id
    ,t2.flow_param,t2.biz_param5
    ,t3.usc_aply_serno                           --用信申请流水号|c32
	,t3.ahn_ltr_aply_serno                       --授用信申请流水号|c32
    ,t4.ctr_serno
	,t4.cst_id                                   --客户号|C20
	,t4.cst_nm                                   --客户名称|C200
	,t4.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t4.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t4.ctr_bgn_dt                               --合同起始日期
	,t4.ctr_mtu_dt                               --合同到期日期
    ,t4.TMT_DT	                                 --终结日期
    ,t4.exec_intr_rat	--执行利率|decimal(13,7)
    ,t4.bsn_mark_nm	    --业务标识
    ,t4.hpn_typ_nm
    ,t4.usc_aply_dt	    --用信申请日期|c8
    ,t4.reg_typ_cd	    --登记类型代码|c2
    ,t4.reg_typ_nm
    ,t4.PD_NM
    ,T5.PRE_ASES_SERNO
    ,t5.rul_set_rslt_nm --新预评估结果
    ,t5.cst_nm  as aply_cst_nm
    ,t5.org_nm          --申请机构
    ,t6.rul_nm  --预评估不通过规则
from SJXQ_SJ2024090636_CST_01       t1
left join SJXQ_SJ2024090636_CST_02  t2
on t1.instance_id = t2.instance_id
left join SJXQ_SJ2024090636_CST_03  t3
on t2.BIZ_ID = t3.ahn_ltr_aply_serno
left join SJXQ_SJ2024090636_CST_04  t4
on t3.usc_aply_serno = t4.rel_serno
left join SJXQ_SJ2024090636_CST_05  t5
on t4.cst_id=t5.cst_id
left join(
    SELECT pre_ases_serno
    from SJXQ_SJ2024090636_CST_06
    where rul_set_rslt_cd='2010'    --未通过
    GROUP BY pre_ases_serno
)t6 on t5.PRE_ASES_SERNO=t6.pre_ases_serno
where t1.role_id='2047'     --村行审查岗
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090636_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090636_CST_08 AS
SELECT  cst_id                    AS 客户号
       ,cst_nm                    AS 客户名称
       ,ctr_serno                 AS 合同流水号
       ,PD_NM                     AS 业务品种
       ,bsn_mark_nm               AS 业务标识
       ,hpn_typ_nm                AS 发生类型
       ,usc_aply_dt               AS 用信申请日期
       ,ctr_mtu_dt                AS 合同到期日期
       ,ctr_amt                   AS 合同金额
       ,exec_intr_rat             AS 执行利率
       ,aply_cst_nm               AS 申请人
       ,org_nm                    AS 申请机构
       ,rul_set_rslt_nm           AS 新预评估结果
       ,rul_nm                    AS 预评估不通过规则
       ,flow_param                AS 提交市场部审批原因
       ,comment_sign              AS 审批状态
       ,user_comment              AS 审批意见
       ,concat(user_id,' ',user_name) AS 审查岗审批人
       ,start_time                AS 审批日期
FROM SJXQ_SJ2024090636_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ2024090636_CST_01 where role_id='2047'
union all
SElECT '02' seq, count(1) cnt,count(distinct BIZ_ID) custs
from SJXQ_SJ2024090636_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct usc_aply_serno) custs
from SJXQ_SJ2024090636_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct REL_SERNO) custs
from SJXQ_SJ2024090636_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024090636_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct pre_ases_serno) custs
from SJXQ_SJ2024090636_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ2024090636_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024090636_CST_08
;
***SJ2024090906_嘉兴分行全量信贷数据.sql
--
DROP   TABLE IF     EXISTS SJXQ_SJ2024090906_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090906_CST_01 AS
SELECT  '' col_1 --合同流水号
       ,'' col_2 --发放日期
       ,'' col_3 --到期日期
-- from
-- where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024090906_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090906_CST_02 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.smls_reloan_ind	        --无缝续贷标志|c1
    ,t1.smls_reloan_typ_cd	    --无缝续贷类型代码|c1
    ,c1.cd_val_dscr             as smls_reloan_typ_nm
    ,t1.hpn_typ_cd	            --发生类型代码|c6
    ,c4.cd_val_dscr             as hpn_typ_nm
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,d.preevaluateresult
    ,c2.cd_val_dscr     preevaluateresult_nm
from edw.dim_bus_loan_ctr_bse_inf_dd       t1 --合同基础信息
inner join (
    select distinct col_1
    from SJXQ_SJ2024090906_CST_01
)t on t1.ctr_serno =t.col_1
left join edw.dim_bus_loan_prd_frml_dd     t2
on  t1.prd_no=t2.prd_no
and t2.dt='20240831'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on  t1.ctr_serno=t3.ctr_serno
and t3.dt='20240831'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240831'
left JOIN edw.DWD_BUS_LOAN_APL_INF_DD  C --信贷业务申请信息
ON      t1.rel_serno = C.APL_ID    --业务申请编号
AND     NVL(C.APL_ID,'') <> ''      --剔除空值和空
AND     C.DT ='20240719'
left join edw.loan_customer_preevaluate_result  D -- 预评估最终结果表 // 该表作用基本只提供preevaluateresult
on trim(c.pre_apl_srl_nbr) = trim(D.serialno)
and D.customerrole = '01' -- 角色为借款人
and D.dt ='20240719'
left join edw.dwd_code_library_dd       c2
on  d.PREEVALUATERESULT = c2.cd_val
and c2.dt = '20240719'
left join edw.dwd_code_library_dd           c1
on t1.smls_reloan_typ_cd = c1.cd_val
and c1.dt = '20240831'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON  t1.hpn_typ_cd = C4.CD_VAL
AND C4.DT = '20240719'
where t1.dt='20240831'
;
-- 新预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2024090906_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090906_CST_03 AS
SELECT  T1.CST_ID
       ,T1.PRE_ASES_SERNO
FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD          T1
LEFT JOIN EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD  T2
ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
AND T2.DT = '20240831'
INNER JOIN
(
	SELECT  CST_ID
	       ,MAX(PRE_ASES_SERNO) AS MAX_PRE_ASES_SERNO
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240831'
	GROUP BY  CST_ID
) T3 ON T1.PRE_ASES_SERNO = T3.MAX_PRE_ASES_SERNO -- 取最近一笔预评估结果
LEFT JOIN edw.dwd_code_library_dd T4
ON t2.RUL_SET_RSLT_CD = t4.cd_val
AND T4.DT = '20240831'
AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND t4.fld_nm = 'RUL_SET_RSLT_CD'
WHERE T1.DT = '20240831'
GROUP BY  T1.CST_ID,T1.PRE_ASES_SERNO
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090906_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090906_CST_04 AS
SELECT  col_1                   AS 合同流水号
       ,col_2                   AS 发放日期
       ,col_3                   AS 到期日期
       ,t2.PD_NM                AS 产品名称
       ,t2.preevaluateresult_nm AS 老预评估结果
       ,t3.rul_set_rslt_nm      AS 新预评估结果
       ,t2.smls_reloan_ind      AS 无缝续贷标志
       ,t2.smls_reloan_typ_nm   AS 无缝续贷类型
       ,t2.hpn_typ_nm           AS 发生类型
from SJXQ_SJ2024090906_CST_01       t1
left join SJXQ_SJ2024090906_CST_02  t2
on t1.col_1 = t2.ctr_serno
left join SJXQ_SJ2024090906_CST_03  t3
on t2.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024090906_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024090906_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024090906_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024090906_CST_04
***SJ20240909136_台州分行快捷支付明细.sql
--支付流水表
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_01 AS
SELECT  ACT
       ,SUM(CASE WHEN pay_org_id = 'Z2007933000010' THEN 1 ELSE 0 END) ZFB_CNT
       ,SUM(CASE WHEN pay_org_id = 'Z2004944000010' THEN 1 ELSE 0 END) WX_CNT
FROM EDW.DWD_BUS_CHNL_EPC_PAY_SRL_DTL_DI --支付流水表
WHERE DT >= '20240901'
AND DT <= '20240930'
AND PAY_ORG_ID IN ( 'Z2007933000010' , 'Z2004944000010' )
AND TRX_TYP = '0110'
AND CNTR_STS = '00'
GROUP BY  ACT
;
-- 字段汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_02 AS
SELECT  COALESCE(C.CST_ID,E1.CST_ID)    CST_ID
    ,coalesce(c.cst_act_nm,e1.cst_nm) 	cst_nm --客户名称|C200
    ,B.ACT,b.ZFB_CNT,b.WX_CNT
    ,CASE WHEN ZFB_CNT > 0 THEN '是'  ELSE '否' END 支付宝活跃
    ,CASE WHEN WX_CNT > 0  THEN '是'  ELSE '否' END 微信活跃
    ,CASE WHEN C.CST_ID IS NOT NULL THEN '借记卡'
            WHEN E1.CST_ID IS NOT NULL THEN '贷记卡'  ELSE '' END 账户类型
    ,Y.ACT_CTG_CD_2 账户分类代码
    ,COALESCE(C.OPN_DT, E1.CARD_ACTV_DT) OPN_DT
    ,COALESCE(D.ACS_ORG_ID, E.ACS_ORG_ID) ACS_ORG_ID
    ,K.sbr_org_nm
    ,K.brc_org_nm
    ,K.tem_org_nm
    ,COALESCE(E.FRS_MGR_ID, D.MGR_ID) MGR_ID
    ,Z.EMPE_NM MGR_NM
    ,Z1.POS_ID 职位
    ,Z1.POS_NM 职位名称
FROM    SJXQ_SJ20240909136_CST_01  B
LEFT JOIN    EDW.DIM_BUS_DEP_CST_ACT_INF_DD C
ON      B.ACT = C.CST_ACT_ID
AND     C.DT = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DWD_BUS_DEP_CST_ACT_MGR_INF_DD D
ON      B.act = D.CST_ACT_ID
AND     D.DT = '@@{yyyyMMdd}'
AND     D.FRS_CTC_IND = '1'
LEFT JOIN    edw.dwd_bus_crd_cr_crd_mgr_inf_dd E
ON      B.ACT = E.cr_crd_card_nbr
AND     E.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd E1
ON      B.ACT = E1.cr_crd_card_nbr
AND     E1.DT = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    K --考核机构树
on  COALESCE(D.ACS_ORG_ID, E.acs_org_id)=K.org_id
and K.dt='@@{yyyyMMdd}'
LEFT JOIN    EDW.DWS_HR_EMPE_INF_DD Z
ON      COALESCE(E.FRS_MGR_ID, D.MGR_ID) = Z.EMPE_ID
AND     Z.DT = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DIM_HR_ORG_JOB_INF_DD Z1
ON      Z.POS_ENC = Z1.POS_ID
AND     Z1.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  CST_ACT_ID
                         ,ACT_CTG_CD_2
                 FROM    EDW.DIM_BUS_DEP_ACT_INF_DD
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     ACT_CTG_CD_2 IN ( '301' , '302' , '303' )
             ) Y
ON      B.ACT = Y.CST_ACT_ID
;
-- 输出结果 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_03 AS
SELECT  ACT        AS 活跃账户
       ,账户类型
       ,账户分类代码
       ,CST_ID     AS 客户号
       ,cst_nm     AS 客户姓名
       ,支付宝活跃
       ,微信活跃
       ,brc_org_nm AS 所属分行
       ,sbr_org_nm AS 所属支行
       ,tem_org_nm AS 所属团队
       ,MGR_ID     AS 账户管户工号
       ,MGR_NM     AS 账户管户姓名
       ,职位名称
from SJXQ_SJ20240909136_CST_02
;
-- 输出结果 员工维度
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_04 AS
SELECT  brc_org_nm AS 所属分行
       ,sbr_org_nm AS 所属支行
       ,tem_org_nm AS 所属团队
       ,MGR_ID     AS 账户管户工号
       ,MGR_NM     AS 账户管户姓名
       ,职位名称
       ,SUM(case WHEN ZFB_CNT+WX_CNT > 0 THEN 1 else 0 end)                  AS 当月活跃账户数
       ,SUM(case WHEN ZFB_CNT+WX_CNT > 0 AND 账户类型 = '贷记卡' THEN 1 else 0 end) AS 当月活跃账户数_贷记卡
FROM SJXQ_SJ20240909136_CST_02
GROUP BY  brc_org_nm ,sbr_org_nm ,tem_org_nm ,MGR_ID ,MGR_NM ,职位名称
;
SElECT '01' seq, count(1) cnt,count(distinct ACT) custs
from SJXQ_SJ20240909136_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ACT) custs
from SJXQ_SJ20240909136_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 活跃账户) custs
from SJXQ_SJ20240909136_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 账户管户工号) custs
from SJXQ_SJ20240909136_CST_04
;
SElECT '03' seq, *
from SJXQ_SJ20240909136_CST_03
;
SElECT '04' seq, *
from SJXQ_SJ20240909136_CST_04
;
-- 需求2
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_05 AS
SELECT  act
       ,SUM(trx_amt) AS WXLN_AMT --微信当年交易金额
       ,COUNT(1)     AS WXLN_CNT --微信当年交易笔数
FROM edw.DWD_BUS_CHNL_EPC_PAY_SRL_DTL_DI A --交易类确认流水表
WHERE dt >= '@@{yyyyMMdd-1y}'
AND cntr_sts = '00'
AND TRX_TYP = '0110'
AND A.pay_org_id = 'Z2004944000010' --微信
GROUP BY  act
;
-- 交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_06 AS
SELECT  t1.act
       ,t2.CST_ACT_ID
       ,t3.dep_act_id
       ,t3.trx_dt
       ,t3.trx_tm          --交易时间
       ,t3.crd_and_dbt_ind --借贷标志
       ,t3.trx_amt
       ,t3.smr_dscr        --摘要描述
       ,t3.cmt             --备注
from SJXQ_SJ20240909136_CST_05              t1
left join edw.dws_bus_dep_act_inf_dd    	t2 --存款账户信息汇总
on t1.act=t2.CST_ACT_ID
and t2.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3 --存款账户余额发生明细
on t2.dep_act_id=t3.dep_act_id
and t3.dt>='@@{yyyyMMdd-1y}'
and t3.trx_dt>='@@{yyyyMMdd-1y}'
and CONCAT(t3.smr_dscr,t3.cmt) regexp '微信提现'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_07 AS
SElECT t1.ACT
    ,t1.WXLN_AMT --近一年微信交易金额
    ,t1.WXLN_CNT --近一年微信交易笔数
    ,t2.cst_act_nm --客户名称
    ,t2.cst_id
    ,t3.CST_ACT_ID
    ,t3.MGR_ID
    ,t5.empe_nm as mgr_nm
    ,t4.sbr_org_nm
    ,t4.brc_org_nm
    ,t4.tem_org_nm
    ,t6.idt_cd	--行业代码|C5
    ,c1.cd_val_dscr     as idt_nm
    ,t7.lst_1y_wxtx_cnt
    ,t7.lst_1y_wxtx_amt
from SJXQ_SJ20240909136_CST_05              t1
LEFT JOIN    EDW.DIM_BUS_DEP_CST_ACT_INF_DD t2
ON      t1.ACT = t2.CST_ACT_ID
AND     t2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_BUS_DEP_CST_ACT_MGR_INF_DD t3
ON      t1.act = t3.CST_ACT_ID
AND     t3.DT = '@@{yyyyMMdd}'
AND     t3.FRS_CTC_IND = '1'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.ACS_ORG_ID=t4.org_id
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN    EDW.DWS_HR_EMPE_INF_DD t5
ON      t3.MGR_ID = t5.EMPE_ID
AND     t5.DT = '@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd	t6 --客户基础信息汇总表
on t2.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join (
    select cst_act_id
        ,count(1)       as lst_1y_wxtx_cnt
        ,sum(trx_amt)   as lst_1y_wxtx_amt
    from SJXQ_SJ20240909136_CST_06
    group by cst_act_id
) t7 on t1.act=t7.CST_ACT_ID
left join edw.dwd_code_library_dd           c1
on t6.idt_cd =  c1.cd_val
and c1.dt='@@{yyyyMMdd}'
;
-- 结果表2
DROP   TABLE IF     EXISTS SJXQ_SJ20240909136_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240909136_CST_08 AS
SELECT  ACT					as 账号
       ,cst_id              as 客户号
       ,cst_act_nm          as 客户姓名
       ,idt_nm              as 从事行业
       ,lst_1y_wxtx_cnt     as 近一年微信提现总次数
       ,lst_1y_wxtx_amt     as 近一年微信提现总金额
       ,WXLN_AMT            as 近一年微信交易金额
       ,WXLN_CNT            as 近一年微信交易笔数
       ,brc_org_nm          as 所属分行
       ,sbr_org_nm          as 所属支行
       ,tem_org_nm          as 所属团队
       ,MGR_ID              as 账户主管户工号
       ,mgr_nm              as 账户主管户姓名
FROM SJXQ_SJ20240909136_CST_07
;
SElECT '05' seq, count(1) cnt,count(distinct act) custs
from SJXQ_SJ20240909136_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct act) custs
from SJXQ_SJ20240909136_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct act) custs
from SJXQ_SJ20240909136_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 账号) custs
from SJXQ_SJ20240909136_CST_08
;
SElECT '08' seq, *
from SJXQ_SJ20240909136_CST_08
***SJ2024090956_杭州分行续贷业务.sql
--栾成-续贷业务分析
-- SJ2024090956
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024090956_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090956_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --合同登记流水号
       ,col_3 --客户号
       ,col_4 --客户名称
       ,col_5 --担保方式
from qbi_file_20240919_10_00_36
where pt<>''
;
--合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024090956_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090956_CST_02 AS
SElECT t1.col_2
    ,t2.ctr_serno
    ,t2.cst_id
    ,t3.USC_APLY_SERNO
    ,t4.ahn_ltr_aply_serno
	,t4.sam_rsk_ctrl_no                          --同一风险控制号|c24
	,t4.csld_cr_lmt                              --统一授信额度|decimal(21,2)
	,t4.csld_cr_xpos                             --统一授信敞口|decimal(21	,t4.2)
	,t4.apl_dt                                   --申请日期|c8
	,t4.exec_intr_rat                            --执行利率|decimal(13,7)
    ,t5.lgp_cst_id                               --对公客户法人客户号
    ,t5.lgp_nm                                   --对公客户法人客户名称
from(
    SElECT distinct col_2
    from SJXQ_SJ2024090956_CST_01
)t1 inner join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD	t2 --合同基础信息
on t1.col_2=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_lmt_aply_biz_dd      t3
on t2.rel_serno=t3.USC_APLY_SERNO
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_lmt_aply_info_dd     t4 --授用信申请信息
on t3.ahn_ltr_aply_serno=t4.ahn_ltr_aply_serno
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_cst_entp_lgp_inf_dd           t5 --对公客户法人信息表
on t2.cst_id = t5.cst_id
and t5.dt='@@{yyyyMMdd}'
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024090956_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090956_CST_03 AS
SElECT t1.cst_id,t1.apl_dt
    ,t2.cst_cr_grd_val
    ,t2.prd_dt
    ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id,t1.apl_dt ORDER BY t2.prd_dt DESC) AS rn
from(
    SElECT cst_id,apl_dt
    from SJXQ_SJ2024090956_CST_02
    union
    SElECT lgp_cst_id,apl_dt
    from SJXQ_SJ2024090956_CST_02
)t1 left join(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '@@{yyyyMMdd}'
    UNION
    SELECT  cst_id
        ,prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '@@{yyyyMMdd}'
)t2 on t1.cst_id=t2.cst_id
and t1.apl_dt>=t2.prd_dt
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090956_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090956_CST_04 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '@@{yyyyMMdd}'
)t1 inner JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.rn=1
;
--担保分类（纯信用、纯道义、纯家人、大信用、抵质押、其他担保）
DROP   TABLE IF     EXISTS SJXQ_SJ2024090956_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090956_CST_05 AS
SElECT t1.ctr_serno
    ,t3.vouch_type --担保分类
from SJXQ_SJ2024090956_CST_02                       t1
left join(
    SElECT ctr_srl_no	--合同流水号
    from adm_rsk.adm_rsk_apl_inter_all	--风险集市应用表-资产质量日常监测源表
    where dt = '@@{yyyyMMdd}'
    group by ctr_srl_no
)t3 on t1.ctr_serno=t3.ctr_srl_no
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024090956_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024090956_CST_06 AS
SELECT  t1.col_1           AS 序号
       ,t1.col_2           AS 合同登记流水号
       ,t1.col_3           AS 客户号
       ,t1.col_4           AS 客户名称
       ,t1.col_5           AS 担保方式
       ,t2.sam_rsk_ctrl_no AS 同一风险控制号
       ,t2.csld_cr_xpos    AS 统一授信敞口
       ,t2.lgp_cst_id      AS 对公客户法人客户号
       ,t2.lgp_nm          AS 对公客户法人客户名称
       ,t3.cst_cr_grd_val  AS 经办时客户中征分
       ,t4.cst_cr_grd_val  AS 经办时法定代表人中征分_对公业务
       ,t5.rul_set_rslt_nm AS 客户新预评估结果
       ,t6.rul_set_rslt_nm AS 法定代表人新预评估结果_对公业务
       ,t7.vouch_type       AS 担保分类
from SJXQ_SJ2024090956_CST_01       t1
left join SJXQ_SJ2024090956_CST_02  T2
on t1.col_2=t2.ctr_serno
left join SJXQ_SJ2024090956_CST_03  T3
on t2.cst_id=t3.cst_id
and t2.apl_dt=t3.apl_dt
and t3.rn=1
left join SJXQ_SJ2024090956_CST_03  T4
on t2.lgp_cst_id=t4.cst_id
and t2.apl_dt=t4.apl_dt
and t4.rn=1
left join SJXQ_SJ2024090956_CST_04  t5
on t2.cst_id=t5.cst_id
left join SJXQ_SJ2024090956_CST_04  t6
on t2.cst_id=t6.cst_id
left join SJXQ_SJ2024090956_CST_05  t7
on t2.ctr_serno=t7.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024090956_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024090956_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024090956_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024090956_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024090956_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同登记流水号) custs
from SJXQ_SJ2024090956_CST_06
;
SElECT '06' seq, *
from SJXQ_SJ2024090956_CST_06
;
***SJ2024091101_征信数据.sql
--栾成-风险排查需求
-- SJ2024091101
-- 9.10底稿，这张表优先取数，请总行老师按照C列客户号，帮忙取表头为灰色部分的数据。数据位置可见附件excel表格sheet3
DROP   TABLE IF     EXISTS SJXQ_SJ2024091101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091101_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --客户号
from qbi_file_20240911_17_37_12
where pt<>''
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024091101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091101_CST_02 AS
SELECT  t.cst_id
    ,t.prd_dt
    ,t.cst_cr_grd_val
    ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  prd_dt DESC ) AS rn
FROM
(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '@@{yyyyMMdd}'
    UNION
    SELECT  cst_id
        ,substr(replace(prd_dt,'-',''),1,8) as prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '@@{yyyyMMdd}'
) t
;
-- 个人征信指标信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2024091101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091101_CST_03 AS
SELECT  t1.cst_id
       ,t1.report_no
       ,t1.report_dt                      --报告日期
       ,t1.cred_busi_org_out_wjq          --授信机构数（不含未激活）
       ,t1.oth_bank_busi_org_num          --他行授信机构数(不含未激活)
       ,t1.oth_bank_loan_org_num          --他行贷款授信机构数
       ,t1.oth_bank_xfx_loan_org_num      --他行消费性贷款授信机构数
       ,t1.othr_bnk_mngmt_loan_org_num    --他行经营性贷款授信机构数
       ,t1.rem_house_loan_unsett_org_num  --除房贷外当前有余额的贷款机构数
       ,t1.cds                            --当前逾期
       ,t1.c_od_amt                       --当前逾期总额
       ,t1.c_od_total_amt                 --贷款当前逾期总额
       ,t1.late_2y_card_max_serial_od_num --近2年信用卡最大连续逾期月份数
       ,t1.late_6mon_enqu_count           --最近6个月审批查询次数
       ,t1.curr_unsett_fyh_loan_org_num   --当前未结清非银行贷款机构数
       ,t1.c_c_6m_avg_use_rate            --信用卡最近6个月平均透支率
       ,t1.cred_card_6m_use_rate          --最近6个月信用卡额度使用率(不含未激活)
       ,t1.cred_card_num                  --信用卡张数
       ,t1.curr_bad_extguan_loan_amt      --当前非正常对外贷款担保金额
       ,t1.curr_bad_extguan_loan_num      --非正常贷款对外担保笔数
       ,t1.case_sts                       --法院执行案件状态
       ,t2.report_id
       ,t2.zxqu_l6m_cnt                   --最近6个月内查询次数
    ,t3.rpt_id
    -- ,t3.rpay_duty_amt	            --还款责任金额|C15
    ,nvl(t3.bal,0) as bal_zrr	                        --余额|C15
    ,nvl(t4.bal,0) as bal_zzjg
    ,row_number() over(partition by t1.cst_id order by t1.report_no desc) rn
from edw.dws_cst_ccrc_idv_ind_inf_dd                t1 --个人征信指标信息表
left join adm_pub.adm_csm_cbus_out_crd_idv_qry_dd	t2 --客户集市-业务信息-个人征信-查询信息表
on t1.cst_id=t2.cst_id
and t1.report_no=t2.report_id
and t2.dt='@@{yyyyMMdd}'
left join (
    SELECT rpt_id
        ,sum(nvl(cast(bal as double),0)) bal
    from edw.dwd_cst_ccrc_idv_rel_rpay_duty_smy_inf_dd  --征信个人客户相关还款责任汇总信息
    where dt='@@{yyyyMMdd}' and brw_typ_cd='1'   --自然人
    GROUP BY rpt_id
)	t3 --征信个人客户相关还款责任汇总信息
on t1.report_no=t3.rpt_id
left join (
    SELECT rpt_id
        ,sum(nvl(cast(bal as double),0)) bal
    from edw.dwd_cst_ccrc_idv_rel_rpay_duty_smy_inf_dd  --征信个人客户相关还款责任汇总信息
    where dt='@@{yyyyMMdd}' and brw_typ_cd='2'   --组织机构
    GROUP BY rpt_id
)	t4 --征信个人客户相关还款责任汇总信息
on t1.report_no=t4.rpt_id
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1	--报告降序排序号
;
-- 客户2023年以来是否有案件,是否失信限高
DROP   TABLE IF     EXISTS SJXQ_SJ2024091101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091101_CST_04 AS
SELECT  cst_id      --客户号|C20
    ,cort_rpt_id	--法院报告编号
    ,exe_nm	        --被执行人姓名
    ,exe_cas_id	    --执行案号
    ,hpn_dt         --发生日期|C14
    ,donur_ind      --失信标识|C4
    ,hi_csm_ind     --限制高消费标识|C4
    ,row_number() over(partition by cst_id order by hpn_dt desc) rn
from edw.dim_cst_out_cort_ful_inf_dd	--法院查询全量信息
where dt='@@{yyyyMMdd}' and nvl(cst_id,'')<>''
and hpn_dt>='20230101'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091101_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091101_CST_05 AS
SELECT  t1.col_1                          AS 序号
       ,t1.col_2                          AS 客户号
       ,t5.xpos_amt         AS 同一风险控制号下客户贷款敞口金额
       ,t2.cst_cr_grd_val                 AS 客户最新中征分
       ,t3.cred_busi_org_out_wjq          AS 授信机构数_不含未激活
       ,t3.oth_bank_busi_org_num          AS 他行授信机构数_不含未激活
       ,t3.oth_bank_loan_org_num          AS 他行贷款授信机构数
       ,t3.oth_bank_xfx_loan_org_num      AS 他行消费性贷款授信机构数
       ,t3.othr_bnk_mngmt_loan_org_num    AS 他行经营性贷款授信机构数
       ,t3.rem_house_loan_unsett_org_num  AS 除房贷外当前有余额的贷款机构数
       ,t3.cds                            AS 当前逾期
       ,t3.c_od_amt                       AS 当前逾期总额
       ,t3.c_od_total_amt                 AS 贷款当前逾期总额
       ,t3.late_2y_card_max_serial_od_num AS 近2年信用卡最大连续逾期月份数
       ,t3.late_6mon_enqu_count           AS 最近6个月审批查询次数
       ,t3.curr_unsett_fyh_loan_org_num   AS 当前未结清非银行贷款机构数
       ,t3.c_c_6m_avg_use_rate            AS 信用卡最近6个月平均透支率
       ,t3.cred_card_6m_use_rate          AS 最近6个月信用卡额度使用率_不含未激活
       ,t3.cred_card_num                  AS 信用卡张数
       ,t3.curr_bad_extguan_loan_amt      AS 当前非正常对外贷款担保金额
       ,t3.curr_bad_extguan_loan_num      AS 非正常贷款对外担保笔数
       ,t3.case_sts                       AS 法院执行案件状态
       ,t3.zxqu_l6m_cnt                   AS 最近6个月内查询次数
    ,t3.bal_zrr	            as 其他相关还款责任余额_借款人身份为自然人
    ,t3.bal_zzjg	            as 其他相关还款责任余额_借款人身份为组织机构
    ,t3.bal_zrr+t3.bal_zzjg as 其他相关还款责任余额汇总
       ,case when t4.cst_id is not null then '是' else '否' end as 2023年以来是否有案件
       ,t4.donur_ind                      AS 失信标识
       ,t4.hi_csm_ind                     AS 限制高消费标识
from SJXQ_SJ2024091101_CST_01         t1
left join SJXQ_SJ2024091101_CST_02    t2
on t1.col_2 = t2.cst_id
and t2.rn=1
left join SJXQ_SJ2024091101_CST_03    t3
on t1.col_2 = t3.cst_id
left join (
    SELECT cst_id
        ,max(donur_ind)     as donur_ind
        ,max(hi_csm_ind)    as hi_csm_ind
    from SJXQ_SJ2024091101_CST_04
    GROUP BY cst_id
)    t4
on t1.col_2 = t4.cst_id
left join(
    select cst_id,xpos_amt     --同一风险控制号下客户贷款敞口金额
    from adm_pub.adm_csm_crisk_sam_rsk_ctrl_inf_dd     --客户同一风险控制号信息
    where dt='@@{yyyyMMdd}'
)t5 on t1.col_2=t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024091101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091101_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091101_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024091101_CST_05
;
SELECT  *
from SJXQ_SJ2024091101_CST_05
***SJ2024091411_杭州分行隐患业务.sql
--栾成-隐患取数-同一风险控制号-统一授信额度等
-- SJ2024091411
--qbi_file_20240919_15_42_54
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --合同流水号
       ,col_3 --客户号
       ,col_4 --客户名称
       ,col_5 --担保分类
       ,col_6 --行业投向
from qbi_file_20240919_15_42_54
where pt<>''
;
-- select * from SJXQ_SJ2024091411_CST_02
-- 客户同一风险控制号总敞口
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_02 AS
SElECT t1.cst_id
    ,t2.sam_rsk_ctrl_id	    --同一风险控制号
    ,t2.xpos_amt	        --同一风险控制号下客户贷款敞口金额
    ,t3.sam_rsk_epsr_amt    --同一风险控制号下合同敞口金额
from(
    select distinct t3.cst_id
        ,case when nvl(t3.sam_rsk_ctrl_id,'')='' then t3.cst_id else t3.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    from SJXQ_SJ2024091411_CST_01       t1
    inner join edw.dws_cst_bas_inf_dd   t3
    on t1.col_3=t3.cst_id
    and t3.dt='@@{yyyyMMdd}'
)t1
left join adm_pub.adm_csm_crisk_sam_rsk_ctrl_inf_dd	t2 --客户同一风险控制号信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join(
    SElECT case when nvl(t3.sam_rsk_ctrl_id,'')='' then t3.cst_id else t3.sam_rsk_ctrl_id end sam_rsk_ctrl_id2
        ,sum(t1.ctr_epsr_amt) AS sam_rsk_epsr_amt	--合同敞口金额|decimal(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt='@@{yyyyMMdd}'
    and t2.PD_NM not regexp '信用卡'
    inner join edw.dws_cst_bas_inf_dd    t3
    on t1.cst_id=t3.cst_id
    and t3.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    GROUP BY sam_rsk_ctrl_id2
)t3 on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id2
;
-- 征信数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_03_1 AS
SELECT *
from(
    SELECT  t1.cst_id
            ,t1.report_dt
            ,t1.report_no
            ,t1.cred_card_use_frequ
            ,t1.min_rp_djk_num
            ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id ORDER BY  t1.report_dt DESC ) AS rn
    FROM edw.dws_cst_ccrc_idv_ind_inf_di    t1
    inner join(
        SELECT DISTINCT col_3 as cst_id
        from SJXQ_SJ2024091411_CST_01
    )     t2  on t1.cst_id=t2.cst_id
    WHERE dt >= '20150601'
)t1 where rn<=2
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_03_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_03_2 AS
SELECT *
from(
    SELECT  cst_id
        ,report_id
        ,dtrb_org            --金融机构名称
        ,pd_cd               --贷款类型
        ,ctr_bal             --贷款余额
        ,shd_pay_day         --应还款日期
        ,late_one_tm_rpay_dt --最近一次实际还款日期
        ,cur_mon_shd_rpay    --本月应还款金额
        ,cur_mon_actl_rpay   --本月实还款
        ,act_sts_cd          --账户状态
        ,rank() OVER ( PARTITION BY cst_id ORDER BY  report_id DESC ) AS rn
	FROM edw.dim_cst_ccrc_idv_loan_inf_dd --个人征信客户贷款信息
	WHERE dt = '@@{yyyyMMdd}'
	AND act_sts_cd = '1' --正常
	AND act_typ_cd IN ( 'R2' , 'R3' ) --账户类型非贷记卡账户（R2）准贷记卡账户（R3）
	AND ctr_bal > 0
	AND cur_mon_shd_rpay = cur_mon_actl_rpay
	AND cur_mon_actl_rpay > 0
)t1 where rn=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_03 AS
SELECT  t1.cst_id
       ,t1.report_dt ----最新简化征信报告日期
       ,CASE WHEN t2.report_dt <> '' THEN t2.report_dt  ELSE '0' END AS syq_report_dt ----上一期简化征信报告日期
       ,t1.report_no ----最新简化征信报告编号
       ,CASE WHEN t2.report_no <> '' THEN t2.report_no  ELSE '0' END AS syq_report_no ----上一期简化征信报告编号
       ,t1.cred_card_use_frequ                                       AS 最新征信报告信用卡使用率
       ,t2.cred_card_use_frequ                                       AS 次新征信报告信用卡使用率
       ,t1.min_rp_djk_num                                            AS 最新征信处于最低还款状态的贷记卡账户数
       ,CASE WHEN t3.cst_id <> '' THEN '是'  ELSE '否' END           AS is_fq_djk --最新简化征信报告贷记卡是否分期存在&ldquo;是&rdquo;
        ,CASE
           WHEN t4.mar_status = '10' THEN '未婚'
           WHEN t4.mar_status = '20' THEN '已婚'
           WHEN t4.mar_status = '21' THEN '初婚'
           WHEN t4.mar_status = '22' THEN '再婚'
           WHEN t4.mar_status = '23' THEN '复婚'
           WHEN t4.mar_status = '30' THEN '丧偶'
           WHEN t4.mar_status = '40' THEN '离婚'
           WHEN t4.mar_status = '90' THEN '未说明的婚姻状况'
         END                                                                               AS 最新征信报告婚姻状态
        ,CASE
           WHEN t5.mar_status = '10' THEN '未婚'
           WHEN t5.mar_status = '20' THEN '已婚'
           WHEN t5.mar_status = '21' THEN '初婚'
           WHEN t5.mar_status = '22' THEN '再婚'
           WHEN t5.mar_status = '23' THEN '复婚'
           WHEN t5.mar_status = '30' THEN '丧偶'
           WHEN t5.mar_status = '40' THEN '离婚'
           WHEN t5.mar_status = '90' THEN '未说明的婚姻状况'
         END                                                                               AS 次新征信报告婚姻状态
FROM SJXQ_SJ2024091411_CST_03_1         t1
LEFT JOIN SJXQ_SJ2024091411_CST_03_1    t2
ON t1.cst_id = t2.cst_id
and t2.rn=2
LEFT JOIN (
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024091411_CST_03_2
) t3
ON t1.cst_id = t3.cst_id
LEFT JOIN
(
	SELECT  report_id
	       ,mar_status
	FROM edw.ncip_pb02_marriageinf
	WHERE dt >= '20150601'
) t4
ON t1.report_no = t4.report_id
LEFT JOIN
(
	SELECT  report_id
	       ,mar_status
	FROM edw.ncip_pb02_marriageinf
	WHERE dt >= '20150601'
) t5
ON t2.report_no = t5.report_id
WHERE t1.rn = 1
;
-- 近6月日均存款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_04 AS
SElECT t1.cst_id
    ,nvl(t2.客户近6个月存款日均,0) as 客户近6个月存款日均
from (
    SELECT DISTINCT col_3 as cst_id
    from SJXQ_SJ2024091411_CST_01
) t1
left join(
    SELECT  cst_id
            ,SUM(last_180_days_gl_bal_acml) / 180 AS 客户近6个月存款日均
    FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
    WHERE   DT = '@@{yyyyMMdd}'
    GROUP BY cst_id
)t2 on t1.cst_id=t2.cst_id
;
-- 合同最终审批人角色（例：团队负责人、支行行长、分行小企业总经理）
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_05 AS
SElECT t1.ctr_serno
    ,t2.USC_APLY_SERNO
    ,t3.biz_id
    ,t4.INSTANCE_ID
    ,t4.ROLE_ID
    ,t4.node_nm	        --节点名称
    ,t4.user_comment    --用户评价
    ,t4.comment_sign	--用户结论
    ,row_number() over(partition by t1.ctr_serno order by t4.START_TIME desc) rn
from  edw.DIM_BUS_LOAN_CTR_BSE_INF_DD	        t1 --合同基础信息
left join edw.dwd_bus_loan_lmt_aply_biz_dd      t2
on t1.rel_serno=t2.USC_APLY_SERNO
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_n_wf_instance_his_dd t3 --流程运行实例历史表
on t2.AHN_LTR_APLY_SERNO=t3.biz_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_n_wf_comment_his_dd  t4 --流程审批意见历史
on t3.INSTANCE_ID=t4.INSTANCE_ID
and t4.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.REG_TYP_cd = '01'
and t1.ctr_serno in (
    SElECT distinct col_2
    from SJXQ_SJ2024091411_CST_01
)
;
/*
select ROLE_ID as 角色
from edw.loan_n_wf_comment_his nwch
where INSTANCE_ID = (
    SELECT  INSTANCE_ID
    FROM edw.loan_n_wf_instance_his nwi
    WHERE biz_id = (
        SELECT  lab.AHN_LTR_APLY_SERNO
        FROM    edw.loan_ctr_bse_inf cbi
        JOIN    edw.loan_lmt_aply_biz lab
        ON      lab.USC_APLY_SERNO = cbi.REL_SERNO
        WHERE   cbi.CTR_SERNO = '合同号'
        AND     cbi.REG_TYP = '01'
    )
)
ORDER BY START_TIME DESC
LIMIT 1;
    ,t5.aprv_empe_nm as 最终审批人
    ,t5.aprv_level_nm as 最终审批人角色
left join adm_rsk.adm_rsk_ast_ast_aprv_prcs_task_dd as t5
    on t1.busi_apl_id = t5.apl_srl_no
      and t1.dt = t5.dt
      and t5.is_final_aprv = '1'
*/
-- 最终审批人批复意见 --增加最终审批人续贷前批复意见
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_06 AS
SElECT t1.ctr_serno
    ,t2.rel_serno
    ,t2.RPAY_PRCP_SETL_INTR_MOD_CD	--还本结息方式代码
    ,c1.cd_val_dscr     as RPAY_PRCP_SETL_INTR_MOD_nm --还本结息方式
    -- ,t3.serialno
    -- ,t4.decrible        as 最终审批人续贷前批复意见
    -- ,T5.FNL_APV_ID
    -- ,T5.FNL_APV_NM   --最终审批人
from(
    SElECT distinct col_2 as ctr_serno
    from SJXQ_SJ2024091411_CST_01
)t1 left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD	t2 --合同基础信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
-- left join(
--     SELECT  ft.objectno
--             ,max(ft.serialno) AS serialno
--     FROM    edw.loan_flow_task ft
--     WHERE   ft.dt = '@@{yyyyMMdd}'
--     AND     ft.objecttype = 'CreditApply'
--     AND     ft.phasetype = '1020'
--     GROUP BY ft.objectno
-- )t3 on t2.rel_serno=t3.objectno
-- left join edw.loan_approveopinion_info          t4
-- on t3.serialno=t4.relativeserialno
-- and t4.dt='@@{yyyyMMdd}'
-- and t4.RelativeObjectType = 'SignOpinion'
-- LEFT JOIN adm_pub.adm_rsk_bus_loan_mngmt_flow_mdl_dd t5 --风险集市信贷业务合同信息模型表
-- ON      t2.rel_serno = t5.busi_apl_id
-- AND     t5.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd               c1
on t2.RPAY_PRCP_SETL_INTR_MOD_CD = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_07 AS
SELECT  t1.col_1                        --序号
       ,t1.col_2                        --合同流水号
       ,t1.col_3                        --客户号
       ,t1.col_4                        --客户名称
       ,t1.col_5                        --担保分类
       ,t1.col_6                        --行业投向
       ,t2.xpos_amt                     --同一风险控制号下客户贷款敞口金额
       ,t2.sam_rsk_epsr_amt             --同一风险控制号下合同敞口金额
       ,t3.最新征信报告信用卡使用率
       ,t3.次新征信报告信用卡使用率
       ,t3.最新征信处于最低还款状态的贷记卡账户数
       ,t3.is_fq_djk                    --最新简化征信报告贷记卡是否分期存在&ldquo;是&rdquo;
       ,t3.最新征信报告婚姻状态
       ,t3.次新征信报告婚姻状态
       ,t4.客户近6个月存款日均
       ,t5.ROLE_ID
       ,t5.node_nm	        --节点名称
       ,t5.user_comment     --用户评价
       ,t5.comment_sign	    --用户结论
       ,t6.RPAY_PRCP_SETL_INTR_MOD_nm   --还本结息方式
    --    ,t6.最终审批人续贷前批复意见
       ,t7.age                          --客户年龄
from SJXQ_SJ2024091411_CST_01       t1
left join SJXQ_SJ2024091411_CST_02  t2
on t1.col_3=t2.cst_id
left join SJXQ_SJ2024091411_CST_03  t3
on t1.col_3=t3.cst_id
left join SJXQ_SJ2024091411_CST_04  t4
on t1.col_3=t4.cst_id
left join SJXQ_SJ2024091411_CST_05  t5
on t1.col_2=t5.ctr_serno and t5.rn=1
left join SJXQ_SJ2024091411_CST_06  t6
on t1.col_2=t6.ctr_serno
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t7 --对私客户基础信息
on t1.col_3=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091411_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091411_CST_08 AS
SELECT  col_1                      AS 序号
       ,col_2                      AS 合同流水号
       ,col_3                      AS 客户号
       ,col_4                      AS 客户名称
       ,col_5                      AS 担保分类
       ,col_6                      AS 行业投向
       ,sam_rsk_epsr_amt           AS 同一风险控制号下合同敞口金额
       ,最新征信报告信用卡使用率
       ,次新征信报告信用卡使用率
       ,最新征信处于最低还款状态的贷记卡账户数
       ,is_fq_djk                  AS 最新征信报告贷记卡是否分期
       ,最新征信报告婚姻状态
       ,次新征信报告婚姻状态
       ,客户近6个月存款日均
       ,RPAY_PRCP_SETL_INTR_MOD_nm AS 还本结息方式
       ,t5.node_nm                 AS 节点名称
       ,t5.user_comment            AS 用户评价
       ,t5.comment_sign            AS 用户结论
       ,age                        AS 客户年龄
from SJXQ_SJ2024091411_CST_07
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024091411_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091411_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091411_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091411_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091411_CST_05 where rn=1
union all
SElECT '06' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091411_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024091411_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024091411_CST_08
;
SElECT '08' seq, *
from SJXQ_SJ2024091411_CST_08
***SJ20240918101_台州分行异地贷款.sql
--江丽娜003943-台州分行异地贷款清单
-- SJ20240918101
-- 截至2024.9.18，有余额的异地贷款清单，台州分行
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20240918101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240918101_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率
    ,t1.usc_aply_dt	    --用信申请日期
    ,t1.reg_typ_cd	    --登记类型代码
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr     as bsn_mark_nm             --业务标识
    ,t1.hpn_typ_cd
    ,c2.cd_val_dscr     as hpn_typ_nm
    ,t1.mgr_id	        --管户人工号
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_opr_id	    --经办人工号
    ,t1.hdl_org_id      --经办机构编号
    ,t1.GRNT_MOD_COLC	--担保方式集合
    ,decode(t1.GRNT_MOD_COLC,'005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池','') as GRNT_MOD_COLC_nm --担保方式
    ,t1.cpt_usg_cd	--资金用途代码|c4
    ,c4.cd_val_dscr     as cpt_usg_nm
    ,t1.cpt_usg_rmk	--资金用途备注|c4000
    ,t1.RVLG_TYP_CD	--循环类型代码
    ,c5.cd_val_dscr     as RVLG_TYP_nm
    ,t1.DIF_PLC_BSN_IND	--乡情贷业务标志
    ,t1.prcp_setl_dt	--本金结清日期|c8
    ,t1.PRD_TAG	--产品标签编号集合 营销标签代码
    ,t2.pd_nm           --业务品种
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
    ,t6.org_nm  as hdl_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm='台州分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t1.hdl_org_id = t6.org_id
and t6.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.hpn_typ_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON  t1.cpt_usg_cd = C4.CD_VAL
AND C4.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C5
ON  t1.RVLG_TYP_CD = C5.CD_VAL
AND C5.DT = '@@{yyyyMMdd}'
where t1.dt='20240918'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 行业投向
DROP   TABLE IF     EXISTS SJXQ_SJ20240918101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240918101_CST_02 AS
SELECT  t1.cst_id
       ,t2.cst_chn_nm  --客户姓名
       ,t2.idt_cd      --行业代码
       ,c1.cd_val_dscr AS 行业投向一级大类
       ,c2.cd_val_dscr AS 行业投向二级大类
       ,c3.cd_val_dscr AS 行业投向小类
from(
    SElECT distinct cst_id
    from SJXQ_SJ20240918101_CST_01
)t1
LEFT JOIN edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20240918'
LEFT JOIN    edw.dwd_code_library_dd c1 --码值表
ON      SUBSTR(T2.idt_cd, 1, 1) = c1.cd_val
AND     c1.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     c1.fld_nm = 'IDT_CD'
AND     c1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd c2 --码值表
ON      SUBSTR(T2.idt_cd, 1, 3) = c2.cd_val
AND     c2.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     c2.fld_nm = 'IDT_CD'
AND     c2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd c3 --码值表
ON      T2.idt_cd = c3.cd_val
AND     c3.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     c3.fld_nm = 'IDT_CD'
AND     c3.DT = '@@{yyyyMMdd}'
;
-- 社区名称
DROP   TABLE IF     EXISTS SJXQ_SJ20240918101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240918101_CST_03 AS
SElECT t1.cst_id
    ,t6.sub_cmnt_id      AS 子社区编号
    ,t7.cmnt_nm          AS 社区名称
from(
    SElECT distinct cst_id
    from SJXQ_SJ20240918101_CST_01
)t1
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '20240918'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240918101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240918101_CST_04 AS
SELECT  '20240918'          AS 数据日期
       ,t1.ctr_serno        AS 合同流水号
       ,t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户名称
       ,t3.社区名称
       ,t2.行业投向一级大类
       ,t2.行业投向二级大类
       ,t2.idt_cd           AS 行业投向小类编码
       ,t2.行业投向小类
       ,t1.hpn_typ_nm       AS 发生类型
       ,t1.bsn_mark_nm      AS 业务标识
       ,T1.pd_nm            AS 业务品种
       ,t1.PRD_TAG          AS 产品标签编号集合_营销标签
       ,t1.RVLG_TYP_nm      AS 循环类型
       ,t1.ctr_amt          AS 合同金额
       ,t1.ctr_bal          AS 合同余额
       ,t1.exec_intr_rat    AS 执行利率
       ,t1.cpt_usg_nm       AS 资金用途代码
       ,t1.cpt_usg_rmk      AS 资金用途备注
       ,t1.ctr_bgn_dt       AS 合同起始日期
       ,t1.ctr_mtu_dt       AS 合同到期日期
       ,t1.GRNT_MOD_COLC_nm AS 担保方式集合
       ,t1.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t4.otherarealoan    AS 是否异地贷款
    --    ,t1.prcp_setl_dt     AS 本金结清日期
       ,CASE WHEN t5.dbil_bal_cny > 0 THEN '未结清'  ELSE '是' END AS 是否结清
       ,t1.mgr_org_id       AS 管户机构号
       ,t1.org_nm           AS 管户机构
       ,t1.mgr_id           AS 管户人工号
       ,t1.mgr_nm           AS 管户人
       ,t1.hdl_opr_id       AS 经办人工号
       ,t1.hdl_opr_nm       AS 经办人
       ,t1.hdl_org_id       AS 经办机构编号
       ,t1.hdl_org_nm       AS 经办机构
from SJXQ_SJ20240918101_CST_01       t1
left join SJXQ_SJ20240918101_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20240918101_CST_03  t3
on t1.cst_id=t3.cst_id
left join(
	SELECT  acct_num	--合同号
	FROM adm_upss.adm_upss_qd_ln_bal_dd
	WHERE dt = '20240918'
    group by acct_num
)t4 on t1.ctr_serno=t4.acct_num
LEFT JOIN    (
                 SELECT  cst_id
                         ,sum(dbil_bal_cny) AS dbil_bal_cny
                 FROM    adm_rsk.adm_rsk_apl_inter_all
                 WHERE   dt = '20240918'
                 GROUP BY cst_id
             ) t5
ON      t1.cst_id = t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240918101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240918101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240918101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240918101_CST_04
;
SElECT *
from SJXQ_SJ20240918101_CST_04
***SJ2024091816_丽水分行信贷工商数据.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_00 AS
SELECT  col_1 --序号
       ,col_2 --客户号
       ,col_3 --客户名称
-- from qbi_file_20240919_10_00_36
-- where pt<>''
;
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.reg_typ_cd	    --登记类型代码|c2
    ,t1.mgr_id	        --管户人工号|c10
    ,t1.mgr_org_id	    --管户机构号|c12
    ,t1.hdl_opr_id	    --经办人工号|c12
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='20240918'
and t1.cst_id in (select distinct col_2 from SJXQ_SJ2024091816_CST_00)
;
-- 外部工商数据 edw.NOUT_COMPANY_BASE   ---工商信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_02 AS
select t1.company_id                               --主体唯一键
	,t1.company_name                             --企业名称
	,t1.credit_no                                --统一信用代码
    ,t1.establish_date                           --成立日期
	,t1.legal_person                             --法定代表人
	,t1.company_address                          --地址
    ,t1.business_scope                           --经营范围
	,t1.legal_person_type                        --法人类型，0自然人，1非自然人
	,t1.legal_person_id                          --法人ID
    ,t3.cst_id	--客户号|C20
    ,t3.cst_nm	--客户名称|C200
from edw.nout_company_base              t1 --企业基本信息表
inner join edw.dim_cst_entp_bas_inf_dd	t3 --企业客户基本信息
on t1.credit_no=t3.lctax_cert_no	--地税证件号
and t3.dt='20240918'
where t1.dt='20240918'
and nvl(t1.credit_no,'')<>''
-- and substr(t1.credit_no,3,4) = '3310'    --台州
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_03 AS
SELECT  A.cst_id      --客户号
       ,A.cst_nm      --客户名称
       ,A.csld_crd_cd --关联企业统一社会信用代码
       ,A.idt_nm      --关联企业行业
       ,A.entp_nm     --关联企业名称
       ,A.entp_sts    --关联企业状态
       ,A.set_up_tm   --成立时间
       ,A.pvc	        --省份|C300
       ,'' ctrb_rto
       ,'法人'          AS CST_TY
FROM    edw.dim_cst_out_geb_idv_lgp_inf_dd A --工商个人人员法人信息
WHERE   A.DT = '20240918'
AND     NVL(A.csld_crd_cd, '') <> ''
UNION
SELECT  B.cst_id      --客户号
       ,B.cst_nm      --客户名称
       ,B.csld_crd_cd --关联企业统一社会信用代码
       ,B.idt_nm      --关联企业行业
       ,B.entp_nm     --关联企业名称
       ,B.entp_sts    --关联企业状态
       ,B.set_up_tm   --成立时间
       ,B.pvc	        --省份|C300
       ,B.ctrb_rto    --出资比例
       ,'股东'          AS CST_TY --关联关系
FROM    edw.dim_cst_out_geb_idv_shh_inf_dd B --工商个人人员股东信息
WHERE   B.DT = '20240918'
AND     NVL(B.csld_crd_cd, '') <> ''
;
--工商查询企业基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_04 AS
select cst_id                                   --客户号|C20
	,cst_nm                                   --客户名称|C600
	,csld_crd_cd                              --统一信用代码|C100
	,adr                                      --住址|C2000
	,rsd_cur_dtrct_dvd                        --住所所在行政区划|C50
	,opr_sts                                  --经营状态|C50
	,found_dt                                 --成立日期|C50
	,lgl_rprs                                 --法定代表人/负责人/执行事务合伙人|C300
	,entp_id                                  --企业ID|C100
	,idt_cd                                   --国民经济行业代码|C50
	,cd_nm                                    --国民经济代码名称|C100
	,reg_instt                                --登记机关|C300
	,cur_cty                                  --所在城市|C100
	,reg_adr_adm_id                           --注册地址行政编号|C50
	,cur_cnr                                  --所在区/县|C100
	,pvc                                      --所在省份|C50
	,rvk_dt                                   --吊销日期|C50
	,opr_bus_scp                              --经营业务范围|C4000
    ,ROW_NUMBER() OVER ( PARTITION BY csld_crd_cd ORDER BY qry_tm DESC) RN
from edw.dim_cst_out_geb_bas_inf_dd           --工商查询企业基本信息
where dt='20240918'
;
--信贷客户经营基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_05 AS
SELECT  t1.cst_id
       ,t1.opr_prj_nm      --经营项目
       ,t2.OPR_PLC_AREA --经营场所面积
FROM edw.DIM_CST_ASST_FIN_OPR_BSC_DD	t1 --经营基本信息
left join (
    SElECT cst_id
    from edw.DIM_CST_ASST_FIN_OPR_PLC_DD	--经营场地信息
    where dt= '20240918'
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
WHERE   t1.DT = '20240918'
;
/*
-- 老信贷
SELECT  cst_id
       ,opr_prj      --经营项目
       ,year_rnt_amt --年租金
       ,unt_nm       --单位名称
       ,hld_shr_rto  --持股比例
       ,opr_atb_area --经营场所面积
       ,opr_bgn_day  --经营起始日
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY srl_nbr DESC ) RN
FROM    edw.dim_cst_asst_crd_cst_opr_bas_situ_dd --信贷客户经营基本信息
WHERE   DT = '20240918'
;
*/
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_06 AS
SElECT t1.col_1,t1.col_2,t1.col_3
    ,t2.ctr_amt,t2.ctr_bal,t2.mgr_org_id,t2.org_nm,t2.mgr_id,t2.mgr_nm
    -- ,t3.idt_cd
    -- ,c1.cd_val_dscr     as idt_1
    -- ,c2.cd_val_dscr     as idt_2
    -- ,c3.cd_val_dscr     as idt_3
    -- ,c4.cd_val_dscr     as idt_nm
    ,T5.CST_TY       --工商关联关系
    ,T5.csld_crd_cd  --工商关联企业统一信用代码
    ,T5.entp_nm      --工商关联企业名称
    ,T5.set_up_tm    --工商工商关联企业成立日期
    ,t5.ctrb_rto     --出资比例
    ,T6.opr_bus_scp  --工商关联企业经营业务范围
    ,T6.pvc                                      --所在省份|C50
    ,T6.cur_cty                                  --所在城市|C100
    ,T6.cur_cnr                                  --所在区/县|C100
    ,T6.cd_nm        --行业类型
    ,T7.opr_prj_nm      --信贷经营项目
    ,T7.OPR_PLC_AREA --信贷经营场所面积
from SJXQ_SJ2024091816_CST_00       t1
left join(
    SElECT mgr_org_id,org_nm,mgr_id,mgr_nm,cst_id
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
    from SJXQ_SJ2024091816_CST_01
    group by mgr_org_id,org_nm,mgr_id,mgr_nm,cst_id
)t2 on t1.col_2=t2.cst_id
-- left join edw.dws_cst_bas_inf_dd    T3 --客户基础信息汇总表
-- on t1.col_2=t3.cst_id
-- and t3.dt='20240918'
-- left join edw.dwd_code_library_dd       c1
-- ON substr(t3.idt_cd,1,1) = C1.CD_VAL
-- AND C1.DT='20240918'
-- left join edw.dwd_code_library_dd       C2
-- ON substr(t3.idt_cd,1,3) = C2.CD_VAL
-- AND C2.DT='20240918'
-- left join edw.dwd_code_library_dd       C3
-- ON substr(t3.idt_cd,1,4) = C3.CD_VAL
-- AND C3.DT='20240918'
-- left join edw.dwd_code_library_dd       C4
-- ON t3.idt_cd = C4.CD_VAL
-- AND C4.DT='20240918'
LEFT JOIN SJXQ_SJ2024091816_CST_03  T5
ON T1.col_2 = T5.cst_id            --查询给定个人客户的工商数据
LEFT JOIN SJXQ_SJ2024091816_CST_04  T6
ON T5.csld_crd_cd = T6.csld_crd_cd  --查询给定企业客户的工商数据
AND T6.RN = 1
LEFT JOIN SJXQ_SJ2024091816_CST_05  T7
ON T1.col_2 = T7.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091816_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091816_CST_07 AS
SELECT  col_1        AS 序号
       ,col_2        AS 客户号
       ,col_3        AS 客户名称
       ,ctr_amt      AS 截至9月18日我行授信金额
       ,ctr_bal      AS 截至9月18日我行授信余额
       ,mgr_org_id   AS 管户机构号
       ,org_nm       AS 管户机构名称
       ,mgr_id       AS 管户客户经理工号
       ,mgr_nm       AS 管户客户经理姓名
       ,entp_nm      AS 工商关联企业名称
       ,csld_crd_cd  AS 工商关联企业统一信用代码
       ,pvc          AS 注册地址所在省份
       ,cur_cty      AS 注册地址所在城市
       ,cur_cnr      AS 注册地址所在区县
       ,set_up_tm    AS 工商工商关联企业成立日期
       ,opr_bus_scp  AS 工商关联企业经营业务范围
       ,cd_nm        AS 国民经济行业代码名称
       ,opr_prj_nm      AS 信贷经营项目
       ,OPR_PLC_AREA AS 信贷经营场所面积
from SJXQ_SJ2024091816_CST_06
;
SElECT '00' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024091816_CST_00
union all
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091816_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct credit_no) custs
from SJXQ_SJ2024091816_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091816_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct csld_crd_cd) custs
from SJXQ_SJ2024091816_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091816_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024091816_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024091816_CST_07
;
SElECT '07' seq, *
from SJXQ_SJ2024091816_CST_07
***SJ2024091891_台州分行信贷业务审批.sql
/*SJ2024091891  台州分行2024年6月后审批的所有业务
数据需求字段
合同流水号、预评估结果（通过、未通过、上诉通过、抗辩通过、抗辩未通过）、分支行业务最终审批人工号、分支行业务最终审批人姓名
*/
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024091891_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091891_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.reg_typ_cd	    --登记类型代码|c2
    ,t1.mgr_id	        --管户人工号|c10
    ,t1.mgr_org_id	    --管户机构号|c12
    ,t1.hdl_opr_id	    --经办人工号|c12
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm='台州分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.cst_id in (select distinct col_2 from SJXQ_SJ2024091816_CST_00)
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091891_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091891_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '@@{yyyyMMdd}'
)t1 LEFT JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '@@{yyyyMMdd}'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '@@{yyyyMMdd}'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.rn=1
;
-- 合同最终审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2024091891_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091891_CST_03 AS
SElECT t1.ctr_serno
    ,t2.USC_APLY_SERNO
    ,t3.biz_id
    ,t4.INSTANCE_ID
    ,t4.user_id	        --用户id|c32
    ,t4.ROLE_ID
    ,substr(replace(t4.START_TIME,'/',''),1,8) apv_dt
    ,t4.node_nm	        --节点名称
    ,t4.user_comment    --用户评价
    ,t4.comment_sign	--用户结论
    ,t5.empe_nm         fnl_apv_nm
    ,row_number() over(partition by t1.ctr_serno order by t4.START_TIME desc) rn
from  edw.DIM_BUS_LOAN_CTR_BSE_INF_DD	        t1 --合同基础信息
inner join edw.dwd_bus_loan_lmt_aply_biz_dd      t2
on t1.rel_serno=t2.USC_APLY_SERNO
and t2.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_loan_n_wf_instance_his_dd t3 --流程运行实例历史表
on t2.AHN_LTR_APLY_SERNO=t3.biz_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_loan_n_wf_comment_his_dd  t4 --流程审批意见历史
on t3.INSTANCE_ID=t4.INSTANCE_ID
and t4.dt='@@{yyyyMMdd}'
and substr(replace(t4.START_TIME,'/',''),1,8) >='20240601'
left join edw.dws_hr_empe_inf_dd                t5 --员工信息汇总
on  substr(t4.user_id,1,6)=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.REG_TYP_cd = '01'
and t1.ctr_serno in (
    SElECT distinct ctr_serno
    from SJXQ_SJ2024091891_CST_01
)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024091891_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091891_CST_04 AS
SELECT  t1.ctr_serno
from SJXQ_SJ2024091891_CST_01           t1
left join adm_pub.adm_rsk_app_inter_all	t2 --风险集市应用表-资产质量日常监测源表
on t1.ctr_serno=t2.ctr_srl_no
and t2.dt='@@{yyyyMMdd}'
group by t1.ctr_serno
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091891_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091891_CST_05 AS
SELECT  t1.ctr_serno       AS 合同流水号
       ,t1.ctr_bgn_dt      AS 合同起始日期
       ,t1.ctr_mtu_dt      AS 合同到期日期
       ,t2.rul_set_rslt_nm AS 新预评估结果
       ,t3.apv_dt          AS 审批日期
       ,t3.user_id         AS 最终审批人工号
       ,t3.fnl_apv_nm      AS 最终审批人姓名
from SJXQ_SJ2024091891_CST_01       t1
left join SJXQ_SJ2024091891_CST_02  t2
on t1.cst_id=t2.cst_id
inner join SJXQ_SJ2024091891_CST_03 t3
on t1.ctr_serno=t3.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091891_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091891_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091891_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091891_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024091891_CST_05
;
SElECT '05' seq, *
from SJXQ_SJ2024091891_CST_05
***SJ2024091911_黄岩支行信贷数据.sql
--陶丹佳007779-经营地址所在省市区
-- SJ2024091911
-- 截止2023年8月底数据和截止2024年9月底数据：
-- 黄岩头陀小微综合支行、黄岩北洋小微企业专营支行，信贷业务未结清（包括合同有效但无余额）的异地客户，需包含地址省市区县、行业投向、利率等。
-- 20230831
DROP   TABLE IF     EXISTS SJXQ_SJ2024091911_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091911_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.reg_typ_cd	    --登记类型代码|c2
    ,c3.cd_val_dscr     as reg_typ_nm
    ,t1.mgr_id	        --管户人工号|c10
    ,t1.mgr_org_id	    --管户机构号|c12
    ,t1.inv_in_indy_cd	--投向行业代码|c5
    ,c1.cd_val_dscr     as inv_in_indy_nm
    ,t1.hdl_opr_id	    --经办人工号|c12
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.inv_in_indy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t1.reg_typ_cd = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.ctr_bgn_dt<='20230831'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 经营地址
DROP   TABLE IF     EXISTS SJXQ_SJ2024091911_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091911_CST_02 AS
SELECT  T1.CST_ID        --客户号
       ,T2.CTY_LVL_ID_CD AS native_cty_cd
       ,C1.CD_VAL_DSCR   AS 户籍地所在市
       ,T2.CNR_LVL_ID_CD AS native_CNR_cd
       ,C2.CD_VAL_DSCR   AS 户籍地所在区县
       ,T3.PVC_LVL_ID_CD AS opr_pvc_cd
       ,C3.CD_VAL_DSCR   AS 经营地所在省
       ,T3.CTY_LVL_ID_CD AS opr_cty_cd
       ,C4.CD_VAL_DSCR   AS 经营地所在市
       ,T3.CNR_LVL_ID_CD AS opr_cnr_cd
       ,C5.CD_VAL_DSCR   AS 经营地所在区县
       ,T9.CMNT_NM       AS 子社区名称
       ,T10.CD_VAL_DSCR  AS 所属行业
FROM (
    SELECT distinct CST_ID
    FROM SJXQ_SJ2024091911_CST_01
)T1 LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD    T2 --客户物理地址信息
ON T1.CST_ID = T2.CST_ID
AND T2.DT = '20230831'
AND T2.PHY_ADR_TYP_CD = '050100' --户籍地址
LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD T3 --客户物理地址信息
ON T1.CST_ID = T3.CST_ID
AND T3.DT = '20230831'
AND T3.PHY_ADR_TYP_CD = '050900' --经营所在地地址
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1 -- 码值表
ON T2.CTY_LVL_ID_CD = C1.CD_VAL
AND C1.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C1.FLD_NM = 'CTY_DTRCT_DVD_CD' --市
AND C1.DT = '20230831'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C2 -- 码值表
ON T2.CNR_LVL_ID_CD = C2.CD_VAL
AND C2.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C2.FLD_NM = 'AREA_OR_CNR_DTRCT_DVD_CD' --区县
AND C2.DT = '20230831'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C3 -- 码值表
ON T3.PVC_LVL_ID_CD = C3.CD_VAL
AND C3.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C3.FLD_NM = 'PVC_OR_MNCP_DTRCT_DVD_CD' --省或直辖市
AND C3.DT = '20230831'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C4 -- 码值表
ON T3.CTY_LVL_ID_CD = C4.CD_VAL
AND C4.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C4.FLD_NM = 'CTY_DTRCT_DVD_CD' --市
AND C4.DT = '20230831'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C5 -- 码值表
ON T3.CNR_LVL_ID_CD = C5.CD_VAL
AND C5.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C5.FLD_NM = 'AREA_OR_CNR_DTRCT_DVD_CD' --区县
AND C5.DT = '20230831'
LEFT JOIN EDW.DWS_CST_BAS_INF_DD T8 --客户基础信息汇总表
ON T1.cst_id = T8.CST_ID
AND T8.DT = '20230831'
LEFT JOIN EDW.DIM_CST_MNG_CMNT_INF_DD T9 --社区信息
ON T8.SUB_CMNT_ID = T9.CMNT_ENC
AND T9.DT = '20230831'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD T10 -- 码值表
ON T8.IDT_CD = T10.CD_VAL
AND T10.TBL_NM = 'DWS_CST_BAS_INF_DD'
AND T10.FLD_NM = 'IDT_CD'
AND T10.DT = '20230831'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091911_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091911_CST_03 AS
SELECT  t1.ctr_serno     AS 合同流水号
       ,t1.cst_id        AS 客户号
       ,t1.cst_nm        AS 客户名称
       ,t1.ctr_amt       AS 合同金额
       ,t1.ctr_bal       AS 合同余额
       ,t1.ctr_bgn_dt    AS 合同起始日期
       ,t1.ctr_mtu_dt    AS 合同到期日期
       ,t1.exec_intr_rat AS 执行利率
       ,t1.inv_in_indy_nm AS 行业投向
       ,substr(t3.wrk_adr,1,12) as 经营所在地地址
       ,t2.经营地所在省
       ,t2.经营地所在市
       ,t2.经营地所在区县
       ,t1.mgr_id        AS 管户人工号
       ,t1.mgr_nm        AS 管户人姓名
       ,t1.mgr_org_id    AS 管户机构号
       ,t1.hdl_opr_nm    AS 经办人姓名
       ,t1.sbr_org_nm    AS 管户支行
from SJXQ_SJ2024091911_CST_01           t1
left join SJXQ_SJ2024091911_CST_02	    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd	t3
on t1.cst_id=t3.cst_id
and t3.dt='20230831'
;
-- 20240919
DROP   TABLE IF     EXISTS SJXQ_SJ2024091911_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091911_CST_04 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.reg_typ_cd	    --登记类型代码|c2
    ,c3.cd_val_dscr     as reg_typ_nm
    ,t1.mgr_id	        --管户人工号|c10
    ,t1.mgr_org_id	    --管户机构号|c12
    ,t1.inv_in_indy_cd	--投向行业代码|c5
    ,c1.cd_val_dscr     as inv_in_indy_nm
    ,t1.hdl_opr_id	    --经办人工号|c12
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.inv_in_indy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t1.reg_typ_cd = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 经营地址行政区划
DROP   TABLE IF     EXISTS SJXQ_SJ2024091911_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091911_CST_05 AS
SELECT  T1.CST_ID        --客户号
       ,T2.CTY_LVL_ID_CD AS native_cty_cd
       ,C1.CD_VAL_DSCR   AS 户籍地所在市
       ,T2.CNR_LVL_ID_CD AS native_CNR_cd
       ,C2.CD_VAL_DSCR   AS 户籍地所在区县
       ,T3.PVC_LVL_ID_CD AS opr_pvc_cd
       ,C3.CD_VAL_DSCR   AS 经营地所在省
       ,T3.CTY_LVL_ID_CD AS opr_cty_cd
       ,C4.CD_VAL_DSCR   AS 经营地所在市
       ,T3.CNR_LVL_ID_CD AS opr_cnr_cd
       ,C5.CD_VAL_DSCR   AS 经营地所在区县
       ,T9.CMNT_NM       AS 子社区名称
       ,T10.CD_VAL_DSCR  AS 所属行业
FROM (
    SELECT distinct CST_ID
    FROM SJXQ_SJ2024091911_CST_04
)T1 LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD    T2 --客户物理地址信息
ON T1.CST_ID = T2.CST_ID
AND T2.DT = '@@{yyyyMMdd}'
AND T2.PHY_ADR_TYP_CD = '050100' --户籍地址
LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD T3 --客户物理地址信息
ON T1.CST_ID = T3.CST_ID
AND T3.DT = '@@{yyyyMMdd}'
AND T3.PHY_ADR_TYP_CD = '050900' --经营所在地地址
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1 -- 码值表
ON T2.CTY_LVL_ID_CD = C1.CD_VAL
AND C1.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C1.FLD_NM = 'CTY_DTRCT_DVD_CD' --市
AND C1.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C2 -- 码值表
ON T2.CNR_LVL_ID_CD = C2.CD_VAL
AND C2.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C2.FLD_NM = 'AREA_OR_CNR_DTRCT_DVD_CD' --区县
AND C2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C3 -- 码值表
ON T3.PVC_LVL_ID_CD = C3.CD_VAL
AND C3.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C3.FLD_NM = 'PVC_OR_MNCP_DTRCT_DVD_CD' --省或直辖市
AND C3.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C4 -- 码值表
ON T3.CTY_LVL_ID_CD = C4.CD_VAL
AND C4.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C4.FLD_NM = 'CTY_DTRCT_DVD_CD' --市
AND C4.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C5 -- 码值表
ON T3.CNR_LVL_ID_CD = C5.CD_VAL
AND C5.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
AND C5.FLD_NM = 'AREA_OR_CNR_DTRCT_DVD_CD' --区县
AND C5.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWS_CST_BAS_INF_DD T8 --客户基础信息汇总表
ON T1.cst_id = T8.CST_ID
AND T8.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_CST_MNG_CMNT_INF_DD T9 --社区信息
ON T8.SUB_CMNT_ID = T9.CMNT_ENC
AND T9.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD T10 -- 码值表
ON T8.IDT_CD = T10.CD_VAL
AND T10.TBL_NM = 'DWS_CST_BAS_INF_DD'
AND T10.FLD_NM = 'IDT_CD'
AND T10.DT = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024091911_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024091911_CST_06 AS
SELECT  t1.ctr_serno      AS 合同流水号
       ,t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.ctr_amt        AS 合同金额
       ,t1.ctr_bal        AS 合同余额
       ,t1.ctr_bgn_dt     AS 合同起始日期
       ,t1.ctr_mtu_dt     AS 合同到期日期
       ,t1.exec_intr_rat  AS 执行利率
       ,t1.inv_in_indy_nm AS 投向行业
       ,substr(t3.wrk_adr,1,12) as 经营所在地地址
       ,t2.经营地所在省
       ,t2.经营地所在市
       ,t2.经营地所在区县
       ,t1.mgr_id         AS 管户人工号
       ,t1.mgr_nm         AS 管户人姓名
       ,t1.mgr_org_id     AS 管户机构号
       ,t1.hdl_opr_nm     AS 经办人姓名
       ,t1.sbr_org_nm     AS 管户支行
from SJXQ_SJ2024091911_CST_04       t1
left join SJXQ_SJ2024091911_CST_05	t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd	t3
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091911_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091911_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024091911_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024091911_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024091911_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024091911_CST_06
;
SElECT '03' seq, concat(客户号,'%'),*
from lab_bigdata_dev.SJXQ_SJ2024091911_CST_03
;
SElECT '06' seq, concat(客户号,'%'),*
from lab_bigdata_dev.SJXQ_SJ2024091911_CST_06
;
SElECT '03' seq, count(1) cnt
from lab_bigdata_dev.SJXQ_SJ2024091911_CST_03
where 执行利率=0
;
SElECT '06' seq, count(1) cnt
from lab_bigdata_dev.SJXQ_SJ2024091911_CST_06
where 执行利率=0
;
***SJ2024092011_绍兴分行第四期举一反三.sql
--陈贝贝-绍兴分行举一反三
-- SJ2024092011
/*
-- 主维护人、定人、关键人 啥关系？ 关键人是客户。其他为客户经理
-- 客户为经办客户经理定人子社区外客户？ 客户为非定人子社区
-- 资金往来，多长时间？暂定1年
*/
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_01 AS
select t1.ctr_serno     --合同流水号
    ,t1.REL_SERNO
	,t1.cst_id          --客户号
	,t1.cst_nm          --客户名称
	,t1.ctr_amt         --合同金额
	,t1.ctr_bal         --合同余额
	,t1.ctr_bgn_dt      --合同起始日期
	,t1.ctr_mtu_dt      --合同到期日期
    ,t1.TMT_DT	        --终结日期
    ,t1.exec_intr_rat	--执行利率
    ,t1.usc_aply_dt	    --用信申请日期
    ,t1.reg_typ_cd	    --登记类型代码
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr     as bsn_mark_nm --业务标识
    ,t1.hpn_typ_cd
    ,c2.cd_val_dscr     as hpn_typ_nm
    ,t1.mgr_id	        --管户人工号
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_opr_id	    --经办人工号
    ,t1.hdl_org_id      --经办机构编号
    ,t1.GRNT_MOD_COLC	--担保方式集合
    ,decode(t1.GRNT_MOD_COLC,'005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池','') as GRNT_MOD_COLC_nm --担保方式
    ,t1.cpt_usg_cd	    --资金用途代码|c4
    ,c4.cd_val_dscr     as cpt_usg_nm
    ,t1.cpt_usg_rmk	    --资金用途备注|c4000
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c5.cd_val_dscr     as RVLG_TYP_nm
    ,t1.DIF_PLC_BSN_IND	--乡情贷业务标志 是否异地
    ,t1.prcp_setl_dt	--本金结清日期|c8
    ,t1.PRD_TAG	        --产品标签编号集合 营销标签代码
    ,t2.pd_nm           --业务品种
    ,t2.PRM_BUS_BRED_CTG	--主业务品种分类 业务类型
    ,c3.cd_val_dscr     as PRM_BUS_BRED_CTG_nm
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
    ,t6.org_nm  as hdl_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm='绍兴分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t1.hdl_org_id = t6.org_id
and t6.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.hpn_typ_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t2.PRM_BUS_BRED_CTG = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON  t1.cpt_usg_cd = C4.CD_VAL
AND C4.DT = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C5
ON  t1.RVLG_TYP_CD = C5.CD_VAL
AND C5.DT = '@@{yyyyMMdd}'
where t1.dt='20240831'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 一、客户来源集中
--客户子社区 是否为定人子社区
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_02 AS
SElECT t1.cst_id
    ,t3.prm_mgr_id
    ,t4.sub_cmnt_id
    ,t4.sub_cmnt_nm
    ,case when (t4.sub_cmnt_id is not null and t3.prm_mgr_id regexp t5.employ_no_dr ) then '是'
        when nvl(t4.sub_cmnt_id,'') = '' then '' else '否' end as 是否为定人子社区
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024092011_CST_01
)t1
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3 --客户`主管户`信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
---- 社区信息（仅看 普惠社区）
inner join edw.dwd_cst_mng_cmnt_rel_dd t4
on  t1.cst_id = t4.cst_id
and t4.dt ='@@{yyyyMMdd}'
and t4.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
---- 社区定人(普惠社区定人信息表) ---- 一个社区会有多个定人
left join
(
      select community_code
      from   edw.xwdt_etl_xw_community_per
      where  dt = '@@{yyyyMMdd}'
      and    is_main_person = '2'   ---- 1主维护人，2社区定人
      group by community_code
)t5 on t4.sub_cmnt_id = t5.community_code
;
-- 客户经营地址
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03 AS
SElECT t1.cst_id
    ,t2.ful_adr	    --完整地址
    ,t3.wrk_adr     --经营所在地地址
    ,case when nvl(t2.ful_adr,'')<>'' and t2.ful_adr=t3.wrk_adr then 1 else 0 end is_sam
from(
    SElECT distinct cst_id
    from SJXQ_SJ2024092011_CST_01
)t1
LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD T2 --客户物理地址信息
ON  T1.CST_ID = T2.CST_ID
AND T2.DT = '@@{yyyyMMdd}'
AND T2.PHY_ADR_TYP_CD = '050900' --经营所在地地址
left join edw.dws_cst_bas_inf_dd	    t3
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
;
-- 输出结果 1-2 客户经营地址一致
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_04 AS
SElECT t2.cst_id,t1.cst_id_sum
from (
    SElECT ful_adr,sum(cast(cst_id as int))  cst_id_sum
    from SJXQ_SJ2024092011_CST_03
    where nvl(ful_adr,'')<>''
    group by ful_adr
    having count(1) > 1
)t1 inner join SJXQ_SJ2024092011_CST_03 t2
on t1.ful_adr=t2.ful_adr
union
SElECT t2.cst_id,t1.cst_id_sum
from (
    SElECT wrk_adr,sum(cast(cst_id as int))  cst_id_sum
    from SJXQ_SJ2024092011_CST_03
    where nvl(wrk_adr,'')<>''
    group by wrk_adr
    having count(1) > 1
)t1 inner join SJXQ_SJ2024092011_CST_03 t2
on t1.wrk_adr=t2.wrk_adr
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_01_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_01_2 AS
SELECT  t2.ctr_serno        AS 合同流水号
       ,t2.cst_id           AS 客户号
       ,t2.cst_nm           AS 客户名称
       ,t2.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t2.cpt_usg_rmk      AS 资金用途备注
       ,t2.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t2.ctr_amt          AS 合同金额
       ,t2.ctr_bal          AS 合同余额
       ,t2.mgr_org_id       AS 管户机构号
       ,t2.org_nm           AS 管户机构
       ,t2.mgr_id           AS 管户人工号
       ,t2.mgr_nm           AS 管户人姓名
       ,t2.hdl_org_id       AS 经办机构编号
       ,t2.hdl_org_nm       AS 经办机构
       ,t2.hdl_opr_id       AS 经办人工号
       ,t2.hdl_opr_nm       AS 经办人姓名
       ,t4.ful_adr          AS 客户经营地址
       ,t4.wrk_adr          AS 经营所在地地址
       ,t3.sub_cmnt_nm      AS 客户所属子社区
       ,t1.cst_id_sum   as 同一经营地址客户号和
from SJXQ_SJ2024092011_CST_04       t1
inner join SJXQ_SJ2024092011_CST_01 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024092011_CST_02      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024092011_CST_03      t4
on t1.cst_id=t4.cst_id
;
-- 输出结果 1-4
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_01_4 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_01_4 AS
SELECT  t1.ctr_serno        AS 合同流水号
       ,t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户名称
       ,t1.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t1.cpt_usg_rmk      AS 资金用途备注
       ,t1.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t1.ctr_amt          AS 合同金额
       ,t1.ctr_bal          AS 合同余额
       ,t1.mgr_org_id       AS 管户机构号
       ,t1.org_nm           AS 管户机构
       ,t1.mgr_id           AS 管户人工号
       ,t1.mgr_nm           AS 管户人姓名
       ,t1.hdl_org_id       AS 经办机构编号
       ,t1.hdl_org_nm       AS 经办机构
       ,t1.hdl_opr_id       AS 经办人工号
       ,t1.hdl_opr_nm       AS 经办人姓名
       ,t4.ful_adr          AS 客户经营地址
       ,t4.wrk_adr          AS 经营所在地地址
       ,t2.sub_cmnt_nm      AS 客户所属子社区
from SJXQ_SJ2024092011_CST_01       t1
inner join SJXQ_SJ2024092011_CST_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024092011_CST_03  t4
on t1.cst_id=t4.cst_id
where t2.是否为定人子社区<>'是'
;
-- 二、担保集中
-- （1）担保人是支行关键人的业务;
-- 风险集市客户业务社区关键人信息表
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_10 AS
--业务类型1：普惠
SELECT  A.CMNT_ENC            AS CMNT_ID --社区编码
        ,A.CMNT_NM            AS CMNT_NM --社区名称
        ,A.KEY_CST_ID         AS MAIN_CST_ID --关键人客户号
        ,A.KEY_NM             AS MAIN_CST_NM --关键人名称
        ,A.GDR_CD             AS SEX_CD --性别代码
        ,A.BTH_DT             AS BIRTH_DATE --出生日期
        ,A.DOC_NBR            AS CTFC_ID --证件号码
        ,A.CTC_TEL            AS MAIN_PHONE --联系电话
        ,A.ADR                AS MAIN_ADDR --地址
        ,A.WTHR_OWN_CST       AS IS_OUR_BANK_CST --行内客户标识
        ,A.KEY_TYP_CD         AS MAIN_TYPE_CD --关键人类型代码
        ,A.KEY_SITU_CMT       AS MAIN_STN_EXPN --关键人情况说明
        ,A.RCM_CST_NBR        AS RCMD_CST_CNT --推荐客户数
        ,A.VLD_CST_NBR        AS VALID_CST_CNT --有效户数
        ,A.DEP_LOAN_SIZ       AS DEP_LOAN_SIZE --存贷规模
        ,A.PULL_IN_CST_ID_SET AS ACCS_CST_ID_SMR --引入客户号集合
        ,A.PULL_IN_CST_NM_SET AS ACCS_CST_NM_SMR --引入客户名称集合
        ,A.STS_CD             AS MAIN_STS_CD --状态代码
FROM    edw.DWD_CST_MNG_ICSV_CMNT_KEY_PSN_REL_INF_DD A --普惠社区关键人关联信息
WHERE   A.DT = '@@{yyyyMMdd}' --STS_CD: -1是删除，0是正常，1是退出
UNION
--业务类型2：小企业
SELECT  B.CMNT_ENC        AS CMNT_ID --社区编码
        ,B.CMNT_NM        AS CMNT_NM --社区名称
        ,B.KEY_CST_ID     AS MAIN_CST_ID --关键人客户号
        ,B.KEY_NM         AS MAIN_CST_NM --关键人名称
        ,B.GDR_CD         AS SEX_CD --性别代码
        ,B.BTH_DT         AS BIRTH_DATE --出生日期
        ,B.DOC_NBR        AS CTFC_ID --证件号码
        ,B.CTC_TEL        AS MAIN_PHONE --联系电话
        ,B.ADR            AS MAIN_ADDR --地址
        ,B.WTHR_OWN_CST   AS IS_OUR_BANK_CST --是否我行客户
        ,B.KEY_TYP        AS MAIN_TYPE_CD --关键人类型
        ,B.KEY_SITU_CMT   AS MAIN_STN_EXPN --关键人情况说明
        ,B.RCM_CST_NBR    AS RCMD_CST_CNT --推荐客户数
        ,B.VLD_CST_NBR    AS VALID_CST_CNT --有效户数
        ,B.DEP_LOAN_SIZ   AS DEP_LOAN_SIZE --存贷规模
        ,B.PULL_IN_CST_ID AS ACCS_CST_ID_SMR --引入客户号集合
        ,B.PULL_IN_CST_NM AS ACCS_CST_NM_SMR --引入客户名称
        ,B.STS_CMT        AS MAIN_STS_CD --状态说明
FROM    edw.DWD_CST_MNG_ENTP_CMNT_KEY_PSN_REL_INF_DD B --小企业社区关键人关联信息
WHERE   B.DT = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_02_1 AS
SELECT  t2.ctr_serno        AS 合同流水号
       ,t2.cst_id           AS 客户号
       ,t2.cst_nm           AS 客户名称
       ,t2.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t2.cpt_usg_rmk      AS 资金用途备注
       ,t2.ctr_amt          AS 合同金额
       ,t2.ctr_bal          AS 合同余额
       ,t2.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t2.mgr_org_id       AS 管户机构号
       ,t2.org_nm           as 管户机构
       ,t2.mgr_id           AS 管户人工号
       ,t2.mgr_nm           AS 管户人姓名
       ,t2.hdl_org_id       AS 经办机构编号
       ,t2.hdl_org_nm       AS 经办机构
       ,t2.hdl_opr_id       AS 经办人工号
       ,t2.hdl_opr_nm       AS 经办人姓名
from (
    select distinct t1.ctr_serno
    from SJXQ_SJ2024092011_CST_01           t1
    inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2  --担保人汇总信息
    ON  t1.ctr_serno=t2.bus_ctr_id              --业务合同编号
    and t2.dt = '@@{yyyyMMdd}'
    inner join SJXQ_SJ2024092011_CST_10     t3 --社区关键人
    on t2.wrnt_cst_id = t3.MAIN_CST_ID
)t1 inner join SJXQ_SJ2024092011_CST_01 t2
on t1.ctr_serno=t2.ctr_serno
;
-- （2）担保人为我行3个及以上客户担保的业务；
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_11 AS
select distinct t1.cst_id
    ,t2.wrnt_cst_id
    ,t2.wrnt_cst_nm
from SJXQ_SJ2024092011_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.ctr_serno=t2.bus_ctr_id           --业务合同编号
and t2.dt = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_02_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_02_2 AS
SELECT  t3.ctr_serno        AS 合同流水号
       ,t3.cst_id           AS 客户号
       ,t3.cst_nm           AS 客户名称
       ,t3.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t3.cpt_usg_rmk      AS 资金用途备注
       ,t3.ctr_amt          AS 合同金额
       ,t3.ctr_bal          AS 合同余额
       ,t3.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t3.mgr_org_id       AS 管户机构号
       ,t3.org_nm           AS 管户机构
       ,t3.mgr_id           AS 管户人工号
       ,t3.mgr_nm           AS 管户人姓名
       ,t3.hdl_org_id       AS 经办机构编号
       ,t3.hdl_org_nm       AS 经办机构
       ,t3.hdl_opr_id       AS 经办人工号
       ,t3.hdl_opr_nm       AS 经办人姓名
       ,t2.wrnt_cst_id      AS 担保人ID
       ,t2.wrnt_cst_nm      AS 担保人
from(
    select wrnt_cst_id
    from SJXQ_SJ2024092011_CST_11
    group by wrnt_cst_id
    having count(distinct cst_id)>=3    --3个及以上客户
)t1 inner join SJXQ_SJ2024092011_CST_11 t2
on t1.wrnt_cst_id=t2.wrnt_cst_id
inner join SJXQ_SJ2024092011_CST_01     t3
on t2.cst_id=t3.cst_id
;
-- 三、资金流向集中
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_29 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_29 AS
select a.cst_id
    ,a.cst_act_id
    ,a.dep_act_id
    ,b.dtl_seq_nbr	                        --明细序号
	,b.trx_dt                                   --交易日期|C8
	,b.crd_and_dbt_ind                          --借贷标志|C1
	,b.trx_amt                                  --交易金额|DECIMAL(21,2)
	,b.txt_code                                 --摘要代码|C10
	,b.smr_dscr                                 --摘要描述|C512
	,b.cnt_pty_cst_act_id                       --对方客户账号|C32
	,b.cnt_pty_act_nm                           --对方户名|c200
	,b.cmt                                      --备注|C200
	,b.act_nm                                   --账户名称|C200
	,b.bal_fld_nm                               --余额字段名称|C32
from (select distinct cst_id from SJXQ_SJ2024092011_CST_01) t0
inner join edw.dws_bus_dep_act_inf_dd       A
on t0.cst_id=a.CST_ID
and A.dt='@@{yyyyMMdd}'
inner join edw.DWD_BUS_DEP_BAL_CHG_DTL_DI   B
ON   A.DEP_ACT_ID=B.DEP_ACT_ID
AND  A.CST_ACT_ID=B.CST_ACT_ID
AND  B.dt<='@@{yyyyMMdd}'   --历史交易流水
;
-- 客户近1年资金交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_30 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_30 AS
select a.cst_id
    ,a.cst_act_id
    ,a.dep_act_id,a.dtl_seq_nbr
	,a.trx_dt                                   --交易日期|C8
	,a.crd_and_dbt_ind                          --借贷标志|C1
	,a.trx_amt                                  --交易金额|DECIMAL(21,2)
	,a.txt_code                                 --摘要代码|C10
	,a.smr_dscr                                 --摘要描述|C512
	,a.cnt_pty_cst_act_id                       --对方客户账号|C32
	,a.cnt_pty_act_nm                           --对方户名|c200
	,a.cmt                                      --备注|C200
	,a.act_nm                                   --账户名称|C200
	,a.bal_fld_nm                               --余额字段名称|C32
    ,c.cst_id	     as cnt_pty_cst_id          --客户编号|C20
    ,case when d.cst_id is not null then 1 else 0 end is_crdt_cst
    ,case when CONCAT(a.smr_dscr,a.cmt)  regexp  '手续费|借款' then 1 else 0 end is_keyword
    ,t4.job_unt_nm	--对方客户工作单位名称
    ,case when t5.cst_id is not null then 1 else 0 end is2wrnt
    ,t6.key_psn_cst_id                                  --关键人客户号
    ,t6.key_psn_cst_nm                                  --关键人客户名称
    ,case when nvl(c.cst_id,'')<>'' and c.cst_id=t6.key_psn_cst_id then 1 else 0 end is2keypsn
from SJXQ_SJ2024092011_CST_29               a
left join edw.dim_bus_dep_cst_act_inf_dd  	c --客户存款账户信息
on a.cnt_pty_cst_act_id=c.cst_act_id
and c.dt='@@{yyyyMMdd}'
left join (
    select distinct cst_id
    from edw.dim_bus_loan_ctr_bse_inf_dd
    where dt='@@{yyyyMMdd}'
)d on c.cst_id=d.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t4	--客户集市-客户基础-对私客户基础信息
on c.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join(
    select distinct cst_id,wrnt_cst_id
    from SJXQ_SJ2024092011_CST_11
)t5 on a.cst_id=t5.cst_id
and c.cst_id=t5.wrnt_cst_id
LEFT JOIN    edw.dwd_cst_mng_cmnt_key_psn_rcm_cst_inf_dd t6 --社区关键人推荐客户信息
ON      a.cst_id = t6.rcm_cst_id
and     c.cst_id = t6.key_psn_cst_id
AND     t6.dt = '@@{yyyyMMdd}'
;
-- （1）我行贷款资金流向关键人、担保人;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03_1 AS
SELECT  t1.ctr_serno          AS 合同流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.PRM_BUS_BRED_CTG   AS 主业务品种分类
       ,t1.cpt_usg_rmk        AS 资金用途备注
       ,t1.ctr_amt            AS 合同金额
       ,t1.ctr_bal            AS 合同余额
       ,t1.DIF_PLC_BSN_IND    AS 乡情贷业务标志
       ,t1.mgr_org_id         AS 管户机构号
       ,t1.org_nm             AS 管户机构
       ,t1.mgr_id             AS 管户人工号
       ,t1.mgr_nm             AS 管户人姓名
       ,t1.hdl_org_id         AS 经办机构编号
       ,t1.hdl_org_nm         AS 经办机构
       ,t1.hdl_opr_id         AS 经办人工号
       ,t1.hdl_opr_nm         AS 经办人姓名
       ,t2.DBIL_ID            AS 借据号
       ,t2.LVE_ACT_BGN_DT     AS 出账起始日期
       ,t2.amt                AS 借据金额
       ,t3.cst_act_id         AS 客户账号
       ,t3.trx_dt             AS 交易时间
       ,t3.crd_and_dbt_ind    AS 借贷标志
       ,t3.trx_amt            AS 交易金额
       ,t3.cnt_pty_cst_id     AS 对方客户号
       ,t3.cnt_pty_cst_act_id AS 对方账号
       ,t3.cnt_pty_act_nm     AS 对方名称
       ,t3.is_crdt_cst        AS 对方是否授信客户
       ,t3.job_unt_nm         AS 对方客户工作单位名称
       ,t3.is2wrnt            AS 是否流向担保人
       ,t3.is2keypsn          AS 是否流向关键人
from SJXQ_SJ2024092011_CST_01           t1
inner join edw.dim_bus_loan_dbil_inf_dd	t2 --信贷借据信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
inner join SJXQ_SJ2024092011_CST_30     t3
on t1.cst_id=t3.cst_id
and t2.LVE_ACT_BGN_DT<=t3.trx_dt
and t3.trx_dt<=replace(add_months(to_date(t2.LVE_ACT_BGN_DT,'yyyyMMdd'),3),'-','') --近3月资金流出
and (t3.is2wrnt=1 or t3.is2keypsn=1)
and t3.crd_and_dbt_ind='D'
;
-- （2）超过3个行内授信客户贷款资金流向同一个交易对手（对方账号相同或对方名称相同）
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_31 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_31 AS
SELECT  t1.ctr_serno          --合同流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.PRM_BUS_BRED_CTG   --主业务品种分类
       ,t1.cpt_usg_rmk        --资金用途备注
       ,t1.ctr_amt            --合同金额
       ,t1.ctr_bal            --合同余额
       ,t1.DIF_PLC_BSN_IND    --乡情贷业务标志
       ,t1.mgr_org_id         --管户机构号
       ,t1.org_nm             --管户机构
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_nm             --管户人姓名
       ,t1.hdl_org_id         --经办机构编号
       ,t1.hdl_org_nm         --经办机构
       ,t1.hdl_opr_id         --经办人工号
       ,t1.hdl_opr_nm         --经办人姓名
       ,t2.DBIL_ID            --借据号
       ,t2.LVE_ACT_BGN_DT     --出账起始日期
       ,t2.amt                --借据金额
       ,t3.cst_act_id         --客户账号
       ,t3.trx_dt             --贷款交易时间
       ,t3.crd_and_dbt_ind    --贷款借贷标志
       ,t3.trx_amt            --贷款交易金额
       ,t3.cnt_pty_cst_id     --对方客户号
       ,t3.cnt_pty_cst_act_id --对方账号
       ,t3.cnt_pty_act_nm     --对方名称
       ,t3.is_crdt_cst        --对方是否授信客户
       ,t3.job_unt_nm         --对方客户工作单位名称
from SJXQ_SJ2024092011_CST_01           t1
inner join edw.dim_bus_loan_dbil_inf_dd	t2 --信贷借据信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
inner join SJXQ_SJ2024092011_CST_30     t3
on t1.cst_id=t3.cst_id
and t2.LVE_ACT_BGN_DT<=t3.trx_dt
and t3.trx_dt<=replace(add_months(to_date(t2.LVE_ACT_BGN_DT,'yyyyMMdd'),3),'-','') --近3月资金流出
and t3.crd_and_dbt_ind='D'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03_2 AS
SELECT  t1.ctr_serno          as 合同流水号
       ,t1.cst_id             as 客户号
       ,t1.cst_nm             as 客户名称
       ,t1.PRM_BUS_BRED_CTG   as 主业务品种分类
       ,t1.cpt_usg_rmk        as 资金用途备注
       ,t1.ctr_amt            as 合同金额
       ,t1.ctr_bal            as 合同余额
       ,t1.DIF_PLC_BSN_IND    as 乡情贷业务标志
       ,t1.mgr_org_id         as 管户机构号
       ,t1.org_nm             as 管户机构
       ,t1.mgr_id             as 管户人工号
       ,t1.mgr_nm             as 管户人姓名
       ,t1.hdl_org_id         as 经办机构编号
       ,t1.hdl_org_nm         as 经办机构
       ,t1.hdl_opr_id         as 经办人工号
       ,t1.hdl_opr_nm         as 经办人姓名
       ,t1.DBIL_ID            as 借据号
       ,t1.LVE_ACT_BGN_DT     as 出账起始日期
       ,t1.amt                as 借据金额
       ,t1.cst_act_id         as 客户账号
       ,t1.trx_dt             as 交易时间
       ,t1.crd_and_dbt_ind    as 借贷标志
       ,t1.trx_amt            as 交易金额
       ,t1.cnt_pty_cst_id     as 对方客户号
       ,t1.cnt_pty_cst_act_id as 对方账号
       ,t1.cnt_pty_act_nm     as 对方名称
       ,t1.is_crdt_cst        as 对方是否授信客户
       ,t1.job_unt_nm         as 对方客户工作单位名称
       ,t2.custs as 流向该交易对手的客户数
from SJXQ_SJ2024092011_CST_31 t1
inner join(
    SElECT cnt_pty_cst_id,count(distinct cst_id) custs
    from SJXQ_SJ2024092011_CST_31
    where nvl(cnt_pty_cst_id,'')<>''
    group by cnt_pty_cst_id
    having count(distinct cst_id) >= 3
)t2 on t1.cnt_pty_cst_id=t2.cnt_pty_cst_id
;
-- （3）超过3个行内授信客户还贷或还息资金来源于同一个交易对手（对方账号相同或对方名称相同）
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_32 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_32 AS
SELECT  t1.ctr_serno          --合同流水号
       ,t1.cst_id             --客户号
       ,t1.cst_nm             --客户名称
       ,t1.PRM_BUS_BRED_CTG   --主业务品种分类
       ,t1.cpt_usg_rmk        --资金用途备注
       ,t1.ctr_amt            --合同金额
       ,t1.ctr_bal            --合同余额
       ,t1.DIF_PLC_BSN_IND    --乡情贷业务标志
       ,t1.mgr_org_id         --管户机构号
       ,t1.org_nm             --管户机构
       ,t1.mgr_id             --管户人工号
       ,t1.mgr_nm             --管户人姓名
       ,t1.hdl_org_id         --经办机构编号
       ,t1.hdl_org_nm         --经办机构
       ,t1.hdl_opr_id         --经办人工号
       ,t1.hdl_opr_nm         --经办人姓名
       ,t2.DBIL_ID            --借据号
       ,t2.LVE_ACT_BGN_DT     --出账起始日期
       ,t2.amt                --借据金额
       ,t3.repay_dt
       ,t4.cst_act_id         --客户账号
       ,t4.trx_dt             --交易时间
       ,t4.crd_and_dbt_ind    --借贷标志
       ,t4.trx_amt            --交易金额
       ,t4.cnt_pty_cst_id     --对方客户号
       ,t4.cnt_pty_cst_act_id --对方账号
       ,t4.cnt_pty_act_nm     --对方名称
       ,t4.is_crdt_cst        --对方是否授信客户
       ,t4.job_unt_nm         --对方客户工作单位名称
from SJXQ_SJ2024092011_CST_01                   t1
inner join edw.dim_bus_loan_dbil_inf_dd	        t2 --信贷借据信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
INNER JOIN(
    select distinct t3.dbil_id,t3.trx_dt as repay_dt
    from edw.dwd_bus_loan_trm_pmt_trx_dtl_di  t3 --贷款期供交易明细
    where T3.evt_cmt NOT RLIKE '形态转移'
    AND     (T3.prcp_amt<> 0 OR T3.RCV_ACR_INTR_AMT<>0)
    AND     t3.dt <= '@@{yyyyMMdd}'
)t3 ON t2.dbil_id = t3.dbil_id
inner join SJXQ_SJ2024092011_CST_30     t4
on t1.cst_id=t4.cst_id
and t4.trx_dt<=t3.repay_dt
and t4.trx_dt>=replace(add_months(to_date(t3.repay_dt,'yyyyMMdd'),-1),'-','') --还款前1月资金流入
and t4.crd_and_dbt_ind='C'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03_3 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03_3 AS
SELECT  t1.ctr_serno          as 合同流水号
       ,t1.cst_id             as 客户号
       ,t1.cst_nm             as 客户名称
       ,t1.PRM_BUS_BRED_CTG   as 主业务品种分类
       ,t1.cpt_usg_rmk        as 资金用途备注
       ,t1.ctr_amt            as 合同金额
       ,t1.ctr_bal            as 合同余额
       ,t1.DIF_PLC_BSN_IND    as 乡情贷业务标志
       ,t1.mgr_org_id         as 管户机构号
       ,t1.org_nm             as 管户机构
       ,t1.mgr_id             as 管户人工号
       ,t1.mgr_nm             as 管户人姓名
       ,t1.hdl_org_id         as 经办机构编号
       ,t1.hdl_org_nm         as 经办机构
       ,t1.hdl_opr_id         as 经办人工号
       ,t1.hdl_opr_nm         as 经办人姓名
       ,t1.DBIL_ID            as 借据号
       ,t1.LVE_ACT_BGN_DT     as 出账起始日期
       ,t1.amt                as 借据金额
       ,t1.repay_dt           as 还款日期
       ,t1.cst_act_id         as 客户账号
       ,t1.trx_dt             as 交易时间
       ,t1.crd_and_dbt_ind    as 借贷标志
       ,t1.trx_amt            as 交易金额
       ,t1.cnt_pty_cst_id     as 对方客户号
       ,t1.cnt_pty_cst_act_id as 对方账号
       ,t1.cnt_pty_act_nm     as 对方名称
       ,t1.is_crdt_cst        as 对方是否授信客户
       ,t1.job_unt_nm         as 对方客户工作单位名称
       ,t2.custs as 还款来源该交易对手的客户数
from SJXQ_SJ2024092011_CST_32 t1
inner join(
    SElECT cnt_pty_cst_id,count(distinct cst_id) as custs
    from SJXQ_SJ2024092011_CST_32
    where nvl(cnt_pty_cst_id,'')<>''
    group by cnt_pty_cst_id
    having count(distinct cst_id) >= 3
)t2 on t1.cnt_pty_cst_id=t2.cnt_pty_cst_id
;
-- （4）与超过5个行内授信客户有资金往来；
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03_4 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03_4 AS
SELECT  t2.ctr_serno          AS 合同流水号
       ,t2.cst_id             AS 客户号
       ,t2.cst_nm             AS 客户名称
       ,t2.PRM_BUS_BRED_CTG   AS 主业务品种分类
       ,t2.cpt_usg_rmk        AS 资金用途备注
       ,t2.ctr_amt            AS 合同金额
       ,t2.ctr_bal            AS 合同余额
       ,t2.DIF_PLC_BSN_IND    AS 乡情贷业务标志
       ,t2.mgr_org_id         AS 管户机构号
       ,t2.org_nm             AS 管户机构
       ,t2.mgr_id             AS 管户人工号
       ,t2.mgr_nm             AS 管户人姓名
       ,t2.hdl_org_id         AS 经办机构编号
       ,t2.hdl_org_nm         AS 经办机构
       ,t2.hdl_opr_id         AS 经办人工号
       ,t2.hdl_opr_nm         AS 经办人姓名
       ,t3.cst_act_id         AS 客户账号
       ,t3.cnt_pty_cst_id     AS 对方客户号
       ,t3.cnt_pty_cst_act_id AS 对方账号
       ,t3.cnt_pty_act_nm     AS 对方名称
       ,t3.is_crdt_cst        AS 对方是否授信客户
       ,t3.job_unt_nm         AS 对方客户工作单位名称
       ,t3.trx_cnt            AS 资金往来次数
       ,t1.custs as 有资金来往的行内授信客户数
from (
    select cst_id,count(distinct cnt_pty_cst_id) custs
    from SJXQ_SJ2024092011_CST_30
    where is_crdt_cst=1
    group by cst_id
    having count(distinct cnt_pty_cst_id) > 5   --超过5个
)t1
inner join SJXQ_SJ2024092011_CST_01 t2
on t1.cst_id=t2.cst_id
left join(
    select cst_id,cnt_pty_cst_id
        ,max(is_crdt_cst) as is_crdt_cst
        ,count(1) trx_cnt
    from SJXQ_SJ2024092011_CST_30
    group by cst_id,cnt_pty_cst_id
)t3 on t1.cst_id=t3.cst_id
;
-- （5）近1年不同资金交易对手达到100个以上；
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03_5 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03_5 AS
SELECT  t2.ctr_serno          AS 合同流水号
       ,t2.cst_id             AS 客户号
       ,t2.cst_nm             AS 客户名称
       ,t2.PRM_BUS_BRED_CTG   AS 主业务品种分类
       ,t2.cpt_usg_rmk        AS 资金用途备注
       ,t2.ctr_amt            AS 合同金额
       ,t2.ctr_bal            AS 合同余额
       ,t2.DIF_PLC_BSN_IND    AS 乡情贷业务标志
       ,t2.mgr_org_id         AS 管户机构号
       ,t2.org_nm             AS 管户机构
       ,t2.mgr_id             AS 管户人工号
       ,t2.mgr_nm             AS 管户人姓名
       ,t2.hdl_org_id         AS 经办机构编号
       ,t2.hdl_org_nm         AS 经办机构
       ,t2.hdl_opr_id         AS 经办人工号
       ,t2.hdl_opr_nm         AS 经办人姓名
       ,t3.cst_act_id         AS 客户账号
       ,t3.cnt_pty_cst_id     AS 对方客户号
       ,t3.cnt_pty_cst_act_id AS 对方账号
       ,t3.cnt_pty_act_nm     AS 对方名称
       ,t3.is_crdt_cst        AS 对方是否授信客户
       ,t3.job_unt_nm         AS 对方客户工作单位名称
       ,t3.trx_cnt            AS 资金往来次数
       ,t1.custs    as 近1年不同资金交易对手数
from (
    select cst_id,count(distinct cnt_pty_cst_id) custs
    from SJXQ_SJ2024092011_CST_30
    where trx_dt>='@@{yyyyMMdd-1y}'     --近一年
    group by cst_id
    having count(distinct cnt_pty_cst_id) > 100   --100个以上
)t1
inner join SJXQ_SJ2024092011_CST_01 t2
on t1.cst_id=t2.cst_id
left join(
    select cst_id,cnt_pty_cst_id
        ,max(is_crdt_cst) as is_crdt_cst
        ,count(1) trx_cnt
    from SJXQ_SJ2024092011_CST_30
    group by cst_id,cnt_pty_cst_id
)t3 on t1.cst_id=t3.cst_id
;
-- （6）客户交易备注中存在&ldquo;手续费&rdquo;、&ldquo;借款&rdquo;字眼
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_03_6 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_03_6 AS
SELECT  t2.ctr_serno          AS 合同流水号
       ,t2.cst_id             AS 客户号
       ,t2.cst_nm             AS 客户名称
       ,t2.PRM_BUS_BRED_CTG   AS 主业务品种分类
       ,t2.cpt_usg_rmk        AS 资金用途备注
       ,t2.ctr_amt            AS 合同金额
       ,t2.ctr_bal            AS 合同余额
       ,t2.DIF_PLC_BSN_IND    AS 乡情贷业务标志
       ,t2.mgr_org_id         AS 管户机构号
       ,t2.org_nm             AS 管户机构
       ,t2.mgr_id             AS 管户人工号
       ,t2.mgr_nm             AS 管户人姓名
       ,t2.hdl_org_id         AS 经办机构编号
       ,t2.hdl_org_nm         AS 经办机构
       ,t2.hdl_opr_id         AS 经办人工号
       ,t2.hdl_opr_nm         AS 经办人姓名
       ,t3.cst_act_id         AS 客户账号
       ,t3.cnt_pty_cst_id     AS 对方客户号
       ,t3.cnt_pty_cst_act_id AS 对方账号
       ,t3.cnt_pty_act_nm     AS 对方名称
       ,t3.is_crdt_cst        AS 对方是否授信客户
       ,t3.job_unt_nm         AS 对方客户工作单位名称
       ,t3.trx_cnt            AS 资金往来次数
       ,t3.smr_dscr as 摘要描述
        ,t3.cmt as 备注
from (
    select distinct cst_id
    from SJXQ_SJ2024092011_CST_30
    where is_keyword=1
)t1
inner join SJXQ_SJ2024092011_CST_01 t2
on t1.cst_id=t2.cst_id
left join(
    select cst_id,cnt_pty_cst_id
        ,max(is_crdt_cst) as is_crdt_cst
        ,count(1) trx_cnt
    from SJXQ_SJ2024092011_CST_30
    where is_keyword=1
    group by cst_id,cnt_pty_cst_id
)t3 on t1.cst_id=t3.cst_id
;
-- 四、实地调查
-- （1）未结清业务里5笔及以上业务侧面打听对象是同一人的业务；
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_40 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_40 AS
select t1.svy_rcd_serno                          --调查记录流水号|C32
	,t1.svy_mod_cd                               --调查方式代码|C2
    ,c1.cd_val_dscr     as svy_mod_nm
	,t1.svy_dt                                   --调查日期|C8
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.svy_addr_typ_cd                          --调查地址类型代码|C3
    ,c2.cd_val_dscr     as svy_addr_typ_nm
	,t1.adiv                                     --行政区划|C12
	,t1.svy_addr                                 --调查地址|C256
	,t1.svy_ctnt_and_rslt                        --调查内容及结果|C4000
	,t1.rmk                                      --备注|c4000
	,t1.pcp_mnl_no                               --参与人工号|C20
	,t1.pcp_psn_nm                               --参与人姓名|C200
    ,t2.svy_obj_nm	--调查对象名称|c200
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
left join edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd t2 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t2.rel_serno --关联流水号
and t2.dt='@@{yyyyMMdd}'
and nvl(t2.svy_obj_nm,'')<>''
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt='@@{yyyyMMdd}'
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.cst_id in(select distinct cst_id from SJXQ_SJ2024092011_CST_01)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_41 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_41 AS
select t1.ctr_serno,t2.svy_addr_typ_nm,t2.svy_addr
from SJXQ_SJ2024092011_CST_01       t1
inner join SJXQ_SJ2024092011_CST_40 t2
on t1.cst_id=t2.cst_id
and t2.svy_mod_nm regexp '侧面打听'
group by t1.ctr_serno,t2.svy_addr_typ_nm,t2.svy_addr
;
-- （1）未结清业务里5笔及以上业务侧面打听对象是同一人的业务
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_04_1 AS
SELECT  t3.ctr_serno        AS 合同流水号
       ,t3.cst_id           AS 客户号
       ,t3.cst_nm           AS 客户名称
       ,t3.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t3.cpt_usg_rmk      AS 资金用途备注
       ,t3.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t3.ctr_amt          AS 合同金额
       ,t3.ctr_bal          AS 合同余额
       ,t3.mgr_org_id       AS 管户机构号
       ,t3.org_nm           AS 管户机构
       ,t3.mgr_id           AS 管户人工号
       ,t3.mgr_nm           AS 管户人姓名
       ,t3.hdl_org_id       AS 经办机构编号
       ,t3.hdl_org_nm       AS 经办机构
       ,t3.hdl_opr_id       AS 经办人工号
       ,t3.hdl_opr_nm       AS 经办人姓名
       ,t2.svy_obj_nm       as 侧面打听人
       ,t2.svy_addr_typ_nm  AS 实地调查地址类型
       ,t2.svy_addr         AS 实地调查具体地址
from(
    select svy_obj_nm
    from SJXQ_SJ2024092011_CST_41
    group by svy_obj_nm
    having count(distinct ctr_serno) >= 5
)t1 inner join SJXQ_SJ2024092011_CST_41 t2
on t1.svy_obj_nm=t2.svy_obj_nm
inner join SJXQ_SJ2024092011_CST_01     t3
on t2.ctr_serno=t3.ctr_serno
;
-- （2）实地走访地址非经营地；
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_04_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_04_2 AS
SELECT  t1.ctr_serno        AS 合同流水号
       ,t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户名称
       ,t1.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t1.cpt_usg_rmk      AS 资金用途备注
       ,t1.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t1.ctr_amt          AS 合同金额
       ,t1.ctr_bal          AS 合同余额
       ,t1.mgr_org_id       AS 管户机构号
       ,t1.org_nm           AS 管户机构
       ,t1.mgr_id           AS 管户人工号
       ,t1.mgr_nm           AS 管户人姓名
       ,t1.hdl_org_id       AS 经办机构编号
       ,t1.hdl_org_nm       AS 经办机构
       ,t1.hdl_opr_id       AS 经办人工号
       ,t1.hdl_opr_nm       AS 经办人姓名
       ,t2.svy_addr_typ_nm  AS 实地调查地址类型
       ,t2.svy_addr         AS 实地调查具体地址
from SJXQ_SJ2024092011_CST_01 t1
inner join(
    select distinct cst_id,svy_addr_typ_nm,svy_addr
    from SJXQ_SJ2024092011_CST_40
    where svy_addr_typ_nm not regexp '经营'
)t2 on t1.cst_id=t2.cst_id
;
-- （3）超过3个客户具体调查地址相同。
DROP   TABLE IF     EXISTS SJXQ_SJ2024092011_CST_04_3 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092011_CST_04_3 AS
SELECT  t3.ctr_serno        AS 合同流水号
       ,t3.cst_id           AS 客户号
       ,t3.cst_nm           AS 客户名称
       ,t3.PRM_BUS_BRED_CTG AS 主业务品种分类
       ,t3.cpt_usg_rmk      AS 资金用途备注
       ,t3.DIF_PLC_BSN_IND  AS 乡情贷业务标志
       ,t3.ctr_amt          AS 合同金额
       ,t3.ctr_bal          AS 合同余额
       ,t3.mgr_org_id       AS 管户机构号
       ,t3.org_nm           AS 管户机构
       ,t3.mgr_id           AS 管户人工号
       ,t3.mgr_nm           AS 管户人姓名
       ,t3.hdl_org_id       AS 经办机构编号
       ,t3.hdl_org_nm       AS 经办机构
       ,t3.hdl_opr_id       AS 经办人工号
       ,t3.hdl_opr_nm       AS 经办人姓名
       ,t2.svy_addr_typ_nm  AS 实地调查地址类型
       ,t2.svy_addr         AS 实地调查具体地址
from (
    select svy_addr
    from SJXQ_SJ2024092011_CST_40
    where nvl(svy_addr,'')<>''
    group by svy_addr
    having count(distinct cst_id)>=3
)t1 inner join (
    select distinct cst_id,svy_addr_typ_nm,svy_addr
    from SJXQ_SJ2024092011_CST_40
)t2 on t1.svy_addr=t2.svy_addr
inner join SJXQ_SJ2024092011_CST_01 t3
on t2.cst_id=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024092011_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024092011_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024092011_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,cst_id_sum) custs
from SJXQ_SJ2024092011_CST_04
union all
SElECT '10' seq, count(1) cnt,count(distinct MAIN_CST_ID) custs
from SJXQ_SJ2024092011_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_id,wrnt_cst_id) custs
from SJXQ_SJ2024092011_CST_11
union all
SElECT '29' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024092011_CST_29
union all
SElECT '30' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024092011_CST_30
union all
SElECT '31' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ2024092011_CST_31
union all
SElECT '32' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024092011_CST_32
union all
SElECT '40' seq, count(1) cnt,count(distinct svy_rcd_serno,svy_obj_nm) custs
from SJXQ_SJ2024092011_CST_40
union all
SElECT '41' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024092011_CST_41
;
SElECT '12' seq, count(1) cnt,count(distinct 合同流水号,同一经营地址客户号和) custs
from SJXQ_SJ2024092011_CST_01_2
union all
SElECT '14' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_01_4
union all
SElECT '21' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_02_1
union all
SElECT '22' seq, count(1) cnt,count(distinct 合同流水号,担保人ID) custs
from SJXQ_SJ2024092011_CST_02_2
union all
SElECT '31' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_03_1
union all
SElECT '32' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_03_2
union all
SElECT '33' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_03_3
union all
SElECT '34' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_03_4
union all
SElECT '35' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_03_5
union all
SElECT '36' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_03_6
union all
SElECT '41' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_04_1
union all
SElECT '42' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_04_2
union all
SElECT '43' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024092011_CST_04_3
;
SElECT '12' seq, *
from SJXQ_SJ2024092011_CST_01_2
;
SElECT '14' seq, *
from SJXQ_SJ2024092011_CST_01_4
;
SElECT '21' seq, *
from SJXQ_SJ2024092011_CST_02_1
;
SElECT '22' seq, *
from SJXQ_SJ2024092011_CST_02_2
;
SElECT '31' seq, *
from SJXQ_SJ2024092011_CST_03_1
;
SElECT '32' seq, *
from SJXQ_SJ2024092011_CST_03_2
;
SElECT '33' seq, *
from SJXQ_SJ2024092011_CST_03_3
;
SElECT '34' seq, *
from SJXQ_SJ2024092011_CST_03_4
;
SElECT '35' seq, *
from SJXQ_SJ2024092011_CST_03_5
;
SElECT '36' seq, *
from SJXQ_SJ2024092011_CST_03_6
;
SElECT '41' seq, *
from SJXQ_SJ2024092011_CST_04_1
;
SElECT '42' seq, *
from SJXQ_SJ2024092011_CST_04_2
;
SElECT '43' seq, *
from SJXQ_SJ2024092011_CST_04_3
***SJ2024092091_丽水分行反洗钱.sql
-- 取数区间：2024年1月1日至2024年8月31日
-- 取数范围：丽水分行全量对私开户数据
-- 1. 对私开户登记簿
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_01 AS
SELECT  t1.cst_id                                                            AS 对私客户号
       ,t3.cst_chn_nm                                                        AS 对私客户姓名
       ,t3.doc_typ_cd                                                        AS 证件类型代码
       ,CASE WHEN t3.doc_typ_cd = 'B0100' THEN '身份证'
             WHEN t3.doc_typ_cd = 'B0101' THEN '居民身份证'
             WHEN t3.doc_typ_cd = 'B0102' THEN '临时身份证'
             WHEN t3.doc_typ_cd = 'B0200' THEN '户口簿'  ELSE t3.doc_typ_cd END AS 证件类型
    --    ,t3.doc_mtu_dt                                                        AS 证件到期日期2
    --    ,t4.doc_isu_dt                                                        AS 证件签发日期
       ,t4.doc_mtu_dt                                                        AS 证件到期日期
       ,t5.ntn_cd                                                            AS 国籍代码
       ,c1.cd_val_dscr                                                       AS 国籍
       ,t5.ocp_cd                                                            AS 职业代码
       ,c2.cd_val_dscr                                                       AS 职业
       ,t5.job_unt_nm                                                        AS 工作单位名称
       ,t1.opn_org                                                           AS 开户机构
       ,t2.org_nm                                                            AS 开户机构名称
       ,t1.opn_dt                                                            AS 开户日期
FROM edw.dws_bus_dep_act_inf_dd             t1
INNER JOIN edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
ON t1.opn_org = t2.org_id
AND t2.dt = '@@{yyyyMMdd}'
AND t2.brc_org_nm = '丽水分行'
LEFT JOIN edw.dws_cst_bas_inf_dd            t3
ON t1.cst_id = t3.cst_id
-- AND t3.doc_typ_cd IN ( 'B0100' , 'B0101' , 'B0102' )--缺户口本
AND t3.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_cst_bas_doc_inf_dd        t4 --客户证件信息
ON t1.cst_id = t4.cst_id
AND t4.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_cst_idv_bas_inf_dd        t5
ON t1.cst_id = t5.cst_id
AND t5.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd           c1
ON t5.ntn_cd = c1.cd_val
AND c1.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_code_library_dd           c2
ON t5.ocp_cd = c2.cd_val
AND c2.dt = '@@{yyyyMMdd}'
WHERE t1.dt = '@@{yyyyMMdd}'
AND t1.opn_dt >= '20240101'
AND t1.opn_dt <= '20240831'
AND t1.cst_tp = '1' --对私
AND t1.act_sts_cd <> 'C'
;
-- 2. 对公开户登记簿
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_02 AS
SELECT  t1.cst_id --客户号
       ,M1.REL_CST_ID      as 法定代表人客户号
       ,m2.CST_CHN_NM      as 法定代表人客户名
       ,M2.doc_typ_cd      as 法定代表人证件类型
       ,m2.doc_nbr         as 法定代表人证件号
       ,m2.doc_isu_dt      as 法定代表人证件签发日期
       ,m2.doc_mtu_dt      as 法定代表人证件到期日
       ,m5.REL_CST_ID      --受益人客户号
       ,m6.CST_CHN_NM      --受益人客户名
       ,m7.cmn_adr         --受益人通讯地址
       ,m7.wrk_adr          --受益人工作单位或经营所在地地址
       ,m8.direct_hold_ratio   --行内受益人直接持股比例
       ,m8.indirect_hold_ratio --行内受益人间接持股比例
       ,row_number() over(partition by t1.cst_id order by m8.direct_hold_ratio desc) rn
FROM edw.dim_cst_entp_bas_inf_dd t1
LEFT JOIN EDW.DIM_CST_REL_INF_DD M1 --客户关联关系信息
ON t1.cst_id = M1.CST_ID AND M1.REL_TYP_CD = '0101' --法定代表人
AND M1.DT = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  a.CST_ID
	       ,b.CST_CHN_NM
	       ,a.doc_typ_cd
	       ,a.doc_nbr
	       ,a.doc_isu_dt
	       ,a.doc_mtu_dt
	FROM edw.dim_cst_bas_doc_inf_dd A
	INNER JOIN edw.dim_cst_idv_bas_inf_dd b
	ON a.CST_ID = b.CST_ID AND b.dt = '@@{yyyyMMdd}'
	WHERE a.dt = '@@{yyyyMMdd}'
	UNION
	SELECT  relation_id
	       ,rel_per_name
	       ,cert_typ
	       ,cert_no
	       ,nvl(CASE WHEN REPLACE(substr(cert_issu_dt,1,10),'-','') = '' THEN NULL ELSE REPLACE(substr(cert_issu_dt,1,10),'-','') END,'18991231')
	       ,nvl(CASE WHEN REPLACE(substr(cert_expr_dt,1,10),'-','') = '' THEN NULL ELSE REPLACE(substr(cert_expr_dt,1,10),'-','') END,'18991231')
	FROM edw.ecif_t01_org_relationer_info --对公关系人信息表
	WHERE dt = '@@{yyyyMMdd}'
	AND UPDATED_TS = '9999-12-31 00:00:00'
) M2
ON M1.REL_CST_ID = M2.CST_ID
LEFT JOIN EDW.DIM_CST_REL_INF_DD M5
ON t1.cst_id = M5.CST_ID AND M5.REL_TYP_CD LIKE '09%' --受益人
AND M5.DT = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  a.CST_ID
	       ,b.CST_CHN_NM
	       ,a.doc_typ_cd
	       ,a.doc_nbr
	       ,a.doc_isu_dt
	       ,a.doc_mtu_dt
	FROM edw.dim_cst_bas_doc_inf_dd A
	INNER JOIN edw.dim_cst_idv_bas_inf_dd b
	ON a.CST_ID = b.CST_ID AND b.dt = '@@{yyyyMMdd}'
	WHERE a.dt = '@@{yyyyMMdd}'
	UNION
	SELECT  relation_id
	       ,rel_per_name
	       ,cert_typ
	       ,cert_no doc_nbr
	       ,nvl(CASE WHEN REPLACE(substr(cert_issu_dt,1,10),'-','') = '' THEN NULL ELSE REPLACE(substr(cert_issu_dt,1,10),'-','') END,'18991231') doc_isu_dt
	       ,nvl(CASE WHEN REPLACE(substr(cert_expr_dt,1,10),'-','') = '' THEN NULL ELSE REPLACE(substr(cert_expr_dt,1,10),'-','') END,'18991231') doc_mtu_dt
	FROM edw.ecif_t01_org_relationer_info
	WHERE dt = '@@{yyyyMMdd}'
	AND UPDATED_TS = '9999-12-31 00:00:00'
) M6
ON m5.REL_CST_ID = m6.CST_ID
LEFT JOIN edw.dws_cst_bas_inf_dd m7
ON m6.CST_ID = m7.cst_id
AND m7.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  d.cust_no --对公客户号
                         ,b.CUST_NO AS CST_ID --受益人客户号
                         ,direct_hold_ratio --直接持股比例
                         ,indirect_hold_ratio --间接持股比例
                         ,stock_pen_level --股权穿透层级
                         ,nual_shareholder_flg --是否自然人股东
                         ,beneficiary_generation_mode --	受益人生成方式
                         ,beneficiary_statement --受益人说明
                 FROM    edw.ecif_t01_org_cust_stock_info c
                 INNER JOIN    edw.ECIF_T00_ORG_CUST_NO_REC d
                 ON      d.PARTY_ID = c.org_party_id
                 AND     d.dt = '@@{yyyyMMdd}'
                 AND     d.UPDATED_TS = '9999-12-31 00:00:00'
                 INNER JOIN    edw.ECIF_T00_NOR_CUST_NO_REC b
                 ON      b.PARTY_ID = c.nor_party_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 AND     b.UPDATED_TS = '9999-12-31 00:00:00'
                 WHERE   c.dt = '@@{yyyyMMdd}'
                 AND     c.UPDATED_TS = '9999-12-31 00:00:00'
             ) m8
ON      M5.cst_id = m8.cust_no
AND     m5.REL_CST_ID = m8.CST_ID
WHERE t1.dt = '@@{yyyyMMdd}';
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_03 AS
SELECT  t1.cst_id     AS 对公客户号
       ,t3.cst_chn_nm AS 对公客户名称
       ,t1.opn_org    AS 开户机构
       ,t2.org_nm     AS 开户机构名称
       ,t1.opn_dt     AS 开户日期
       ,t4.法定代表人客户名
       ,t4.法定代表人证件类型
       ,t4.法定代表人证件到期日
       ,t4.CST_CHN_NM AS 受益人1名称
       ,t4.wrk_adr    AS 受益人1工作单位或经营所在地地址
       ,t5.CST_CHN_NM AS 受益人2名称
       ,t5.wrk_adr    AS 受益人2工作单位或经营所在地地址
       ,t6.CST_CHN_NM AS 受益人3名称
       ,t6.wrk_adr    AS 受益人3工作单位或经营所在地地址
       ,t7.CST_CHN_NM AS 受益人4名称
       ,t7.wrk_adr    AS 受益人4工作单位或经营所在地地址
       ,t8.CST_CHN_NM AS 受益人5名称
       ,t8.wrk_adr    AS 受益人5工作单位或经营所在地地址
FROM edw.dws_bus_dep_act_inf_dd             t1
INNER JOIN edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
ON t1.opn_org = t2.org_id
AND t2.dt = '@@{yyyyMMdd}'
AND t2.brc_org_nm = '丽水分行'
LEFT JOIN adm_pub.adm_csm_cbas_org_inf_dd t3
ON t1.cst_id = t3.cst_id
AND t3.dt = '@@{yyyyMMdd}'
LEFT JOIN SJXQ_SJ2024092091_CST_02 t4
ON t1.cst_id = t4.cst_id
and t4.rn=1
LEFT JOIN SJXQ_SJ2024092091_CST_02 t5
ON t1.cst_id = t5.cst_id
and t5.rn=2
LEFT JOIN SJXQ_SJ2024092091_CST_02 t6
ON t1.cst_id = t6.cst_id
and t6.rn=3
LEFT JOIN SJXQ_SJ2024092091_CST_02 t7
ON t1.cst_id = t7.cst_id
and t7.rn=4
LEFT JOIN SJXQ_SJ2024092091_CST_02 t8
ON t1.cst_id = t8.cst_id
and t8.rn=5
WHERE t1.dt = '@@{yyyyMMdd}'
AND     t1.opn_dt >= '20240101'
AND     t1.opn_dt <= '20240831'
AND     t1.cst_tp = '2' --对公客户
-- AND     t1.lbl_prod_typ_cd = '0' --活期产品
-- AND     t1.stl_act_ind = '1' --结算账户
AND     t1.act_sts_cd <> 'C'
;
-- 3. 受益所有人与慧众征信不一致
-- 取数：2024.01.01-2024.08.31在丽水分行开立的对公户
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_04 AS
SELECT  B.QYMC                        --惠众_企业名称
        ,B.zt                         --惠众企业状态
        ,C.BENF_NAME                  --惠众_受益人名称
        ,C.BENF_OWNER_RLTNP_TP        --惠众_受益所有人关系
        ,substr(C.update_time, 1, 10) --惠众更新日期
        ,C.drct_shrhld_rto            --直接持股比例
        ,C.indt_shrhld_rto            --间接持股比例
        ,C.smy_shrhld_rto             --合计持股比例
        ,C.level                      --穿透层级
        ,row_number() over(partition by B.QYMC order by c.drct_shrhld_rto desc) rn
FROM    EDW.DCIP_ENT_BASIC_INFO B ----企业基本信息
INNER JOIN    EDW.DCIP_ENT_FAVOREE_INFO_WBGS C ----受益人信息
ON      C.REL_COMPANY_ID = B.HZZX_ID ----内部流水号
AND     C.DT = '@@{yyyyMMdd}'
WHERE   b.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_05 AS
SELECT  t1.开户机构
       ,t1.开户机构名称
       ,t1.开户日期
       ,t1.对公客户号
       ,t1.对公客户名称
       ,''                 AS 惠众受益人情况
       ,s0.惠众受益人个数
       ,s1.BENF_NAME       AS 惠众_受益人1名称
       ,s1.drct_shrhld_rto AS 惠众_受益人1直接持股比例
       ,s1.indt_shrhld_rto AS 惠众_受益人1间接持股比例
       ,s2.BENF_NAME       AS 惠众_受益人2名称
       ,s2.drct_shrhld_rto AS 惠众_受益人2直接持股比例
       ,s2.indt_shrhld_rto AS 惠众_受益人2间接持股比例
       ,s3.BENF_NAME       AS 惠众_受益人3名称
       ,s3.drct_shrhld_rto AS 惠众_受益人3直接持股比例
       ,s3.indt_shrhld_rto AS 惠众_受益人3间接持股比例
       ,s4.BENF_NAME       AS 惠众_受益人4名称
       ,s4.drct_shrhld_rto AS 惠众_受益人4直接持股比例
       ,s4.indt_shrhld_rto AS 惠众_受益人4间接持股比例
       ,s5.BENF_NAME       AS 惠众_受益人5名称
       ,s5.drct_shrhld_rto AS 惠众_受益人5直接持股比例
       ,s5.indt_shrhld_rto AS 惠众_受益人5间接持股比例
       ,'' 行内受益人情况
       ,t3.行内受益人个数
       ,t4.CST_CHN_NM AS 行内受益人1名称
       ,t4.direct_hold_ratio   as 行内受益人1直接持股比例
       ,t4.indirect_hold_ratio as 行内受益人1间接持股比例
       ,t5.CST_CHN_NM AS 行内受益人2名称
       ,t5.direct_hold_ratio   as 行内受益人2直接持股比例
       ,t5.indirect_hold_ratio as 行内受益人2间接持股比例
       ,t6.CST_CHN_NM AS 行内受益人3名称
       ,t6.direct_hold_ratio   as 行内受益人3直接持股比例
       ,t6.indirect_hold_ratio as 行内受益人3间接持股比例
       ,t7.CST_CHN_NM AS 行内受益人4名称
       ,t7.direct_hold_ratio   as 行内受益人4直接持股比例
       ,t7.indirect_hold_ratio as 行内受益人4间接持股比例
       ,t8.CST_CHN_NM AS 行内受益人5名称
       ,t8.direct_hold_ratio   as 行内受益人5直接持股比例
       ,t8.indirect_hold_ratio as 行内受益人5间接持股比例
from SJXQ_SJ2024092091_CST_03       t1
left join(
    SElECT cst_id,count(distinct REL_CST_ID) 行内受益人个数
    from SJXQ_SJ2024092091_CST_02
    group by cst_id
)t3 on t1.对公客户号=t3.cst_id
LEFT JOIN SJXQ_SJ2024092091_CST_02  t4
ON t1.对公客户号 = t4.cst_id
and t4.rn=1
LEFT JOIN SJXQ_SJ2024092091_CST_02  t5
ON t1.对公客户号 = t5.cst_id
and t5.rn=2
LEFT JOIN SJXQ_SJ2024092091_CST_02  t6
ON t1.对公客户号 = t6.cst_id
and t6.rn=3
LEFT JOIN SJXQ_SJ2024092091_CST_02  t7
ON t1.对公客户号 = t7.cst_id
and t7.rn=4
LEFT JOIN SJXQ_SJ2024092091_CST_02  t8
ON t1.对公客户号 = t8.cst_id
and t8.rn=5
left join(
    SElECT QYMC,count(distinct BENF_NAME) 惠众受益人个数
    from SJXQ_SJ2024092091_CST_04
    group by QYMC
)s0 on t1.对公客户名称=s0.QYMC
LEFT JOIN SJXQ_SJ2024092091_CST_04  s1
ON t1.对公客户名称 = s1.QYMC
and s1.rn=1
LEFT JOIN SJXQ_SJ2024092091_CST_04  s2
ON t1.对公客户名称 = s2.QYMC
and s2.rn=2
LEFT JOIN SJXQ_SJ2024092091_CST_04  s3
ON t1.对公客户名称 = s3.QYMC
and s3.rn=3
LEFT JOIN SJXQ_SJ2024092091_CST_04  s4
ON t1.对公客户名称 = s4.QYMC
and s4.rn=4
LEFT JOIN SJXQ_SJ2024092091_CST_04  s5
ON t1.对公客户名称 = s5.QYMC
and s5.rn=5
;
SElECT '01' seq, count(1) cnt,count(distinct 对私客户号) custs
from SJXQ_SJ2024092091_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024092091_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 对公客户号) custs
from SJXQ_SJ2024092091_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct QYMC) custs
from SJXQ_SJ2024092091_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 对公客户号) custs
from SJXQ_SJ2024092091_CST_05
;
SElECT '01' seq, *
from SJXQ_SJ2024092091_CST_01
;
SElECT '02' seq, *
from SJXQ_SJ2024092091_CST_02
;
SElECT '03' seq, *
from SJXQ_SJ2024092091_CST_03
;
SElECT '04' seq, *
from SJXQ_SJ2024092091_CST_04
;
SElECT '05' seq, *
from SJXQ_SJ2024092091_CST_05
***SJ2024092091_丽水分行泰惠收.sql
-- 经办机构	机构编号	办理日期	泰惠收商户号	商户名称	客户号	外部工商信息显示的营业执照号码
-- 外部工商信息显示的营业执照名称	外部工商信息显示的经营状态（是否注销或吊销或存续）	有无命中过行内黑名单
-- 商户类型（企业商户/个体工商户）	商户证件到期日	法定代表人或企业负责人名称	法定代表人证件类型	法定代表人证件到期日
-- ECIF系统中：法定代表人名称	ECIF系统中：法定代表人证件类型	ECIF系统中：法定代表人证件到期日
-- 20240101 -20240831
DROP TABLE IF EXISTS tmp_LS_SJ2024092091_THS PURGE;
CREATE TABLE IF NOT EXISTS tmp_LS_SJ2024092091_THS AS
SELECT  T1.agency_org_td_nm AS 经办机构
        ,T1.agency_org_id   AS 机构编号
        ,T1.rvw_date        AS 办理日期
        ,T1.mch_id          AS 泰惠收商户号
        ,T1.mch_simple_name AS 商户简称
        ,T1.mch_name        AS 商户名称
        ,T1.cst_id          AS 客户号
        ,T4.credit_no       AS 外部工商信息显示的营业执照号码
        ,T4.company_name    AS 外部工商信息显示的营业执照名称
        ,T4.company_status  AS 外部工商信息显示的经营状态
        ,CASE
           WHEN T5.mch_id IS NOT NULL THEN '是'
           ELSE '否'
         END                AS 有无命中过行内黑名单
        ,T1.mch_type        AS 商户类型
        ,T2.bus_lcn_nvld_dt AS 商户证件到期日
        ,T2.lgp_nm          AS 法定代表人或企业负责人名称
        ,T3.cd_val_dscr     AS 法定代表人证件类型
        ,T2.lgp_doc_nvld_dt AS 法定代表人证件到期日
        ,T6.lgp_nm          AS ECIF法定代表人名称
        ,T7.cd_val_dscr     AS ECIF法定代表人证件类型
        ,T6.lgp_doc_mtu_dt  AS ECIF法定代表人证件到期日
FROM    app_rpt.fct_ths_mch_inf_ceshi T1 --泰惠收商户信息表
LEFT JOIN    edw.dws_bus_chnl_ths_mch_inf_dd T2 --泰惠收商户汇总信息
ON      T1.mch_id = T2.mch_id
AND     T2.DT = '20240831'
LEFT JOIN    edw.dwd_code_library_dd T3 -- 码值表
ON      T2.lgp_doc_typ_cd = T3.cd_val
AND     T3.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T3.fld_nm = 'DOC_TYP_CD'
AND     T3.DT = '20240831'
LEFT JOIN    edw.NOUT_COMPANY_BASE T4
ON      T2.bus_lcn_nbr = T4.credit_no
AND     T4.credit_no <> ''
AND     T4.dt = '20240831'
LEFT JOIN    (
                 SELECT  DISTINCT mch_id
                 FROM    edw.dim_bus_chnl_ths_blst_inf_dd
                 WHERE   DT = '20240831'
             ) T5 --泰惠收黑名单信息
ON      T1.mch_id = T5.mch_id
LEFT JOIN    edw.dim_cst_entp_lgp_inf_dd T6 --对公客户法人信息表
ON      T2.entp_cst_id = T6.cst_id
AND     T6.dt = '20240831'
LEFT JOIN    edw.dwd_code_library_dd T7 -- 码值表
ON      T6.lgp_doc_typ_cd = T7.cd_val
AND     T7.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T7.fld_nm = 'DOC_TYP_CD'
AND     T7.DT = '20240831'
WHERE   T1.DT = '20240831'
AND     T1.agency_org_id LIKE '3306%'
AND     T1.rvw_date >= '20240101'
AND     T1.rvw_date <= '20240831';
***SJ2024092091_丽水分行现钞兑换.sql
-- 业务范围：2024.01.01-2024.08.31丽水分行办理过的所有现钞兑换业务，且交易金额单笔人民币1万元以上或者外币等值1000美元以上的
-- 业务类型为：核心代码4015-客户现金兑换、2325代客结汇、2326代客售汇
-- 联网核查记录表
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_01 as
SELECT  t1.bank_name  --核查机构名称
       ,t1.bank_code2 --核查机构网点代码
       ,t1.checkdate  --联网核查日期
       ,t1.name       --公民姓名
       ,t1.id_no      --居民身份证件号码
FROM    adm_upss.AML_T3R_LWHC_LOG   t1
inner join (
    select distinct doc_nbr     --证件号码
    from adm_pub.adm_csm_cbas_idv_bas_inf_dd --客户集市-客户基础-对私客户基础信息
    where dt='@@{yyyyMMdd}'
)t2 on t1.id_no=t2.doc_nbr
WHERE t1.dt >= '20240101'
AND t1.dt <= '20240831'
group by  t1.bank_name ,t1.bank_code2 ,t1.checkdate ,t1.name ,t1.id_no
;
-- 交易流水
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_02 as
SELECT  T1.act_nm    --姓名
    ,T1.cst_act_id   --客户账号
    ,T1.dep_act_id   --存款账号
    ,T1.trx_dt       --业务日期
    ,T1.trx_ccy_cd   --交易币种代码
    ,T1.trx_amt      --交易金额
    ,T1.tlr_srl_nbr  --业务流水号
    ,T1.trx_tm       --提交开始时间
    ,T1.txt_code     --菜单码
    ,T1.smr_dscr     --菜单名称
    ,T1.opr_tlr      --经办柜员号
    ,T1.trx_bus_org  --机构号
    ,T2.cst_id       --客户号
    ,T3.glbl_srl_nbr --全局流水号
    ,t3.msg_srl_nbr	 --报文流水号
    ,t5.CNY_EXR*T1.trx_amt  as trx_amt_cny
    ,t5.usd_exr*T1.trx_amt  as trx_amt_usd
    ,t6.org_nm
FROM    edw.DWD_BUS_DEP_BAL_CHG_DTL_DI              T1 --存款账户余额发生明细
LEFT JOIN    edw.dws_bus_dep_act_inf_dd             T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_com_core_trx_msg_inf_di    T3  --核心交易报文信息
ON      T1.tlr_srl_nbr = T3.trx_srl_nbr                 --柜员流水与交易流水关联
AND     T1.trx_dt = T3.trx_dt
AND     T3.DT BETWEEN '20240101' and '20240831'
-- LEFT JOIN    edw.dwd_bus_chnl_cnt_face_rcg_inf_di   T4 --柜面业务人脸识别信息
-- ON      T3.glbl_srl_nbr = T4.trx_seq
-- AND     T3.trx_dt = T4.trx_dt
-- AND     T4.DT BETWEEN '20240101' and '20240831'
LEFT JOIN    EDW.DIM_BUS_COM_EXR_INF_DD             T5 --汇率表 CNY_EXR 折人民币汇率
ON      T1.trx_ccy_cd = T5.CCY_CD
and     t1.trx_dt=t5.dt     --交易日汇率
AND     T5.DT BETWEEN '20240101' and '20240831'
left join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t1.trx_bus_org = t6.org_id
and t6.dt = '20240831'
WHERE   T1.dt BETWEEN '20240101' and '20240831'
-- AND     T1.TRX_CHNL_CD ='A01' --柜面
-- AND     T1.bal_fld_nm = 'DPLDGBAL'
-- AND     T1.csh_ind      = '0'   --现转标志
AND     ((T1.trx_ccy_cd='156' and T1.trx_amt> 10000)                --人民币10000以上
    or (T1.trx_ccy_cd<>'156' and T1.trx_amt*t5.usd_exr> 1000))      --美元1000以上
AND     T2.cst_tp     = '1' -- 个人客户
AND     T1.trx_bus_org  like '3306%' --丽水分行
;
--外币现钞兑换
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_03 AS
select t1.bus_dt                                   --业务日期|C10
	,t1.trx_srl                                  --交易流水|C32
	,t1.doc_chk_srl_nbr                          --身份核查流水号|C32
	,t1.sbm_orig_tm                              --提交开始时间|C20
	,t1.sbm_end_tm                               --提交结束时间|C20
	,t1.chnl_dt                                  --渠道日期|C10
	,t1.menu_no                                  --菜单码|C10
	,t1.menu_nm                                  --菜单名称|C256
	,t1.trx_sts                                  --交易状态|C3
	,t1.hdl_tlr_id                               --经办柜员号|C10
	,t1.org_id                                   --机构号|C10
	,t1.cmt                                      --备注|C256
	,t1.rtn_no                                   --返回码|C32
	,t1.rtn_inf                                  --返回信息|C2000
	,t1.dbt_cst_id                               --借记客户号|C32
	,t1.dbt_cst_nm                               --借记客户姓名|C128
	,t1.crd_cst_id                               --贷记客户号|C32
	,t1.act_ccy                                  --账户币种|C10
	,t1.trx_amt                                  --交易金额|C32
	,t1.cst_id                                   --客户号|C30
	,t1.csh_amt                                  --现金金额|C30
	,t1.trx_typ_cd                               --交易类型代码|C5
    ,t6.org_nm
from edw.dwd_bus_chnl_cnt_trx_srl_di          t1 --柜面交易流水表
left join edw.dim_hr_org_mng_org_tree_dd      t6 --考核机构树
on  t1.org_id = t6.org_id
and t6.dt = '20240831'
where t1.dt BETWEEN '20240101' and '20240831'
and t1.org_id like '3306%' --丽水分行
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_04 AS
SELECT  t1.org_nm   AS 机构
    ,T1.trx_bus_org AS 机构号
    ,T1.trx_tm      AS 提交开始时间
    ,t2.sbm_end_tm  AS 提交结束时间
    ,CASE WHEN nvl(T1.smr_dscr,'') <> '' THEN T1.smr_dscr  ELSE t2.menu_nm END AS 业务类型
    ,T1.tlr_srl_nbr AS 业务流水号
    ,t2.trx_srl     AS 交易流水
    ,T1.opr_tlr     AS 经办柜员号
    ,T1.trx_ccy_cd  AS 交易币种代码
    ,T1.trx_dt      AS 业务日期
    ,T1.trx_amt     AS 交易金额
    ,t1.trx_amt_cny AS 交易金额折人民币
    ,t1.trx_amt_usd AS 交易金额折美元
    ,T1.cst_id      AS 客户号
    ,T1.act_nm      AS 姓名
    ,case when t5.id_no is not null then '是' else '' end 是否联网核查
    ,t5.checkdate   as 联网核查日期
from SJXQ_SJ2024092091_CST_02           t1
left join SJXQ_SJ2024092091_CST_03      t2
on t1.glbl_srl_nbr=t2.trx_srl
and t1.trx_dt=t2.bus_dt
left join edw.dws_cst_bas_inf_dd 		t3   --客户基础信息汇总表
on t1.cst_ID=t3.cst_id
and t3.dt='20240831'
LEFT JOIN    SJXQ_SJ2024092091_CST_01   t5
ON      t3.doc_nbr = t5.id_no
AND     t1.trx_dt = t5.checkdate  --交易当天
;
SElECT '01' seq, count(1) cnt,count(distinct id_no) custs
from SJXQ_SJ2024092091_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct glbl_srl_nbr,trx_dt) custs
from SJXQ_SJ2024092091_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct trx_srl,bus_dt) custs
from SJXQ_SJ2024092091_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 交易流水,业务日期) custs
from SJXQ_SJ2024092091_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024092091_CST_04
;
***SJ2024092091_丽水分行现钞兑换1017.sql
-- 业务范围：2024.01.01-2024.08.31丽水分行办理过的所有现钞兑换业务，且交易金额单笔人民币1万元以上或者外币等值1000美元以上的
-- 业务类型为：核心代码4015-客户现金兑换、2325代客结汇、2326代客售汇
--员工信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_01 AS
SELECT  COALESCE(A.EMPE_ID,B.EMPE_ID) AS EMPE_ID --柜员号
       ,COALESCE(A.ORG_ID,B.ORG_ID)   AS ORG_ID  --机构号
       ,COALESCE(A.POS_ENC,B.POS_ENC) AS POS_ENC --职位号
FROM
(
	SELECT  EMPE_ID
	       ,ORG_ID
	       ,POS_ENC
	FROM edw.DWS_HR_EMPE_INF_DD --员工汇总信息
	WHERE DT = '@@{yyyyMMdd}'
) A
FULL JOIN
(
	SELECT  TLR_ID     AS EMPE_ID
	       ,BUS_ORG_ID AS ORG_ID
	       ,''         AS POS_ENC
	FROM edw.DIM_BUS_CHNL_CNT_TLR_INF_DD A --柜员参数表
	WHERE A.DT = '@@{yyyyMMdd}'
) B
ON A.EMPE_ID = B.EMPE_ID
;
-- 联网核查记录表
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_02
(
    BANK_NAME   STRING COMMENT '核查机构名称'
    ,BANK_CODE2 STRING COMMENT '核查机构网点代码'
    ,CHECKDATE  STRING COMMENT '联网核查日期'
    ,CHECKTIME  STRING COMMENT '联网核查时间'
    ,NAME       STRING COMMENT '公民姓名'
    ,ID_NO      STRING COMMENT '居民身份证件号码'
    ,RESULT     STRING COMMENT '核查结果'
    ,COUNTER_NO STRING COMMENT '柜员号'
    ,OPE_LINE   STRING COMMENT '业务条线'
    ,CHECKMODE  STRING COMMENT '核查方式'
    ,PURPOSE    STRING COMMENT '摘要'
    ,TB_ID      STRING COMMENT '提取编号'
    ,CHANNEL    STRING COMMENT '核查渠道'
)
COMMENT '公民联网核查日志记录表&mdash;临时表';
INSERT INTO SJXQ_SJ2024092091_CST_02
--身份核查登记表
SELECT  ''                                AS BANK_NAME
        ,COALESCE(B.ORG_ID, f.PRM_ORG_ID) AS BANK_CODE2 --主管护机构号
        ,A.JOB_DT                         AS CHECKDATE
        ,SUBSTR(A.CHK_DEAL_CPL_DT, 9, 6)  AS CHECKTIME
        ,A.CHK_NM                         AS NAME
        ,A.ID_CARD_NBR                    AS ID_NO
        ,CASE
           WHEN A.SNG_CHK_RSL_CD = '00' THEN '11'
           WHEN A.SNG_CHK_RSL_CD = '01' THEN '12'
           WHEN A.SNG_CHK_RSL_CD = '02' THEN '14'
           WHEN A.SNG_CHK_RSL_CD = '03' THEN '15'
           ELSE '16'
         END                              AS RESULT
        ,A.OPR_USR                        AS COUNTER_NO
        ,CASE
           WHEN C.POS_NM IS NOT NULL THEN SUBSTR(C.POS_NM, 1, 40)
           ELSE '业务部门'
         END                              AS OPE_LINE
        ,'10'                             AS CHECKMODE
        ,''                               AS PURPOSE
        ,''                               AS TB_ID
        ,'GAPS'                           AS CHANNEL
FROM    edw.DWD_BUS_IB_NTW_CHK_ID_CARD_JNL_DI A
LEFT JOIN    SJXQ_SJ2024092091_CST_01 B
ON      A.OPR_USR = B.EMPE_ID
LEFT JOIN    edw.DIM_HR_ORG_JOB_INF_DD C
ON      B.POS_ENC = C.POS_ID
AND     C.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.DWS_CST_IDV_BAS_INF_DD E
ON      A.ID_CARD_NBR = E.DOC_NBR
AND     E.DT = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_mng_inf_dd	f --客户集市-客户基础-客户管户信息
on e.cst_id=f.cst_id
and f.dt='@@{yyyyMMdd}'
WHERE   SUBSTR(A.CHK_DEAL_CPL_DT, 1, 8) >= '20240101'
AND     A.DT  >= '20240101'
--中金联网核查人行
UNION ALL
SELECT  ''                                             AS BANK_NAME --核查机构名称
        ,A.BANK_CODE2                                  AS BANK_CODE2 --核查机构网点代码
        ,REPLACE(SUBSTR(A.CHECKTIME, 1, 10), '-', '')  AS CHECKDATE --联网核查日期
        ,REPLACE(SUBSTR(A.CHECKTIME, 12, 10), ':', '') AS CHECKTIME --联网核查时间
        ,A.USERNAME                                    AS NAME --公民姓名
        ,A.IDNO                                        AS ID_NO --居民身份证件号码
        ,'16'                                          AS RESULT --核查结果
        ,'ZXGY'                                        AS COUNTER_NO --柜员号
        ,'互联网金融部'                                      AS OPE_LINE --业务条线
        ,'10'                                          AS CHECKMODE --核查方式
        ,CASE
           WHEN A.ZJRETCODE = '10' THEN '公民身份号码与姓名一致'
           ELSE '公民身份号码与姓名不一致'
         END                                           AS PURPOSE --摘要
        ,''                                            AS TB_ID
        ,'IFSP'                                        AS CHANNEL
FROM    edw.IFSP_ZJNETCHECK A --中金联网核查人行报送
WHERE   SUBSTR(A.CHECKTIME, 1, 10) >= '2024-01-01'
AND     A.DT  >= '20240101'
UNION ALL
SELECT  ''                                AS BANK_NAME --核查机构名称
        ,COALESCE(B.ORG_ID, C1.PRM_ORG_ID) AS BANK_CODE2 --核查机构网点代
        ,A.PLF_DT                         AS CHECKDATE --联网核查日期
        ,SUBSTR(A.MSG_SND_TM, 9, 6)       AS CHECKTIME --联网核查时间
        ,A.BY_QRY_PSN_NM                  AS NAME --公民姓名
        ,A.ID_CARD_NBR                    AS ID_NO --居民身份证件号码
        ,CASE
           WHEN A.CHK_RSL = 'MCHD' THEN '11'
           WHEN A.CHK_RSL = 'NMCH' THEN '14'
           WHEN A.CHK_RSL = 'SYAB' THEN '16'
           ELSE ''
         END                              AS RESULT --核查结果
        ,A.TLR_ID                         AS COUNTER_NO --柜员号
        ,CASE
           WHEN F.POS_NM IS NOT NULL THEN SUBSTR(F.POS_NM, 1, 40)
           ELSE '业务部门'
         END                              AS OPE_LINE --业务条线
        ,'11'                             AS CHECKMODE --核查方式
        ,''                               AS PURPOSE --摘要
        ,''                               AS TB_ID
        ,'SPMT'                           AS CHANNEL
FROM    edw.DWD_BUS_CHNL_SPMT_ENTP_INF_NTW_CHK_QRY_DTL_DD A --企业信息联网核查查询登记簿
LEFT JOIN    SJXQ_SJ2024092091_CST_01 B --员工信息表
ON      A.TLR_ID = B.EMPE_ID
LEFT JOIN    edw.DWS_CST_IDV_BAS_INF_DD C --个人客户基本信息汇总表
ON      A.ID_CARD_NBR = C.DOC_NBR
AND     C.DT = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_mng_inf_dd	c1 --客户集市-客户基础-客户管户信息
on c.cst_id=c1.cst_id
and c1.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_HR_ORG_JOB_INF_DD F --职位信息表
ON      B.POS_ENC = F.POS_ID
AND     F.DT = '@@{yyyyMMdd}'
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.CHNL_DT  >= '20240101'
AND     A.THD_PTY_MSG_ID = 'mivs.327.001.01'
UNION ALL
SELECT  ''                                  AS BANK_NAME --核查机构名称
        ,COALESCE(A.ZAM_BRANCHID, D.ORG_ID) AS BANK_CODE2 --核查机构网点代
        ,SUBSTR(A.ZAM_HOSTSENDTIME, 1, 8)   AS CHECKDATE --联网核查日期
        ,SUBSTR(A.ZAM_HOSTSENDTIME, 9, 6)   AS CHECKTIME --联网核查时间
        ,A.ZAM_NAME                         AS NAME --公民姓名
        ,A.ZAM_IDENTITY                     AS ID_NO --居民身份证件号码
        ,CASE
           WHEN A.ZAM_IFRICHARD = '0' THEN '15'
           WHEN A.ZAM_IFRICHARD = '1' THEN '11'
           ELSE ''
         END                                AS RESULT --核查结果
        ,A.ZAM_USERID                       AS COUNTER_NO --柜员号
        ,CASE
           WHEN F.POS_NM IS NOT NULL THEN SUBSTR(F.POS_NM, 1, 40)
           ELSE '业务部门'
         END                                AS OPE_LINE --业务条线
        ,'11'                               AS CHECKMODE --核查方式
        ,''                                 AS PURPOSE --摘要
        ,''                                 AS TB_ID
        ,'OUTD'                             AS CHANNEL
FROM    edw.OUTD_ZJ_ACCOUNTCERT_MAIN A --中金账号验证主表
LEFT JOIN    SJXQ_SJ2024092091_CST_01 D --员工信息表
ON      A.ZAM_USERID = D.EMPE_ID
LEFT JOIN    edw.DIM_HR_ORG_JOB_INF_DD F --职位信息表
ON      D.POS_ENC = F.POS_ID
AND     F.DT = '@@{yyyyMMdd}'
WHERE   A.DT  >= '20240101'
UNION ALL
SELECT  ''                                                 AS BANK_NAME --核查机构名称
        ,A.CHK_ORG_ID                                      AS BANK_CODE2 --核查机构网点代
        ,A.CHK_DT                                          AS CHECKDATE --联网核查日期
        ,SUBSTR(TO_CHAR(A.CHK_TM, 'yyyymmddhhmiss'), 9, 6) AS CHECKTIME --联网核查时间
        ,A.CST_NM                                          AS NAME --公民姓名
        ,A.DOC_NBR_CD                                      AS ID_NO --居民身份证件号码
        ,CASE
           WHEN A.CHK_RSL_INF IN ( '公民身份号码与姓名一致，且存在照片' , '要素核查匹配正确' ) THEN '11'
           WHEN A.CHK_RSL_INF = '公民身份号码与姓名一致，但不存在照片'                  THEN '12'
           WHEN A.CHK_RSL_INF = '公民身份号码存在，但与姓名不匹配'                    THEN '14'
           WHEN A.CHK_RSL_INF = '公民身份号码不存在'                           THEN '15'
           ELSE 16
         END                                               AS RESULT --核查结果
        ,A.CHK_TLR_ID                                      AS COUNTER_NO --柜员号
        ,CASE
           WHEN C.POS_NM IS NOT NULL THEN SUBSTR(C.POS_NM, 1, 40)
           ELSE '业务部门'
         END                                               AS OPE_LINE --业务条线
        ,'11'                                              AS CHECKMODE --核查方式
        ,''                                                AS PURPOSE --摘要
        ,''                                                AS TB_ID
        ,'NACE'                                            AS CHANNEL
FROM    edw.DWD_BUS_CHNL_CNT_ID_CHK_INF_DI A
LEFT JOIN    SJXQ_SJ2024092091_CST_01 B --员工信息表
ON      A.CHK_TLR_ID = B.EMPE_ID
LEFT JOIN    edw.DIM_HR_ORG_JOB_INF_DD C --职位信息表
ON      B.POS_ENC = C.POS_ID
AND     C.DT = '@@{yyyyMMdd}'
WHERE   A.DT  >= '20240101'
UNION ALL
SELECT  ''                       AS BANK_NAME --核查机构名称
        ,A.TRX_ORG_ID            AS BANK_CODE2 --核查机构网点代
        ,A.TRX_DT                AS CHECKDATE --联网核查日期
        ,SUBSTR(A.REG_TMS, 1, 6) AS CHECKTIME --联网核查时间
        ,A.CST_NM                AS NAME --公民姓名
        ,A.DOC_NBR               AS ID_NO --居民身份证件号码
        ,CASE
           WHEN A.DOC_VRF_RSL_CD = 'MCHD' THEN '11'
           WHEN A.DOC_VRF_RSL_CD = 'NMCH' THEN '14'
           WHEN A.DOC_VRF_RSL_CD = 'SYAB' THEN '16'
           ELSE ''
         END                     AS RESULT --核查结果
        ,A.TRX_TLR_ID            AS COUNTER_NO --柜员号
        ,CASE
           WHEN C.POS_NM IS NOT NULL THEN SUBSTR(C.POS_NM, 1, 40)
           ELSE '业务部门'
         END                     AS OPE_LINE --业务条线
        ,'11'                    AS CHECKMODE --核查方式
        ,''                      AS PURPOSE --摘要
        ,''                      AS TB_ID
        ,'NGAP'                  AS CHANNEL
FROM    edw.DWD_BUS_IB_NTW_CHK_ITF_CALL_SRL_DI A
LEFT JOIN    SJXQ_SJ2024092091_CST_01 B --员工信息表
ON      A.TRX_TLR_ID = B.EMPE_ID
LEFT JOIN    edw.DIM_HR_ORG_JOB_INF_DD C --职位信息表
ON      B.POS_ENC = C.POS_ID
AND     C.DT = '@@{yyyyMMdd}'
WHERE   A.DT  >= '20240101'
;
--外币现钞兑换
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_03 AS
select bus_dt                                   --业务日期|C10
	,trx_srl                                  --交易流水|C32
	,doc_chk_srl_nbr                          --身份核查流水号|C32
	,trx_opn_tm                               --交易打开时间|C20
	,sbm_orig_tm                              --提交开始时间|C20
	,sbm_end_tm                               --提交结束时间|C20
	,chnl_dt                                  --渠道日期|C10
	,menu_no                                  --菜单码|C10
	,menu_nm                                  --菜单名称|C256
	,trx_sts                                  --交易状态|C3
	,hdl_tlr_id                               --经办柜员号|C10
	,org_id                                   --机构号|C10
	,cmt                                      --备注|C256
	,rtn_no                                   --返回码|C32
	,rtn_inf                                  --返回信息|C2000
	,dbt_cst_id                               --借记客户号|C32
	,dbt_cst_nm                               --借记客户姓名|C128
	,crd_cst_id                               --贷记客户号|C32
	,act_ccy                                  --账户币种|C10
	,trx_amt                                  --交易金额|C32
	,cst_id                                   --客户号|C30
	,csh_amt                                  --现金金额|C30
	,trx_typ_cd                               --交易类型代码|C5
from edw.dwd_bus_chnl_cnt_trx_srl_di          --柜面交易流水表
where dt >= '20240101'
and dt <= '20240831'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092091_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092091_CST_04 AS
SELECT  t4.org_nm    AS 机构
    ,t1.org_id       AS 机构编号
    ,t1.sbm_orig_tm  AS 提交开始时间
    ,t1.sbm_end_tm   AS 提交结束时间
    ,menu_nm         AS 业务类型
    ,trx_srl         AS 交易流水
    ,hdl_tlr_id      AS 经办柜员号
    ,trx_amt         AS 交易金额
    ,act_ccy         AS 账户币种
    ,t2.cst_chn_nm   AS 客户姓名
    ,T3.rcg_cpl_tm   AS 核查完成时间
    ,T3.face_rcg_rsl AS 人脸识别结果
    ,T3.rcg_rsl      AS 联网核查结果
    ,T3.rcg_rsl_dscr AS 联网核查结果描述
    ,case when t5.id_no is not null then '是' else '' end as是否联网核查
    ,t5.CHECKDATE  as 联网核查日期
from SJXQ_SJ2024092091_CST_03                       t1
left join edw.dws_cst_bas_inf_dd 				    t2   --客户基础信息汇总表
on t1.cst_ID=t2.cst_id
and t2.dt='20240831'
LEFT JOIN    edw.dwd_bus_chnl_cnt_face_rcg_inf_di   T3 --柜面业务人脸识别信息
ON      t1.trx_srl = T3.trx_seq
AND     T1.bus_dt = T3.trx_dt
AND     T3.DT >= '20240101'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t1.org_id = t4.org_id
and t4.dt = '20240831'
LEFT JOIN    SJXQ_SJ2024092091_CST_02               t5
ON      t2.doc_nbr = t5.id_no
AND     t1.bus_dt = t5.checkdate  --交易当天
AND     t2.doc_typ_cd = '110001'
AND     t5.checkdate >= '20240101'
;
SElECT '01' seq, count(1) cnt,count(distinct EMPE_ID) custs
from SJXQ_SJ2024092091_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ID_NO) custs
from SJXQ_SJ2024092091_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct trx_srl) custs
from SJXQ_SJ2024092091_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 交易流水) custs
from SJXQ_SJ2024092091_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024092091_CST_04
;
/*
SELECT   T2.cst_id        AS 客户号
        ,T1.act_nm       AS 姓名
        ,T1.cst_act_id   AS 客户账号
        ,T1.dep_act_id   AS 存款账号
        ,CASE
           WHEN COALESCE(T1.agn_nm,'') <>'' THEN '是'
           ELSE '否'
         END             AS 是否为代理
        ,T1.agn_nm       AS 代理人姓名
        ,T1.trx_dt       AS 业务日期
        ,T1.tlr_srl_nbr  AS 业务流水号
        ,T4.trx_seq      AS 被代理人和代理人身份核查流水号
        ,T1.trx_tm       AS 提交开始时间
        ,T1.txt_code     AS 菜单码
        ,T1.smr_dscr     AS 菜单名称
        ,T1.opr_tlr      AS 经办柜员号
        ,T1.trx_bus_org  AS 机构号
        ,T1.bal_fld_nm   AS 余额字段名称
        ,T4.face_rcg_rsl AS 人脸识别结果
        ,T4.rcg_rsl      AS  联网核查结果
        ,T4.rcg_rsl_dscr AS  联网核查结果描述
FROM    edw.DWD_BUS_DEP_BAL_CHG_DTL_DI T1 --存款账户余额发生明细
LEFT JOIN    edw.dws_bus_dep_act_inf_dd T2 --存款账户信息汇总
ON      T1.dep_act_id = T2.dep_act_id
AND     T1.cst_act_id = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_com_core_trx_msg_inf_di T3 --核心交易报文信息
ON      T1.tlr_srl_nbr = T3.trx_srl_nbr --柜员流水与交易流水关联
AND     T1.trx_dt = T3.trx_dt
AND     T3.DT >= '20220101'
LEFT JOIN    edw.dwd_bus_chnl_cnt_face_rcg_inf_di T4 --柜面业务人脸识别信息
ON      T3.glbl_srl_nbr = T4.trx_seq
AND     T3.trx_dt = T4.trx_dt
AND     T4.DT >= '20220101'
WHERE   T1.dt >= '20220101'
AND     T1.TRX_CHNL_CD IN ( 'A01' ) --柜面
AND     T1.bal_fld_nm = 'DPLDGBAL'
AND     T1.csh_ind      = '0'   --现转标志
AND     T1.trx_amt     >= 10000
AND     T2.cst_tp     = '1' -- 个人客户
AND     T1.opn_org  like '3563%'
;
--外汇买卖
INSERT INTO lab_bigdata_dev.TMP_FCT_CASH_INCOM_EXPOR_BUSI_SUM_2
--收入：  1.用户使用外币（现金）在柜面兑换为本币（非现金）
--        2.用户使用外币（现金）在柜面兑换为本币（现金）
SELECT  COALESCE(B.CST_ID, C.CST_ID, D.CST_ID, '')    AS DEP_AR_ID --客户号 以证件号关联客户信息，如无可能为非我行客户现金兑换现金，客户号置空
        ,'2'                                          AS BUS_BRED_CD --外币兑换业务
        ,'a'                                          AS TRAN_CHNL --柜面
        ,SUBSTR(TO_DATE(A.TRX_DT, 'yyyyMMdd'), 1, 10) AS TRAN_DT
        ,A.BUS_BLG_ORG -- 业务归属机构
        ,SUM(A.SEL_AMT)                               AS TRAN_AMT -- 卖出金额 --统一折算为人民币进行统计
        ,'C'                                          AS DRCR_IND -- 借贷标志
        ,NULL
        ,NULL
        ,NULL
        ,NULL
FROM    ${odps_edw}.DWD_BUS_IBIZ_IDV_FX_STL_DTL_DD A
LEFT JOIN    ${odps_edw}.DWS_CST_BAS_INF_DD B
ON      B.DT = '@@{yyyyMMdd}'
AND     B.CST_TYP_CD = '1'
AND     A.OPR_DOC_NBR = B.DOC_NBR
LEFT JOIN    ${odps_edw}.DIM_BUS_DEP_CST_ACT_INF_DD C
ON      C.DT = '@@{yyyyMMdd}'
AND     A.BUY_ACT_ID = C.CST_ACT_ID
LEFT JOIN    ${odps_edw}.DIM_BUS_DEP_CST_ACT_INF_DD D
ON      D.DT = '@@{yyyyMMdd}'
AND     A.SEL_ACT_ID = D.CST_ACT_ID
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.TRX_DT = '@@{yyyyMMdd}'
AND     A.FX_TRD = '13' --代客结汇
AND     A.CPT_SRC = '0' --资金来源为0-现金  即用户持外币现金来兑换为任何形式的人民币
AND     A.SEL_CCY = '156' --卖出币种为人民币
AND     A.BUY_CCY NOT IN ( '156' , 'CNY' ) --买入币种不为人民币
AND     A.FX_STL_STAT_CD IS NOT NULL -- 结售汇统计代码
AND     A.FX_STL_STAT_CD <> ''
GROUP BY COALESCE(B.CST_ID, C.CST_ID, D.CST_ID, '') , A.BUS_BLG_ORG , SUBSTR(TO_DATE(A.TRX_DT, 'yyyyMMdd'), 1, 10)
--  支出：  1.用户使用本币（非现金）在柜面兑换为外币（现金）
--          2.用户使用本币（现金）在柜面兑换为外币（现金）
UNION ALL
SELECT  COALESCE(B.CST_ID, C.CST_ID, '')              AS DEP_AR_ID --客户号 以证件号关联客户信息，如无可能为非我行客户现金兑换现金，客户号置空
        ,'2'                                          AS BUS_BRED_CD --外币兑换业务
        ,'a'                                          AS TRAN_CHNL --柜面
        ,SUBSTR(TO_DATE(A.TRX_DT, 'yyyyMMdd'), 1, 10) AS TRAN_DT
        ,A.BUS_BLG_ORG -- 业务归属机构
        ,SUM(A.BUY_AMT)                               AS TRAN_AMT -- 买入金额 --统一折算为人民币进行统计
        ,'D'                                          AS DRCR_IND -- 借贷标志
        ,NULL
        ,NULL
        ,NULL
        ,NULL
FROM    ${odps_edw}.DWD_BUS_IBIZ_IDV_FX_STL_DTL_DD A
LEFT JOIN    ${odps_edw}.DWS_CST_BAS_INF_DD B
ON      B.DT = '@@{yyyyMMdd}'
AND     B.CST_TYP_CD = '1'
AND     A.OPR_DOC_NBR = B.DOC_NBR
LEFT JOIN    ${odps_edw}.DIM_BUS_DEP_CST_ACT_INF_DD C
ON      C.DT = '@@{yyyyMMdd}'
AND     A.SEL_ACT_ID = C.CST_ACT_ID ---------------------------------------------------------------------------
WHERE   A.DT = '@@{yyyyMMdd}'
AND     A.TRX_DT = '@@{yyyyMMdd}'
AND     A.FX_TRD = '15' --代客售汇
AND     A.CPT_QXNG = '0' --资金去向为0-现金  即用户以任何形式的人民币兑换为外币现金
AND     A.BUY_CCY = '156' --买入币种为人民币
AND     A.SEL_CCY NOT IN ( '156' , 'CNY' ) --卖出币种不为人民币，即为外币
AND     A.FX_STL_STAT_CD IS NOT NULL -- 结售汇统计代码
AND     A.FX_STL_STAT_CD <> ''
GROUP BY COALESCE(B.CST_ID, C.CST_ID, '') , A.BUS_BLG_ORG , SUBSTR(TO_DATE(A.TRX_DT, 'yyyyMMdd'), 1, 10);
*/
***SJ2024092306_台州三门支行信贷数据.sql
-- 截止9月22日，台州三门支行所有信贷客户风险等级
-- 数据需求字段
-- 客户号、客户名称、合同到期日、贷款余额、管户部门、管记客户经理、贷款担保人客户号、贷款担保人客户名称、担保人在我行是否有贷款
DROP   TABLE IF     EXISTS SJXQ_SJ2024092306_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092306_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.reg_typ_cd	    --登记类型代码|c2
    ,c3.cd_val_dscr     as reg_typ_nm
    ,t1.mgr_id	        --管户人工号|c10
    ,t1.mgr_org_id	    --管户机构号|c12
    ,t1.inv_in_indy_cd	--投向行业代码|c5
    ,c1.cd_val_dscr     as inv_in_indy_nm
    ,t1.hdl_opr_id	    --经办人工号|c12
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.inv_in_indy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C3
ON  t1.reg_typ_cd = C3.CD_VAL
AND C3.DT = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
-- and t1.ctr_bgn_dt<='20230831'
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024092306_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092306_CST_02 AS
SElECT t1.CTR_SERNO
    ,t2.GRNT_CTR_NO	    --担保合同编号
    ,nvl(t4.GTOR_NO,t6.OBG_ID) as GTOR_NO	                                    --保证人编号|C20
    ,nvl(t4.GTOR_NM,t6.OBG_NM) as GTOR_NM	                                    --保证人名称|C200
    ,t4.WITH_BRWR_REL	                            --与借款人关系
    ,t4.GRNT_AMT
    ,case when t8.cst_id is not null then '是' else '否' end is_loan_cst
    ,row_number() over(partition by t1.CTR_SERNO ORDER by t4.GRNT_AMT desc) rn
from SJXQ_SJ2024092306_CST_01               t1
left join(
    SElECT distinct CTR_SERNO,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '@@{yyyyMMdd}'
) t2 on t1.CTR_SERNO = t2.CTR_SERNO
left join edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD	t4 --担保合同保证人信息
on t2.GRNT_CTR_NO=t4.GRNT_CTR_NO
and t4.dt='@@{yyyyMMdd}'
left join (
    SElECT distinct GRNT_CTR_NO,OBG_ID,OBG_NM
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='@@{yyyyMMdd}'
) t6 on t2.GRNT_CTR_NO=t6.GRNT_CTR_NO
left join edw.dws_cst_idv_bas_inf_dd	t7 --个人客户基本信息汇总表
on nvl(t4.GTOR_NO,t6.OBG_ID) = t7.cst_id
and t7.dt='@@{yyyyMMdd}'
left join(
    SElECT distinct cst_id
    from SJXQ_SJ2024092306_CST_01
    where ctr_bal>0
)t8 on nvl(t4.GTOR_NO,t6.OBG_ID)=t8.cst_id
where t1.sbr_org_nm='台州三门支行'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092306_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092306_CST_03 AS
SELECT  t1.CTR_SERNO     AS 合同号
       ,t2.cst_id        AS 客户号
       ,t2.cst_nm        AS 客户名称
       ,t2.ctr_amt       AS 合同金额
       ,t2.ctr_bal       AS 合同余额
       ,t2.ctr_bgn_dt    AS 合同起始日期
       ,t2.ctr_mtu_dt    AS 合同到期日期
       ,t2.org_nm        AS 管户部门
       ,t2.mgr_nm        AS 管户客户经理
       ,t1.GRNT_CTR_NO   AS 担保合同编号
       ,t1.GTOR_NO       AS 保证人编号
       ,t1.GTOR_NM       AS 保证人名称
       ,t1.WITH_BRWR_REL AS 与借款人关系
       ,t1.is_loan_cst   AS 担保人在我行是否有贷款
from SJXQ_SJ2024092306_CST_02       t1
left join SJXQ_SJ2024092306_CST_01  t2
on t1.ctr_serno=t2.ctr_serno
;
SElECT '01' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ2024092306_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ2024092306_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同号) custs
from SJXQ_SJ2024092306_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2024092306_CST_03
***SJ2024092341_清单押品评估.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024092341_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092341_CST_01 AS
SELECT  col_1      --序号
        ,col_2     --合同流水号
        ,col_3     --客户号
        ,col_4     --客户姓名
        ,col_5     --经办日期
        ,col_6     --合同到期日期
        ,col_7     --合同金额
        ,col_8     --余额
        ,col_9     --风险控制号
        ,col_10    --管户机构号
        ,col_11    --管户机构
        ,col_12    --管户员工号
        ,col_13    --管户员工
        ,col_14    --经办机构号
        ,col_15    --经办机构
        ,col_16    --经办人工号
        ,t1.col_17 --经办人
        ,t1.col_18 --业务产品名称
        ,t1.col_19 --担保人姓名
        ,t1.col_20 --担保合同编号
        ,t1.col_21 --押品编号
        ,t1.col_22 --押品名称
        ,t1.col_23 --评估基准日期
        ,t1.col_24 --评估效力截止日期
        ,t1.col_25 --估值方法代码
        ,t1.col_26 --抵质押率
        ,t1.col_27 --评估价值
        ,t1.col_28 --认定价值
    ,t4.hpn_typ_cd
    ,c2.cd_val_dscr     as hpn_typ_nm
from qbi_file_20240925_11_02_21             t1
left join edw.dim_bus_loan_ctr_bse_inf_dd   t4 --合同基础信息
on t1.col_2=t4.ctr_serno
and t4.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t4.hpn_typ_cd = C2.CD_VAL
AND C2.DT = '@@{yyyyMMdd}'
where pt<>''
;
-- 是否首次抵押
DROP   TABLE IF     EXISTS SJXQ_SJ2024092341_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092341_CST_02 AS
SELECT  t1.col_2
       ,t5.grnt_ctr_no     --担保合同编号
       ,t5.GRNT_GDS_TYP_CD --担保物类型代码1保证人2押品
       ,t5.grnt_gds_id     --担保物编号
       ,t5.grnt_gds_nm	    --担保物名称|c200
       ,t2.ases_val        --评估价值
       ,t2.afm_val         --认定价值
       ,t2.ases_bss_dt     --评估基准日期
       ,t3.sequesteredflag --是否首次抵押
FROM SJXQ_SJ2024092341_CST_01                       t1
INNER JOIN edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd t5 --主合同、担保合同、担保物关系
on t1.col_2=t5.CTR_SERNO
and t5.dt = '@@{yyyyMMdd}'
and t5.GRNT_GDS_TYP_CD='2' --押品
INNER JOIN (
    select cltr_no       --押品编号|c32
        ,ases_val        --评估价值
        ,afm_val         --认定价值
        ,ases_bss_dt     --评估基准日期
        ,row_number() over(partition by cltr_no order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd
    where dt = '@@{yyyyMMdd}'
) t2 ON t5.grnt_gds_id = t2.cltr_no
and t2.rn=2     --上一次
left join edw.loan_guaranty_info  t3 --担保物信息表
on t5.grnt_gds_id=t3.guarantyid	--担保物编号
and t3.dt='20240719'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092341_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092341_CST_03 AS
SELECT  t1.col_1            AS 序号
        ,t1.col_2           AS 合同流水号
        ,t1.col_3           AS 客户号
        ,t1.col_4           AS 客户姓名
        ,t1.col_5           AS 经办日期
        ,t1.col_6           AS 合同到期日期
        ,t1.col_7           AS 合同金额
        ,t1.col_8           AS 余额
        ,t1.col_9           AS 风险控制号
        ,t1.col_10          AS 管户机构号
        ,t1.col_11          AS 管户机构
        ,t1.col_12          AS 管户员工号
        ,t1.col_13          AS 管户员工
        ,t1.col_14          AS 经办机构号
        ,t1.col_15          AS 经办机构
        ,t1.col_16          AS 经办人工号
        ,t1.col_17          AS 经办人
        ,t1.col_18          AS 业务产品名称
        ,t1.col_19          AS 担保人姓名
        ,t1.col_20          AS 担保合同编号
        ,t2.grnt_gds_id     AS 押品编号
        ,t2.grnt_gds_nm     AS 押品名称
        ,t1.col_23          AS 评估基准日期
        ,t1.col_24          AS 评估效力截止日期
        ,t1.col_25          AS 估值方法代码
        ,t1.col_26          AS 抵质押率
        ,t1.col_27          AS 评估价值
        ,t1.col_28          AS 认定价值
        ,t2.sequesteredflag AS 是否首次抵押
        ,t1.hpn_typ_nm      AS 发生类型
        ,t2.ases_val        AS 上一次评估价值
        ,t2.afm_val         AS 上一次认定价值
        ,t2.ases_bss_dt     AS 上一次评估基准日期
from SJXQ_SJ2024092341_CST_01       t1
left join SJXQ_SJ2024092341_CST_02  t2
on  t1.col_2=t2.col_2
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024092341_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct col_2,grnt_ctr_no,grnt_gds_id) custs
from SJXQ_SJ2024092341_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号,押品编号) custs
from SJXQ_SJ2024092341_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2024092341_CST_03
;
***SJ2024092746_政和村行相关数据.sql
-- 检查期限：2023年11月1日至2024年9月末
-- 政和村行相关数据
-- 3561     政和
-- SJ2024092746
-- 3.截至2024年9月末，我行存量对公信息与外部工商信息不一致客户清单
-- 公司留存状态是否正常，法人是否与行内留存信息一致，受益所有人信息是否一致
------标准代码块：惠众受益人
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_01 AS
SELECT  B.QYMC                        AS 惠众_企业名称
        ,B.zt                         AS 惠众企业状态
        ,C.BENF_NAME                  AS 惠众_受益人名称
        ,C.BENF_OWNER_RLTNP_TP        AS 惠众_受益所有人关系
        ,substr(C.update_time, 1, 10) AS 惠众更新日期
        ,C.drct_shrhld_rto            AS 直接持股比例
        ,C.indt_shrhld_rto            AS 间接持股比例
        ,C.smy_shrhld_rto             AS 合计持股比例
        ,C.level                      AS 穿透层级
FROM    EDW.DCIP_ENT_BASIC_INFO B ----企业基本信息
INNER JOIN    EDW.DCIP_ENT_FAVOREE_INFO_WBGS C ----受益人信息
ON      C.REL_COMPANY_ID = B.HZZX_ID ----内部流水号
AND     C.DT = '20240930'
WHERE   b.dt = '20240930'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_02 AS
SELECT  t1.cst_id        AS 客户号
       ,t1.cst_nm        AS 客户名称
       ,t1.opr_situ_cd   AS 经营状况代码
       ,c1.cd_val_dscr   AS 经营状况
       ,t1.lctax_cert_no AS 地税证件号
       ,t2.legal_person  AS 法定代表人_工商信息
       ,t5.lgp_cst_id    AS 对公客户法人客户号_行内
       ,t5.lgp_nm        AS 对公客户法人客户名称_行内
       ,case when nvl(t2.legal_person,'')<>'' and nvl(t5.lgp_nm,'')<>'' and t2.legal_person=t5.lgp_nm then '是'
            else '' end  as 法人是否与行内留存信息一致
       ,t6.rel_cst_id    AS 受益人客户号_行内
       ,t7.cst_chn_nm    as 受益人客户名称_行内
       ,t8.惠众_受益人名称
       ,case when nvl(t7.cst_chn_nm,'')<>'' and nvl(t8.惠众_受益人名称,'')<>'' and t7.cst_chn_nm=t8.惠众_受益人名称 then '是'
            else '' end  as 受益所有人信息是否一致
from edw.dim_cst_entp_bas_inf_dd	t1 --企业客户基本信息
left join edw.nout_company_base     t2 --企业基本信息表
on t1.lctax_cert_no=t2.credit_no
and t2.dt='20240930'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20240930'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20240930'
left join edw.dim_cst_entp_lgp_inf_dd       t5     --对公客户法人信息表
on t1.cst_id=t5.cst_id
and t5.dt='20240930'
LEFT JOIN    EDW.DIM_CST_REL_INF_DD         t6
ON      t1.cst_id = t6.CST_ID
AND     t6.REL_TYP_CD LIKE '09%' --受益人
AND     t6.DT = '20240930'
left join edw.dws_cst_bas_inf_dd 			t7	    --客户基础信息汇总表
on t6.rel_cst_id=t7.cst_id
and t7.dt = '20240930'
left join SJXQ_SJ2024092746_CST_01          t8
on t1.cst_nm=t8.惠众_企业名称
left join edw.dwd_code_library                      c1
on t1.opr_situ_cd=c1.cd_val
where t1.dt='20240930'
and t4.brc_org_id like '3561%'    --管户机构
;
-- 5.截至2024年9月末，对私：同一个证件号码对应两个以上客户号清单；对公：同一个对公客户名称对应两个以上客户号清单  --gyp
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_11 AS
SELECT  t1.cst_id       AS 客户号
       ,md5(t1.doc_nbr) AS 加密证件号
from adm_pub.adm_csm_cbas_idv_bas_inf_dd t1	--对私客户基础信息
inner join(
    SElECT doc_nbr
    from adm_pub.adm_csm_cbas_idv_bas_inf_dd
    where dt='20240930' and nvl(doc_nbr,'')<>''
    and org_mngr_id	like '3561%'    --管户机构
    group by doc_nbr
    having count(distinct cst_id)>1
)t2 on t1.doc_nbr=t2.doc_nbr
where t1.dt='20240930'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_12 AS
SELECT  t1.cst_id AS 客户号
       ,t1.cst_nm AS 客户名称
from edw.dim_cst_entp_bas_inf_dd        t1	--企业客户基本信息
inner join(
    SElECT cst_nm   --客户名称
    from edw.dim_cst_entp_bas_inf_dd  		--企业客户基本信息
    where dt='20240930' and nvl(cst_nm,'')<>''
    and upd_org_id	like '3561%'    --更新机构号
    group by cst_nm
    having count(distinct cst_id)>1
)t2 on t1.cst_nm=t2.cst_nm
where t1.dt='20240930'
;
-- 6.截至2024年9月末，同一个联系方式被两个以上客户留存清单 --gyp
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_13 AS
SELECT  t1.cst_id       AS 客户号
       ,md5(t1.mbl_nbr) AS 加密手机号
from edw.dws_cst_bas_inf_dd	 t1     --客户基础信息汇总表
inner join(
    SElECT mbl_nbr   --客户名称
    from edw.dws_cst_bas_inf_dd	    --客户基础信息汇总表
    where dt='20240930' and nvl(mbl_nbr,'')<>''
    and file_org_id	like '3561%'    --建档机构编号|C12
    group by mbl_nbr
    having count(distinct cst_id)>1
)t2 on t1.mbl_nbr=t2.mbl_nbr
where t1.dt='20240930'
;
-- 7.截至2024年9月末，同一个注册地址被两个以上客户留存清单 --gyp
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_14 AS
SELECT  t1.cst_id       AS 客户号
       ,md5(t1.reg_adr) AS 加密注册地址
from edw.dws_cst_bas_inf_dd	 t1     --客户基础信息汇总表
inner join(
    SElECT reg_adr   --客户名称
    from edw.dws_cst_bas_inf_dd	    --客户基础信息汇总表
    where dt='20240930' and nvl(reg_adr,'')<>''
    and file_org_id	like '3561%'    --建档机构编号|C12
    group by reg_adr
    having count(distinct cst_id)>1
)t2 on t1.reg_adr=t2.reg_adr
where t1.dt='20240930'
;
-- 14.对私客户账户被限制清单：
-- 是否止付 止付原因
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_15 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_15 AS
SELECT  cst_act_id,frz_rsn
    ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
WHERE   DT = '@@{yyyyMMdd}'
AND     FRZ_SRC_CD='2'  --止付
AND     NFRZ_IND = '0'
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_16 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_16 AS
SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
    ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T1.FRZ_SRC_CD='1'  --冻结
AND     T1.NFRZ_IND = '0'
;
--账户是否关闭非柜面 关闭非柜面原因
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_17 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_17 AS
SELECT  cst_act_id,lmt_cmt
    ,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
WHERE   DT = '@@{yyyyMMdd}'
AND     ACT_THRS_TYP = '2' --暂停非柜面
and     evt_id='DPDRAW'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024092746_CST_18 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024092746_CST_18 AS
SELECT  T1.cst_id                                                            AS 客户号
       ,T1.act_nm                                                            AS 账户名称
       ,T1.cst_act_id                                                        AS 客户账号
       ,T1.dep_act_id                                                        AS 存款账号
       ,T1.opn_dt                                                            AS 开户日期
       ,t23.bth_dt                                                           AS 出生日期
       ,decode(t23.gdr_cd,'1','男','2','女','未知')                           AS 性别
       ,t23.doc_typ_cd                                                        as  证件类型
-- , t23.doc_nbr string 证件号码
-- , t23.reg_adr_dtl_inf string 户籍地址
-- , t23.fam_adr_dtl_inf string 家庭地址
-- , t23.m_tel_no string 手机
       ,decode(T1.ACT_CTG_CD_2,'301','I类账户','302','II类账户','303','III类账户','') AS 账户类型 -- I、II、III类账户
       ,T1.ACT_STS_CD                                                        AS 账户状态代码
       ,T19.cd_val_dscr                                                      AS 账户状态
       ,CASE WHEN T12.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END          AS 是否关闭非柜面
       ,T12.lmt_cmt                                                          AS 关闭原因
       ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END           AS 是否冻结
       ,T6.frz_dt                                                            AS 冻结日期
       ,T6.frz_cls                                                           AS 冻结种类
       ,T6.frz_rsn                                                           AS 冻结原因
       ,CASE WHEN T11.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END          AS 是否止付
       ,T11.frz_rsn                                                          AS 止付原因
       ,T1.opn_org                                                           AS 开户机构编号
       ,T2.org_nm                                                            AS 开户机构名称
       ,T4.mgr_id                                                            AS 存款管户客户经理编号
       ,T5.empe_nm                                                           AS 存款管户客户经理名称
       ,A4.org_nm                                                            AS 存款管户客户经理考核机构
FROM    edw.dws_bus_dep_act_inf_dd              T1 --存款账户信息表
inner join(
    SElECT cst_act_id from SJXQ_SJ2024092746_CST_15 where rn=1
    union
    select cst_act_id from SJXQ_SJ2024092746_CST_16 where rn=1
    union
    select cst_act_id from SJXQ_SJ2024092746_CST_17 where rn=1
)t0 on t1.cst_act_id=t0.cst_act_id
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd     T2 --开户机构
ON      T1.opn_org = T2.org_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T4
ON      T1.cst_act_id = T4.cst_act_id
AND     T4.dt = '@@{yyyyMMdd}'
AND     T4.frs_ctc_ind = '1' --第一联系人标志
LEFT JOIN    edw.dws_hr_empe_inf_dd             T5
ON      T4.mgr_id = T5.empe_id
AND     T5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd     A4 --存款管户考核机构
ON      T4.acs_org_id = A4.org_id
AND     A4.dt = '@@{yyyyMMdd}'
LEFT JOIN    SJXQ_SJ2024092746_CST_16           t6 --冻结
on T1.cst_act_id = T6.cst_act_id
AND T6.RN = 1
LEFT JOIN    SJXQ_SJ2024092746_CST_15           T11 --止付
on T1.cst_act_id = T11.cst_act_id
AND T11.RN = 1
LEFT JOIN SJXQ_SJ2024092746_CST_17 T12 --账户额度控制
ON      T1.cst_act_id = T12.cst_act_id
and     t12.rn=1
LEFT JOIN    (
                 SELECT  cd_val
                         ,cd_val_dscr
                 FROM    edw.dwd_code_library_dd
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     cd_nm LIKE '%存款账户状态%'
                 AND     tbl_nm = 'DWS_BUS_DEP_ACT_INF_DD'
             ) T19
ON      T1.act_sts_cd = T19.cd_val
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t23 --对私客户基础信息
on t1.cst_id = t23.cst_id
and t23.dt = '@@{yyyyMMdd}'
WHERE   T1.ACT_CTG_CD_2 IN ( '301' , '302' , '303' ) -- I、II、III类账户 个人账户
AND     T1.STL_ACT_IND = '1'    --结算账户
-- AND     T1.opn_dt >= '20100101'
-- AND     T1.opn_dt <= '20231231'
AND     T1.DT = '@@{yyyyMMdd}'
AND     T1.opn_org LIKE '3561%' --政和村行
-- AND     T1.ACT_STS_CD = 'A'     --账户状态为正常
;
SElECT '01' seq, count(1) cnt,count(distinct 惠众_企业名称) custs
from SJXQ_SJ2024092746_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024092746_CST_02
union all
SElECT '11' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024092746_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024092746_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024092746_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024092746_CST_14
union all
SElECT '15' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2024092746_CST_15
union all
SElECT '16' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2024092746_CST_16
union all
SElECT '17' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2024092746_CST_17
union all
SElECT '18' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2024092746_CST_18
;
SElECT '01' seq, *
from SJXQ_SJ2024092746_CST_01
;
SElECT '02' seq, *
from SJXQ_SJ2024092746_CST_02
;
SElECT '11' seq, *
from SJXQ_SJ2024092746_CST_11
;
SElECT '12' seq, *
from SJXQ_SJ2024092746_CST_12
;
SElECT '13' seq, *
from SJXQ_SJ2024092746_CST_13
;
SElECT '14' seq, *
from SJXQ_SJ2024092746_CST_14
;
SElECT '18' seq, *
from SJXQ_SJ2024092746_CST_18
***SJ20240929116_半自助循环贷款年审业务.sql
-- 年审业务的审批时间、客户号、合同流水号、合同金额、借据流水号、借据金额、对应合同起始日等相关口径。
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ20240929116_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240929116_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.bsn_mark_cd	    --业务标识代码|c32
    ,c1.cd_val_dscr     as bsn_mark_nm
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm
    ,decode(t1.RVLG_TYP_CD,'0','非循环','1', '自助循环（融e贷）','2', '半自助','') as RVLG_TYP_nm2
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,T10.aprv_dt      AS 上一次完成年审时间
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = '@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  ctr_no
	       ,aprv_dt
	       ,ROW_NUMBER() OVER ( PARTITION BY ctr_no ORDER BY  aprv_dt DESC ) AS RN
	FROM edw.dwd_bus_loan_crc_ctr_year_chk_apl_inf_dd --循环贷款合同年审申请信息
	WHERE DT = '@@{yyyyMMdd}'
	AND aprv_dt <> '18991231'
) T10
ON T1.CTR_SERNO = T10.ctr_no AND T10.RN = 1
where t1.dt='@@{yyyyMMdd}'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据
DROP   TABLE IF     EXISTS SJXQ_SJ20240929116_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240929116_CST_02 AS
select DBIL_ID                                  --借据编号|C64
	,t1.CTR_SERNO                                --合同流水号|C32
	,USC_APLY_SERNO                           --用信申请流水号|C32
	,AMT                                      --金额DECIMAL(21,2)
	,LVE_ACT_BGN_DT                           --出账起始日期|C8
	,APNT_MTU_DT                              --约定到期日|C8
	,EXEC_MTU_DT                              --执行到期日|C8
	,PRCP_BAL                                 --本金余额DECIMAL(21,2)
	,TMT_DT                                   --终结日期|C8
	,REL_DBIL_ID                              --关联借据号|C32
	,PRCP_PYF_DT                              --本金结清日期|C8
	,ORIG_DBIL_ID                             --原来借据号|C64
	,PYF_IND                                  --结清标志|C1
	,OPN_DT                                   --开户日期|CVARCHAR20
	,CTR_AMT                                  --合同金额DECIMAL(21,2)
	,CUR_DTRB_AMT                             --已发放金额DECIMAL(21,2)
	,RMN_DTRB_AMT                             --可发放金额DECIMAL(21,2)
	,MTU_DT                                   --到期日期|C8
from edw.dim_bus_loan_dbil_inf_dd   t1            --信贷借据信息
inner join(
    select distinct ctr_serno
    from SJXQ_SJ20240929116_CST_01
)t2 on t1.ctr_serno=t2.ctr_serno
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240929116_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240929116_CST_03 AS
SELECT  T1.上一次完成年审时间
       ,t1.ctr_serno      AS 合同流水号
       ,t1.cst_id         AS 客户号
       ,t1.cst_nm         AS 客户名称
       ,t1.ctr_amt        AS 合同金额
       ,t1.ctr_bal        AS 合同余额
       ,t1.ctr_bgn_dt     AS 合同起始日期
       ,t1.ctr_mtu_dt     AS 合同到期日期
       ,t1.TMT_DT         AS 终结日期
       ,t1.usc_aply_dt    AS 用信申请日期
       ,t1.RVLG_TYP_nm    AS 循环类型
       ,t1.PD_NM          AS 产品名称
       ,t1.mgr_id         AS 管户人工号
       ,t1.mgr_nm         AS 管户人姓名
       ,t1.org_nm         AS 管户机构
       ,t2.DBIL_ID        AS 借据编号
       ,t2.AMT            AS 借据金额
       ,t2.LVE_ACT_BGN_DT AS 出账起始日期
       ,t2.APNT_MTU_DT    AS 约定到期日
       ,t2.EXEC_MTU_DT    AS 执行到期日
       ,t2.PRCP_BAL       AS 本金余额
       ,t2.PYF_IND        AS 结清标志
       ,t2.OPN_DT         AS 开户日期
       ,t2.MTU_DT         AS 到期日期
from SJXQ_SJ20240929116_CST_01          t1
inner join SJXQ_SJ20240929116_CST_02    t2
on t1.ctr_serno=t2.ctr_serno
where t1.RVLG_TYP_CD='2'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240929116_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20240929116_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20240929116_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20240929116_CST_03
;
***SJ2024093011_大冶村行小鱼管家取数.sql
-- 客户群组
DROP   TABLE IF     EXISTS SJXQ_SJ2024093011_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093011_CST_01 AS
SELECT  T1.DT                                    AS 会计日期
        ,T1.ID
        ,T3.brc_org_nm                           AS 群组创建分行
        ,t1.group_name                           AS 供应链群组名称
        ,COALESCE(t4.cst_id, T41.cst_id)         AS 核心企业客户编号
        ,COALESCE(t4.cst_chn_nm, T41.cst_chn_nm) AS 核心企业名称
        ,MAX(CASE WHEN T2.cst_id = COALESCE(t4.cst_id, T41.cst_id) THEN 1 ELSE 0 END) AS 核心企业是否群组内客户
FROM    app_yxpt.cst_group t1 --客户群组
LEFT JOIN    app_yxpt.cst_group_x_customer t2 --客户群组用户关联信息表
ON      t1.id = t2.group_id
AND     t1.dt = t2.dt
inner JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T1.org_code = T3.org_id
AND     t1.dt = t3.dt
and     SUBSTR(t3.org_id, 1, 4) = '4261' --湖北大冶泰隆村镇
LEFT JOIN    edw.dws_cst_bas_inf_dd t4 --客户基础信息汇总表
ON      SUBSTR(t1.group_name, 1, 10) = t4.cst_id
AND     t1.dt = t4.dt
LEFT JOIN    edw.dws_cst_bas_inf_dd t41 --客户基础信息汇总表
ON      substring_index(REPLACE(t1.group_name, '【平台搭建】', ''), '供应链项目', 1) = t41.cst_chn_nm
AND     t1.dt = t41.dt
WHERE   t1.dt = '@@{yyyyMMdd}'
-- AND     ( t1.group_name LIKE '%供应链项目' OR t1.group_name LIKE '%供应链项目2023' )
and t1.group_name regexp '隐患客户'
AND     t1.del_flg = '0' --剔除已经删除的群组
GROUP BY T1.DT , T1.ID , T3.brc_org_nm , t1.group_name , COALESCE(t4.cst_id, T41.cst_id) , COALESCE(t4.cst_chn_nm, T41.cst_chn_nm) ;
-- 信贷管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024093011_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093011_CST_02 AS
SElECT distinct t1.cst_id,t1.cst_nm
    ,t3.mgr_id                                   --管户人工号|C10
	,t3.mgr_nm                                   --管户人姓名|C200
	,t3.mgr_org_id                               --管户机构号|C12
    ,t4.brc_org_id,t4.sbr_org_id,t4.tem_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
from(
    SElECT distinct 核心企业客户编号 as cst_id
        ,核心企业名称 as cst_nm
    from SJXQ_SJ2024093011_CST_01
)t1 inner join edw.dim_bus_loan_ctr_bse_inf_dd      t2 --合同基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd          t3 --信贷合同管护信息
on t2.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024093011_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093011_CST_03 AS
SELECT  t1.cst_id                 AS 客户号
       ,t1.cst_nm                 AS 客户名称
       ,t1.mgr_id                 AS 信贷管户人工号
       ,t1.mgr_nm                 AS 信贷管户人姓名
       ,t1.brc_org_id             AS 信贷管户分行ID
       ,t1.brc_org_nm             AS 信贷管户分行
       ,t1.sbr_org_id             AS 信贷管户支行ID
       ,t1.sbr_org_nm             AS 信贷管户支行
       ,t1.tem_org_id             AS 信贷管户团队ID
       ,t1.tem_org_nm             AS 信贷管户团队
       ,t3.prm_mgr_id             AS 主管户人工号
       ,t3.prm_mgr_nm             AS 主管户人姓名
       ,t4.brc_org_id             AS 主管户分行ID
       ,t4.brc_org_nm             AS 主管户分行
       ,t4.sbr_org_id             AS 主管户支行ID
       ,t4.sbr_org_nm             AS 主管户支行
       ,t4.tem_org_id             AS 主管户团队ID
       ,t4.tem_org_nm             AS 主管户团队
       ,t2.hidden_danger_measures AS 隐患管理措施
       ,t2.measure_date           AS 措施执行日期
       ,t2.specific_plan          AS 具体方案
from SJXQ_SJ2024093011_CST_02           t1
left join edw.xwdt_xw_loan_measures     t2 --隐患风险贷后管理措施
on t1.cst_id=t2.cust_no
and t2.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct 核心企业客户编号) custs
from SJXQ_SJ2024093011_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024093011_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024093011_CST_03
;
SElECT '01' seq, *
from SJXQ_SJ2024093011_CST_01
;
SElECT '02' seq, *
from SJXQ_SJ2024093011_CST_02
;
SElECT '03' seq, *
from SJXQ_SJ2024093011_CST_03
***SJ2024093021_大V卡定向提额产效分析.sql
-- 导入数据 大V卡
DROP   TABLE IF     EXISTS SJXQ_SJ2024093021_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093021_CST_01 AS
SELECT  col_1 --机构编号
       ,col_2 --序号
       ,col_3 --机构名称
       ,col_4 --客户号
       ,col_5 --客户姓名
       ,col_6 --借记卡账号
       ,col_7 --申报额度_万元
       ,col_8 --填报时间
from qbi_file_20241009_16_06_02
where pt<>''
;
-- 活期存款月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024093021_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093021_CST_02 AS
select t1.cst_id
    ,t1.dmnd_dep_bal_mon_avg	--活期存款余额月日均
    ,t1.dt
    ,substr(t1.dt,1,6)  as trx_mon
from adm_pub.adm_csm_cbus_dep_inf_dd t1 		--存款业务信息表
inner join(
    select distinct col_4 as cst_id
    from SJXQ_SJ2024093021_CST_01
)t2 on t1.cst_id=t2.cst_id
;
--微信提现 微信支付
DROP   TABLE IF     EXISTS SJXQ_SJ2024093021_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093021_CST_03 AS
select t1.cst_id
    ,t2.dep_act_id		--存款账号
    ,t2.cst_act_id		--客户账号
    ,t2.trx_dt			--交易日期
    ,t2.trx_tm          --交易时间
    ,substr(t2.trx_dt,1,6)  as trx_mon
    ,t2.crd_and_dbt_ind	--借贷标志
    ,t2.trx_amt			--交易金额
    ,t2.txt_code		--摘要代码
    ,t2.smr_dscr		--摘要描述
    ,t2.cmt             --备注
    ,case when CONCAT(t2.smr_dscr,t2.cmt) regexp '微信提现' and t2.crd_and_dbt_ind='C' then '微信提现'
        when CONCAT(t2.smr_dscr,t2.cmt) regexp '微信|财付通' and t2.crd_and_dbt_ind='D' then '微信支付'
        else '' end trx_type
from (
    select distinct col_4 as cst_id
        ,col_6 as act_id
    from SJXQ_SJ2024093021_CST_01
) t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di t2
on t1.act_id=t2.cst_act_id
and t2.dt<='20241009'
and t2.dt>='20230801'
and (t2.smr_dscr regexp '财付通' or t2.trx_chnl_cd = 'H04' --财付通
    or CONCAT(t2.smr_dscr,t2.cmt) regexp '微信|财付通')
 or (substr(t2.trx_dt,1,6)='202310' and t2.trx_dt<='20231009'))
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024093021_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093021_CST_04 AS
SElECT cst_id,cst_act_id
    ,trx_mon
    ,count(1)       as wx_tx_cnt
    ,sum(trx_amt)   as wx_tx_amt
from SJXQ_SJ2024093021_CST_03
where trx_type='微信提现'
group by cst_id,cst_act_id,trx_mon
;
--微信支付
DROP   TABLE IF     EXISTS SJXQ_SJ2024093021_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093021_CST_05 AS
SELECT  t1.cst_id
       ,t1.act_id
       ,substr(t2.trx_dt,1,6) as trx_mon
       ,COUNT(1)     AS wx_zf_cnt
       ,SUM(trx_amt) AS wx_zf_amt
FROM(
    select distinct col_4 as cst_id
        ,col_6 as act_id
    from SJXQ_SJ2024093021_CST_01
) t1 inner join EDW.DWD_BUS_CHNL_EPC_PAY_SRL_DTL_DI t2 --支付流水表
on t1.act_id=t2.act
and t2.DT >= '20230801'
AND t2.DT <= '20241009'
AND t2.PAY_ORG_ID = 'Z2004944000010' --财付通
AND t2.RSP_NO = '00000' --交易成功
AND t2.TRX_TYP = '0110' --交易类型 = 0110 --支付
AND t2.pmt_act_typ = '00' --付款方账户类型 = 00-借记卡 01-贷记卡
 or (substr(t2.trx_dt,1,6)='202310' and t2.trx_dt<='20231009'))
GROUP BY t1.cst_id,t1.act_id,trx_mon
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024093021_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024093021_CST_06 AS
SELECT  t1.col_2                AS 序号
       ,t1.col_1                AS 机构编号
       ,t1.col_3                AS 机构名称
       ,t1.col_4                AS 客户号
       ,t1.col_5                AS 客户姓名
       ,t1.col_6                AS 借记卡账号
       ,t1.col_7                AS 申报额度_万元
       ,t1.col_8                AS 填报时间
       ,t2.dmnd_dep_bal_mon_avg AS 活期存款月日均_202308
       ,t3.dmnd_dep_bal_mon_avg AS 活期存款月日均_202309
       ,t4.dmnd_dep_bal_mon_avg AS 活期存款月日均_202310
       ,t5.dmnd_dep_bal_mon_avg AS 活期存款月日均_202406
       ,t6.dmnd_dep_bal_mon_avg AS 活期存款月日均_202407
       ,t7.dmnd_dep_bal_mon_avg AS 活期存款月日均_202408
       ,t8.dmnd_dep_bal_mon_avg AS 活期存款月日均_202409
       ,t9.dmnd_dep_bal_mon_avg AS 活期存款月日均_202410
       ,tx1.wx_tx_cnt           AS 微信提现次数_202308
       ,tx2.wx_tx_cnt           AS 微信提现次数_202309
       ,tx3.wx_tx_cnt           AS 微信提现次数_202310
       ,tx4.wx_tx_cnt           AS 微信提现次数_202406
       ,tx5.wx_tx_cnt           AS 微信提现次数_202407
       ,tx6.wx_tx_cnt           AS 微信提现次数_202408
       ,tx7.wx_tx_cnt           AS 微信提现次数_202409
       ,tx8.wx_tx_cnt           AS 微信提现次数_202410
       ,tx1.wx_tx_amt           AS 微信提现金额_202308
       ,tx2.wx_tx_amt           AS 微信提现金额_202309
       ,tx3.wx_tx_amt           AS 微信提现金额_202310
       ,tx4.wx_tx_amt           AS 微信提现金额_202406
       ,tx5.wx_tx_amt           AS 微信提现金额_202407
       ,tx6.wx_tx_amt           AS 微信提现金额_202408
       ,tx7.wx_tx_amt           AS 微信提现金额_202409
       ,tx8.wx_tx_amt           AS 微信提现金额_202410
       ,zf1.wx_zf_cnt           AS 微信支付次数_202308
       ,zf2.wx_zf_cnt           AS 微信支付次数_202309
       ,zf3.wx_zf_cnt           AS 微信支付次数_202310
       ,zf4.wx_zf_cnt           AS 微信支付次数_202406
       ,zf5.wx_zf_cnt           AS 微信支付次数_202407
       ,zf6.wx_zf_cnt           AS 微信支付次数_202408
       ,zf7.wx_zf_cnt           AS 微信支付次数_202409
       ,zf8.wx_zf_cnt           AS 微信支付次数_202410
       ,zf1.wx_zf_amt           AS 微信支付金额_202308
       ,zf2.wx_zf_amt           AS 微信支付金额_202309
       ,zf3.wx_zf_amt           AS 微信支付金额_202310
       ,zf4.wx_zf_amt           AS 微信支付金额_202406
       ,zf5.wx_zf_amt           AS 微信支付金额_202407
       ,zf6.wx_zf_amt           AS 微信支付金额_202408
       ,zf7.wx_zf_amt           AS 微信支付金额_202409
       ,zf8.wx_zf_amt           AS 微信支付金额_202410
from SJXQ_SJ2024093021_CST_01       t1
left join SJXQ_SJ2024093021_CST_02  t2
on t1.col_4=t2.cst_id
and t2.trx_mon='202308'
left join SJXQ_SJ2024093021_CST_02  t3
on t1.col_4=t3.cst_id
and t3.trx_mon='202309'
left join SJXQ_SJ2024093021_CST_02  t4
on t1.col_4=t4.cst_id
and t4.trx_mon='202310'
left join SJXQ_SJ2024093021_CST_02  t5
on t1.col_4=t5.cst_id
and t5.trx_mon='202406'
left join SJXQ_SJ2024093021_CST_02  t6
on t1.col_4=t6.cst_id
and t6.trx_mon='202407'
left join SJXQ_SJ2024093021_CST_02  t7
on t1.col_4=t7.cst_id
and t7.trx_mon='202408'
left join SJXQ_SJ2024093021_CST_02  t8
on t1.col_4=t8.cst_id
and t8.trx_mon='202409'
left join SJXQ_SJ2024093021_CST_02  t9
on t1.col_4=t9.cst_id
and t9.trx_mon='202410'
left join SJXQ_SJ2024093021_CST_04 tx1
on t1.col_4=tx1.cst_id and t1.col_6=tx1.cst_act_id
and tx1.trx_mon='202308'
left join SJXQ_SJ2024093021_CST_04 tx2
on t1.col_4=tx2.cst_id and t1.col_6=tx2.cst_act_id
and tx2.trx_mon='202309'
left join SJXQ_SJ2024093021_CST_04 tx3
on t1.col_4=tx3.cst_id and t1.col_6=tx3.cst_act_id
and tx3.trx_mon='202310'
left join SJXQ_SJ2024093021_CST_04 tx4
on t1.col_4=tx4.cst_id and t1.col_6=tx4.cst_act_id
and tx4.trx_mon='202406'
left join SJXQ_SJ2024093021_CST_04 tx5
on t1.col_4=tx5.cst_id and t1.col_6=tx5.cst_act_id
and tx5.trx_mon='202407'
left join SJXQ_SJ2024093021_CST_04 tx6
on t1.col_4=tx6.cst_id and t1.col_6=tx6.cst_act_id
and tx6.trx_mon='202408'
left join SJXQ_SJ2024093021_CST_04 tx7
on t1.col_4=tx7.cst_id and t1.col_6=tx7.cst_act_id
and tx7.trx_mon='202409'
left join SJXQ_SJ2024093021_CST_04 tx8
on t1.col_4=tx8.cst_id and t1.col_6=tx8.cst_act_id
and tx8.trx_mon='202410'
left join SJXQ_SJ2024093021_CST_05 zf1
on t1.col_4=zf1.cst_id and t1.col_6=zf1.act_id
and zf1.trx_mon='202308'
left join SJXQ_SJ2024093021_CST_05 zf2
on t1.col_4=zf2.cst_id and t1.col_6=zf2.act_id
and zf2.trx_mon='202309'
left join SJXQ_SJ2024093021_CST_05 zf3
on t1.col_4=zf3.cst_id and t1.col_6=zf3.act_id
and zf3.trx_mon='202310'
left join SJXQ_SJ2024093021_CST_05 zf4
on t1.col_4=zf4.cst_id and t1.col_6=zf4.act_id
and zf4.trx_mon='202406'
left join SJXQ_SJ2024093021_CST_05 zf5
on t1.col_4=zf5.cst_id and t1.col_6=zf5.act_id
and zf5.trx_mon='202407'
left join SJXQ_SJ2024093021_CST_05 zf6
on t1.col_4=zf6.cst_id and t1.col_6=zf6.act_id
and zf6.trx_mon='202408'
left join SJXQ_SJ2024093021_CST_05 zf7
on t1.col_4=zf7.cst_id and t1.col_6=zf7.act_id
and zf7.trx_mon='202409'
left join SJXQ_SJ2024093021_CST_05 zf8
on t1.col_4=zf8.cst_id and t1.col_6=zf8.act_id
and zf8.trx_mon='202410'
;
SElECT '01' seq, count(1) cnt,count(distinct col_4,col_6) custs
from SJXQ_SJ2024093021_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024093021_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id,cst_act_id) custs
from SJXQ_SJ2024093021_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id,cst_act_id) custs
from SJXQ_SJ2024093021_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id,act_id) custs
from SJXQ_SJ2024093021_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号,借记卡账号) custs
from SJXQ_SJ2024093021_CST_06
;
SElECT '06' seq, *
from SJXQ_SJ2024093021_CST_06
***SJ2024100501_青年创业伙伴计划数据报送.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024100501_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100501_CST_01 AS
SELECT  DISTINCT T1.cst_id --创业青年客户号
       ,t5.mgr_org_id      --信贷合同管护机构编号
FROM    edw.dim_cst_entp_bas_inf_dd     T1 --企业客户基本信息
INNER JOIN    edw.dim_cst_rel_inf_dd    T2 --客户关联关系信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20240930'
AND     ( T2.rel_typ_cd IN ( '0109' , '0101' ) -- 0109:实际控制人（高管）, 0101:法定代表人（高管）
    OR T2.rel_typ_cd LIKE '02%' )
INNER JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T2.rel_cst_id = T3.cst_id
AND     T3.bth_dt <> ''
AND     T3.DT = '20240930'
INNER JOIN edw.dim_bus_loan_ctr_bse_inf_dd      t4 --合同基础信息
ON      t1.cst_id = t4.cst_id
AND     T4.DT = '20240930'
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T5 --信贷合同管护信息
ON      T4.ctr_serno = T5.ctr_serno
AND     T5.DT = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t6 --机构树_考核维度
ON      t5.mgr_org_id = t6.org_id
AND     t6.DT = '20240930'
WHERE   T1.DT = '20240930'
AND     T1.org_org_found_dt >= '20150101'
AND     t6.brc_org_nm RLIKE '绍兴分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024100501_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100501_CST_02 AS
SELECT  t.cst_id
        ,t1.mgr_org_id --信贷合同管护机构编号
        ,sum(t.ctr_amt) AS sum_ctr_amt --贷款金额
        ,sum(t.ctr_bal) AS sum_ctr_bal --贷款余额
FROM    edw.dim_bus_loan_ctr_bse_inf_dd      t --合同基础信息
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T1 --信贷合同管护信息
ON      T.ctr_serno = T1.ctr_serno
AND     T1.DT = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t2 --机构树_考核维度
ON      t1.mgr_org_id = t2.org_id
AND     t2.DT = '20240930'
LEFT JOIN EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD   t3 --合同其它明细信息
ON      t.CTR_SERNO = t3.CTR_SERNO
AND     t3.dt = '20240930'
WHERE   t.dt = '20240930'
AND     t.BSN_MARK_CD <> '01' --剔除 员工贷款 '01-员工贷款02-信贷人员亲属业务03-预保预报业务04-重组业务05-协作业务
AND     ( t3.APLY_CHNL_cd <> 'L08'
    OR t.prd_no <> '201050101040335' ) --剔除 小鱼分期
AND     t.prd_no <> '201050101040332' --剔除 蚂蚁借呗
AND     t.prd_no <> '201050101040319'  --剔除百度分期贷
AND     ( t.prd_no NOT IN ( '201050102010146' , '201050101040348' )
    OR t.CTR_STS_CD <> '1' ) --剔除未签约的泰e贷
AND     ( ( t.CTR_STS_CD IN ( '2' , '4' )
AND     t.TMT_DT = '18991231'
    OR t.CTR_BAL > 0 ) --未到期未终结口径
AND     t2.brc_org_nm RLIKE '绍兴分行'
GROUP BY t.cst_id , t1.mgr_org_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024100501_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100501_CST_03 AS
SELECT  t1.cst_id      AS 创业青年客户号
       ,t1.mgr_org_id  AS 信贷合同管护机构编号
       ,t2.sum_ctr_amt AS 贷款金额
       ,t2.sum_ctr_bal AS 贷款余额
FROM SJXQ_SJ2024100501_CST_01       t1
LEFT JOIN SJXQ_SJ2024100501_CST_02  t2
ON t1.cst_id = t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100501_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100501_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 创业青年客户号) custs
from SJXQ_SJ2024100501_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2024100501_CST_03
***SJ2024100501_青年创业伙伴计划数据报送1010.sql
-- 合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024100501_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100501_CST2_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                        --合同敞口金额|decimal(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t1.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240930'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240930'
and t4.brc_org_nm regexp '绍兴分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240930'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='20240930'
where t1.dt='20240930'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024100501_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100501_CST2_02 AS
SELECT  t1.cst_id      AS 客户号
       ,t1.cst_nm      AS 客户名称
       ,t2.sum_ctr_amt AS 累计合同金额
       ,t2.sum_ctr_bal AS 累计合同余额
       ,t2.PD_NM       AS 持有贷款产品名称
       ,T3.bth_dt      AS 出生日期
from(
    SElECT distinct cst_id,cst_nm
    from SJXQ_SJ2024100501_CST2_01
    where is_jyd=1      --持有我行个人经营性贷款客户
)t1 inner join(
    SElECT cst_id
        ,sum(ctr_amt) AS sum_ctr_amt --累计合同金额
        ,sum(ctr_bal) AS sum_ctr_bal --累计合同余额
    from SJXQ_SJ2024100501_CST2_01
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
INNER JOIN edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.bth_dt <> ''
AND     T3.DT = '20240930'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024100501_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024100501_CST2_02
;
SElECT '02' seq, *
from SJXQ_SJ2024100501_CST2_02
***SJ20241008181_首笔贷前走访情况.sql
-- SJ20241008181
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241008181_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241008181_CST_01 AS
SELECT  col_1  --序号
       ,col_2  --用信申请流水号
       ,col_3  --合同登记流水号
       ,col_4  --客户号
       ,col_5  --客户名称
       ,col_6  --合同金额
       ,col_7  --管户机构号
       ,col_8  --管户机构名称
       ,col_9  --管户人工号
       ,col_10 --管户人名称
-- from
-- where pt<>''
;
-- 合同信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241008181_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241008181_CST_02 AS
SElECT t2.ctr_serno
    ,t2.REL_SERNO
	,t2.cst_id          --客户号
	,t2.cst_nm          --客户名称
	,t2.ctr_amt         --合同金额
	,t2.ctr_bal         --合同余额
	,t2.ctr_bgn_dt      --合同起始日期
	,t2.ctr_mtu_dt      --合同到期日期
    ,t2.TMT_DT	        --终结日期
    ,t2.exec_intr_rat	--执行利率
    ,t2.usc_aply_dt	    --用信申请日期
    ,t2.reg_typ_cd	    --登记类型代码
    ,t2.bsn_mark_cd
from(
    select distinct col_3
    from SJXQ_SJ20241008181_CST_01
)t1
inner join edw.dim_bus_loan_ctr_bse_inf_dd        t2 --合同基础信息
on t1.col_3=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
;
-- 贷前走访
DROP   TABLE IF     EXISTS SJXQ_SJ20241008181_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241008181_CST_03 AS
SElECT t1.cst_id,t1.ctr_bgn_dt
	,t2.svy_mod_cd                               --调查方式代码|C2
    ,c1.cd_val_dscr     as svy_mod_nm
	,t2.svy_dt                                   --调查日期|C8
	,t2.cst_id                                  as 客户号
	,t2.cst_nm                                   --客户名称|C200
	,t2.svy_addr_typ_cd                          --调查地址类型代码|C3
    ,c2.cd_val_dscr     as svy_addr_typ_nm
	,t2.adiv                                     --行政区划|C12
	,t2.svy_addr                                 --调查地址|C256
	,t2.svy_ctnt_and_rslt                        --调查内容及结果|C4000
	,t2.rmk                                      --备注|c4000
	,t2.pcp_mnl_no                               --参与人工号|C20
	,t2.pcp_psn_nm                               --参与人姓名|C200
from(
    SElECT distinct cst_id,ctr_bgn_dt
    from SJXQ_SJ20241008181_CST_02
)t1 left join edw.dwd_bus_loan_cst_svy_rcd_dd  t2        --客户调查记录信息
on t1.cst_id=t2.cst_id
and t1.ctr_bgn_dt>=t2.svy_dt -- 贷前走访
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T2.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt='@@{yyyyMMdd}'
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T2.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241008181_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241008181_CST_04 AS
SELECT  t1.col_1           AS 序号
       ,t1.col_2           AS 用信申请流水号
       ,t1.col_3           AS 合同登记流水号
       ,t1.col_4           AS 客户号
       ,t1.col_5           AS 客户名称
       ,t1.col_6           AS 合同金额
       ,t1.col_7           AS 管户机构号
       ,t1.col_8           AS 管户机构名称
       ,t1.col_9           AS 管户人工号
       ,t1.col_10          AS 管户人名称
       ,t2.ctr_bgn_dt      AS 合同起始日期
       ,t3.svy_dt          AS 调查日期
       ,t3.pcp_mnl_no      AS 参与人工号
       ,t3.pcp_psn_nm      AS 参与人姓名
       ,t3.svy_addr_typ_nm AS 调查地址类型
       ,t3.svy_mod_nm      AS 调查方式
from SJXQ_SJ20241008181_CST_01      t1
left join SJXQ_SJ20241008181_CST_02 t2
on t1.col_3=t2.ctr_serno
left join SJXQ_SJ20241008181_CST_03 t3
on t2.cst_id=t3.cst_id
and t2.ctr_bgn_dt=t3.ctr_bgn_dt
;
SElECT '01' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ20241008181_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241008181_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241008181_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20241008181_CST_04
;
SElECT '01' seq, *
from SJXQ_SJ20241008181_CST_01
;
SElECT '02' seq, *
from SJXQ_SJ20241008181_CST_02
;
SElECT '03' seq, *
from SJXQ_SJ20241008181_CST_03
;
SElECT '04' seq, *
from SJXQ_SJ20241008181_CST_04
***SJ2024100836_绍兴分行授信敞口.sql
-- 截止9月30日，绍兴分行所有客户在我行的授信敞口，及其同一风险控制号在我行的合计授信敞口
-- 数据需求字段
-- 客户号，客户姓名，我行敞口金额，同一风险控制号，同一风险控制号下我行合计授信敞口
DROP   TABLE IF     EXISTS SJXQ_SJ2024100836_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100836_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
    ,t1.rel_serno	                             --用信申请流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                        --合同敞口金额|decimal(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,case when t1.bsn_mark_cd='03' then '1' else 0 end pre_dfd_pre_rpt_ind	--预保预报标识
    ,c1.cd_val_dscr     bsn_mark_nm             --业务标识
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = 'J' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t2.PD_NM
    ,case when t2.PD_NM regexp '随贷通' then 1 else 0 end is_sdt
    ,case when t2.PD_NM regexp '泰e贷'  then 1 else 0 end is_tyd
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240930'
inner join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240930'
and t4.brc_org_nm regexp '绍兴分行'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240930'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='20240930'
where t1.dt='20240930'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024100836_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100836_CST_02 AS
SELECT  t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户姓名
       ,t1.ctr_epsr_amt     AS 我行敞口金额
       ,t1.sam_rsk_ctrl_id  AS 同一风险控制号
       ,t2.sam_rsk_epsr_amt AS 同一风险控制号下我行合计授信敞口
from(
    SELECT  cst_id
        ,cst_nm
        ,sam_rsk_ctrl_id
        ,SUM(nvl(ctr_epsr_amt,0)) as ctr_epsr_amt
    from SJXQ_SJ2024100836_CST_01
    group by cst_id,cst_nm,sam_rsk_ctrl_id
)t1 left join(
    SElECT sam_rsk_ctrl_id
        ,sum(nvl(ctr_epsr_amt,0))  as sam_rsk_epsr_amt
    from SJXQ_SJ2024100836_CST_01
    group by sam_rsk_ctrl_id
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024100836_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024100836_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2024100836_CST_02
***SJ2024100871_金华分行存量业务社区归位.sql
-- 客群
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_00 AS
SELECT  col_1 --序号
       ,col_2 --客户号
       ,col_3 --客户姓名
from qbi_file_20241010_10_33_17
where pt<>''
;
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.REL_SERNO
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	--执行利率
    ,t1.usc_aply_dt	    --用信申请日期
    ,t1.reg_typ_cd	    --登记类型代码
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr     as bsn_mark_nm             --业务标识
    ,t1.hpn_typ_cd
    ,c2.cd_val_dscr     as hpn_typ_nm --发生类型
    ,t1.mgr_id	        --管户人工号
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_opr_id	    --经办人工号
    ,t1.hdl_org_id      --经办机构编号
    ,t1.GRNT_MOD_COLC	--担保方式集合
    ,decode(t1.GRNT_MOD_COLC,'005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池','') as GRNT_MOD_COLC_nm --担保方式
    ,t1.cpt_usg_cd	--资金用途代码|c4
    ,c4.cd_val_dscr     as cpt_usg_nm
    ,t1.cpt_usg_rmk	--资金用途备注|c4000
    ,t1.RVLG_TYP_CD	--循环类型代码
    ,c5.cd_val_dscr     as RVLG_TYP_nm
    ,t1.DIF_PLC_BSN_IND	--乡情贷业务标志 是否异地
    ,t1.prcp_setl_dt	--本金结清日期|c8
    ,t1.PRD_TAG	--产品标签编号集合 营销标签代码
    ,t1.rpay_prcp_setl_intr_mod_cd	--还本结息方式代码|c2
    ,c6.cd_val_dscr     as RPAY_PRCP_SETL_INTR_MOD_nm
    ,t2.pd_nm           --业务品种
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t4.brc_org_nm ,t4.sbr_org_nm ,t4.org_nm
    ,t6.org_nm  as hdl_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join (
    select distinct col_2 as cst_id
    from SJXQ_SJ2024100871_CST_00
)t0 on t1.cst_id=t0.cst_id
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20240930'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20240930'
-- and t4.brc_org_nm='台州分行'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20240930'
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t1.hdl_org_id = t6.org_id
and t6.dt = '20240930'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240930'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C2
ON  t1.hpn_typ_cd = C2.CD_VAL
AND C2.DT = '20240930'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C4
ON  t1.cpt_usg_cd = C4.CD_VAL
AND C4.DT = '20240930'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C5
ON  t1.RVLG_TYP_CD = C5.CD_VAL
AND C5.DT = '20240930'
left join edw.dwd_code_library_dd           c6
on t1.RPAY_PRCP_SETL_INTR_MOD_CD = c6.cd_val
and c6.dt = '20240930'
where t1.dt='20240930'
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 担保人
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_02 AS
SElECT t1.ctr_serno
    ,count(distinct t2.wrnt_cst_id)             as wrnt_cst_cnt --保证人客户编号
from SJXQ_SJ2024100871_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.ctr_serno=t2.bus_ctr_id           --业务合同编号
and t2.dt = '20240930'
group by t1.ctr_serno
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_03 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD
	WHERE DT = '20240930'
)t1 LEFT JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20240930'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20240930'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
inner join(
    select distinct col_2 as cst_id
    from SJXQ_SJ2024100871_CST_00
)t3 on t1.cst_id=t3.cst_id
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20240930'
where t1.rn=1
;
-- 精准贷后 取最近一次
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_04 AS
SELECT  a.tsk_serno                 --任务流水号
       ,a.btch_serno                --批次流水号
       ,a.pst_loan_chk_tsk_src_cd   --贷后检查任务来源代码
       ,d.cd_val_dscr               as pst_loan_chk_tsk_src_nm --贷后检查任务来源
       ,a.pst_loan_chk_tsk_typ_cd   --贷后检查任务类型代码
       ,c.cd_val_dscr               as pst_loan_chk_tsk_typ_nm --精准贷后任务类型
       ,a.tsk_gen_dt                --任务生成日期
       ,a.wthr_pass_mid_grd_ind     --过中台标志
       ,b.cst_id                    --客户号
       ,b.cst_rsk_dgr_cd            --客户风险程度
       ,b.reply_opnn_exec_situ	    --批复意见执行情况|c4000
       ,b.chk_psn_id	            --检查人工号|c10
       ,b.chk_psn_bel_org_no	    --检查人所属机构编号|c12
       ,row_number()over(partition by b.cst_id order by a.tsk_gen_dt desc) rn
from   edw.dwd_bus_loan_psp_chk_tsk_inf_dd      a
left join edw.dwd_bus_loan_psp_chk_btch_inf_dd  b --贷后检查批次信息
on a.btch_serno = b.btch_serno
and b.dt = a.dt
left join edw.dwd_code_library_dd               c
on a.pst_loan_chk_tsk_typ_cd = c.cd_val
and c.dt = '20240930'   ---- 码值表取最新分区（新信贷的码值0719后才有）
left join edw.dwd_code_library_dd               d
on a.pst_loan_chk_tsk_src_cd = d.cd_val
and d.dt = '20240930'    ---- 码值表取最新分区（新信贷的码值0719后才有）
inner join(
    select distinct col_2 as cst_id
    from SJXQ_SJ2024100871_CST_00
)t3 on b.cst_id=t3.cst_id
where  a.dt ='20240930'
and    a.pst_loan_chk_tsk_src_cd = '01'   ----精准贷后
and    a.tsk_gen_dt>='20240101'
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_05 AS
SELECT ctr_serno
    ,max(is_rsk_loan) as   is_rsk_loan  --是否风险贷款
from(
    SELECT  t1.cst_id,t1.ctr_serno
        ,t2.dbil_srl_no
        ,t2.is_rsk_loan               --是否风险贷款
        ,row_number() over(partition by t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ2024100871_CST_01              t1
    left join adm_rsk.adm_rsk_apl_inter_all	   t2 --风险集市应用表-资产质量日常监测源表
    on t1.ctr_serno=t2.ctr_srl_no
    and t2.dt>='20230101'
    and t2.dt<='20240930'
)t1 where rn=1
group by ctr_serno
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_06 AS
SElECT t1.cst_id
    ,t2.cst_cr_grd_val
    ,t2.prd_dt
    ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
from (
    select distinct col_2 as cst_id
    from SJXQ_SJ2024100871_CST_00
)t1 left join(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240930'
    UNION
    SELECT  cst_id
        ,prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240930'
)t2 on t1.cst_id=t2.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024100871_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100871_CST_07 AS
SELECT  t0.col_1                      AS 序号
       ,t0.col_2                      AS 客户号
       ,t0.col_3                      AS 客户姓名
       ,t1.ctr_serno                  AS 合同流水号
       ,t7.sub_cmnt_nm                AS 子社区名称
       ,t1.hpn_typ_nm                 AS 发生类型
       ,t1.exec_intr_rat              AS 执行利率
       ,t1.pd_nm                      AS 业务品种
       ,t1.GRNT_MOD_COLC_nm           AS 担保方式
       ,t1.RVLG_TYP_nm                AS 循环类型
       ,t1.ctr_amt                    AS 合同金额
       ,t1.ctr_bal                    AS 合同余额
       ,t1.ctr_bgn_dt                 AS 合同起始日期
       ,t1.ctr_mtu_dt                 AS 合同到期日期
       ,t1.RPAY_PRCP_SETL_INTR_MOD_nm AS 还本结息方式
       ,t2.wrnt_cst_cnt               AS 担保人个数
       ,t2.wrnt_cst_nm                AS 担保人姓名
       ,t1.org_nm                     AS 管户机构名称
       ,t1.mgr_id                     AS 管户人工号
       ,t1.mgr_nm                     AS 管户人姓名
       ,t3.rul_set_rslt_nm            AS 新预评估结果
       ,''                            AS 客户有余额这笔合同征信分
       ,t6.cst_cr_grd_val             AS 最近一次征信分数
       ,t4.pst_loan_chk_tsk_typ_nm    AS 精准贷后任务类型
       ,t5.is_rsk_loan                AS 是否风险贷款
       ,t8.dep_bal_mon_avg            AS 存款余额月日均
       ,t9.loan_bal_acs_mon_avg       AS 贷款余额月日均
from SJXQ_SJ2024100871_CST_00       t0
left join SJXQ_SJ2024100871_CST_01  t1
on t0.col_2=t1.cst_id
left join SJXQ_SJ2024100871_CST_02  t2
on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ2024100871_CST_03  t3
on t0.col_2=t3.cst_id
left join SJXQ_SJ2024100871_CST_04  t4
on t0.col_2=t4.cst_id and t4.rn=1
left join SJXQ_SJ2024100871_CST_05  t5
on t1.ctr_serno=t5.ctr_serno
left join SJXQ_SJ2024100871_CST_06  t6
on t0.col_2=t6.cst_id and t6.rn=1
LEFT JOIN edw.dwd_cst_mng_cmnt_rel_dd       t7
ON      t1.cst_id = t7.cst_id
AND     t7.dt = '20240930'
AND     t7.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
left join adm_pub.adm_csm_cbus_dep_inf_dd   t8 --存款业务信息表
on t0.col_2=t8.cst_id
and t8.dt='20240930'
left join adm_pub.adm_csm_cbus_loan_inf_dd  t9 --贷款业务信息
on t0.col_2=t9.cst_id
and t9.dt='20240930'
;
SElECT '00' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024100871_CST_00
union all
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024100871_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024100871_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100871_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100871_CST_04 where rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024100871_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100871_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024100871_CST_07
;
SElECT '07' seq, *
from SJXQ_SJ2024100871_CST_07
***SJ2024100911_他行授信家数.sql
-- 主表
DROP   TABLE IF EXISTS SJXQ_SJ2024100911_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024100911_CST_01
(
    seq         string COMMENT '序号'
    ,cst_id     string COMMENT '客户号'
)
;
insert into SJXQ_SJ2024100911_CST_01
;
-- 他行授信家数
DROP   TABLE IF EXISTS SJXQ_SJ2024100911_CST_02 PURGE;
CREATE TABLE           SJXQ_SJ2024100911_CST_02 as
SELECT  t1.seq                   AS 序号
       ,t1.cst_id                AS 客户号
       ,t2.cred_busi_org_out_wjq AS 授信机构数_不含未激活
       ,t2.oth_bank_busi_org_num AS 他行授信机构数_不含未激活
       ,t2.oth_bank_loan_org_num AS 他行贷款授信机构数
       ,t2.cred_total_amt        AS 授信总额_信用总额
from SJXQ_SJ2024100911_CST_01 t1
left join (
    SELECT  t1.cst_id
        ,t1.report_no
        ,t1.report_dt                      --报告日期
        ,t1.cred_busi_org_out_wjq          --授信机构数（不含未激活）
        ,t1.oth_bank_busi_org_num          --他行授信机构数(不含未激活)
        ,t1.oth_bank_loan_org_num          --他行贷款授信机构数
        ,t1.cred_total_amt               --授信总额_信用总额
        ,row_number() over(partition by t1.cst_id order by t1.report_no desc) rn
    from edw.dws_cst_ccrc_idv_ind_inf_dd                t1 --个人征信指标信息表
    where t1.dt='@@{yyyyMMdd}'
    and t1.report_dsc_rn=1	--报告降序排序号
)t2 on t1.cst_id=t2.cst_id
and t2.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100911_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024100911_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2024100911_CST_02
***SJ20241009136_中征分预评估结果取数.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_01 AS
SELECT col_1 --客户号
       ,col_2 --客户名称
       ,col_3 --客户类型
-- from
-- where pt<>''
;
-- 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_02 AS
SELECT  cst_id
    ,prd_dt
    ,cst_cr_grd_val
    ,ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY prd_dt DESC) AS rn
FROM (
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240930'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240930'
)t
;
-- 输出结果1 sheet1
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_03 AS
SELECT  col_1             AS 客户号
       ,col_2             AS 客户名称
       ,col_3             AS 客户类型
       ,t4.lgp_cst_id     AS 对公客户法人客户号
       ,t4.lgp_nm         AS 对公客户法人客户名称
       ,t2.cst_cr_grd_val AS 对私客户最新中征分
       ,t5.cst_cr_grd_val AS 对公客户法定代表人最新中征分
from SJXQ_SJ20240904137_CST_01      t1
left join SJXQ_SJ20240904137_CST_02 t2
on t1.col_1 = t2.cst_id
and t2.rn=1
left join edw.dim_cst_entp_lgp_inf_dd   t4           --对公客户法人信息表
on t1.col_1 = t4.cst_id
and t4.dt='20240930'
left join SJXQ_SJ20240904137_CST_02     t5
on t4.lgp_cst_id = t5.cst_id
and t5.rn=1
;
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_04 AS
SELECT col_1 --客户号
       ,col_2 --客户名称
       ,col_3 --客户类型
-- from
-- where pt<>''
;
-- 输出结果2 sheet2
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_05 AS
SELECT  col_1             AS 客户号
       ,col_2             AS 客户名称
       ,col_3             AS 客户类型
       ,t4.lgp_cst_id     AS 对公客户法人客户号
       ,t4.lgp_nm         AS 对公客户法人客户名称
       ,t2.cst_cr_grd_val AS 对私客户最新中征分
       ,t5.cst_cr_grd_val AS 对公客户法定代表人最新中征分
from SJXQ_SJ20240904137_CST_04      t1
left join SJXQ_SJ20240904137_CST_02 t2
on t1.col_1 = t2.cst_id
and t2.rn=1
left join edw.dim_cst_entp_lgp_inf_dd   t4           --对公客户法人信息表
on t1.col_1 = t4.cst_id
and t4.dt='20240930'
left join SJXQ_SJ20240904137_CST_02     t5
on t4.lgp_cst_id = t5.cst_id
and t5.rn=1
;
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_06 AS
SELECT  col_1 --用信申请流水号
       ,col_2 --合同登记流水号
       ,col_3 --申请书流水号
       ,col_4 --是否框架下子合同
       ,col_5 --合同编号
       ,col_6 --客户号
       ,col_7 --客户名称
-- from
-- where pt<>''
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_07 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20240930'
)t1 inner JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20240930'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20240930'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20240930'
where t1.rn=1
;
-- 输出结果3 sheet3
DROP   TABLE IF     EXISTS SJXQ_SJ20240904137_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240904137_CST_08 AS
SELECT  t1.col_1 as 用信申请流水号
       ,t1.col_2 as 合同登记流水号
       ,t1.col_3 as 申请书流水号
       ,t1.col_4 as 是否框架下子合同
       ,t1.col_5 as 合同编号
       ,t1.col_6 as 客户号
       ,t1.col_7 as 客户名称
       ,COALESCE(t2.rul_set_rslt_nm,t5.rul_set_rslt_nm) as 新预评估结果
from SJXQ_SJ20240904137_CST_06      t1
left join SJXQ_SJ20240904137_CST_07 t2
on t1.col_6 = t2.cst_id
left join edw.dim_cst_entp_lgp_inf_dd   t4           --对公客户法人信息表
on t1.col_6 = t4.cst_id
and t4.dt='20240930'
left join SJXQ_SJ20240904137_CST_07     t5
on t4.lgp_cst_id = t5.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ20240904137_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240904137_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240904137_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ20240904137_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240904137_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct col_6) custs
from SJXQ_SJ20240904137_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240904137_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20240904137_CST_08
;
-- 结果表
SElECT '03' seq, *
from SJXQ_SJ20240904137_CST_03
;
SElECT '05' seq, *
from SJXQ_SJ20240904137_CST_05
;
SElECT '08' seq, *
from SJXQ_SJ20240904137_CST_08
***SJ2024100946_衢州分行百年好合卡.sql
﻿--截止2024年9月底，衢州分行百年好合卡发卡客户的产效情况（存款、贷款、理财、aum）。
--注：百年好合卡分为定制卡面款、通用卡面款两种
/*
客户号	客户姓名	卡片类型	卡号	发卡时间	经办人	经办团队	经办支行    产效情况（存款、贷款、理财、aum）月日均
1. 持有信用卡？ 是否持有信用卡？账号持有数
2. 财富-理财保险基金贵金属 取 余额？还是月日均？ 均取
*/
-- 衢州分行百年好合卡发卡客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_01 as
SELECT  t1.cst_id --客户编号|C20
    ,t1.cst_nm --客户名称|C200
    ,t1.isu_dt --发卡日期|C8
    ,t1.cr_crd_card_nbr
    ,t1.cr_crd_pd_id
    ,t2.crd_no
    ,t4.cr_crd_mgr_nm	        --信用卡业务管户人
    ,t4.cr_crd_org_nm	        --信用卡业务管户机构
    ,t4.cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
    ,case when t1.cr_crd_pd_id = '0054' then '定制版'
        when t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12' then '通用版'
        else '' end  as card_type
FROM edw.dim_bus_crd_cr_crd_inf_dd  t1 --信用卡卡片信息
INNER JOIN    edw.loan_ctr_crd_face t2
ON      t1.cr_crd_card_nbr = t2.crd_no
AND     t2.dt = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  DISTINCT cst_id
	    ,cr_crd_brc_org_nm
        ,cr_crd_mgr_nm	        --信用卡业务管户人
        ,cr_crd_org_nm	        --信用卡业务管户机构
        ,cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
	-- FROM app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd
    from app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd
	WHERE dt = '20240930'
	AND cr_crd_brc_org_nm = '衢州分行'
)T4 ON T1.cst_id = T4.cst_id
WHERE t1.dt = '20240930'
and (t1.cr_crd_pd_id = '0054' --百年好合卡定制卡
    OR (t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12') --百年好合卡通用版
)
;
-- 当前是否为有效户 存款	贷款	信用卡	财富
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_03 as
SElECT t1.cst_id
	,t2.efe_dep_cst_ind         --有效存款户标识
	,t2.efe_loan_cst_ind        --有效信贷户标识
	,t2.efe_wlth_cst_ind        --有效财富户标识
    ,t3.cr_crd_vld_cst_ind	    --信用卡有效户标识:0否1是
from (
    SElECT distinct cst_id
    from SJXQ_SJ2024100946_CST_01
)t1 left join adm_pub.adm_csm_cbas_ind_inf_dd 		    t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='20240930'
left join adm_pub.adm_csm_clab_cr_crd_bas_lab_inf_dd    t3 --客户集市-客户标签信息-信用卡-基本标签信息
on t1.cst_id=t3.cst_id
and t3.dt='20240930'
;
-- 理财	保险	基金	贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_04 as
SELECT  t1.cst_id           --客户编号
    ,t2.xyk_act_cnt     --信用卡账号数
    ,t2.xyk_bal         --信用卡余额
    ,case when nvl(t3.sam_rsk_ctrl_id,'')<>'' then t3.sam_rsk_ctrl_id else t1.cst_id end sam_rsk_ctrl_id    --同一风险控制号
    ,t4.fnc_amt          --理财金额
    ,t4.fnc_mon_avg_amt  --理财金额月日均
    ,t4.insu_amt         --保险保费
    ,t4.insu_mon_avg_amt --保险保费月日均
    ,t4.fund_amt         --基金金额
    ,t4.fund_mon_avg_amt --基金金额月日均
    ,t4.gold_amt         --贵金属近一年金额
    ,t4.gold_mon_avg_amt --贵金属金额月日均
    ,t5.dep_bal          --存款余额
    ,t5.dep_bal_mon_avg  --存款余额月日均
    ,t6.ctr_amt          --授信金额
    ,t6.ctr_bal          --用信余额
from SJXQ_SJ2024100946_CST_03                       t1
left join(
    SElECT cst_id
        ,count(distinct cr_crd_act_id)  as xyk_act_cnt
        ,sum(bal)                       as xyk_bal --信用卡余额
    from app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd	--信用卡账户信息汇总表
    where dt='20240930'
    group by cst_id
)t2 on  t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd 				    t3 --客户基础信息汇总表
on  t1.cst_id=t3.cst_id
and t3.dt='20240930'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t4 --客户金融资产信息表
on  t1.cst_id=t4.cst_id
and t4.dt='20240930'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t5 --存款业务信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20240930'
left join(
    select cst_id
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd    t1
    inner join edw.dim_bus_loan_prd_frml_dd t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20240930'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20240930'
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
;
-- 同一风险控制号下全部客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_05 as
SELECT  sam_rsk_ctrl_id
       ,SUM(dep_bal)          AS 存款余额
       ,SUM(dep_bal_mon_avg)  AS 存款余额月日均
       ,SUM(ctr_amt)          AS 授信金额
       ,SUM(ctr_bal)          AS 用信余额
       ,SUM(xyk_act_cnt)      AS 信用卡账号数
       ,SUM(xyk_bal)          AS 信用卡余额
       ,SUM(fnc_amt)          AS 理财金额
       ,SUM(fnc_mon_avg_amt)  AS 理财金额月日均
       ,SUM(insu_amt)         AS 保险保费
       ,SUM(insu_mon_avg_amt) AS 保险保费月日均
       ,SUM(fund_amt)         AS 基金金额
       ,SUM(fund_mon_avg_amt) AS 基金金额月日均
       ,SUM(gold_amt)         AS 贵金属近一年金额
       ,SUM(gold_mon_avg_amt) AS 贵金属金额月日均
from SJXQ_SJ2024100946_CST_04
group by sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_06 as
SELECT  t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.card_type          AS 卡片类型
       ,t1.cr_crd_card_nbr    AS 卡号
       ,t1.isu_dt             AS 发卡日期
       ,t1.cr_crd_mgr_nm      AS 信用卡业务管户人
       ,t1.cr_crd_org_nm      AS 信用卡业务管户机构
       ,t1.cr_crd_sbr_org_nm  AS 信用卡业务管户支行名称
       ,t2.efe_dep_cst_ind    AS 有效存款户标识
       ,t2.efe_loan_cst_ind   AS 有效信贷户标识
       ,t2.cr_crd_vld_cst_ind AS 信用卡有效户标识
       ,t2.efe_wlth_cst_ind   AS 有效财富户标识
       ,t3.dep_bal            AS 单客户_存款余额
       ,t3.dep_bal_mon_avg    AS 单客户_存款余额月日均
       ,t3.ctr_amt            AS 单客户_授信金额
       ,t3.ctr_bal            AS 单客户_用信余额
       ,t3.xyk_act_cnt        AS 单客户_信用卡账号数
       ,t3.xyk_bal            AS 单客户_信用卡余额
       ,t3.fnc_amt            AS 单客户_理财金额
       ,t3.fnc_mon_avg_amt    AS 单客户_理财金额月日均
       ,t3.insu_amt           AS 单客户_保险保费
       ,t3.insu_mon_avg_amt   AS 单客户_保险保费月日均
       ,t3.fund_amt           AS 单客户_基金金额
       ,t3.fund_mon_avg_amt   AS 单客户_基金金额月日均
       ,t3.gold_amt           AS 单客户_贵金属近一年金额
       ,t3.gold_mon_avg_amt   AS 单客户_贵金属金额月日均
       ,t4.存款余额                 AS 同一风险控制号下_存款余额
       ,t4.存款余额月日均            AS 同一风险控制号下_存款余额月日均
       ,t4.授信金额                 AS 同一风险控制号下_授信金额
       ,t4.用信余额                 AS 同一风险控制号下_用信余额
       ,t4.信用卡账号数             AS 同一风险控制号下_信用卡账号数
       ,t4.信用卡余额                AS 同一风险控制号下_信用卡余额
       ,t4.理财金额                 AS 同一风险控制号下_理财金额
       ,t4.理财金额月日均            AS 同一风险控制号下_理财金额月日均
       ,t4.保险保费                 AS 同一风险控制号下_保险保费
       ,t4.保险保费月日均            AS 同一风险控制号下_保险保费月日均
       ,t4.基金金额                 AS 同一风险控制号下_基金金额
       ,t4.基金金额月日均            AS 同一风险控制号下_基金金额月日均
       ,t4.贵金属近一年金额           AS 同一风险控制号下_贵金属近一年金额
       ,t4.贵金属金额月日均           AS 同一风险控制号下_贵金属金额月日均
from SJXQ_SJ2024100946_CST_01           t1
left join SJXQ_SJ2024100946_CST_03      t2
on t1.cst_id=T2.cst_id
left join SJXQ_SJ2024100946_CST_04      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024100946_CST_05      t4
on t3.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024100946_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024100946_CST_06
;
SElECT '06' seq, *
from SJXQ_SJ2024100946_CST_06
***SJ2024100946_衢州分行百年好合卡1012.sql
--截止2024年9月底，衢州分行百年好合卡发卡客户的产效情况（存款、贷款、理财、aum）。
--注：百年好合卡分为定制卡面款、通用卡面款两种
/*
客户号	客户姓名	卡片类型	卡号	发卡时间	经办人	经办团队	经办支行    产效情况（存款、贷款、理财、aum）月日均
1. 持有信用卡？ 是否持有信用卡？账号持有数
2. 财富-理财保险基金贵金属 取 余额？还是月日均？ 均取
*/
-- 衢州分行百年好合卡发卡客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_01 as
SELECT  t1.cst_id --客户编号|C20
    ,t1.cst_nm --客户名称|C200
    ,t1.isu_dt --发卡日期|C8
    ,t1.cr_crd_card_nbr
    ,t1.cr_crd_pd_id
    ,t3.cardseq
    ,t3.cardname
    ,t3.cardname2
    ,t4.cr_crd_mgr_nm	        --信用卡业务管户人
    ,t4.cr_crd_org_nm	        --信用卡业务管户机构
    ,t4.cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
    ,t4.prm_mgr_nm	            --客户主管户客户经理名称
    ,t4.prm_org_nm	            --客户主管户机构名称
    ,t4.prm_sbr_nm              --客户主管户支行名称
    ,t5.reg_opr_id	--登记人|C10
    ,t6.EMPE_NM     as reg_opr_nm
    ,t5.reg_org_id	--登记机构|C12
    ,t7.tem_org_nm  as reg_tem_nm
    ,t7.sbr_org_nm  as reg_sbr_nm
FROM edw.dim_bus_crd_cr_crd_inf_dd  t1 --信用卡卡片信息
INNER JOIN edw.ncrd_card            t2 --卡片资料表
ON t1.cr_crd_card_nbr = t2.card_nbr
AND t2.dt = '20240930'
INNER JOIN edw.ifsp_cardinfo        t3
ON concat(t1.pd_cd, t2.cdfrm) = t3.cardseq
AND t3.dt = '20240930'
AND t3.cardname regexp '百年好合卡' --百年好合卡通用版
INNER JOIN
(
	SELECT  DISTINCT cst_id
	    ,cr_crd_brc_org_nm
        ,cr_crd_mgr_nm	        --信用卡业务管户人
        ,cr_crd_org_nm	        --信用卡业务管户机构
        ,cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
        ,prm_mgr_nm	                    --客户主管户客户经理名称
        ,prm_org_nm	                    --客户主管户机构名称
        ,sbr_org_nm	 as prm_sbr_nm      --客户主管户支行名称
	FROM app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd
	WHERE dt = '20240930'
	AND cr_crd_brc_org_nm = '衢州分行'
)T4 ON T1.cst_id = T4.cst_id
LEFT JOIN edw.dwd_bus_crd_cr_crd_apl_inf_dd	t5 --信用卡申请信息
ON      t1.BUSI_APL_ID = t5.CR_CRD_APL_SRL_NBR
AND     t5.DT = '20240930'
left join edw.dws_hr_empe_inf_dd            t6 --员工信息汇总
on  t5.reg_opr_id=t6.empe_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t7 --考核机构树
on  t5.reg_org_id=t7.org_id
and t7.dt='@@{yyyyMMdd}'
WHERE t1.dt = '20240930'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_02 as
SELECT  t1.cst_id --客户编号|C20
    ,t1.cst_nm --客户名称|C200
    ,t1.isu_dt --发卡日期|C8
    ,t1.cr_crd_card_nbr
    ,t1.cr_crd_pd_id
    ,t4.cr_crd_mgr_nm	        --信用卡业务管户人
    ,t4.cr_crd_org_nm	        --信用卡业务管户机构
    ,t4.cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
    ,t4.prm_mgr_nm	            --客户主管户客户经理名称
    ,t4.prm_org_nm	            --客户主管户机构名称
    ,t4.prm_sbr_nm              --客户主管户支行名称
    ,t5.reg_opr_id	--登记人|C10
    ,t6.EMPE_NM     as reg_opr_nm
    ,t5.reg_org_id	--登记机构|C12
    ,t7.tem_org_nm  as reg_tem_nm
    ,t7.sbr_org_nm  as reg_sbr_nm
from edw.dim_bus_crd_cr_crd_inf_dd t1 --信用卡卡片信息
INNER JOIN (
	SELECT  DISTINCT cst_id
	    ,cr_crd_brc_org_nm
        ,cr_crd_mgr_nm	        --信用卡业务管户人
        ,cr_crd_org_nm	        --信用卡业务管户机构
        ,cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
        ,prm_mgr_nm	                    --客户主管户客户经理名称
        ,prm_org_nm	                    --客户主管户机构名称
        ,sbr_org_nm	 as prm_sbr_nm      --客户主管户支行名称
    FROM app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd
    WHERE dt='20240930'
    AND cr_crd_brc_org_nm='衢州分行'
)T4 ON T1.cst_id=T4.cst_id
LEFT JOIN edw.dwd_bus_crd_cr_crd_apl_inf_dd	t5 --信用卡申请信息
ON      t1.BUSI_APL_ID = t5.CR_CRD_APL_SRL_NBR
AND     t5.DT = '20240930'
left join edw.dws_hr_empe_inf_dd            t6 --员工信息汇总
on  t5.reg_opr_id=t6.empe_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t7 --考核机构树
on  t5.reg_org_id=t7.org_id
and t7.dt='@@{yyyyMMdd}'
where t1.dt='20240930'
and t1.cr_crd_pd_id='0054'	--信用卡产品编号 百年好合卡 定制卡
;
-- 当前是否为有效户 存款	贷款	信用卡	财富
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_03 as
SElECT t1.cst_id
	,t2.efe_dep_cst_ind         --有效存款户标识
	,t2.efe_loan_cst_ind        --有效信贷户标识
	,t2.efe_wlth_cst_ind        --有效财富户标识
    ,t3.cr_crd_vld_cst_ind	    --信用卡有效户标识:0否1是
from (
    SElECT cst_id
    from SJXQ_SJ2024100946_CST_01
    union
    SElECT cst_id
    from SJXQ_SJ2024100946_CST_02
)t1 left join adm_pub.adm_csm_cbas_ind_inf_dd 		    t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='20240930'
left join adm_pub.adm_csm_clab_cr_crd_bas_lab_inf_dd    t3 --客户集市-客户标签信息-信用卡-基本标签信息
on t1.cst_id=t3.cst_id
and t3.dt='20240930'
;
-- 理财	保险	基金	贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_04 as
SELECT  t1.cst_id           --客户编号
    ,t2.xyk_act_cnt     --信用卡账号数
    ,t2.xyk_bal         --信用卡余额
    ,case when nvl(t3.sam_rsk_ctrl_id,'')<>'' then t3.sam_rsk_ctrl_id else t1.cst_id end sam_rsk_ctrl_id    --同一风险控制号
    ,t4.fnc_amt          --理财金额
    ,t4.fnc_mon_avg_amt  --理财金额月日均
    ,t4.insu_amt         --保险保费
    ,t4.insu_mon_avg_amt --保险保费月日均
    ,t4.fund_amt         --基金金额
    ,t4.fund_mon_avg_amt --基金金额月日均
    ,t4.gold_amt         --贵金属近一年金额
    ,t4.gold_mon_avg_amt --贵金属金额月日均
    ,t5.dep_bal          --存款余额
    ,t5.dep_bal_mon_avg  --存款余额月日均
    ,t6.ctr_amt          --授信金额
    ,t6.ctr_bal          --用信余额
from SJXQ_SJ2024100946_CST_03                       t1
left join(
    SElECT cst_id
        ,count(distinct cr_crd_act_id)  as xyk_act_cnt
        ,sum(bal)                       as xyk_bal --信用卡余额
    from app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd	--信用卡账户信息汇总表
    where dt='20240930'
    group by cst_id
)t2 on  t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd 				    t3 --客户基础信息汇总表
on  t1.cst_id=t3.cst_id
and t3.dt='20240930'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t4 --客户金融资产信息表
on  t1.cst_id=t4.cst_id
and t4.dt='20240930'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t5 --存款业务信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20240930'
left join(
    select cst_id
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd    t1
    inner join edw.dim_bus_loan_prd_frml_dd t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20240930'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20240930'
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
;
-- 同一风险控制号下全部客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_05 as
SELECT  sam_rsk_ctrl_id
       ,SUM(dep_bal)          AS 存款余额
       ,SUM(dep_bal_mon_avg)  AS 存款余额月日均
       ,SUM(ctr_amt)          AS 授信金额
       ,SUM(ctr_bal)          AS 用信余额
       ,SUM(xyk_act_cnt)      AS 信用卡账号数
       ,SUM(xyk_bal)          AS 信用卡余额
       ,SUM(fnc_amt)          AS 理财金额
       ,SUM(fnc_mon_avg_amt)  AS 理财金额月日均
       ,SUM(insu_amt)         AS 保险保费
       ,SUM(insu_mon_avg_amt) AS 保险保费月日均
       ,SUM(fund_amt)         AS 基金金额
       ,SUM(fund_mon_avg_amt) AS 基金金额月日均
       ,SUM(gold_amt)         AS 贵金属近一年金额
       ,SUM(gold_mon_avg_amt) AS 贵金属金额月日均
from SJXQ_SJ2024100946_CST_04
group by sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024100946_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100946_CST_06 as
SELECT  t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.card_type          AS 卡片类型
       ,t1.cr_crd_card_nbr    AS 卡号
       ,t1.isu_dt             AS 发卡日期
       ,t1.reg_opr_nm         AS 登记人
       ,t1.reg_tem_nm         AS 登记团队
       ,t1.reg_sbr_nm         AS 登记支行
       ,t1.cr_crd_mgr_nm      AS 信用卡业务管户人
       ,t1.cr_crd_org_nm      AS 信用卡业务管户机构
       ,t1.cr_crd_sbr_org_nm  AS 信用卡业务管户支行名称
       ,t1.prm_mgr_nm         AS 客户主管户客户经理名称
       ,t1.prm_org_nm         AS 客户主管户机构名称
       ,t1.prm_sbr_nm         AS 客户主管户支行名称
       ,t2.efe_dep_cst_ind    AS 有效存款户标识
       ,t2.efe_loan_cst_ind   AS 有效信贷户标识
       ,t2.cr_crd_vld_cst_ind AS 信用卡有效户标识
       ,t2.efe_wlth_cst_ind   AS 有效财富户标识
       ,t3.dep_bal            AS 单客户_存款余额
       ,t3.dep_bal_mon_avg    AS 单客户_存款余额月日均
       ,t3.ctr_amt            AS 单客户_授信金额
       ,t3.ctr_bal            AS 单客户_用信余额
       ,t3.xyk_act_cnt        AS 单客户_信用卡账号数
       ,t3.xyk_bal            AS 单客户_信用卡余额
       ,t3.fnc_amt            AS 单客户_理财金额
       ,t3.fnc_mon_avg_amt    AS 单客户_理财金额月日均
       ,t3.insu_amt           AS 单客户_保险保费
       ,t3.insu_mon_avg_amt   AS 单客户_保险保费月日均
       ,t3.fund_amt           AS 单客户_基金金额
       ,t3.fund_mon_avg_amt   AS 单客户_基金金额月日均
       ,t3.gold_amt           AS 单客户_贵金属近一年金额
       ,t3.gold_mon_avg_amt   AS 单客户_贵金属金额月日均
       ,t4.存款余额                 AS 同一风险控制号下_存款余额
       ,t4.存款余额月日均            AS 同一风险控制号下_存款余额月日均
       ,t4.授信金额                 AS 同一风险控制号下_授信金额
       ,t4.用信余额                 AS 同一风险控制号下_用信余额
       ,t4.信用卡账号数             AS 同一风险控制号下_信用卡账号数
       ,t4.信用卡余额                AS 同一风险控制号下_信用卡余额
       ,t4.理财金额                 AS 同一风险控制号下_理财金额
       ,t4.理财金额月日均            AS 同一风险控制号下_理财金额月日均
       ,t4.保险保费                 AS 同一风险控制号下_保险保费
       ,t4.保险保费月日均            AS 同一风险控制号下_保险保费月日均
       ,t4.基金金额                 AS 同一风险控制号下_基金金额
       ,t4.基金金额月日均            AS 同一风险控制号下_基金金额月日均
       ,t4.贵金属近一年金额           AS 同一风险控制号下_贵金属近一年金额
       ,t4.贵金属金额月日均           AS 同一风险控制号下_贵金属金额月日均
from(
    SELECT  cst_id         --客户编号|C20
        ,cst_nm            --客户名称|C200
        ,isu_dt            --发卡日期|C8
        ,cr_crd_card_nbr
        ,cr_crd_mgr_nm     --信用卡业务管户人
        ,cr_crd_org_nm     --信用卡业务管户机构
        ,cr_crd_sbr_org_nm --信用卡业务管户支行名称
        ,prm_mgr_nm        --客户主管户客户经理名称
        ,prm_org_nm        --客户主管户机构名称
        ,prm_sbr_nm        --客户主管户支行名称
        ,reg_opr_nm        --登记人
        ,reg_tem_nm        --登记团队
        ,reg_sbr_nm        --登记支行
    ,'通用版' as card_type
    from SJXQ_SJ2024100946_CST_01
    union all
    SELECT  cst_id         --客户编号|C20
        ,cst_nm            --客户名称|C200
        ,isu_dt            --发卡日期|C8
        ,cr_crd_card_nbr
        ,cr_crd_mgr_nm     --信用卡业务管户人
        ,cr_crd_org_nm     --信用卡业务管户机构
        ,cr_crd_sbr_org_nm --信用卡业务管户支行名称
        ,prm_mgr_nm        --客户主管户客户经理名称
        ,prm_org_nm        --客户主管户机构名称
        ,prm_sbr_nm        --客户主管户支行名称
        ,reg_opr_nm        --登记人
        ,reg_tem_nm        --登记团队
        ,reg_sbr_nm        --登记支行
        ,'定制版'
    from SJXQ_SJ2024100946_CST_02
)t1 left join SJXQ_SJ2024100946_CST_03  t2
on t1.cst_id=T2.cst_id
left join SJXQ_SJ2024100946_CST_04      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024100946_CST_05      t4
on t3.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100946_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024100946_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024100946_CST_06
;
SElECT '06' seq, *
from SJXQ_SJ2024100946_CST_06
***SJ2024100971_小营支行担保人及配偶信息.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024100971_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100971_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --用信申请流水号
       ,col_3 --合同登记流水号
       ,col_4 --客户号
       ,col_5 --客户名称
from qbi_file_20241012_08_58_16
where pt<>''
;
-- 担保人
DROP   TABLE IF     EXISTS SJXQ_SJ2024100971_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100971_CST_02 AS
SElECT t1.col_3 as ctr_serno
    -- ,t2.wrnt_cst_id         --保证人客户编号
    -- ,t2.wrnt_cst_nm         --保证人客户名称
    -- ,t2.grnt_psn_seq_nbr    --担保人序号
from SJXQ_SJ2024100971_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.col_3=t2.bus_ctr_id           --业务合同编号
and t2.dt = '@@{yyyyMMdd}'
group by ctr_serno
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2024100971_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100971_CST_03 AS
SElECT t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
    -- ,t1.rel_typ
    -- ,c1.cd_val_dscr as rel_typ_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --法人 实际控制人的企业
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --法人 实际控制人的企业
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024100971_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024100971_CST_04 AS
SELECT  t1.col_1        AS 序号
       ,t1.col_2        AS 用信申请流水号
       ,t1.col_3        AS 合同登记流水号
       ,t1.col_4        AS 客户号
       ,t1.col_5        AS 客户名称
       ,t2.wrnt_cst_ids AS 保证人客户编号
       ,t2.wrnt_cst_nms AS 保证人客户名称
       ,t3.rel_cst_id   AS 配偶客户号
       ,t3.rel_cst_nm   AS 配偶客户名称
from SJXQ_SJ2024100971_CST_01       t1
left join SJXQ_SJ2024100971_CST_02  t2
on t1.col_3=t2.ctr_serno
left join(
    select cst_id
    from SJXQ_SJ2024100971_CST_03
    group by cst_id
)t3 on t1.col_4=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ2024100971_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024100971_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024100971_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同登记流水号) custs
from SJXQ_SJ2024100971_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024100971_CST_04
***SJ2024101006_符亦芸支行举一反三.sql
-- edw.dwd_bus_loan_aply_acpt_reloan_dd	续贷申请受理信息	43	xpc_reloan_amt	decimal	预计续贷金额|decimal(21,2)
-- edw.dwd_bus_loan_aply_acpt_onl_dd	申请受理线上商机进件	20	aply_lmt	decimal	申请额度|decimal(21,2)
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024101006_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101006_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --客户号
       ,col_3 --客户名称
       ,col_4 --合同终结日期
       ,col_5 --合同登记流水号
       ,col_6 --合同金额
from qbi_file_20241012_09_04_09
where pt<>''
;
-- 老预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2024101006_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101006_CST_02 AS
SElECT distinct t1.col_5 as ctr_serno
    ,t1.col_4 as mtu_dt
    ,substr(REPLACE(T2.inputdate, '/', ''), 1, 8)  as PRE_ASES_dt
from SJXQ_SJ2024101006_CST_01               t1
inner join edw.loan_customer_preevaluate    t2 --客户预评估申请表
on t1.col_3=t2.customerid	--客户编号
and abs(DATEDIFF(to_date(t1.col_4, 'yyyy-mm-dd'), to_date(substr(REPLACE(T2.inputdate, '/', ''), 1, 8), 'yyyymmdd'), 'DD'))<=3
and  t2.dt='20240719'
;
-- 新预评估
DROP   TABLE IF     EXISTS SJXQ_SJ2024101006_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101006_CST_03 AS
SElECT distinct t1.col_5 as ctr_serno
    ,t1.col_4 as mtu_dt
    ,substr(REPLACE(T2.sys_reg_tm, '-', ''), 1, 8)	as PRE_ASES_dt --预评估系统登记时间
from SJXQ_SJ2024101006_CST_01                       t1
inner join EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD    t2 --预评估业务申请
on t1.col_3=t2.cst_id	--客户编号
and abs(DATEDIFF(to_date(t1.col_4, 'yyyy-mm-dd'), to_date(substr(REPLACE(T2.sys_reg_tm, '-', ''), 1, 8), 'yyyymmdd'), 'DD'))<=3
and  t2.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024101006_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101006_CST_04 AS
SELECT  t1.col_1 as 序号
       ,t1.col_2 as 客户号
       ,t1.col_3 as 客户名称
       ,t1.col_4 as 合同终结日期
       ,t1.col_5 as 合同登记流水号
       ,t1.col_6 as 合同金额
       ,t2.PRE_ASES_dt as 预评估日期
       ,case when t2.ctr_serno is not null then 'Y' else 'N' end as 是否终结日前后三天内发起过预评估
from SJXQ_SJ2024101006_CST_01       t1
left join(
    select ctr_serno,mtu_dt
    from(
        select ctr_serno,mtu_dt,PRE_ASES_dt
        from SJXQ_SJ2024101006_CST_02
        union
        select ctr_serno,mtu_dt,PRE_ASES_dt
        from SJXQ_SJ2024101006_CST_03
    )T1 group by ctr_serno,mtu_dt
)t2 on t1.col_5=t2.ctr_serno
and t1.col_4 = t2.mtu_dt
;
SElECT '01' seq, count(1) cnt,count(distinct col_3) custs
from SJXQ_SJ2024101006_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024101006_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024101006_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024101006_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024101006_CST_04
***SJ2024101076_长乐村行不同担保人需求.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024101076_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101076_CST_01 AS
SELECT  col_1  --序号
       ,col_2  --管户机构名称
       ,col_3  --管户人工号
       ,col_4  --管户人名称
       ,col_5  --经办人名称
       ,col_6  --经办人机构名称
       ,col_7  --用信申请流水号
       ,col_8  --合同登记流水号
       ,col_9  --合同编号
       ,col_10 --客户号
       ,col_11 --客户名称
       ,col_12 --发生类型
       ,col_13 --业务标识
       ,col_14 --产品名称
       ,col_15 --合同起始日期
       ,col_16 --合同到期日期
       ,col_17 --合同金额
       ,col_18 --合同余额
from qbi_file_20241011_15_46_31
where pt<>''
;
/* --合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024101076_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101076_CST_02 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.bsn_mark_cd	    --业务标识代码|c32
    ,c1.cd_val_dscr     as bsn_mark_nm
    ,t1.usc_aply_dt	    --用信申请日期|c8
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
    ,T10.aprv_dt      AS 上一次完成年审时间
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240930'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240930'
and t4.brc_org_nm regexp '福建长乐泰隆村镇'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20240930'
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = '20240930'
where t1.dt='20240930'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
*/
-- 每笔业务担保人信息 -- 担保人
DROP   TABLE IF     EXISTS SJXQ_SJ2024101076_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101076_CST_02 AS
SElECT t1.col_8
    ,t2.wrnt_cst_id         --保证人客户编号
    ,t2.wrnt_cst_nm         --保证人客户名称
    ,t2.grnt_psn_seq_nbr    --担保人序号
    ,ROW_NUMBER() over(partition by t1.col_8 order by t2.grnt_psn_seq_nbr asc) rn
from SJXQ_SJ2024101076_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.col_8=t2.bus_ctr_id           --业务合同编号
and t2.dt = '20240930'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024101076_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101076_CST_03 AS
SELECT  t1.col_1  as 序号
    ,t1.col_2  as 管户机构名称
    ,t1.col_3  as 管户人工号
    ,t1.col_4  as 管户人名称
    ,t1.col_5  as 经办人名称
    ,t1.col_6  as 经办人机构名称
    ,t1.col_7  as 用信申请流水号
    ,t1.col_8  as 合同登记流水号
    ,t1.col_9  as 合同编号
    ,t1.col_10 as 客户号
    ,t1.col_11 as 客户名称
    ,t1.col_12 as 发生类型
    ,t1.col_13 as 业务标识
    ,t1.col_14 as 产品名称
    ,t1.col_15 as 合同起始日期
    ,t1.col_16 as 合同到期日期
    ,t1.col_17 as 合同金额
    ,t1.col_18 as 合同余额
    ,t2.wrnt_cst_nm as 担保人1_名称
    ,t3.wrnt_cst_nm as 担保人2_名称
    ,t4.wrnt_cst_nm as 担保人3_名称
    ,t5.wrnt_cst_nm as 担保人4_名称
from SJXQ_SJ2024101076_CST_01       t1
left join SJXQ_SJ2024101076_CST_02  t2
on t1.col_8=t2.col_8 and t2.rn=1
left join SJXQ_SJ2024101076_CST_02  t3
on t1.col_8=t3.col_8 and t3.rn=2
left join SJXQ_SJ2024101076_CST_02  t4
on t1.col_8=t4.col_8 and t4.rn=3
left join SJXQ_SJ2024101076_CST_02  t5
on t1.col_8=t5.col_8 and t5.rn=4
;
SElECT '01' seq, count(1) cnt,count(distinct col_8) custs
from SJXQ_SJ2024101076_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct col_8) custs
from SJXQ_SJ2024101076_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同登记流水号) custs
from SJXQ_SJ2024101076_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2024101076_CST_03
***SJ2024101286_嘉兴分行理财销售人核实.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-10-14 16:15:19
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 管护在嘉兴分行海宁支行、海宁袁花支行、海宁长安支行、和海宁盐官支行的客户的理财的销售人
-- 理财交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024101286_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101286_CST_01 AS
select t1.tacfm_srl_nbr                            --ta确认流水号|c32
	,t1.srl_nbr                                  --流水号|c32
	,t1.cst_id                                   --客户编号|c24
    ,t6.cst_chn_nm
	,t1.cfm_dt                                   --确认日期|c8
	,t1.cfm_amt                                  --确认金额|decimal(20,2)
	,t1.mgr_id                                   --客户经理编号|c32
    ,t4.mgr_id  as sale_mgr_id
	,t2.pd_cd
    ,t2.pd_nm   --产品名称
    ,t2.pfm_comp_bas    --业绩比较基准
    ,t2.pd_found_dt     --产品成立日期
    ,t2.pd_val_dt       --产品起息日期
    ,t2.pd_end_dt       --产品结束日期
	,t3.mgr_id  as acs_mgr_id                                 --管护人编号
    ,c1.empe_nm as acs_mgr_nm
    ,t3.acs_rto	--考核比例
	,t3.acs_org_id                               --考核机构编号
    ,t5.org_nm
    ,t5.sbr_org_nm
from edw.dwd_bus_chm_trx_cfm_dtl_dd           t1 --理财交易确认流水明细
left join edw.dim_bus_chm_pd_inf_dd           t2
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_bus_chm_act_mgr_inf_dd      t3 --理财考核汇总信息
on  t1.cst_id=t3.cst_id
and t1.pd_cd=t3.pd_cd
and t1.bnk_act_id=t3.bnk_act_id
and t3.dt='@@{yyyyMMdd}'
and t3.mng_typ_cd = '1'  --`管户`类型 1考核 2销售
and t3.pd_tp_cd='1'      --理财类型：0基金 1理财
left join edw.dws_bus_chm_act_mgr_inf_dd      t4 --理财考核汇总信息
on  t1.cst_id=t4.cst_id
and t1.pd_cd=t4.pd_cd
and t1.bnk_act_id=t4.bnk_act_id
and t4.dt='@@{yyyyMMdd}'
and t4.mng_typ_cd = '2'  --`管户`类型 1考核 2销售
and t4.pd_tp_cd='1'      --理财类型：0基金 1理财
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd   t5
ON      t3.acs_org_id = t5.org_id
AND     t5.dt = '@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd 			  t6    --客户基础信息汇总表
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd              c1 --员工信息汇总
on  t3.mgr_id=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t5.brc_org_nm='嘉兴分行'
and t5.sbr_org_nm regexp '海宁支行|海宁袁花|海宁长安|海宁盐官'
;
-- 输出结果 历史所有交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024101286_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101286_CST_02 AS
SELECT  tacfm_srl_nbr AS ta确认流水号
       ,srl_nbr       AS 流水号
       ,cst_id        AS 客户编号
       ,cst_chn_nm    AS 客户姓名
       ,acs_mgr_id    AS 管护客户经理工号
       ,acs_mgr_nm    AS 管护客户经理姓名
       ,acs_rto	as 考核比例
       ,org_nm        AS 管护部门
       ,sbr_org_nm    AS 管护支行
       ,pd_nm         AS 产品名称
       ,cfm_dt        AS 确认日期
       ,cfm_amt       AS 确认金额
       ,sale_mgr_id   AS 销售人工号
from SJXQ_SJ2024101286_CST_01
;
SElECT '01' seq, count(1) cnt,count(distinct srl_nbr) custs
from SJXQ_SJ2024101286_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 流水号) custs
from SJXQ_SJ2024101286_CST_02
;
SElECT *
from SJXQ_SJ2024101286_CST_02
;
***SJ2024101406_舟山分行财富数据.sql
﻿-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-10-14 10:07:50
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 1 、 历史曾购买过我行贵金属产品的客户 + 2 、 20 - 60岁 &amp; 女性 ， 若数据量很大 ， 则再加 &ldquo; &amp; 存款余额5万及以上 &rdquo; 条件 清单客户数控制在10万以内
-- 1.1 购买过我行贵金属产品
DROP TABLE IF EXISTS lab_bigdata_dev.YXQD_024547_GOLD_20241014_01 ;
CREATE TABLE lab_bigdata_dev.YXQD_024547_GOLD_20241014_01 AS
SELECT  DISTINCT CST_ID --客户号
                 ,'贵金属购买客户' AS reason
FROM    ADM_PUB.adm_pub_cst_nob_met_trx_sum_di --贵金属交易明细表
WHERE   dt <= '@@{yyyyMMdd}';
-- 1.2 客户字段
DROP TABLE IF EXISTS YXQD_024547_GOLD_20241014_021 PURGE;
CREATE TABLE IF NOT EXISTS YXQD_024547_GOLD_20241014_021 AS
SELECT  t1.cst_id
        ,t1.age
        ,decode(t1.gdr_cd, '1', '男', '2', '女', '未知') AS gdr_nm
        ,t2.dmnd_dep_bal                             AS 活期存款余额
        ,CASE
           WHEN t3.cst_id IS NOT NULL THEN '是'
           ELSE ''
         END                                         AS 是否历史购买过我行贵金属
        ,t4.天添宝余额
FROM    adm_pub.adm_csm_cbas_idv_bas_inf_dd t1 --对私客户基础信息
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd t2 --存款业务信息表
ON      t1.cst_id = t2.cst_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    YXQD_024547_GOLD_20241014_01 t3
ON      t1.cst_id = t3.cst_id
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,sum(t.cur_fnc_amt) AS 天添宝余额
                 FROM    edw.dws_bus_chm_act_mgr_inf_dd t
                 INNER JOIN    edw.dwd_bus_chm_ptfl_cpn_pd_rel_inf_dd t2
                 ON      t.pd_cd = t2.pd_cd
                 AND     t2.DVD_GRP_CD = 'TTB001'
                 AND     t2.dt = '@@{yyyyMMdd}'
                 WHERE   t.mng_typ_cd = '1'
                 and t.dt = '@@{yyyyMMdd}'
                 GROUP BY t.cst_id
             ) t4
ON      t1.cst_id = t4.cst_id
WHERE   t1.dt = '@@{yyyyMMdd}';
-- 1.3
DROP TABLE IF EXISTS YXQD_024547_GOLD_20241014_031;
CREATE TABLE IF NOT EXISTS YXQD_024547_GOLD_20241014_031 AS
SELECT  *
FROM    YXQD_024547_GOLD_20241014_021
WHERE   ( 是否历史购买过我行贵金属 = '是' )
    OR ( age >= 30
AND     age <= 60
AND     gdr_nm = '女'
AND     天添宝余额 >= 300000 )
    OR ( age >= 30
AND     age <= 60
AND     gdr_nm = '女'
AND     活期存款余额 >= 50000 );
SELECT *
FROM    YXQD_024547_GOLD_20241014_031;
-- 1.4
DROP TABLE IF EXISTS YXQD_024547_GOLD_20241014_041;
CREATE TABLE IF NOT EXISTS YXQD_024547_GOLD_20241014_041 AS
SELECT  t1.cst_id
    ,t1.age
    ,t1.gdr_nm
    ,t1.活期存款余额
    ,t1.是否历史购买过我行贵金属
    ,t1.天添宝余额
    ,t3.prm_mgr_nm as 主管户客户经理
    ,t4.brc_org_nm as 主管户分行
    ,t4.sbr_org_nm as 主管户支行
from YXQD_024547_GOLD_20241014_031                  t1
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t4.brc_org_nm='舟山分行'
;
***SJ2024101496_台州分行担保合同信息.sql
﻿DROP TABLE IF EXISTS lab_bigdata_dev.SJ2024101496_cst_danbao_inf_20241023;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2024101496_cst_danbao_inf_20241023 AS
SELECT  T5.grnt_gds_id                AS 担保人客户号
        ,t5.grnt_gds_nm               AS 担保人客户名称
        ,t4.grnt_ctr_no               AS 担保合同编号
        ,t5.grnt_amt                  AS 担保金额
        ,t4.wrat_cst_id               AS 被担保人客户号
        ,t4.wrat_nm                   AS 被担保人名称
        ,CASE
           WHEN t4.grnt_ctr_sts_cd = '2' THEN '已生效'
         END                          AS 担保合同状态
        ,t6.cd_val_dscr               AS 担保合同类型
        ,t4.grnt_ctr_bgn_dt           AS 担保合同起始日期
        ,t4.grnt_ctr_mtu_dt           AS 担保合同到期日期
        ,t12.age    as 担保人年龄
        ,t12.bth_dt as 担保人出生日期
        ,c1.cd_val_dscr as 担保人职业
        ,t7.prm_mgr_id                AS 主管护客户经理工号
        ,t7.prm_mgr_nm                AS 主管护客户经理姓名
        ,t8.tem_org_nm                AS 团队层级机构名称
        ,t9.dep_bal_mon_avg           AS 存款余额月日均
        ,t10.我行贷款余额
        ,t10.我行综合授信
        ,t10.我行贷款合同金额
        ,t10.我行随贷通卡合同金额
        ,t10.我行信用卡合同金额
        ,t11.report_dt                AS 最新征信日期
        ,t11.oth_bank_loan_credit_bal AS 他行贷款授信余额
        ,t11.guar_contr_amt           AS 对外担保金额
FROM    edw.dim_bus_loan_ctr_grnt_inf_dd t4 --担保合同信息  取担保类型为担保的合同
LEFT JOIN(
    SELECT  DISTINCT grnt_ctr_no,grnt_gds_id,grnt_gds_nm,grnt_amt
    from EDW.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD
    where DT = '@@{yyyyMMdd}'
    AND   GRNT_GDS_TYP_CD = 1 -- 保证人
) T5 --主合同、担保合同、担保物关系
ON      t4.grnt_ctr_no = T5.grnt_ctr_no
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD t6
ON      t4.grnt_ctr_typ_cd = t6.cd_val
AND     t6.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t7 --客户集市-客户基础-客户管户信息
ON      T5.grnt_gds_id = t7.cst_id
AND     t7.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t8 --机构树_考核维度
ON      t7.prm_org_id = t8.org_id
AND     t8.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd t9 --客户集市-业务信息-客户存款业务信息表
ON      t5.grnt_gds_id = t9.cst_id
AND     t9.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,sum(t1.ctr_bal) AS 我行贷款余额
                         ,sum(t1.ctr_amt) AS 我行综合授信
                         ,sum(CASE
                                WHEN t1.PRD_NO NOT IN ( '2002010101001' , '2002010101901' ) THEN t1.ctr_amt
                                ELSE 0
                              END)        AS 我行贷款合同金额
                         ,sum(CASE
                                WHEN t1.PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN t1.ctr_amt
                                ELSE 0
                              END)        AS 我行随贷通卡合同金额
                         ,sum(CASE
                                WHEN t1.PRD_NO IN ( '2002010101001' , '2002010101901' ) THEN t1.ctr_amt
                                ELSE 0
                              END)        AS 我行信用卡合同金额
                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 GROUP BY t1.cst_id
             ) t10
ON      t5.grnt_gds_id = t10.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd t11
ON      t5.grnt_gds_id = t11.cst_id
AND     t11.report_dsc_rn = 1
AND     t11.dt = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd t12 --客户集市-客户基础-对私客户基础信息
ON      t5.grnt_gds_id = t12.cst_id
AND     t12.dt = '@@{yyyyMMdd}'
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD c1
ON      t12.ocp_cd = c1.cd_val
AND     c1.dt = '@@{yyyyMMdd}'
WHERE   t4.dt = '@@{yyyyMMdd}'
AND     T4.grnt_mod_cd = '010' -- 担保
AND     t4.grnt_ctr_sts_cd = '2' --担保合同状态代码:2 已生效
AND     T5.grnt_gds_id IS NOT NULL
AND     t10.我行贷款余额 = 0
AND     t8.brc_org_nm = '台州分行'
;
SELECT count(1) cnt,count(DISTINCT 担保合同编号) custs
from lab_bigdata_dev.SJ2024101496_cst_danbao_inf_20241023
***SJ20241017106_苏州分行中征分.sql
-- 截至2024年9月30日，苏州分行有授信客户的中证分
-- 数据需求字段
-- 截至2024年9月30日，苏州分行有授信客户的客户编号和中证分
-- 授信客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241017106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241017106_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t2.PD_NM
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' )
        AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
        then 1 else 0 end is_not_mtu
from edw.dim_bus_loan_ctr_bse_inf_dd       t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240930'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240930'
where t1.dt='20240930'
and t4.brc_org_nm = '苏州分行'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20241017106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241017106_CST_02 AS
SELECT  cst_id
    ,prd_dt
    ,cst_cr_grd_val
    ,ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY prd_dt DESC) AS rn
FROM (
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20240930'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20240930'
)t
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241017106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241017106_CST_03 AS
SELECT  t1.cst_ID         AS 客户号
       ,decode(t1.is_not_mtu,1,'是','') AS 合同未到期未终结
       ,t2.cst_cr_grd_val AS 中征分
from(
    SElECT cst_ID
        ,max(is_not_mtu) is_not_mtu
    from SJXQ_SJ20241017106_CST_01
    group by cst_id
)T1 left join SJXQ_SJ20241017106_CST_02 t2
on t1.cst_ID=t2.cst_ID
and t2.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241017106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241017106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241017106_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20241017106_CST_03
***SJ2024101791_上海分行反洗钱数据分析.sql
-- 查冻扣
DROP   TABLE IF     EXISTS SJXQ_SJ2024101791_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101791_CST_01 AS
SELECT  T1.qry_ctrl_chnl_nm AS 查控渠道名称
        ,T4.cd_val_dscr     AS 有权机关类型
        ,T1.exe_rsn          AS 执行原因
        ,T1.instt_nm         AS 有权机关名称
        ,T1.law_doc_id       AS 法律文书编号
        ,T1.law_doc_nm       AS 法律文书名称
        ,T1.qry_ctrl_dt      AS 查控日期
        ,T1.qry_ctrl_tm      AS 查控时间
        ,T1.qry_ctrl_typ_nm  AS 查控类型代码
        ,T1.cst_id           AS 客户号
        ,T1.cst_nm           AS 客户名称
        ,CASE
           WHEN T1.CST_TYP_CD = '1' THEN '对私'
           WHEN T1.CST_TYP_CD = '2' THEN '对公'
         END                 AS 公私标识
        ,T1.cst_doc_typ_cd   AS 客户证件类型
        ,T1.cst_doc_nbr      AS 客户证件号码
        ,T1.cst_act_id       AS 客户账号
        ,T2.prm_org_id       AS 客户归属机构ID
        ,T2.prm_org_nm       AS 客户归属机构
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd T1
INNER JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户管户信息
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树
ON      T2.prm_org_id = T3.org_id
AND     T3.dt = '@@{yyyyMMdd}'
left join  edw.dwd_code_library_dd T4
on T1.instt_typ_cd=T4.cd_val
and T4.dt='@@{yyyyMMdd}'
WHERE   T1.dt = '@@{yyyyMMdd}'
-- AND     T1.qry_ctrl_dt >= '@@{yyyyMMdd-1y}'
AND     T1.qry_ctrl_dt <= '@@{yyyyMMdd}'
AND     T1.qry_ctrl_typ_nm IN ( '查询' , '冻结' , '划扣' )
AND     ( T1.instt_typ_cd IN ( '04' , '05' )
    OR ( ( T1.instt_nm LIKE '%法院%'
    OR T1.instt_typ_cd = '01' )
AND     T1.LAW_DOC_ID LIKE '%刑%' ) )
-- AND     T3.brc_org_nm = '上海分行'
;
--客户存款账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024101791_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101791_CST_02 AS
select t1.cst_act_id
    ,t1.cst_act_nm                             --客户名称|C200
	,t1.cst_id                                   --客户编号|C20
    ,t2.cst_chn_nm  --客户名称
    ,case when t1.cst_act_nm=t2.cst_chn_nm then 1 else 0 end is_cst_nm_equal
    ,case when t2.cst_chn_nm regexp '建筑工程服务|建筑装饰|贸易|餐饮' then 1 else 0 end is_keyword
	,t1.opn_dt                                   --开户日期|C8
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
from edw.dim_bus_dep_cst_act_inf_dd                 t1 --客户存款账户信息
left join edw.dws_cst_bas_inf_dd 				    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt= '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.opn_dt >= '@@{yyyyMMdd-1y}'  --近1年开户
and t1.ACT_STS_CD ='A'              --正常
and t4.brc_org_nm='上海分行'
;
--存款账户余额发生明细
DROP   TABLE IF     EXISTS SJXQ_SJ2024101791_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101791_CST_03 AS
SElECT t1.cst_id,t1.cst_act_id,t2.dep_act_id
    ,t2.dtl_seq_nbr
	,t2.trx_dt                                  --交易日期|C8
	,t2.trx_tm                                  --交易时间|C9
	,t2.crd_and_dbt_ind                         --借贷标志|C1
	,t2.trx_amt                                 --交易金额|DECIMAL(21,2)
	,t2.act_bal                                 --账户余额|DECIMAL(21,2)
	,t2.txt_code                                --摘要代码|C10
	,t2.smr_dscr                                --摘要描述|C512
    ,t2.cmt
from SJXQ_SJ2024101791_CST_02              t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细
on t1.cst_act_id=t2.cst_act_id
and t2.dt >= '@@{yyyyMMdd-1y}'
and t2.trx_dt >= '@@{yyyyMMdd-1y}'
-- and t2.crd_and_dbt_ind='C'  --贷方
;
-- 开通电子汇票功能
DROP   TABLE IF     EXISTS SJXQ_SJ2024101791_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101791_CST_04 AS
select t2.cst_id,min(t1.sign_dt) as sign_dt	--签约日期
from edw.nbms_ifb_cust_acct         t1 --客户账户签约信息表
INNER join SJXQ_SJ2024101791_CST_02 t2
on t1.cust_id=t2.cst_id
where t1.dt='@@{yyyyMMdd}'
and t1.elc_flg='1' --是否开通电票: 0-否, 1-是
and t1.sign_dt>='@@{yyyyMMdd-1y}'
and datediff(to_date(t1.sign_dt,'yyyyMMdd'),to_date(t2.opn_dt,'yyyyMMdd'),'dd') between 0 and 7
group by t2.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024101791_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024101791_CST_05 AS
SELECT  t1.cst_id                    AS 客户号
       ,t1.cst_chn_nm                AS 客户名称
       ,t1.cst_act_id as 客户账号
       ,T1.prm_org_id                AS 主管户机构号
       ,T1.org_nm                    AS 主管户机构名称
       ,t2.c_trx_cnt                 AS 近1年内贷方交易笔数
       ,t2.c_trx_amt                 AS 近1年内贷方交易金额
       ,t3.last_360_days_gl_bal_acml AS 近360天日均总账余额
       ,case when t4.cst_id is not null then '是' else '' end as 是否历史有查冻扣记录
       ,t1.opn_dt                    AS 开户日期
       ,case when t5.cst_id is not null then '是' else '' end as 是否近1年存在日交易1到100万笔数占比8成以上
       ,case when t6.cst_id is not null then '是' else '' end as 是否开户后7天内开通电子汇票功能
       ,t6.sign_dt                  as 电子汇票签约日期
from SJXQ_SJ2024101791_CST_02 t1
left join(
    select cst_ID,count(1)  as c_trx_cnt
        ,sum(trx_amt)       as c_trx_amt
    from SJXQ_SJ2024101791_CST_03
    where crd_and_dbt_ind='C'  --贷方
    group by cst_id
)t2 on t1.cst_id=t2.cst_id
left join(
    select cst_id
        ,round(sum(last_360_days_gl_bal_acml)/360,2)  as last_360_days_gl_bal_acml --近360天总账余额积数|DECIMAL(20,2)
    from edw.dws_bus_dep_act_mgr_inf_dd	--存款账户管护汇总信息
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
left join(
    select distinct 客户号 as cst_id
    from SJXQ_SJ2024101791_CST_01
)t4 on t1.cst_id=t4.cst_id
left join(
    select distinct cst_id
    from(
        select cst_ID,trx_dt,count(1) cnt
            ,sum(case when trx_amt between 10000 and 1000000 then 1 else 0 end) trx_cnt_s
        from SJXQ_SJ2024101791_CST_03
        group by cst_ID,trx_dt
    )t where trx_cnt_s/cnt > 0.8
)t5 on t1.cst_id=t5.cst_id
left join SJXQ_SJ2024101791_CST_04 t6
on  t1.cst_id=t6.cst_id
where t1.is_keyword=1                   --客户名称涉及&ldquo;建筑工程服务&rdquo;、&ldquo;建筑装饰&rdquo;、&ldquo;贸易&rdquo;、&ldquo;餐饮&rdquo;字样；
and t2.c_trx_amt>=10000000              --近一年贷方交易金额在1000万元及以上的
and t3.last_360_days_gl_bal_acml<=50000 -- 近一年账户日均留存余额在5万元及以下的
;
SElECT '01' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024101791_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2024101791_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024101791_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024101791_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2024101791_CST_05
;
SElECT '05' seq, *
from SJXQ_SJ2024101791_CST_05
;
***SJ20241022106_信贷客户营销取数.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_01 AS
SELECT  distinct col_1 AS cst_id --客户号
       ,col_2          AS cst_nm --客户名称
from qbi_file_20241024_09_00_08
where pt''
;
-- 客户信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_02 AS
SELECT  t1.cst_id
       ,t1.cst_nm
       ,t2.age
       ,t2.m_tel_no             --手机
       ,t3.efe_cst_ind          --有效户标识
       ,t3.efe_dep_cst_ind      --有效存款户标识
       ,t3.efe_loan_cst_ind     --有效贷款户标识
       ,t4.crd_amt              --授信金额
       ,t4.use_crd_bal          --用信余额
       ,t5.dep_bal_mon_avg      --存款余额月日均
       ,t6.loan_bal_acs_mon_avg --贷款余额月日均
       ,t7.sdt_nbr              --持有存量随贷通卡
       ,t7.is_hld_okv           --持有泰惠收产品
       ,nvL(t8.xpos_amt,0) as xpos_amt            --同一风险控制号下客户贷款敞口金额
       ,COALESCE(t8.sam_rsk_ctrl_id,t1.cst_id) as sam_rsk_ctrl_id      --同一风险控制号
    --    ,t9.companyname          --主营企业名称 --营业执照名称
    --    ,t10.lctax_cert_no	    --地税证件号C60
from SJXQ_SJ20241022106_CST_01                  t1
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd 	t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_ind_inf_dd 		t3 --客户基础标识信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	t4 --客户集市-业务信息-贷款-授信与额度
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_dep_inf_dd 		t5 --存款业务信息表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_loan_inf_dd 		t6 --贷款业务信息
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_pd_hld_inf_dd	t7 --客户集市-标签信息-客户持有产品信息表
on t1.cst_id=t7.cst_id
and t7.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_crisk_sam_rsk_ctrl_inf_dd	t8 --客户同一风险控制号信息
on t1.cst_id=t8.cst_id
and t8.dt='@@{yyyyMMdd}'
-- LEFT JOIN    edw.loan_customer_certification t9 --客户资质认证
-- ON      t2.doc_nbr = t9.certid
-- AND     t9.dt = '@@{yyyyMMdd}'
-- left join edw.dim_cst_entp_bas_inf_dd       t10			--企业客户基本信息
-- on t1.cst_id=t10.cst_id
-- and t10.dt='@@{yyyyMMdd}'
;
-- 社区信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_03 AS
SElECT t1.cst_id,t1.cst_nm
    ,t2.main_add        --主地址
    -- ,t2.com_son_code	--所属子社区编号 为空
    -- ,t2.com_son_name	--所属子社区名称 为空
    ,t3.prm_mgr_id
    ,t3.prm_mgr_nm
    ,t4.org_nm
    ,t5.sub_cmnt_id     --子社区编号
    ,t5.sub_cmnt_nm     --子社区名称
    ,decode(t2.main_add_flag,'1','经营','2','通讯','3','家庭','4','户籍','5','办公','6','注册','') as 主地址类型
FROM SJXQ_SJ20241022106_CST_01      t1
LEFT JOIN edw.xwdt_xw_customer      t2 --客户表(正潜灰)
ON  t1.cst_id = t2.cust_no
AND t2.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
---- 社区信息（仅看 普惠社区）
left join edw.dwd_cst_mng_cmnt_rel_dd               t5
on  t1.cst_id = t5.cst_id
and t5.dt ='@@{yyyyMMdd}'
and t5.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
;
--征信数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_04 AS
SELECT  t1.cst_id
       ,t2.report_dt                 --报告日期
       ,t2.oth_cred_total_amt        --他行授信总额
       ,t2.oth_bank_busi_org_num     --他行授信机构数_不含未激活
       ,t2.oth_bank_credit_total_amt --他行授信总余额_不含未激活
       ,t2.oth_bank_loan_org_num     --他行贷款授信机构数
       ,t2.oth_bank_loan_credit_bal  --他行贷款授信余额
       ,t3.oth_bnk_RATE
FROM SJXQ_SJ20241022106_CST_01              t1
inner join edw.dws_cst_ccrc_idv_ind_inf_dd	t2 --个人征信指标信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.report_dsc_rn=1	--报告降序排序号
left join (
	SELECT REPORT_ID
	FROM EDW.NCIP_CPQ_ACCOUNT_CALCULATE
	WHERE DT = '@@{yyyyMMdd}'
    and RATE'-9999' and nvl(rate,'')''
    group by REPORT_ID
)t3 on t2.report_no=t3.REPORT_ID
;
-- 营业执照名称
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_04_1 AS
SElECT t1.cst_id,t2.doc_nbr,t3.gpm_flowno
    ,t4.gpr_entname as 营业执照名称
from SJXQ_SJ20241022106_CST_01      t1
left join edw.dws_cst_bas_inf_dd    t2  --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
LEFT JOIN
(
	SELECT  gpm_ctfno
	       ,gpm_flowno
	FROM
	(
		SELECT  gpm_ctfno
		       ,gpm_flowno
		       ,ROW_NUMBER()OVER( PARTITION BY gpm_ctfno ORDER BY  gpm_hostsendtime DESC ) rn
		FROM edw.outd_gs_person_main --工商个人主表
		WHERE dt = '20200101'
		AND dt = '@@{yyyyMMdd}'
		AND substr(gpm_hostsendtime, 1, 8) = '20200101'
		AND substr(gpm_hostsendtime, 1, 8) = '@@{yyyyMMdd}'
	) a
	WHERE a.rn = 1
) t3 ON t2.doc_nbr = t3.gpm_ctfno --证件号关联
INNER join (
    SELECT  gpr_flowno,gpr_entname
        ,ROW_NUMBER() OVER(PARTITION BY gpr_flowno ORDER BY DT DESC) RN
    FROM edw.outd_gs_person_ryposfr
    WHERE dt = '20200101'
    AND nvl(gpr_entname,'')''
) t4  --工商个人-人员法人信息
on t3.gpm_flowno=t4.gpr_flowno  --工商流水号
AND T4.RN=1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_04_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_04_2 AS
SELECT cst_id,mch_name,mcht_licn_no --	营业执照号
    ,rvw_date	--审核日期
    ,acg_dt	    --统计日期
    ,apl_dt	    --申请日期
    ,ROW_NUMBER() OVER(PARTITION BY cst_id ORDER BY rvw_date DESC) RN
from app_rpt.fct_ths_mch_inf_ceshi            --泰惠收商户信息表
where dt='@@{yyyyMMdd}'
and nvl(cst_id,'')''
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241022106_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241022106_CST_05 AS
SELECT  t1.cst_id                    AS 客户号
       ,t1.cst_nm                    AS 客户名称
       ,t1.age                       AS 年龄
       ,t1.m_tel_no                  AS 手机
       ,t1.efe_cst_ind               AS 有效户标识
       ,t1.efe_dep_cst_ind           AS 有效存款户标识
       ,t1.efe_loan_cst_ind          AS 有效贷款户标识
       ,t1.crd_amt                   AS 授信金额
       ,t1.use_crd_bal               AS 用信余额
       ,t1.dep_bal_mon_avg           AS 存款余额月日均
       ,t1.loan_bal_acs_mon_avg      AS 贷款余额月日均
       ,t1.sdt_nbr                   AS 持有存量随贷通卡
       ,t1.is_hld_okv                AS 持有泰惠收产品
       ,t1.sam_rsk_ctrl_id           AS 同一风险控制号
       ,t1.xpos_amt                  AS 同一风险控制号下客户贷款敞口金额
       ,case when nvl(t5.mch_name,'')'' then t5.mch_name else t4.营业执照名称 end as 营业执照名称
       ,t2.main_add                  AS 主地址
       ,t2.sub_cmnt_nm               AS 子社区名称
       ,t2.prm_mgr_nm                AS 主管护机构
       ,t2.org_nm                    AS 主管护人
       ,t3.report_dt                 AS 最新征信报告日期
       ,t3.oth_cred_total_amt        AS 他行授信总额
       ,t3.oth_bank_loan_credit_bal  AS 他行贷款授信余额
       ,t3.oth_bank_credit_total_amt AS 他行授信总余额_不含未激活
       ,t3.oth_bank_loan_org_num     AS 他行贷款授信机构数
       ,t3.oth_bank_busi_org_num     AS 他行授信机构数_不含未激活
       ,t3.oth_bnk_RATE              AS 他行贷款利率
from SJXQ_SJ20241022106_CST_02      t1
left join SJXQ_SJ20241022106_CST_03 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20241022106_CST_04 t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20241022106_CST_04_1 t4
on t1.cst_id=t4.cst_id
left join SJXQ_SJ20241022106_CST_04_2 t5
on t1.cst_id=t5.cst_id AND T5.RN=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241022106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241022106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241022106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241022106_CST_04
union all
SElECT '041' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241022106_CST_04_1
union all
SElECT '042' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241022106_CST_04_2 WHERE RN=1
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241022106_CST_05
;
SElECT '05' seq,
from SJXQ_SJ20241022106_CST_05
;
***SJ2024102226_许巍文_明悦新城客户名单.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_01 AS
SELECT  col_1 --序号
       ,col_2 --合同姓名
       ,col_3 --联系电话
       ,col_4 --合同姓名2
       ,col_5 --联系电话2
from qbi_file_20241029_11_18_03
where pt<>''
;
-- 客户基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_02 AS
SElECT t1.cst_id                            --客户号
	,t1.cst_chn_nm                          --客户中文名称
    ,t1.m_tel_no                            --手机
	,t1.doc_typ_cd                          --证件类型
	,t1.doc_nbr                             --证件号码
    ,t1.reg_adr_dtl_inf                     --户籍地址
    ,t2.prm_mgr_id,t2.prm_mgr_nm,t2.prm_org_id
    ,t3.dep_bal	                            --存款余额
    ,t4.crd_amt	                            --授信金额
    ,t4.use_crd_bal	                        --用信余额
from adm_pub.adm_csm_cbas_idv_bas_inf_dd 	        t1 --对私客户基础信息
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t2 --客户`主管户`信息
on  t1.cst_id = t2.cst_id
and t2.dt = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_dep_inf_dd	        t3 --客户集市-业务信息-客户存款业务信息表
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd	    t4 --客户集市-业务信息-贷款-授信与额度
on  t1.cst_id = t4.cst_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
-- 信贷管户
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_03 AS
SELECT  t1.cst_id
from edw.dim_bus_loan_ctr_bse_inf_dd         t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd   t2 --信贷合同管护信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
group by t1.cst_id
;
-- 结果汇总 合同姓名1+手机1匹配
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_04 AS
SELECT  t1.col_1           --序号
       ,t2.cst_id
from SJXQ_SJ2024102226_CST_01       t1
inner join SJXQ_SJ2024102226_CST_02 t2
on t1.col_2=t2.cst_chn_nm
and t1.col_3=t2.m_tel_no
;
-- 结果汇总 合同姓名1 匹配
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_05 AS
SELECT  t1.col_1           --序号
       ,t2.cst_id
from SJXQ_SJ2024102226_CST_01       t1
inner join SJXQ_SJ2024102226_CST_02 t2
on t1.col_2=t2.cst_chn_nm
left join SJXQ_SJ2024102226_CST_04  t4
on t1.col_1=t4.col_1
where t4.col_1 is null
;
-- 结果汇总 合同姓名2+手机2匹配
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_06 AS
SELECT  t1.col_1           --序号
       ,t2.cst_id
from SJXQ_SJ2024102226_CST_01       t1
inner join SJXQ_SJ2024102226_CST_02 t2
on t1.col_4=t2.cst_chn_nm
and t1.col_5=t2.m_tel_no
;
-- 结果汇总 合同姓名2匹配
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_07 AS
SELECT  t1.col_1           --序号
       ,t2.cst_id
from SJXQ_SJ2024102226_CST_01       t1
inner join SJXQ_SJ2024102226_CST_02 t2
on t1.col_4=t2.cst_chn_nm
left join(
    select col_1 from SJXQ_SJ2024102226_CST_06
)t4 on t1.col_1=t4.col_1
where t4.col_1 is null
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024102226_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102226_CST_08 AS
SELECT  t1.col_1           as 序号
       ,t1.col_2           as 合同姓名
       ,t1.col_3           as 联系电话
       ,t1.col_4           as 合同姓名2
       ,t1.col_5           as 联系电话2
       ,t2.cst_id          as 客户号
       ,t2.is_bnk_phone    as 客户号和手机是否和行里数据一致
       ,t3.cst_chn_nm      as 客户中文名称
       ,t3.doc_typ_cd      as 证件类型
       ,t3.doc_nbr         as 证件号码
       ,t3.reg_adr_dtl_inf as 户籍地址
       ,t3.prm_mgr_id      as 主管户人工号
       ,t3.prm_mgr_nm      as 主管户人
       ,t3.prm_org_id      as 主管户机构号
       ,t3.dep_bal         as 存款余额
       ,t3.crd_amt         as 授信金额
       ,t3.use_crd_bal     as 用信余额
       ,t4.mgr_id          as 信贷管户人工号
       ,t4.mgr_nm          as 信贷管户人姓名
       ,t4.mgr_org_id      as 信贷管户机构号
from SJXQ_SJ2024102226_CST_01       t1
left join(
    select col_1,cst_id,'是' is_bnk_phone from SJXQ_SJ2024102226_CST_04
    union
    select col_1,cst_id,'' from SJXQ_SJ2024102226_CST_05
    union
    select col_1,cst_id,'是' from SJXQ_SJ2024102226_CST_06
    union
    select col_1,cst_id,'' from SJXQ_SJ2024102226_CST_07
)t2 on t1.col_1=t2.col_1
left join SJXQ_SJ2024102226_CST_02  t3
on t2.cst_id=t3.cst_id
left join SJXQ_SJ2024102226_CST_03  t4
on t2.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_1) custs
from SJXQ_SJ2024102226_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102226_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102226_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102226_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102226_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102226_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102226_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ2024102226_CST_08
;
SElECT '08' seq, *
from SJXQ_SJ2024102226_CST_08
order by 序号
***SJ2024102246_泰惠收配贷情况.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024102246_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102246_CST_01 AS
SELECT  col_1  --序号
       ,col_2  --商户号
       ,col_3  --商户简称
       ,col_4  --商户全称
       ,col_5  --商户入驻时间
       ,col_6  --商户状态名称
       ,col_7  --法人_店主姓名
       ,col_8  --法人客户号
       ,col_9  --结算账号
       ,col_10 --结算账号开户日期
from qbi_file_20241023_10_58_49
where pt<>''
;
-- 信贷合同管护信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024102246_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102246_CST_02 AS
select t1.cst_id
    ,sum(t1.ctr_amt) as ctr_amt --合同金额|decimal(21,2)
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd	t2 --信贷合同管护信息
on t1.ctr_serno=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t2.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
group by t1.cst_id
;
-- 贷款金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024102246_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102246_CST_03 AS
SELECT  t1.cst_id
    ,case when nvl(t1.sam_rsk_ctrl_id,'')<>'' then t1.sam_rsk_ctrl_id else t1.cst_id end sam_rsk_ctrl_id
    ,t2.loan_bal_acs         --贷款余额
    ,t2.loan_bal_acs_mon_avg --贷款余额月日均
    ,t4.fst_dtrb_dt
    ,t5.ctr_amt
    ,t5.mgr_id
    ,t5.mgr_nm
    ,t5.sbr_org_nm
    ,t5.tem_org_nm
from edw.dws_cst_bas_inf_dd                 t1 --客户基础信息汇总表
left join adm_pub.adm_csm_cbus_loan_inf_dd  t2 --贷款业务信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join(
    select CST_ID                                   --客户号|C20
        ,min(LVE_ACT_BGN_DT) as fst_dtrb_dt       --出账起始日期|C8
    from edw.dim_bus_loan_dbil_inf_dd             --信贷借据信息
    where dt='@@{yyyyMMdd}'
    group by CST_ID
)t4 on t1.cst_id=t4.cst_id
left join SJXQ_SJ2024102246_CST_02 t5
on t1.cst_id=t5.cst_id
where t1.dt='@@{yyyyMMdd}'
;
-- 同一风险控制号下其他客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024102246_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102246_CST_04 AS
SElECT t1.cst_id
    ,sum(t2.loan_bal_acs        )   as loan_bal_acs         --贷款余额
    ,sum(t2.loan_bal_acs_mon_avg)   as loan_bal_acs_mon_avg --贷款余额月日均
    ,min(t2.fst_dtrb_dt)            as fst_dtrb_dt
from SJXQ_SJ2024102246_CST_03       t1
left join SJXQ_SJ2024102246_CST_03  t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t1.cst_id<>t2.cst_id
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024102246_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102246_CST_05 AS
SELECT  t1.col_1                AS 序号
       ,t1.col_2                AS 商户号
       ,t1.col_3                AS 商户简称
       ,t1.col_4                AS 商户全称
       ,t1.col_5                AS 商户入驻时间
       ,t1.col_6                AS 商户状态名称
       ,t1.col_7                AS 法人_店主姓名
       ,t1.col_8                AS 法人客户号
       ,t1.col_9                AS 结算账号
       ,t1.col_10               AS 结算账号开户日期
       ,t2.ctr_amt              as 法人名下授信金额
       ,t2.loan_bal_acs         AS 法人名下贷款余额
       ,t2.loan_bal_acs_mon_avg AS 法人名下贷款余额月日均
       ,t2.fst_dtrb_dt          AS 法人名下首笔贷款发放时间
       ,t2.sbr_org_nm           AS 信贷业务管护支行
       ,t2.tem_org_nm           AS 信贷业务管护团队
       ,t2.mgr_nm               AS 信贷业务管护客户经理
       ,t2.mgr_id               AS 信贷业务管护客户经理工号
       ,t3.loan_bal_acs         AS 同一风险控制号下其他客户名下贷款余额
       ,t3.loan_bal_acs_mon_avg AS 同一风险控制号下其他客户名下贷款余额月日均
       ,t3.fst_dtrb_dt          AS 同一风险控制号下其他客户名下首笔贷款发放时间
       ,t3.sbr_org_nm           AS 同一风险控制号下其他客户信贷业务管护支行
       ,t3.tem_org_nm           AS 同一风险控制号下其他客户信贷业务管护团队
       ,t3.mgr_nm               AS 同一风险控制号下其他客户信贷业务管护客户经理
       ,t3.mgr_id               AS 同一风险控制号下其他客户信贷业务管护客户经理工号
from SJXQ_SJ2024102246_CST_01       t1
left join SJXQ_SJ2024102246_CST_03  t2 --法人
on t1.col_8=t2.cst_id
left join SJXQ_SJ2024102246_CST_04  t3 --同一风险控制号下其他客户
on t1.col_8=t3.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_8) custs
from SJXQ_SJ2024102246_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102246_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102246_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102246_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 法人客户号) custs
from SJXQ_SJ2024102246_CST_05
;
SElECT '05' seq, *
from SJXQ_SJ2024102246_CST_05
***SJ2024102406_舟山分行信贷客户数据.sql
-- 舟山分行全量信贷客户向下的同一风险控制号客户、配偶、担保人信息
-- 数据需求字段
-- 信贷客户向下的同一风险控制号客户、配偶、担保人信息
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024102406_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102406_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t2.PD_NM
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' )
        AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
        then 1 else 0 end is_not_mtu
    ,t4.sbr_org_nm
    ,t4.brc_org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd       t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t4.brc_org_nm='舟山分行'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 同一风险控制号下客户号、客户名称
DROP   TABLE IF     EXISTS SJXQ_SJ2024102406_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102406_CST_02 AS
select t1.cst_ID,t1.sam_rsk_ctrl_id
from SJXQ_SJ2024102406_CST_01       t1
left join edw.DWS_CST_BAS_INF_DD    t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t2.dt='@@{yyyyMMdd}'
group by t1.cst_ID,t1.sam_rsk_ctrl_id
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ2024102406_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102406_CST_03 AS
SElECT t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
    -- ,t1.rel_typ
    -- ,c1.cd_val_dscr as rel_typ_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '@@{yyyyMMdd}'
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024102406_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102406_CST_04 AS
SElECT t1.cst_id
    -- ,t2.wrnt_cst_id         --保证人客户编号
    -- ,t2.wrnt_cst_nm         --保证人客户名称
    -- ,t2.grnt_psn_seq_nbr    --担保人序号
from SJXQ_SJ2024102406_CST_01           t1
inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
ON  t1.ctr_serno=t2.bus_ctr_id           --业务合同编号
and t2.dt = '@@{yyyyMMdd}'
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024102406_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102406_CST_05 AS
SELECT  t1.brc_org_nm    AS 信贷管户分行
        ,t1.sbr_org_nm   AS 信贷管户支行
        ,t1.cst_id       AS 客户号
        ,t1.cst_nm       AS 客户名称
        ,t2.同一风险控制号下客户
        ,t3.配偶
        ,t4.wrnt_cst_nms AS 担保人
from(
        ,cst_id                        --客户号|C20
        ,cst_nm                        --客户名称|C200
    from SJXQ_SJ2024102406_CST_01
    GROUP BY  cst_id,cst_nm
)t1 left join SJXQ_SJ2024102406_CST_02 t2
on t1.cst_ID=t2.cst_id
left join(
    select cst_id
    from SJXQ_SJ2024102406_CST_03
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024102406_CST_04 t4
on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102406_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102406_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102406_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024102406_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024102406_CST_05
;
SElECT '05' seq, *
from SJXQ_SJ2024102406_CST_05
;
***SJ2024102516_台州分行担保数据.sql
-- 截止2024年10月24日，台州分行客户担保分类清单，业务风险等级分类清单。
-- 合同表
DROP   TABLE IF     EXISTS SJXQ_SJ2024102516_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102516_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t2.PD_NM
    ,t2.PRM_BUS_BRED_CTG	--主业务品种分类_业务类型
    ,c2.cd_val_dscr as PRM_BUS_BRED_CTG_nm
    ,case when ( ( t1.CTR_STS_CD IN ( '2' , '4' )
        AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
        then 1 else 0 end is_not_mtu
    ,t1.hdl_opr_id	    --经办人工号
    ,t7.empe_nm     as hdl_opr_nm
    ,t1.hdl_org_id      --经办机构编号
    ,t6.org_nm      as hdl_org_nm
    ,case when t1.hpn_typ_cd='010' THEN '是'  ELSE '否' END	as 首贷标识 --发生类型代码|c6
    ,t1.bsn_mark_cd
    ,c1.cd_val_dscr     as bsn_mark_nm             --业务标识
    ,t1.GRNT_MOD_COLC	--担保方式集合
    ,decode(t1.GRNT_MOD_COLC,'005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池','') as GRNT_MOD_COLC_nm --担保方式
    ,t1.prcp_setl_dt                             --本金结清日期|c8
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd       t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241024'
and t2.PD_NM not regexp '信用卡'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20241024'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20241024'
left join edw.DWS_CST_BAS_INF_DD           t5
on t1.cst_id=t5.cst_id
and t5.dt='20241024'
left join edw.dim_hr_org_mng_org_tree_dd   t6 --考核机构树
on  t1.hdl_org_id = t6.org_id
and t6.dt = '20241024'
left join edw.dws_hr_empe_inf_dd            t7 --员工信息汇总
on  t1.hdl_opr_id=t7.empe_id
and t7.dt='20241024'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '20241024'
left join edw.dwd_code_library_dd           c2
on t2.PRM_BUS_BRED_CTG = c2.cd_val
and c2.dt = '20241024'
where t1.dt='20241024'
and t4.brc_org_nm='台州分行'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 借据 主表
DROP   TABLE IF     EXISTS SJXQ_SJ2024102516_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102516_CST_02 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
	,t1.grant_amt                                --发放金额
	,t1.grant_date                               --发放日期
	,t1.vouch_type                               --担保分类
	,t1.hpn_rsk_date                             --出险日期
	,t1.is_rsk_loan                              --是否风险贷款
	,t1.opr_empe_id                              --经办客户经理
	,t1.opr_org_id                               --经办机构号
from adm_rsk.adm_rsk_apl_inter_all      t1 --风险集市应用表-资产质量日常监测源表
inner join SJXQ_SJ2024102516_CST_01     t2
on t1.ctr_srl_no=t2.ctr_serno
where t1.dt='20241024'
;
-- 余额月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024102516_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102516_CST_03 AS
SElECT t1.ctr_serno
    ,round(sum(t1.ctr_bal)/count(distinct t1.dt),2)                 as loan_bal_year_avg
    ,sum(case when t1.dt>='20241001' then t1.ctr_bal else 0 end)    as curr_mon_loan_bal
    ,sum(case when t1.dt>='20241001' then 1 else 0 end)             as curr_mon_days
from edw.dim_bus_loan_ctr_bse_inf_dd    t1
inner join SJXQ_SJ2024102516_CST_01     t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt<='20241024'
and t1.dt>='20240101'
group by t1.ctr_serno
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024102516_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024102516_CST_04 AS
SELECT  t1.ctr_serno        AS 合同流水号
       ,t1.rel_serno        AS 用信申请流水号
       ,t1.cst_id           AS 客户号
       ,t1.cst_nm           AS 客户姓名
       ,t1.sam_rsk_ctrl_id  AS 同一风险控制号
       ,t1.mgr_org_id       AS 管户机构号
       ,t1.org_nm           AS 管户机构
       ,t1.mgr_id           AS 管户人工号
       ,t1.mgr_nm           AS 管户人姓名
       ,t1.hdl_org_nm       AS 经办机构
       ,t1.hdl_opr_id       AS 经办人工号
       ,t1.hdl_opr_nm       AS 经办人
       ,t1.SYS_REG_DT       AS 系统登记日期_经办日期
       ,t1.ctr_bgn_dt       AS 合同起始日期
       ,t1.ctr_mtu_dt       AS 合同到期日期
       ,t1.ctr_amt          AS 合同金额
       ,t1.ctr_bal          AS 合同余额
       ,t1.首贷标识
       ,t1.PD_NM            as 产品名称
       ,t4.bind_lmt	        as 	随贷通绑定额度
        ,round(t3.curr_mon_loan_bal/t3.curr_mon_days,2)     as 本月本金余额月日均
        ,t3.loan_bal_year_avg as 本年本金余额年日均
        ,case when t2.ctr_srl_no is not null then '是' else '否' end as 是否用过信
       ,t1.exec_intr_rat    AS 执行利率
       ,t1.PRM_BUS_BRED_CTG_nm       AS 主业务品种分类_业务类型
       ,t1.bsn_mark_nm      AS 业务标识
       ,t1.GRNT_MOD_COLC_nm AS 担保方式集合
       ,t2.担保分类
       ,t2.是否风险贷款
       ,t2.首次出险日期
       ,t1.prcp_setl_dt      AS 本金结清日期
       ,case when t1.prcp_setl_dt='18991231' then ''
            when t1.prcp_setl_dt<='20241024' then '是'
            else '否' end as 本金结清标识
from SJXQ_SJ2024102516_CST_01 t1
left join(
    SELECT  ctr_srl_no
        ,MIN(hpn_rsk_date)                        AS 首次出险日期
    from SJXQ_SJ2024102516_CST_02
    group by ctr_srl_no
)t2 on t1.ctr_serno=t2.ctr_srl_no
left join SJXQ_SJ2024102516_CST_03 t3
on t1.ctr_serno=t3.ctr_serno
left join edw.dwd_bus_loan_fnc_crd_lmt_inf_dd t4 --随贷通授信额度信息
on t1.ctr_serno=t4.bus_ctr_id
and t4.dt='20241024'
and t4.lmt_sts_cd IN ( '0' , '3' ) --'0','正常','3','未激活'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024102516_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ2024102516_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024102516_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024102516_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024102516_CST_04
where 是否用过信='是'
***SJ20241028106_吴奇_杭州大额日均.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241028106_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241028106_CST_01 AS
SELECT  t1.col_1  --序号
       ,t1.col_2  --管户机构号
       ,t1.col_3  --分行
       ,t1.col_4  --支行
       ,t1.col_5  --同一风险控制号
       ,t1.col_6  --同一风险控制号余额万元
       ,t1.col_7  --区间
       ,t1.col_8  --是否上会
       ,t1.col_9  --客户名称
       ,t1.col_10 --核心客户编号
       ,case when nvl(t2.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end sam_rsk_ctrl_id
       ,case when t1.col_5=t2.SAM_RSK_CTRL_ID then 1 else 0 end is_equal_sam_rsk
from qbi_file_20241029_11_07_19     t1
left join edw.DWS_CST_BAS_INF_DD    t2
on t1.col_10=t2.cst_id
and t2.dt='20241028'
where t1.pt<>''
;
-- 同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ20241028106_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241028106_CST_02 AS
SElECT t1.sam_rsk_ctrl_id
    ,sum(nvl(t3.gl_bal_6m_avg,0))   as gl_bal_6m_avg
    ,sum(nvl(t3.gl_bal_year_avg,0)) as gl_bal_year_avg
    ,sum(nvl(t3.gl_bal_6m_avg_del_insamt,0))   as gl_bal_6m_avg_del_insamt
    ,sum(nvl(t3.gl_bal_year_avg_del_insamt,0)) as gl_bal_year_avg_del_insamt
from (
    SElECT sam_rsk_ctrl_id
    from SJXQ_SJ20241028106_CST_01
)t1 left join edw.DWS_CST_BAS_INF_DD t2
on t1.sam_rsk_ctrl_id = case when nvl(t2.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end
and t2.dt='20241028'
left join(
    SELECT  t1.cst_id
            ,SUM(t1.last_180_days_gl_bal_acml) / 180 AS gl_bal_6m_avg
            ,SUM(t1.last_360_days_gl_bal_acml) / 360 AS gl_bal_year_avg
            ,SUM(case when D1.cd_val_dscr NOT LIKE '%保证金%' and D2.cd_val_dscr NOT LIKE '%保证金%'
                then t1.last_180_days_gl_bal_acml else 0 end) / 180 AS gl_bal_6m_avg_del_insamt
            ,SUM(case when D1.cd_val_dscr NOT LIKE '%保证金%' and D2.cd_val_dscr NOT LIKE '%保证金%'
                then t1.last_360_days_gl_bal_acml else 0 end) / 360 AS gl_bal_year_avg_del_insamt
    FROM    edw.dws_bus_dep_act_inf_dd      t1 --存款账户信息汇总
    LEFT JOIN    edw.dwd_code_library_dd    D1 --账户分类代码1
    ON      T1.act_ctg_cd_1 = D1.cd_val
    AND     D1.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
    AND     D1.fld_nm = 'ACT_CTG_CD_1'
    AND     D1.dt = '@@{yyyyMMdd}'
    LEFT JOIN    edw.dwd_code_library_dd    D2 --账户分类代码2
    ON      T1.act_ctg_cd_2 = D2.cd_val
    AND     D2.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
    AND     D2.fld_nm = 'ACT_CTG_CD_2'
    AND     D2.dt = '@@{yyyyMMdd}'
    WHERE   T1.DT = '20241028'
    -- AND     T1.STL_ACT_IND = '1'        --结算账户
    -- AND     T1.BAL_GL_IND <> '0'        --剔除虚户
    -- AND     T1.act_sts_cd='A'           --剔除账户状态为销户、不动户、营业外收入
    -- AND     D1.cd_val_dscr NOT LIKE '%保证金%' --账户分类代码1
    -- AND     D2.cd_val_dscr NOT LIKE '%保证金%' --账户分类代码2
    GROUP BY cst_id
)t3 on t2.cst_id=t3.cst_id
left join(
    select cst_id
        ,slf_ast_lbl_rat	--本人资产负债率
        ,ast_lbl_rat	    --资产负债率
        ,row_number() over(partition by cst_id order by rcd_tm desc) rn
    from edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd --信贷客户资产负债概况
    where dt='20241028'
)t4 on t2.cst_id=t4.cst_id
and t4.rn=1
group by t1.sam_rsk_ctrl_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241028106_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241028106_CST_03_1 AS
SElECT t1.sam_rsk_ctrl_id
    ,t2.cst_id
    ,t3.ctr_serno
    -- ,decode(t1.GRNT_MOD_COLC,'005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池','') as GRNT_MOD_COLC_nm --担保方式
    ,case when t3.GRNT_MOD_COLC regexp '020' then '是' else '否' end   as is_diya
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by t3.ctr_bgn_dt desc) rn
from (
    SElECT sam_rsk_ctrl_id
    from SJXQ_SJ20241028106_CST_01
)t1 inner join edw.DWS_CST_BAS_INF_DD       t2
on t1.sam_rsk_ctrl_id = case when nvl(t2.SAM_RSK_CTRL_ID,'')='' then t2.cst_id else t2.sam_rsk_ctrl_id end
and t2.dt='20241028'
inner join edw.dim_bus_loan_ctr_bse_inf_dd  t3 --合同基础信息
on t2.cst_id=t3.cst_id
and t3.dt='20241028'
inner join edw.dim_bus_loan_prd_frml_dd     t4
on t3.prd_no=t4.prd_no
and t4.dt='20241028'
and t4.PD_NM not regexp '信用卡'
;
-- 同一风险控制号下最新一笔业务
DROP   TABLE IF     EXISTS SJXQ_SJ20241028106_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241028106_CST_03 AS
select t1.sam_rsk_ctrl_id,t1.is_diya
    ,sum(case when t1.is_diya='是' then nvl(t3.afm_val,0) else 0 end)     as afm_val
from SJXQ_SJ20241028106_CST_03_1 t1
inner join(
    SElECT distinct CTR_SERNO,GRNT_CTR_NO
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '20241028'
    and grnt_gds_typ_cd=2	--	担保物类型代码|c1|1 保证人 2 押品
) t2 on t1.CTR_SERNO = t2.CTR_SERNO
inner join (
    SElECT GRNT_CTR_NO,sum(nvl(afm_val,0))     as afm_val	--认定价值
    from edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD --担保合同抵质押信息
    where dt='20241028'
    group by GRNT_CTR_NO
) t3 on t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
where t1.rn=1
group by t1.sam_rsk_ctrl_id,t1.is_diya
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241028106_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241028106_CST_04 AS
SELECT  t1.col_1           AS 序号
       ,t1.col_2           AS 管户机构号
       ,t1.col_3           AS 分行
       ,t1.col_4           AS 支行
       ,t1.col_5           AS 同一风险控制号
       ,t1.col_6           AS 同一风险控制号余额万元
       ,t1.col_7           AS 区间
       ,t1.col_8           AS 是否上会
       ,t1.col_9           AS 客户名称
       ,t1.col_10          AS 核心客户编号
       ,t2.gl_bal_6m_avg   AS 同一风险控制号下近6月存款日均
       ,t2.gl_bal_year_avg AS 同一风险控制号下近1年存款日均
       ,t2.gl_bal_6m_avg_del_insamt   AS 同一风险控制号下近6月存款日均_剔除保证金
       ,t2.gl_bal_year_avg_del_insamt AS 同一风险控制号下近1年存款日均_剔除保证金
       ,t2.slf_ast_lbl_rat AS 同一风险控制号下客户本人资产负债率
       ,t2.ast_lbl_rat     AS 同一风险控制号下资产负债率
       ,t3.is_diya         AS 同一风险控制号下最新一笔业务是否抵押
       ,t3.afm_val         AS 同一风险控制号下最新一笔业务抵押物价值
from SJXQ_SJ20241028106_CST_01      t1
left join SJXQ_SJ20241028106_CST_02 t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
left join SJXQ_SJ20241028106_CST_03 t3
on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct col_10) custs
from SJXQ_SJ20241028106_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ20241028106_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ20241028106_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 序号) custs
from SJXQ_SJ20241028106_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ20241028106_CST_04
order by 序号
***SJ2024103096_栾成_良渚中征分.sql
-- 客群 客户号重复较多
DROP   TABLE IF EXISTS SJXQ_SJ2024103096_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024103096_CST_01
(
    seq         string
    ,cst_id     string
)
;
insert into SJXQ_SJ2024103096_CST_01
values
;
-- 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024103096_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024103096_CST_02 AS
SELECT  cst_id
    ,prd_dt
    ,cst_cr_grd_val
    ,scor_rng
    ,ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY prd_dt DESC) AS rn
FROM (
    SELECT  cst_id
        ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyyMMdd') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
        ,scor_rng	--	分数区间
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20241030'
    UNION
    SELECT  cst_id
        ,to_date(prd_dt,'yyyyMMdd') AS prd_dt
        ,cst_cr_grd_val
        ,scor_rng	--	分数区间
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20241030'
)t
;
-- 输出结果1 sheet1
DROP   TABLE IF     EXISTS SJXQ_SJ2024103096_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024103096_CST_03 AS
SELECT  t1.seq            AS 序号
       ,t1.cst_id         AS 客户号
       ,t4.lgp_cst_id     AS 对公客户法人客户号
       ,t4.lgp_nm         AS 对公客户法人客户名称
       ,t2.scor_rng       AS 对私客户最新中征分分数区间
       ,t5.scor_rng       AS 对公客户法定代表人最新中征分分数区间
from SJXQ_SJ2024103096_CST_01      t1
left join SJXQ_SJ2024103096_CST_02 t2
on t1.cst_id = t2.cst_id
and t2.rn=1
left join edw.dim_cst_entp_lgp_inf_dd   t4           --对公客户法人信息表
on t1.cst_id = t4.cst_id
and t4.dt='20241030'
left join SJXQ_SJ2024103096_CST_02     t5
on t4.lgp_cst_id = t5.cst_id
and t5.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024103096_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024103096_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024103096_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ2024103096_CST_03
***SJ2024110716_郑建俊_衢州分行押品价值评估.sql
﻿-- 衢州分行担保合同押品清单
DROP   TABLE IF     EXISTS SJXQ_SJ2024110716_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110716_CST_01 as
SELECT distinct t1.cst_id,t5.grnt_gds_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1
INNER JOIN edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
INNER JOIN edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
INNER JOIN edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
INNER JOIN(
    SElECT distinct CTR_SERNO,grnt_gds_id	    --	担保物编号
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '@@{yyyyMMdd}'
    and grnt_gds_typ_cd='2'     --押品
) t5 on t1.CTR_SERNO = t5.CTR_SERNO
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
and t2.PD_NM not regexp '信用卡'
and t4.brc_org_nm='衢州分行'
;
-- 押品基本信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024110716_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110716_CST_02 as
SELECT  cltr_no                  --押品编号|c32
       ,cltr_nm                  --押品名称|c200
       ,mort_pldg_gds_sts_cd     --抵质押物状态代码|c2
       ,cltr_chk_dt              --押品核验日期|c8
       ,at_oth_bnk_mort_pldg_ind --他行有抵质押标志|c1
       ,our_bnk_psit_cd          --我行顺位代码|c1
       ,oth_bnk_mort_pldg_cnt    --他行抵质押笔数|int10
       ,oth_bnk_mort_pldg_amt    --他行抵质押金额|decimal(21,2)
       ,mort_pldg_gds_situ       --抵质押物情况|c2
       ,sys_reg_tm               --系统登记时间|c20
FROM edw.dim_bus_loan_cltr_bas_inf_dd --押品基本信息
WHERE dt = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024110716_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110716_CST_03 as
select guarantyid                             --押品编号
	,firstbeneficiaryname                     --第一债权人名称
from edw.loan_guaranty_survey                 --押品贷前调查信息
where dt='20240719'
and nvl(firstbeneficiaryname,'')<>''
;
-- 押品价值评估
DROP   TABLE IF     EXISTS SJXQ_SJ2024110716_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110716_CST_04 as
select val_ases_serno                         --价值评估流水号|c32
    ,cltr_no                                  --押品编号|c32
    ,ases_val                                 --评估价值|decimal(21, 2 )
    ,afm_val                                  --认定价值|decimal(21, 2 )
    ,incl_mortd_amt_ind                       --包含已抵金额标志|c1
    ,cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal(21, 2 )
    ,mort_pldg_rat                            --抵质押率|decimal(10, 6 )
    ,ases_bss_dt                              --评估基准日期|c8
    ,eff_ind    --生效标识
    ,last_upd_tm
    ,row_number() over(partition by cltr_no order by eff_ind desc,last_upd_tm desc) rn
from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd  --押品价值评估申请信息表
where dt = '@@{yyyyMMdd}'
-- and eff_ind='1'     --1:是 0:否
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024110716_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110716_CST_05 as
SELECT  t1.cst_id                   AS 客户号
       ,t1.grnt_gds_id              AS 押品编号
       ,t4.val_ases_serno           AS 价值评估流水号
    --    ,t4.eff_ind    as 生效标识
       ,t4.ases_bss_dt              AS 评估基准日期
       ,t4.ases_val                 AS 评估价值
       ,t4.afm_val                  AS 认定价值
       ,t4.incl_mortd_amt_ind       AS 包含已抵金额标志
       ,t3.firstbeneficiaryname     AS 第一债权人名称_20240719数据
       ,t2.at_oth_bnk_mort_pldg_ind AS 他行有抵质押标志
       ,t2.our_bnk_psit_cd          AS 我行顺位代码
       ,t2.oth_bnk_mort_pldg_cnt    AS 他行抵质押笔数
       ,t2.oth_bnk_mort_pldg_amt    AS 他行抵质押金额
from SJXQ_SJ2024110716_CST_01       t1
left join SJXQ_SJ2024110716_CST_02  t2
on t1.grnt_gds_id=t2.cltr_no
left join SJXQ_SJ2024110716_CST_03  t3
on t1.grnt_gds_id=t3.guarantyid
left JOIN SJXQ_SJ2024110716_CST_04  t4
ON t1.grnt_gds_id = t4.cltr_no     --押品编号
and t4.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024110716_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ2024110716_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct guarantyid) custs
from SJXQ_SJ2024110716_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ2024110716_CST_04 WHERE rn=1
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号,押品编号) custs
from SJXQ_SJ2024110716_CST_05
;
SElECT '05' seq, *
from SJXQ_SJ2024110716_CST_05
;
***SJ2024110776_陶琨炜_杭州分行客户征信.sql
﻿--信贷客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241231_CST_01 AS
select distinct t1.cst_id                                   --客户号|C20
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on  t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on  t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t4.brc_org_nm='杭州分行'
;
-- 征信指标信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241231_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241231_CST_02 AS
select t1.report_dt                              --报告日期
	,t1.report_no                                --报告编号
	,t1.cst_id                                   --客户号
	,t1.cred_total_amt                           --授信总额（信用总额）
	,t1.cred_total_balan                         --授信余额（信用总余额）
	-- ,t1.late_mon_enqu_count                      --最近一个月内的查询次数
	-- ,t1.late_year_enqu_count                     --最近一年内的查询次数
	-- ,t1.c_od_amt                                 --当前逾期总额
	-- ,t1.un_settl_loan_num                        --未结清贷款笔数
	-- ,t1.loan_total_amt                           --贷款总授信额度
	-- ,t1.loan_total_balan                         --贷款总余额
	-- ,t1.cds                                      --当前逾期
	-- ,t1.loan_his_od_num                          --历史逾期期数
	-- ,t1.late_year_loan_count                     --最近12个月贷款审核查询记录
	-- ,t1.late_year_guan_count                     --最近12个月担保资格查询记录
	-- ,t1.late_year_card_count                     --最近12个月信用卡审批查询记录
	-- ,t1.oth_cred_total_amt                       --他行授信总额
	-- ,t1.idv_crd_sco_val                          --个人信用评分分值|DECIMAL(4,0)
from   edw.dws_cst_ccrc_idv_ind_inf_dd  t1      --个人征信指标信息表
inner join SJXQ_SJ20241231_CST_01       t2
on t1.cst_id=t2.cst_id
where  t1.dt = '@@{yyyyMMdd}'
and    t1.report_dsc_rn = 1
union all
select t1.report_dt                              --报告日期
	,t1.report_no                                --报告编号
	,t1.cst_id                                   --客户号
	,t1.cred_total_amt                           --信用总发生额
	,t1.cred_total_balan                         --信用总余额
from   edw.dws_cst_ccrc_entp_ind_inf_dd t1
inner join SJXQ_SJ20241231_CST_01       t2
on t1.cst_id=t2.cst_id
where  t1.dt = '@@{yyyyMMdd}'
and    t1.report_dsc_rn = 1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241231_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241231_CST_03 AS
SELECT  t1.cst_id    AS 客户号
    ,t1.report_no
       ,t1.report_dt AS 最新征信报告日期
       ,t2.小贷公司授信金额
       ,t2.小贷公司贷款余额
       ,t2.有余额小贷公司数
from SJXQ_SJ20241231_CST_02  t1 -- 征信指标
---- 小额贷款融资家数、融资金额 （含消费金融公司、小贷公司、信托公司贷款）
INNER JOIN
( --2024100222424250187044 该征信报告有余额 授信金额未获取到
      select cst_id
            ,report_id
            ,count(distinct dtrb_org)  贷款融资家数
            ,sum(ctr_bal)              贷款融资余额
      from   edw.dim_cst_ccrc_idv_loan_inf_dd
      where  dt = '@@{yyyyMMdd}'
      and    act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) --贷款
      -- and    (ctr_bal > 0 OR rmn_rpay_trm > 0 )  ---- 未结清
      group by cst_id ,report_id
      union all
      select cst_id
            ,report_id
            ,count(distinct dtrb_org_cd)  贷款融资家数
            ,sum(loan_bal)                贷款融资余额
      from   edw.dim_cst_ccrc_entp_loan_inf_dd
      where  dt = '@@{yyyyMMdd}'
      and    act_typ IN ( 'D1' , 'R1' , 'R4' ) --贷款
      -- and    (ctr_bal > 0 OR rmn_rpay_trm > 0 )  ---- 未结清
      group by cst_id ,report_id
)t2 on t1.cst_id = t2.cst_id
and t1.report_no = t2.report_id
and (t2.小贷公司授信金额>=50000 or 小贷公司贷款余额>0)
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241231_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241231_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241231_CST_03
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20241231_CST_03
***SJ2024110851_全行信贷合同信息.sql
DROP   TABLE IF     EXISTS SJXQ_SJ2024110851_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110851_CST_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.bsn_mark_cd
    ,CASE WHEN NVL(T1.bsn_mark_cd,'') = '04' THEN '是' ELSE '否' END is_chongzu
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.onbs_ovd_intr_bal	                    --表内欠息余额DECIMAL(21,2)
    ,t1.ofbs_ovd_intr_bal	                    --表外欠息余额DECIMAL(21,2)
    ,t1.ovd_intr_dt	                            --欠息日期|C8
    ,t1.ref_intr_rat	                        --参考利率DECIMAL(13,2)
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
and t2.PD_NM not regexp '信用卡'
where t1.dt='20240930'
and t2.prd_no is not null
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
-- AND     t1.TMT_DT = '18991231'
--     OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024110851_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024110851_CST_02 AS
SELECT  t1.ctr_serno       AS 合同号
       ,t1.ctr_bal         AS 合同余额
       ,t2.grnt_ctr_no     AS 担保合同编号
       ,t2.grnt_amt        AS 担保金额
       ,t2.grnt_gds_typ_cd AS 担保物类型代码 --保证人 2 押品
       ,t3.ases_val        AS 最新评估价值
from SJXQ_SJ2024110851_CST_01 t1
left join(
    SElECT distinct CTR_SERNO
        ,grnt_ctr_no	    --	担保合同编号|c32
        ,grnt_gds_id	    --	担保物编号
        ,grnt_gds_nm	    --	担保物名称
        ,grnt_amt	        --	担保金额
        ,grnt_gds_typ_cd	--	担保物类型代码--保证人 2 押品
    from edw.DWD_BUS_LOAN_CTR_GRNT_CTR_GRNT_REL_DD --主合同、担保合同、担保物关系
    where dt = '20240930'
) t2 on t1.CTR_SERNO = t2.CTR_SERNO
left JOIN (
    select cltr_no,ases_val,mort_pldg_rat
        ,row_number() over(partition by cltr_no order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd  --押品价值评估申请信息表
    where dt = '20240930'
) t3 ON t2.grnt_gds_id = t3.cltr_no     --押品编号
and t3.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024110851_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同号,担保合同编号) custs
from SJXQ_SJ2024110851_CST_02
***SJ2024111111_王雯_百年好合卡产效.sql
﻿--截止2024年10月底，衢州分行百年好合卡发卡客户的产效情况（存款、贷款、理财、aum）。
--注：百年好合卡分为定制卡面款、通用卡面款两种
/*
客户号	客户姓名	卡片类型	卡号	发卡时间	经办人	经办团队	经办支行    产效情况（存款、贷款、理财、aum）月日均
1. 持有信用卡？ 是否持有信用卡？账号持有数
2. 财富-理财保险基金贵金属 取 余额？还是月日均？ 均取
*/
-- 衢州分行百年好合卡发卡客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024111111_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111111_CST_01 as
SELECT  t1.cst_id               --客户编号|C20
    ,t1.cst_nm                  --客户名称|C200
    ,t1.busi_ctr_id             --业务合同编号|C32
    ,t1.isu_dt                  --发卡日期|C8
    ,t1.cr_crd_card_nbr
    ,t1.cr_crd_pd_id
    ,t2.crd_no
    -- ,t4.cr_crd_mgr_nm	        --信用卡业务管户人
    -- ,t4.cr_crd_org_nm	        --信用卡业务管户机构
    -- ,t4.cr_crd_sbr_org_nm	    --信用卡业务管户支行名称
    ,t4.cr_crd_brc_org_nm       --信用卡业务管户分行名称
    ,case when t1.cr_crd_pd_id = '0054' then '定制版'
        when t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12' then '通用版'
        else '' end  as card_type
FROM edw.dim_bus_crd_cr_crd_inf_dd  t1 --信用卡卡片信息
INNER JOIN    edw.loan_ctr_crd_face t2
ON      t1.cr_crd_card_nbr = t2.crd_no
AND     t2.dt = '@@{yyyyMMdd}'
INNER JOIN
(
	SELECT  DISTINCT cst_id,cr_crd_brc_org_nm
    from app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd
	WHERE dt = '20241031'
	AND cr_crd_brc_org_nm = '衢州分行'
)T4 ON T1.cst_id = T4.cst_id
WHERE t1.dt = '20241031'
and (t1.cr_crd_pd_id = '0054' --百年好合卡定制卡
    OR (t1.cr_crd_pd_id = '0053' AND t2.crd_face_stl = 'TA12') --百年好合卡通用版
)
;
-- 信用卡 经办人	经办团队	经办支行
DROP   TABLE IF     EXISTS SJXQ_SJ2024111111_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111111_CST_02 as
SElECT t1.busi_ctr_id
    ,t2.hdl_org_id	    --经办机构编号|c10
    ,t2.hdl_opr_id	    --经办人工号|c12
    ,t3.empe_nm     as hdl_opr_nm
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
from SJXQ_SJ2024111111_CST_01               t1
left join EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD   t2 --合同基础信息
on t1.busi_ctr_id=t2.ctr_serno
and t2.dt='20241031'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  t2.hdl_opr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd        t4 --考核机构树
on  t2.hdl_org_id=t4.org_id
and t4.dt='@@{yyyyMMdd}'
;
-- 当前是否为有效户 存款	贷款	信用卡	财富
DROP   TABLE IF     EXISTS SJXQ_SJ2024111111_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111111_CST_03 as
SElECT t1.cst_id
	,t2.efe_dep_cst_ind         --有效存款户标识
	,t2.efe_loan_cst_ind        --有效信贷户标识
	,t2.efe_wlth_cst_ind        --有效财富户标识
    ,t3.cr_crd_vld_cst_ind	    --信用卡有效户标识:0否1是
from SJXQ_SJ2024111111_CST_01                   t1
left join adm_pub.adm_csm_cbas_ind_inf_dd 		t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='20241031'
left join adm_pub.adm_csm_clab_cr_crd_bas_lab_inf_dd    t3 --客户集市-客户标签信息-信用卡-基本标签信息
on t1.cst_id=t3.cst_id
and t3.dt='20241031'
;
-- 理财	保险	基金	贵金属
DROP   TABLE IF     EXISTS SJXQ_SJ2024111111_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111111_CST_04 as
SELECT  t1.cst_id           --客户编号
    ,t2.xyk_act_cnt     --信用卡账号数
    ,t2.xyk_bal         --信用卡余额
    ,case when nvl(t3.sam_rsk_ctrl_id,'')<>'' then t3.sam_rsk_ctrl_id else t1.cst_id end sam_rsk_ctrl_id    --同一风险控制号
    ,t4.fnc_amt          --理财金额
    ,t4.fnc_mon_avg_amt  --理财金额月日均
    ,t4.insu_amt         --保险保费
    ,t4.insu_mon_avg_amt --保险保费月日均
    ,t4.fund_amt         --基金金额
    ,t4.fund_mon_avg_amt --基金金额月日均
    ,t4.gold_amt         --贵金属近一年金额
    ,t4.gold_mon_avg_amt --贵金属金额月日均
    ,t5.dep_bal          --存款余额
    ,t5.dep_bal_mon_avg  --存款余额月日均
    ,t6.综合授信          --授信金额
    ,t6.贷款余额          --用信余额
    ,t6.贷款合同金额
    ,t6.贷款合同余额
    ,t6.信用卡合同金额
    ,t6.信用卡合同余额
from SJXQ_SJ2024111111_CST_03                       t1
left join(
    SElECT cst_id
        ,count(distinct cr_crd_act_id)  as xyk_act_cnt
        ,sum(bal)                       as xyk_bal --信用卡余额
    from app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd	--信用卡账户信息汇总表
    where dt='20241031'
    group by cst_id
)t2 on  t1.cst_id=t2.cst_id
left join edw.dws_cst_bas_inf_dd 				    t3 --客户基础信息汇总表
on  t1.cst_id=t3.cst_id
and t3.dt='20241031'
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t4 --客户金融资产信息表
on  t1.cst_id=t4.cst_id
and t4.dt='20241031'
left join adm_pub.adm_csm_cbus_dep_inf_dd 	        t5 --存款业务信息表
on  t1.cst_id=t5.cst_id
and t5.dt='20241031'
left join(
    select cst_id
    ,sum(nvl(ctr_amt,0)) as 综合授信
    ,sum(nvl(ctr_bal,0)) as 贷款余额
    ,SUM(CASE WHEN t1.PRD_NO NOT IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_amt ELSE 0 END) AS 贷款合同金额
    ,SUM(CASE WHEN t1.PRD_NO NOT IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_bal ELSE 0 END) AS 贷款合同余额
    ,SUM(CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_amt ELSE 0 END)     AS 信用卡合同金额
    ,SUM(CASE WHEN t1.PRD_NO IN ( '2002010101001' ,'2002010101901' ) THEN t1.ctr_bal ELSE 0 END)     AS 信用卡合同余额
    from edw.dim_bus_loan_ctr_bse_inf_dd    t1
    -- left join edw.dim_bus_loan_prd_frml_dd  t2
    -- on t1.prd_no=t2.prd_no
    -- and t2.dt='20241031'
    -- and t2.PD_NM not regexp '信用卡'
    where t1.dt='20241031'
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
    group by cst_id
)t6 on t1.cst_id=t6.cst_id
;
-- 同一风险控制号下全部客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024111111_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111111_CST_05 as
SELECT  sam_rsk_ctrl_id
       ,SUM(nvl(dep_bal,0))          AS 存款余额
       ,SUM(nvl(dep_bal_mon_avg,0))  AS 存款余额月日均
       ,SUM(nvl(贷款合同金额,0))      AS 贷款合同授信金额
       ,SUM(nvl(贷款合同余额,0))      AS 贷款合同用信余额
       ,SUM(nvl(xyk_act_cnt,0))      AS 信用卡账号数
       ,SUM(nvl(xyk_bal,0))          AS 信用卡余额
       ,SUM(nvl(fnc_amt,0))          AS 理财金额
       ,SUM(nvl(fnc_mon_avg_amt,0))  AS 理财金额月日均
       ,SUM(nvl(insu_amt,0))         AS 保险保费
       ,SUM(nvl(insu_mon_avg_amt,0)) AS 保险保费月日均
       ,SUM(nvl(fund_amt,0))         AS 基金金额
       ,SUM(nvl(fund_mon_avg_amt,0)) AS 基金金额月日均
       ,SUM(nvl(gold_amt,0))         AS 贵金属近一年金额
       ,SUM(nvl(gold_mon_avg_amt,0)) AS 贵金属金额月日均
from SJXQ_SJ2024111111_CST_04
group by sam_rsk_ctrl_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024111111_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111111_CST_06 as
SELECT  t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.card_type          AS 卡片类型
       ,t1.cr_crd_card_nbr    AS 卡号
       ,t1.isu_dt             AS 发卡日期
    ,coalesce(t5.hdl_opr_nm,t5.hdl_opr_id) as 信用卡经办人
    ,t5.brc_org_nm as 信用卡经办分行
    ,t5.sbr_org_nm as 信用卡经办支行
    ,t5.tem_org_nm as 信用卡经办团队
       ,t1.cr_crd_brc_org_nm  AS 信用卡业务管户分行
       ,t2.efe_dep_cst_ind    AS 有效存款户标识
       ,t2.efe_loan_cst_ind   AS 有效信贷户标识
       ,t2.cr_crd_vld_cst_ind AS 信用卡有效户标识
       ,t2.efe_wlth_cst_ind   AS 有效财富户标识
       ,t3.dep_bal            AS 单客户_存款余额
       ,t3.dep_bal_mon_avg    AS 单客户_存款余额月日均
       ,t3.贷款合同金额        AS 单客户_贷款合同授信金额
       ,t3.贷款合同余额        AS 单客户_贷款合同用信余额
       ,t3.xyk_act_cnt        AS 单客户_信用卡账号数
       ,t3.xyk_bal            AS 单客户_信用卡余额
       ,t3.fnc_amt            AS 单客户_理财金额
       ,t3.fnc_mon_avg_amt    AS 单客户_理财金额月日均
       ,t3.insu_amt           AS 单客户_保险保费
       ,t3.insu_mon_avg_amt   AS 单客户_保险保费月日均
       ,t3.fund_amt           AS 单客户_基金金额
       ,t3.fund_mon_avg_amt   AS 单客户_基金金额月日均
       ,t3.gold_amt           AS 单客户_贵金属近一年金额
       ,t3.gold_mon_avg_amt   AS 单客户_贵金属金额月日均
       ,t4.存款余额                 AS 同一风险控制号下_存款余额
       ,t4.存款余额月日均            AS 同一风险控制号下_存款余额月日均
       ,t4.贷款合同授信金额          AS 同一风险控制号下_贷款合同授信金额
       ,t4.贷款合同用信余额          AS 同一风险控制号下_贷款合同用信余额
       ,t4.信用卡账号数             AS 同一风险控制号下_信用卡账号数
       ,t4.信用卡余额                AS 同一风险控制号下_信用卡余额
       ,t4.理财金额                 AS 同一风险控制号下_理财金额
       ,t4.理财金额月日均            AS 同一风险控制号下_理财金额月日均
       ,t4.保险保费                 AS 同一风险控制号下_保险保费
       ,t4.保险保费月日均            AS 同一风险控制号下_保险保费月日均
       ,t4.基金金额                 AS 同一风险控制号下_基金金额
       ,t4.基金金额月日均            AS 同一风险控制号下_基金金额月日均
       ,t4.贵金属近一年金额           AS 同一风险控制号下_贵金属近一年金额
       ,t4.贵金属金额月日均           AS 同一风险控制号下_贵金属金额月日均
from SJXQ_SJ2024111111_CST_01           t1
left join SJXQ_SJ2024111111_CST_03      t2
on t1.cst_id=T2.cst_id
left join SJXQ_SJ2024111111_CST_04      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024111111_CST_05      t4
on t3.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id
left join SJXQ_SJ2024111111_CST_02      t5
on t1.busi_ctr_id=t5.busi_ctr_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024111111_CST_01
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024111111_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024111111_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024111111_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024111111_CST_06
;
SElECT '06' seq, *
from lab_bigdata_dev.SJXQ_SJ2024111111_CST_06
***SJ2024111186_泰惠收商户取数.sql
﻿/*
泰惠收商户：温岭市石塘三妹猪肉店（商户号820211231022005），申请查询该商户入驻至今每月存款日均和每月手续费收取的具体数据。
申请查询入驻时间2021年12月31日开始到2024年11月11日的数据
数据需求字段
申请查询该商户入驻至今每月存款日均和每月手续费收取的具体数据
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024111186_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111186_CST_01 AS
SELECT  ord.TXN_SEQ_ID    AS 内部流水号
    ,ord.TXN_DT
    ,ord.TXN_TM           AS 交易时间
    ,ord.TXN_STATE        AS 交易状态码值
    ,CASE
        WHEN ord.TXN_STATE = '00' THEN '交易成功'
        WHEN ord.TXN_STATE = '01' THEN '退款'
        WHEN ord.TXN_STATE = '09' THEN '交易已关闭'
        WHEN ord.TXN_STATE = '10' THEN '支付受理成功，请尽快发起支付'
        WHEN ord.TXN_STATE = '11' THEN '支付受理成功，请稍后发起交易状态查询，查询处理结果'
        WHEN ord.TXN_STATE = '12' THEN '支付受理成功，已发送主机，主机正在处理中'
        WHEN ord.TXN_STATE = '13' THEN '主机受理支付成功，需稍后发起交易状态查询，查询处理结果'
        WHEN ord.TXN_STATE = '14' THEN '主机受理支付成功，用户正在支付中,请稍后发起交易状态查询，查询处理结果'
        WHEN ord.TXN_STATE = '20' THEN '主机支付通讯超时'
        WHEN ord.TXN_STATE = '99' THEN '失败'
        ELSE ord.TXN_STATE
        END               AS 交易状态
    ,ord.MER_ID           AS 一级商户号
    ,ord.pay_channel      AS 交易渠道
    ,ord.BANK_NAME        AS 付款银行名称
    ,ord.orig_txn_seq_id  AS 交易流水号
    ,ord.TXN_ORDER_REMARK AS 备注
    ,CASE
        WHEN sign(nvl(ord.TXN_AMT, 0) - 100) = - 1 THEN nvl(ord.TXN_AMT, 0) / 100
        ELSE ord.TXN_AMT / 100
        END                  AS  TXN_AMT    --交易金额
    ,t2.cst_id
FROM    edw.dpss_pbs_order_info ord
inner join(
    SELECT  distinct T1.mch_id,t1.cst_id
    FROM    edw.dim_bus_chnl_ths_mch_inf_dd t1
    WHERE   t1.dt = '@@{yyyyMMdd}'
    AND     nvl(t1.cst_id,'') <> ''
    and t1.mch_id='8202112310220054'
)t2 on ord.MER_ID=t2.mch_id
WHERE   ord.dt >= '20211231'
AND     ord.dt <= '20241111'
AND     ord.TXN_SUB_TYPE IN ( '100601' , '100603' , '100604' , '100701' , '100702' , '100704' , '100800'
    , '101000' , '110603' , '110702' , '110704' , '100411' , '100412' , '100413' , '100414' , '100417'
    , '100419' , '100423' , '100499' , '201003' , '201002' , '201001' , '201007' )
AND     ord.TXN_STATE = '00'
;
-- 存款余额月日均
DROP   TABLE IF     EXISTS SJXQ_SJ2024111186_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111186_CST_02 AS
SElECT t1.cst_id
    ,substr(t1.dt,1,6)  as mons
    ,t1.dep_bal_mon_avg	--	存款余额月日均
    ,row_number() over(partition by t1.cst_id,substr(t1.dt,1,6) order by t1.dt desc) rn
from adm_pub.adm_csm_cbus_dep_inf_dd 		t1 --存款业务信息表
where t1.dt between '20211231' and '20241111'
and t1.cst_id in(select distinct cst_id from SJXQ_SJ2024111186_CST_01)
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024111186_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111186_CST_04 AS
SELECT  ord.TXN_SEQ_ID                                                           AS 内部流水号
        ,inAcc.STLM_DATE                                                         AS 清算日期
        ,mcht.ecif_client_no                                                     AS 客户号
        ,ord.TXN_DT                                                              AS 交易日期
        ,ord.TXN_TM                                                              AS 交易时间
        ,CASE
           WHEN txnType.TXN_SUB_TYPE_DESC = '支付宝被扫支付' AND ord.PAY_SCENE = '01'  THEN '支付宝被扫支付(刷脸)'
           WHEN txnType.TXN_SUB_TYPE_DESC = '支付宝被扫支付' AND ord.PAY_SCENE = '00'  THEN '支付宝被扫支付(条码)'
           WHEN txnType.TXN_SUB_TYPE_DESC = '支付宝被扫支付' AND ord.PAY_SCENE IS NULL THEN '支付宝被扫支付(条码)'
           ELSE TXN_SUB_TYPE_DESC
         END                                                                     AS 交易类型
        ,ord.TXN_STATE                                                           AS 交易状态码值
        ,CASE
           WHEN ord.TXN_STATE = '00' THEN '交易成功'
           WHEN ord.TXN_STATE = '01' THEN '退款'
           WHEN ord.TXN_STATE = '09' THEN '交易已关闭'
           WHEN ord.TXN_STATE = '10' THEN '支付受理成功，请尽快发起支付'
           WHEN ord.TXN_STATE = '11' THEN '支付受理成功，请稍后发起交易状态查询，查询处理结果'
           WHEN ord.TXN_STATE = '12' THEN '支付受理成功，已发送主机，主机正在处理中'
           WHEN ord.TXN_STATE = '13' THEN '主机受理支付成功，需稍后发起交易状态查询，查询处理结果'
           WHEN ord.TXN_STATE = '14' THEN '主机受理支付成功，用户正在支付中,请稍后发起交易状态查询，查询处理结果'
           WHEN ord.TXN_STATE = '20' THEN '主机支付通讯超时'
           WHEN ord.TXN_STATE = '99' THEN '失败'
           ELSE ord.TXN_STATE
         END                                                                     AS 交易状态
        ,ord.MER_ID                                                              AS 一级商户号
        ,mcht.mcht_name                                                          AS 商户名称
        ,mcht.mcht_simple_name                                                   AS 商户简称
        ,mng.MCHT_ID                                                             AS 二级商户号
        ,mng.MCHT_NAME                                                           AS 二级商户名称
        ,mcht.MCHT_ORG_ID                                                        AS 机构号
        ,org.BRNAME                                                              AS 机构名称
        ,mcht.MCHT_AMR_NO                                                        AS 客户经理工号
        ,mcht.MCHT_AMR_NAME                                                      AS 客户经理姓名
        ,ord.pay_channel                                                         AS 交易渠道
        ,ord.BANK_NAME                                                           AS 付款银行名称
        ,ord.orig_txn_seq_id                                                     AS 交易流水号
        ,ord.TXN_ORDER_REMARK                                                    AS 备注
        ,CASE
           WHEN instr(ord.PAGY_BANK_ID, 'DEBIT') > 0               THEN '借记卡'
           WHEN instr(ord.PAGY_BANK_ID, 'CREDIT') > 0              THEN '信用卡'
           WHEN instr(ord.PAGY_BANK_ID, 'MIXED') > 0               THEN '借贷合一卡'
           WHEN ord.PAGY_BANK_ID = 'CFT'                           THEN '零钱'
           WHEN ord.PAGY_BANK_ID = 'LQT'                           THEN '零钱通'
           WHEN ord.PAGY_BANK_ID = 'OTHERS'                        THEN '非银行卡'
           WHEN ord.PAGY_BANK_ID = '3-HB'                          THEN '花呗分期3期'
           WHEN ord.PAGY_BANK_ID = '6-HB'                          THEN '花呗分期6期'
           WHEN ord.PAGY_BANK_ID = '12-HB'                         THEN '花呗分期12期'
           WHEN ord.PAGY_BANK_ID = '3-CC'                          THEN '信用卡分期3期'
           WHEN ord.PAGY_BANK_ID = '6-CC'                          THEN '信用卡分期6期'
           WHEN ord.PAGY_BANK_ID = '12-CC'                         THEN '信用卡分期12期'
           WHEN ord.BANK_NAME = '支付宝' AND ord.PAGY_BANK_ID IS NULL THEN '支付宝'
         END                                                                     AS 支付账户类型
        ,COALESCE(p1.branch_name, P1_1.branch_name)                              AS 分行
        -- --, (select branch_name from ifs_org_branch where substr(mcht.mcht_org_id,0,4)=branch_no or substr(mcht.mcht_org_id,0,2)=branch_no) branch
        ,CASE
           WHEN sign(nvl(ord.TXN_AMT, 0) - 100) = - 1 THEN nvl(ord.TXN_AMT, 0) / 100
           ELSE ord.TXN_AMT / 100
         END                                                                     AS 交易金额 --TXN_AMT
        ,CASE
           WHEN TXN_STATE = '01' THEN nvl(ord.TXN_AMT, 0) / 100
           ELSE 0
         END                                                                     AS 退款金额
        --  ,decode(sign(nvl(ord.TXN_AMT, 0) - 100), - 1, nvl(ord.TXN_AMT, 0) / 100, ord.TXN_AMT / 100) TXN_AMT
        ,CASE
           WHEN sign(nvl(inAcc.FEE_IN_AMT, 0) - 100) = - 1 THEN nvl(inAcc.FEE_IN_AMT, 0) / 100
           ELSE inAcc.FEE_IN_AMT / 100
         END                                                                     AS 应收手续费  --TXN_AMT_FEE
        -- ,decode(sign(nvl(inAcc.FEE_IN_AMT, 0) - 100), - 1, nvl(inAcc.FEE_IN_AMT, 0) / 100, inAcc.FEE_IN_AMT / 100) TXN_AMT_FEE
        ,inAcc.FEE_REDUCE_AMT / 100                                              AS 手续费减免金额 --FEE_REDUCE_AMT
        ,inAcc.RET_FEE_AMT / 100                                                 AS 手续费返还金额 --RET_FEE_AMT
        ,inAcc.SETL_AMT / 100                                                    AS 商户清算金额 --SETTLE_AMT
        ,CASE
           WHEN sign(nvl(( inAcc.SETL_FEE_AMT ), 0) - 100) = - 1 THEN nvl(( inAcc.SETL_FEE_AMT ), 0) / 100
           ELSE ( inAcc.SETL_FEE_AMT ) / 100
         END                                                                     AS 实收手续费  --AMT_FEE
        --,decode(sign(nvl(( inAcc.SETL_FEE_AMT ), 0) - 100), '-1', nvl(( inAcc.SETL_FEE_AMT ), 0) / 100, ( inAcc.SETL_FEE_AMT ) / 100) AMT_FEE
        ,inf.ACTIVE_NAME                                                         AS 参与活动
        ,decode(ord.txn_state, '99', ord.Pagy_Resp_Msg, '')                      AS 失败原因
        ,ord.AGENT_MER_ID                                                        AS 经销商户号
        ,decode(gra.GRADE_BODY, '0', '默认', '1', '用户', '')                        AS 评分主体 --grade_body
        ,gra.grade                                                               AS 评分
        ,decode(ord.C_PORT_CON_FLAG, '00', '不参与', '01', '参与', '不参与')             AS 是否参与积分消费 --CON_FLAG
        ,ord.C_PORT_CON_DEDUCTIO_AMT / 100                                       AS 抵扣金额 --DEDUCTIO_AMT
        ,ord.C_PORT_CON_DEDUCTIO_INTEGRAL                                        AS 消耗积分 -- DEDUCTIO_INTEGRAL
        ,ord.PAY_SCENE                                                           AS 支付场景
        ,ord.TXN_ORDER_ID                                                        AS 商户订单号
        ,nvl(ord.TXN_ORDER_AMT, 0) / 100                                         AS 客户实付金额 --TXN_ORDER_AMT
        ,nvl(ord.CARD_HOLDER_ACTV_EXP_AMT, 0) / 100                              AS 持卡人营销活动支出总金额 --CARD_HOLDER_ACTV_EXP_AMT
        ,nvl(ord.CARD_HOLDER_ACTV_MCHT_EXP_AMT, 0) / 100                         AS 持卡人营销活动商户支出总金额 --CARD_HOLDER_ACTV_MCHT_EXP_AMT
        ,p2.PAGY_TXN_SSN                                                         AS 通道商户单号
        ,p3.TPAM_TXN_SSN                                                         AS 通道交易单号 --wechat_pagy_seq_id
        ,( nvl(ord.QY_MCHT_ACTIVE_AMT, 0) + nvl(ord.COUCHER_MCHT_AMT, 0) ) / 100 AS 卡券抵扣_商户补贴金额 --QY_MCHT_ACTIVE_AMT
        ,nvl(ord.BUY_COUCHER_AMT, 0) / 100                                       AS 卡券抵扣_客户购买权益 --QY_CUSTOMER_BUY_AMT
        ,nvl(ord.TLZF_ACT_BANK_AMT, 0) / 100                                     AS 泰隆支付活动银行出资金额 --TLZF_ACT_BANK_AMT
        ,( nvl(ord.ORDER_GOODS_TAG, 0) + nvl(ord.COUCHER_AMT, 0) ) / 100         AS 商品标记代金券或立减优惠功能的参数 --ORDER_GOODS_TAG
        ,inAcc.TPAM_OPEN_ID                                                      AS 用户ID
        ,inAcc.TPAM_BUYER_USER_ID                                                AS 买家支付宝用户号
        ,inAcc.PAY_TXN_ACC_NO                                                    AS 支付账户号
        ,nvl(ord.DIRECTION_POINT_NUM, 0)                                         AS 定向积分数量
        ,nvl(ord.DIRECTION_POINT_AMT, 0) / 100                                   AS 定向积分抵扣金额
        ,nvl(ord.WISDOM_AMT, 0) / 100                                            AS 智慧经营活动抵扣金额
        ,nvl(ord.WX_DRAINAGE_FLAG, '00')                                         AS 吱口令标签
        ,ord.OTHER_DESC_INFO                                                     AS 自定义备注
FROM    edw.dpss_pbs_order_info ord
LEFT JOIN    edw.dpss_pbs_txn_sub_type_info txnType
ON      ord.TXN_SUB_TYPE = txnType.TXN_SUB_TYPE_CODE
AND     txnType.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dpss_pbs_mcht_base_info mcht
ON      ord.MER_ID = mcht.MCHT_ID
AND     mcht.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dpss_pbs_mcht_base_info mng
ON      mcht.MCHT_MNG_NO = mng.MCHT_ID
AND     mng.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dpss_ifs_org org
ON      mcht.MCHT_ORG_ID = org.BRCODE
AND     org.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dpss_pbs_order_grade_info gra
ON      ord.TXN_SEQ_ID = gra.TXN_SEQ_ID
AND     gra.dt = ord.dt
LEFT JOIN    edw.dpss_bth_mer_in_acc_dtl inAcc
ON      ord.TXN_SEQ_ID = inAcc.CHL_TXN_SSN
AND     inAcc.dt = ord.dt
LEFT JOIN    (
                 SELECT  MCHT_ID
                         ,ACTIVE_NAME
                 FROM    edw.dpss_actv_inf inf
                 LEFT JOIN    edw.dpss_actv_mcht_in_inf inInf
                 ON      inf.ACTIVE_NO = inInf.ACTIVE_NO
                 AND     inInf.dt = '@@{yyyyMMdd}'
                 WHERE   inInf.IN_FLAG = '01'
                 AND     instr(inInf.ACTIVE_NO, 'AT3') > 0
                 AND     inf.dt = '@@{yyyyMMdd}'
             ) inf
ON      ord.mer_id = inf.MCHT_ID
LEFT JOIN    edw.dpss_ifs_org_branch p1
ON      substr(mcht.mcht_org_id, 1, 4) = p1.branch_no
AND     p1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dpss_ifs_org_branch p1_1
ON      substr(mcht.mcht_org_id, 1, 2) = p1_1.branch_no
AND     p1_1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dpss_pagy_core_txn_record p2
ON      p2.CHL_TXN_SSN = ord.TXN_SEQ_ID
AND     p2.dt = ord.dt
LEFT JOIN    edw.dpss_pagy_wechat_txn_info p3
ON      p3.CHL_TXN_SSN = ord.TXN_SEQ_ID
AND     p3.dt = ord.dt
LEFT JOIN    edw.dpss_pagy_alipay_txn_info p4
ON      p4.CHL_TXN_SSN = ord.TXN_SEQ_ID
AND     p4.dt = ord.dt
LEFT JOIN    edw.dpss_bth_mer_in_acc_dtl p5
ON      p5.CHL_TXN_SSN = ord.TXN_SEQ_ID
AND     p5.dt = ord.dt
WHERE   ord.dt >= '20211231'
AND     ord.dt <= '20241111'
AND     ord.TXN_SUB_TYPE IN ( '100601' , '100603' , '100604' , '100701' , '100702' , '100704' , '100800' , '101000' , '110603' , '110702' , '110704' , '100411' , '100412' , '100413' , '100414' , '100417' , '100419' , '100423' , '100499' , '201003' , '201002' , '201001' , '201007' )
AND     ord.MER_ID IN ( '8202112310220054')
ORDER BY org.BRNAME , ord.txn_dt , ord.txn_tm;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024111186_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111186_CST_03 AS
SELECT  t1.mch_id          AS 商户编号
       ,t1.cst_id          AS 客户号
       ,t1.mch_nm          AS 商户名称
       ,t2.mons            AS 月末
       ,t2.dep_bal_mon_avg AS 存款余额月日均
       ,t3.实收手续费     AS 月交易手续费
from edw.dim_bus_chnl_ths_mch_inf_dd    t1    --泰惠收商户基本信息
left join SJXQ_SJ2024111186_CST_02      t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join(
    SELECT 客户号 as cst_id
        ,substr(交易日期,1,6) as mons
        ,sum(实收手续费) as 实收手续费
    from SJXQ_SJ2024111186_CST_04
    GROUP BY 客户号,mons
)t3 on t1.cst_id=t3.cst_id
and t2.mons=t3.mons
where t1.dt='@@{yyyyMMdd}'
and t1.mch_id='8202112310220054'
;
SElECT '01' seq, count(1) cnt,count(distinct 内部流水号) custs
from SJXQ_SJ2024111186_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024111186_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 商户编号) custs
from SJXQ_SJ2024111186_CST_03
;
-- 结果表
SElECT '03' seq, *
from LAB_BIGDATA_DEV.SJXQ_SJ2024111186_CST_03
***SJ20241112121_张宣萍_台州分行信贷数据.sql
-- 20221231 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_01 as
SELECT  *
FROM
(
	SELECT  a.acctcode
	       ,CASE WHEN a.accttype = 'R1' THEN '是'  ELSE '否' END                                  AS SFXH
	       ,NVL(LOAN.CTR_SERNO,substr(a.MCC,15))                                                AS CTR_SERNO
	       ,f.OPENDATE
	       ,f.DUEDATE
	       ,b.ACCTBAL
	       ,b.OVERDPRINC
	       ,b.TOTOVERD - b.OVERDPRINC                                                           AS YQLX
	       ,b.TOTOVERD
	       ,a.name
	       ,a.idnum
	       ,jC.telephone                                                                        AS TEL_JKR
	       ,DB.DBR
	       ,a.rptdate
	       ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE,a.idnum,DB.DBR ORDER BY  A.RPTDATE DESC ) AS RN
	FROM adm_upss.IN_M_pci_acctbs a
	LEFT JOIN adm_upss.IN_M_pci_acctmthlyblginf b
	ON a.acctcode = b.acctcode AND b.dt = a.dt
	LEFT JOIN adm_upss.IN_M_pci_acctbsinf f
	ON a.acctcode = f.acctcode AND f.dt = a.dt
	LEFT JOIN
	(
		SELECT  R.ACCTCODE
		       ,R.RPTDATE
		FROM adm_upss.IN_M_PCI_RLTREPYMTINF r
		LEFT JOIN
		(
			SELECT  A.CUST_ID
			       ,INFO.IDTYPE                                                                  AS CUST_TYPE
			       ,CASE WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD,INFO.IDNUM),1,12)
			             WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM,1,9)
			             WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM,1,8)  ELSE INFO.IDNUM END AS IDNUM
			FROM adm_upss.L_CUST_ALL A
			LEFT JOIN adm_upss.ICR_C_PBI_INFO INFO --个人证件
			ON INFO.CST_ID = A.CUST_ID AND INFO.DT = '20221231'
			WHERE A.DT = '20221231'
			AND A.CUST_TYPE = '00'
			--担保人取个人
		) CST_DB --担保人信息
		ON r.ARLPCERTNUM = CST_DB.IDNUM AND r.ARLPCERTTYPE = CST_DB.CUST_TYPE
		LEFT JOIN
		(
			SELECT  T.*
			       ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY  T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
			FROM EDW.LOAN_CUSTOMER_TEL T
			WHERE T.DT = '20221231'
			AND T.TELTYPE = '010000' -- 010000-手机号
			AND T.RELATIONSHIP = '0101' -- 关系类型 0101-本人
			AND T.ISINFORMATION = '1'
			-- 1-是接收短信的有效号码
			--电话类型为手机号
		) D --担保人信息 -取手机号
		ON CST_DB.CUST_ID = D.customerid AND D.N = 1
		GROUP BY  R.ACCTCODE
		         ,R.RPTDATE
	)DB
	ON A.ACCTCODE = DB.ACCTCODE AND A.RPTDATE = DB.RPTDATE
	LEFT JOIN EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
	ON SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID AND LOAN.DT = '20221231' AND A.ACCTTYPE = 'D1'
	LEFT JOIN
	(
		SELECT  A.CUST_ID
		       ,INFO.IDTYPE                                                                  AS CUST_TYPE
		       ,CASE WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD,INFO.IDNUM),1,12)
		             WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM,1,9)
		             WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM,1,8)  ELSE INFO.IDNUM END AS IDNUM
		FROM adm_upss.L_CUST_ALL A
		LEFT JOIN adm_upss.ICR_C_PBI_INFO INFO --个人证件
		ON INFO.CST_ID = A.CUST_ID AND INFO.DT = '20221231'
		WHERE A.DT = '20221231'
	) CST --借款人信息
	ON A.IDNUM = CST.IDNUM AND A.IDTYPE = CST.CUST_TYPE
	LEFT JOIN
	(
		SELECT  T.*
		       ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY  T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
		FROM EDW.LOAN_CUSTOMER_TEL T
		WHERE T.DT = '20221231'
		AND T.TELTYPE = '010000' -- 010000-手机号
		AND T.RELATIONSHIP = '0101' -- 关系类型 0101-本人
		AND T.ISINFORMATION = '1'
		-- 1-是接收短信的有效号码
		--电话类型为手机号 非手机号不取
	) jC --借款人信息 -取手机号
	ON CST.CUST_ID = jC.customerid AND jC.N = 1
	WHERE b.ACCTBAL > 0
	AND a.MULTI_TENANCY_ID = '000000'
	AND NOT EXISTS (
	SELECT  1
	FROM adm_upss.IN_M_pci_acctbs c
	WHERE c.dt <= '20221231'
	AND a.acctcode = c.acctcode
	AND c.rptdatecode IN ( '20' , '32' ) )
)T
WHERE T.RN = '1'
;
-- 20230331 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_02 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20230331'
                 WHERE   A.DT = '20230331'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20230331'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20230331'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20230331'
                 WHERE   A.DT = '20230331'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20230331'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20230331'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 20230630 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_03 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20230630'
                 WHERE   A.DT = '20230630'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20230630'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20230630'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20230630'
                 WHERE   A.DT = '20230630'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20230630'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20230630'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 20230930 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_04 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20230930'
                 WHERE   A.DT = '20230930'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20230930'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20230930'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20230930'
                 WHERE   A.DT = '20230930'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20230930'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20230930'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 20231231 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_05 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20231231'
                 WHERE   A.DT = '20231231'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20231231'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20231231'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20231231'
                 WHERE   A.DT = '20231231'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20231231'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20231231'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 20240331 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_06 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20240331'
                 WHERE   A.DT = '20240331'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20240331'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20240331'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20240331'
                 WHERE   A.DT = '20240331'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20240331'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20240331'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 20240630 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_07 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20240630'
                 WHERE   A.DT = '20240630'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20240630'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20240630'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20240630'
                 WHERE   A.DT = '20240630'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20240630'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20240630'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 20240930 acctcode
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_08 as
SELECT * FROM (
SELECT          a.acctcode
                 ,CASE
                    WHEN a.accttype = 'R1' THEN '是'
                    ELSE '否'
                  END AS SFXH
                 ,NVL(LOAN.CTR_SERNO, substr(a.MCC, 15)) AS CTR_SERNO
                 ,f.OPENDATE
                 ,f.DUEDATE
                 ,b.ACCTBAL
                 ,b.OVERDPRINC
                 ,b.TOTOVERD - b.OVERDPRINC AS YQLX
                 ,b.TOTOVERD
                 ,a.name
                 ,a.idnum
                 ,jC.telephone AS TEL_JKR
                 ,DB.DBR
                 ,a.rptdate
				 ,ROW_NUMBER() OVER(PARTITION BY A.ACCTCODE, a.idnum, DB.DBR ORDER BY A.RPTDATE DESC ) AS RN
FROM    adm_upss.IN_M_pci_acctbs a
LEFT JOIN    adm_upss.IN_M_pci_acctmthlyblginf b
ON      a.acctcode = b.acctcode
AND     b.dt = a.dt
LEFT JOIN    adm_upss.IN_M_pci_acctbsinf f
ON      a.acctcode = f.acctcode
AND     f.dt = a.dt
LEFT JOIN    (
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20240930'
                 WHERE   A.DT = '20240930'
                 AND     A.CUST_TYPE = '00'
             --担保人取个人
             ) CST_DB --担保人信息
ON      r.ARLPCERTNUM = CST_DB.IDNUM
AND     r.ARLPCERTTYPE = CST_DB.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20240930'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号
             ) D --担保人信息 -取手机号
ON      CST_DB.CUST_ID = D.customerid
AND     D.N = 1
GROUP BY R.ACCTCODE ,R.RPTDATE
)DB
ON A.ACCTCODE =DB.ACCTCODE AND A.RPTDATE=DB.RPTDATE
LEFT JOIN   EDW.DIM_BUS_LOAN_DBIL_INF_DD LOAN
ON      SUBSTR(A.ACCTCODE, 15) = LOAN.DBIL_ID
AND     LOAN.DT = '20240930'
AND     A.ACCTTYPE = 'D1'
LEFT JOIN    (
                 SELECT  A.CUST_ID
                         ,INFO.IDTYPE AS CUST_TYPE
                         ,CASE
                            WHEN INFO.IDTYPE = '2' THEN SUBSTR(CONCAT(A.NATION_CD, INFO.IDNUM), 1, 12)
                            WHEN INFO.IDTYPE = '5' THEN SUBSTR(INFO.IDNUM, 1, 9)
                            WHEN INFO.IDTYPE = '6' THEN SUBSTR(INFO.IDNUM, 1, 8)
                            ELSE INFO.IDNUM
                          END         AS IDNUM
                 FROM    adm_upss.L_CUST_ALL A
                 LEFT JOIN    adm_upss.ICR_C_PBI_INFO INFO --个人证件
                 ON      INFO.CST_ID = A.CUST_ID
                 AND     INFO.DT = '20240930'
                 WHERE   A.DT = '20240930'
             ) CST --借款人信息
ON      A.IDNUM = CST.IDNUM
AND     A.IDTYPE = CST.CUST_TYPE
LEFT JOIN    (
                 SELECT  T.*
                         ,ROW_NUMBER() OVER ( PARTITION BY T.CUSTOMERID ORDER BY T.ISINFORMATION DESC ,T.UPDATEDATE DESC ) N --按照更新日期取最新一条
                 FROM    EDW.LOAN_CUSTOMER_TEL T
                 WHERE   T.DT = '20240930'
                 AND     T.TELTYPE = '010000' -- 010000-手机号
                 AND     T.RELATIONSHIP = '0101' --  关系类型 0101-本人
                 AND     T.ISINFORMATION = '1'
 --  1-是接收短信的有效号码
             --电话类型为手机号 非手机号不取
             ) jC --借款人信息 -取手机号
ON      CST.CUST_ID = jC.customerid
AND     jC.N = 1
WHERE   b.ACCTBAL > 0
AND     a.MULTI_TENANCY_ID = '000000'
AND     NOT EXISTS (
                       SELECT  1
                       FROM    adm_upss.IN_M_pci_acctbs c
                       WHERE   c.dt <= '20240930'
                       AND     a.acctcode = c.acctcode
                       AND     c.rptdatecode IN ( '20' , '32' )
                   ))T
WHERE T.RN = '1'
;
-- 输出结果
-- 20221231
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20221231 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20221231 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20221231'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20221231'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20221231'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20221231'
    where t1.dt='20221231'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20221231'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20221231'
    where t1.dt='20221231'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20230331
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20230331 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20230331 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20230331'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20230331'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20230331'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20230331'
    where t1.dt='20230331'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20230331'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20230331'
    where t1.dt='20230331'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20230630
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20230630 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20230630 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20230630'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20230630'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20230630'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20230630'
    where t1.dt='20230630'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20230630'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20230630'
    where t1.dt='20230630'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20230930
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20230930 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20230930 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20230930'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20230930'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20230930'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20230930'
    where t1.dt='20230930'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20230930'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20230930'
    where t1.dt='20230930'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20231231
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20231231 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20231231 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20231231'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20231231'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20231231'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20231231'
    where t1.dt='20231231'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20231231'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20231231'
    where t1.dt='20231231'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20240331
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20240331 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20240331 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20240331'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20240331'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20240331'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20240331'
    where t1.dt='20240331'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20240331'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20240331'
    where t1.dt='20240331'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20240630
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20240630 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20240630 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20240630'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20240630'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20240630'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20240630'
    where t1.dt='20240630'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20240630'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20240630'
    where t1.dt='20240630'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
-- 20240930
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST2_20240930 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST2_20240930 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,t2.lve_act_bgn_dt       AS 出账起始日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.prcp_bal             AS 逾期本金
    ,nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0)                    AS 逾期利息
    ,nvl(t2.prcp_bal,0)+nvl(t2.onbs_ovd_intr_bal,0)+nvl(t2.ofbs_ovd_intr_bal,0) AS 逾期总额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from(
    select t1.ctr_serno                              --合同流水号
        ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
        ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
        ,t1.ctr_bgn_dt                               --合同起始日期
        ,t1.ctr_mtu_dt                               --合同到期日期
        ,c2.cd_val_dscr     as RVLG_TYP_nm
        ,t5.cst_chn_nm	    --客户中文名称
        ,t5.doc_nbr	        --主证件号码
        ,t5.mbl_nbr	        --手机号
        ,t1.dt
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    left join edw.dim_bus_loan_prd_frml_dd      t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20240930'
    left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
    on t1.ctr_serno=t3.ctr_serno
    and t3.dt='20240930'
    left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
    on  t3.mgr_org_id = t4.org_id
    and t4.dt = '20240930'
    left join edw.dwd_code_library_dd           c2
    on t1.RVLG_TYP_CD = c2.cd_val
    and c2.dt = '@@{yyyyMMdd}'
    inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
    on t1.cst_id=t5.cst_id
    and t5.dt='20240930'
    where t1.dt='20240930'
    and t1.CTR_BAL > 0  --有余额
    and t2.PD_NM not regexp '信用卡'
    and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
) t1 left join (
    SELECT  t1.ctr_serno --合同流水号|c32
        ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
        ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
        ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
        ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    from edw.dim_bus_loan_dbil_inf_dd       t1
    where t1.dt='20240930'
    GROUP BY t1.ctr_serno
) t2 on t1.ctr_serno=t2.ctr_serno
left join (
    SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
    from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
    left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
    on t1.wrnt_cst_id=t3.cst_id
    and t3.dt='20240930'
    where t1.dt='20240930'
    group by t1.bus_ctr_id
) t4 on t1.ctr_serno=t4.bus_ctr_id
;
SElECT '01' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_07
union all
SElECT '08' seq, count(1) cnt,count(distinct acctcode) custs
from SJXQ_SJ20241112121_CST2_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20221231
union all
SElECT '10' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20230331
union all
SElECT '11' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20230630
union all
SElECT '12' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20230930
union all
SElECT '13' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20231231
union all
SElECT '14' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20240331
union all
SElECT '15' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20240630
union all
SElECT '16' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST2_20240930
;
***SJ20241112121_张宣萍_台州分行信贷数据_模板.sql
﻿/*
取数时点：20221231、20230331、20230630、20230930、20231231、20240331、20240630、20240930
取数规则：截至上述时点有余额的个人客户信息
借贷客户字段信息：账户标识码、是否循环贷、合同号、开户日期、合同起始日、合同到期日、余额、逾期本金、
逾期利息、逾期总额、借款人姓名、借款人证件号、借款人手机号、担保人姓名、担保人证件号、担保人手机号、数据日期
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_01 as
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ovd_amt	                                --逾期金额  逾期本金
    ,t1.ovd_dt	                                --逾期日期
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm
    ,t4.brc_org_nm
    ,t5.cst_chn_nm	    --客户中文名称
    ,t5.doc_nbr	        --主证件号码
    ,t5.mbl_nbr	        --手机号
    ,t1.dt
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='20240930'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20240930'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20240930'
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = '@@{yyyyMMdd}'
inner join edw.dws_cst_idv_bas_inf_dd	    t5 --个人客户基本信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='20240930'
where t1.dt='20240930'
and t1.CTR_BAL > 0  --有余额
and t2.PD_NM not regexp '信用卡'
and t4.cpy_org_id = '999999998' --泰隆 剔除村行 不含村行
;
-- 逾期本金、逾期利息、逾期总额
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_02 as
select t2.ctr_serno                               --合同流水号
	,sum(t1.dbil_amt            ) as dbil_amt             --借据金额
	,sum(t1.dbil_bal            ) as dbil_bal             --借据余额 = 正常本金+逾期本金+呆滞本金+呆账本金
	,sum(t1.cny_dbil_bal        ) as cny_dbil_bal         --借据余额(折人民币)
	,sum(t1.nrm_prcp            ) as nrm_prcp             --正常本金
	,sum(t1.ovd_prcp            ) as ovd_prcp             --逾期本金
	,sum(t1.dead_prcp           ) as dead_prcp            --呆滞本金
	,sum(t1.bad_debt_prcp       ) as bad_debt_prcp        --呆账本金
	,sum(t1.ovd_intr            ) as ovd_intr             --逾期利息 = 表内欠息+表外欠息
	,sum(t1.table_intn_debt_intr) as table_intn_debt_intr --表内欠息
	,sum(t1.table_extn_debt_intr) as table_extn_debt_intr --表外欠息
    ,count(distinct dbil_srl_no) as dbil_cnt
from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd   t1 --风险集市信贷业务借据信息表
inner join SJXQ_SJ20241112121_CST_01        t2
on t1.ctr_srl_no=t2.ctr_serno
where t1.dt='20240930'
group by t2.ctr_serno
;
/*该表数据与上表一致，但少2个合同号
BC2020081800001505
BC2020082600000936
借据表有356条合同与合同表余额对不上，疑似借据数据错误少
BC2021082600000371
-- 逾期本金、逾期利息、逾期总额
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_03 as
select t2.ctr_serno                               --合同流水号
	,sum(t1.amt             ) as dtrb_amt                                 --发放金额
	,sum(t1.prcp_bal        ) as prcp_bal                                 --本金余额 = 正常余额+逾期金额+呆滞余额+呆帐余额
	,sum(t1.norm_bal        ) as norm_bal                                 --正常余额
	,sum(t1.ovd_amt         ) as ovd_amt                                  --逾期金额
	,sum(t1.idle_bal        ) as idle_bal                                 --呆滞余额
	,sum(t1.bad_bal         ) as bad_bal                                  --呆帐余额
	,sum(t1.ibs_ovd_intr_bal) as ibs_ovd_intr_bal                         --表内欠息余额
	,sum(t1.obs_ovd_intr_bal) as obs_ovd_intr_bal                         --表外欠息余额
    ,count(distinct dbil_id) as dbil_cnt
from app_rpt.adm_pub_bus_loan_dbil_inf_dd   t1   --公共集市-贷款业务信息汇总表
inner join SJXQ_SJ20241112121_CST_01        t2
on t1.bus_ctr_id=t2.ctr_serno
where t1.dt='20240930'
group by t2.ctr_serno
;
SELECT *
from SJXQ_SJ20241112121_CST_01 t1
left JOIN SJXQ_SJ20241112121_CST_02 t2
on t1.ctr_serno=t2.ctr_serno
where t1.ctr_bal<>t2.cny_dbil_bal
*/
-- 借据汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_03_1 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_03_1 as
SELECT  t1.ctr_serno --合同流水号|c32
    ,sum(t1.amt)   as  fk_amt --金额|decimal(21,2)
    ,min(t1.lve_act_bgn_dt)    AS lve_act_bgn_dt --出账起始日期|c8
    ,max(t1.exec_mtu_dt)       AS exec_mtu_dt --执行到期日|c8
    ,sum(t1.prcp_bal)          AS prcp_bal --本金余额=正常余额+逾期金额+呆滞余额+呆账余额
    ,sum(t1.norm_bal)          AS norm_bal --正常余额|decimal(22,2)
    ,sum(t1.ovd_amt)           AS ovd_amt --逾期金额|decimal(21,2)
    ,sum(t1.dull_bal)          AS dull_bal --呆滞余额|decimal(22,2)
    ,sum(t1.stgn_dbt_bal)      AS stgn_dbt_bal --呆账余额|decimal(21,2)
    ,sum(t1.onbs_ovd_intr_bal) AS onbs_ovd_intr_bal --表内欠息余额|decimal(21,2)
    ,sum(t1.ofbs_ovd_intr_bal) AS ofbs_ovd_intr_bal --表外欠息余额|decimal(21,2)
    ,max(t1.tmt_dt)            AS tmt_dt --终结日期|c8
    ,max(t1.prcp_pyf_dt)       AS prcp_pyf_dt --本金结清日期|c8
    ,max(t1.pyf_ind)           AS pyf_ind --结清标志
    ,count(distinct dbil_id) as dbil_cnt
from edw.dim_bus_loan_dbil_inf_dd       t1
inner join SJXQ_SJ20241112121_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt='20240930'
GROUP BY t1.ctr_serno
;
SELECT t1.*
from edw.dim_bus_loan_dbil_inf_dd       t1
inner join SJXQ_SJ20241112121_CST_01    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt='20240930'
and t1.opn_dt='18991231'
-- 担保人汇总信息 担保人姓名、担保人证件号、担保人手机号
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_04 as
SELECT  t1.bus_ctr_id                                                                          --业务合同编号|C32
from edw.dws_bus_grnt_prsn_inf_dd           t1   --担保人汇总信息
inner join SJXQ_SJ20241112121_CST_01        t2
on t1.bus_ctr_id=t2.ctr_serno
left join edw.dws_cst_idv_bas_inf_dd	    t3 --个人客户基本信息汇总表
on t1.wrnt_cst_id=t3.cst_id
and t3.dt='20240930'
where t1.dt='20240930'
group by t1.bus_ctr_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241112121_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241112121_CST_05 as
SELECT  ''                   AS 账户标识码
    ,t1.RVLG_TYP_nm          AS 循环类型
    ,t1.ctr_serno            AS 合同流水号
    ,''                      AS 开户日期
    ,t1.ctr_bgn_dt           AS 合同起始日期
    ,t1.ctr_mtu_dt           AS 合同到期日期
    ,t1.ctr_amt              AS 合同金额
    ,t1.ctr_bal              AS 合同余额
    ,t2.ovd_prcp             AS 逾期本金
    ,t2.ovd_intr             AS 逾期利息
    ,t2.ovd_prcp+t2.ovd_intr AS 逾期总额
    ,t1.ovd_amt              AS 逾期金额
    ,t1.cst_chn_nm           AS 借款人姓名
    ,t1.doc_nbr              AS 借款人证件号
    ,t1.mbl_nbr              AS 借款人手机号
    ,t4.wrnt_cst_nm          AS 担保人姓名
    ,t4.wrnt_doc_nbr         AS 担保人证件号
    ,t4.mbl_nbr              AS 担保人手机号
    ,t1.dt                   AS 数据日期
from SJXQ_SJ20241112121_CST_01      t1
left join SJXQ_SJ20241112121_CST_03_1 t2
on t1.ctr_serno=t2.ctr_serno
left join SJXQ_SJ20241112121_CST_04 t4
on t1.ctr_serno=t4.bus_ctr_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241112121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241112121_CST_02
-- union all
-- SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
-- from SJXQ_SJ20241112121_CST_03
union all
SElECT '031' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241112121_CST_03_1
union all
SElECT '04' seq, count(1) cnt,count(distinct bus_ctr_id) custs
from SJXQ_SJ20241112121_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241112121_CST_05
;
SElECT '05' seq, *
from SJXQ_SJ20241112121_CST_05
where 合同流水号='BC2021030400003063'
;
/*以下3个合同的余额 和借据对不上
BC2021030400003063
BC2020042900002564
BC2020111100000750
SELECT *
from edw.dim_bus_loan_dbil_inf_dd
where dt='20240930'
'BC2020082600000936')
*/
SELECT *
from edw.dim_bus_loan_dbil_inf_dd
where dt='20240930'
and dbil_id='SXK202403260026564474'
and CTR_SERNO = 'BC2021030400003063'
;
select *
from edw.dim_bus_loan_ctr_bse_inf_dd
where dt='20240930'
and  CTR_SERNO =  'BC2021030400003063'
select *
from adm_rsk.adm_rsk_ast_loan_dbil_inf_dd
where dt='20240930'
and  ctr_srl_no =  'BC2021030400003063'
select cst_id,count(1) cnt
from adm_upss.in_m_pci_acctbs
where dt='20240930'
GROUP by cst_id
order by cnt desc
select *
from adm_upss.in_m_pci_acctbs
where dt='20240930'
and cst_id='1008965526'
***SJ2024121081_管户人获奖清单.sql
﻿/*
账户管户从 理财账户管户表里取
里面的达标时间按 理财确认交易流水里的交易时间来，可以用交易流水号ASC排序
同一天里也可能有先后，所以按流水号的大小来排序
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024121081_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121081_CST_01_1 AS
select cst_ID,pd_cd,bnk_act_id,mgr_id,acs_org_id,acs_rto
    ,row_number() over(partition by cst_ID,pd_cd,bnk_act_id order by acs_rto desc,mgr_id asc) rn
from edw.dws_bus_chm_act_mgr_inf_dd t3 --理财考核汇总信息
where t3.dt = '@@{yyyyMMdd}'
and t3.MNG_TYP_CD = '1'     --`管户`类型 1考核 2销售
and t3.PD_TP_CD='1'         --'0','基金','1','理财'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121081_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121081_CST_01 AS
select t1.srl_nbr                                  --流水号|c32
	,t1.cst_id                                   --客户编号|c24
	,t1.trx_dt                                   --交易日期|c8
	,t1.trx_tm                                   --交易时间|c6
    ,t1.cfm_dt
	,t1.cfm_amt                                  --确认金额|decimal(20,2)
    ,t1.pd_cd
    ,t2.pd_nm   --产品名称
	,t3.mgr_id  as acs_mgr_id                                 --管护人编号
    ,c1.empe_nm as acs_mgr_nm
    ,t5.sbr_org_nm
    ,t5.brc_org_nm
    ,sum(t1.cfm_amt) over(partition by t3.mgr_id order by t1.srl_nbr asc) as sum_cfm_amt
from edw.dwd_bus_chm_trx_cfm_dtl_dd         t1 --理财交易确认流水明细
left join edw.dim_bus_chm_pd_inf_dd         t2
on t1.pd_cd=t2.pd_cd
and t2.dt='@@{yyyyMMdd}'
left join SJXQ_SJ2024121081_CST_01_1 t3
on  t1.cst_ID=t3.cst_ID
and t1.pd_cd=t3.pd_cd
and t1.bnk_act_id=t3.bnk_act_id
and t3.rn=1
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd    t5
ON      t3.acs_org_id = t5.org_id
AND     t5.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t3.mgr_id=c1.empe_id
and c1.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
;
-- 累计达500万（含）前2名
DROP   TABLE IF     EXISTS SJXQ_SJ2024121081_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121081_CST_02 AS
select rn2                        as 序号
	,concat(trx_dt,' ',trx_tm)   as 达标累计金额时间
	,acs_mgr_id                  as 管户人工号
    ,acs_mgr_nm                  as 管户人姓名
    ,brc_org_nm                  as 管户人所在分行
    ,sbr_org_nm                  as 管户人所在支行_部门
    ,sum_cfm_amt                 as 累计认购金额_截止达标时间
from(
    SELECT *
        ,row_number() over(order by srl_nbr asc) rn2
    from(
        select *
            ,row_number() over(partition by acs_mgr_id order by srl_nbr asc) rn1
        from SJXQ_SJ2024121081_CST_01
        where sum_cfm_amt >= 5000000
    )t1 where rn1=1     --取最早达标记录
)t1 where rn2<=2    --取前2
;
-- 累计达300万（含）前5名
DROP   TABLE IF     EXISTS SJXQ_SJ2024121081_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121081_CST_03 AS
select rn2                        as 序号
	,concat(trx_dt,' ',trx_tm)   as 达标累计金额时间
	,acs_mgr_id                  as 管户人工号
    ,acs_mgr_nm                  as 管户人姓名
    ,brc_org_nm                  as 管户人所在分行
    ,sbr_org_nm                  as 管户人所在支行_部门
    ,sum_cfm_amt                 as 累计认购金额_截止达标时间
from(
    SELECT *,row_number() over(order by srl_nbr asc) rn2
    from(
        select *,row_number() over(partition by acs_mgr_id order by srl_nbr asc) rn1
        from SJXQ_SJ2024121081_CST_01       t1
        left join SJXQ_SJ2024121081_CST_02  t2
        on  t1.acs_mgr_id=t2.管户人工号
        where sum_cfm_amt >= 3000000
        and t2.管户人工号 is null
    )t1 where rn1=1
)t1 WHERE rn2<=5
;
-- 累计达100万（含）前10名
DROP   TABLE IF     EXISTS SJXQ_SJ2024121081_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121081_CST_04 AS
select rn2                        as 序号
	,concat(trx_dt,' ',trx_tm)   as 达标累计金额时间
	,acs_mgr_id                  as 管户人工号
    ,acs_mgr_nm                  as 管户人姓名
    ,brc_org_nm                  as 管户人所在分行
    ,sbr_org_nm                  as 管户人所在支行_部门
    ,sum_cfm_amt                 as 累计认购金额_截止达标时间
from(
    SELECT *,row_number() over(order by srl_nbr asc) rn2
    from(
        select *,row_number() over(partition by acs_mgr_id order by srl_nbr asc) rn1
        from SJXQ_SJ2024121081_CST_01       t1
        left join(
            select 管户人工号
            from SJXQ_SJ2024121081_CST_02
            union all
            select 管户人工号
            from SJXQ_SJ2024121081_CST_03
        )t2 on  t1.acs_mgr_id=t2.管户人工号
        where sum_cfm_amt >= 1000000
        and t2.管户人工号 is null
    )t1 where rn1=1
)t1 where rn2<=10
;
-- 累计达30万（含）前30名
DROP   TABLE IF     EXISTS SJXQ_SJ2024121081_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121081_CST_05 AS
select rn2                        as 序号
	,concat(trx_dt,' ',trx_tm)   as 达标累计金额时间
	,acs_mgr_id                  as 管户人工号
    ,acs_mgr_nm                  as 管户人姓名
    ,brc_org_nm                  as 管户人所在分行
    ,sbr_org_nm                  as 管户人所在支行_部门
    ,sum_cfm_amt                 as 累计认购金额_截止达标时间
from(
    SELECT *,row_number() over(order by srl_nbr asc) rn2
    from(
        select *
            ,row_number() over(partition by acs_mgr_id order by srl_nbr asc) rn1
        from SJXQ_SJ2024121081_CST_01       t1
        left join(
            select 管户人工号
            from SJXQ_SJ2024121081_CST_02
            union all
            select 管户人工号
            from SJXQ_SJ2024121081_CST_03
            union all
            select 管户人工号
            from SJXQ_SJ2024121081_CST_04
        )t2 on  t1.acs_mgr_id=t2.管户人工号
        where sum_cfm_amt >= 300000
        and t2.管户人工号 is null
    )t1 where rn1=1
)t1 where rn2<=30
;
SElECT '01' seq, count(1) cnt,count(distinct srl_nbr) custs
from SJXQ_SJ2024121081_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 管户人工号) custs
from SJXQ_SJ2024121081_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 管户人工号) custs
from SJXQ_SJ2024121081_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 管户人工号) custs
from SJXQ_SJ2024121081_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 管户人工号) custs
from SJXQ_SJ2024121081_CST_05
***SJ2024121221_财富余额统计.sql
﻿-- 存款账户首次开卡日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_01 AS
select t1.cst_id,t1.fst_OPN_DT
    ,case when substr(t1.fst_OPN_DT,1,4)='2024' then 1 else 0 end as is_2024cst
    ,case when substr(t1.fst_OPN_DT,1,4)='2023' then 1 else 0 end as is_2023cst
    ,t2.cst_seg_flg
    ,decode(t2.cst_seg_flg,'1','2 企业主','2','1 个体工商户','3','3 企事业高管'
        ,'5','4 工薪族','6','5 退休养老','7','6 持家女性','7 其他') as cst_seg_nm
from(
    SElECT cst_id
        ,min(OPN_DT) as fst_OPN_DT
    from edw.dws_bus_dep_act_inf_dd    			--存款账户信息汇总
    where dt='20241130'
    group by cst_id
)t1 left join adm_pub.adm_csm_clab_cst_jc_inf_dd t2 --客户标签信息
on t1.cst_id=t2.cst_id
and t2.dt='20241130'
;
-- 20241130 客户数 余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_02 AS
SElECT t1.cst_id,t1.cst_seg_nm,t1.is_2024cst,t1.is_2023cst
    ,t2.fund_amt	            --基金金额
    ,t2.fnc_amt	                --理财金额
    ,t2.gold_amt	            --贵金属近一年金额
    ,t2.insu_amt	            --保险保费
    ,t3.gold_amt_tot
    -- ,t2.gold_buy_amt	        --贵金属购买金额
    -- ,t2.gold_fin_buy_amt_12m	--近12个月贵金属购买金额(金融专区)
from SJXQ_SJ2024121221_CST_01                       t1
inner join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd  t2 --客户金融资产信息表
on t1.cst_id=t2.cst_id
and t2.dt='20241130'
left join (
    select cst_id,SUM(cmdt_pay_unt_prc) AS gold_amt_tot --购买金额
    from adm_pub.adm_pub_cst_nob_met_trx_sum_di  --贵金属交易整合表
    where dt <= '20241130'
    and nvl(cst_id,'')<>''   --客户号非空
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
;
-- 20231231 客户数 余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_03 AS
SElECT t1.cst_id,t1.cst_seg_nm,t1.is_2024cst,t1.is_2023cst
    ,t2.fund_amt	            --基金金额
    ,t2.fnc_amt	                --理财金额
    ,t2.gold_amt	            --贵金属近一年金额
    ,t2.insu_amt	            --保险保费
    ,t3.gold_amt_tot
    -- ,t2.gold_buy_amt	        --贵金属购买金额
    -- ,t2.gold_fin_buy_amt_12m	--近12个月贵金属购买金额(金融专区)
from SJXQ_SJ2024121221_CST_01                       t1
inner join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd   t2 --客户金融资产信息表
on t1.cst_id=t2.cst_id
and t2.dt='20231231'
left join (
    select cst_id,SUM(cmdt_pay_unt_prc) AS gold_amt_tot --购买金额
    from adm_pub.adm_pub_cst_nob_met_trx_sum_di  --贵金属交易整合表
    where dt <= '20231231'
    and nvl(cst_id,'')<>''   --客户号非空
    group by cst_id
)t3 on t1.cst_id=t3.cst_id
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_04_1 AS
SElECT '2024_所有' typ,cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_02
group by cst_seg_nm
order by cst_seg_nm
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_04_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_04_2 AS
SElECT '2024_所有' typ,'合计_人均'   as cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,sum(fnc_amt )/count(case when fnc_amt >0 then cst_id end)/10000  as fnc_amt_2024_all_avg
    ,sum(fund_amt)/count(case when fund_amt>0 then cst_id end)/10000  as fund_amt_2024_all_avg
    ,sum(insu_amt)/count(case when insu_amt>0 then cst_id end)/10000  as insu_amt_2024_all_avg
    ,sum(gold_amt_tot)/count(case when gold_amt_tot>0 then cst_id end)/10000  as gold_amt_tot_2024_all_avg
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_02
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_05_1 AS
SElECT '2024_新' typ,cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_02
where is_2024cst=1
group by cst_seg_nm
order by cst_seg_nm
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_05_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_05_2 AS
SElECT '2024_新' typ,'合计_人均'   as cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,sum(fnc_amt )/count(case when fnc_amt >0 then cst_id end)/10000  as fnc_amt_2024_all_avg
    ,sum(fund_amt)/count(case when fund_amt>0 then cst_id end)/10000  as fund_amt_2024_all_avg
    ,sum(insu_amt)/count(case when insu_amt>0 then cst_id end)/10000  as insu_amt_2024_all_avg
    ,sum(gold_amt_tot)/count(case when gold_amt_tot>0 then cst_id end)/10000  as gold_amt_tot_2024_all_avg
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_02
where is_2024cst=1
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_06_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_06_1 AS
SElECT '2023_所有' typ,cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_03
group by cst_seg_nm
order by cst_seg_nm
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_06_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_06_2 AS
SElECT '2023_所有' typ,'合计_人均'   as cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,sum(fnc_amt )/count(case when fnc_amt >0 then cst_id end)/10000  as fnc_amt_2024_all_avg
    ,sum(fund_amt)/count(case when fund_amt>0 then cst_id end)/10000  as fund_amt_2024_all_avg
    ,sum(insu_amt)/count(case when insu_amt>0 then cst_id end)/10000  as insu_amt_2024_all_avg
    ,sum(gold_amt_tot)/count(case when gold_amt_tot>0 then cst_id end)/10000  as gold_amt_tot_2024_all_avg
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_03
;
-- 输出结果4
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_07_1 AS
SElECT '2023_新' typ,cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_03
where is_2023cst=1
group by cst_seg_nm
order by cst_seg_nm
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121221_CST_07_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121221_CST_07_2 AS
SElECT '2023_新' typ,'合计_人均'   as cst_seg_nm
    ,sum(fnc_amt)/10000   as fnc_amt_2024_all
    ,sum(fund_amt)/10000  as fund_amt_2024_all
    ,sum(insu_amt)/10000  as insu_amt_2024_all
    ,sum(gold_amt_tot)/10000  as gold_amt_tot_2024_all
    ,sum(fnc_amt )/count(case when fnc_amt >0 then cst_id end)/10000  as fnc_amt_2024_all_avg
    ,sum(fund_amt)/count(case when fund_amt>0 then cst_id end)/10000  as fund_amt_2024_all_avg
    ,sum(insu_amt)/count(case when insu_amt>0 then cst_id end)/10000  as insu_amt_2024_all_avg
    ,sum(gold_amt_tot)/count(case when gold_amt_tot>0 then cst_id end)/10000  as gold_amt_tot_2024_all_avg
    ,count(case when fnc_amt >0 then cst_id end) as fnc_amt_custs_2024
    ,count(case when fund_amt>0 then cst_id end) as fund_amt_custs_2024
    ,count(case when insu_amt>0 then cst_id end) as insu_amt_custs_2024
    ,count(case when gold_amt_tot>0 then cst_id end) as gold_amt_tot_custs_2024
from SJXQ_SJ2024121221_CST_03
where is_2023cst=1
;
-- 结果查看
SELECT *
from SJXQ_SJ2024121221_CST_04_1
order by cst_seg_nm
;
SELECT *
from SJXQ_SJ2024121221_CST_04_2
;
SELECT *
from SJXQ_SJ2024121221_CST_05_1
order by cst_seg_nm
;
SELECT *
from SJXQ_SJ2024121221_CST_05_2
;
SELECT *
from SJXQ_SJ2024121221_CST_06_1
order by cst_seg_nm
;
SELECT *
from SJXQ_SJ2024121221_CST_06_2
;
SELECT *
from SJXQ_SJ2024121221_CST_07_1
order by cst_seg_nm
;
SELECT *
from SJXQ_SJ2024121221_CST_07_2
***SJ2024121261.sql
﻿-- 提取管户员工属于绍兴分行或机构客户管护在绍兴
DROP   TABLE IF     EXISTS SJXQ_SJ2024121261_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121261_CST_01 AS
select distinct t1.cst_id                         --客户号|C20
from edw.dim_cst_entp_bas_inf_dd   t1            --企业客户基本信息
left join edw.dwd_bus_dep_cst_act_mgr_inf_dd t2 --存款客户账户`管户`信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t2.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.acs_org_id=t4.org_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.org_id=t5.org_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and (t4.brc_org_nm='绍兴分行' or t5.brc_org_nm='绍兴分行')
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121261_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121261_CST_02 AS
SELECT  t1.cst_id        as 企业客户号
       ,t2.cst_nm        AS 企业名称
       ,t2.cntry_tax_nbr AS 国税证
       ,t2.lctax_cert_no AS 地税证件号
       ,t3.cst_act_id    AS 客户账号
       ,t3.mgr_id        AS 当前存款账号管户人工号
       ,t4.empe_nm       AS 当前存款账户管户人姓名
       ,t3.mgr_rto	     as 管护比例
       ,t3.acs_org_id    AS 当前存款账户管户人所属机构号
       ,t5.org_nm        AS 当前存款账户管户人所属机构名
from SJXQ_SJ2024121261_CST_01                t1
left join edw.dim_cst_entp_bas_inf_dd        t2 --企业客户基本信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_dep_cst_act_mgr_inf_dd t3 --存款客户账户`管户`信息
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t4 --员工信息汇总
on  t3.mgr_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.acs_org_id=t5.org_id
and t5.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121261_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ2024121261_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ2024121261_CST_02
;
SElECT *
from SJXQ_SJ2024121261_CST_02
where 客户账号='33070010202000000228'
***SJ20241222436_保险贵金属中收来源.sql
﻿--保险中收
DROP   TABLE IF     EXISTS SJXQ_SJ20241222436_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241222436_CST_01 AS
select replace(t1.TRX_DT,'-','') as trx_dt       --交易日期
	,t1.cst_id                                   --客户号
	,t1.insu_ord_nbr                             --投保单号
	,t1.insu_plcy_id                             --保单号
	,t1.insu_plcy_sts                            --保单状态
	,t1.cur_insu_plcy_sts_nm                     --新保单状态
	,t1.mng_cnv_insu_fee                         --管护折算保费
	,t1.mng_cnv_cmsn_fee  as INS_MID_INCM        --管护折算手续费
	,t1.mng_mgr_id                               --管护客户经理工号
	,t1.mng_mgr_nm                               --管护客户经理姓名
	,t1.mng_rto                                  --管护比例
	,t1.mng_org_id                               --管护机构号
	,t1.mng_org_nm                               --管护机构名称
	,t1.trx_sts                                  --交易状态
    ,t2.efe_loan_cst_ind as efe_loan_cst_2024       --有效贷款户标识
    ,case when nvl(t3.sam_rsk_ctrl_id,'')='' then t3.cst_id else t3.sam_rsk_ctrl_id end as sam_rsk_ctrl_id
    ,t4.brc_org_nm
    ,t5.efe_loan_cst_ind as efe_loan_cst_2022       --有效贷款户标识
    ,t6.efe_loan_cst_ind as efe_loan_cst_2023       --有效贷款户标识
from app_rpt.fct_insu_agn_bus_acs_dtl_tbl   t1 --保险代销业务考核明细表
left join adm_pub.adm_csm_cbas_ind_inf_dd   t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd 			t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mng_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_ind_inf_dd   t5 --客户基础标识信息
on t1.cst_id=t5.cst_id
and t5.dt='20221231'
left join adm_pub.adm_csm_cbas_ind_inf_dd   t6 --客户基础标识信息
on t1.cst_id=t6.cst_id
and t6.dt='20231231'
where t1.dt='@@{yyyyMMdd}'
AND replace(t1.TRX_DT,'-','') BETWEEN '20220101' and '@@{yyyyMMdd}'
AND t1.cur_insu_plcy_sts_nm<>'已失效'   --已失效 已生效 已终止 待生效
;
--贵金属中收
DROP   TABLE IF     EXISTS SJXQ_SJ20241222436_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241222436_CST_02 AS
select t1.ord_id                                   --订单号
	,t1.ord_tm                                   --订单时间
	,t1.cst_id                                   --客户号
	,t1.cmdt_pay_unt_prc                         --商品应付现金总额
	,t1.mid_inc_tot_amt   as GOD_MID_INCM        --佣金总额
	,t1.rcm_psn_id                               --推荐人工号
	,t1.rcm_psn_nm                               --推荐人姓名
	,t1.rcm_psn_afl_dept_id                      --推荐人所属部门/团队ID
	,t1.rcm_psn_afl_dept                         --推荐人所属部门/团队
	,t1.rcm_psn_afl_sub_brn                      --推荐人所属支行
	,t1.rcm_psn_afl_brn      as brc_org_nm       --推荐人所属分行
    ,t1.dt as trx_dt
    ,t2.efe_loan_cst_ind as efe_loan_cst_2024       --有效贷款户标识
    ,case when nvl(t3.sam_rsk_ctrl_id,'')='' then t3.cst_id else t3.sam_rsk_ctrl_id end as sam_rsk_ctrl_id
    ,t5.efe_loan_cst_ind as efe_loan_cst_2022       --有效贷款户标识
    ,t6.efe_loan_cst_ind as efe_loan_cst_2023       --有效贷款户标识
from adm_pub.adm_pub_cst_nob_met_trx_sum_di t1 --贵金属交易整合表
left join adm_pub.adm_csm_cbas_ind_inf_dd   t2 --客户基础标识信息
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd 			t3 --客户基础信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_ind_inf_dd   t5 --客户基础标识信息
on t1.cst_id=t5.cst_id
and t5.dt='20221231'
left join adm_pub.adm_csm_cbas_ind_inf_dd   t6 --客户基础标识信息
on t1.cst_id=t6.cst_id
and t6.dt='20231231'
WHERE   t1.dt BETWEEN '20220101' and '@@{yyyyMMdd}'
AND     t1.CMDT_PAY_UNT_PRC<>0 			--存在未付钱且有中收，需剔除
;
--保险中收结果表
DROP   TABLE IF     EXISTS SJXQ_SJ20241222436_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241222436_CST_03 AS
select t1.brc_org_nm            as 分行
    ,t3.INS_MID_INCM_2022       as 来源于有效贷款户_2022
    ,t3.INS_MID_INCM_sam_2022   as 来源于有效贷款户的同一风险控制号下非有效贷款户_剔除本人_2022
    ,t2.INS_MID_INCM_2023       as 来源于有效贷款户_2023
    ,t2.INS_MID_INCM_sam_2023   as 来源于有效贷款户的同一风险控制号下非有效贷款户_剔除本人_2023
    ,t1.INS_MID_INCM_2024       as 来源于有效贷款户_2024
    ,t1.INS_MID_INCM_sam_2024   as 来源于有效贷款户的同一风险控制号下非有效贷款户_剔除本人_2024
from(
    SElECT t1.brc_org_nm
        ,sum(case when t1.efe_loan_cst_2024='1' then t1.INS_MID_INCM else 0 end) as INS_MID_INCM_2024
        ,sum(case when t1.efe_loan_cst_2024<>'1' and sam_efe_loan_cst_2024='1' then t1.INS_MID_INCM else 0 end) as INS_MID_INCM_sam_2024
    from SJXQ_SJ20241222436_CST_01 t1
    left join(
        select sam_rsk_ctrl_id,max(efe_loan_cst_2024) as sam_efe_loan_cst_2024
        from SJXQ_SJ20241222436_CST_01
        where trx_dt between '20240101' and '20241224'
        group by sam_rsk_ctrl_id
    )t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    where t1.brc_org_nm like '%分行%'
    and t1.trx_dt between '20240101' and '20241224'
    group by t1.brc_org_nm
)t1 left join(
    SElECT t1.brc_org_nm
        ,sum(case when t1.efe_loan_cst_2023='1' then t1.INS_MID_INCM else 0 end) as INS_MID_INCM_2023
        ,sum(case when t1.efe_loan_cst_2023<>'1' and sam_efe_loan_cst_2023='1' then t1.INS_MID_INCM else 0 end) as INS_MID_INCM_sam_2023
    from SJXQ_SJ20241222436_CST_01 t1
    left join(
        select sam_rsk_ctrl_id,max(efe_loan_cst_2023) as sam_efe_loan_cst_2023
        from SJXQ_SJ20241222436_CST_01
        where trx_dt between '20230101' and '20231231'
        group by sam_rsk_ctrl_id
    )t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    where t1.brc_org_nm like '%分行%'
    and t1.trx_dt between '20230101' and '20231231'
    group by t1.brc_org_nm
)t2 on t1.brc_org_nm=t2.brc_org_nm
left join(
    SElECT t1.brc_org_nm
        ,sum(case when t1.efe_loan_cst_2022='1' then t1.INS_MID_INCM else 0 end) as INS_MID_INCM_2022
        ,sum(case when t1.efe_loan_cst_2022<>'1' and sam_efe_loan_cst_2022='1' then t1.INS_MID_INCM else 0 end) as INS_MID_INCM_sam_2022
    from SJXQ_SJ20241222436_CST_01 t1
    left join(
        select sam_rsk_ctrl_id,max(efe_loan_cst_2022) as sam_efe_loan_cst_2022
        from SJXQ_SJ20241222436_CST_01
        where trx_dt between '20220101' and '20221231'
        group by sam_rsk_ctrl_id
    )t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    where t1.brc_org_nm like '%分行%'
    and t1.trx_dt between '20220101' and '20221231'
    group by t1.brc_org_nm
)t3 on t1.brc_org_nm=t3.brc_org_nm
;
--贵金属中收结果表
DROP   TABLE IF     EXISTS SJXQ_SJ20241222436_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241222436_CST_04 AS
select t1.brc_org_nm            as 分行
    ,t3.GOD_MID_INCM_2022       as 来源于有效贷款户_2022
    ,t3.GOD_MID_INCM_sam_2022   as 来源于有效贷款户的同一风险控制号下非有效贷款户_剔除本人_2022
    ,t2.GOD_MID_INCM_2023       as 来源于有效贷款户_2023
    ,t2.GOD_MID_INCM_sam_2023   as 来源于有效贷款户的同一风险控制号下非有效贷款户_剔除本人_2023
    ,t1.GOD_MID_INCM_2024       as 来源于有效贷款户_2024
    ,t1.GOD_MID_INCM_sam_2024   as 来源于有效贷款户的同一风险控制号下非有效贷款户_剔除本人_2024
from(
    SElECT t1.brc_org_nm
        ,sum(case when t1.efe_loan_cst_2024='1' then t1.GOD_MID_INCM else 0 end) as GOD_MID_INCM_2024
        ,sum(case when t1.efe_loan_cst_2024<>'1' and sam_efe_loan_cst_2024='1' then t1.GOD_MID_INCM else 0 end) as GOD_MID_INCM_sam_2024
    from SJXQ_SJ20241222436_CST_02 t1
    left join(
        select sam_rsk_ctrl_id,max(efe_loan_cst_2024) as sam_efe_loan_cst_2024  --同一风险控制号下是否有有效贷款户
        from SJXQ_SJ20241222436_CST_02
        where trx_dt between '20240101' and '20241224'
        group by sam_rsk_ctrl_id
    )t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    where t1.brc_org_nm like '%分行%'
    and t1.trx_dt between '20240101' and '20241224'
    group by t1.brc_org_nm
)t1 left join(
    SElECT t1.brc_org_nm
        ,sum(case when t1.efe_loan_cst_2023='1' then t1.GOD_MID_INCM else 0 end) as GOD_MID_INCM_2023
        ,sum(case when t1.efe_loan_cst_2023<>'1' and sam_efe_loan_cst_2023='1' then t1.GOD_MID_INCM else 0 end) as GOD_MID_INCM_sam_2023
    from SJXQ_SJ20241222436_CST_02 t1
    left join(
        select sam_rsk_ctrl_id,max(efe_loan_cst_2023) as sam_efe_loan_cst_2023
        from SJXQ_SJ20241222436_CST_02
        where trx_dt between '20230101' and '20231231'
        group by sam_rsk_ctrl_id
    )t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    where t1.brc_org_nm like '%分行%'
    and t1.trx_dt between '20230101' and '20231231'
    group by t1.brc_org_nm
)t2 on t1.brc_org_nm=t2.brc_org_nm
left join(
    SElECT t1.brc_org_nm
        ,sum(case when t1.efe_loan_cst_2022='1' then t1.GOD_MID_INCM else 0 end) as GOD_MID_INCM_2022
        ,sum(case when t1.efe_loan_cst_2022<>'1' and sam_efe_loan_cst_2022='1' then t1.GOD_MID_INCM else 0 end) as GOD_MID_INCM_sam_2022
    from SJXQ_SJ20241222436_CST_02 t1
    left join(
        select sam_rsk_ctrl_id,max(efe_loan_cst_2022) as sam_efe_loan_cst_2022
        from SJXQ_SJ20241222436_CST_02
        where trx_dt between '20220101' and '20221231'
        group by sam_rsk_ctrl_id
    )t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
    where t1.brc_org_nm like '%分行%'
    and t1.trx_dt between '20220101' and '20221231'
    group by t1.brc_org_nm
)t3 on t1.brc_org_nm=t3.brc_org_nm
;
SElECT '01' seq, count(1) cnt,count(distinct insu_plcy_id) custs
from SJXQ_SJ20241222436_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ord_id) custs
from SJXQ_SJ20241222436_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 分行) custs
from SJXQ_SJ20241222436_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 分行) custs
from SJXQ_SJ20241222436_CST_04
;
-- 保险
SElECT '03' seq, * from SJXQ_SJ20241222436_CST_03;
-- 贵金属
SElECT '04' seq, * from SJXQ_SJ20241222436_CST_04;***SJ2024122781_客户各产品使用情况.sql
﻿-- 数据的时间是2023年1月至2024年9月30日
-- 客群 使用产品笔数、金额
-- SELECT cst_id,cst_chn_nm
-- FROM lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST
-- ;
-- 15.特约商户收单 包括在本行开立账户，或在他行开立账户由本行收单 泰惠收？
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_01 AS
SELECT t2.cst_id
    ,count(1)                    as tysh_cnt
    ,SUM(a.trx_pay_amt)/10000    AS  tysh_amt -- 订单金额
from edw.dws_bus_chnl_ths_ord_inf_di  a --泰惠收订单信息汇总
inner join edw.dws_bus_chnl_ths_mch_inf_dd b --泰惠收商户汇总信息
on a.frs_lvl_mch_id=b.mch_id and b.dt='20240930'
inner join lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t2
on b.stl_act_cst_id=t2.cst_id
WHERE a.dt >= '20230101'
AND a.dt <= '20240930'
AND a.trx_sts = '00'
group by t2.cst_id
;
-- 16.代发工资业务	与客户签订代发工资协议，为客户提供代发工资扣款、汇划服务
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_02 AS
SELECT  t2.cst_id
       ,COUNT(1)             AS dfgz_cnt
       ,SUM(a.trx_amt)/10000 AS dfgz_amt -- 交易金额
FROM edw.dwd_bus_dep_bal_chg_dtl_di a --存款账户余额发生明细
INNER JOIN edw.dws_bus_dep_act_inf_dd b --存款账户信息汇总
ON a.cst_act_id = b.cst_act_id AND b.dt = '20240930'
inner join lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t2
on b.cst_id=t2.cst_id
WHERE a.dt between '20230101' AND '20240930'
AND a.txt_code = 'DPW040' --代发工资
AND a.crd_and_dbt_ind = 'D'
group by t2.cst_id
;
-- 大额存款 名下所有账户年末存款余额超过100万元客户的合计存款余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_03 AS
SELECT  t1.cst_id
       ,COUNT(t1.DEP_ACT_ID)                                          AS act_num
       ,SUM(t3.GL_BAL)/10000                                                AS DEP_ACT_BAL
       ,SUM(COALESCE(ROUND(t3.gl_bal * t4.AVG_PRC / t4.QUO_UNT,2),0))/10000 AS DEP_ACT_BAL_RMB
FROM edw.DIM_BUS_DEP_ACT_INF_DD t1 --存款账户信息 DEP_ACT_ID 唯一
INNER JOIN lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t2
ON t1.cst_id = t2.cst_id
INNER JOIN edw.dws_bus_dep_act_acm_inf_dd t3 --存款账户余额累计汇总 DEP_ACT_ID 唯一
ON t1.DEP_ACT_ID = t3.DEP_ACT_ID AND t1.dt = t3.dt
INNER JOIN edw.DIM_BUS_COM_EXR_INF_DD t4
ON t3.CCY_CD = t4.CCY_CD AND t3.DT = t4.dt
WHERE t1.dt = '20240930'
GROUP BY  t1.cst_id
HAVING DEP_ACT_BAL_RMB > 100
;
-- 18.资管类产品余额 销售本行理财产品（含其他机构代销本行理财）余额 自营理财
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_04 AS
SELECT t1.CST_ID
    ,count(1) as trx_cnt
    ,sum(t1.CFM_AMT)/10000 as trx_amt --确认金额
FROM EDW.dwd_bus_chm_trx_cfm_dtl_di                     T1  --理财交易确认流水明细
INNER JOIN lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST    t2
ON t1.cst_id = t2.cst_id
where t1.dt between '20230101' AND '20240930'
and t1.TACD = 'TL'
and t1.CFM_AMT>0    --确认金额
and t1.bus_cd IN ( '122' , '130' ) -- 130 认购 122 申购
group by t1.CST_ID
;
-- 19.贵金属产品销售 包括销售本行发行或代理销售其他机构贵金属产品
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_05 AS
SELECT  t2.cst_id --客户号
       ,COUNT(1)                       AS gold_cnt
       ,SUM(t1.cmdt_pay_unt_prc)/10000 AS gold_amt --商品应付现金总额
FROM adm_pub.adm_pub_cst_nob_met_trx_sum_di t1 --贵金属交易整合表
INNER JOIN lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t2
ON t1.cst_id = t2.cst_id
WHERE t1.dt BETWEEN '20230101' AND '20240930'
group by t2.cst_id
;
-- 21 境内跨行转账汇款
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_06 AS
SELECT  t2.cst_id
       ,COUNT(1)                                                                  AS jnkh_zz_cnt
       ,SUM(( t.remit_amount * a2.avg_prc / 100 ) / ( a3.avg_prc / 100 )) / 10000 AS jnkh_zz_amt
FROM edw.niss_ormt_master t
INNER JOIN
(
	SELECT  dt
	       ,avg_prc --中间价
	       ,iso_ccy_cd --币种代码
	FROM edw.dim_bus_com_exr_inf_dd --汇率信息
	WHERE dt >= '20230101'
	AND dt <= '20240930'
) a2
ON REPLACE(substr(t.trans_date, 1, 10), '-', '') = a2.dt AND t.remit_ccy = a2.iso_ccy_cd
LEFT JOIN
(
	SELECT  dt
	       ,avg_prc --中间价
	FROM edw.dim_bus_com_exr_inf_dd --汇率信息
	WHERE ccy_cd = '156' --人民币
	AND dt >= '20230101'
	AND dt <= '20240930'
) a3
ON REPLACE(substr(t.trans_date, 1, 10), '-', '') = a3.dt
INNER JOIN lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t2
ON t.ord_id = t2.cst_id
WHERE t.dt = '20240930'
AND t.clearing_Channel = 'FMT'
AND t.is_Return = 'YES'
group by t2.cst_id
;
-- 数字人民币四类钱包
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_07_1 AS
select t1.wal_id                                   --钱包id
	,t1.cst_nm                                   --客户名称
	,t1.wal_typ_cd                               --钱包类型代码 01个人钱包 09对公钱包
	-- ,wal_grd_typ_cd                        --钱包等级类型代码 全空
    ,t1.doc_nbr,t1.doc_typ_cd
	,case when nvl(t1.cst_id,'')='' then t2.cst_id else t1.cst_id end cst_id --客户号 只有对公数据
	,t1.opn_dt                                   --开户日期|c8
	,t1.dstr_act_dt                              --销户日期|c8
	,t1.wal_sts_typ_cd                           --钱包状态类型代码 ,'1','正常','2','已注销'
from edw.dim_bus_chnl_dcep_wal_inf_dd   t1      --数字人民币钱包信息
left join edw.dws_cst_bas_inf_dd        t2
on t1.doc_nbr=t2.DOC_NBR
and t2.doc_typ_cd='B0101'
and t2.dt='20240930'
where t1.dt='20240930'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_07_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_07_2 AS
select t1.channel_date                             --渠道日期
	-- ,channel_serial                           --渠道流水号
	,t1.trans_type                               --1-充钱包 2-存银行 3-转账 4-互联互通充钱包 5-互联互通存银行 6-互联互通转账 7-个人汇款兑出  8-扫收款码支付
	-- ,subsys_busi_type                         --交易类型的细分：其中转账有如下细分 CD-卡账户 FC-人脸标记 TK-token QR-二维码 WT-钱包id PH-手机号 TO-碰一碰
	-- ,busi_date                                --账务日期
	-- ,host_customer_no                         --全行统一客户号 全空
	,t1.wallet_id                                --钱包id
	,t1.wallet_name                              --钱包名称
	-- ,wallet_type                              --钱包类型 全空
	-- ,wallet_level                             --钱包等级 全空
	,t1.opponent_acct                            --他行账号
	,t1.opponent_name                            --他行户名
	-- ,opponent_acct_type                       --对手账户类型 全空
	-- ,opponent_bank                            --他行行号 全空
	-- ,opponent_bank_name                       --他行行名 全空
	-- ,payee_mobile_no                          --收款人手机号码 94% 为空
	,t1.trans_amt                                --交易金额
	-- ,currency                                 --币种 全为 人名币
	,t1.trans_status                             --0-初始化 1-处理中 2-交易成功 3-交易失败 4-交易超时 5-支付中
    ,t2.cst_id,t2.cst_nm
    ,case when t1.opponent_name=t2.cst_nm then 1 else 0 end as is_sam_nm
from edw.dcep_bupps_wallet_exchange_serial  t1 --汇兑业务流水表
INNER JOIN SJXQ_SJ2024122781_CST_07_1       t2 --数字人民币钱包信息
on t1.wallet_id=t2.wal_id
WHERE   DT BETWEEN '20230101' AND '20240930'
AND     respcode = '00000' --交易成功
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_07 AS
SELECT  cst_id
       ,COUNT(1)             AS sjrmb_cnt
       ,SUM(trans_amt)/10000 AS sjrmb_amt
from SJXQ_SJ2024122781_CST_07_2
where is_sam_nm=0
GROUP BY cst_id
;
--信用卡
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_08 AS
SELECT  t2.cst_id
       ,COUNT(1)             AS xyk_cnt
       ,SUM(abs(a.trx_amt))/10000 AS xyk_amt -- 信用卡交易金额
FROM edw.dwd_bus_crd_cr_crd_trx_dtl_di a --信用卡客户交易流水
INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd a2 --信用卡卡片信息
ON a.cr_crd_card_nbr = a2.cr_crd_card_nbr AND a2.dt = '20240930'
INNER JOIN lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t2
ON a2.cst_id = t2.cst_id
WHERE a.dt >= '20230101'
AND a.dt <= '20240930'
GROUP BY  t2.cst_id
;
-- 个人网银 已开通且有效（激活）的个人网银（包括手机银行、Ukey、动态口令令牌等）工具的数量，同一账户开通多个有效网银工具的，累积计算
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_09 AS
SElECT t1.cst_id
    ,t2.cst_act_id,t2.dep_act_id,t3.dtl_seq_nbr
    ,t3.trx_dt
    ,t3.trx_amt
    ,t3.trx_amt*t4.cny_exr  as trx_amt_cny
    ,t3.trx_chnl_cd
from lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST t1
INNER JOIN    edw.dws_bus_dep_act_inf_dd    t2
ON      t1.cst_id = t2.cst_id
AND     t2.dt = '20240930'
INNER join edw.dwd_bus_dep_bal_chg_dtl_di   t3
on t2.cst_act_id=t3.cst_act_id
and t2.dep_act_id=t3.dep_act_id
and t3.dt BETWEEN '20230101' AND '20240930'
AND t3.bal_fld_nm = 'DPLDGBAL'
LEFT JOIN    EDW.DIM_BUS_COM_EXR_INF_DD     T4 --汇率表 CNY_EXR 折人民币汇率
ON      t3.trx_ccy_cd = T4.CCY_CD
and     t3.trx_dt=t4.dt     --交易日汇率
AND     T4.DT BETWEEN '20230101' and '20240930'
;
-- 保管箱 其中&ldquo;保管箱&rdquo;只对应&ldquo;开箱次数&rdquo;，无需&ldquo;笔数&rdquo;&ldquo;金额&rdquo;信息
-- DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_10 purge;
-- CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_10 AS
-- SELECT  '19'                           AS ind
--         ,count(DISTINCT t.tail_box_id) AS val --  柜员尾箱数量
-- FROM    edw.dwd_bus_chnl_cnt_tail_box_tlr_inf_dd t --柜员尾箱信息
-- WHERE   t.dt = '20240930'
-- 汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024122781_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122781_CST_11 AS
SELECT t0.cst_id,t0.cst_chn_nm
    ,t1.tysh_cnt           	as 特约商户收单笔数
    ,t1.tysh_amt            as 特约商户收单金额
    ,t2.dfgz_cnt            as 代发工资笔数
    ,t2.dfgz_amt            as 代发工资金额
    ,t3.act_num             as 大额存款笔数
    ,t3.DEP_ACT_BAL_RMB     as 大额存款余额
    ,t4.trx_cnt             as 资管产品_自营理财购买笔数
    ,t4.trx_amt             as 资管产品_自营理财购买金额
    ,t5.gold_cnt            as 贵金属购买笔数
    ,t5.gold_amt            as 贵金属购买金额
    ,t6.jnkh_zz_cnt         as 境内跨行转账笔数
    ,t6.jnkh_zz_amt         as 境内跨行转账金额
    ,t7.sjrmb_cnt           as 数字人民币异名交易笔数
    ,t7.sjrmb_amt           as 数字人民币异名交易金额
    ,t8.xyk_cnt             as 信用卡交易笔数
    ,t8.xyk_amt             as 信用卡交易金额
    ,t9.trx_cnt             as 网银交易笔数
    ,t9.trx_amt             as 网银交易金额
from lab_bigdata_dev.SJXQ_SJ2024122781_CSTLIST  t0
left join SJXQ_SJ2024122781_CST_01 t1 on t0.cst_id=t1.cst_id
left join SJXQ_SJ2024122781_CST_02 t2 on t0.cst_id=t2.cst_id
left join SJXQ_SJ2024122781_CST_03 t3 on t0.cst_id=t3.cst_id
left join SJXQ_SJ2024122781_CST_04 t4 on t0.cst_id=t4.cst_id
left join SJXQ_SJ2024122781_CST_05 t5 on t0.cst_id=t5.cst_id
left join SJXQ_SJ2024122781_CST_06 t6 on t0.cst_id=t6.cst_id
left join SJXQ_SJ2024122781_CST_07 t7 on t0.cst_id=t7.cst_id
left join SJXQ_SJ2024122781_CST_08 t8 on t0.cst_id=t8.cst_id
left join(
    SELECT cst_id
        ,count(1) as trx_cnt
        ,sum(trx_amt)/10000 as trx_amt
    from SJXQ_SJ2024122781_CST_09
    where is_wy=1
    GROUP BY cst_id
) t9 on t0.cst_id=t9.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_09
-- union all
-- SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
-- from SJXQ_SJ2024122781_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024122781_CST_11
;
SElECT '11' seq, *
from SJXQ_SJ2024122781_CST_11
;
/*
01	6640	6640
02	678	678
03	3919	3919
04	3361	3361
05	3053	3053
06	420	420
07	974	973
08	11108	11108
09	75497092	120556
11	156958	156958
*/***SJ20270730131_支行AUM分析.sql
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20240730131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240730131_CST_01 AS
select t1.cst_id,t1.age
    ,t2.aum_bal	        --客户综合金融资产(aum)
    ,t2.insu_amt	    --保险保费
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,case when t2.aum_bal>=100000 and t2.aum_bal<500000 then '1'
        when t2.aum_bal>=500000 and t2.aum_bal<1000000 then '2'
        when t2.aum_bal>=1000000 and t2.aum_bal<5000000 then '3'
        when t2.aum_bal>=5000000 then '4' else '' end aum_bal_grd
from adm_pub.adm_csm_cbas_idv_bas_inf_dd            t1 --对私客户基础信息
left join adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd	t2 --客户集市-业务信息-客户金融资产信息表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t1.age>=25
and t1.age<=70
;
DROP   TABLE IF     EXISTS SJXQ_SJ20240730131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20240730131_CST_02 AS
SELECT brc_org_nm       as 分行
    ,sbr_org_nm         as 支行
    ,sum(aum_bal)       as AUM余额总额
    ,sum(insu_amt)      as 现有保险AUM总额
    ,sum(case when aum_bal_grd='1' then 1 else 0 end)       客户数_10w_50w
    ,sum(case when aum_bal_grd='1' then aum_bal else 0 end) 余额总额_10w_50w
    ,sum(case when aum_bal_grd='2' then 1 else 0 end)       客户数_50w_100w
    ,sum(case when aum_bal_grd='2' then aum_bal else 0 end) 余额总额_50w_100w
    ,sum(case when aum_bal_grd='3' then 1 else 0 end)       客户数_100w_500w
    ,sum(case when aum_bal_grd='3' then aum_bal else 0 end) 余额总额_100w_500w
    ,sum(case when aum_bal_grd='4' then 1 else 0 end)       客户数_500w以上
    ,sum(case when aum_bal_grd='4' then aum_bal else 0 end) 余额总额_500w以上
from SJXQ_SJ20240730131_CST_01
group by brc_org_nm,sbr_org_nm
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20240730131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 分行) custs
from SJXQ_SJ20240730131_CST_02
***刘璐_SJ20241127111_宁波分行信贷客户风险分析.sql
***取数SQL-SJ2023120146-吴小薇-012115.sql
-- 开户机构为台州分行辖内（含总行营业部）的个人结算账户仍在代发的工资户（剔除行内员工及其亲属账户、剔除已销户数据）;
-- 工资户口径(各种渠道备注显示的工资等)：
-- 1.账户交易流水中有出现 交易柜员为&ldquo;WPSPGY&rdquo;的账户
-- 2.账户交易流水中&ldquo;摘要描述&rdquo;字段，有出现登记为&ldquo;代发工资&rdquo;、&ldquo;工资 &rdquo;的账户
-- 3.账户交易流水中&ldquo;备注&rdquo;字段，有出现&ldquo;代发工资&rdquo;或&ldquo;工资&rdquo;的账户
-- 账号、户名、开户机构、开户日期、客户号、客户身份证号、账户状态（含止付、非柜等情况）、代发工资机构，是否工资户标记
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxw_wxw_20231204_001 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxw_wxw_20231204_001 AS
SELECT  distinct
        T1.cst_act_id   as  账号
       ,T1.act_nm       as  户名
       ,T1.opn_org      as  开户机构编号
       ,T2.org_nm        AS  开户机构名称
       ,T2.sbr_org_nm    AS  开户支行名称
       ,T2.brc_org_nm    AS  开户分行
       ,T1.opn_dt       as  开户日期
       ,T1.cst_id       as  客户号
       ,SUBSTR(T3.doc_nbr,1,6)  as   客户身份证号前6位
       ,concat(substr(regexp_replace(T3.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.reg_adr,'\\s|,',''))-6,0)),'******')   户籍地址脱敏
       ,concat(substr(regexp_replace(T3.fml_adr,'\\s|,',''),1,greatest(length(regexp_replace(T3.fml_adr,'\\s|,',''))-6,0)),'******')   家庭地址脱敏
       ,T1.act_sts_cd    as  账户状态编号
       ,T19.cd_val_dscr  as  账户状态
       ,case when T6.cst_act_id is not null then '是'  else '否'  end   as 是否冻结
       ,case when T11.cst_act_id is not null then '是' else '否'  end   as 是否止付
       ,case when T12.cst_act_id is not null then '是' else '否'  end   as 是否关闭非柜面
       ,T13.cnt_pty_cst_act_id  AS 最近三个月代发工资交易对手账户
       ,T13.cnt_pty_act_nm      AS 最近三个月代发工资交易对手名称
       ,CASE  WHEN  T18.kehuhaoo  is null or  T18.kehuhaoo ='' THEN  '否'
              else  '是'  end AS  新柜面系统标签是否工资户
FROM  edw.dws_bus_dep_act_inf_dd  T1
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd  T2  ON  T1.opn_org=T2.org_id    and T2.dt='@@{yyyyMMdd}'
LEFT JOIN  edw.dws_cst_bas_inf_dd  T3          ON  T1.cst_id=T3.cst_id     and T3.dt='@@{yyyyMMdd}'
left join  (	 SELECT b1.*
				 FROM
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
                  FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                  WHERE   DT = '@@{yyyyMMdd}'
                  AND     NFRZ_IND = '0') b1 where b1.rn=1
             ) T6 --账户冻结登记
on T1.cst_act_id=T6.cst_act_id
left join  ( SELECT a1.*
			 FROM
                 (SELECT  *,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
                  FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                  WHERE   DT = '@@{yyyyMMdd}'
                  AND     NFRZ_IND = '0'  ) a1
                  where   a1.rn=1
             ) T11        --账户冻结登记
    on T1.cst_act_id=T11.cst_act_id
left join ( SELECT c1.*
		    FROM
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
                  FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
                  WHERE   DT = '@@{yyyyMMdd}'
                  AND     ACT_THRS_TYP = '2'      --暂停非柜面
				  and     evt_id='DPDRAW') c1 where c1.rn=1
             ) T12 --账户额度控制
on     T1.cst_act_id=T12.cst_act_id
left join (
    SELECT  DISTINCT
             A.cst_act_id
            ,T1.cnt_pty_cst_act_id
            ,T1.cnt_pty_act_nm
    from edw.DIM_BUS_DEP_ACT_INF_DD              A
    left  JOIN  edw.DWD_BUS_DEP_BAL_CHG_DTL_DI   T1     on   A.cst_act_id=T1.cst_act_id   and   A.dep_act_id=T1.dep_act_id  and   T1.dt>='20230901'
    where A.dt='@@{yyyyMMdd}'
    AND  A.BAL_GL_IND <> '0'    -- 剔除虚拟户
    AND  A.STL_ACT_IND = '1'    -- 结算账户
    AND  T1.crd_and_dbt_ind='C'
    AND  (A.opn_org like  '3301%' or  A.opn_org like  '9999%')
    AND  (T1.opr_tlr='WPSPGY' or smr_dscr REGEXP  '代发工资|工资' or cmt REGEXP '代发工资|工资')
)   T13  on  T1.cst_act_id=T13.cst_act_id
left join  edw.core_kcpb_zhbzxx   T18   ON  T1.cst_id=T18.kehuhaoo and  T18.dt='@@{yyyyMMdd}'
left join  (
     select  cd_val,cd_val_dscr
     from    edw.dwd_code_library_dd
     where   dt='@@{yyyyMMdd}'
     and     cd_nm like '%存款账户状态%'
     AND     tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
      )   T19  on T1.act_sts_cd=T19.cd_val
where T1.dt='@@{yyyyMMdd}'
AND   T1.BAL_GL_IND <> '0'    -- 剔除虚拟户
AND   T1.STL_ACT_IND = '1'
AND  (T1.opn_org like  '3301%' or  T1.opn_org like  '9999%')
AND  T1.cst_id   not in
(
    select  distinct cst_id
    from   edw.dim_cst_idv_bas_inf_dd t5
    where  t5.dt='@@{yyyyMMdd}'
    and    length(t5.own_emp_id)>0    -- 本行员工号
    union
    SELECT
    DISTINCT  c2.cst_id
    from     edw.dim_hr_empe_invl_pty_inf_dd c1   --员工家庭成员与关联人信息
    inner join edw.dws_cst_bas_inf_dd        c2 on c1.invl_pty_id_card_id=c2.doc_nbr  --身份证关联
    and   c2.dt='@@{yyyyMMdd}'
    where c1.dt='@@{yyyyMMdd}'
)
and  T13.cst_act_id is not null
;  -- 结算账户
SELECT *
FROM  lab_bigdata_dev.tmp_yxw_wxw_20231204_001
SELECT count(1)  as a
FROM  lab_bigdata_dev.tmp_yxw_wxw_20231204_001
***取数代码-SJ2023111381--伍晶晶--017738.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 杨相伟
-- 创建日期: 2023-11-14 17:09:44
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
-- 客户号、客户名称，客户性别、客户年龄、开户网点，职业、账户状态、开户日期、销户日期、管控措施、管控日期、管控原因、管户客户经理、调额日期、客户价值等级、工作单位
-- 添加字段：10月31号的非柜额度；当前非柜额度；-- 小鱼管家--客户价值等级/FTP;
--                  降低非柜；止付类型；
-- 销户日期是客户账号的销户日期，剔除18991231
-- 管控措施：关闭非柜面，止付，否
-- 管控日期：关闭非柜面日期，止付日期
-- 管护经理：存款管户客户经理名称
-- 关联字段都是客户账号
-- 结算账户限制
-- 账户状态是存款账户状态还是客户账号状态
DROP TABLE IF EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw AS
select distinct  T1.cst_id        as  客户号
,t1.cst_act_id       as   客户账号
,t1.act_nm           as   账户名称
,A1.cd_val_dscr      as   性别
,t2.age              as   年龄
,t4.sbr_org_id       as   客户账号支行层级机构编号
,t4.sbr_org_nm       as   客户账号支行层级机构名称
,t4_1.sbr_org_id     as   存款账号支行层级机构编号
,t4_1.sbr_org_nm     as   存款账号支行层级机构名称
,A2.cd_val_dscr      as   职业
,t1.cd_val_dscr      as   存款账号状态代码
,t1.opn_dt           as   存款账号开户日期
,t1.act_dstr_act_dt  as   存款账号销户日期
,A3.cd_val_dscr      as   客户账号账户状态
,t3.opn_dt           as   客户账号开户日期
,t3.dstr_act_dt      as   客户账号销户日期
,case when T12.cst_act_id is not null then '是' else '否' end  as 是否关闭非柜面
,T12.lmt_cmt     as 关闭非柜面原因
,t12.lmt_eft_dt  as  关闭非柜面日期
,case when T11.cst_act_id is not null then '是' else '否' end  as 是否止付
,T11.frz_dt      AS  止付日期
,T11.act_stop_pmt_typ_cd   AS  止付类型代码
,a11.cd_val_dscr     AS    止付类型
,T11.frz_cls_cd   AS  止付种类代码
,A8.cd_val_dscr   as  止付种类
,T11.frz_rsn      as  止付原因
,T5.mgr_id        as  存款管户客户经理编号
,T6.empe_nm       as  存款管户客户经理名称
,T8.ACCP_DT       as  调额日期
-- ,t77.cst_val_grd   as   客户价值等级
,t7.cur_year_ftp_inc   AS  当年FTP利润收入
,t2.job_unt_nm    as   工作单位名称
,CASE  WHEN  T18.kehuhaoo  is null or  T18.kehuhaoo ='' THEN  '否'
            else  '是'  end AS  新柜面标签是否工资户
FROM  (select  distinct t1.cst_id        --客户号
,t1.dep_act_id          --存款账号
,t1.cst_act_id          --客户账号
,t1.act_nm              --账户名称
,t2.cd_val_dscr         --存款账户状态代码
,t1.opn_dt              --开户日期
,t1.act_dstr_act_dt     --销户日期
,t1.opn_org             --开户机构编号
from  edw.dws_bus_dep_act_inf_dd    t1  -- 存款账户信息汇总
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm ='ACT_STS_CD'
    and     tbl_nm='DWS_BUS_DEP_ACT_INF_DD'
)   t2
on  t1.act_sts_cd = t2.cd_val
WHERE   t1.STL_ACT_IND = '1' --结算账户
AND     t1.DT = '20231031'
and     t1.opn_org like '3305%'
and     t1.cst_tp = '1'  )  T1
left join  adm_pub.adm_csm_cbas_idv_bas_inf_dd  T2   --客户集市-客户基础-对私客户基础信息
ON  T1.cst_id =T2.cst_id
and T2.dt='@@{yyyyMMdd}'
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='GDR_CD'
    --and     tbl_nm='ADM_CSM_CBAS_IDV_BAS_INF_DD'
) A1  on   T2.gdr_cd=A1.cd_val
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='OCP_CD'
    --and    tbl_nm='ADM_CSM_CBAS_IDV_BAS_INF_DD'
) A2
on   T2.ocp_cd=A2.cd_val
left join  edw.dim_bus_dep_cst_act_inf_dd   t3  --客户存款账户信息
on t1.cst_act_id = t3.cst_act_id
and t3.dt = '20231031'
and t3.dstr_act_dt <> '18991231'
left join (
    select  cd_val,cd_val_dscr
    from    edw.dwd_code_library_dd
    where   dt='@@{yyyyMMdd}'
    AND     fld_nm='ACT_STS_CD'
    and    tbl_nm='DIM_BUS_DEP_CST_ACT_INF_DD'
) A3
on  t3.act_sts_cd = A3.cd_val
left join edw.dim_hr_org_mng_org_tree_dd   t4     --机构树_考核维度
on t3.opn_org_id =  t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd   t4_1     --机构树_考核维度
on t1.opn_org =  t4_1.org_id
and t4_1.dt = '@@{yyyyMMdd}'
left join  ( SELECT a1.*
			 from
                 (SELECT  *,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
                  FROM    edw.dwd_bus_dep_frz_inf_dd --账户冻结登记
                  WHERE   DT = '20231031'
                  AND     NFRZ_IND = '0'  ) a1
                  where   a1.rn=1
             ) T11        --账户冻结登记
    on T1.cst_act_id=T11.cst_act_id
left join (select *
          from edw.dwd_code_library_dd
          where dt='@@{yyyyMMdd}'
          and tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
          and fld_nm='FRZ_CLS_CD') A8
    on T11.frz_cls_cd=A8.cd_val
left  JOIN  (
    select cd_val,cd_val_dscr
    from  edw.dwd_code_library_dd
    where  dt='@@{yyyyMMdd}'
    AND    fld_nm='ACT_STOP_PMT_TYP_CD'
    AND    tbl_nm='DWD_BUS_DEP_FRZ_INF_DD') a11   on T11.ACT_STOP_PMT_TYP_CD=a11.cd_val
left join ( SELECT c1.*
		    from
                 (SELECT  *,ROW_NUMBER() over(partition by cst_act_id order by lmt_eft_dt desc) rn
                 FROM    edw.dwd_bus_dep_act_lmt_inf_dd  --账户额度控制
                 WHERE   DT = '20231031'
                 AND     ACT_THRS_TYP = '2'      --暂停非柜面
				 and evt_id='DPDRAW') c1 where c1.rn=1
             ) T12 --账户额度控制
on     T1.cst_act_id=T12.cst_act_id
left JOIN  edw.dwd_bus_dep_cst_act_mgr_inf_dd    T5     --客户存款账户管护信息
 ON  T1.cst_act_id =T5.cst_act_id
 and T5.dt='@@{yyyyMMdd}'
 and T5.frs_ctc_ind = '1'
left join  edw.dws_hr_empe_inf_dd          T6        --员工汇总信息
  ON  T5.mgr_id=T6.empe_id     and  T6.dt='@@{yyyyMMdd}'
-- left  join adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd     t77    --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
-- on   t1.cst_id = t77.cst_id
-- and  t77.dt='20230410'
left  join adm_pub.adm_csm_cbus_ftp_inf_dd   t7
on   t1.cst_id = t7.cst_id
and  T7.dt='@@{yyyyMMdd}'
left JOIN (
    select ACCT_NO
          ,ACCP_DT
          ,channel_code
          ,row_number() over(partition by ACCT_NO order by ACCP_DT desc)  as rn
    from  edw.qdrh_aecip_rmc_modifylimitflow    --非柜面限额维护登记表
    where dt >= '20200101'
    and MAINTAIN_TYPE='1'
)  T8
on   T1.cst_act_id=T8.ACCT_NO
and  T8.rn=1
left join  edw.core_kcpb_zhbzxx   T18    --账户备注信息
ON  T1.cst_id = T18.kehuhaoo
and  T18.dt='@@{yyyyMMdd}'
;
----职业：'企业负责人','个体户','销售人员','会计专业人员'
DROP TABLE IF EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_zhiye_inf_20231114_yxw ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_zhiye_inf_20231114_yxw AS
select  客户号
,客户账号
,账户名称
,性别
,年龄
,客户账号支行层级机构编号
,客户账号支行层级机构名称
,存款账号支行层级机构编号
,存款账号支行层级机构名称
,职业
,存款账号状态代码
,存款账号开户日期
,存款账号销户日期
,客户账号账户状态
,客户账号开户日期
,客户账号销户日期
,是否关闭非柜面
,关闭非柜面原因
,关闭非柜面日期
,是否止付
,止付日期
,止付类型代码
,止付类型
,止付种类代码
,止付种类
,止付原因
,存款管户客户经理编号
,存款管户客户经理名称
,调额日期
,当年FTP利润收入
-- ,客户价值等级
,工作单位名称
from  lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw
;
SELECT *
FROM   lab_bigdata_dev.wenzhoufh_ckzh_cst_zhiye_inf_20231114_yxw
SELECT *
FROM   lab_bigdata_dev.wenzhoufh_ckzh_cst_tichu_6yue_jioayi_inf_20231114_yxw
----近6个月未发生交易（除计息）
DROP TABLE IF EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_tichu_6yue_jioayi_inf_20231114_yxw ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_tichu_6yue_jioayi_inf_20231114_yxw AS
select  客户号
,客户账号
,账户名称
,性别
,年龄
,客户账号支行层级机构编号
,客户账号支行层级机构名称
,存款账号支行层级机构编号
,存款账号支行层级机构名称
,职业
,存款账号状态代码
,存款账号开户日期
,存款账号销户日期
,客户账号账户状态
,客户账号开户日期
,客户账号销户日期
,是否关闭非柜面
,关闭非柜面原因
,关闭非柜面日期
,是否止付
,止付日期
,止付类型代码
,止付类型
,止付种类代码
,止付种类
,止付原因
,存款管户客户经理编号
,存款管户客户经理名称
,调额日期
,当年FTP利润收入
-- ,客户价值等级
,工作单位名称
from  lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw
where 客户账号  not  in ( SELECT  A3.cst_act_id
FROM edw.dwd_bus_dep_bal_chg_dtl_di  A3   --近6个月及以上除计息以外的交易    --存款账户余额发生明细
WHERE  A3.dt between '20230501' and  '20231031'
 GROUP BY      A3.cst_act_id  )
;
SELECT DISTINCT 新柜面标签是否工资户
FROM   lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw
SELECT *
FROM   lab_bigdata_dev.wenzhoufh_ckzh_cst_gongzihu_inf_20231114_yxw
----工资卡
DROP TABLE IF EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_gongzihu_inf_20231114_yxw ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_gongzihu_inf_20231114_yxw AS
select  客户号
,客户账号
,账户名称
,性别
,年龄
,客户账号支行层级机构编号
,客户账号支行层级机构名称
,存款账号支行层级机构编号
,存款账号支行层级机构名称
,职业
,存款账号状态代码
,存款账号开户日期
,存款账号销户日期
,客户账号账户状态
,客户账号开户日期
,客户账号销户日期
,是否关闭非柜面
,关闭非柜面原因
,关闭非柜面日期
,是否止付
,止付日期
,止付类型代码
,止付类型
,止付种类代码
,止付种类
,止付原因
,存款管户客户经理编号
,存款管户客户经理名称
,调额日期
,当年FTP利润收入
-- ,客户价值等级
,工作单位名称
,新柜面标签是否工资户
from  lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw
where  新柜面标签是否工资户 = '是'
;
SELECT *
FROM   lab_bigdata_dev.wenzhoufh_ckzh_cst_ths_inf_20231114_yxw
----泰惠收
DROP TABLE IF EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_ths_inf_20231114_yxw ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.wenzhoufh_ckzh_cst_ths_inf_20231114_yxw AS
select  客户号
,客户账号
,账户名称
,性别
,年龄
,客户账号支行层级机构编号
,客户账号支行层级机构名称
,存款账号支行层级机构编号
,存款账号支行层级机构名称
,职业
,存款账号状态代码
,存款账号开户日期
,存款账号销户日期
,客户账号账户状态
,客户账号开户日期
,客户账号销户日期
,是否关闭非柜面
,关闭非柜面原因
,关闭非柜面日期
,是否止付
,止付日期
,止付类型代码
,止付类型
,止付种类代码
,止付种类
,止付原因
,存款管户客户经理编号
,存款管户客户经理名称
,调额日期
,当年FTP利润收入
-- ,客户价值等级
,工作单位名称
from  lab_bigdata_dev.wenzhoufh_ckzh_cst_inf_20231114_yxw   t1
inner join  edw.dim_bus_chnl_ths_ctr_inf_dd   t2
on  t1.客户账号 = t2.stl_act_id
and  t2.dt = '20231031'
;
***吴小薇_SJ2024112726_客户反诈提醒.sql
﻿/*
客户类型：1.取现5万以上客户；2.&ldquo;频繁大额转账客户&rdquo;（单笔金额超过人民币10万元、月内转账累计超过50万元的客户）
3.银证转账签约客户；4.更换银行卡电话绑定客户
时间区间：20241001-20241127；银证转账签约客户为辖内存量签约客户
机构：台州分行辖内支行（含总行营业部）
数据需求字段
账号、户名、开户机构、客户号、地区、手机号码、 业务相关情况（转账日期、转账金额、转账用途、取现金额等）、经办机构、经办人员
*/
-- 取现5万以上客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_01 AS
SELECT a.dep_act_id,a.cst_act_id,a.trx_dt
    ,a.trx_amt      --柜面现金交易金额
    ,a.txt_code
    ,a.smr_dscr
    ,a.cmt
    ,a.trx_bus_org	--	交易营业机构|C12
    ,a.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,b.cst_id	--客户号|C20
    ,b.act_nm	--账户名称|C300
    ,b.opn_org	--开户机构编号|C12
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id
and b.dt='20241127'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(a.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241127'
where a.dt between '20241001' and '20241127'
AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
and a.crd_and_dbt_ind='D'
and a.csh_ind='0' --0:现金;1:转账
and a.trx_amt > 50000   --5万以上
-- and a.trx_chnl_cd='A01' --交易渠道柜面
-- and a.TXT_CODE <> 'DP2137'  --无卡
;
--单笔金额超过人民币10万元
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_02 AS
SELECT a.dep_act_id,a.cst_act_id,a.trx_dt
    ,a.trx_amt      --柜面现金交易金额
    ,a.txt_code
    ,a.smr_dscr
    ,a.cmt
    ,a.trx_bus_org	--	交易营业机构|C12
    ,a.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,b.cst_id	--客户号|C20
    ,b.act_nm	--账户名称|C300
    ,b.opn_org	--开户机构编号|C12
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id
and b.dt='20241127'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(a.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241127'
where a.dt between '20241001' and '20241127'
AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
and a.crd_and_dbt_ind='D'
and a.csh_ind='1' --0:现金;1:转账
and a.trx_amt > 100000   --10万以上
;
-- 月内转账累计超过50万元
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_03 AS
SELECT b.cst_id	--客户号|C20
    ,substr(a.trx_dt,1,6) as trx_mon
    ,sum(a.trx_amt) as trx_amt      --柜面现金交易金额
    ,row_number() over(partition by b.cst_id order by sum(a.trx_amt) desc) rn
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join(
    select distinct cst_id,dep_act_id
    from SJXQ_SJ2024112726_CST_02   --单笔金额超过人民币10万元
)b on a.dep_act_id=b.dep_act_id
where a.dt between '20241001' and '20241127'
and a.crd_and_dbt_ind='D'
and a.csh_ind='1' --0:现金;1:转账
group by b.cst_id,trx_mon
having sum(a.trx_amt) > 500000
;
-- 客户手机号及地区
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_04 AS
SElECT t1.cst_id
    ,t1.CST_TYP_CD
    ,t1.mbl_nbr	    --	手机号码
    ,t1.FML_TEL_NBR --家庭电话
    ,t1.CMP_TEL_NBR --公司电话
    ,SUBSTR(t1.DOC_NBR,1,6) as DOC_NBR_6
    ,t3.region_cd	--	客户所属地区
    ,c3.CD_VAL_DSCR     as 客户所属地区
    ,t1.REG_ADR
    ,concat(substr(regexp_replace(T1.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T1.reg_adr,'\\s|,',''))-6,0)),'******') as reg_adr_jm
    -- ,T2.CTY_LVL_ID_CD AS native_cty_cd
    -- ,C1.CD_VAL_DSCR   AS 户籍地所在市
    -- ,T2.CNR_LVL_ID_CD AS native_CNR_cd
    -- ,C2.CD_VAL_DSCR   AS 户籍地所在区县
from edw.dws_cst_bas_inf_dd 	t1		    --客户基础信息汇总表
-- LEFT JOIN EDW.DIM_CST_BAS_PHY_ADR_INF_DD    T2 --客户物理地址信息
-- ON T1.CST_ID = T2.CST_ID
-- AND T2.DT = '20241127'
-- AND T2.PHY_ADR_TYP_CD = '050100' --户籍地址
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C1 -- 码值表
-- ON T2.CTY_LVL_ID_CD = C1.CD_VAL
-- AND C1.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
-- AND C1.FLD_NM = 'CTY_DTRCT_DVD_CD' --市
-- AND C1.DT = '20241127'
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD C2 -- 码值表
-- ON T2.CNR_LVL_ID_CD = C2.CD_VAL
-- AND C2.TBL_NM = 'DIM_CST_OUT_CMN_ADR_STDZ_ADR_TXT_RTR_ALL_DD'
-- AND C2.FLD_NM = 'AREA_OR_CNR_DTRCT_DVD_CD' --区县
-- AND C2.DT = '20241127'
left join adm_upss.l_cust_all   t3 --全量客户表
on t1.cst_id=t3.cust_id
and t3.dt='20241127'
left join EDW.DWD_CODE_LIBRARY_DD C3 -- 码值表
on case when nvl(t3.region_cd,'')<>'' then t3.region_cd else SUBSTR(t1.DOC_NBR,1,6) end=c3.cd_val
and  C3.DT = '20241127'
AND  C3.FLD_NM = 'CITY' --区县
AND  C3.TBL_NM = 'CUSTOMER_ADDRESS'
where t1.dt='20241127'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_05 AS
SELECT  t1.cst_act_id           AS 客户账号
       ,t1.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t1.cst_id               AS 客户号
       ,COALESCE(t2.客户所属地区,t2.reg_adr_jm)         AS 客户所属地区
       ,t2.mbl_nbr              AS 手机号码
       ,t2.FML_TEL_NBR          AS 家庭电话
       ,t2.CMP_TEL_NBR          AS 公司电话
       ,decode(t2.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t1.trx_dt               AS 取现日期
       ,t1.trx_amt              AS 现金交易金额
       ,t1.smr_dscr             AS 摘要描述
       ,t1.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t1.opr_tlr,t1.opr_tlr_nm)            AS 操作柜员
from SJXQ_SJ2024112726_CST_01       t1
left join SJXQ_SJ2024112726_CST_04  t2
on t1.cst_id=t2.cst_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '20241127'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t1.trx_bus_org = t5.org_id
and t5.dt = '20241127'
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_06 AS
SELECT  t2.cst_act_id           AS 客户账号
       ,t2.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t2.cst_id               AS 客户号
       ,COALESCE(t3.客户所属地区,t3.reg_adr_jm)          AS 客户所属地区
       ,t3.mbl_nbr              AS 手机号码
       ,t3.FML_TEL_NBR          AS 家庭电话
       ,t3.CMP_TEL_NBR          AS 公司电话
       ,decode(t3.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t2.trx_dt               AS 转账日期
       ,t2.trx_amt              AS 单笔转账金额
       ,t1.trx_mon              AS 月转账超50万月份
       ,t1.trx_amt              AS 月转账超50万金额
       ,t2.smr_dscr             AS 摘要描述
       ,t2.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t2.opr_tlr,t2.opr_tlr_nm)           AS 操作柜员
from SJXQ_SJ2024112726_CST_03       t1
left join SJXQ_SJ2024112726_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024112726_CST_04  t3
on t1.cst_id=t3.cst_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = '20241127'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t2.trx_bus_org = t5.org_id
and t5.dt = '20241127'
where t1.rn=1
;
/*
银转证
-- ods表	对应的模型层表
-- odps.edw.ifts_tbstandardtrans	odps.edw.dwd_bus_cpt_p2p_sbj_mat_trx_srl_di     P2P标的交易流水表
-- odps.edw.ifts_tbclientyzzz_05	odps.edw.dwd_bus_cpt_p2p_cst_act_rel_dd         P2P客户银证关系表
*/
-- 签约银转证客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_07 AS
select t1.doc_nbr
    ,t1.cst_ctg_cd --客户类别 0个人
    ,t1.ctr_dt
    ,t1.cst_nm
    ,t2.cst_id
    ,t2.CST_CHN_NM
    ,t2.mbl_nbr	    --	手机号码
    ,t2.FML_TEL_NBR --家庭电话
    ,t2.CMP_TEL_NBR --公司电话
    ,t3.cst_act_id
    ,t3.dep_act_id
    ,t3.act_nm          --账户名称
    ,t4.sbr_org_nm      --开户分行
    ,t4.org_nm          --开户机构
    ,ROW_NUMBER() over(partition by t1.doc_nbr order by t1.ctr_dt desc) rn
from edw.dwd_bus_cpt_p2p_cst_act_rel_dd t1
INNER JOIN edw.dws_cst_bas_inf_dd 	    t2		    --客户基础信息汇总表
on t1.doc_nbr=t2.DOC_NBR
-- and t1.doc_typ_cd=t2.doc_typ_cd 不一样
and t2.dt='20241127'
INNER JOIN edw.dws_bus_dep_act_inf_dd   t3 --存款账户信息汇总
on t2.cst_id=t3.cst_id
and t3.dt='20241127'
AND   (t3.opn_org like  '3301%' or  t3.opn_org like  '9999%') --台州分行、总行营业部
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.opn_org = t4.org_id
and t4.dt = '20241127'
where t1.dt='20241127'
and t1.cst_sts_cd='0' --只取 0,5
;
-- 输出结果3 账号、户名、开户机构、客户号、手机号码、电话号码
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_08 AS
SELECT distinct cst_act_id             AS 客户账号
    ,act_nm                            AS 账户名称
    ,sbr_org_nm                        AS 开户支行
    ,org_nm                            AS 开户机构
    ,ctr_dt                            AS 签约日期
    ,cst_id                            AS 客户号
    ,decode(cst_ctg_cd, '0', '个人', '对公') AS 客户类别 -- 0个人
    ,mbl_nbr                           AS 手机号码
    ,FML_TEL_NBR                       AS 家庭电话
    ,CMP_TEL_NBR                       AS 公司电话
from SJXQ_SJ2024112726_CST_07
where rn=1
;
-- 更换手机号客户
-- 更换手机号：客户最近一次更新日期在 20241001-20241127 且 有2个手机号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_09 AS
SELECT t.*
    ,row_number() over(partition by cip_cstno order by cip_phoneupdtime desc) rn
from(
    select distinct t1.cip_cstno                     --客户号
        ,t1.cip_namecn                               --客户姓名
        ,t1.cip_checkmobile                          --绑定手机号码
        ,t1.cip_phoneupdtime                         --绑定手机号修改时间
    from edw.ebnk_pb_cstinf_main   t1               --个人客户信息表
    INNER JOIN (
        SELECT DISTINCT cst_id
        from edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
        where dt='20241127'
        AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
    )t2 on t1.cip_cstno=t2.cst_id
    where t1.dt<='20241127'
    and nvl(t1.cip_checkmobile,'')<>''
)t
;
-- 更换手机号客户所有交易记录 9.30日
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_10 AS
SElECT t1.cip_cstno as cst_id
        ,t1.cip_checkmobile                          --绑定手机号码
        ,t1.cip_phoneupdtime                         --绑定手机号修改时间
from SJXQ_SJ2024112726_CST_09   t1
inner join(
    SElECT cip_cstno
    from SJXQ_SJ2024112726_CST_09
    group by cip_cstno having count(distinct cip_checkmobile)>1
)t2 on t1.cip_cstno=t2.cip_cstno
where t1.rn=1
and substr(t1.cip_phoneupdtime,1,8)>='20241001'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112726_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112726_CST_11 AS
SELECT  t1.cst_id                     AS 客户号
       ,t1.cip_checkmobile            AS 绑定手机号码
       ,t1.cip_phoneupdtime           AS 绑定手机号修改时间
       ,t2.cst_act_id                 AS 客户账号
       ,t2.act_nm                     AS 账户名称
       ,t4.sbr_org_nm                 AS 开户支行
       ,t4.org_nm                     AS 开户机构
       ,t3.trx_dt                     AS 交易时间
       ,t3.crd_and_dbt_ind            AS 借贷标志
       ,t3.trx_amt                    AS 交易金额
       ,t3.smr_dscr                   AS 交易摘要
       ,t3.cmt                        AS 备注
       ,t5.org_nm                     AS 交易营业机构
       ,concat(t3.opr_tlr,c1.empe_nm) AS 操作柜员
from SJXQ_SJ2024112726_CST_10 t1
left join edw.dws_bus_dep_act_inf_dd   t2 --存款账户信息汇总
on  t1.cst_id=t2.cst_id
and t2.dt='20241127'
left join edw.dwd_bus_dep_bal_chg_dtl_di t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.dt between '20241001' and '20241127'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = '20241127'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(t3.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241127'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.trx_bus_org = t5.org_id
and t5.dt = '20241127'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112726_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112726_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112726_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112726_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112726_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112726_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112726_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112726_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct cip_cstno) custs
from SJXQ_SJ2024112726_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112726_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112726_CST_11
***吴小薇_SJ20241212131_反诈提醒.sql
﻿/*
客户类型：
1.取现5万以上客户；
2.&ldquo;频繁大额转账客户&rdquo;（单笔金额超过人民币10万元、月内转账累计超过50万元的客户）
3..更换银行卡电话绑定客户；
上述3条取数的时间区间：20241128-取数当下；
4.近3个月发生过向陌生账户转账的对公客户，陌生账户？陌生账号：近两年转账过的账号都不是陌生账号
5.45周岁以上、客户价值等级V3的个人；V3以上
6.职业为企事业单位负责人的女性客户（数据中需包含是否签约理账）
机构：台州分行辖内支行（含总行营业部）
数据需求字段
账号、户名、开户机构、客户号、地区、手机号码、 业务相关情况（转账日期、转账金额、转账用途、取现金额等）、经办机构、经办人员、客户价值等级、理财签情况
*/
-- 客户价值
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_khjz purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_khjz AS
SELECT  t1.cst_id
    ,t1.cst_val_type as cst_val_l1y
    ,t2.cst_val_type as cst_val_c1m
    ,t3.cst_val_type as cst_val_c3m
    ,t4.cst_val_type as cst_val_c1y
FROM app_ado.adm_subl_cst_bus_inf_dd_khjz       t1
left join app_ado.adm_subl_cst_bus_inf_dd_khjz  t2
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and t2.stat_dim = '当月'
left join app_ado.adm_subl_cst_bus_inf_dd_khjz  t3
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
and t3.stat_dim = '当季'
left join app_ado.adm_subl_cst_bus_inf_dd_khjz  t4
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
and t4.stat_dim = '近一年'
WHERE t1.dt = '@@{yyyyMMdd}'
AND t1.stat_dim = '近一年'
;
-- 取现5万以上客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_01 AS
SELECT a.dep_act_id,a.cst_act_id,a.trx_dt
    ,a.trx_amt      --柜面现金交易金额
    ,a.txt_code
    ,a.smr_dscr
    ,a.cmt
    ,a.trx_bus_org	--	交易营业机构|C12
    ,a.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,b.cst_id	--客户号|C20
    ,b.act_nm	--账户名称|C300
    ,b.opn_org	--开户机构编号|C12
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id
and b.dt='20241217'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(a.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241217'
where a.dt between '20241128' and '20241217'
AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
and a.crd_and_dbt_ind='D'
and a.csh_ind='0' --0:现金;1:转账
and a.trx_amt > 50000   --5万以上
;
--单笔金额超过人民币10万元
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_02 AS
SELECT a.dep_act_id,a.cst_act_id,a.trx_dt
    ,a.trx_amt      --柜面现金交易金额
    ,a.txt_code
    ,a.smr_dscr
    ,a.cmt
    ,a.trx_bus_org	--	交易营业机构|C12
    ,a.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,b.cst_id	--客户号|C20
    ,b.act_nm	--账户名称|C300
    ,b.opn_org	--开户机构编号|C12
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
on a.dep_act_id=b.dep_act_id
and b.dt='20241217'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(a.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241217'
where a.dt between '20241128' and '20241217'
AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
and a.crd_and_dbt_ind='D'
and a.csh_ind='1' --0:现金;1:转账
and a.trx_amt > 100000   --10万以上
;
-- 月内转账累计超过50万元
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_03 AS
SELECT b.cst_id	--客户号|C20
    ,substr(a.trx_dt,1,6) as trx_mon
    ,sum(a.trx_amt) as trx_amt      --柜面现金交易金额
    ,row_number() over(partition by b.cst_id order by sum(a.trx_amt) desc) rn
from edw.dwd_bus_dep_bal_chg_dtl_di     a --存款账户余额发生明细表
inner join(
    select distinct cst_id,dep_act_id
    from SJXQ_SJ20241212131_CST_02   --单笔金额超过人民币10万元
)b on a.dep_act_id=b.dep_act_id
where a.dt between '20241101' and '20241217'
and a.crd_and_dbt_ind='D'
and a.csh_ind='1' --0:现金;1:转账
group by b.cst_id,trx_mon
having sum(a.trx_amt) > 500000
;
-- 客户手机号及地区
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_04 AS
SElECT t1.cst_id,t1.cst_chn_nm	--	客户姓名|C200
    ,t1.CST_TYP_CD
    ,t1.mbl_nbr	    --	手机号码
    ,t1.FML_TEL_NBR --家庭电话
    ,t1.CMP_TEL_NBR --公司电话
    ,SUBSTR(t1.DOC_NBR,1,6) as DOC_NBR_6
    ,t3.region_cd	--	客户所属地区
    ,c3.CD_VAL_DSCR     as 客户所属地区
    ,t1.REG_ADR
    ,concat(substr(regexp_replace(T1.reg_adr,'\\s|,',''),1,greatest(length(regexp_replace(T1.reg_adr,'\\s|,',''))-6,0)),'******') as reg_adr_jm
from edw.dws_cst_bas_inf_dd 	t1 --客户基础信息汇总表
left join adm_upss.l_cust_all   t3 --全量客户表
on t1.cst_id=t3.cust_id
and t3.dt='20241217'
left join EDW.DWD_CODE_LIBRARY_DD C3 -- 码值表
on case when nvl(t3.region_cd,'')<>'' then t3.region_cd else SUBSTR(t1.DOC_NBR,1,6) end=c3.cd_val
and  C3.DT = '20241217'
AND  C3.FLD_NM = 'CITY' --区县
AND  C3.TBL_NM = 'CUSTOMER_ADDRESS'
where t1.dt='20241217'
;
-- 是否当日存定期
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_04_1 AS
select t1.cst_id,t1.trx_dt,t2.opn_dt
	,t2.int_val_dt                               --起息日期|C8
	,t2.mtu_dt                                   --到期日期|C8
	,t2.dep_trm                                  --存期|C6
    ,t2.opn_amt
	,t2.gl_bal                                   --账户总账余额|DECIMAL(20,2)
    ,t2.cur_act_bal                              --当前账户余额
from(
    select cst_ID,trx_dt
    from SJXQ_SJ20241212131_CST_01
    union
    select cst_ID,trx_dt
    from SJXQ_SJ20241212131_CST_02
)t1 inner join EDW.DWS_BUS_DEP_ACT_INF_DD t2 -- 存款账户信息表
on t1.cst_ID=t2.cst_ID
and t1.trx_dt=t2.int_val_dt
and t2.dt='20241217'
and t2.lbl_prod_typ_cd='1' --,'0','活期','1','定期'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_05 AS
SELECT  t1.cst_act_id           AS 客户账号
       ,t1.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t1.cst_id               AS 客户号
       ,COALESCE(t2.客户所属地区,t2.reg_adr_jm)         AS 客户所属地区
       ,t2.mbl_nbr              AS 手机号码
       ,t2.FML_TEL_NBR          AS 家庭电话
       ,t2.CMP_TEL_NBR          AS 公司电话
       ,decode(t2.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t1.trx_dt               AS 取现日期
       ,t1.trx_amt              AS 现金交易金额
       ,t1.smr_dscr             AS 摘要描述
       ,t1.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t1.opr_tlr,t1.opr_tlr_nm)            AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
    ,case when t8.cst_id is not null then '是' else '' end as 取现日是否存定期存款
    ,t8.opn_amt     as 取现日存定期存款开户金额
    ,t8.gl_bal      as 定期存款当前余额_1217
from SJXQ_SJ20241212131_CST_01       t1
left join SJXQ_SJ20241212131_CST_04  t2
on t1.cst_id=t2.cst_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '20241217'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t1.trx_bus_org = t5.org_id
and t5.dt = '20241217'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='20241217'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ20241212131_CST_khjz       t7
on t1.cst_id=t7.cst_id
left join(
    select t1.cst_id,t1.trx_dt
        ,sum(opn_amt) as opn_amt
        ,sum(gl_bal ) as gl_bal
    from SJXQ_SJ20241212131_CST_04_1 t1
    group by t1.cst_id,t1.trx_dt
)t8 on t1.cst_ID=t8.cst_ID
and t1.trx_dt=t8.trx_dt
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_06 AS
SELECT  t2.cst_act_id           AS 客户账号
       ,t2.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t2.cst_id               AS 客户号
       ,COALESCE(t3.客户所属地区,t3.reg_adr_jm)        AS 客户所属地区
       ,t3.mbl_nbr              AS 手机号码
       ,t3.FML_TEL_NBR          AS 家庭电话
       ,t3.CMP_TEL_NBR          AS 公司电话
       ,decode(t3.CST_TYP_CD,'1','对私','2','对公','') AS 客户类型
       ,t2.trx_dt               AS 转账日期
       ,t2.trx_amt              AS 单笔转账金额
       ,t1.trx_mon              AS 月转账超50万月份
       ,t1.trx_amt              AS 月转账超50万金额
       ,t2.smr_dscr             AS 摘要描述
       ,t2.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t2.opr_tlr,t2.opr_tlr_nm)           AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
    ,case when t8.cst_id is not null then '是' else '' end as 取现日是否存定期存款
    ,t8.opn_amt     as 取现日存定期存款开户金额
    ,t8.gl_bal      as 定期存款当前余额_1217
from SJXQ_SJ20241212131_CST_03       t1
left join SJXQ_SJ20241212131_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20241212131_CST_04  t3
on t1.cst_id=t3.cst_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = '20241217'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t2.trx_bus_org = t5.org_id
and t5.dt = '20241217'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='20241217'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ20241212131_CST_khjz       t7
on t1.cst_id=t7.cst_id
left join(
    select t1.cst_id,t1.trx_dt
        ,sum(opn_amt) as opn_amt
        ,sum(gl_bal ) as gl_bal
    from SJXQ_SJ20241212131_CST_04_1 t1
    group by t1.cst_id,t1.trx_dt
)t8 on t2.cst_ID=t8.cst_ID
and t2.trx_dt=t8.trx_dt
where t1.rn=1
;
-- 更换手机号客户
-- 更换手机号：客户最近一次更新日期在 20241128-20241217 且 有2个手机号
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_07 AS
SELECT t.*
    ,row_number() over(partition by cip_cstno order by cip_phoneupdtime desc) rn
from(
    select distinct t1.cip_cstno                     --客户号
        ,t1.cip_namecn                               --客户姓名
        ,t1.cip_checkmobile                          --绑定手机号码
        ,t1.cip_phoneupdtime                         --绑定手机号修改时间
    from edw.ebnk_pb_cstinf_main   t1               --个人客户信息表
    INNER JOIN (
        SELECT DISTINCT cst_id
        from edw.dws_bus_dep_act_inf_dd   b --存款账户信息汇总
        where dt='20241217'
        AND   (b.opn_org like  '3301%' or  b.opn_org like  '9999%') --台州分行、总行营业部
    )t2 on t1.cip_cstno=t2.cst_id
    where t1.dt<='20241217'
    and nvl(t1.cip_checkmobile,'')<>''
)t
;
-- 更换手机号客户所有交易记录 9.30日
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_08 AS
SElECT t1.cip_cstno as cst_id
        ,t1.cip_checkmobile                          --绑定手机号码
        ,t1.cip_phoneupdtime                         --绑定手机号修改时间
from SJXQ_SJ20241212131_CST_07   t1
inner join(
    SElECT cip_cstno
    from SJXQ_SJ20241212131_CST_07
    group by cip_cstno having count(distinct cip_checkmobile)>1
)t2 on t1.cip_cstno=t2.cip_cstno
where t1.rn=1
and substr(t1.cip_phoneupdtime,1,8) between '20241128' and '20241217'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_09 AS
SELECT  t1.cst_id                     AS 客户号
       ,t1.cip_checkmobile            AS 绑定手机号码
       ,t1.cip_phoneupdtime           AS 绑定手机号修改时间
       ,t2.cst_act_id                 AS 客户账号
       ,t2.act_nm                     AS 账户名称
       ,t4.sbr_org_nm                 AS 开户支行
       ,t4.org_nm                     AS 开户机构
       ,t3.trx_dt                     AS 交易时间
       ,t3.crd_and_dbt_ind            AS 借贷标志
       ,t3.trx_amt                    AS 交易金额
       ,t3.smr_dscr                   AS 交易摘要
       ,t3.cmt                        AS 备注
       ,t5.org_nm                     AS 交易营业机构
       ,concat(t3.opr_tlr,c1.empe_nm) AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
from SJXQ_SJ20241212131_CST_08          t1
left join edw.dws_bus_dep_act_inf_dd    t2 --存款账户信息汇总
on  t1.cst_id=t2.cst_id
and t2.dt='20241217'
left join edw.dwd_bus_dep_bal_chg_dtl_di    t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.dt between '20241128' and '20241217'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t2.opn_org = t4.org_id
and t4.dt = '20241217'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  substr(t3.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241217'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  t3.trx_bus_org = t5.org_id
and t5.dt = '20241217'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='20241217'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ20241212131_CST_khjz t7
on t1.cst_id=t7.cst_id
;
-- 4.近3个月发生过向陌生账户转账的对公客户，陌生账户？陌生账号：近两年转账过的账号都不是陌生账号
-- 台州分行近3月对公客户转出明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_10 AS
SElECT t1.cst_id
    ,COALESCE(t1.客户所属地区,t1.reg_adr_jm)        AS 客户所属地区
    ,t1.mbl_nbr              AS 手机号码
    ,t1.FML_TEL_NBR          AS 家庭电话
    ,t1.CMP_TEL_NBR          AS 公司电话
    ,t2.cst_act_id
    ,t2.act_nm,t2.opn_org
    ,t3.dep_act_id
    ,t3.trx_dt,t3.trx_amt
    ,t3.trx_bus_org
    ,t3.cnt_pty_cst_act_id	    --	对方客户账号|C32
    ,t3.cnt_pty_act_nm	        --	对方户名|c200
    ,t3.opr_tlr	    --	操作柜员
    ,c1.empe_nm as opr_tlr_nm
    ,t3.smr_dscr
    ,t3.cmt
from SJXQ_SJ20241212131_CST_04          t1
inner join edw.dws_bus_dep_act_inf_dd   t2 --存款账户信息汇总
on  t1.cst_id=t2.cst_id
and t2.dt='20241217'
AND (t2.opn_org like  '3301%' or  t2.opn_org like  '9999%') --台州分行、总行营业部
inner join edw.dwd_bus_dep_bal_chg_dtl_di t3 --存款账户余额发生明细表
on  t2.dep_act_id=t3.dep_act_id
and t3.crd_and_dbt_ind='D'
and t3.csh_ind='1' --0:现金;1:转账
left join edw.dws_hr_empe_inf_dd          c1 --员工信息汇总
on  substr(t3.opr_tlr,1,6)=c1.empe_id
and c1.dt='20241217'
where t1.CST_TYP_CD='2' --'对公'
;
-- 近两年转账过的账号 剔除近3月交易
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_11 AS
select t1.cst_id,t1.dep_act_id,t3.cnt_pty_cst_act_id	    --	对方客户账号|C32
    ,max(t3.trx_dt)     as lst_trx_dt
from(
    SElECT distinct cst_id,dep_act_id
    from SJXQ_SJ20241212131_CST_10
)t1 inner join edw.dwd_bus_dep_bal_chg_dtl_di t3 --存款账户余额发生明细表
on  t1.dep_act_id=t3.dep_act_id
and t3.crd_and_dbt_ind='D'
and t3.csh_ind='1' --0:现金;1:转账
where nvl(t3.cnt_pty_cst_act_id,'')<>''
group by t1.cst_id,t1.dep_act_id,t3.cnt_pty_cst_act_id
;
-- 输出结果4
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_12 AS
SELECT  t1.cst_act_id           AS 客户账号
       ,t1.act_nm               AS 账户名称
       ,t4.sbr_org_nm           AS 开户支行
       ,t4.org_nm               AS 开户机构
       ,t1.cst_id               AS 客户号
       ,t1.客户所属地区
       ,t1.手机号码
       ,t1.家庭电话
       ,t1.公司电话
       ,t1.trx_dt               AS 转账日期
       ,t1.trx_amt              AS 单笔转账金额
       ,t1.cnt_pty_cst_act_id   as 陌生账户_近12月到3月未交易过
       ,t1.smr_dscr             AS 摘要描述
       ,t1.cmt                  AS 备注
       ,t5.org_nm               AS 交易营业机构
       ,concat(t1.opr_tlr,t1.opr_tlr_nm)           AS 操作柜员
    ,case when t6.cst_id is not null then '是' else '' end as 当前是否签约理财
    ,t7.cst_val_c1m	            as 客户价值等级 --（1-V1,2-V2,3-V3,4-V4,5-V5,6-V6,7-V7,8-V8,0 不符合等级判断的）
from SJXQ_SJ20241212131_CST_10       t1
left join SJXQ_SJ20241212131_CST_11  t2
on t1.dep_act_id=t2.dep_act_id
and t1.cnt_pty_cst_act_id=t2.cnt_pty_cst_act_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '20241217'
left join edw.dim_hr_org_mng_org_tree_dd    t5 --考核机构树
on  T1.trx_bus_org = t5.org_id
and t5.dt = '20241217'
left join edw.dwd_bus_chm_ctr_inf_dd 	    t6  --理财客户签约信息 468375 cst_id 唯一
on t1.cst_id=t6.cst_id
and t6.dt='20241217'
and t6.sal_rcd_sts_cd = '0' --未解约
left join SJXQ_SJ20241212131_CST_khjz       t7
on t1.cst_id=t7.cst_id
where t2.dep_act_id is null     --陌生账户转账
;
-- 5.45周岁以上、客户价值等级V3的个人；V3以上
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_13 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_13 AS
SELECT  t1.cst_id                         AS 客户号
       ,t1.cst_chn_nm                     AS 客户姓名
       ,COALESCE(t1.客户所属地区,t1.reg_adr_jm) AS 客户所属地区
       ,t1.mbl_nbr                        AS 手机号码
       ,t1.FML_TEL_NBR                    AS 家庭电话
       ,t1.CMP_TEL_NBR                    AS 公司电话
       ,t2.age                            AS 年龄
       ,decode(t2.gdr_cd,'1','男','2','女','未知') as 性别
       ,t7.cst_val_c1m                    AS 客户价值等级
       ,t3.prm_mgr_id                     AS 主管户经理ID
       ,t3.prm_mgr_nm                     AS 主管户经理
       ,t4.brc_org_nm                     AS 主管户分行
       ,t4.sbr_org_nm                     AS 主管户支行
from SJXQ_SJ20241212131_CST_04                  t1
inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd  t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20241217'
and t2.age>=45
inner join SJXQ_SJ20241212131_CST_khjz t7
on t1.cst_id=t7.cst_id
and t7.cst_val_c1m>=3   -- V3以上
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241217'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241217'
where t3.prm_org_id like '3301%' or t3.prm_org_id like  '9999%' --台州分行、总行营业部
;
-- 6.职业为企事业单位负责人的女性客户（数据中需包含是否签约理账）
DROP   TABLE IF     EXISTS SJXQ_SJ20241212131_CST_14 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212131_CST_14 AS
SELECT  t1.cst_id                         AS 客户号
       ,t1.cst_chn_nm                     AS 客户姓名
       ,COALESCE(t1.客户所属地区,t1.reg_adr_jm) AS 客户所属地区
       ,t1.mbl_nbr                        AS 手机号码
       ,t1.FML_TEL_NBR                    AS 家庭电话
       ,t1.CMP_TEL_NBR                    AS 公司电话
       ,t2.age                            AS 年龄
       ,decode(t2.gdr_cd,'1','男','2','女','未知') as 性别
       ,c1.cd_val_dscr                    AS 职业
       ,t3.prm_mgr_id                     AS 主管户经理ID
       ,t3.prm_mgr_nm                     AS 主管户经理
       ,t4.brc_org_nm                     AS 主管户分行
       ,t4.sbr_org_nm                     AS 主管户支行
       ,t7.cst_val_c1m	            as 客户价值等级
from SJXQ_SJ20241212131_CST_04                  t1
inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd  t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20241217'
and t2.gdr_cd='2'   --'1','男','2','女'
inner join edw.dws_cst_idv_bas_inf_dd	        t5 --个人客户基本信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='20241217'
and t5.ocp_cd='10600'   --职业代码 10600企事业单位负责人
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD            c1
ON      t5.ocp_cd = c1.cd_val
AND     c1.dt = '@@{yyyyMMdd}'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241217'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241217'
left join SJXQ_SJ20241212131_CST_khjz t7
on t1.cst_id=t7.cst_id
where t3.prm_org_id like '3301%' or t3.prm_org_id like  '9999%' --台州分行、总行营业部
;
SElECT '01' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ20241212131_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ20241212131_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212131_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212131_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20241212131_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20241212131_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cip_cstno) custs
from SJXQ_SJ20241212131_CST_07 where rn=1
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212131_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20241212131_CST_09
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212131_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct dep_act_id,cnt_pty_cst_act_id) custs
from SJXQ_SJ20241212131_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct 客户账号) custs
from SJXQ_SJ20241212131_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241212131_CST_13
union all
SElECT '14' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241212131_CST_14
;
SElECT '05' seq, * from lab_bigdata_dev.SJXQ_SJ20241212131_CST_05;
SElECT '06' seq, * from lab_bigdata_dev.SJXQ_SJ20241212131_CST_06;
SElECT '09' seq, * from lab_bigdata_dev.SJXQ_SJ20241212131_CST_09;
SElECT '12' seq, * from lab_bigdata_dev.SJXQ_SJ20241212131_CST_12;
SElECT '13' seq, * from lab_bigdata_dev.SJXQ_SJ20241212131_CST_13;
SElECT '14' seq, * from lab_bigdata_dev.SJXQ_SJ20241212131_CST_14;
/*
01	9654	8471
02	131700	45544
03	25318	25318
04	19002449	19002449
05	9654	8061
06	115354	32695
07	1097821	1097821
08	493	493
09	10378	997
10	1447859	33845
11	2080639	2080639
12	464211	59627
13	75910	75910
14	2323	2323
*/***吴文雅_SJ20241206141_庆元村行贷款审批信息.sql
﻿-- 取 授用信申请流程 对应的审批人
-- 庆元村行 202409-202411 3个月审批数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241206141_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241206141_CST_01 AS
select t1.ahn_ltr_aply_serno                       --授用信申请流水号|c32
	,t1.cst_id                                   --客户号|c20
	,t1.cst_nm                                   --客户名称|c200
    -- ,t1.usc_aply_serno                           --用信申请流水号|c32
	-- ,t1.mgr_id                                   --管户人工号|c10
	-- ,t1.mgr_org_id                               --管户机构编号|c12
	-- ,t1.sys_reg_psn_id                           --系统登记人|c20
	-- ,t1.sys_reg_org_id                           --系统登记机构编号|c12
	-- ,t1.sys_reg_tm                               --系统登记时间|c20
    ,t2.org_nm
    ,t3.instance_id                              --流程实例id
    ,t3.flow_name                                --流程名称
    ,t3.flow_starter	                         --流程发起者
    ,t3.flow_starter_name                        --发起者名称
    ,replace(t3.start_time,'/','') as lc_start_time --流程发起时间
    ,t3.org_id                                   --发起人机构id
    ,t3.biz_id                                   --业务流水号|c32
    ,t3.biz_type_cd                              --业务类型代码|c32
from (
    SELECT ahn_ltr_aply_serno
    from edw.dwd_bus_loan_lmt_aply_biz_dd --用信方案
    where dt='@@{yyyyMMdd}'
    GROUP BY ahn_ltr_aply_serno
)t1 INNER JOIN edw.dim_hr_org_mng_org_tree_dd   T2 --机构树_考核维度
ON  T1.mgr_org_id = T2.org_id
AND T2.DT = '@@{yyyyMMdd}'
and t2.brc_org_nm regexp '浙江庆元泰隆村镇'
INNER JOIN edw.dwd_bus_loan_n_wf_instance_his_dd t3 --流程运行实例历史表
on t1.ahn_ltr_aply_serno=t3.biz_id
and t3.dt='@@{yyyyMMdd}'
and replace(t3.start_time,'/','') between '20240901' and '20241130'
;
-- 审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ20241206141_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241206141_CST_02 AS
SELECT t1.biz_id               --授用信申请流水号_业务流水号
    ,t1.instance_id          --流程实例id
    ,t2.comment_id           --主键|c32
    ,t2.user_id              --用户id|c32
    ,t3.empe_nm              --用户名称
    ,t2.comment_sign         --用户结论|c5
    ,t2.start_time           --评论时间|c32
    ,t2.role_id              --审批人角色id|c32
    ,t2.user_comment         --用户评价|c1000
    ,t2.node_nm              --节点名称|c32
    ,t2.org_id AS cmt_org_id --所属机构编号|c32
    ,t4.approval_time        --办理时长
    ,round(t4.approval_time/60,2) as approval_minute
    ,case when node_nm='客户经理' then 1
        when node_nm='团队审查岗' then 2
        when node_nm='团队总经理' then 3
        when node_nm='支行行长' then 4
        else 0 end aprv_lvl
    ,ROW_NUMBER() over(partition by t1.biz_id order by t2.start_time asc) rn
from SJXQ_SJ20241206141_CST_01 t1
left join edw.dwd_bus_loan_n_wf_comment_his_dd  t2 --流程审批意见历史
on t1.instance_id=t2.instance_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  substr(t2.user_id,1,6)=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.loan_n_wf_comment_his             t4
on t2.comment_id=t4.comment_id
and t4.dt='@@{yyyyMMdd}'
;
--平均审批时长、审批次数、是否退回
DROP   TABLE IF     EXISTS SJXQ_SJ20241206141_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241206141_CST_03 AS
SELECT instance_id,aprv_lvl
    ,round(avg(approval_minute),2)                          as approval_minute
    ,count(1) as aprv_cnt
    ,sum(case when user_comment regexp '退回' then 1 else 0 end) as back_cnt
from SJXQ_SJ20241206141_CST_02
where aprv_lvl<>0
GROUP BY instance_id,aprv_lvl
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241206141_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241206141_CST_04 AS
SELECT  t1.org_nm         AS 机构名称
    ,t1.cst_id            AS 客户号
    ,t1.cst_nm            AS 客户名称
    ,t1.biz_id            AS 业务流水号
    ,t1.flow_starter      AS 流程发起者
    ,t1.flow_starter_name AS 发起者名称
    ,t1.lc_start_time     AS 流程发起时间
    ,t2.aprv_nm         as 团队审查岗
    ,t2.approval_minute as 团队审查岗审批时长_分
    ,t2.user_comment    as 团队审查岗审批意见
    ,t2.aprv_cnt        as 团队审查岗审批次数
    ,t2.back_cnt        as 团队审查岗退回次数
    ,t3.aprv_nm         as 团队总经理
    ,t3.approval_minute as 团队总经理审批时长_分
    ,t3.user_comment    as 团队总经理审批意见
    ,t3.aprv_cnt        as 团队总经理审批次数
    ,t3.back_cnt        as 团队总经理退回次数
    ,t4.aprv_nm         as 审批支行行长
    ,t4.approval_minute as 审批支行行长审批时长_分
    ,t4.user_comment    as 审批支行行长审批意见
    ,t4.aprv_cnt        as 审批支行行长审批次数
    ,t4.back_cnt        as 审批支行行长退回次数
from SJXQ_SJ20241206141_CST_01      t1
left join SJXQ_SJ20241206141_CST_03 t2
on t1.instance_id=t2.instance_id
and t2.aprv_lvl=2
left join SJXQ_SJ20241206141_CST_03 t3
on t1.instance_id=t3.instance_id
and t3.aprv_lvl=3
left join SJXQ_SJ20241206141_CST_03 t4
on t1.instance_id=t4.instance_id
and t4.aprv_lvl=4
;
SElECT '01' seq, count(1) cnt,count(distinct biz_id) custs
from SJXQ_SJ20241206141_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ20241206141_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ20241206141_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241206141_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ20241206141_CST_04
;
/*
01	685	685
02	5554	685
03	2608	685
04	685	572
*/***吴文雅_SJ2024122696_贷款审批数据.sql
﻿-- 2024年9月-11月三个月贷款审批数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024122696_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122696_CST_01 AS
select t1.ahn_ltr_aply_serno                       --授用信申请流水号|c32
	,t1.cst_id                                   --客户号|c20
	,t1.cst_nm                                   --客户名称|c200
    ,t2.org_nm
    ,t3.instance_id                              --流程实例id
    ,t3.flow_name                                --流程名称
    ,t3.flow_starter	                         --流程发起者
    ,t3.flow_starter_name                        --发起者名称
    ,replace(t3.start_time,'/','') as lc_start_time --流程发起时间
    ,t3.org_id                                   --发起人机构id
    ,t3.biz_id                                   --业务流水号|c32
    ,t3.biz_type_cd                              --业务类型代码|c32
from (
    SELECT ahn_ltr_aply_serno
    from edw.dwd_bus_loan_lmt_aply_biz_dd --用信方案
    where dt='@@{yyyyMMdd}'
    GROUP BY ahn_ltr_aply_serno
)t1 INNER JOIN edw.dim_hr_org_mng_org_tree_dd   T2 --机构树_考核维度
ON  T1.mgr_org_id = T2.org_id
AND T2.DT = '@@{yyyyMMdd}'
and t2.brc_org_nm regexp '浙江庆元泰隆村镇'
INNER JOIN edw.dwd_bus_loan_n_wf_instance_his_dd t3 --流程运行实例历史表
on t1.ahn_ltr_aply_serno=t3.biz_id
and t3.dt='@@{yyyyMMdd}'
and replace(t3.start_time,'/','') between '20240901' and '20241130'
;
-- 审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ2024122696_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122696_CST_02 AS
SELECT t1.biz_id               --授用信申请流水号_业务流水号
    ,t1.instance_id          --流程实例id
    ,t2.comment_id           --主键|c32
    ,t2.user_id              --用户id|c32
    ,t3.empe_nm              --用户名称
    ,t2.comment_sign         --用户结论|c5
    ,t2.start_time           --评论时间|c32
    ,t2.role_id              --审批人角色id|c32
    ,t2.user_comment         --用户评价|c1000
    ,t2.node_nm              --节点名称|c32
    ,t2.org_id AS cmt_org_id --所属机构编号|c32
    ,t4.approval_time        --办理时长
    ,round(t4.approval_time/60,2) as approval_minute
    ,case when t2.node_nm='客户经理' then 1
        when t2.node_nm='团队审查岗' then 2
        when t2.node_nm='团队总经理' then 3
        when t2.node_nm='支行行长' then 4
        when t2.node_nm='村行市场部审查岗' then 5
        when t2.node_nm='村行市场部总经理' then 6
        else 0 end aprv_lvl
    ,ROW_NUMBER() over(partition by t1.biz_id order by t2.start_time asc) rn
from SJXQ_SJ2024122696_CST_01 t1
left join edw.dwd_bus_loan_n_wf_comment_his_dd  t2 --流程审批意见历史
on t1.instance_id=t2.instance_id
and t2.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                t3 --员工信息汇总
on  substr(t2.user_id,1,6)=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.loan_n_wf_comment_his             t4
on t2.comment_id=t4.comment_id
and t4.dt='@@{yyyyMMdd}'
;
--平均审批时长、审批次数、是否退回
DROP   TABLE IF     EXISTS SJXQ_SJ2024122696_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122696_CST_03 AS
SELECT instance_id,aprv_lvl
    ,round(avg(approval_minute),2)                          as approval_minute
    ,count(1) as aprv_cnt
    ,sum(case when user_comment regexp '退回' then 1 else 0 end) as back_cnt
from SJXQ_SJ2024122696_CST_02
where aprv_lvl<>0
GROUP BY instance_id,aprv_lvl
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024122696_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024122696_CST_04 AS
SELECT  t1.org_nm         AS 机构名称
    ,t1.cst_id            AS 客户号
    ,t1.cst_nm            AS 客户名称
    ,t1.biz_id            AS 业务流水号
    ,t1.flow_starter      AS 流程发起者
    ,t1.flow_starter_name AS 发起者名称
    ,t1.lc_start_time     AS 流程发起时间
    ,t2.aprv_nm         as 团队审查岗
    ,t2.approval_minute as 团队审查岗审批时长_分
    ,t2.user_comment    as 团队审查岗审批意见
    ,t2.aprv_cnt        as 团队审查岗审批次数
    ,t2.back_cnt        as 团队审查岗退回次数
    ,t3.aprv_nm         as 团队总经理
    ,t3.approval_minute as 团队总经理审批时长_分
    ,t3.user_comment    as 团队总经理审批意见
    ,t3.aprv_cnt        as 团队总经理审批次数
    ,t3.back_cnt        as 团队总经理退回次数
    ,t4.aprv_nm         as 审批支行行长
    ,t4.approval_minute as 审批支行行长审批时长_分
    ,t4.user_comment    as 审批支行行长审批意见
    ,t4.aprv_cnt        as 审批支行行长审批次数
    ,t4.back_cnt        as 审批支行行长退回次数
    ,t5.aprv_nm         as 村行市场部审查岗
    ,t5.approval_minute as 村行市场部审查岗审批时长_分
    ,t5.user_comment    as 村行市场部审查岗审批意见
    ,t5.aprv_cnt        as 村行市场部审查岗审批次数
    ,t5.back_cnt        as 村行市场部审查岗退回次数
    ,t6.aprv_nm         as 村行市场部总经理
    ,t6.approval_minute as 村行市场部总经理审批时长_分
    ,t6.user_comment    as 村行市场部总经理审批意见
    ,t6.aprv_cnt        as 村行市场部总经理审批次数
    ,t6.back_cnt        as 村行市场部总经理退回次数
from SJXQ_SJ2024122696_CST_01      t1
left join SJXQ_SJ2024122696_CST_03 t2
on t1.instance_id=t2.instance_id
and t2.aprv_lvl=2
left join SJXQ_SJ2024122696_CST_03 t3
on t1.instance_id=t3.instance_id
and t3.aprv_lvl=3
left join SJXQ_SJ2024122696_CST_03 t4
on t1.instance_id=t4.instance_id
and t4.aprv_lvl=4
left join SJXQ_SJ2024122696_CST_03 t5
on t1.instance_id=t5.instance_id
and t5.aprv_lvl=5
left join SJXQ_SJ2024122696_CST_03 t6
on t1.instance_id=t6.instance_id
and t6.aprv_lvl=6
;
SElECT '01' seq, count(1) cnt,count(distinct biz_id) custs
from SJXQ_SJ2024122696_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ2024122696_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct instance_id) custs
from SJXQ_SJ2024122696_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024122696_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024122696_CST_04
;
/*
01	693	693
02	5631	693
03	3171	693
04	693	577
*/
***吴雨伦_SJ2024112996_创保贷合规性检查.sql
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024112996_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112996_CST_01 AS
SELECT  col_1  --合同登记流水号
       ,col_2  --客户号
       ,col_3  --客户名称
       ,col_4  --合同起始日期
       ,col_5  --合同到期日期
       ,col_6  --合同金额
       ,col_7  --合同余额
       ,col_8  --执行年利率
       ,col_9  --管户机构名称
       ,col_10 --管户人名称
from qbi_file_20241202_10_22_35_0
where pt<>''
;
-- 出账起始日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024112996_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112996_CST_02 AS
select distinct t1.col_2 as cst_id
    ,t2.lve_act_bgn_dt    --出账起始日期|c8
from SJXQ_SJ2024112996_CST_01           t1
left join edw.dim_bus_loan_dbil_inf_dd  t2
on t1.col_1=t2.ctr_serno
and t2.dt='@@{yyyyMMdd}'
;
-- 合同余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024112996_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112996_CST_03 AS
select t1.dt,t1.cst_id                         --客户号
	,sum(t1.ctr_bal) as ctr_bal                --合同余额
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
inner join(
    select distinct col_2 as cst_id
    from SJXQ_SJ2024112996_CST_01
)t3 on t1.cst_id=t3.cst_id
where t1.dt<='@@{yyyyMMdd}'
group by t1.dt,t1.cst_id
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112996_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112996_CST_04 AS
SELECT  t1.col_1       AS 合同登记流水号
    ,t1.col_2          AS 客户号
    ,t1.col_3          AS 客户名称
    ,t1.col_4          AS 合同起始日期
    ,t1.col_5          AS 合同到期日期
    ,t1.col_6          AS 合同金额
    ,t1.col_7          AS 合同余额
    ,t1.col_8          AS 执行年利率
    ,t1.col_9          AS 管户机构名称
    ,t1.col_10         AS 管户人名称
    ,t2.lve_act_bgn_dt AS 借据发放日期
    ,t3.ctr_bal        AS 借据发放当日客户号下的贷款余额
    ,t4.ctr_bal        AS 借据发放前一日客户号下的贷款余额
from SJXQ_SJ2024112996_CST_01       t1
left join SJXQ_SJ2024112996_CST_02  t2
on t1.col_2=t2.cst_id
left join SJXQ_SJ2024112996_CST_03  t3
on t1.col_2=t3.cst_id
and t2.lve_act_bgn_dt=t3.dt
left join SJXQ_SJ2024112996_CST_03  t4
on t1.col_2=t4.cst_id
and t2.lve_act_bgn_dt=to_char(dateadd(to_date(t4.dt,'yyyyMMdd'),1,'dd'),'yyyyMMdd')
;
SElECT '01' seq, count(1) cnt,count(distinct col_2) custs
from SJXQ_SJ2024112996_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112996_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112996_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112996_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024112996_CST_04***吴雨伦_SJ20241212146_经营性贷款业务.sql
﻿-- 1.2023年10月20日至今，金家楠作为最终审批人的授信（贷款、随贷通卡等）业务清单；
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_01 AS
SELECT distinct ctr_srl_no
from adm_rsk.adm_rsk_apl_inter_all      --风险集市应用表-资产质量日常监测源表
where dt<='@@{yyyyMMdd}'
and final_aprv_empe_id regexp '金家楠'  --最终审批人
and ctr_start_dt>='20231020'	        --合同生效日期
;
-- 合同
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_02 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,case when (t1.prd_no LIKE '200101%' OR ( t1.prd_no REGEXP '^2001010101003/2001020101003'  AND   SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '03' ) )) then 1 else 0 end is_xfd    --对私一般贷款 ：个人消费性贷款
    ,case when ( ( SUBSTR(t1.PRD_NO, 1, 1) IN ( '1' , '4' ) AND SUBSTR(t1.PRD_NO, 1, 4) <> '1002' ) OR t1.PRD_NO LIKE '200102%' OR ( t1.PRD_NO REGEXP ( '2001010101003|2001020101003' ) AND SUBSTR(t1.CPT_USG_CD, 1, 2) IN ( '01' , '02' ) ) ) then 1 else 0 end is_jyd    --对私一般贷款 ：个人经营性贷款
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.hpn_typ_cd	        --发生类型代码|c6
    ,t1.grnt_mod_colc	    --担保方式集合|c200
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t1.RVLG_TYP_CD	    --循环类型代码
    ,c2.cd_val_dscr     as RVLG_TYP_nm
    ,t2.PD_NM
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,t5.job_unt_nm	            as 工作单位名称
    ,t6.sub_cmnt_id             as 子社区编号
    ,t7.cmnt_nm                 as 子社区名称
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.bsn_mark_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c2
on t1.RVLG_TYP_CD = c2.cd_val
and c2.dt = '@@{yyyyMMdd}'
left join edw.dws_cst_idv_bas_inf_dd    t5 --个人客户基本信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
and t1.ctr_bgn_dt >= '20231020'
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_03 AS
SELECT  t2.ctr_serno     AS 合同流水号
    ,t2.cst_id        AS 客户号
    ,t2.cst_nm        AS 客户名称
    ,t2.prd_no        AS 产品编号
    ,t2.PD_NM         AS 产品名称
    ,t2.is_xfd        AS 是否个人消费性贷款
    ,t2.is_jyd        AS 是否个人经营性贷款
    ,t2.ctr_amt       AS 合同金额
    ,t2.ctr_bal       AS 合同余额
    ,t2.ctr_bgn_dt    AS 合同起始日期
    ,t2.ctr_mtu_dt    AS 合同到期日期
    ,t2.TMT_DT        AS 终结日期
    ,t2.exec_intr_rat AS 执行利率
    ,t2.hpn_typ_cd    AS 发生类型代码
    ,t2.grnt_mod_colc AS 担保方式集合
    ,t2.SYS_REG_DT    AS 系统登记日期_经办日期
    ,t2.RVLG_TYP_CD   AS 循环类型代码
    ,t2.RVLG_TYP_nm   AS 循环类型
    ,t2.mgr_id        AS 管户人工号
    ,t2.mgr_nm        AS 管户人姓名
    ,t2.mgr_org_id    AS 管户机构号
    ,t2.org_nm        AS 管户机构名称
    ,t2.工作单位名称
    ,t2.子社区编号
    ,t2.子社区名称
from SJXQ_SJ20241212146_CST_01          t1
inner join SJXQ_SJ20241212146_CST_02    t2
on t1.ctr_srl_no=t2.ctr_serno
;
-- 2.2023年10月20日至今，瓜沥支行所有发放的经营性授信（贷款、随贷通卡等）业务中，
-- 客户在业务办理前六个月内有【新注册营业执照】或【营业执照法人、股东发生变更记录】的。
/* 可搜索关键词
   黄利铭014519-95后法定代表人
   --GS_ENT_HISMDF_LGLPSNMDF_LST2Y_CNT	工商-企业-历史变更-法人变更-近两年-次数
   企业变更事项为&ldquo;股权变更&rdquo;的次数
   变更记录数大于20条的企业数
   --工商企业-变更信息
   股东变更表
   法人变更前180天交易笔数
   工商企业变更信息
   法人变更时间
*/
-- 瓜沥支行经营性授信（贷款、随贷通卡等）业务客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_04 AS
select distinct cst_id,sbr_org_nm
from SJXQ_SJ20241212146_CST_02
where sbr_org_nm regexp '萧山瓜沥'
and is_jyd=1            --经营性贷款
;
--成立日期 注册日期
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_05 AS
select t1.cst_id
    ,t2.cst_chn_nm
    ,t2.doc_typ_cd
    ,t3.company_id
    ,t3.company_name
    ,t3.credit_no
    ,replace(t3.establish_date,'-','') as establish_dt	--成立日期
from SJXQ_SJ20241212146_CST_04      t1
LEFT JOIN edw.dws_cst_bas_inf_dd    t2 -- 客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
and nvl(t2.doc_nbr,'')<>''
LEFT JOIN edw.nout_company_base     t3
on t2.doc_nbr=t3.credit_no
and t3.dt='20241214'
and nvl(t3.credit_no,'')<>''
;
-- 法人、股东发生变更记录
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_06 AS
SELECT t1.cst_id,t4.company_id
    ,t4.id
    ,replace(t4.change_date,'-','') as change_date
    ,t4.change_field
        ,'股东发起人(股权)变更'
        ,'股东变更(股权转让)'
        ,'股东、投资人变更（股权转让）'
        ,'股东发起人（股权）变更'
        ,'股东名录变更'
        ,'协助法院变更股东') and replace(t4.change_date,'-','')>'@@{yyyyMMdd-3y}'
        then 1 else 0 end as is_gdbg
        ,'法定代表人(负责人、董事长、首席代表)变更'
        ,'法定代表人（负责人）变更'
        ,'法定代表人（负责人、董事长、首席代表）变更') and replace(t4.change_date,'-','')>'@@{yyyyMMdd-3y}'
        then 1 else 0 end as is_frbg
from SJXQ_SJ20241212146_CST_05      t1
LEFT JOIN edw.nout_company_change   t4
on t1.company_id=t4.company_id
and t4.dt='20241214'
and t4.use_flag<>'10'  --10废弃数据
where t1.company_id is not null
;
-- 业务经办前6月是否新注册营业执照或法人股东变更
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_07 AS
SELECT t1.cst_id,t1.SYS_REG_DT
    ,max(t3.bus_dt) max_bus_dt
    ,max(case when t3.cst_id is not null then 1 else 0 end) as is_exist
from(
    SELECT DISTINCT cst_id,SYS_REG_DT
    from SJXQ_SJ20241212146_CST_02
)t1 left join(
    SELECT cst_id,establish_dt as bus_dt
    from SJXQ_SJ20241212146_CST_05
    where NVL(establish_dt,'')<>''
    union
    SELECT cst_id,change_date
    from SJXQ_SJ20241212146_CST_06
    where (is_gdbg=1 or is_frbg=1)
    and NVL(change_date,'')<>''
)t3 on t1.cst_id=t3.cst_id
and t1.SYS_REG_DT>t3.bus_dt
and t1.SYS_REG_DT<=to_char(DATEADD(TO_DATE(t3.bus_dt,'yyyyMMdd'),182,'dd'),'yyyyMMdd')
GROUP BY t1.cst_id,t1.SYS_REG_DT
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_08 AS
SELECT  t2.ctr_serno     AS 合同流水号
    ,t2.cst_id        AS 客户号
    ,t2.cst_nm        AS 客户名称
    ,t2.prd_no        AS 产品编号
    ,t2.PD_NM         AS 产品名称
    ,t2.is_xfd        AS 是否个人消费性贷款
    ,t2.is_jyd        AS 是否个人经营性贷款
    ,t2.ctr_amt       AS 合同金额
    ,t2.ctr_bal       AS 合同余额
    ,t2.ctr_bgn_dt    AS 合同起始日期
    ,t2.ctr_mtu_dt    AS 合同到期日期
    ,t2.TMT_DT        AS 终结日期
    ,t2.exec_intr_rat AS 执行利率
    ,t2.hpn_typ_cd    AS 发生类型代码
    ,t2.grnt_mod_colc AS 担保方式集合
    ,t2.SYS_REG_DT    AS 系统登记日期_经办日期
    ,t2.RVLG_TYP_CD   AS 循环类型代码
    ,t2.RVLG_TYP_nm   AS 循环类型
    ,t2.mgr_id        AS 管户人工号
    ,t2.mgr_nm        AS 管户人姓名
    ,t2.mgr_org_id    AS 管户机构号
    ,t2.org_nm        AS 管户机构名称
    ,t2.工作单位名称
    ,t2.子社区编号
    ,t2.子社区名称
    ,t3.is_exist as 业务经办前6月是否新注册营业执照或法人股东变更
    ,t3.max_bus_dt as 最近变更日期
from SJXQ_SJ20241212146_CST_04      t1
left join SJXQ_SJ20241212146_CST_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20241212146_CST_07 t3
on t2.cst_id=t3.cst_id
and t2.SYS_REG_DT=t3.SYS_REG_DT
;
-- 个人客户匹配法人信息 关联 股东变更
-- 成立日期
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_09 AS
SELECT 客户号 as  cst_id
    ,t1.企业名称,t1.企业状态,t1.企业类型,t1.行业名称,t1.注册资本万元,t1.注册资本币种,t1.注册号,t1.省份
    ,REPLACE(成立时间,'-','') as 成立时间
    ,t3.company_id,t3.company_name	--	企业名称
    ,replace(t3.establish_date,'-','') as establish_dt	--成立日期
from LAB_BIGDATA_DEV.SJXQ_SJ20241212146_CST_FR t1
left join edw.nout_company_base     t3
on t1.统一社会信用代码=t3.credit_no
and t3.dt='20241216'
and nvl(t3.credit_no,'')<>''
where 查得标识='1'  --765
;
-- 法人、股东发生变更记录
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_10 AS
SELECT t1.cst_id
    ,t4.company_id
    ,t4.id
    ,replace(t4.change_date,'-','') as change_date
    ,t4.change_field
        ,'股东发起人(股权)变更'
        ,'股东变更(股权转让)'
        ,'股东、投资人变更（股权转让）'
        ,'股东发起人（股权）变更'
        ,'股东名录变更'
        ,'协助法院变更股东') and replace(t4.change_date,'-','')>'@@{yyyyMMdd-3y}'
        then 1 else 0 end as is_gdbg
        ,'法定代表人(负责人、董事长、首席代表)变更'
        ,'法定代表人（负责人）变更'
        ,'法定代表人（负责人、董事长、首席代表）变更') and replace(t4.change_date,'-','')>'@@{yyyyMMdd-3y}'
        then 1 else 0 end as is_frbg
from (
    SELECT DISTINCT t1.cst_id,t1.company_id
    from SJXQ_SJ20241212146_CST_09 t1
    where t1.company_id is not null
)t1 INNER JOIN edw.nout_company_change   t4
on t1.company_id=t4.company_id
and t4.dt='20241216'
and t4.use_flag<>'10'  --10废弃数据
;
-- 业务经办前6月是否新注册营业执照或法人股东变更
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_11 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_11 AS
SELECT t1.cst_id,t1.company_id,t1.SYS_REG_DT
    ,max(t3.bus_dt) max_bus_dt
    ,max(case when t3.company_id is not null then 1 else 0 end) as is_exist
from(
    SELECT DISTINCT t1.cst_id,t1.SYS_REG_DT,t2.company_id
    from SJXQ_SJ20241212146_CST_02          t1
    INNER JOIN SJXQ_SJ20241212146_CST_09    t2
    on t1.cst_id=t2.cst_id
    where nvl(t2.company_id,'')<>''
)t1 left join(
    SELECT company_id,成立时间 as bus_dt
    from SJXQ_SJ20241212146_CST_09
    where NVL(成立时间,'')<>''
    union
    SELECT company_id,change_date
    from SJXQ_SJ20241212146_CST_10
    where (is_gdbg=1 or is_frbg=1)
    and NVL(change_date,'')<>''
)t3 on t1.company_id=t3.company_id
and t1.SYS_REG_DT>t3.bus_dt
and t1.SYS_REG_DT<=to_char(DATEADD(TO_DATE(t3.bus_dt,'yyyyMMdd'),182,'dd'),'yyyyMMdd')
GROUP BY t1.cst_id,t1.company_id,t1.SYS_REG_DT
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_12 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_12 AS
SELECT t1.cst_id
    ,t2.cst_nm        AS 客户名称
    ,t1.企业名称
    ,t1.企业状态
    ,t1.企业类型
    ,t1.行业名称
    ,t1.注册资本万元
    ,t1.注册资本币种
    ,t1.注册号
    ,t1.省份
    ,t1.成立时间
    ,t2.ctr_serno     AS 合同流水号
    ,t2.prd_no        AS 产品编号
    ,t2.PD_NM         AS 产品名称
    ,t2.is_xfd        AS 是否个人消费性贷款
    ,t2.is_jyd        AS 是否个人经营性贷款
    ,t2.ctr_amt       AS 合同金额
    ,t2.ctr_bal       AS 合同余额
    ,t2.ctr_bgn_dt    AS 合同起始日期
    ,t2.ctr_mtu_dt    AS 合同到期日期
    ,t2.TMT_DT        AS 终结日期
    ,t2.exec_intr_rat AS 执行利率
    ,t2.hpn_typ_cd    AS 发生类型代码
    ,t2.grnt_mod_colc AS 担保方式集合
    ,t2.SYS_REG_DT    AS 系统登记日期_经办日期
    ,t2.RVLG_TYP_CD   AS 循环类型代码
    ,t2.RVLG_TYP_nm   AS 循环类型
    ,t2.mgr_id        AS 管户人工号
    ,t2.mgr_nm        AS 管户人姓名
    ,t2.mgr_org_id    AS 管户机构号
    ,t2.org_nm        AS 管户机构名称
    ,t2.工作单位名称
    ,t2.子社区编号
    ,t2.子社区名称
    ,t3.is_exist as 业务经办前6月是否新注册营业执照或法人股东变更
    ,t3.max_bus_dt as 最近变更日期
from SJXQ_SJ20241212146_CST_09      t1
left join SJXQ_SJ20241212146_CST_02 t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20241212146_CST_11 t3
on t1.cst_id=t3.cst_id
and t1.company_id=t3.company_id
and t2.SYS_REG_DT=t3.SYS_REG_DT
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_srl_no) custs
from SJXQ_SJ20241212146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241212146_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241212146_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212146_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212146_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212146_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241212146_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241212146_CST_08
;
SElECT '08' seq, *
from SJXQ_SJ20241212146_CST_08
where 业务经办前6月是否新注册营业执照或法人股东变更=1
;
/*
01	1737	1737
02	784514	784514
03	1737	1737
04	730	730
05	730	730
06	2341	242
07	702518	384715
08	1911	1911
*/
-- 法人变更
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_05_1 AS
SELECT  T2.cust_no           as     CST_ID
        ,count(distinct replace(substr(T1.created_ts,1,10),'-',''))   as   NEW_CREATE_num
        ,max(replace(substr(T1.created_ts,1,10),'-',''))              as   NEW_CREATET_tim
from edw.ecif_t02_org_cust_cust_rel     T1
LEFT JOIN edw.ecif_t00_org_cust_no_rec  T2  -- /*对公客户号识别信息*/
ON    T1.party_id=T2.party_id
and   T2.dt='@@{yyyyMMdd}'
where T1.dt='@@{yyyyMMdd}'
and   T1.REL_TYPE = '0101'   -- 法人变更 02% 股东
and   T2.cust_no is not null
group by T2.cust_no
having count(distinct replace(substr(T1.created_ts,1,10),'-',''))>=2    --变更
;
-- 股东变更
DROP   TABLE IF     EXISTS SJXQ_SJ20241212146_CST_05_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241212146_CST_05_2 AS
SELECT  T2.cust_no           as     CST_ID
        ,count(distinct replace(substr(T1.created_ts,1,10),'-',''))   as   NEW_CREATE_num
        ,max(replace(substr(T1.created_ts,1,10),'-',''))              as   NEW_CREATET_tim
from edw.ecif_t02_org_cust_cust_rel     T1
LEFT JOIN edw.ecif_t00_org_cust_no_rec  T2  -- /*对公客户号识别信息*/
ON    T1.party_id=T2.party_id
and   T2.dt='@@{yyyyMMdd}'
where T1.dt='@@{yyyyMMdd}'
and   T1.REL_TYPE like '02%'   -- 股东
and   T2.cust_no is not null
group by T2.cust_no
having count(distinct replace(substr(T1.created_ts,1,10),'-',''))>=2    --变更
;
***周嘉晖_SJ20241217166_征信查询记录.sql
﻿-- 查询2021年至今请求合肥行征信的数据
-- 合肥行客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241217166_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217166_CST_01 AS
select t1.apl_srl_nbr                            --申请流水号 预评估申请流水号 pre_ases_srl_nbr 16位
	,t1.rel_apl_srl_nbr                          --关联申请流水号|C132
	,t1.cst_id    as cst_id1                   	 --客户编号 均为20位 与行内无法关联
	,t1.cst_nm                                   --客户名称|C1200
	,t1.cst_rol_cd                               --客户角色代码|C132
    ,decode(t1.cst_rol_cd,'01','借款人','02','担保人','03','关系人','04','潜在客户','') as 客户角色
	,t1.doc_typ_cd                               --证件类型代码|C15
	,t1.doc_nbr                                  --证件号码|C160
	,t1.che_cntnt                                --核查内容|C1200
	,t1.crd_qry_rsn_cd                           --征信查询原因代码|C1200
	,t1.apl_typ_cd                               --申请类型代码|C116
	,t1.apl_sts_cd                               --申请状态代码|C116
	,t1.bef_apl_rsl                              --预申请结果|C132
	,t1.crd_qry_sts                              --征信查询状态|C132
	,t1.sts_cd                                   --状态代码|C11
	,t1.aplc_id                                  --申请人编号|c10
	,t1.apl_dt                                   --申请日期|c20
	,t1.apl_org_id
    ,t2.brc_org_nm,t2.org_nm
	,t3.cst_id as cst_id2
	,t4.cst_id
from edw.dwd_bus_loan_cst_bef_ases_apl_tbl_dd 	as t1 --客户预评估
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd 		as t2 --机构树_考核维度
on t1.apl_org_id = t2.org_id
and t2.dt = '20240718'
left join (
	SELECT DISTINCT pre_ases_srl_nbr,cst_rol_cd,cst_id
	from edw.dwd_bus_loan_pre_ases_rsl_dd
	where dt='20240718'
) 	t3 --预评估最终结果信息
on t1.apl_srl_nbr=t3.pre_ases_srl_nbr
and t1.cst_rol_cd=t3.cst_rol_cd
left join edw.dws_cst_bas_inf_dd 	t4
on t1.doc_nbr=t4.DOC_NBR
and t4.dt='20241218'
and t4.DOC_TYP_CD='B0101'
-- left join edw.dwd_bus_loan_pre_ases_bsn_aply_dd t4 --预评估业务申请 无老信贷 预评估申请流水号
-- on t1.apl_srl_nbr=t4.pre_ases_serno
-- and t4.dt='20241218'
where t1.dt='20240718'
and SUBSTR(t1.apl_org_id, 1, 4)='E340'  --合肥科技农商行
and t1.apl_dt>='20210101'
;
-- 征信查询时间 客户号长度不一致 无法关联出数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241217166_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217166_CST_02 AS
SELECT  T1.APL_SRL_NBR                            AS YPG_APL_SRL_NO --预评估申请流水号
        ,COALESCE(Z2.REPORT_NO, Z3.REPORT_NO)     AS zx_REPORT_NO --外部数据报告编号
        ,COALESCE(Z2.QRY_DT, Z3.REPORT_DT)        as QRY_DT
FROM    SJXQ_SJ20241217166_CST_01 T1
--二。 取征信报告号
--2.3.个人征信 预评估30天内征信 （客户号相关联,预评估申请表的申请日期- 征信报告号日期 30 天内,取最小征信日期差的一笔 ）
LEFT JOIN    (
                 SELECT  P1.APL_SRL_NBR
                         ,P2.REPORT_NO AS REPORT_NO
                         ,P2.QRY_DT
                         ,ROW_NUMBER() OVER ( PARTITION BY P1.APL_SRL_NBR ORDER BY P2.QRY_DT DESC ) RN
                 FROM    edw.DWD_BUS_LOAN_CST_BEF_ASES_APL_TBL_DD P1 --预评估申请表
                 INNER JOIN    edw.DWD_CST_CCRC_IDV_RPT_JNL_HIS_DD P2 --个人客户人行征信报告历史 length(CST_ID)=10
                 ON      P1.CST_ID = P2.CST_ID
                 AND     REGEXP_REPLACE(P1.APL_DT, '/', '') >= REGEXP_REPLACE(SUBSTR(P2.REPORT_DT, 1, 10), '-', '')
                 AND     REGEXP_REPLACE(P1.APL_DT, '/', '') <= REGEXP_REPLACE(SUBSTR(DATEADD(TO_DATE(REGEXP_REPLACE(P2.QRY_DT, '-', ''), 'yyyyMMdd hh:mi:ss'), 29, 'dd'), 1, 10), '-', '')
                 AND     P2.DT = '20240718'
                 WHERE   P1.DT = '20240718'
             ) Z2
ON      T1.APL_SRL_NBR = Z2.APL_SRL_NBR
AND     Z2.RN = 1
--2.4.企业征信 预评估30天内征信 （客户号相关联,预评估申请表的申请日期- 征信报告号日期 30 天内,取最小征信日期差的一笔 ）
LEFT JOIN    (
                 SELECT  P1.APL_SRL_NBR
                         ,P2.REPORT_NO AS REPORT_NO
                         ,P2.REPORT_DT
                         ,ROW_NUMBER() OVER ( PARTITION BY P1.APL_SRL_NBR ORDER BY P2.REPORT_DT DESC ) RN
                 FROM    edw.DWD_BUS_LOAN_CST_BEF_ASES_APL_TBL_DD P1 --预评估申请表
                 INNER JOIN    edw.DWS_CST_CCRC_ENTP_IND_INF_DD P2 --企业客户人行征信报告历史 仅8个客户length(CST_ID)=20
                 ON      P1.CST_ID = P2.CST_ID
                 AND     REGEXP_REPLACE(P1.APL_DT, '/', '') >= REGEXP_REPLACE(SUBSTR(P2.REPORT_DT, 1, 10), '-', '')
                 AND     REGEXP_REPLACE(P1.APL_DT, '/', '') <= REGEXP_REPLACE(SUBSTR(DATEADD(to_date(REGEXP_REPLACE(CONCAT(P2.REPORT_DT, ' 00:00:00'), '-', ''), 'yyyyMMdd hh:mi:ss'), 29, 'dd'), 1, 10), '-', '')
                 AND     P2.DT = '20240718'
                 WHERE   P1.DT = '20240718'
             ) Z3
ON      T1.APL_SRL_NBR = Z3.APL_SRL_NBR
AND     Z3.RN = 1
;
-- 合作行 预评估最终结果信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241217166_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217166_CST_03 AS
select b1.srl_nbr 	--CPR
	,b1.pre_ases_srl_nbr,b1.cst_id,b1.pre_ases_rsl,b1.reg_tm
	,b2.apl_dt,b3.sgs_inf
from edw.dwd_bus_loan_pre_ases_rsl_dd 				as b1 --预评估最终结果信息
inner join edw.dwd_bus_loan_cst_bef_ases_apl_tbl_dd as b2 --客户预评估
on b1.pre_ases_srl_nbr = b2.apl_srl_nbr
and b1.cst_rol_cd=b2.cst_rol_cd
and b2.dt = '20240718'
and SUBSTR(b2.apl_org_id, 1, 4)='E340'  --合肥科技农商行
left join
(
	from edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd    --客户预评估申请关联表
	where dt = '20240718'
	and qry_rsl = '2010'
	and apl_cst_rol = '01'
	group by apl_srl_nbr
) as b3
on b1.pre_ases_srl_nbr = b3.apl_srl_nbr
where b1.dt = '20240718'
;
-- 业务流水号
DROP   TABLE IF     EXISTS SJXQ_SJ20241217166_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217166_CST_04 AS
SELECT t1.cst_id
from(
	SELECT DISTINCT cst_id
	from SJXQ_SJ20241217166_CST_01
	where nvl(cst_id,'')<>''
)t1 INNER join edw.dwd_bus_loan_lmt_aply_info_dd t2       --授用信申请信息 新
on t1.cst_id=t2.cst_id
and t2.dt='20241218'
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241217166_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217166_CST_05 AS
select t1.apl_srl_nbr                            as 预评估申请流水号
	,t1.cst_nm                                   as 客户名称
	,t1.客户角色
	,t1.doc_typ_cd                               as 证件类型代码
	,t1.doc_nbr                                  as 证件号码
	,t1.crd_qry_sts                              as 征信查询状态
	,t1.aplc_id                                  as 申请人编号
	,t1.apl_dt                                   as 申请日期
	,t1.apl_org_id as 申请机构号
from SJXQ_SJ20241217166_CST_01 		t1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241217166_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct YPG_APL_SRL_NO) custs
from SJXQ_SJ20241217166_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241217166_CST_03
;
/*
seq	cnt	custs
01	28065	11665
02	28065	28065
03	52300	11648
*/
***喻美华_SJ2024112026_消费贷客户画像分析.sql
﻿
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_01 AS
SELECT  col_1 as seq    --序号
       ,col_2 as cst_id --客户号
       ,col_3 as cst_nm --客户名称
from qbi_file_20241125_13_52_22_0
where pt<>''
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_02 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20241117'
)t1 inner JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20241117'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20241117'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20241117'
where t1.rn=1
;
--借据号维度是否用信
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_03 AS
SELECT cst_id
from(
    SELECT  a.cst_id,max(dt) use_crdt_dt
    FROM edw.dws_bus_loan_dbil_inf_dd a --贷款借据信息汇总
    inner join (
        SELECT DISTINCT cst_id from SJXQ_SJ2024112026_CST_01
    )t2 on a.cst_id=t2.cst_id
    WHERE a.dt <= '20241117'
    and a.prcp_bal>0    --用信
    group by cst_id
)t1
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_04 AS
SELECT t1.cst_id
    ,max(case when t1.is_rsk_loan = 'Y' then 1 else 0 end) as is_rsk_loan	--是否风险贷款
FROM adm_rsk.adm_rsk_apl_inter_all	t1 --风险集市应用表-资产质量日常监测源表
left join EDW.dwd_code_library_dd   c1
on t1.loan_usg=c1.cd_val
and c1.dt='20241117'
WHERE t1.dt = '20241117'
group by t1.cst_id
;
-- 侧面打听
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_05 AS
select t1.svy_rcd_serno                          --调查记录流水号|C32
	,t1.svy_mod_cd                               --调查方式代码|C2
    ,c1.cd_val_dscr     as svy_mod_nm   --侧面打听
	,t1.svy_dt                                   --调查日期|C8
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.svy_addr_typ_cd                          --调查地址类型代码|C3
    ,c2.cd_val_dscr     as svy_addr_typ_nm
	,t1.adiv                                     --行政区划|C12
	,t1.svy_addr                                 --调查地址|C256
	,t1.svy_ctnt_and_rslt                        --调查内容及结果|C4000
	,t1.rmk                                      --备注|c4000
	,t1.pcp_mnl_no                               --参与人工号|C20
	,t1.pcp_psn_nm                               --参与人姓名|C200
    ,t2.svy_obj_nm	--调查对象名称|c200
from edw.dwd_bus_loan_cst_svy_rcd_dd  t1        --客户调查记录信息
inner join edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd t2 --调查记录关联调查对象信息 会调查多人多次
on t1.svy_rcd_serno=t2.rel_serno --关联流水号
and t2.dt='20241117'
and nvl(t2.svy_obj_nm,'')<>''
LEFT JOIN    EDW.dwd_code_library_dd  c1
ON      T1.SVY_MOD_CD = c1.CD_VAL
AND     c1.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     c1.FLD_NM = 'SVY_MOD_CD'
and     c1.dt='20241117'
LEFT JOIN    EDW.dwd_code_library_dd  c2
ON      T1.SVY_ADDR_TYP_CD = C2.CD_VAL
AND     C2.TBL_NM = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     C2.FLD_NM = 'SVY_ADDR_TYP_CD'
and     c2.dt='20241117'
where t1.dt='20241117'
and t1.cst_id in(select distinct cst_id from SJXQ_SJ2024112026_CST_01)
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_06 AS
SElECT t1.cst_id
    ,t2.cst_cr_grd_val
    ,t2.prd_dt
    ,ROW_NUMBER() OVER ( PARTITION BY t1.cst_id ORDER BY t2.prd_dt DESC) AS rn
from (
    select distinct cst_id
    from SJXQ_SJ2024112026_CST_01
)t1 left join(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                                              AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20241117'
    UNION
    SELECT  cst_id
        ,prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20241117'
)t2 on t1.cst_id=t2.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112026_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112026_CST_07 AS
SELECT   t1.seq           AS 序号
    ,t1.cst_id           AS 客户号
    ,t1.cst_nm           AS 客户名称
    ,t2.rul_set_rslt_nm AS 新预评估结果
    ,case when t3.is_use_crdt_1y=1 then '是' else '否' end  AS 近1年是否用信
    ,case when t3.is_use_crdt_2y=1 then '是' else '否' end  AS 近2年是否用信
    ,case when t4.is_rsk_loan=1 then '是' else '否' end     AS 是否存在风险贷款
    ,t4.loan_usg        AS 贷款用途
    ,t5.svy_obj_nm      AS 侧面打听人
    ,t6.age             AS 年龄
    ,t6.anl_inc         AS 年收入
    ,decode(t6.gdr_cd,'1','男','2','女','未知')  as 性别
    ,decode(t6.mrg_situ_cd,'10','未婚','20','已婚','21','初婚','22','再婚','23','复婚','30','丧偶','40','离婚','') as 婚姻状况
    ,t7.cst_cr_grd_val  as 最新征信分
from SJXQ_SJ2024112026_CST_01       t1
left join SJXQ_SJ2024112026_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024112026_CST_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024112026_CST_04  t4
on t1.cst_id=t4.cst_id
left join (
    select cst_id
    from SJXQ_SJ2024112026_CST_05
    where svy_mod_nm regexp '侧面打听'
    group by cst_id
)t5 on t1.cst_id=t5.cst_id
left join adm_pub.adm_csm_cbas_idv_bas_inf_dd  t6    --客户集市-客户基础-对私客户基础信息
on t1.cst_id=t6.cst_id
and t6.dt='20241117'
left join SJXQ_SJ2024112026_CST_06  t7
on t1.cst_id=t7.cst_id
and t7.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112026_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112026_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112026_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112026_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112026_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112026_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112026_CST_07
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ2024112026_CST_07
***孔明洋_SJ20241223171_叶县村行触发精准贷后客户.sql
﻿-- 自2019年8月1日到2024年12月23日期间叶县村行存量贷款客户触发精准贷后的规则。
DROP   TABLE IF     EXISTS SJXQ_SJ20241223171_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223171_CST_01 AS
select t1.ctr_srl_no                             --合同流水号
	,t1.dbil_srl_no                              --借据流水号
	,t1.mng_empe_id                              --管户人工号
	,t1.mng_org_id                               --管户机构号
	,t1.cst_nm                                   --客户名称
	,t1.cst_id                                   --核心客户编号
	,t1.dbil_bal_cny                             --余额
	,t1.grant_amt                                --发放金额
	,t1.grant_date                               --发放日期
	,t1.end_date                                 --到期日期
	,t1.loan_usg                                 --贷款用途
	,t1.hpn_rsk_date                             --出险日期
	,t1.is_rsk_loan                              --是否风险贷款
	,t1.apl_srl_no                               --申请流水号
	,t1.opr_empe_id                              --经办客户经理
	,t1.opr_dept_lead_empe_id                    --经办部门负责人
	,t1.opr_sub_brch_prsd_empe_id                --经办支行行长
	,t1.rvw_empe_id                              --经办审查人
	,t1.final_aprv_empe_id                       --最终审批人
	,t1.rsk_lvl                                  --贷后风险判断
	,t1.chk_opnn                                 --贷后管理意见
	,t1.start_dt                                 --任务生成日期
	,t1.rsk_lvl_bef                              --出险前贷后风险判断
	,t1.start_dt_bef                             --出险前任务生成日期
	,t1.hpn_typ_cd                               --发生类型
	,t1.ctr_start_dt                             --合同生效日期
	,t1.ctr_mtu_dt                               --合同到期日期
	,t1.dft_label                                --违约标识 Y-是 N-否
	,t1.his_dft_cst_label                        --历史违约客户标识 Y-是 N-否
	,t1.pd_typ                                   --产品类型 随贷通、垫款、分期贷款、非分期贷款、信用卡
	,t1.wtf_sts_label                            --核销状态标识 1-核销已结清 2-核销未结清
    ,t2.org_nm
from adm_rsk.adm_rsk_apl_inter_all          t1 --风险集市应用表-资产质量日常监测源表
inner join edw.dim_hr_org_mng_org_tree_dd   t2 --考核机构树
on  t1.mng_org_id = t2.org_id
and t2.dt = '20241223'
and t2.brc_org_nm = '河南叶县泰隆村镇银行'
where t1.dt='20241223'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241223171_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223171_CST_02 AS
SELECT  T1.cst_id                                                  AS 客户号
       ,T2.tsk_gen_dt                                              AS 精准贷后风险触发时间
       ,CASE WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
             WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
             WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
             WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类' END AS 精准贷后触发类型
       ,T3.触发规则分类
       ,T3.触发规则
       ,T3.触发原因分析
       ,ROW_NUMBER() over(PARTITION BY T1.cst_id ORDER BY  t2.tsk_gen_dt DESC) rn
FROM edw.dwd_bus_loan_psp_chk_btch_inf_dd       AS T1 --贷后检查批次信息表
INNER JOIN edw.dwd_bus_loan_psp_chk_tsk_inf_dd  AS T2 --贷后检查任务信息
ON T1.btch_serno = T2.btch_serno
AND T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后 贷后检查任务来源代码
AND T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03' , '04' ) --01 处置1级, 02 处置2级, 03 预警类, 04 提示类
AND T2.DT = '20241223'
LEFT JOIN
(
	SELECT  btch_serno
	       ,CONCAT(rul_ctg_nm,'-',rul_sub_clss_nm)                                      AS 触发规则分类
	       ,rul_nm                                                                      AS 触发规则
	       ,trg_rsn_anls                                                                AS 触发原因分析
	       ,rul_ctg_nm                                                                  AS 规则分类名称
	       ,rul_sub_clss_nm                                                             AS 规则细类名称
	       ,ROW_NUMBER() OVER ( PARTITION BY btch_serno ORDER BY  sgnl_rul_serno DESC ) AS RN
	FROM edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
	WHERE DT = '20241223'
) T3
ON T1.btch_serno = T3.btch_serno
AND T3.RN = 1
WHERE T1.DT = '20241223'
and T2.tsk_gen_dt >='20190801'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241223171_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223171_CST_03 AS
SELECT  t1.cst_nm       AS 客户名称
    ,t1.cst_id      AS 客户号
    ,t1.org_nm      AS 管户机构
    ,t1.ctr_srl_no  AS 合同流水号
    ,t1.dbil_cnt    as 借据数
    ,t1.dbil_srl_no AS 借据流水号
    ,t1.mng_empe_id AS 管户人工号
    ,t3.empe_nm     AS 管户人
    ,T2.精准贷后风险触发时间
    ,T2.精准贷后触发类型
    ,T2.触发规则分类
    ,T2.触发规则
    ,T2.触发原因分析
from (
    SELECT  t1.cst_nm
        ,t1.cst_id
        ,t1.org_nm
        ,t1.ctr_srl_no
        ,t1.mng_empe_id
        ,count(dbil_srl_no) dbil_cnt
    from SJXQ_SJ20241223171_CST_01 t1
    GROUP BY t1.cst_nm,t1.cst_id,t1.org_nm,t1.ctr_srl_no,t1.mng_empe_id
)t1
INNER JOIN SJXQ_SJ20241223171_CST_02 t2
on t1.cst_id=t2.客户号
and t2.rn=1
left join edw.dws_hr_empe_inf_dd    t3 --员工信息汇总
on  t1.mng_empe_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct dbil_srl_no) custs
from SJXQ_SJ20241223171_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241223171_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241223171_CST_03
;
SElECT '03' seq, *
from SJXQ_SJ20241223171_CST_03
;
/*
01	10056	10056
02	372143	372143
03	1210	1210
*/***孙佳莹_SJ20241129136_票据中介交易分析.sql
﻿-- 账户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_01 AS
SELECT t1.dep_act_id                               --存款账号|C32
	,t1.cst_act_id                               --客户账号|C32
	,t1.ccy_cd                                   --币种代码|C3
	,t1.bal_itm_id                               --科目编号
	,t1.cst_id                                   --客户号|C20
	,t1.act_nm                                   --账户名称|C300
	,t1.act_cr_ind                               --钞汇标志|C1
	,t1.dep_trm                                  --存期|C6
	,t1.int_val_dt                               --起息日期|C8
	,t1.mtu_dt                                   --到期日期|C8
	,t1.act_afl_org                              --核算机构编号|C12
	,t1.opn_org                                  --开户机构编号|C12
	,t1.opn_dt                                   --开户日期|C8
	,t1.act_opn_tlr                              --开户柜员编号|C10
	,t1.act_dstr_act_org                         --销户机构编号|C12
	,t1.act_dstr_act_dt                          --销户日期|C8
	,t1.act_dstr_act_tlr                         --销户柜员编号|C10
	,t1.gl_bal                                   --账户总账余额|DECIMAL(20,2)
	,t1.act_mth_acm_bal	                         --月累计总账余额积数|DECIMAL(20,2)
	,t1.act_year_acm_bal	                     --年累计总账余额积数|DECIMAL(20,2)
	,t1.bal_late_upd_dt                          --上次动户日期|C8
	,t1.prod_id                                  --存款产品代码|C24
	,t1.cst_tp                                   --所属客户类型代码|C1
	,t1.lbl_prod_typ_cd                          --存款产品类型代码|C1
	,t1.dep_cls_cd                               --存款种类|C4
	,t1.act_sts_cd                               --存款账户状态代码|C1
    ,decode(T1.act_sts_cd,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结'
        ,'F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户') act_sts
        WHEN T1.PROD_ID IN ( '00201030304','00201030303','00201030401','00201030402','00201030502','00201030501','00202030200','00201030305','00201030306','00201030307') THEN '4' --靠档类账户
        ELSE '7' END AS DEP_ACT_TYP   --存款账户类型：1活期，2定期，3保证金，4靠档类，5发行类，6通知类，7其他
    ,t4.org_nm  as opn_org_nm
FROM EDW.DWS_BUS_DEP_ACT_INF_DD             t1
LEFT JOIN edw.dwd_bus_bill_acc_mrgn_inf_dd  T2
ON t1.cst_act_id = T2.mrgn_act_id
AND T1.DT = T2.dt -- 承兑保证金信息
LEFT JOIN EDW.DWD_BUS_DEP_AGR_CTR_INF_DD    T3 --协定存款签约信息
ON T3.DEP_ACT_ID = T1.DEP_ACT_ID
AND T3.DT = '20241031'
AND T3.AGR_DEP_IND = '1' --协定存款账号
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org = t4.org_id
and t4.dt = '20241031'
WHERE t1.dt='20241031'
AND T2.mrgn_act_id IS NULL -- 剔除保证金账户--客户账号是卡号 ，存款账号 是存款的账号
and t4.brc_org_nm='杭州分行'
;
-- 账户交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_02 AS
SElECT t1.cst_id
from SJXQ_SJ20241129136_CST_01               t1
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t2 --存款账户余额发生明细表
on t1.dep_act_id=t2.dep_act_id
and t1.cst_act_id=t2.cst_act_id
and t2.dt> '20231031'   --近1年
and t2.dt<='20241031'
and t2.cnt_pty_fin_instt_nm regexp '吉林亿联银行|武汉众邦银行|华瑞银行|河北银行|盛京银行' --对方金融机构名称
where t1.DEP_ACT_TYP<>'2'  --剔除定期存款账户
group by t1.cst_id
having count(1)>10  --10次以上
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_02_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_02_1 AS
select t1.cst_act_id                               --客户账号|C32
	,t1.act_sts_cd                               --账户状态代码|C1
    ,c2.cd_val_dscr     as act_sts_nm
	,t1.cst_id                                   --客户编号|C20
	,t1.opn_org_id                               --开户机构编号|C12
    ,t4.org_nm          as opn_org_nm
	,t1.opn_dt                                   --开户日期|C8
	,t1.opn_tlr_id                               --开户柜员编号|C10
    ,c1.empe_nm         as opn_tlr_nm
	,t1.act_cls_frz_ind                          --账户封闭冻结标志|C1
	,t1.act_rcv_oly_ind                          --账户只收不付标志|C1
	,t1.act_amt_frz_ind                          --账户金额冻结标志|C1
	,t1.act_pay_oly_ind                          --账户只付不收标志|C1
from edw.dim_bus_dep_cst_act_inf_dd  t1         --客户存款账户信息
inner join SJXQ_SJ20241129136_CST_02 t2
on t1.cst_id=t2.cst_id
inner join (
    select distinct cst_act_id
    from SJXQ_SJ20241129136_CST_01
    where DEP_ACT_TYP<>'2'  --剔除定期存款账户
) t3 on t1.cst_act_id=t3.cst_act_id
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.opn_org_id = t4.org_id
and t4.dt = '20241031'
left join edw.dws_hr_empe_inf_dd            c1 --员工信息汇总
on  t1.opn_tlr_id=c1.empe_id
and c1.dt='20241031'
left join edw.dwd_code_library_dd           c2  --132058 tbl_nm,fld_nm,cd_val 唯一
on t1.act_sts_cd = c2.cd_val
and c2.dt='20241031'
where t1.dt='20241031'
and t4.brc_org_nm='杭州分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_01_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_01_1 AS
SELECT t1.*
from SJXQ_SJ20241129136_CST_01          t1
INNER JOIN SJXQ_SJ20241129136_CST_02_1  t2
on t1.cst_act_id=t2.cst_act_id
;
-- 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_03 AS
SELECT  t1.cst_id
    ,t2.cst_chn_nm  --客户姓名
    ,t2.doc_nbr     --证件号码|C60
    ,t2.doc_mtu_dt  --证件到期日期|C8
    ,t2.mbl_nbr     --手机|C32
    ,t2.fml_tel_nbr --家庭电话|C32
    ,t2.cmp_tel_nbr --公司电话|C32
    ,t2.reg_adr     --户籍地址|注册地址|C256
    ,t2.cmn_adr     --通讯地址|C256
    ,t2.wrk_adr     --工作单位地址|经营所在地地址|C256
    ,t3.idt_ctg_cd  --行业分类代码|C10
    ,c1.cd_val_dscr     as idt_ctg_nm
    ,t5.lgp_cst_id
    ,t5.lgp_nm
    ,t5.lgp_doc_id     --对公客户法人证件号
    ,t5.lgp_tel        --对公客户法人手机号
    ,t5.lgp_doc_mtu_dt --对公客户法人证件到期日
    ,t6.prm_mgr_id,t6.prm_mgr_nm,t6.prm_org_id
    ,t7.brc_org_nm,t7.sbr_org_nm,t7.tem_org_nm,t7.org_nm
    ,case when coalesce(t15.chk_rsl_cd,t16.chk_rsl_cd) = '1' then '一致'
          when coalesce(t15.chk_rsl_cd,t16.chk_rsl_cd) = '2' then '不一致'
          else '' end as 预留手机号码实名验证结果
from SJXQ_SJ20241129136_CST_02          t1
left join edw.dws_cst_bas_inf_dd 		t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20241031'
left join edw.dim_cst_entp_bas_inf_dd	t3 --企业客户基本信息
on t1.cst_id=t3.cst_id
and t3.dt='20241031'
left join edw.dim_cst_entp_lgp_inf_dd   t5  --对公客户法人信息表 （主键为cst_id 对公客户）
on t1.cst_ID=t5.cst_ID
and t5.dt = '20241031'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t6 --客户`主管户`信息
on  t1.cst_id = t6.cst_id
and t6.dt = '20241031'
left join edw.dim_hr_org_mng_org_tree_dd            t7 --考核机构树
on  t6.prm_org_id = t7.org_id
and t7.dt = '20241031'
left  join  edw.dwd_cst_out_oprt_dx_realnm_atst_chk_dd    t15   --电信三网实名认证事实表
on    md5(t2.doc_nbr) = t15.id_card_nbr_md5
and T15.dt = '20241031'
left  join  edw.dwd_cst_out_oprt_dx_realnm_atst_chk_dd    t16   --电信三网实名认证事实表
on    t2.doc_nbr = t16.id_card_nbr
and T16.dt = '20241031'
left join edw.dwd_code_library_dd       c1  --132058 tbl_nm,fld_nm,cd_val 唯一
on t3.idt_ctg_cd = c1.cd_val
and c1.dt='20241031'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_04 AS
select cst_act_id --客户账号|c32
    ,agn_nm         --代理人名称
    ,agn_doc_nbr    --代理人证件号码
    ,agn_tel        --代理人电话|c16
    ,agn_doc_mtu_dt --代理人证件到期日期|c8
    ,rcd_sts_cd
    ,trx_dt
from(
    SELECT  cst_id         --客户号|c20
        ,cst_nm         --客户名称|c200
        ,cst_act_id     --客户账号|c32
        ,act_id         --负债账号|c32
        ,trx_dt	        --交易日期|c8
        ,lbl_pd_typ_cd  --负债产品类型代码|c1
        ,agn_nm         --代理人名称
        ,agn_doc_nbr    --代理人证件号码
        ,agn_doc_typ    --代理人证件类型代码
        ,agn_tel        --代理人电话|c16
        ,agn_doc_mtu_dt --代理人证件到期日期|c8
        ,rcd_sts_cd
        ,ROW_NUMBER() over(partition by cst_act_id order by rcd_sts_cd asc,trx_dt desc) rn
    FROM edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd --代理业务交易登记簿
    WHERE dt = '20241031'
    AND agn_bus_typ = '1'   --代理业务类型代码:代理开户
    -- and rcd_sts_cd='0'      --0	正常
)t where rn=1
;
--外部工商状态
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_05 AS
SELECT  dt             --查询日期
       ,geb_creditcode --统一信用代码
       ,geb_entname    --企业名称
       ,geb_entstatus  --经营状态_工商状态
       ,geb_candate    --注销日期
       ,geb_revdate    --吊销日期
       ,geb_orgcodes   --组织机构代码
       ,geb_regno      --注册号
FROM
(
	SELECT  dt
	       ,geb_creditcode
	       ,geb_entname
	       ,geb_entstatus
	       ,geb_candate
	       ,geb_revdate
	       ,geb_orgcodes
	       ,geb_regno
	       ,ROW_NUMBER() OVER ( PARTITION BY geb_entname ORDER BY  dt DESC ) rnk
	FROM edw.outd_gs_entinfo_basic
	WHERE dt >= '20230101'
	AND dt <= '20241031'
) t
WHERE t.rnk = 1
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_06 AS
SELECT  A.cst_id        --客户号
       ,B.geb_entstatus --工商状态
       ,B.geb_candate   --注销日期
       ,B.geb_revdate   --吊销日期
       ,B.DT            --查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN SJXQ_SJ20241129136_CST_05 B
ON      A.cst_chn_nm = B.geb_entname
WHERE   A.dt = '20241031'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' ) --对公客户
-- AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 工商注销
UNION
SELECT  A.cst_id        AS 客户号
       ,B.geb_entstatus AS 工商状态
       ,B.geb_candate   AS 注销日期
       ,B.geb_revdate   AS 吊销日期
       ,B.DT            AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN SJXQ_SJ20241129136_CST_05 B
ON      A.prm_doc_nbr = B.geb_creditcode
WHERE   A.dt = '20241031'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
-- AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 经营状态
UNION
SELECT  A.cst_id        AS 客户号
       ,B.geb_entstatus AS 工商状态
       ,B.geb_candate   AS 注销日期
       ,B.geb_revdate   AS 吊销日期
       ,B.DT            AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN SJXQ_SJ20241129136_CST_05 B
ON      A.prm_doc_nbr = B.geb_orgcodes
WHERE   A.dt = '20241031'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
-- AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 经营状态
UNION
SELECT  A.cst_id        AS 客户号
       ,B.geb_entstatus AS 工商状态
       ,B.geb_candate   AS 注销日期
       ,B.geb_revdate   AS 吊销日期
       ,B.DT            AS 查询日期
FROM    edw.dim_cst_bas_inf_dd A --客户基本信息
INNER JOIN SJXQ_SJ20241129136_CST_05 B
ON      A.prm_doc_nbr = B.geb_regno
WHERE   A.dt = '20241031'
AND     substr(a.cst_id, 1, 1) IN ( '0' , '2' , '6' , '8' )
-- AND     B.geb_entstatus NOT LIKE '在营（开业）' --geb_entstatus 经营状态
;
--账户止付
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_07 AS
SELECT t1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --止付种类
    ,t1.ACT_STOP_PMT_TYP_CD,c2.cd_val_dscr ACT_STOP_PMT_TYP --止付类型
    ,ROW_NUMBER() over (partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd  t1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='20241031'
left join edw.dwd_code_library_dd   c2
on t1.frz_cls_cd = c2.cd_val
and c2.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c2.fld_nm='ACT_STOP_PMT_TYP_CD'
and c2.dt='20241031'
WHERE   t1.DT = '20241031'
AND     t1.FRZ_SRC_CD='2'  --止付
AND     t1.NFRZ_IND = '0'
;
--冻结
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_08 AS
SELECT T1.cst_act_id,t1.frz_dt,t1.frz_rsn
    ,t1.frz_cls_cd,c1.cd_val_dscr frz_cls                   --冻结种类
    ,ROW_NUMBER() over(partition by cst_act_id order by frz_dt desc) rn
FROM    edw.dwd_bus_dep_frz_inf_dd      T1  --账户冻结登记
left join edw.dwd_code_library_dd   c1
on t1.frz_cls_cd = c1.cd_val
and c1.tbl_nm='DWD_BUS_DEP_FRZ_INF_DD'
and c1.fld_nm='FRZ_CLS_CD'
and c1.dt='20241031'
WHERE   T1.DT = '20241031'
AND     T1.FRZ_SRC_CD='1'  --冻结
AND     T1.NFRZ_IND = '0'
;
--关闭非柜面
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_09 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_09 AS
SELECT  cst_act_id,lmt_cmt close_fg_rsn
        ,ROW_NUMBER() OVER ( PARTITION BY cst_act_id ORDER BY lmt_eft_dt DESC ) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd --账户额度控制
WHERE   DT = '20241031'
AND     ACT_THRS_TYP = '2' --暂停非柜面
AND     evt_id = 'DPDRAW'
;
--非柜面限额 where 条件无法直接合并，需探查
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_10 AS
SELECT  cengcgjz    cst_act_id
    ,danciedu   fg_per_lmt
    ,leijiedu   fg_day_lmt
FROM    edw.core_kdpa_zheddy -- 负债账户额度定义表
WHERE   dt = '20241031'
AND     zhxeleix = '2'
AND     shijbhao = 'FGMXIANE' -- 非柜面限额
AND     edkzzhqi = '1D'
and cengcgjz in(select cst_act_id from SJXQ_SJ20241129136_CST_02_1)
;
-- 非柜面渠道2024年以来每日使用额度最高值
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_11 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_11 AS
SELECT  B.cst_act_id
       ,MAX(trx_amt_sum_day)    AS 非柜面渠道2024年以来每日使用额度最高值
       ,MAX(zc_trx_amt_sum_day) AS 非柜面渠道2024年以来每日转出金额最大值
FROM
(
	SELECT  A.cst_act_id
	       ,A.trx_dt
	       ,SUM(trx_amt) trx_amt_sum_day
	       ,SUM(CASE WHEN A.crd_and_dbt_ind = 'D' THEN trx_amt ELSE 0 END) AS zc_trx_amt_sum_day
	FROM edw.DWD_BUS_DEP_BAL_CHG_DTL_DI A --存款账户余额发生明细
	WHERE A.dt >= '20240101'
	AND A.dt <= '20241031'
	AND A.TRX_CHNL_CD NOT IN ( 'A01' , 'M08' , 'C03' , 'C10' )  --,'A01','柜面' ,'C03','超级柜台' ,'C10','智能现金柜台' ,'M08','基金理财系统'
	AND A.int_trx_no NOT IN ( 'dp2265' , 'dp2101' , 'dp15' )
	AND A.txt_code NOT IN ( 'LQSF01' , 'SBKF01' , 'BA0004' , 'FD0001' , 'FD0002' , 'FD0003' , 'FD0004' , 'FD0005' , 'FD0010'
        , 'FD0011' , 'FD0012' , 'FD0013' , 'FD0014' , 'FD0015' , 'FD0016' , 'FD0017' , 'FD0018' , 'FD0019' , 'LC0009' , 'LN0002'
        , 'LN0003' , 'LN0004' , 'THKHK1' , 'XE1207' , 'XYKHK1' , 'YL0035' , 'TY0033' )
	AND A.smr_dscr NOT REGEXP '代发|代扣'
	AND A.bal_fld_nm = 'DPLDGBAL'   --动账
	GROUP BY  A.cst_act_id ,A.trx_dt
) B
GROUP BY  B.cst_act_id
;
--至今每日非柜限额
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_12 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_12 AS
SELECT  T1.cst_act_id
       ,T1.lmt_id           --额度编号|c10
       ,T1.DT
       ,T1.sng_tm_trx_lmt   --单次交易额度|number(22,21)
       ,T1.acm_trx_lmt      --累计交易额度|number(22,21)
       ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_act_id ORDER BY T1.DT ASC ) rn
FROM    edw.dwd_bus_dep_act_lmt_inf_dd T1
INNER join SJXQ_SJ20241129136_CST_02_1 t2
on t1.cst_act_id=t2.cst_act_id
WHERE   T1.DT <= '20241031'
and     nvl(t1.cst_act_id,'')<>''
AND     T1.ACT_THRS_TYP = '2'   --账户限额类型 ,'0','通用限额' ,'1','二三类限额' ,'2','非柜面限额' ,'3','外汇限额' ,'4','其他'
AND     T1.EVT_ID = 'FGMXIANE'  --事件编号
AND     T1.LMT_CTRL_PRD = '1D'  --额度控制周期
;
--至今每日非柜限额调整记录
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_13 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_13 AS
SELECT  T1.cst_act_id
    ,T1.DT
    ,T2.DT                                                                AS pre_dt
    ,T1.ACM_TRX_LMT                                                       AS acm_trx_lmt_today
    ,T2.ACM_TRX_LMT                                                       AS ACM_TRX_LMT_yestoday
    ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_act_id ORDER BY T1.DT DESC ) AS rn
    ,CASE WHEN T1.ACM_TRX_LMT > T2.ACM_TRX_LMT THEN '提额' ELSE '降额' END AS 非柜面限额调整方向
FROM SJXQ_SJ20241129136_CST_12       T1
LEFT JOIN SJXQ_SJ20241129136_CST_12  T2
ON      T1.cst_act_id = T2.cst_act_id
AND     T1.rn = T2.rn+1
WHERE   T1.acm_trx_lmt > T2.acm_trx_lmt  --提额
;
-- 客户风险等级
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_14 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_14 AS
SELECT  substr(party_id,3,12) AS cst_id
       ,levelkey              --最终风险等级
       ,check_user            --审核人
       ,check_dt              --审核日期
       ,rcheck_user           --审批人
       ,rcheck_dt             --审批日期
       ,statistic_dt          --评级日期
       ,ROW_NUMBER() OVER ( PARTITION BY substr(party_id,3,12) ORDER BY  statistic_dt DESC ) AS rn
FROM adm_upss.aml_t37_party_result_curr
WHERE dt = '20241031'
;
-- 是否有信贷业务
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_15 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_15 AS
SElECT t1.cst_ID,sum(t1.ctr_bal) as ctr_bal
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241031'
and t2.PD_NM not regexp '信用卡'
where t1.dt='20241031'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
group by t1.cst_id
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_16 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_16 AS
SELECT  t1.cst_id          AS 客户号
    ,t3.cst_chn_nm      AS 客户姓名
    ,t3.doc_nbr         AS 主证件号码
    ,t3.doc_mtu_dt      AS 主证件到期日期
    ,t3.idt_ctg_nm      AS 行业分类
    ,t3.reg_adr         AS 户籍地址
    ,t3.cmn_adr         AS 通讯地址
    ,t3.mbl_nbr         AS 手机
    ,t3.fml_tel_nbr     AS 家庭电话
    ,t3.cmp_tel_nbr     AS 公司电话
    ,t3.lgp_nm          AS 对公客户法人姓名
    ,t3.lgp_doc_id      AS 对公客户法人证件号
    ,t3.lgp_doc_mtu_dt  AS 对公客户法人证件到期日
    ,t3.lgp_tel         AS 对公客户法人手机号
    ,t4.agn_nm          AS 代理人名称
    ,t4.agn_doc_nbr     AS 代理人证件号码
    ,t4.agn_doc_mtu_dt  AS 代理人证件到期日期
    ,t4.agn_tel         AS 代理人电话
    ,t3.预留手机号码实名验证结果
    ,t1.cst_act_id      AS 客户账号
    ,t1.opn_dt          AS 开户日期
    ,t1.act_sts_nm      AS 账户状态
    ,t9.geb_entstatus                                                 AS 外部工商状态
    ,CASE WHEN T8.cst_act_id IS NULL THEN '否'
            WHEN T8.cst_act_id IS NOT NULL THEN '是'  ELSE '其他' END      AS 是否设置非柜限额
    ,T8.fg_per_lmt                                                    AS 非柜单笔限额
    ,T8.fg_day_lmt                                                    AS 非柜日累计限额
    ,CASE WHEN T7.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END       AS 是否关闭非柜面
    ,T7.close_fg_rsn                                                  AS 关闭原因
    ,CASE WHEN T6.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END       AS 是否冻结
    ,T6.frz_dt                                                        AS 冻结日期
    ,T6.frz_cls                                                       AS 冻结种类
    ,T6.frz_rsn                                                       AS 冻结原因
    ,CASE WHEN T5.cst_act_id IS NOT NULL THEN '是'  ELSE '否' END       AS 是否止付
    ,T5.frz_dt                                                        AS 止付日期
    ,T5.act_stop_pmt_typ_cd                                           AS 止付类型代码
    ,T5.act_stop_pmt_typ                                              AS 止付类型
    ,T5.frz_cls_cd                                                    AS 止付种类代码
    ,T5.frz_cls                                                       AS 止付种类
    ,T5.frz_rsn                                                       AS 止付原因
    ,t10.非柜面渠道2024年以来每日使用额度最高值
    ,t11.dt as 最近一次非柜面限额提额时间
    ,CASE WHEN t12.customeraccount is not null THEN '是'  ELSE '否' END AS 历史是否被外部有权机关查询
    ,t13.levelkey as 客户风险等级
    ,CASE WHEN t14.cst_ID is not null THEN '是'  ELSE '否' END          AS 是否有信贷业务
    ,t14.CTR_BAL                                                      AS 信贷业务余额
    ,t1.opn_tlr_id      AS 开户柜员编号
    ,t1.opn_tlr_nm      AS 开户柜员
    ,t2.月总账余额日均
    ,t2.年总账余额日均
    ,t1.opn_org_id      AS 开户机构编号
    ,t1.opn_org_nm      AS 开户机构
    ,t3.org_nm                           AS 管户机构名称
    ,concat(t3.prm_mgr_id,t3.prm_mgr_nm) AS 管护客户经理姓名
from SJXQ_SJ20241129136_CST_02_1     t1
left join(
    select cst_act_id
       ,round(sum(act_mth_acm_bal)/31,2)    AS 月总账余额日均
       ,round(sum(act_year_acm_bal)/304,2)  AS 年总账余额日均
    from SJXQ_SJ20241129136_CST_01
    group by cst_act_id
)t2 on t1.cst_act_id=t2.cst_act_id
left join SJXQ_SJ20241129136_CST_03  t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20241129136_CST_04  t4
on t2.cst_act_id=t4.cst_act_id
left join SJXQ_SJ20241129136_CST_07              t5 --止付
on t2.cst_act_id=t5.cst_act_id and t5.rn=1
left join SJXQ_SJ20241129136_CST_08              t6 --冻结
on t2.cst_act_id=t6.cst_act_id and t6.rn=1
left join SJXQ_SJ20241129136_CST_09              t7 --关闭非柜面
on t2.cst_act_id=t7.cst_act_id and t7.rn=1
left join SJXQ_SJ20241129136_CST_10              t8 --非柜面限额
on t2.cst_act_id=t8.cst_act_id
left join(
    SELECT cst_id,geb_entstatus
        ,ROW_NUMBER() over(partition by cst_id order by dt desc) rn
    from SJXQ_SJ20241129136_CST_06
)  t9
on t1.cst_id=t9.cst_id and t9.rn=1
left join SJXQ_SJ20241129136_CST_11  t10
on t2.cst_act_id=t10.cst_act_id
left join SJXQ_SJ20241129136_CST_13  t11
on t2.cst_act_id=t11.cst_act_id
and t11.rn=1
left JOIN (
    select replace(A.customeraccount,'+','')   as customeraccount
           ,COUNT(1)   as numbers
           ,max(handledate) as handledate --经办日期
    FROM app_rpt.inter_enquiry_pow_inst_reg A --有权机关查询
    WHERE A.dt='20241031'
    GROUP BY A.customeraccount
)  T12 on  T2.cst_act_id=T12.customeraccount
left join SJXQ_SJ20241129136_CST_14  t13
on  t1.cst_ID=t13.cst_ID
and t13.rn=1
left join SJXQ_SJ20241129136_CST_15  t14
on t1.cst_ID=t14.cst_ID
;
--账户每月交易明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_17 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_17 AS
SELECT t1.cst_act_id,t1.trx_dt,substr(t1.trx_dt,1,6) as trx_mon
    ,t1.trx_amt         --交易金额
    ,t1.crd_and_dbt_ind --C存入 'D' 支取
    ,t1.txt_code
    ,t1.smr_dscr
    ,t2.客户号
    ,t2.开户机构
from edw.dwd_bus_dep_bal_chg_dtl_di   t1 --存款账户余额发生明细表
inner join (
SELECT  distinct 客户账号,客户号,开户机构
    from SJXQ_SJ20241129136_CST_16
)   t2 --存款账户信息汇总
on t1.cst_act_id=t2.客户账号
where t1.dt between '20230101' and '20241031'
and t1.trx_dt between '20230101' and '20241031'
and t1.bal_fld_nm = 'DPLDGBAL' --动账
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20241129136_CST_18 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129136_CST_18 AS
SELECT  cst_act_id AS 客户账号
       ,客户号
       ,开户机构
       ,trx_mon    AS 交易月份
       ,COUNT(case WHEN crd_and_dbt_ind = 'C' THEN cst_act_id end)   AS 转入笔数
       ,SUM(case WHEN crd_and_dbt_ind = 'C' THEN trx_amt else 0 end) AS 转入金额
       ,COUNT(case WHEN crd_and_dbt_ind = 'D' THEN cst_act_id end)   AS 转出笔数
       ,SUM(case WHEN crd_and_dbt_ind = 'D' THEN trx_amt else 0 end) AS 转出金额
        ,ROW_NUMBER() over(partition by cst_act_id order by trx_mon) as 客户账号月份序号
from SJXQ_SJ20241129136_CST_17
group by cst_act_id,客户号,开户机构,trx_mon
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_01
union all
SElECT '011' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_01_1
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129136_CST_02
union all
SElECT '021' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_02_1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129136_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct geb_entname) custs
from SJXQ_SJ20241129136_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129136_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_07 where rn=1
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_08 where rn=1
union all
SElECT '09' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_09 where rn=1
union all
SElECT '10' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_10
union all
SElECT '11' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_11
union all
SElECT '12' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_12
union all
SElECT '13' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ20241129136_CST_13 where rn=1
union all
SElECT '14' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129136_CST_14 where rn=1
union all
SElECT '15' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129136_CST_15
union all
SElECT '16' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241129136_CST_16
union all
SElECT '17' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241129136_CST_17
union all
SElECT '18' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241129136_CST_18
;
-- 结果1
SElECT '16' seq, *
from SJXQ_SJ20241129136_CST_16
;
-- 结果2
SElECT '18' seq, *
from SJXQ_SJ20241129136_CST_18
***张依宁_SJ2024120696_嘉兴分行征信授权书.sql
/*
2024年10月20日-11月31日期间，客户征信查询原因 及是否签署电子版征信授权书
10.20-11.30期间发起的征信查询原因、10.20-11.30期间客户是否签署过电子征信授权书、10.20-11.30期间客户经理是否向客户发送过电子征信授权书签署链接
*/
DROP   TABLE IF EXISTS SJXQ_SJ2024120696_CST_01 PURGE;
CREATE TABLE           SJXQ_SJ2024120696_CST_01
(
     org_id string COMMENT '机构号'
    ,org_nm string COMMENT '机构'
    ,cst_id string COMMENT '客户号'
    ,cst_nm string COMMENT '客户名称'
    ,role_nm  string COMMENT '角色'
)
;
insert into SJXQ_SJ2024120696_CST_01
values
;
/*
--征信查询原因
DROP   TABLE IF     EXISTS SJXQ_SJ2024120696_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120696_CST_02 AS
SELECT  substr(CC.CUSTOMER_ID, 1, 10) AS 客户号
        ,CC.CLIENT_NAME               AS 客户名称
        ,CC.CALL_SYS_USER             AS 查询人
        ,CC.qry_reason                AS 查询原因
        ,DECODE(cc.qry_reason,'01','贷后管理'
            ,'02','贷款审批'
            ,'03','信用卡审批'
            ,'08','担保资格审查','0801','担保资格审查-贷前','0802','担保资格审查-贷后'
            ,'09','司法调查','16','公积金提取复核查询','18','股指期货开户','19','特约商户实名审查'
            ,'20','保前审查','21','保后管理'
            ,'22','法人代表、负责人、高管等资信审查','2201','法人代表、负责人、高管等资信审查-贷前','2202','法人代表、负责人、高管等资信审查-贷后'
            ,'23','客户准入资格审查','24','融资审批','25','资信审查','2501','资信审查-贷前','2502','资信审查-贷后'
            ,'26','额度审批','') as qry_reason_nm
        ,CC.query_time                AS 查询时间
        ,CC.source_type               AS 渠道
        ,CC.ext2                      AS 查询人所在机构
        ,CC.AUTHORIZA_VESION
        ,CASE
           WHEN CC.AUTHORIZA_VESION = '01' THEN '电子'
           WHEN CC.AUTHORIZA_VESION = '02' THEN '纸质'
           WHEN CC.AUTHORIZA_VESION = '03' THEN '未签署'
           WHEN CC.AUTHORIZA_VESION = '04' THEN '短信邀约'
           ELSE ''
         END                          AS 授权版本
FROM    edw.ncip_cpq_resultinfo cc
WHERE   CC.STATUS = '1' --查询成功 ERROR_INFO = '查询成功'
AND     CC.SOURCE = '2' --查询人行
AND     CC.oper_org IN ( '990000000' , '426199999' , '336199999' ) --我行
AND     CC.CALL_SYS_USER NOT RLIKE '^[A-Za-z]+$' --NOT REGEXP_LIKE(CC.CALL_SYS_USER, '^[A-Za-z]+$') --剔除批量
-- AND     CC.QUERY_TIME BETWEEN '2024-07-01 00:00:00' AND '2024-07-31 00:00:00'
and     substr(replace(cc.query_time,'-',''),1,8) between '20241020' and '20241130'
AND     CC.dt >= '20241020'
AND     CC.dt <= '20241130'
-- AND     CC.qry_reason IN ( '01' , '02' , '2201' , '2202' , '24' , '25' , '2501' , '2502' , '26' )
union all
SELECT  substr(CC.CUSTOMER_ID, 1, 10) 客户号
        ,CC.CLIENT_NAME 客户名称
        ,CC.CALL_SYS_USER 查询人
        ,CC.qry_reason  AS 查询原因
        ,DECODE(cc.qry_reason,'01','贷前（保前）审查' ,'02','贷中操作' ,'03','贷后（在保）管理' ,'04','其他原因'
            ,'05','关联查询' ,'0501','关联查询-贷前' ,'0502','关联查询-贷后'
            ,'17','额度审批' ,'18','担保审查' ,'1801','担保审查-贷前' ,'1802','担保审查-贷后'
            ,'') as qry_reason_nm
        ,CC.query_time  AS 查询时间
        ,CC.source_type AS 渠道
        ,CC.ext2 查询人所在机构
        ,CC.AUTHORIZA_VESION
        ,CASE
           WHEN CC.AUTHORIZA_VESION = '01' THEN '电子'
           WHEN CC.AUTHORIZA_VESION = '02' THEN '纸质'
           WHEN CC.AUTHORIZA_VESION = '03' THEN '未签署'
           WHEN CC.AUTHORIZA_VESION = '04' THEN '短信邀约'
           ELSE ''
         END            AS 授权版本
FROM    edw.ncip_ceq_resultinfo cc
WHERE   CC.STATUS = '1' --查询成功
AND     CC.SOURCE = '2' --查询人行
AND     CC.oper_org IN ( '990000000' , '426199999' , '336199999' ) --我行
AND     CC.CALL_SYS_USER NOT RLIKE '^[A-Za-z]+$' --NOT REGEXP_LIKE(CC.CALL_SYS_USER, '^[A-Za-z]+$') --剔除批量
and     substr(replace(cc.query_time,'-',''),1,8) between '20241020' and '20241130'
AND     CC.dt >= '20241020'
AND     CC.dt <= '20241130'
-- AND     CC.qry_reason IN ( '01' , '03' , '0501' , '0502' , '17' , '1801' , '1801' )
;
*/
-- 是否发送电子征信授权书签署链接
DROP   TABLE IF     EXISTS SJXQ_SJ2024120696_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120696_CST_03 AS
select create_date                              --新建日期
	,customer_id                              --客户号
	,customer_name                            --客户姓名
	,authorization_version                    --授权书版本
	,authorization_reason                     --授权事由
	,query_reason                             --查询原因(01 贷前（保前）审查,02 贷款审批,03 信用卡审批,05 关联查询,08 担保资格审查,17 额度审批,18 担保审查,22 法人代表、负责人、高管等资信审查,25 资信审查,04 其他)
	,decode(query_reason,'01','贷前（保前）审查','02','贷款审批','03','信用卡审批','04','其他','05','关联查询'
        ,'08','担保资格审查','17','额度审批','18','担保审查','22','法人代表、负责人、高管等资信审查'
        ,'25','资信审查') as query_reason_nm
    ,authorization_way                        --授权方式(01-线下-纸质,02-线下-电子（PAD手写）03-线上-电子（短信平台）04-线上-电子（安心签）05-线上-电子（加签平台）)
    ,decode(authorization_way,'01','线下-纸质','02','线下-电子_PAD手写','03','线上-电子_短信平台'
        ,'04','线上-电子_安心签','05','线上-电子_加签平台') as authorization_way_nm
    ,start_date                               --授权起始日
	,authorization_scenario                   --授权场景(预评估,网申卡申请)
	,userid                                   --用户号
    ,row_number() over(partition by customer_id order by create_date desc) rn
from SJXQ_SJ2024120696_CST_01               t1
left join edw.ncip_zx_authorization_records t2 --征信授权记录表
on t1.cst_id=t2.customer_id
and t2.dt='@@{yyyyMMdd}'
and t2.create_date between '20241020' and '20241130'
;
-- 10.20-11.30期间客户经理是否向客户发送过电子征信授权书签署链接
-- edw.dim_bus_loan_ext_data_ahn_aply_rel_dd	外部数据授权关联表
DROP   TABLE IF     EXISTS SJXQ_SJ2024120696_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120696_CST_03_1 AS
SELECT  distinct img_no	as cst_id --影像编号
FROM    edw.loan_ext_data_ahn_aply_dtl --外部数据授权申请
WHERE   substr(replace(SYS_REG_TM,'-',''),1,8) BETWEEN '20241020' AND '20241130'
AND     ahn_mod = '03' -- 线上授权
AND     ahn_sts != '01' -- 不为待授权（既已分享出去）
AND     ahn_ctg_nm LIKE '%征信%'
AND     DT='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024120696_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120696_CST_04 AS
SELECT  t1.org_id               AS 机构号
       ,t1.org_nm               AS 机构
       ,t1.cst_id               AS 客户号
       ,t1.cst_nm               AS 客户名称
       ,t1.role_nm              AS 角色
       ,t3.query_reason_nm      AS 查询原因
       ,t3.authorization_way_nm AS 授权方式
       ,t3.is_e_sign            AS 是否签署过电子征信授权书1020_1130
       ,case when t4.cst_id is not null then '是' else '' end as 是否向客户发送电子征信授权书签署链接1020_1130
from SJXQ_SJ2024120696_CST_01       t1
left join SJXQ_SJ2024120696_CST_03  t3
on t1.cst_id=t3.customer_id
and t3.rn=1
left join SJXQ_SJ2024120696_CST_03_1 t4
on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024120696_CST_01
union all
-- SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
-- from SJXQ_SJ2024120696_CST_02
-- union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024120696_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024120696_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024120696_CST_04
***徐舒月_SJ2024121931_长乐村行数据.sql
﻿/*
截至2024年11月底长乐村行的数据
数据需求字段
1.账户状态正常的单位客户工商状态是否为注销、吊销
2.泰惠收未注销的单位客户工商状态是否为注销、吊销
3.年龄在46周岁及以下的个人客户，证件有效期是否为20年
详细取数字段见附件
*/
-- 工商数据 工商状态 工商经营状态
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_00 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_00 AS
select t1.cst_id
    ,t1.doc_nbr
    ,t2.lctax_cert_no	    --地税证件号|C60
    ,t3.company_status	    --登记状态
    ,t4.n_company_status	--归类后的登记状态
from edw.dws_cst_bas_inf_dd 			t1 --客户基础信息汇总表
left join edw.dim_cst_entp_bas_inf_dd	t2 --企业客户基本信息	54
on t1.cst_id=t2.cst_id
and t2.dt='20241130'
LEFT JOIN edw.NOUT_COMPANY_BASE         t3
on t1.doc_nbr=t3.credit_no
and t3.dt='20241130'
and nvl(t3.credit_no,'')<>''
LEFT JOIN edw.nout_company_base_clean   t4
on t3.company_id=t4.company_id
and t4.dt='20241130'
and t4.use_flag<>'10'  --10废弃数据
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t5 --客户`主管户`信息
on  t1.cst_id = t5.cst_id
and t5.dt = '20241130'
inner join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t5.prm_org_id = t6.org_id
and t6.dt = '20241130'
and t6.brc_org_nm regexp '福建长乐泰隆村镇'
where t1.dt= '20241130'
and t1.cst_typ_cd='2'   --对公 单位客户
and nvl(t1.doc_nbr,'')<>''
;
--客户存款账户信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_01 AS
select t1.cst_act_id
    ,t1.cst_act_nm                               --客户名称|C200
	,t1.cst_id                                   --客户编号|C20
    ,t2.cst_chn_nm                               --客户名称
	,t1.opn_dt                                   --开户日期|C8
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
from edw.dim_bus_dep_cst_act_inf_dd                 t1 --客户存款账户信息
inner join edw.dws_cst_bas_inf_dd 				    t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt= '20241130'
and t2.cst_typ_cd='2'   --对公 单位客户
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241130'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241130'
and t4.brc_org_nm regexp '福建长乐泰隆村镇'
where t1.dt='20241130'
and t1.ACT_STS_CD ='A'              --正常
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_02 AS
SELECT  t1.cst_id
    ,t1.mch_id	--商户编号|C32
    ,t1.mch_nm	--商户名称|C200
    ,t1.reg_dt	--注册日期|C8
    ,t1.mch_sts_cd
    ,decode(t1.mch_sts_cd,'99','中止','16','注销','00','执行中','') as mch_sts_nm
    ,t2.cst_chn_nm
    ,row_number() over(PARTITION  by t1.cst_id ORDER by t1.reg_dt desc,last_upd_tm desc) rn
FROM    edw.dim_bus_chnl_ths_mch_inf_dd     t1
inner join edw.dws_cst_bas_inf_dd 			t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt= '20241130'
and t2.cst_typ_cd='2'   --对公 单位客户
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241130'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241130'
and t4.brc_org_nm regexp '福建长乐泰隆村镇'
WHERE   t1.dt = '20241130'
AND     nvl(t1.cst_id,'') <> ''
AND     t1.mch_sts_cd <>'16' --商户状态 ,'99':'中止' ,'16':'注销' ,'00':'执行中'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_03 AS
SELECT  t1.cst_id
    ,t1.cst_chn_nm
    ,t2.age
    ,t1.doc_mtu_dt	                as doc_mtu_dt2
	,t5.doc_isu_dt                  --证件签发日期|C8
	,t5.doc_mtu_dt                  --证件到期日期|C8
    ,t5.cst_typ_cd                               --客户类型代码|C1
FROM edw.dws_cst_bas_inf_dd 			            t1 --客户基础信息汇总表
inner join adm_pub.adm_csm_cbas_idv_bas_inf_dd      t2 --对私客户基础信息
on t1.cst_id=t2.cst_id
and t2.dt='20241130'
and t2.age<=46
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241130'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241130'
and t4.brc_org_nm regexp '福建长乐泰隆村镇'
left join edw.dim_cst_bas_doc_inf_dd                t5 --客户证件信息
on t1.cst_id=t5.cst_id
and t1.doc_typ_cd=t5.doc_typ_cd
and t1.doc_nbr=t5.doc_nbr
and t5.dt='20241130'
WHERE t1.dt = '20241130'
and t1.cst_typ_cd='1'   --对私
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_04 AS
SELECT  t1.cst_id           AS 客户号
       ,t1.cst_chn_nm       AS 客户名称
       ,t2.n_company_status AS 工商登记状态
       ,t1.cst_act_id       AS 客户账号
       ,'正常'               AS 账户状态
from SJXQ_SJ2024121931_CST_01       t1
left join SJXQ_SJ2024121931_CST_00  t2
on t1.cst_id=t2.cst_id
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_05 AS
SELECT  t1.cst_id           AS 客户号
       ,t1.cst_chn_nm       AS 客户名称
       ,t2.n_company_status AS 工商登记状态
       ,t1.mch_sts_nm       AS 泰惠收状态
from SJXQ_SJ2024121931_CST_02       t1
left join SJXQ_SJ2024121931_CST_00  t2
on t1.cst_id=t2.cst_id
where t1.rn=1
;
-- 输出结果3
DROP   TABLE IF     EXISTS SJXQ_SJ2024121931_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121931_CST_06 AS
SELECT  cst_id     AS 客户号
    ,cst_chn_nm AS 客户名称
    ,age        AS 年龄
    ,doc_isu_dt AS 证件签发日期
    ,doc_mtu_dt AS 证件到期日期
    ,case when substr(doc_mtu_dt,1,4)-substr(doc_isu_dt,1,4)=20 then '是' else '' end as 证件有效期是否为20年
from SJXQ_SJ2024121931_CST_03
;
SElECT '00' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121931_CST_00
union all
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121931_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121931_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121931_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024121931_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024121931_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024121931_CST_06
;
/*
00	5679	5679
01	465	448
02	42	42
03	160927	160927
04	465	448
05	46	42
06	160927	160927
*/***方利利_SJ2024121806_未结清客户征信数据.sql
﻿-- 截至2024/11/30、2024/8/31两个时间点的，福清村行全量未结清信贷业务（贷款、随贷通）的客户的征信数据，村行需关注客户他行负债变化情况。
DROP   TABLE IF     EXISTS SJXQ_SJ2024121806_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121806_CST_01 AS
select t1.ctr_serno                              --合同流水号|C32
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
	,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t2.PD_NM
    ,case when t2.pd_nm regexp '随贷通' then 1 else 0 end is_sdt
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241130'
and t2.PD_NM not regexp '信用卡'
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd  t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20241130'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20241130'
and t4.brc_org_nm regexp '福建福清泰隆村镇'
where t1.dt='20241130'
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
--标准代码块：最新的中征分
DROP   TABLE IF     EXISTS SJXQ_SJ2024121806_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121806_CST_02 AS
select *
from(
    SELECT  t.cst_id
        ,t.prd_dt
        ,t.cst_cr_grd_val
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY  prd_dt DESC ) AS rn
    FROM
    (
        SELECT  cst_id
            ,to_date(REPLACE(substr(qry_tm,1,10),'-',''),'yyyymmdd') AS prd_dt
            ,cr_sco_val                                              AS cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
        WHERE dt <= '20241130'
        UNION
        SELECT  cst_id
            ,to_date(prd_dt,'yyyymmdd') AS prd_dt
            ,cst_cr_grd_val
        FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
        WHERE dt <= '20241130'
    ) t
)t1 where rn=1
;
-- 新预评估结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024121806_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121806_CST_03 AS
SELECT  T1.CST_ID,t1.cst_nm
    ,t1.mbrwr_cst_id    --主借款人客户号
    ,T1.PRE_ASES_SERNO
    ,t1.aply_org_id     --申请机构号
    ,t2.rul_set_rslt_nm --新预评估结果
    ,t4.org_nm          --申请机构
from(
	SELECT  CST_ID,PRE_ASES_SERNO
        ,cst_nm	        --客户名称
        ,mbrwr_cst_id	--主借款人客户号
        ,aply_org_id	--申请机构号|c32
        ,sys_reg_tm	    --系统登记时间|c19
	    ,row_number() over(partition by cst_id order by PRE_ASES_SERNO desc) rn
	FROM EDW.DWD_BUS_LOAN_PRE_ASES_BSN_APLY_DD --预评估业务申请
	WHERE DT = '20241130'
)t1 inner JOIN (
    SElECT t2.PRE_ASES_SERNO
    from EDW.DIM_BUS_LOAN_PRE_ASES_RUL_SET_REL_DD   t2 --预评估规则集关系
    LEFT JOIN edw.dwd_code_library_dd               T4
    ON  t2.RUL_SET_RSLT_CD = t4.cd_val
    AND T4.DT = '20241130'
    AND t4.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
    AND t4.fld_nm = 'RUL_SET_RSLT_CD'
    where t2.DT = '20241130'
    group by t2.PRE_ASES_SERNO
)T2 ON T1.PRE_ASES_SERNO = T2.PRE_ASES_SERNO
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.aply_org_id = t4.org_id
and t4.dt = '20241130'
where t1.rn=1
;
-- 新征信表
DROP   TABLE IF     EXISTS SJXQ_SJ2024121806_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121806_CST_04 AS
SELECT  cst_id
       ,report_dt	                 --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,oth_bank_loan_org_num        --他行贷款授信机构数
       ,oth_bank_loan_credit_bal     --他行贷款授信余额
       ,curr_unsett_fyh_loan_org_num --当前未结清非银行贷款机构数
       ,curr_unsett_fyh_loan_bal     --当前未结清非银行贷款余额
       ,cred_card_num                --信用卡张数
       ,cred_card_total_amt          --信用卡总授信额度
       ,cred_card_total_balan        --信用卡总余额
       ,late_year_enqu_count         --最近一年内的查询次数
       ,late_3mon_enqu_count         --最近3个月审批查询次数
       ,late_6mon_enqu_count         --最近6个月审批查询次数
       ,idv_crd_sco_val              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_idv_ind_inf_dd
where dt='20241130'
and report_dsc_rn='1'
union all
SELECT  cst_id
       ,report_dt	                 --报告日期
       ,cred_total_amt               --授信总额（信用总额）
       ,cred_total_balan             --授信余额（信用总余额）
       ,OTH_BANK_BUSI_ORG_NUM        --他行贷款授信机构数
       ,NUll
       ,un_sett_loan_rzbank_num	 	--未结清贷款授信机构数
       ,un_sett_loan_total_amt
       ,0                --信用卡张数
       ,0          	--信用卡总授信额度
       ,0        	--信用卡总余额
       ,NUll         --最近一年内的查询次数
       ,NUll         --最近3个月审批查询次数
       ,NUll         --最近6个月审批查询次数
       ,NUll              --个人信用评分分值|DECIMAL(4,0)
from edw.dws_cst_ccrc_entp_ind_inf_dd
where dt='20241130'
and report_dsc_rn='1'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024121806_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121806_CST_05 AS
SELECT  t1.cst_id                       AS 客户号
       ,t1.cst_nm                       AS 客户名
       ,t1.org_nm                       AS 管户机构
       ,t1.mgr_nm                       AS 管户人
       ,t1.ctr_amt                      AS 客户授信总金额
       ,t1.ctr_bal                      AS 客户授信总余额
       ,t1.lst_mtu_dt                   AS 合同最近到期日
       ,t2.prd_dt                       AS 中征分日期
       ,t2.cst_cr_grd_val               AS 中征分
       ,t4.report_dt                    AS 征信报告日期
       ,t4.idv_crd_sco_val              AS 征信分
       ,t4.oth_bank_loan_org_num        AS 他行贷款授信机构数
       ,t4.oth_bank_loan_credit_bal     AS 他行贷款授信余额
       ,t4.curr_unsett_fyh_loan_org_num AS 当前未结清非银行贷款机构数
       ,t4.curr_unsett_fyh_loan_bal     AS 当前未结清非银行贷款余额
       ,t4.cred_card_num                AS 信用卡张数
       ,t4.cred_card_total_amt          AS 信用卡总授信额度
       ,t4.cred_card_total_balan        AS 信用卡总余额
       ,t4.late_year_enqu_count         AS 最近一年内的查询次数
       ,t4.late_6mon_enqu_count         AS 最近6个月审批查询次数
       ,t4.late_3mon_enqu_count         AS 最近3个月审批查询次数
       ,t3.rul_set_rslt_nm              AS 客户预评估结果
       ,t1.sdt_amt                      AS 我行随贷通额度
       ,t1.sdt_bal                      AS 我行随贷通余额
from(
    SELECT cst_id,cst_nm,mgr_nm,org_nm
        ,sum(ctr_amt) as ctr_amt
        ,sum(ctr_bal) as ctr_bal
        ,min(ctr_mtu_dt)    as lst_mtu_dt
        ,sum(case when is_sdt=1 then ctr_amt else 0 end) as sdt_amt
        ,sum(case when is_sdt=1 then ctr_bal else 0 end) as sdt_bal
    from SJXQ_SJ2024121806_CST_01
    group by cst_id,cst_nm,mgr_nm,org_nm
)t1 left join SJXQ_SJ2024121806_CST_02  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024121806_CST_03      t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024121806_CST_04      t4
on t1.cst_id=t4.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024121806_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121806_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121806_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024121806_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024121806_CST_05
***朱燕妮_SJ20241224151_全行担保函数据.sql
﻿-- 截止2024年12月31日，全行担保函数据。
DROP   TABLE IF     EXISTS SJXQ_SJ20241224151_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241224151_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,T1.ctr_amt * T6.AVG_PRC / T6.QUO_UNT as ctr_amt_cny
    ,T1.ctr_bal * T6.AVG_PRC / T6.QUO_UNT as ctr_bal_cny
    ,t1.mgr_org_id	    --管户机构号
    ,t3.grnt_ctr_no	    --担保合同编号
    ,DECODE(t3.grnt_ctr_typ,'010' , '一般担保' , '020' , '最高额担保' , '030' , '担保函' , '040' , '线下担保合同' , '999' , '他行代签协议','') as 担保合同类型
    ,t4.brc_org_nm
	,t5.wrat_cst_id                              --被担保人客户号|c20
	,t5.wrat_nm                                  --被担保人名称|c200
    ,t5.prtn_no     --合作方编号
    ,t5.prtn_nm     --合作方名称
    ,t5.grnt_ctr_sts
    ,DECODE(t5.grnt_ctr_sts,'1','未生效','2','已生效','3','终止','4','冻结','5','作废','') as grnt_ctr_sts_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241231'
and t2.PD_NM not regexp '信用卡'
inner join edw.loan_ctr_rel_grnt	t3 --主合同关联担保合同表
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20241231'
and t3.grnt_ctr_typ='030'	--	担保合同类型代码 010 一般担保 020 最高额担保 030 担保函 040 线下担保合同 999 他行代签协议
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20241231'
and t4.brc_org_nm not like '%村镇银行%'
left join edw.loan_ctr_ltr_grnt t5      --合同担保函信息
ON t3.GRNT_CTR_NO = t5.LTR_GRNT_NO
AND t5.dt = '20241231'
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD T6 --汇率信息
ON      t1.bsn_ccy_cd = T6.CCY_CD
AND     T6.dt='20241231'
where t1.dt='20241231'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241224151_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241224151_CST_02 AS
SELECT  wrat_cst_id  AS 被担保人客户号
        ,wrat_nm     AS 被担保人名称
        ,ctr_serno   AS 合同流水号
        ,ctr_amt_cny AS 合同金额_折人民币
        ,ctr_bal_cny AS 合同余额_折人民币
        ,grnt_ctr_no AS 担保函编号
        ,grnt_ctr_sts_nm as 担保函状态
        ,prtn_no     AS 合作方编号
        ,prtn_nm     AS 合作方名称
        ,brc_org_nm  AS 所属分行
FROM SJXQ_SJ20241224151_CST_01
where grnt_ctr_no<>'GLMN2024120200000009'
union all
SELECT   t5.wrat_cst_id  AS 被担保人客户号
        ,t5.wrat_nm     AS 被担保人名称
        ,t1.ctr_serno   AS 合同流水号
        ,t1.ctr_amt_cny AS 合同金额_折人民币
        ,t1.ctr_bal_cny AS 合同余额_折人民币
        ,t1.grnt_ctr_no AS 担保函编号
        ,DECODE(t5.grnt_ctr_sts,'1','未生效','2','已生效','3','终止','4','冻结','5','作废','') as 担保函状态
        ,t5.prtn_no     AS 合作方编号
        ,t5.prtn_nm     AS 合作方名称
        ,t1.brc_org_nm  AS 所属分行
FROM SJXQ_SJ20241224151_CST_01  t1
left join edw.loan_ctr_ltr_grnt t5      --合同担保函信息
ON t1.GRNT_CTR_NO = t5.LTR_GRNT_NO
AND t5.dt = '20241211'
where t1.grnt_ctr_no='GLMN2024120200000009'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno,grnt_ctr_no) custs
from SJXQ_SJ20241224151_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241224151_CST_02
;
SElECT *
from SJXQ_SJ20241224151_CST_02
;
/*
01	3015	3015
02	3015	2781
edw.loan_ctr_rel_grnt   --主合同关联担保合同表
edw.loan_ctr_ltr_grnt   --合同担保函信息
edw.dwd_bus_loan_ctr_rel_grnt_dd	 --主合同、担保合同关系
edw.dim_bus_loan_ctr_ltr_grnt_inf_dd --合同担保函信息   数据不全 用信贷系统表
SELECT *
from edw.loan_ctr_ltr_grnt
where dt>='20241101'
,'GLMN2024120600000005')
;
*/
SELECT 'loan_ctr_ltr_grnt' tbl_nm
    ,count(1) cnt
    ,count(DISTINCT LTR_GRNT_NO) as 担保函编号
from edw.loan_ctr_ltr_grnt   --合同担保函信息
where dt='20241231'
;
tbl_nm	cnt	担保函编号
loan_ctr_ltr_grnt	3228	3228
SELECT 'dim_bus_loan_ctr_ltr_grnt_inf_dd' tbl_nm
    ,count(1) cnt
    ,count(DISTINCT LTR_GRNT_NO) as 担保函编号
from edw.dim_bus_loan_ctr_ltr_grnt_inf_dd   --合同担保函信息
where dt='20241231'
;
tbl_nm	cnt	担保函编号
dim_bus_loan_ctr_ltr_grnt_inf_dd	2963	2963
***林小素_SJ2024120636_审查人信息.sql
﻿-- 经办人是重点关注人员
DROP   TABLE IF EXISTS SJXQ_SJ2024120636_CST2_01 PURGE;
CREATE TABLE           SJXQ_SJ2024120636_CST2_01
(
    hdl_opr_id      string COMMENT '工号'
    ,hdl_opr_nm     string COMMENT '客户经理姓名'
    ,hdl_org_nm     string COMMENT '所属团队'
)
;
insert into SJXQ_SJ2024120636_CST2_01
values
;
-- 审查人是一级信贷调查资质客户经理
DROP   TABLE IF EXISTS SJXQ_SJ2024120636_CST2_02 PURGE;
CREATE TABLE           SJXQ_SJ2024120636_CST2_02
(
    rvw_empe_id      string COMMENT '工号'
    ,rvw_empe_nm     string COMMENT '客户经理姓名'
    ,rvw_org_nm      string COMMENT '所属团队'
)
;
insert into SJXQ_SJ2024120636_CST2_02
values
;
--贷款合同基础信息
DROP   TABLE IF EXISTS SJXQ_SJ2024120636_CST2_03 PURGE;
CREATE TABLE           SJXQ_SJ2024120636_CST2_03 as
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	        --	用信申请流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no	    --产品编号|c32
    ,t2.PD_NM
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,c1.cd_val_dscr	    as hpn_typ_nm --发生类型
    ,t1.cst_rsk_grd_cd	--客户风险等级代码 越高风险越大
    ,t1.CTR_STS_CD
    ,decode(t1.CTR_STS_CD,'1' , '未生效' , '2' , '已生效' , '3' , '终止' , '4' , '冻结' , '5' , '作废') as CTR_STS_nm
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,case when nvl(t3.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t3.sam_rsk_ctrl_id end sam_rsk_ctrl_id
    ,t6.rsk_lyr_cd	    --风险分层代码|c1
    ,decode(t6.rsk_lyr_cd,'1','低风险','2','中低风险','3','中风险','4','中高风险','5','高风险','') AS 风险分层 --不是合同表的客户风险等级
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.DWS_CST_BAS_INF_DD            t3
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           c1
ON  t1.hpn_typ_cd = C1.CD_VAL
AND C1.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_bus_loan_lmt_biz_stat_inf_dd t6 --统计类信息
ON      t1.rel_serno = t6.usc_aply_serno
AND     t6.dt = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
and t4.brc_org_nm regexp '温州分行'
and t1.CTR_STS_CD = '2' -- '1' , '未生效' , '2' , '已生效' , '3' , '终止' , '4' , '冻结' , '5' , '作废'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 所属条线
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_04 AS
select t1.bus_ctr_id                             --信贷合同编号
from app_rpt.ADM_PUB_BUS_LOAN_DBIL_INF_DD   t1    --公共集市-贷款业务信息汇总表
INNER JOIN SJXQ_SJ2024120636_CST2_03        t2
on t1.bus_ctr_id=t2.ctr_serno
where t1.dt='@@{yyyyMMdd}'
group by t1.bus_ctr_id
;
-- 申请流水号	客户编号	客户名称	部门	机构	客户经理	客户经理工号	客户经理资质	审查人姓名	收到时间	审查时间	审查意见
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_05 AS
SELECT  A1.usc_aply_serno
        ,A1.aply_epsr_amt
        ,A1.apl_amt
        ,a2.ahn_ltr_aply_serno                          --申请流水号
        ,a2.cst_id                                      AS 客户编号
        ,a2.cst_nm                                      AS 客户名称
        ,a5.tem_org_nm                                 AS 团队
        ,a5.org_nm                                     AS 部门
        ,a6.empe_nm                                    AS 客户经理
        ,a2.sys_reg_psn_id                              AS 客户经理工号
        ,a9.cd_val_dscr                                AS 客户经理资质
        ,a4.user_id     AS 审查人工号
        ,a7.empe_nm                                   AS 审查人姓名
		,a4.start_time	                               AS 评论时间
        ,a4.comment_sign                               AS 审查意见
		,a4.user_comment                               AS 用户评价
        ,a4.role_id,a4.node_id,a4.node_nm
FROM    edw.dwd_bus_loan_lmt_aply_biz_dd    a1  --用信方案
left join edw.dwd_bus_loan_lmt_aply_info_dd a2   -- 授用信申请信息
ON      a2.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
AND     a2.cst_id = A1.cst_id
AND     a2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a3 --流程运行实例历史表
ON      a2.ahn_ltr_aply_serno = a3.biz_id
AND     a2.sys_reg_psn_id = a3.flow_starter     --授信申请登记者 = 流程发起者   不然会有多条记录
AND     a3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_n_wf_comment_his_dd a4 --流程审批意见历史
ON      a3.main_instance_id = a4.instance_id
AND     a4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a5 --机构树_考核维度
ON      a2.sys_reg_org_id = a5.org_id
AND     a5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd a6 --员工汇总信息
ON      a2.sys_reg_psn_id = a6.empe_id
AND     a6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd a7 --员工汇总信息
ON      a4.user_id = a7.empe_id
AND     a7.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_tlcb_usr_qualf_info a8 --用户资质表
ON      a2.sys_reg_psn_id = a8.user_code
AND     a8.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd a9 -- 码值表
ON      a8.qualf_lvl = a9.cd_val
AND     a9.tbl_nm = 'DWD_BUS_LOAN_CST_SVY_RCD_DD'
AND     a9.fld_nm = 'JOB_QUALF_CD'
AND     a9.DT = '@@{yyyyMMdd}'
WHERE   a1.dt = '@@{yyyyMMdd}'
AND     a5.brc_org_nm = '温州分行'
;
--合同审批流程
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_05_1 AS
SELECT t1.ctr_serno,t1.rel_serno
    ,t2.ahn_ltr_aply_serno                       --授用信申请流水号 业务流水号
    ,t3.instance_id                              --流程实例id
    ,t3.flow_name                                --流程名称
    ,t3.flow_starter_name                        --发起者名称
    ,replace(t3.start_time,'/','') as lc_start_time --流程发起时间
    ,t3.org_id                                   --发起人机构id
    ,t3.biz_id                                   --业务流水号|c32
    ,t3.biz_type_cd                              --业务类型代码|c32
from SJXQ_SJ2024120636_CST2_03                  t1
LEFT JOIN edw.dwd_bus_loan_lmt_aply_biz_dd      t2 --用信方案
on t1.rel_serno=t2.USC_APLY_SERNO
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_n_wf_instance_his_dd t3 --流程运行实例历史表
on t2.ahn_ltr_aply_serno=t3.biz_id
and t3.dt='@@{yyyyMMdd}'
where t1.brc_org_nm='温州分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_05_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_05_2 AS
SELECT t3.ctr_serno,t3.rel_serno
    ,t3.biz_id                                  --授用信申请流水号 业务流水号
    ,t3.instance_id                             --流程实例id
    ,t4.comment_id                              --主键|c32
    ,t4.user_id                                  --用户id|c32
    ,t5.empe_nm as user_name                     --用户名称
    ,t4.comment_sign                             --用户结论|c5
    ,t4.start_time                               --评论时间|c32
    ,t4.role_id                                  --审批人角色id|c32
    ,t4.user_comment                             --用户评价|c1000
    ,t4.node_nm                                --节点名称|c32
    ,t4.org_id          as cmt_org_id          --所属机构编号|c32
    ,ROW_NUMBER() over(partition by t3.ctr_serno order by t4.start_time desc) rn
from SJXQ_SJ2024120636_CST2_05_1                t3
left join edw.dwd_bus_loan_n_wf_comment_his_dd  t4    --流程审批意见历史
on t3.instance_id=t4.instance_id
and t4.dt='@@{yyyyMMdd}'
left join edw.dws_hr_empe_inf_dd                t5 --员工信息汇总
on  substr(t4.user_id,1,6)=t5.empe_id
and t5.dt='@@{yyyyMMdd}'
where (t4.role_id = '2047' or t4.node_nm regexp '团队审查岗')
;
-- 最终审批人
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_06 AS
SELECT  A1.usc_aply_serno
    ,A1.aply_epsr_amt
    ,A1.apl_amt
    ,t.exec_intr_rat
    ,B.user_name
    ,B.user_id
    ,B.node_name
    ,c.comment_sign
    ,ROW_NUMBER() OVER ( PARTITION BY A1.usc_aply_serno ORDER BY B.end_time DESC ) AS RN
FROM    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息
ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
AND     T.cst_id = A1.cst_id
AND     T.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表
ON      t.ahn_ltr_aply_serno = a.biz_id
AND     t.sys_reg_psn_id = a.flow_starter ---- 授信申请登记者 = 流程发起者   不然会有多条记录
AND     a.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表  --只保留了最后一次流程提交或审批的时间
ON      a.main_instance_id = b.instance_id
AND     b.dt = '@@{yyyyMMdd}'
left join edw.dwd_bus_loan_n_wf_comment_his_dd c   --流程审批意见历史
on      a.main_instance_id=c.main_instance_id
and     c.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T2 --机构树_考核维度
ON      T.sys_reg_org_id = T2.org_id
AND     T2.DT = '@@{yyyyMMdd}'
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     T2.brc_org_nm = '温州分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_06_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_06_1 AS
SELECT t1.*
from SJXQ_SJ2024120636_CST2_05          t1
INNER JOIN SJXQ_SJ2024120636_CST2_03    t2
on t1.usc_aply_serno=t2.rel_serno
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_06_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_06_2 AS
SELECT t1.*
from SJXQ_SJ2024120636_CST2_06          t1
INNER JOIN SJXQ_SJ2024120636_CST2_03    t2
on t1.usc_aply_serno=t2.rel_serno
where rn=1
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_07 AS
SELECT *
from(
    SELECT  t1.cst_id,t1.ctr_serno
    ,t2.dbil_srl_no               --借据流水号
    ,t2.dbil_bal_cny              --余额
    ,t2.grant_amt                 --发放金额
    ,t2.grant_date                --发放日期
    ,t2.mng_empe_id               --管户人工号
    ,t2.opr_empe_id               --经办客户经理
    ,t2.opr_dept_lead_empe_id     --经办部门负责人
    ,t2.opr_sub_brch_prsd_empe_id --经办支行行长
    ,t2.rvw_empe_id               --经办审查人
    ,t2.final_aprv_empe_id        --最终审批人
    ,t2.dt
    ,row_number() over(partition by t2.dbil_srl_no order by t2.dt desc) rn
    from SJXQ_SJ2024120636_CST2_03              t1
    left join adm_rsk.adm_rsk_apl_inter_all	    t2 --风险集市应用表-资产质量日常监测源表
    on t1.ctr_serno=t2.ctr_srl_no
    and t2.dt<='@@{yyyyMMdd}'
    where t1.brc_org_nm regexp '温州分行'
)t1 where rn=1
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_08 AS
SELECT  t1.ctr_serno          AS 合同流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.hpn_typ_nm         AS 发生类型
       ,t1.ctr_amt            AS 合同金额
       ,t1.ctr_bal            AS 合同余额
       ,t1.ctr_bgn_dt         AS 合同起始日期
       ,t1.ctr_mtu_dt         AS 合同到期日期
       ,t1.CTR_STS_nm         AS 合同状态
       ,t3.ctr_epsr_amt       AS 同一风险控制号总敞口金额
       ,t1.cst_rsk_grd_cd     AS 客户风险等级代码_越高风险越大
       ,DECODE(t4.LINE_OF_BUS_CD, '010', '普惠', '020', '小企业', '040', '直销银行', '050', '大客户', '070'
            , '国际业务', '080', '科技企业', '110', '资产保全', '130', '总行营业部', '140', '其他'
            , '150', '储蓄专营','') AS 业务所属条线
       ,t1.风险分层
       ,t1.hdl_opr_id         AS 经办人工号
       ,t2.hdl_opr_nm         AS 经办人
       ,t2.hdl_org_nm         AS 经办人所属团队
       ,t5.rvw_empe_id        AS 经办审查人
       ,t5.final_aprv_empe_id AS 最终审批人
from SJXQ_SJ2024120636_CST2_03       t1
inner join SJXQ_SJ2024120636_CST2_01 t2
on t1.hdl_opr_id=t2.hdl_opr_id
left join(
    select sam_rsk_ctrl_id
        ,sum(ctr_epsr_amt) ctr_epsr_amt
    from SJXQ_SJ2024120636_CST2_03
    group by sam_rsk_ctrl_id
)t3 on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
left join SJXQ_SJ2024120636_CST2_04  t4
on t1.ctr_serno=t4.bus_ctr_id
left join (
    SElECT ctr_serno
    from SJXQ_SJ2024120636_CST2_07
    group by ctr_serno
) t5 on t1.ctr_serno=t5.ctr_serno
where t1.CTR_STS_CD='2'     --已生效
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ2024120636_CST2_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120636_CST2_09 AS
SELECT  t1.ctr_serno          AS 合同流水号
       ,t1.cst_id             AS 客户号
       ,t1.cst_nm             AS 客户名称
       ,t1.hpn_typ_nm         AS 发生类型
       ,t1.ctr_amt            AS 合同金额
       ,t1.ctr_bal            AS 合同余额
       ,t1.ctr_bgn_dt         AS 合同起始日期
       ,t1.ctr_mtu_dt         AS 合同到期日期
       ,t1.CTR_STS_nm         AS 合同状态
       ,t3.ctr_epsr_amt       AS 同一风险控制号总敞口金额
       ,t1.cst_rsk_grd_cd     AS 客户风险等级代码_越高风险越大
       ,DECODE(t4.LINE_OF_BUS_CD, '010', '普惠', '020', '小企业', '040', '直销银行', '050', '大客户', '070'
            , '国际业务', '080', '科技企业', '110', '资产保全', '130', '总行营业部', '140', '其他'
            , '150', '储蓄专营','') AS 业务所属条线
       ,t1.风险分层
       ,t1.hdl_opr_id         AS 经办人工号
       ,t1.hdl_opr_nm         AS 经办人
       ,t1.tem_org_nm         AS 经办人所属团队
       ,t5.rvw_empe_id        AS 经办审查人
       ,t5.final_aprv_empe_id AS 最终审批人
from SJXQ_SJ2024120636_CST2_03       t1
left join(
    select sam_rsk_ctrl_id
        ,sum(ctr_epsr_amt) ctr_epsr_amt
    from SJXQ_SJ2024120636_CST2_03
    group by sam_rsk_ctrl_id
)t3 on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
left join SJXQ_SJ2024120636_CST2_04  t4
on t1.ctr_serno=t4.bus_ctr_id
left join (
    SElECT ctr_serno
    from SJXQ_SJ2024120636_CST2_07
    group by ctr_serno
) t5 on t1.ctr_serno=t5.ctr_serno
inner join SJXQ_SJ2024120636_CST2_02 t2
on substr(t5.rvw_empe_id,1,6)=t2.rvw_empe_id
where t1.CTR_STS_CD='2'     --已生效
;
SElECT '01' seq, count(1) cnt,count(distinct hdl_opr_id) custs
from SJXQ_SJ2024120636_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct rvw_empe_id) custs
from SJXQ_SJ2024120636_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024120636_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct bus_ctr_id) custs
from SJXQ_SJ2024120636_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct usc_aply_serno) custs
from SJXQ_SJ2024120636_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct usc_aply_serno) custs
from SJXQ_SJ2024120636_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024120636_CST2_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024120636_CST2_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ2024120636_CST2_09
;
/*
01	23	23
02	71	71
03	18779	18779
04	17520	17520
05	486092	119005
06	2456591	119005
07	181681	22560
08	2427	2427
09	663	663
*/
SElECT '08' seq,*
from lab_bigdata_dev.SJXQ_SJ2024120636_CST2_08
;
SElECT '09' seq, *
from lab_bigdata_dev.SJXQ_SJ2024120636_CST2_09
***梁俊杰_SJ20241217176_村镇银行央行评级.sql
﻿--梁俊杰017600-用于2024年度村镇银行央行评级
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_01 AS
SELECT  T1.COL_1   --序号
        ,T1.COL_2  --客户号
        ,T1.COL_3  --户名
        ,T1.COL_4  --贷款账号
        ,T1.COL_5  AS 贷款余额
        ,T1.COL_6  AS 贷款类型
        ,T1.COL_7  AS 借款日
        ,T1.COL_8  AS 首次放款日
        ,T1.COL_9  AS 到期日
        ,T1.COL_10 AS 担保方式
        ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t5.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
        ,t5.doc_nbr,t5.DOC_TYP_CD
        ,t3.dbil_id,t3.cst_id
        ,t3.out_acc_serno	    --	出账流水号|c32
        ,t3.ctr_serno	        --	合同流水号|c32
        ,t3.usc_aply_serno	    --	用信申请流水号
        ,t3.prcp_bal,t3.onbs_ovd_intr_bal + t3.ofbs_ovd_intr_bal as ovd_intr_bal
        ,t3.rcv_acr_intr	--	应收应计利息
FROM    qbi_file_20241219_15_55_06_0    T1
left join (
    SELECT  t1.customerid
        ,t1.attribute2
        ,t1.inliststatus
        ,CASE WHEN t1.attribute2 = '50' THEN '禁止' WHEN t1.attribute2 = '60' THEN '提示' END attribute2_nm --严重程度
        ,case when t1.inliststatus='2' then '有效' when t1.inliststatus='1' then '无效' end inliststatus_nm --是否有效
        ,ROW_NUMBER() OVER ( PARTITION BY customerid ORDER BY  serialno DESC ) rn --一个客户有多条信息
    from edw.dwd_bus_loan_customer_special_dd t1 --我行预保预报名单库明细表 edw.loan_customer_special t1 --特定客户名单
    WHERE t1.dt = '20240719'        --老信贷
    and nvl(t1.customerid,'')<>''
    and t1.inlistreason='PR2019110200000010' --'逃废银行债务'
)t2 on t1.COL_2=t2.customerid
and t2.rn=1
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.COL_2=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_dbil_inf_dd  t3
on t1.col_4=t3.dbil_id
and t3.dt='@@{yyyyMMdd}'
WHERE   T1.PT <> ''
;
/*
客户是否涉及司法诉讼、仲裁和执行案件: fqm_fxmsgnum	string	风险信息条数
客户是否失信执行人: fqm_shixinnum	string	失信老赖名单数
客户是否欠税: fqm_qianshuinum	string	欠税名单数
是否进入了破产清算程序:fqm_qingsuannum	string	清算记录数
edw.nout_fy_query_main  法院精确查询主信息表    这个表应该是增量表，用fqm_ctfno证件号关联
*/
--法院精确查询主信息表
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_02 AS
SELECT  t1.*,t5.cst_id,t5.cst_chn_nm
    ,row_number() OVER ( PARTITION BY t1.fqm_ctfno ORDER BY t1.FQM_HOSTSENDTIME DESC ) AS rn
from(
    select fqm_stype                                --查询模式（1：查询个人信息；2：查询企业信息；3：查询个体工商户；默认为查询个人模式）
        ,fqm_hostsendtime                         --交易发送主机时间
        ,fqm_ctfno                                --证件号
        ,fqm_globaltype
        ,fqm_namecn                               --客户姓名
        ,fqm_fxmsgnum                             --风险信息条数
        ,fqm_shixinnum                            --失信老赖名单笔数
        ,fqm_qianshuinum
        ,fqm_qingsuannum                          --审判清算命中条数
        ,fqm_clienttype                           --客户类型    1：对私；2：对公；0：同业
    from edw.outd_fy_query_main                   --法院精确查询主信息表
    where dt='@@{yyyyMMdd}'
    union all
    select fqm_stype                              --查询类型stype =1表示查询个人信息；stype =2表示查询企业信息； Stype=3表示查询个体工商户；默认为查询个人模式
        ,fqm_hostsendtime                         --数据时间
        ,fqm_ctfno                                --统一社会信用代码
        ,fqm_globaltype
        ,fqm_namecn                               --企业名称
        ,fqm_fxmsgnum                             --风险信息条数
        ,fqm_shixinnum                            --失信老赖名单数
        ,fqm_qianshuinum                          --欠税名单数
        ,fqm_qingsuannum                          --清算记录数
        ,fqm_clienttype                           --客户类型1：对私；2：对公；0：同业
    from edw.nout_fy_query_main                   --法院精确查询主信息表
    where dt='@@{yyyyMMdd}'
    and ifrichard = '1'   ----表示已查得
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.fqm_ctfno=t5.doc_nbr
and t1.fqm_globaltype=t5.DOC_TYP_CD
and t5.dt='@@{yyyyMMdd}'
;
/*
用身份证号关联；增量表，按照身份证号取最新一笔数据就可以
有两点要注意，一是这个数据23年12月才开始有调用，有些客户可能没有覆盖
二是这个数据的命中很低的，如果匹配上但是没命中也很正常
*/
-- 客户主要负责人员是否涉黑涉恶
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_03 AS
select t1.*,t5.cst_id,t5.cst_chn_nm     --只有1个关联不到 cst_id
from(
    SELECT  in_certno          --查询人身份证号
        ,in_name               --查询人姓名
        ,insert_time_chinadaas --插入时间
        ,dt_bbf_shsk_year      --命中涉黑涉恐距今年份(0：未命中；1：3年以内；2：3-5年；3：5-10年；4：10年以上；5：未知)
        ,row_number() over(partition by in_certno order by insert_time_chinadaas desc) rn
    from edw.nout_bh_bc_fxtcv2  t1 --百行征信百辰-风险探测接口
    where t1.dt<='@@{yyyyMMdd}'
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.in_certno=t5.doc_nbr
and t5.dt='@@{yyyyMMdd}'
where t1.rn=1
and t1.dt_bbf_shsk_year>'0'    -- 查看 5 多不多 没有
;
-- 关联人
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_03_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_03_1 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    ,t2.cst_chn_nm	--客户姓名|C200
from(
    SElECT cst_id,rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ IN ( '0101' , '0109' ) --法定代表人、实控人
    union
    SElECT rel_cst_id,cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ IN ( '0101' , '0109' ) --法定代表人、实控人
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
;
-- 法人实控人是否涉黑涉恶
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_03_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_03_2 AS
select t1.cst_id
    ,max(case when t3.cst_id is not null then 1 else 0 end) as main_lead_is_he
from(
    SElECT distinct cst_id
    from SJXQ_SJ20241217176_CST_01
)t1 inner join SJXQ_SJ20241217176_CST_03_1  t2
on t1.cst_id=t2.cst_id
left join SJXQ_SJ20241217176_CST_03         t3
on t2.rel_cst_id=t3.cst_id
group by t1.cst_id
;
-- 工商经营状态
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_04 AS
SELECT  GEB_CREDITCODE      --统一社会信用代码
       ,GEB_ENTSTATUS      --经营状态
       ,GEB_HOSTSENDTIME
FROM
(
	SELECT  *
	       ,ROW_NUMBER()over(PARTITION BY GEB_CREDITCODE ORDER BY  GEB_HOSTSENDTIME DESC) AS rn
	FROM
	(
        SELECT  GEB_CREDITCODE      --统一社会信用代码
            ,GEB_ENTSTATUS          --经营状态
            ,GEB_HOSTSENDTIME       --geb_hostsendtime
		FROM edw.OUTD_GS_ENTINFO_BASIC
		WHERE dt <= '@@{yyyyMMdd}'
		UNION ALL
		SELECT  dt_creditcode         AS GEB_CREDITCODE     --统一信用代码
		       ,dt_entstatus          AS GEB_ENTSTATUS      --经营状态
		       ,insert_time_chinadaas AS GEB_HOSTSENDTIME
		FROM edw.nout_zs_ent_basic
		WHERE dt <= '@@{yyyyMMdd}'
	) t1
) t2
WHERE t2.rn = 1
;
-- 另一种口径
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_04_1 AS
SELECT  GEB_CREDITCODE  --统一社会信用代码,
    ,GEB_ENTSTATUS      --经营状态,
    ,substr(GEB_HOSTSENDTIME,1,8) as geb_hostsendtime
FROM    edw.OUTD_GS_ENTINFO_BASIC --老工商数据基本信息表
WHERE dt <= '@@{yyyyMMdd}' limit 10
union
SELECT csld_crd_cd
    ,opr_sts	--经营状态
    ,substr(replace(QRY_TM,'-',''),1,8)
FROM    edw.DIM_CST_OUT_GEB_BAS_INF_DD --新工商数据基本信息表
WHERE   dt = '@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_04_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_04_2 AS
SELECT t1.*,t2.cst_id as cst_id2
from(
    SELECT cst_id	        --客户号|C10
        ,usc_no	            --统一信用代码
        ,opr_sts_nm	        --经营状态名称
        ,inst_tm	        --插入时间
        ,ROW_NUMBER() over(partition by usc_no order by inst_tm desc) rn
    from edw.dim_cst_out_geb_entp_bsc_inf t1
)t1 left join (
    SELECT lctax_cert_no,cst_id,late_upd_dt
        ,ROW_NUMBER() over(partition by lctax_cert_no order by late_upd_dt desc) rn
    from edw.dim_cst_entp_bas_inf_dd
    where dt='@@{yyyyMMdd}'
) t2 on t1.usc_no=t2.lctax_cert_no
where t1.rn=1
and t2.rn=1
;
-- 他行逾期
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_05 AS
select cst_id,report_dt	--报告日期
    ,c_od_amt	--	当前逾期总额
    ,bitdilmt	--	不良余额比例
    ,0       as gura_total_bl_balan
    ,'个人' as cst_type
from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
where dt='@@{yyyyMMdd}'
and report_dsc_rn=1
union all
select t1.cst_id,t1.report_dt	--报告日期
    ,nvl(t2.客户当日信贷逾期金额求和_企业征信,0)
    ,t1.un_sett_bad_cl_total_balan	                --	未结清不良信贷信用总余额
    ,t3.客户当日相关还款责任不良余额求和_企业征信
    ,'企业'
from edw.dws_cst_ccrc_entp_ind_inf_dd t1 --企业征信指标信息表
left join(
    SELECT  report_id
        ,SUM(over_total) AS 客户当日信贷逾期金额求和_企业征信
    FROM edw.ncip_ce_m_account_info AS A
    WHERE a.dt <= '@@{yyyyMMdd}'
    AND a.account_state = '1' --未结清
    GROUP BY  report_id
)t2 on t1.report_no=t2.report_id
left join(
    SELECT  REPORT_ID
        ,SUM(BALANCE) AS 客户当日相关还款责任不良余额求和_企业征信 --对外担保
    FROM
    (
        SELECT  REPORT_ID
            ,coalesce(SUM(acc_rec_balance),0)+coalesce(SUM(oth_acc_att_balance),0)+coalesce(SUM(oth_acc_bad_balance),0) AS BALANCE
        FROM edw.ncip_eb05ah_esrs_sr_transub
        WHERE DT <= '@@{yyyyMMdd}'
        AND liabily_tyoe = '0'
        GROUP BY  REPORT_ID
        UNION ALL
        SELECT  T3.REPORT_ID ,SUM(T3.BALANCE) AS BALANCE
        FROM
        (
            SELECT  T1.REPORT_ID ,T1.GUAR_TRANS_BUSI_SUBDI ,T2.FIVE_LEVEL_CLASS ,T2.ACC_ACTIV_STATUS ,T2.BALANCE
            FROM edw.NCIP_ED04A_EDGB_GUA T1 -- 担保账户基本信息
            LEFT JOIN edw.NCIP_ED04B_EDGR_GUA T2
            ON T2.UNION_ID = T1.ID
            AND T2.DT <= '@@{yyyyMMdd}' -- 担保账户在保责任信息
            WHERE T1.DT <= '@@{yyyyMMdd}'
        ) T3
        AND T3.ACC_ACTIV_STATUS = '1'
        GROUP BY  T3.REPORT_ID
    ) AS aa
    GROUP BY  REPORT_ID
)t3 on t1.report_no=t3.report_id
where t1.dt='@@{yyyyMMdd}'
and t1.report_dsc_rn=1
;
--担保合同保证人信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_06 AS
SElECT distinct t1.cst_id,t1.ctr_serno
    ,t3.gtor_no                     --保证人编号|c20
    ,t3.gtor_nm                     --保证人名称|c200
from (
    SELECT DISTINCT cst_id,ctr_serno
    from SJXQ_SJ20241217176_CST_01
)t1 INNER JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd    t2 --主合同、担保合同关系
on t1.ctr_serno = t2.CTR_SERNO
and t2.dt='@@{yyyyMMdd}'
and t2.BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
INNER JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd   t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_06_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_06_1 AS
select t1.cst_id,t1.ctr_serno
    ,max(case when t2.col_1 is not null then 1 else 0 end) as is_ourbnk_high_rsk
    ,max(case when t3.fqm_fxmsgnum   >0 then 1 else 0 end) as bzr_fqm_fxmsgnum     --风险信息条数
    ,max(case when t3.fqm_shixinnum  >0 then 1 else 0 end) as bzr_fqm_shixinnum    --失信老赖名单笔数
    ,max(case when t3.fqm_qianshuinum>0 then 1 else 0 end) as bzr_fqm_qianshuinum  --欠税名单数
    ,max(case when t3.fqm_qingsuannum>0 then 1 else 0 end) as bzr_fqm_qingsuannum  --审判清算命中条数
    ,max(case when t4.ovd_amt>0 or nvl(t5.c_od_amt,0)>0 then 1 else 0 end) as bzr_ovd
    ,max(case when t4.ourbnk_bad_bal>0 or t5.bitdilmt>0 then 1 else 0 end) as bzr_bad_loan
    ,max(case when t5.gura_total_bl_balan>0 then 1 else 0 end) as bzr_dwdb_bad_loan
from SJXQ_SJ20241217176_CST_06          t1
left join qbi_file_20241219_16_32_24_0  t2  --本行高风险客户 193
on t1.gtor_no=t2.COL_1
and t2.pt<>''
left join SJXQ_SJ20241217176_CST_02     t3
on t1.gtor_no=t3.cst_id
and t3.rn=1
left join(
    select cst_id
        ,sum(nvl(OVD_AMT,0)) OVD_AMT --逾期金额
        ,sum(case when FCLS_RSLT_CD IN ( '09' , '10','11','12') then PRCP_BAL else 0 end)   as ourbnk_bad_bal
    from edw.dim_bus_loan_dbil_inf_dd	--信贷借据信息	33	OVD_AMT	DECIMAL	逾期金额DECIMAL(21,2)
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t4 on t1.gtor_no=t4.cst_id
left join SJXQ_SJ20241217176_CST_05     t5
on t1.gtor_no=t5.cst_id
group by t1.cst_id,t1.ctr_serno
;
-- WHEN t1.FCLS_RSLT_CD IN ( '09' , '10' ) THEN '次级'
-- WHEN t1.FCLS_RSLT_CD IN ( '11' )        THEN '可疑'
-- WHEN t1.FCLS_RSLT_CD IN ( '12' )        THEN '损失'
-- 抵押物评估价值
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_07 AS
SELECT t1.cst_id,t1.ctr_serno
    ,t3.ases_val
	,t4.cltr_nm                                  --押品名称|c200
	,t4.mort_pldg_gds_sts_cd                     --抵质押物状态代码|c2
	,t4.our_bnk_psit_cd                          --我行顺位代码|c1
from (
    SELECT DISTINCT cst_id,ctr_serno
    from SJXQ_SJ20241217176_CST_01
)t1 INNER join edw.dws_bus_grnt_itm_inf_dd      t2 --担保物汇总信息
on t1.ctr_serno=t2.busi_ctr_id
and t2.dt='@@{yyyyMMdd}'
INNER JOIN (
    select cltr_no,ases_val,mort_pldg_rat
        ,row_number() over(partition by cltr_no order by last_upd_tm desc) rn
    from edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd
    where dt = '@@{yyyyMMdd}'
) t3 --押品价值评估申请信息表
ON  t2.grnt_id = t3.cltr_no     --押品编号
and t3.rn=1
left join edw.dim_bus_loan_cltr_bas_inf_dd t4 --押品基本信息
on t2.grnt_id=t4.cltr_no
and t4.dt='@@{yyyyMMdd}'
;
-- 同一风险控制号下除了保证人和自己的客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_08 AS
select distinct t1.cst_id,t1.sam_rsk_ctrl_id
    ,t2.cst_id as rel_cst_id
    ,case when t3.cst_id is not null then 1 else 0 end is_grnt_cst
    ,case when t1.cst_id=t2.cst_id then 1 else 0 end is_benr
from SJXQ_SJ20241217176_CST_01      t1
left join edw.DWS_CST_BAS_INF_DD    t2
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
and t2.dt='@@{yyyyMMdd}'
left join (
    select distinct cst_id,gtor_no
    from SJXQ_SJ20241217176_CST_06
)t3 on t1.cst_id=t3.cst_id
and t2.cst_id=t3.gtor_no
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_08_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_08_1 AS
select t1.cst_id
    ,max(case when t2.col_1 is not null then 1 else 0 end) as is_ourbnk_high_rsk
    ,max(case when t3.fqm_fxmsgnum   >0 then 1 else 0 end) as glr_fqm_fxmsgnum     --风险信息条数
    ,max(case when t3.fqm_shixinnum  >0 then 1 else 0 end) as glr_fqm_shixinnum    --失信老赖名单笔数
    ,max(case when t3.fqm_qianshuinum>0 then 1 else 0 end) as glr_fqm_qianshuinum  --欠税名单数
    ,max(case when t3.fqm_qingsuannum>0 then 1 else 0 end) as glr_fqm_qingsuannum  --审判清算命中条数
    ,max(case when t4.ovd_amt>0 or nvl(t5.c_od_amt,0)>0 then 1 else 0 end) as glr_ovd
    ,max(case when t4.ourbnk_bad_bal>0 or t5.bitdilmt>0 then 1 else 0 end) as glr_bad_loan
    ,max(case when t5.gura_total_bl_balan>0 then 1 else 0 end) as glr_dwdb_bad_loan
from SJXQ_SJ20241217176_CST_08          t1
left join qbi_file_20241219_16_32_24_0  t2  --本行高风险客户 193
on t1.rel_cst_id=t2.COL_1
and t2.pt<>''
left join SJXQ_SJ20241217176_CST_02     t3
on t1.rel_cst_id=t3.cst_id
and t3.rn=1
left join(
    select cst_id
        ,sum(nvl(OVD_AMT,0)) OVD_AMT --逾期金额
        ,sum(case when FCLS_RSLT_CD IN ( '09' , '10','11','12') then PRCP_BAL else 0 end)   as ourbnk_bad_bal
    from edw.dim_bus_loan_dbil_inf_dd	--信贷借据信息	33	OVD_AMT	DECIMAL	逾期金额DECIMAL(21,2)
    where dt='@@{yyyyMMdd}'
    group by cst_id
)t4 on t1.rel_cst_id=t4.cst_id
left join SJXQ_SJ20241217176_CST_05     t5
on t1.rel_cst_id=t5.cst_id
where t1.is_grnt_cst<>1 and t1.is_benr<>1
group by t1.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241217176_CST_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241217176_CST_09 AS
SELECT  T1.COL_1   as 序号
    ,T1.COL_2  as 客户号
    ,T1.COL_3  as 户名
    ,T1.COL_4  as 贷款账号_借据号
    ,T1.贷款余额
    ,T1.贷款类型
    ,T1.借款日
    ,T1.首次放款日
    ,T1.到期日
    ,T1.担保方式
    ,t1.是否逃废银行债务
    ,case when t2.fqm_fxmsgnum   >0 then '是' else '' end as 客户是否涉及司法诉讼仲裁和执行案件
    ,case when t2.fqm_shixinnum  >0 then '是' else '' end as 客户是否失信执行人
    ,case when t2.fqm_qianshuinum>0 then '是' else '' end as 客户是否欠税
    ,case when t3.cst_id is not null or t4.cst_id is not null then '是' else '' end 客户本人或主要负责人员是否涉黑涉恶
    ,t5.opr_sts_nm as 工商_经营状态
    ,case when t2.fqm_qingsuannum>0 then '是' else '' end as 是否进入了破产清算程序
    ,case when c_od_amt	>0 then '是' else '' end 			as 客户在他行是否逾期贷款
    ,case when bitdilmt	>0 then '是' else '' end            as 客户在他行是否不良贷款
    ,''                                                     as 客户对外担保是否出现逾期
    ,case when gura_total_bl_balan>0 then '是' else '' end  as 客户对外担保是否出现不良
    ,case when t7.is_ourbnk_high_rsk=1 then '是' else '' end as 贷款保证人是否为本行高风险客户
    ,case when t7.bzr_fqm_fxmsgnum  =1 then '是' else '' end as 贷款保证人是否涉及司法诉讼仲裁和执行案件
    ,case when t7.bzr_fqm_shixinnum =1 then '是' else '' end as 贷款保证人是否为失信执行人
    ,case when t7.bzr_ovd           =1 then '是' else '' end as 贷款保证人在本行及他行是否逾期贷款
    ,case when t7.bzr_bad_loan      =1 then '是' else '' end as 贷款保证人在本行及他行是否不良贷款
    ,''                    as 贷款保证人对外担保是否出现逾期
    ,case when t7.bzr_dwdb_bad_loan =1 then '是' else '' end as 贷款保证人对外担保是否出现不良
    ,case when t8.ases_val>=t1.prcp_bal then '是' else '' end as 最近一期的抵押物评估价值是否能覆盖贷款本息
    ,'' 抵押物是否被司法查封
    ,'' 抵押物是否包含在建工程
    ,'' 抵押物是否包含闲置土地
    ,t8.our_bnk_psit_cd as 我行顺位代码
    ,case when t9.is_ourbnk_high_rsk =1 then '是' else '' end as 关联方是否为本行高风险客户
    ,case when t9.glr_fqm_fxmsgnum   =1 then '是' else '' end as 关联方是否涉及司法诉讼仲裁和执行案件
    ,case when t9.glr_fqm_shixinnum  =1 then '是' else '' end as 关联方是否失信执行人
    ,case when t9.glr_ovd            =1 then '是' else '' end as 关联方在本行及他行是否逾期贷款
    ,case when t9.glr_bad_loan       =1 then '是' else '' end as 关联方在本行及他行是否不良贷款
    ,''                    as 关联方对外担保是否出现逾期
    ,case when t9.glr_dwdb_bad_loan  =1 then '是' else '' end as 关联方对外担保是否出现不良
from SJXQ_SJ20241217176_CST_01          t1
left join SJXQ_SJ20241217176_CST_02     t2
on t1.cst_id=t2.cst_id
and t2.rn=1
left join SJXQ_SJ20241217176_CST_03     t3
on t1.cst_id=t3.cst_id
left join SJXQ_SJ20241217176_CST_03_2   t4
on t1.cst_id=t4.cst_id
left join SJXQ_SJ20241217176_CST_04_2   t5
on t1.cst_id=t5.cst_id
left join SJXQ_SJ20241217176_CST_05     t6
on t1.cst_id=t6.cst_id
left join SJXQ_SJ20241217176_CST_06_1   t7
on t1.ctr_serno=t7.ctr_serno
left join(
    select ctr_serno,sum(ases_val) as ases_val
    from SJXQ_SJ20241217176_CST_07
    group by ctr_serno
)t8 on t1.ctr_serno=t8.ctr_serno
left join SJXQ_SJ20241217176_CST_08_1   t9
on t1.cst_id=t9.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241217176_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241217176_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241217176_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct GEB_CREDITCODE) custs
from SJXQ_SJ20241217176_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241217176_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id,gtor_no) custs
from SJXQ_SJ20241217176_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241217176_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct cst_id,rel_cst_id) custs
from SJXQ_SJ20241217176_CST_08
union all
SElECT '09' seq, count(1) cnt,count(distinct 贷款账号_借据号) custs
from SJXQ_SJ20241217176_CST_09
;
SElECT '09' seq, *
from lab_bigdata_dev.SJXQ_SJ20241217176_CST_09
;
/*
01	7731	2617
02	71239	13756
03	47	46
04	10009464	10009463
05	6226928	6226926
06	4163	3205
07	17	14
08	6077	6077
09	7731	7731
*/***江丽娜_SJ20241223111_台州分行循环贷业务.sql
﻿-- 截止2024.12.23，台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况
-- 合同号维度
DROP   TABLE IF     EXISTS SJXQ_SJ20241223111_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223111_CST_01 AS
SELECT  a.dt                   AS 数据日期
        ,a.ctr_serno           AS 合同流水号
        ,a.cst_id              AS 客户编号
        ,a.cst_nm              AS 客户名称
        ,CASE
           WHEN f.rsk_lyr = '1' THEN '低风险'
           WHEN f.rsk_lyr = '2' THEN '中低风险'
           WHEN f.rsk_lyr = '3' THEN '中风险'
           WHEN f.rsk_lyr = '4' THEN '中高风险'
           WHEN f.rsk_lyr = '5' THEN '高风险'
        else ''
         END                   AS 风险分层      --不是合同表的客户风险等级
        ,CASE
           WHEN a.hpn_typ_cd = '011' THEN '续做'
           WHEN a.hpn_typ_cd = '010' THEN '首笔'
         END                   AS 发生类型
        ,CASE
           WHEN a.bsn_mark_cd = '01' THEN '员工贷款'
           WHEN a.bsn_mark_cd = '02' THEN '信贷人员亲属业务'
           WHEN a.bsn_mark_cd = '03' THEN '预保预报业务'
           WHEN a.bsn_mark_cd = '04' THEN '重组业务'
           WHEN a.bsn_mark_cd = '05' THEN '协作业务'
         END                   AS 业务标识
        ,a.prd_no              AS 业务品种代码
        ,T4.pd_nm              AS 业务名称
        ,a.prd_tag             AS 产品标签编号集合 --即原来的营销标签
        ,a.prd_tag_nm          AS 产品标签名称
        ,CASE
           WHEN a.rvlg_typ_cd = 0 THEN '非循环'
           WHEN a.rvlg_typ_cd = 1 THEN '自助循环'
           WHEN a.rvlg_typ_cd = 2 THEN '半自助循环'
         END                   AS 循环贷款类型
        ,CASE
           WHEN e.bsn_aprv_mod_cd = 1 THEN '机批'
           WHEN e.bsn_aprv_mod_cd = 2 THEN '人批'
         END                   AS 业务审批模式
        ,CASE
           WHEN c.ctr_frz_mod = 05 THEN '每笔贷款发放后'
           WHEN c.ctr_frz_mod = 06 THEN '无'
           WHEN c.ctr_frz_mod = 07 THEN '冻结一次'
           WHEN c.ctr_frz_mod = 08 THEN '循环冻结'
           WHEN c.ctr_frz_mod = 09 THEN '到期前3个月'
         END                   AS 合同冻结方式     --合同表的ctr_frz_mod_cd不能用
        ,c.frz_trm             AS 合同冻结期限
        ,d.sngl_usc_trm_ceil   AS 单笔用信期限上限
        ,a.ctr_amt             AS 合同金额
        ,a.ctr_bal             AS 合同余额
        ,b.amt                 AS 未结清借据金额
        ,a.exec_intr_rat       AS 执行月利率
        ,a.exec_intr_rat * 1.2 AS 执行年利率
        ,a.rpay_prcp_setl_intr_mod_cd	as	还本结息方式代码
        ,c1.cd_val_dscr     as 还本结息方式
        ,a.cpt_usg_cd          AS 资金用途代码
        ,a.cpt_usg_rmk         AS 资金用途
        ,a.ctr_bgn_dt          AS 合同起始日
        ,a.ctr_mtu_dt          AS 合同到期日
        ,CASE
           WHEN a.grnt_mod_colc = 010 THEN '保证'
           WHEN a.grnt_mod_colc = 005 THEN '信用'
           WHEN a.grnt_mod_colc = 020 THEN '抵押'
           WHEN a.grnt_mod_colc = 040 THEN '质押'
         END                   AS 担保方式集合
        ,CASE
           WHEN a.dif_plc_bsn_ind = 0 THEN '否'
           WHEN a.dif_plc_bsn_ind = 1 THEN '是'
         END                   AS 乡情贷业务标志 --即是否异地
        ,a.mgr_org_id          AS 管户机构号
        ,a1.org_nm             AS 管护机构名
        ,a.mgr_id              AS 管户人工号
        ,a3.empe_nm            AS 管户人姓名
        ,a.hdl_opr_id          AS 经办人工号
        ,a4.empe_nm            AS 经办人姓名
        ,a.hdl_org_id          AS 经办机构号
        ,a2.org_nm             AS 经办机构名称
FROM    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息  对应贴源层表edw.loan_ctr_bse_inf
LEFT JOIN    (
                 SELECT  t.ctr_serno
                         ,sum(t.prcp_bal) AS amt --未结清借据金额
                 FROM    edw.DIM_BUS_LOAN_DBIL_INF_DD t
                 WHERE   t.dt = '20241223'
                 AND     ( t.TMT_DT = '18991231'
                     OR t.prcp_bal > 0 ) ----未终结未结清
                 GROUP BY t.ctr_serno
             ) b
ON      a.ctr_serno = b.ctr_serno
LEFT JOIN    edw.loan_ctr_intr_rat c --合同利率
ON      a.ctr_serno = c.ctr_serno
AND     c.dt = '20241223'
LEFT JOIN    edw.loan_ctr_oth_dtl_inf d --合同其它明细信息
ON      a.ctr_serno = d.ctr_serno
AND     d.dt = '20241223'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_biz_dd e --用信方案
ON      a.rel_serno = e.usc_aply_serno
AND     e.dt = '20241223'
LEFT JOIN    edw.loan_lmt_biz_stat_inf f --统计类信息
ON      a.rel_serno = f.usc_aply_serno
AND     f.dt = '20241223'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T4 --产品信息
ON      a.prd_no = T4.prd_no
AND     T4.DT = '20241223'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a1
ON      a.mgr_org_id = a1.org_id
AND     a1.dt = '20241223'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a2
ON      a.hdl_org_id = a2.org_id
AND     a2.dt = '20241223'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a3
ON      a.mgr_id = a3.empe_id
AND     a3.dt = '20241223'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a4
ON      a.hdl_opr_id = a4.empe_id
AND     a4.dt = '20241223'
left join edw.dwd_code_library_dd               c1
on a.RPAY_PRCP_SETL_INTR_MOD_CD = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
WHERE   a.dt = '20241223'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( A.CTR_STS_CD IN ( '2' , '4' )
AND     A.TMT_DT = '18991231'
AND     to_date(A.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A.DT, 'yyyyMMdd') )
    OR A.CTR_BAL > 0 )
AND     a.rvlg_typ_cd <> '0' --循环类贷款
AND     a.prd_no <> '2002010101001' --剔除信用卡
AND     a.mgr_org_id LIKE '3301%'     --台州分行
;
SElECT '01' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241223111_CST_01
;
SElECT '01' seq, *
from SJXQ_SJ20241223111_CST_01
***江黎_SJ20241202231_社区地图规划调整.sql
﻿-- 台州分行内2024年8月1日-11月30 日社区地图有变化（含新增/合并/拆分/删除/修改）的子社区清单，及社区内各种客户数统计，客户数取修改前数据。
-- 社区变更记录
DROP   TABLE IF     EXISTS SJXQ_SJ20241202231_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202231_CST_01 AS
select cmnt_enc                               --社区编码|C32
    ,cmnt_nm                                  --社区名称|C300
    ,cmnt_typ_cd                              --社区类型代码|C32
    ,afl_org_id                               --所属机构编号|C12
    ,afl_cmnt_id                              --所属社区编号|C32
    ,aprv_sts_cd                              --审批状态代码|C2
    ,area_typ_cd                              --地域类型代码|C32
    ,cmnt_sts_cd                              --社区状态代码|C2
    ,decode(cmnt_sts_cd,'1','潜在' ,'2','正在开发' ,'3','有效' ,'4','关闭','') as cmnt_sts_nm
    ,cmnt_dscr                                --社区描述|C2000
    ,entr_tm                                  --进入时间|C200
    ,cst_cpc                                  --客户容量|C200
    ,key_cst_id                               --关键人客户编号|C1000
    ,key_cst_nm                               --关键人姓名|C1000
    ,crt_tm	                                  --创建时间|C20
    ,mdf_tm	                                  --修改时间|C20
    ,case when crt_tm>=mdf_tm then substr(replace(crt_tm,'-',''),1,8) else substr(replace(mdf_tm,'-',''),1,8) end as update_dt
    ,opr_typ_cd                               --操作类型代码|C1
    ,decode(opr_typ_cd,'1','增加' ,'2','修改' ,'3','删除' ,'4','转移' ,'5','认领','') as opr_typ_nm
    ,cmnt_dev_typ_cd                          --社区开发类型代码|C1
    ,decode(cmnt_dev_typ_cd,'1','潜在' ,'2','开发中' ,'3','储备' ,'4','主推','') as cmnt_dev_typ_nm
    ,dt
    ,row_number() over(partition by cmnt_enc,crt_tm,substr(replace(mdf_tm,'-',''),1,8) order by mdf_tm desc,dt asc) rn
from edw.dim_cst_mng_cmnt_inf_dd              --社区信息
where dt between '20240801' and '20241130'  -- dt >= '20240801'
and (substr(replace(crt_tm,'-',''),1,8) between '20240801' and '20241130'
or substr(replace(mdf_tm,'-',''),1,8) between '20240801' and '20241130')
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241202231_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202231_CST_02 AS
select t1.cmnt_enc                               --社区编码|C32
    ,t1.cmnt_nm                                  --社区名称|C300
    ,t1.cmnt_sts_nm                              --社区状态代码|C2
    ,t1.entr_tm                                  --进入时间|C200
    ,t1.cst_cpc                                  --客户容量|C200
    ,t1.cmnt_dev_typ_nm                          --社区开发类型
    ,t1.opr_typ_nm
    ,t4.org_nm
    ,t1.update_dt
    ,to_char(dateadd(to_date(t1.update_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd') as update_yesdt
from SJXQ_SJ20241202231_CST_01              t1
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.afl_org_id = t4.org_id
and t4.dt = '20241130'
where t1.rn=1
and t1.update_dt between '20240801' and '20241130'
and t4.brc_org_nm='台州分行'
;
--统计字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20241202231_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202231_CST_03 AS
select t1.cmnt_enc
    ,t1.update_yesdt
    ,count(distinct t2.cst_id)   custs
    ,count(distinct case when t3.forml_cst_ind='1' then t2.cst_id end) as forml_custs  --正式客户标识
    ,count(distinct case when t4.efe_cst_ind='1'   then t2.cst_id end) as efe_custs
    ,count(distinct case when t4.efe_cst_ind<>'1'  then t2.cst_id end) as no_efe_custs
    ,count(distinct case when t5.attach_flag='0'   then t2.cst_id end) as hand_custs
    ,count(distinct case when t5.attach_flag='1'   then t2.cst_id end) as auto_custs
from SJXQ_SJ20241202231_CST_02          t1
left join edw.dwd_cst_mng_cmnt_rel_dd   t2 --客户社区信息
on t1.cmnt_enc=t2.sub_cmnt_id
and t1.update_yesdt=t2.dt
and t2.dt between '20240731' and '20241130'
left join adm_pub.adm_csm_cbas_mng_inf_dd t3 --客户`管户`基础信息
on t2.cst_id=t3.cst_id
and t2.dt=t3.dt
and t3.dt between '20240731' and '20241130'
left join adm_pub.adm_csm_cbas_ind_inf_dd t4 --客户基础标识信息
on t2.cst_id=t4.cst_id
and t2.dt=t4.dt
and t4.dt between '20240731' and '20241130'
left join edw.xwdt_xw_cust_com            t5 -- 客户与社区关联表
on t2.cst_id=t5.cust_no
and t2.dt=t5.dt
and t5.dt between '20240731' and '20241130'
group by t1.cmnt_enc,t1.update_yesdt
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241202231_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202231_CST_04 AS
SELECT  t1.cmnt_enc        AS 社区编码
       ,t1.cmnt_nm         AS 社区名称
       ,t1.org_nm          AS 归属机构
       ,t2.is_xn_cmnt      AS 是否虚拟子社区
       ,t1.cmnt_sts_nm     AS 社区状态
       ,t1.entr_tm         AS 进入时间
       ,t1.cst_cpc         AS 客户容量
       ,t1.cmnt_dev_typ_nm AS 社区开发类型
       ,t1.opr_typ_nm      AS 操作类型
       ,t1.update_dt       AS 变更日期
       ,t1.update_yesdt    AS 变更前一日
       ,t2.custs           AS 社区内总客户数
       ,t2.forml_custs     AS 社区内正式客户数
       ,t2.efe_custs       AS 社区内有效户数
       ,t2.no_efe_custs    AS 社区内非有效户数
       ,t2.hand_custs      AS 社区内客户挂靠方式_手动客户数
       ,t2.auto_custs      AS 社区内客户挂靠方式_自动客户数
from SJXQ_SJ20241202231_CST_02      t1
left join SJXQ_SJ20241202231_CST_03 t2
on t1.cmnt_enc=t2.cmnt_enc
and t1.update_yesdt=t2.update_yesdt
;
SElECT '01' seq, count(1) cnt,count(distinct cmnt_enc,update_dt) custs
from SJXQ_SJ20241202231_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cmnt_enc,update_yesdt) custs
from SJXQ_SJ20241202231_CST_02
union all
SElECT '02' seq, count(1) cnt,count(distinct cmnt_enc,update_yesdt) custs
from SJXQ_SJ20241202231_CST_03
union all
SElECT '03' seq, count(1) cnt,count(distinct 社区编码,变更日期) custs
from SJXQ_SJ20241202231_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ20241202231_CST_04
***王荣_SJ20241128101_舟山分行未到期未终结客户清单.sql
﻿-- 客户号、客户名称、管护人、管护机构、同一风险控制号下我行授信总敞口、同一风险控制号、配偶是否签入担保
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
-- and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST_02 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
    -- ,t2.cst_chn_nm	--客户姓名|C200
    -- ,t1.rel_typ
    -- ,c1.cd_val_dscr as rel_typ_nm
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
-- LEFT JOIN EDW.DWD_CODE_LIBRARY_DD           C1
-- ON  cast(t1.rel_typ as int) = cast(C1.CD_VAL as int)
-- AND C1.DT = '@@{yyyyMMdd}'
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST_03 AS
select t1.cst_id
    ,count(distinct t1.wrnt_cst_id) as wrnt_custs
    ,max(case when t3.cst_id is not null then 1 else 0 end) as is_po
from(
    SElECT distinct t1.cst_id
        ,t2.wrnt_cst_id         --保证人客户编号
    from SJXQ_SJ20241128101_CST_01           t1
    inner JOIN edw.dws_bus_grnt_prsn_inf_dd t2 --担保人汇总信息
    ON  t1.ctr_serno=t2.bus_ctr_id           --业务合同编号
    and t2.dt = '@@{yyyyMMdd}'
)t1 left join SJXQ_SJ20241128101_CST_02      t3
on t1.cst_id=t3.cst_id
and t1.wrnt_cst_id=t3.rel_cst_id
group by t1.cst_id
;
-- 输出结果 客户号、客户名称、管护人、管护机构、同一风险控制号下我行授信总敞口、同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST_04 AS
SELECT  t1.cst_id             AS 客户号
    ,t1.cst_nm                AS 客户名称
    ,concat(t1.mgr_id,mgr_nm) AS 管护人
    ,t1.org_nm                AS 管护机构
    ,t1.sam_rsk_ctrl_id       AS 同一风险控制号
    ,t1.ctr_epsr_amt          AS 同一风险控制号下我行授信总敞口
    ,t2.wrnt_custs  		  as 担保人数
    ,case when t2.is_po=1 then '是' else '' end as 配偶是否签入担保
from(
    SElECT cst_id,cst_nm,mgr_id,mgr_nm,org_nm,sam_rsk_ctrl_id
        ,sum(ctr_epsr_amt) as ctr_epsr_amt
    from SJXQ_SJ20241128101_CST_01
    where brc_org_nm regexp '舟山分行'
    GROUP BY cst_id,cst_nm,mgr_id,mgr_nm,org_nm,sam_rsk_ctrl_id
)t1 left join SJXQ_SJ20241128101_CST_03 t2
on t1.cst_id=t2.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241128101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241128101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241128101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241128101_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ20241128101_CST_04
;
***王荣_SJ20241128101_舟山分行未到期未终结客户清单_合同.sql
﻿-- 客户号、客户名称、管护人、管护机构、同一风险控制号下我行授信总敞口、同一风险控制号、配偶是否签入担保
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST2_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
    ,t1.prd_no	    --产品编号|c32
    ,t2.PD_NM
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.exec_intr_rat	--执行利率|decimal(13,7)
    ,t1.inv_in_indy_cd	--投向行业代码|c5
    ,c1.cd_val_dscr     as inv_in_indy_nm
    ,t1.comt_no	        --社区编号|c32
    ,COALESCE(c2.CMNT_NM, '') AS COMT_NM -- 社区名称
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='@@{yyyyMMdd}'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
-- and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
left join edw.DWS_CST_BAS_INF_DD            t5
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c1
on t1.inv_in_indy_cd = c1.cd_val
and c1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_CST_MNG_CMNT_INF_DD    c2 --社区信息
ON      T1.comt_no = c2.CMNT_ENC
AND     c2.DT = '@@{yyyyMMdd}'
where t1.dt='@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 配偶
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST2_02 AS
SElECT distinct t1.cst_id,t1.rel_cst_id
from(
    SElECT cst_id,rel_cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
    union
    SElECT rel_cst_id,cst_id,rel_typ
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ='0301' --配偶
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
;
-- 担保人信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST2_03 AS
select t1.ctr_serno
    ,count(distinct t1.wrnt_cst_id) as wrnt_custs
    ,max(case when t3.cst_id is not null then 1 else 0 end) as is_po
from(
    SElECT distinct t1.cst_id,t1.ctr_serno
        ,t2.wrnt_cst_id         --保证人客户编号
    from SJXQ_SJ20241128101_CST2_01             t1
    inner JOIN edw.dws_bus_grnt_prsn_inf_dd     t2 --担保人汇总信息
    ON  t1.ctr_serno=t2.bus_ctr_id           --业务合同编号
    and t2.dt = '@@{yyyyMMdd}'
)t1 left join SJXQ_SJ20241128101_CST2_02      t3
on t1.cst_id=t3.cst_id
and t1.wrnt_cst_id=t3.rel_cst_id
group by t1.ctr_serno
;
-- 输出结果 客户号、客户名称、管护人、管护机构、同一风险控制号下我行授信总敞口、同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ20241128101_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241128101_CST2_04 AS
SELECT  t1.sbr_org_nm            AS 管护支行机构名称
    ,t1.org_nm                AS 管护机构
    ,t1.cst_id                AS 客户号
    ,t1.cst_nm                AS 客户名称
    ,t1.ctr_serno             AS 合同流水号
    ,t1.prd_no                AS 产品编号
    ,t1.PD_NM                 as 产品名称
    ,t1.ctr_amt               AS 合同授信金额
    ,t1.ctr_epsr_amt          AS 合同敞口金额
    ,t1.exec_intr_rat         AS 执行利率
    ,concat(t1.mgr_id,mgr_nm) AS 管护人
    ,t1.sam_rsk_ctrl_id       AS 同一风险控制号
    ,t3.ctr_epsr_amt          AS 同一风险控制号总敞口金额
    ,t2.wrnt_custs            AS 担保人数
    ,CASE WHEN t2.is_po = 1 THEN '是'  ELSE '' END              AS 配偶是否签入担保
    ,CASE WHEN t4.ctr_srl_no is not null THEN '是'  ELSE '' END AS 合同是否为风险贷款
    ,t1.inv_in_indy_nm        as 行业投向
    ,t1.comt_no	              as 社区编号
    ,t1.COMT_NM               as 社区名称
    ,t6.sub_cmnt_id           as 子社区编号
    ,t7.cmnt_nm               as 子社区名称
from SJXQ_SJ20241128101_CST2_01         t1
left join SJXQ_SJ20241128101_CST2_03    t2
on t1.ctr_serno=t2.ctr_serno
left join(
    select sam_rsk_ctrl_id
        ,sum(ctr_epsr_amt) as ctr_epsr_amt
    from SJXQ_SJ20241128101_CST2_01
    group by sam_rsk_ctrl_id
)t3 on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
left join(
    SELECT  distinct ctr_srl_no	        --合同流水号
    FROM adm_rsk.adm_rsk_apl_inter_all	--风险集市应用表-资产质量日常监测源表
    WHERE dt = '@@{yyyyMMdd}'
    AND is_rsk_loan = 'Y'
)t4 on t1.ctr_serno=t4.ctr_srl_no
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t6
ON      t1.cst_id = t6.cst_id
AND     t6.dt = '@@{yyyyMMdd}'
AND     t6.dpd_typ_cd = '1' --挂靠类型：1普惠，2小企业
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd t7
ON      t6.sub_cmnt_id = t7.cmnt_enc
AND     t7.dt = '@@{yyyyMMdd}'
where t1.brc_org_nm regexp '舟山分行'
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241128101_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241128101_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241128101_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 合同流水号) custs
from SJXQ_SJ20241128101_CST2_04
;
SElECT '04' seq, *
from SJXQ_SJ20241128101_CST2_04
***王谦_SJ2024112701_旬阳村行征信客户.sql
﻿/*
12月-3月，旬阳村行新客查询征信数据
数据频次：从12月开始每周一取数1次；
数据范围：客户号、客户名称、管户支行、管户团队、管户客户经理、客户征信查询时间、是否转化为有效户、客户建档时间、客户面访时间
数据需求字段
客户号、客户名称、管户支行、管户团队、管户客户经理、客户征信查询时间、是否转化为有效户、客户建档时间、客户面访时间（重点是有征信查询数据）
*/
--查询征信客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_01 AS
select cst_id
    ,substr(replace(report_dt,'-',''),1,8) as report_dt	--报告日期
    ,qry_rsn	--查询原因
    ,'个人' as cst_type
from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
where dt='@@{yyyyMMdd}'
and report_asc_rn=1
and nvl(cst_id,'')<>''
and substr(replace(report_dt,'-',''),1,8) between '20241125' and '20241201'     --此处需要修改？？？
union all
select cst_id
    ,replace(report_dt,'-','') as report_dt	--报告日期
    ,qry_rsn	--查询原因
    ,'企业'
from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
where dt='@@{yyyyMMdd}'
and report_asc_rn=1
and nvl(cst_id,'')<>''
and replace(report_dt,'-','') between '20241125' and '20241201' --此处需要修改？？？
;
-- 客户面访时间
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_02 AS
SELECT t.cust_no              --客户号
    ,t.employ_no            --客户经理
    ,t.visiting_time        --实际访客时间
    ,t.emp_sign_addr        --员工签到地点
    ,t.visit_type           --服务目的
    ,t.visit_content        --服务内容
    ,t.remark               --工作备注
    ,t.create_employ_id     --创建人
    ,t.create_time          --创建时间
from(
    SELECT  vis.BUS_SEQ_ID       AS id
            ,vis.CREATE_EMP      AS employ_no
            ,vis.SRV_CNTNT       AS visit_content
            ,vis.COMMENTS        AS remark
            ,vis.CREATE_EMP      AS create_employ_id
            ,vis.CREATE_TM       AS create_time
            ,vis.UPDATE_EMP      AS update_employ_id
            ,vis.UPDATE_TM       AS update_time
            ,vis.srv_tm          AS visiting_time
            ,vis.bus_typ         AS visit_type
            ,act.visit_task_id   AS visit_task
            ,act.plan_visit_addr AS plan_address
            ,vis.CST_ID          AS cust_no
            ,vis.SOURCE_FLAG     AS sourceFlag
            ,vis.EMP_SIGN_ADDR   AS emp_sign_addr
            ,vis.COM_CUST_ID     AS com_cust_id
            ,vis.COM_CUST_NAME   AS com_cust_name
            ,vis.CST_DMND        AS cst_dmnd
            ,vis.SRV_TYPE        AS srv_type
            ,vis.NEED_ASSIGN
            ,vis.ASSIGN_PERSON
            ,vis.PLAN_END_TM
            ,vis.ASSIGN_REASON
            ,vis.PLAN_TM
            ,row_number() over(partition by vis.CST_ID order by vis.srv_tm desc) rn
    FROM    edw.xwdt_xw_cst_vst_dtl_di vis      --客户走访明细表
    LEFT JOIN    edw.xwdt_xw_activity_info act  --面访表
    ON      act.bus_seq_id = vis.bus_seq_id
    AND     act.DT = '@@{yyyyMMdd}'
    WHERE   act.srv_type = '01'     --拜访
    AND     vis.DT = '@@{yyyyMMdd}'
    -- AND     SUBSTR(REPLACE(vis.srv_tm, '-', ''), 1, 8) >= '20200601' --实际访客时间
    -- AND     SUBSTR(REPLACE(vis.srv_tm, '-', ''), 1, 8) <= '20240814'
)t where rn=1
;
-- 字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_03 AS
SELECT  t1.cst_id       --客户号
    ,t1.report_dt       --报告日期
    ,t1.qry_rsn         --查询原因
    ,t1.cst_type        --客户类型
    ,t2.visiting_time   --实际访客时间
    ,t3.prm_mgr_id,t3.prm_mgr_nm,t3.prm_org_id
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,t5.cst_chn_nm	    --客户姓名
    ,t5.file_dt	        --建档日期
    ,t6.efe_cst_ind	    --有效户标识
from SJXQ_SJ2024112701_CST_01       t1
left join SJXQ_SJ2024112701_CST_02  t2
on t1.cst_id=t2.cust_no
inner join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
and t4.org_id LIKE '6161%'    --陕西旬阳村行
left join edw.dws_cst_bas_inf_dd	        t5 --客户基础信息汇总表
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbas_ind_inf_dd	t6 --客户集市-基础信息-客户基础标识信息
on t1.cst_id=t6.cst_id
and t6.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112701_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112701_CST_04 AS
SELECT  cst_id     AS 客户号
    ,cst_chn_nm    AS 客户姓名
    ,sbr_org_nm    AS 主管户支行
    ,tem_org_nm    AS 主管户团队
    ,concat(prm_mgr_id,prm_mgr_nm) AS 主管户经理
    ,report_dt     AS 首次征信报告查询日期
    ,qry_rsn       AS 查询原因
    ,cst_type      AS 客户类型
    ,efe_cst_ind   AS 有效户标识
    ,file_dt       AS 建档日期
    ,visiting_time AS 最新面访时间
from SJXQ_SJ2024112701_CST_03
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112701_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cust_no) custs
from SJXQ_SJ2024112701_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112701_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112701_CST_04
;
SElECT '04' seq, *
from SJXQ_SJ2024112701_CST_04
***白璐_SJ20241223161_眉县村行征信数据.sql
﻿--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241223161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223161_CST_01 AS
select t1.ctr_serno                              --合同流水号
   ,t1.cst_id                                   --客户号|C20
   ,t1.cst_nm                                   --客户名称|C200
   ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
   ,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
   ,t1.exec_intr_rat	                         --执行利率 执行月利率
   ,t3.mgr_id	                                 --管户人工号|C10
   ,t3.mgr_nm	                                 --管户人姓名|C200
   ,t3.mgr_org_id	                             --管户机构号|C12
   ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='20241222'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20241222'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20241222'
where t1.dt='20241222'
and t2.PD_NM not regexp '信用卡'
and t4.brc_org_nm='陕西眉县泰隆村镇银行'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 ) --未到期未终结口径
;
-- 最新征信分 中征分
DROP   TABLE IF     EXISTS SJXQ_SJ20241223161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223161_CST_02 AS
SELECT  t.cst_id
    ,t.prd_dt
    ,t.cst_cr_grd_val
    ,ROW_NUMBER() OVER ( PARTITION BY t.cst_id ORDER BY  t.prd_dt DESC ) AS rn
FROM
(
    SELECT  cst_id
        ,REPLACE(substr(qry_tm,1,10),'-','') AS prd_dt
        ,cr_sco_val                          AS cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
    WHERE dt <= '20241222'
    UNION
    SELECT  cst_id
        ,substr(replace(prd_dt,'-',''),1,8) as prd_dt
        ,cst_cr_grd_val
    FROM edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
    WHERE dt <= '20241222'
) t inner join (
    select distinct cst_id
    from SJXQ_SJ20241223161_CST_01
)t2 on t.cst_id=t2.cst_id
;
-- 个人他行贷款明细 对私他行贷款明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241223161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223161_CST_03 AS
SELECT  T1.id,T1.report_id --报告编号|C32
    ,T1.cst_id --客户号|C20
    ,T1.dtrb_org --发放机构|C60
    ,T1.ccy_cd
    ,T1.ctr_amt --贷款金额|DECIMAL(16, 2)
    ,CASE WHEN T1.act_typ_cd IN ( 'D1' ,'R4' ) THEN ( T1.CTR_AMT * T3.AVG_PRC / T3.QUO_UNT )
            WHEN T1.act_typ_cd = 'R1' THEN ( T1.act_crd_lmt * T3.AVG_PRC / T3.QUO_UNT )
            ELSE coalesce(t1.ctr_amt,0) + coalesce(t1.act_crd_lmt,0) END AS CTR_AMT_cny
    ,T1.ctr_bal --贷款余额|DECIMAL(16, 2)
    ,t1.ctr_bal * T3.AVG_PRC / T3.QUO_UNT AS ctr_bal_cny --贷款余额
    ,t1.ctr_bal * c1.cny_exr as ctr_bal_cny2
    ,T1.dtrb_org_typ_cd --发放机构类型代码|C60
    ,CASE t1.dtrb_org_typ_cd
        WHEN '11' THEN '商业银行'
        WHEN '12' THEN '村镇银行'
        WHEN '14' THEN '住房储蓄银行'
        WHEN '15' THEN '外资银行'
        WHEN '16' THEN '财务公司'
        WHEN '21' THEN '信托公司'
        WHEN '22' THEN '融资租赁公司'
        WHEN '23' THEN '汽车金融公司'
        WHEN '24' THEN '消费金融公司'
        WHEN '25' THEN '贷款公司'
        WHEN '26' THEN '金融资产管理公司'
        WHEN '31' THEN '证券公司'
        WHEN '41' THEN '保险公司'
        WHEN '51' THEN '小额贷款公司'
        WHEN '52' THEN '公积金管理中心'
        WHEN '53' THEN '融资性担保公司'
        WHEN '54' THEN '保理公司'
        WHEN '99' THEN '其他机构' else '其他机构'
        END AS dtrb_org_typ_nm --放款机构类型
    ,t2.intr_rat
    ,DENSE_RANK()over(partition by t1.cst_id order by SUBSTR(t1.report_id,1,8) desc) as dr
FROM edw.dim_cst_ccrc_idv_loan_inf_dd           t1 --个人征信客户贷款信息
left join    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t2 --个人征信借贷账户利率计算
on      t1.report_id = t2.crd_rpt_id
and     t1.act_id = t2.act_id
and     t2.act_id <> ''
and     coalesce(t2.intr_rat, '') <> ''
and     t2.intr_rat <> '-9999'
and     t2.dt = '20241222'
LEFT JOIN edw.dim_bus_com_exr_inf_dd            t3 --汇率信息表
ON T1.ccy_cd = t3.iso_ccy_cd
AND t3.dt = '20241222'
LEFT JOIN EDW.DIM_BUS_COM_EXR_INF_DD            c1 --汇率表 CNY_EXR 折人民币汇率
ON  T1.ccy_cd = c1.iso_ccy_cd
AND c1.DT ='20241222'
inner join (
    select distinct cst_id
    from SJXQ_SJ20241223161_CST_01
)t4 on t1.cst_id=t4.cst_id
WHERE T1.dt = '20241222'
and nvl(t1.cst_id,'')<>''
AND T1.ACT_TYP_CD IN ( 'D1' , 'R1' , 'R4' ) --贷款账户
and T1.dtrb_org <> 'ZJTLCB'
;
-- 对公他行贷款明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241223161_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223161_CST_04 AS
select T1.id,T1.cst_id                           --客户号|C20
	,T1.report_id                                --报告编号|C32
	,T1.act_actv_sts                             --账户活动状态|C60
	,T1.act_typ                                  --账户类型|C60
	,T1.loan_trm                                 --贷款期限|C60
	,T1.dtrb_org_typ_cd                          --发放机构类型代码|C60
	,T1.dtrb_org_cd                              --发放机构代码|C60
   ,CASE t1.dtrb_org_typ_cd
        WHEN '11' THEN '商业银行'
        WHEN '12' THEN '村镇银行'
        WHEN '14' THEN '住房储蓄银行'
        WHEN '15' THEN '外资银行'
        WHEN '16' THEN '财务公司'
        WHEN '21' THEN '信托公司'
        WHEN '22' THEN '融资租赁公司'
        WHEN '23' THEN '汽车金融公司'
        WHEN '24' THEN '消费金融公司'
        WHEN '25' THEN '贷款公司'
        WHEN '26' THEN '金融资产管理公司'
        WHEN '31' THEN '证券公司'
        WHEN '41' THEN '保险公司'
        WHEN '51' THEN '小额贷款公司'
        WHEN '52' THEN '公积金管理中心'
        WHEN '53' THEN '融资性担保公司'
        WHEN '54' THEN '保理公司'
        WHEN '99' THEN '其他机构' else '其他机构'
        END AS dtrb_org_typ_nm --放款机构类型
   ,T1.ccy                                      --币种|C60
   ,T1.loan_amt                                 --贷款金额|DECIMAL(15,2)
   ,t1.loan_amt * c1.cny_exr   as loan_amt_cny
   ,T1.loan_bal                                 --贷款余额|DECIMAL(15,2)
   ,t1.loan_bal * c1.cny_exr   as loan_bal_cny
   ,t2.mon_intr_rat
   ,DENSE_RANK()over(partition by T1.cst_id order by SUBSTR(T1.report_id,1,8) desc) as dr
from edw.dim_cst_ccrc_entp_loan_inf_dd   t1 --企业征信客户贷款信息
---- 征信企业借贷账户利率计算
left join edw.dwd_cst_ccrc_entp_dc_act_intr_rat_clc_dd t2
on      t1.report_id = t2.rpt_no
and     t1.act_id = t2.act_id
and     t2.act_id <> ''
and     coalesce(t2.mon_intr_rat, '') <> ''
and     t2.mon_intr_rat <> '-9999'
and     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN EDW.DIM_BUS_COM_EXR_INF_DD     c1 --汇率表 CNY_EXR 折人民币汇率
ON  T1.ccy = c1.iso_ccy_cd
AND c1.DT ='20241222'
inner join (
    select distinct cst_id
    from SJXQ_SJ20241223161_CST_01
)t4 on t1.cst_id=t4.cst_id
where T1.dt='20241222'
and nvl(t1.cst_id,'')<>''
and     t1.dtrb_org_typ_cd <> ''   ---- 不含泰隆
and     t1.bus_pd_cls_cd = '11'  --贷款
-- and T1.ACT_TYP IN ( 'D1' , 'R1' , 'R4' ) --贷款
-- and length(T1.DTRB_ORG_CD)='4' --他行
;
--征信 利率
DROP   TABLE IF     EXISTS SJXQ_SJ20241223161_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223161_CST_05 AS
select t1.*
from(
    select cst_id,report_no,irr,id
    from lab_bigdata_dev.zx_rate_result_all_di --最大日期 20240507
    where dt<='20241222' and irr<>'-9999'
    union all
    select cst_id,report_no,irr,id
    from lab_bigdata_dev.zx_rate_result_ent_di --最大日期 20240717
    where dt<='20241222' and irr<>'-9999'
)t1 inner join (
    select report_id from SJXQ_SJ20241223161_CST_03 where dr=1
    union
    select report_id from SJXQ_SJ20241223161_CST_04 where dr=1
)t4 on t1.report_no=t4.report_id
;
-- 结果表
DROP   TABLE IF     EXISTS SJXQ_SJ20241223161_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241223161_CST_06 AS
SELECT  t1.org_nm       AS 管户部门名称
    ,t1.cst_nm          AS 客户名称
    ,t1.cst_id          AS 客户号
    ,t1.mgr_id          AS 管户客户经理工号
    ,t1.mgr_nm          AS 管户客户经理
    ,t1.ctr_amt         AS 我行授信金额
    ,t1.ctr_bal         AS 我行贷款余额
    ,t1.exec_intr_rat   AS 我行贷款加权平均利率
    ,t2.dtrb_org        AS 发放机构
    ,t2.dtrb_org_typ_nm AS 发放机构类型
    ,t2.CTR_AMT_cny     AS 他行授信金额
    ,t2.ctr_bal_cny     AS 他行贷款余额
    ,case when nvl(t2.intr_rat,'')='' then nvl(t3.irr,'') else t2.intr_rat end AS 他行贷款利率
    ,t4.cst_cr_grd_val  as 中征分
from(
    SElECT t1.org_nm
        ,t1.cst_nm                                   --客户名称|C200
        ,t1.cst_id                                   --客户号|C20
        ,t1.mgr_id	                                 --管户人工号|C10
        ,t1.mgr_nm	                                 --管户人姓名|C200
        ,sum(t1.ctr_amt) as ctr_amt                          --合同金额DECIMAL(21,2)
        ,sum(t1.ctr_bal) as ctr_bal                          --合同余额DECIMAL(21,2)
        ,case when sum(t1.ctr_bal)=0 then 0 else sum(t1.ctr_bal * t1.exec_intr_rat)/sum(t1.ctr_bal) end as exec_intr_rat --执行利率 执行月利率
    from SJXQ_SJ20241223161_CST_01 t1
    group by t1.org_nm,t1.cst_nm,t1.cst_id,t1.mgr_id,t1.mgr_nm
)t1 left join(
    select id,report_id,cst_id
        ,dtrb_org,dtrb_org_typ_nm
        ,CTR_AMT_cny
        ,ctr_bal_cny
        ,intr_rat
    from SJXQ_SJ20241223161_CST_03
    where dr=1
    union all
    select id,report_id,cst_id
        ,dtrb_org_cd,dtrb_org_typ_nm
        ,loan_amt_cny
        ,loan_bal_cny
        ,mon_intr_rat
    from SJXQ_SJ20241223161_CST_04
    where dr=1
)t2 on t1.cst_id=t2.cst_id
left join SJXQ_SJ20241223161_CST_05 t3
on t2.id=t3.id
and t2.report_id=t3.report_no
left join SJXQ_SJ20241223161_CST_02 t4
on t1.cst_id=t4.cst_id
and t4.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241223161_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241223161_CST_02 where rn=1
union all
SElECT '03' seq, count(1) cnt,count(distinct id,report_id) custs
from SJXQ_SJ20241223161_CST_03 where dr=1
union all
SElECT '04' seq, count(1) cnt,count(distinct id,report_id) custs
from SJXQ_SJ20241223161_CST_04 where dr=1
union all
SElECT '05' seq, count(1) cnt,count(distinct id,report_no) custs
from SJXQ_SJ20241223161_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 客户号,发放机构) custs
from SJXQ_SJ20241223161_CST_06
;
SElECT '06' seq, *
from SJXQ_SJ20241223161_CST_06
;
/*
01	6882	6882
02	4992	4992
03	94739	94739
04	2489	2489
05	619	619
06	97626	25953
*/***盛天明_SJ2024121217_行内理财资质.sql
﻿-- 20241212 台州分行 理财资质
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_01 AS
select col_1 as 客户号
	,col_2 as 账号
	,col_3 as 账户管户人工号
	,col_4 as 新账户管户人工号
	,col_5 as 账户管户人姓名
	,col_6 as 账户考核所在支行机构名称
	,col_7 as 账户考核所在分行机构名称
	,col_8 as 指定销售人工号
	,col_9 as 指定销售人姓名
from qbi_file_20241217_10_31_36_0
where pt<>''
;
-- 账户销售人
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_02 AS
select t1.cst_id
    ,t1.cst_act_id
    ,t2.sale_empes
    ,t2.mgr_id
    ,t2.mgr_nm
from(
    select distinct 客户号 as cst_id
        ,账号 as cst_act_id
    from SJXQ_SJ2024121217_CST_01
)t1 left join(
    select t1.cst_id,t1.bnk_act_id
        ,count(1) sale_empes
    from edw.dws_bus_chm_act_mgr_inf_dd   t1        --理财考核汇总信息
    left join edw.dws_hr_empe_inf_dd      t2 --员工信息汇总
    on  t1.mgr_id=t2.empe_id
    and t2.dt='@@{yyyyMMdd}'
    where t1.dt='20241212'
    and t1.mng_typ_cd = '2'  --`管户`类型 1考核 2销售
    and t1.pd_tp_cd='1'      --理财类型：0基金 1理财
    group by t1.cst_id,t1.bnk_act_id
)t2 on t1.cst_id=t2.cst_id
and t1.cst_act_id=t2.bnk_act_id
;
--行内理财
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_03 AS
SELECT  a.client_manager AS empe_id
    ,count(1) zz_cnt    --均为1
    ,max(case when substr(a.reserve1, 24, 1) = '1' then 1 else 0 end) as is_gj_zz --挂钩型理财销售资格，reserve1第24位
FROM    edw.finc_tbclientmanager a
WHERE   a.prd_rights LIKE '%1%'
AND     dt = '@@{yyyyMMdd}'
GROUP BY a.client_manager
;
--行外证书 自研
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_04 AS
select empe_id
from(
    select t1.empe_id,t1.get_tm,t1.ctf_id,t1.ctf_isu_org
        ,t1.ind_bus_ind	--职业资格类别|C32
        ,t1.cmt
        ,t1.std_ctf_nm
        ,c1.cd_val_dscr std_ctf
        ,t1.pro_ctg
        ,case when nvl(t1.pro_ctg_nm,'')='' then t1.pro_ctg else t1.pro_ctg_nm end as pro_ctg_nm --专业类别 名称
        ,t1.aprv_dt
        ,row_number() over(partition by t1.empe_id,t1.std_ctf_nm order by t1.get_tm desc,t1.pro_ctg desc) rn1
    from edw.dim_hr_empe_ctf_ttl_dd     t1 --员工证书职称信息
    LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C1
    ON  t1.std_ctf_nm = C1.CD_VAL
    AND C1.DT = '20241212'
    where t1.dt='20241212'
    and nvl(t1.std_ctf_nm,'')<>''   --证书名称 非空 证书编号有缺失
    and (t1.orig_ctf_nm regexp '理财' or c1.cd_val_dscr regexp '理财'
        or t1.pro_ctg_nm regexp '理财' or t1.cmt regexp '理财' or t1.ctf_isu_org='中国银行业协会')
)t1 where rn1=1
and concat(std_ctf,pro_ctg_nm) regexp '理财'
GROUP BY empe_id
;
--行外证书 参考 行外理财资质
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_04_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_04_1 AS
SELECT  DISTINCT a.empe_id
FROM
(
	SELECT  dd.empe_id
	       ,dd.std_ctf_nm
	       ,dd.pro_ctg
	       ,c.cd_val_dscr
	FROM edw.dim_hr_empe_ctf_ttl_dd dd
	LEFT JOIN edw.dwd_code_library_dd c
	WHERE dd.dt = '20221231' --证书清单
	AND ( ( dd.pro_ctg_nm = '个人理财' AND ( dd.std_ctf_nm = '011' OR dd.std_ctf_nm = '012' ) ) --银行从业
    OR ( dd.std_ctf_nm = '014' ) --afp
    OR ( dd.std_ctf_nm = '015' ) --cfp
    OR ( dd.std_ctf_nm = '007' ) --cfa
    OR ( dd.std_ctf_nm = '007' ) --afp
    OR ( dd.std_ctf_nm = '023' OR dd.std_ctf_nm = '022' ) --frm
    )
)a
;
--1.2、行内认证的理财资质-在这个表里取  ctf_nm 理财销售资质
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_04_2 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_04_2 AS
SELECT  empe_id,ctf_id
FROM    edw.dwd_hr_empe_int_ctf_dtrb_rcd_dd
WHERE   dt = '20240528'
AND     ctf_nm LIKE '%理财%'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024121217_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024121217_CST_05 AS
SElECT t1.客户号
    ,t1.账号
    ,t1.账户管户人工号
    ,t1.新账户管户人工号
    ,t1.账户管户人姓名
    ,t1.账户考核所在支行机构名称
    ,t1.账户考核所在分行机构名称
    ,t1.指定销售人工号
    ,t1.指定销售人姓名
    ,t2.mgr_id as 截止12月12日该账户的销售人工号
    ,t2.mgr_nm as 截止12月12日该账户的销售人姓名
    ,case when t3.empe_id is not null then '是' else '' end as D列账户管户人是否有行内理财资质
    ,t7.std_ctf as D列账户管户人行外理财资质
    ,case when t4.empe_id is not null then '是' else '' end as D列账户管户人是否有行内挂钩型理财销售资质
    ,case when t5.empe_id is not null then '是' else '' end as G列指定销售人是否有行内理财销售资质
    ,t8.std_ctf as G列指定销售人行外理财资质
    ,case when t6.empe_id is not null then '是' else '' end as G列指定销售人是否有行内挂钩型理财销售资质
from SJXQ_SJ2024121217_CST_01       t1
left join SJXQ_SJ2024121217_CST_02  t2
on t1.客户号=t2.cst_id
and t1.账号=t2.cst_act_id
left join SJXQ_SJ2024121217_CST_03  t3
on t1.新账户管户人工号=t3.empe_id
left join SJXQ_SJ2024121217_CST_03  t4
on t1.新账户管户人工号=t4.empe_id
and t4.is_gj_zz=1
left join SJXQ_SJ2024121217_CST_03  t5
on t1.指定销售人工号=t5.empe_id
left join SJXQ_SJ2024121217_CST_03  t6
on t1.指定销售人工号=t6.empe_id
and t6.is_gj_zz=1
left join SJXQ_SJ2024121217_CST_04  t7
on t1.新账户管户人工号=t7.empe_id
left join SJXQ_SJ2024121217_CST_04  t8
on t1.指定销售人工号=t8.empe_id
;
SElECT '01' seq, count(1) cnt, count(distinct 账号) custs
from SJXQ_SJ2024121217_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_act_id) custs
from SJXQ_SJ2024121217_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024121217_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct empe_id) custs
from SJXQ_SJ2024121217_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 账号) custs
from SJXQ_SJ2024121217_CST_05
;
SElECT *
from SJXQ_SJ2024121217_CST_05
;
/*
01	8900	8900
02	8900	8900
03	8834	8834
04	6657	6657
05	8900	8900
*/***管群谦_SJ20241118101_台州分行财富数据.sql
﻿/*
截止20241118，台州分行，手机银行近90日浏览过理财界面的客户清单
截止20241031，台州分行500万以上存款到期，且当前账户余额500万以上的客户清单
*/
-- 埋点基础数据+用户/机构数据整合
DROP   TABLE IF     EXISTS SJXQ_SJ20241118101_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241118101_CST_01 as
SELECT  d.brc_org_id
       ,d.brc_org_nm
       ,d.sbr_org_id
       ,d.sbr_org_nm
       ,d.org_id
       ,d.org_nm
       ,c.prm_mgr_id,c.prm_mgr_nm
    --    ,decode(kk.cst_seg_flg,'1','企业主','2','个体工商户','3','企事业高管','4','非持牌个体户','5','工薪族','6','退休养老','7','持家女性','') cluster
    --    ,decode(xj.aum_grd,'1','一星','2','二星','3','三星','4','四星','5','五星','6','六星','') wlth_lvl
    --    ,if(c.cst_id is null,'是','否') is_tourist
       ,a.distinct_id cst_id
    --    ,a.event
    --    ,a.time
    --    ,a.a_event_duration duration
    --    ,a.product_id
    --    ,a.product_name
    --    ,a.click_name
    --    ,a.is_success
    --    ,a.page_name
    --    ,a.dt data_dt
        ,count(a.event)       fnc_view_cnt_90d
        ,count(distinct a.dt) fnc_view_days_90d
FROM edw.aubs_events_ibnk a
LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd c
ON a.distinct_id = c.cst_id
AND c.dt = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd d
ON c.prm_org_id = d.org_id
AND d.dt = '@@{yyyyMMdd}'
-- LEFT JOIN adm_pub.adm_csm_clab_cst_jc_inf_dd kk
-- ON a.distinct_id = kk.cst_id
-- AND kk.dt = '@@{yyyyMMdd}'
-- LEFT JOIN adm_pub.adm_csm_cbas_cst_grd_inf_dd xj
-- ON a.distinct_id = xj.cst_id
-- AND xj.dt = '@@{yyyyMMdd}'
WHERE a.dt <= '20241118'
AND event not regexp '^login'
and d.brc_org_nm = '台州分行'
and a.event regexp '^financial' and event regexp '_pageview$'   --浏览理财界面
group by  d.brc_org_id,d.brc_org_nm,d.sbr_org_id,d.sbr_org_nm,d.org_id,d.org_nm,c.prm_mgr_id,c.prm_mgr_nm,a.distinct_id
; -- 剔除登录相关
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241118101_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241118101_CST_02 as
SELECT  t1.cst_id           AS 客户号
    ,t2.cst_chn_nm       AS 客户姓名
    ,t3.dep_bal          AS 存款余额_1118
    ,t3.mrgn_dep_bal     AS 保证金存款余额_1118
    ,t4.chm_bal          AS 理财产品余额_1118
    ,t4.cls_chm_bal      AS 封闭式理财余额_1118
    ,t4.open_chm_bal     AS 开放式理财余额_1118
    ,t5.loan_bal_acs     AS 贷款余额_1118
    ,t1.prm_mgr_id       AS 主管户客户经理工号
    ,t1.prm_mgr_nm       AS 主管户客户经理姓名
    ,t1.org_nm           AS 主管户机构
    ,t1.sbr_org_nm       AS 主管户支行
    ,t1.fnc_view_cnt_90d  AS 近90日浏览理财页面次数
    ,t1.fnc_view_days_90d AS 近90日浏览理财页面天数
from SJXQ_SJ20241118101_CST_01      t1
left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='20241118'
left join adm_pub.adm_csm_cbus_dep_inf_dd t3 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt='20241118'
left join adm_pub.adm_csm_cbus_chm_inf_dd t4 --客户集市-业务信息-客户理财业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='20241118'
left join adm_pub.adm_csm_cbus_loan_inf_dd t5		--贷款业务信息
on t1.cst_id=t5.cst_id
and t5.dt='20241118'
;
-- 截止20241031，台州分行500万以上存款到期，且当前账户余额500万以上的客户清单 定期存款
DROP   TABLE IF     EXISTS SJXQ_SJ20241118101_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241118101_CST_03 as
SELECT distinct t1.CST_ID					--客户号
    ,t3.prm_mgr_id,t3.prm_mgr_nm
    ,t4.sbr_org_nm,t4.org_nm
FROM EDW.DWS_BUS_DEP_ACT_INF_DD	        t1 	-- 存款账户信息表
INNER join EDW.DWS_BUS_DEP_ACT_INF_DD   t2
on t1.dep_act_id=t2.dep_act_id
and t2.dt='@@{yyyyMMdd}'
and t2.GL_BAL>=5000000  --账户总账余额
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
WHERE t1.DT='20241031'
and t1.lbl_prod_typ_cd='1' --,'0','活期','1','定期'
AND t1.GL_BAL>=5000000  --账户总账余额
AND t1.MTU_DT<='20241031'
and t4.brc_org_nm='台州分行'
;
-- 结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20241118101_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241118101_CST_04 as
SELECT  t1.cst_id       AS 客户号
    ,t2.cst_chn_nm   AS 客户姓名
    ,t3.dep_bal      AS 存款余额_1124
    ,t3.mrgn_dep_bal AS 保证金存款余额_1124
    ,t4.chm_bal      AS 理财产品余额_1124
    ,t4.cls_chm_bal  AS 封闭式理财余额_1124
    ,t4.open_chm_bal AS 开放式理财余额_1124
    ,t5.loan_bal_acs AS 贷款余额_1124
    ,t1.prm_mgr_id   AS 主管户客户经理工号
    ,t1.prm_mgr_nm   AS 主管户客户经理姓名
    ,t1.org_nm       AS 主管户机构
    ,t1.sbr_org_nm   AS 主管户支行
from SJXQ_SJ20241118101_CST_03      t1
left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_dep_inf_dd t3 --客户集市-业务信息-客户存款业务信息表
on t1.cst_id=t3.cst_id
and t3.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_chm_inf_dd t4 --客户集市-业务信息-客户理财业务信息表
on t1.cst_id=t4.cst_id
and t4.dt='@@{yyyyMMdd}'
left join adm_pub.adm_csm_cbus_loan_inf_dd t5 --贷款业务信息
on t1.cst_id=t5.cst_id
and t5.dt='@@{yyyyMMdd}'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241118101_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241118101_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241118101_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241118101_CST_04
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20241118101_CST_02
;
SELECT *
from lab_bigdata_dev.SJXQ_SJ20241118101_CST_04
;
***耿鹏程_SJ2024120531_汝南村行信贷业务退回.sql
﻿-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_01 AS
SELECT  col_1  AS 用信申请流水号
       ,col_2  AS 客户号
       ,col_3  AS 客户名称
       ,col_4  AS 发生类型
       ,col_5  AS 产品名称
       ,col_6  AS 合同起始日期
       ,col_7  AS 合同到期日期
       ,col_8  AS 合同金额
       ,col_9  AS 合同余额
       ,col_10 AS 执行月利率
       ,col_11 AS 经办人名称
from qbi_file_20241205_15_30_59_0
where pt<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_02 AS
SElECT t2.usc_aply_serno                         --用信申请流水号|c32
	,t2.ahn_ltr_aply_serno                       --授用信申请流水号 业务流水号
from (
    select distinct 用信申请流水号 as rel_serno
    from SJXQ_SJ2024120531_CST_01
)t1 inner join edw.dwd_bus_loan_lmt_aply_biz_dd  t2 --用信方案
on t1.rel_serno=t2.USC_APLY_SERNO
and t2.dt='@@{yyyyMMdd}'
;
-- 实例汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_03 AS
select t1.*,t2.usc_aply_serno   --不同申请编号 对应 同一审批流程
    ,ROW_NUMBER() over(partition by t2.usc_aply_serno order by start_time desc) rn
from(
    select instance_id                              --流程实例id
        ,flow_name                                --流程名称
        ,flow_starter_name                        --发起者名称
        ,replace(start_time,'/','') as start_time --流程发起时间
        ,org_id                                   --发起人机构id
        ,biz_id                                   --业务流水号|c32
        ,biz_type_cd                              --业务类型代码|c32
    from edw.dwd_bus_loan_n_wf_instance_his_dd    --流程运行实例历史表
    where dt='@@{yyyyMMdd}'
    union
    select instance_id                            --流程实例id
        ,flow_name                                --流程名称
        ,flow_starter_name                        --发起者名称
        ,replace(start_time,'-','') as start_time --流程发起时间
        ,org_id                                   --发起人机构id
        ,biz_id                                   --业务流水号
        ,biz_type                                 --业务类型
    from edw.loan_n_wf_instance                   --流程运行实例表
    where dt<='@@{yyyyMMdd}'
)t1 inner join SJXQ_SJ2024120531_CST_02 t2
on t1.biz_id=t2.ahn_ltr_aply_serno
;
-- 审批汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_04 AS
select t1.usc_aply_serno,t1.biz_id,t1.flow_name
    ,t2.*
    ,ROW_NUMBER() over(partition by t1.usc_aply_serno order by t2.start_time asc) rn
from SJXQ_SJ2024120531_CST_03 t1
inner join(
    select t1.comment_id                               --主键|c32
        ,t1.instance_id                              --实例id|c32
        ,t1.user_id                                  --用户id|c32
	    ,t2.empe_nm as user_name                     --用户名称
        ,t1.comment_sign                             --用户结论|c5
        ,t1.start_time                               --评论时间|c32
        ,t1.role_id                                  --审批人角色id|c32
        ,t1.user_comment                             --用户评价|c1000
        ,t1.node_nm                                --节点名称|c32
        ,t1.org_id                                   --所属机构编号|c32
        ,'his' src_tbl
    from edw.dwd_bus_loan_n_wf_comment_his_dd t1    --流程审批意见历史
    left join edw.dws_hr_empe_inf_dd          t2 --员工信息汇总
    on  substr(t1.user_id,1,6)=t2.empe_id
    and t2.dt='@@{yyyyMMdd}'
    where t1.dt='@@{yyyyMMdd}'
    union all
    select comment_id                               --主键|c32
        ,instance_id                              --实例id|c32
        ,user_id                                  --用户id|c32
	    ,user_name                                --用户名称
        ,comment_sign                             --用户结论|c5
        ,start_time                               --评论时间|c32
        ,role_id                                  --审批人角色id|c32
        ,user_comment                             --用户评价|c1000
        ,node_name                                --节点名称|c32
        ,org_id                                   --所属机构编号|c32
        ,'curr' src_tbl
    from edw.loan_n_wf_comment	                --流程审批意见
    where dt='@@{yyyyMMdd}'
)t2 on t1.instance_id=t2.instance_id
where t1.rn=1
;
-- 流程审批意见
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_05 AS
SElECT usc_aply_serno,biz_id
from SJXQ_SJ2024120531_CST_04
GROUP BY usc_aply_serno,biz_id
;
-- 字段汇总表
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_06 AS
SELECT  t1.用信申请流水号
       ,t1.客户号
       ,t1.客户名称
       ,t1.发生类型
       ,t1.产品名称
       ,t1.合同起始日期
       ,t1.合同到期日期
       ,t1.合同金额
       ,t1.合同余额
       ,t1.执行月利率
       ,t1.经办人名称
    ,t2.biz_id as 业务流水号
    ,t2.流程审批意见
    ,case when t2.流程审批意见 regexp '退回' then '是' else '否' end as 是否包含退回
from SJXQ_SJ2024120531_CST_01       t1
left join SJXQ_SJ2024120531_CST_05  t2
on t1.用信申请流水号=t2.usc_aply_serno
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024120531_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024120531_CST_07 AS
SELECT  t1.用信申请流水号
    ,t1.客户号
    ,t1.客户名称
    ,t1.发生类型
    ,t1.产品名称
    ,t1.合同起始日期
    ,t1.合同到期日期
    ,t1.合同金额
    ,t1.合同余额
    ,t1.执行月利率
    ,t1.经办人名称
    ,t2.biz_id     AS 业务流水号
    ,t2.rn         AS 流程序号
    ,t2.node_nm    AS 节点名称
    ,t2.user_name  AS 用户名称
    ,t2.start_time AS 评论时间
    ,concat(t2.comment_sign,';',t2.user_comment) as 流程审批意见
    ,case when t2.comment_sign regexp '退回' or t2.user_comment regexp '退回' then '是' else '否' end as 是否包含退回
from SJXQ_SJ2024120531_CST_01       t1
left join SJXQ_SJ2024120531_CST_04  t2
on t1.用信申请流水号=t2.usc_aply_serno
;
SElECT '01' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from SJXQ_SJ2024120531_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct usc_aply_serno) custs
from SJXQ_SJ2024120531_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct usc_aply_serno) custs
from SJXQ_SJ2024120531_CST_03 where rn=1
union all
SElECT '04' seq, count(1) cnt,count(distinct usc_aply_serno,comment_id) custs
from SJXQ_SJ2024120531_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct usc_aply_serno) custs
from SJXQ_SJ2024120531_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from SJXQ_SJ2024120531_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 用信申请流水号) custs
from SJXQ_SJ2024120531_CST_07
;
SElECT '06' seq,*
from SJXQ_SJ2024120531_CST_06
WHERE 是否包含退回='是'
;
SElECT '07' seq,*
from SJXQ_SJ2024120531_CST_07
WHERE 是否包含退回='是'
;
/*
01	2120	2109
02	2109	2109
03	2109	2109
04	13184	13184
05	2108	2108
06	2120	2109
07	13271	2109
*/
***邓凤平_SJ2024112521_内部降额业务分析.sql
﻿/*
截止10月末数据，大冶村行
bsn_sts	string	业务状态 202406核销 正常 证券化
adm_rsk.adm_rsk_apl_inter_all	风险集市应用表-资产质量日常监测源表	19
*/
-- 2022,2023年合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_01 AS
select t1.*
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from(
    select t1.dt,t1.cst_id                           --客户号|C20
        ,sum(t1.ctr_amt) as ctr_amt             --合同金额DECIMAL(21,2)
        ,sum(t1.ctr_bal) as ctr_bal             --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1      --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on  t1.prd_no=t2.prd_no
    and t2.dt='20241031'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt between '20210131' and '20231231'
    and substr(to_char(dateadd(to_date(t1.dt, 'yyyyMMdd'),1,'dd'),'yyyyMMdd'),7,2)='01'   --月末
    group by t1.dt,t1.cst_id
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20241031'
;
--当前合同 20241031
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_02 AS
select t1.ctr_serno                             --合同流水号
	,t1.cst_id                                  --客户号
	,t1.cst_nm                                  --客户名称
	,t1.ctr_amt                                 --合同金额
	,t1.ctr_bal                                 --合同余额
    ,t1.ctr_epsr_amt 	                        --合同敞口金额
    ,t1.ctr_epsr_bal                            --合同敞口余额
	,t1.ctr_bgn_dt                               --合同起始日期
    ,t1.SYS_REG_DT      --系统登记日期
    ,substr(t1.SYS_REG_DT,1,4)  as 准入年份
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,t1.cur_rsk_ctg_rslt_cd	    --当前风险分类结果代码|c2
    ,c1.cd_val_dscr     as cur_rsk_ctg_rslt_nm
    ,t1.cst_rsk_grd_cd	        --客户风险等级代码|c1
    ,c2.cd_val_dscr     as cst_rsk_grd_nm
    ,case when nvl(t6.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t6.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241031'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20241031'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20241031'
and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20241031'
left join edw.DWS_CST_BAS_INF_DD            t6
on t1.cst_id=t6.cst_id
and t6.dt='20241031'
left join edw.dwd_code_library_dd           c1
on t1.CUR_RSK_CTG_RSLT_CD=c1.cd_val
and c1.dt= '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c2
on t1.cst_rsk_grd_cd=c2.cd_val
and c2.dt= '@@{yyyyMMdd}'
where t1.dt='20241031'
;
-- 是否风险客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_03 AS
SElECT distinct cst_id
from adm_rsk.adm_rsk_apl_inter_all	--风险集市应用表-资产质量日常监测源表	19
where dt<='20241031'
and is_rsk_loan='Y'	--	是否风险贷款
;
-- 2022年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_04 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as max_ctr_amt_2022
    ,sum(ctr_bal) as max_ctr_bal_2022
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST_01 t1
INNER join(
    SELECT DISTINCT sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2022'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2023年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_05 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as max_ctr_amt_2023
    ,sum(ctr_bal) as max_ctr_bal_2023
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST_01 t1
INNER join(
    SELECT DISTINCT sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2023'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2021年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_05_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_05_1 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as max_ctr_amt_2021
    ,sum(ctr_bal) as max_ctr_bal_2021
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST_01 t1
INNER join(
    SELECT DISTINCT sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2021'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2022年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_06 AS
select dt,t1.cst_id
    ,ctr_amt as max_ctr_amt_2022
    ,ctr_bal as max_ctr_bal_2022
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST_01 t1
INNER join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024112521_CST_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2022'
;
-- 2023年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_07 AS
select dt,t1.cst_id
    ,ctr_amt as max_ctr_amt_2023
    ,ctr_bal as max_ctr_bal_2023
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST_01 t1
INNER join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024112521_CST_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2023'
;
-- 2021年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_07_1 AS
select dt,t1.cst_id
    ,ctr_amt as max_ctr_amt_2021
    ,ctr_bal as max_ctr_bal_2021
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST_01 t1
INNER join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024112521_CST_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2021'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST_08 AS
SELECT  t1.sbr_org_nm    AS 支行_1031
    ,t1.tem_org_nm       AS 团队_1031
    ,t1.mgr_id           AS 管户人名称_1031
    ,t1.mgr_nm           AS 管户人工号_1031
    ,t1.hdl_opr_id       AS 经办人工号_1031
    ,t1.hdl_opr_nm       AS 经办人名称_1031
    ,t1.cst_id           AS 客户号
    ,t1.cst_nm           AS 客户名称
    ,case when nvl(t4.max_ctr_amt_2022,0)>nvl(t51.max_ctr_amt_2021,0) then '1'
        when nvl(t4.max_ctr_amt_2022,0)=nvl(t51.max_ctr_amt_2021,0)  then '0'
        when nvl(t4.max_ctr_amt_2022,0)<nvl(t51.max_ctr_amt_2021,0)  then '-1' else '' end  2022年同一风险控制号最高授信金额是否上升
    ,case when nvl(t8.max_ctr_amt_2022,0)>nvl(t91.max_ctr_amt_2021,0) then '1'
        when nvl(t8.max_ctr_amt_2022,0)=nvl(t91.max_ctr_amt_2021,0)  then '0'
        when nvl(t8.max_ctr_amt_2022,0)<nvl(t91.max_ctr_amt_2021,0)  then '-1' else '' end  2022年单户最高授信金额是否上升
    ,case when nvl(t4.max_ctr_amt_2022,0)>nvl(t5.max_ctr_amt_2023,0) then '-1'
        when nvl(t4.max_ctr_amt_2022,0)=nvl(t5.max_ctr_amt_2023,0)  then '0'
        when nvl(t4.max_ctr_amt_2022,0)<nvl(t5.max_ctr_amt_2023,0)  then '1' else '' end  2023年同一风险控制号最高授信金额是否上升
    ,case when nvl(t8.max_ctr_amt_2022,0)>nvl(t9.max_ctr_amt_2023,0) then '-1'
        when nvl(t8.max_ctr_amt_2022,0)=nvl(t9.max_ctr_amt_2023,0)  then '0'
        when nvl(t8.max_ctr_amt_2022,0)<nvl(t9.max_ctr_amt_2023,0)  then '1' else '' end  2023年单户最高授信金额是否上升
    ,t31.max_ctr_bal_2021 AS 2021年同一风险控制号最高余额月末最后一天_含核销
    ,t31.dt               AS 2021年同一风险控制号最高余额所在月份_含核销
    ,t2.max_ctr_bal_2022 AS 2022年同一风险控制号最高余额月末最后一天_含核销
    ,t2.dt               AS 2022年同一风险控制号最高余额所在月份_含核销
    ,t3.max_ctr_bal_2023 AS 2023年同一风险控制号最高余额月末最后一天_含核销
    ,t3.dt               AS 2023年同一风险控制号最高余额所在月份_含核销
    ,t51.max_ctr_amt_2021 AS 2021年同一风险控制号最高授信金额月末最后一天
    ,t51.dt               AS 2021年同一风险控制号最高授信金额所在月份
    ,t4.max_ctr_amt_2022 AS 2022年同一风险控制号最高授信金额月末最后一天
    ,t4.dt               AS 2022年同一风险控制号最高授信金额所在月份
    ,t5.max_ctr_amt_2023 AS 2023年同一风险控制号最高授信金额月末最后一天
    ,t5.dt               AS 2023年同一风险控制号最高授信金额所在月份
    ,t71.max_ctr_bal_2021 AS 2021年单户最高余额月末最后一天_含核销
    ,t71.dt               AS 2021年单户最高余额所在月份_含核销
    ,t6.max_ctr_bal_2022 AS 2022年单户最高余额月末最后一天_含核销
    ,t6.dt               AS 2022年单户最高余额所在月份_含核销
    ,t7.max_ctr_bal_2023 AS 2023年单户最高余额月末最后一天_含核销
    ,t7.dt               AS 2023年单户最高余额所在月份_含核销
    ,t91.max_ctr_amt_2021 AS 2021年单户最高授信金额月末最后一天
    ,t91.dt               AS 2021年单户最高授信金额所在月份
    ,t8.max_ctr_amt_2022 AS 2022年单户最高授信金额月末最后一天
    ,t8.dt               AS 2022年单户最高授信金额所在月份
    ,t9.max_ctr_amt_2023 AS 2023年单户最高授信金额月末最后一天
    ,t9.dt               AS 2023年单户最高授信金额所在月份
    ,case when t51.max_ctr_amt_2021 < 300000 then '1 <=30万'
        when t51.max_ctr_amt_2021>=300000  and t51.max_ctr_amt_2021 < 500000  then '2 30-50万'
        when t51.max_ctr_amt_2021>=500000  and t51.max_ctr_amt_2021 < 1000000 then '3 50-100万'
        when t51.max_ctr_amt_2021>=1000000 and t51.max_ctr_amt_2021 < 1500000 then '4 100-150万'
        when t51.max_ctr_amt_2021>=1500000 and t51.max_ctr_amt_2021 < 3000000 then '5 150-300万'
        when t51.max_ctr_amt_2021>=3000000 then '6 300万元及以上' else '其他' end as 2021年额度分布_同一风险控制号维度
    ,case when t91.max_ctr_amt_2021 < 300000 then '1 <=30万'
        when t91.max_ctr_amt_2021>=300000  and t91.max_ctr_amt_2021 < 500000  then '2 30-50万'
        when t91.max_ctr_amt_2021>=500000  and t91.max_ctr_amt_2021 < 1000000 then '3 50-100万'
        when t91.max_ctr_amt_2021>=1000000 and t91.max_ctr_amt_2021 < 1500000 then '4 100-150万'
        when t91.max_ctr_amt_2021>=1500000 and t91.max_ctr_amt_2021 < 3000000 then '5 150-300万'
        when t91.max_ctr_amt_2021>=3000000 then '6 300万元及以上' else '其他' end as 2021年额度分布_单个客户维度
    ,case when t4.max_ctr_amt_2022 < 300000 then '1 <=30万'
        when t4.max_ctr_amt_2022>=300000  and t4.max_ctr_amt_2022 < 500000  then '2 30-50万'
        when t4.max_ctr_amt_2022>=500000  and t4.max_ctr_amt_2022 < 1000000 then '3 50-100万'
        when t4.max_ctr_amt_2022>=1000000 and t4.max_ctr_amt_2022 < 1500000 then '4 100-150万'
        when t4.max_ctr_amt_2022>=1500000 and t4.max_ctr_amt_2022 < 3000000 then '5 150-300万'
        when t4.max_ctr_amt_2022>=3000000 then '6 300万元及以上' else '其他' end as 2022年额度分布_同一风险控制号维度
    ,case when t8.max_ctr_amt_2022 < 300000 then '1 <=30万'
        when t8.max_ctr_amt_2022>=300000  and t8.max_ctr_amt_2022 < 500000  then '2 30-50万'
        when t8.max_ctr_amt_2022>=500000  and t8.max_ctr_amt_2022 < 1000000 then '3 50-100万'
        when t8.max_ctr_amt_2022>=1000000 and t8.max_ctr_amt_2022 < 1500000 then '4 100-150万'
        when t8.max_ctr_amt_2022>=1500000 and t8.max_ctr_amt_2022 < 3000000 then '5 150-300万'
        when t8.max_ctr_amt_2022>=3000000 then '6 300万元及以上' else '其他' end as 2022年额度分布_单个客户维度
    ,case when t5.max_ctr_amt_2023 < 300000 then '1 <=30万'
        when t5.max_ctr_amt_2023>=300000  and t5.max_ctr_amt_2023 < 500000  then '2 30-50万'
        when t5.max_ctr_amt_2023>=500000  and t5.max_ctr_amt_2023 < 1000000 then '3 50-100万'
        when t5.max_ctr_amt_2023>=1000000 and t5.max_ctr_amt_2023 < 1500000 then '4 100-150万'
        when t5.max_ctr_amt_2023>=1500000 and t5.max_ctr_amt_2023 < 3000000 then '5 150-300万'
        when t5.max_ctr_amt_2023>=3000000 then '6 300万元及以上' else '其他' end as 2023年额度分布_同一风险控制号维度
    ,case when t9.max_ctr_amt_2023 < 300000 then '1 <=30万'
        when t9.max_ctr_amt_2023>=300000  and t9.max_ctr_amt_2023 < 500000  then '2 30-50万'
        when t9.max_ctr_amt_2023>=500000  and t9.max_ctr_amt_2023 < 1000000 then '3 50-100万'
        when t9.max_ctr_amt_2023>=1000000 and t9.max_ctr_amt_2023 < 1500000 then '4 100-150万'
        when t9.max_ctr_amt_2023>=1500000 and t9.max_ctr_amt_2023 < 3000000 then '5 150-300万'
        when t9.max_ctr_amt_2023>=3000000 then '6 300万元及以上' else '其他' end as 2023年额度分布_单个客户维度
    ,case when t10.ctr_amt_1031 < 300000 then '1 <=30万'
        when t10.ctr_amt_1031>=300000  and t10.ctr_amt_1031 < 500000  then '2 30-50万'
        when t10.ctr_amt_1031>=500000  and t10.ctr_amt_1031 < 1000000 then '3 50-100万'
        when t10.ctr_amt_1031>=1000000 and t10.ctr_amt_1031 < 1500000 then '4 100-150万'
        when t10.ctr_amt_1031>=1500000 and t10.ctr_amt_1031 < 3000000 then '5 150-300万'
        when t10.ctr_amt_1031>=3000000 then '6 300万元及以上' else '其他' end as 最新额度分布_同一风险控制号维度_1031
    ,case when t1.ctr_amt < 300000 then '1 <=30万'
        when t1.ctr_amt>=300000  and t1.ctr_amt < 500000  then '2 30-50万'
        when t1.ctr_amt>=500000  and t1.ctr_amt < 1000000 then '3 50-100万'
        when t1.ctr_amt>=1000000 and t1.ctr_amt < 1500000 then '4 100-150万'
        when t1.ctr_amt>=1500000 and t1.ctr_amt < 3000000 then '5 150-300万'
        when t1.ctr_amt>=3000000 then '6 300万元及以上' else '其他' end as 最新额度分布_单个客户维度_1031
    ,t10.ctr_epsr_amt     AS 最新同一风险控制号敞口金额_1031
    ,t10.ctr_epsr_bal     AS 最新同一风险控制号敞口余额_1031
    ,t1.ctr_bal           AS 当前客户余额_1031
    ,case when t11.cst_id is not null then '是' else '' end as 是否风险客户_1031
    ,t1.最早准入年份
from(
    SElECT sam_rsk_ctrl_id,cst_id,cst_nm
        ,sum(ctr_amt)                            as ctr_amt
        ,sum(ctr_bal)                            as ctr_bal
        ,min(准入年份)  as 最早准入年份
    from SJXQ_SJ2024112521_CST_02
    group by sam_rsk_ctrl_id,cst_id,cst_nm
)t1 left join SJXQ_SJ2024112521_CST_04  t2 --2022
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id and t2.rn_bal=1
left join SJXQ_SJ2024112521_CST_05      t3 --2023
on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id and t3.rn_bal=1
left join SJXQ_SJ2024112521_CST_05_1    t31 --2021
on t1.sam_rsk_ctrl_id=t31.sam_rsk_ctrl_id and t31.rn_bal=1
left join SJXQ_SJ2024112521_CST_04      t4 --2022
on t1.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id and t4.rn_amt=1
left join SJXQ_SJ2024112521_CST_05      t5 --2023
on t1.sam_rsk_ctrl_id=t5.sam_rsk_ctrl_id and t5.rn_amt=1
left join SJXQ_SJ2024112521_CST_05_1    t51 --2021
on t1.sam_rsk_ctrl_id=t51.sam_rsk_ctrl_id and t51.rn_amt=1
left join SJXQ_SJ2024112521_CST_06      t6 --2022
on t1.cst_id=t6.cst_id and t6.rn_bal=1
left join SJXQ_SJ2024112521_CST_07      t7 --2023
on t1.cst_id=t7.cst_id and t7.rn_bal=1
left join SJXQ_SJ2024112521_CST_07_1    t71 --2021
on t1.cst_id=t71.cst_id and t71.rn_bal=1
left join SJXQ_SJ2024112521_CST_06      t8 --2022
on t1.cst_id=t8.cst_id and t8.rn_amt=1
left join SJXQ_SJ2024112521_CST_07      t9 --2023
on t1.cst_id=t9.cst_id and t9.rn_amt=1
left join SJXQ_SJ2024112521_CST_07_1      t91 --2021
on t1.cst_id=t91.cst_id and t91.rn_amt=1
left join (
    select sam_rsk_ctrl_id
        ,sum(ctr_amt)      as ctr_amt_1031
        ,sum(ctr_epsr_amt) as ctr_epsr_amt 	 --合同敞口金额
        ,sum(ctr_epsr_bal) as ctr_epsr_bal   --合同敞口余额
    from SJXQ_SJ2024112521_CST_02
    group by sam_rsk_ctrl_id
)t10 on t1.sam_rsk_ctrl_id=t10.sam_rsk_ctrl_id
left join SJXQ_SJ2024112521_CST_03  t11
on t1.cst_id=t11.cst_id
;
SElECT *
from lab_bigdata_dev.SJXQ_SJ2024112521_CST_08
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024112521_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024112521_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112521_CST_08
;
/*
01	56680782	1782036
02	81306	25304
03	95327	95327
04	241402	20736
05	258083	22832
06	253642	21832
07	272263	24124
08	25304	25304
*/***邓凤平_SJ2024112521_内部降额业务分析1216.sql
/*
截止10月末数据，大冶村行
bsn_sts	string	业务状态 202406核销 正常 证券化
adm_rsk.adm_rsk_apl_inter_all	风险集市应用表-资产质量日常监测源表	19
*/
-- 2022,2023年合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_01 AS
select t1.*
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from(
    select t1.dt,t1.cst_id                           --客户号|C20
        ,sum(t1.ctr_amt) as ctr_amt             --合同金额DECIMAL(21,2)
        ,sum(t1.ctr_bal) as ctr_bal             --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1      --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on  t1.prd_no=t2.prd_no
    and t2.dt='20241031'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt between '20210131' and '20231231'
    and substr(to_char(dateadd(to_date(t1.dt, 'yyyyMMdd'),1,'dd'),'yyyyMMdd'),7,2)='01'   --月末
    group by t1.dt,t1.cst_id
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20241031'
;
--当前合同 20241031
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_02 AS
select t1.ctr_serno                             --合同流水号
	,t1.cst_id                                  --客户号
	,t1.cst_nm                                  --客户名称
	,t1.ctr_amt                                 --合同金额
	,t1.ctr_bal                                 --合同余额
    ,t1.ctr_epsr_amt 	                        --合同敞口金额
    ,t1.ctr_epsr_bal                            --合同敞口余额
	,t1.ctr_bgn_dt                               --合同起始日期
    ,t1.SYS_REG_DT      --系统登记日期
    ,substr(t1.SYS_REG_DT,1,4)  as 准入年份
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t1.hdl_opr_id	    --经办人工号
    ,t5.empe_nm         as hdl_opr_nm	--经办人
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,t1.cur_rsk_ctg_rslt_cd	    --当前风险分类结果代码|c2
    ,c1.cd_val_dscr     as cur_rsk_ctg_rslt_nm
    ,t1.cst_rsk_grd_cd	        --客户风险等级代码|c1
    ,c2.cd_val_dscr     as cst_rsk_grd_nm
    ,case when nvl(t6.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t6.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241031'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20241031'
inner join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20241031'
and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
left join edw.dws_hr_empe_inf_dd            t5 --员工信息汇总
on  t1.hdl_opr_id=t5.empe_id
and t5.dt='20241031'
left join edw.DWS_CST_BAS_INF_DD            t6
on t1.cst_id=t6.cst_id
and t6.dt='20241031'
left join edw.dwd_code_library_dd           c1
on t1.CUR_RSK_CTG_RSLT_CD=c1.cd_val
and c1.dt= '@@{yyyyMMdd}'
left join edw.dwd_code_library_dd           c2
on t1.cst_rsk_grd_cd=c2.cd_val
and c2.dt= '@@{yyyyMMdd}'
where t1.dt='20241031'
;
-- 是否风险客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_03 AS
SElECT distinct cst_id
from adm_rsk.adm_rsk_apl_inter_all	--风险集市应用表-资产质量日常监测源表	19
where dt<='20241031'
and is_rsk_loan='Y'	--	是否风险贷款
;
-- 2021年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_04 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as ctr_amt_2021
    ,sum(ctr_bal) as ctr_bal_2021
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) asc,dt desc) rn_bal_asc
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) asc,dt desc) rn_amt_asc
from SJXQ_SJ2024112521_CST2_01 t1
INNER join(
    SELECT DISTINCT sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2021'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2022年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_05 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as ctr_amt_2022
    ,sum(ctr_bal) as ctr_bal_2022
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) asc,dt desc) rn_bal_asc
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) asc,dt desc) rn_amt_asc
from SJXQ_SJ2024112521_CST2_01 t1
INNER join(
    SELECT DISTINCT sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2022'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2023年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_06 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as ctr_amt_2023
    ,sum(ctr_bal) as ctr_bal_2023
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) asc,dt desc) rn_bal_asc
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) asc,dt desc) rn_amt_asc
from SJXQ_SJ2024112521_CST2_01 t1
INNER join(
    SELECT DISTINCT sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2023'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2021年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_07 AS
select dt,t1.cst_id
    ,ctr_amt as ctr_amt_2021
    ,ctr_bal as ctr_bal_2021
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
    ,row_number() over(partition by t1.cst_id order by ctr_bal asc,dt desc) rn_bal_asc
    ,row_number() over(partition by t1.cst_id order by ctr_amt asc,dt desc) rn_amt_asc
from SJXQ_SJ2024112521_CST2_01 t1
INNER join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2021'
;
-- 2022年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_08 AS
select dt,t1.cst_id
    ,ctr_amt as ctr_amt_2022
    ,ctr_bal as ctr_bal_2022
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
    ,row_number() over(partition by t1.cst_id order by ctr_bal asc,dt desc) rn_bal_asc
    ,row_number() over(partition by t1.cst_id order by ctr_amt asc,dt desc) rn_amt_asc
from SJXQ_SJ2024112521_CST2_01 t1
INNER join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2022'
;
-- 2023年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_09 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_09 AS
select dt,t1.cst_id
    ,ctr_amt as ctr_amt_2023
    ,ctr_bal as ctr_bal_2023
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
    ,row_number() over(partition by t1.cst_id order by ctr_bal asc,dt desc) rn_bal_asc
    ,row_number() over(partition by t1.cst_id order by ctr_amt asc,dt desc) rn_amt_asc
from SJXQ_SJ2024112521_CST2_01 t1
INNER join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2023'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_10 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_10 AS
SELECT  t1.sbr_org_nm    AS 支行_1031
    ,t1.tem_org_nm       AS 团队_1031
    ,t1.mgr_id           AS 管户人名称_1031
    ,t1.mgr_nm           AS 管户人工号_1031
    ,t1.hdl_opr_id       AS 经办人工号_1031
    ,t1.hdl_opr_nm       AS 经办人名称_1031
    ,t1.cst_id           AS 客户号
    ,t1.cst_nm           AS 客户名称
    ,case when nvl(t22_s_maxamt.ctr_amt_2022,0)>nvl(t21_s_maxamt.ctr_amt_2021,0) then '1'
        when nvl(t22_s_maxamt.ctr_amt_2022,0)=nvl(t21_s_maxamt.ctr_amt_2021,0)  then '0'
        when nvl(t22_s_maxamt.ctr_amt_2022,0)<nvl(t21_s_maxamt.ctr_amt_2021,0)  then '-1' else '' end  2022年同一风险控制号最高授信金额是否上升
    ,case when nvl(t22_c_maxamt.ctr_amt_2022,0)>nvl(t21_c_maxamt.ctr_amt_2021,0) then '1'
        when nvl(t22_c_maxamt.ctr_amt_2022,0)=nvl(t21_c_maxamt.ctr_amt_2021,0)  then '0'
        when nvl(t22_c_maxamt.ctr_amt_2022,0)<nvl(t21_c_maxamt.ctr_amt_2021,0)  then '-1' else '' end  2022年单户最高授信金额是否上升
    ,case when nvl(t22_s_maxamt.ctr_amt_2022,0)>nvl(t23_s_maxamt.ctr_amt_2023,0) then '-1'
        when nvl(t22_s_maxamt.ctr_amt_2022,0)=nvl(t23_s_maxamt.ctr_amt_2023,0)  then '0'
        when nvl(t22_s_maxamt.ctr_amt_2022,0)<nvl(t23_s_maxamt.ctr_amt_2023,0)  then '1' else '' end  2023年同一风险控制号最高授信金额是否上升
    ,case when nvl(t22_c_maxamt.ctr_amt_2022,0)>nvl(t23_c_maxamt.ctr_amt_2023,0) then '-1'
        when nvl(t22_c_maxamt.ctr_amt_2022,0)=nvl(t23_c_maxamt.ctr_amt_2023,0)  then '0'
        when nvl(t22_c_maxamt.ctr_amt_2022,0)<nvl(t23_c_maxamt.ctr_amt_2023,0)  then '1' else '' end  2023年单户最高授信金额是否上升
    -- 最高
    ,t21_s_maxbal.ctr_bal_2021 AS 2021年同一风险控制号最高余额月末最后一天_含核销
    ,t21_s_maxbal.dt               AS 2021年同一风险控制号最高余额所在月份_含核销
    ,t22_s_maxbal.ctr_bal_2022 AS 2022年同一风险控制号最高余额月末最后一天_含核销
    ,t22_s_maxbal.dt               AS 2022年同一风险控制号最高余额所在月份_含核销
    ,t23_s_maxbal.ctr_bal_2023 AS 2023年同一风险控制号最高余额月末最后一天_含核销
    ,t23_s_maxbal.dt               AS 2023年同一风险控制号最高余额所在月份_含核销
    ,t21_s_maxamt.ctr_amt_2021 AS 2021年同一风险控制号最高授信金额月末最后一天
    ,t21_s_maxamt.dt               AS 2021年同一风险控制号最高授信金额所在月份
    ,t22_s_maxamt.ctr_amt_2022 AS 2022年同一风险控制号最高授信金额月末最后一天
    ,t22_s_maxamt.dt               AS 2022年同一风险控制号最高授信金额所在月份
    ,t23_s_maxamt.ctr_amt_2023 AS 2023年同一风险控制号最高授信金额月末最后一天
    ,t23_s_maxamt.dt               AS 2023年同一风险控制号最高授信金额所在月份
    ,t21_c_maxbal.ctr_bal_2021 AS 2021年单户最高余额月末最后一天_含核销
    ,t21_c_maxbal.dt               AS 2021年单户最高余额所在月份_含核销
    ,t22_c_maxbal.ctr_bal_2022 AS 2022年单户最高余额月末最后一天_含核销
    ,t22_c_maxbal.dt               AS 2022年单户最高余额所在月份_含核销
    ,t23_c_maxbal.ctr_bal_2023 AS 2023年单户最高余额月末最后一天_含核销
    ,t23_c_maxbal.dt               AS 2023年单户最高余额所在月份_含核销
    ,t21_c_maxamt.ctr_amt_2021 AS 2021年单户最高授信金额月末最后一天
    ,t21_c_maxamt.dt               AS 2021年单户最高授信金额所在月份
    ,t22_c_maxamt.ctr_amt_2022 AS 2022年单户最高授信金额月末最后一天
    ,t22_c_maxamt.dt               AS 2022年单户最高授信金额所在月份
    ,t23_c_maxamt.ctr_amt_2023 AS 2023年单户最高授信金额月末最后一天
    ,t23_c_maxamt.dt               AS 2023年单户最高授信金额所在月份
    -- 最低
    ,t21_s_minbal.ctr_bal_2021 AS 2021年同一风险控制号最低余额月末最后一天_含核销
    ,t21_s_minbal.dt               AS 2021年同一风险控制号最低余额所在月份_含核销
    ,t22_s_minbal.ctr_bal_2022 AS 2022年同一风险控制号最低余额月末最后一天_含核销
    ,t22_s_minbal.dt               AS 2022年同一风险控制号最低余额所在月份_含核销
    ,t23_s_minbal.ctr_bal_2023 AS 2023年同一风险控制号最低余额月末最后一天_含核销
    ,t23_s_minbal.dt               AS 2023年同一风险控制号最低余额所在月份_含核销
    ,t21_s_minamt.ctr_amt_2021 AS 2021年同一风险控制号最低授信金额月末最后一天
    ,t21_s_minamt.dt               AS 2021年同一风险控制号最低授信金额所在月份
    ,t22_s_minamt.ctr_amt_2022 AS 2022年同一风险控制号最低授信金额月末最后一天
    ,t22_s_minamt.dt               AS 2022年同一风险控制号最低授信金额所在月份
    ,t23_s_minamt.ctr_amt_2023 AS 2023年同一风险控制号最低授信金额月末最后一天
    ,t23_s_minamt.dt               AS 2023年同一风险控制号最低授信金额所在月份
    ,t21_c_minbal.ctr_bal_2021 AS 2021年单户最低余额月末最后一天_含核销
    ,t21_c_minbal.dt               AS 2021年单户最低余额所在月份_含核销
    ,t22_c_minbal.ctr_bal_2022 AS 2022年单户最低余额月末最后一天_含核销
    ,t22_c_minbal.dt               AS 2022年单户最低余额所在月份_含核销
    ,t23_c_minbal.ctr_bal_2023 AS 2023年单户最低余额月末最后一天_含核销
    ,t23_c_minbal.dt               AS 2023年单户最低余额所在月份_含核销
    ,t21_c_minamt.ctr_amt_2021 AS 2021年单户最低授信金额月末最后一天
    ,t21_c_minamt.dt               AS 2021年单户最低授信金额所在月份
    ,t22_c_minamt.ctr_amt_2022 AS 2022年单户最低授信金额月末最后一天
    ,t22_c_minamt.dt               AS 2022年单户最低授信金额所在月份
    ,t23_c_minamt.ctr_amt_2023 AS 2023年单户最低授信金额月末最后一天
    ,t23_c_minamt.dt               AS 2023年单户最低授信金额所在月份
    ,case when t21_s_maxamt.ctr_amt_2021 < 300000 then '1 <=30万'
        when t21_s_maxamt.ctr_amt_2021>=300000  and t21_s_maxamt.ctr_amt_2021 < 500000  then '2 30-50万'
        when t21_s_maxamt.ctr_amt_2021>=500000  and t21_s_maxamt.ctr_amt_2021 < 1000000 then '3 50-100万'
        when t21_s_maxamt.ctr_amt_2021>=1000000 and t21_s_maxamt.ctr_amt_2021 < 1500000 then '4 100-150万'
        when t21_s_maxamt.ctr_amt_2021>=1500000 and t21_s_maxamt.ctr_amt_2021 < 3000000 then '5 150-300万'
        when t21_s_maxamt.ctr_amt_2021>=3000000 then '6 300万元及以上' else '其他' end as 2021年额度分布_同一风险控制号维度
    ,case when t21_c_maxamt.ctr_amt_2021 < 300000 then '1 <=30万'
        when t21_c_maxamt.ctr_amt_2021>=300000  and t21_c_maxamt.ctr_amt_2021 < 500000  then '2 30-50万'
        when t21_c_maxamt.ctr_amt_2021>=500000  and t21_c_maxamt.ctr_amt_2021 < 1000000 then '3 50-100万'
        when t21_c_maxamt.ctr_amt_2021>=1000000 and t21_c_maxamt.ctr_amt_2021 < 1500000 then '4 100-150万'
        when t21_c_maxamt.ctr_amt_2021>=1500000 and t21_c_maxamt.ctr_amt_2021 < 3000000 then '5 150-300万'
        when t21_c_maxamt.ctr_amt_2021>=3000000 then '6 300万元及以上' else '其他' end as 2021年额度分布_单个客户维度
    ,case when t22_s_maxamt.ctr_amt_2022 < 300000 then '1 <=30万'
        when t22_s_maxamt.ctr_amt_2022>=300000  and t22_s_maxamt.ctr_amt_2022 < 500000  then '2 30-50万'
        when t22_s_maxamt.ctr_amt_2022>=500000  and t22_s_maxamt.ctr_amt_2022 < 1000000 then '3 50-100万'
        when t22_s_maxamt.ctr_amt_2022>=1000000 and t22_s_maxamt.ctr_amt_2022 < 1500000 then '4 100-150万'
        when t22_s_maxamt.ctr_amt_2022>=1500000 and t22_s_maxamt.ctr_amt_2022 < 3000000 then '5 150-300万'
        when t22_s_maxamt.ctr_amt_2022>=3000000 then '6 300万元及以上' else '其他' end as 2022年额度分布_同一风险控制号维度
    ,case when t22_c_maxamt.ctr_amt_2022 < 300000 then '1 <=30万'
        when t22_c_maxamt.ctr_amt_2022>=300000  and t22_c_maxamt.ctr_amt_2022 < 500000  then '2 30-50万'
        when t22_c_maxamt.ctr_amt_2022>=500000  and t22_c_maxamt.ctr_amt_2022 < 1000000 then '3 50-100万'
        when t22_c_maxamt.ctr_amt_2022>=1000000 and t22_c_maxamt.ctr_amt_2022 < 1500000 then '4 100-150万'
        when t22_c_maxamt.ctr_amt_2022>=1500000 and t22_c_maxamt.ctr_amt_2022 < 3000000 then '5 150-300万'
        when t22_c_maxamt.ctr_amt_2022>=3000000 then '6 300万元及以上' else '其他' end as 2022年额度分布_单个客户维度
    ,case when t23_s_maxamt.ctr_amt_2023 < 300000 then '1 <=30万'
        when t23_s_maxamt.ctr_amt_2023>=300000  and t23_s_maxamt.ctr_amt_2023 < 500000  then '2 30-50万'
        when t23_s_maxamt.ctr_amt_2023>=500000  and t23_s_maxamt.ctr_amt_2023 < 1000000 then '3 50-100万'
        when t23_s_maxamt.ctr_amt_2023>=1000000 and t23_s_maxamt.ctr_amt_2023 < 1500000 then '4 100-150万'
        when t23_s_maxamt.ctr_amt_2023>=1500000 and t23_s_maxamt.ctr_amt_2023 < 3000000 then '5 150-300万'
        when t23_s_maxamt.ctr_amt_2023>=3000000 then '6 300万元及以上' else '其他' end as 2023年额度分布_同一风险控制号维度
    ,case when t23_c_maxamt.ctr_amt_2023 < 300000 then '1 <=30万'
        when t23_c_maxamt.ctr_amt_2023>=300000  and t23_c_maxamt.ctr_amt_2023 < 500000  then '2 30-50万'
        when t23_c_maxamt.ctr_amt_2023>=500000  and t23_c_maxamt.ctr_amt_2023 < 1000000 then '3 50-100万'
        when t23_c_maxamt.ctr_amt_2023>=1000000 and t23_c_maxamt.ctr_amt_2023 < 1500000 then '4 100-150万'
        when t23_c_maxamt.ctr_amt_2023>=1500000 and t23_c_maxamt.ctr_amt_2023 < 3000000 then '5 150-300万'
        when t23_c_maxamt.ctr_amt_2023>=3000000 then '6 300万元及以上' else '其他' end as 2023年额度分布_单个客户维度
    ,case when t2.ctr_amt_1031 < 300000 then '1 <=30万'
        when t2.ctr_amt_1031>=300000  and t2.ctr_amt_1031 < 500000  then '2 30-50万'
        when t2.ctr_amt_1031>=500000  and t2.ctr_amt_1031 < 1000000 then '3 50-100万'
        when t2.ctr_amt_1031>=1000000 and t2.ctr_amt_1031 < 1500000 then '4 100-150万'
        when t2.ctr_amt_1031>=1500000 and t2.ctr_amt_1031 < 3000000 then '5 150-300万'
        when t2.ctr_amt_1031>=3000000 then '6 300万元及以上' else '其他' end as 最新额度分布_同一风险控制号维度_1031
    ,case when t1.ctr_amt < 300000 then '1 <=30万'
        when t1.ctr_amt>=300000  and t1.ctr_amt < 500000  then '2 30-50万'
        when t1.ctr_amt>=500000  and t1.ctr_amt < 1000000 then '3 50-100万'
        when t1.ctr_amt>=1000000 and t1.ctr_amt < 1500000 then '4 100-150万'
        when t1.ctr_amt>=1500000 and t1.ctr_amt < 3000000 then '5 150-300万'
        when t1.ctr_amt>=3000000 then '6 300万元及以上' else '其他' end as 最新额度分布_单个客户维度_1031
    ,t2.ctr_epsr_amt     AS 最新同一风险控制号敞口金额_1031
    ,t2.ctr_epsr_bal     AS 最新同一风险控制号敞口余额_1031
    ,t1.ctr_bal           AS 当前客户余额_1031
    ,case when t3.cst_id is not null then '是' else '' end as 是否风险客户_1031
    ,t1.最早准入年份
from(
    SElECT sam_rsk_ctrl_id,cst_id,cst_nm
        ,sum(ctr_amt)                            as ctr_amt
        ,sum(ctr_bal)                            as ctr_bal
        ,min(准入年份)  as 最早准入年份
    from SJXQ_SJ2024112521_CST2_02
    group by sam_rsk_ctrl_id,cst_id,cst_nm
)t1 left join (
    select sam_rsk_ctrl_id
        ,sum(ctr_amt)      as ctr_amt_1031
        ,sum(ctr_epsr_amt) as ctr_epsr_amt 	 --合同敞口金额
        ,sum(ctr_epsr_bal) as ctr_epsr_bal   --合同敞口余额
    from SJXQ_SJ2024112521_CST2_02
    group by sam_rsk_ctrl_id
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
left join SJXQ_SJ2024112521_CST2_03  t3
on t1.cst_id=t3.cst_id
-- 最高
LEFT JOIN SJXQ_SJ2024112521_CST2_04 t21_s_maxbal
ON t1.sam_rsk_ctrl_id = t21_s_maxbal.sam_rsk_ctrl_id AND t21_s_maxbal.rn_bal = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_04 t21_s_maxamt
ON t1.sam_rsk_ctrl_id = t21_s_maxamt.sam_rsk_ctrl_id AND t21_s_maxamt.rn_amt = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_05 t22_s_maxbal
ON t1.sam_rsk_ctrl_id = t22_s_maxbal.sam_rsk_ctrl_id AND t22_s_maxbal.rn_bal = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_05 t22_s_maxamt
ON t1.sam_rsk_ctrl_id = t22_s_maxamt.sam_rsk_ctrl_id AND t22_s_maxamt.rn_amt = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_06 t23_s_maxbal
ON t1.sam_rsk_ctrl_id = t23_s_maxbal.sam_rsk_ctrl_id AND t23_s_maxbal.rn_bal = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_06 t23_s_maxamt
ON t1.sam_rsk_ctrl_id = t23_s_maxamt.sam_rsk_ctrl_id AND t23_s_maxamt.rn_amt = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_07 t21_c_maxbal
ON t1.cst_id = t21_c_maxbal.cst_id AND t21_c_maxbal.rn_bal = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_07 t21_c_maxamt
ON t1.cst_id = t21_c_maxamt.cst_id AND t21_c_maxamt.rn_amt = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_08 t22_c_maxbal
ON t1.cst_id = t22_c_maxbal.cst_id AND t22_c_maxbal.rn_bal = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_08 t22_c_maxamt
ON t1.cst_id = t22_c_maxamt.cst_id AND t22_c_maxamt.rn_amt = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_09 t23_c_maxbal
ON t1.cst_id = t23_c_maxbal.cst_id AND t23_c_maxbal.rn_bal = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_09 t23_c_maxamt
ON t1.cst_id = t23_c_maxamt.cst_id AND t23_c_maxamt.rn_amt = 1
-- 最低
LEFT JOIN SJXQ_SJ2024112521_CST2_04 t21_s_minbal
ON t1.sam_rsk_ctrl_id = t21_s_minbal.sam_rsk_ctrl_id AND t21_s_minbal.rn_bal_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_04 t21_s_minamt
ON t1.sam_rsk_ctrl_id = t21_s_minamt.sam_rsk_ctrl_id AND t21_s_minamt.rn_amt_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_05 t22_s_minbal
ON t1.sam_rsk_ctrl_id = t22_s_minbal.sam_rsk_ctrl_id AND t22_s_minbal.rn_bal_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_05 t22_s_minamt
ON t1.sam_rsk_ctrl_id = t22_s_minamt.sam_rsk_ctrl_id AND t22_s_minamt.rn_amt_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_06 t23_s_minbal
ON t1.sam_rsk_ctrl_id = t23_s_minbal.sam_rsk_ctrl_id AND t23_s_minbal.rn_bal_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_06 t23_s_minamt
ON t1.sam_rsk_ctrl_id = t23_s_minamt.sam_rsk_ctrl_id AND t23_s_minamt.rn_amt_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_07 t21_c_minbal
ON t1.cst_id = t21_c_minbal.cst_id AND t21_c_minbal.rn_bal_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_07 t21_c_minamt
ON t1.cst_id = t21_c_minamt.cst_id AND t21_c_minamt.rn_amt_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_08 t22_c_minbal
ON t1.cst_id = t22_c_minbal.cst_id AND t22_c_minbal.rn_bal_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_08 t22_c_minamt
ON t1.cst_id = t22_c_minamt.cst_id AND t22_c_minamt.rn_amt_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_09 t23_c_minbal
ON t1.cst_id = t23_c_minbal.cst_id AND t23_c_minbal.rn_bal_asc = 1
LEFT JOIN SJXQ_SJ2024112521_CST2_09 t23_c_minamt
ON t1.cst_id = t23_c_minamt.cst_id AND t23_c_minamt.rn_amt_asc = 1
;
SElECT *
from lab_bigdata_dev.SJXQ_SJ2024112521_CST2_10
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024112521_CST2_05
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024112521_CST2_06
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_08
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_09
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112521_CST2_10
;
/*
01	56680782	1782036
02	81306	25304
03	95327	95327
04	241402	20736
05	258083	22832
06	253642	21832
07	272263	24124
08	25304	25304
*/***邓凤平_SJ2024112521_内部降额业务分析_old.sql
﻿/*
截止10月末数据，大冶村行
bsn_sts	string	业务状态 202406核销 正常 证券化
adm_rsk.adm_rsk_apl_inter_all	风险集市应用表-资产质量日常监测源表	19
*/
-- 2022,2023年合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_01 AS
select t1.*
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from(
    select t1.dt,t1.cst_id                           --客户号|C20
        ,sum(t1.ctr_amt) as ctr_amt             --合同金额DECIMAL(21,2)
        ,sum(t1.ctr_bal) as ctr_bal             --合同余额DECIMAL(21,2)
    from edw.dim_bus_loan_ctr_inf_dd        t1      --信贷合同信息
    where t1.dt between '20220131' and '20231231'
    and substr(to_char(dateadd(to_date(t1.dt, 'yyyyMMdd'),1,'dd'),'yyyyMMdd'),7,2)='01'   --月末
    group by t1.dt,t1.cst_id
)t1 left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20241031'
;
--当前合同 20241031
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_02 AS
select t1.busi_ctr_id                           --合同流水号
	,t1.cst_id                                  --客户号
	,t1.cst_nm                                  --客户名称
    ,substr(t1.apnt_start_dt,1,4)  as 准入年份
	,t1.ctr_amt                                 --合同金额
	,t1.ctr_bal                                 --合同余额
    ,t1.tot_xpos_amt as ctr_epsr_amt 	        --合同敞口金额
    ,0 as ctr_epsr_bal                          --合同敞口余额
    ,t2.mgr_id	    --	管户人工号|c10
    ,t2.mgr_nm	    --	管户人姓名|c10
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm
    ,case when nvl(t6.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t6.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_inf_dd            t1      --信贷合同信息
inner join edw.dwd_bus_loan_ctr_mgr_inf_dd 	t2 	--信贷合同`管户`信息
on t1.busi_ctr_id=t2.ctr_serno
and t2.dt='20240719'
inner join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t2.mgr_org_id = t4.org_id
and t4.dt = '20241031'
and t4.brc_org_nm regexp '湖北大冶泰隆村镇'
left join edw.DWS_CST_BAS_INF_DD            t6
on t1.cst_id=t6.cst_id
and t6.dt='20241031'
where t1.dt='20240719'
;
-- 是否风险客户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_03 AS
SElECT distinct cst_id
from adm_rsk.adm_rsk_apl_inter_all	--风险集市应用表-资产质量日常监测源表	19
where dt<='20241031'
and is_rsk_loan='Y'	--	是否风险贷款
;
-- 2022年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_04 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as max_ctr_amt_2022
    ,sum(ctr_bal) as max_ctr_bal_2022
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST2_01 t1
inner join(
    select distinct sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2022'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2023年同一风险控制号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_05 AS
select dt,t1.sam_rsk_ctrl_id
    ,sum(ctr_amt) as max_ctr_amt_2023
    ,sum(ctr_bal) as max_ctr_bal_2023
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_bal) desc,dt desc) rn_bal
    ,row_number() over(partition by t1.sam_rsk_ctrl_id order by sum(ctr_amt) desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST2_01 t1
inner join(
    select distinct sam_rsk_ctrl_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
where substr(dt,1,4)='2023'
group by dt,t1.sam_rsk_ctrl_id
;
-- 2022年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_06 AS
select dt,t1.cst_id
    ,ctr_amt as max_ctr_amt_2022
    ,ctr_bal as max_ctr_bal_2022
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST2_01 t1
inner join(
    select distinct cst_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2022'
;
-- 2023年单户
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_07 AS
select dt,t1.cst_id
    ,ctr_amt as max_ctr_amt_2023
    ,ctr_bal as max_ctr_bal_2023
    ,row_number() over(partition by t1.cst_id order by ctr_bal desc,dt desc) rn_bal
    ,row_number() over(partition by t1.cst_id order by ctr_amt desc,dt desc) rn_amt
from SJXQ_SJ2024112521_CST2_01 t1
inner join(
    select distinct cst_id
    from SJXQ_SJ2024112521_CST2_02
)t2 on t1.cst_id=t2.cst_id
where substr(dt,1,4)='2023'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112521_CST2_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112521_CST2_08 AS
SELECT  t1.sbr_org_nm    AS 支行_1031
    ,t1.tem_org_nm       AS 团队_1031
    ,t1.mgr_id           AS 管户人名称_1031
    ,t1.mgr_nm           AS 管户人工号_1031
    -- ,t1.hdl_opr_id       AS 经办人工号_1031
    -- ,t1.hdl_opr_nm       AS 经办人名称_1031
    ,t1.cst_id           AS 客户号
    ,t1.cst_nm           AS 客户名称
    ,t2.max_ctr_bal_2022 AS 2022年同一风险控制号最高余额月末最后一天_含核销
    ,t2.dt               AS 2022年同一风险控制号最高余额所在月份_含核销
    ,t3.max_ctr_bal_2023 AS 2023年同一风险控制号最高余额月末最后一天_含核销
    ,t3.dt               AS 2023年同一风险控制号最高余额所在月份_含核销
    ,t4.max_ctr_amt_2022 AS 2022年同一风险控制号最高授信金额月末最后一天
    ,t4.dt               AS 2022年同一风险控制号最高授信金额所在月份
    ,t5.max_ctr_amt_2023 AS 2023年同一风险控制号最高授信金额月末最后一天
    ,t5.dt               AS 2023年同一风险控制号最高授信金额所在月份
    ,t6.max_ctr_bal_2022 AS 2022年单户最高余额月末最后一天_含核销
    ,t6.dt               AS 2022年单户最高余额所在月份_含核销
    ,t7.max_ctr_bal_2023 AS 2023年单户最高余额月末最后一天_含核销
    ,t7.dt               AS 2023年单户最高余额所在月份_含核销
    ,t8.max_ctr_amt_2022 AS 2022年单户最高授信金额月末最后一天
    ,t8.dt               AS 2022年单户最高授信金额所在月份
    ,t9.max_ctr_amt_2023 AS 2023年单户最高授信金额月末最后一天
    ,t9.dt               AS 2023年单户最高授信金额所在月份
    ,case when nvl(t4.max_ctr_amt_2022,0)>nvl(t5.max_ctr_amt_2023,0) then '-1'
        when nvl(t4.max_ctr_amt_2022,0)=nvl(t5.max_ctr_amt_2023,0)  then '0'
        when nvl(t4.max_ctr_amt_2022,0)<nvl(t5.max_ctr_amt_2023,0)  then '1' else '' end is_lift_sam
    ,case when nvl(t8.max_ctr_amt_2022,0)>nvl(t9.max_ctr_amt_2023,0) then '-1'
        when nvl(t8.max_ctr_amt_2022,0)=nvl(t9.max_ctr_amt_2023,0)  then '0'
        when nvl(t8.max_ctr_amt_2022,0)<nvl(t9.max_ctr_amt_2023,0)  then '1' else '' end is_lift_cst
    ,case when t4.max_ctr_amt_2022 < 300000 then '1 <=30万'
        when t4.max_ctr_amt_2022>=300000  and t4.max_ctr_amt_2022 < 500000  then '2 30-50万'
        when t4.max_ctr_amt_2022>=500000  and t4.max_ctr_amt_2022 < 1000000 then '3 50-100万'
        when t4.max_ctr_amt_2022>=1000000 and t4.max_ctr_amt_2022 < 1500000 then '4 100-150万'
        when t4.max_ctr_amt_2022>=1500000 and t4.max_ctr_amt_2022 < 3000000 then '5 150-300万'
        when t4.max_ctr_amt_2022>=3000000 then '6 300万元及以上' else '其他' end as 2022年额度分布_同一风险控制号维度
    ,case when t8.max_ctr_amt_2022 < 300000 then '1 <=30万'
        when t8.max_ctr_amt_2022>=300000  and t8.max_ctr_amt_2022 < 500000  then '2 30-50万'
        when t8.max_ctr_amt_2022>=500000  and t8.max_ctr_amt_2022 < 1000000 then '3 50-100万'
        when t8.max_ctr_amt_2022>=1000000 and t8.max_ctr_amt_2022 < 1500000 then '4 100-150万'
        when t8.max_ctr_amt_2022>=1500000 and t8.max_ctr_amt_2022 < 3000000 then '5 150-300万'
        when t8.max_ctr_amt_2022>=3000000 then '6 300万元及以上' else '其他' end as 2022年额度分布_单个客户维度
    ,case when t5.max_ctr_amt_2023 < 300000 then '1 <=30万'
        when t5.max_ctr_amt_2023>=300000  and t5.max_ctr_amt_2023 < 500000  then '2 30-50万'
        when t5.max_ctr_amt_2023>=500000  and t5.max_ctr_amt_2023 < 1000000 then '3 50-100万'
        when t5.max_ctr_amt_2023>=1000000 and t5.max_ctr_amt_2023 < 1500000 then '4 100-150万'
        when t5.max_ctr_amt_2023>=1500000 and t5.max_ctr_amt_2023 < 3000000 then '5 150-300万'
        when t5.max_ctr_amt_2023>=3000000 then '6 300万元及以上' else '其他' end as 2023年额度分布_同一风险控制号维度
    ,case when t9.max_ctr_amt_2023 < 300000 then '1 <=30万'
        when t9.max_ctr_amt_2023>=300000  and t9.max_ctr_amt_2023 < 500000  then '2 30-50万'
        when t9.max_ctr_amt_2023>=500000  and t9.max_ctr_amt_2023 < 1000000 then '3 50-100万'
        when t9.max_ctr_amt_2023>=1000000 and t9.max_ctr_amt_2023 < 1500000 then '4 100-150万'
        when t9.max_ctr_amt_2023>=1500000 and t9.max_ctr_amt_2023 < 3000000 then '5 150-300万'
        when t9.max_ctr_amt_2023>=3000000 then '6 300万元及以上' else '其他' end as 2023年额度分布_单个客户维度
    ,case when t10.ctr_amt_1031 < 300000 then '1 <=30万'
        when t10.ctr_amt_1031>=300000  and t10.ctr_amt_1031 < 500000  then '2 30-50万'
        when t10.ctr_amt_1031>=500000  and t10.ctr_amt_1031 < 1000000 then '3 50-100万'
        when t10.ctr_amt_1031>=1000000 and t10.ctr_amt_1031 < 1500000 then '4 100-150万'
        when t10.ctr_amt_1031>=1500000 and t10.ctr_amt_1031 < 3000000 then '5 150-300万'
        when t10.ctr_amt_1031>=3000000 then '6 300万元及以上' else '其他' end as 最新额度分布_同一风险控制号维度_1031
    ,case when t1.ctr_amt < 300000 then '1 <=30万'
        when t1.ctr_amt>=300000  and t1.ctr_amt < 500000  then '2 30-50万'
        when t1.ctr_amt>=500000  and t1.ctr_amt < 1000000 then '3 50-100万'
        when t1.ctr_amt>=1000000 and t1.ctr_amt < 1500000 then '4 100-150万'
        when t1.ctr_amt>=1500000 and t1.ctr_amt < 3000000 then '5 150-300万'
        when t1.ctr_amt>=3000000 then '6 300万元及以上' else '其他' end as 最新额度分布_单个客户维度_1031
    ,t10.ctr_epsr_amt     AS 最新同一风险控制号敞口金额_1031
    ,t10.ctr_epsr_bal     AS 最新同一风险控制号敞口余额_1031
    ,t1.ctr_bal           AS 当前客户余额_1031
    ,case when t11.cst_id is not null then '是' else '' end as 是否风险客户_1031
    ,t1.最早准入年份
from(
    SElECT sam_rsk_ctrl_id,cst_id,cst_nm
        ,sum(ctr_amt)                            as ctr_amt
        ,sum(ctr_bal)                            as ctr_bal
        ,min(准入年份)  as 最早准入年份
    from SJXQ_SJ2024112521_CST2_02
    group by sam_rsk_ctrl_id,cst_id,cst_nm
)t1 left join SJXQ_SJ2024112521_CST2_04  t2 --2022
on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id and t2.rn_bal=1
left join SJXQ_SJ2024112521_CST2_05      t3 --2023
on t1.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id and t3.rn_bal=1
left join SJXQ_SJ2024112521_CST2_04      t4 --2022
on t1.sam_rsk_ctrl_id=t4.sam_rsk_ctrl_id and t4.rn_amt=1
left join SJXQ_SJ2024112521_CST2_05      t5 --2023
on t1.sam_rsk_ctrl_id=t5.sam_rsk_ctrl_id and t5.rn_amt=1
left join SJXQ_SJ2024112521_CST2_06      t6 --2022
on t1.cst_id=t6.cst_id and t6.rn_bal=1
left join SJXQ_SJ2024112521_CST2_07      t7 --2023
on t1.cst_id=t7.cst_id and t7.rn_bal=1
left join SJXQ_SJ2024112521_CST2_06      t8 --2022
on t1.cst_id=t8.cst_id and t8.rn_amt=1
left join SJXQ_SJ2024112521_CST2_07      t9 --2023
on t1.cst_id=t9.cst_id and t9.rn_amt=1
left join (
    select sam_rsk_ctrl_id
        ,sum(ctr_amt)      as ctr_amt_1031
        ,sum(ctr_epsr_amt) as ctr_epsr_amt 	 --合同敞口金额
        ,sum(ctr_epsr_bal) as ctr_epsr_bal   --合同敞口余额
    from SJXQ_SJ2024112521_CST2_02
    group by sam_rsk_ctrl_id
)t10 on t1.sam_rsk_ctrl_id=t10.sam_rsk_ctrl_id
left join SJXQ_SJ2024112521_CST2_03  t11
on t1.cst_id=t11.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024112521_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct sam_rsk_ctrl_id) custs
from SJXQ_SJ2024112521_CST2_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ2024112521_CST2_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ2024112521_CST2_08
;
SElECT *
from lab_bigdata_dev.SJXQ_SJ2024112521_CST2_08
;
SElECT is_lift_sam,count(1) cnt
from lab_bigdata_dev.SJXQ_SJ2024112521_CST2_08
GROUP BY is_lift_sam
;
SElECT is_lift_cst,count(1) cnt
from lab_bigdata_dev.SJXQ_SJ2024112521_CST2_08
GROUP BY is_lift_cst
***邓凤平_SJ20241202196_知识产权质押担保分析.sql
﻿/*
主要想查的点就是借款人也就是公司客户的法定代表人以及股东是否有查询征信，是否有签入担保
合同流水号 HTBH2024081900001546 不存在 疑似 BC2024062600000598
*/
-- 导入数据
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_01 AS
SELECT  sn
    ,col_1 as 业务合同流水号
    ,col_2 as 合同流水号和押品编号的情况
    ,col_3 as 合同出现次数
    ,col_4 as 合同起始日期
    ,col_5 as 合同到期日期
    ,col_6 as 合同金额
    ,col_7 as 合同余额
    ,col_8 as 总的合同余额
    ,col_9 as 客户编号
    ,col_10 as 客户姓名
    ,col_11 as 管户人工号_业务
    ,col_12 as 管户机构编号_业务
    ,col_13 as 管户机构名称
    ,col_14 as 管户支行机构编号
    ,col_15 as 管户支行机构名称
    ,col_16 as 五级分类
    ,col_17 as 担保合同编号
    ,col_18 as 担保合同类型
    ,col_19 as 担保方式
    ,col_20 as 担保合同生效日期
    ,col_21 as 担保合同到期日期
    ,col_22 as 担保合同金额
    ,col_23 as 押品编号
    ,col_24 as 押品出现次数
    ,col_25 as 押品名称
    ,col_26 as 押品类型代码
    ,col_27 as 押品类型
    ,col_28 as 押品二级分类
    ,col_29 as 押品三级分类
    ,col_30 as 评估价值
    ,col_31 as 认定价值
    ,col_32 as 押品分配认定价值
    ,col_33 as 调整系数1
    ,col_34 as 合同分配余额
    ,col_35 as 调整系数2
    ,col_36 as 抵押率
from qbi_file_20241204_11_17_21_0
where pt<>''
;
-- 是否为纯抵押
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_02 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.grnt_mod_colc	--担保方式集合 '005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池'
    ,case when t1.grnt_mod_colc = '020' then '是' else '否' end as is_pure_dy
    ,case when t1.grnt_mod_colc = '040' then '是' else '否' end as is_pure_zy
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join(
    select distinct 业务合同流水号 as ctr_serno
    from SJXQ_SJ20241202196_CST_01
)t2 on t1.ctr_serno=t2.ctr_serno
where t1.dt='@@{yyyyMMdd}'
;
-- 保证人
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_03 AS
SElECT t1.ctr_serno
    ,t2.GRNT_CTR_NO
    ,t2.grnt_ctr_typ_cd	    --担保合同类型代码|c3
    -- ,t2.eff_sts_cd	        --生效状态代码|c1
    ,t3.gtor_no                                  --保证人编号|c20
    ,t3.gtor_nm                                  --保证人名称|c200
    ,t3.with_brwr_rel                            --与借款人关系|c3
    ,t3.grnt_amt	        --	担保金额|decimal(21,2)
    ,t3.eff_sts_cd                               --生效状态代码 0:待生效 1:已生效 2:已失效
    ,row_number() over(partition by t1.ctr_serno order by t3.grnt_amt desc) rn
from SJXQ_SJ20241202196_CST_02              t1
INNER JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno = t2.CTR_SERNO
and t2.dt='@@{yyyyMMdd}'
and BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
INNER JOIN edw.dim_bus_loan_grnt_ctr_gtor_inf_dd   t3 --担保合同保证人信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='@@{yyyyMMdd}'
;
-- 权利人
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_04 AS
SElECT t1.ctr_serno
    ,t2.GRNT_CTR_NO
    ,t2.grnt_ctr_typ_cd	    --担保合同类型代码|c3
    ,t2.eff_sts_cd	        --生效状态代码|c1
	,t3.obg_id                                   --权利人编号|c20
	,t3.obg_nm                                   --权利人名称|c200
from SJXQ_SJ20241202196_CST_02              t1
INNER JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno = t2.CTR_SERNO
and t2.dt='@@{yyyyMMdd}'
and BUSI_TYP_CD='1'     --业务类型代码 1贷款业务 2信用卡业务
INNER JOIN edw.dim_bus_loan_grnt_ctr_mort_pldg_dd t3 --担保合同抵质押信息
on  t2.GRNT_CTR_NO=t3.GRNT_CTR_NO
and t3.dt='@@{yyyyMMdd}'
;
--历史查询征信客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_05 AS
select cst_id
    ,min(report_dt)     as min_report_dt
    ,max(report_dt)     as max_report_dt
from(
    select cst_id,report_dt	--报告日期
    from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
    where dt='@@{yyyyMMdd}'
    union all
    select cst_id,report_dt	--报告日期
    from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
    where dt='@@{yyyyMMdd}'
)t group by cst_id
;
-- 股东
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_06 AS
select t1.*
    ,t2.cst_chn_nm	--客户姓名
    ,case when t3.cst_id is not null then '是' else '否' end as is_chk_zx
    ,row_number() over(partition by t1.cst_id order by t1.rel_cst_id asc) rn
from(
    SElECT cst_id,rel_cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ like '02%' --股东
    union
    SElECT rel_cst_id,cst_id
    from edw.loan_cst_rel         --客户关联关系信息
    where DT = '@@{yyyyMMdd}'
    and rel_typ like '02%' --股东
)t1 left join edw.dws_cst_bas_inf_dd 	t2 --客户基础信息汇总表
on t1.rel_cst_id=t2.cst_id
and t2.dt='@@{yyyyMMdd}'
left join SJXQ_SJ20241202196_CST_05     t3
on t1.rel_cst_id=t3.cst_id
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241202196_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241202196_CST_07 AS
SELECT  t1.sn
    ,t1.业务合同流水号
    ,t1.合同流水号和押品编号的情况
    ,t1.合同出现次数
    ,t1.合同起始日期
    ,t1.合同到期日期
    ,t1.合同金额
    ,t1.合同余额
    ,t1.总的合同余额
    ,t1.客户编号
    ,t1.客户姓名
    ,t1.管户人工号_业务
    ,t1.管户机构编号_业务
    ,t1.管户机构名称
    ,t1.管户支行机构编号
    ,t1.管户支行机构名称
    ,t1.五级分类
    ,t1.担保合同编号
    ,t1.担保合同类型
    ,t1.担保方式
    ,t1.担保合同生效日期
    ,t1.担保合同到期日期
    ,t1.担保合同金额
    ,t1.押品编号
    ,t1.押品出现次数
    ,t1.押品名称
    ,t1.押品类型代码
    ,t1.押品类型
    ,t1.押品二级分类
    ,t1.押品三级分类
    ,t1.评估价值
    ,t1.认定价值
    ,t1.押品分配认定价值
    ,t1.调整系数1
    ,t1.合同分配余额
    ,t1.调整系数2
    ,t1.抵押率
    ,t2.is_pure_dy      as 是否为纯抵押
    ,t2.is_pure_zy      as 是否为纯质押
    ,t3.gtor_nm         as 保证人1
    ,t4.gtor_nm         as 保证人2
    ,t5.gtor_nm         as 保证人3
    ,t6.gtor_nm         as 保证人4
    ,t7.lgp_nm          as 公司法定代表人
    ,case when c1.cst_id is not null then '是' else '否' end as 公司法定代表人是否查征信
    ,t8.cst_chn_nm      as 公司股东1
    ,t8.is_chk_zx       as 公司股东1是否查征信
    ,t9.cst_chn_nm      as 公司股东2
    ,t9.is_chk_zx       as 公司股东2是否查征信
    ,t10.cst_chn_nm     as 公司股东3
    ,t10.is_chk_zx      as 公司股东3是否查征信
    ,t11.gd_num         as 公司股东数
from SJXQ_SJ20241202196_CST_01      t1
left join SJXQ_SJ20241202196_CST_02 t2
on t1.业务合同流水号=t2.ctr_serno
left join SJXQ_SJ20241202196_CST_03 t3
on t2.ctr_serno=t3.ctr_serno
and t3.rn=1
left join SJXQ_SJ20241202196_CST_03 t4
on t2.ctr_serno=t4.ctr_serno
and t4.rn=2
left join SJXQ_SJ20241202196_CST_03 t5
on t2.ctr_serno=t5.ctr_serno
and t5.rn=3
left join SJXQ_SJ20241202196_CST_03 t6
on t2.ctr_serno=t6.ctr_serno
and t6.rn=4
left join edw.dim_cst_entp_lgp_inf_dd   t7  --对公客户法人信息表 （主键为cst_id 对公客户）
on t2.cst_ID=t7.cst_ID
and t7.dt = '@@{yyyyMMdd}'
left join SJXQ_SJ20241202196_CST_05     c1
on t7.lgp_cst_id=c1.cst_id
left join SJXQ_SJ20241202196_CST_06 t8
on t2.cst_id=t8.cst_id
and t8.rn=1
left join SJXQ_SJ20241202196_CST_06 t9
on t2.cst_id=t9.cst_id
and t9.rn=2
left join SJXQ_SJ20241202196_CST_06 t10
on t2.cst_id=t10.cst_id
and t10.rn=3
left join (
    SELECT cst_id,count(DISTINCT rel_cst_id) gd_num
    from SJXQ_SJ20241202196_CST_06
    GROUP BY cst_id
)t11 on t2.cst_id=t11.cst_id
;
SElECT '01' seq, count(1) cnt,count(distinct 业务合同流水号) custs
from SJXQ_SJ20241202196_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241202196_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241202196_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ20241202196_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241202196_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241202196_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct 业务合同流水号) custs
from SJXQ_SJ20241202196_CST_07
;
SElECT '07' seq, *
from SJXQ_SJ20241202196_CST_07
***金蕴_SJ2024112551_台州分行客户经理泰e贷资质.sql
-- 截至11月25日，分行泰e贷资质持有情况，即禁用作业模式未勾选&ldquo;预授信（单笔）&ldquo;和&rdquo;预授信（批量）&ldquo;的客户经理和禁用作业模式未勾选&ldquo;面对面扫码单户&ldquo;和&rdquo;面对面扫码团办&ldquo;的客户经理
-- 数据需求字段
-- 支行名称，团队名称，岗位，员工名称、工号
DROP   TABLE IF     EXISTS SJXQ_SJ2024112551_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112551_CST_01 AS
select t1.user_code                                --信贷员工号
	,t1.org_id                                   --信贷所属机构编号
	,t1.qualf_typ                                --资质类型
	,t1.qualf_sub_clss                           --资质子类
    ,decode(t1.qualf_sub_clss,'0060','信贷业务调查资质'
        ,'0060006','六级调查资质'
        ,'0040','接力贷资质'
        ,'0060002','二级调查资质'
        ,'0060005','五级调查资质'
        ,'0040001','禁办接力贷'
        ,'0020001','单人调查资质（随贷通卡）'
        ,'0010001','单人作业（普惠业务）'
        ,'0060004','四级调查资质'
        ,'0040003','突破接力贷政策'
        ,'0050','信用类贷款资质'
        ,'0030001','单人调查资质（贷记卡）'
        ,'0040002','接力贷权限上收'
        ,'0060000','无调查资质（年审取消）'
        ,'0050003','突破信用类贷款政策'
        ,'0030','单人调查资质（贷记卡）'
        ,'0070001','授予泰e贷业务权限'
        ,'0070','线上业务经办资质'
        ,'0060001','一级调查资质'
        ,'0060003','三级调查资质'
        ,'0010','单人作业（普惠业务）'
        ,'0050001','禁办信用类贷款'
        ,'0050002','信用类贷款权限上收','')     as qualf_sub_clss_nm
	,t1.qualf_lvl                                --调查资质等级
	,t1.frbd_mod_no                              --禁用模式编码
    ,case when t1.frbd_mod_no regexp '01|02|04|06' then 1 else 0 end as is_select
    -- ,decode(t1.frbd_mod_no,'01','人工预授信-单户' ,'02','人工预授信-批量' ,'03','普通业务申请' ,'04','面对面单户'
    --     ,'05','自然流量-单户' ,'06','面对面团办' ,'07','自然流量-团办'
    --     ,'08','预先跑批-存量' ,'09','预先跑批-新场景','') as frbd_mod_nm
	,t1.rctly_anl_rvw_dt                         --最近一次年审日期
	,t1.qualf_sts                                --资质状态
    ,t2.empe_nm
    ,t2.pos_enc	--职位编号|C32
    ,t3.POS_NM  --职位名称
    ,t4.sbr_org_nm,t4.tem_org_nm
from edw.loan_tlcb_usr_qualf_info           t1  --用户资质表
left join edw.dws_hr_empe_inf_dd            t2 --员工信息汇总
on  t1.user_code=t2.empe_id
and t2.dt='20241125'
left JOIN edw.DIM_HR_ORG_JOB_INF_DD         t3 -- 职位信息
ON  t3.POS_ID = t2.POS_ENC --职位编号
AND t3.DT = '20241125'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.org_id = t4.org_id
and t4.dt = '20241125'
where t1.dt='20241125'
and t1.del_ind='0'  --未删除
and t4.brc_org_nm='台州分行'
;
--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024112551_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024112551_CST_02 AS
SELECT  sbr_org_nm        AS 支行名称
       ,tem_org_nm        AS 团队名称
       ,user_code         AS 信贷员工号
       ,empe_nm           AS 员工名称
       ,frbd_mod_no       AS 禁用模式编码
       ,qualf_sub_clss_nm AS 资质子类
       ,POS_NM            AS 职位名称
from SJXQ_SJ2024112551_CST_01
where is_select <> 1   --未勾选 预授信单笔,批量;面对面单户,面对面团办
;
/*
禁用模式编码
,'01','人工预授信-单户'
,'02','人工预授信-批量'
,'03','普通业务申请'
,'04','面对面单户'
,'05','自然流量-单户'
,'06','面对面团办'
,'07','自然流量-团办'
,'08','预先跑批-存量'
,'09','预先跑批-新场景'
*/
SElECT '01' seq, count(1) cnt,count(distinct user_code) custs
from SJXQ_SJ2024112551_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 信贷员工号) custs
from SJXQ_SJ2024112551_CST_02
;
SElECT *
from SJXQ_SJ2024112551_CST_02
***陆奇_SJ20241210161_押品存单数据 - 1223.sql
﻿/*
截至取数当天，押品为存单，信贷系统押品入库状态为04已入库、05待临时出库、06临时出库、07待回库、08待释放，但核心系统状态为解止付的
核心开发付新龙反馈两张表kdpb_dngjdj和kdpl_donjmx。要关联kdpa_zhduiz用zhanghao字段
数据需求字段
押品编号、客户号（这两个字段我的附件内已有，如果到开发取数时隔较长，请重新取一下最新存单入库的清单）、存单专项信息的账号、子户号、核心系统状态
好的，再确认下业务需求：最新时间点（比如今天取，就取12.19），
押品类型为存单（cltrl_type_cd LIKE 'A0101%），
权证状态为大入库类（OOIS_STS_CD IN ( '04' , '05' , '06' , '07' , '08' )），
核心系统的止付状态。涉及到字段：
押品编号、认定价值、权属人客户编号、冻结止付编号、核心系统冻结止付编号最新的状态。
另外，帮忙取一下押品关联的担保合同编号、管护机构那是最好的
*/
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST2_01 AS
select col_1 as 押品编号
    ,col_2 as 权属人客户编号
    ,col_3 as 押品类型代码
    ,col_4 as 评估价值
    ,col_5 as 认定价值
    ,col_6 as 权证编号
    ,t1.wrnt_typ_cd
    ,t1.oois_sts_cd
	,t4.cst_id
	,t4.cst_nm
from qbi_file_20241212_09_13_56_0 t1
left join (
	SELECT cltr_no
	from edw.dim_bus_loan_cltr_owr_inf_dd t1 --押品权利人信息
	where dt = '@@{yyyyMMdd}'
	GROUP BY cltr_no
)t4 on t1.col_1=t4.cltr_no
where t1.pt<>''
;
-- edw.dws_bus_grnt_itm_inf_dd T14 --担保物汇总信息 cltr_cst_id  AS 权属人客户号
-- edw.loan_guaranty_info t3     -----担保物信息 ownerid  权属人客户号
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST2_02 AS
SELECT t1.cltr_no
    ,t1.cltr_typ_cd 	    --押品类型代码|c7
    ,t1.cltr_nm	            --押品名称|c200
	,t4.cst_id
	,t4.cst_nm
	,t2.wrnt_no
	,t2.WRNT_TYP_CD
	,t2.OOIS_STS_CD
    ,t2.grnt_ctr_no	    --担保合同编号|C32
	,t2.AFM_VAL   as AFM_VAL2  --认定价值
	,t2.VAL_ASES_SERNO         --价值评估流水号
	,t3.ases_val               --评估价值
	,t3.afm_val                --认定价值
	,decode(t2.OOIS_STS_CD,'04','已入库','05','待临时出库','06','临时出库','07','待回库','08','待释放') as OOIS_STS_nm
from edw.dim_bus_loan_cltr_bas_inf_dd 			t1 --押品基本信息
inner join EDW.DWD_BUS_LOAN_CLTR_WRNT_INF_DD 	t2 --押品权证信息
ON t1.cltr_no = t2.CLTR_NO
AND t2.DT = '@@{yyyyMMdd}'
and t2.OOIS_STS_CD IN ( '04' , '05' , '06' , '07' , '08' )
left join edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd t3 --押品价值评估申请信息表
on t2.val_ases_serno=t3.val_ases_serno
and t3.dt='@@{yyyyMMdd}'
left join (
	SELECT cltr_no
	from edw.dim_bus_loan_cltr_owr_inf_dd t1 --押品权利人信息
	where dt = '@@{yyyyMMdd}'
	GROUP BY cltr_no
)t4 on t1.cltr_no=t4.cltr_no
where t1.dt='@@{yyyyMMdd}'
and t1.cltr_typ_cd LIKE 'A0101%'    --存单
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST2_03 AS
SELECT t1.cltr_no,t2.act_no
	,coalesce(t2.act_no,t4.act_id) as act_id             --账号|c32
	,coalesce(t2.act_nm,t4.act_nm) as act_nm             --账户户名|c200
	,coalesce(t2.sub_act_no,t4.sub_act_no) as sub_act_no --子户号|c32
	,t2.stop_pay_no                              --止付编号|c32
	,T3.jiedonbz                                 --解冻标志_0止付_1解止付
	,T3.djqsriqi	--	冻结起始日期
	,decode(T3.jiedonbz,'0','止付','1','解止付','') as jiedonbz_nm
from(
    select distinct cltr_no
    from SJXQ_SJ20241210161_CST2_02
)t1 INNER JOIN edw.loan_cltr_dep_cert_spcl t2
on t1.cltr_no=t2.cltr_no
and t2.dt='@@{yyyyMMdd}'
left join edw.core_kdpl_donjmx      T3 --账户冻结明细
on t2.stop_pay_no=t3.dongjbho
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_cltr_our_bnk_act_spcl_dd t4 --贷款客户押品-我行账户专项信息
on t1.cltr_no=t4.cltr_no
and t4.dt='@@{yyyyMMdd}'
;
-- 信贷管户
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST2_04 AS
select t1.grnt_ctr_no
    ,t2.ctr_serno
    ,t3.mgr_id                                   --管户人工号|C10
	,t3.mgr_nm                                   --管户人姓名|C200
	,t3.mgr_org_id                               --管户机构号|C12
    ,t4.org_nm
from(
    select distinct grnt_ctr_no
    from SJXQ_SJ20241210161_CST2_02
    where nvl(grnt_ctr_no,'')<>''
)t1 left join edw.dwd_bus_loan_ctr_rel_grnt_dd t2 --主合同、担保合同关系
on t1.grnt_ctr_no=t2.grnt_ctr_no
and t2.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd      t3 --信贷合同管护信息
on t2.ctr_serno=t3.ctr_serno
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST2_05 AS
SELECT  t1.cltr_no      AS 押品编号
        ,t1.cst_id      AS 权利人客户号
        ,t1.cst_nm      AS 权利人客户名称
        ,t1.cltr_typ_cd AS 押品类型代码
        ,t1.ases_val    AS 评估价值
        ,t1.afm_val     AS 认定价值
        ,t1.wrnt_no     AS 权证编号
        ,t1.wrnt_typ_cd AS 权证类型
        ,t1.OOIS_STS_nm AS 出入库状态
        ,t1.grnt_ctr_no AS 担保合同编号
        ,t4.grnt_ctr_sts_cd	as	担保合同状态代码
        ,decode(t4.grnt_ctr_sts_cd,'1','未生效' ,'2','已生效' ,'3','终止' ,'4','冻结' ,'5','作废','') as 担保合同状态
        ,t2.act_nm      AS 账户名称
        ,t2.act_id      AS 客户账号
        ,t2.sub_act_no  AS 子户号
        ,t2.stop_pay_no as 止付编号
        ,t2.djqsriqi    AS 冻结起始日期
        ,t2.jiedonbz_nm AS 解冻标志
        ,t5.qudaohao    as 渠道
        ,t3.mgr_nm      as 信贷管户经理
        ,t3.org_nm      as 信贷管户机构
from SJXQ_SJ20241210161_CST2_02      t1
left join SJXQ_SJ20241210161_CST2_03 t2
on t1.cltr_no=t2.cltr_no
left join(
    select grnt_ctr_no
    from SJXQ_SJ20241210161_CST2_04
    group by grnt_ctr_no
)t3 on t1.grnt_ctr_no=t3.grnt_ctr_no
left join edw.dim_bus_loan_ctr_grnt_inf_dd	t4 --担保合同信息
on t1.grnt_ctr_no=t4.grnt_ctr_no
and t4.dt='@@{yyyyMMdd}'
left join(
    select dongjbho -- 冻结编号
    from edw.core_kdpb_dngjdj --负债账户冻结登记簿
    where dt='@@{yyyyMMdd}'
    and jiedonbz='1'
    group by dongjbho
)t5 on t2.stop_pay_no=t5.dongjbho
;
SElECT '01' seq, count(1) cnt,count(distinct 押品编号,权证编号) custs
from SJXQ_SJ20241210161_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST2_03
union all
SElECT '04' seq, count(1) cnt,count(distinct grnt_ctr_no) custs
from SJXQ_SJ20241210161_CST2_04
union all
SElECT '05' seq, count(1) cnt,count(distinct 押品编号,权证编号) custs
from SJXQ_SJ20241210161_CST2_05
;
SElECT *
from SJXQ_SJ20241210161_CST2_05
;
/*
01	3071	3071
02	3117	2219
03	2167	2167
04	9147	1184
05	3117	3117
*/
***陆奇_SJ20241210161_押品存单数据.sql
﻿/*
截至取数当天，押品为存单，信贷系统押品入库状态为04已入库、05待临时出库、06临时出库、07待回库、08待释放，但核心系统状态为解止付的
核心开发付新龙反馈两张表kdpb_dngjdj和kdpl_donjmx。要关联kdpa_zhduiz用zhanghao字段
数据需求字段
押品编号、客户号（这两个字段我的附件内已有，如果到开发取数时隔较长，请重新取一下最新存单入库的清单）、存单专项信息的账号、子户号、核心系统状态
*/
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_01 AS
select col_1 as 押品编号
    ,col_2 as 权属人客户编号
    ,col_3 as 押品类型代码
    ,col_4 as 评估价值
    ,col_5 as 认定价值
    ,col_6 as 权证编号
    ,t1.wrnt_typ_cd
    ,t1.oois_sts_cd
	,t4.cst_id
	,t4.cst_nm
from qbi_file_20241212_09_13_56_0 t1
left join (
	SELECT cltr_no
	from edw.dim_bus_loan_cltr_owr_inf_dd t1 --押品权利人信息
	where dt = '@@{yyyyMMdd}'
	GROUP BY cltr_no
)t4 on t1.col_1=t4.cltr_no
where t1.pt<>''
;
-- 主表
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_02 AS
SELECT t1.cltr_no
    ,t1.cltr_typ_cd	--	押品类型代码|c7
    ,t1.cltr_nm	    --	押品名称|c200
	,t4.cst_id
	,t4.cst_nm
	,t2.wrnt_no
	,t2.WRNT_TYP_CD
	,t2.OOIS_STS_CD
	,t2.AFM_VAL   as AFM_VAL2  --认定价值
	,t2.VAL_ASES_SERNO         --价值评估流水号
	,t3.ases_val               --评估价值
	,t3.afm_val                --认定价值
	,decode(t2.OOIS_STS_CD,'04','已入库','05','待临时出库','06','临时出库','07','待回库','08','待释放') as OOIS_STS_nm
	,ROW_NUMBER() OVER ( PARTITION BY 1 ORDER BY t1.cltr_no ASC) SN
from edw.dim_bus_loan_cltr_bas_inf_dd 			t1 --押品基本信息
inner join EDW.DWD_BUS_LOAN_CLTR_WRNT_INF_DD 	t2 --押品权证信息
ON t1.cltr_no = t2.CLTR_NO
AND t2.DT = '@@{yyyyMMdd}'
and t2.OOIS_STS_CD IN ( '04' , '05' , '06' , '07' , '08' )
left join edw.dwd_bus_loan_cltr_val_ases_apl_inf_dd t3 --押品价值评估申请信息表
on t2.val_ases_serno=t3.val_ases_serno
and t3.dt='@@{yyyyMMdd}'
left join (
	SELECT cltr_no
	from edw.dim_bus_loan_cltr_owr_inf_dd t1 --押品权利人信息
	where dt = '@@{yyyyMMdd}'
	GROUP BY cltr_no
)t4 on t1.cltr_no=t4.cltr_no
where t1.dt='@@{yyyyMMdd}'
and t1.cltr_typ_cd LIKE 'A01%'
;
-- 账户专项信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_03 AS
select t1.cltr_no
	,t2.act_nm                                   --账户名称|C200
	,t2.act_id                                   --账号|C32
	,t2.sub_act_no                               --子户号|C32
	,t2.dep_clss_cd		--	存款种类代码
	,t2.opn_dt			--	开户日期|C8
	,t2.cls_dt			--	销户日期
	,t2.dep_trm		    --	存期
	,t2.mtu_dt			--	到期日期
from(
    select distinct 押品编号 as cltr_no
    from SJXQ_SJ20241210161_CST_01
)t1 INNER JOIN edw.dim_bus_loan_cltr_our_bnk_act_spcl_dd t2 --贷款客户押品-我行账户专项信息
on t1.cltr_no=t2.cltr_no
and t2.dt='@@{yyyyMMdd}'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_04 AS
select t1.cltr_no
	,t2.vch_no                                   --凭证号|c32
	,t2.our_bnk_dep_cert_ind                     --本行存单标志|c1
	,t2.dep_cert_typ_cd                          --存单类型代码|c4
	,t2.act_nm                                   --账户户名|c200
	,t2.dep_bnk_nm                               --开户行名称|c200
	,t2.act_id                                   --账号|c32
	,t2.sub_act_no                               --子户号|c32
	,t2.opn_amt                                  --开户金额|decimal(21, 2)
	,t2.dep_trm                                  --存期|c6
	,t2.strt_intr_dt                             --起息日|c8
	,t2.mtu_dt                                   --到期日期|c8
	,t2.stop_pay_no                              --止付编号|c32
	,t2.opn_dt                                   --开户日期|c8
	,t2.act_bal                                  --账户余额|decimal(21,2)
from(
    select distinct 押品编号 as cltr_no
    from SJXQ_SJ20241210161_CST_01
)t1 INNER JOIN edw.dim_bus_loan_cltr_dep_cert_spcl_dd t2  --贷款客户押品存单专项信息
on t1.cltr_no=t2.cltr_no
and t2.dt='@@{yyyyMMdd}'
;
-- 账户、子账户汇总
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_05 AS
SELECT cltr_no,act_nm,act_id,sub_act_no
from SJXQ_SJ20241210161_CST_03
union
SELECT cltr_no,act_nm,act_id,sub_act_no
from SJXQ_SJ20241210161_CST_04
;
-- 存款账户冻结登记簿
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_06 AS
select kehuzhao,zhanghao,dongjbho
	,djqsriqi	--	冻结起始日期
	,jiedonbz                                 --解冻标志_0止付_1解止付
	,decode(jiedonbz,'0','止付','1','解止付','') as jiedonbz_nm
	,ROW_NUMBER() over(partition by kehuzhao,zhanghao order by dongjbho desc,xudongxh desc) rn
from edw.core_kdpb_dngjdj T1 --负债账户冻结登记簿 edw.dwd_bus_dep_frz_inf_dd 存款账户冻结登记簿
INNER JOIN (
	SELECT DISTINCT act_id
	FROM SJXQ_SJ20241210161_CST_05
	WHERE NVL(ACT_ID,'')<>''
)T2 ON T1.kehuzhao=T2.act_id
where T1.dt='@@{yyyyMMdd}'
and T1.JILUZTAI = '0' --记录状态
;
--账户冻结明细
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_07 AS
select t2.kehuzhao,t2.zhanghao,t2.dongjbho
	,T1.zhanghao as zhanghao2
	,T1.jiedonbz                                 --解冻标志_0止付_1解止付
	,T1.djqsriqi	--	冻结起始日期
	,decode(T1.jiedonbz,'0','止付','1','解止付','') as jiedonbz_nm
	,ROW_NUMBER() over(partition by T1.zhanghao order by T1.dongjbho desc,T1.shunxhao desc) rn
from edw.core_kdpl_donjmx T1 --账户冻结明细
INNER JOIN (
	SELECT DISTINCT kehuzhao,zhanghao,dongjbho
	FROM SJXQ_SJ20241210161_CST_06
)T2 ON T1.dongjbho=T2.dongjbho
where T1.dt='@@{yyyyMMdd}'
;
-- 全在 客户账号里面
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_07_1 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_07_1 AS
SELECT t1.zhanghao
	,t1.jiedonbz                                 --解冻标志_0止付_1解止付
	,decode(t1.jiedonbz,'0','止付','1','解止付','') as jiedonbz_nm
	,ROW_NUMBER() over(partition by t1.zhanghao order by t1.dongjbho desc,t1.shunxhao desc) rn
from edw.core_kdpl_donjmx t1
INNER JOIN (
	SELECT DISTINCT act_id
	FROM SJXQ_SJ20241210161_CST_05
	WHERE NVL(ACT_ID,'')<>''
)T2 ON T1.zhanghao=T2.act_id
where t1.dt='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241210161_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241210161_CST_08 AS
SELECT  t1.押品编号
    ,t1.权属人客户编号
    ,t1.押品类型代码
    ,t1.评估价值
    ,t1.认定价值
    ,t1.权证编号
    ,t1.wrnt_typ_cd
    ,t1.oois_sts_cd
    ,t3.act_nm      AS 账户名称
    ,t3.act_id      AS 客户账号
    ,t3.sub_act_no  AS 子户号
	,t5.zhanghao 	as 负债账号
	,t5.djqsriqi	as 冻结起始日期
    ,t5.jiedonbz_nm AS 解冻标志
from SJXQ_SJ20241210161_CST_01      t1
left join SJXQ_SJ20241210161_CST_05 t3
on t1.押品编号=t3.cltr_no
left join SJXQ_SJ20241210161_CST_07 t5
on t3.act_id=t5.kehuzhao
and t5.rn=1
;
SElECT '01' seq, count(1) cnt,count(distinct 押品编号,权证编号) custs
from SJXQ_SJ20241210161_CST_01
union all
SElECT '011' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST_01_1
union all
SElECT '02' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cltr_no) custs
from SJXQ_SJ20241210161_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct kehuzhao) custs
from SJXQ_SJ20241210161_CST_06 where rn=1
union all
SElECT '07' seq, count(1) cnt,count(distinct kehuzhao) custs
from SJXQ_SJ20241210161_CST_07 where rn=1
union all
SElECT '071' seq, count(1) cnt,count(distinct zhanghao) custs
from SJXQ_SJ20241210161_CST_07_1 where rn=1
union all
SElECT '08' seq, count(1) cnt,count(distinct 押品编号,权证编号) custs
from SJXQ_SJ20241210161_CST_08
;
SElECT *
from SJXQ_SJ20241210161_CST_08
order by 客户账号
;
/*
01	3071	3071
011	2000	1996
02	3116	2260
03	68	68
04	2171	2171
05	2239	2239
06	2620	1404
07	2620	1404
071	84	84
08	35028	3071
select kehuzhao                                 --客户账号
	,zhanghao                                 --负债账号
	,mingxxuh                                 --负债账号明细序号
	,zhhuztai                                 --账户状态
from edw.core_kdpa_zhduiz                     --客户账号对照表
where dt='@@{yyyyMMdd}'
;
*/
***顾烨鑫_SJ2024111596_质押贷款风险监测.sql
﻿-- 客户：客户号、客户类型、账户类型
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_01 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_01 as
SELECT t1.dep_act_id             --存款账号|C32
    ,t1.cst_act_id                --客户账号|C32
    ,t1.cst_id                    --客户号|C20
    ,t1.act_nm                    --账户名称|C300
    ,t1.int_val_dt                --起息日期|C8
    ,t1.mtu_dt                    --到期日期|C8
    ,t1.act_afl_org               --核算机构编号|C12
    ,t1.opn_org                   --开户机构编号|C12
    ,t1.opn_dt                    --开户日期|C8
    ,t1.gl_bal                    --账户总账余额
    ,t1.prod_id                   --存款产品代码|C24
    ,c1.cd_val_dscr               as prod_nm
    ,t1.cst_tp                    --所属客户类型代码
    ,t1.lbl_prod_typ_cd           --存款产品类型代码|C1
    ,t1.act_sts_cd                --存款账户状态代码|C1
    ,t1.stl_act_ind               --结算账户标志|C1
    ,t1.opn_chnl_cd               --开户渠道|C8
    ,t1.last_180_days_gl_bal_acml --近180天总账余额积数
    ,t1.last_360_days_gl_bal_acml --近360天总账余额积数
    ,t1.cur_act_bal               --当前账户余额
    ,t1.last_day_act_bal          --上日账户余额
    ,t1.act_ctg_cd_1              --账户分类代码1|C32
    ,t1.act_ctg_cd_2              --账户分类代码2|C32
    ,t1.act_ctg_cd_3              --账户分类代码3|C110
    ,t1.ac_vld_prd_dt             --账户有效日期|C8
    ,DECODE(T1.ACT_STS_CD,'A','正常','B','不动户','C','销户','D','久悬户','E','封闭冻结'
        ,'F','金额冻结','G','未启用','H','待启用','I','转营业外收入','Y','预销户')  AS ACT_STS
    ,DECODE(T1.ACT_CTG_CD_2,'301','I类户','302','II类户','303','III类户')         AS ACT_TYP
from edw.dws_bus_dep_act_inf_dd                     T1  --存款账户信息汇总
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD   C1
ON T1.prod_id=C1.CD_VAL
AND C1.DT='20241120'
AND C1.TBL_NM='DIM_BUS_DEP_ACT_INF_DD'
AND C1.FLD_NM='PROD_ID'
where T1.dt = '20241120'
and T1.cst_tp='1'   --对私
and T1.ACT_STS_CD <> 'C' --and STL_ACT_IND = '1' --非销户且为结算账户 cst_act_id 99%近似唯一
;
/*
\N	2952321
III类户	97
II类户	139105
I类户	6127075
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_02 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_02 as
SELECT t1.dep_act_id             --存款账号|C32
    ,t1.cst_act_id                --客户账号|C32
    ,t1.cst_id                    --客户号|C20
    ,t1.ACT_CTG_CD_2
    ,T2.int_act_id_ind                      --行内账号标志 1 --是 0--否 不准
    ,T2.cls_one_act_cst_act_id              --I类账户客户账号
    ,t2.cls_one_act_cst_nm	                --I类账户客户名称|C200
    ,substr(T2.cls_one_act_cst_act_id,1,4)  as I类账户客户账号前4位
    ,substr(T2.cls_one_act_cst_act_id,5,24) as I类账户客户账号前5到24位
    ,t2.cls_one_opn_bnk_cd	    --I类开户行代码|C12
    ,t2.cls_one_opn_bnk_nm	    --I类开户行名称
    ,T2.bind_dt                             --绑定日期
    ,T2.rmit_bind_dt                        --解绑日期
    ,t2.upd_tm
    ,case when T3.cst_act_id is not null then 1 else 0 end as is_ourbnk_act --是否行内客户账号
    ,row_number() over(PARTITION by t1.cst_act_id ORDER by T2.bind_dt desc,t2.upd_tm desc) rn
from SJXQ_SJ2024111596_CST_01                       t1
INNER JOIN edw.dwd_bus_dep_cls_one_act_bind_inf_dd  T2 --一类账户绑定信息
on t1.dep_act_id=t2.lbl_act_id
and t2.dt='20241120'
and T2.eft_ind='1'
and T2.vrf_pass_ind='1'
left JOIN  edw.dim_bus_dep_cst_act_inf_dd           T3
ON  T2.cls_one_act_cst_act_id=T3.cst_act_id
and  T3.dt='20241120'
where T3.cst_act_id is null     --他行
;
-- 贷款申请：cst_id,客户类型，apl_id，渠道，贷款类型
-- DWD_BUS_LOAN_APLY_ACPT_ONL_DD	申请受理线上商机进件	APLY_CHNL_CD	申请渠道代码
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_03 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_03 as
select t1.aply_acpt_no                             --申请受理编号|c32 4580601	4580601
	,t1.aply_acpt_typ_cd                         --申请受理类型代码|c2  01线上进件 02续卡续贷 03商机线索
    ,c1.cd_val_dscr     as aply_acpt_typ_nm
	,t1.aply_acpt_sub_clss_cd                    --申请受理细类代码 015泰e贷
    ,c2.cd_val_dscr     as aply_acpt_sub_clss_nm
	,t1.aply_acpt_sma_clss_cd                    --申请受理子类代码|c5
    ,c3.cd_val_dscr     as aply_acpt_sma_clss_nm
	,t1.cst_id                                   --客户号|c20
	,t1.cst_nm                                   --客户名称|c200
	,t1.cst_typ_cd                               --客户类型代码|c4
    ,c4.cd_val_dscr     as cst_typ_nm
	,t1.prd_no                                   --产品编号|c32
	,t1.prd_nm                                   --产品名称|c200
    ,t1.opr_tm
    ,t1.sys_reg_tm
	,SUBSTR(replace(t1.opr_tm     ,'-',''),1,8) as opr_dt                                   --操作时间|c19
	,SUBSTR(replace(t1.sys_reg_tm ,'-',''),1,8) as sys_reg_dt                               --系统登记时间|c19
	,SUBSTR(replace(t1.late_upd_tm,'-',''),1,8) as late_upd_tm                              --最后更新时间|c19
	,t2.ahn_ltr_aply_serno                       --授用信申请流水号|c32
	,t2.usc_aply_serno                           --用信申请流水号|c32
    -- ,t3.CTR_SERNO
from edw.dwd_bus_loan_aply_acpt_inf_dd              t1 --申请受理信息
left join edw.dwd_bus_loan_aply_acpt_rel_facl_dd    t2 --申请受理与授信表关联关系
on t1.APLY_ACPT_NO=t2.APLY_ACPT_NO
and t2.dt='20241120'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON T1.aply_acpt_typ_cd=C1.CD_VAL
AND C1.DT='20241120'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C2
ON T1.aply_acpt_sub_clss_cd=C2.CD_VAL
AND C2.DT='20241120'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C3
ON T1.aply_acpt_sma_clss_cd=C3.CD_VAL
AND C3.DT='20241120'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C4
ON T1.cst_typ_cd=C4.CD_VAL
AND C4.DT='20241120'
-- left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD           t3
-- on t2.USC_APLY_SERNO=t3.REL_SERNO
-- and t3.dt='20241120'
where t1.dt='20241120'
and SUBSTR(replace(sys_reg_tm,'-',''),1,8) >='20230101'     --申请时间
and t1.cst_id in(
    Select DISTINCT cst_id from SJXQ_SJ2024111596_CST_01
)   --对私
;
-- 合同：ctr_serno,brc_org_nm,loan_mgr_nm
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_04 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_04 as
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,t2.PD_NM
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.usc_aply_dt	        --用信申请日期
    ,t1.cst_src_chnl_cd	    --客户来源渠道代码|c3
    ,t1.dtrb_cst_act_id	    --放款客户账号|c32
    ,c1.cd_val_dscr     as cst_src_chnl_nm
    ,t1.grnt_mod_colc	    --担保方式集合|c200 '005','信用' ,'010','保证' ,'020','抵押' ,'040','质押' ,'050','资产池'
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.brc_org_nm,t4.sbr_org_id,t4.sbr_org_nm,t4.org_nm
    ,row_number() over(partition by t1.cst_id order by t1.ctr_bgn_dt) rn
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='20241120'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20241120'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20241120'
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON T1.cst_src_chnl_cd=C1.CD_VAL
AND C1.DT='20241120'
where t1.dt='20241120'
and t1.grnt_mod_colc regexp '040'   --担保方式 包含质押
and t2.PD_NM not regexp '信用卡'
and t1.ctr_bgn_dt >='20230101'
and t1.cst_id in(
    Select DISTINCT cst_id from SJXQ_SJ2024111596_CST_01
)   --对私
;
-- 借据：客户号、入账日期、担保类型、rn、入账账号II,是否绑定他行I类户
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_05 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_05 as
select t1.DBIL_ID                                --借据编号|C64
	,t1.OUT_ACC_SERNO                            --出账流水号|C32
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.DTRB_ACT_ID                              --放款客户账号|C32 可通过存款账户判断账户类型
	,t1.RPAY_ACT_ID                              --还款客户账号|C32 ？？？
from edw.dim_bus_loan_dbil_inf_dd       t1            --信贷借据信息
INNER JOIN  SJXQ_SJ2024111596_CST_04    t2
on t1.ctr_serno=t2.ctr_serno
where t1.dt='20241120'
;
-- 放款
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_06 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_06 as
select t1.dbil_id                                  --借据号|C50
	,t1.dtl_id                                   --明细编号|C32
	,t1.ccy_cd                                   --货币代码|C3
    ,t1.trx_dt                                   --交易日期|C8
	,t1.entr_act_act_id                          --入账账号|C32
	,t1.dtrb_amt                                 --放款金额|DECIMAL(20,2)
	,t1.norm_prcp                                --正常本金|DECIMAL(20,2)
	,t1.ovd_prcp                                 --逾期本金|DECIMAL(20,2)
	,t1.idle_prcp                                --呆滞本金|DECIMAL(20,2)
	,t1.bad_prcp                                 --呆账本金|DECIMAL(20,2)
	,t1.rpay_act_id                              --还款账号|C32
	,t1.rpay_tot_amt                             --还款总额|DECIMAL(20,2)
	,t1.rpay_sts_cd                              --还款状态代码|C1
	,t1.rpay_prcp                                --归还本金|DECIMAL(20,2)
	,t1.trx_evt                                  --交易事件|C10
	,t1.evt_cmt                                  --事件说明|C80
	,t1.trx_no                                   --交易码|C16
	,t1.smr                                      --摘要|C512
	,t1.loan_act_id                              --贷款客户账号|C32
	,t1.tms                                      --时间戳|DECIMAL(0,0)
    ,case when substr(t1.tms,12,2) between 5 and 22 then 0 else 1 end as is_dark
	,t1.chnl_cd                                  --渠道代码|c3
	,t2.CTR_SERNO                                --合同流水号|C32
	,t2.CST_ID                                   --客户号|C20
    ,t3.act_ctg_cd_2
    ,case when t3.act_ctg_cd_2='302' then 1 else 0 end     as is_2cls
    ,case when t4.cst_act_id is not null then 1 else 0 end as is_bind1cls
from edw.dwd_bus_loan_cst_act_trx_dtl_di    t1     --贷款客户账户交易明细
INNER JOIN SJXQ_SJ2024111596_CST_05         t2
on t1.dbil_id=t2.DBIL_ID
left join (
    SELECT distinct cst_act_id,act_ctg_cd_2
    from SJXQ_SJ2024111596_CST_01
    where nvl(ACT_TYP,'')<>''
)t3 on t1.entr_act_act_id=t3.cst_act_id
left join (
    SELECT DISTINCT cst_act_id
    from SJXQ_SJ2024111596_CST_02
) t4  on t1.entr_act_act_id=t4.cst_act_id
where t1.dt<='20241120' and t1.dt>='20230101'
and t1.smr = '贷款发放'
;
-- 还款：cst_id,还款日期
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_07 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_07 as
select t1.dbil_id                                  --借据号|C50
	,t1.dtl_id                                   --明细编号|C32
	,t1.ccy_cd                                   --货币代码|C3
    ,t1.trx_dt                                   --交易日期|C8
	,t1.entr_act_act_id                          --入账账号|C32
	,t1.dtrb_amt                                 --放款金额|DECIMAL(20,2)
	,t1.norm_prcp                                --正常本金|DECIMAL(20,2)
	,t1.ovd_prcp                                 --逾期本金|DECIMAL(20,2)
	,t1.idle_prcp                                --呆滞本金|DECIMAL(20,2)
	,t1.bad_prcp                                 --呆账本金|DECIMAL(20,2)
	,t1.rpay_act_id                              --还款账号|C32
	,t1.rpay_tot_amt                             --还款总额|DECIMAL(20,2)
	,t1.rpay_sts_cd                              --还款状态代码|C1
	,t1.rpay_prcp                                --归还本金|DECIMAL(20,2)
	,t1.trx_evt                                  --交易事件|C10
	,t1.evt_cmt                                  --事件说明|C80
	,t1.trx_no                                   --交易码|C16
	,t1.smr                                      --摘要|C512
	,t1.loan_act_id                              --贷款客户账号|C32
	,t1.tms                                      --时间戳|DECIMAL(0,0)
	,t1.chnl_cd                                  --渠道代码|c3
	,t2.CTR_SERNO                                --合同流水号|C32
	,t2.CST_ID                                   --客户号|C20
    ,t3.act_ctg_cd_2
from edw.dwd_bus_loan_cst_act_trx_dtl_di    t1  --贷款客户账户交易明细
INNER JOIN SJXQ_SJ2024111596_CST_05         t2
on t1.dbil_id=t2.DBIL_ID
left join (
    SELECT distinct cst_act_id,act_ctg_cd_2
    from SJXQ_SJ2024111596_CST_01
    where nvl(ACT_TYP,'')<>''
)t3 on t1.rpay_act_id=t3.cst_act_id
where t1.dt<='20241120' and dt>='20230101'
and t1.smr ='归还贷款'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_act_id) custs
from SJXQ_SJ2024111596_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct dep_act_id) custs
from SJXQ_SJ2024111596_CST_02 where is_ourbnk_act=0
union all
SElECT '03' seq, count(1) cnt,count(distinct aply_acpt_no) custs
from SJXQ_SJ2024111596_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct ctr_serno) custs
from SJXQ_SJ2024111596_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct DBIL_ID) custs
from SJXQ_SJ2024111596_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ2024111596_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct CTR_SERNO) custs
from SJXQ_SJ2024111596_CST_07
;
/*
01	9218598	7970137
02	23037	22819
03	1006913	1006913
04	1053	1053
05	2023	2023
06	2023	2023
07	6033	1831
--出账申请记录
select t1.out_acc_serno                            --出账流水号|c32
	,t1.ctr_serno                                --合同流水号|c32
	,t1.usc_aply_serno                           --用信申请流水号|c32
	,t1.ctr_no                                   --合同编号|c100
	,t1.cst_id                                   --客户号|c20
	,t1.cst_nm                                   --客户名称|c200
	,t1.prd_no                                   --产品编号|c32
	,t1.ctr_amt                                  --合同金额|decimal(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期|c8
	,t1.ctr_mtu_dt                               --合同到期日期|c8
	,t1.grnt_mod_colc                            --担保方式集合|c200
	,t1.out_acc_amt                              --出账金额|decimal(21,2)
	,t1.thstm_aply_drw_mny_amt                   --本次申请提款金额|decimal(21,2)
	,t1.lve_act_dt                               --出账日期|c8
	,t1.dbil_bgn_dt                              --借据起始日期|c8
	,t1.dbil_mtu_dt                              --借据到期日期|c8
	,t1.dtrb_cst_act_id                          --放款客户账号|c32
	,t1.rpay_cst_act_id                          --还款客户账号|c32
	,t1.stl_cst_act_id                           --结算客户账号|c32
	,t1.rvlg_typ_cd                              --循环类型代码|c1
	,t1.chnl_cd                                  --渠道代码|c6
    ,c1.cd_val_dscr     as chnl_nm
	,t1.trx_dt                                   --交易日期|c8
	,t1.actl_pmt_amt                             --实付金额|decimal(21,2)
from edw.dwd_bus_loan_pvp_aply_inf_dd   t1 --出账申请记录
LEFT JOIN EDW.DWD_CODE_LIBRARY_DD       C1
ON T1.chnl_cd=C1.CD_VAL
AND C1.DT='20241120'
where t1.dt='20241120'
and t1.grnt_mod_colc regexp '040'  --包含质押贷款
and t1.lve_act_dt>='20230101'
;
select loan_act_id                              --贷款账号|C32
	,loan_dbil_id                             --贷款借据号|C35
	,dtl_seq_nbr                              --明细序号|BIGINT
	,pd_cd                                    --产品代码|C24
	,cst_id                                   --客户号|C20
	,cst_nm                                   --客户名称|C200
	,ccy_cd                                   --货币代号|C3
	,trx_dt                                   --交易日期|C8
	,trx_dir                                  --交易方向|C1
	,trx_amt                                  --交易金额|DECIMAL(21,2)
	,bal                                      --余额|DECIMAL(21,2)
	,loan_bal_fld                             --贷款余额字段|C8
	,bal_fld_cmt                              --余额字段说明|C80
	,trx_evt                                  --交易事件|C10
	,evt_cmt                                  --事件说明|C80
	,trx_no                                   --交易码|C16
	,smr                                      --摘要|C512
	,loan_rpay_mth                            --贷款归还方式|C2
	,rcd_sts                                  --记录状态|C1
from edw.dwd_bus_loan_act_trx_dtl_di          --贷款账户交易明细
where dt<='@@{yyyyMMdd}'
and trx_dir='1'   --交易方向 0放款 1还款
;
*/
/*
edw.dwd_bus_loan_cst_act_trx_dtl_di
贷款客户账户交易明细
全部取数时间：20230101-至今
一、对私客户通过线上渠道，申请质押贷款，贷款发放入账 30 分钟内偿还贷款
且 贷款入账账户为 II 类账户
且 II类账户绑定他行I类账户
说明：&rdquo;质押贷款&ldquo;，是指客户信贷业务的主要担保方式为&rdquo;质押&ldquo;&quot;
*/
-- 22793
SELECT count(DISTINCT cst_act_id) as II类户绑定他行I类户的账户数
from SJXQ_SJ2024111596_CST_02
where ACT_CTG_CD_2='302'    --II类户
;
-- 近180天通过非面对面渠道申请质押贷款266笔，共229户。
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_08 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_08 as
SELECT  t1.cst_id           AS 客户号
    ,t1.cst_nm          AS 客户名称
    ,t1.ctr_serno       AS 合同号
    ,t1.ctr_bgn_dt      AS 合同起始日期
    ,t1.ctr_amt         AS 合同金额
    ,t1.ctr_bal         AS 合同余额
    ,t1.cst_src_chnl_nm AS 客户来源渠道
    ,t1.dtrb_cst_act_id AS 放款客户账号
    ,t1.mgr_nm          AS 管户人
    ,t1.org_nm          AS 管户机构
    ,t2.dbil_id         AS 借据号
    ,t2.trx_dt          AS 放款日期
    ,t2.entr_act_act_id AS 入账账号
    ,t2.dtrb_amt        AS 放款金额
    ,t2.loan_act_id     AS 贷款客户账号
    ,t2.is_2cls         AS 是否II类户
    ,t2.is_bind1cls     AS 是否绑定他行I类户
from SJXQ_SJ2024111596_CST_04       t1
INNER JOIN SJXQ_SJ2024111596_CST_06 t2
on t1.CTR_SERNO=t2.CTR_SERNO
and t1.非面对面渠道建立业务关系=1
;
/*
&quot;过去180天内
客户申请个人质押贷款 次数 >= 3
且 首次贷款入账 到 最后一笔贷款还款 时间 间隔30天内
且 至少一笔信贷申请时间 发生在 23点-5点（次日）
且 累计贷款入账金额 >=1000000
或者
客户个人质押贷款的入账（借据） 次数 >= 3
且 首次贷款入账 到 最后一笔贷款还款 时间 间隔30天内
且 至少一笔贷款入账时间 发生在 23点-5点（次日）
且 累计贷款入账金额 >=1000000
或者
客户个人质押贷款的信贷合同 次数 >= 3
且 首次信贷合同 到 最后一笔合同 时间 间隔30天内
且 累计贷款合同金额 >=1000000
说明：①&ldquo;凌晨申请&rdquo;，只要发生过一次信贷申请或者贷款入账在 23点-5点（次日）的都算；②贷款首次、最后一笔，取同一个信贷合同的第一笔入账时间、最后一笔还款时间。&quot;
*/
-- 存在 首次贷款入账 到 最后一笔贷款还款 时间 间隔30天内的客户
-- 贷款首次、最后一笔，取同一个信贷合同的第一笔入账时间、最后一笔还款时间。
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_10 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_10 as
select distinct t1.cst_id
from(
    SELECT cst_id,ctr_serno
        ,min(trx_dt) as fst_rz_dt
    from SJXQ_SJ2024111596_CST_06 t1
    GROUP BY cst_id,ctr_serno
)t1 INNER JOIN (
    SELECT ctr_serno
        ,max(trx_dt) as lst_repay_dt
    from SJXQ_SJ2024111596_CST_07
    GROUP BY ctr_serno
)t2 on t1.ctr_serno=t2.ctr_serno
and DATEDIFF(TO_DATE(t2.lst_repay_dt, 'yyyyMMdd'), TO_DATE(t1.fst_rz_dt,'yyyyMMdd'), 'dd') between 0 and 30
;
-- 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_11 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_11 as
select CST_ID
    ,count(DISTINCT dbil_id)    as dbil_cnt_180
    ,sum(dtrb_amt)              as dbil_amt_180
from SJXQ_SJ2024111596_CST_06
GROUP BY CST_ID
having count(DISTINCT dbil_id)>=3
and sum(dtrb_amt)>=1000000
;
-- 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_12 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_12 as
select CST_ID
    ,count(DISTINCT ctr_serno)  as ctr_cnt_180
    ,sum(ctr_amt)               as ctr_amt_180
from SJXQ_SJ2024111596_CST_04
GROUP BY CST_ID
having count(DISTINCT ctr_serno)>=3
and sum(ctr_amt)>=1000000
;
-- 输出结果 客户号、涉及账户、日期、动账类型（入账/还款）、涉及金额、管护机构、管护经理
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_13 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_13 as
SELECT  t1.CST_ID           AS 客户号
        ,t4.cst_nm          AS 客户名称
        ,t1.dbil_cnt_180    AS 近180天入账借据次数
        ,t1.dbil_amt_180    AS 近180天累计贷款入账金额
        ,t4.ctr_amt         AS 合同金额
        ,t4.ctr_bal         AS 合同余额
        ,t4.ctr_bgn_dt      AS 合同起始日期
        ,t4.ctr_mtu_dt      AS 合同到期日期
        ,t4.dtrb_cst_act_id AS 放款客户账号
        ,t4.mgr_id          AS 管户人工号
        ,t4.mgr_nm          AS 管户人姓名
        ,t4.mgr_org_id      AS 管户机构号
        ,t4.org_nm          AS 管户机构
        ,case when t3.cst_id is not null then '是' else '否' end as 是否存在一笔贷款入账时间发生在23点到5点
from SJXQ_SJ2024111596_CST_11       t1
INNER JOIN SJXQ_SJ2024111596_CST_10 t2
on t1.cst_id=t2.cst_id
left join(
    SELECT DISTINCT cst_id
    from SJXQ_SJ2024111596_CST_06
    where is_dark=1     --至少一笔贷款入账时间 发生在 23点-5点
)t3 on t1.cst_id=t3.cst_id
left join SJXQ_SJ2024111596_CST_04 t4
on t1.cst_id=t4.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_14 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_14 as
SELECT  t1.CST_ID           AS 客户号
        ,t4.cst_nm          AS 客户名称
        ,t1.ctr_cnt_180     AS 近180天质押贷款合同数
        ,t1.ctr_amt_180     AS 近180天质押贷款合同金额
        ,t4.ctr_amt         AS 合同金额
        ,t4.ctr_bal         AS 合同余额
        ,t4.ctr_bgn_dt      AS 合同起始日期
        ,t4.ctr_mtu_dt      AS 合同到期日期
        ,t4.dtrb_cst_act_id AS 放款客户账号
        ,t4.mgr_id          AS 管户人工号
        ,t4.mgr_nm          AS 管户人姓名
        ,t4.mgr_org_id      AS 管户机构号
        ,t4.org_nm          AS 管户机构
from SJXQ_SJ2024111596_CST_12       t1
INNER JOIN SJXQ_SJ2024111596_CST_10 t2 --首次信贷合同 到 最后一笔合同 时间 间隔30天内
on t1.cst_id=t2.cst_id
left join SJXQ_SJ2024111596_CST_04  t4
on t1.cst_id=t4.cst_id
;
/*
&quot;提取客户过去180天内的所有交易ip地址，去重后，去掉个人质押贷款申请、入账、还款时的交易IP地址；
比较个人质押贷款申请、入账、还款时的交易IP地址是否存在其他交易ip中，如不存在，预警&quot;	客户号、个人质押贷款申请入账还款时的交易日期、个人质押贷款申请入账还款时的交易的ip、个人质押贷款申请入账还款时的交易的ip、管户机构、管户经理
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_15 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_15 as
SELECT  DISTINCT lgp_bnk_id 多法人行标识
                 ,chnl_typ_cd 渠道类型代码
                 ,trx_seq 交易流水号
                 ,cst_id 客户号
                 ,trx_cd 交易代码
                 ,pmt_act_id 调查人账号
                 ,pmt_sub_act_id 调查人子账号
                 ,pmt_act_nm 调查人户名
                 ,pmt_opn_bnk_id 调查人开户行号
                 ,pmt_opn_bnk_nm 调查人开户行名称
                 ,rcv_act_id 对方账号
                 ,rcv_sub_act_id 对方子账号
                 ,rcv_act_nm 对方户名
                 ,rcv_opn_bnk 对方开户行
                 ,rcv_opn_bnk_cnaps 对方开户行联行号
                 ,ccy_cd 币种
                 ,usr_sbm_tm 用户提交时间
                 ,trx_amt 交易金额
                 ,rcv_cmsn_fee 应收手续费
                 ,core_srl_nbr 核心流水号
                 ,trx_snd_hst_tm 交易发送主机时间
                 ,hst_rtn_err_cd 主机返回错误代码
                 ,hst_rtn_err_dscr 主机返回错误描述
                 ,usr_cmt 用户备注
                 ,instr_sts_cd 指令状态
                 ,cst_end_ip 客户端ip
                 ,ovs_ind 境外标志
                 ,cnr_nm 国家名称
                 ,pvc_nm 省份名称
                 ,cty_nm 城市名称
                 ,opr_mch_nm 运营商名称
                 ,late_upd_tm 最后更新时间
                 ,use_face_pmt_flg 使用人脸提升限额标志
                 ,atst_mth_cd 认证方式代码
                 ,glbl_srl_nbr 全局流水号
                 ,rcv_mbl_nbr 收款人手机号码
                 ,aplc_srl_nbr 反欺诈申请流水号
                 ,IF(cnr_nm = '中国', concat(pvc_nm, ' ', cty_nm), cnr_nm) AS 地区
                 ,CASE
                    WHEN cst_end_ip REGEXP '@'                                                                                 THEN split_part(cst_end_ip, '@', 1)
                    WHEN cst_end_ip REGEXP ':' AND cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR cst_end_ip REGEXP '^null:' THEN split_part(cst_end_ip, ':', 1)
                    WHEN cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                         THEN cst_end_ip
                  END                                                    AS mac
                 ,CASE
                    WHEN cst_end_ip REGEXP '@'                                                                                 THEN split_part(cst_end_ip, '@', 2, 100)
                    WHEN cst_end_ip REGEXP ':' AND cst_end_ip NOT REGEXP '^\\d{1,3}\\.|^\\w{4}:' OR cst_end_ip REGEXP '^null:' THEN split_part(cst_end_ip, ':', 2, 100)
                    WHEN cst_end_ip REGEXP '^\\d{1,3}\\.|^\\w{4}:'                                                             THEN cst_end_ip
                  END                                                    AS ip
                 --,concat(pmt_act_id, '%')
FROM    edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di --个人网银各渠道汇总流水信息
WHERE   dt >= '20230101'
AND     dt <= '20241120'
and cst_id in(select DISTINCT cst_id from SJXQ_SJ2024111596_CST_04)
-- AND     pmt_act_id IN ( '6214808801032023505' ,'6214808800000281483','6214808801031908540','6214808801007544477','6214808801031799824','6214808801031906031','6214808801030060947','6214808801031804764')
ORDER BY pmt_act_id,usr_sbm_tm desc
;
-- 化简
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_16 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_16 as
SELECT 客户号 as cst_id
    ,substr(用户提交时间,1,8) as trx_dt
    ,交易金额 as trx_amt
    ,ip
from SJXQ_SJ2024111596_CST_15 t1
where nvl(ip,'')<>''
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_17 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_17 as
SELECT t1.cst_id,t1.trx_dt,t1.trx_amt,t1.ip
    ,case when t2.cst_id is not null then 1 else 0 end as is_select
from SJXQ_SJ2024111596_CST_16 t1
left join(
    SELECT cst_id,trx_dt,dtrb_amt as trx_amt
    from SJXQ_SJ2024111596_CST_06
    union
    select cst_id,trx_dt,rpay_tot_amt as trx_amt
    from SJXQ_SJ2024111596_CST_07
)t2 on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
and t1.trx_amt=t2.trx_amt
;
-- 筛选条件
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_18 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_18 as
SELECT t1.cst_id,sum(case when t2.cst_id is not null then 1 else 0 end) as 个人质押贷款申请入账还款时的交易的ip存在其他交易ip数
from(
    SELECT DISTINCT cst_id,ip
    from SJXQ_SJ2024111596_CST_17
    where is_select=0
)t1 left JOIN (
    SELECT DISTINCT cst_id,ip
    from SJXQ_SJ2024111596_CST_17
    where is_select=1
)t2 on t1.ip=t2.ip
and t1.cst_id=t2.cst_id
group by t1.cst_id
;
-- 输出结果 客户号、个人质押贷款申请入账还款时的交易日期、个人质押贷款申请入账还款时的交易的ip、个人质押贷款申请入账还款时的交易的ip、管护机构、管护经理
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_19 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_19 as
SELECT  t1.cst_id   AS 客户号
        ,t2.trx_dt  AS 个人质押贷款申请入账还款时的交易日期
        ,t2.trx_amt AS 个人质押贷款申请入账还款时的交易金额
        ,t2.ip      AS 个人质押贷款申请入账还款时的交易的ip
        ,t3.mgr_nm  AS 管户经理
        ,t3.org_nm  AS 管户机构
from SJXQ_SJ2024111596_CST_18        t1
inner join SJXQ_SJ2024111596_CST_17  t2
on t1.cst_id=t2.cst_id
and t2.is_select=1
left join(
    SELECT t1.cst_id
    from SJXQ_SJ2024111596_CST_04 t1
    GROUP BY t1.cst_id
)t3 on t1.cst_id=t3.cst_id
where t1.个人质押贷款申请入账还款时的交易的ip存在其他交易ip数=0
;
/*
&quot;客户发生查冻扣，查冻扣时间 晚于 个人质押贷款还款时间
且 间隔时间小于等于15天&quot;
*/
-- 查冻扣
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_20 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_20 as
SELECT  T1.qry_ctrl_chnl_nm AS 查控渠道名称
        ,T4.cd_val_dscr     AS 有权机关类型
        ,T1.exe_rsn          AS 执行原因
        ,T1.instt_nm         AS 有权机关名称
        ,T1.law_doc_id       AS 法律文书编号
        ,T1.law_doc_nm       AS 法律文书名称
        ,T1.qry_ctrl_dt      AS 查控日期
        ,T1.qry_ctrl_tm      AS 查控时间
        ,T1.qry_ctrl_typ_nm  AS 查控类型代码
        ,T1.cst_id           AS 客户号
        ,T1.cst_nm           AS 客户名称
        ,CASE
           WHEN T1.CST_TYP_CD = '1' THEN '对私'
           WHEN T1.CST_TYP_CD = '2' THEN '对公'
         END                 AS 公私标识
        ,T1.cst_doc_typ_cd   AS 客户证件类型
        ,T1.cst_doc_nbr      AS 客户证件号码
        ,T1.cst_act_id       AS 客户账号
        ,T2.prm_org_id       AS 客户归属机构ID
        ,T2.prm_org_nm       AS 客户归属机构
FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd T1
INNER JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户管户信息
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树
ON      T2.prm_org_id = T3.org_id
AND     T3.dt = '@@{yyyyMMdd}'
left join  edw.dwd_code_library_dd T4
on T1.instt_typ_cd=T4.cd_val
and T4.dt='@@{yyyyMMdd}'
WHERE   T1.dt = '@@{yyyyMMdd}'
-- AND     T1.qry_ctrl_dt >= '@@{yyyyMMdd-1y}'
AND     T1.qry_ctrl_dt <= '@@{yyyyMMdd}'
AND     T1.qry_ctrl_typ_nm IN ( '查询' , '冻结' , '划扣' )
AND     ( T1.instt_typ_cd IN ( '04' , '05' )
    OR ( ( T1.instt_nm LIKE '%法院%'
    OR T1.instt_typ_cd = '01' )
AND     T1.LAW_DOC_ID LIKE '%刑%' ) )
-- AND     T3.brc_org_nm = '上海分行'
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_21 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_21 as
SELECT DISTINCT 客户号 as cst_id
    ,查控日期 as qry_ctrl_dt
from SJXQ_SJ2024111596_CST_20
;
-- 贷款还款信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_22 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_22 as
SElECT t1.cst_id    as 客户号
    ,T2.qry_ctrl_dt as 发生查冻扣日期
    ,t1.trx_dt      as 个人质押贷款还款日期
    ,t3.mgr_nm	    as 管户经理
    ,t3.org_nm      as 管户机构
FROM (
    SELECT DISTINCT cst_id,trx_dt
    from SJXQ_SJ2024111596_CST_07
)t1 INNER JOIN SJXQ_SJ2024111596_CST_21 t2
on t1.cst_id=t2.cst_id
and DATEDIFF(TO_DATE(t2.qry_ctrl_dt,'yyyyMMdd'),TO_DATE(t1.trx_dt,'yyyyMMdd'),'DD') between 0 and 15
left join(
    SELECT t1.cst_id
    from SJXQ_SJ2024111596_CST_04 t1
    GROUP BY t1.cst_id
)t3 on t1.cst_id=t3.cst_id
;
select *
from SJXQ_SJ2024111596_CST_22
/*
&quot;贷款客户的I类账户，在质押贷款发放前1天，存在他行同名I类账户转入资金
且 累计转入资金 在 0.8*贷款资金~1.2*贷款资金 之间
且 转入次数 >=5 次
且 单笔转入资金>=50000
贷款客户的II账户，在还质押贷款交易前1天，存在他行同名I类账户转入资金
且 累计转入资金 在 0.8*还款资金~1.2*还款资金 之间
且 入账交易时间  与 还款交易时间的时间差在3天及内
贷款客户的II账户，在质押贷款发放前1天，存在他行同名I类账户转入资金
且 累计转入资金 在0.75*贷款资金~1.25*贷款资金
且 当日 转出至定期性账户（如购买大额存单、开立定期存款、购买结构性存款 ），累计转出金额=累计转入资金
且 当日 转出至定期性账户 次数 >=2次
且 该笔定期性账户 是 客户质押贷款的押品
说明：&ldquo;押品&rdquo;信息，取自该笔质押贷款的担保合同信息&quot;
*/
-- 客户号、客户账号、几类户-I、质押贷款发放日期、发放金额、他行同名I类户转入资金、转入次数，最大单笔转入资金、管户机构、管户经理
-- ？客户号、客户账号、几类户_II、质押贷款还款日期、还款金额、他行同名I类户转入资金、转入次数，最大单笔转入资金、管户机构、管户经理
-- 客户号、客户账号、几类户_II、质押贷款发放日期、发放金额、他行同名I类户转入资金、转入次数，最大单笔转入资金、管户机构、管户经理
-- 押贷款发放前1天交易
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_23 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_23 as
SELECT t1.cst_id,t1.trx_dt,t1.dtrb_amt
    ,count(1)       as trx_in_cnt
    ,max(trx_amt)   as max_trx_amt
    ,sum(trx_amt)   as cum_trx_amt
from(
    SELECT cst_id,trx_dt,sum(dtrb_amt) as dtrb_amt
    from SJXQ_SJ2024111596_CST_06
    where act_ctg_cd_2 ='301'
    GROUP BY cst_id,trx_dt
)t1 inner join SJXQ_SJ2024111596_CST_01     t2 --存款账户信息汇总
on t1.cst_id=t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.trx_dt=to_char(DATEADD(TO_DATE(t1.trx_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd')    --前一天
and t3.dt<='@@{yyyyMMdd}'
and (t3.cst_act_id=t3.cnt_pty_cst_act_id or t3.act_nm=t3.cnt_pty_act_nm)            --同名转账
and t3.crd_and_dbt_ind='C'  --转入
and t3.cnt_pty_fin_instt_typ_cd <> '13' --他行 13银行内部机构号
group by t1.cst_id,t1.trx_dt,t1.dtrb_amt
;
-- 结果5-1
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_24 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_24 as
SELECT  t1.cst_id       AS 客户号
        ,t1.trx_dt      AS 质押贷款发放日期
        ,t1.dtrb_amt    AS 发放金额
        ,t1.trx_in_cnt  AS 前1天转入次数
        ,t1.max_trx_amt AS 前1天最大单笔转入资金
        ,t1.cum_trx_amt  AS 前1天他行同名转入资金
    ,t3.mgr_nm	    as 管户经理
    ,t3.org_nm      as 管户机构
from SJXQ_SJ2024111596_CST_23 t1
left join(
    SELECT t1.cst_id
    from SJXQ_SJ2024111596_CST_04 t1
    GROUP BY t1.cst_id
)t3 on t1.cst_id=t3.cst_id
where t1.trx_in_cnt>=5
and t1.cum_trx_amt between 0.8*t1.dtrb_amt and 1.2*t1.dtrb_amt
and t1.max_trx_amt>=50000
;
SELECT *
from SJXQ_SJ2024111596_CST_24
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_25 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_25 as
SELECT t1.cst_id,t1.trx_dt,t1.rpay_tot_amt
    ,count(1)       as trx_in_cnt
    ,max(t3.trx_amt)   as max_trx_amt
    ,sum(t3.trx_amt)   as cum_trx_amt
from(
    SELECT cst_id,trx_dt,sum(rpay_tot_amt) as rpay_tot_amt
    from SJXQ_SJ2024111596_CST_07
    where act_ctg_cd_2 ='302'
    GROUP BY cst_id,trx_dt
)t1 inner join SJXQ_SJ2024111596_CST_01     t2 --存款账户信息汇总
on t1.cst_id=t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.trx_dt=to_char(DATEADD(TO_DATE(t1.trx_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd')    --前一天
and t3.dt<='@@{yyyyMMdd}'
and (t3.cst_act_id=t3.cnt_pty_cst_act_id or t3.act_nm=t3.cnt_pty_act_nm)            --同名转账
and t3.crd_and_dbt_ind='C'  --转入
and t3.cnt_pty_fin_instt_typ_cd <> '13' --他行 13银行内部机构号
group by t1.cst_id,t1.trx_dt,t1.rpay_tot_amt
;
-- 没数据
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_26 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_26 as
SELECT *
from SJXQ_SJ2024111596_CST_25        t1
INNER join SJXQ_SJ2024111596_CST_07  t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.trx_dt
inner join SJXQ_SJ2024111596_CST_06 t3
on t1.cst_id=t3.cst_id
and t2.dbil_id=t3.dbil_id
and DATEDIFF(TO_DATE(t2.trx_dt,'yyyyMMdd'),TO_DATE(t3.trx_dt,'yyyyMMdd'),'DD') between 0 and 3
;
--
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_27 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_27 as
SELECT t1.cst_id,t1.trx_dt,t1.dtrb_amt
    ,count(1)       as trx_in_cnt
    ,max(trx_amt)   as max_trx_amt
    ,sum(trx_amt)   as cum_trx_amt
from(
    SELECT cst_id,trx_dt,sum(dtrb_amt) as dtrb_amt
    from SJXQ_SJ2024111596_CST_06
    where act_ctg_cd_2 ='302'
    GROUP BY cst_id,trx_dt
)t1 inner join SJXQ_SJ2024111596_CST_01     t2 --存款账户信息汇总
on t1.cst_id=t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.trx_dt=to_char(DATEADD(TO_DATE(t1.trx_dt,'yyyyMMdd'),-1,'dd'),'yyyyMMdd')    --前一天
and t3.dt<='@@{yyyyMMdd}'
and (t3.cst_act_id=t3.cnt_pty_cst_act_id or t3.act_nm=t3.cnt_pty_act_nm)            --同名转账
and t3.crd_and_dbt_ind='C'  --转入
and t3.cnt_pty_fin_instt_typ_cd <> '13' --他行 13银行内部机构号
group by t1.cst_id,t1.trx_dt,t1.dtrb_amt
;
-- 当日转出
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_28 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_28 as
SELECT t1.cst_id,t1.trx_dt,t1.dtrb_amt
    ,count(1)       as trx_out_cnt
    ,sum(t4.trx_amt)   as cum_out_amt
from(
    SELECT cst_id,trx_dt,sum(dtrb_amt) as dtrb_amt
    from SJXQ_SJ2024111596_CST_06
    where act_ctg_cd_2 ='302'
    GROUP BY cst_id,trx_dt
)t1 inner join SJXQ_SJ2024111596_CST_01     t2 --存款账户信息汇总
on t1.cst_id=t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di   t4 --存款账户余额发生明细表
on t2.dep_act_id=t4.dep_act_id
and t4.trx_dt=t1.trx_dt   --当日
and t4.dt<='@@{yyyyMMdd}'
and t4.crd_and_dbt_ind='D'  --转出
inner join (
    SELECT DISTINCT cst_act_id
    from SJXQ_SJ2024111596_CST_01
    where lbl_prod_typ_cd='1'  -- 1	定期产品 0	活期产品
)t5 on t4.cnt_pty_cst_act_id=t5.cst_act_id
group by t1.cst_id,t1.trx_dt,t1.dtrb_amt
;
select *
from SJXQ_SJ2024111596_CST_28
;
/*
&quot;对私客户在发生质押贷款入账时间前 近一年的 年日均余额<1000，
且  在质押贷款入账时间的  3 天前，客户在我行的账户余额 < 100
且  在质押贷款归还后，客户在我行的账户余额 < 100&quot;
*/
-- 入账客户 存款账户余额信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_30 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_30 as
SELECT dt,cst_id
    ,sum(last_360_days_gl_bal_acml)/360 as bal_year_avg --近360天总账余额积数
    ,sum(cur_act_bal)   as cur_act_bal
from edw.dws_bus_dep_act_inf_dd                     T1  --存款账户信息汇总
where dt<='20241120'
and dt>='20221201'
and cst_id in(select DISTINCT cst_id from SJXQ_SJ2024111596_CST_06)
group by dt,cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_31 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_31 as
SELECT  t1.cst_id        AS 客户号
        ,t1.trx_dt       AS 贷款入账日期
        ,t1.dtrb_amt     AS 入账金额
        ,t2.bal_year_avg AS 账户余额年日均
        ,t3.cur_act_bal  AS 入账3天前账户余额
        ,t3.dt           AS 入账3天前
        ,t4.repay_dt     AS 质押贷款还款日期
        ,t5.cur_act_bal  AS 质押贷款还款日期账户余额
        ,t6.mgr_nm       AS 管户经理
        ,t6.org_nm       AS 管户机构
from SJXQ_SJ2024111596_CST_06       t1
inner join SJXQ_SJ2024111596_CST_30 t2
on t1.cst_id=t2.cst_id
and t1.trx_dt=t2.dt
and t2.bal_year_avg<1000
inner join SJXQ_SJ2024111596_CST_30 t3
on t1.cst_id=t3.cst_id
and DATEDIFF(TO_DATE(t1.trx_dt,'yyyyMMdd'),TO_DATE(t3.dt,'yyyyMMdd'),'dd')=3
and t3.cur_act_bal<100
left join(
    SELECT dbil_id,max(trx_dt) repay_dt
    from SJXQ_SJ2024111596_CST_07
    GROUP BY dbil_id
)t4 on t1.dbil_id=t4.dbil_id
inner join SJXQ_SJ2024111596_CST_30 t5
on t1.cst_id=t5.cst_id
and t4.repay_dt=t5.dt
and t5.cur_act_bal<100
left join(
    SELECT t1.cst_id
    from SJXQ_SJ2024111596_CST_04 t1
    GROUP BY t1.cst_id
)t6 on t1.cst_id=t6.cst_id
;
SELECT *
from SJXQ_SJ2024111596_CST_31
;
/*
&quot;对私客户在我行的I、II类账户，
统计 对私客户的首笔质押贷款入账前3天 到 最后一笔质押贷款还款后3天 的 时间范围内 ，
累计入账金额/累计出账金额 比例 在0.8~1.2之间&quot;
*/
-- 客户号、首笔质押贷款日期、最后一笔质押贷款日期、累计入账金额、累计出账金额、管户机构、管户经理
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_32 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_32 as
SELECT cst_id,trx_dt
    ,to_char(DATEADD(TO_DATE(trx_dt,'yyyyMMdd'),-3,'dd'),'yyyyMMdd') as trx_dt_minus3
    ,to_char(DATEADD(TO_DATE(trx_dt,'yyyyMMdd'),3,'dd'),'yyyyMMdd') as trx_dt_add3
    ,row_number() over(partition by cst_id order by trx_dt asc) rn_asc
    ,row_number() over(partition by cst_id order by trx_dt desc) rn_dsc
from SJXQ_SJ2024111596_CST_06
;
-- 客户维度
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_33 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_33 as
SELECT t1.cst_id,t1.trx_dt as fst_loan_dt
    ,t1.trx_dt_minus3
    ,t2.trx_dt  as lst_loan_dt
    ,t2.trx_dt_add3
from SJXQ_SJ2024111596_CST_32       t1
left join SJXQ_SJ2024111596_CST_32  t2
on t1.cst_id=t2.cst_id
and t2.rn_dsc=1
where t1.rn_asc=1
;
-- 累计入账金额、累计出账金额
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_34 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_34 as
select t1.cst_id,t1.trx_dt_minus3
    ,t1.trx_dt_add3
    ,t3.crd_and_dbt_ind	    --借贷标志
    ,t3.trx_dt
    ,t3.trx_amt             --交易金额
from SJXQ_SJ2024111596_CST_33       t1
inner join SJXQ_SJ2024111596_CST_01 t2 --存款账户信息汇总
on t1.cst_id=t2.cst_id
inner join edw.dwd_bus_dep_bal_chg_dtl_di t3 --存款账户余额发生明细表
on t2.dep_act_id=t3.dep_act_id
and t3.trx_dt>=t1.trx_dt_minus3
and t3.trx_dt<=t1.trx_dt_add3
and t3.dt<='@@{yyyyMMdd}'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST_35 PURGE;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST_35 as
SELECT  t1.cst_id       AS 客户号
        ,t1.fst_loan_dt AS 首笔质押贷款日期
        ,t1.lst_loan_dt AS 最后一笔质押贷款日期
        ,t2.in_amt      AS 累计入账金额
        ,t3.out_amt     AS 累计出账金额
        ,round(t2.in_amt/t3.out_amt,2) as 入账比出账金额
        ,t6.mgr_nm      AS 管户经理
        ,t6.org_nm      AS 管户机构
from SJXQ_SJ2024111596_CST_33 t1
left join(
    SELECT cst_id,sum(trx_amt) as in_amt
    from SJXQ_SJ2024111596_CST_34 t1
    where crd_and_dbt_ind='C'
    GROUP BY cst_id
)t2 on t1.cst_id=t2.cst_id
inner join(
    SELECT cst_id,sum(trx_amt) as out_amt
    from SJXQ_SJ2024111596_CST_34 t1
    where crd_and_dbt_ind='D' and trx_amt<>0
    GROUP BY cst_id
)t3 on t1.cst_id=t3.cst_id
left join(
    SELECT t1.cst_id
    from SJXQ_SJ2024111596_CST_04 t1
    GROUP BY t1.cst_id
)t6 on t1.cst_id=t6.cst_id
where t2.in_amt/t3.out_amt between 0.8 and 1.2
;
SELECT *
from SJXQ_SJ2024111596_CST_35
-- 结果 1 无数据
-- 结果 2-1
SELECT *
from SJXQ_SJ2024111596_CST_13
;
-- 结果 2-2
SELECT *
from SJXQ_SJ2024111596_CST_14
;
-- 结果 3
SELECT *
from SJXQ_SJ2024111596_CST_19
;
-- -- 结果 4
-- SELECT *
-- from SJXQ_SJ2024111596_CST_22
-- ;
-- 结果 6
SELECT *
from SJXQ_SJ2024111596_CST_31
;
-- 结果 7
SELECT *
from SJXQ_SJ2024111596_CST_35
;
/*
SELECT  T0.cst_id
        ,T2.DBIL_ID
        ,T1.TRX_DT
        ,T1.SHD_PAY_DT --应还日期
        ,CASE
           WHEN T1.TRX_EVT = 'LN_TQHK' AND T1.TRX_DT = T1.SHD_PAY_DT THEN 'LN_ZCHK'
           WHEN T1.TRX_EVT = 'LN_YQHK' AND T1.TRX_DT = T1.SHD_PAY_DT THEN 'LN_ZCHK'
           ELSE T1.TRX_EVT
         END AS TRX_EVT --交易事件：提前还款LN_TQHK，正常还款LN_ZCHK，逾期还款LN_YQHK，核销归还LN_HXGH
        ,T1.PRCP_AMT PRCP_AMT --本金发生额
        ,T1.RCV_ACR_INTR_AMT + T1.CLCN_ACR_INTR_AMT + T1.RCV_OVD_INTR_AMT + T1.CLCN_OVD_INTR_AMT + T1.RCV_ACR_INTR_PNTY_AMT + T1.CLCN_ACR_INTR_PNTY_AMT + T1.RCV_INTR_PNTY_AMT + T1.CLCN_INTR_PNTY_AMT + T1.ACR_CMPD_INTR_AMT + T1.CMPD_INTR_AMT INTR_AMT --应收应计利息发生额,催收应计利息发生额,应收欠息发生额,催收欠息发生额,应收应计罚息发生额,催收应计罚息发生额,应收罚息发生额,催收罚息发生额,应计复息发生额,复息发生额
        ,CASE
           WHEN T1.TRX_EVT = 'LN_TQHK' THEN DATEDIFF(TO_DATE(T1.SHD_PAY_DT, 'yyyyMMdd'), TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 'dd')
           ELSE NULL
         END TQHK_DAYS --提前还款天数
        ,CASE
           WHEN T1.TRX_EVT = 'LN_YQHK' THEN DATEDIFF(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), TO_DATE(T1.SHD_PAY_DT, 'yyyyMMdd'), 'dd')
           ELSE NULL
         END YQHK_DAYS --逾期还款天数
        ,CASE
           WHEN T3.CUR_SHD_PAY_PRCP <> 0 THEN T1.PRCP_AMT / T3.CUR_SHD_PAY_PRCP
           ELSE NULL
         END PRCP_RTO --本金还款比例
        ,CASE
           WHEN T3.CUR_SHD_PAY_INTR <> 0 THEN ( T1.RCV_ACR_INTR_AMT + T1.CLCN_ACR_INTR_AMT + T1.RCV_OVD_INTR_AMT + T1.CLCN_OVD_INTR_AMT + T1.RCV_ACR_INTR_PNTY_AMT + T1.CLCN_ACR_INTR_PNTY_AMT + T1.RCV_INTR_PNTY_AMT + T1.CLCN_INTR_PNTY_AMT + T1.ACR_CMPD_INTR_AMT + T1.CMPD_INTR_AMT ) / T3.CUR_SHD_PAY_INTR
           ELSE NULL
         END INTR_RTO --利息还款比例
        ,CASE
           WHEN ( T3.CUR_SHD_PAY_PRCP + T3.CUR_SHD_PAY_INTR ) <> 0 THEN ( T1.PRCP_AMT + T1.RCV_ACR_INTR_AMT + T1.CLCN_ACR_INTR_AMT + T1.RCV_OVD_INTR_AMT + T1.CLCN_OVD_INTR_AMT + T1.RCV_ACR_INTR_PNTY_AMT + T1.CLCN_ACR_INTR_PNTY_AMT + T1.RCV_INTR_PNTY_AMT + T1.CLCN_INTR_PNTY_AMT + T1.ACR_CMPD_INTR_AMT + T1.CMPD_INTR_AMT ) / ( T3.CUR_SHD_PAY_PRCP + T3.CUR_SHD_PAY_INTR )
           ELSE NULL
         END TOT_RTO --总还款比例
FROM    tmp_feat_intn_ent_cst_dcbg_sample_dd T0
LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON      T0.cst_id = T2.cst_id
AND     T2.DT = '${date}'
LEFT JOIN    edw.dwd_bus_loan_trm_pmt_trx_dtl_di T1 --贷款期供交易明细表
ON      T1.DBIL_ID = T2.DBIL_ID
AND     T1.DT BETWEEN '${start_date}' AND '${date}' -- 上线时，date为跑数时间，start_date为date往前推12个月
AND     T1.RPAY_ACT_ID IS NOT NULL
AND     T1.RPAY_ACT_ID <> ''
LEFT JOIN    edw.dwd_bus_loan_rpay_pln_dd T3 --还款计划试算表
ON      T1.DBIL_ID = T3.DBIL_ID
AND     T1.CUR_TRM = T3.CUR_TRM
AND     T1.CUR_SUB_TRM = T3.CUR_SUB_TRM
AND     T3.DT = '${date}';SELECT  T0.cst_id
        ,T2.DBIL_ID
        ,T1.TRX_DT
        ,T1.SHD_PAY_DT --应还日期
        ,CASE
           WHEN T1.TRX_EVT = 'LN_TQHK' AND T1.TRX_DT = T1.SHD_PAY_DT THEN 'LN_ZCHK'
           WHEN T1.TRX_EVT = 'LN_YQHK' AND T1.TRX_DT = T1.SHD_PAY_DT THEN 'LN_ZCHK'
           ELSE T1.TRX_EVT
         END AS TRX_EVT --交易事件：提前还款LN_TQHK，正常还款LN_ZCHK，逾期还款LN_YQHK，核销归还LN_HXGH
        ,T1.PRCP_AMT PRCP_AMT --本金发生额
        ,T1.RCV_ACR_INTR_AMT + T1.CLCN_ACR_INTR_AMT + T1.RCV_OVD_INTR_AMT + T1.CLCN_OVD_INTR_AMT + T1.RCV_ACR_INTR_PNTY_AMT + T1.CLCN_ACR_INTR_PNTY_AMT + T1.RCV_INTR_PNTY_AMT + T1.CLCN_INTR_PNTY_AMT + T1.ACR_CMPD_INTR_AMT + T1.CMPD_INTR_AMT INTR_AMT --应收应计利息发生额,催收应计利息发生额,应收欠息发生额,催收欠息发生额,应收应计罚息发生额,催收应计罚息发生额,应收罚息发生额,催收罚息发生额,应计复息发生额,复息发生额
        ,CASE
           WHEN T1.TRX_EVT = 'LN_TQHK' THEN DATEDIFF(TO_DATE(T1.SHD_PAY_DT, 'yyyyMMdd'), TO_DATE(T1.TRX_DT, 'yyyyMMdd'), 'dd')
           ELSE NULL
         END TQHK_DAYS --提前还款天数
        ,CASE
           WHEN T1.TRX_EVT = 'LN_YQHK' THEN DATEDIFF(TO_DATE(T1.TRX_DT, 'yyyyMMdd'), TO_DATE(T1.SHD_PAY_DT, 'yyyyMMdd'), 'dd')
           ELSE NULL
         END YQHK_DAYS --逾期还款天数
        ,CASE
           WHEN T3.CUR_SHD_PAY_PRCP <> 0 THEN T1.PRCP_AMT / T3.CUR_SHD_PAY_PRCP
           ELSE NULL
         END PRCP_RTO --本金还款比例
        ,CASE
           WHEN T3.CUR_SHD_PAY_INTR <> 0 THEN ( T1.RCV_ACR_INTR_AMT + T1.CLCN_ACR_INTR_AMT + T1.RCV_OVD_INTR_AMT + T1.CLCN_OVD_INTR_AMT + T1.RCV_ACR_INTR_PNTY_AMT + T1.CLCN_ACR_INTR_PNTY_AMT + T1.RCV_INTR_PNTY_AMT + T1.CLCN_INTR_PNTY_AMT + T1.ACR_CMPD_INTR_AMT + T1.CMPD_INTR_AMT ) / T3.CUR_SHD_PAY_INTR
           ELSE NULL
         END INTR_RTO --利息还款比例
        ,CASE
           WHEN ( T3.CUR_SHD_PAY_PRCP + T3.CUR_SHD_PAY_INTR ) <> 0 THEN ( T1.PRCP_AMT + T1.RCV_ACR_INTR_AMT + T1.CLCN_ACR_INTR_AMT + T1.RCV_OVD_INTR_AMT + T1.CLCN_OVD_INTR_AMT + T1.RCV_ACR_INTR_PNTY_AMT + T1.CLCN_ACR_INTR_PNTY_AMT + T1.RCV_INTR_PNTY_AMT + T1.CLCN_INTR_PNTY_AMT + T1.ACR_CMPD_INTR_AMT + T1.CMPD_INTR_AMT ) / ( T3.CUR_SHD_PAY_PRCP + T3.CUR_SHD_PAY_INTR )
           ELSE NULL
         END TOT_RTO --总还款比例
FROM    tmp_feat_intn_ent_cst_dcbg_sample_dd T0
LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON      T0.cst_id = T2.cst_id
AND     T2.DT = '${date}'
LEFT JOIN    edw.dwd_bus_loan_trm_pmt_trx_dtl_di T1 --贷款期供交易明细表
ON      T1.DBIL_ID = T2.DBIL_ID
AND     T1.DT BETWEEN '${start_date}' AND '${date}' -- 上线时，date为跑数时间，start_date为date往前推12个月
AND     T1.RPAY_ACT_ID IS NOT NULL
AND     T1.RPAY_ACT_ID <> ''
LEFT JOIN    edw.dwd_bus_loan_rpay_pln_dd T3 --还款计划试算表
ON      T1.DBIL_ID = T3.DBIL_ID
AND     T1.CUR_TRM = T3.CUR_TRM
AND     T1.CUR_SUB_TRM = T3.CUR_SUB_TRM
AND     T3.DT = '${date}';
*/***顾烨鑫_SJ2024111596_质押贷款风险监测_简化.sql
﻿/*
简化版：
1. 取个人质押贷款业务（分为&ldquo;定e融&rdquo;、&ldquo;定融通&rdquo;两个产品，其中&ldquo;定e融&rdquo;是线上循环类产品）；
2. 时间范围，2023年至今客户质押贷款业务借据表中；
3. 筛选条件：同一个客户在30天内（或者同一个月内）发生4笔以上借据，且借据金额累计超过这些借据所对应的贷款合同金额的4倍以上；
4. 数据字段：客户号、客户姓名、客户合同号、业务或产品类型、合同金额、合同开始时间、（符合筛选条件范围）借据笔数统计、（符合筛选条件范围）借据金额累计、客户放款账号、客户还款账号、合同对应的质押物权证信息（包括权属关系、权属客户名称、权属质押账号）、管护机构号、管护机构名称、管护经理客户号、管护经理名称；
说明：①业务或产品类型，就是区分定e融、定融通；②信贷合同对应的质押物权属信息表，可能需要通过关联担保关系的中间表，来定位。
*/
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST2_01 AS
select t1.ctr_serno                              --合同流水号
    ,t1.rel_serno	                             --用信申请流水号
	,t1.cst_id                                   --客户号|C20
	,t1.cst_nm                                   --客户名称|C200
    ,t1.prd_no
    ,t2.PD_NM
    ,t1.prd_tag_nm
    ,case when t2.PD_NM regexp '定e融' then '定e融'
        when t1.prd_tag_nm RLIKE '定融通' then '定融通' else '' end as pd_cls
    ,t1.ctr_amt                                  --合同金额DECIMAL(21,2)
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
	,t1.ctr_bgn_dt                               --合同起始日期
	,t1.ctr_mtu_dt                               --合同到期日期
    ,t1.TMT_DT	                                 --终结日期
    ,t1.exec_intr_rat	                        --执行利率DECIMAL(13,7)
    ,t1.grnt_mod_colc	                        --担保方式集合
    ,case when t1.grnt_mod_colc	regexp '040' then 1 else 0 end as 担保方式集是否包含质押
    ,t1.ovd_amt	                                --逾期金额DECIMAL(21,2)
    ,t1.ovd_dt	                                --逾期日期
    ,t1.SYS_REG_DT	                            --系统登记日期 经办日期
    ,t1.dtrb_cst_act_id	    --	放款客户账号|c32
    ,t1.rpay_cst_act_id	    --	还款客户账号|c32
    ,t3.mgr_id	                                 --管户人工号|C10
    ,t3.mgr_nm	                                 --管户人姓名|C200
    ,t3.mgr_org_id	                             --管户机构号|C12
    ,t4.org_nm as mgr_org_nm
    ,t5.prm_mgr_id,t5.prm_mgr_nm,t5.prm_org_id
    ,t6.org_nm as prm_org_nm
    ,t7.fst_outacc_dt
    ,DATEDIFF(TO_DATE(t7.fst_outacc_dt, 'yyyyMMdd'), TO_DATE(T1.ctr_bgn_dt, 'yyyyMMdd'), 'dd') as 首次出账距起始日天数
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='20241120'
left join edw.dwd_bus_loan_ctr_mgr_inf_dd   t3 --信贷合同管护信息
on t1.ctr_serno=t3.ctr_serno
and t3.dt='20241120'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t3.mgr_org_id = t4.org_id
and t4.dt = '20241120'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t5 --客户`主管户`信息
on  t1.cst_id = t5.cst_id
and t5.dt = '20241120'
left join edw.dim_hr_org_mng_org_tree_dd            t6 --考核机构树
on  t5.prm_org_id = t6.org_id
and t6.dt = '20241120'
left join(
    SELECT ctr_serno,min(LVE_ACT_BGN_DT) as fst_outacc_dt
    from edw.dim_bus_loan_dbil_inf_dd       t1           --信贷借据信息
    where dt='20241120'
    GROUP BY ctr_serno
)t7 on t1.ctr_serno=t7.ctr_serno
where t1.dt='20241120'
and t1.ctr_bgn_dt >='20230101'
and (t2.PD_NM regexp '定e融' or t1.prd_tag_nm RLIKE '定融通')
;
-- 借据信息
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST2_02 AS
select t1.DBIL_ID                                --借据编号|C64
	,t1.OUT_ACC_SERNO                            --出账流水号|C32
	,t1.CTR_SERNO                                --合同流水号|C32
	,t1.CST_ID                                   --客户号|C20
	,t1.CST_NM                                   --客户名称|C200
	,t1.AMT                                      --金额DECIMAL(21,2)
	,t1.LVE_ACT_BGN_DT                           --出账起始日期|C8
	,t1.DTRB_ACT_ID                              --放款客户账号|C32 可通过存款账户判断账户类型
	,t1.RPAY_ACT_ID                              --还款客户账号|C32
from edw.dim_bus_loan_dbil_inf_dd       t1           --信贷借据信息
inner join SJXQ_SJ2024111596_CST2_01    t2
on t1.CTR_SERNO=t2.CTR_SERNO
and DATEDIFF(TO_DATE(t1.LVE_ACT_BGN_DT, 'yyyyMMdd'), TO_DATE(T2.fst_outacc_dt, 'yyyyMMdd'), 'dd') between 0 and 30 --30日内借据
where t1.dt='20241120'
;
--担保合同
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST2_03 AS
select t1.ctr_serno                                --合同流水号|c32
	,t2.grnt_ctr_no                              --担保合同编号|c32
	,t2.thstm_ocp_grnt_lmt                       --本次占用担保额度|decimal
	,t2.ocp_seq                                  --占用顺序|bigint
	,t2.grnt_ctr_typ_cd                          --担保合同类型代码|c3
	,t2.busi_typ_cd                              --业务类型代码1贷款业务2信用卡业务|c1
	,t2.eff_sts_cd                               --生效状态代码|c1
from SJXQ_SJ2024111596_CST2_01              t1
left join edw.dwd_bus_loan_ctr_rel_grnt_dd  t2 --主合同、担保合同关系
on t1.ctr_serno=t2.ctr_serno
and t2.dt='20241120'
;
-- 担保合同押品
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST2_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST2_04 AS
select t1.grnt_ctr_no                              --担保合同编号|c32
	,t2.cltr_no                                  --押品编号|c32
	,t2.cltr_nm                                  --押品名称|c200
	,t2.cltr_typ_cd                              --押品类型代码|c7
	,t2.obg_id                                   --权利人编号|c20
	,t2.obg_nm                                   --权利人名称|c200
	,t2.afm_val                                  --认定价值|decimal
	,t2.cltr_hgst_can_grnt_amt                   --押品最高可担保金额|decimal
	,t2.ccy_cd                                   --币种代码|c3
	,t2.wrnt_no                                  --权证编号|c128
from (
    SELECT DISTINCT grnt_ctr_no
    from SJXQ_SJ2024111596_CST2_03
)t1 left join edw.dim_bus_loan_grnt_ctr_mort_pldg_dd    t2 --担保合同抵质押信息
on t1.grnt_ctr_no=t2.grnt_ctr_no
and t2.dt='20241120'
AND t2.eff_sts_cd = '1' --已生效
left join edw.dim_bus_loan_cltr_bas_inf_dd              t3 --押品基本信息
on t2.cltr_no=t3.cltr_no
and t3.dt='20241120'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST2_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST2_05 AS
SELECT  t1.ctr_serno        AS 合同流水号
        ,t1.cst_id          AS 客户号
        ,t1.cst_nm          AS 客户名称
        ,t1.PD_NM           AS 产品名称
        ,t1.pd_cls          AS 贷款业务
        ,t1.ctr_amt         AS 合同金额
        ,t1.ctr_bal         AS 合同余额
        ,t1.ctr_bgn_dt      AS 合同起始日期
        ,t1.ctr_mtu_dt      AS 合同到期日期
        ,t2.LVE_ACT_BGN_DT  as 首次出账日期
        ,t1.首次出账距起始日天数
        ,t2.DBIL_cnt        as 借据笔数_首次出账30日内
        ,t2.DBIL_amt        as 借据金额_首次出账30日内
        ,round(t2.DBIL_amt/t1.ctr_amt,2) as 借据总金额为合同金额倍数
        ,t1.dtrb_cst_act_id AS 放款客户账号
        ,t1.rpay_cst_act_id AS 还款客户账号
        ,t3.押品名称
        ,t3.权利人
        ,t3.权证编号
        ,t1.mgr_id          AS 信贷管护机构号
        ,t1.mgr_nm          AS 信贷管护机构名称
        ,t1.mgr_org_id      AS 信贷管护经理客户号
        ,t1.mgr_org_nm      AS 信贷管护经理名称
        ,t1.prm_mgr_id      AS 主管护机构号
        ,t1.prm_mgr_nm      AS 主管护机构名称
        ,t1.prm_org_id      AS 主管护经理客户号
        ,t1.prm_org_nm      AS 主管护经理名称
from SJXQ_SJ2024111596_CST2_01  t1
left join(
    SELECT CTR_SERNO
        ,min(LVE_ACT_BGN_DT)        as LVE_ACT_BGN_DT
        ,count(distinct DBIL_ID)    as DBIL_cnt
        ,sum(amt)                   as DBIL_amt
    from SJXQ_SJ2024111596_CST2_02
    GROUP BY CTR_SERNO
)t2 on t1.ctr_serno=t2.CTR_SERNO
left join(
    SELECT t1.ctr_serno
    from SJXQ_SJ2024111596_CST2_03      t1
    left join SJXQ_SJ2024111596_CST2_04 t2
    on t1.grnt_ctr_no=t2.grnt_ctr_no
    group by t1.ctr_serno
)t3 on t1.ctr_serno=t3.CTR_SERNO
where t2.DBIL_cnt>=4
-- and t2.DBIL_amt>=4*ctr_amt
;
SELECT '01' seq,count(1) as cnt,count(DISTINCT ctr_serno) as custs
from SJXQ_SJ2024111596_CST2_01
union all
SELECT '02' seq,count(1) as cnt,count(DISTINCT ctr_serno) as custs
from SJXQ_SJ2024111596_CST2_02
union all
SELECT '03' seq,count(1) as cnt,count(DISTINCT ctr_serno,grnt_ctr_no) as custs
from SJXQ_SJ2024111596_CST2_03
union all
SELECT '04' seq,count(1) as cnt,count(DISTINCT grnt_ctr_no,cltr_no) as custs
from SJXQ_SJ2024111596_CST2_04
union all
SELECT '05' seq,count(1) as cnt,count(DISTINCT 合同流水号) as custs
from SJXQ_SJ2024111596_CST2_05
;
SELECT *
from SJXQ_SJ2024111596_CST2_05
/*
01	1319	1319
02	1824	1197
03	1744	1741
04	2232	2068
05	1319	1319
select 'dwd_bus_loan_ctr_rel_grnt_dd' as tbl_nm
    ,count(1) as cnt
    ,count(DISTINCT ctr_serno) as 合同流水号
    ,count(DISTINCT grnt_ctr_no) as 担保合同编号
    ,count(DISTINCT ctr_serno,grnt_ctr_no) as 合同流水号担保合同编号
from edw.dwd_bus_loan_ctr_rel_grnt_dd         --主合同、担保合同关系
where DT = '20241120'
;cnt	合同流水号	担保合同编号	合同流水号担保合同编号
5822353	5377787	4226086	5822353
select 'dim_bus_loan_grnt_ctr_mort_pldg_dd' as tbl_nm
    ,count(1) as cnt
    ,count(DISTINCT grnt_ctr_no) as 担保合同编号
    ,count(DISTINCT grnt_ctr_no,cltr_no) as 担保合同编号押品编号
from edw.dim_bus_loan_grnt_ctr_mort_pldg_dd   --担保合同抵质押信息
where DT = '20241120'
;cnt	担保合同编号	担保合同编号押品编号
181787	146014	181787
select 'dim_bus_loan_cltr_bas_inf_dd' as tbl_nm
    ,count(1) as cnt
    ,count(DISTINCT cltr_no) as 押品编号
from edw.dim_bus_loan_cltr_bas_inf_dd         --押品基本信息
where DT = '20241120'
;cnt	担保合同编号
112019	112019
*/
***顾烨鑫_SJ2024111596_质押贷款风险监测_简化1204.sql
-- 截至2024年11月30日，我行未结清个人质押贷款余额。然后按押品类型，分层共计下余额
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST3_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST3_01 AS
select t1.ctr_serno                                --合同流水号|c32
    ,max(case when t3.cltr_typ_cd like 'A%' then 1 else 0 end) as is_a_cltr --押品类型
from  edw.dwd_bus_loan_ctr_rel_grnt_dd  t1 --主合同、担保合同关系
left join edw.dim_bus_loan_grnt_ctr_mort_pldg_dd    t3 --担保合同抵质押信息
on t1.grnt_ctr_no=t3.grnt_ctr_no
and t3.dt='20241130'
AND t3.eff_sts_cd = '1' --已生效
left join edw.dwd_code_library_dd           c1  --132058 tbl_nm,fld_nm,cd_val 唯一
on t3.cltr_typ_cd = c1.cd_val
and c1.dt='20241130'
where t1.dt='20241130'
group by t1.ctr_serno
;
DROP   TABLE IF     EXISTS SJXQ_SJ2024111596_CST3_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024111596_CST3_02 AS
select t1.ctr_serno                              --合同流水号
    ,case when t1.grnt_mod_colc regexp '040' then 1 else 0 end as is_zy
    ,case when (t2.PD_NM regexp '定e融' or t1.prd_tag_nm RLIKE '定融通') then 1 else 0 end as is_sel
	,t1.ctr_bal                                  --合同余额DECIMAL(21,2)
    ,t1.CTR_STS_CD,t1.TMT_DT,t1.CTR_MTU_DT
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    ,case when  ( ( t1.CTR_STS_CD IN ( '2' , '4' )  --, '1' , '未生效' , '2' , '已生效' , '3' , '终止' , '4' , '冻结' , '5' , '作废'
        AND     t1.TMT_DT = '18991231'
            OR t1.CTR_BAL > 0 ) then 1 else 0 end as is_notmtu --未到期未终结口径
    ,t4.cltr_typ_nm,t4.is_a_cltr
    ,t6.brc_org_nm
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
left join edw.dim_bus_loan_prd_frml_dd      t2
on t1.prd_no=t2.prd_no
and t2.dt='20241130'
inner join edw.dws_cst_idv_bas_inf_dd       t3 --个人客户基本信息汇总表
on t1.cst_id=t3.cst_id
and t3.dt='20241130'
left join SJXQ_SJ2024111596_CST3_01         t4
on t1.ctr_serno=t4.ctr_serno
left join edw.dim_hr_org_mng_org_tree_dd    t6 --考核机构树
on  t1.mgr_org_id = t6.org_id
and t6.dt = '20241130'
where t1.dt='20241130'
and t6.cpy_org_id='999999998'   --不含村行
;
-- 数据验证
SELECT brc_org_nm,sum(ctr_bal) as ctr_bal
from SJXQ_SJ2024111596_CST3_02
GROUP BY brc_org_nm
;
SELECT is_notmtu,is_vld,count(1) cnt
    ,sum(ctr_bal) as ctr_bal
from SJXQ_SJ2024111596_CST3_02
GROUP BY is_notmtu,is_vld
;
SELECT *
from SJXQ_SJ2024111596_CST3_02
where is_notmtu=1
and is_vld=0
;
/*
数据需求：（1）截至2024年11月30日，我行未结清个人质押贷款的贷款余额。说明：质押的押品类型是我行存单、理财产品，不包括商标、摊位等其他押品。
（2）截至2024年11月30日，我行未结清个人&quot;定融通&quot;、&ldquo;定e融&rdquo;贷款的贷款余额。
（3）两个统计口径：①均不含村行的数据；②均是针对个人客户，不含企业客户的业务；
*/
select sum(case when is_zy=1 and is_a_cltr=1 then ctr_bal else 0 end)/10000 as 截至2024年11月30日未结清个人质押贷款余额_剔村行_A类押品
    ,sum(case when is_sel=1 then ctr_bal else 0 end)/10000 as 截至2024年11月30日未结清个人定融通定e融贷款余额_剔村行_A类押品
from SJXQ_SJ2024111596_CST3_02
where is_vld=1      --合同生效定义
;
***鲁豪杰_SJ20241129146_绍兴分行信贷数据.sql
/*
截止10月31日，绍兴分行所有客户在我行的授信敞口，及其同一风险控制号在我行的合计授信敞口
数据需求字段
客户号，客户姓名，我行敞口金额，同一风险控制号，同一风险控制号下我行合计授信敞口
*/
--合同基础信息
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST_01 AS
select t1.ctr_serno                              --合同流水号
	,t1.cst_id                                   --客户号
	,t1.cst_nm                                   --客户名称
	,t1.ctr_amt                                  --合同金额
	,t1.ctr_bal                                  --合同余额
    ,t1.ctr_epsr_amt	                         --合同敞口金额|decimal(21,2)
    ,t1.mgr_id	        --管户人工号
    ,t3.empe_nm         as mgr_nm	    --管户人
    ,t1.mgr_org_id	    --管户机构号
    ,t4.brc_org_nm,t4.sbr_org_nm,t4.tem_org_nm,t4.org_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
inner join edw.dim_bus_loan_prd_frml_dd     t2
on t1.prd_no=t2.prd_no
and t2.dt='20241031'
and t2.PD_NM not regexp '信用卡'
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20241031'
left join edw.dim_hr_org_mng_org_tree_dd   t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20241031'
left join edw.DWS_CST_BAS_INF_DD        t5
on t1.cst_id=t5.cst_id
and t5.dt='20241031'
where t1.dt='20241031'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST_02 AS
SELECT  t1.cst_id          AS 客户号
       ,t1.cst_nm          AS 客户名称
       ,t1.sbr_org_nm      AS 信贷管户支行
       ,t1.ctr_epsr_amt    AS 客户合同敞口金额
       ,t1.sam_rsk_ctrl_id AS 同一风险控制号
       ,t2.ctr_epsr_amt    AS 同一风险控制号下我行合计授信敞口
from(
    select cst_id                                 --客户号
        ,cst_nm                                   --客户名称
        ,sbr_org_nm
        ,sam_rsk_ctrl_id
        ,sum(nvl(ctr_epsr_amt,0)) as ctr_epsr_amt --合同敞口金额|decimal(21,2)
    from SJXQ_SJ20241129146_CST_01 t1
    where brc_org_nm='绍兴分行'
    group by cst_id ,cst_nm ,sbr_org_nm ,sam_rsk_ctrl_id
)T1 left join (
    SElECT sam_rsk_ctrl_id,sum(nvl(ctr_epsr_amt,0)) as ctr_epsr_amt
    from SJXQ_SJ20241129146_CST_01
    group by sam_rsk_ctrl_id
)t2 on t1.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129146_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241129146_CST_02
;
SElECT '02' seq, *
from SJXQ_SJ20241129146_CST_02
***鲁豪杰_SJ20241129146_绍兴分行信贷数据20231231.sql
/*
截止10月31日，绍兴分行所有客户在我行的授信敞口，及其同一风险控制号在我行的合计授信敞口
数据需求字段
客户号，客户姓名，我行敞口金额，同一风险控制号，同一风险控制号下我行合计授信敞口
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST3_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST3_01 AS
select t1.cst_id
    ,count(1) as mgr_cnt
from edw.dwd_bus_loan_ctr_mgr_inf_dd 		t1 --信贷合同`管户`信息
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20231231'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20231231'
where t1.dt='20231231'
and t1.mgr_org_id like '3307%'
group by t1.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST3_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST3_02 AS
SELECT  t1.cst_id
    ,t1.cny_facl_lmt    --授信额度
    ,t1.cny_epsr_lmt    --敞口额度
    ,t1.lmt_sts	        --额度状态
    ,t5.cst_chn_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
FROM    edw.loan_lmt_exmp           t1
left join edw.DWS_CST_BAS_INF_DD    t5
on t1.cst_id=t5.cst_id
and t5.dt='20231231'
WHERE T1.DT='20231231'
and t1.del_ind='0'
-- and t1.lmt_sts='01'    --,'01','正常','02','冻结','03','终止'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST3_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST3_03 AS
SELECT  t1.cst_id           AS 客户号
        ,t2.cst_chn_nm      AS 客户名称
        ,t2.cny_facl_lmt1    AS 正常授信额度汇总
        ,t2.cny_epsr_lmt1    AS 正常敞口额度汇总
        ,t2.cny_facl_lmt2    AS 冻结授信额度汇总
        ,t2.cny_epsr_lmt2    AS 冻结敞口额度汇总
        ,t2.cny_facl_lmt3    AS 终止授信额度汇总
        ,t2.cny_epsr_lmt3    AS 终止敞口额度汇总
        ,t2.sam_rsk_ctrl_id AS 同一风险控制号
        ,t3.cny_facl_lmt1    AS 同一风险控制号下正常授信额度汇总
        ,t3.cny_epsr_lmt1    AS 同一风险控制号下正常敞口额度汇总
        ,t3.cny_facl_lmt2    AS 同一风险控制号下冻结授信额度汇总
        ,t3.cny_epsr_lmt2    AS 同一风险控制号下冻结敞口额度汇总
        ,t3.cny_facl_lmt3    AS 同一风险控制号下终止授信额度汇总
        ,t3.cny_epsr_lmt3    AS 同一风险控制号下终止敞口额度汇总
        ,t1.sbr_org_id      AS 管户支行号
        ,t1.sbr_org_nm      AS 管户支行
        ,t1.tem_org_nm      AS 管户团队
        ,t1.mgr_nm          AS 管户客户经理
from SJXQ_SJ20241129146_CST3_01 T1
inner join (
    SELECT cst_id,cst_chn_nm,sam_rsk_ctrl_id
        ,sum(case when lmt_sts='01' then cny_facl_lmt else 0 end) as cny_facl_lmt1
        ,sum(case when lmt_sts='01' then cny_epsr_lmt else 0 end) as cny_epsr_lmt1
        ,sum(case when lmt_sts='02' then cny_facl_lmt else 0 end) as cny_facl_lmt2
        ,sum(case when lmt_sts='02' then cny_epsr_lmt else 0 end) as cny_epsr_lmt2
        ,sum(case when lmt_sts='03' then cny_facl_lmt else 0 end) as cny_facl_lmt3
        ,sum(case when lmt_sts='03' then cny_epsr_lmt else 0 end) as cny_epsr_lmt3
    from SJXQ_SJ20241129146_CST3_02
    GROUP BY cst_id,cst_chn_nm,sam_rsk_ctrl_id
)t2 on t1.cst_id=t2.cst_id
left join (
    SELECT sam_rsk_ctrl_id
        ,sum(case when lmt_sts='01' then cny_facl_lmt else 0 end) as cny_facl_lmt1
        ,sum(case when lmt_sts='01' then cny_epsr_lmt else 0 end) as cny_epsr_lmt1
        ,sum(case when lmt_sts='02' then cny_facl_lmt else 0 end) as cny_facl_lmt2
        ,sum(case when lmt_sts='02' then cny_epsr_lmt else 0 end) as cny_epsr_lmt2
        ,sum(case when lmt_sts='03' then cny_facl_lmt else 0 end) as cny_facl_lmt3
        ,sum(case when lmt_sts='03' then cny_epsr_lmt else 0 end) as cny_epsr_lmt3
    from SJXQ_SJ20241129146_CST3_02
    GROUP BY sam_rsk_ctrl_id
)t3 on t2.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129146_CST3_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129146_CST3_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241129146_CST3_03
;
SElECT *
from SJXQ_SJ20241129146_CST3_03
;
/*
01	214974	214974
02	1520007	1160700
03	36427	36427
*/
***鲁豪杰_SJ20241129146_绍兴分行信贷数据20250106.sql
﻿/*
截止10月31日，绍兴分行所有客户在我行的授信敞口，及其同一风险控制号在我行的合计授信敞口
数据需求字段
客户号，客户姓名，我行敞口金额，同一风险控制号，同一风险控制号下我行合计授信敞口
*/
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST2_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST2_01 AS
select t1.cst_id
    ,count(1) as mgr_cnt
from edw.dim_cst_mng_loan_mgr_dd            t1 --信贷客户管户信息
left join edw.dws_hr_empe_inf_dd            t3 --员工信息汇总
on  t1.mgr_id=t3.empe_id
and t3.dt='20241231'
left join edw.dim_hr_org_mng_org_tree_dd    t4 --考核机构树
on  t1.mgr_org_id = t4.org_id
and t4.dt = '20241231'
where t1.dt='20241231'
and t1.mgr_org_id like '3307%'
group by t1.cst_id
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST2_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST2_02 AS
SELECT  t1.cst_id
    ,t1.cny_facl_lmt    --授信额度
    ,t1.cny_epsr_lmt    --敞口额度
    ,t1.lmt_sts	        --额度状态
    ,t5.cst_chn_nm
    ,case when nvl(t5.SAM_RSK_CTRL_ID,'')='' then t1.cst_id else t5.sam_rsk_ctrl_id end sam_rsk_ctrl_id
FROM    edw.loan_lmt_exmp           t1
left join edw.DWS_CST_BAS_INF_DD    t5
on t1.cst_id=t5.cst_id
and t5.dt='20241231'
WHERE T1.DT='20241231'
and t1.del_ind='0'
-- and t1.lmt_sts='01'    --,'01','正常','02','冻结','03','终止'
;
-- 输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ20241129146_CST2_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241129146_CST2_03 AS
SELECT  t1.cst_id           AS 客户号
        ,t2.cst_chn_nm      AS 客户名称
        ,t2.cny_facl_lmt1    AS 正常授信额度汇总
        ,t2.cny_epsr_lmt1    AS 正常敞口额度汇总
        ,t2.cny_facl_lmt2    AS 冻结授信额度汇总
        ,t2.cny_epsr_lmt2    AS 冻结敞口额度汇总
        ,t2.cny_facl_lmt3    AS 终止授信额度汇总
        ,t2.cny_epsr_lmt3    AS 终止敞口额度汇总
        ,t2.sam_rsk_ctrl_id AS 同一风险控制号
        ,t3.cny_facl_lmt1    AS 同一风险控制号下正常授信额度汇总
        ,t3.cny_epsr_lmt1    AS 同一风险控制号下正常敞口额度汇总
        ,t3.cny_facl_lmt2    AS 同一风险控制号下冻结授信额度汇总
        ,t3.cny_epsr_lmt2    AS 同一风险控制号下冻结敞口额度汇总
        ,t3.cny_facl_lmt3    AS 同一风险控制号下终止授信额度汇总
        ,t3.cny_epsr_lmt3    AS 同一风险控制号下终止敞口额度汇总
        ,t1.sbr_org_id      AS 管户支行号
        ,t1.sbr_org_nm      AS 管户支行
        ,t1.tem_org_nm      AS 管户团队
        ,t1.mgr_nm          AS 管户客户经理
from SJXQ_SJ20241129146_CST2_01 T1
inner join (
    SELECT cst_id,cst_chn_nm,sam_rsk_ctrl_id
        ,sum(case when lmt_sts='01' then cny_facl_lmt else 0 end) as cny_facl_lmt1
        ,sum(case when lmt_sts='01' then cny_epsr_lmt else 0 end) as cny_epsr_lmt1
        ,sum(case when lmt_sts='02' then cny_facl_lmt else 0 end) as cny_facl_lmt2
        ,sum(case when lmt_sts='02' then cny_epsr_lmt else 0 end) as cny_epsr_lmt2
        ,sum(case when lmt_sts='03' then cny_facl_lmt else 0 end) as cny_facl_lmt3
        ,sum(case when lmt_sts='03' then cny_epsr_lmt else 0 end) as cny_epsr_lmt3
    from SJXQ_SJ20241129146_CST2_02
    GROUP BY cst_id,cst_chn_nm,sam_rsk_ctrl_id
)t2 on t1.cst_id=t2.cst_id
left join (
    SELECT sam_rsk_ctrl_id
        ,sum(case when lmt_sts='01' then cny_facl_lmt else 0 end) as cny_facl_lmt1
        ,sum(case when lmt_sts='01' then cny_epsr_lmt else 0 end) as cny_epsr_lmt1
        ,sum(case when lmt_sts='02' then cny_facl_lmt else 0 end) as cny_facl_lmt2
        ,sum(case when lmt_sts='02' then cny_epsr_lmt else 0 end) as cny_epsr_lmt2
        ,sum(case when lmt_sts='03' then cny_facl_lmt else 0 end) as cny_facl_lmt3
        ,sum(case when lmt_sts='03' then cny_epsr_lmt else 0 end) as cny_epsr_lmt3
    from SJXQ_SJ20241129146_CST2_02
    GROUP BY sam_rsk_ctrl_id
)t3 on t2.sam_rsk_ctrl_id=t3.sam_rsk_ctrl_id
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129146_CST2_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241129146_CST2_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241129146_CST2_03
;
SElECT *
from SJXQ_SJ20241129146_CST2_03
;
/*
01	214974	214974
02	1520007	1160700
03	36427	36427
*/
***鲁雨_SJ20241125121_信贷客户数据.sql
﻿/*
需求1：开业以来贷款流失及全款贷款客户余额较最高峰下降的企业和个体工商户，数据可截止至11.24日
需求2：在我行查过征信但是未授用信的企业和个体工商户，时间截止11月24日即可
数据内容
明确数据日期，数据范围，以及取数口径等；例如，截止xx日期，xx分行xx数据；
开业以来贷款流失及全款贷款客户余额较最高峰下降的企业和个体工商户，在我行查过征信但是未授用信的企业和个体工商户
数据需求字段
需求1字段：客户号、主管客户经理、主管机构支行名称、是否已流失、最高峰贷款余额、目前贷款余额、客户类型、是否小微企业主、是否个体工商户
需求2字段：客户号、主管客户经理、主管机构支行名称、我行首次查询征信时间、我行最近查询征信时间、征信查询类型、客户类型、是否小微企业主、是否个体工商户
问题：
贷款流失：全量信贷客户剔除 未到期未终结客户
全款贷款客户余额较最高峰下降：当前贷款余额 小于 最高峰贷款余额？
未授用信：没有贷款合同的客户？是
*/
--贷款流失：全量信贷客户剔除 未到期未终结客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_01 AS
SElECT t1.cst_id
from(
    select distinct t1.cst_id
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20241124'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20241124'
)t1 left join(
    select distinct t1.cst_id
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20241124'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20241124'
    --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
    AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
    AND     t1.TMT_DT = '18991231'
        OR t1.CTR_BAL > 0 ) --未到期未终结口径
)t2 on t1.cst_id =t2.cst_id
where t2.cst_id is null     --剔除未到期未终结客户
;
-- 贷款余额下降客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_02 AS
SElECT t1.cst_id,t1.dt
    ,t1.ctr_bal as max_ctr_bal
    ,t2.ctr_bal
    ,t2.cst_typ_cd
    ,c1.cd_val_dscr     as cst_typ_nm
from(
    SElECT cst_id,dt,ctr_bal
        ,row_number() over(partition by cst_id order by ctr_bal desc,dt desc) rn
    from(
        select t1.dt,t1.cst_id,sum(ctr_bal) ctr_bal
        from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
        inner join edw.dim_bus_loan_prd_frml_dd     t2
        on t1.prd_no=t2.prd_no
        and t2.dt='20241124'
        and t2.PD_NM not regexp '信用卡'
        where t1.dt<='20241124'
        group by t1.dt,t1.cst_id
    )t1
)t1 left join(
    select t1.cst_id,t1.cst_typ_cd,sum(ctr_bal) ctr_bal
    from edw.dim_bus_loan_ctr_bse_inf_dd        t1 --合同基础信息
    inner join edw.dim_bus_loan_prd_frml_dd     t2
    on t1.prd_no=t2.prd_no
    and t2.dt='20241124'
    and t2.PD_NM not regexp '信用卡'
    where t1.dt='20241124'
    group by t1.cst_id,t1.cst_typ_cd
)t2 on t1.cst_id=t2.cst_id
left join edw.dwd_code_library_dd           c1
on t2.cst_typ_cd = c1.cd_val
and c1.dt = '20241124'
where t1.rn=1   --最高余额
;
-- 输出结果1
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_03 AS
SELECT  t1.cst_id                        AS 客户号
    ,concat(t3.prm_mgr_id,t3.prm_mgr_nm) AS 主管客户经理
    ,t4.sbr_org_nm                       AS 主管机构支行名称
    ,CASE WHEN t2.cst_id is not null THEN '是'  ELSE '' END AS 是否已流失
    ,t1.max_ctr_bal                      AS 最高峰贷款余额
    ,t1.dt                               AS 最高峰贷款余额最近日期
    ,T1.ctr_bal                          AS 目前贷款余额
    ,t1.cst_typ_nm                       AS 客户类型
    ,t7.indiv_bsn_owr_ind                AS 个体工商户主标志
    ,t7.sme_owr_ind                      AS 小微企业主标志
from SJXQ_SJ20241125121_CST_02      t1
left join SJXQ_SJ20241125121_CST_01 t2
on t1.cst_id=t2.cst_id
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241124'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241124'
inner JOIN edw.loan_cst_indiv_ind   T7 --个人客户标识信息
ON      T1.cst_id = T7.cst_id
AND     T7.DT = '20241124'
AND     T7.del_ind <> '1' --删除标识
and     (t7.indiv_bsn_owr_ind='1' or t7.sme_owr_ind='1')
where t4.brc_org_nm regexp '陕西旬阳泰隆村镇银行'
and (t2.cst_id is not null or t1.ctr_bal<t1.max_ctr_bal)
;
--历史查询征信客户
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_04 AS
select cst_id
    ,min(report_dt)     as min_report_dt
    ,max(report_dt)     as max_report_dt
from(
    select cst_id,report_dt	--报告日期
    from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
    where dt='20241124'
    union all
    select cst_id,report_dt	--报告日期
    from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
    where dt='20241124'
)t group by cst_id
;
-- 另一种口径征信
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_05 AS
SELECT  coalesce(SUBSTR(a.customer_id,1,10),b.cst_id) AS cst_id
       ,a.query_time                                  --查询时间
       ,a.qry_reason                                  --查询原因
       ,a.query_type                                  --数字解读标志（0-非数字解读，2-数字解读）
FROM edw.ncip_cpq_resultinfo AS a
LEFT JOIN
(
	SELECT  DOC_NBR
	       ,MAX(CST_ID) AS CST_ID
	FROM edw.DIM_CST_BAS_DOC_INF_DD
	WHERE DT = '20241124'
	GROUP BY  DOC_NBR
) AS b
ON a.cert_no = b.doc_nbr
WHERE a.dt <= '20241124'
AND a.ERROR_INFO = '查询成功'
UNION
SELECT  DISTINCT COALESCE(SUBSTR(T1.customer_id,1,10),T4.CST_ID,C1.CST_ID,C2.CST_ID,C3.CST_ID,C4.CST_ID,C5.CST_ID) as cst_id
       ,T1.query_time
       ,T1.qry_reason	--查询原因
       ,T1.query_type	--数字解读标志（0-非数字解读，2-数字解读）
FROM edw.ncip_ceq_resultinfo T1 --企业信用报告查询记录
LEFT JOIN
(
	SELECT  'ZHONGZHENGMA'  AS DOC_TYP_CD --无此证件类型
	       ,LOANCARDNO      AS DOC_NBR
	       ,MAX(CUSTOMERID) AS CST_ID
	FROM edw.LOAN_CUSTOMER_INFO
	WHERE DT = '20241124'
	GROUP BY  LOANCARDNO
) T4
ON T1.loancard_code = T4.DOC_NBR
LEFT JOIN edw.DIM_CST_BAS_DOC_INF_DD C1
ON T1.US_CREDIT_CODE = C1.DOC_NBR AND C1.DOC_TYP_CD = 'A0100' --统一社会信用代码
 AND C1.DT = '20241124'
LEFT JOIN edw.DIM_CST_BAS_DOC_INF_DD C2
ON T1.COPR_CODE = C2.DOC_NBR AND C2.DOC_TYP_CD = 'A0200' --组织机构代码
 AND C2.DT = '20241124'
LEFT JOIN edw.DIM_CST_BAS_DOC_INF_DD C3
ON T1.ORG_CREDIT_CODE = C3.DOC_NBR AND C3.DOC_TYP_CD = 'A2200' --机构信用代码
 AND C3.DT = '20241124'
LEFT JOIN edw.DIM_CST_BAS_DOC_INF_DD C4
ON T1.GS_REGI_CODE = C4.DOC_NBR AND C4.DOC_TYP_CD = 'A1400' --国税
 AND C4.DT = '20241124'
LEFT JOIN edw.DIM_CST_BAS_DOC_INF_DD C5
ON T1.DS_REGI_CODE = C5.DOC_NBR AND C5.DOC_TYP_CD = 'A1500' --地税
 AND C5.DT = '20241124'
WHERE T1.DT <= '20241124'
AND T1.ERROR_INFO = '查询成功'
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_06 AS
SElECT CST_ID
    ,min(query_time) as min_report_dt
    ,max(query_time) as max_report_dt
from SJXQ_SJ20241125121_CST_05
group by CST_ID
;
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_07 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_07 AS
select cst_id,report_dt	--报告日期
    ,qry_rsn	--查询原因
    ,'个人' as cst_type
from edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
where dt='20241124'
and report_dsc_rn=1
union all
select cst_id,report_dt	--报告日期
    ,qry_rsn	--查询原因
    ,'企业'
from edw.dws_cst_ccrc_entp_ind_inf_dd --企业征信指标信息表
where dt='20241124'
and report_dsc_rn=1
;
-- 输出结果2
DROP   TABLE IF     EXISTS SJXQ_SJ20241125121_CST_08 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ20241125121_CST_08 AS
SELECT  t1.cst_id                           AS 客户号
       ,concat(t3.prm_mgr_id,t3.prm_mgr_nm) AS 主管客户经理
       ,t4.sbr_org_nm                       AS 主管机构支行名称
       ,t1.min_report_dt                    AS 我行首次查询征信时间
       ,t1.max_report_dt                    AS 我行最近查询征信时间
    --    ,t5.report_dt                        as 我行最近查询征信时间2
       ,t5.qry_rsn                          as 最近查询原因
       ,t5.cst_type                         AS 客户类型
       ,t7.indiv_bsn_owr_ind                AS 个体工商户主标志
       ,t7.sme_owr_ind                      AS 小微企业主标志
from SJXQ_SJ20241125121_CST_04      t1
left join SJXQ_SJ20241125121_CST_02 t2
on t1.cst_id=t2.cst_id
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd   t3 --客户`主管户`信息
on  t1.cst_id = t3.cst_id
and t3.dt = '20241124'
left join edw.dim_hr_org_mng_org_tree_dd            t4 --考核机构树
on  t3.prm_org_id = t4.org_id
and t4.dt = '20241124'
left join SJXQ_SJ20241125121_CST_07                 t5
on t1.CST_ID=t5.CST_ID
inner JOIN edw.loan_cst_indiv_ind   T7 --个人客户标识信息
ON      T1.cst_id = T7.cst_id
AND     T7.DT = '20241124'
AND     T7.del_ind <> '1' --删除标识
and     (t7.indiv_bsn_owr_ind='1' or t7.sme_owr_ind='1')
where t2.cst_Id is null     -- 未授用信
and t4.brc_org_nm regexp '陕西旬阳泰隆村镇银行'
;
SElECT '01' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241125121_CST_01
union all
SElECT '02' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241125121_CST_02
union all
SElECT '03' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241125121_CST_03
union all
SElECT '04' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241125121_CST_04
union all
SElECT '05' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241125121_CST_05
union all
SElECT '06' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241125121_CST_06
union all
SElECT '07' seq, count(1) cnt,count(distinct cst_id) custs
from SJXQ_SJ20241125121_CST_07
union all
SElECT '08' seq, count(1) cnt,count(distinct 客户号) custs
from SJXQ_SJ20241125121_CST_08
;
SElECT '08' seq, *
from SJXQ_SJ20241125121_CST_08