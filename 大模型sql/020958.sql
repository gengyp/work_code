**01-数据需求_保全_2024_D0506_王凯燕_债务人法院执行信息.sql
--字段：执行案号、对应案件的执行金额、执行总金额
--执行标的 = 执行总金额
--执行金额 = 执行标的 - 未履行
--edw.nout_fay_total_main --法研总案件主表
--edw.nout_fay_various_details --各类案件详情

---4,结果表
DROP TABLE IF EXISTS fayuanzhixingxinxi0507_03 PURGE;

CREATE TABLE IF NOT EXISTS fayuanzhixingxinxi0507_03 AS
SELECT  DISTINCT f.COL_1 债务人名称
                 ,f.COL_2 债务人身份证号
                 ,f.COL_3 统一社会信用代码
                 ,f.COL_4 地址
                 ,COALESCE(p.fvd_c_ah, p1.fvd_c_ah) 执行案号
                 --,COALESCE(p.fvd_d_larq,p1.fvd_d_larq) 执行时间_最近
                 ,COALESCE(p.fvd_n_sqzxbdje, p1.fvd_n_sqzxbdje) 执行标的
                 ,COALESCE(p.fvd_n_sjdwje,p1.fvd_n_sjdwje) 执行金额
                 --,COALESCE(p.fvd_n_wzxje, p1.fvd_n_wzxje) 未执行金额
                -- ,COALESCE(p.fvd_n_sqzxbdje, p1.fvd_n_sqzxbdje) - COALESCE(p.fvd_n_wzxje, p1.fvd_n_wzxje) 执行金额
FROM    (
            SELECT  DISTINCT *
            FROM    lab_bigdata_dev.qbi_file_20240507_15_55_51 --导入的债务人信息
            WHERE   pt = MAX_PT('lab_bigdata_dev.qbi_file_20240507_15_55_51')
        ) f
LEFT JOIN    (
                 SELECT  t.ftm_flowno --客户号
                         ,t.ftm_namecn --企业名称
                         ,t0.fvd_c_ah --案号
                         --,max(t0.fvd_d_larq) as  fvd_d_larq --立案时间
                         ,t0.fvd_n_sqzxbdje --申请执行标的金额
                          ,nvl(t0.fvd_n_sjdwje,0) as fvd_n_sjdwje --实际到位金额
                         --,t0.fvd_n_wzxje --未执行金额
                 FROM    edw.nout_fay_total_main t --法研总案件主表
                 LEFT JOIN    edw.nout_fay_various_details t0 --各类案件详情
                 ON      t.ftm_flowno = t0.fvd_flowno
                 AND     t0.dt <= '@@{yyyyMMdd}'
                 AND     t0.fvd_n_sqzxbdje IS NOT NULL
                 WHERE   t.dt <= '@@{yyyyMMdd}'
                 group  by t.ftm_flowno --客户号
                         ,t.ftm_namecn --企业名称
                         ,t0.fvd_c_ah --案号
                        ,t0.fvd_n_sqzxbdje --申请执行标的金额
                        ,t0.fvd_n_sjdwje
                     --   ,t0.fvd_n_wzxje --未执行金额
             ) p
ON      p.ftm_flowno = MD5(f.COL_2) -- 个人，用客户号匹配
LEFT JOIN    (
                 SELECT  t.ftm_flowno --客户号
                         ,t.ftm_namecn --企业名称
                         ,t0.fvd_c_ah --案号
                         --,max(t0.fvd_d_larq) as  fvd_d_larq   --立案时间
                         ,t0.fvd_n_sqzxbdje --申请执行标的金额
                         ,nvl(t0.fvd_n_sjdwje,0) as fvd_n_sjdwje --实际到位金额
                         --,t0.fvd_n_wzxje --未执行金额
                 FROM    edw.nout_fay_total_main t --法研总案件主表
                 LEFT JOIN    edw.nout_fay_various_details t0 --各类案件详情
                 ON      t.ftm_flowno = t0.fvd_flowno
                 AND     t0.dt <= '@@{yyyyMMdd}'
                 AND     t0.fvd_n_sqzxbdje IS NOT NULL
                 WHERE   t.dt <= '@@{yyyyMMdd}'
                group  by t.ftm_flowno --客户号
                         ,t.ftm_namecn --企业名称
                         ,t0.fvd_c_ah --案号
                        ,t0.fvd_n_sqzxbdje --申请执行标的金额
                        ,t0.fvd_n_sjdwje
                        --,t0.fvd_n_wzxje --未执行金额
             ) p1
ON      f.COL_1 = p1.ftm_namecn   --对公，用企业名称匹配;
;




--SELECT  * FROM fayuanzhixingxinxi0507_03 WHERE 债务人名称='王武江'
**01-数据需求_保全_2024_D0506_郑一峰_逾期客户账户余额.sql
--截至目前所有在我行有逾期业务的客户账户的余额,逾期口径：本金逾期天数大于0
--字段：止付编号	账户号	客户编号	客户名称	证件类型	证件号码	当前账户余额
--关联业务合同号/卡号	合同到期日	合同金额	合同余额	应收利息	罚息	复息	关联业务借款人	客户性质	备注	管户人工号	管户人	信贷管户机构号	信贷管户机构

--自动止付&amp; 手动止付清单
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_001 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_001 AS
SELECT  DISTINCT --o.serialno 流水号
                 -- o.stoppaymentno  止付申请流水号,
                 -- o.relievestoppaymentno  解止付申请流水号,
                 -- o.accountserialno  账户流水号,
                 o.controlno 止付编号
                ,CASE
                    WHEN SA.STOPTYPE = '01' THEN '自动止付'
                    WHEN SA.STOPTYPE = '02' THEN '手动止付'
                  END AS 止付类型
                 ,sac.accountno 账户
                 ,case when sac.accountno = bc.paybackaccount then '1' else '0' end as 是否还款账户
                 ,o.customerid 客户编号
                 ,o.customername 客户姓名
                 ,SA.certtype  证件类型
                 ,SA.certid 证件号码
                 ,CASE
                    WHEN o.stoprole = '1' THEN '借款人'
                    WHEN o.stoprole = '2' THEN '担保人'
                  END AS 客户角色 --[1.借款人 2.担保人]
                 --,least(nvl(o.STOPSUM, 0), NVL(NVL(SAC.Balance, '0') * h.AVG_PRC / h.QUO_UNT, '0')) 实际止付金额
                 --,o.stopsum 控制金额 --按人民币）,
                 ,o.stopreturn 备注
                 --,sac.balance 当前账户余额
                 -- o.stopstatus  止付状态,  --00-待发送,10-成功,2010-交易超时,2020-交易异常,2030-业务异常,
                 -- o.stoptime  止付时间,
                 -- o.relievestatus  解止付状态,  --00-待发送,10-成功,2010-交易超时,2020-交易异常,2030-业务异常,
                 -- o.relievetime  解止付时间,
                 --,SA.stopdate 止付日期
                 ,bc.customerid 关联业务借款人
                 ,SA.customername 关联业务借款人名称
                 ,o.objectno 业务流水号   ---busi_ctr_id
                 ,CASE
                    WHEN o.objecttype = 'BusinessContract' THEN '贷款合同/随贷通卡'
                    WHEN o.objecttype = 'CreditCard'       THEN '信用卡'
                  END AS 业务类型 --BusinessContract 贷款合同/随贷通卡 CreditCard 信用卡,
                 ,bc.businesssum 合同金额
                 ,bc.balance 合同余额
                 ,BC.maturity 合同到期日
                 ,CB.userid 管户人工号    --用户
                 ,t.empe_nm 管护人姓名
                 ,CB.orgid 信贷管户机构号  --机构
                 ,jg.org_nm 信贷管户机构名称
FROM    edw.loan_stoppayment_inventory O  --止付清单
LEFT JOIN
( SELECT SERIALNO
         ,accountno
         ,balance
         ,ROW_NUMBER() over(partition by accountno order by SERIALNO desc ) as rn
  FROM  edw.loan_stoppayment_account    --引入账号记录
  WHERE dt='@@{yyyyMMdd}'
)SAC
ON      O.ACCOUNTSERIALNO = SAC.SERIALNO     --账户流水号和流水号关联
-- AND     SAC.dt = '@@{yyyyMMdd}'
and sac.rn=1
LEFT JOIN    edw.loan_stoppayment_apply SA   --止付申请
ON      O.stoppaymentno = SA.serialno  --止付申请流水号和流水号关联
AND     SA.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_customer_belong CB   --客户所属列表
ON      SA.CUSTOMERID = CB.CUSTOMERID
AND     CB.dt = '@@{yyyyMMdd}'
AND     CB.BELONGATTRIBUTE = '1'   --客户主管护
LEFT JOIN    edw.loan_business_contract BC   --业务合同表
ON      bc.serialno = o.objectno      --业务流水号关联
AND     BC.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD h --汇率信息
-- ON      SAC.Currency = h.CCY_CD
-- AND     h.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd jg --机构树_考核维度
ON      CB.orgid = jg.org_id
AND     jg.DT = '@@{yyyyMMdd}'
left join edw.dim_hr_empe_bas_inf_dd t    --员工基本信息表
on CB.userid=t.empe_id
AND     t.DT = '@@{yyyyMMdd}'
-- left join edw.dim_bus_crd_cr_crd_act_inf_dd crd ---信用卡账户信息
-- ON      o.objectno  = crd.cr_crd_act_id
-- AND     crd.DT = '@@{yyyyMMdd}'
WHERE   O.dt = '@@{yyyyMMdd}'
-- and jg.brc_org_id='330699999'  --丽水分行
;

-----贷款，应收利息	罚息	复息
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_002 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_002 AS
select t0.cst_id
,t0.busi_ctr_id
,t0.apnt_start_dt
,t0.apnt_mtu_dt
,sum(rcv_acr_intr)	应收应计利息
,sum(rcv_acr_intr_pnty) 应收应计罚息
,sum(rcv_intr_pnty)	应收罚息
,sum(cmpd_intr)	复息
from edw.dim_bus_loan_ctr_inf_dd t0  --信贷合同信息
left join edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
on t0.busi_ctr_id=t1.bus_ctr_id   --业务合同编号关联
and t1.dt='@@{yyyyMMdd}'
and t1.ovd_day>0   --逾期天数大于0
-- and sum(t1.ovd_amt)>0
where t0.dt='@@{yyyyMMdd}'
and t0.cst_id is not null
group by t0.cst_id,t0.busi_ctr_id,t0.apnt_start_dt,t0.apnt_mtu_dt
order by t0.cst_id,t0.busi_ctr_id,t0.apnt_start_dt,t0.apnt_mtu_dt
;

-----信用卡，应收利息	罚息	复息
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_003 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_003 AS
select  distinct t0.cst_id,t0.cr_crd_act_id
,t0.busi_ctr_id ---业务合同编号|C32
,t0.busi_apl_id
,t1.rcv_intr	应收利息
,t1.intr_pnty_bal	罚息余额
from edw.dim_bus_crd_cr_crd_inf_dd t0   --信用卡卡片信息
left join edw.dim_bus_crd_cr_crd_act_inf_dd t1   --信用卡账户信息
on t0.cr_crd_act_id=t1.cr_crd_act_id
and t1.dt='@@{yyyyMMdd}'
--and sum(t1.ovd_amt)>0   信用卡逾期最高期数>0
and t1.ovd_hi_trm >0
where t0.dt='@@{yyyyMMdd}'
and t0.cst_id<>''
;

---合并
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_004 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_004 AS
select distinct
--t1.流水号
t1.止付编号
,t1.止付类型
,t1.账户
,t1.是否还款账户
,t1.客户编号
,t1.客户姓名
,t1.客户角色
,t1.证件类型
,concat(substr(t1.证件号码,1,5),'******',substr(t1.证件号码,12,18)) as 证件号码
--,p2.cur_act_bal 当前账户余额
--,t1.实际止付金额
--,t1.控制金额
,t1.备注
--,t1.当前账户余额
--,t1.止付日期
,t1.关联业务借款人
,t1.关联业务借款人名称
,t1.业务流水号
,t1.业务类型
,t1.合同金额
,t1.合同余额
,t1.合同到期日
,case when t1.业务类型='贷款合同/随贷通卡' then t2.应收应计利息
      when t1.业务类型='信用卡' then t3.应收利息
      end as 应收利息
,case when t1.业务类型='贷款合同/随贷通卡' then t2.应收应计罚息
    when t1.业务类型='信用卡' then t3.罚息余额
    end as 应收应计罚息
,case when t1.业务类型='贷款合同/随贷通卡' then t2.复息
    end as 复息
,t1.管户人工号
,t1.管护人姓名
,t1.信贷管户机构号
,t1.信贷管户机构名称
from  lab_bigdata_dev.data_request_zhengyifeng_20240506_001 t1
left join lab_bigdata_dev.data_request_zhengyifeng_20240506_002 t2
on t1.业务流水号=t2.busi_ctr_id
left join lab_bigdata_dev.data_request_zhengyifeng_20240506_003 t3
on t1.业务流水号=t3.busi_ctr_id


-- --结果表，取存款账户的账户余额
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_005 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_005 AS
SELECT p1.*
       ,p2.cur_act_bal as 当前账户余额
from lab_bigdata_dev.data_request_zhengyifeng_20240506_004 p1
LEFT JOIN
(   SELECT cst_act_id
           ,sum(cur_act_bal) as cur_act_bal
    from edw.dws_bus_dep_act_inf_dd  --存款账户信息汇总
    where dt='@@{yyyyMMdd}'
    GROUP BY cst_act_id
) p2
ON p1.账户=p2.cst_act_id
;

--SELECT * FROM lab_bigdata_dev.data_request_zhengyifeng_20240506_005  WHERE 账户='6214808801012336786'










-- --增加逾期条件

-- -----贷款，应收利息	罚息	复息
-- DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_002_02 PURGE;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_002_02 AS
-- select t0.cst_id
-- ,t0.busi_ctr_id
-- ,t0.apnt_start_dt
-- ,t0.apnt_mtu_dt
-- ,sum(rcv_acr_intr)	应收应计利息
-- ,sum(rcv_acr_intr_pnty) 应收应计罚息
-- ,sum(rcv_intr_pnty)	应收罚息
-- ,sum(cmpd_intr)	复息
-- from edw.dim_bus_loan_ctr_inf_dd t0  --信贷合同信息
-- left join edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
-- on t0.busi_ctr_id=t1.bus_ctr_id   --业务合同编号关联
-- and t1.dt='@@{yyyyMMdd}'
-- where t0.dt='@@{yyyyMMdd}'
-- and t0.cst_id is not null
-- group by t0.cst_id,t0.busi_ctr_id,t0.apnt_start_dt,t0.apnt_mtu_dt
-- having sum(t1.ovd_amt)>0 and max(t1.ovd_day)>0
-- order by t0.cst_id,t0.busi_ctr_id,t0.apnt_start_dt,t0.apnt_mtu_dt
-- ;

-- --SELECT * from  lab_bigdata_dev.data_request_zhengyifeng_20240506_002_02

-- -----信用卡，应收利息	罚息	复息
-- DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_003_03 PURGE;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_003_03 AS
-- select   t0.cst_id,t0.cr_crd_act_id
-- ,t0.busi_ctr_id ---业务合同编号|C32
-- ,t0.busi_apl_id
-- ,t1.rcv_intr	应收利息
-- ,t1.intr_pnty_bal	罚息余额
-- from edw.dim_bus_crd_cr_crd_inf_dd t0   --信用卡卡片信息
-- left join edw.dim_bus_crd_cr_crd_act_inf_dd t1   --信用卡账户信息
-- on t0.cr_crd_act_id=t1.cr_crd_act_id
-- and t1.dt='@@{yyyyMMdd}'
-- where t0.dt='@@{yyyyMMdd}'
-- and t0.cst_id<>''
-- GROUP BY t0.cst_id,t0.cr_crd_act_id
-- ,t0.busi_ctr_id
-- ,t0.busi_apl_id
-- ,t1.rcv_intr
-- ,t1.intr_pnty_bal
-- having sum(t1.ovd_amt)>0 and max(t1.ovd_hi_trm)>1
-- ;

-- ---结果表
-- DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_004_04 PURGE;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_20240506_004_04 AS
-- select distinct
-- --t1.流水号
-- t1.止付编号
-- ,t1.止付类型
-- ,t1.止付账户
-- ,t1.是否还款账户
-- ,t1.客户编号
-- ,t1.客户姓名
-- ,t1.客户角色
-- ,t1.证件类型
-- ,concat(substr(t1.证件号码,1,5),'******',substr(t1.证件号码,12,18)) as 证件号码
-- --,t1.实际止付金额
-- --,t1.控制金额
-- ,t1.备注
-- ,t1.截止5月7日账户余额
-- --,t1.止付日期
-- ,t1.关联业务借款人
-- ,t1.关联业务借款人名称
-- ,t1.业务流水号
-- ,t1.业务类型
-- ,t1.合同金额
-- ,t1.合同余额
-- ,t1.合同到期日
-- ,case when t1.业务类型='贷款合同/随贷通卡' then t2.应收应计利息
--       when t1.业务类型='信用卡' then t3.应收利息
--       end as 应收利息
-- ,case when t1.业务类型='贷款合同/随贷通卡' then t2.应收应计罚息
--     when t1.业务类型='信用卡' then t3.罚息余额
--     end as 应收应计罚息
-- ,case when t1.业务类型='贷款合同/随贷通卡' then t2.复息
--     end as 复息
-- ,t1.管户人工号
-- ,t1.管护人姓名
-- ,t1.信贷管户机构号
-- ,t1.信贷管户机构名称
-- from  lab_bigdata_dev.data_request_zhengyifeng_20240506_001 t1
-- left join lab_bigdata_dev.data_request_zhengyifeng_20240506_002_02 t2
-- on t1.业务流水号=t2.busi_ctr_id
-- left join lab_bigdata_dev.data_request_zhengyifeng_20240506_003_03 t3
-- on t1.业务流水号=t3.busi_ctr_id
-- ;

-- SELECT count(*) FROM lab_bigdata_dev.data_request_zhengyifeng_20240506_004_04 WHERE 止付编号 is not NULL

-- SELECT count(*) FROM lab_bigdata_dev.data_request_zhengyifeng_20240506_004 WHERE 止付编号 is not NULL
**01-数据需求_保全_2024_D0508_张颖_信用卡逾期客户存款账户余额.sql
--字段：客户号	客户账号（即借记卡账号）	账户余额	冻结状态	冻结金额	金额控制标志	封闭控制标志	只收不付标志	止付不收标志	止付原因	账户状态
--只取账户余额大于0

--edw.core_kdpb_dngjdj--负债账户冻结登记簿；或edw.dwd_bus_dep_frz_inf_dd --存款账户冻结登记簿
--edw.core_kdpa_kehuzh---客户账号表；或edw.dim_bus_dep_cst_act_inf_dd T3 --客户存款账户信息；
--edw.core_kdpl_donjmx  ---账户冻结明细，donjjibe=0，xzhileix in（金额止付/只付不收/只收不付/封闭冻结）
--edw.core_kdpa_yuexxi--负债账户余额信息表
--edw.core_kdpa_zhxinx  --负债账户信息表ljdonjje

--只收不付或者封闭冻结，取负债账户信息表的zhhuyuee
--只付不收或金额冻结，取负债账户余额信息表的

--客户账号层就取edw.core_kdpa_kehuzh

--**************************************
-- SELECT DISTINCT xzhileix from edw.core_kdpl_donjmx  WHERE dt='20240510' ---账户冻结明细
-- ;
-- SELECT * FROM edw.dwd_code_library_dd WHERE dt='20240510' AND tbl_nm=upper('core_kdpl_donjmx')  AND fld_nm=upper('xzhileix') ;

SELECT * FROM lab_bigdata_dev.tmp_xyk_yq_20240509_999;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_yq_20240509 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_xyk_yq_20240509 AS
SELECT  T3.cst_act_nm       AS 客户姓名
        ,T1.客户号
        ,T3.cst_act_id      AS 客户账号
        ,T2.账户余额
        ,CASE
           WHEN T11.是否冻结 = 1 THEN '是'
           ELSE '否'
         END                AS 冻结状态
        ,T13.T13
        -- ,T3.act_amt_frz_ind AS 账户金额冻结标志
        -- ,T3.act_cls_frz_ind AS 账户封闭冻结标志
        -- ,T3.act_rcv_oly_ind AS 账户只收不付标志
        -- ,T3.act_pay_oly_ind AS 账户只付不收标志
        ,T11.冻结种类
        ,CASE
           WHEN T11.是否止付 = 1 THEN '是'
           ELSE '否'
         END                AS 是否止付
        ,T11.止付类型
        ,T11.止付原因
        ,T12.cd_val_dscr    AS 账户状态
FROM    lab_bigdata_dev.tmp_xyk_yq_20240508_1500_01 T1 --导入的客户号
LEFT JOIN    (
                 SELECT  cst_act_id
                         ,cst_id
                         ,SUM(gl_bal) AS 账户余额
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY cst_act_id , cst_id
                  HAVING 账户余额 > 0
             ) T2
ON      T1.客户号 = T2.cst_id
LEFT JOIN    edw.dim_bus_dep_cst_act_inf_dd T3 --客户存款账户信息
ON      T2.cst_act_id = T3.cst_act_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  cst_act_id
                         ,MAX(CASE
                                WHEN A1.FRZ_SRC_CD = '1' THEN 1
                                ELSE 0
                              END)                                 AS 是否冻结
                         ,MAX(CASE
                                WHEN A1.FRZ_SRC_CD = '2' THEN 1
                                ELSE 0
                              END)                                 AS 是否止付
                         ,WM_CONCAT(DISTINCT '||', B2.cd_val_dscr) AS 冻结种类
                         ,WM_CONCAT(DISTINCT '||', CASE
                                                     WHEN A1.FRZ_SRC_CD = '2' THEN A11.cd_val_dscr
                                                   END)            AS 止付类型
                         ,WM_CONCAT(DISTINCT '||', CASE
                                                     WHEN A1.FRZ_SRC_CD = '2' THEN A1.frz_rsn
                                                   END)            AS 止付原因
                 FROM    edw.dwd_bus_dep_frz_inf_dd A1 --存款账户冻结登记簿
                 LEFT JOIN    edw.dwd_code_library_dd A11 --码值表  账户止付类型|C10
                 ON      A1.ACT_STOP_PMT_TYP_CD = A11.cd_val
                 AND     A11.tbl_nm = 'DWD_BUS_DEP_FRZ_INF_DD'
                 AND     A11.fld_nm = 'ACT_STOP_PMT_TYP_CD'
                 AND     A11.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_code_library_dd B2 --码值表  冻结种类代码|C2
                 ON      A1.frz_cls_cd = B2.cd_val
                 AND     B2.tbl_nm = 'DWD_BUS_DEP_FRZ_INF_DD'
                 AND     B2.fld_nm = 'FRZ_CLS_CD'
                 AND     B2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 --   AND     A1.FRZ_SRC_CD IN ( '2' ) --控制即止付
                 AND     A1.NFRZ_IND = '0' --解冻标志 ，尚未解冻
                 GROUP BY cst_act_id
             ) T11 --账户止付登记
ON      T2.cst_act_id = T11.cst_act_id
LEFT JOIN    edw.dwd_code_library_dd T12 --码值表  账户状态
ON      T3.act_sts_cd = T12.cd_val
AND     T12.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     T12.fld_nm = 'ACT_STS_CD'
AND     T12.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
            SELECT  A1.kehuzhao
			,SUM(CASE WHEN A3.cd_val_dscr IN ('只收不付','封闭冻结') THEN A1.zhhuyuee
			          WHEN A3.cd_val_dscr IN ('金额冻结','只付不收') THEN A4.ljdonjje
				  END ) AS 冻结金额
				--,WM_CONCAT(DISTINCT '||',A3.cd_val_dscr) AS 限制类型
                 FROM    edw.core_kdpa_zhxinx A1  --负债账户信息表
	         LEFT JOIN    edw.core_kdpl_donjmx A2  --账户冻结明细
                 ON      A1.zhanghao = A2.zhanghao
                 AND    A2.jiluztai ='0'  --记录状态
	         AND     A2.donjjibe='0'  --冻结级别
                 AND     A2.jiedonbz='0'   --解冻标志
                 AND     A2.dt = '@@{yyyyMMdd}'
                 left JOIN edw.core_kdpa_yuexxi A4  --     --负债账户余额信息表
                 ON    A2.zhanghao=A4.zhanghao
                 AND     A4.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_code_library_dd A3 --码值表  账户止付类型|C10
                 ON      A1.xzhileix = A3.cd_val
                 AND     A3.tbl_nm = 'KDPB_PLDLMX'
                 AND     A3.fld_nm = 'XZHILEIX'
                 AND     A3.dt = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.kehuzhao
             ) T13
ON      T2.cst_act_id = T13.kehuzhao;


--SELECT * FROM lab_bigdata_dev.tmp_xyk_yq_20240509 WHERE 客户账号='6221410000315791'






--冻结来源代码|C1
-- 1	冻结
-- 2	控制即止付
-- 3	其他

--账户止付类型|C10
-- 01	证件到期止付
-- 02	信贷风险止付
-- 03	外汇监管止付
-- 04	洗钱风险止付
-- 05	有权机构止付
-- 06	存单质押止付
-- 07	柜面差错止付
-- 08	账户管理止付
-- 09	产品约定止付
-- 10	客户申请止付
-- 11	账户风险止付
-- 13	睡眠户止付
-- 99	其他止付

--冻结种类代码|C2
-- 10	启用不收不付控制
-- 11	金额冻结
-- 12	只收不付
-- 13	封闭冻结
-- 21	验资止付
-- 22	保证控制
-- 23	只付不收控制
-- 24	差错临控
-- 25	止付控制
-- 26	其他金额控制
-- 27	封闭控制
-- 28	理财申购控制
-- 29	电子国债申购控制
-- 30	证明控制
-- 31	预授权
-- 32	金额控制（不可超额）
-- 33	启用控制
-- 34	只收不付控制
-- 35	质押控制
-- 36	放贷控制
-- 37	受托控制
-- 38	贴现控制
-- 39	额度控制
-- 40	睡眠户封闭控制
-- 41	认购控制
-- 42	廉政账户控制
-- 43	金额控制（可超额）
-- 44	身份未核查控制
-- 45	挂失只收不付控制
-- 46	挂失封闭控制
-- 47	证件到期控制
-- 48	ATM延迟转账
**01-数据需求_保全_2024_D0509_张颖_信用卡客户催收记录.sql
-- 催收日期、合同号/卡号、客户名称、催收对象、联系人姓名、催收方式、催收人员、登记人、登记时间、催记渠道、状态、是否有附件

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_20240509_1730_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_20240509_1730_01
-- (
--     客户姓名                 STRING
--    ,需要调取催记的信用卡卡号 STRING
--    ,文件夹                   STRING
-- ) ;



--第一个文件夹
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj11 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj11 AS
SELECT
        T1.需要调取催记的信用卡卡号
        ,T1.文件夹
        ,T1.客户姓名
        ,T2.coln_date         AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm          AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
        else ''
         END 催收对象
        ,T2.contact_name	    AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no AS 催收人员编号行内
        ,T2.coln_user AS 催收人员名称行内
        ,T2.out_person AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date          AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
		   WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
      --   ,CASE
      --      WHEN t2.collect_status = '01' THEN '承诺还款'
      --      WHEN t2.collect_status = '02' THEN '谈判中'
      --      WHEN t2.collect_status = '05' THEN '其他'
      --      WHEN t2.collect_status = '03' THEN '转告还款'
      --      WHEN t2.collect_status = '04' THEN '无法触达'
      --      ELSE ''
      --    END 催收状态
        ,CASE
           WHEN file_id is not null THEN '是'
           ELSE '否'
         END                AS 是否有附件
FROM    lab_bigdata_dev.tmp_xyk_cs_20240509_1730_01 T1  --导入信用卡客户
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.需要调取催记的信用卡卡号 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
WHERE   T1.文件夹='第一个文件夹'
;


--SELECT * from lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj11 WHERE 客户名称='林兴虎'


--第二个文件夹
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj21 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj21 AS
SELECT
        T1.需要调取催记的信用卡卡号
        ,T1.文件夹
        ,T1.客户姓名
        ,T2.coln_date         AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm          AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
        else ''
         END 催收对象
        ,T2.contact_name	    AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no AS 催收人员编号行内
        ,T2.coln_user AS 催收人员名称行内
        ,T2.out_person AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date          AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
		   WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
      --   ,CASE
      --      WHEN t2.collect_status = '01' THEN '承诺还款'
      --      WHEN t2.collect_status = '02' THEN '谈判中'
      --      WHEN t2.collect_status = '05' THEN '其他'
      --      WHEN t2.collect_status = '03' THEN '转告还款'
      --      WHEN t2.collect_status = '04' THEN '无法触达'
      --      ELSE ''
      --    END 状态
        ,CASE
           WHEN file_id is not null THEN '是'
           ELSE '否'
         END                AS 是否有附件
FROM    lab_bigdata_dev.tmp_xyk_cs_20240509_1730_01 T1  --导入信用卡客户
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.需要调取催记的信用卡卡号 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
WHERE   T1.文件夹='第二个文件夹'
;


--SELECT * from lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj21 WHERE 客户名称='程红星'

--第三个文件夹
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj31 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj31 AS
SELECT
        T1.需要调取催记的信用卡卡号
        ,T1.文件夹
        ,T1.客户姓名
        ,T2.coln_date         AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm          AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
        else ''
         END 催收对象
        ,T2.contact_name	    AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no AS 催收人员编号行内
        ,T2.coln_user AS 催收人员名称行内
        ,T2.out_person AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date          AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
		   WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
      --   ,CASE
      --      WHEN t2.collect_status = '01' THEN '承诺还款'
      --      WHEN t2.collect_status = '02' THEN '谈判中'
      --      WHEN t2.collect_status = '05' THEN '其他'
      --      WHEN t2.collect_status = '03' THEN '转告还款'
      --      WHEN t2.collect_status = '04' THEN '无法触达'
      --      ELSE ''
      --    END 状态
        ,CASE
           WHEN file_id is not null THEN '是'
           ELSE '否'
         END                AS 是否有附件
FROM    lab_bigdata_dev.tmp_xyk_cs_20240509_1730_01 T1  --导入信用卡客户
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.需要调取催记的信用卡卡号 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
WHERE   T1.文件夹='第三个文件夹'
;


--SELECT * from lab_bigdata_dev.tmp_xyk_cs_20240509_1730_02_wj31 WHERE 客户名称='胡梦佳'
**01-数据需求_保全_2024_D0509_梁世鹏_信贷客户风险成本数据.sql
--字段：本金余额-20231231	pd-20231231	lgd-20231231	风险成本-20231231
--本金余额-20240430	pd_20240430	lgd_20240430	风险成本_20240430


-----*******************存量风险贷款与信用卡********************************************************************
--2023年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20231231_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20231231_01 AS
SELECT    DISTINCT     p.COL_1 管户分行
               ,p.COL_2 借据流水号_卡号
               ,p.COL_3 业务类型
               ,t.term_end_prcp_bal 本金余额_20231231
               ,t.term_end_pd pd值_20231231
               ,t.term_end_lgd lgd值_20231231
               ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20231231
FROM  lab_bigdata_dev.qbi_file_20240515_17_58_39  p
left join adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
on p.COL_2=t.term_end_dbil_srl_no
and    t.dt = '20231231'
WHERE p.pt=MAX_PT('lab_bigdata_dev.qbi_file_20240515_17_58_39')
;


-- 2024年4月30日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20240430_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20240430_01 AS
SELECT       DISTINCT  p.COL_1 管户分行
               ,p.COL_2 借据流水号_卡号
               ,p.COL_3 业务类型
               ,t.term_end_prcp_bal 本金余额_20240430
               ,t.term_end_pd pd值_20240430
               ,t.term_end_lgd lgd值_20240430
               ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20240430
FROM  lab_bigdata_dev.qbi_file_20240515_17_58_39  p
left join adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
on p.COL_2=t.term_end_dbil_srl_no
and    t.dt = '20240430'
WHERE p.pt=MAX_PT('lab_bigdata_dev.qbi_file_20240515_17_58_39')
;


--结果表1：存量风险贷款与信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_0515_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_0515_01 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.业务类型
       ,t1.本金余额_20231231
       ,t1.pd值_20231231
       ,t1.lgd值_20231231
       ,t1.应提风险成本_20231231
       ,t2.本金余额_20240430
       ,t2.pd值_20240430
       ,t2.lgd值_20240430
       ,t2.应提风险成本_20240430
from lab_bigdata_dev.tmp_baoquan_SJ2024050806_20231231_01 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024050806_20240430_01 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

---*******************公司化业务***************************************************************************************

--2023年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20231231_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20231231_02 AS
SELECT    DISTINCT     p.COL_1 管户分行
               ,p.COL_2 借据流水号_卡号
               ,t.term_end_prcp_bal 本金余额_20231231
               ,t.term_end_pd pd值_20231231
               ,t.term_end_lgd lgd值_20231231
               ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20231231
FROM  lab_bigdata_dev.qbi_file_20240515_18_27_56  p
left join adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
on p.COL_2=t.term_end_dbil_srl_no
and    t.dt = '20231231'
WHERE p.pt=MAX_PT('lab_bigdata_dev.qbi_file_20240515_18_27_56')
;


-- 2024年4月30日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20240430_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_20240430_02 AS
SELECT       DISTINCT  p.COL_1 管户分行
               ,p.COL_2 借据流水号_卡号
               ,t.term_end_prcp_bal 本金余额_20240430
               ,t.term_end_pd pd值_20240430
               ,t.term_end_lgd lgd值_20240430
               ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20240430
FROM  lab_bigdata_dev.qbi_file_20240515_18_27_56  p
left join adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
on p.COL_2=t.term_end_dbil_srl_no
and    t.dt = '20240430'
WHERE p.pt=MAX_PT('lab_bigdata_dev.qbi_file_20240515_18_27_56')
;


--结果表2:公司化业务
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_0515_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024050806_0515_02 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.本金余额_20231231
       ,t1.pd值_20231231
       ,t1.lgd值_20231231
       ,t1.应提风险成本_20231231
       ,t2.本金余额_20240430
       ,t2.pd值_20240430
       ,t2.lgd值_20240430
       ,t2.应提风险成本_20240430
from lab_bigdata_dev.tmp_baoquan_SJ2024050806_20231231_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024050806_20240430_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;


--SELECT count(*) FROM lab_bigdata_dev.tmp_baoquan_SJ2024050806_0515_02
**01-数据需求_保全_2024_D0514_叶宇_客户催收走访记录.sql
--用途：
--用于分析往年业务走访覆盖情况。因客户经理、资产保全人员信息不对称，为避免重复走访，提高走访效率，现申请数据需求，查看哪些已经走访过了，哪些未走过，以便更好安排走访计划。
--催收痕迹，截至最新数据，丽水分行&ldquo;催收日期&rdquo;在2023年和2024年的数据
--字段：数据日期、业务流水号、合同号/卡号、客户号、催收日期、催收方式、催收地点、登记日期、更新日期、催收人员编号(行内)、登记人

DROP TABLE IF EXISTS lab_bigdata_dev.cyf_tmp_SJ202301_20241231 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.cyf_tmp_SJ202301_20241231 AS
SELECT  DISTINCT '@@{yyyyMMdd}' 数据日期
                 ,t1.busi_no 业务流水号
                 ,t1.cont_card_no 合同号或卡号
                 ,t1.cust_no 客户号
                 ,t1.coln_date 催收日期
                 ,CASE
                    WHEN t1.coln_way = '20' THEN '债务拆分'
                    WHEN t1.coln_way = '14' THEN 'AI催收'
                    WHEN t1.coln_way = '07' THEN '诉讼'
                    WHEN t1.coln_way = '17' THEN '分期还款'
                    WHEN t1.coln_way = '99' THEN '其他'
                    WHEN t1.coln_way = '03' THEN '催收电子邮件'
                    WHEN t1.coln_way = '13' THEN '律师函催收'
                    WHEN t1.coln_way = '04' THEN '电话录音催收'
                    WHEN t1.coln_way = '19' THEN '重组'
                    WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
                    WHEN t1.coln_way = '08' THEN '公安立案'
                    WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
                    WHEN t1.coln_way = '18' THEN '利息减免'
                    WHEN t1.coln_way = '02' THEN '催收短信'
                    WHEN t1.coln_way = '11' THEN '现场催收'
                    WHEN t1.coln_way = '01' THEN '催收通知书'
                    WHEN t1.coln_way = '16' THEN '催收函'
                    WHEN t1.coln_way = '09' THEN '报纸公告'
                    WHEN t1.coln_way = '06' THEN '上门催收'
                    ELSE ''
                  END 催收方式
                 ,case
                  when t1.coln_place='01' THEN '行内'
                  when t1.coln_place='02' THEN '借款人家'
                  when t1.coln_place='03' THEN '担保人家'
                  when t1.coln_place='04' THEN '借款人工作场所'
                  when t1.coln_place='05' THEN ' 担保人工作场所'
                  when t1.coln_place='06' THEN ' 法院'
                  else '其他'
                  end as 催收地点
                 ,t1.input_date 登记日期
                 ,t1.update_date 更新日期
                 ,t1.coln_usr_no 催收人员编号_行内
                 ,t1.input_usr_no 登记人
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3306%' --丽水分行
AND     substr(t1.coln_date, 1, 4) IN ( '2023' , '2024' );



SELECT * FROM lab_bigdata_dev.cyf_tmp_SJ202301_20241231


--催收地点
-- 01     行内
-- 02     借款人家
-- 03     担保人家
-- 04     借款人工作场所
-- 05     担保人工作场所
-- 06     法院
-- 99     其它
**01-数据需求_保全_2024_D0516_吴伟_用于内部呆账核销管理_业务筛选.sql
-- 四个数据需求，数据范围均为全行（不含村行），数据日期为截至2024年5月16日。
-- 1、合同余额大于0的个人经营性贷款。
-- 取数口径：情况1：产品编号以201050102开头；2情况：产品编号以2010503开头（随贷通卡），且贷款用途是经营（情况1和2是或者的情况）；
-- 供参考代码：select count(*)
-- from dim_bus_loan_ctr_inf_dd
-- where dt='20240331'
-- and (pd_cd like '201050102%' or (pd_cd like '2010503%' and LOAN_USG_CD in ('0100','0199')))
-- 2、合同余额大于0的对公贷款。
-- 取数口径：pd_CD 前7位是 2010401的合同；
-- 3、合同余额大于0的农户贷款。
-- 取数口径：客户信息表&ldquo;是否农户&rdquo;字段是农户的贷款；
-- 4、合同余额大于0的中小企业对公贷款。
-- 取数口径：1、对公贷款；2、客户为中小企业，判断标准为总资产和销售收入规模均不高于2亿，数据来源见附件-信贷截图。
-- 合同编号，借据编号，客户名称，客户编号，四个数据需求字段，借据余额，管户分行


-- 1、合同编号，借据编号，客户名称，客户编号，四个数据需求字段，借据余额，管户分行。
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_01 AS
SELECT
    '清单一'       AS 清单类型
   ,T1.busi_ctr_id AS 合同编号
   ,T2.dbil_id	   AS 借据编号
   ,T1.cst_nm	   AS 客户名称
   ,T1.cst_id	   AS 客户编号
   ,T1.pd_cd       AS 产品编号
   ,T1.loan_usg_cd AS 贷款用途
   ,T4.brc_org_nm  AS 管户分行
FROM  edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON T1.busi_ctr_id=T2.bus_ctr_id
AND T2.prcp_bal > 0
AND T2.DT='20240516'
LEFT JOIN  edw.dwd_bus_loan_ctr_mgr_inf_dd T3 --信贷合同管护信息
ON T1.busi_ctr_id=T3.busi_ctr_id
AND T3.DT='20240516'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON T3.acs_org_id =T4.org_id
AND T4.DT='20240516'
WHERE T1.DT='20240516'
AND T1.ctr_bal	>0
AND (T1.pd_cd like '201050102%' or (T1.pd_cd like '2010503%' and T1.LOAN_USG_CD in ('0100','0199')))
AND T4.cpy_org_id	='999999998' --母行
;


-- 2、合同余额大于0的对公贷款。
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_02 AS
SELECT
    '清单二'       AS 清单类型
   ,T1.busi_ctr_id AS 合同编号
   ,T2.dbil_id	   AS 借据编号
   ,T1.cst_nm	   AS 客户名称
   ,T1.cst_id	   AS 客户编号
   ,T1.pd_cd       AS 产品编号
   ,T4.brc_org_nm  AS 管户分行
FROM  edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON T1.busi_ctr_id=T2.bus_ctr_id
AND T2.prcp_bal > 0
AND T2.DT='20240516'
LEFT JOIN  edw.dwd_bus_loan_ctr_mgr_inf_dd T3 --信贷合同管护信息
ON T1.busi_ctr_id=T3.busi_ctr_id
AND T3.DT='20240516'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON T3.acs_org_id =T4.org_id
AND T4.DT='20240516'
WHERE T1.DT='20240516'
AND T1.ctr_bal	>0
AND T1.pd_cd like '2010401%'  --对公贷款
AND T4.cpy_org_id	='999999998' --母行
;

-- 3、合同余额大于0的农户贷款。
-- 取数口径：客户信息表&ldquo;是否农户&rdquo;字段是农户的贷款；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_03_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_03_01 AS
SELECT
    '清单三'       AS 清单类型
   ,T1.busi_ctr_id AS 合同编号
   ,T2.dbil_id	   AS 借据编号
   ,T1.cst_nm	   AS 客户名称
   ,T1.cst_id	   AS 客户编号
   ,T1.pd_cd       AS 产品编号
   ,T5.fm_ind      AS 农户标志
   ,T4.brc_org_nm  AS 管户分行
FROM  edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON T1.busi_ctr_id=T2.bus_ctr_id
AND T2.prcp_bal > 0
AND T2.DT='20240516'
LEFT JOIN  edw.dwd_bus_loan_ctr_mgr_inf_dd T3 --信贷合同管护信息
ON T1.busi_ctr_id=T3.busi_ctr_id
AND T3.DT='20240516'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON T3.acs_org_id =T4.org_id
AND T4.DT='20240516'
LEFT JOIN  edw.dws_cst_idv_bas_inf_dd T5 --个人客户基本信息汇总表
ON  T1.cst_id = T5.cst_id
AND T5.DT='20240516'
WHERE T1.DT='20240516'
AND T1.ctr_bal > 0
AND T5.fm_ind = '1'   --农户标志
--AND T4.cpy_org_id	='999999998' --母行
and substr(T4.brc_org_id,1,4) in ('3101','3202','3301','3302')  --上海，苏州，台州，杭州
;

--SELECT * FROM lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_03_01;
---
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_03_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_03_02 AS
SELECT
    '清单三'       AS 清单类型
   ,T1.busi_ctr_id AS 合同编号
   ,T2.dbil_id	   AS 借据编号
   ,T1.cst_nm	   AS 客户名称
   ,T1.cst_id	   AS 客户编号
   ,T1.pd_cd       AS 产品编号
   ,T5.fm_ind      AS 农户标志
   ,T4.brc_org_nm  AS 管户分行
FROM  edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON T1.busi_ctr_id=T2.bus_ctr_id
AND T2.prcp_bal > 0
AND T2.DT='20240516'
LEFT JOIN  edw.dwd_bus_loan_ctr_mgr_inf_dd T3 --信贷合同管护信息
ON T1.busi_ctr_id=T3.busi_ctr_id
AND T3.DT='20240516'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON T3.acs_org_id =T4.org_id
AND T4.DT='20240516'
LEFT JOIN  edw.dws_cst_idv_bas_inf_dd T5 --个人客户基本信息汇总表
ON  T1.cst_id = T5.cst_id
AND T5.DT='20240516'
WHERE T1.DT='20240516'
AND T1.ctr_bal > 0
AND T5.fm_ind = '1'   --农户标志
--AND T4.cpy_org_id	='999999998' --母行
and substr(T4.brc_org_id,1,4) in ('3303','3305','3306','3307','3308','3309','3310','3311')  --宁波,温州,丽水,绍兴,金华,嘉兴,湖州,衢州
;


-- 4、合同余额大于0的中小企业对公贷款。
-- 取数口径：1、对公贷款；2、客户为中小企业，判断标准为总资产和销售收入规模均不高于2亿，数据来源见附件-信贷截图。
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_04_1 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_04_1 AS
SELECT
    '清单四'       AS 清单类型
   ,T1.busi_ctr_id AS 合同编号
   ,T2.dbil_id	   AS 借据编号
   ,T1.cst_nm	   AS 客户名称
   ,T1.cst_id	   AS 客户编号
   ,T1.pd_cd       AS 产品编号
   ,T4.brc_org_nm  AS 管户分行
FROM  edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息
LEFT JOIN edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
ON T1.busi_ctr_id=T2.bus_ctr_id
AND T2.prcp_bal > 0
AND T2.DT='20240516'
LEFT JOIN  edw.dwd_bus_loan_ctr_mgr_inf_dd T3 --信贷合同管护信息
ON T1.busi_ctr_id=T3.busi_ctr_id
AND T3.DT='20240516'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON T3.acs_org_id =T4.org_id
AND T4.DT='20240516'
LEFT JOIN  edw.loan_ent_info T5 --企业基本信息
ON  T1.cst_id= T5.customerid
AND T5.DT='20240516'
WHERE T1.DT='20240516'
and T1.pd_cd like '2010401%'  --对公贷款
AND T1.ctr_bal > 0
AND COALESCE(T5.lastyearsale,'')  <='200000000'  --销售额
AND COALESCE(T5.capitalamount,'') <='200000000'  --资产总额
AND T4.cpy_org_id	='999999998' --母行
--and substr(T4.brc_org_id,1,4) in ('3101','3202','3301','3302')  --上海，苏州，台州，杭州
;

SELECT count(*) FROM lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_04_1
-- ---
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_04_02 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_quanhang_hetongyue_20240517_04_02 AS
-- SELECT
--     '清单四'       AS 清单类型
--    ,T1.busi_ctr_id AS 合同编号
--    ,T2.dbil_id	   AS 借据编号
--    ,T1.cst_nm	   AS 客户名称
--    ,T1.cst_id	   AS 客户编号
--    ,T1.pd_cd       AS 产品编号
--    ,T4.brc_org_nm  AS 管户分行
-- FROM  edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息
-- LEFT JOIN edw.dim_bus_loan_dbil_inf_dd T2 --信贷借据信息
-- ON T1.busi_ctr_id=T2.bus_ctr_id
-- AND T2.prcp_bal > 0
-- AND T2.DT='20240516'
-- LEFT JOIN  edw.dwd_bus_loan_ctr_mgr_inf_dd T3 --信贷合同管护信息
-- ON T1.busi_ctr_id=T3.busi_ctr_id
-- AND T3.DT='20240516'
-- LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
-- ON T3.acs_org_id =T4.org_id
-- AND T4.DT='20240516'
-- LEFT JOIN  edw.loan_ent_info T5 --企业基本信息
-- ON  T1.cst_id	 = T5.customerid
-- AND T5.DT='20240516'
-- WHERE T1.DT='20240516'
-- and T1.pd_cd like '2010401%'  --对公贷款
-- AND T1.ctr_bal > 0
-- AND COALESCE(T5.lastyearsale,'')  <='200000000'  --销售额
-- AND COALESCE(T5.capitalamount,'') <='200000000'  --资产总额
-- --AND T4.cpy_org_id	='999999998' --母行
-- and substr(T4.brc_org_id,1,4) in ('3303','3305','3306','3307','3308','3309','3310','3311')  --宁波,温州,丽水,绍兴,金华,嘉兴,湖州,衢州
-- ;
**01-数据需求_保全_2024_D0520_周小四_信用卡客户基本信息及交易明细.sql
---结果表1,附件涉及信用卡业务的以下字段&ldquo;性别、民族、出生日期、户籍地址、身份证号、联系电话、卡申请编号、信用额度（卡申请时点）&rdquo;；
DROP TABLE IF EXISTS lab_bigdata_dev.temp_sjxqSJ2024051746 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.temp_sjxqSJ2024051746 AS
SELECT  DISTINCT a.cst_id 客户号
        ,a.COL_1 管户机构
        ,a.COL_2 客户名称
        ,a.COL_3 卡号
        ,T1.cd_val_dscr 性别
        ,T2.cd_val_dscr 民族
        ,b.bth_dt 出生日期
        ,b.reg_adr 户籍地址
        ,b.doc_nbr 证件号
        ,b.mbl_nbr 手机
        ,c.cr_crd_apl_srl_nbr 卡申请编号
        ,a.crd_lmt 信用额度
FROM    (
            SELECT  P.COL_1 --管护机构
                    ,P.COL_2 --客户名称
                    ,P.COL_3 --卡号
                    ,T.cst_id
                    ,T.cst_nm
                    ,T.crd_lmt
            FROM    qbi_file_20240520_16_42_16 P --导入数据
            LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T --信用卡账户信息汇总
            ON      P.COL_3 = T.late_main_card_card_nbr
            AND     T.dt = '@@{yyyyMMdd}'
            WHERE   P.PT = MAX_PT('qbi_file_20240520_16_42_16')
        ) a
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd b --个人客户基本信息汇总表
ON      a.cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T1
ON      b.gdr_cd = T1.cd_val
AND     T1.dt = '@@{yyyyMMdd}'
AND     T1.tbl_nm = upper('dws_cst_idv_bas_inf_dd')
AND     T1.fld_nm = upper('gdr_cd')
LEFT JOIN    edw.dwd_code_library_dd T2
ON      b.rac_cd = T2.cd_val
AND     T2.dt = '@@{yyyyMMdd}'
AND     T2.tbl_nm = upper('dws_cst_idv_bas_inf_dd')
AND     T2.fld_nm = upper('rac_cd')
LEFT JOIN    edw.dwd_bus_crd_cr_crd_apl_inf_dd c --信用卡申请信息
ON      a.cst_id = c.cst_id
AND     c.dt = '@@{yyyyMMdd}';

--select * FROM lab_bigdata_dev.temp_sjxqSJ2024051746 WHERE 信用额度='0'

--2、附件涉及信用卡业务自启用时点其至2024年5月17日止的信用卡交易明细清单；

-- 查询报表信息  -- 报表管理平台：3103信用卡交易明细(资保)
-- 卡号 交易日期	交易时间	交易类型描述	交易金额	交易币种	撤销、冲正标志	入帐日期

DROP TABLE IF EXISTS tmp_fa_data_query_20240519 PURGE;

CREATE TABLE IF NOT EXISTS tmp_fa_data_query_20240519 AS
SELECT  a0.COL_3         AS 卡号
        ,a2.cst_nm       AS 姓名
        ,a2.doc_id       AS 证件号
        ,a1.trx_dt       AS 交易日期
        ,a1.trx_tm       AS 交易时间
        ,a1.trx_typ_dscr AS 交易类型描述
        ,a1.trx_amt      AS 交易金额
        ,a1.trx_ccy_cd   AS 交易币种
        ,a1.wdw_rvs_ind  AS 撤销冲正标志
        ,a1.act_dt       AS 入帐日期
FROM    (
            SELECT  DISTINCT COL_3
            FROM    qbi_file_20240520_16_42_16
            WHERE   pt = MAX_PT('qbi_file_20240520_16_42_16')
        ) a0
LEFT JOIN    edw.dwd_bus_crd_cr_crd_trx_dtl_di a1 --信用卡客户交易流水
ON      a0.COL_3 = a1.cr_crd_card_nbr
AND     a1.dt BETWEEN '20100101' AND '@@{yyyyMMdd}'
left JOIN    app_rpt.FCT_CR_CRD_MGT_INF a2 --信用卡报表权限控制表
ON      a1.cr_crd_card_nbr = a2.main_crd_no
AND     a2.dt = '@@{yyyyMMdd}';


--select count(distinct 卡号), count(1) FROM tmp_fa_data_query_20240519
**01-数据需求_保全_2024_D0521_张颖_信用卡客户催记.sql
-- 字段：字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记时间、
--  ，催记渠道、外呼电话、与本人关系、外呼状态、催收状态、催收内容、客户标签（即对应催收标签列表）、
-- 客户手机号码，联系人电话号码/手机，与客户的关系。多个联系人就取多个。


-- edw.zcbq_risk_collect_record  --催收痕迹
-- edw.loan_creditcard_customer --信用卡客户情况




-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xykcs_SJ20240520116_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_xykcs_SJ20240520116_01
-- (
  -- 客户姓名      STRING
  -- ,需要调取催记的信用卡卡号	 STRING
  -- ,文件夹      STRING
-- ) ;



-- 字段：字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记时间、
--  ，催记渠道、外呼电话、与本人关系、外呼状态、催收状态、催收内容、客户标签（即对应催收标签列表）、
-- 客户手机号码，联系人电话号码/手机，与客户的关系。多个联系人就取多个。
---取实名认证一致的电话
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xykcs_SJ20240520116_02 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_xykcs_SJ20240520116_02 AS
-- SELECT  T1.需要调取催记的信用卡卡号
--         ,T1.文件夹
--         ,T1.客户姓名
--         ,T2.coln_date             AS 催收日期
--         ,T2.cont_card_no          AS 合同号卡号
--         ,T2.cust_no               AS 客户号
--         ,CASE
--            WHEN T2.col_obj = '01' THEN '本人'
--            WHEN T2.col_obj = '02' THEN '担保人'
--            WHEN T2.col_obj = '03' THEN '联系人'
--            WHEN T2.col_obj = '04' THEN '第三方'
--            ELSE ''
--          END 催收对象
--         ,T2.contact_name          AS 催收对象名称
--         ,CASE
--            WHEN T2.coln_way = '20' THEN '债务拆分'
--            WHEN T2.coln_way = '14' THEN 'AI催收'
--            WHEN T2.coln_way = '07' THEN '诉讼'
--            WHEN T2.coln_way = '17' THEN '分期还款'
--            WHEN T2.coln_way = '99' THEN '其他'
--            WHEN T2.coln_way = '03' THEN '催收电子邮件'
--            WHEN T2.coln_way = '13' THEN '律师函催收'
--            WHEN T2.coln_way = '04' THEN '电话录音催收'
--            WHEN T2.coln_way = '19' THEN '重组'
--            WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
--            WHEN T2.coln_way = '08' THEN '公安立案'
--            WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
--            WHEN T2.coln_way = '18' THEN '利息减免'
--            WHEN T2.coln_way = '02' THEN '催收短信'
--            WHEN T2.coln_way = '11' THEN '现场催收'
--            WHEN T2.coln_way = '01' THEN '催收通知书'
--            WHEN T2.coln_way = '16' THEN '催收函'
--            WHEN T2.coln_way = '09' THEN '报纸公告'
--            WHEN T2.coln_way = '06' THEN '上门催收'
--            ELSE ''
--          END 催收方式
--         ,T2.coln_usr_no           AS 催收人员编号行内
--         ,T2.coln_user             AS 催收人员名称行内
--         ,T2.out_person            AS 催收人员名称行外
--         ,T2.input_usr_no 登记人
--         ,t2.input_usr_name 登记人姓名
--         ,T2.input_date            AS 登记时间
--         ,CASE
--            WHEN t2.coln_source = '101060' THEN '金融移动服务站'
--            WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
--            WHEN t2.coln_source = '202020' THEN '信贷系统'
--            WHEN t2.coln_source = '202021' THEN 'PC'
--            WHEN t2.coln_source = '413010' THEN '小鱼管家'
--            WHEN t2.coln_source = '440010' THEN '智能AI'
--            WHEN t2.coln_source = '449010' THEN '人工外呼'
--            WHEN t2.coln_source = '102010' THEN '短信平台'
--            ELSE ''
--          END 催收渠道
--         ,T2.phone                 AS 外呼电话号码
--         ,T2.relation              AS 与本人关系
--         ,T2.call_status           AS 外呼状态
--         ,CASE
--            WHEN t2.collect_status = '01' THEN '承诺还款'
--            WHEN t2.collect_status = '02' THEN '谈判中'
--            WHEN t2.collect_status = '05' THEN '其他'
--            WHEN t2.collect_status = '03' THEN '转告还款'
--            WHEN t2.collect_status = '04' THEN '无法触达'
--            ELSE ''
--          END 催收状态
--         ,t2.coln_result           AS 催收内容
--         ,t2.collect_mark_list_str AS 催收标签列表
--         ,T3.ctc_1_nm              AS 联系人1姓名
--         ,T3.ctc_1_tel_nbr         AS 联系人1电话号码
--         ,T3.ctc_1_mbl             AS 联系人1手机
--         ,T3.ctc_1_cst_rel         AS 联系人1与客户关系
--         ,T3.ctc_2_nm              AS 联系人2姓名
--         ,T3.ctc_2_tel_nbr         AS 联系人2电话号码
--         ,T3.ctc_2_mbl             AS 联系人2手机
--         ,T3.ctc_2_cst_rel         AS 联系人2与客户关系
--         ,T3.imd_rel_tel_nbr       AS 直系亲属电话号码
--         ,T3.imd_rel_cst_rel       AS 直系亲属与客户关系
--         ,T4.telephone             AS 客户手机号码
-- FROM    lab_bigdata_dev.tmp_xykcs_SJ20240520116_01 T1 --导入信用卡客户
-- LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
-- ON      T1.需要调取催记的信用卡卡号 = T2.cont_card_no
-- AND     T2.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dim_cst_idv_cr_crd_ctc_inf_dd T3 --信用卡客户联系信息
-- ON      T2.cust_no = T3.cst_id
-- AND     T3.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.loan_customer_tel T4 --客户联系电话详情
-- ON      T2.cust_no = T4.customerid
-- --AND     T4.validateresult = '1' --手机号码实名认证结果一致
-- and    T4.isinformation='1'   --,1是为短信接收号码,2不是短信接收号码
-- and    T4.isnew='1'   --1最新,2和0为否
-- AND     T4.DT = '@@{yyyyMMdd}';


-- SELECT * from lab_bigdata_dev.tmp_xykcs_SJ20240520116_02  WHERE 合同号卡号= '6222870000214200'



-----------------取信贷的表-------------------------------------------


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xykcs_SJ20240520116_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xykcs_SJ20240520116_03 AS
SELECT  T1.需要调取催记的信用卡卡号
        ,T1.文件夹
        ,T1.客户姓名
        ,T2.coln_date             AS 催收日期
        ,T2.cont_card_no          AS 合同号卡号
        ,T2.cust_nm               AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name          AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no           AS 催收人员编号行内
        ,T2.coln_user             AS 催收人员名称行内
        ,T2.out_person            AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date            AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        ,T2.phone                 AS 外呼电话号码
        ,T2.relation              AS 与本人关系
        ,T2.call_status           AS 外呼状态
        ,CASE
           WHEN t2.collect_status = '01' THEN '承诺还款'
           WHEN t2.collect_status = '02' THEN '谈判中'
           WHEN t2.collect_status = '05' THEN '其他'
           WHEN t2.collect_status = '03' THEN '转告还款'
           WHEN t2.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
        ,t2.coln_result           AS 催收内容
        ,t2.collect_mark_list_str AS 催收标签列表
        ,T3.linkmanname1        AS 联系人1姓名
        ,T3.linkmantel1         AS 联系人1电话号码
        ,T3.linkmanmobtel1      AS 联系人1手机
        ,T3.linkmanship1         AS 联系人1与客户关系
        ,T3.linkmanname2         AS 联系人2姓名
        ,T3.linkmantel2        AS 联系人2电话号码
        ,T3.linkmanmobtel2           AS 联系人2手机
        ,T3.linkmanship2        AS 联系人2与客户关系
        ,T3.kinfolksname        AS 直系亲属姓名
        ,T3.kinfolkstel     AS 直系亲属电话号码
        ,T3.kinfolksship       AS 直系亲属与客户关系
        ,T3.telephoneno             AS 客户手机号码_用于信用卡业务
        ,T4.mobiletelephone       AS 客户手机号码_基本信息
FROM    lab_bigdata_dev.tmp_xykcs_SJ20240520116_01 T1 --导入信用卡客户
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.需要调取催记的信用卡卡号 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_creditcard_customer T3 --信用卡客户联系信息
ON      T2.cust_no = T3.customerid
AND     T3.DT = '@@{yyyyMMdd}'
left JOIN edw.loan_ind_info T4  --个人信息表
on T2.cust_no=T4.customerid
and T4.dt='@@{yyyyMMdd}';

SELECT * FROM edw.loan_ind_info T3 --信用卡客户联系信息
WHERE  T3.dt='@@{yyyyMMdd}';


--SELECT * from lab_bigdata_dev.tmp_xykcs_SJ20240520116_03 WHERE 客户手机号码_用于信用卡业务 <> 客户手机号码_基本信息
































SELECT distinct 催收标签列表 FROM lab_bigdata_dev.tmp_xykcs_SJ20240520116_02 WHERE 催收标签列表 is not null

SELECT DISTINCT collect_mark_list_str  FROM edw.zcbq_risk_collect_record WHERE DT = '@@{yyyyMMdd}'
**01-数据需求_保全_2024_D0523_郑一峰_22_23年逾期客户催记.sql
--20220101-20231231登记的全量逾期客户
--催收日期、合同号、客户号、客户名称、催收对象、催收方式、省市区、详细地址、催收状态、下阶段措施、催收地点、是否中介介入、催收人员、登记人、登记机构、催收内容、催记渠道、状态等

SELECT  T2.coln_date              AS 催收日期
        ,T2.cont_card_no          AS 合同号卡号
        ,T2.cust_no               AS 客户号
        ,T2.cust_nm               AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name          AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
         ,T2.city_code            AS 省市区码值
         ,T2.addr_info            AS 详细地址
         ,T2.next_step            AS 下阶段措施
         ,T2.coln_place           AS 催收地点
         ,T2.is_inter             AS 是否中介介入
        ,T2.coln_usr_no           AS 催收人员编号行内
        ,T2.coln_user             AS 催收人员名称行内
        ,T2.out_person            AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date            AS 登记时间
        ,T2.input_org_no          AS 登记机构
        ,T2.input_org_name        AS 登记机构名称
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        ,T2.coln_result             AS 催收过程及结果
        -- ,CASE
        --    WHEN t2.collect_status = '01' THEN '承诺还款'
        --    WHEN t2.collect_status = '02' THEN ''
        --    WHEN t2.collect_status = '05' THEN '其他'
        --    WHEN t2.collect_status = '03' THEN '转告还款'
        --    WHEN t2.collect_status = '04' THEN '无法触达'
        --    ELSE ''
        --  END 催收状态
from edw.zcbq_risk_collect_record T2 --催收痕迹
WHERE T2.dt='@@{yyyyMMdd}'
**01-数据需求_保全_2024_D0531_叶宇_客户催收走访记录.sql
--用途：
--用于分析往年业务走访覆盖情况。因客户经理、资产保全人员信息不对称，为避免重复走访，提高走访效率，现申请数据需求，查看哪些已经走访过了，哪些未走过，以便更好安排走访计划。
--催收痕迹，截至最新数据，丽水分行&ldquo;催收日期&rdquo;在2023年和2024年的数据
--字段：数据日期、业务流水号、合同号/卡号、客户号、催收日期、催收方式、催收地点、登记日期、更新日期、催收人员编号(行内)、登记人


DROP TABLE IF EXISTS lab_bigdata_dev.yy_tmp_SJ2024053101 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.yy_tmp_SJ2024053101 AS
SELECT  DISTINCT '@@{yyyyMMdd}' 数据日期
                 ,t1.busi_no 业务流水号
                 ,t1.cont_card_no 合同号或卡号
                 ,t1.cust_no 客户号
                 ,t1.coln_date 催收日期
                 ,CASE
                    WHEN t1.coln_way = '20' THEN '债务拆分'
                    WHEN t1.coln_way = '14' THEN 'AI催收'
                    WHEN t1.coln_way = '07' THEN '诉讼'
                    WHEN t1.coln_way = '17' THEN '分期还款'
                    WHEN t1.coln_way = '99' THEN '其他'
                    WHEN t1.coln_way = '03' THEN '催收电子邮件'
                    WHEN t1.coln_way = '13' THEN '律师函催收'
                    WHEN t1.coln_way = '04' THEN '电话录音催收'
                    WHEN t1.coln_way = '19' THEN '重组'
                    WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
                    WHEN t1.coln_way = '08' THEN '公安立案'
                    WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
                    WHEN t1.coln_way = '18' THEN '利息减免'
                    WHEN t1.coln_way = '02' THEN '催收短信'
                    WHEN t1.coln_way = '11' THEN '现场催收'
                    WHEN t1.coln_way = '01' THEN '催收通知书'
                    WHEN t1.coln_way = '16' THEN '催收函'
                    WHEN t1.coln_way = '09' THEN '报纸公告'
                    WHEN t1.coln_way = '06' THEN '上门催收'
                    ELSE ''
                  END 催收方式
                 ,case
                  when t1.coln_place='01' THEN '行内'
                  when t1.coln_place='02' THEN '借款人家'
                  when t1.coln_place='03' THEN '担保人家'
                  when t1.coln_place='04' THEN '借款人工作场所'
                  when t1.coln_place='05' THEN ' 担保人工作场所'
                  when t1.coln_place='06' THEN ' 法院'
                  else '其他'
                  end as 催收地点
                 ,t1.input_date 登记日期
                 ,t1.update_date 更新日期
                 ,t1.coln_usr_no 催收人员编号_行内
                 ,t1.input_usr_no 登记人
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3306%' --丽水分行
AND     substr(t1.coln_date, 1, 4) IN ( '2023' , '2024' );



SELECT * FROM lab_bigdata_dev.yy_tmp_SJ2024053101


--催收地点
-- 01     行内
-- 02     借款人家
-- 03     担保人家
-- 04     借款人工作场所
-- 05     担保人工作场所
-- 06     法院
-- 99     其它
**01-数据需求_保全_2024_D0603_梁世鹏_信贷客户风险成本数据.sql
--1、存量风险贷款与信用卡，字段：本金余额-20231231	pd-20231231	lgd-20231231	风险成本-20231231	本金余额-20240531	pd_20240531	lgd_20240531	风险成本_20240531
--2、公司化业务，字段:本金余额-剥离日期	pd-剥离日期	lgd-剥离日期	风险成本-剥离日期	本金余额-20240531	pd-20240531	lgd-20240531	风险成本-20240531

SELECT * from ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD WHERE dt='20240531' LIMIT 1000

--导入的表
--1、qbi_file_20240603_17_49_57

--2、qbi_file_20240603_17_52_40

--结果表1：lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01
--结果表2：lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02

--adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD --风险集市信贷业务风险成本考核口径时点表
--adm_rsk.adm_rsk_apl_loan_bsn_rsk_cost_assm_clb_incr_mgr_dd  --风险集市信贷业务风险成本考核口径增量迁徙表

-----*******************存量风险贷款与信用卡********************************************************************
--2023年12月31日的对应业务的本金余额、PD、LGD、风险成本；
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_01 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_01 AS
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,p.COL_3 业务类型
--                  ,t.term_end_prcp_bal 本金余额_20231231
--                  ,t.term_end_pd pd值_20231231
--                  ,t.term_end_lgd lgd值_20231231
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20231231
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      p.COL_2 = t.term_end_dbil_srl_no
-- AND     t.dt = '20231231'
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
-- and     p.COL_3='贷款'
-- union all
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,p.COL_3 业务类型
--                  ,t.term_end_prcp_bal 本金余额_20231231
--                  ,t.term_end_pd pd值_20231231
--                  ,t.term_end_lgd lgd值_20231231
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20231231
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
-- left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
-- on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
-- and T1.dt='20231231'
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      T1.cr_crd_act_id = t.term_end_dbil_srl_no
-- AND     t.dt = '20231231'
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
-- and     p.COL_3='信用卡'
-- ;


-- -- 2024年5月31日的对应业务的本金余额、PD、LGD、风险成本；
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_01 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_01 AS
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,p.COL_3 业务类型
--                  ,t.term_end_prcp_bal 本金余额_2024531
--                  ,t.term_end_pd pd值_2024531
--                  ,t.term_end_lgd lgd值_2024531
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_2024531
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      p.COL_2 = t.term_end_dbil_srl_no
-- AND     t.dt = '20240531'
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
-- and     p.COL_3='贷款'
-- union all
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,p.COL_3 业务类型
--                  ,t.term_end_prcp_bal 本金余额_20231231
--                  ,t.term_end_pd pd值_20231231
--                  ,t.term_end_lgd lgd值_20231231
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20231231
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
-- left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
-- on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
-- and T1.dt='20240531'
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      T1.cr_crd_act_id = t.term_end_dbil_srl_no
-- AND     t.dt = '20240531'
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
-- and     p.COL_3='信用卡'
-- ;


-- --结果表1：存量风险贷款与信用卡
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 AS
-- SELECT  distinct t1.管户分行
--        ,t1.借据流水号_卡号
--        ,t1.业务类型
--        ,t1.本金余额_20231231
--        ,t1.pd值_20231231
--        ,t1.lgd值_20231231
--        ,t1.应提风险成本_20231231
--        ,t2.本金余额_2024531
--        ,t2.pd值_2024531
--        ,t2.lgd值_2024531
--        ,t2.应提风险成本_2024531
-- from lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_01 t1
-- left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_01 t2
-- ON t1.借据流水号_卡号=t2.借据流水号_卡号
-- ;


-- SELECT * from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 WHERE 业务类型='信用卡'

-- ---*******************公司化业务***************************************************************************************

-- --剥离日期对应业务的本金余额、PD、LGD、风险成本；

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 AS
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,p.COL_3 剥离日期
--                  ,t.term_end_prcp_bal 本金余额_剥离日期
--                  ,t.term_end_pd pd值_剥离日期
--                  ,t.term_end_lgd lgd值_剥离日期
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_剥离日期
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      p.COL_2 = t.term_end_dbil_srl_no
-- AND     t.dt = p.COL_3
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
-- union all
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,p.COL_3 剥离日期
--                  ,t.term_end_prcp_bal 本金余额_剥离日期
--                  ,t.term_end_pd pd值_剥离日期
--                  ,t.term_end_lgd lgd值_剥离日期
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_剥离日期
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
-- LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
-- ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
-- AND     T1.dt = '20240531'
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      T1.cr_crd_act_id = t.term_end_dbil_srl_no
-- AND     t.dt = p.COL_3
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
-- and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
-- ;

-- -- 2024年5月31日的对应业务的本金余额、PD、LGD、风险成本；
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 AS
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,t.term_end_prcp_bal 本金余额_20240531
--                  ,t.term_end_pd pd值_20240531
--                  ,t.term_end_lgd lgd值_20240531
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20240531
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      p.COL_2 = t.term_end_dbil_srl_no
-- AND     t.dt = '20240531'
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
-- union all
-- SELECT  DISTINCT p.COL_1 管户分行
--                  ,p.COL_2 借据流水号_卡号
--                  ,t.term_end_prcp_bal 本金余额_20240531
--                  ,t.term_end_pd pd值_20240531
--                  ,t.term_end_lgd lgd值_20240531
--                  ,t.term_end_shd_sbmt_rsk_cost 应提风险成本_20240531
-- FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
-- left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
-- on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
-- and T1.dt='20240531'
-- LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_INCR_MGR_DD t
-- ON      T1.cr_crd_act_id= t.term_end_dbil_srl_no
-- AND     t.dt = '20240531'
-- WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
-- and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
-- ;

-- --结果表2:公司化业务
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 AS
-- SELECT  distinct t1.管户分行
--        ,t1.借据流水号_卡号
--        ,t1.剥离日期
--        ,t1.本金余额_剥离日期
--        ,t1.pd值_剥离日期
--        ,t1.lgd值_剥离日期
--        ,t1.应提风险成本_剥离日期
--        ,t2.本金余额_20240531
--        ,t2.pd值_20240531
--        ,t2.lgd值_20240531
--        ,t2.应提风险成本_20240531
-- from lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 t1
-- left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 t2
-- ON t1.借据流水号_卡号=t2.借据流水号_卡号
-- ;

-- SELECT COUNT(*) FROM tmp_baoquan_SJ2024060376_0603_02



--用时点表，不用增量表，避免出现多行记录
-----*******************存量风险贷款与信用卡********************************************************************
--2023年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20231231
                 ,t.PD_ORIG_VALUE pd值_20231231
                 ,t.LGD_ORIG_VALUE lgd值_20231231
                 ,t.RSK_COST 风险成本_20231231
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
LEFT JOIN   adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20231231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='贷款'
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20231231
                 ,t.PD_ORIG_VALUE pd值_20231231
                 ,t.LGD_ORIG_VALUE lgd值_20231231
                 ,t.RSK_COST 风险成本_20231231
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20231231'
LEFT JOIN  adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20231231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='信用卡'
;


-- 2024年5月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_011 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_011 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='贷款'
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240531'
LEFT JOIN   adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='信用卡'
;

--结果表1：存量风险贷款与信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.业务类型
       ,t1.本金余额_20231231
       ,t1.pd值_20231231
       ,t1.lgd值_20231231
       ,t1.风险成本_20231231
       ,t2.本金余额_20240531
       ,t2.pd值_20240531
       ,t2.lgd值_20240531
       ,t2.风险成本_20240531
from lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_011 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

--SELECT count(*) from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01

---*******************公司化业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN   adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20240531'
LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


-- 2024年5月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240531'
LEFT JOIN    adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t   --风险集市信贷业务风险成本考核口径时点表
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;

--结果表2:公司化业务
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20240531
       ,t2.pd值_20240531
       ,t2.lgd值_20240531
       ,t2.风险成本_20240531
from lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

-- SELECT * from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 WHERE 借据流水号_卡号='4202050102556100';
**01-数据需求_保全_2024_D0603_梁世鹏_信贷客户风险成本数据_修改.sql
--1、存量风险贷款与信用卡，字段：本金余额-20231231	pd-20231231	lgd-20231231	风险成本-20231231	本金余额-20240531	pd_20240531	lgd_20240531	风险成本_20240531
--2、公司化业务，字段:本金余额-剥离日期	pd-剥离日期	lgd-剥离日期	风险成本-剥离日期	本金余额-20240531	pd-20240531	lgd-20240531	风险成本-20240531

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20240531'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

  UNION ALL

  SELECT
    T2.DT
    ,T2.DBIL_SRL_NO
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
    ,T2.PD_START_VALUE AS PD_ORIG_VALUE
    ,CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END AS LGD_ORIG_VALUE
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
    (CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END) AS RSK_COST
  FROM
  (
    SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
    ,T1.GRNT_MODE
    ,T1.OVD_REPAY_RATE REPAY_RATE
    ,T1.CST_PRCP_BAL
    ,T1.VOUCH_PERSON_NUMBER
    ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
    ,CASE
      WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
        THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
      ELSE 0
    END OVDR_MTH_TERM
    FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
    WHERE T1.DT>='20231231' AND T1.DT<='20240531'
    AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
  ) T2
;

--用时点表，不用增量表，避免出现多行记录
-----*******************存量风险贷款与信用卡********************************************************************
--2023年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20231231
                 ,t.PD_ORIG_VALUE pd值_20231231
                 ,t.LGD_ORIG_VALUE lgd值_20231231
                 ,t.RSK_COST 风险成本_20231231
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20231231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='贷款'
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20231231
                 ,t.PD_ORIG_VALUE pd值_20231231
                 ,t.LGD_ORIG_VALUE lgd值_20231231
                 ,t.RSK_COST 风险成本_20231231
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20231231'
LEFT JOIN  COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20231231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='信用卡'
;


-- 2024年5月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_011 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_011 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='贷款'
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240531'
LEFT JOIN  COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='信用卡'
;

--结果表1：存量风险贷款与信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.业务类型
       ,t1.本金余额_20231231
       ,t1.pd值_20231231
       ,t1.lgd值_20231231
       ,t1.风险成本_20231231
       ,t2.本金余额_20240531
       ,t2.pd值_20240531
       ,t2.lgd值_20240531
       ,t2.风险成本_20240531
from lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_011 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

--SELECT count(*) from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01

---*******************公司化业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20240531'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


-- 2024年5月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240531
                 ,t.PD_ORIG_VALUE pd值_20240531
                 ,t.LGD_ORIG_VALUE lgd值_20240531
                 ,t.RSK_COST 风险成本_20240531
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240531'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20240531'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;

--结果表2:公司化业务
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20240531
       ,t2.pd值_20240531
       ,t2.lgd值_20240531
       ,t2.风险成本_20240531
from lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240531_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

-- SELECT count(*) from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02
-- WHERE 借据流水号_卡号='4202050102556100';
**01-数据需求_保全_2024_D0603_梁世鹏_信贷客户风险成本数据_跑20240630.sql
--1、存量风险贷款与信用卡，字段：本金余额-20231231	pd-20231231	lgd-20231231	风险成本-20231231	本金余额-20240630	pd_20240630	lgd_20240630	风险成本_20240630
--2、公司化业务，字段:本金余额-剥离日期	pd-剥离日期	lgd-剥离日期	风险成本-剥离日期	本金余额-20240630	pd-20240630	lgd-20240630	风险成本-20240630

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20240630'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

  UNION ALL

  SELECT
    T2.DT
    ,T2.DBIL_SRL_NO
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
    ,T2.PD_START_VALUE AS PD_ORIG_VALUE
    ,CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END AS LGD_ORIG_VALUE
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
    (CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END) AS RSK_COST
  FROM
  (
    SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
    ,T1.GRNT_MODE
    ,T1.OVD_REPAY_RATE REPAY_RATE
    ,T1.CST_PRCP_BAL
    ,T1.VOUCH_PERSON_NUMBER
    ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
    ,CASE
      WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
        THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
      ELSE 0
    END OVDR_MTH_TERM
    FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
    WHERE T1.DT>='20231231' AND T1.DT<='20240630'
    AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
  ) T2
;

--用时点表，不用增量表，避免出现多行记录
-----*******************存量风险贷款与信用卡********************************************************************
--2023年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20231231
                 ,t.PD_ORIG_VALUE pd值_20231231
                 ,t.LGD_ORIG_VALUE lgd值_20231231
                 ,t.RSK_COST 风险成本_20231231
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20231231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='贷款'
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20231231
                 ,t.PD_ORIG_VALUE pd值_20231231
                 ,t.LGD_ORIG_VALUE lgd值_20231231
                 ,t.RSK_COST 风险成本_20231231
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20231231'
LEFT JOIN  COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20231231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='信用卡'
;


-- 2024年6月30日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240630_011 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240630_011 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20240630
                 ,t.PD_ORIG_VALUE pd值_20240630
                 ,t.LGD_ORIG_VALUE lgd值_20240630
                 ,t.RSK_COST 风险成本_20240630
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240630'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='贷款'
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 业务类型
                 ,t.PRCP_BAL 本金余额_20240630
                 ,t.PD_ORIG_VALUE pd值_20240630
                 ,t.LGD_ORIG_VALUE lgd值_20240630
                 ,t.RSK_COST 风险成本_20240630
FROM    lab_bigdata_dev.qbi_file_20240603_17_49_57 p
left JOIN edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240630'
LEFT JOIN  COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20240630'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_49_57')
and     p.COL_3='信用卡'
;

--结果表1：存量风险贷款与信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.业务类型
       ,t1.本金余额_20231231
       ,t1.pd值_20231231
       ,t1.lgd值_20231231
       ,t1.风险成本_20231231
       ,t2.本金余额_20240630
       ,t2.pd值_20240630
       ,t2.lgd值_20240630
       ,t2.风险成本_20240630
from lab_bigdata_dev.tmp_baoquan_SJ2024060376_20231231_011 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240630_011 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

--SELECT count(*) from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_01

---*******************公司化业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20240630'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


-- 2024年6月30日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240630_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240630_02 AS
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240630
                 ,t.PD_ORIG_VALUE pd值_20240630
                 ,t.LGD_ORIG_VALUE lgd值_20240630
                 ,t.RSK_COST 风险成本_20240630
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240630'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 管户分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240630
                 ,t.PD_ORIG_VALUE pd值_20240630
                 ,t.LGD_ORIG_VALUE lgd值_20240630
                 ,t.RSK_COST 风险成本_20240630
FROM    lab_bigdata_dev.qbi_file_20240603_17_52_40 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240630'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20240630'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240603_17_52_40')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;

--结果表2:公司化业务
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 AS
SELECT  distinct t1.管户分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20240630
       ,t2.pd值_20240630
       ,t2.lgd值_20240630
       ,t2.风险成本_20240630
from lab_bigdata_dev.tmp_baoquan_SJ2024060376_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024060376_20240630_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;

-- SELECT * from lab_bigdata_dev.tmp_baoquan_SJ2024060376_0603_02 WHERE 借据流水号_卡号='4202050102556100';
**01-数据需求_保全_2024_D0611_陈敏珠_重组贷款为分期还款的分析.sql
-- 杭州分行结息方式为定制方案、等额本息、等额本金、分段计息按期归还、等额还款按期归还的重组贷款（bus_cd,业务标识为J0和J）每月需还款金额（本金和利息分别多少)和今年1-5月每月实际还款金额(本金和利息分别多少)
-- 附件上传截止5月末的重组清单,供匹配用看是否清单完整。

-- 08	等额本息
-- 11	等额本金
-- 12	分段计息按期归还
-- 15	等额还款按期归还
-- 17	定制方案
--
-- 管户机构号、合同号、借据号、客户名称、发放日期、到期日期、发放金额、目前余额、结息方式、每月需还本金金额、每月需还利息金额、1月实际归还本金金额、1月实际归还利息金额、
--2月实际归还本金金额、2月实际归还利息金额、3月实际归还本金金额、3月实际归还利息金额、4月实际归还本金金额、4月实际归还利息金额、5月实际归还本金金额、5月实际归还利息金额

--edw.dwd_bus_loan_trm_pmt_trx_dtl_di  --贷款期供交易明细，ini_prcp --应还本金，ini_intr --应还利息，prcp_amt  --实还本金，RCV_ACR_INTR_AMT--实还利息，
--edw.dws_bus_loan_dbil_inf_dd  --贷款借据信息汇总
--edw.dim_bus_loan_ctr_inf_dd  --信贷合同表 ，intr_mth_cd --计息方式
--edw.loan_business_contract   --业务合同表，ictype --计息方式，BUSINESSFLAG--业务标志

-- SELECT t.serialno 合同号
--        ,t.manageorgid 管护机构
--        ,t.manageuserid 管护人
--        ,t.customerid 客户号
--        ,t.customername 客户名称
--        ,t1.dtrb_dt 发放日期
--        ,t1.apnt_mtu_day 到期日期
--        ,t1.amt 发放金额
--        ,t1.prcp_bal 本金余额
--        ,case
--        when t.ictype='08' then '等额本息'
--        when t.ictype='11' then '等额本金'
--        when t.ictype='12' then '分段计息按期归还'
--        when t.ictype='15' then '等额还款按期归还'
--        when t.ictype='17' then '定制方案'
--        end as 结息方式
-- FROM edw.loan_business_contract t  --业务合同表
-- LEFT JOIN edw.dws_bus_loan_dbil_inf_dd t1  --贷款借据信息汇总
-- ON t.serialno=t1.bus_ctr_id
-- and t1.dt='20240531'
-- left join edw.dwd_bus_loan_trm_pmt_trx_dtl_di  t2 --贷款期供交易明细
-- on t1.dbil_id=t2.dbil_id
-- and t2.dt>='20240101' and t2.dt<='20240531'
-- and t2.shd_pay_dt>='20240101' and t2.shd_pay_dt<='20240531'  --应还日期
-- WHERE t.dt='20240531'
-- and t.businessflag in ('J0','J')  --重组贷款
-- and t.manageorgid like '3302%'  --杭州分行
-- and t.ictype in ('08','11','12','15','17')   --定制方案、等额本息、等额本金、分段计息按期归还、等额还款按期归还
-- ;


--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024060686_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024060686_01 AS
SELECT  COL_1                         AS 序号
        ,COL_2                        AS 合同流水号_账户号
        ,COL_3                        AS 借据流水号_卡号
        ,COL_4                        AS 管户机构号
        ,COL_5                        AS 管户机构名称
        ,COL_6                        AS 客户名称
        ,COL_7                        AS 0531借据余额
        ,COL_8                        AS 借据金额
        ,COL_9                        AS 借据发放日期
        ,COL_10                       AS 借据约定到期日期
        ,COL_11                       AS 逾期类型
        ,COL_12                       AS 助兴通类型
        ,COL_13                       AS 本息最长逾期天数
        ,COL_14                       AS 是否转让
        ,COL_15                       AS 是否核销
        ,COL_16                       AS 管户人工号
        ,COL_17                       AS 主担保方式
        ,COL_18                       AS 抵押物类型
        ,COL_19                       AS 还本计息代码
        ,COL_20                       AS 是否风险贷款
        ,COL_21                       AS 条线
        ,COL_22                       AS 是否年度新发生
        ,COL_23                       AS 是否近一年新发生
        ,T2.trx_dt                    AS 交易日期
        ,T2.cur_trm                   AS 还款期数
        ,T2.evt_cmt                   AS 还款事件说明
        ,T2.shd_pay_dt                AS 应还日期
        ,t2.ini_prcp                  AS 应还本金
        ,t2.ini_intr                  AS 应还利息
        ,t2.prcp_amt                  AS 实还本金
        ,t2.RCV_ACR_INTR_AMT          AS 实还利息
FROM    czdk_hzfh_20240531 T1
LEFT JOIN    edw.dwd_bus_loan_trm_pmt_trx_dtl_di t2 --贷款期供交易明细
ON      t1.COL_3 = t2.dbil_id
AND     t2.dt >= '20240101'
AND     t2.dt <= '20240531'
WHERE   PT <> ''
ORDER BY COL_1,T2.trx_dt
;

-- SELECT * FROM lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024060686_01 WHERE 合同流水号_账户号='BC2023101400000106'
**01-数据需求_保全_2024_D0613_卢文锐_催收痕迹批量导出.sql
--2022年1月1日至2024年6月6日，广东英德泰隆村镇银行，批量集中导出催收登记痕迹
--字段：客户名称，催收人员，催收方式，催收日期，催收地点，联系对象，联系人姓名，与本人关系，催收状态，催收内容（催收过程及结果），下阶段措施，催收痕迹、登记日期
drop table if EXISTS lab_bigdata_dev.tmp_lwr_SJ20240606101 purge;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_lwr_SJ20240606101 as
SELECT T1.cust_no 客户号
       ,T1.cust_nm 客户姓名
       ,T1.coln_usr_no 行内催收人员编号
       ,T1.coln_user 行内催收人员名称
       ,T1.out_person 行外催收人员名称
        ,CASE
        WHEN t1.coln_way = '20' THEN '债务拆分'
        WHEN t1.coln_way = '14' THEN 'AI催收'
        WHEN t1.coln_way = '07' THEN '诉讼'
        WHEN t1.coln_way = '17' THEN '分期还款'
        WHEN t1.coln_way = '99' THEN '其他'
        WHEN t1.coln_way = '03' THEN '催收电子邮件'
        WHEN t1.coln_way = '13' THEN '律师函催收'
        WHEN t1.coln_way = '04' THEN '电话录音催收'
        WHEN t1.coln_way = '19' THEN '重组'
        WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
        WHEN t1.coln_way = '08' THEN '公安立案'
        WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
        WHEN t1.coln_way = '18' THEN '利息减免'
        WHEN t1.coln_way = '02' THEN '催收短信'
        WHEN t1.coln_way = '11' THEN '现场催收'
        WHEN t1.coln_way = '01' THEN '催收通知书'
        WHEN t1.coln_way = '16' THEN '催收函'
        WHEN t1.coln_way = '09' THEN '报纸公告'
        WHEN t1.coln_way = '06' THEN '上门催收'
        END 催收方式
       ,T1.coln_date 催收日期
       ,case
        when t1.coln_place='01' THEN '行内'
        when t1.coln_place='02' THEN '借款人家'
        when t1.coln_place='03' THEN '担保人家'
        when t1.coln_place='04' THEN '借款人工作场所'
        when t1.coln_place='05' THEN ' 担保人工作场所'
        when t1.coln_place='06' THEN ' 法院'
        else '其他'
        end as 催收地点
        ,CASE
           WHEN T1.col_obj = '01' THEN '本人'
           WHEN T1.col_obj = '02' THEN '担保人'
           WHEN T1.col_obj = '03' THEN '联系人'
           WHEN T1.col_obj = '04' THEN '第三方'
         END 催收对象
       ,T1.contact_name 联系人姓名
        ,case
        when T1.relation='00' then '本人'
        when T1.relation='01' then '父母'
        when T1.relation='02' then '亲戚'
        when T1.relation='03' then '配偶'
        when T1.relation='05' then '同事'
        when T1.relation='06' then '朋友'
        when T1.relation='11' then '子女'
        when T1.relation='12' then '其他'
        end as  与本人关系
        ,CASE
           WHEN T1.collect_status = '01' THEN '承诺还款'
           WHEN T1.collect_status = '02' THEN '谈判中'
           WHEN T1.collect_status = '05' THEN '其他'
           WHEN T1.collect_status = '03' THEN '转告还款'
           WHEN T1.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
       ,T1.coln_result 催收内容
       ,case
       when T1.next_step='01' then '协商催收'
       when T1.next_step='03' then '诉讼'
       when T1.next_step='04' then '第三人代偿'
       when T1.next_step='05' then ' 以资抵债'
       when T1.next_step='06' then '监控分期还款情况'
       when T1.next_step='07' then '分期'
       when T1.next_step='99' then '其他'
       when T1.next_step='11' then '公安立案'
       when T1.next_step='12' then '现金清收'
       end as 下阶段措施
     ,CASE
           WHEN T1.coln_source = '101060' THEN '金融移动服务站'
           WHEN T1.coln_source = '113010' THEN '小鱼泡泡'
           WHEN T1.coln_source = '202020' THEN '信贷系统'
           WHEN T1.coln_source = '202021' THEN 'PC'
           WHEN T1.coln_source = '413010' THEN '小鱼管家'
           WHEN T1.coln_source = '440010' THEN '智能AI'
           WHEN T1.coln_source = '449010' THEN '人工外呼'
		   WHEN T1.coln_source = '102010' THEN '短信平台'
         END 催收渠道
       ,T1.input_date 登记日期
from edw.zcbq_risk_collect_record T1 --催收痕迹
WHERE   T1.dt = '@@{yyyyMMdd}'
AND     T1.input_org_no LIKE '4461%' --广东英德村行
AND     substr(T1.coln_date, 1, 4) IN ( '2022','2023','2024');


--SELECT count(*) FROM lab_bigdata_dev.tmp_lwr_SJ20240606101

--collect_mark_list_str 催收标签
**01-数据需求_保全_2024_D0919_梁世鹏_提供近3年的利息减免数据明细数据.sql
--SJ2024091941
-- 风险贷款漏斗图建设，需提供近3年的利息减免数据明细数据。
--交易日期处于2022年1月1日至2024年9月19日之间的全量利息减免数据。

-- SELECT * FROM tmp_sjxq_lsp_SJ2024091941;

DROP TABLE IF EXISTS tmp_sjxq_lsp_SJ2024091941 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_lsp_SJ2024091941 AS
SELECT  c.prm_org_id    AS 管护机构
        ,c.prm_org_nm   AS 管护机构名称
        ,b.bus_ctr_id   AS 合同号
        ,b.amt          AS 金额
        ,b.dtrb_dt      AS 发放日期
        ,b.apnt_mtu_day AS 约定到期日
        ,b.exe_mtu_day  AS 执行到期日
        ,a.loan_act_id  AS 贷款账号
        ,a.loan_dbil_id AS 贷款借据号
        ,a.dtl_seq_nbr  AS 明细序号
        ,a.bus_org      AS 营业机构
        ,a.pd_cd        AS 产品代码
        ,a.act_ctg      AS 会计类别
        ,a.cst_id       AS 客户号
        ,CASE
           WHEN e.cst_typ_cd = '1' THEN '个人客户'
           WHEN e.cst_typ_cd = '2' THEN '企业客户'
         END            AS 客户类型
        ,a.ccy_cd       AS 货币代号
        ,a.trx_dt       AS 交易日期
        ,a.trx_dir      AS 交易方向
        ,a.trx_amt      AS 交易金额
        ,a.bal          AS 余额
        ,a.loan_bal_fld AS 余额字段
        ,a.bal_fld_cmt  AS 余额字段说明
        ,a.trx_org      AS 交易机构
        ,a.trx_tlr      AS 交易柜员
        ,a.trx_srl      AS 交易流水
        ,a.trx_evt      AS 交易事件
        ,a.evt_cmt      AS 事件说明
        ,a.trx_no       AS 交易码
        ,a.smr          AS 摘要
FROM    edw.dwd_bus_loan_act_trx_dtl_di a --贷款账户交易明细
INNER JOIN    edw.dws_bus_loan_dbil_inf_dd b --信贷借据信息表
ON      b.dt = '20240919'
AND     b.dbil_id = a.loan_dbil_id
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd c --客户主管护信息表
ON      a.cst_id = c.cst_id
AND     c.dt = '20240919'
-- LEFT JOIN    edw.dim_hr_org_bas_inf_dd d --机构信息表
-- ON      c.prm_org_id = d.org_id
-- AND     d.dt = '20240919'
LEFT JOIN    edw.dws_cst_bas_inf_dd e --客户基础信息汇总表
ON      e.cst_id = a.cst_id
AND     e.dt = '20240919'
WHERE   a.dt >= '20220101'
AND     a.dt <= '20240919'
AND     a.trx_no IN ( '2617a' , '2618b' , '5331' )
AND     a.trx_amt < 0
AND     a.bal_fld_cmt IN ( '应收应计利息' , '应收欠息' , '催收欠息' , '应收应计罚息' , '催收应计罚息' , '应收罚息' , '催收罚息' , '应计复息' , '复息' , '已核销本金利息' , '核销利息' , '证券化赎回应收欠息' , '证券化赎回催收罚息' , '证券化赎回复息' , '证券化赎回催收欠息' , '证券化赎回应计复息' , '证券化赎回应收应计罚息' , '证券化赎回应收罚息' )
;
**01-数据需求_保全_2024_D0924_嘉兴分行_周林霄_信用卡客户卡片信息.sql
-- SJ20240924116
-- 申请调取盛宏卫（客户编号：1023001258）（卡号：6222873401153100）（申请流水号：BA2019122300002588）信用卡申请表，
-- 领卡签收单（或者信用卡激活申请，如有）（债权银行请改成：浙江泰隆商业银行股份有限公司嘉兴平湖支行）

-- 卡类型：贷记白金卡（网申）         卡号：6222873401153100
DROP TABLE IF EXISTS tmp_zlx_SJ20240924116 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zlx_SJ20240924116 AS
SELECT  T2.cr_crd_card_nbr 卡号
        ,T3.cst_id 客户编号
        ,T3.cst_nm 客户名称
        ,a.crd_typ_nm 卡种名称
        ,T2.ctr_srl_nbr 合同流水号
        ,T3.busi_apl_id 申请流水号
        ,T2.mgr_mnl_id 管护人
        ,T2.mgr_org_id 管护机构编号
        ,b.org_nm 管护机构名称
        ,CASE
           WHEN T2.sgnfc_actvt_ctg_cd = 1 THEN '面签'
           WHEN T2.sgnfc_actvt_ctg_cd = 2 THEN '激活'
         END AS 面签激活分类代码
        ,CASE
           WHEN T2.cr_crd_sgnfc_mod_cd = 1 THEN '柜面'
           WHEN T2.cr_crd_sgnfc_mod_cd = 2 THEN 'PAD'
           WHEN T2.cr_crd_sgnfc_mod_cd = 3 THEN '手机银行'
         END AS 信用卡面签方式代码
        ,CASE
           WHEN T2.cr_crd_sgnfc_sts_cd = 01 THEN '待获取'
           WHEN T2.cr_crd_sgnfc_sts_cd = 02 THEN '待面签'
           WHEN T2.cr_crd_sgnfc_sts_cd = 03 THEN '无需面签'
           WHEN T2.cr_crd_sgnfc_sts_cd = 04 THEN '已面签'
         END AS 信用卡面签状态代码
        ,CASE
           WHEN T2.cr_crd_actv_sts_cd = 01 THEN '待获取'
           WHEN T2.cr_crd_actv_sts_cd = 02 THEN '待激活'
           WHEN T2.cr_crd_actv_sts_cd = 03 THEN '已激活'
         END AS 信用卡激活状态代码
        ,T2.sgnfc_dt 面签日期
        ,a.crd_face_stl_cd 卡面样式代码
        ,a.apldoc_barcd 申请件条形码
        ,a.ftch_arg_no 领用合约编号
        ,CASE
           WHEN a.cr_crd_aply_typ_cd = 1 THEN '手写申请书'
           WHEN a.cr_crd_aply_typ_cd = 2 THEN '电子申请书'
         END AS 信用卡申请类型代码
        ,CASE
           WHEN a.aply_src_cd = '01A0' THEN '卡中心进件'
           WHEN a.aply_src_cd = '02A2' THEN '分行进件'
           WHEN a.aply_src_cd = '03'   THEN '路桥区财政'
           WHEN a.aply_src_cd = '04'   THEN '京东进件'
         END AS 申请书来源代码
        ,a.ctr_tpl_typ_cd 合同模板类型代码
        ,a.usd_act_lmt 美元账户额度
        ,a.bil_dt 账单日
        ,a.csh_instm_aprv_intr_rat 现金分期审批利率
        ,a.instm_pay_lmt 分期付款额度
        ,a.pre_brw_csh_rto_adj_val 预借现金比例调整值
        ,a.dlv_mod 递送方式
        ,a.dlv_org_nm 递送机构名称
        ,a.ltgtn_bel_brch_nm 诉讼归属分行名称
        ,a.rvl_brch_nm 收件分行名称
        ,a.fml_addr 家庭地址
        ,a.fml_addr_zip_cde 家庭地址邮编
        ,a.cmp_addr 公司地址
        ,a.cmp_addr_zip_cde 公司地址邮编
        ,a.hreg_addr 户籍地址
        ,a.hreg_addr_zip_cde 户籍地址邮编
        ,a.esta_addr 房产地址
        ,a.esta_addr_zip_cde 房产地址邮编
        ,a.oth_addr 其他地址
        ,a.oth_addr_zip_cde 其他地址邮编
        -- ,a.deal_rsl 处理结果
        -- ,a.fail_rsn 失败原因
        -- ,a.deal_dt 处理日期
        ,a.sys_reg_psn_id 系统登记人id
        ,a.sys_reg_org_no 系统登记机构代码
        --以下字段为空值
-- ,a.sgnfc_actvt_ctg 面签激活分类代码
-- ,a.elec_sgnfc_ind 电子面签标志
-- ,a.cr_crd_sgnfc_mod_cd 信用卡面签方式代码
-- ,a.cr_crd_sgnfc_sts_cd 信用卡面签状态代码
-- ,a.cr_crd_actvt_sts_cd 信用卡激活状态代码
-- ,a.atnms_sgnfc_ind 自主面签标志
-- ,a.sgnfc_org 面签机构
-- ,a.sgn_ctr_chnl 签约渠道
FROM    edw.dwd_bus_loan_cr_crd_sgnfc_actv_inf_dd T2 --信用卡面签激活信息
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd T3 --信用卡卡片信息
ON      T2.cr_crd_card_nbr = T3.cr_crd_card_nbr
AND     T3.dt = '20240924'
LEFT JOIN    edw.dim_bus_crd_lmt_biz_crd_dd a -- 信用卡用信
ON      T3.busi_apl_id = a.usc_aply_serno
AND     a.dt = '20240924'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd b
ON      T2.mgr_org_id = b.org_id
AND     b.dt = '20240924'
WHERE   T2.dt = '20240924'
AND     T2.cr_crd_card_nbr = '6222873401153100'
AND     T2.sgnfc_actvt_ctg_cd = '2'  --1面签，2激活
;




-- SELECT * FROM edw.dwd_bus_loan_cr_crd_sgnfc_actv_inf_dd WHERE dt = '20240924' and cr_crd_card_nbr='6222873401153100'

-- SELECT * FROM edw.loan_admin_sm_lookup_dict WHERE dt='20240924' and lookup_code=upper('aply_src_cd');

-- SELECT * FROM edw.dwd_code_library_dd WHERE dt='20240924' and fld_nm=upper('aply_src_cd')


-- --激活状态 cr_crd_actvt_sts_cd
-- 03	已激活
-- 02	待激活
-- 01	待获取

-- --面签状态cr_crd_sgnfc_sts_cd
-- 02	待面签
-- 03	无需面签
-- 04	已面签
-- 01	待获取

-- --面签方式cr_crd_sgnfc_mod_cd
-- 2	PAD
-- 1	柜面
-- 3	手机银行

-- --申请书来源代码APLY_SRC_CD
-- 02A2	分行进件
-- 01A0	卡中心进件
-- 03	路桥区财政
-- 04	京东进件
**01-数据需求_保全_2024_D1029_吴伟_全量非核销风险贷款信息.sql
--取总行
--先取贷款,取未结清未终结的合同
-- SJ2024102951

-- 截至24年10月28日，针对我行全量非核销风险贷款的借款人，其我行用信金额占征信全部用信金额的比例，即我行敞口占全部敞口之比。


DROP TABLE IF EXISTS tmp_sjxq_SJ2024102951_001 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024102951_001 as
SELECT  bl.bus_ctr_id     AS 合同号
        ,bl.dbil_id       AS 借据号
        ,bl.cst_id        AS 客户号
        ,bl.cst_nm        AS 客户名称
        ,bl.ctr_amt       AS 合同金额
        ,cb.ctr_bal       AS 合同余额
        ,bl.prcp_bal      AS 本金余额
        ,cb.ctr_epsr_amt  AS 合同敞口金额
        ,bl.dtrb_dt       AS 发放日期
        ,bl.apnt_mtu_day  AS 到期日期
        ,bl.ovd_dt        AS 本金逾期日期
        ,bl.ovd_intr_dt   AS 利息逾期日期
        ,bl.ovd_day       AS 逾期天数
        ,cb.grnt_mod_colc AS 担保方式集合
        ,T9.grnt_mod_nm   AS 担保方式
        ,CASE
           WHEN wo.dbil_id IS NOT NULL THEN '是'
           ELSE '否'
         END              AS 是否已核销
        -- ,bl.acs_org_nm
FROM    edw.dws_bus_loan_dbil_inf_dd bl
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd cb
ON      cb.ctr_serno = bl.bus_ctr_id
AND     cb.dt = '20241028'
LEFT JOIN    app_rpt.FCT_LOAN_WRT_OFF_DD wo --贷款核销报表
ON      bl.bus_ctr_id = wo.busi_ctr_id
AND     wo.dt = '20241028'
LEFT JOIN    (
                 SELECT  a.dt
                         ,a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241028'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '20241028'
                 GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc
             ) T9
ON      cb.ctr_serno = T9.ctr_serno
WHERE   bl.dt = '20241028'
and  bl.ovd_amt>0  --逾期
AND     bl.end_dt = '18991231' --未终结
AND     to_date(bl.apnt_mtu_day, 'yyyymmdd') >= TO_DATE(bl.dt, 'yyyymmdd')  --未到期
AND     substr(bl.acs_org_id, 3, 1) <> '6' --母行
AND     ( ( cb.CTR_STS_CD IN ( '2' , '4' )
AND     cb.TMT_DT = '18991231'
AND     to_date(cb.CTR_MTU_DT, 'yyyyMMdd') >= to_date(cb.DT, 'yyyyMMdd') )
 OR cb.CTR_BAL > 0 )
;


---客户在他行的贷款负债

DROP TABLE IF EXISTS tmp_sjxq_SJ2024102951_002 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024102951_002 AS
SELECT  T.cst_id
        ,sum(T.ctr_amt) AS ctr_amt
        ,sum(T.ctr_bal) AS ctr_bal
FROM    (
            SELECT  A1.cst_id
                    ,CASE
                       WHEN A1.ctr_amt <> 0 THEN A1.ctr_amt
                       ELSE A1.act_crd_lmt
                     END                                                               AS ctr_amt   --个人取贷款金额，账户授信额度
                    ,A1.ctr_bal
                    ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
            FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
            WHERE   A1.DT = '@@{yyyyMMdd}'
            AND     A1.dtrb_org <> 'ZJTLCB'
            AND     A1.ctr_bal > 0
        ) T
WHERE   T.rn = 1
GROUP BY T.cst_id
UNION ALL
SELECT  T.cst_id
        ,sum(T.ctr_amt) AS ctr_amt
        ,sum(T.ctr_bal) AS ctr_bal
FROM    (
            SELECT  A1.cst_id
                    ,CASE
                       WHEN A1.loan_amt <> 0 THEN A1.loan_amt
                       ELSE A1.crd_lmt
                     END                                                               AS ctr_amt   --企业取贷款金额，信用额度
                    ,A1.loan_bal                                                       AS ctr_bal
                    ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
            FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
            WHERE   A1.DT = '@@{yyyyMMdd}'
            AND     A1.dtrb_org_typ_cd <> '' --为他行
            AND     A1.loan_bal > 0
        ) T
WHERE   T.rn = 1
GROUP BY T.cst_id

;

--结果表
-- 合同号、客户名称、我行敞口、征信口径敞口、发放日期、到期日期、本金逾期日期、利息逾期日期、逾期天数、担保方式（大信用、纯信用的那一个分类）、合同余额、是否已核销

DROP TABLE IF EXISTS tmp_sjxq_SJ2024102951_003 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024102951_003 as
SELECT  a1.客户号
        ,a1.客户名称
        ,a1.合同号
        ,a1.借据号
        -- ,a1.合同金额
        ,a1.合同余额
        -- ,a1.本金余额
        -- ,a1.合同敞口金额
        ,a1.发放日期
        ,a1.到期日期
        ,a1.本金逾期日期
        ,a1.利息逾期日期
        ,a1.逾期天数
        ,a1.担保方式集合
        ,a1.担保方式
        ,a1.是否已核销
        ,a2.我行敞口金额
        ,a2.我行敞口余额
        ,a3.ctr_amt 他行征信敞口金额
        ,a3.ctr_bal 他行征信敞口余额
FROM    tmp_sjxq_SJ2024102951_001 a1
LEFT JOIN    (
                 SELECT  T.客户号
                         ,sum(T.合同金额) AS 我行敞口金额
                         ,sum(T.合同余额) AS 我行敞口余额
                 FROM    (
                             SELECT  DISTINCT 客户号
                                              ,合同号
                                              ,合同金额
                                              ,合同余额
                             FROM    tmp_sjxq_SJ2024102951_001
                         ) T
                 GROUP BY T.客户号
             ) a2
ON      a1.客户号 = a2.客户号
LEFT JOIN    tmp_sjxq_SJ2024102951_002 a3
ON      a1.客户号 = a3.cst_id
;
**01-数据需求_保全_2024_D1031_苏州分行_周小白_新发生逾期业务具体信息.sql
-- 2024年新发生逾期业务需要了解客户具体信息，以便电话及实地催收，因数据量较大，故申请数据需求
-- 截至2024年10月26日，
-- 业务基本信息:产品名称	币种	主担保方式	合同金额	合同余额	合同起始日期	合同到期日期	逾期本金	逾期利息	本金逾期日期	利息逾期日期
-- 管护信息:管户机构号	管户团队	管户支行	管户人工号	管户人姓名
-- 借款人信息:借款人客户编号	借款人姓名	借款人证件号	借款人联系电话	借款人户籍地	借款人居住地	借款人经营地
-- 担保人信息:担保人客户编号	担保人姓名	担保人证件号	担保人联系电话	担保人户籍地	担保人居住地	担保人经营地

DROP TABLE IF EXISTS tmp_sjxq_SJ2024103101 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024103101 AS
SELECT  INT(col_1)                                 AS 序号
        ,col_2                                     AS 合同流水号
        ,lc.prd_no                                 AS 产品号
        ,T8.pd_nm                                  AS 产品名称
        ,lc.bsn_ccy_cd                             AS 币种
        ,lc.grnt_mod_colc                          AS 担保方式集合
        ,T9.grnt_mod_nm                            AS 担保方式
        ,lc.ctr_amt                                AS 合同金额
        ,lc.ctr_bal                                AS 合同余额
        ,lc.ctr_bgn_dt                             AS 合同起始日期
        ,lc.ctr_mtu_dt                             AS 合同到期日期
        ,b.dbil_id                                 AS 借据号
        ,( b.ovd_amt + b.idle_bal + b.bad_bal )    AS 逾期本金 --（逾期金额 + 呆滞余额 + 呆帐余额）
        ,( b.ibs_ovd_intr_bal + obs_ovd_intr_bal ) AS 逾期利息 --（表内欠息余额 + 表外欠息余额）
        ,case when b.ovd_dt='18991231' then null ELSE  b.ovd_dt end   AS 本金逾期日期
        ,case when b.ovd_intr_dt='18991231'  then null ELSE b.ovd_intr_dt end  AS 利息逾期日期
        ,lc.mgr_org_id                             AS 管户机构号
        ,org.org_nm                                AS 管户机构
        ,org.tem_org_nm                            AS 管户团队
        ,org.sbr_org_nm                            AS 管户支行
        ,lc.mgr_id                                 AS 管户人工号
        ,hr.empe_nm                                AS 管户人姓名
        ,lc.cst_id                                 AS 借款人客户编号
        ,lc.cst_nm                                 AS 借款人姓名
        ,cb.doc_nbr                                AS 借款人证件号
        ,cb.mbl_nbr                                AS 借款人联系电话
        ,cb.reg_adr                                AS 借款人户籍地
        ,cb.fml_adr                                AS 借款人居住地
        ,cb.wrk_adr                                AS 借款人经营地
        ,gp.wrnt_cst_id                            AS 担保人客户编号
        ,gp.wrnt_cst_nm                            AS 担保人姓名
        ,gp.wrnt_doc_nbr                           AS 担保人证件号
        ,cb1.mbl_nbr                               AS 担保人联系电话
        ,cb1.reg_adr                               AS 担保人户籍地
        ,cb1.fml_adr                               AS 担保人居住地
        ,cb1.wrk_adr                               AS 担保人经营地
FROM    qbi_file_20241031_14_07_43 a
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd lc
ON      a.col_2 = lc.ctr_serno
AND     lc.dt = '20241026'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd b --贷款借据汇总表
ON      a.col_2 = b.bus_ctr_id
AND     b.dt = '20241026'
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T8 --产品信息
ON      lc.prd_no = T8.prd_no
AND     T8.DT = '20241027'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      lc.mgr_org_id = org.org_id
AND     org.dt = '20241026'
LEFT JOIN    edw.dws_hr_empe_inf_dd hr
ON      lc.mgr_id = hr.empe_id
AND     hr.dt = '20241026'
LEFT JOIN    edw.dws_cst_bas_inf_dd cb
ON      lc.cst_id = cb.cst_id
AND     cb.dt = '20241026'
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd gp
ON      lc.ctr_serno = gp.bus_ctr_id
AND     gp.dt = '20241026'
LEFT JOIN    edw.dws_cst_bas_inf_dd cb1
ON      gp.wrnt_cst_id = cb1.cst_id
AND     cb1.dt = '20241026'
LEFT JOIN    (
                 SELECT  T.ctr_serno
                         ,T.grnt_mod_colc
                         ,wm_concat('|', coalesce(T1.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241026'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) T
                 LEFT JOIN    edw.dwd_code_library_dd T1
                 ON      T.grnt_mod_colc2 = T1.cd_val
                 AND     T1.tbl_nm = upper('DIM_BUS_LOAN_CTR_GRNT_INF_DD')
                 AND     T1.fld_nm = upper('grnt_mod_cd')
                 AND     T1.dt = '20241026'
                 GROUP BY T.ctr_serno , T.grnt_mod_colc
             ) T9
ON      a.col_2 = T9.ctr_serno
WHERE   pt <> ''
ORDER BY INT(col_1)
;
**01-数据需求_保全_2024_D1105_梁世鹏_执行款退还申请.sql
--	截至10月31号，全量的已退回/划扣的执行款。
-- SJ2024110526
--审批状态	扣款账号	申请类型	借据号卡号	客户打款账户号	借款人客户号	入账时间	入账金额
--申请扣款时间	申请扣款金额	营业经理工号	营业经理名称	推送OA状态	推送OA时间	OA是否确认通过	申请人	申请机构	申请日期	业务交易流水号	业务流水号

--edw.zcbq_inter_zx_kh_th_apply_in_acct 没入仓 ,借据号卡号取不了，转运维

DROP TABLE IF EXISTS tmp_lsp_SJ2024110526 PURGE;

CREATE TABLE IF NOT EXISTS tmp_lsp_SJ2024110526 AS
SELECT  busi_no 业务交易流水号 --主键
        ,out_acct 出账账号
        ,CASE
           WHEN apply_type = 1 THEN '退还'
           WHEN apply_type = 2 THEN '扣划'
         END AS 申请类型
        ,mx_busi_no 业务流水号
        ,cnt_pty_act_id 客户打款账户号
        ,cnt_pty_act_id_nm 客户打款账户名称
        ,cust_no 借款人客户号
        ,cust_nm 借款人客户名称
        ,trx_dt 入账时间
        ,trx_amt 入账金额
        ,apl_ded_date 申请扣款时间
        ,apl_ded_amt 申请扣款金额
        ,CASE
           WHEN wf_status = '000' THEN '待发起'
           WHEN wf_status = '111' THEN '审批中'
           WHEN wf_status = '992' THEN '退回'
           WHEN wf_status = '998' THEN '否决'
           WHEN wf_status = '997' THEN '审批通过'
           WHEN wf_status = '999' THEN '作废'
         END AS 审批状态
        ,push_oa_date 推送OA时间
        ,next_user_id 营业经理工号
        ,next_user_name 营业经理名称
        ,CASE
           WHEN push_oa_sta = '00' THEN '待推送'
           WHEN push_oa_sta = '01' THEN '已推送'
           WHEN push_oa_sta = '02' THEN '推送失败'
         END 推送OA状态
        ,case when oa_confirm='00' then '未确认'
        when oa_confirm='O-12' then '同意'
        when oa_confirm='O-1' then '退回'
        when oa_confirm='01' then '取消出账'
        when oa_confirm='02' then '已手动确认'
        end as OA是否确认通过
        -- ,oa_con_date	OA确认时间
        -- ,oa_busi_no	OA流程流水号
        -- ,remark	备注
        ,input_user_id 申请人
        ,input_org_id 申请机构
        ,input_date 申请日期
FROM    edw.zcbq_inter_zx_kh_th_apply  --执行款退还申请
WHERE   dt = '20241031'
;



--edw.zcbq_inter_zx_kh_th_apply_in_acct 没入仓
SELECT
        BUSI_NO,
        acct.DBIL_CARD_ID,
        OUT_ACCT,
        APPLY_TYPE,
        MX_BUSI_NO,
        CNT_PTY_ACT_ID,
        CNT_PTY_ACT_ID_NM,
        CUST_NO,
        CUST_NM,
        CERT_NO,
        TRX_DT,
        TRX_AMT,
        APL_DED_DATE,
        APL_DED_AMT,
        WF_STATUS,
        OA_CONFIRM,
        REMARK,
        INPUT_USER_ID,
        INPUT_ORG_ID,
        INPUT_DATE,
        UPDATE_USER_ID,
        UPDATE_ORG_ID,
        UPDATE_DATE,
        PUSH_OA_DATE,
        NEXT_USER_ID,
        NEXT_USER_NAME,
        PUSH_OA_STA,
        CANCEL_DESC
        FROM
        inter_zx_kh_th_apply a
        left join (select REL_BUSI_NO, GROUP_CONCAT(DBIL_CARD_ID) DBIL_CARD_ID
        from inter_zx_kh_th_apply_in_acct where STATUS = '1' GROUP BY REL_BUSI_NO) acct
        on acct.REL_BUSI_NO = a.BUSI_NO;
**01-数据需求_保全_2024_D1129_梁世鹏_对剥离业务的管户交接数据.sql
-- SJ20241128151
--为进一步推动剥离业务的信贷管户交接，现需对剥离业务的管户交接数据进行再梳理。
--1、数据日期最新的数据日期
--2、数据范围为附件中客户号下向下的全量未结清贷款/信用卡业务。（未结清的判断已在数据需求字段中进行说明）

-- --定期更新导入的表：qbi_file_20241129_16_36_39_0
-- DROP TABLE if EXISTS wsj_SJ20241128151_2 purge;
-- CREATE TABLE IF NOT EXISTS wsj_SJ20241128151_2 as
-- SELECT col_1 as 剥离分行
--        ,col_2 as 客户号
--        ,col_3 as 剥离日期
-- FROM  qbi_file_20241129_16_36_39_0 WHERE pt=MAX_PT('qbi_file_20241129_16_36_39_0');

--

SELECT count(1) FROM LSP_SJ20241128151

--结果表:贷款和信用卡合同
--- 贷款
drop table if EXISTS  lab_bigdata_dev.LSP_SJ20241128151 PURGE ;
create table if not EXISTS  LSP_SJ20241128151 as
select distinct *
from (
select distinct
    t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'贷款' 业务种类
    ,t2.CTR_SERNO 合同号_卡号
    ,case when t3.busi_ctr_id is not null then '是' else '否' end 是否已剥离
    ,case when t4.CTR_SERNO is not null then '否' else '是' end 是否已结清
    ,case when t5.CTR_SERNO is not null then '是' else '否' end 是否已核销
    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.CTR_SERNO is not null and t8.MGR_ID != t9.MGR_ID then '是'  else '否' end 业务是否已交接
    ,t10.余额 透支本金余额_合同余额_核后本金余额
    ,t12.pd_nm 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.MGR_ORG_ID 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.MGR_ID 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.MGR_ORG_ID 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.MGR_ID 剥离时点业务管户客户经理工号

from wsj_SJ20241128151_2 t1   --业务提供的数据
left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t2   --合同基础信息
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_loan_peel_loan_mng_dd t3  --剥离贷款管理
on t2.CTR_SERNO =t3.busi_ctr_id
and t3.dt ='${data_dt}'
and t3.peel_sts_cd ='997' --剥离
left join
(
    select t1.CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and DBIL_STS_CD !='1' --未结清   借据状态代码0 正常1 结清2 已核销3 准销户4 录入5 已减免
    group by t1.CTR_SERNO
) t4
on t2.CTR_SERNO =t4.CTR_SERNO
left join
(
    select t1.CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and DBIL_STS_CD ='2' --已核销
    group by t1.CTR_SERNO
) t5
on t2.CTR_SERNO =t5.CTR_SERNO
--判断客户管户经理工号与剥离时点客户管户经理工号是否一致
left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and t1.剥离日期 = t6.dt -- 客户剥离时管户
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'
--判断业务管户经理工号与剥离时点业务管户经理工号是否一致
left join edw.DWD_BUS_LOAN_CTR_MGR_INF_DD t8 --信贷合同管护信息
on t3.busi_ctr_id =t8.CTR_SERNO  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.peel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_loan_ctr_mgr_inf_dd t9 -- 信贷合同管护信息
on t2.CTR_SERNO =t9.CTR_SERNO and t9.dt ='${data_dt}' -- 业务当前管户
--透支本金余额/合同余额+核后本金余额(合同级)（若业务为核销业务需取合同项下的所有借据的核后本金余额与借据余额之和）
left join
(
    select t1.CTR_SERNO
    ,sum(WRT_OFF_AMT)+sum(prcp_bal) 余额
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    group by t1.CTR_SERNO
) t10
on t2.CTR_SERNO = t10.CTR_SERNO

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  -现客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join edw.DIM_BUS_LOAN_PRD_FRML_DD t12 --信贷产品信息
on t2.PRD_NO = t12.prd_no   and t12.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --现业务管户机构
on t9.MGR_ORG_ID = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.MGR_ID = t14.empe_id  and t14.dt ='${data_dt}'  --现业务客户经理

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.MGR_ORG_ID = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.MGR_ID = t17.empe_id  and t17.dt ='${data_dt}'

where t2.CTR_SERNO is not null

union

--- 信用卡
select distinct
     t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'信用卡' 业务种类
    ,t2.late_main_card_card_nbr 合同号_卡号
    ,case when t3.ctr_srl_nbr is not null then '是' else '否' end 是否已剥离
    ,case when t4.未结清金额 = 0  then '是' else '否' end 是否已结清
    ,case when t5.late_main_card_card_nbr is not null then '是' else '否' end 是否已核销

    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.cr_crd_card_nbr is not null and t8.frs_mgr_id != t9.frs_mgr_id then '是'  else '否' end 业务是否已交接

    ,t4.未结清金额 透支本金余额_合同余额_核后本金余额
    ,t12.cr_crd_pd_cmt 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.acs_org_id 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.frs_mgr_id 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.acs_org_id 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.frs_mgr_id 剥离时点业务管户客户经理工号

from wsj_SJ20241128151_2 t1
left join edw.dws_bus_crd_cr_crd_act_inf_dd t2 -- 信用卡账户信息汇总
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_crd_pel_cr_crd_mng_dd t3  -- 剥离信用卡管理
on t2.late_main_card_card_nbr =t3.ctr_srl_nbr and t3.dt ='${data_dt}' and t3.pel_sts_cd ='997' --剥离
left join
(
    SELECT  late_main_card_card_nbr
        ,nvl(H.IBS_RCV_FEE,0) + nvl(H.OBS_RCV_FEE,0) + nvl(H.RCV_INTR,0) + nvl(H.OVDR_BAL,0) + nvl(H.INSTL_RMN_NOT_PAID_PRCP_BAL,0) 未结清金额
    FROM   edw.DWS_BUS_CRD_CR_CRD_ACT_INF_DD H  -- 信用卡账户信息汇总
    where H.dt ='${data_dt}'
) t4
on t2.late_main_card_card_nbr =t4.late_main_card_card_nbr
left join
(
    select t1.late_main_card_card_nbr
    from edw.dws_bus_crd_cr_crd_act_inf_dd t1  -- 信用卡账户信息
    where t1.dt ='${data_dt}'
    and t1.act_sts_cd ='V' --已核销
) t5
on t2.late_main_card_card_nbr =t5.late_main_card_card_nbr

left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and t1.剥离日期= t6.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'

left join edw.DWD_BUS_CRD_CR_CRD_MGR_INF_DD t8 --信用卡管护信息
on t3.ctr_srl_nbr =t8.cr_crd_card_nbr  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.pel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t9 -- 信用卡管护信息
on t2.late_main_card_card_nbr =t9.cr_crd_card_nbr and t9.dt ='${data_dt}' -- 业务当前管户

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  --客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join
(
select t1.cr_crd_card_nbr,t2.cr_crd_pd_cmt
from edw.DIM_BUS_CRD_CR_CRD_INF_DD t1  --信用卡卡片信息
left join edw.dim_bus_crd_cr_crd_pd_inf_dd t2  --信用卡产品信息
on t1.cr_crd_pd_id = t2.cr_crd_pd_id  and t2.dt ='${data_dt}'
where t1.dt ='${data_dt}'
) t12 --产品表
on t2.late_main_card_card_nbr =t12.cr_crd_card_nbr

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --业务管户机构
on t9.acs_org_id = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.frs_mgr_id = t14.empe_id  and t14.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.acs_org_id = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.frs_mgr_id = t17.empe_id  and t17.dt ='${data_dt}'

where t2.late_main_card_card_nbr is not null
)
ORDER BY 剥离分行,客户号,剥离日期
;
**01-数据需求_保全_2024_SJ2024061471_叶宇_客户催收走访记录.sql
--用途：
--用于分析往年业务走访覆盖情况。因客户经理、资产保全人员信息不对称，为避免重复走访，提高走访效率，现申请数据需求，查看哪些已经走访过了，哪些未走过，以便更好安排走访计划。
--催收痕迹，截至最新数据，丽水分行&ldquo;催收日期&rdquo;在2023年和2024年的数据
--字段：数据日期、业务流水号、合同号/卡号、客户号、催收日期、催收方式、催收地点、登记日期、更新日期、催收人员编号(行内)、登记人


DROP TABLE IF EXISTS lab_bigdata_dev.yy_tmp_SJ2024061471 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.yy_tmp_SJ2024061471 AS
SELECT  DISTINCT '@@{yyyyMMdd}' 数据日期
                 ,t1.busi_no 业务流水号
                 ,t1.cont_card_no 合同号或卡号
                 ,t1.cust_no 客户号
                 ,t1.coln_date 催收日期
                 ,CASE
                    WHEN t1.coln_way = '20' THEN '债务拆分'
                    WHEN t1.coln_way = '14' THEN 'AI催收'
                    WHEN t1.coln_way = '07' THEN '诉讼'
                    WHEN t1.coln_way = '17' THEN '分期还款'
                    WHEN t1.coln_way = '99' THEN '其他'
                    WHEN t1.coln_way = '03' THEN '催收电子邮件'
                    WHEN t1.coln_way = '13' THEN '律师函催收'
                    WHEN t1.coln_way = '04' THEN '电话录音催收'
                    WHEN t1.coln_way = '19' THEN '重组'
                    WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
                    WHEN t1.coln_way = '08' THEN '公安立案'
                    WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
                    WHEN t1.coln_way = '18' THEN '利息减免'
                    WHEN t1.coln_way = '02' THEN '催收短信'
                    WHEN t1.coln_way = '11' THEN '现场催收'
                    WHEN t1.coln_way = '01' THEN '催收通知书'
                    WHEN t1.coln_way = '16' THEN '催收函'
                    WHEN t1.coln_way = '09' THEN '报纸公告'
                    WHEN t1.coln_way = '06' THEN '上门催收'
                    ELSE ''
                  END 催收方式
                 ,case
                  when t1.coln_place='01' THEN '行内'
                  when t1.coln_place='02' THEN '借款人家'
                  when t1.coln_place='03' THEN '担保人家'
                  when t1.coln_place='04' THEN '借款人工作场所'
                  when t1.coln_place='05' THEN ' 担保人工作场所'
                  when t1.coln_place='06' THEN ' 法院'
                  else '其他'
                  end as 催收地点
                 ,t1.input_date 登记日期
                 ,t1.update_date 更新日期
                 ,t1.coln_usr_no 催收人员编号_行内
                 ,t1.input_usr_no 登记人
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3306%' --丽水分行
AND     substr(t1.coln_date, 1, 4) IN ( '2023' , '2024' );



SELECT * FROM lab_bigdata_dev.yy_tmp_SJ2024061471
**01-数据需求_保全_2024_SJ2024061876_胡婷_用于跟进所有未结清重组贷款的还款落实情况.sql
--无导数权限

--SELECT * FROM  tmp_sjxq_SJ2024061876;

drop table if exists tmp_sjxq_SJ2024061876 PURGE ;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024061876 as
SELECT  plan_type 方案类型
        ,plan_amt 方案金额
        ,maturity 到期日
        ,bor_date 借款日
        ,pay_type 还款方式
        ,rate 助兴通利率
        ,cust_nm 重组客户名称
        ,cust_no 重组客户号
        ,guar_mod 担保方式
        ,bor_change 借款人主体是否变更
        ,ori_bor 原借款人
        ,new_bor 新借款人
        ,guar_change 担保人物是否变更
        ,ori_guar 原担保人
        ,new_guar 新担保人
        ,reg_situ 收回情况
        ,int_dera 是否存在利息减免
        ,apply_dera_amt 申请减免金额
        ,dera_loan_amt 减免贷款本金
        ,dera_loan_int 减免贷款正常利息
        ,dera_loan_pent 减免贷款罚息
        ,dera_card_amt 减免随贷通卡金额
        ,dera_card_pent 减免随贷通卡罚息
        ,dera_card_int 减免随贷通卡正常利息
        ,dera_reason 情况说明及申请减免理由
        ,loan_context 助兴通贷款背景情况
        ,plan_dispo 助兴通方案说明及处置计划
        ,rate_des 利率调整说明
        ,act_cust_nm 实际助兴通客户名称
        ,act_cust_no 实际助兴通客户号
        ,act_amt 实际助兴通金额
        ,act_deadline 实际助兴通期限
        ,act_rate 实际助兴通利率
        ,act_busi_type 实际助兴通业务品种
        ,act_loan_purp 实际助兴通贷款用途
        ,act_guad_mod 实际助兴通担保方式
        ,had_used 方案是否被使用
FROM    edw.zcbq_loan_restruct_plan t ---助兴通贷款方案申请
WHERE   t.dt = '@@{yyyyMMdd}'
and cust_no in('1041250681',
'1600477338',
'1600555280',
'1600684077',
'1602275918',
'1602490390',
'1603580809',
'1603644136',
'1604645082',
'1604937770',
'1605055653',
'1605100993',
'1606073783',
'1606724097',
'1606873468',
'1607095746',
'1607835622',
'1607916005',
'1608431547',
'1610433744',
'1610606996',
'1613453956',
'1613881455',
'1614217263',
'1614601350',
'1614782782',
'1616712486',
'1618738149',
'1628957157',
'1631072549',
'1631744258',
'1632649358',
'1634877058',
'1637508410',
'1639915248',
'1641613140',
'1643228337',
'1643810027',
'1644123876',
'1645153942',
'1646560891',
'1646708371',
'1647036137',
'1649510278',
'1649581866',
'1649584748',
'1650632728',
'1651745949',
'1652501547',
'1653934619',
'1655040664',
'1655646247',
'1656344364',
'1656621967',
'1656874980',
'1657072533',
'1668762553',
'1669309831',
'1671201792',
'1672808152',
'1673207923',
'1676305781',
'1676932924',
'1677735076',
'1678558350',
'1679341643',
'1679370323',
'2604208306',
'7005301530',
'7005314200',
'7005319692',
'7005358590',
'7005358862',
'7005383488',
'7005427377',
'7005433929',
'7005450298',
'7005451071',
'7005461023',
'7005465579',
'7005484668',
'7005492559',
'7005515818',
'7005540085',
'7005569150',
'7005571319',
'7005573146',
'7005587550',
'7005604776',
'7005606495',
'7005618027',
'7005678238',
'7005691549',
'7005708650',
'7005716217',
'7005730077',
'7005749013',
'7005760061',
'7005760580',
'7005766553',
'7005822127',
'7005834122',
'7005835330',
'7005854979',
'7005881757',
'7005898928',
'7005902722',
'7005905945',
'7005911009',
'7005912712',
'7005915928',
'7005923004',
'7005926607',
'7005936611',
'7005941651',
'7005947369',
'7005958396',
'7005974969',
'7005987886',
'7005988032',
'7005993205',
'7005997667',
'7006009640',
'7006011234',
'7006019250',
'7006028210',
'7006041196',
'7006044403',
'7006044960',
'7006046463',
'7006060881',
'7006065343',
'7006066272',
'7006068186',
'7006080063',
'7006082218',
'7006084261',
'7006090402',
'7006099357',
'7006103858',
'7006112111',
'7006121575',
'7006125038',
'7006129793',
'7006146598',
'7006152746',
'7006154427',
'7006157671',
'7006168297',
'7006180864',
'7006190241',
'7006192061',
'7006202612',
'7006227457',
'7006260801',
'7006280076',
'7006286328',
'7006291382',
'7006307045',
'7006314348',
'7006315594',
'7006323098',
'7006323562',
'7006326569',
'7006327157',
'7006332421',
'7006333855',
'7006334429',
'7006348011',
'7006358258',
'7006360462',
'7006364189',
'7006370894',
'7006373202',
'7006374946',
'7006389195',
'7006391549',
'7006398915',
'7006403097',
'7006409471',
'7006410011',
'7006415319',
'7600257030',
'7620171736',
'7620610818',
'7635740336',
'7636596834',
'7637634684',
'7643312530',
'7645100949',
'7645730736',
'7649691365',
'7650690777',
'7651305509',
'7669113990',
'7669511362',
'7669577686',
'7670528970',
'7672068490',
'7677556492',
'7684715673',
'7685746832',
'7687644432',
'7689800729',
'7693089965',
'7693844519',
'8000575861',
'8600610022',
'8611788094')
**01-数据需求_保全_2024_SJ2024061961_梁世鹏_盘点新发生风险贷款交接类业务的数量.sql
--盘点新发生风险贷款交接类业务的数量
--【发放人工号】、【发放人名称】、【业务管户人工号】、【业务管户人名称】

--导入的借据号，qbi_file_20240620_18_43_52，发放人取借据表的经办人

DROP TABLE IF EXISTS tmp_sjxq_SJ2024061961 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024061961 AS
SELECT  T.jiejuhao 借据号
        ,T1.operateuserid 发放人工号
        ,T5.empe_nm 发放人名称
        ,T1.operateorgid 发放机构号
        ,T6.org_nm 发放机构名称
        ,T1.manageuserid 管护人工号
        ,T3.empe_nm 管护人姓名
        ,T1.manageorgid 管护机构号
        ,T4.org_nm 管护机构名称
FROM    qbi_file_20240620_18_43_52 T
LEFT JOIN    (
                 SELECT  T2.SERIALNO --合同流水号
                         ,t1.serialno AS dbil_id
                         ,T1.operateuserid
                         ,T1.operateorgid
                         ,T2.manageuserid
                         ,T2.manageorgid
                 FROM    edw.loan_business_duebill T1 --业务借据信息表
                 LEFT JOIN    edw.loan_business_contract T2 --业务合同表
                 ON      T1.relativeserialno2 = T2.SERIALNO
                 AND     T2.dt = '@@{yyyyMMdd}'
                 WHERE   T1.dt = '@@{yyyyMMdd}'
             ) T1
ON      T.jiejuhao = T1.dbil_id
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd T3 --员工基本信息
ON      T1.manageuserid = T3.empe_id
AND     T3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd T5 --员工基本信息
ON      T1.operateuserid = T5.empe_id
AND     T5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T1.manageorgid = T4.org_id
AND     T4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T6 --机构树_考核维度
ON      T1.operateorgid = T6.org_id
AND     T6.dt = '@@{yyyyMMdd}'
WHERE   pt = MAX_PT('qbi_file_20240620_18_43_52');



-- SELECT * FROM tmp_sjxq_SJ2024061961
**01-数据需求_保全_2024_SJ2024062161_梁世鹏_所有剥离时点的管护人员信息.sql
--需求：取剥离时点下的客户经理名单
--字段：合同流水号/卡号	业务类型	剥离日期	剥离时点业务管户人工号	剥离时点业务管户人名称

--导数数据临时表
-- CREATE TABLE IF NOT EXISTS TMP_SJ2024062161 AS
-- SELECT COL_1 as 合同流水号_卡号
--        ,COL_2 as 业务类型
--        ,COL_3 AS 剥离日期
-- FROM wsj_lsp_SJ2024062161
-- WHERE pt=MAX_PT('wsj_lsp_SJ2024062161');

DROP TABLE IF EXISTS tmp_sjxqlsp_SJ2024062161 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxqlsp_SJ2024062161 AS
SELECT  T.合同流水号_卡号
        ,T.业务类型
        ,SUBSTR(T.剥离日期,1,10) as 剥离日期
        --,T3.peel_dt 剥离日期2
        ,t8.acs_mngr_id 剥离时点业务管户人工号
        ,t9.empe_nm 剥离时点业务管户人名称
FROM    TMP_SJ2024062161 T
LEFT JOIN    edw.dwd_bus_loan_peel_loan_mng_dd t3 --剥离贷款管理
ON      T.合同流水号_卡号 = t3.busi_ctr_id
AND     t3.dt = '${data_dt}'
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd t8 --信贷合同管护信息
ON      t3.busi_ctr_id = t8.busi_ctr_id
AND     t8.dt >= '20220630'
AND     t8.dt <= '${data_dt}'
AND     t3.peel_dt = t8.dt
LEFT JOIN    edw.dws_hr_empe_inf_dd t9 --员工汇总信息
ON      t8.acs_mngr_id = t9.empe_id
AND     t9.dt = '${data_dt}'
WHERE   T.业务类型 = '贷款'
UNION
SELECT  T.合同流水号_卡号
        ,T.业务类型
        ,substr(T.剥离日期,1,10) as 剥离日期
        --,T3.pel_dt 剥离日期2
        ,t8.frs_mgr_id 剥离时点业务管户人工号
        ,t9.empe_nm 剥离时点业务管户人名称
FROM    TMP_SJ2024062161 T
LEFT JOIN    edw.dwd_bus_crd_pel_cr_crd_mng_dd t3 -- 剥离信用卡管理
ON      T.合同流水号_卡号 = t3.ctr_srl_nbr
AND     t3.dt = '${data_dt}'
LEFT JOIN    edw.dwd_bus_crd_cr_crd_mgr_inf_dd t8 --信用卡管护信息
ON      t3.ctr_srl_nbr = t8.cr_crd_card_nbr
AND     t8.dt >= '20220630'
AND     t8.dt <= '${data_dt}'
AND     t3.pel_dt = t8.dt
LEFT JOIN    edw.dws_hr_empe_inf_dd t9 --员工汇总信息
ON      t8.frs_mgr_id = t9.empe_id
AND     t9.dt = '${data_dt}'
WHERE   T.业务类型 = '信用卡';



-- SELECT * FROM  tmp_sjxqlsp_SJ2024062161
**01-数据需求_保全_2024_SJ2024062461_梁世鹏_对剥离业务的管户交接数据盘点.sql
--因半年度公司化汇报，现需对剥离业务的管户交接数据进行再梳理。
--1、数据日期最新的数据日期
--2、数据范围为附件中客户号下向下的全量未结清贷款/信用卡业务。（未结清的判断已在数据需求字段中进行说明）
-- CREATE TABLE IF NOT EXISTS wsj_SJ2024062461_2 as
-- SELECT col_1 as 剥离分行
--        ,col_2 as 客户号
--        ,TO_CHAR(col_3,'yyyy-mm-dd') as 剥离日期
-- FROM  wsj_SJ2024062461_1 WHERE pt=MAX_PT('wsj_SJ2024062461_1');

--SELECT * from lab_bigdata_dev.LSP_SJ2024062461;

--结果表:贷款和信用卡合同
--- 贷款
drop table if EXISTS  lab_bigdata_dev.LSP_SJ2024062461 PURGE ;
create table if not EXISTS  LSP_SJ2024062461 as
select distinct *
from (
select distinct
    t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'贷款' 业务种类
    ,t2.busi_ctr_id 合同号_卡号
    ,case when t3.busi_ctr_id is not null then '是' else '否' end 是否已剥离
    ,case when t4.bus_ctr_id is not null then '否' else '是' end 是否已结清
    ,case when t5.bus_ctr_id is not null then '是' else '否' end 是否已核销
    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.busi_ctr_id is not null and t8.acs_mngr_id != t9.acs_mngr_id then '是'  else '否' end 业务是否已交接
    ,t10.余额 透支本金余额_合同余额_核后本金余额
    ,t12.pd_nm 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.acs_org_id 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.acs_mngr_id 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.acs_org_id 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.acs_mngr_id 剥离时点业务管户客户经理工号

from wsj_SJ2024062461_2 t1   --业务提供的数据
left join edw.dim_bus_loan_ctr_inf_dd t2   --信贷合同表
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_loan_peel_loan_mng_dd t3  --剥离贷款管理
on t2.busi_ctr_id =t3.busi_ctr_id
and t3.dt ='${data_dt}'
and t3.peel_sts_cd ='997' --剥离
left join
(
    select t1.bus_ctr_id
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and t1.loan_act_sts !='1' --未结清
    group by t1.bus_ctr_id
) t4
on t2.busi_ctr_id =t4.bus_ctr_id
left join
(
    select t1.bus_ctr_id
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and t1.loan_act_sts ='2' --已核销
    group by t1.bus_ctr_id
) t5
on t2.busi_ctr_id =t5.bus_ctr_id
--判断客户管户经理工号与剥离时点客户管户经理工号是否一致
left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and to_date(t1.剥离日期,'yyyy-mm-dd') = to_date(t6.dt,'yyyymmdd')  -- 客户剥离时管户
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'
--判断业务管户经理工号与剥离时点业务管户经理工号是否一致
left join edw.dwd_bus_loan_ctr_mgr_inf_dd t8 --信贷合同管护信息
on t3.busi_ctr_id =t8.busi_ctr_id  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.peel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_loan_ctr_mgr_inf_dd t9 -- 信贷合同管护信息
on t2.busi_ctr_id =t9.busi_ctr_id and t9.dt ='${data_dt}' -- 业务当前管户
--透支本金余额/合同余额+核后本金余额(合同级)（若业务为核销业务需取合同项下的所有借据的核后本金余额与借据余额之和）
left join
(
    select t1.bus_ctr_id
    ,sum(wrt_off_amt)+sum(prcp_bal) 余额
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    group by t1.bus_ctr_id
) t10
on t2.busi_ctr_id = t10.bus_ctr_id

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  -现客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join edw.dim_bus_loan_pd_inf_dd t12 --信贷产品信息
on t2.pd_cd = t12.pd_cd  and t12.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --现业务管户机构
on t9.acs_org_id = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.acs_mngr_id = t14.empe_id  and t14.dt ='${data_dt}'  --现业务客户经理

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.acs_org_id = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.acs_mngr_id = t17.empe_id  and t17.dt ='${data_dt}'

where t2.busi_ctr_id is not null

union

--- 信用卡
select distinct
     t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'信用卡' 业务种类
    ,t2.late_main_card_card_nbr 合同号_卡号
    ,case when t3.ctr_srl_nbr is not null then '是' else '否' end 是否已剥离
    ,case when t4.未结清金额 = 0  then '是' else '否' end 是否已结清
    ,case when t5.late_main_card_card_nbr is not null then '是' else '否' end 是否已核销

    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.cr_crd_card_nbr is not null and t8.frs_mgr_id != t9.frs_mgr_id then '是'  else '否' end 业务是否已交接

    ,t4.未结清金额 透支本金余额_合同余额_核后本金余额
    ,t12.cr_crd_pd_cmt 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.acs_org_id 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.frs_mgr_id 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.acs_org_id 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.frs_mgr_id 剥离时点业务管户客户经理工号

from wsj_SJ2024062461_2 t1
left join edw.dws_bus_crd_cr_crd_act_inf_dd t2 -- 信用卡账户信息汇总
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_crd_pel_cr_crd_mng_dd t3  -- 剥离信用卡管理
on t2.late_main_card_card_nbr =t3.ctr_srl_nbr and t3.dt ='${data_dt}' and t3.pel_sts_cd ='997' --剥离
left join
(
    SELECT  late_main_card_card_nbr
        ,nvl(H.IBS_RCV_FEE,0) + nvl(H.OBS_RCV_FEE,0) + nvl(H.RCV_INTR,0) + nvl(H.OVDR_BAL,0) + nvl(H.INSTL_RMN_NOT_PAID_PRCP_BAL,0) 未结清金额
    FROM   edw.DWS_BUS_CRD_CR_CRD_ACT_INF_DD H  -- 信用卡账户信息汇总
    where H.dt ='${data_dt}'
) t4
on t2.late_main_card_card_nbr =t4.late_main_card_card_nbr
left join
(
    select t1.late_main_card_card_nbr
    from edw.dws_bus_crd_cr_crd_act_inf_dd t1  -- 信用卡账户信息
    where t1.dt ='${data_dt}'
    and t1.act_sts_cd ='V' --已核销
) t5
on t2.late_main_card_card_nbr =t5.late_main_card_card_nbr

left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and to_date(t1.剥离日期,'yyyy-mm-dd') = to_date(t6.dt,'yyyymmdd')
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'

left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t8 --信用卡管护信息
on t3.ctr_srl_nbr =t8.cr_crd_card_nbr  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.pel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t9 -- 信用卡管护信息
on t2.late_main_card_card_nbr =t9.cr_crd_card_nbr and t9.dt ='${data_dt}' -- 业务当前管户

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  --客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join
(
select t1.cr_crd_card_nbr,t2.cr_crd_pd_cmt
from edw.dim_bus_crd_cr_crd_inf_dd t1
left join edw.dim_bus_crd_cr_crd_pd_inf_dd t2
on t1.cr_crd_pd_id = t2.cr_crd_pd_id  and t2.dt ='${data_dt}'
where t1.dt ='${data_dt}'
) t12 --产品表
on t2.late_main_card_card_nbr =t12.cr_crd_card_nbr

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --业务管户机构
on t9.acs_org_id = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.frs_mgr_id = t14.empe_id  and t14.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.acs_org_id = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.frs_mgr_id = t17.empe_id  and t17.dt ='${data_dt}'

where t2.late_main_card_card_nbr is not null
)
ORDER BY  剥离分行,客户号,剥离日期
;
**01-数据需求_保全_2024_SJ2024062506_郑一峰_存量只收不付控制的账户信息.sql
--（2）2021年6月17日前信贷系统发起的只收不付控制的账户信息
--字段：分行机构名称	管户机构名称	客户编号	客户名称	冻结通知书编号	客户账号	负债账号	冻结种类	冻结起始日期	渠道	当前账户余额	关联业务合同号	关联合同类型	关联合同余额	关联合同当前逾期天数
--关联合同到期日期	关联业务借款人	客户角色

-- 2020年1月1日-2021年6月16日，在信贷系统发起止付的业务，目前仍为止付状态的（只收不付）的账户及相关联的合同、客户
-- 字段：分行、管户机构、止付编号、止付账户、客户编号、客户名称、控制金额、实际止付金额、账户余额、止付日期、关联业务合同号、关联业务借款人、客户性质


-- 2021年6月16日前只有止付客户的记录，没有止付账号的信息，经与需求方沟通，
-- 取止付日期在20200101-20210616之间的客户，和这些客户当前所有存款账户的状态与账户余额，以及能够关联到的未结清且逾期的信贷合同
-- 账户信息
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_1 PURGE; -- 4830

CREATE TABLE  IF NOT EXISTS  sc_tmp_SJ2024062506_1 AS
SELECT  t1.dongjbho 冻结通知书编号
        ,t1.kehuzhao 客户账号
        ,t1.zhanghao 负债账号
        ,CASE
           WHEN t1.donjzhgl = '10' THEN '启用不收不付控制'
           WHEN t1.donjzhgl = '11' THEN '金额冻结'
           WHEN t1.donjzhgl = '12' THEN '只收不付'
           WHEN t1.donjzhgl = '13' THEN '封闭冻结'
           WHEN t1.donjzhgl = '21' THEN '验资止付'
           WHEN t1.donjzhgl = '22' THEN '保证控制'
           WHEN t1.donjzhgl = '23' THEN '只付不收控制'
           WHEN t1.donjzhgl = '24' THEN '差错临控'
           WHEN t1.donjzhgl = '25' THEN '止付控制'
           WHEN t1.donjzhgl = '26' THEN '其他金额控制'
           WHEN t1.donjzhgl = '27' THEN '封闭控制'
           WHEN t1.donjzhgl = '28' THEN '理财申购控制'
           WHEN t1.donjzhgl = '29' THEN '电子国债申购控制'
           WHEN t1.donjzhgl = '30' THEN '证明控制'
           WHEN t1.donjzhgl = '31' THEN '预授权'
           WHEN t1.donjzhgl = '32' THEN '金额控制（不可超额）'
           WHEN t1.donjzhgl = '33' THEN '启用控制'
           WHEN t1.donjzhgl = '34' THEN '只收不付控制'
           WHEN t1.donjzhgl = '35' THEN '质押控制'
           WHEN t1.donjzhgl = '36' THEN '放贷控制'
           WHEN t1.donjzhgl = '37' THEN '受托控制'
           WHEN t1.donjzhgl = '38' THEN '贴现控制'
           WHEN t1.donjzhgl = '39' THEN '额度控制'
           WHEN t1.donjzhgl = '40' THEN '睡眠户封闭控制'
           WHEN t1.donjzhgl = '41' THEN '认购控制'
           WHEN t1.donjzhgl = '42' THEN '廉政账户控制'
           WHEN t1.donjzhgl = '43' THEN '金额控制（可超额）'
           WHEN t1.donjzhgl = '44' THEN '身份未核查控制'
           WHEN t1.donjzhgl = '45' THEN '挂失只收不付控制'
           WHEN t1.donjzhgl = '46' THEN '挂失封闭控制'
           WHEN t1.donjzhgl = '47' THEN '证件到期控制'
           WHEN t1.donjzhgl = '48' THEN 'ATM延迟转账'
           ELSE NULL
         END 冻结种类
        ,t1.djqsriqi 冻结起始日期
        ,t1.qudaohao 渠道
FROM    edw.core_kdpb_dngjdj t1 -- 核心系统，冻结止付账簿
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.zhzfleix = '02' -- 账户止付类型,02:信贷风险止付
AND     t1.jiedonbz = '0' -- 解冻标志
AND     t1.djqsriqi < '20210616' --冻结起始日期
;


-- 匹配客户信息
-- 按客户账号
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_2 PURGE;

CREATE TABLE sc_tmp_SJ2024062506_2 AS
SELECT  t4.brc_org_nm 分行机构名称
        ,t3.prm_org_nm 管户机构名称
        ,t2.cst_id 客户编号
        ,t5.cst_nm 客户名称
        ,t1 . *
        ,t2.cur_act_bal 当前账户余额
FROM    sc_tmp_SJ2024062506_1 t1
LEFT JOIN    (
                 SELECT   cst_id
                                  ,cst_act_id
                                  ,sum(cur_act_bal) cur_act_bal
                 FROM    edw.dws_bus_dep_act_inf_dd
                 WHERE   dt = '@@{yyyyMMdd}'
                 group by cst_id,cst_act_id
             ) t2 -- 存款账户信息汇总表
ON      t1.客户账号 = t2.cst_act_id
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t3 -- 客户集市-客户基础-客户管户信息
ON      t2.cst_id = t3.cst_id
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t4 --机构树_考核维度
ON      t3.prm_org_id = t4.org_id
AND     t4.dt = '@@{yyyyMMdd}'
left join (
        select cst_id
        ,cst_chn_nm cst_nm
        from adm_pub.adm_csm_cbas_org_inf_dd  -- 对公客户基础信息
        where dt='@@{yyyyMMdd}'
        union all
        select cst_id
        ,cst_chn_nm cst_nm
        from adm_pub.adm_csm_cbas_idv_bas_inf_dd --对私客户基础信息
        where dt='@@{yyyyMMdd}'
)t5
on      t2.cst_id = t5.cst_id
WHERE   t2.cst_id IS NOT NULL
;


-- 按存款帐号
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_3 PURGE;

CREATE TABLE sc_tmp_SJ2024062506_3 AS
SELECT  t4.brc_org_nm 分行机构名称
        ,t3.prm_org_nm 管户机构名称
        ,t2.cst_id 客户编号
        ,t5.cst_nm 客户名称
        ,t1 . *
        ,t2.cur_act_bal 当前账户余额
FROM    sc_tmp_SJ2024062506_1 t1
LEFT JOIN    (
                 SELECT           cst_id
                                  ,dep_act_id
                                  ,sum(cur_act_bal) cur_act_bal
                 FROM    edw.dws_bus_dep_act_inf_dd
                 WHERE   dt = '@@{yyyyMMdd}'
                 group by cst_id,dep_act_id
             ) t2 -- 存款账户信息汇总表
ON      t1.客户账号 = t2.dep_act_id
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd t3 -- 客户集市-客户基础-客户管户信息
ON      t2.cst_id = t3.cst_id
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t4 --机构树_考核维度
ON      t3.prm_org_id = t4.org_id
AND     t4.dt = '@@{yyyyMMdd}'
left join (
        select cst_id
        ,cst_chn_nm cst_nm
        from adm_pub.adm_csm_cbas_org_inf_dd  -- 对公客户基础信息
        where dt='@@{yyyyMMdd}'
        union all
        select cst_id
        ,cst_chn_nm cst_nm
        from adm_pub.adm_csm_cbas_idv_bas_inf_dd --对私客户基础信息
        where dt='@@{yyyyMMdd}'
)t5
on      t2.cst_id = t5.cst_id
WHERE   t2.cst_id IS NOT NULL
and     t1.冻结通知书编号 not in (select 冻结通知书编号 from sc_tmp_SJ2024062506_2)
;



-- 合表,4819条记录
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_4 PURGE;

CREATE TABLE sc_tmp_SJ2024062506_4 AS
SELECT  DISTINCT *
FROM    (
            SELECT  t1 . *
            FROM    sc_tmp_SJ2024062506_2 t1
            UNION ALL
            SELECT  t2 . *
            FROM    sc_tmp_SJ2024062506_3 t2
        ) t;

-- select count(1) from sc_tmp_SJ2024062506_4;



-- 已核销业务+未结清的非核销业务信息, 688849
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_5 PURGE;

CREATE TABLE sc_tmp_SJ2024062506_5 AS
SELECT  cust_no                                                                                AS cst_id -- 客户号
        ,cont_no                                                                               AS busi_ctr_id -- 合同流水号
        ,'已核销业务'                                                                               AS ctr_type
        ,sum(nvl(cancel_capital_bal, 0) + nvl(cancel_int_bal, 0) + nvl(cancel_capital_int, 0)) AS amt -- 核后本金余额+核后利息余额+已核销本金利息
FROM    edw.zcbq_cancel_loan_book -- 贷款核销台账
WHERE   dt = '@@{yyyyMMdd}'
AND     ( nvl(cancel_capital_bal, 0) + nvl(cancel_int_bal, 0) + nvl(cancel_capital_int, 0) ) > 0 -- 核后本金余额+核后利息余额+已核销本金利息>0 的已核销业务
GROUP BY cust_no , cont_no
UNION ALL
SELECT  DISTINCT cst_id
                 ,busi_ctr_id
                 ,'未结清的非核销业务' AS ctr_type
                 ,ctr_bal     AS amt -- 合同余额
FROM    edw.dim_bus_loan_ctr_inf_dd -- 信贷合同信息
WHERE   dt = '@@{yyyyMMdd}'
AND     ctr_bal > 0
AND     end_dt = '18991231'  -- 合同余额>0 的非核销业务
AND     busi_ctr_id NOT IN (
                               SELECT  DISTINCT cont_no
                               FROM    edw.zcbq_cancel_loan_book
                               WHERE   dt = '@@{yyyyMMdd}'
                               AND     ( nvl(cancel_capital_bal, 0) + nvl(cancel_int_bal, 0) + nvl(cancel_capital_int, 0) ) > 0 -- 核后本金余额+核后利息余额+已核销本金利息>0 的已核销业务
                           )
;


-- select * from sc_tmp_SJ2024030111_5;

-- 合同信息
-- 借款人
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_6 PURGE;

CREATE TABLE sc_tmp_SJ2024062506_6 AS
SELECT  DISTINCT T1.客户编号
                 ,T2.busi_ctr_id 关联业务合同号
                 ,t2.ctr_type 关联合同类型
                 ,t2.amt 关联合同余额    -- 未结清的非核销业务指合同余额，已核销业务指三个核销金额汇总值
                 ,t3.max_ovd_day 关联合同当前逾期天数
                 ,T4.apnt_mtu_dt 关联合同到期日期
                 ,T4.cst_nm 关联业务借款人
                 ,'借款人' 客户性质
FROM    sc_tmp_SJ2024062506_4 T1
inner JOIN    sc_tmp_SJ2024062506_5 T2
ON      T1.客户编号 = T2.CST_ID
inner JOIN    (
                 SELECT  a1.bus_ctr_id
                         ,max(ovd_day) max_ovd_day
                 FROM    edw.dim_bus_loan_dbil_inf_dd a1   -- 信贷借据信息
                 WHERE   a1.dt = '@@{yyyyMMdd}'
                 GROUP BY a1.bus_ctr_id
             ) t3
ON      t2.busi_ctr_id = t3.bus_ctr_id
left  join edw.dim_bus_loan_ctr_inf_dd t4
on t2.busi_ctr_id = t4.busi_ctr_id
and  t4.dt='@@{yyyyMMdd}'
WHERE   t2.busi_ctr_id is not null
;



-- 担保人
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_7 PURGE;

CREATE TABLE sc_tmp_SJ2024062506_7 AS
SELECT  DISTINCT T1.客户编号
                 ,T2.busi_ctr_id 关联业务合同号
                 ,t2.ctr_type 关联合同类型
                 ,t2.amt 关联合同余额    -- 未结清的非核销业务指合同余额，已核销业务指三个核销金额汇总值
                 ,t3.max_ovd_day 关联合同当前逾期天数
                 ,T4.apnt_mtu_dt 关联合同到期日期
                 ,T4.cst_nm 关联业务借款人
                 ,'担保人' 客户性质
FROM    sc_tmp_SJ2024062506_4 T1
inner join edw.dws_bus_grnt_prsn_inf_dd t11  --担保人汇总信息
on t1.客户编号 = t11.wrnt_cst_id
and  t11.dt='@@{yyyyMMdd}'
inner JOIN    sc_tmp_SJ2024062506_5 T2
ON      T11.bus_ctr_id  = T2.busi_ctr_id
inner JOIN    (
                 SELECT  a1.bus_ctr_id
                         ,max(ovd_day) max_ovd_day
                 FROM    edw.dim_bus_loan_dbil_inf_dd a1
                 WHERE   a1.dt = '@@{yyyyMMdd}'
                 and     a1.loan_act_sts !='1' --未结清
                 GROUP BY a1.bus_ctr_id
             ) t3
ON      t2.busi_ctr_id = t3.bus_ctr_id
left  join edw.dim_bus_loan_ctr_inf_dd t4
on t2.busi_ctr_id = t4.busi_ctr_id
and  t4.dt='@@{yyyyMMdd}'
WHERE   t2.busi_ctr_id is not null
;

--- 最后信息的合并,5076
DROP TABLE IF EXISTS sc_tmp_SJ2024062506_final PURGE;

CREATE TABLE sc_tmp_SJ2024062506_final AS
SELECT  t1 . *
        ,t2.`(客户编号)?+.+`
FROM    sc_tmp_SJ2024062506_4 t1
LEFT JOIN    (
                 SELECT  *
                 FROM    sc_tmp_SJ2024062506_6
                 UNION ALL
                 SELECT  *
                 FROM    sc_tmp_SJ2024062506_7
             ) t2
ON      t1.客户编号 = t2.客户编号
ORDER BY t1.客户编号
;

-- SELECT * FROM sc_tmp_SJ2024062506_final
**01-数据需求_保全_2024_SJ2024062506_郑一峰_逾期客户账户余额.sql
--（1）截至2024年6月30日目前所有在我行有逾期业务的客户账户的余额，逾期口径：本金逾期天数大于0
--字段：分行	止付编号	止付类型	账户	是否还款账户	客户编号	客户姓名	客户角色	备注
--关联业务借款人	关联业务借款人名称	业务流水号	业务类型	管户人工号	管护人姓名	信贷管户机构号	信贷管户机构名称 当前账户余额	是否司法机关冻结


--自动止付&amp; 手动止付清单，借款人
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_001 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_001 AS
SELECT  DISTINCT --o.serialno 流水号
                 -- o.stoppaymentno  止付申请流水号,
                 -- o.relievestoppaymentno  解止付申请流水号,
                 -- o.accountserialno  账户流水号,
                 o.controlno 止付编号
                ,CASE
                    WHEN SA.STOPTYPE = '01' THEN '自动止付'
                    WHEN SA.STOPTYPE = '02' THEN '手动止付'
                  END AS 止付类型
                 ,sac.accountno 账户
                 ,case when sac.accountno = bc.paybackaccount then '1' else '0' end as 是否还款账户
                 ,o.customerid 客户编号
                 ,o.customername 客户姓名
                --  ,SA.certtype  证件类型
                --  ,SA.certid 证件号码
                 ,CASE
                    WHEN o.stoprole = '1' THEN '借款人'
                    WHEN o.stoprole = '2' THEN '担保人'
                  END AS 客户角色 --[1.借款人 2.担保人]
                 --,least(nvl(o.STOPSUM, 0), NVL(NVL(SAC.Balance, '0') * h.AVG_PRC / h.QUO_UNT, '0')) 实际止付金额
                 --,o.stopsum 控制金额 --按人民币）,
                 ,o.stopreturn 备注
                 -- o.stopstatus  止付状态,  --00-待发送,10-成功,2010-交易超时,2020-交易异常,2030-业务异常,
                 -- o.stoptime  止付时间,
                 -- o.relievestatus  解止付状态,  --00-待发送,10-成功,2010-交易超时,2020-交易异常,2030-业务异常,
                 -- o.relievetime  解止付时间,
                 --,SA.stopdate 止付日期
                 ,bc.customerid 关联业务借款人
                 ,SA.customername 关联业务借款人名称
                 ,o.objectno 业务流水号   ---busi_ctr_id
                 ,CASE
                    WHEN o.objecttype = 'BusinessContract' THEN '贷款合同/随贷通卡'
                    WHEN o.objecttype = 'CreditCard'       THEN '信用卡'
                  END AS 业务类型 --BusinessContract 贷款合同/随贷通卡 CreditCard 信用卡,
                --  ,bc.businesssum 合同金额
                --  ,bc.balance 合同余额
                --  ,BC.maturity 合同到期日
                 ,CB.userid 管户人工号    --用户
                 ,t.empe_nm 管护人姓名
                 ,CB.orgid 信贷管户机构号  --机构
                 ,jg.org_nm 信贷管户机构名称
FROM    edw.loan_stoppayment_inventory O  --止付清单
LEFT JOIN
( SELECT SERIALNO
         ,accountno
         ,balance
         ,ROW_NUMBER() over(partition by accountno order by SERIALNO desc ) as rn
  FROM  edw.loan_stoppayment_account    --引入账号记录
  WHERE dt='@@{yyyyMMdd}'
)SAC
ON      O.ACCOUNTSERIALNO = SAC.SERIALNO     --账户流水号和流水号关联
-- AND     SAC.dt = '@@{yyyyMMdd}'
and sac.rn=1
LEFT JOIN    edw.loan_stoppayment_apply SA   --止付申请
ON      O.stoppaymentno = SA.serialno  --止付申请流水号和流水号关联
AND     SA.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_customer_belong CB   --客户所属列表
ON      SA.CUSTOMERID = CB.CUSTOMERID
AND     CB.dt = '@@{yyyyMMdd}'
AND     CB.BELONGATTRIBUTE = '1'   --客户主管护
LEFT JOIN    edw.loan_business_contract BC   --业务合同表
ON      bc.serialno = o.objectno      --业务流水号关联
AND     BC.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD h --汇率信息
-- ON      SAC.Currency = h.CCY_CD
-- AND     h.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd jg --机构树_考核维度
ON      CB.orgid = jg.org_id
AND     jg.DT = '@@{yyyyMMdd}'
left join edw.dim_hr_empe_bas_inf_dd t    --员工基本信息表
on CB.userid=t.empe_id
AND     t.DT = '@@{yyyyMMdd}'
-- left join edw.dim_bus_crd_cr_crd_act_inf_dd crd ---信用卡账户信息
-- ON      o.objectno  = crd.cr_crd_act_id
-- AND     crd.DT = '@@{yyyyMMdd}'
WHERE   O.dt = '@@{yyyyMMdd}'
-- and jg.brc_org_id='330699999'  --丽水分行
;

-- ---s1,担保人,担保人的业务信息
SELECT DISTINCT o.customerid,O.customername,O.stoprole,T12.cst_id,T12.cst_nm
from edw.loan_stoppayment_inventory O  --止付清单
inner join edw.dws_bus_grnt_prsn_inf_dd t11  --担保人汇总信息
on O.customerid = t11.wrnt_cst_id
and  t11.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.loan_business_contract BC   --业务合同表
ON      bc.serialno = o.objectno      --业务流水号关联
AND     BC.dt = '@@{yyyyMMdd}'
inner JOIN    edw.dim_bus_loan_ctr_inf_dd T12  --信贷合同
ON      T11.bus_ctr_id  = T12.busi_ctr_id
and  t12.dt='@@{yyyyMMdd}'
where   O.dt = '@@{yyyyMMdd}'



-----贷款，应收利息	罚息	复息
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_002 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_002 AS
select t0.cst_id
,t0.busi_ctr_id
,t0.apnt_start_dt
,t0.apnt_mtu_dt
-- ,sum(rcv_acr_intr)	应收应计利息
-- ,sum(rcv_acr_intr_pnty) 应收应计罚息
-- ,sum(rcv_intr_pnty)	应收罚息
-- ,sum(cmpd_intr)	复息
from edw.dim_bus_loan_ctr_inf_dd t0  --信贷合同信息
left join edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
on t0.busi_ctr_id=t1.bus_ctr_id   --业务合同编号关联
and t1.dt='@@{yyyyMMdd}'
and t1.ovd_day>0   --逾期天数大于0
-- and sum(t1.ovd_amt)>0
where t0.dt='@@{yyyyMMdd}'
and t0.cst_id is not null
group by t0.cst_id,t0.busi_ctr_id,t0.apnt_start_dt,t0.apnt_mtu_dt
order by t0.cst_id,t0.busi_ctr_id,t0.apnt_start_dt,t0.apnt_mtu_dt
;

-----信用卡，应收利息	罚息	复息
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_003 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_003 AS
select  distinct t0.cst_id
,t0.cr_crd_act_id
,t0.busi_ctr_id ---业务合同编号|C32
,t0.busi_apl_id
-- ,t1.rcv_intr	应收利息
-- ,t1.intr_pnty_bal	罚息余额
from edw.dim_bus_crd_cr_crd_inf_dd t0   --信用卡卡片信息
left join edw.dim_bus_crd_cr_crd_act_inf_dd t1   --信用卡账户信息
on t0.cr_crd_act_id=t1.cr_crd_act_id
and t1.dt='@@{yyyyMMdd}'
--and sum(t1.ovd_amt)>0   信用卡逾期最高期数>0
and t1.ovd_hi_trm >0
where t0.dt='@@{yyyyMMdd}'
and t0.cst_id<>''
;

-- SELECT * from lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_003

---合并
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_004 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_004 AS
select distinct
--t1.流水号
t1.止付编号
,t1.止付类型
,t1.账户
,t1.是否还款账户
,t1.客户编号
,t1.客户姓名
,t1.客户角色
-- ,t1.证件类型
-- ,concat(substr(t1.证件号码,1,5),'******',substr(t1.证件号码,12,18)) as 证件号码
--,p2.cur_act_bal 当前账户余额
--,t1.实际止付金额
--,t1.控制金额
,t1.备注
--,t1.当前账户余额
--,t1.止付日期
,t1.关联业务借款人
,t1.关联业务借款人名称
,t1.业务流水号
,t1.业务类型
-- ,t1.合同金额
-- ,t1.合同余额
-- ,t1.合同到期日
-- ,case when t1.业务类型='贷款合同/随贷通卡' then t2.应收应计利息
--       when t1.业务类型='信用卡' then t3.应收利息
--       end as 应收利息
-- ,case when t1.业务类型='贷款合同/随贷通卡' then t2.应收应计罚息
--     when t1.业务类型='信用卡' then t3.罚息余额
--     end as 应收应计罚息
-- ,case when t1.业务类型='贷款合同/随贷通卡' then t2.复息
--     end as 复息
,t1.管户人工号
,t1.管护人姓名
,t1.信贷管户机构号
,t1.信贷管户机构名称
from  lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_001 t1
left join lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_002 t2
on t1.业务流水号=t2.busi_ctr_id
left join lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_003 t3
on t1.业务流水号=t3.busi_ctr_id
;


-- --结果表，取存款账户的账户余额
DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_005 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_005 AS
SELECT  p1 . *
        ,p2.cur_act_bal AS 当前账户余额
        ,CASE
           WHEN p1.账户 IN (
                               SELECT  kehuzhao   --客户账号
                               FROM    edw.core_kdpb_dngjdj    --负债账户冻结登记簿
                               WHERE   dt = '@@{yyyyMMdd}' AND  donjlaiy='1'  --冻结
                           ) THEN '是'
           ELSE '否'
         END            AS 是否冻结   --冻结是外部的说法，控制是内部的说法
FROM    lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_004 p1
LEFT JOIN    (
                 SELECT  cst_act_id
                         ,sum(cur_act_bal) AS cur_act_bal
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   dt = '@@{yyyyMMdd}'
                 GROUP BY cst_act_id
             ) p2
ON      p1.账户 = p2.cst_act_id;






SELECT count(1) FROM lab_bigdata_dev.data_request_zhengyifeng_SJ2024062506_005 WHERE 是否冻结='否' and 账户 is not NULL;



SELECT dongjbho,zhanghao,xzhileix FROM edw.core_kdpl_donjmx T --账户冻结明细
WHERE   T.dt = '@@{yyyyMMdd}'

SELECT dongjbho,concat(kehuzhao,'%'),zhanghao,donjlaiy FROM edw.core_kdpb_dngjdj    --负债账户冻结登记簿
WHERE   dt = '@@{yyyyMMdd}'
-- and donjlaiy='1'  --冻结
and kehuzhao='6214800602003005564'
;

SELECT * FROM edw.core_kdpa_zhduiz   --客户账号对照表
WHERE dt='@@{yyyyMMdd}'
and zhanghao=#zhanghao#
**01-数据需求_保全_2024_SJ2024070126_叶宇_客户催收走访记录.sql
--用途：
--用于分析往年业务走访覆盖情况。因客户经理、资产保全人员信息不对称，为避免重复走访，提高走访效率，现申请数据需求，查看哪些已经走访过了，哪些未走过，以便更好安排走访计划。
--催收痕迹，截至最新数据，丽水分行&ldquo;催收日期&rdquo;在2023年和2024年的数据
--字段：数据日期、业务流水号、合同号/卡号、客户号、催收日期、催收方式、催收地点、登记日期、更新日期、催收人员编号(行内)、登记人


DROP TABLE IF EXISTS lab_bigdata_dev.yy_tmp_SJ2024070126 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.yy_tmp_SJ2024070126 AS
SELECT  DISTINCT '@@{yyyyMMdd}' 数据日期
                 ,t1.busi_no 业务流水号
                 ,t1.cont_card_no 合同号或卡号
                 ,t1.cust_no 客户号
                 ,t1.coln_date 催收日期
                 ,CASE
                    WHEN t1.coln_way = '20' THEN '债务拆分'
                    WHEN t1.coln_way = '14' THEN 'AI催收'
                    WHEN t1.coln_way = '07' THEN '诉讼'
                    WHEN t1.coln_way = '17' THEN '分期还款'
                    WHEN t1.coln_way = '99' THEN '其他'
                    WHEN t1.coln_way = '03' THEN '催收电子邮件'
                    WHEN t1.coln_way = '13' THEN '律师函催收'
                    WHEN t1.coln_way = '04' THEN '电话录音催收'
                    WHEN t1.coln_way = '19' THEN '重组'
                    WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
                    WHEN t1.coln_way = '08' THEN '公安立案'
                    WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
                    WHEN t1.coln_way = '18' THEN '利息减免'
                    WHEN t1.coln_way = '02' THEN '催收短信'
                    WHEN t1.coln_way = '11' THEN '现场催收'
                    WHEN t1.coln_way = '01' THEN '催收通知书'
                    WHEN t1.coln_way = '16' THEN '催收函'
                    WHEN t1.coln_way = '09' THEN '报纸公告'
                    WHEN t1.coln_way = '06' THEN '上门催收'
                    ELSE ''
                  END 催收方式
                 ,case
                  when t1.coln_place='01' THEN '行内'
                  when t1.coln_place='02' THEN '借款人家'
                  when t1.coln_place='03' THEN '担保人家'
                  when t1.coln_place='04' THEN '借款人工作场所'
                  when t1.coln_place='05' THEN ' 担保人工作场所'
                  when t1.coln_place='06' THEN ' 法院'
                  else '其他'
                  end as 催收地点
                 ,t1.input_date 登记日期
                 ,t1.update_date 更新日期
                 ,t1.coln_usr_no 催收人员编号_行内
                 ,t1.input_usr_no 登记人
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3306%' --丽水分行
AND     substr(t1.coln_date, 1, 4) IN ( '2023' , '2024' );



-- SELECT * FROM lab_bigdata_dev.yy_tmp_SJ2024070126
**01-数据需求_保全_2024_SJ2024071776_郑一峰_新信贷上线后止付数据验证.sql
-- SJ2024071776
-- 止付类型、解止付类型、止付编号、止付账户、客户编号、客户姓名、客户角色、关联业务借款人名称,关联业务合同流水号、管户人工号、管户人名称、信贷管户机构号、信贷管户机构名称
-- 范围：截止7月19日存量止付及解止付数据,19日,20日,21日自动止付及解止付增量数据。


--自动止付&amp; 手动止付清单

DROP TABLE IF EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024071776_001 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.data_request_zhengyifeng_SJ2024071776_001 AS
SELECT  DISTINCT
--o.serialno 流水号
-- o.stoppaymentno  止付申请流水号,
-- o.relievestoppaymentno  解止付申请流水号,
-- o.accountserialno  账户流水号,
O.dt 数据日期
,o.controlno 止付编号
,CASE
   WHEN SA.STOPTYPE = '01' THEN '自动止付'
   WHEN SA.STOPTYPE = '02' THEN '手动止付'
 END AS 止付类型
,sac.accountno 账户
,o.customerid 客户编号
,o.customername 客户姓名
,CASE
   WHEN o.stoprole = '1' THEN '借款人'
   WHEN o.stoprole = '2' THEN '担保人'
 END AS 客户角色  --[1.借款人 2.担保人]
,bc.customerid 关联业务借款人
,SA.customername 关联业务借款人名称
,CB.userid 管户人工号 --用户
,t.empe_nm 管护人姓名
,CB.orgid 信贷管户机构号 --机构
,jg.org_nm 信贷管户机构名称
FROM    edw.loan_stoppayment_inventory O --止付清单
LEFT JOIN    (
                 SELECT  SERIALNO
                         ,accountno
                         ,balance
                         ,ROW_NUMBER() OVER ( PARTITION BY accountno ORDER BY SERIALNO DESC ) AS rn
                 FROM    edw.loan_stoppayment_account --引入账号记录
                 WHERE   dt in  ('20240719','20240720','20240721')
             ) SAC
ON      O.ACCOUNTSERIALNO = SAC.SERIALNO  --账户流水号和流水号关联
AND     sac.rn = 1
LEFT JOIN    edw.loan_stoppayment_apply SA --止付申请
ON      O.stoppaymentno = SA.serialno --止付申请流水号和流水号关联
AND     SA.dt in ('20240719','20240720','20240721')
LEFT JOIN    edw.loan_customer_belong CB --客户所属列表
ON      SA.CUSTOMERID = CB.CUSTOMERID
AND     CB.dt in ('20240719','20240720','20240721')
AND     CB.BELONGATTRIBUTE = '1' --客户主管护
LEFT JOIN    edw.loan_business_contract BC --业务合同表
ON      bc.serialno = o.objectno --业务流水号关联
AND     BC.dt in ('20240719','20240720','20240721')
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd jg --机构树_考核维度
ON      CB.orgid = jg.org_id
AND     jg.DT in('20240719','20240720','20240721')
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd t --员工基本信息表
ON      CB.userid = t.empe_id
AND     t.DT in ('20240719','20240720','20240721')
WHERE   O.dt in  ('20240719','20240720','20240721')
;

-- SELECT DISTINCT 数据日期 FROM lab_bigdata_dev.data_request_zhengyifeng_SJ2024071776_001
**01-数据需求_保全_2024_SJ2024071956_吴伟_调取催收短信_用于核销资料归档_.sql
-- 20180730-20220101：数仓edw.dxpt_gsms_msg_ticket_sms
-- 20220101-20221117：短信平台玄武，无信用卡短信
--20230713-至今：edw.ncrd_smscontent  --银数短信,逾期短信通过银数发
-- 20221117-至今4天前：数仓edw.nsms_gsms_msg_ticket_sms


-- 1、需要调取清单内核销业务，在核销时点前的逾期短信一条，征信上报短信5条。
-- 2、以卡号为单位汇总这六条短信，汇总页请写明每一条短信的发送日期和短信内容。
-- 3、清单内核销日期有两个，请注意做好区别。

---1.1 催还款，短信平台,20180730-20220101：数仓edw.dxpt_gsms_msg_ticket_sms
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_huankuan_SJ2024071956_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_huankuan_SJ2024071956_01 AS
SELECT T.col_1 卡号
       ,T.col_2 客户编号
       ,T.col_3 客户名称
       ,p.telephoneno 手机号
       ,substr(replace(t2.post_time,'-',''),1,8) 发送时间
       ,T2.msg_id
       ,T2.sms_content 短信发送内容1
FROM qbi_file_20240723_15_29_41 T
LEFT JOIN edw.loan_creditcard_customer p --信用卡客户情况
on T.col_2=p.customerid
and p.dt='20240528'
left JOIN edw.dxpt_gsms_msg_ticket_sms T2
on p.telephoneno=T2.phone
and T2.dt<='20240528'
and T2.state=1 --发送成功
WHERE T.pt=MAX_PT('qbi_file_20240723_15_29_41')
and (T2.sms_content rlike '到期还款' or T2.sms_content rlike '征信报送' or T2.sms_content RLIKE '逾期')
;

-- SELECT * FROM tmp_huankuan_SJ2024071956_01

--1.2、逾期提示，20230713-至今：edw.ncrd_smscontent  --银数短信,逾期短信通过银数发
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024071956_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024071956_02 AS
SELECT T.col_1 卡号
       ,T.col_2 客户编号
       ,T.col_3 客户名称
       ,p.telephoneno 手机号
       ,substr(T3.sms_snd_tm,1,8) 发送时间
       ,T3.sms_snd_cntnt 短信发送内容2
FROM qbi_file_20240723_15_29_41 T
LEFT JOIN edw.loan_creditcard_customer p --信用卡客户情况
on T.col_2=p.customerid
and p.dt='20240528'
left join edw.ncrd_smscontent T3 --银数短信,逾期
on p.telephoneno=T3.mbl_nbr
and T3.dt<='20240528'
WHERE T.pt=MAX_PT('qbi_file_20240723_15_29_41')
and (T3.sms_snd_cntnt rlike '征信报送' or T3.sms_snd_cntnt rlike '逾期' or T3.sms_snd_cntnt rlike '到期还款')
;

-- SELECT * FROM tmp_yuqi_SJ2024071956_02

--1.3 短信3
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024071956_03 PURGE;

CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.tmp_yuqi_SJ2024071956_03 AS
SELECT T.col_1 卡号
       ,T.col_2 客户编号
       ,T.col_3 客户名称
       ,p.telephoneno 手机号
       ,substr(T3.post_time,1,10) 发送时间
       ,T3.sms_content 短信发送内容3
FROM qbi_file_20240723_15_29_41 T
LEFT JOIN edw.loan_creditcard_customer p --信用卡客户情况
on T.col_2=p.customerid
and p.dt='20240528'
left join edw.nsms_gsms_msg_ticket_sms T3 --存放短信话单信息(按日期分表)
on p.telephoneno=T3.phone
and T3.dt<='20240528'
WHERE T.pt=MAX_PT('qbi_file_20240723_15_29_41')
and (T3.sms_content rlike '征信报送' or T3.sms_content rlike '逾期' or T3.sms_content rlike '还款' )
;


-- SELECT * FROM tmp_yuqi_SJ2024071956_03
**01-数据需求_保全_2024_SJ2024072286_陈敏珠_重组贷款为分期还款的分析.sql
-- 杭州分行结息方式为定制方案、等额本息、等额本金、分段计息按期归还、等额还款按期归还的重组贷款（业务标识为J0和J）每月需还款金额（本金和利息分别多少)和今年1-7月每月实际还款金额(本金和利息分别多少)
-- 附件上传截止6月末的重组清单,供匹配用看是否清单完整。


--1.1
-- 管户机构号、合同号、借据号、客户名称、发放日期、到期日期、发放金额、目前余额、结息方式、还款计划中的1-7月每月需还本金金额、每月需还利息金额及每月实际归还本金、每月实际归还利息
-- （1月应还本金、1月应还利息、1月实际归还本金金额、1月实际归还利息金额...至7月应还本金、7月应还利息、7月实际归还本金金额、7月实际归还利息金额）

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024072286_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024072286_02 AS
SELECT  T1.col_1 合同流水号_账户号
        ,T1.col_2 借据流水号_卡号
        ,T1.col_3 支行
        ,T1.col_4 团队
        ,T1.col_5 管户机构号
        ,T1.col_6 客户名称
        ,T1.col_7 客户号
        ,T1.col_8 截止6月末借据余额_含核销__透支本金余额_含分期未还
        ,T1.col_9 借据金额
        ,substr(T1.col_10, 1, 10) 借据发放日期
        ,substr(T1.col_11, 1, 10) 借据约定到期日期
        ,T1.col_12 业务品种
        ,T1.col_13 助兴通类型
        ,T1.col_14 本息最长逾期天数
        ,T1.col_15 本金逾期日期
        ,T1.col_16 利息逾期日期
        ,T1.col_17 主担保方式
        ,T1.col_18 还本计息代码
        ,T2.trx_dt           AS 交易日期
        ,T2.cur_trm          AS 还款期数
        ,T2.evt_cmt          AS 还款事件说明
        ,T2.shd_pay_dt       AS 应还日期
        ,t2.ini_prcp         AS 应还本金
        ,t2.ini_intr         AS 应还利息
        ,t2.prcp_amt         AS 实还本金
        ,t2.RCV_ACR_INTR_AMT AS 实还利息
FROM    qbi_file_20240724_11_25_32 T1
LEFT JOIN    edw.dwd_bus_loan_trm_pmt_trx_dtl_di t2 --贷款期供交易明细，暂时看到未改
ON      t1.COL_2 = t2.dbil_id
-- AND     t2.dt >= '20240101'
AND     t2.dt <= '@@{yyyyMMdd}'
and t2.dt>='20171118'  --这张表最早的数据
WHERE   T1.PT = MAX_PT('qbi_file_20240724_11_25_32')
ORDER BY COL_1 , T2.trx_dt;


-- SELECT count(1) FROM tmp_czdk_hzfh_20240531_SJ2024072286_02

--1.2 还款计划
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024072286_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_czdk_hzfh_20240531_SJ2024072286_03 AS
SELECT  T1.col_1 合同流水号_账户号
        ,T1.col_2 借据流水号_卡号
        ,T1.col_3 支行
        ,T1.col_4 团队
        ,T1.col_5 管户机构号
        ,T1.col_6 客户名称
        ,T1.col_7 客户号
        ,T1.col_8 截止6月末借据余额_含核销__透支本金余额_含分期未还
        ,T1.col_9 借据金额
        ,substr(T1.col_10, 1, 10) 借据发放日期
        ,substr(T1.col_11, 1, 10) 借据约定到期日期
        ,T1.col_12 业务品种
        ,T1.col_13 助兴通类型
        ,T1.col_14 本息最长逾期天数
        ,T1.col_15 本金逾期日期
        ,T1.col_16 利息逾期日期
        ,T1.col_17 主担保方式
        ,T1.col_18 还本计息代码
        ,T2.rpay_trm 还款期数
        ,T2.tmn_rpay_amt 每期还款额
        ,T2.rpay_dt 还款日期
        ,T2.rpay_amt 应还本金额
        ,T2.intr_amt 应还利息金额
FROM qbi_file_20240724_11_25_32 T1
LEFT JOIN edw.dwd_bus_loan_rpay_pln_all_dd T2 --贷款还款计划
on t1.COL_2 =T2.ctr_id
and T2.dt='20240725'
WHERE   T1.PT = MAX_PT('qbi_file_20240724_11_25_32')
;


-- SELECT * from tmp_czdk_hzfh_20240531_SJ2024072286_03
**01-数据需求_保全_2024_SJ2024072356_陈敏珠_利息减免情况检查.sql
-- 2024年审批完成的利息减免方案和重组方案带减免是否逆流程和是否已落实减免

-- 1.利息减免方案：当前阶段、方案编号、合同编号、团队机构号、客户名称、方案类型、收回方式、收回日期、应收总和、实收总和、申请减免总金额、



-- 申请人、申请机构、申请日期、本金结清日期、实际减免日期、实际减免金额；



-- 利息减免：

-- 如果是贷款利息减免：edw.zcbq_cash_back_plan   --现金收回方案

-- 如果是随贷通：  edw.zcbq_card_cash_back_plan





-- 2.重组（利息减免）方案/重组(压额及利息减免)方案：方案编号、合同号、团队机构号、方案类型、重组类型、申请减免金额、



-- 、方案金额、重组期限、客户名称、登记人、登记机构、登记日期、实际减免金额、本金结清日期、实际减免日期



--  loan_restruct_plan T  --助兴通贷款方案申请



--1.2	重组（利息减免）方案/重组(压额及利息减免)方案



SELECT T.plan_no  as 方案编号

       ,'重组利息减免'  as 方案类型

       ,   as 合同号

       ,   as 团队机构号

       ,   as 重组类型

       ,T.apply_dera_amt   as 申请减免金额

       ,T.plan_amt as 方案金额

       ,T.deadlines as 助兴通期限

       ,T.cust_no as 重组客户号

       ,T.cust_nm  as 重组客户名称

       ,T.input_usr_no  as 登记人

       ,T.input_org_no as 登记机构

       ,T.input_date as 登记日期

       ,  as 实际减免金额

       , as 本金结清日期

       ,  as 实际减免日期

FROM edw.zcbq_loan_restruct_plan T  --助兴通贷款方案申请

WHERE T.dt='@@{yyyyMMdd}'

and T.plan_type='02'  --重组利息减免

and T.wf_status='997'  --审批完成

union all

SELECT T.plan_no  as 方案编号

       ,'重组(压额及利息减免)方案'  as 方案类型

       ,   as 合同号

       ,   as 团队机构号

       ,   as 重组类型

       ,T.apply_dera_amt   as 申请减免金额

       ,T.plan_amt as 方案金额

       ,T.deadlines as 助兴通期限

       ,T.cust_no as 重组客户号

       ,T.cust_nm  as 重组客户名称

       ,T.input_usr_no  as 登记人

       ,T.input_org_no as 登记机构

       ,T.input_date as 登记日期

       ,  as 实际减免金额

       , as 本金结清日期

       ,  as 实际减免日期

FROM edw.zcbq_loan_restruct_plan T  --助兴通贷款方案申请

WHERE T.dt='@@{yyyyMMdd}'

and T.plan_type='04'  --（重组(压额及利息减免)方案）

and T.wf_status='997'  --审批完成

;



--1.1 贷款和随贷通利息减免方案：当前阶段、方案编号、合同编号、团队机构号、客户名称、方案类型、收回方式、收回日期、应收总和、实收总和、申请减免总金额、

-- 申请人、申请机构、申请日期、本金结清日期、实际减免日期、实际减免金额；



SELECT * FROM edw.zcbq_cash_back_plan   --现金收回方案

WHERE dt='20240710';













SELECT * FROM edw.dwd_code_library_dd t

WHERE t.dt='20240710'

and t.tbl_nm=upper('zcbq_cash_back_plan')

and t.fld_nm=upper('plan_type')
**01-数据需求_保全_2024_SJ2024072526_吴伟_用于呆账核销年度检查.sql
-- 目的：查询已核销业务在核销日期时，合同下本息最长逾期时间（合同若有多个借据，则取逾期时间最长借据；利息逾期时间与本金逾期时间取孰长）。
-- 数据范围：分为三个，一是分行核销贷款、二是分行核销信用卡、三是村行核销贷款。
-- dg取数底表：（报表平台的18011和18012），
-- 18011 ZCBQ_CANCEL_LOAN_BOOK  ：edw.zcbq_cancel_loan_book  --贷款核销台账
-- 18012 ZCBQ_CANCEL_CARD_BOOK  ：edw.zcbq_cancel_card_book  --信用卡核销台账
-- dg供参考用底表：app_rpt.fct_loan_wrt_off_dd    --贷款核销报表
--               app_rpt.fct_card_wrt_off_dd  --信用卡核销报表


--1.1 村行核销贷款
DROP TABLE if EXISTS tmp_chhxdk_SJ2024072526 purge;
CREATE TABLE IF NOT EXISTS tmp_chhxdk_SJ2024072526 as
SELECT COL_2 核心分行机构号
,COL_3 核心分行机构名称
,COL_4 合同流水号
,COL_5 借据流水号
,COL_6 客户号
,COL_7 客户名称
,COL_8 产品名称
,COL_9 币种
,P1.lng_ovd_intr_day 本息最长逾期天数
-- ,COL_18 本金逾期日期
-- ,COL_19 利息逾期日期
,COL_44 核销日期
FROM qbi_file_20240730_18_25_48 P
left join app_rpt.fct_loan_wrt_off_dd P1
on P.COL_4=P1.busi_ctr_id
AND P.COL_5=P1.dbil_id
and P1.dt=REPLACE(P.COL_44,'-','')
WHERE P.pt=MAX_PT('qbi_file_20240730_18_25_48')
;

--1.2 分行信用卡
DROP TABLE if EXISTS tmp_fhxyk_SJ2024072526 purge;
CREATE TABLE IF NOT EXISTS tmp_fhxyk_SJ2024072526 as
SELECT col_1 序号
,col_2 核心分行机构号
,col_3 核心分行机构名称
,col_4 卡号
,col_5 客户编号
,col_6 客户名称
,col_7 业务品种
,col_8 信用卡账户
,col_9 币种
,col_10 信用额度
,P1.od_tm 逾期期数
,col_43 核销日期
FROM qbi_file_20240730_19_32_52 P
left join app_rpt.fct_card_wrt_off_dd P1
on P.COL_4=P1.cr_crd_ar_id
and P1.dt=P.col_43
WHERE P.pt=MAX_PT('qbi_file_20240730_19_32_52')
;



--1.3 分行贷款
DROP TABLE if EXISTS tmp_fhdk_SJ2024072526 purge;
CREATE TABLE IF NOT EXISTS tmp_fhdk_SJ2024072526 as
SELECT COL_2 核心分行机构号
,COL_3 核心分行机构名称
,COL_4 合同流水号
,COL_5 借据流水号
,COL_6 客户号
,COL_7 客户名称
,COL_8 产品名称
,COL_9 币种
-- ,P1.lng_ovd_intr_day 本息最长逾期天数
-- -- ,COL_18 本金逾期日期
-- -- ,COL_19 利息逾期日期
,COL_44 核销日期
FROM qbi_file_20240730_19_42_47 P
left join app_rpt.fct_loan_wrt_off_dd P1
on P.COL_4=P1.busi_ctr_id
AND P.COL_5=P1.dbil_id
and P1.dt=REPLACE(P.COL_44,'-','')
WHERE P.pt=MAX_PT('qbi_file_20240730_19_42_47')
;
**01-数据需求_保全_2024_SJ20240729156_张颖_信用卡客户催记_改成新信贷的表_.sql
-- 字段：字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记时间、
--  ，催记渠道、外呼电话、与本人关系、外呼状态、催收状态、催收内容、客户标签（即对应催收标签列表）、
-- 客户手机号码，联系人电话号码/手机，与客户的关系。多个联系人就取多个。


-- edw.zcbq_risk_collect_record  --催收痕迹
-- edw.loan_creditcard_customer --信用卡客户情况

-- 1、整体：截至取数操作日最新的催记DT，取附件清单内信用卡卡号对应的客户的全量催记；第二批和第三批分开
-- 2、时间：调取附件清单内信用卡的对应催记
-- 3、字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记时间、催记渠道、外呼电话、
--与本人关系、外呼状态、催收状态、催收内容、催收对象我行银行卡客户补充资料中的手机号码或联系人对应号码、信贷系统本人接收短信最新有效号码


-----------------取新信贷的表-------------------------------------------

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xykcs_SJ20240729156_03 PURGE;

CREATE TABLE  IF NOT EXISTS  lab_bigdata_dev.tmp_xykcs_SJ20240729156_03 AS
SELECT  T1.col_1 批次
        ,T1.col_2 卡号
        ,T2.coln_date    AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm      AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no  AS 催收人员编号行内
        ,T2.coln_user    AS 催收人员名称行内
        ,T2.out_person   AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date   AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        ,T2.phone        AS 外呼电话号码
        ,T2.relation     AS 与本人关系
        ,T2.call_status  AS 外呼状态
        ,CASE
           WHEN t2.collect_status = '01' THEN '承诺还款'
           WHEN t2.collect_status = '02' THEN '谈判中'
           WHEN t2.collect_status = '05' THEN '其他'
           WHEN t2.collect_status = '03' THEN '转告还款'
           WHEN t2.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
        ,t2.coln_result  AS 催收内容
        ,CASE
           WHEN T2.DC_THOGH_STATUS = '1'  THEN '无人接听'
           WHEN T2.DC_THOGH_STATUS = '100' THEN '未接通'
           WHEN T2.DC_THOGH_STATUS = '111' THEN '已告知，未明显表态，有效接通'
           WHEN T2.DC_THOGH_STATUS = '12'  THEN '已告知'
           WHEN T2.DC_THOGH_STATUS = '130' THEN '其他-请看催记备注'
           WHEN T2.DC_THOGH_STATUS = '131' THEN '否认消费（部分交易）'
           WHEN T2.DC_THOGH_STATUS = '132' THEN '否认消费（全部交易）'
           WHEN T2.DC_THOGH_STATUS = '134' THEN '拒绝还款，要投诉'
           WHEN T2.DC_THOGH_STATUS = '135' THEN '无还款能力'
           WHEN T2.DC_THOGH_STATUS = '136' THEN '其他-见催记备注'
           WHEN T2.DC_THOGH_STATUS = '137' THEN '失联'
           WHEN T2.DC_THOGH_STATUS = '138' THEN '生病'
           WHEN T2.DC_THOGH_STATUS = '139' THEN '涉刑'
           WHEN T2.DC_THOGH_STATUS = '140' THEN '欺诈情况'
           WHEN T2.DC_THOGH_STATUS = '141' THEN '反催特点'
           WHEN T2.DC_THOGH_STATUS = '142' THEN '死亡'
           WHEN T2.DC_THOGH_STATUS = '143' THEN '移交专家'
           WHEN T2.DC_THOGH_STATUS = '144' THEN '其他-详见催记备注'
           WHEN T2.DC_THOGH_STATUS = '145' THEN '分期'
           WHEN T2.DC_THOGH_STATUS = '146' THEN '减免'
           WHEN T2.DC_THOGH_STATUS = '147' THEN 'ZXT/ZD'
           WHEN T2.DC_THOGH_STATUS = '149' THEN '他人代偿（需登记关系）'
           WHEN T2.DC_THOGH_STATUS = '150' THEN '承诺一次性还款'
           WHEN T2.DC_THOGH_STATUS = '160'  THEN '要求短分期（小于等于24期）'
           WHEN T2.DC_THOGH_STATUS = '161' THEN '要求长分期（大于24期）'
           WHEN T2.DC_THOGH_STATUS = '162' THEN '要求全额减免利息'
           WHEN T2.DC_THOGH_STATUS = '163' THEN '已承诺减免'
           WHEN T2.DC_THOGH_STATUS = '165'  THEN '话务条异常'
           WHEN T2.DC_THOGH_STATUS = '168' THEN '空号/停机'
           WHEN T2.DC_THOGH_STATUS = '17'  THEN '通话中全部归还'
           WHEN T2.DC_THOGH_STATUS = '2'   THEN '拒接'
           WHEN T2.DC_THOGH_STATUS = '3'   THEN '忙音'
           WHEN T2.DC_THOGH_STATUS = '4'   THEN '错号'
           WHEN T2.DC_THOGH_STATUS = '5'   THEN '空号'
           WHEN T2.DC_THOGH_STATUS = '6'   THEN '停机'
           WHEN T2.DC_THOGH_STATUS = '7'   THEN '关机'
           WHEN T2.DC_THOGH_STATUS = '8'   THEN '呼叫限制'
           WHEN T2.DC_THOGH_STATUS = '9'   THEN '话务条异常'
           ELSE ''
         END             AS 电催结果
        ,T3.ctc_tel_no 联系人电话号码
        ,T3.ctc_mbl_no 联系人手机号
        ,T4.CTC_TEL 信贷系统信用卡预留有效号码
FROM    lab_bigdata_dev.qbi_file_20240729_19_36_33 T1 --导入信用卡
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.col_2 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  T1.cr_crd_card_nbr
                         ,T2.ctc_tel_no --联系人电话号码
                         ,T2.ctc_mbl_no --联系人手机号
                 FROM    edw.dws_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息汇总
                 LEFT JOIN    edw.loan_cst_emge_ctc_inf T2 --紧急联系人信息
                 ON      T1.cst_id = T2.cst_id
                 AND     T2.dt = '@@{yyyyMMdd}'
                 WHERE   T1.dt = '@@{yyyyMMdd}'
             ) T3
ON      T1.col_2 = T3.cr_crd_card_nbr
LEFT JOIN    (
                 SELECT  T1.CST_ID
                         ,T1.cr_crd_card_nbr
                         ,T2.CTC_TEL
                 FROM    edw.dws_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息汇总
                 LEFT JOIN    (
                                  SELECT  cctr.CST_ID
                                          ,cct.CTC_TEL
                                  FROM    edw.loan_cst_ctc_tel cct --联系电话信息
                                  LEFT JOIN    edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息
                                  ON      cctr.REL_SERNO = cct.SERNO
                                  AND     cct.DEL_IND = '0' --删除标识,0-否 1-是
                                  AND     cctr.dt = '@@{yyyyMMdd}'
                                  WHERE   cct.dt = '@@{yyyyMMdd}'
                                --   AND     cctr.SMS_RCV_TEL_NO_IND = '1' --短信接收号码标志,1-是 0-否
                                  AND     cctr.cr_crd_rsrv_tel_ind = '1'   --信用卡预留电话标志 ,1-是 0-否
                                  AND     cctr.REL_TYP = '0001'  -- 关联类型，本人
                              ) T2
                 ON      T2.CST_ID = T1.cst_id
                 WHERE   T1.dt = '@@{yyyyMMdd}'
             ) T4
ON      T1.col_2 = T4.cr_crd_card_nbr
WHERE   T1.pt = MAX_PT('qbi_file_20240729_19_36_33')
;




-- SELECT * FROM tmp_xykcs_SJ20240729156_03 WHERE 电催结果='无人接听'


-- 卡号 IN ( '6222873324628105' , '6222873024968108' , '6222873331864107' , '6222873321071101' )
**01-数据需求_保全_2024_SJ2024072996_周小四_诉讼信用卡客户基本信息_含信用卡申请编号_.sql
-- 序号	管户机构、卡号、客户号	客户名称、性别	民族	出生日期、身份证号、身份证地址	手机号码、卡申请编号、信用额度
DROP TABLE if EXISTS tmp_SJ2024072996_final purge;
CREATE TABLE IF NOT EXISTS tmp_SJ2024072996_final AS
SELECT  t1.col_1 序号
        ,t1.col_2 分行
        ,t1.col_3 卡号
        ,t1.col_4 客户号
        ,t1.col_5 姓名
        ,CASE
           WHEN t2.gdr_cd = 1 THEN '男'
           WHEN t2.gdr_cd = 2 THEN '女'
         END                      AS 性别
        ,CASE
           WHEN t2.rac_cd = '01' THEN '汉族'
           WHEN t2.rac_cd = '02' THEN '蒙古族'
           WHEN t2.rac_cd = '03' THEN '回族'
           WHEN t2.rac_cd = '06' THEN '苗族'
           WHEN t2.rac_cd = '07' THEN '彝族'
           WHEN t2.rac_cd = '08' THEN '壮族'
           WHEN t2.rac_cd = '09' THEN '布依族'
           WHEN t2.rac_cd = '11' THEN '满族'
           WHEN t2.rac_cd = '12' THEN '侗族'
           WHEN t2.rac_cd = '15' THEN '土家族'
           WHEN t2.rac_cd = '18' THEN '傣族'
           WHEN t2.rac_cd = '57' THEN '其他'
           ELSE t2.rac_cd
         END                      AS 民族
        ,substr(t2.doc_nbr, 7, 8) AS 出生日期
        ,t2.doc_nbr 身份证号
        -- ,t2.reg_adr_dtl_inf 户籍地址
        -- ,t2.fam_adr_dtl_inf 家庭地址
        ,t4.full_addr 身份证地址
        ,t2.m_tel_no 手机号码
        ,t3.busi_apl_id 卡申请编号
        ,t3.cst_crd_lmt 信用额度
FROM    lab_bigdata_dev.qbi_file_20240729_16_34_20 t1
LEFT JOIN    adm_pub.adm_csm_cbas_idv_bas_inf_dd t2 ----客户集市-客户基础-对私客户基础信息
ON      t1.col_4 = t2.cst_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd t3 --信用卡卡片信息
ON      t1.col_3 = t3.cr_crd_card_nbr
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cust_no
                         --  ,t4.cust_nt
                         ,t3.full_addr
                 FROM    edw.ecif_t00_nor_cust_no_rec t1 --对私客户号识别信息表
                 LEFT JOIN    edw.ecif_t02_nor_cust_contact_rel t2 --对私参与人和联系信息的关系表
                 ON      t1.party_id = t2.party_id
                 AND     t2.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.ecif_t03_nor_cust_addr_info t3 --对私客户联系地址信息表
                 ON      t2.cont_id = t3.addr_id
                 AND     t3.dt = '@@{yyyyMMdd}'
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 AND     t2.cont_type = '050100'
             ) t4
ON      t2.cst_id = t4.cust_no
WHERE   t1.pt = MAX_PT('qbi_file_20240729_16_34_20')
ORDER BY round(t1.col_1, 0);

-- SELECT * FROM tmp_SJ2024072996_final;
**01-数据需求_保全_2024_SJ20240730126_周小四_信用卡交易明细.sql
-- 附件涉及信用卡业务自启用时点其至2024年7月28日止的信用卡交易明细清单
--（1、请按照单笔卡交易先后顺序出数；2、请按照附件清单顺序出数；3、示例见附件）
-- 字段：交易日期、交易时间，交易类型描述、交易金额、交易币种、撤销/冲正标志、入账日期
--导入的字段：序号、管户机构、卡号、客户号、客户名称


DROP TABLE if EXISTS tmp_zxs_SJ20240730126 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_zxs_SJ20240730126 as
SELECT cast(T.col_1 as int) 序号
       ,T.col_2 管户机构
       ,T.col_3 卡号
       ,T.col_4 客户号
       ,T.col_5 客户名称
       ,T1.trx_dt 交易日期
       ,T1.trx_tm 交易时间
       ,T1.trx_typ_dscr 交易类型描述
       ,T1.trx_amt 交易金额
       ,T1.trx_ccy_cd 交易币种代码
       ,T1.wdw_rvs_ind 	撤销冲正标志
       ,T1.act_dt 入帐日期
       ,row_number() OVER ( ORDER BY cast(T.col_1 as int), trx_dt, trx_tm) rank
FROM qbi_file_20240731_16_48_46 T
LEFT JOIN edw.dwd_bus_crd_cr_crd_trx_dtl_di T1 --信用卡客户交易流水
on T.col_3=T1.cr_crd_card_nbr
and T1.dt<='20240728'
WHERE T.pt=MAX_PT('qbi_file_20240731_16_48_46')
;

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zxs_SJ20240730126_f PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zxs_SJ20240730126_f AS
SELECT  *
FROM    lab_bigdata_dev.tmp_zxs_SJ20240730126
ORDER BY rank;
**01-数据需求_保全_2024_SJ2024080171_周小四_法院批量诉讼信用卡客户基本信息_含卡申请编号_.sql
-- 1、附件K到R列取数； 性别	民族	出生日期	身份证号	身份证地址	手机号码	卡申请编号	信用额度
-- 2、附件所涉信用卡客户自启用时点其至2024年7月31日止的信用卡交易明细清单（1、请按照单笔卡交易先后顺序出数；2、请按照附件清单顺序出数；3、示例见附件）

--第四批信用卡客户交易明细
---结果表1,附件涉及信用卡业务的以下字段&ldquo;性别、民族、出生日期、户籍地址、身份证号、联系电话、卡申请编号、信用额度（卡申请时点）&rdquo;；
DROP TABLE IF EXISTS lab_bigdata_dev.temp_sjxqSJ2024080171 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.temp_sjxqSJ2024080171 AS
SELECT  CAST(a.col_1 AS INT) 序号
        ,row_number() OVER ( ORDER BY CAST(a.col_1 AS INT) ) rank
        ,a.col_2 诉讼批次
        ,a.col_3 管户机构
        ,a.col_4 卡号
        ,a.col_5 客户名称
        ,a.col_6 客户号
        ,substr(a.col_7, 1, 10) 本息余额计算截止日
        ,a.col_8 透支本金
        ,a.col_9 利息及违约金
        ,a.col_10 逾期期数
        ,T1.cd_val_dscr 性别
        ,T2.cd_val_dscr 民族
        ,b.bth_dt 出生日期
        ,b.doc_nbr 证件号
        ,b.reg_adr 户籍地址
        ,b.mbl_nbr 手机
        ,q.busi_apl_id 卡申请编号
        ,a.crd_lmt 信用额度
FROM    (
            SELECT  P.col_1 --序号
                    ,P.col_2 --诉讼批次
                    ,P.col_3 --管户机构
                    ,P.col_4 --卡号
                    ,P.col_5 --客户名称
                    ,P.col_6 --客户号
                    ,P.col_7 --本息余额计算截止日
                    ,P.col_8 --透支本金
                    ,P.col_9 --利息及违约金
                    ,P.col_10 --逾期期数
                    ,T.cst_id
                    -- ,T.cst_nm
                    ,T.crd_lmt
            FROM    qbi_file_20240801_19_13_08 P --导入数据
            LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T --信用卡账户信息汇总
            ON      P.col_4 = T.late_main_card_card_nbr
            AND     T.dt = '@@{yyyyMMdd}'
            WHERE   P.PT = MAX_PT('qbi_file_20240801_19_13_08')
        ) a
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd b --个人客户基本信息汇总表
ON      a.col_6 = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T1
ON      b.gdr_cd = T1.cd_val
AND     T1.dt = '@@{yyyyMMdd}'
AND     T1.tbl_nm = upper('dws_cst_idv_bas_inf_dd')
AND     T1.fld_nm = upper('gdr_cd')
LEFT JOIN    edw.dwd_code_library_dd T2
ON      b.rac_cd = T2.cd_val
AND     T2.dt = '@@{yyyyMMdd}'
AND     T2.tbl_nm = upper('dws_cst_idv_bas_inf_dd')
AND     T2.fld_nm = upper('rac_cd')
left join edw.dim_bus_crd_cr_crd_inf_dd q --信用卡卡片信息
on a.col_4=q.cr_crd_card_nbr
and a.col_6=q.cst_id
and q.dt='@@{yyyyMMdd}'
-- LEFT JOIN    edw.loan_lmt_aply_biz q --用信方案,替换新信贷的信用卡申请表
-- ON      a.col_6 = q.cst_id
-- AND     q.dt = '@@{yyyyMMdd}'
-- AND     q.prd_no = '2002010101001'  --信用卡
;

select count(1) FROM lab_bigdata_dev.temp_sjxqSJ2024080171 WHERE 卡号 in ('6222870000187455','6222873300657391','6222873030310105','6222873000088673')

--2、附件涉及信用卡业务自启用时点其至2024年7月31日止的信用卡交易明细清单；

-- 查询报表信息  -- 报表管理平台：3103信用卡交易明细(资保)
-- 卡号 交易日期	交易时间	交易类型描述	交易金额	交易币种	撤销、冲正标志	入帐日期

DROP TABLE IF EXISTS tmp_fa_data_query_20240731 PURGE;

CREATE TABLE IF NOT EXISTS tmp_fa_data_query_20240731 AS
SELECT   CAST(P.col_1 AS INT) 序号
        ,row_number() OVER ( ORDER BY CAST(P.col_1 AS INT) , a1.trx_dt , a1.trx_tm ) rank
        ,P.col_2 诉讼批次
        ,P.col_3 管户机构
        ,P.col_4 卡号
        ,P.col_5 客户名称
        ,P.col_6 客户号
        ,substr(P.col_7, 1, 10) 本息余额计算截止日
        ,P.col_8 透支本金
        ,P.col_9 利息及违约金
        ,P.col_10 逾期期数
        -- ,a2.cst_nm       AS 姓名
        -- ,a2.doc_id       AS 证件号
        ,a1.trx_dt       AS 交易日期
        ,a1.trx_tm       AS 交易时间
        ,a1.trx_typ_dscr AS 交易类型描述
        ,a1.trx_amt      AS 交易金额
        ,a1.trx_ccy_cd   AS 交易币种
        ,a1.wdw_rvs_ind  AS 撤销冲正标志
        ,a1.act_dt       AS 入帐日期
FROM    qbi_file_20240801_19_13_08 P
LEFT JOIN    edw.dwd_bus_crd_cr_crd_trx_dtl_di a1 --信用卡客户交易流水
ON      P.col_4 = a1.cr_crd_card_nbr
AND     a1.dt BETWEEN '20100101' AND '20240731'
-- LEFT JOIN    app_rpt.FCT_CR_CRD_MGT_INF a2 --信用卡报表权限控制表
-- ON      a1.cr_crd_card_nbr = a2.main_crd_no
-- AND     a2.dt = '20240731'
WHERE   P.pt = MAX_PT('qbi_file_20240801_19_13_08');



SELECT count(1) FROM tmp_fa_data_query_20240731
-- SELECT count(DISTINCT 交易时间) FROM tmp_fa_data_query_20240731


--另外方式：
-- DROP TABLE if EXISTS tmp_zxs_SJ2024080171_02 PURGE ;
-- CREATE TABLE IF NOT EXISTS tmp_zxs_SJ2024080171_02 as
-- SELECT cast(T.col_1 as int) 序号
--        ,T.col_2 管户机构
--        ,T.col_3 卡号
--        ,T.col_4 客户号
--        ,T.col_5 客户名称
--        ,T1.trx_dt 交易日期
--        ,T1.trx_tm 交易时间
--        ,T1.trx_typ_dscr 交易类型描述
--        ,T1.trx_amt 交易金额
--        ,T1.trx_ccy_cd 交易币种代码
--        ,T1.wdw_rvs_ind 	撤销冲正标志
--        ,T1.act_dt 入帐日期
--        ,row_number() OVER ( ORDER BY cast(T.col_1 as int), trx_dt, trx_tm) rank
-- FROM qbi_file_20240731_16_48_46 T
-- LEFT JOIN edw.dwd_bus_crd_cr_crd_trx_dtl_di T1 --信用卡客户交易流水
-- on T.col_3=T1.cr_crd_card_nbr
-- and T1.dt<='20240728'
-- WHERE T.pt=MAX_PT('qbi_file_20240731_16_48_46')
-- ORDER BY rank
-- ;

--结果表
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zxs_SJ2024080171_f PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zxs_SJ2024080171_f AS
-- SELECT  *
-- FROM    lab_bigdata_dev.tmp_zxs_SJ2024080171
-- ORDER BY rank;
**01-数据需求_保全_2024_SJ2024080176_张颖_信用卡客户催记_第四批.sql
-- 字段：字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记时间、
--  ，催记渠道、外呼电话、与本人关系、外呼状态、催收状态、催收内容、客户标签（即对应催收标签列表）、
-- 客户手机号码，联系人电话号码/手机，与客户的关系。多个联系人就取多个。


-- edw.zcbq_risk_collect_record  --催收痕迹
-- edw.loan_creditcard_customer --信用卡客户情况

-- 1、整体：截至取数操作日最新的催记DT，取附件清单内信用卡卡号对应的客户的全量催记；第二批和第三批分开
-- 2、时间：调取附件清单内信用卡的对应催记
-- 3、字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记时间、催记渠道、外呼电话、
--与本人关系、外呼状态、催收状态、催收内容、催收对象我行银行卡客户补充资料中的手机号码或联系人对应号码、信贷系统本人接收短信最新有效号码


-----------------取新信贷的表-------------------------------------------

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xykcs_SJ2024080176_03 PURGE;

CREATE TABLE  IF NOT EXISTS  lab_bigdata_dev.tmp_xykcs_SJ2024080176_03 AS
SELECT  T1.col_1 卡号
        ,T2.coln_date    AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm      AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no  AS 催收人员编号行内
        ,T2.coln_user    AS 催收人员名称行内
        ,T2.out_person   AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date   AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        ,T2.phone        AS 外呼电话号码
        ,T2.relation     AS 与本人关系
        ,T2.call_status  AS 外呼状态
        ,CASE
           WHEN t2.collect_status = '01' THEN '承诺还款'
           WHEN t2.collect_status = '02' THEN '谈判中'
           WHEN t2.collect_status = '05' THEN '其他'
           WHEN t2.collect_status = '03' THEN '转告还款'
           WHEN t2.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
        ,t2.coln_result  AS 催收内容
        ,CASE
           WHEN T2.DC_THOGH_STATUS = '1'  THEN '无人接听'
           WHEN T2.DC_THOGH_STATUS = '100' THEN '未接通'
           WHEN T2.DC_THOGH_STATUS = '111' THEN '已告知，未明显表态，有效接通'
           WHEN T2.DC_THOGH_STATUS = '12'  THEN '已告知'
           WHEN T2.DC_THOGH_STATUS = '130' THEN '其他-请看催记备注'
           WHEN T2.DC_THOGH_STATUS = '131' THEN '否认消费（部分交易）'
           WHEN T2.DC_THOGH_STATUS = '132' THEN '否认消费（全部交易）'
           WHEN T2.DC_THOGH_STATUS = '134' THEN '拒绝还款，要投诉'
           WHEN T2.DC_THOGH_STATUS = '135' THEN '无还款能力'
           WHEN T2.DC_THOGH_STATUS = '136' THEN '其他-见催记备注'
           WHEN T2.DC_THOGH_STATUS = '137' THEN '失联'
           WHEN T2.DC_THOGH_STATUS = '138' THEN '生病'
           WHEN T2.DC_THOGH_STATUS = '139' THEN '涉刑'
           WHEN T2.DC_THOGH_STATUS = '140' THEN '欺诈情况'
           WHEN T2.DC_THOGH_STATUS = '141' THEN '反催特点'
           WHEN T2.DC_THOGH_STATUS = '142' THEN '死亡'
           WHEN T2.DC_THOGH_STATUS = '143' THEN '移交专家'
           WHEN T2.DC_THOGH_STATUS = '144' THEN '其他-详见催记备注'
           WHEN T2.DC_THOGH_STATUS = '145' THEN '分期'
           WHEN T2.DC_THOGH_STATUS = '146' THEN '减免'
           WHEN T2.DC_THOGH_STATUS = '147' THEN 'ZXT/ZD'
           WHEN T2.DC_THOGH_STATUS = '149' THEN '他人代偿（需登记关系）'
           WHEN T2.DC_THOGH_STATUS = '150' THEN '承诺一次性还款'
           WHEN T2.DC_THOGH_STATUS = '160'  THEN '要求短分期（小于等于24期）'
           WHEN T2.DC_THOGH_STATUS = '161' THEN '要求长分期（大于24期）'
           WHEN T2.DC_THOGH_STATUS = '162' THEN '要求全额减免利息'
           WHEN T2.DC_THOGH_STATUS = '163' THEN '已承诺减免'
           WHEN T2.DC_THOGH_STATUS = '165'  THEN '话务条异常'
           WHEN T2.DC_THOGH_STATUS = '168' THEN '空号/停机'
           WHEN T2.DC_THOGH_STATUS = '17'  THEN '通话中全部归还'
           WHEN T2.DC_THOGH_STATUS = '2'   THEN '拒接'
           WHEN T2.DC_THOGH_STATUS = '3'   THEN '忙音'
           WHEN T2.DC_THOGH_STATUS = '4'   THEN '错号'
           WHEN T2.DC_THOGH_STATUS = '5'   THEN '空号'
           WHEN T2.DC_THOGH_STATUS = '6'   THEN '停机'
           WHEN T2.DC_THOGH_STATUS = '7'   THEN '关机'
           WHEN T2.DC_THOGH_STATUS = '8'   THEN '呼叫限制'
           WHEN T2.DC_THOGH_STATUS = '9'   THEN '话务条异常'
           ELSE ''
         END             AS 电催结果
        ,T3.ctc_tel_no 联系人电话号码
        ,T3.ctc_mbl_no 联系人手机号
        ,T4.CTC_TEL 信贷系统信用卡预留有效号码
FROM    lab_bigdata_dev.qbi_file_20240801_18_11_38 T1 --导入信用卡
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.col_1 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  T1.cr_crd_card_nbr
                         ,T2.ctc_tel_no --联系人电话号码
                         ,T2.ctc_mbl_no --联系人手机号
                 FROM    edw.dws_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息汇总
                 LEFT JOIN    edw.loan_cst_emge_ctc_inf T2 --紧急联系人信息
                 ON      T1.cst_id = T2.cst_id
                 AND     T2.dt = '@@{yyyyMMdd}'
                 WHERE   T1.dt = '@@{yyyyMMdd}'
             ) T3
ON      T1.col_1 = T3.cr_crd_card_nbr
LEFT JOIN    (
                 SELECT  T1.CST_ID
                         ,T1.cr_crd_card_nbr
                         ,T2.CTC_TEL
                 FROM    edw.dws_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息汇总
                 LEFT JOIN    (
                                  SELECT  cctr.CST_ID
                                          ,cct.CTC_TEL
                                  FROM    edw.loan_cst_ctc_tel cct --联系电话信息
                                  LEFT JOIN    edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息
                                  ON      cctr.REL_SERNO = cct.SERNO
                                  AND     cct.DEL_IND = '0' --删除标识,0-否 1-是
                                  AND     cctr.dt = '@@{yyyyMMdd}'
                                  WHERE   cct.dt = '@@{yyyyMMdd}'
                                --   AND     cctr.SMS_RCV_TEL_NO_IND = '1' --短信接收号码标志,1-是 0-否
                                  AND     cctr.cr_crd_rsrv_tel_ind = '1'   --信用卡预留电话标志 ,1-是 0-否
                                  AND     cctr.REL_TYP = '0001'  -- 关联类型，本人
                              ) T2
                 ON      T2.CST_ID = T1.cst_id
                 WHERE   T1.dt = '@@{yyyyMMdd}'
             ) T4
ON      T1.col_1 = T4.cr_crd_card_nbr
WHERE   T1.pt = MAX_PT('qbi_file_20240801_18_11_38')
;




-- SELECT * FROM tmp_xykcs_SJ2024080176_03
**01-数据需求_保全_2024_SJ2024080256_谢晓勇_对存量逾期信用卡客户进行分析及电话联系.sql
-- 管护分行	分行	管户机构	卡号	划片	卡产品名称	是否网申卡	客户名称
-- 宁波分行存量逾期信用卡客户对应身份证号码，联系电话，工作单位，工作地址，户籍地址，居住地址
DROP TABLE IF EXISTS tmp_xxy_SJ2024080256 PURGE;

CREATE TABLE IF NOT EXISTS tmp_xxy_SJ2024080256 AS
SELECT  T.col_1 管护分行
        ,T.col_2 分行
        ,T.col_3 管户机构
        ,T.col_4 卡号
        ,T.col_5 划片
        ,T.col_6 卡产品名称
        ,T.col_7 是否网申卡
        ,T.col_8 客户姓名
        ,T1.cst_id 客户号
        ,T2.doc_nbr 证件号码
        ,T2.mbl_nbr 联系电话
        ,T3.job_unt_nm 工作单位
        ,T2.wrk_adr 工作地址
        ,T2.reg_adr 户籍地址
        ,T2.fml_adr 家庭地址
FROM    qbi_file_20240807_09_16_51 T
LEFT JOIN    edw.dws_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息汇总
ON      T.col_4 = T1.cr_crd_card_nbr
AND     T1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd T3 --个人客户基本信息
ON      T2.cst_id = T3.cst_id
AND     T3.dt = '@@{yyyyMMdd}'
WHERE   T.pt = MAX_PT('qbi_file_20240807_09_16_51')
**01-数据需求_保全_2024_SJ2024080531_胡婷_用于跟进所有未结清重组贷款的还款落实情况.sql
--无导数权限

-- SELECT * FROM  tmp_sjxq_SJ2024080531;

drop table if exists tmp_sjxq_SJ2024080531 PURGE ;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024080531 as
SELECT  plan_type 方案类型
        ,plan_amt 方案金额
        ,maturity 到期日
        ,bor_date 借款日
        ,pay_type 还款方式
        ,rate 助兴通利率
        ,cust_nm 重组客户名称
        ,cust_no 重组客户号
        ,guar_mod 担保方式
        ,bor_change 借款人主体是否变更
        ,ori_bor 原借款人
        ,new_bor 新借款人
        ,guar_change 担保人物是否变更
        ,ori_guar 原担保人
        ,new_guar 新担保人
        ,reg_situ 收回情况
        ,int_dera 是否存在利息减免
        ,apply_dera_amt 申请减免金额
        ,dera_loan_amt 减免贷款本金
        ,dera_loan_int 减免贷款正常利息
        ,dera_loan_pent 减免贷款罚息
        ,dera_card_amt 减免随贷通卡金额
        ,dera_card_pent 减免随贷通卡罚息
        ,dera_card_int 减免随贷通卡正常利息
        ,dera_reason 情况说明及申请减免理由
        ,loan_context 助兴通贷款背景情况
        ,plan_dispo 助兴通方案说明及处置计划
        ,rate_des 利率调整说明
        ,act_cust_nm 实际助兴通客户名称
        ,act_cust_no 实际助兴通客户号
        ,act_amt 实际助兴通金额
        ,act_deadline 实际助兴通期限
        ,act_rate 实际助兴通利率
        ,act_busi_type 实际助兴通业务品种
        ,act_loan_purp 实际助兴通贷款用途
        ,act_guad_mod 实际助兴通担保方式
        ,had_used 方案是否被使用
FROM    edw.zcbq_loan_restruct_plan t ---助兴通贷款方案申请
WHERE   t.dt = '@@{yyyyMMdd}'
and cust_no in('7005606495',
'7005834122',
'7645100949',
'7677556492',
'7689800729',
'1600555280',
'1613881455',
'7005484668',
'7653962777',
'7006019250',
'7006190241',
'1600055722',
'7005730077',
'7005854979',
'7620171736',
'1652501547',
'1679341643',
'7006323098',
'7006326569',
'1602490390',
'7005741600',
'1671201792',
'1679183598',
'7006318236',
'1606931319',
'1610606996',
'7005912798',
'7006323562',
'1600198343',
'1676305781',
'7006065343',
'1604506390',
'1632285210',
'1643228337',
'7005905945',
'7006332919',
'1610433744',
'1611652094',
'7006415319',
'1673207923',
'1632649358',
'1679741921',
'7006041196',
'8611788094',
'1610259621',
'1672808152',
'1676932924',
'1677735076',
'7649691365',
'1636980361',
'1643810027',
'7006327157',
'1646724778',
'7005936611',
'1645960089',
'7006348011',
'7647744012',
'7005630656',
'7005835330',
'7005604776',
'7006227457',
'7006060881',
'1681095984',
'7005842532',
'1628957157',
'7005319692',
'7006011234',
'7643312530',
'1650036121',
'1650632728',
'7645730736',
'1647036137',
'7005618887',
'7005881757',
'7005911009',
'7669511362',
'1606008312',
'1649581866',
'7651296902',
'1607916005',
'1612299801',
'7005571319',
'7006084261',
'1651745949',
'7693844519',
'1644123876',
'7006364189',
'1604645082',
'1679370323')
**01-数据需求_保全_2024_SJ20240812101_梁世鹏_对剥离业务的管户交接数据盘点_已改成新信贷表_.sql
--为进一步推动剥离业务的信贷管户交接，现需对剥离业务的管户交接数据进行再梳理。
--1、数据日期最新的数据日期
--2、数据范围为附件中客户号下向下的全量未结清贷款/信用卡业务。（未结清的判断已在数据需求字段中进行说明）

--定期更新导入的表：qbi_file_20240814_15_42_47
-- DROP TABLE if EXISTS wsj_SJ2024081361_2 purge;
-- CREATE TABLE IF NOT EXISTS wsj_SJ2024081361_2 as
-- SELECT col_1 as 剥离分行
--        ,col_2 as 客户号
--        ,col_3 as 剥离日期
-- FROM  qbi_file_20240814_15_42_47 WHERE pt=MAX_PT('qbi_file_20240814_15_42_47');

-- SELECT * FROM LSP_SJ2024081361 WHERE 剥离时点业务管户机构名称 is not null

--结果表:贷款和信用卡合同
--- 贷款
drop table if EXISTS  lab_bigdata_dev.LSP_SJ2024081361 PURGE ;
create table if not EXISTS  LSP_SJ2024081361 as
select distinct *
from (
select distinct
    t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'贷款' 业务种类
    ,t2.CTR_SERNO 合同号_卡号
    ,case when t3.busi_ctr_id is not null then '是' else '否' end 是否已剥离
    ,case when t4.CTR_SERNO is not null then '否' else '是' end 是否已结清
    ,case when t5.CTR_SERNO is not null then '是' else '否' end 是否已核销
    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.CTR_SERNO is not null and t8.MGR_ID != t9.MGR_ID then '是'  else '否' end 业务是否已交接
    ,t10.余额 透支本金余额_合同余额_核后本金余额
    ,t12.pd_nm 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.MGR_ORG_ID 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.MGR_ID 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.MGR_ORG_ID 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.MGR_ID 剥离时点业务管户客户经理工号

from wsj_SJ2024081361_2 t1   --业务提供的数据
left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t2   --合同基础信息
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_loan_peel_loan_mng_dd t3  --剥离贷款管理
on t2.CTR_SERNO =t3.busi_ctr_id
and t3.dt ='${data_dt}'
and t3.peel_sts_cd ='997' --剥离
left join
(
    select t1.CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and DBIL_STS_CD !='1' --未结清   借据状态代码0 正常1 结清2 已核销3 准销户4 录入5 已减免
    group by t1.CTR_SERNO
) t4
on t2.CTR_SERNO =t4.CTR_SERNO
left join
(
    select t1.CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and DBIL_STS_CD ='2' --已核销
    group by t1.CTR_SERNO
) t5
on t2.CTR_SERNO =t5.CTR_SERNO
--判断客户管户经理工号与剥离时点客户管户经理工号是否一致
left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and t1.剥离日期 = t6.dt -- 客户剥离时管户
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'
--判断业务管户经理工号与剥离时点业务管户经理工号是否一致
left join edw.DWD_BUS_LOAN_CTR_MGR_INF_DD t8 --信贷合同管护信息
on t3.busi_ctr_id =t8.CTR_SERNO  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.peel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_loan_ctr_mgr_inf_dd t9 -- 信贷合同管护信息
on t2.CTR_SERNO =t9.CTR_SERNO and t9.dt ='${data_dt}' -- 业务当前管户
--透支本金余额/合同余额+核后本金余额(合同级)（若业务为核销业务需取合同项下的所有借据的核后本金余额与借据余额之和）
left join
(
    select t1.CTR_SERNO
    ,sum(WRT_OFF_AMT)+sum(prcp_bal) 余额
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    group by t1.CTR_SERNO
) t10
on t2.CTR_SERNO = t10.CTR_SERNO

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  -现客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join edw.DIM_BUS_LOAN_PRD_FRML_DD t12 --信贷产品信息
on t2.PRD_NO = t12.prd_no   and t12.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --现业务管户机构
on t9.MGR_ORG_ID = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.MGR_ID = t14.empe_id  and t14.dt ='${data_dt}'  --现业务客户经理

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.MGR_ORG_ID = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.MGR_ID = t17.empe_id  and t17.dt ='${data_dt}'

where t2.CTR_SERNO is not null

union

--- 信用卡
select distinct
     t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'信用卡' 业务种类
    ,t2.late_main_card_card_nbr 合同号_卡号
    ,case when t3.ctr_srl_nbr is not null then '是' else '否' end 是否已剥离
    ,case when t4.未结清金额 = 0  then '是' else '否' end 是否已结清
    ,case when t5.late_main_card_card_nbr is not null then '是' else '否' end 是否已核销

    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.cr_crd_card_nbr is not null and t8.frs_mgr_id != t9.frs_mgr_id then '是'  else '否' end 业务是否已交接

    ,t4.未结清金额 透支本金余额_合同余额_核后本金余额
    ,t12.cr_crd_pd_cmt 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.acs_org_id 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.frs_mgr_id 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.acs_org_id 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.frs_mgr_id 剥离时点业务管户客户经理工号

from wsj_SJ2024081361_2 t1
left join edw.dws_bus_crd_cr_crd_act_inf_dd t2 -- 信用卡账户信息汇总
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_crd_pel_cr_crd_mng_dd t3  -- 剥离信用卡管理
on t2.late_main_card_card_nbr =t3.ctr_srl_nbr and t3.dt ='${data_dt}' and t3.pel_sts_cd ='997' --剥离
left join
(
    SELECT  late_main_card_card_nbr
        ,nvl(H.IBS_RCV_FEE,0) + nvl(H.OBS_RCV_FEE,0) + nvl(H.RCV_INTR,0) + nvl(H.OVDR_BAL,0) + nvl(H.INSTL_RMN_NOT_PAID_PRCP_BAL,0) 未结清金额
    FROM   edw.DWS_BUS_CRD_CR_CRD_ACT_INF_DD H  -- 信用卡账户信息汇总
    where H.dt ='${data_dt}'
) t4
on t2.late_main_card_card_nbr =t4.late_main_card_card_nbr
left join
(
    select t1.late_main_card_card_nbr
    from edw.dws_bus_crd_cr_crd_act_inf_dd t1  -- 信用卡账户信息
    where t1.dt ='${data_dt}'
    and t1.act_sts_cd ='V' --已核销
) t5
on t2.late_main_card_card_nbr =t5.late_main_card_card_nbr

left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and t1.剥离日期= t6.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'

left join edw.DWD_BUS_CRD_CR_CRD_MGR_INF_DD t8 --信用卡管护信息
on t3.ctr_srl_nbr =t8.cr_crd_card_nbr  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.pel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t9 -- 信用卡管护信息
on t2.late_main_card_card_nbr =t9.cr_crd_card_nbr and t9.dt ='${data_dt}' -- 业务当前管户

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  --客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join
(
select t1.cr_crd_card_nbr,t2.cr_crd_pd_cmt
from edw.DIM_BUS_CRD_CR_CRD_INF_DD t1  --信用卡卡片信息
left join edw.dim_bus_crd_cr_crd_pd_inf_dd t2  --信用卡产品信息
on t1.cr_crd_pd_id = t2.cr_crd_pd_id  and t2.dt ='${data_dt}'
where t1.dt ='${data_dt}'
) t12 --产品表
on t2.late_main_card_card_nbr =t12.cr_crd_card_nbr

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --业务管户机构
on t9.acs_org_id = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.frs_mgr_id = t14.empe_id  and t14.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.acs_org_id = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.frs_mgr_id = t17.empe_id  and t17.dt ='${data_dt}'

where t2.late_main_card_card_nbr is not null
)
ORDER BY 剥离分行,客户号,剥离日期
;
**01-数据需求_保全_2024_SJ2024081276_梁世鹏_业务数据剥离时点与7月末的风险成本数据.sql
--SJ2024081276

--字段:本金余额-剥离日期、pd-剥离日期、lgd-剥离日期、风险成本-剥离日期	本金余额-20240731、pd-20240731、lgd-20240731、风险成本-20240731

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

--临时表：COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD
SELECT * FROM COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20240731'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

  UNION ALL

  SELECT
    T2.DT
    ,T2.DBIL_SRL_NO
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
    ,T2.PD_START_VALUE AS PD_ORIG_VALUE
    ,CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END AS LGD_ORIG_VALUE
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
    (CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END) AS RSK_COST
  FROM
  (
    SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
    ,T1.GRNT_MODE
    ,T1.OVD_REPAY_RATE REPAY_RATE
    ,T1.CST_PRCP_BAL
    ,T1.VOUCH_PERSON_NUMBER
    ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
    ,CASE
      WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
        THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
      ELSE 0
    END OVDR_MTH_TERM
    FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
    WHERE T1.DT>='20231231' AND T1.DT<='20240731'
    AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
  ) T2
;

---*******************全量业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

SELECT * FROM tmp_baoquan_SJ2024081276_blrq_02

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024081276_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024081276_blrq_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240814_11_30_29 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240814_11_30_29')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240814_11_30_29 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20240731'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240814_11_30_29')
and     (p.COL_2  like '62%' OR p.COL_2 like '42%')
;

-- SELECT COUNT(1) FROM tmp_baoquan_SJ2024081276_blrq_02

-- 2024年7月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024081276_20240731_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024081276_20240731_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240731
                 ,t.PD_ORIG_VALUE pd值_20240731
                 ,t.LGD_ORIG_VALUE lgd值_20240731
                 ,t.RSK_COST 风险成本_20240731
FROM    lab_bigdata_dev.qbi_file_20240814_11_30_29 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240731'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240814_11_30_29')
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
and substr(p.COL_2,1,2) not in('62','42')

union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240731
                 ,t.PD_ORIG_VALUE pd值_20240731
                 ,t.LGD_ORIG_VALUE lgd值_20240731
                 ,t.RSK_COST 风险成本_20240731
FROM    lab_bigdata_dev.qbi_file_20240814_11_30_29 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240731'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20240731'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240814_11_30_29')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


--结果表:
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024081276_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024081276_0603_02 AS
SELECT  distinct t1.剥离所属分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20240731
       ,t2.pd值_20240731
       ,t2.lgd值_20240731
       ,t2.风险成本_20240731
from lab_bigdata_dev.tmp_baoquan_SJ2024081276_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024081276_20240731_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;
-- SELECT * FROM tmp_baoquan_SJ2024081276_0603_02
**01-数据需求_保全_2024_SJ2024081356_诸银君_借款人和担保人各类地址.sql
-- 清单为只列了借款人信息，需要补充对应的担保人信息
-- 联系号码	居住地址	户籍地址	经营地址（经营）/办公地址（工薪）	是否主地址

-- cd_val	cd_val_dscr
-- 050100	户籍地址
-- 050200	居住地址
-- 050400	办公地址
-- 050800	注册地址
-- 050900	经营地址
-- 051000	其他地址
-- 051100	其他经营地址
-- 051200	其他居住地址

--临时表1 借款人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yq_lxfs_sj2024081356_01;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yq_lxfs_sj2024081356_01 AS
SELECT  T1.COL_1     AS 序号
        ,T1.COL_2    AS 合同流水号
        ,T1.COL_3    AS 核心客户编号
        ,T1.COL_4    AS 名称
        ,T1.COL_5    AS 角色
        ,T2.mbl_nbr  AS 联系号码
        ,T3.dtl_addr AS 居住地址
        ,T4.dtl_addr AS 户籍地址
        ,T5.dtl_addr AS 经营地址
        ,T6.dtl_addr AS 办公地址
        ,CASE
           WHEN T7.addr_typ = '050800' THEN '注册地址'
           WHEN T7.addr_typ = '050400' THEN '办公地址'
           WHEN T7.addr_typ = '050900' THEN '经营地址'
           WHEN T7.addr_typ = '050100' THEN '户籍地址'
           WHEN T7.addr_typ = '050200' THEN '居住地址'
           WHEN T7.addr_typ = '051100' THEN '其他经营地址'
           WHEN T7.addr_typ = '051200' THEN '其他居住地址'
           WHEN T7.addr_typ = '051000' THEN '其他'
         END         AS 主地址类型
        ,T7.dtl_addr AS 主地址
FROM    qbi_file_20240814_11_05_57 T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.COL_3 = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T3
ON      T1.COL_3 = T3.cst_id
AND     T3.nvld_ind = '0' --失效标志
AND     T3.del_ind = '0' --删除标识
AND     T3.addr_typ = '050200' --居住地址
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T4
ON      T1.COL_3 = T4.cst_id
AND     T4.nvld_ind = '0' --失效标志
AND     T4.del_ind = '0' --删除标识
AND     T4.addr_typ = '050100' --户籍地址
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T5
ON      T1.COL_3 = T5.cst_id
AND     T5.nvld_ind = '0' --失效标志
AND     T5.del_ind = '0' --删除标识
AND     T5.addr_typ = '050900' --经营地址
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T6
ON      T1.COL_3 = T6.cst_id
AND     T6.nvld_ind = '0' --失效标志
AND     T6.del_ind = '0' --删除标识
AND     T6.addr_typ = '050400' --办公地址
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T7
ON      T1.COL_3 = T7.cst_id
AND     T7.nvld_ind = '0' --失效标志
AND     T7.del_ind = '0' --删除标识
AND     T7.main_addr_ind = '1' --主地址
AND     T7.DT = '@@{yyyyMMdd}'
WHERE   T1.PT <> '';


--临时表2 担保人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yq_lxfs_sj2024081356_02;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yq_lxfs_sj2024081356_02 AS
SELECT  T1.COL_1        AS 序号
        ,T1.COL_2       AS 合同流水号
        ,T0.WRNT_CST_ID AS 担保人客户编号
        ,T0.WRNT_CST_NM AS 担保人名称
        ,'担保人'       AS 角色
        ,T2.mbl_nbr     AS 担保人联系号码
        ,T3.dtl_addr    AS 担保人居住地址
        ,T4.dtl_addr    AS 担保人户籍地址
        ,T5.dtl_addr    AS 担保人经营地址
        ,T6.dtl_addr    AS 担保人办公地址
        ,CASE
           WHEN T7.addr_typ = '050800' THEN '注册地址'
           WHEN T7.addr_typ = '050400' THEN '办公地址'
           WHEN T7.addr_typ = '050900' THEN '经营地址'
           WHEN T7.addr_typ = '050100' THEN '户籍地址'
           WHEN T7.addr_typ = '050200' THEN '居住地址'
           WHEN T7.addr_typ = '051100' THEN '其他经营地址'
           WHEN T7.addr_typ = '051200' THEN '其他居住地址'
           WHEN T7.addr_typ = '051000' THEN '其他'
         END            AS 担保人主地址类型
        ,T7.dtl_addr    AS 担保人主地址
FROM    qbi_file_20240814_11_05_57 T1
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd T0 --担保人汇总信息
ON      T1.COL_2 = T0.BUS_CTR_ID
AND     T0.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T0.WRNT_CST_ID = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T3
ON      T0.WRNT_CST_ID = T3.cst_id
AND     T3.nvld_ind = '0' --失效标志
AND     T3.del_ind = '0' --删除标识
AND     T3.addr_typ = '050200' --居住地址
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T4
ON      T0.WRNT_CST_ID = T4.cst_id
AND     T4.nvld_ind = '0' --失效标志
AND     T4.del_ind = '0' --删除标识
AND     T4.addr_typ = '050100' --户籍地址
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T5
ON      T0.WRNT_CST_ID = T5.cst_id
AND     T5.nvld_ind = '0' --失效标志
AND     T5.del_ind = '0' --删除标识
AND     T5.addr_typ = '050900' --经营地址
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T6
ON      T0.WRNT_CST_ID = T6.cst_id
AND     T6.nvld_ind = '0' --失效标志
AND     T6.del_ind = '0' --删除标识
AND     T6.addr_typ = '050400' --办公地址
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T7
ON      T0.WRNT_CST_ID = T7.cst_id
AND     T7.nvld_ind = '0' --失效标志
AND     T7.del_ind = '0' --删除标识
AND     T7.main_addr_ind = '1' --主地址
AND     T7.DT = '@@{yyyyMMdd}'
WHERE   T1.PT <> '';


-- SELECT * FROM tmp_yq_lxfs_sj2024081356
--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yq_lxfs_sj2024081356;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yq_lxfs_sj2024081356 AS
SELECT  T1.序号
        ,T1.合同流水号
        ,T1.核心客户编号
        ,T1.名称
        ,T1.角色 AS 角色1
        ,T1.联系号码
        ,T1.居住地址
        ,T1.户籍地址
        ,T1.经营地址
        ,T1.办公地址
        ,T1.主地址类型
        ,T1.主地址
        ,T2.担保人客户编号
        ,T2.担保人名称
        ,T2.角色 AS 角色2
        ,T2.担保人联系号码
        ,T2.担保人居住地址
        ,T2.担保人户籍地址
        ,T2.担保人经营地址
        ,T2.担保人办公地址
        ,T2.担保人主地址类型
        ,T2.担保人主地址
FROM    lab_bigdata_dev.tmp_yq_lxfs_sj2024081356_01 T1
LEFT JOIN    lab_bigdata_dev.tmp_yq_lxfs_sj2024081356_02 T2
ON      T1.合同流水号 = T2.合同流水号;
**01-数据需求_保全_2024_SJ2024081361_梁世鹏_智慧财务诉讼费用单据的关联合同号.sql
-- SJ2024081361	--未入仓，已转运维胡书行处理
-- 部分分行在对存量诉讼费用单据的关联合同号进行数据治理时，未同步在智慧财务系统中进行治理。现需梳理出智慧财务系统中单据所关联的合同号后，比对后，进行统一治理
-- 分行、单据编号、费用项、关联合同号。

select pd1.deptname as 分行,
     t.BILLNO  as 单据编号,
     ard.TYPECD as 费用项编码,
     BUTP.TYPENA  as 费用项名称,
     b.origcd  as 合同号
from
     edw.infs_afb_rgst t  --差旅报销申请表
inner join edw.infs_afb_rgst_detl ard  --费用报销明细表
on
     ard.BILLNO = t.BILLNO
left JOIN edw.infs_afp_butp_detl BUTP  --业务明细表
        ON
     BUTP.TYPECD = ard.TYPECD
     and BUTP.BSNSCD = ard.ASSIS3
     and (BUTP.OTDATE is null
          or BUTP.OTDATE >= t.MKDATE )
inner join edw.infs_pcmc_dept pd   --机构表
on
     t.ACCOBR = pd.DEPTCODE
inner join edw.infs_pcmc_dept pd1  --机构表
on
     pd.STBRCH = pd1.DEPTCODE
inner join (
     select
          GROUP_CONCAT(alc.origcd) as origcd ,
          alc.BILLNO
     from
          edw.infs_afb_legal_cntr alc  --诉讼费合同信息表
     group by
          alc.BILLNO
        ) b
        on
     t.billno = b.BILLNO
where
     t.PRCSCD = 'afb_legal_add'
     order by pd1.deptname ,t.BILLNO ;
**01-数据需求_保全_2024_SJ2024082176_赵家灿_调取附件内清单所列客户的_户籍地址_.sql
-- 卡号	卡产品名称	客户号	客户名称	户籍地址


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zjxc_SJ2024082176 PURGE ;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zjxc_SJ2024082176 AS
SELECT  T1.COL_1     AS 卡号
        ,T1.COL_2    AS 产品名称
        ,T1.COL_3    AS 客户号
        ,T1.COL_4    AS 客户名称
        ,T4.dtl_addr AS 户籍地址
FROM    qbi_file_20240821_19_19_48 T1
LEFT JOIN    edw.loan_cst_ctc_addr T4
ON      T1.COL_3 = T4.cst_id
AND     T4.nvld_ind = '0' --失效标志
AND     T4.del_ind = '0' --删除标识
AND     T4.addr_typ = '050100' --户籍地址
AND     T4.DT = '@@{yyyyMMdd}'
WHERE   T1.PT <> '';


-- cd_val	cd_val_dscr
-- 050100	户籍地址
-- 050200	居住地址
-- 050400	办公地址
-- 050800	注册地址
-- 050900	经营地址
-- 051000	其他地址
-- 051100	其他经营地址
-- 051200	其他居住地址
**01-数据需求_保全_2024_SJ2024082861_章静静_客户有效电话及地址.sql
-- 1.获取附件中sheet1的客户在我行的预留号码，取数口径：客户在我行预留的电话信息，其中电话类型为&ldquo;手机号&rdquo;，且手机实名认证结果=&ldquo;一致&rdquo;，且状态=&ldquo;生效&rdquo;，若有多个，取更新时间最新的那一条；
-- 1.sheet1的数据字段输出：客户号，联系电话
--1、sheet1，

DROP TABLE if EXISTS tmp_zjj_SJ2024082861_01 PURGE;
CREATE TABLE IF NOT EXISTS tmp_zjj_SJ2024082861_01 as
SELECT  b.col_1 客户号
        ,cct.ctc_tel 手机号
        ,CASE
           WHEN cct.mbl_real_nm_atst_rslt = 1 THEN '一致'
           WHEN cct.mbl_real_nm_atst_rslt = 2 THEN '不一致'
           WHEN cct.mbl_real_nm_atst_rslt = 3 THEN '系统异常'
           WHEN cct.mbl_real_nm_atst_rslt = 4 THEN '库无记录'
           else ''
         END AS 手机实名认证结果 --1，一致,2,不一致,3,系统异常,4,库无记录
        ,cctr.nvld_ind 状态 --1，失效，0，生效
        ,substr(cct.last_upd_tm,1,10) 最后更新时间
        ,cctr.REL_TYP 关联类型
FROM    qbi_file_20240830_14_24_10 b
LEFT JOIN    edw.loan_cst_ctc_tel cct --联系电话信息
ON      b.col_1 = cct.cst_id
AND     cct.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息
ON      cctr.REL_SERNO = cct.SERNO
AND     cct.DEL_IND = '0' --删除标识,0-否 1-是
AND     cctr.dt = '@@{yyyyMMdd}'
WHERE   b.pt <> ''
AND     cct.tel_typ = '010000' --手机号
AND     cctr.nvld_ind = '0'   --1，失效，0，生效
AND     cctr.REL_TYP = '0001'  -- 关联类型，本人,会存在一个人有多个手机号
;

--2、获取附件中sheet2的客户在我行的预留号码（口径同上），以及所有地址信息，包括居住地址、办公地址、经营地址、户籍地址，且状态=&ldquo;生效&rdquo;
-- 字段输出：客户号，联系电话，地址类型，行政区划，详细地址

DROP TABLE IF EXISTS tmp_zjj_SJ2024082861_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zjj_SJ2024082861_02 AS
SELECT  a.col_1 客户号
        ,cct.ctc_tel 手机号
        ,CASE
           WHEN cca.addr_typ = '050200' THEN '家庭地址'
           WHEN cca.addr_typ = '050300' THEN '通讯地址'
           WHEN cca.addr_typ = '050400' THEN '工作地址'
           WHEN cca.addr_typ = '050900' THEN '经营地址'
           WHEN cca.addr_typ = '050800' THEN '注册地址'
           WHEN cca.addr_typ = '050100' THEN '户籍地址'
           ELSE '其他地址'
         END AS 地址类型
        ,cca.adiv 行政区划编码
        ,kc.xzhqhmch 行政区划
        ,cca.dtl_addr 详细地址
FROM    qbi_file_20240830_15_37_11 a
LEFT JOIN    edw.loan_cst_ctc_tel cct --联系电话信息
ON      a.col_1 = cct.cst_id
AND     cct.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息
ON      cctr.REL_SERNO = cct.SERNO
AND     cct.DEL_IND = '0' --删除标识,0-否 1-是
AND     cctr.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr cca --客户地址信息
ON      a.col_1 = cca.cst_id
AND     cca.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.core_kcfp_cfxzdm kc --行政区划代码表
ON      substr(cca.adiv, 1, 6) = kc.xzqhdaim
AND     kc.dt = '@@{yyyyMMdd}'
-- AND     kc.xzqhdaim <> ''  --空的匹配，只是显示有问题，实际为/N，无影响
WHERE   a.pt <> ''
AND     cca.nvld_ind = '0' --生效
AND     cct.tel_typ = '010000' --手机号
AND     cctr.nvld_ind = '0' --1，失效，0，生效
AND     cctr.REL_TYP = '0001'  -- 关联类型，本人,会存在一个人有多个手机号
;
**01-数据需求_保全_2024_SJ2024083006郑一峰_获取历史信用风险止付的保证金账户.sql
--获取历史信用风险止付的保证金账户
-- 取止付明细表中，止付柜员为【DPGY】、止付状态为【止付】且存在另一条止付记录的止付明细及票据信息。
-- 要素：止付编号、账户名称、账号、子账户序号、止付标志、止付类型、止付种类、止付金额、止付开始日期、解止付日期、止付原因、止付办理机构、经办人、
-- 票据号码、子票区间号、出票日期、到期日期、票据状态。
SELECT  a.dongjbho 冻结编号
        ,b.zhhuzwmc 账户名称
        ,a.kehuzhao 客户账号
        ,a.shunxhao 顺序号
        ,a.zhanghao 负债账号
        ,a.jiedonbz 解冻标志
        ,a.zhzfleix 冻结类型
        ,a.donjzhgl 冻结种类
        ,a.jiedjine 解冻金额
        ,a.djqsriqi 冻结起始日期
        ,a.djzzriqi 冻结终止日期
        ,a.donjyyin 冻结原因  --02 信用风险止付
        ,a.jiaoyijg 交易机构
        ,a.jinbguiy 经办人
FROM    edw.core_kdpb_dngjdj a --负债账户冻结登记簿
LEFT JOIN    edw.core_kdpa_zhxinx b --负债账户信息表
ON      a.zhanghao = b.zhanghao
AND     b.dt = '20240831'
WHERE   a.dt = '20240831'
AND     a.jinbguiy = 'DPGY'
AND     a.donjczbz = '5' --冻结操作标志
AND     a.jiedonbz = '0'  --解冻标志
AND     b.chapbhao IN ( '00203010100' , '00203010200' , '00301040400' , '00301040500' ) --保证金账户
-- and  a.dongjbho like 'KZ%'  --止付不要冻结
AND     EXISTS (
                   SELECT  1
                   FROM    edw.core_kdpb_dngjdj b
                   WHERE   b.dt = '20240831'
                   AND     b.dongjbho != a.dongjbho
                   AND     b.kehuzhao = a.kehuzhao
                   AND     b.donjczbz = '5'
                   AND     b.jiedonbz = '0'
               )
;


-- 20240831
**01-数据需求_保全_2024_SJ20240903101_梁世鹏_业务数据剥离时点与8月末的风险成本数据.sql
--
-- SJ20240903101

--字段:本金余额-剥离日期、pd-剥离日期、lgd-剥离日期、风险成本-剥离日期	本金余额-20240831、pd-20240831、lgd-20240831、风险成本-20240831

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

--临时表：COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

SELECT * FROM COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD WHERE DBIL_SRL_NO='20121026000792'

DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20240831'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

  UNION ALL

  SELECT
    T2.DT
    ,T2.DBIL_SRL_NO
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
    ,T2.PD_START_VALUE AS PD_ORIG_VALUE
    ,CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END AS LGD_ORIG_VALUE
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
    (CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END) AS RSK_COST
  FROM
  (
    SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
    ,T1.GRNT_MODE
    ,T1.OVD_REPAY_RATE REPAY_RATE
    ,T1.CST_PRCP_BAL
    ,T1.VOUCH_PERSON_NUMBER
    ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
    ,CASE
      WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
        THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
      ELSE 0
    END OVDR_MTH_TERM
    FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
    WHERE T1.DT>='20231231' AND T1.DT<='20240831'
    AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
  ) T2
;

---*******************全量业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

SELECT * FROM qbi_file_20240905_14_21_43 WHERE pt<>'' and col_2='20121026000792'

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ20240903101_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ20240903101_blrq_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240905_14_21_43 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240905_14_21_43')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20240905_14_21_43 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20240831'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240905_14_21_43')
and     (p.COL_2  like '62%' OR p.COL_2 like '42%')
;

-- SELECT COUNT(1) FROM tmp_baoquan_SJ20240903101_blrq_02

-- 2024年8月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ20240903101_20240831_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ20240903101_20240831_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240831
                 ,t.PD_ORIG_VALUE pd值_20240831
                 ,t.LGD_ORIG_VALUE lgd值_20240831
                 ,t.RSK_COST 风险成本_20240831
FROM    lab_bigdata_dev.qbi_file_20240905_14_21_43 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240831'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240905_14_21_43')
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
and substr(p.COL_2,1,2) not in('62','42')

union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240831
                 ,t.PD_ORIG_VALUE pd值_20240831
                 ,t.LGD_ORIG_VALUE lgd值_20240831
                 ,t.RSK_COST 风险成本_20240831
FROM    lab_bigdata_dev.qbi_file_20240905_14_21_43 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240831'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20240831'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240905_14_21_43')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


--结果表:
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ20240903101_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ20240903101_0603_02 AS
SELECT  distinct t1.剥离所属分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20240831
       ,t2.pd值_20240831
       ,t2.lgd值_20240831
       ,t2.风险成本_20240831
from lab_bigdata_dev.tmp_baoquan_SJ20240903101_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ20240903101_20240831_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;
-- SELECT count(1) FROM tmp_baoquan_SJ20240903101_0603_02
**01-数据需求_保全_2024_SJ2024090391_吴伟_已核销业务的本金及利息最长逾期时间_账户余额.sql
-- 18011 ZCBQ_CANCEL_LOAN_BOOK  ：edw.zcbq_cancel_loan_book  --贷款核销台账
-- 18012 ZCBQ_CANCEL_CARD_BOOK  ：edw.zcbq_cancel_card_book  --信用卡核销台账
-- dg供参考用底表：app_rpt.fct_loan_wrt_off_dd    --贷款核销报表
--               app_rpt.fct_card_wrt_off_dd  --信用卡核销报表


--1、分行及村行，2024年1-8月已核销业务
--字段：合同号、借据号、机构、核销日期、核销时合同下所有借据的本金或利息最长逾期时间

---14661条数据
DROP TABLE IF EXISTS tmp_ww_SJ2024090391_01 PURGE;
CREATE TABLE IF NOT EXISTS tmp_ww_SJ2024090391_01 AS
SELECT  T.机构号
        ,T.分村行
        ,T.合同号
        ,T.借据流水号
        ,T.核销日期
        ,T.本息最长逾期天数
FROM    (
            SELECT  a.brn_org_id 机构号
                    ,a.brn_org_nm 分村行
                    ,a.busi_ctr_id 合同号
                    ,a.dbil_id 借据流水号
                    ,a.cancel_dt 核销日期
                    ,a.lng_ovd_intr_day 本息最长逾期天数
                    ,dense_rank() OVER ( PARTITION BY a.busi_ctr_id ORDER BY a.lng_ovd_intr_day DESC ) AS rn  --逾期天数相同时排名相同
            -- DATEDIFF(TO_DATE('@@{yyyyMMdd}', 'yyyyMMdd'), TO_DATE(LEAST(a.OVD_DT, a.OVD_INTR_DT), 'yyyyMMdd'), 'DD')
            FROM    app_rpt.fct_loan_wrt_off_dd a --贷款核销报表
            WHERE   a.dt = '20240831'
            AND     a.cancel_dt >= '2024-01-01'
            AND     a.cancel_dt <= '2024-08-31'
        ) T
WHERE   T.rn = 1
;

--2、已核销业务客户账户余额。分行及村行，2024年1-8月已核销业务
--2.1、在核销当日的余额情况
--2.2、在2024年8月31日的余额情况
--字段：分行 、 止付编号 、止付类型、 账户 、客户编号、 客户姓名、客户角色 、 当前账户余额、 是否司法机关冻结、冻控来源单位、冻结通知书编号
-- loan_stoppayment_inventory = loan_psp_stop_pay_trx_list  --止付清单:止付编号
-- loan_stoppayment_account = loan_psp_stop_pay_act_dtl    --引入账号:账号
-- loan_stoppayment_apply =loan_psp_stop_pay_rcd   --止付申请:止付类型

--分村行1-8月已核销业务
--2.2 0831的余额  --19871条

-- SELECT count(*) FROM tmp_ww_SJ2024090391_01_20240831 ;

DROP TABLE IF EXISTS tmp_ww_SJ2024090391_01_20240831 PURGE;
CREATE TABLE IF NOT EXISTS tmp_ww_SJ2024090391_01_20240831 AS
SELECT distinct a.cancel_dt 核销日期
        ,a.brn_org_id 机构号
        ,a.brn_org_nm 分村行
        ,a.cst_id 客户号
        ,a.cst_nm 客户姓名
        ,b.stop_pay_no 止付编号
        ,CASE
           WHEN b.stop_pay_obj = '01' THEN '主借款人'
           WHEN b.stop_pay_obj = '02' THEN '共同借款人'
           WHEN b.stop_pay_obj = '03' THEN '担保人'
           WHEN b.stop_pay_obj = '04' THEN '关联人'
           WHEN b.stop_pay_obj = '05' THEN '关联人'
           WHEN b.stop_pay_obj = '06' THEN '合作企业或关键人'
           WHEN b.stop_pay_obj = '07' THEN '潜在客户'
         END AS 止付对象 -- 01主借款人 02共同借款人 03担保 04关联人 05关联人 06合作企业或关键人 07潜在客户
        ,CASE
           WHEN b.stop_pay_mod = '01' THEN '手动止付'
           WHEN b.stop_pay_mod = '02' THEN '自动止付'
         END AS 止付类型 --01手动止付02自动止付
        ,b.act_no 账号
        ,p2.cur_act_bal 账户余额
        ,P3.dongjbho  冻结编号
       -- ,CASE
        --   WHEN p3.donjlaiy = 1 THEN '冻结'
        --   WHEN p3.donjlaiy = 2 THEN '控制'
       --    ELSE '其他'
       -- END AS 冻结来源
        ,p3.zfbmminc 执法部门名称
        ,p3.djtzsbho 冻结通知书编号
FROM    app_rpt.fct_loan_wrt_off_dd a --贷款核销报表
LEFT JOIN    (
                 SELECT  q1.stop_pay_no --止付编号
                         ,q1.cst_id --客户号
                         ,q1.cst_nm --客户姓名
                         ,q2.stop_pay_obj --止付对象 01.借款人 02.担保人
                         ,q2.stop_pay_mod --止付类型 01手动止付 02自动止付
                         ,q1.act_no --账号
                 FROM    edw.loan_psp_stop_pay_trx_list q1 --止付交易清单
                 LEFT JOIN    edw.loan_psp_stop_pay_rcd q2 -- 止付记录
                 ON      q1.stop_pay_serno = q2.stop_pay_serno
                 AND     q2.dt = '20240831'
                 WHERE   q1.dt = '20240831'
             ) b
ON      a.cst_id = b.cst_id
LEFT JOIN    (
                 SELECT  cst_act_id
                         ,sum(cur_act_bal) AS cur_act_bal
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   dt = '20240831'
                 GROUP BY cst_act_id
             ) p2
ON      b.act_no = p2.cst_act_id
LEFT JOIN   ( SELECT  distinct P3.kehuzhao  --客户账号
                    ,p3.dongjbho --冻结编号
                --      ,P3.zhanghao  --负债账号
             --      ,P3.donjlaiy  --冻结来源 1.冻结 2 控制 3 其他   --冻结是外部的说法，控制是内部的说法
                     ,P3.djtzsbho  --冻结通知书编号
                     ,P3.zfbmleix  --执法部门
                     ,P3.zfbmminc  --执法部门名称
          FROM edw.core_kdpb_dngjdj p3 --负债账户冻结登记簿
         WHERE p3.dt = '20240831'
         and P3.zfbmleix<>''
        -- and P3.donjlaiy='1'
) P3
ON      b.act_no = p3.kehuzhao
-- and b.stop_pay_no=p3.dongjbho
WHERE   a.dt = '20240831'
AND     a.cancel_dt >= '2024-01-01'
AND     a.cancel_dt <= '2024-08-31'
AND     nvl(b.stop_pay_no, '') <> ''
;


--2.1 在核销当日的余额情况
--2.1.1 取1-8月所有的核销日期  ,总共21个核销日期
-- SELECT  distinct a.cancel_dt --核销日期
-- FROM    app_rpt.fct_loan_wrt_off_dd a --贷款核销报表
-- WHERE   a.dt = '20240831'
-- AND     a.cancel_dt >= '2024-01-01'
-- AND     a.cancel_dt <= '2024-08-31'
;
--2.2.2 取核销当日的账户余额  --283269条数据

-- SELECT count(1) FROM tmp_ww_SJ2024090391_02_hexiao


DROP TABLE IF EXISTS tmp_ww_SJ2024090391_02_hexiao PURGE;

CREATE TABLE IF NOT EXISTS tmp_ww_SJ2024090391_02_hexiao AS
SELECT  DISTINCT a.dt 数据日期
                 ,a.cancel_dt 核销日期
                 ,a.brn_org_id 机构号
                 ,a.brn_org_nm 分村行
                 ,a.cst_id 客户号
                 ,a.cst_nm 客户姓名
                 ,b.stop_pay_no 止付编号
                 ,CASE
                    WHEN b.stop_pay_obj = '01' THEN '主借款人'
                    WHEN b.stop_pay_obj = '02' THEN '共同借款人'
                    WHEN b.stop_pay_obj = '03' THEN '担保人'
                    WHEN b.stop_pay_obj = '04' THEN '关联人'
                    WHEN b.stop_pay_obj = '05' THEN '关联人'
                    WHEN b.stop_pay_obj = '06' THEN '合作企业或关键人'
                    WHEN b.stop_pay_obj = '07' THEN '潜在客户'
                  END AS 止付对象 -- 01主借款人 02共同借款人 03担保 04关联人 05关联人 06合作企业或关键人 07潜在客户
                 ,CASE
                    WHEN b.stop_pay_mod = '01' THEN '手动止付'
                    WHEN b.stop_pay_mod = '02' THEN '自动止付'
                  END AS 止付类型 --01手动止付02自动止付
                 ,b.act_no 账号
                 ,P3.dongjbho 冻结编号
                 ,p2.cur_act_bal 账户余额
                 --  ,CASE
                 --     WHEN p3.donjlaiy = 1 THEN '冻结'
                 --     WHEN p3.donjlaiy = 2 THEN '控制'
                 --     ELSE '其他 '
                 --   END AS 冻结来源 ----1.冻结 2 控制 3 其他   --冻结是外部的说法，控制是内部的说法
                 ,p3.zfbmminc 执法部门名称
                 ,p3.djtzsbho 冻结通知书编号
FROM    app_rpt.fct_loan_wrt_off_dd a --贷款核销报表
LEFT JOIN    (
                 SELECT  q1.stop_pay_no --止付编号
                         ,q1.cst_id --客户号
                         ,q1.cst_nm --客户姓名
                         ,q2.stop_pay_obj --止付对象 01.借款人 02.担保人
                         ,q2.stop_pay_mod --止付类型 01手动止付 02自动止付
                         ,q1.act_no --账号
                         ,q1.dt --数据日期
                 FROM    edw.loan_psp_stop_pay_trx_list q1 --止付交易清单
                 LEFT JOIN    edw.loan_psp_stop_pay_rcd q2 -- 止付记录
                 ON      q1.stop_pay_serno = q2.stop_pay_serno
                 AND     q2.dt = q1.dt
                 WHERE   q1.dt IN ( '20240130' , '20240227' , '20240228' , '20240321' , '20240327' , '20240328' , '20240329' , '20240427' , '20240429' , '20240528' , '20240530' , '20240531' , '20240626' , '20240627' , '20240628' , '20240725' , '20240730' , '20240807' , '20240823' , '20240829' , '20240830' )
             ) b
ON      a.cst_id = b.cst_id
LEFT JOIN    (
                 SELECT  dt
                         ,cst_act_id
                         ,sum(cur_act_bal) AS cur_act_bal
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   dt IN ( '20240130' , '20240227' , '20240228' , '20240321' , '20240327' , '20240328' , '20240329' , '20240427' , '20240429' , '20240528' , '20240530' , '20240531' , '20240626' , '20240627' , '20240628' , '20240725' , '20240730' , '20240807' , '20240823' , '20240829' , '20240830' )
                 GROUP BY dt , cst_act_id
             ) p2
ON      b.act_no = p2.cst_act_id
LEFT JOIN    (
                 SELECT  DISTINCT P3.kehuzhao --客户账号
                                  ,p3.dongjbho  --冻结编号
                                  --      ,P3.zhanghao  --负债账号
                                  --      ,P3.donjlaiy  --冻结来源 1.冻结 2 控制 3 其他   --冻结是外部的说法，控制是内部的说法
                                  ,P3.djtzsbho --冻结通知书编号
                                  ,P3.zfbmleix --执法部门
                                  ,P3.zfbmminc --执法部门名称
                 FROM    edw.core_kdpb_dngjdj p3 --负债账户冻结登记簿
                 WHERE   p3.dt IN ( '20240130' , '20240227' , '20240228' , '20240321' , '20240327' , '20240328' , '20240329' , '20240427' , '20240429' , '20240528' , '20240530' , '20240531' , '20240626' , '20240627' , '20240628' , '20240725' , '20240730' , '20240807' , '20240823' , '20240829' , '20240830' )
                 AND     P3.zfbmleix <> ''
             -- and P3.donjlaiy='1'
             ) P3
ON      b.act_no = p3.kehuzhao
-- and b.stop_pay_no=p3.dongjbho
WHERE   a.dt IN ( '20240130' , '20240227' , '20240228' , '20240321' , '20240327' , '20240328' , '20240329' , '20240427' , '20240429' , '20240528' , '20240530' , '20240531' , '20240626' , '20240627' , '20240628' , '20240725' , '20240730' , '20240807' , '20240823' , '20240829' , '20240830' )
AND     a.cancel_dt >= '2024-01-01'
AND     a.cancel_dt <= '2024-08-31'
AND     nvl(b.stop_pay_no, '') <> '';








-- desc edw.loan_psp_stop_pay_trx_list  --止付交易清单
-- | serno           | string     |       | 流水号                                         |
-- | stop_pay_serno  | string     |       | 止付流水号                                       |
-- | bsn_serno       | string     |       | 业务流水号                                       |
-- | stop_pay_bsn_clss | string     |       | 止付业务种类                                      |
-- | stop_pay_obj    | string     |       | 止付对象                                        |   01主借款人 02共同借款人 03担保 04关联人 05关联人 06合作企业或关键人 07潜在客户
-- | stop_pay_no     | string     |       | 止付编号                                        |
-- | cst_id          | string     |       | 客户号                                         |
-- | cst_nm          | string     | 2     | 客户名称                                        |
-- | cst_typ         | string     |       | 客户类型                                        |
-- | stop_pay_amt    | decimal    |       | 止付金额                                        |
-- | stop_pay_dt     | string     |       | 止付日期                                        |
-- | cupd_trx_sts    | string     |       | 银数交易状态                                      |
-- | cupd_stop_pay_rsp_inf | string     |       | 银数止付响应信息                                    |
-- | cupd_stop_pay_tm | string     |       | 银数止付时间                                      |
-- | core_trx_sts    | string     |       | 核心交易状态                                      |
-- | core_stop_pay_rsp_inf | string     |       | 核心止付响应信息                                    |
-- | core_stop_pay_tm | string     |       | 核心止付时间                                      |
-- | cr_crd_no       | string     |       | 信用卡卡号                                       |
-- | act_no          | string     | 3     | 账号                                          |
-- | lgp_id          | string     |       | 法人编号                                        |
-- | bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
-- | del_ind         | string     |       | 删除标识                                        |
-- | sys_reg_psn     | string     |       | 系统登记人                                       |
-- | sys_reg_org     | string     |       | 系统登记机构                                      |
-- | sys_reg_tm      | string     |       | 系统登记时间                                      |
-- | last_upd_psn    | string     |       | 最后更新人                                       |
-- | last_upd_org    | string     |       | 最后更新机构                                      |
-- | last_upd_tm     | string     |       | 最后更新时间                                      |
-- | act_sub_sn      | string     |       | 账户子序号                                       |

-- desc edw.loan_psp_stop_pay_act_dtl  --止付账户明细
-- | serno           | string     |       | 流水号                                         |
-- | stop_pay_serno  | string     |       | 止付流水号                                       |
-- | cst_id          | string     |       | 客户号                                         |
-- | act_no          | string     | 3     | 账号                                          |
-- | act_sub_sn      | string     |       | 账户子序号                                       |
-- | ccy             | string     |       | 币种                                          |
-- | act_nm          | string     | 2     | 账户名称                                        |
-- | dep_act_sts_cd  | string     |       | 存款账户状态代码                                    |
-- | stop_pay_ind    | string     |       | 止付标志                                        |
-- | stop_pay_amt    | decimal    |       | 止付金额                                        |
-- | stop_pay_no     | string     |       | 止付编号                                        |
-- | act_bal         | decimal    | 3     | 账户余额                                        |
-- | lgp_id          | string     |       | 法人编号                                        |
-- | bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
-- | del_ind         | string     |       | 删除标识                                        |
-- | sys_reg_psn     | string     |       | 系统登记人                                       |
-- | sys_reg_org     | string     |       | 系统登记机构                                      |
-- | sys_reg_tm      | string     |       | 系统登记时间                                      |
-- | last_upd_psn    | string     |       | 最后更新人                                       |
-- | last_upd_org    | string     |       | 最后更新机构                                      |
-- | last_upd_tm     | string     |       | 最后更新时间                                      |

-- desc edw.loan_psp_stop_pay_rcd -- 止付记录
-- SELECT stop_pay_mod  from edw.loan_psp_stop_pay_rcd  WHERE dt='20240831'

--  stop_pay_serno  | string     |       | 止付流水号                                       |
-- | cst_id          | string     |       | 客户号                                         |
-- | cst_nm          | string     | 2     | 客户名称                                        |
-- | cert_typ        | string     |       | 证件类型                                        |
-- | cert_no         | string     | 4     | 证件号码                                        |
-- | mgr_id          | string     |       | 管户人工号                                       |
-- | mgr_org         | string     |       | 管户机构                                        |
-- | auto_rels_stop_pay_ind | string     |       | 自动解止付标志                                     |
-- | stop_pay_rsn    | string     |       | 止付原因                                        |
-- | stop_pay_mod    | string     |       | 止付方式                                        |
-- | stop_pay_rsn_dscr | string     |       | 止付原因描述                                      |
-- | stop_pay_dt     | string     |       | 止付日期                                        |
-- | stop_pay_obj    | string     |       | 止付对象                                        |
-- | stop_pay_bsn_clss | string     |       | 止付业务种类                                      |
-- | aprv_sts        | string     |       | 审批状态                                        |
-- | tsk_sts         | string     |       | 任务状态                                        |
-- | inf_cpl_ind     | string     |       | 信息完整标志                                      |
-- | lgp_id          | string     |       | 法人编号                                        |
-- | bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
-- | del_ind         | string     |       | 删除标识                                        |
-- | sys_reg_psn     | string     |       | 系统登记人                                       |
-- | sys_reg_org     | string     |       | 系统登记机构                                      |
-- | sys_reg_tm      | string     |       | 系统登记时间                                      |
-- | last_upd_psn    | string     |       | 最后更新人                                       |
-- | last_upd_org    | string     |       | 最后更新机构                                      |
-- | last_upd_tm     | string     |       | 最后更新时间                                      |
-- +------------------------------------------------------------------------------------+
**01-数据需求_保全_2024_SJ2024090396郑一峰_逾期贷款处置账务管理检查.sql
-- 1.逾期客户账户止付后有金额的业务清单；（信用风险止付）；
-- 2.截止8月底本清利存业务，本金结清日期后是否有催记；（包括核销及非核销）；
-- 3.2023.5-2024.4结清的业务：本金结清到利息减免之间耗时（期间有无催记）；
-- 催记口径：催收方式为&ldquo;催收短信、催收电子邮件、电话录音催收、上门催收、现场催收、其他、分期还款、债务拆分&rdquo;，但催记渠道不为短信平台的催记

-- 1.逾期客户账户止付后有金额的业务清单；（信用风险止付）；
-- 分行	流水号	止付类型	止付编号	止付账户	是否还款账户	客户编号	客户姓名	客户角色	实际止付金额	控制金额	备注	截止9月3日账户金额
-- 止付状态	止付日期	关联业务借款人	关联业务借款人名称	业务流水号	业务类型	合同金额	合同余额	合同到期日	信贷管户机构号	信贷管户机构名称
-- 管户人工号	序号	是否司法冻结

-- loan_stoppayment_inventory = loan_psp_stop_pay_trx_list  --止付清单:止付编号
-- loan_stoppayment_account = loan_psp_stop_pay_act_dtl    --止付账户清单:账号
-- loan_stoppayment_apply =loan_psp_stop_pay_rcd   --止付申请:止付类型


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_01;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_01 AS
SELECT  DISTINCT T3.brc_org_nm                                                                           AS 分行
                 --  ,o.serno                                                                                AS 流水号
                 ,O.stop_pay_serno                                                                       AS 止付流水号
                 ,CASE
                    WHEN SA.stop_pay_mod = '01' THEN '手动止付'
                    WHEN SA.stop_pay_mod = '02' THEN '自动止付'
                  END                                                                                    AS 止付类型  --01手动止付02自动止付
                 ,CASE
                    WHEN SA.stop_pay_rsn = '01' THEN '证件到期止付'
                    WHEN SA.stop_pay_rsn = '02' THEN '信用风险止付'
                    WHEN SA.stop_pay_rsn = '03' THEN '外汇监管止付'
                    WHEN SA.stop_pay_rsn = '04' THEN '洗钱风险止付'
                    WHEN SA.stop_pay_rsn = '05' THEN '有权机关止付'
                    WHEN SA.stop_pay_rsn = '06' THEN '存单质押止付'
                    WHEN SA.stop_pay_rsn = '99' THEN '其他止付'
                  END                                                                                    AS 止付原因
                 ,o.stop_pay_no                                                                          AS 止付编号
                 ,o.act_no                                                                               AS 账户
                 ,CASE
                    WHEN sac.act_no = bc.rpay_cst_act_id THEN '1'
                    ELSE '0'
                  END                                                                                    AS 是否还款账户
                 ,SAC.STOP_PAY_IND  AS 止付标识
                 ,o.cst_id                                                                               AS 客户编号
                 ,o.cst_nm                                                                               AS 客户姓名
                 ,CASE
                    WHEN O.stop_pay_obj = '04' THEN '关联人'
                    WHEN O.stop_pay_obj = '07' THEN '潜在客户'
                    WHEN O.stop_pay_obj = '03' THEN '担保人'
                    WHEN O.stop_pay_obj = '06' THEN '合作企业或关键人'
                    WHEN O.stop_pay_obj = '05' THEN '共同还款人'
                    WHEN O.stop_pay_obj = '01' THEN '主借款人'
                    WHEN O.stop_pay_obj = '02' THEN '共同借款人'
                  END                                                                                    AS 客户角色
                 ,least(nvl(o.stop_pay_amt, 0), NVL(NVL(SAC.act_bal, '0') * h.AVG_PRC / h.QUO_UNT, '0')) AS 实际止付金额
                 ,o.stop_pay_amt                                                                         AS 控制金额
                 ,SA.stop_pay_rsn_dscr                                                                   AS 止付原因描述
                 ,sa.AUTO_RELS_STOP_PAY_IND  as 自动解止付标志  --1是，0否
                 ,T1.截止9月3日账户金额
                 ,CASE
                    WHEN O.cupd_trx_sts = '2020' THEN '交易异常'
                    WHEN O.cupd_trx_sts = '2010' THEN '交易超时'
                    WHEN O.cupd_trx_sts = '10'   THEN '成功'
                    WHEN O.cupd_trx_sts = '00'   THEN '待发送'
                    WHEN O.cupd_trx_sts = '2030' THEN '业务异常'
                  END                                                                                    AS 银数交易状态
                 ,CASE
                    WHEN O.core_trx_sts = '2020' THEN '交易异常'
                    WHEN O.core_trx_sts = '2010' THEN '交易超时'
                    WHEN O.core_trx_sts = '10'   THEN '成功'
                    WHEN O.core_trx_sts = '00'   THEN '待发送'
                    WHEN O.core_trx_sts = '2030' THEN '业务异常'
                  END                                                                                    AS 核心交易状态
                 ,bc.cst_id                                                                              AS 关联业务借款人
                 ,BC.cst_nm                                                                              AS 关联业务借款人名称
                 ,o.bsn_serno 业务流水号 ---busi_ctr_id
                 ,CASE
                    WHEN o.stop_pay_bsn_clss = '1' THEN '贷款类'
                    WHEN o.stop_pay_bsn_clss = '2' THEN '卡类'
                  END                                                                                    AS 业务类型
                 ,bc.ctr_amt                                                                             AS 合同金额
                 ,bc.ctr_bal                                                                             AS 合同余额
                 ,T4.核后本金余额
                 ,T4.核后利息余额
                 ,BC.ctr_mtu_dt                                                                          AS 合同到期日
                 ,CB.ln_mgr_id 管户人工号 --用户
                 ,CB.ln_mgr_nm 管护人姓名
                 ,CB.ln_org_id 信贷管户机构号 --机构
                 ,CB.ln_org_nm 信贷管户机构名称
                 ,CASE
                    WHEN T2.kehuzhao IS NOT NULL THEN '是'
                    ELSE '否'
                  END                                                                                    AS 是否有司法冻结
FROM    edw.loan_psp_stop_pay_trx_list O --止付交易清单
LEFT JOIN    (
                 SELECT  stop_pay_serno
                         ,act_no
                         ,act_bal
                         ,ccy
                         ,STOP_PAY_IND  --止付标识，0否，1是
                         ,ROW_NUMBER() OVER ( PARTITION BY act_no ORDER BY serno DESC ) AS rn
                 FROM    edw.loan_psp_stop_pay_act_dtl --止付账户明细，取账户
                 WHERE   dt = '@@{yyyyMMdd}'
             ) SAC
ON      O.stop_pay_serno = SAC.stop_pay_serno --账户流水号和流水号关联
AND     O.act_no = SAC.act_no
AND     sac.rn = 1
LEFT JOIN    edw.loan_psp_stop_pay_rcd SA --止付记录
ON      O.stop_pay_serno = SA.stop_pay_serno --止付申请流水号和流水号关联
AND     SA.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd CB --客户集市-客户基础-客户管户信息
ON      SA.cst_id = CB.cst_id
AND     CB.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd BC --合同基础信息
ON      bc.ctr_serno = o.bsn_serno --业务流水号关联
AND     BC.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  busi_ctr_id
                         ,SUM(wrt_off_amt)  AS 核后本金余额
                         ,SUM(wrt_off_intr) AS 核后利息余额
                 FROM    app_rpt.fct_loan_wrt_off_dd   --贷款核销报表
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY busi_ctr_id
             ) T4
ON      T4.busi_ctr_id = o.bsn_serno --业务流水号关联
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD h --汇率信息
ON      SAC.ccy = h.CCY_CD
AND     h.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  cst_act_id
                         ,SUM(gl_bal) AS 截止9月3日账户金额
                 FROM    edw.dws_bus_dep_act_inf_dd
                 WHERE   DT = '20240903'
                 GROUP BY cst_act_id
             ) T1
ON      sac.act_no = T1.cst_act_id
LEFT JOIN    (
                 SELECT  DISTINCT kehuzhao
                 FROM    edw.core_kdpb_dngjdj  --负债账户冻结登记薄
                 WHERE   DT = '@@{yyyyMMdd}'
                --  AND     djtzsbho IS NOT NULL
                 and     donjlaiy='1'  --冻结
             ) T2
ON      T2.kehuzhao = O.act_no
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      CB.ln_org_id = T3.org_id
AND     T3.DT = '@@{yyyyMMdd}'
WHERE   O.dt = '@@{yyyyMMdd}'
AND     SA.stop_pay_rsn = '02' --'信用风险止付'
AND     o.stop_pay_no <> ''
-- and     sa.AUTO_RELS_STOP_PAY_IND<>'1'  --剔除自动解止付 ，1是，0否
;

--结果表

-- SELECT * FROM tmp_yuqi_SJ2024090396_f WHERE 自动解止付标志=0 and 截止9月3日账户金额>0 and 是否还款账户='1' and 是否逾期='逾期' ;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_f;

CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.tmp_yuqi_SJ2024090396_f AS
SELECT  distinct t1 . *
        ,CASE
           WHEN t1.业务流水号 IN (
                                SELECT  T1.ctr_serno
                                -- ,T1.cst_id
                                -- ,T1.cst_nm
                                FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
                                LEFT JOIN    (
                                                 SELECT  A2.busi_ctr_id
                                                         ,A1.bal AS 信用卡余额
                                                         ,A1.ovd_amt
                                                 FROM    edw.dws_bus_crd_cr_crd_act_inf_dd A1 --信用卡账户信息汇总
                                                 LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd A2 --信用卡卡片信息
                                                 ON      A1.cr_crd_act_id = A2.cr_crd_act_id AND A2.DT = '@@{yyyyMMdd}'
                                                 WHERE   A1.DT = '@@{yyyyMMdd}' AND A1.ovd_amt > 0
                                             ) T0
                                ON      T1.ctr_serno = T0.busi_ctr_id
                                WHERE   T1.DT = '@@{yyyyMMdd}'
                                AND ( T1.ovd_amt > 0
                                OR T0.ovd_amt > 0 )  --贷款、信用卡逾期
                            ) THEN '逾期'
           ELSE '未逾期'
         END AS 是否逾期
FROM    lab_bigdata_dev.tmp_yuqi_SJ2024090396_01 t1



-- 表1：合同余额为0 的，可能是核销，需要还原真实的欠款金额，也就是核后本金余额；
-- 表2：本金结清日期有误，核销业务数据缺失，数据量不止这么点；3：本金结清日期有误
-- 3.比如20170105001648，本金结清日期是23年6.13，但显示的是利息减免日期


-- 2.截止8月底本清利存业务，本金结清日期后是否有催记；（包括核销及非核销）；


-- 合同流水号	借据流水号	管护机构号	管户机构名称	分行	客户号	客户名称	发放日期	约定到期日期	本金余额	截至8月底核销利息
-- 截至8月底已核销本金利息	应收应计利息金额	应收欠息	催收欠息	应收应计罚息	催收应计罚息	应收罚息	催收罚息	应计复息
-- 催收应计利息	复息金额	合计利息	核销日期	核销时本金	累计回收本金	累计回收利息	本金结清日期	本金结清日期后是否有催记


--取本金结清日期
--非核销业务比如说我今天的本金余额是有值的明天是为零的，那本金结清日期就是今天
--然后核销业务的话，核后本金余额今天比如说是有值，明天变成零了那今天就是本金结清日期按照这个逻辑去取。

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_2;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_2 AS
SELECT  T1.dbil_id
        ,TO_CHAR(dateadd(TO_DATE(MIN(DT), 'yyyyMMdd'), - 1, 'DD'), 'YYYYMMDD') AS 本金结清日期 --取本金余额为0的最小DT前一天
FROM    edw.dim_bus_loan_dbil_inf_dd T1
WHERE   T1.DT <= '@@{yyyyMMdd}'
AND     T1.prcp_bal = 0
GROUP BY T1.dbil_id;

--核销
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_3;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_3 AS
SELECT  T1.dbil_id
        ,TO_CHAR(dateadd(TO_DATE(MIN(DT), 'yyyyMMdd'), - 1, 'DD'), 'YYYYMMDD') AS 本金结清日期 --取本金余额为0的最小DT前一天
        ,T1.wrt_off_amt
FROM     app_rpt.FCT_LOAN_WRT_OFF_DD T1
WHERE   T1.DT <= '@@{yyyyMMdd}'
AND     T1.wrt_off_amt	= 0  --核后本金余额为0，核后利息余额和已核销本金利息加总大于0
GROUP BY T1.dbil_id ;



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_1;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_1 AS
SELECT
   T1.CTR_SERNO AS 合同流水号
   ,T1.DBIL_ID AS 借据流水号
   ,T1.MGR_ORG_ID AS 管护机构号
   ,T2.org_nm AS 管户机构名称
   ,T2.brc_org_nm AS 分行
   ,T1.CST_ID  AS 客户号
   ,T1.CST_NM AS 客户名称
   ,T1.LVE_ACT_BGN_DT  AS 发放日期
   ,T1.APNT_MTU_DT AS 约定到期日期
   ,T1.PRCP_BAL AS 本金余额
   ,T3.actual_cancel_intr	 AS 截至8月底核销利息
   ,T3.finish_cancel_intr	 AS 截至8月底已核销本金利息
   ,T1.RCV_ACR_INTR AS 应收应计利息金额
   ,T1.RCV_OVD_INTR AS 应收欠息
   ,T1.COLL_OVD_INTR AS 催收欠息
   ,T1.RCVB_ACR_PNY_INTR AS 应收应计罚息
   ,T1.COLL_ACR_PNY_INTR AS 催收应计罚息
   ,T1.RCVB_PNY_INTR AS 应收罚息
   ,T1.COLL_PNY_INTR AS 催收罚息
   ,T1.ACR_CINT AS 应计复息
   ,T1.COLL_ACR_INTR AS 催收应计利息
   ,T1.CINT  AS  复息金额
   ,T1.RCV_ACR_INTR+T1.RCV_OVD_INTR+T1.COLL_OVD_INTR+T1.RCVB_ACR_PNY_INTR+T1.COLL_ACR_PNY_INTR+T1.RCVB_PNY_INTR+T1.COLL_PNY_INTR+T1.ACR_CINT+T1.COLL_ACR_INTR+T1.CINT AS 合计利息
   ,T3.cancel_dt	 AS 核销日期
   ,T3.acm_clbk_amt AS 累计回收本金
   ,T3.acm_clbk_intr	 AS 累计回收利息
   ,CASE WHEN T3.cancel_dt IS NOT NULL  THEN T5.本金结清日期 ELSE T4.本金结清日期 END AS  本金结清日期
   ,T3.wrt_off_amt  AS 核后本金余额
   ,T3.wrt_off_intr AS 核后利息余额
   ,T3.finish_cancel_intr	 AS 已核销本金利息
FROM edw.dim_bus_loan_dbil_inf_dd T1 --信贷借据信息
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T2 --机构树_考核维度
ON      T1.MGR_ORG_ID = T2.org_id
AND     T2.DT = '20240831'
LEFT JOIN  app_rpt.FCT_LOAN_WRT_OFF_DD T3 --贷款核销报表
ON      T1.DBIL_ID = T3.dbil_id
AND     T3.DT = '20240831'
LEFT JOIN  lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_2 T4
ON      T1.DBIL_ID = T4.dbil_id
LEFT JOIN  lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_3 T5
ON      T1.DBIL_ID = T5.dbil_id
LEFT JOIN  edw.dim_bus_loan_ctr_bse_inf_dd T6
ON      T1.CTR_SERNO = T6.CTR_SERNO
AND     T6.ctr_bal = 0
AND     T6.dt= '20240831'
WHERE T1.DT='20240831'
AND (
      ( T1.PRCP_BAL ='0'
    AND  T1.RCV_ACR_INTR+T1.RCV_OVD_INTR+T1.COLL_OVD_INTR+T1.RCVB_ACR_PNY_INTR+T1.COLL_ACR_PNY_INTR+T1.RCVB_PNY_INTR+T1.COLL_PNY_INTR+T1.ACR_CINT+T1.COLL_ACR_INTR+T1.CINT >0
      )   --本清利存：非核销(本金余额为0，那一些利息加起来是大于0的)
   OR (T3.wrt_off_amt =0 AND T3.wrt_off_intr	+ T3.finish_cancel_intr >0)  -- 核销(核后本金余额为0，核后利息余额和已核销本金利息加总大于0)
);


--结果表2
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_02;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_02 AS
SELECT
    T1.*
	,T2.PRCP_BAL AS 核销时本金
	,CASE WHEN T3.合同流水号 IS NOT NULL THEN '是' ELSE '否' END AS 本金结清日期后是否有催记
FROM lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_1 T1
LEFT JOIN  edw.dim_bus_loan_dbil_inf_dd T2
ON  TO_CHAR(DATEADD(TO_DATE(核销日期,'YYYY-MM-DD'),-1,'dd'),'YYYYMMDD') = T2.DT
AND  T1.借据流水号 = T2.DBIL_ID
AND  T2.DT IN (SELECT DISTINCT TO_CHAR(DATEADD(TO_DATE(核销日期,'YYYY-MM-DD'),-1,'dd'),'YYYYMMDD') as 核销日期  FROM lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_1 )
LEFT JOIN (
           SELECT
               DISTINCT  A1.合同流水号
           FROM lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_1 A1
           INNER JOIN edw.zcbq_risk_collect_record A2   --催收痕迹
           ON  A1.合同流水号 = A2.cont_card_no
           AND  A1.本金结清日期<SUBSTR(REPLACE(A2.coln_date,'-',''),1,8)
		   AND  A2.coln_way IN ('02','03','04','06','11','99','17','20') -- 催记口径：催收方式为&ldquo;催收短信、催收电子邮件、电话录音催收、上门催收、现场催收、其他、分期还款、债务拆分&rdquo;
		   AND  A2.coln_source <> '102010'   --渠道不为短信平台
           AND A2.DT = '20240831'
          ) T3
ON   T1.合同流水号 = T3.合同流水号 ;



-- 3.2023.5-2024.4结清的业务：本金结清到利息减免之间耗时（期间有无催记）；


-- 合同流水号	借据流水号	管护机构号	管户机构名称	分行	客户号	客户名称	发放日期	约定到期日期	本金结清日期	是否利息减免	利息减免日期	本金结清日期后是否有催记

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_03_1;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_03_1 AS
SELECT  T1.CTR_SERNO       AS 合同流水号
        ,T1.DBIL_ID        AS 借据流水号
        ,T1.MGR_ORG_ID     AS 管护机构号
        ,T2.org_nm         AS 管户机构名称
        ,T2.brc_org_nm     AS 分行
        ,T1.CST_ID         AS 客户号
        ,T1.CST_NM         AS 客户名称
        ,T1.LVE_ACT_BGN_DT AS 发放日期
        ,T1.APNT_MTU_DT    AS 约定到期日期
        ,T0.TMT_DT         AS 合同结清日期
        ,T1.TMT_DT         AS 借据结清日期
        ,T4.本金结清日期
        ,CASE
           WHEN T3.jiaoyirq IS NOT NULL THEN '是'
           ELSE '否'
         END               AS 是否利息减免
        ,T3.jiaoyirq       AS 利息减免日期
FROM    edw.dim_bus_loan_dbil_inf_dd T1 --信贷借据信息
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T0 --合同基础信息
ON      T1.ctr_serno = T0.ctr_serno --业务流水号关联
AND     T0.dt = '20240831'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T2 --机构树_考核维度
ON      T1.MGR_ORG_ID = T2.org_id
AND     T2.DT = '20240831'
LEFT JOIN    (
                 SELECT  DISTINCT dkjiejuh
                                 ,jiaoyirq
                 FROM    edw.core_klnl_dkzhmx a
                 WHERE   a.jiaoyisj IN ( 'LN_BXTZ' , 'LN_LXTZ' )
                 AND     zhaiyoms NOT LIKE '%抵扣%'
				         AND     jiaoyima <> 'w02b'  --转出转账撤销
                 AND     DT >= '20171118'
                 and dkjiejuh='2022091900004694'
             ) T3
ON      T1.DBIL_ID = T3.dkjiejuh
LEFT JOIN  lab_bigdata_dev.tmp_yuqi_SJ2024090396_02_2 T4
ON      T1.DBIL_ID = T4.dbil_id
WHERE   T1.DT = '20240831'
AND     T0.tmt_dt>= '20230501'
AND     T0.tmt_dt<= '20240430';


--结果表3
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqi_SJ2024090396_03;

CREATE TABLE lab_bigdata_dev.tmp_yuqi_SJ2024090396_03 AS
SELECT  DISTINCT T1 . *
             ,CASE
                WHEN T3.合同流水号 IS NOT NULL THEN '是'
                ELSE '否'
              END AS 本金结清日期后是否有催记
FROM    lab_bigdata_dev.tmp_yuqi_SJ2024090396_03_1 T1
LEFT JOIN    (
                 SELECT  DISTINCT A1.合同流水号
                 FROM    lab_bigdata_dev.tmp_yuqi_SJ2024090396_03_1 A1
                 INNER JOIN    edw.zcbq_risk_collect_record A2
                 ON      A1.合同流水号 = A2.cont_card_no
                 AND     A1.本金结清日期 < SUBSTR(REPLACE(A2.coln_date, '-', ''), 1, 8)
                 AND     A2.coln_way IN ('02','03','04','06','11','99','17','20') -- 催记口径：催收方式为&ldquo;催收短信、催收电子邮件、电话录音催收、上门催收、现场催收、其他、分期还款、债务拆分&rdquo;
		         AND     A2.coln_source <> '102010'   --渠道不为短信平台
                 AND     A2.DT = '20240831'
             ) T3
ON      T1.合同流水号 = T3.合同流水号
WHERE   T1.是否利息减免='是'
;
**01-数据需求_保全_2024_SJ2024090536_梁贝贝_法院执行立案后收回本息数据.sql
-- 数据用途
-- 因报送法院需要，申请清单内业务法院执行立案后收回本息数据

-- 台州路桥法院执行清单内的贷款、信用卡、承兑业务自执行立案之日起至2024年8月31日收回本金金额、收回利罚息金额、收回总额
-- 数据需求字段
-- 合同流水号或信用卡卡号、业务类型、客户名字、收回本金金额、收回利罚息金额、收回本息金额合计


--信用卡

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqihuankuan_SJ2024090536_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yuqihuankuan_SJ2024090536_01 AS
SELECT  T1.COL_1              AS 信用卡卡号
        ,T1.COL_2             AS 业务类型
        ,T1.COL_3             AS 借款人
        ,T1.COL_4             AS 诉讼本金
        ,T1.COL_5             AS 诉讼案号
        ,T1.COL_6             AS 执行案号
        ,T1.COL_7             AS 执行立案时间
        ,T2.TRX_TYP_CD        AS 还款类型代码
        ,T3.prt_cmt           AS 还款类型
        ,SUM(ABS(T2.trx_amt)) AS 交易金额
FROM    qbi_xinyongka_20240910_17_14_00 T1
LEFT JOIN    edw.dwd_bus_crd_cr_crd_trx_dtl_di T2 --信用卡交易流水表
ON      T1.COL_1 = T2.cr_crd_card_nbr
AND     T2.wdw_rvs_ind <> '1' --撤销冲正标志 ,0冲正，1撤销
AND     T2.TRX_TYP_CD >= '7000'
AND     T2.TRX_TYP_CD <= '7999' --还款交易：根据tran表统计，交易类型7000-7999
AND     T2.DT >= SUBSTR(REPLACE(T1.COL_7, '-', ''), 1, 8)
AND     T2.DT >= '20160219'
LEFT JOIN    edw.dim_bus_crd_cr_crd_trx_typ_dd T3  --信用卡交易类型信息
ON      T2.TRX_TYP_CD = T3.cr_crd_trx_typ
AND     T3.DT = '@@{yyyyMMdd}'
WHERE   T1.PT <> ''
GROUP BY COL_1 , COL_2 , COL_3 , COL_4 , COL_5 , COL_6 , COL_7 , T2.TRX_TYP_CD , T3.prt_cmt;


--贷款和承兑
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqihuankuan_SJ2024090536_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yuqihuankuan_SJ2024090536_02 AS
SELECT  COL_1            AS 合同流水号
        ,COL_2           AS 业务类型
        ,COL_3           AS 借款人
        ,COL_4           AS 诉讼本金
        ,COL_5           AS 诉讼案号
        ,COL_6           AS 执行案号
        ,COL_7           AS 执行立案时间
        ,T3.bal_fld_cmt  AS 交易类型
        ,SUM(T3.trx_amt) AS 交易金额
        ,T3.trx_dt       AS 交易日期
        ,T3.evt_cmt      AS 事件或交易说明
FROM    qbi_daikchengdui_20240910_17_15_11 T1
LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd T2
ON      T1.COL_1 = T2.CTR_SERNO
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_act_trx_dtl_di T3 --贷款账户交易明细
ON      T2.dbil_id = T3.loan_dbil_id
AND     T3.dt >= '20160105'
AND     T3.DT >= SUBSTR(REPLACE(T1.COL_7, '-', ''), 1, 8)
-- AND     T3.rvs_ind <> '1'  --冲正标志
-- AND     T3.rvsd_ind <> '1'  --被冲正标志
AND     T3.trx_dir = '1' --交易方向为还款，事件说明&lsquo;逾期还本&rsquo;
WHERE   T1.PT <> ''
GROUP BY COL_1 , COL_2 , COL_3 , COL_4 , COL_5 , COL_6 , COL_7 , T3.bal_fld_cmt ,T3.trx_dt, T3.evt_cmt;



-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yuqihuankuan_SJ2024090536_022 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_yuqihuankuan_SJ2024090536_022 AS
-- SELECT  COL_1                                   AS 合同流水号
--         ,COL_2                                  AS 业务类型
--         ,COL_3                                  AS 借款人
--         ,COL_4                                  AS 诉讼本金
--         ,COL_5                                  AS 诉讼案号
--         ,COL_6                                  AS 执行案号
--         ,COL_7                                  AS 执行立案时间
--         ,SUM(T3.prcp_amt)                       AS 收回本金金额
--         ,SUM(T3.RCV_ACR_INTR_AMT+T3.rcv_acr_intr_pnty_amt)               AS 收回利罚息金额
--         ,SUM(T3.prcp_amt + T3.RCV_ACR_INTR_AMT+T3.rcv_acr_intr_pnty_amt) AS 收回本息金额合计
-- FROM    qbi_daikchengdui_20240910_17_15_11 T1
-- LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd T2
-- ON      T1.COL_1 = T2.CTR_SERNO
-- AND     T2.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_bus_loan_trm_pmt_trx_dtl_di T3 --贷款期供交易明细
-- ON      T2.dbil_id = T3.dbil_id
-- AND     T3.dt >= '20160105'
-- AND     T3.DT >= SUBSTR(REPLACE(T1.COL_7, '-', ''), 1, 8)
-- where    T1.PT <> ''
-- GROUP BY COL_1 , COL_2 , COL_3 , COL_4 , COL_5 , COL_6 , COL_7;
**01-数据需求_保全_2024_SJ2024090661_胡航钱_逾期业务借款人以及担保人信息及征信负债.sql
-- 合同流水号、客户名称、年龄、手机号码、户籍地址、居住地址、我行业务余额、业务类型（信用卡、贷款、随贷通等），法院执行案件数、
-- 征信数据（1.贷款机构家数2.贷款余额3.信用卡张数4.信用卡使用余额5.对外担保笔数、金额及五级分类状态）


--临时表1 法院相关信息,法院是否有异常数据
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_01 AS
SELECT  a.dt
        ,a.cst_id
        ,b.fqm_ctfno
        ,CASE
           WHEN ( FQM_FXMSGNUM > 0 OR FQM_ZHIXINGNUM > 0 OR FQM_CAIPANNUM > 0 OR FQM_SHENPANNUM > 0 OR FQM_WEIFANUM > 0 OR FQM_SHIXINNUM > 0 OR FQM_XIANGAONUM > 0
		        OR FQM_XIANCHUNUM > 0 OR FQM_ZUIFANNUM > 0 OR FQM_QIANSHUINUM > 0 OR FQM_FEIZHENGNUM > 0 OR FQM_QIANKUANNUM > 0 ) THEN 1
           ELSE 0
         END       AS 法院是否有异常数据
        ,CONCAT_WS('|', concat('风险总条数:', FQM_FXMSGNUM), concat('执行条数:', FQM_ZHIXINGNUM), concat('裁判条数:', FQM_CAIPANNUM), concat('审判条数:', FQM_SHENPANNUM)
		              , concat('违法条数:', FQM_WEIFANUM), concat('失信条数:', FQM_SHIXINNUM), concat('限高条数:', FQM_XIANGAONUM), concat('限出条数:', FQM_XIANCHUNUM)
					  , concat('罪犯条数:', FQM_XIANCHUNUM), concat('欠税条数:', FQM_QIANSHUINUM), concat('非正条数:', FQM_FEIZHENGNUM), concat('欠款条数:', FQM_QIANKUANNUM)
					  )  AS 法院相关信息
FROM    edw.dws_cst_bas_inf_dd a
LEFT JOIN    (
                 SELECT  t1 . *
                         ,row_number() OVER ( PARTITION BY fqm_ctfno ORDER BY FQM_HOSTSENDTIME DESC ) AS ROW_NO
                 FROM    (
                             SELECT  fqm_ctfno --证件号
                                     ,FQM_NAMECN -----客户名称,
                                     ,FQM_FXMSGNUM -----风险总条数,
                                     ,FQM_ZHIXINGNUM -----执行条数,
                                     ,FQM_CAIPANNUM -----裁判条数,
                                     ,FQM_SHENPANNUM -----审判条数,
                                     ,FQM_WEIFANUM -----违法条数    ,
                                     ,FQM_SHIXINNUM -----失信条数   ,
                                     ,FQM_XIANGAONUM -----限高条数  ,
                                     ,FQM_XIANCHUNUM -----限出条数  ,
                                     ,FQM_ZUIFANNUM -----罪犯条数   ,
                                     ,FQM_QIANSHUINUM -----欠税条数 ,
                                     ,FQM_FEIZHENGNUM -----非正条数 ,
                                     ,FQM_QIANKUANNUM -----欠款条数 ,
                                     ,FQM_HOSTSENDTIME
                             FROM    EDW.OUTD_FY_QUERY_MAIN   --法院精确查询主信息表
                             WHERE   DT <= '@@{yyyyMMdd}'
                             UNION ALL
                             SELECT  fqm_ctfno --证件号
                                     ,fqm_namecn
                                     ,fqm_fxmsgnum
                                     ,fqm_zhixingnum
                                     ,FQM_CAIPANNUM -----裁判条数,
                                     ,FQM_SHENPANNUM -----审判条数,
                                     ,FQM_WEIFANUM -----违法条数    ,
                                     ,FQM_SHIXINNUM -----失信条数   ,
                                     ,FQM_XIANGAONUM -----限高条数  ,
                                     ,FQM_XIANCHUNUM -----限出条数  ,
                                     ,FQM_ZUIFANNUM -----罪犯条数   ,
                                     ,FQM_QIANSHUINUM -----欠税条数 ,
                                     ,FQM_FEIZHENGNUM -----非正条数 ,
                                     ,FQM_QIANKUANNUM -----欠款条数 ,
                                     ,fqm_hostsendtime
                             FROM    edw.nout_fy_query_main   --法院精确查询主信息表
                             WHERE   DT <= '@@{yyyyMMdd}'
                             AND     ifrichard = '1'  ----表示已查得
                         ) t1
             ) b
ON      a.doc_nbr = b.fqm_ctfno
AND     b.ROW_NO = 1
WHERE   a.dt = '@@{yyyyMMdd}'
GROUP BY a.dt , a.cst_id , b.fqm_ctfno, FQM_FXMSGNUM , FQM_ZHIXINGNUM , FQM_CAIPANNUM , FQM_SHENPANNUM , FQM_WEIFANUM
       , FQM_SHIXINNUM , FQM_XIANGAONUM , FQM_XIANCHUNUM , FQM_ZUIFANNUM , FQM_QIANSHUINUM , FQM_FEIZHENGNUM , FQM_QIANKUANNUM;



--临时表2 征信贷款机构家数，贷款余额
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_02 AS
SELECT  A1.dt                     AS acct_dt
        ,A1.cst_id
        ,A1.report_id
        ,COUNT(DISTINCT dtrb_org) AS 贷款机构家数
        ,SUM(ctr_bal)             AS 贷款余额
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     ( A1.mtu_dt >= A1.DT
AND     ctr_bal > 0 ) --未到期
AND     A1.pd_cd IN ( '11' , '12' , '13' , '21' , '31' , '32' , '33' , '41' , '51' , '52' , '53' , '91' , '99' ) --业务品种贷款
AND     act_typ_cd NOT IN ( 'R2' , 'R3' , 'C1' ) --剔除贷记卡账户，准贷记卡账户，催收账户
GROUP BY A1.dt , A1.cst_id , A1.report_id
UNION ALL
SELECT  A1.dt                        AS acct_dt
        ,A1.cst_id
        ,A1.report_id
        ,COUNT(DISTINCT dtrb_org_cd) AS 贷款机构家数
        ,SUM(loan_bal)               AS 贷款余额
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     ( A1.loan_mtu_dt >= A1.DT
AND     loan_bal > 0 ) --未到期
AND     A1.bus_pd_cls_cd = '11' --业务产品种类代码贷款
AND     act_typ NOT IN ( 'D2' , 'C1' ) ---- 剔除催收账户和贴现账户
GROUP BY A1.dt , A1.cst_id , A1.report_id;



--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_03 AS
SELECT  T1.ctr_serno                                                                  AS 合同流水号
        ,T1.cst_nm                                                                    AS 客户名称
        ,DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(T3.BTH_DT, 'YYYYMMDD'), 'YYYY') AS 年龄
        ,T2.mbl_nbr                                                                   AS 手机号码
        ,T2.REG_ADR                                                                   AS 户籍_注册地址
        ,T2.FML_ADR                                                                   AS 居住地址
        ,T1.ctr_bal                                                                   AS 我行业务余额
        ,T0.信用卡余额
        ,T4.pd_nm                                                                     AS 业务类型
        ,T5.法院相关信息                                                                    AS 法院执行案件数
        ,T8.贷款机构家数
        ,T8.贷款余额
        ,T6.cred_card_num                                                             AS 信用卡张数
        ,T6.cred_card_total_balan                                                     AS 信用卡总余额
        ,COALESCE(T6.ext_guar_num, T7.guar_contr_count)                               AS 对外担保笔数
        ,COALESCE(T6.guar_contr_amt, T7.guar_contr_amt)                               AS 对外担保金额
        ,COALESCE(T6.five_cgy_cd, T7.five_cgy_cd)                                     AS 五级分类状态
        ,T9.WRNT_CST_NM                                                               AS 担保人名称
        ,T91.法院相关信息                                                                   AS 担保人法院执行案件数
        ,T94.贷款机构家数                                                                   AS 担保人贷款机构家数
        ,T94.贷款余额                                                                     AS 担保人贷款余额
        ,T92.cred_card_num                                                            AS 担保人信用卡张数
        ,T92.cred_card_total_balan                                                    AS 担保人信用卡总余额
        ,COALESCE(T92.ext_guar_num, T93.guar_contr_count)                             AS 担保人对外担保笔数
        ,COALESCE(T92.guar_contr_amt, T93.guar_contr_amt)                             AS 担保人对外担保金额
        ,COALESCE(T92.five_cgy_cd, T93.five_cgy_cd)                                   AS 担保人五级分类状态
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    (
                 SELECT  A2.busi_ctr_id
                         ,A1.bal AS 信用卡余额
                         ,A1.ovd_amt
                 FROM    edw.dws_bus_crd_cr_crd_act_inf_dd A1 --信用卡账户信息汇总
                 LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd A2 --信用卡卡片信息
                 ON      A1.cr_crd_act_id = A2.cr_crd_act_id
                 AND     A2.DT = '20240831'
                 WHERE   A1.DT = '20240831'
                 AND     A1.ovd_amt > 0
             ) T0
ON      T1.ctr_serno = T0.busi_ctr_id
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20240831'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20240831'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T4 --产品信息
ON      T1.prd_no = T4.prd_no
AND     T4.DT = '20240831'
LEFT JOIN    lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_01 T5
ON      T1.cst_id = T5.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T6 --个人征信指标信息表
ON      T1.cst_id = T6.cst_id
AND     T6.report_dsc_rn = '1'
AND     T6.DT = '20240831'
LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd T7 --企业征信指标信息表
ON      T1.cst_id = T7.cst_id
AND     T7.report_dsc_rn = '1'
AND     T7.DT = '20240831'
LEFT JOIN    lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_02 T8
ON      T1.cst_id = T8.cst_id
AND     COALESCE(T6.report_no, T7.report_no) = T8.report_id
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd T9 --担保人汇总信息
ON      T1.ctr_serno = T9.BUS_CTR_ID
AND     T9.DT = '20240831'
LEFT JOIN    lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_01 T91
ON      T9.WRNT_CST_ID = T91.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T92 --个人征信指标信息表
ON      T9.WRNT_CST_ID = T92.cst_id
AND     T92.report_dsc_rn = '1'
AND     T92.DT = '20240831'
LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd T93 --企业征信指标信息表
ON      T9.WRNT_CST_ID = T93.cst_id
AND     T93.report_dsc_rn = '1'
AND     T93.DT = '20240831'
LEFT JOIN    lab_bigdata_dev.tmp_ningbo_yuqi_SJ2024090661_02 T94
ON      T9.WRNT_CST_ID = T94.cst_id
AND     COALESCE(T92.report_no, T93.report_no) = T94.report_id
WHERE   T1.DT = '20240831'
AND     ( T1.ovd_amt > 0 --逾期金额>0
    OR T0.ovd_amt > 0 --信用卡
	)
AND     SUBSTR(T1.hdl_org_id, 1, 4) = '3303' --经办机构宁波分行
;
**01-数据需求_保全_2024_SJ20240910101_胡婷_用于跟进所有未结清重组贷款的还款落实情况.sql
--无导数权限

-- DROP TABLE if EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240910101_01 PURGE ;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240910101_01 (
--     ctr STRING  COMMENT '合同号'
--     ,cst_id STRING COMMENT '客户号'
-- ) COMMENT '重组客户清单'
-- ;

INSERT INTO TABLE lab_bigdata_dev.tmp_sjxq_SJ20240910101_01
(ctr,cst_id)
values
('BC2024071600002022','1681095984'),
('BC2024011200002840','1643228337'),
('BC2024070900003176','7006318236'),
('BC2024071800000297','7653962777'),
('HTBH2024082200002358','7005426400'),
('BC2024052800003362','7649691365'),
('BC2024062000002407','1650036121'),
('BC2024051300002781','1646708371'),
('HTBH2024080900002972','1674600682'),
('BC2024060700003505','7005604776'),
('BC2024071000000179','7006332919'),
('HTBH2024083000000666','1652218414'),
('BC2024030100000261','7005936611'),
('BC2024031300001749','7645100949'),
('HTBH2024081300001531','7005999177'),
('HTBH2024081600000418','7005314200'),
('BC2024062400001647','1679183598'),
('HTBH2024073100002322','1606008312'),
('BC2024052300003208','1604645082'),
('HTBH2024081300002551','1605017403'),
('BC2024032100002522','1600555280'),
('BC2024071600000092','7005630656'),
('BC2024060400002855','1679370323'),
('BC2024071100000437','1646724778'),
('HTBH2024082300002159','7656135313'),
('HTBH2024090400002641','7005671350'),
('HTBH2024090500002636','1670436379'),
('BC2024060600003031','7005854979'),
('BC2024061500000058','7006080063'),
('HTBH2024082800002807','1636523613'),
('HTBH2024082900000053','1605993220'),
('HTBH2024083000000008','7006037713'),
('HTBH2024090400000482','1602631846'),
('BC2024041700002615','7005606495'),
('BC2024030700002456','7689800729'),
('BC2024031900000542','7006060881'),
('BC2024040700000514','7006019250'),
('BC2024040800001885','7005842532'),
('BC2024042900002617','7693844519'),
('HTBH2024082000000688','7005819673'),
('BC2024030700001304','1643810027'),
('BC2024030700001311','1651745949'),
('BC2024051700002172','7005834122'),
('BC2024060700000291','1652501547'),
('BC2024041000002761','7620171736'),
('BC2024040800000412','7006065343'),
('BC2024041000002182','1610606996'),
('BC2024043000002412','7005905945'),
('BC2024062600001798','7005912798'),
('BC2024062700001993','1610259621'),
('BC2024020800001113','1676305781'),
('BC2024051100000129','7006011234'),
('BC2024071200000256','1612299801'),
('HTBH2024080100001663','7006096521'),
('BC2024060500000526','7005911009'),
('BC2024071800003752','7651296902'),
('HTBH2024080900002976','7006245819'),
('BC2024070300000795','1636980361'),
('BC2024032600002565','7006415319'),
('HTBH2024072900001802','1600055722'),
('HTBH2024080100002102','7006300206'),
('BC2024071600002154','7647744012'),
('BC2024071800000262','1600198343'),
('BC2024020100002902','7006041196'),
('BC2024052800000022','1671201792'),
('BC2024032700002963','7006227457'),
('BC2024062000003115','1606931319'),
('BC2024071100001780','7005741600'),
('HTBH2024082900003618','1606931319'),
('BC2024031100002167','7006364189'),
('BC2024052700002533','7643312530'),
('HTBH2024090300000917','1608764512'),
('BC2024030800001141','1676932924'),
('BC2024052200001640','1644123876'),
('HTBH2024080500001270','1613674410'),
('HTBH2024080800001065','1614541009'),
('HTBH2024081500002625','7006342404'),
('BC2024041200001745','1645960089'),
('BC2024042900003752','1679341643'),
('BC2024051100001542','1611652094'),
('HTBH2024081600001841','7006122923'),
('BC2024011400000041','7669511362'),
('HTBH2024080900001686','1683413716'),
('BC2024041800002861','1613881455'),
('BC2024032800002275','7006348011'),
('BC2024040500000085','7006323562'),
('BC2024040500000086','7006323098'),
('BC2024040800002131','1673207923'),
('BC2024053100003743','1610433744'),
('HTBH2024090300001609','7005541666'),
('HTBH2024090500002940','7005541666'),
('BC2024042200001180','1602490390'),
('BC2024050700000064','7005835330'),
('BC2024071600001907','1632285210'),
('HTBH2024081600001375','7005697079')
;


DROP TABLE IF EXISTS tmp_sjxq_SJ20240910101 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20240910101 AS
SELECT  T0.ctr 合同流水
        ,T0.cst_id 客户号
        ,plan_type 方案类型
        ,plan_amt 方案金额
        ,maturity 到期日
        ,bor_date 借款日
        ,pay_type 还款方式
        ,rate 助兴通利率
        ,cust_no 重组客户号
        ,cust_nm 重组客户名称
        ,guar_mod 担保方式
        ,bor_change 借款人主体是否变更
        ,ori_bor 原借款人
        ,new_bor 新借款人
        ,guar_change 担保人物是否变更
        ,ori_guar 原担保人
        ,new_guar 新担保人
        ,reg_situ 收回情况
        ,int_dera 是否存在利息减免
        ,apply_dera_amt 申请减免金额
        ,dera_loan_amt 减免贷款本金
        ,dera_loan_int 减免贷款正常利息
        ,dera_loan_pent 减免贷款罚息
        ,dera_card_amt 减免随贷通卡金额
        ,dera_card_pent 减免随贷通卡罚息
        ,dera_card_int 减免随贷通卡正常利息
        ,dera_reason 情况说明及申请减免理由
        ,loan_context 助兴通贷款背景情况
        ,plan_dispo 助兴通方案说明及处置计划
        ,rate_des 利率调整说明
        ,act_cust_nm 实际助兴通客户名称
        ,act_cust_no 实际助兴通客户号
        ,act_amt 实际助兴通金额
        ,act_deadline 实际助兴通期限
        ,act_rate 实际助兴通利率
        ,act_busi_type 实际助兴通业务品种
        ,act_loan_purp 实际助兴通贷款用途
        ,act_guad_mod 实际助兴通担保方式
        ,had_used 方案是否被使用
FROM    tmp_sjxq_SJ20240910101_01 T0
LEFT JOIN    edw.zcbq_loan_restruct_plan t ---助兴通贷款方案申请
ON      T0.cst_id = t.cust_no
AND     t.dt = '@@{yyyyMMdd}'
where   t0.cst_id NOT IN ('7005541666','1606931319')  --一个客户有2个合同，无合同号对应先删除处理
;
**01-数据需求_保全_2024_SJ2024091091_诸银君_逾期借款人和担保人的身份证前6位.sql
-- SJ2024091091
-- 逾期客户催收需要，确认一下客户的户籍信息
-- 逾期业务借款人和担保人的身份证号前6位
-- 客户号，客户名称，身份证号前6位

CREATE TABLE IF NOT EXISTS  tmp_sfz_SJ2024091091 as
SELECT T1.COL_2 核心客户编号
       ,T1.col_3 名称
       ,substr(T2.doc_nbr,1,6) 身份证号前6位
FROM qbi_file_20240911_14_38_22 T1
left join edw.dws_cst_bas_inf_dd T2
on T1.col_2=T2.cst_id
and T2.dt='@@{yyyyMMdd}'
WHERE T1.pt<>''
;
**01-数据需求_保全_2024_SJ20240929111_张颖_信用卡核销盘点_是否自动审批_标签.sql
-- SJ20240929111
-- 因信用卡核销盘点需要，需求提起信用卡&rdquo;是否自动审批&ldquo;标签（新信贷-信用卡信息查询-是否自动审批）

-- SELECT * FROM tmp_zy_SJ20240929111;

DROP TABLE IF EXISTS tmp_zy_SJ20240929111 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zy_SJ20240929111 AS
SELECT  T.col_1 AS 卡号
        ,CASE
           WHEN T1.BSN_APRV_MOD_CD = 1 THEN '机批'
           WHEN T1.BSN_APRV_MOD_CD = 2 THEN '人批'
         END    AS 是否自动审批
FROM    qbi_file_20241008_16_14_03 T
LEFT JOIN    (
                 SELECT  ccr.cr_crd_card_nbr
                         ,rab.BSN_APRV_MOD_CD --1 机批 2 人批
                 FROM    edw.dim_bus_crd_cr_crd_inf_dd ccr --信用卡卡片信息
                 LEFT JOIN    edw.loan_ctr_bse_inf cbi --合同基础信息
                 ON      cbi.CTR_SERNO = ccr.busi_ctr_id
                 AND     cbi.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.loan_reply_aply_biz rab --批复用信方案 或者edw.dwd_bus_loan_lmt_aply_biz_dd  --用信方案
                 ON      rab.USC_APLY_SERNO = cbi.REL_SERNO
                 AND     rab.dt = '@@{yyyyMMdd}'
                 WHERE   ccr.dt = '@@{yyyyMMdd}'
                 AND     cbi.REG_TYP = '01'  --登记类型: 01 用信申请，02 资产池授信 03 贷后变更 04 合作方授信 05 合同整改 06 提款申请 07 合作方授信变更 08 随贷通调额
             ) T1
ON      T.col_1 = T1.cr_crd_card_nbr
WHERE   T.pt <> ''
;
**01-数据需求_保全_2024_SJ2024101116_梁世鹏_业务数据剥离时点与9月末的风险成本数据.sql
-- SJ2024101116

--字段:本金余额-剥离日期、pd-剥离日期、lgd-剥离日期、风险成本-剥离日期	本金余额-20240930、pd-20240930、lgd-20240930、风险成本-20240930

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

--临时表：COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD



DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20240930'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

  UNION ALL

  SELECT
    T2.DT
    ,T2.DBIL_SRL_NO
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
    ,T2.PD_START_VALUE AS PD_ORIG_VALUE
    ,CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END AS LGD_ORIG_VALUE
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
    (CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END) AS RSK_COST
  FROM
  (
    SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
    ,T1.GRNT_MODE
    ,T1.OVD_REPAY_RATE REPAY_RATE
    ,T1.CST_PRCP_BAL
    ,T1.VOUCH_PERSON_NUMBER
    ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
    ,CASE
      WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
        THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
      ELSE 0
    END OVDR_MTH_TERM
    FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
    WHERE T1.DT>='20231231' AND T1.DT<='20240930'
    AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
  ) T2
;

SELECT min(dt) FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD WHERE dt<='20231231'

---*******************全量业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

SELECT * FROM tmp_baoquan_SJ2024101161_blrq_02 WHERE 借据流水号_卡号='20121026000792';

SELECT * FROM qbi_file_20241012_15_38_48 where pt<>'' and col_2='20121026000792'

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_blrq_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20240930'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
and     (p.COL_2  like '62%' OR p.COL_2 like '42%')
;

-- SELECT COUNT(1) FROM tmp_baoquan_SJ2024101161_blrq_02

-- 2024年9月30日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_20240930_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_20240930_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240930
                 ,t.PD_ORIG_VALUE pd值_20240930
                 ,t.LGD_ORIG_VALUE lgd值_20240930
                 ,t.RSK_COST 风险成本_20240930
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20240930'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
and substr(p.COL_2,1,2) not in('62','42')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20240930
                 ,t.PD_ORIG_VALUE pd值_20240930
                 ,t.LGD_ORIG_VALUE lgd值_20240930
                 ,t.RSK_COST 风险成本_20240930
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20240930'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20240930'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


--结果表:
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_0603_02 AS
SELECT  distinct t1.剥离所属分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20240930
       ,t2.pd值_20240930
       ,t2.lgd值_20240930
       ,t2.风险成本_20240930
from lab_bigdata_dev.tmp_baoquan_SJ2024101161_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024101161_20240930_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;


SELECT * FROM tmp_baoquan_SJ2024101161_0603_02 WHERE 借据流水号_卡号='20121026000792'
**01-数据需求_保全_2024_SJ2024101161_来玲玲_分村行新发生风险业务_清单由我部提供_从9.25_10.10的利息收回情况.sql
--

-- SJ2024101161

--分村行新发生风险业务（清单由我部提供）从9.25-10.10的利息收回情况

--在现有清单字段的基础上增加应收利息汇总、催收欠息、催收罚息、催收应计罚息、复息、应计复息、应收罚息、应收欠息、应收应计罚息、实收利息汇总



--回收利息=应收应计利息发生额+催收应计利息发生额+应收欠息发生额+催收欠息发生额+应收应计罚息发生额+催收应计罚息发生额+应收罚息发生额+催收罚息发生额+应计复息发生额+复息发生额



--村行,4294

DROP TABLE IF EXISTS tmp_lll_SJ2024101161_ch PURGE;



CREATE TABLE IF NOT EXISTS tmp_lll_SJ2024101161_ch AS

SELECT  a.col_1 合同流水号

        ,a.col_2 借据流水号

        ,sum(b.YSYJLXFS) 应收应计利息发生额

        ,sum(b.CSYJLXFS) 催收应计利息发生额

        ,sum(b.YSHQXIFS) 应收欠息发生额

        ,sum(b.CSHQXIFS) 催收欠息发生额

        ,sum(b.YSYJFXFS) 应收应计罚息发生额

        ,sum(b.CSYJFXFS) 催收应计罚息发生额

        ,sum(b.YSHFXIFS) 应收罚息发生额

        ,sum(b.CSHOFXFS) 催收罚息发生额

        ,sum(b.YJIFXIFS) 应计复息发生额

        ,sum(b.FUXIIIFS) 复息发生额

        --  ,b.hexlixfs 核销利息发生额

        --  ,b.lxitzhfs 利息调整发生额

        ,NVL(SUM(b.YSYJLXFS + b.CSYJLXFS + b.YSHQXIFS + b.CSHQXIFS + b.YSYJFXFS + b.CSYJFXFS + b.YSHFXIFS + b.CSHOFXFS + b.YJIFXIFS + b.FUXIIIFS), 0) AS 0925至1014回收利息和

        -- ,b.jiaoyisj 交易事件

        -- ,b.shjshuom 事件说明

        -- ,b.zhaiyoms  摘要

        -- ,b.jiaoyima 交易码

FROM    qbi_file_20241015_10_25_58 a

LEFT JOIN    edw.core_klnl_dkqgmx b --贷款期供表,或者edw.dwd_bus_loan_act_trx_dtl_di a --贷款账户交易明细，余额字段bal_fld_cmt

ON      a.col_2 = b.dkjiejuh

AND     b.dt >= '20240925'

AND     b.jiaoyirq >= '20240925'

WHERE   a.pt <> ''

GROUP BY a.col_1 , a.col_2,b.jiaoyisj,b.shjshuom,b.zhaiyoms,b.jiaoyima

;





--分行,54583条



DROP TABLE IF EXISTS tmp_lll_SJ2024101161_fh PURGE;



CREATE TABLE IF NOT EXISTS tmp_lll_SJ2024101161_fh AS

SELECT  a.col_1 合同流水号

        ,a.col_2 借据流水号

        ,sum(b.YSYJLXFS) 应收应计利息发生额

        ,sum(b.CSYJLXFS) 催收应计利息发生额

        ,sum(b.YSHQXIFS) 应收欠息发生额

        ,sum(b.CSHQXIFS) 催收欠息发生额

        ,sum(b.YSYJFXFS) 应收应计罚息发生额

        ,sum(b.CSYJFXFS) 催收应计罚息发生额

        ,sum(b.YSHFXIFS) 应收罚息发生额

        ,sum(b.CSHOFXFS) 催收罚息发生额

        ,sum(b.YJIFXIFS) 应计复息发生额

        ,sum(b.FUXIIIFS) 复息发生额

        --  ,b.hexlixfs 核销利息发生额

        --  ,b.lxitzhfs 利息调整发生额

        ,NVL(SUM(b.YSYJLXFS + b.CSYJLXFS + b.YSHQXIFS + b.CSHQXIFS + b.YSYJFXFS + b.CSYJFXFS + b.YSHFXIFS + b.CSHOFXFS + b.YJIFXIFS + b.FUXIIIFS), 0) AS 0925至1014回收利息和

FROM    qbi_file_20241015_11_06_55 a

LEFT JOIN    edw.core_klnl_dkqgmx b --贷款期供表,或者edw.dwd_bus_loan_act_trx_dtl_di a --贷款账户交易明细，余额字段bal_fld_cmt

ON      a.col_2 = b.dkjiejuh

AND     b.dt >= '20240925'

AND     b.jiaoyirq >= '20240925'

WHERE   a.pt <> ''

GROUP BY a.col_1 , a.col_2;
**01-数据需求_保全_2024_SJ2024101241_陈敏珠_杭州逾期网申卡地址催收走访.sql
-- 杭州分行逾期（逾期期数>0）网申卡客户地址，身份证前6位用来定位区域



-- SJ2024101241



-- 客户名称、身份证号码（前6位）、客户年龄、性别、卡号、卡产品名称、透支本金(含分期付款余额) 、余额 、逾期期数、户籍地址、家庭地址、公司地址、账单地址



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wsk_yq_SJ2024101241_01 PURGE;



CREATE TABLE lab_bigdata_dev.tmp_wsk_yq_SJ2024101241_01 AS

SELECT  T1.cst_nm                                                                     AS 客户名称

        ,SUBSTR(T3.DOC_NBR, 1, 6)                                                     AS 身份证号码前6位

        ,DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(T4.BTH_DT, 'YYYYMMDD'), 'YYYY') AS 客户年龄

        ,CASE

           WHEN T4.GDR_CD = '1' THEN '男性'

           WHEN T4.GDR_CD = '2' THEN '女性'

         END                                                                          AS 性别

        ,T1.cr_crd_card_nbr                                                           AS 卡号

        ,T1.cr_crd_pd_id                                                              AS 卡产品ID

        ,T5.cr_crd_pd_cmt                                                             AS 卡产品名称

        ,T2.ovdr_bal + T2.instl_rmn_not_paid_prcp_bal                                 AS 透支本金_含分期付款余额

        ,T2.bal                                                                       AS 余额

        ,T2.ovd_hi_trm                                                                AS 逾期期数

        ,T3.REG_ADR                                                                   AS 户籍地址

        ,T3.FML_ADR                                                                   AS 家庭地址

        ,T3.WRK_ADR                                                                   AS 公司地址

        ,T2.bil_adr                                                                   AS 账单地址

FROM    app_ado.fct_bus_crd_cr_crd_online_opr_inf_dd T1 --信用卡网申卡业务信息表

INNER JOIN    edw.dim_bus_crd_cr_crd_act_inf_dd T2 --信用卡账户信息

ON      T1.cr_crd_act_id = T2.cr_crd_act_id

AND     T2.ovd_hi_trm > 0 --逾期期数>0

AND     T2.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dws_cst_bas_inf_dd T3 --客户基础信息汇总表

ON      T1.cst_id = T3.cst_id

AND     T3.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T4 --个人客户基本信息汇总表

ON      T1.cst_id = T4.cst_id

AND     T4.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dim_bus_crd_cr_crd_pd_inf_dd T5 --信用卡产品信息

ON      T1.cr_crd_pd_id = T5.cr_crd_pd_id

AND     T5.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_bus_crd_cr_crd_mgr_inf_dd T6 --信用卡管护信息

ON      T1.cr_crd_card_nbr = T6.cr_crd_card_nbr

AND     T6.DT = '@@{yyyyMMdd}'

WHERE   T1.DT = '@@{yyyyMMdd}'

AND     SUBSTR(T6.acs_org_id, 1, 4) = '3302' --杭州分行

;
**01-数据需求_保全_2025_D0102_梁世鹏_12月末风险成本_新_.sql
-- SJ2025010376

-- 为分析存量数据清收对风险成本释放的影响，现需取相关业务数据剥离时点与12月末的风险成本数据。
--字段:本金余额-剥离日期、pd-剥离日期、lgd-剥离日期、风险成本-剥离日期	本金余额-20241231、pd-20241231、lgd-20241231、风险成本-20241231

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

--临时表：COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

-- SELECT * FROM COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD WHERE DBIL_SRL_NO='AD131334501020520210406893002155';

-- SELECT * FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
--  WHERE T1.DT='20231231' and DBIL_SRL_NO='AD131334501020520210406893002155';


-- SELECT * FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1   ----风险成本-信贷借据风险成本计量口径结果表
--  WHERE T1.DT='20231231' and DBIL_SRL_NO='AD131334501020520210406893002155';

----只要用时点表就可
DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20241231'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

--   UNION ALL

--   SELECT
--     T2.DT
--     ,T2.DBIL_SRL_NO
--     ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
--     ,T2.PD_START_VALUE AS PD_ORIG_VALUE
--     ,CASE
--      WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
--      WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
--      WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
--      ELSE 0.50
--     END AS LGD_ORIG_VALUE
--     ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
--     (CASE
--      WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
--      WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
--      WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
--      WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
--      WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
--      ELSE 0.50
--     END) AS RSK_COST
--   FROM
--   (
--     SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
--     ,T1.GRNT_MODE
--     ,T1.OVD_REPAY_RATE REPAY_RATE
--     ,T1.CST_PRCP_BAL
--     ,T1.VOUCH_PERSON_NUMBER
--     ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
--     ,CASE
--       WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
--         THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
--       ELSE 0
--     END OVDR_MTH_TERM
--     FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
--     WHERE T1.DT>='20231231' AND T1.DT<='20241231'
--     AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
--   ) T2
-- ;

---*******************全量业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；


-- SELECT * FROM tmp_baoquan_SJ20250103761_blrq_02 WHERE 借据流水号_卡号='AD131334501020520210406893002155'

DROP TABLE IF EXISTS tmp_baoquan_SJ20250103761_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_baoquan_SJ20250103761_blrq_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    qbi_file_20250210_11_49_37_0 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt <>''
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    qbi_file_20250210_11_49_37_0 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20241231'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt<>''
and     (p.COL_2  like '62%' OR p.COL_2 like '42%')
;



-- 2024年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS tmp_baoquan_SJ20250103761_20241231_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_baoquan_SJ20250103761_20241231_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20241231
                 ,t.PD_ORIG_VALUE pd值_20241231
                 ,t.LGD_ORIG_VALUE lgd值_20241231
                 ,t.RSK_COST 风险成本_20241231
FROM    qbi_file_20250210_11_49_37_0 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20241231'
WHERE  p.pt<>''
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
AND     substr(p.COL_2, 1, 2) NOT IN ( '62' , '42' )
UNION ALL
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20241231
                 ,t.PD_ORIG_VALUE pd值_20241231
                 ,t.LGD_ORIG_VALUE lgd值_20241231
                 ,t.RSK_COST 风险成本_20241231
FROM   qbi_file_20250210_11_49_37_0 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20241231'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = '20241231'
WHERE  p.pt<>''
AND     ( p.COL_2 LIKE '62%' OR p.COL_2 LIKE '42%' );




--结果表:
DROP TABLE IF EXISTS tmp_baoquan_SJ20250103761_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_baoquan_SJ20250103761_0603_02 AS
SELECT  distinct t1.剥离所属分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20241231
       ,t2.pd值_20241231
       ,t2.lgd值_20241231
       ,t2.风险成本_20241231
from tmp_baoquan_SJ20250103761_blrq_02 t1
left join tmp_baoquan_SJ20250103761_20241231_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;


--332412条，比表格中332415少3条数据
**01-数据需求_保全_2025_D0102_梁世鹏_分析存量数据清收对风险成本释放的影响_现需取相关业务数据剥离时点与12月末的风险成本数据.sql
-- 	---
-- SJ2025010376

-- 为分析存量数据清收对风险成本释放的影响，现需取相关业务数据剥离时点与12月末的风险成本数据。
--字段:本金余额-剥离日期、pd-剥离日期、lgd-剥离日期、风险成本-剥离日期	本金余额-20241231、pd-20241231、lgd-20241231、风险成本-20241231

-- 将后续adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD 都改成这个临时表COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

--临时表：COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD

SELECT * FROM COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD where DBIL_SRL_NO='20121026000792'

DROP TABLE IF EXISTS COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD PURGE ;
CREATE TABLE COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD AS
SELECT
    T1.DT
    ,T1.DBIL_SRL_NO
    ,T1.PRCP_BAL
    ,T1.PD_ORIG_VALUE
    ,T1.LGD_ORIG_VALUE
    ,T1.RSK_COST
  FROM adm_rsk.ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD T1   --风险集市信贷业务风险成本考核口径时点表
  WHERE T1.DT>='20231231' AND T1.DT<='20241231'
  AND NVL(T1.PROD_TYPE_CD,'') NOT LIKE '%垫款%'

  UNION ALL

  SELECT
    T2.DT
    ,T2.DBIL_SRL_NO
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1) AS PRCP_BAL
    ,T2.PD_START_VALUE AS PD_ORIG_VALUE
    ,CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END AS LGD_ORIG_VALUE
    ,T2.PRCP_BAL*NVL(T2.CNY_RATE,1)*T2.PD_START_VALUE*
    (CASE
     WHEN DFT_LABEL = 1 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.4931 --'LGD01'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(GRNT_MODE, '信用') = '信用'                                  THEN 0.5822 --'LGD06'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 100000 THEN 0.4493 --'LGD07'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 100000  THEN 0.5551 --'LGD08'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 6 AND NVL(REPAY_RATE, 0) > 0.2                                     THEN 0.2638 --'LGD09'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(GRNT_MODE, '信用') = '信用'                                 THEN 0.7576 --'LGD10'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.5778 --'LGD11'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.7196 --'LGD12'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 12 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.4152 --'LGD13'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) <= 50000 THEN 0.7516 --'LGD14'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) <= 0.2 AND NVL(CST_PRCP_BAL, 0) > 50000  THEN 0.8694 --'LGD15'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM <= 18 AND NVL(REPAY_RATE, 0) > 0.2                                    THEN 0.6047 --'LGD16'
     WHEN DFT_LABEL = 1 AND OVDR_MTH_TERM > 18                                                                  THEN 0.9129 --'LGD17'
     WHEN DFT_LABEL = 0 AND GRNT_MODE IN ( '抵押' , '质押' )                                                        THEN 0.2011 --'LGD18'
     WHEN DFT_LABEL = 0 AND NVL(GRNT_MODE, '信用') = '信用'                                                         THEN 0.4986 --'LGD23'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) <= 50000                  THEN 0.3932 --'LGD24'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) <= 1 AND NVL(CST_PRCP_BAL, 0) > 50000                   THEN 0.4849 --'LGD25'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) <= 100000                  THEN 0.3175 --'LGD26'
     WHEN DFT_LABEL = 0 AND NVL(VOUCH_PERSON_NUMBER, 0) > 1 AND NVL(CST_PRCP_BAL, 0) > 100000                   THEN 0.3989 --'LGD27'
     ELSE 0.50
    END) AS RSK_COST
  FROM
  (
    SELECT T1.DT,T1.DBIL_SRL_NO,T1.PRCP_BAL,T1.CNY_RATE,T1.PD_START_VALUE
    ,T1.GRNT_MODE
    ,T1.OVD_REPAY_RATE REPAY_RATE
    ,T1.CST_PRCP_BAL
    ,T1.VOUCH_PERSON_NUMBER
    ,CASE WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60) THEN 1 ELSE 0 END DFT_LABEL
    ,CASE
      WHEN T1.WTF_LABEL=1 OR (T1.PRCP_BAL>0 AND DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(DECODE(T1.DBIL_START_DATE, '18991231', NULL, T1.DBIL_START_DATE), 'YYYYMMDD'), 'DD')>60)
        THEN NVL(DATEDIFF(TO_DATE(T1.DT,'YYYYMMDD'),TO_DATE(T1.DBIL_START_DATE,'YYYYMMDD'),'DD'),0)/30
      ELSE 0
    END OVDR_MTH_TERM
    FROM ADM_RSK.ADM_RSK_APL_RSK_COST_CRDT_LOAN_DBIL_CHECK_RSK_COST_RSLT_DD T1  --风险成本-信贷借据风险成本计量口径结果表
    WHERE T1.DT>='20231231' AND T1.DT<='20241231'
    AND NVL(T1.PROD_TYPE_CD,'') LIKE '%垫款%'
  ) T2
;

---*******************全量业务***************************************************************************************

--剥离日期对应业务的本金余额、PD、LGD、风险成本；

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_blrq_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_blrq_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
LEFT JOIN   COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,p.COL_3 剥离日期
                 ,t.PRCP_BAL 本金余额_剥离日期
                 ,t.PD_ORIG_VALUE pd值_剥离日期
                 ,t.LGD_ORIG_VALUE lgd值_剥离日期
                 ,t.RSK_COST 风险成本_剥离日期
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd T1 ---信用卡账户信息汇总
ON      T1.late_main_card_card_nbr = P.COL_2 --卡号关联
AND     T1.dt = '20241231'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id = t.dbil_srl_no
AND     t.dt = p.COL_3
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
and     (p.COL_2  like '62%' OR p.COL_2 like '42%')
;

-- SELECT COUNT(1) FROM tmp_baoquan_SJ2024101161_blrq_02

-- 2024年12月31日的对应业务的本金余额、PD、LGD、风险成本；
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_20241231_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_20241231_02 AS
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20241231
                 ,t.PD_ORIG_VALUE pd值_20241231
                 ,t.LGD_ORIG_VALUE lgd值_20241231
                 ,t.RSK_COST 风险成本_20241231
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      p.COL_2 = t.dbil_srl_no
AND     t.dt = '20241231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
-- and     (p.COL_2 like '20%' or p.COL_2 like 'SXK%'or p.COL_2 like 'AD%' OR p.COL_2 like 'DB%')
and substr(p.COL_2,1,2) not in('62','42')
union all
SELECT  DISTINCT p.COL_1 剥离所属分行
                 ,p.COL_2 借据流水号_卡号
                 ,t.PRCP_BAL 本金余额_20241231
                 ,t.PD_ORIG_VALUE pd值_20241231
                 ,t.LGD_ORIG_VALUE lgd值_20241231
                 ,t.RSK_COST 风险成本_20241231
FROM    lab_bigdata_dev.qbi_file_20241012_15_38_48 p
left join  edw.dws_bus_crd_cr_crd_act_inf_dd T1    ---信用卡账户信息汇总
on T1.late_main_card_card_nbr=P.COL_2   --卡号关联
and T1.dt='20241231'
LEFT JOIN    COPY_ADM_RSK_APL_LOAN_BSN_RSK_COST_ASSM_CLB_TIME_NODE_DD t
ON      T1.cr_crd_act_id= t.dbil_srl_no
AND     t.dt = '20241231'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20241012_15_38_48')
and     (p.COL_2 like '62%' OR p.COL_2 like '42%')
;


--结果表:
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_0603_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_baoquan_SJ2024101161_0603_02 AS
SELECT  distinct t1.剥离所属分行
       ,t1.借据流水号_卡号
       ,t1.剥离日期
       ,t1.本金余额_剥离日期
       ,t1.pd值_剥离日期
       ,t1.lgd值_剥离日期
       ,t1.风险成本_剥离日期
       ,t2.本金余额_20241231
       ,t2.pd值_20241231
       ,t2.lgd值_20241231
       ,t2.风险成本_20241231
from lab_bigdata_dev.tmp_baoquan_SJ2024101161_blrq_02 t1
left join lab_bigdata_dev.tmp_baoquan_SJ2024101161_20241231_02 t2
ON t1.借据流水号_卡号=t2.借据流水号_卡号
;


SELECT * FROM tmp_baoquan_SJ2024101161_0603_02 WHERE 借据流水号_卡号='20121026000792'
**01-数据需求_保全_2025_D0107_张颖_信用卡客户催记.sql
-- SJ20250107121

-- 安永会计师事务所信用卡催记审计需求，需要2024年10月-11月我行全量的信用卡催收记录数据；

-- 截止2024年12月31日，取&ldquo;催收日期&rdquo;在2024年10月1日-2024年12月31日期间全量的信用卡的催收记录，系统界面见附件2张图
-- ；

-- 催收日期 、卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记机构、登记时间、催记渠道、状态、催收内容、外呼状态、电催结果、催收状态、催收结果；


SELECT * FROM tmp_xyk_cs_SJ20250107121


--28596条信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_SJ20250107121 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_SJ20250107121 AS
SELECT
        T1.col_1 As 提供卡号
        ,T2.coln_date    AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm      AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no  AS 催收人员编号行内
        ,T2.coln_user    AS 催收人员名称行内
        ,T2.out_person   AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_org_no 登记机构
        ,T2.input_date   AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        ,t2.coln_result  AS 催收内容
        ,T2.call_status  AS 外呼状态
        ,CASE
           WHEN t2.collect_status = '01' THEN '承诺还款'
           WHEN t2.collect_status = '02' THEN '谈判中'
           WHEN t2.collect_status = '05' THEN '其他'
           WHEN t2.collect_status = '03' THEN '转告还款'
           WHEN t2.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
        ,CASE
           WHEN T2.DC_THOGH_STATUS = '1'   THEN '无人接听'
           WHEN T2.DC_THOGH_STATUS = '100' THEN '未接通'
           WHEN T2.DC_THOGH_STATUS = '111' THEN '已告知，未明显表态，有效接通'
           WHEN T2.DC_THOGH_STATUS = '12'  THEN '已告知'
           WHEN T2.DC_THOGH_STATUS = '130' THEN '其他-请看催记备注'
           WHEN T2.DC_THOGH_STATUS = '131' THEN '否认消费（部分交易）'
           WHEN T2.DC_THOGH_STATUS = '132' THEN '否认消费（全部交易）'
           WHEN T2.DC_THOGH_STATUS = '134' THEN '拒绝还款，要投诉'
           WHEN T2.DC_THOGH_STATUS = '135' THEN '无还款能力'
           WHEN T2.DC_THOGH_STATUS = '136' THEN '其他-见催记备注'
           WHEN T2.DC_THOGH_STATUS = '137' THEN '失联'
           WHEN T2.DC_THOGH_STATUS = '138' THEN '生病'
           WHEN T2.DC_THOGH_STATUS = '139' THEN '涉刑'
           WHEN T2.DC_THOGH_STATUS = '140' THEN '欺诈情况'
           WHEN T2.DC_THOGH_STATUS = '141' THEN '反催特点'
           WHEN T2.DC_THOGH_STATUS = '142' THEN '死亡'
           WHEN T2.DC_THOGH_STATUS = '143' THEN '移交专家'
           WHEN T2.DC_THOGH_STATUS = '144' THEN '其他-详见催记备注'
           WHEN T2.DC_THOGH_STATUS = '145' THEN '分期'
           WHEN T2.DC_THOGH_STATUS = '146' THEN '减免'
           WHEN T2.DC_THOGH_STATUS = '147' THEN 'ZXT/ZD'
           WHEN T2.DC_THOGH_STATUS = '149' THEN '他人代偿（需登记关系）'
           WHEN T2.DC_THOGH_STATUS = '150' THEN '承诺一次性还款'
           WHEN T2.DC_THOGH_STATUS = '160' THEN '要求短分期（小于等于24期）'
           WHEN T2.DC_THOGH_STATUS = '161' THEN '要求长分期（大于24期）'
           WHEN T2.DC_THOGH_STATUS = '162' THEN '要求全额减免利息'
           WHEN T2.DC_THOGH_STATUS = '163' THEN '已承诺减免'
           WHEN T2.DC_THOGH_STATUS = '165' THEN '话务条异常'
           WHEN T2.DC_THOGH_STATUS = '168' THEN '空号/停机'
           WHEN T2.DC_THOGH_STATUS = '17'  THEN '通话中全部归还'
           WHEN T2.DC_THOGH_STATUS = '2'   THEN '拒接'
           WHEN T2.DC_THOGH_STATUS = '3'   THEN '忙音'
           WHEN T2.DC_THOGH_STATUS = '4'   THEN '错号'
           WHEN T2.DC_THOGH_STATUS = '5'   THEN '空号'
           WHEN T2.DC_THOGH_STATUS = '6'   THEN '停机'
           WHEN T2.DC_THOGH_STATUS = '7'   THEN '关机'
           WHEN T2.DC_THOGH_STATUS = '8'   THEN '呼叫限制'
           WHEN T2.DC_THOGH_STATUS = '9'   THEN '话务条异常'
           ELSE ''
         END             AS 电催结果
FROM    lab_bigdata_dev.qbi_file_20250107_15_59_27_0 T1 --导入数据
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.col_1 = T2.cont_card_no
and T2.dt='20241231'
and T2.coln_date BETWEEN '2024-10-01 00:00:00' AND '2024-11-30 23:59:00'
where  T1.pt<>''
;
**01-数据需求_保全_2025_D0114_吴伟_对2024年末全量未鉴损业务_判断其中小企业和涉农贷款.sql
-- SJ2025011426
-- 针对2024年末全量未鉴损业务，判断其中小企业和涉农贷款性质；
-- 数据日期：20240113；
-- 数据范围：分行。
--字段：类型	合同号	借据号/信用卡号	是否农户	是否对公贷款	&quot;最近年销售额&quot;	&quot;最近年净利润&quot;


--1，补齐合同号,导入的合同号无法使用,155258条数据


DROP TABLE IF EXISTS tmp_hexiaojiansun_SJ202501142601 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hexiaojiansun_SJ202501142601 AS
SELECT  col_1                                   AS 类型
        ,COALESCE(t0.cst_id, t1.cst_id)         AS cst_id
        ,coalesce(t0.bus_ctr_id, t1.busi_ctr_id) AS 合同号
        ,col_3                                  AS 借据或信用卡卡号
FROM    qbi_file_20250114_14_30_41_0 t
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd t0 --贷款借据信息汇总
ON      t.col_3 = t0.dbil_id
AND     t0.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd t1 --信用卡卡片信息
ON      col_3 = t1.cr_crd_card_nbr
AND     t1.dt = '@@{yyyyMMdd}'
WHERE   t.pt <> '';



--2,取是否农户	是否对公贷款	&quot;最近年销售额&quot;	&quot;最近年净利润&quot;


DROP TABLE IF EXISTS tmp_hexiaojiansun_SJ2025011426_f PURGE;

CREATE TABLE IF NOT EXISTS tmp_hexiaojiansun_SJ2025011426_f AS
SELECT  DISTINCT
        a.类型                                        AS 类型
        ,a.cst_id                                   AS 客户号
        ,a.合同号                                      AS 合同号
        ,a.借据或信用卡卡号                                 AS 借据或信用卡卡号
        ,COALESCE(ci.psnt_hsd_ind, cc.psnt_hsd_ind) AS 农户标识
        ,CASE
           WHEN COALESCE(ci.psnt_hsd_ind, cc.psnt_hsd_ind) = 1 THEN '是'
           ELSE '否'
         END                                        AS 是否农户
        ,CASE
           WHEN T11.ctr_serno IS NOT NULL THEN '是'
           ELSE '否'
         END                                        AS 是否对公贷款
        ,sa.bgn_dt                                  AS 开始日期
        ,sa.end_dt                                  AS 结束日期
        ,sa.sal_amt                                 AS 销售额
        ,sa.npft                                    AS 净利润
FROM    tmp_hexiaojiansun_SJ202501142601 a
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T11 --合同基础信息
ON      a.合同号 = T11.ctr_serno
AND     T11.dt = '@@{yyyyMMdd}'
AND     T11.prd_no LIKE '1001%' --对公贷款
LEFT JOIN    edw.loan_cst_indiv_ind ci --个人客户标识信息
ON      a.cst_id = ci.cst_id
AND     CI.cst_id <> ''
AND     ci.dt = '@@{yyyyMMdd}'
AND     ci.del_ind = '0'
LEFT JOIN    edw.loan_cst_corp_ind cc --企业客户标识信息
ON      a.cst_id = cc.cst_id
AND     cc.cst_id <> ''
AND     cc.dt = '@@{yyyyMMdd}'
AND     cc.del_ind = '0'
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,t.bgn_dt
                         ,t.end_dt
                         ,t.sal_amt --销售额
                         ,t.npft --净利润
                         ,t.sys_reg_tm
                         ,ROW_NUMBER() OVER ( PARTITION BY t.cst_id ORDER BY sys_reg_tm DESC ) AS rn
                 FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd t --信贷客户经营信息销售额及净利润信息
                 WHERE   t.dt = '@@{yyyyMMdd}'
             ) sa
ON      a.cst_id = sa.cst_id
AND     sa.rn = 1;
**01-数据需求_保全_2025_D0121_吴伟_国税鉴损使用.sql
-- SJ2025012121
-- 1、随贷通取发放金额及余额明细查询
-- 取数口径：柜面系统5112；数据日期：2024年12月31日；数据范围：见附件的sheet1，随贷通业务清单。
-- 2、、随贷通取发放及还款明细
-- 取数口径：柜面系统5116；数据日期：2024年12月31日；数据范围：见附件sheet1，随贷通业务清单。
-- 3、贷款发放及还款明细
-- 取数口径：信贷系统；数据日期：2024年12月31日；数据范围：见附件的sheet2，贷款业务清单


-- 字段：
-- 1、随贷通发放金额及余额明细查询
-- 随贷通卡号、借据流水号、借款日期、贷款状态、贷款总利息、贷款金额、贷款到期日、当前利率、贷款余额、贷款欠息、贷款利息罚息、贷款本金罚息。

-- DROP TABLE if EXISTS tmp_sdt_SJ2025012121_5112_01 PURGE ;
-- CREATE TABLE IF NOT EXISTS tmp_sdt_SJ2025012121_5112_01 as
-- SELECT col_1 as 类型
--        ,col_2 as 合同号
--        ,col_3 as 借据号或信用卡号
--        ,col_4 as 是否随贷通
-- FROM qbi_file_20250121_17_33_48_0   --随贷通导入数据
-- WHERE pt<>''
-- ;

---是否未结清，如果要筛的话加一个klna_Dkzhzb的贷款账户状态不为1;

-- 一、随贷通（未结清借据）发放金额及余额明细查询  --5112
-- 随贷通卡号、借据流水号、借款日期、贷款状态、贷款总利息、贷款金额、贷款到期日、当前利率、贷款余额、贷款欠息、贷款利息罚息、贷款本金罚息。

--94061条数据



DROP TABLE IF EXISTS tmp_sdt_fhkmx_SJ20241231126_5112  purge;
CREATE TABLE IF NOT EXISTS tmp_sdt_fhkmx_SJ20241231126_5112 as
SELECT
         a.类型
         ,a.合同号
         ,a.借据号或信用卡号
         ,a.是否随贷通
        -- ,zb.hetongbh                                          AS 合同编号
        -- ,zb.dkjiejuh                                         AS 贷款借据号
        ,zb.Kaihriqi                                         AS 开户日期
        ,zb.qixiriqi                                         AS 起息日期
        ,zb.jiejuuje                                         AS 借据金额
        ,zb.hetongje                                         AS 合同金额
        ,zb.kffangje                                         AS 可发放金额
        ,zb.DKQIXIAN                                         AS 贷款期限_月
        ,zb.Daoqriqi                                         AS 到期日期
        ,case
          when zb.dkzhhzht='0' then '正常'
	  when zb.dkzhhzht='1'	then '销户'
	  when zb.dkzhhzht='2'	then '已核销'
	  when zb.dkzhhzht='3'	then '准销户'
	  when zb.dkzhhzht='4'	then '录入'
	  when zb.dkzhhzht='5'	then '已减免'
        end AS 贷款账户状态    ---1为结清
        ,zb.kehmingc                                         AS 客户名称
        ,zb.kehuhaoo                                         AS 客户号
        ,zb.zhngjigo                                         AS 账务机构
        ,zb.chanpmch                                         AS 产品名称
        ,zb.huobdhao                                     AS 货币代号
        ,zb.xiaohurq                                         AS 销户日期
        ,zb.dkzhangh                                         AS 贷款账号
        -- ,decode(zb.ziczhtai,'0','不适用','1','正常','2','转让','3','证券化','4','化债','5','核销')   AS 资产状态  0--不适用 1--正常 2--转让  3--证券化 4--化债 5--核销
        -- ,case when zb.ziczhtai='0' then '不适用'
        -- when zb.ziczhtai='1' then '正常'
        -- when zb.ziczhtai='2' then '转让'
        -- when zb.ziczhtai='3' then '证券化'
        -- when zb.ziczhtai='4' then '化债'
        -- when zb.ziczhtai='5' then '核销'
        -- end as 资产状态
        ,nvl(jx.zhchlilv,0) as 正常利率
        -- ,nvl(trim(to_char(jx.zhchlilv, '99990.9999999')), 0) AS 正常利率
        ,sum(nvl(zb.fafangje, 0))                            AS 已发放金额
        ,sum(nvl(zb.zhchbjin, 0))                            AS 正常本金
        ,sum(nvl(zb.yuqibjin, 0))                            AS 逾期本金
        ,sum(nvl(zb.dzhibjin, 0))                            AS 呆滞本金
        ,sum(nvl(zb.daizbjin, 0))                            AS 呆账本金
        ,sum(nvl(zb.ysyjlixi, 0))                            AS 应收应计利息
        ,sum(nvl(zb.csyjlixi, 0))                            AS 催收应计利息
        ,sum(nvl(zb.ysqianxi, 0))                            AS 应收欠息
        ,sum(nvl(zb.csqianxi, 0))                            AS 催收欠息
        ,sum(nvl(zb.ysyjfaxi, 0))                            AS 应收应计罚息
        ,sum(nvl(zb.csyjfaxi, 0))                            AS 催收应计罚息
        ,sum(nvl(zb.yshofaxi, 0))                            AS 应收罚息
        ,sum(nvl(zb.cshofaxi, 0))                            AS 催收罚息
        ,sum(nvl(zb.yingjifx, 0))                            AS 应计复息
        ,sum(nvl(zb.fuxiiiii, 0))                            AS 复息
        ,sum(nvl(zb.dianshje, 0))                            AS 垫税金额
        ,sum(nvl(zb.hexiaobj, 0))                            AS 核销本金
        ,sum(nvl(zb.hexiaolx, 0))                            AS 核销利息
        ,sum(nvl(zb.yihxbjlx, 0))                            AS 已核销本金利息
FROM    tmp_sdt_SJ2025012121_5112_01 a
LEFT JOIN    edw.core_klna_dkzhzb zb --贷款账户主表
ON      a.借据号或信用卡号 = zb.dkjiejuh
AND     zb.dt = '20241231'
-- LEFT JOIN    edw.core_klnb_dkjcsx jc --贷款账户基础表
-- ON      zb.dkjiejuh = jc.dkjiejuh
-- AND     jc.dt = '20241231'
-- LEFT JOIN    edw.core_kclb_dkedjj jj --贷款额度借据主表
-- ON      zb.dkjiejuh = jj.jiejuhao
-- AND     jj.dt = '20241231'
LEFT JOIN    edw.core_klnb_dkjxsx jx --贷款账户计息表
ON      zb.dkjiejuh = jx.dkjiejuh
AND     jx.dt = '20241231'
-- WHERE   zb.qixiriqi BETWEEN '20190101' AND '20241231'
GROUP BY  a.类型
         ,a.合同号
         ,a.借据号或信用卡号
         ,a.是否随贷通,zb.dkjiejuh , zb.Kaihriqi  ,zb.qixiriqi,zb.jiejuuje,zb.hetongje ,zb.kffangje,zb.dkzhangh, zb.DKQIXIAN , zb.Daoqriqi , zb.zhngjigo , zb.chanpmch , zb.huobdhao, jx.zhchlilv , zb.shijchuo , zb.kehmingc , zb.kehuhaoo , zb.xiaohurq , zb.hetongbh
         ,case when zb.dkzhhzht='0'	then '正常'
	  when zb.dkzhhzht='1'	then '销户'
	  when zb.dkzhhzht='2'	then '已核销'
	  when zb.dkzhhzht='3'	then '准销户'
	  when zb.dkzhhzht='4'	then '录入'
	  when zb.dkzhhzht='5'	then '已减免'
        end
;


-- 2、随贷通还款及发放明细
-- 合同号、借据流水号、客户姓名明细编号、贷款账号、营业机构、原交易日期、贷款入账账号、贷款入账账户序号放款金额放款资金处理方式待销账序号冻结编号正常本金逾期本金呆滞本金呆账本金
-- 资金来源还款账号还款账户序号可用金额还款总额还款状态归还本金归还应收应计利息归还催收应计利息归还应收欠息归还催收欠息归还应收应计罚息归还催收应计罚息归还应收罚息归还催收罚息归还应计复息归还复息归还罚金
-- 归还费用原交易机构原交易柜员原服务处理流水号交易事件类型事件说明交易码摘要贷款归还方式还款备注维护日期维护时间。


DROP TABLE IF EXISTS tmp_sdt_fhkmx_SJ20241231126_5116  purge;
CREATE TABLE IF NOT EXISTS tmp_sdt_fhkmx_SJ20241231126_5116 as
SELECT   a.类型
         ,a.合同号
         ,a.借据号或信用卡号
         ,a.是否随贷通
        ,jj.kehuhaoo 客户号
        ,jj.kehuzwmc 客户名
        ,jj.kehuzhao 客户账号
        ,mx.mingxibh 明细编号
        ,mx.dkzhangh 贷款账号
        ,mx.huobdhao 货币代号
        ,mx.yngyjigo 营业机构
        ,mx.jiaoyirq 交易日期
        ,mx.dkrzhzhh 贷款入账账号
        ,mx.dkrzhzxh 贷款入账账号子序号
        ,mx.fkjineee 放款金额
        ,mx.fkzjclfs 放款资金处理方式
        ,mx.daixzhxh 待销账序号
        ,mx.djiebhao 冻结编号
        ,mx.zhchbjin 正常本金
        ,mx.yuqibjin 逾期本金
        ,mx.dzhibjin 呆滞本金
        ,mx.daizbjin 呆账本金
        ,mx.zijnlaiy 资金来源
        ,mx.huankzhh 还款账号
        ,mx.hkzhhzxh 还款账号子序号
        ,mx.keyongje 可用金额
        ,mx.hkzongee 还款总额
        ,mx.huankzht 还款状态   --1--提前还款 2--正常还款 3--逾期还款
        ,mx.ghbenjin 归还本金
        ,mx.ghysyjlx 归还应收应计利息
        ,mx.ghcsyjlx 归还催收应计利息
        ,mx.ghynshqx 归还应收欠息
        ,mx.ghcushqx 归还催收欠息
        ,mx.ghysyjfx 归还应收应计罚息
        ,mx.ghcsyjfx 归还催收应计罚息
        ,mx.ghynshfx 归还应收罚息
        ,mx.ghcushfx 归还催收罚息
        ,mx.ghyjfuxi 归还应计复息
        ,mx.ghfxfuxi 归还复息
        ,mx.ghfajinn 归还罚金
        ,mx.ghfeiyin 归还费用
        ,mx.jiaoyijg 交易机构
        ,mx.jiaoyigy 交易柜员
        ,mx.jiaoyils 交易流水
        ,mx.jiaoyisj 交易事件
        ,mx.shjshuom 事件说明
        ,mx.jiaoyima 交易码
        ,mx.zhaiyoms 摘要
        ,mx.daikghfs 贷款归还方式
        ,mx.hkbeizhu 还款备注
        ,mx.weihguiy 维护柜员
        ,mx.weihjigo 维护机构
        ,mx.weihriqi 维护日期
        ,mx.weihshij 维护时间
FROM  tmp_sdt_SJ2025012121_5112_01 a
LEFT JOIN    edw.core_kclb_dkedjj jj --贷款额度借据主表,全量表
ON      a.借据号或信用卡号 = jj.jiejuhao
AND     jj.dt = '20241231'
LEFT JOIN    edw.core_klnl_dkkhmx mx --贷款客户账户交易明细表，增量表,20130913
ON      jj.jiejuhao = mx.dkjiejuh
AND     mx.dt <= '20241231'
and     mx.dt>='20130913'
WHERE   mx.jiaoyirq >= '20130913'
AND     mx.jiaoyirq <= '20241231'
;


-- 3、贷款（非随贷通）发放及还款明细
-- 序号 台帐类型 发放类型 流水号 借据流水号 关联合同流水号 管户人 管户机构 客户编号 客户名称 业务品种 发放金额 回收金额(元) 发生类型 交易描述 账务发生机构号 账务发生机构 账务发生日期 渠道

--导入的清单
-- DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_01 PURGE  ;

-- CREATE TABLE tmp_daikuang_SJ2025012121_01 AS
-- SELECT col_1 as 类型
--        ,col_2 as 合同号
--        ，col_3 as 借据号或卡号
-- FROM qbi_file_20250122_10_10_20_0
-- WHERE pt<>'';

--有3840641条数据
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff;

CREATE TABLE tmp_daikuang_SJ2025012121_ff AS
SELECT  t0.类型
        ,t0.合同号
        ,t0.借据号或卡号
        -- ,t1.sourceno		来源编号
        ,t1.srl_nbr 信息流水号
        ,CASE
           WHEN t1.hpn_dir = '0' THEN '发放'
           ELSE '回收'
         END 台账类型
        ,t1.actl_dbt_amt 发放金额
        ,t1.actl_crd_amt 回收金额
        ,t3.mgr_org_id 管护机构编号
        ,t3.mgr_id 管户客户经理编号
        ,t3.mgr_nm 管户客户经理
        ,t2.cst_id 客户号
        ,t2.cst_nm 客户名称
        ,t2.prd_no 产品代码
        ,t4.pd_nm 业务品种
        ,t1.org_id 机构号
        ,t1.hpn_dt 发生日期
        ,t1.hpn_typ 发生类型
        ,t1.trx_dscr 交易描述
        ,t1.trx_evt 交易事件
        -- ,t2.chnl_cd 渠道代码
FROM   tmp_daikuang_SJ2025012121_01 t0
LEFT JOIN    edw.DWD_BUS_LOAN_BUS_SRL_DTL_DI t1 --业务流水明细
ON      t1.dt <= '20241231'
AND     t1.dbil_id = t0.借据号或卡号
LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd t2
ON      t2.dbil_id = t0.借据号或卡号
AND     t2.dt = '20241231'
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd t3  --信贷合同管护
ON      t2.ctr_serno = t3.ctr_serno
AND     t3.dt = '20241231'
left join edw.dim_bus_loan_prd_frml_dd  t4
on t2.prd_no=t4.prd_no
and t4.dt='20241231'
;


--
--拆分后的结果表
-- tmp_daikuang_SJ2025012121_ff_3101_3202       466391
-- tmp_daikuang_SJ2025012121_ff_3301            436855
-- tmp_daikuang_SJ2025012121_ff_3302            380258
-- tmp_daikuang_SJ2025012121_ff_3303_3305       364578
-- tmp_daikuang_SJ2025012121_ff_3306_3307       342920


-- tmp_daikuang_SJ2025012121_ff_3308_3309_3310  488622
-- tmp_daikuang_SJ2025012121_ff_3311_3312       275366
-- tmp_daikuang_SJ2025012121_ff_CH              93645
-- tmp_daikuang_SJ2025012121_ff_9900_9926       62901
-- tmp_daikuang_SJ2025012121_ff_9915            929105



--3101_3202 ： 466391
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3101_3202;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3101_3202 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3101','3202' )
;


SELECT * FROM tmp_daikuang_SJ2025012121_ff_3101_3202


--3301 ：436855
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3301;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3301 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) ='3301'
;


--3302 ：380258
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3302;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3302 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) ='3302'
;


-- 3303_3305  : 364578
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3303_3305;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3303_3305 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3303','3305' )
;



SELECT * FROM tmp_daikuang_SJ2025012121_ff_3303_3305

-- 3306_3307  : 342920
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3306_3307;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3306_3307 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3306','3307' )
;



-- 3308_3309_3310  : 488622
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3308_3309_3310;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3308_3309_3310 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3308','3309','3310' )
;


-- 3311_3312: 275366
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3311_3312;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3311_3312 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3311','3312' )
;



--村行: ('3361','3561' ,'3562','3563','3564','4161','4162','4261','4461','4462','6161','6162','6163') : 93645
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_CH;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_CH AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3361','3561' ,'3562','3563','3564','4161','4162','4261','4461','4462','6161','6162','6163')
;



--9900，9926: 62901
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_9900_9926;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_9900_9926 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('9900','9926' )
;


--9915:  929105
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_9915;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_9915 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('9915' )
;


---补3101上海和3303宁波
DROP TABLE IF EXISTS tmp_daikuang_SJ2025012121_ff_3101_3303;

CREATE TABLE tmp_daikuang_SJ2025012121_ff_3101_3303 AS
SELECT
    *
FROM tmp_daikuang_SJ2025012121_ff
WHERE SUBSTR(管护机构编号,1,4) in ('3101','3303' )
;

SELECT * FROM tmp_daikuang_SJ2025012121_ff_3101_3303



-- _c0	_c1
-- 3101	197361
-- 3202	269030
-- 3301	436855
-- 3302	380258
-- 3303	288122
-- 3305	76456
-- 3306	303526
-- 3307	39394
-- 3308	229962
-- 3309	167330
-- 3310	91330
-- 3311	222847
-- 3312	52519
-- 3361	2538
-- 3561	11747
-- 3562	13322
-- 3563	1578
-- 3564	6926
-- 4161	1369
-- 4162	639
-- 4261	32621
-- 4461	11054
-- 4462	3687
-- 6161	5143
-- 6162	330
-- 6163	2691
-- 9900	32649
-- 9915	929105
-- 9926	30252
**01-数据需求_保全_2025_D0205_张颖_信用卡客户催记.sql
--
-- SJ2025012441
-- 调取逾期信用卡催记，用于信用卡鉴损
-- 截止取数时的最新时间，调取附件清单卡号的全量保全系统催收痕迹
--
-- 催收日期、合同号/卡号、客户名称、客户编号、催收对象、催收对象名称、催收方式、内部催收人员、外部催收人员、登记人、登记时间、催记渠道、催收内容、催收结果

--291972条数据
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_SJ2025012441 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_SJ2025012441 AS
SELECT
        T1.col_1 As 提供卡号
        ,T2.coln_date    AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm      AS 客户名称
        ,T2.cust_no      As 客户编号
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no  AS 催收人员编号行内
        ,T2.coln_user    AS 催收人员名称行内
        ,T2.out_person   AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_org_no 登记机构
        ,T2.input_date   AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        ,t2.coln_result  AS 催收内容
        ,T2.call_status  AS 外呼状态
        ,CASE
           WHEN t2.collect_status = '01' THEN '承诺还款'
           WHEN t2.collect_status = '02' THEN '谈判中'
           WHEN t2.collect_status = '05' THEN '其他'
           WHEN t2.collect_status = '03' THEN '转告还款'
           WHEN t2.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
        ,CASE
           WHEN T2.DC_THOGH_STATUS = '1'   THEN '无人接听'
           WHEN T2.DC_THOGH_STATUS = '100' THEN '未接通'
           WHEN T2.DC_THOGH_STATUS = '111' THEN '已告知，未明显表态，有效接通'
           WHEN T2.DC_THOGH_STATUS = '12'  THEN '已告知'
           WHEN T2.DC_THOGH_STATUS = '130' THEN '其他-请看催记备注'
           WHEN T2.DC_THOGH_STATUS = '131' THEN '否认消费（部分交易）'
           WHEN T2.DC_THOGH_STATUS = '132' THEN '否认消费（全部交易）'
           WHEN T2.DC_THOGH_STATUS = '134' THEN '拒绝还款，要投诉'
           WHEN T2.DC_THOGH_STATUS = '135' THEN '无还款能力'
           WHEN T2.DC_THOGH_STATUS = '136' THEN '其他-见催记备注'
           WHEN T2.DC_THOGH_STATUS = '137' THEN '失联'
           WHEN T2.DC_THOGH_STATUS = '138' THEN '生病'
           WHEN T2.DC_THOGH_STATUS = '139' THEN '涉刑'
           WHEN T2.DC_THOGH_STATUS = '140' THEN '欺诈情况'
           WHEN T2.DC_THOGH_STATUS = '141' THEN '反催特点'
           WHEN T2.DC_THOGH_STATUS = '142' THEN '死亡'
           WHEN T2.DC_THOGH_STATUS = '143' THEN '移交专家'
           WHEN T2.DC_THOGH_STATUS = '144' THEN '其他-详见催记备注'
           WHEN T2.DC_THOGH_STATUS = '145' THEN '分期'
           WHEN T2.DC_THOGH_STATUS = '146' THEN '减免'
           WHEN T2.DC_THOGH_STATUS = '147' THEN 'ZXT/ZD'
           WHEN T2.DC_THOGH_STATUS = '149' THEN '他人代偿（需登记关系）'
           WHEN T2.DC_THOGH_STATUS = '150' THEN '承诺一次性还款'
           WHEN T2.DC_THOGH_STATUS = '160' THEN '要求短分期（小于等于24期）'
           WHEN T2.DC_THOGH_STATUS = '161' THEN '要求长分期（大于24期）'
           WHEN T2.DC_THOGH_STATUS = '162' THEN '要求全额减免利息'
           WHEN T2.DC_THOGH_STATUS = '163' THEN '已承诺减免'
           WHEN T2.DC_THOGH_STATUS = '165' THEN '话务条异常'
           WHEN T2.DC_THOGH_STATUS = '168' THEN '空号/停机'
           WHEN T2.DC_THOGH_STATUS = '17'  THEN '通话中全部归还'
           WHEN T2.DC_THOGH_STATUS = '2'   THEN '拒接'
           WHEN T2.DC_THOGH_STATUS = '3'   THEN '忙音'
           WHEN T2.DC_THOGH_STATUS = '4'   THEN '错号'
           WHEN T2.DC_THOGH_STATUS = '5'   THEN '空号'
           WHEN T2.DC_THOGH_STATUS = '6'   THEN '停机'
           WHEN T2.DC_THOGH_STATUS = '7'   THEN '关机'
           WHEN T2.DC_THOGH_STATUS = '8'   THEN '呼叫限制'
           WHEN T2.DC_THOGH_STATUS = '9'   THEN '话务条异常'
           ELSE ''
         END             AS 电催结果
FROM    lab_bigdata_dev.qbi_file_20250205_11_02_25_0 T1 --导入数据
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.col_1 = T2.cont_card_no
and T2.dt='@@{yyyyMMdd}'
-- and T2.coln_date BETWEEN '2022-01-01 00:00:00' AND '2024-12-31 23:59:00'
where  T1.pt<>''
ORDER BY T2.coln_date DESC
;
**01-数据需求_保全_2025_D0205_逾期信用卡交易明细_用于信用卡鉴损.sql
-- SJ2025012422

-- 截止取数时的最新时间，调取附件清单卡号按信用卡账号维度调取信用卡自2000年1月1日至2024年12月31日期间发生的全量交易明细
-- 卡号、姓名、交易日期、交易时间、交易类型描述、交易金额、交易币种、入账时间（参考3103报表字段）

--导入的数据清单：qbi_file_20250205_11_02_25_0  --7729


-- 查询报表信息  -- 报表管理平台：3103信用卡交易明细(资保) 童林斌
-- 卡号 交易日期	交易时间	交易类型描述	交易金额	交易币种	撤销、冲正标志	入帐日期



--2376763条数据
DROP TABLE IF EXISTS tmp_fa_data_query_SJ2025012422 PURGE;

CREATE TABLE IF NOT EXISTS tmp_fa_data_query_SJ2025012422 AS
SELECT  a0.col_1       AS 信用卡卡号
       ,a0.col_2  as 机构号前4位
       ,a0.col_3  as 管护分行
    --    ,a1.cr_crd_act_id as 信用卡账号
        -- ,a2.cst_nm       AS 姓名
        -- ,a2.doc_id       AS 证件号
        ,a1.trx_dt       AS 交易日期
        ,a1.trx_tm       AS 交易时间
        ,a1.trx_typ_dscr AS 交易类型描述
        ,a1.trx_amt      AS 交易金额
        ,a1.trx_ccy_cd   AS 交易币种
        ,a1.wdw_rvs_ind  AS 撤销冲正标志
        ,a1.act_dt       AS 入帐日期
FROM    (
            SELECT col_1,col_2,col_3
            FROM    qbi_file_20250205_14_41_23_0
            WHERE   pt <> ''
        ) a0
LEFT JOIN    edw.dwd_bus_crd_cr_crd_trx_dtl_di a1 ---信用卡客户交易流水
ON      a0.col_1 = a1.cr_crd_card_nbr
AND     a1.dt BETWEEN '20000101' AND '20241231'
-- INNER JOIN    app_rpt.FCT_CR_CRD_MGT_INF a2 --信用卡报表权限
-- ON      a1.cr_crd_card_nbr = a2.main_crd_no
-- AND     a2.dt = '20241231'
order by a1.cr_crd_act_id
;


--589587,3301--台州分行
DROP TABLE if EXISTS tmp_fa_data_query_SJ2025012422_3301 purge;
CREATE TABLE IF NOT EXISTS tmp_fa_data_query_SJ2025012422_3301 as
SELECT * FROM tmp_fa_data_query_SJ2025012422 WHERE 机构号前4位='3301';


--488625，3308-3306

DROP TABLE if EXISTS tmp_fa_data_query_SJ2025012422_3306_3308 purge;
CREATE TABLE IF NOT EXISTS tmp_fa_data_query_SJ2025012422_3306_3308 as
SELECT * FROM tmp_fa_data_query_SJ2025012422 WHERE 机构号前4位 in ('3306','3308');

--673939,3303,3101,3302,3305
DROP TABLE if EXISTS tmp_fa_data_query_SJ2025012422_3303_3305 purge;
CREATE TABLE IF NOT EXISTS tmp_fa_data_query_SJ2025012422_3303_3305 as
SELECT * FROM tmp_fa_data_query_SJ2025012422 WHERE 机构号前4位 in ('3303','3101','3302','3305');


--624612，3311,9906,3309,3307,9911,3202,3310,3312,9900,9945,9926,9999
DROP TABLE if EXISTS tmp_fa_data_query_SJ2025012422_3311_9999 purge;
CREATE TABLE IF NOT EXISTS tmp_fa_data_query_SJ2025012422_3311_9999 as
SELECT * FROM tmp_fa_data_query_SJ2025012422 WHERE 机构号前4位 in ('3311','9906','3309','3307','9911','3202','3310','3312','9900','9945','9926','9999');




-- --*****以下为按照账号查询
-- -- 按账户号匹配

-- select count(1) from tmp_fa_query_sample_20240103_2;  -- 6099


-- drop table if exists tmp_fa_data_query_20240103_2 purge;

-- create table IF NOT EXISTS tmp_fa_data_query_20240103_2 as
-- SELECT a0.cr_crd_act_id       AS 账户号
--     ,a1.cr_crd_card_nbr  AS 卡号
--     ,a2.cst_nm          AS 姓名
--     ,a2.doc_id          as 证件号
--     ,a1.trx_dt          AS 交易日期
--     ,a1.trx_tm          AS 交易时间
--     ,a1.trx_typ_dscr   AS 交易类型描述
--     ,a1.trx_amt        AS  交易金额
--     ,a1.trx_ccy_cd           AS 交易币种
--     ,a1.wdw_rvs_ind          AS 撤销冲正标志
--     ,a1.act_dt              AS 入帐日期
-- FROM (select distinct cr_crd_act_id from tmp_fa_query_sample_20240103_2) a0
-- left join edw.dwd_bus_crd_cr_crd_trx_dtl_di a1
-- on a0.cr_crd_act_id = a1.cr_crd_act_id
-- and a1.dt between '20100101' and '20231231'
-- inner join app_rpt.FCT_CR_CRD_MGT_INF a2
-- on a1.cr_crd_card_nbr = a2.main_crd_no
-- and a2.dt = '20231231'
-- ;


-- drop table if exists tmp_fa_data_query_20240103_1 purge;
-- create table IF NOT EXISTS tmp_fa_data_query_20240103_1 as
-- select 卡号, rank() over(order by 卡号) rnk
-- from (
--     select distinct 卡号
--     from tmp_fa_data_query_20240103_2
-- ) a1
-- ;

-- -- part1
-- drop table if exists tmp_fa_data_query_20240103_2_p1 purge;
-- create table IF NOT EXISTS tmp_fa_data_query_20240103_2_p1 as
-- select a1.*
-- from tmp_fa_data_query_20240103_2 a1
-- where a1.卡号 in (
--     select 卡号 from tmp_fa_data_query_20240103_1 where rnk <= 3100
-- )
-- ;
-- -- part2
-- drop table if exists tmp_fa_data_query_20240103_2_p2 purge;
-- create table IF NOT EXISTS tmp_fa_data_query_20240103_2_p2 as
-- select a1.*
-- from tmp_fa_data_query_20240103_2 a1
-- where a1.卡号 in (
--     select 卡号 from tmp_fa_data_query_20240103_1 where rnk > 3100
-- )
-- ;

-- -- 一个账户对应多张卡排查

-- select distinct 账户号, concat('bc',卡号)
-- from tmp_fa_data_query_20240103_2
-- where 账户号 in (
--     select 账户号
--     from tmp_fa_data_query_20240103_2
--     group by 账户号
--     having count(distinct 卡号) > 1
-- )
-- ;
**01-数据需求_保全_2025_D0317_上海分行_颜利娟_信用卡交易明细_对客查询_.sql
-- SJ2025031731
-- 1.客户号：1605903490，客户名称：温杨，信用卡号：6222876200006312，信用卡交易明细，包含具体消费商户名称，消费地点，数据日期：2021年03月05日-2025年03月17日，上海分行温杨信用卡数据。
-- 2.客户号：1036196897，客户名称：张锐，信用卡号：6222876200008813，信用卡交易明细，包含具体消费商户名称，消费地点，数据日期：2021年03年27日-2025年03月17日，上海分行张锐信用卡数据。
-- 信用卡交易明细，包含具体消费商户名称，消费地点

SELECT cr_crd_act_id 信用卡账号
        ,cr_crd_card_nbr 信用卡卡号
        -- ,srl_nbr 流水号
        ,t1.cst_id 客户号
        ,t1.cst_nm 客户名称
        -- ,trx_typ_cd 交易类型代码
        ,trx_typ_dscr 交易类型描述
        ,trx_ccy_cd 交易币种代码
        ,trx_amt 交易金额
        ,mch_typ 商户类型
        ,mch_cd 商户代码
        ,tmn_id_no 受卡机终端标识码
        ,idx_ref 检索参考号
        ,aut_rsp_no 授权应答码
        ,trx_dt 交易日期
        ,trx_tm 交易时间
        ,act_dt 入帐日期
        ,clr_dt 清算日期
        ,wdw_rvs_ind 撤销冲正标志
        ,trx_brn 交易网点
        ,trx_tlr 交易柜员
        ,mon_id 月份编号
        ,ini_amt 原始金额
        ,ini_ccy_cd 原始币种代码
        ,trx_src 交易来源
        ,acc_id_no 受理方标识码
        ,trx_amt_ovp_part_amt 交易金额溢缴款部分金额
        ,trx_ind 交易标志
        ,chnl_id 渠道标识
        ,agn_fwd_isu_org_cd 代理转发发卡机构代码
        ,cnr_cd 国家代码
        ,clr_amt 清算金额
        ,clr_ccy_cd 清算币种代码
        ,rtn_gds_trx_id 退货交易标识
        ,trx_dscr_1 交易描述1
        ,trx_dscr_2 交易描述2
        ,idx_ref_new 新检索参考号
        ,frs_strk_onl_aut_trx_id 首笔联机授权交易标识
        ,pos_inpt_mth POS输入方式
        ,acq_mch_enc 收单商户编码
        ,tbs_fee_amt 可选费用金额
        ,acq_org_id 收单机构码
        ,mch_seq_nbr 商户序号
        ,cur_un_intr_bal 当前不含利息余额
        ,trx_into_whs_dt 交易入库时的自然日期
        ,insd_and_otsd_trx_ind 境内外交易标志
        ,trx_hpn_dt 交易发生日期
        ,actl_trx_tm 实际交易时间
        ,pbc_chnl_ind 人行渠道标识
        ,call_bil_ref 调单参考号
        ,out_card_trx_ind 外卡交易标志
        ,saf_ctrl_hbr_cd 安控层级代码
FROM    edw.dwd_bus_crd_cr_crd_trx_dtl_di t
left join edw.dim_bus_crd_cr_crd_inf_dd t1
on t.cr_crd_card_nbr=t1.cr_crd_card_nbr
and t1.dt='@@{yyyyMMdd}'
WHERE   dt >= '20210305'
AND     dt <= '@@{yyyyMMdd}'
AND     cr_crd_card_nbr in ('6222876200006312','6222876200008813') ;
**01-数据需求_保全_2025_常态化需求_D0102_梁世鹏_剥离业务的信贷管户交接.sql
-- SJ2025010356
--为进一步推动剥离业务的信贷管户交接，现需对剥离业务的管户交接数据进行再梳理。
--1、数据日期2024年12月31日；
--2、数据范围为附件中客户号下向下的全量未结清贷款/信用卡业务。（未结清的判断已在数据需求字段中进行说明）

-- --定期更新导入的表：qbi_file_20250106_14_40_01_0
-- DROP TABLE if EXISTS wsj_SJ2025010356_2 purge;
-- CREATE TABLE IF NOT EXISTS wsj_SJ2025010356_2 as
-- SELECT col_1 as 剥离分行
--        ,col_2 as 客户号
--        ,col_3 as 剥离日期
-- FROM  qbi_file_20250106_14_40_01_0 WHERE pt=MAX_PT('qbi_file_20250106_14_40_01_0');

--


-- SELECT COUNT(1) FROM LSP_SJ2025010356


--结果表:贷款和信用卡合同
--- 贷款
drop table if EXISTS  lab_bigdata_dev.LSP_SJ2025010356 PURGE ;
create table if not EXISTS  LSP_SJ2025010356 as
select distinct *
from (
select distinct
    t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'贷款' 业务种类
    ,t2.CTR_SERNO 合同号_卡号
    ,case when t3.busi_ctr_id is not null then '是' else '否' end 是否已剥离
    ,case when t4.CTR_SERNO is not null then '否' else '是' end 是否已结清
    ,case when t5.CTR_SERNO is not null then '是' else '否' end 是否已核销
    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.CTR_SERNO is not null and t8.MGR_ID != t9.MGR_ID then '是'  else '否' end 业务是否已交接
    ,t10.余额 透支本金余额_合同余额_核后本金余额
    ,t12.pd_nm 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.MGR_ORG_ID 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.MGR_ID 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.MGR_ORG_ID 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.MGR_ID 剥离时点业务管户客户经理工号

from wsj_SJ2025010356_2 t1   --业务提供的数据
left join edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t2   --合同基础信息
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_loan_peel_loan_mng_dd t3  --剥离贷款管理
on t2.CTR_SERNO =t3.busi_ctr_id
and t3.dt ='${data_dt}'
and t3.peel_sts_cd ='997' --剥离
left join
(
    select t1.CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and DBIL_STS_CD !='1' --未结清   借据状态代码0 正常1 结清2 已核销3 准销户4 录入5 已减免
    group by t1.CTR_SERNO
) t4
on t2.CTR_SERNO =t4.CTR_SERNO
left join
(
    select t1.CTR_SERNO
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    and DBIL_STS_CD ='2' --已核销
    group by t1.CTR_SERNO
) t5
on t2.CTR_SERNO =t5.CTR_SERNO
--判断客户管户经理工号与剥离时点客户管户经理工号是否一致
left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and t1.剥离日期 = t6.dt -- 客户剥离时管户
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'
--判断业务管户经理工号与剥离时点业务管户经理工号是否一致
left join edw.DWD_BUS_LOAN_CTR_MGR_INF_DD t8 --信贷合同管护信息
on t3.busi_ctr_id =t8.CTR_SERNO  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.peel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_loan_ctr_mgr_inf_dd t9 -- 信贷合同管护信息
on t2.CTR_SERNO =t9.CTR_SERNO and t9.dt ='${data_dt}' -- 业务当前管户
--透支本金余额/合同余额+核后本金余额(合同级)（若业务为核销业务需取合同项下的所有借据的核后本金余额与借据余额之和）
left join
(
    select t1.CTR_SERNO
    ,sum(WRT_OFF_AMT)+sum(prcp_bal) 余额
    from edw.dim_bus_loan_dbil_inf_dd t1  --信贷借据信息
    where t1.dt ='${data_dt}'
    group by t1.CTR_SERNO
) t10
on t2.CTR_SERNO = t10.CTR_SERNO

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  -现客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join edw.DIM_BUS_LOAN_PRD_FRML_DD t12 --信贷产品信息
on t2.PRD_NO = t12.prd_no   and t12.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --现业务管户机构
on t9.MGR_ORG_ID = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.MGR_ID = t14.empe_id  and t14.dt ='${data_dt}'  --现业务客户经理

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.MGR_ORG_ID = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.MGR_ID = t17.empe_id  and t17.dt ='${data_dt}'

where t2.CTR_SERNO is not null

union

--- 信用卡
select distinct
     t1.剥离分行
    ,t1.客户号
    ,t1.剥离日期
    ,'信用卡' 业务种类
    ,t2.late_main_card_card_nbr 合同号_卡号
    ,case when t3.ctr_srl_nbr is not null then '是' else '否' end 是否已剥离
    ,case when t4.未结清金额 = 0  then '是' else '否' end 是否已结清
    ,case when t5.late_main_card_card_nbr is not null then '是' else '否' end 是否已核销

    ,case when t6.prm_mgr_id = t7.prm_mgr_id then '否' else '是' end 客户是否已交接
    ,case when t8.cr_crd_card_nbr is not null and t8.frs_mgr_id != t9.frs_mgr_id then '是'  else '否' end 业务是否已交接

    ,t4.未结清金额 透支本金余额_合同余额_核后本金余额
    ,t12.cr_crd_pd_cmt 业务品种

    ,t11.brc_org_nm 现客户管户分行
    ,t11.org_nm 现客户管户机构名称
    ,t7.prm_org_id 现客户管户机构号
    ,t7.prm_mgr_nm 现客户客户经理名称
    ,t7.prm_mgr_id 现客户管户客户经理工号

    ,t13.brc_org_nm 现业务管户分行
    ,t13.org_nm 现业务管户机构名称
    ,t9.acs_org_id 现业务管户机构号
    ,t14.empe_nm 现业务客户经理名称
    ,t9.frs_mgr_id 现业务管户客户经理工号

    ,t15.brc_org_nm 剥离时点客户管户分行
	,t6.prm_org_nm 剥离时点客户管户机构名称
    ,t6.prm_org_id 剥离时点客户管户机构号
    ,t6.prm_mgr_nm 剥离时点客户客户经理名称
    ,t6.prm_mgr_id 剥离时点客户管户客户经理工号

    ,t16.brc_org_nm 剥离时点业务管户分行
    ,t16.org_nm 剥离时点业务管户机构名称
    ,t8.acs_org_id 剥离时点业务管户机构号
    ,t17.empe_nm 剥离时点业务客户经理名称
    ,t8.frs_mgr_id 剥离时点业务管户客户经理工号

from wsj_SJ2025010356_2 t1
left join edw.dws_bus_crd_cr_crd_act_inf_dd t2 -- 信用卡账户信息汇总
on t1.客户号 =t2.cst_id  and t2.dt ='${data_dt}'
left join edw.dwd_bus_crd_pel_cr_crd_mng_dd t3  -- 剥离信用卡管理
on t2.late_main_card_card_nbr =t3.ctr_srl_nbr and t3.dt ='${data_dt}' and t3.pel_sts_cd ='997' --剥离
left join
(
    SELECT  late_main_card_card_nbr
        ,nvl(H.IBS_RCV_FEE,0) + nvl(H.OBS_RCV_FEE,0) + nvl(H.RCV_INTR,0) + nvl(H.OVDR_BAL,0) + nvl(H.INSTL_RMN_NOT_PAID_PRCP_BAL,0) 未结清金额
    FROM   edw.DWS_BUS_CRD_CR_CRD_ACT_INF_DD H  -- 信用卡账户信息汇总
    where H.dt ='${data_dt}'
) t4
on t2.late_main_card_card_nbr =t4.late_main_card_card_nbr
left join
(
    select t1.late_main_card_card_nbr
    from edw.dws_bus_crd_cr_crd_act_inf_dd t1  -- 信用卡账户信息
    where t1.dt ='${data_dt}'
    and t1.act_sts_cd ='V' --已核销
) t5
on t2.late_main_card_card_nbr =t5.late_main_card_card_nbr

left join adm_pub.adm_csm_cbas_mng_inf_dd t6  -- 客户集市-客户基础-客户管户信息   -- 客户剥离时管户
on t1.客户号 =t6.cst_id and t6.dt>='20220630' and t6.dt <='${data_dt}' and t1.剥离日期= t6.dt
left join adm_pub.adm_csm_cbas_mng_inf_dd t7  -- 客户集市-客户基础-客户管户信息   -- 客户当前管户
on t1.客户号 =t7.cst_id and t7.dt ='${data_dt}'

left join edw.DWD_BUS_CRD_CR_CRD_MGR_INF_DD t8 --信用卡管护信息
on t3.ctr_srl_nbr =t8.cr_crd_card_nbr  and t8.dt>='20220630' and t8.dt <='${data_dt}' and t3.pel_dt = t8.dt --业务剥离日期时管户
left join edw.dwd_bus_crd_cr_crd_mgr_inf_dd t9 -- 信用卡管护信息
on t2.late_main_card_card_nbr =t9.cr_crd_card_nbr and t9.dt ='${data_dt}' -- 业务当前管户

left join edw.dim_hr_org_mng_org_tree_dd t11  -- 机构表  --客户管户机构
on t7.prm_org_id =t11.org_id  and t11.dt ='${data_dt}'

left join
(
select t1.cr_crd_card_nbr,t2.cr_crd_pd_cmt
from edw.DIM_BUS_CRD_CR_CRD_INF_DD t1  --信用卡卡片信息
left join edw.dim_bus_crd_cr_crd_pd_inf_dd t2  --信用卡产品信息
on t1.cr_crd_pd_id = t2.cr_crd_pd_id  and t2.dt ='${data_dt}'
where t1.dt ='${data_dt}'
) t12 --产品表
on t2.late_main_card_card_nbr =t12.cr_crd_card_nbr

left join edw.dim_hr_org_mng_org_tree_dd t13 -- 机构表 --业务管户机构
on t9.acs_org_id = t13.org_id  and t13.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t14 -- 员工汇总信息
on t9.frs_mgr_id = t14.empe_id  and t14.dt ='${data_dt}'

left join edw.dim_hr_org_mng_org_tree_dd t15 -- 机构表 --剥离时客户管户机构
on t6.prm_org_id = t15.org_id  and t15.dt ='${data_dt}'

left join  edw.dim_hr_org_mng_org_tree_dd t16 -- 机构表 --剥离时业务管户机构
on t8.acs_org_id = t16.org_id  and t16.dt ='${data_dt}'

left join edw.dws_hr_empe_inf_dd t17 -- 员工汇总信息
on t8.frs_mgr_id = t17.empe_id  and t17.dt ='${data_dt}'

where t2.late_main_card_card_nbr is not null
)
ORDER BY 剥离分行,客户号,剥离日期
;
**01-数据需求_保全_D1101_郑一峰_用于逾期客户走访调查.sql
--SJ20241101131
-- 用于客户走访、逾期客户的触达；根据客户最新征信分判断客户情况；根据身份证查询客户案件等信息
-- 合同流水号	借款人名称	借款人身份证号	借款人户籍地	借款人居住地	借款人经营地	借款人联系方式	借款人最新征信分	借款人最近查询征询日期
-- 担保人名称	担保人身份证号	担保人户籍地	担保人居住地	担保人经营地	担保人联系方式	担保人最新征信分	担保人最近查询征询日期	多个担保人的，合并展示，用;隔开

SELECT * FROM tmp_zyf_SJ20241101131_f;

--结果表，多个担保人合并成一行，需要用老表补齐一部分个人征信分，但是只有查询时间，没有查询的征信分
DROP TABLE IF EXISTS tmp_zyf_SJ20241101131_f PURGE;

CREATE TABLE IF NOT EXISTS tmp_zyf_SJ20241101131_f AS
SELECT  合同流水号
        ,借款人名称
        ,借款人客户号
        ,借款人身份证号
        ,借款人户籍地
        ,借款人居住地
        ,借款人经营地
        ,借款人联系方式
        ,coalesce(A.借款人最新征信分, greatest(B.idv_crd_sco_val, B.idv_crd_sco_val2)) AS 借款人最新征信分
        ,coalesce(A.借款人最近查询征询日期, B.report_dt)                                  AS 借款人最近查询征询日期
        ,WM_CONCAT(';', 担保人客户号)                                                AS 担保人客户号
        ,WM_CONCAT(';', 担保人名称)                                                 AS 担保人名称
        ,WM_CONCAT(';', 担保人身份证号)                                               AS 担保人身份证号
        ,WM_CONCAT(';', 担保人户籍地或注册地)                                            AS 担保人户籍地或注册地
        ,WM_CONCAT(';', 担保人居住地)                                                AS 担保人居住地
        ,WM_CONCAT(';', 担保人经营地或工作地)                                            AS 担保人经营地或工作地
        ,WM_CONCAT(';', 担保人联系方式)                                               AS 担保人联系方式
        ,WM_CONCAT(';', 担保人最新征信分)                                              AS 担保人最新征信分
        ,WM_CONCAT(';', 担保人最近查询征询日期)                                           AS 担保人最近查询征询日期
FROM    tmp_zyf_SJ20241101131 A
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd B --个人征信
ON      A.借款人客户号 = B.cst_id
AND     B.dt = '@@{yyyyMMdd}'
AND     B.report_dsc_rn = 1
GROUP BY 合同流水号 , 借款人名称 , 借款人客户号,借款人身份证号 , 借款人户籍地 , 借款人居住地 , 借款人经营地 , 借款人联系方式 , coalesce(A.借款人最新征信分, greatest(B.idv_crd_sco_val, B.idv_crd_sco_val2)) , coalesce(A.借款人最近查询征询日期, B.report_dt)
;


------中间表
DROP TABLE IF EXISTS tmp_zyf_SJ20241101131 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zyf_SJ20241101131 AS
SELECT  a.col_1                    AS 合同流水号
        ,a.col_2                   AS 借款人名称
        ,cb.cst_id                 AS 借款人客户号
        ,b.doc_nbr                 AS 借款人身份证号
        ,b.reg_adr                 AS 借款人户籍地
        ,b.fml_adr                 AS 借款人居住地
        ,b.wrk_adr                 AS 借款人经营地
        ,b.mbl_nbr                 AS 借款人联系方式
        ,c.cst_cr_grd_val          AS 借款人最新征信分
        ,substr(c.prd_dt, 1, 10)   AS 借款人最近查询征询日期
        ,nvl(gp.wrnt_cst_id, '')   AS 担保人客户号
        ,nvl(gp.wrnt_cst_nm, '')   AS 担保人名称
        ,nvl(gp.wrnt_doc_nbr, '')  AS 担保人身份证号
        ,gp1.reg_adr               AS 担保人户籍地或注册地
        ,gp1.fml_adr               AS 担保人居住地
        ,gp1.wrk_adr               AS 担保人经营地或工作地
        ,gp1.mbl_nbr               AS 担保人联系方式
        ,gp2.cst_cr_grd_val        AS 担保人最新征信分
        ,substr(gp2.prd_dt, 1, 10) AS 担保人最近查询征询日期
FROM    qbi_file_20241105_11_03_11 a
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd cb
ON      a.col_1 = cb.ctr_serno
AND     cb.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      cb.cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,t.prd_dt
                         ,t.cst_cr_grd_val
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
                 FROM    (
                             SELECT  cst_id
                                     ,to_date(REPLACE(substr(qry_tm, 1, 10), '-', ''), 'yyyymmdd') AS prd_dt
                                     ,cr_sco_val                                                   AS cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI --单笔评分查询记录
                             WHERE   dt <= '@@{yyyyMMdd}'
                             AND     cr_sco_val IS NOT NULL
                             UNION ALL
                             SELECT  cst_id
                                     ,to_date(prd_dt, 'yyyymmdd') AS prd_dt
                                     ,cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI --批量评分查询记录
                             WHERE   dt <= '@@{yyyyMMdd}'
                             AND     cst_cr_grd_val IS NOT NULL
                         ) t
             ) c
ON      b.cst_id = c.cst_id
AND     c.rn = 1
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd gp
ON      a.col_1 = gp.bus_ctr_id
AND     gp.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd gp1
ON      gp.wrnt_cst_id = gp1.cst_id
AND     gp1.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,t.prd_dt
                         ,t.cst_cr_grd_val
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
                 FROM    (
                             SELECT  cst_id
                                     ,to_date(REPLACE(substr(qry_tm, 1, 10), '-', ''), 'yyyymmdd') AS prd_dt
                                     ,cr_sco_val                                                   AS cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI --单笔评分查询记录
                             WHERE   dt <= '@@{yyyyMMdd}'
                             AND     cr_sco_val IS NOT NULL
                             UNION ALL
                             SELECT  cst_id
                                     ,to_date(prd_dt, 'yyyymmdd') AS prd_dt
                                     ,cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI --批量评分查询记录
                             WHERE   dt <= '@@{yyyyMMdd}'
                             AND     cst_cr_grd_val IS NOT NULL
                         ) t
             ) gp2
ON      gp.wrnt_cst_id = gp2.cst_id
AND     gp2.rn = 1
WHERE   a.pt <> '';
**01-数据需求_保全_D1104_张颖_卡业务催记.sql
-- SJ2024110431
-- 1、调取保全系统催收痕迹，附件表内卡号业务对应的催记，催记的催收时间在&lsquo;2024年6月22日&ldquo;至&rsquo;2024年7月30日&rdquo;
-- 2、调取字段：催收日期、合同号/卡号、客户名称、催收对象、催收对象名称、催收方式、催收人员、登记人、登记机构、登记时间、催记渠道、催收内容、催收结果

--有部分卡在此期间没有催记


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xyk_cs_SJ2024110431 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xyk_cs_SJ2024110431 AS
SELECT T1.col_1 As 提供卡号
        ,T2.coln_date    AS 催收日期
        ,T2.cont_card_no AS 合同号卡号
        ,T2.cust_nm      AS 客户名称
        ,CASE
           WHEN T2.col_obj = '01' THEN '本人'
           WHEN T2.col_obj = '02' THEN '担保人'
           WHEN T2.col_obj = '03' THEN '联系人'
           WHEN T2.col_obj = '04' THEN '第三方'
           ELSE ''
         END 催收对象
        ,T2.contact_name AS 催收对象名称
        ,CASE
           WHEN T2.coln_way = '20' THEN '债务拆分'
           WHEN T2.coln_way = '14' THEN 'AI催收'
           WHEN T2.coln_way = '07' THEN '诉讼'
           WHEN T2.coln_way = '17' THEN '分期还款'
           WHEN T2.coln_way = '99' THEN '其他'
           WHEN T2.coln_way = '03' THEN '催收电子邮件'
           WHEN T2.coln_way = '13' THEN '律师函催收'
           WHEN T2.coln_way = '04' THEN '电话录音催收'
           WHEN T2.coln_way = '19' THEN '重组'
           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN T2.coln_way = '08' THEN '公安立案'
           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN T2.coln_way = '18' THEN '利息减免'
           WHEN T2.coln_way = '02' THEN '催收短信'
           WHEN T2.coln_way = '11' THEN '现场催收'
           WHEN T2.coln_way = '01' THEN '催收通知书'
           WHEN T2.coln_way = '16' THEN '催收函'
           WHEN T2.coln_way = '09' THEN '报纸公告'
           WHEN T2.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,T2.coln_usr_no  AS 催收人员编号行内
        ,T2.coln_user    AS 催收人员名称行内
        ,T2.out_person   AS 催收人员名称行外
        ,T2.input_usr_no 登记人
        ,t2.input_usr_name 登记人姓名
        ,T2.input_date   AS 登记时间
        ,CASE
           WHEN t2.coln_source = '101060' THEN '金融移动服务站'
           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'
           WHEN t2.coln_source = '202020' THEN '信贷系统'
           WHEN t2.coln_source = '202021' THEN 'PC'
           WHEN t2.coln_source = '413010' THEN '小鱼管家'
           WHEN t2.coln_source = '440010' THEN '智能AI'
           WHEN t2.coln_source = '449010' THEN '人工外呼'
           WHEN t2.coln_source = '102010' THEN '短信平台'
           ELSE ''
         END 催收渠道
        -- ,T2.phone        AS 外呼电话号码
        -- ,T2.relation     AS 与本人关系
        -- ,T2.call_status  AS 外呼状态
        ,CASE
           WHEN t2.collect_status = '01' THEN '承诺还款'
           WHEN t2.collect_status = '02' THEN '谈判中'
           WHEN t2.collect_status = '05' THEN '其他'
           WHEN t2.collect_status = '03' THEN '转告还款'
           WHEN t2.collect_status = '04' THEN '无法触达'
           ELSE ''
         END 催收状态
        ,t2.coln_result  AS 催收内容
        ,CASE
           WHEN T2.DC_THOGH_STATUS = '1'   THEN '无人接听'
           WHEN T2.DC_THOGH_STATUS = '100' THEN '未接通'
           WHEN T2.DC_THOGH_STATUS = '111' THEN '已告知，未明显表态，有效接通'
           WHEN T2.DC_THOGH_STATUS = '12'  THEN '已告知'
           WHEN T2.DC_THOGH_STATUS = '130' THEN '其他-请看催记备注'
           WHEN T2.DC_THOGH_STATUS = '131' THEN '否认消费（部分交易）'
           WHEN T2.DC_THOGH_STATUS = '132' THEN '否认消费（全部交易）'
           WHEN T2.DC_THOGH_STATUS = '134' THEN '拒绝还款，要投诉'
           WHEN T2.DC_THOGH_STATUS = '135' THEN '无还款能力'
           WHEN T2.DC_THOGH_STATUS = '136' THEN '其他-见催记备注'
           WHEN T2.DC_THOGH_STATUS = '137' THEN '失联'
           WHEN T2.DC_THOGH_STATUS = '138' THEN '生病'
           WHEN T2.DC_THOGH_STATUS = '139' THEN '涉刑'
           WHEN T2.DC_THOGH_STATUS = '140' THEN '欺诈情况'
           WHEN T2.DC_THOGH_STATUS = '141' THEN '反催特点'
           WHEN T2.DC_THOGH_STATUS = '142' THEN '死亡'
           WHEN T2.DC_THOGH_STATUS = '143' THEN '移交专家'
           WHEN T2.DC_THOGH_STATUS = '144' THEN '其他-详见催记备注'
           WHEN T2.DC_THOGH_STATUS = '145' THEN '分期'
           WHEN T2.DC_THOGH_STATUS = '146' THEN '减免'
           WHEN T2.DC_THOGH_STATUS = '147' THEN 'ZXT/ZD'
           WHEN T2.DC_THOGH_STATUS = '149' THEN '他人代偿（需登记关系）'
           WHEN T2.DC_THOGH_STATUS = '150' THEN '承诺一次性还款'
           WHEN T2.DC_THOGH_STATUS = '160' THEN '要求短分期（小于等于24期）'
           WHEN T2.DC_THOGH_STATUS = '161' THEN '要求长分期（大于24期）'
           WHEN T2.DC_THOGH_STATUS = '162' THEN '要求全额减免利息'
           WHEN T2.DC_THOGH_STATUS = '163' THEN '已承诺减免'
           WHEN T2.DC_THOGH_STATUS = '165' THEN '话务条异常'
           WHEN T2.DC_THOGH_STATUS = '168' THEN '空号/停机'
           WHEN T2.DC_THOGH_STATUS = '17'  THEN '通话中全部归还'
           WHEN T2.DC_THOGH_STATUS = '2'   THEN '拒接'
           WHEN T2.DC_THOGH_STATUS = '3'   THEN '忙音'
           WHEN T2.DC_THOGH_STATUS = '4'   THEN '错号'
           WHEN T2.DC_THOGH_STATUS = '5'   THEN '空号'
           WHEN T2.DC_THOGH_STATUS = '6'   THEN '停机'
           WHEN T2.DC_THOGH_STATUS = '7'   THEN '关机'
           WHEN T2.DC_THOGH_STATUS = '8'   THEN '呼叫限制'
           WHEN T2.DC_THOGH_STATUS = '9'   THEN '话务条异常'
           ELSE ''
         END             AS 催收结果
FROM    lab_bigdata_dev.qbi_file_20241105_10_28_25 T1 --导入数据
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      T1.col_1 = T2.cont_card_no
AND     T2.DT = '@@{yyyyMMdd}'
AND     T2.coln_date BETWEEN '2024-06-22 00:00:00' AND '2024-07-30 00:00:00'
where   T1.pt<>''
;
**01-数据需求_保全_D1121_吴伟_匹配是否农户.sql
--匹配是否农户
--吴伟



DROP TABLE IF EXISTS tmp_sjxq_ww_SJ2024112131 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_ww_SJ2024112131 AS
SELECT  COALESCE(a.col_1,T0.cst_id,T1.cst_id)   AS 客户号
        ,a.col_2                                      AS 合同号
        ,a.col_3                                      AS 借据号
        ,COALESCE(ci.psnt_hsd_ind, cc.psnt_hsd_ind) AS 农户标识
        ,CASE
           WHEN COALESCE(ci.psnt_hsd_ind, cc.psnt_hsd_ind) = 1 THEN '是'
           ELSE '否'
         END                                        AS 是否农户
FROM    qbi_file_20241121_13_43_03_0 a
LEFT JOIN  edw.dws_bus_loan_dbil_inf_dd T0  --贷款借据信息汇总
ON   A.col_3 = T0.dbil_id
AND  T0.dt = '@@{yyyyMMdd}'
LEFT JOIN  edw.dim_bus_loan_ctr_bse_inf_dd T1  --合同基础信息
ON   A.col_2 = T1.ctr_serno
AND  T1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_indiv_ind ci --个人客户标识信息
ON      COALESCE(a.col_1,T0.cst_id,T1.cst_id) = ci.cst_id
AND     CI.cst_id <> ''
AND     ci.dt = '@@{yyyyMMdd}'
AND     ci.del_ind = '0'
LEFT JOIN    edw.loan_cst_corp_ind cc --企业客户标识信息
ON      COALESCE(a.col_1,T0.cst_id,T1.cst_id)  = cc.cst_id
AND     cc.cst_id <> ''
AND     cc.dt = '@@{yyyyMMdd}'
AND     cc.del_ind = '0'
WHERE   a.pt <> ''
;
**01-数据需求_保全_D1127_吴伟_核销状态_是否已核销_实际核销本金_核销时间.sql
--
-- 数据日期：2024.11.26
-- 取数字段：核销状态（是否已核销）、实际核销本金、核销时间（尽量精确到日、时、分、秒，不能到秒也没关系）
-- 取数系统：核心系统
-- 联系人：付新龙
-- 取数范围：附件的拟核销清单。提示：蚂蚁借呗业务、信用卡业务可能在核心没有记录数据，查询可能为空值。
-- 取数字段：核销状态（是否已核销）、实际核销本金、核销时间（尽量精确到日、时、分、秒，不能到秒也没关系）
-- edw.core_klna_dkzhzb就可以了，字段dkzhhzht 和hexiaobj
-- dkzhhzht 码值     、
-- - ZHC 0 正常
--      - XHU 1 销户
--      - YHX 2 已核销
--      要时间的话就要取另一个口径了，edw.core_klnl_dkzhmx 取交易事件LN_HEXO的明细的维护时间



DROP TABLE IF EXISTS tmp_sjxq_SJ2024112721 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024112721 AS
SELECT  t1.col_1     AS 客户号
        ,t1.col_2    AS 合同流水号
        ,t1.col_3    AS 借据号
        ,CASE
           WHEN t2.dkzhhzht = 0 THEN '正常'
           WHEN t2.dkzhhzht = 1 THEN '销户'
           WHEN t2.dkzhhzht = 2 THEN '已核销'
           ELSE ''
         END         AS 核销状态
        ,t2.hexiaobj AS 实际核销本金
        ,t3.weihriqi AS 维护日期
        ,t3.weihshij AS 维护时间
FROM    qbi_file_20241127_11_17_32_0 t1
LEFT JOIN    edw.core_klna_dkzhzb t2 --贷款账户主表
ON      t1.col_3 = t2.dkjiejuh
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  *
                         ,ROW_NUMBER() OVER ( PARTITION BY dkjiejuh ORDER BY weihriqi DESC ) AS rn
                 FROM    edw.core_klnl_dkzhmx  --贷款账户交易明细表
                 WHERE   dt <= '@@{yyyyMMdd}'
                 AND     dt >= '20140101'
                 AND     jiaoyisj = 'LN_HEXO'
             ) t3
ON      t1.col_3 = t3.dkjiejuh
AND     t3.rn = 1
WHERE   t1.pt <> '';
**01-数据需求_保全_D1203_张颖_地址数据治理.sql
--SJ20241202111
--因资管系统信函催收管理模块存量数据治理需要（对客寄送催收函需要取客户地址，历史系统取出地址，但是并未取出对应地址类型，
-- 或因系统原因历史担保人地址仍取的是借款人地址，故对存量数据开展数据治理）取数历史取得的地址对应的地址类型，并后续随系统模块优化，对系统错误地址数据治理
--【贷款地址类型及地址取数逻辑】按清单列表，取出对应客户编号的地址类型及地址，按下列优先级取出有效地址数据。
-- 贷款地址取数优先级为：信贷的法律文书送达地址>信贷的主地址>保全的任务详情里面送达地址；保全的详细地址，只会查有效的is_Vaild是1的状态


-- select task_no as '任务编号',cust_no as '客户编号',cust_nm as 客户名称,ADDR as 送达地址 from ic_biz_arrive_addr  --该表未入仓，无法取。先取前2个地址
--sheet1 ,信函贷款申请
--贷款地址取数优先级为：信贷的法律文书送达地址>信贷的主地址>保全的任务详情里面送达地址；保全的详细地址，只会查有效的is_Vaild是1的状态


--取数440，
DROP TABLE IF EXISTS tmp_sjxq_SJ20241202111_xhdksq PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241202111_xhdksq AS
SELECT  t1.col_1                               AS 合同流水号
        ,t2.cst_id                             AS 借款人编号
        ,t2.cst_role                           AS 信函寄送对象角色
        ,cst.cst_chn_nm                        AS 借款人或担保人名称
        ,COALESCE(adr.dtl_addr, adr1.dtl_addr) AS 地址
        ,CASE
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050800' THEN '注册地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050300' THEN '通讯地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050900' THEN '经营地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050200' THEN '家庭地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050100' THEN '户籍地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050400' THEN '办公地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '051000' THEN '其他地址'
           ELSE ''
         END                                   AS 地址类型
FROM    (
            SELECT  DISTINCT col_1
            FROM    qbi_file_20241203_13_45_18_0
            WHERE   pt <> ''
        ) t1
LEFT JOIN    (
                 SELECT  *
                 FROM    (
                             SELECT  ctr.ctr_serno
                                     ,'借款人' AS cst_role
                                     ,ctr.cst_id
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd ctr
                             WHERE   ctr.dt = '@@{yyyyMMdd}'
                             UNION ALL
                             SELECT  ctr.ctr_serno --合同号
                                     ,'担保人'          AS cst_role --客户角色
                                     ,gr.grnt_gds_id AS cst_id --保证人编号
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd ctr
                             LEFT JOIN    edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd gr --主合同、担保合同、担保物关系
                             ON      ctr.ctr_serno = gr.ctr_serno
                             AND     gr.dt = '@@{yyyyMMdd}'
                             AND     gr.grnt_gds_typ_cd = '1' --1保证人
                             WHERE   ctr.dt = '@@{yyyyMMdd}'
                             AND     gr.grnt_gds_id IS NOT NULL
                         ) t
                 order by t.ctr_serno , t.cst_role
             ) t2
ON      t1.col_1 = t2.ctr_serno
LEFT JOIN    edw.loan_cst_ctc_addr adr --联系地址信息
ON      t2.cst_id = adr.cst_id
AND     adr.dt = '@@{yyyyMMdd}'
AND     adr.del_ind = 0 --删除标识
AND     adr.lgl_imt_arrv_addr_ind = 1 --法律文书送达地址标志
LEFT JOIN    edw.loan_cst_ctc_addr adr1 --联系地址信息
ON      t2.cst_id = adr1.cst_id
AND     adr1.dt = '@@{yyyyMMdd}'
AND     adr1.main_addr_ind = 1 --主地址标志
LEFT JOIN    edw.dws_cst_bas_inf_dd cst
ON      t2.cst_id = cst.cst_id
AND     cst.dt = '@@{yyyyMMdd}'
ORDER BY t1.col_1 ,t2.cst_role ;


--sheet2 --贷款台账

--取数226条

DROP TABLE IF EXISTS tmp_sjxq_SJ20241202111_dktz PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241202111_dktz AS
SELECT  t1.col_1                               AS 合同流水号
        ,t2.cst_id                             AS 借款人或担保人编号
        ,t2.cst_role                           AS 客户角色
        ,cst.cst_chn_nm                        AS 借款人或担保人名称
        ,COALESCE(adr.dtl_addr, adr1.dtl_addr) AS 地址
        ,CASE
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050800' THEN '注册地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050300' THEN '通讯地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050900' THEN '经营地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050200' THEN '居住地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050100' THEN '户籍地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '050400' THEN '办公地址'
           WHEN COALESCE(adr.addr_typ, adr1.addr_typ) = '051000' THEN '其他地址'
           ELSE ''
         END                                   AS 地址类型
FROM    (
            SELECT  DISTINCT col_1
            FROM    qbi_file_20241203_16_51_51_0
            WHERE   pt <> ''
        ) t1
LEFT JOIN    (
                 SELECT  *
                 FROM    (
                             SELECT  ctr.ctr_serno
                                     ,'借款人' AS cst_role
                                     ,ctr.cst_id
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd ctr
                             WHERE   ctr.dt = '@@{yyyyMMdd}'
                             UNION ALL
                             SELECT  ctr.ctr_serno --合同号
                                     ,'担保人'          AS cst_role --客户角色
                                     ,gr.grnt_gds_id AS cst_id --保证人编号
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd ctr
                             LEFT JOIN    edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd gr --主合同、担保合同、担保物关系
                             ON      ctr.ctr_serno = gr.ctr_serno
                             AND     gr.dt = '@@{yyyyMMdd}'
                             AND     gr.grnt_gds_typ_cd = '1' --1保证人
                             WHERE   ctr.dt = '@@{yyyyMMdd}'
                             AND     gr.grnt_gds_id IS NOT NULL
                         ) t
                 order by t.ctr_serno , t.cst_role
             ) t2
ON      t1.col_1 = t2.ctr_serno
LEFT JOIN    edw.loan_cst_ctc_addr adr --联系地址信息
ON      t2.cst_id = adr.cst_id
AND     adr.dt = '@@{yyyyMMdd}'
AND     adr.del_ind = 0 --删除标识
AND     adr.lgl_imt_arrv_addr_ind = 1 --法律文书送达地址标志
LEFT JOIN    edw.loan_cst_ctc_addr adr1 --联系地址信息
ON      t2.cst_id = adr1.cst_id
AND     adr1.dt = '@@{yyyyMMdd}'
AND     adr1.main_addr_ind = 1 --主地址标志
AND     adr1.del_ind = 0 --删除标识
LEFT JOIN    edw.dws_cst_bas_inf_dd cst
ON      t2.cst_id = cst.cst_id
AND     cst.dt = '@@{yyyyMMdd}'
ORDER BY t1.col_1 ,t2.cst_role ;


--sheet3 信用卡台账
-- 【信用卡地址类型及地址取数逻辑】按清单列表，取出对应客户编号的地址类型及地址，按下列优先级取出有效地址数据。
-- 信用卡地址取数优先级为：信贷的法律文书送达地址>银联账单地址>信贷主地址>信贷居住地址>信贷户籍地址；账单地址不能为&ldquo;NONO&rdquo;

--取数有15470条信用卡,清单中信用卡去重有14953张信用卡，数据能对上,账单地址为&ldquo;NONO&rdquo;有158条，未剔除
;


DROP TABLE IF EXISTS tmp_sjxq_SJ20241202111_xyktz PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241202111_xyktz AS
SELECT  a.col_1                                                                         AS 信用卡卡号
        ,b.busi_ctr_id                                                                  AS 业务合同编号
        ,b.cst_id                                                                       AS 借款人或担保人编号
        ,b.cst_role                                                                     AS 客户角色
        ,cst.cst_chn_nm                                                                 AS 借款人或担保人名称
        ,COALESCE(adr.dtl_addr, d.bil_adr, adr1.dtl_addr, adr2.dtl_addr, adr3.dtl_addr) AS 地址
        ,CASE
           WHEN adr.dtl_addr IS NOT NULL AND coalesce(adr.dtl_addr, '') <> ''   THEN '信贷法律文书地址'
           WHEN d.bil_adr IS NOT NULL AND coalesce(d.bil_adr, '') <> ''         THEN '银联账单地址'
           WHEN adr1.dtl_addr IS NOT NULL AND coalesce(adr1.dtl_addr, '') <> '' THEN '信贷主地址'
           WHEN adr2.dtl_addr IS NOT NULL AND coalesce(adr2.dtl_addr, '') <> '' THEN '信贷居住地址'
           WHEN adr3.dtl_addr IS NOT NULL AND coalesce(adr3.dtl_addr, '') <> '' THEN '信贷户籍地址'
         END                                                                            AS 地址类型
-- ,CASE
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) IN ( '050100' , 'F' ) THEN '户籍地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) IN ( '050200' , 'H' ) THEN '居住地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050300'            THEN '通讯地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050400'            THEN '办公地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050800'            THEN '注册地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050900'            THEN '经营地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '051000'            THEN '其他地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = 'W'                 THEN '房产地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = 'B'                 THEN '公司地址'
--    ELSE ''
--  END                                                                            AS 地址类型
FROM    (
            SELECT  DISTINCT col_1
            FROM    qbi_file_20241203_17_14_25_0
            WHERE   pt <> ''
        ) a
LEFT JOIN    (
                 SELECT  crd.busi_ctr_id
                         ,crd.cr_crd_card_nbr
                         ,crd.cr_crd_act_id --信用卡账号
                         ,crd.cst_id
                         ,'借款人' AS cst_role
                 FROM    edw.dim_bus_crd_cr_crd_inf_dd crd ---信用卡卡片信息
                 WHERE   crd.dt = '@@{yyyyMMdd}'
                 UNION ALL
                 SELECT  crd.busi_ctr_id
                         ,crd.cr_crd_card_nbr
                         ,crd.cr_crd_act_id --信用卡账号
                         ,gr.grnt_gds_id AS cst_id --保证人编号
                         ,'担保人'          AS cst_role
                 FROM    edw.dim_bus_crd_cr_crd_inf_dd crd ---信用卡卡片信息
                 LEFT JOIN    edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd gr --主合同、担保合同、担保物关系
                 ON      crd.busi_ctr_id = gr.ctr_serno
                 AND     gr.dt = '@@{yyyyMMdd}'
                 AND     gr.grnt_gds_typ_cd = '1' --保证人
                 WHERE   crd.dt = '@@{yyyyMMdd}'
                 AND     coalesce(crd.busi_ctr_id, '') <> ''
                 AND     gr.grnt_gds_id IS NOT NULL
             ) b
ON      a.col_1 = b.cr_crd_card_nbr
LEFT JOIN    edw.dim_bus_crd_cr_crd_act_inf_dd d --信用卡账户信息,取账单地址,地址类型，BIL_ADR_TYP_CD F:户籍，H：家庭，B:公司，W:房产
ON      b.cr_crd_act_id = d.cr_crd_act_id --信用卡账户
AND     d.dt = '@@{yyyyMMdd}'
AND     d.bil_adr <> 'NONO' --账单地址不能为&ldquo;NONO&rdquo;
LEFT JOIN    edw.loan_cst_ctc_addr adr --信贷客户联系地址
ON      b.cst_id = adr.cst_id
AND     adr.dt = '@@{yyyyMMdd}'
AND     adr.lgl_imt_arrv_addr_ind = 1 --法律文书
AND     adr.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_cst_ctc_addr adr1 --信贷客户联系地址
ON      b.cst_id = adr1.cst_id
AND     adr1.dt = '@@{yyyyMMdd}'
AND     adr1.main_addr_ind = 1 --主地址标识
AND     adr1.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_cst_ctc_addr adr2 --信贷客户联系地址
ON      b.cst_id = adr2.cst_id
AND     adr2.dt = '@@{yyyyMMdd}'
AND     adr2.addr_typ = '050200' --家庭或居住地址
AND     adr2.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_cst_ctc_addr adr3 --信贷客户联系地址
ON      b.cst_id = adr3.cst_id
AND     adr3.dt = '@@{yyyyMMdd}'
AND     adr3.addr_typ = '050100' --户籍地址
AND     adr2.del_ind = 0 --删除标识
LEFT JOIN    edw.dws_cst_bas_inf_dd cst
ON      b.cst_id = cst.cst_id
AND     cst.dt = '@@{yyyyMMdd}'
ORDER BY a.col_1 , b.busi_ctr_id , b.cst_role;


--sheet4  信用卡申请

--取数1180条，实际1073条。


DROP TABLE IF EXISTS tmp_sjxq_SJ20241202111_xyksq PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241202111_xyksq AS
SELECT  INT(a.col_1)                                                                    AS 信用卡卡号
        ,b.busi_ctr_id                                                                  AS 业务合同编号
        ,b.cst_id                                                                       AS 借款人或担保人编号
        ,b.cst_role                                                                     AS 客户角色
        ,cst.cst_chn_nm                                                                 AS 借款人或担保人名称
        ,COALESCE(adr.dtl_addr, d.bil_adr, adr1.dtl_addr, adr2.dtl_addr, adr3.dtl_addr) AS 地址
        ,CASE
           WHEN adr.dtl_addr IS NOT NULL AND coalesce(adr.dtl_addr, '') <> ''   THEN '信贷法律文书地址'
           WHEN d.bil_adr IS NOT NULL AND coalesce(d.bil_adr, '') <> ''         THEN '银联账单地址'
           WHEN adr1.dtl_addr IS NOT NULL AND coalesce(adr1.dtl_addr, '') <> '' THEN '信贷主地址'
           WHEN adr2.dtl_addr IS NOT NULL AND coalesce(adr2.dtl_addr, '') <> '' THEN '信贷居住地址'
           WHEN adr3.dtl_addr IS NOT NULL AND coalesce(adr3.dtl_addr, '') <> '' THEN '信贷户籍地址'
         END                                                                            AS 地址类型
-- ,CASE
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) IN ( '050100' , 'F' ) THEN '户籍地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) IN ( '050200' , 'H' ) THEN '居住地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050300'            THEN '通讯地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050400'            THEN '办公地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050800'            THEN '注册地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '050900'            THEN '经营地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = '051000'            THEN '其他地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = 'W'                 THEN '房产地址'
--    WHEN COALESCE(adr.addr_typ, d.bil_adr_typ_cd, adr1.addr_typ, adr2.addr_typ, adr3.addr_typ) = 'B'                 THEN '公司地址'
--    ELSE ''
--  END                                                                            AS 地址类型
FROM    (
            SELECT  DISTINCT col_1
            FROM    qbi_file_20241204_11_16_44_0
            WHERE   pt <> ''
        ) a
LEFT JOIN    (
                 SELECT  crd.busi_ctr_id
                         ,crd.cr_crd_card_nbr
                         ,crd.cr_crd_act_id --信用卡账号
                         ,crd.cst_id
                         ,'借款人' AS cst_role
                 FROM    edw.dim_bus_crd_cr_crd_inf_dd crd ---信用卡卡片信息
                 WHERE   crd.dt = '@@{yyyyMMdd}'
                 UNION ALL
                 SELECT  crd.busi_ctr_id
                         ,crd.cr_crd_card_nbr
                         ,crd.cr_crd_act_id --信用卡账号
                         ,gr.grnt_gds_id AS cst_id --保证人编号
                         ,'担保人'          AS cst_role
                 FROM    edw.dim_bus_crd_cr_crd_inf_dd crd ---信用卡卡片信息
                 LEFT JOIN    edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd gr --主合同、担保合同、担保物关系
                 ON      crd.busi_ctr_id = gr.ctr_serno
                 AND     gr.dt = '@@{yyyyMMdd}'
                 AND     gr.grnt_gds_typ_cd = '1' --保证人
                 WHERE   crd.dt = '@@{yyyyMMdd}'
                 AND     coalesce(crd.busi_ctr_id, '') <> ''
                 AND     gr.grnt_gds_id IS NOT NULL
             ) b
ON      a.col_1 = b.cr_crd_card_nbr
LEFT JOIN    edw.dim_bus_crd_cr_crd_act_inf_dd d --信用卡账户信息,取账单地址,地址类型，BIL_ADR_TYP_CD F:户籍，H：家庭，B:公司，W:房产
ON      b.cr_crd_act_id = d.cr_crd_act_id --信用卡账户
AND     d.dt = '@@{yyyyMMdd}'
AND     d.bil_adr <> 'NONO' --账单地址不能为&ldquo;NONO&rdquo;
LEFT JOIN    edw.loan_cst_ctc_addr adr --信贷客户联系地址
ON      b.cst_id = adr.cst_id
AND     adr.dt = '@@{yyyyMMdd}'
AND     adr.lgl_imt_arrv_addr_ind = 1 --法律文书
AND     adr.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_cst_ctc_addr adr1 --信贷客户联系地址
ON      b.cst_id = adr1.cst_id
AND     adr1.dt = '@@{yyyyMMdd}'
AND     adr1.main_addr_ind = 1 --主地址标识
AND     adr1.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_cst_ctc_addr adr2 --信贷客户联系地址
ON      b.cst_id = adr2.cst_id
AND     adr2.dt = '@@{yyyyMMdd}'
AND     adr2.addr_typ = '050200' --家庭或居住地址
AND     adr2.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_cst_ctc_addr adr3 --信贷客户联系地址
ON      b.cst_id = adr3.cst_id
AND     adr3.dt = '@@{yyyyMMdd}'
AND     adr3.addr_typ = '050100' --户籍地址
AND     adr2.del_ind = 0 --删除标识
LEFT JOIN    edw.dws_cst_bas_inf_dd cst
ON      b.cst_id = cst.cst_id
AND     cst.dt = '@@{yyyyMMdd}'
ORDER BY a.col_1 , b.busi_ctr_id , b.cst_role;
**01-数据需求_保全_D1211_梁世鹏_公司化客户的催收痕迹查询.sql
-- SJ2024121181
-- 为统计业务公司化，客户经理催收的参与程度，需对公司化客户的催收痕迹进行查询。
-- 数据口径：
-- 1、催收日期处于剥离日期~2024年11月30日期间催收痕迹数据。
-- 2、附件清单内客户：
-- 3、催收方式剔除：催收短信、催收电子邮件、电话录音催收、客服中心一组电话催收、AI催收、客户中心二组电话催收、其他。

-- 内部催收人员、内部催收人员工号、催收方式、催收日期。



DROP TABLE IF EXISTS tmp_sjxq_SJ2024121181 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024121181 AS
SELECT  DISTINCT a . *
                 ,T2.coln_usr_no AS 内部催收人员工号
                 ,T2.coln_user   AS 内部催收人员
                 ,CASE
                    WHEN T2.coln_way = '20' THEN '债务拆分'
                    WHEN T2.coln_way = '14' THEN 'AI催收'
                    WHEN T2.coln_way = '07' THEN '诉讼'
                    WHEN T2.coln_way = '17' THEN '分期还款'
                    WHEN T2.coln_way = '99' THEN '其他'
                    WHEN T2.coln_way = '03' THEN '催收电子邮件'
                    WHEN T2.coln_way = '13' THEN '律师函催收'
                    WHEN T2.coln_way = '04' THEN '电话录音催收'
                    WHEN T2.coln_way = '19' THEN '重组'
                    WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'
                    WHEN T2.coln_way = '08' THEN '公安立案'
                    WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'
                    WHEN T2.coln_way = '18' THEN '利息减免'
                    WHEN T2.coln_way = '02' THEN '催收短信'
                    WHEN T2.coln_way = '11' THEN '现场催收'
                    WHEN T2.coln_way = '01' THEN '催收通知书'
                    WHEN T2.coln_way = '16' THEN '催收函'
                    WHEN T2.coln_way = '09' THEN '报纸公告'
                    WHEN T2.coln_way = '06' THEN '上门催收'
                    ELSE ''
                  END            AS 催收方式
                 ,T2.coln_date   AS 催收日期
FROM    (
            SELECT  DISTINCT a.col_1  AS 剥离分行
                             ,a.col_2 AS 客户号
                             ,a.col_3 AS 剥离日期
            FROM    qbi_file_20241212_11_44_38_0 a
            WHERE   a.pt <> ''
        ) a
LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹
ON      a.客户号 = T2.cust_no
AND     T2.dt = '@@{yyyyMMdd}'
AND     REPLACE(substr(T2.coln_date, 1, 10), '-', '') BETWEEN a.剥离日期 AND '20241130'
AND     T2.coln_way NOT IN ( '02' , '03' , '04' , '05' , '14' , '15' , '99' ) --剔除：催收短信、催收电子邮件、电话录音催收、客服中心一组电话催收、AI催收、客户中心二组电话催收、其他;
order by a.剥离分行,a.客户号,a.剥离日期
**01-数据需求_其他_D0109_钟佩琪_客户经理存款付息率.sql
--
-- SJ2025010886
--2024年12月台州分行客户经理存款付息率数据

-- SELECT * FROM tmp_dep_zpq_SJ2025010886 WHERE 产品名称 like '%一本通%'

DROP TABLE IF EXISTS tmp_dep_zpq_SJ2025010886 PURGE;

CREATE TABLE IF NOT EXISTS tmp_dep_zpq_SJ2025010886 AS
SELECT  t.acg_dt 会计日期
        ,t.org_id 机构号
        ,t.org_nm 机构名称
        ,t.mng_id 客户经理工号
        ,t.mng_nm 客户经理名称
        ,SUM(AGG_BAL) / 10000.00       AS 累计余额
        ,SUM(AVG_BAL) / 10000.00       AS 日均余额
        ,SUM(FTP_INT_AJUST) / 10000.00 AS ftp利息累计
        ,SUM(FTP_PROFIT) / 10000.00    AS ftp营业收入
        ,SUM(ACC_INT_AJUST) / 10000.00 AS 对客利息累计
        ,CASE
           WHEN sum(t.agg_bal) = 0 THEN 0
           ELSE sum(t.acc_int_ajust) / sum(t.agg_bal) * t.year_dt --付息率=对客利息累计/累计余额*天数
         END                           AS 存款付息率
        --  ,t.product_type 产品类型
        ,t.product_name 产品名称
FROM    app_rpt.fct_dep_loan_rat_strc_moni_mng t --存贷款利率结构监测报表_客户经理
WHERE   t.dt = '20241231'
AND     t.org_id LIKE '3301%' --台州分行
AND     t.FLAG = '02' --月
AND     t.PRODUCT_TYPE IN ( '1' , '2' ,'3', '4' , '6' , '7' , '8' , '9' , '10' , '11' , '12' , '13' , '14' ,'15', '16' , '17' , '18' , '19' , '20' , '21' , '22' , '23' , '24' , '25' , '26' )
GROUP BY t.acg_dt,t.org_id , t.org_nm , t.mng_id , t.mng_nm , t.year_dt , t.product_name
**01-数据需求_其他_D0218_CRM_马郡晗_营销活动相关清单数据_用于客户营销成本测算分析.sql
-- SJ2025021821

-- 采集2024.1.1-2025.2.18召开的营销活动相关清单数据，用于客户营销成本测算分析。

-- 20002.营销活动监测清单

-- 字段：活动ID、活动创建时间、活动名称、活动类型、活动类别、所属分行、所属支行、所属团队、创建人姓名、创建人工号、对应社区、对应系列活动名称、
-- 活动成本、活动覆盖客户数、活动签到客户数、活动发奖客户数、活动期新客建档客户数、活动期新增正式客户数、活动新增有效客户数、
-- 发奖客户新增存款余额、发奖客户新增贷款户数、发奖客户新增授信金额、发奖客户新增用信余额



---45108条数据
DROP TABLE IF EXISTS tmp_sjxq_SJ2025021821 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021821 AS
SELECT  a.id                                                                                            AS 活动ID
        ,a.createtime                                                                                   AS 活动创建时间
        ,a.activity_name                                                                                AS 活动名称
        -- ,a.activity_type                                                                     AS 活动类型 ---on_line_act，
        ,decode(a.on_line_act, '1', '线上', '2', '线下', '3', '全民营销', '4', '白名单', '5', '定向推送', '6', '营销用例') AS 活动类型
        --活动类别1产品营销类2客户维护类3品牌推广类(字段全为空值，请不要使用)，只有线下活动才有相应的活动类别
        ,decode(a.act_category, '1', '产品营销类', '2', '客户维护类', '3', '品牌推广类')                               AS 活动类别
        -- ,a.status                                                                                       AS 营销状态
        ,C.BRC_ORG_ID                                                                                   AS 分行机构编号
        ,C.BRC_ORG_NM                                                                                   AS 分行机构名称
        ,C.SBR_ORG_ID                                                                                   AS 支行机构编号
        ,C.SBR_ORG_NM                                                                                   AS 支行机构名称
        ,C.TEM_ORG_ID                                                                                   AS 团队机构编号
        ,C.TEM_ORG_NM                                                                                   AS 团队机构名称
        ,C.ORG_ID                                                                                       AS 机构号
        ,C.ORG_NM                                                                                       AS 机构名称
        ,A.CREATEUSERNAME                                                                               AS 创建人工号
        ,B.EMPE_NM                                                                                      AS 创建人姓名
        ,A.COMMUNITY_CODE                                                                               AS 社区编码
        ,F.CMNT_NM                                                                                      AS 社区名称
        -- ,a.community_flag                                                                            AS 社区活动标志
        ,A.community_name                                                                               AS 社区活动名称
        ,sum(J1.nm * J1.prize_price) + coalesce(J2.prize, 0) + (
                                                               CASE
                                                                 WHEN A.ON_LINE_ACT = '2' AND A.award_flag = '1' THEN ( cast(J3.award_amount as decimal)* J3.award_num )
                                                                 ELSE 0
                                                               END
        )                                                                                               AS 活动成本
        ,COUNT(DISTINCT CASE
                          WHEN H.IS_ATTEND > 0 THEN H.CST_ID
                        END)                                                                            AS 活动签到客户数
        ,count(DISTINCT J.account_id) + count(DISTINCT CASE
                                                         WHEN A.ON_LINE_ACT = '4' THEN I.cst_id
                                                       END)                                             AS 活动发奖客户数
        ,( COUNT(DISTINCT CASE
                            WHEN H.IS_ATTEND > 0 THEN H.CST_ID
                          END) ) + ( count(DISTINCT J.account_id) + count(DISTINCT CASE
                                                                                     WHEN A.ON_LINE_ACT = '4' THEN I.cst_id
                                                                                   END) )               AS 活动覆盖客户数
        ,K.actv_frs_file_dep                                                                            AS 活动新增建档客户数
        -- ,''                                                                                             AS 活动期新增正式客户数
        ,K.actv_vld_cst_nbr_incr                                                                        AS 活动监测期间新增有效户数量
        ,G.act_vld_cst_spv_qty_bfr                                                                      AS 有效户户数较监测开始前新增
        ,G.ACT_NEW_CST_DEP_BAL                                                                          AS 活动期间新开户存款余额
        ,G.act_inc_loan_cst_qty                                                                         AS 活动期间新增贷款户数
        ,G.act_inc_loan_lmt_amt                                                                         AS 活动期间新增授信金额
        ,G.act_inc_loan_lmt_use_amt                                                                     AS 活动期间新增用信余额
FROM    edw.qmyx_marketing_base a
LEFT JOIN    edw.DWS_HR_EMPE_INF_DD B --员工
ON      A.CREATEUSERNAME = B.EMPE_ID
AND     B.DT = '20250218'
LEFT JOIN    edw.DIM_HR_ORG_MNG_ORG_TREE_DD C --机构
ON      A.ACTIVITY_INITIAL_ORG = C.ORG_ID
AND     C.DT = '20250218'
LEFT JOIN    edw.DIM_CST_MNG_CMNT_INF_DD F --社区信息
ON      A.COMMUNITY_CODE = F.CMNT_ENC
AND     F.DT = '20250218'
LEFT JOIN    edw.qmyx_act_x_cst_record H --签到客户记录
ON      A.id = H.act_id
AND     H.dt = '20250218'
LEFT JOIN    edw.qmyx_tk_interests_customer_list I
ON      A.id = I.act_id
AND     I.dt = '20250218'
AND     I.SEND_STATUS = '1'
 --券发放状态 0-未发放,1-已发放,2-已作废
--取中奖客户
LEFT JOIN    (
                 SELECT  t1.activity_code --活动码
                         ,t3.activity_name --活动名称
                         ,t3.id --活动编号
                         ,t1.account_id
                 FROM    edw.qmyx_activity_lottery_record t1 --
                 LEFT JOIN    edw.qmyx_activity t3 --活动盒子基础信息
                 ON      t1.activity_code = t3.activity_code
                 AND     t3.dt = '20250218'
                 WHERE   t1.dt = '20250218'
                  --是否中奖 Y是 N否
                 AND     t1.is_winning = 'Y'
             ) J
ON      a.id = J.id
--自有奖品
LEFT JOIN    (
                 SELECT  t1.activity_code --活动码
                         ,t3.activity_name --活动名称
                         ,t3.id                AS act_id  --活动编号
                         --  ,t1.account_id       AS account_id --用户id
                         ,t2.prize_code --奖品code
                         ,t2.prize_name  --奖品名称
                         --一条记录对应一个奖品
                         ,count(t2.prize_code) AS nm --中奖数量
                         ,max(t2.prize_price)  AS prize_price --自有奖品单价
                 FROM    edw.qmyx_activity_lottery_record t1 --抽奖记录
                 LEFT JOIN    edw.qmyx_prize_list t2 --自有奖品表
                 ON      t1.prize_code = t2.prize_code
                 AND     t2.dt = '20250218'
                 LEFT JOIN    edw.qmyx_activity t3 --活动盒子基础信息
                 ON      t1.activity_code = t3.activity_code
                 AND     t3.dt = '20250218'
                 WHERE   t1.dt = '20250218'
                 AND     t1.is_winning = 'Y' --是否中奖 Y是 N否
                 AND     t3.activity_status NOT IN ( '0' , '1' , '2' , '3' , '9' ) --,01239  ,0-草稿 1-待审批 10-产效跟踪中 2-待执行 3-审批不通过 4-执行中 5-已结束 6-已终止 8-提前终止 9-审批超时
                 AND     t2.own_small_type IN ( '1' ) --权益类不用管，1-自有,自有产品才有单价
                 GROUP BY t1.activity_code , t3.activity_name , t3.id , t2.prize_code , t2.prize_name
             ) J1
ON      A.id = J1.act_id
--积分
LEFT JOIN    (
                 SELECT  t1.activity_code --活动码
                         ,t3.activity_name --活动名称
                         ,t3.id                                  AS act_id  --活动编号
                         --  ,t1.account_id       AS account_id --用户id
                         --  ,t2.prize_code --奖品code
                         --  ,t2.prize_name  --奖品名称
                         --一条记录对应一个奖品
                         ,count(t2.prize_code)                   AS nm --中奖数量
                         ,CAST(sum(t2.point_value) AS INT) / 100 AS prize --积分价值
                 FROM    edw.qmyx_activity_lottery_record t1 --抽奖记录
                 LEFT JOIN    edw.qmyx_prize_list t2 --自有奖品表
                 ON      t1.prize_code = t2.prize_code
                 AND     t2.dt = '20250218'
                 LEFT JOIN    edw.qmyx_activity t3 --活动盒子基础信息
                 ON      t1.activity_code = t3.activity_code
                 AND     t3.dt = '20250218'
                 WHERE   t1.dt = '20250218'
                 AND     t1.is_winning = 'Y' --是否中奖 Y是 N否
                 AND     t3.activity_status NOT IN ( '0' , '1' , '2' , '3' , '9' ) --,01239  ,0-草稿 1-待审批 10-产效跟踪中 2-待执行 3-审批不通过 4-执行中 5-已结束 6-已终止 8-提前终止 9-审批超时
                 AND     t2.own_small_type IN ( '2' ) --积分按照积分值/100汇算
                 GROUP BY t1.activity_code , t3.activity_name , t3.id
             ) J2 --抽奖记录  --用户维度，不是活动维度
ON      A.id = J2.act_id
--立减金活动
LEFT JOIN    edw.QMYX_SERIES_ACTIVITY_AWARD J3  ------系列活动奖励明细表
ON      A.id = J3.sys_act_id
and J3.dt= '20250218'
LEFT JOIN    app_rpt.fct_mrkt_evnt_moni_dtl G --参考报表20002：营销活动监测清单
ON      A.id = G.act_id
AND     g.dt = '20250218'
LEFT JOIN    app_yxpt.adm_papp_yxzx_actv_cmpn_actv_ind_smy_dd K
ON      A.id = K.actv_id
AND     K.dt = '20250218'
WHERE   a.dt = '20250218'
AND     REPLACE(substr(a.createtime, 1, 10), '-', '') >= '20240101'
AND     REPLACE(substr(a.createtime, 1, 10), '-', '') <= '20250218'
AND     a.status NOT IN ( '0' , '2' , '1' , '3' , '9' ) --,01239  ,0-草稿 1-待审批 10-产效跟踪中 2-待执行 3-审批不通过 4-执行中 5-已结束 6-已终止 8-提前终止 9-审批超时
GROUP BY a.id , a.createtime , a.activity_name , a.on_line_act , a.act_category , C.BRC_ORG_ID , C.BRC_ORG_NM , C.SBR_ORG_ID , C.SBR_ORG_NM , C.TEM_ORG_ID , C.TEM_ORG_NM , C.ORG_ID , C.ORG_NM , A.CREATEUSERNAME , B.EMPE_NM , A.COMMUNITY_CODE , F.CMNT_NM , A.community_name , K.actv_frs_file_dep , K.actv_vld_cst_nbr_incr , G.act_vld_cst_spv_qty_bfr , G.ACT_NEW_CST_DEP_BAL , G.act_inc_loan_cst_qty , G.act_inc_loan_lmt_amt , G.act_inc_loan_lmt_use_amt , J2.prize , J3.award_amount , J3.award_num
,A.award_flag




-- 活动成本为统计实际发放奖励成本，即发放奖品数量*单价+积分值汇算+立减金面值*数量

-- 领奖记录表：ACTIVITY_LOTTERY_RECORD WHERE IS_WINNING='Y';   --edw.qmyx_activity_lottery_record   --抽奖记录，是否中奖 Y是 N否
-- 奖品信息表：PRIZE_LIST;  OWN_SMALL_TYPE in ('1','2')  1-基线自有奖品、2-积分  --edw.qmyx_prize_list  --自有奖品表

-- 活动覆盖客户数：活动发奖客户数与活动签到客户数 去重  ---去重相加

-- 活动签到客户数：SELECT * FROM ACT_X_CST_RECORD WHERE IS_ATTEND>0;    --edw.qmyx_act_x_cst_record

-- 活动发奖客户数：
-- 定向发放优惠券活动 使用 MARKETING_BASE ON_LINE_ACT='4' 获取活动号，关联  TK_INTERESTS_CUSTOMER_LIST ， SEND_STATUS='1'   --edw.qmyx_tk_interests_customer_list   ---券发放状态 0-未发放,1-已发放,2-已作废
-- 其他活动： SELECT * FROM ACTIVITY_LOTTERY_RECORD WHERE IS_WINNING='Y';

-- 活动期新客建档客户数   --app_yxpt.adm_papp_yxzx_actv_cmpn_actv_ind_smy_dd    actv_frs_file_dep
-- 活动期新增正式客户数  --正式客户口径是啥？
-- 活动新增有效客户数   --app_yxpt.adm_papp_yxzx_actv_cmpn_actv_ind_smy_dd     actv_vld_cst_nbr_incr


-- 发奖客户新增存款余额  --
-- 发奖客户新增贷款户数   --
-- 发奖客户新增授信金额   --
-- 发奖客户新增用信余额
-- app_rpt.fct_mrkt_evnt_moni_dtl   --营销活动监测清单
-- ;

-- 立减金活动是线下活动的一种
-- select * from marketing_base where ON_LINE_ACT='2' and award_flag='1'   --是否赠送奖励，1是，0否
-- 区分是否是立减金活动
-- 用marketing_base  id关联 SERIES_ACTIVITY_AWARD.SYS_ACT_ID
-- AWARD_AMOUNT 这个字段是卡券面值
-- 对应的发奖记录还是在activity_lottery_record这个表里。  --edw.qmyx_activity_lottery_record

;

SELECT * FROM edw.QMYX_SERIES_ACTIVITY_AWARD  WHERE dt='20250218'

desc edw.QMYX_SERIES_ACTIVITY_AWARD   --系列活动奖励明细表
 id              | string     |       | 主键                                          |
| sys_act_id      | string     | 1     | 关联系列活动ID                                    |
| award_type      | string     |       | 奖励类型，1权益，2实物，3积分                            |
| award_prize_code | string     |       | 奖励编码                                        |
| award_prize_name | string     |       | 奖励名称                                        |
| award_amount    | string     |       | 面值                                          |
| award_num       | decimal    |       | 发放数量                                        |
| award_all_num   | decimal    |       | 权益可发放库存                                     |
| account         | string     |       | 所属账号                                        |
| business_class  | string     |       | 业务模块                                        |
| serial_num      | string     |       | 充值序列号                                       |
| validity_time_start | string     |       | 发放有效期起                                      |
| validity_time_end | string     |       | 发放有效期止                                      |
| instruction     | string     |       | 权益使用说明                                      |
| valid_calc_method_sy | string     |       | 有效期计算方式使用规则                                 |
| valid_day       | string     |       | 领取后天数可用                                     |
| award_url_num   | decimal    |       | 生成二维码数量                                     |
| org_code        | string     |       | 机构号                                         |
| act_hierarchy   | string     |       | 机构层级，0总行，1分行，2支行                            |
| award_send_num  | decimal    |       | 已使用数量                                       |
| award_remain_num | decimal    |       | 剩余数量                                        |
| status          | string     |       | 状态0未失效，1已失效，2已领取                            |
| modify_status   | string     |       | 修改标志，1修改，0未修改                               |
| consume_num     | decimal    |       | 核销数量                                        |
**01-数据需求_其他_D0219_非金项目组_史云_泰惠收商户基本信息.sql
-- SJ2025021751
-- 营业执照号、进件人工号、进件人姓名、维护人工号、维护人姓名
--
DROP TABLE IF EXISTS tmp_sjxq_SJ2025021751 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021751 AS
SELECT  DISTINCT a.col_1        AS 商户号
                 ,a.col_2       AS 商户名称
                 ,a.col_3       AS 机构名称
                 ,a.col_4       AS 参与标志
                 ,a.col_5       AS 参与日期
                 ,a.col_6       AS 分行机构名称
                 ,a.col_7       AS 支行机构名称
                 ,b.bus_lcn_nbr AS 营业执照号
                 --    ,case when b.bus_lcn_nbr is not null or b.bus_lcn_nbr <>'' then b.bus_lcn_nbr ELSE c.USCC  end  as 营业执照号
                 ,b.hdl_mnl_id  AS 经办人工号
                 ,b.opr_nm      AS 经办人姓名
                 ,b.mgr_id      AS 客户经理工号
                 ,b.mgr_nm      AS 管护客户经理名称
FROM    qbi_file_20250219_15_41_51_0 a
LEFT JOIN    edw.dim_bus_chnl_ths_mch_inf_dd b
ON      a.col_1 = b.mch_id
AND     b.dt = '20250218'
-- left join tmp_wz_jczb_SJ2025011641_fr c
-- on b.lgp_doc_nbr=c.by_qry_psn_doc_nbr
WHERE   pt <> '';




--个人工商
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wz_jczb_SJ2025011641_fr PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_wz_jczb_SJ2025011641_fr AS
-- SELECT  distinct B1.*
-- FROM    (
--             SELECT  A1.*
--                     ,RANK() OVER ( PARTITION BY A1.by_qry_psn_doc_nbr  ORDER BY substr(replace(DAT_INS_TM,'-',''),1,8) DESC ) AS RN   -- 取某个证件号最新一次（精确到天）的查询信息
--             FROM    (
--                         SELECT  CST_ID              AS CST_ID
--                                 ,BY_QRY_PSN_NM      AS BY_QRY_PSN_NM
--                                 ,by_qry_psn_doc_nbr AS by_qry_psn_doc_nbr  --证件号码
--                                 ,DAT_INS_TM         AS DAT_INS_TM
--                                 ,USCC               AS USCC   --统一社会信用代码
--                                 ,entp_nm            AS entp_nm
--                                 ,ENTP_TYP           AS ENTP_TYP
--                                 ,ENTP_STS           AS ENTP_STS
--                                 ,PVC                AS PVC
--                         FROM    edw.DIM_CST_OUT_GEB_IDV_PPL_LGP_INF_DD --工商个人人员法人信息事实表新
--                         WHERE   DT = '20241231'
--                         AND     by_qry_psn_doc_nbr <> ''
--                         and (coalesce(uscc,'')<>'' or coalesce(entp_id,'') <>'' or coalesce(entp_nm,'')<>'')
--                         UNION
--                         SELECT  CST_ID       AS CST_ID
--                                 ,CST_NM      AS BY_QRY_PSN_NM
--                                 ,doc_nbr     AS by_qry_psn_doc_nbr
--                                 ,QRY_TM      AS DAT_INS_TM
--                                 ,CSLD_CRD_CD AS USCC
--                                 ,entp_nm     AS entp_nm
--                                 ,ENTP_TYP    AS ENTP_TYP
--                                 ,ENTP_STS    AS ENTP_STS
--                                 ,PVC         AS PVC
--                         FROM    edw.DIM_CST_OUT_GEB_IDV_LGP_INF_DD  --工商个人人员法人信息事实表老
--                         -- WHERE   DT = MAX_PT('${odps_edw}.DIM_CST_OUT_GEB_IDV_LGP_INF_DD');
--                         WHERE   DT = '20241231'
--                         AND     doc_nbr <> ''
--                         and (coalesce(csld_crd_cd,'')<>'' or coalesce(entp_id,'')<>'' or coalesce(entp_nm,'')<>'')
--                     ) A1
--         ) B1
-- WHERE   B1.RN = 1;
**01-数据需求_其他_D0313_徐微_活动签到用户明细.sql
-- SJ20250312101
-- 签到用户明细（用户号，能取到泰隆生活用户号优先取用户号）

-- 月份 用户号 当月累计签到天数 当月签到次数 当月累计获得积分奖励
DROP TABLE IF EXISTS tmp_sjxq_SJ20250312101 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250312101 AS
SELECT  substr(t1.gmt_created, 1, 7)    AS 月份
        ,t1.activity_code 活动码
        ,t1.activity_name 活动名称
        ,t1.account_id 用户ID
        -- ,t1.prize_code 奖品码
        -- ,t1.prize_name 奖品名称
        ,count(DISTINCT t1.gmt_created) AS 当月累计签到天数
        ,count(account_id)              AS 当月签到次数
        ,sum(t2.point_value)          AS 当月累计获得积分奖励
FROM    edw.qmyx_activity_lottery_record t1
LEFT JOIN    edw.qmyx_prize_list t2 --自有奖品表，一个活动对应多个奖品，奖品编号唯一
ON      t1.prize_code = t2.prize_code
AND     t2.dt = '20250228'
WHERE   t1.dt = '20250228'
AND     t1.is_winning = 'Y'
and     t1.activity_name rlike '天天签到赚积分'
AND     REPLACE(substr(t1.gmt_created, 1, 10), '-', '') BETWEEN '20250101' AND '20250228'
GROUP BY substr(t1.gmt_created, 1, 7) , t1.activity_code , t1.activity_name,t1.account_id
;

-- SELECT * FROM tmp_sjxq_SJ20250312101 WHERE 用户ID='1000015968';
**01-数据需求_其他_D0317_总行企划_王起晨_全行人员数据.sql
-- SJ2025031346
-- 我行已采购稿定设计SAAS平台，面向全行员工开放，解决员工营销物料用不起、找不到、用得少等关键问题，因此需在稿定系统录入员工信息，包括姓名、组织机构（二级部门，脱敏后外发）
-- 截至2025年3月12日的全行所有正式员工信息（包含一类派遣）
-- 姓名、工号（不外发）、组织机构（二级部门，脱敏后外发）、用工状态（不外发）、用工类型（不外发）等


-- SELECT * FROM emp_sjxq_SJ2025031346 where 离职日期='' and 用工状态='已上岗' and 员工状态='在职'  ORDER BY 分行     ---12671条数据
;

--员工状态判断员工正常在职时，离职日期赋空，离职日期一起看。离职日期为空，且用工状态为已上岗，且员工状态为在职
DROP TABLE IF EXISTS emp_sjxq_SJ2025031346 PURGE;

CREATE TABLE IF NOT EXISTS emp_sjxq_SJ2025031346 AS
SELECT t.org_id 机构编号
        ,org.brc_org_nm 分行
        ,org.sbr_org_nm 支行
        ,t1.org_nm 组织机构
        ,t.empe_id 员工工号
        ,t.empe_nm 员工姓名
        -- ,t.lbr_tp_sts 用工状态代码
        ,t21.cd_val_dscr 用工状态
        -- ,t.lbr_typ_cd 用工类型代码
        ,t22.cd_val_dscr 用工类型
        -- ,t.empe_actv_sts_cd 员工在职状态代码
        ,t23.cd_val_dscr 员工在职状态
        -- ,t.empe_sts_cd 员工状态代码
        ,t24.cd_val_dscr 员工状态
        ,t.quit_dt 离职日期
FROM    edw.dws_hr_empe_inf_dd t --用工状态和员工状态取的
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t1
ON      t.org_id = t1.org_id
AND     t1.dt = '20250312'
LEFT JOIN    edw.dwd_code_library_dd t21
ON      t.lbr_tp_sts = t21.cd_val
AND     t21.tbl_nm = upper('dws_hr_empe_inf_dd')
AND     t21.fld_nm = upper('lbr_tp_sts')
AND     t21.dt = '20250312'
LEFT JOIN    edw.dwd_code_library_dd t22
ON      t.lbr_typ_cd = t22.cd_val
AND     t22.tbl_nm = upper('dws_hr_empe_inf_dd')
AND     t22.fld_nm = upper('lbr_typ_cd')
AND     t22.dt = '20250312'
LEFT JOIN    edw.dwd_code_library_dd t23
ON      t.empe_actv_sts_cd = t23.cd_val
AND     t23.tbl_nm = upper('dim_hr_empe_bas_inf_dd')
AND     t23.fld_nm = upper('EMPE_ACTV_STS_CD')
AND     t23.dt = '20250312'
LEFT JOIN    edw.dwd_code_library_dd t24
ON      t.empe_actv_sts_cd = t24.cd_val
AND     t24.tbl_nm = upper('dim_hr_empe_org_inf_dd')
AND     t24.fld_nm = upper('empe_sts_cd')
AND     t24.dt = '20250312'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      t.org_id = org.org_id
AND     org.dt = '20250312'
WHERE   t.dt = '20250312'
and  t21.cd_val_dscr='已上岗'
and t24.cd_val_dscr='在职'
and t.quit_dt=''
ORDER BY org.brc_org_nm,org.sbr_org_nm,t1.org_nm
;





SELECT * FROM edw.dwd_code_library_dd WHERE dt='20250312' and tbl_nm=upper('dim_hr_empe_bas_inf_dd') and fld_nm=upper('empe_sts_cd');    --用工状态

SELECT * FROM edw.dwd_code_library_dd WHERE dt='20250312' and tbl_nm=upper('edw.dim_hr_empe_srv_inf_dd') and fld_nm=upper('lbr_typ_cd');    --用工类型



SELECT * FROM edw.dwd_code_library_dd WHERE dt='20250312' and tbl_nm=upper('dim_hr_empe_org_inf_dd') and fld_nm=upper('empe_sts_cd');    --员工状态代码
**01-数据需求_其他_D1009_金鑫_查询中介数据.sql
--	结果：无数据
-- SJ2024100956
--有一中介的手机号，希望从各渠道去看看是不是能从该手机号知道其对应人员的证件号或姓名。因涉及敏感信息，自行无法查询。

--如存在，申请该客户证件号、姓名信息。

SELECT  *
FROM    edw.nout_dx_personalcert_main T  --电信三网实名认证主表
WHERE   T.dpm_mobeil = '17857521330'
AND     T.dt <= '@@{yyyyMMdd}'
;

SELECT MIN(dt) FROM  edw.nout_dx_personalcert_main
**01-数据需求_其他_D1023_崔圆圆_账户业务信息查询.sql
--无交易记录
-- 户名：王小富，客户号1004072042
--其他银行账号：622909357385900011；966666353494343619
-- 自20080101至20141231，在我行办理业务的信息（包括：日期  网点号  流水号  工号  金额）


SELECT a.cst_act_id 账号
      ,a.act_nm 户名
      ,a.dep_act_id 存款账号
      ,a.trx_dt 交易日期
      ,a.trx_tm 交易时间
      ,a.trx_bus_org 交易营业机构
      ,a.tlr_srl_nbr 柜员流水号
      ,a.opr_tlr 操作柜员
      ,a.trx_amt 交易金额
      ,a.smr_dscr 摘要
FROM edw.dwd_bus_dep_bal_chg_dtl_di a  --存款账户余额发生明细
WHERE a.dt<='20141231'
and a.dt>='20080101'
and a.cnt_pty_cst_act_id in('622909357385900011','966666353494343619')
-- and a.cnt_pty_sub_act_seq_nbr in ('622909357385900011','966666353494343619')
;
**01-数据需求_其他_D1028_庞琴芳_客户随贷通交易明细.sql
--SJ2024102881
-- 烦清帮助提取单个客户的随贷通交易明细，包含客户合同生效后的每笔借据的贷款发放日期、还款日期、本金、利息，谢谢
-- 客户号：1689038551 ；客户姓名：丁锦鑫；  卡号：6214809801004884099；合同生效日期：2023-02-20



DROP TABLE IF EXISTS tmp_sjxq_pqf_SJ2024102881 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_pqf_SJ2024102881 AS
SELECT  a.cst_id 客户号
        ,a.cst_nm 客户姓名
        ,a.dbil_id 借据号
        ,a.LVE_ACT_BGN_DT 发放日期
        ,a.amt 借据金额
        ,a.PRCP_BAL 本金余额
        ,b.shd_pay_dt 应还日期
        ,b.trx_dt 交易日期
        ,b.cur_trm 本期期数
        -- ,b.rpay_sts_cd 还款状态
        ,b.prcp_amt 本金发生额
        -- ,b.prcp 本金
        ,b.rcv_acr_intr_amt 应收应计利息发生额
        -- ,b.rcv_acr_intr 应收应计利息
        -- ,b.ini_intr 初始利息
        ,b.evt_cmt 事件说明
        ,b.smr 摘要
        -- ,b.loan_act 贷款账号
        ,b.rpay_act_id 还款账号
FROM    edw.DIM_BUS_LOAN_DBIL_INF_DD a
LEFT JOIN    edw.dwd_bus_loan_trm_pmt_trx_dtl_di b --贷款期供交易明细
ON      a.dbil_id = b.dbil_id
AND     b.dt >= '20230220'
WHERE   a.dt = '@@{yyyyMMdd}'
--随贷通卡号对应的主借据
AND     a.dbil_id IN (
                         SELECT  DISTINCT jiejuhao
                         FROM    edw.core_kclb_dkedjj
                         WHERE   dt = '@@{yyyyMMdd}'
                         AND     kehuzhao = '6214809801004884099'
                     )
;
**01-数据需求_其他_D1119_陈林平_合作发展部_合作项目客群质量分析.sql
-- SJ20241114106
--用于开展合作项目客群质量分析
--取数范围：乐山银行、广州银行股份有限公司、泉州银行、裕民银行、潮阳农商行多法人信贷系统合同客户；合同起始日2022年1月1日到2024年10月31日范围内的业务。

--字段：项目	经办机构	合同流水号	客户编号	客户名称	业务品种	贷款金额	贷款余额	申请日	到期日	执行月利率
-- 担保方式	还款方式	合同状态	行业投向一级大类	行业投向二级大类	行业投向小类	营销标签	发生类型	经办客户经理	管户客户经理
-- 预评估结果	资产负债率	收入合计	银行负债	总负债金额
-- 担保人名称1	与借款人关系	担保作用	担保人名称2	与借款人关系	担保作用	担保人名称3	与借款人关系	担保作用


--经沟通，取老信贷的数据，时间到20240719

--临时表1 征信贷款信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hzkh_SJ20241114106_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hzkh_SJ20241114106_01 AS
SELECT
     T1.cst_id
	 ,T1.report_id
	 ,T1.贷款总余额  AS 银行负债
     ,ROW_NUMBER() OVER(PARTITION BY T1.cst_id ORDER BY T1.report_id DESC  ) AS RN
FROM  (
SELECT  A1.dt                AS acct_dt
        ,A1.cst_id
        ,A1.report_id
        ,SUM(ctr_bal)        AS 贷款总余额
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT = '20240719'
AND      A1.cls_dt	 >= A1.DT
AND      A1.dtrb_org_typ_cd IN ( '11' , '12' , '14' , '15' )   -- 发放机构类型代码为( '11' , '12' , '14' , '15' )----银行，
GROUP BY A1.dt , A1.cst_id , A1.report_id
UNION ALL
SELECT  A1.dt                AS acct_dt
        ,A1.cst_id
        ,A1.report_id
        ,SUM(loan_bal)       AS 贷款总余额
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
WHERE   A1.DT = '20240719'
AND      A1.cls_dt	 >= A1.DT
AND      A1.dtrb_org_typ_cd IN ( '11' , '12' , '14' , '15' )   --银行
GROUP BY A1.dt , A1.cst_id , A1.report_id
 ) T1
 ;





--临时表2 担保信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hzkh_SJ20241114106_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hzkh_SJ20241114106_02 AS
SELECT  T1.SERIALNO --合同流水号
        ,COALESCE(T5.OWNERID, '')                                                                 AS 保证人客户编号
        ,COALESCE(T5.OWNERNAME, '')                                                               AS 保证人客户名称
        ,CASE
           WHEN T5.GuarantyEffect = '010' THEN '主担保'
           WHEN T5.GuarantyEffect = '020' THEN '辅助担保'
           WHEN T5.GuarantyEffect = '030' THEN '道义担保'
         END                                                                                      AS 担保作用
        ,T7.cd_val_dscr                                                                           AS 与借款人关系
        ,ROW_NUMBER() OVER ( PARTITION BY T1.SERIALNO ORDER BY COALESCE(t5.GUARANTYID, '') DESC ) AS RN
FROM    EDW.LOAN_BUSINESS_CONTRACT T1
INNER JOIN    EDW.LOAN_CONTRACT_RELATIVE T2 -- 业务关联担保合同
ON      T2.SERIALNO = T1.SERIALNO
AND     T2.OBJECTTYPE = 'GuarantyContract'
AND     T2.DT = '20240719'
LEFT JOIN    EDW.LOAN_GUARANTY_RELATIVE T3 --业务合同、担保合同与担保物关联表
ON      T3.CONTRACTNO = T2.OBJECTNO
AND     T3.OBJECTNO = T2.SERIALNO
AND     T3.OBJECTTYPE = 'BusinessContract' -- 担保合同关联担保物
AND     T3.DT = '20240719'
LEFT JOIN    EDW.LOAN_GUARANTY_INFO T5
ON      T5.GUARANTYID = T3.GUARANTYID -- 担保物信息
AND     T5.GUARANTYTYPE LIKE '030%'
AND     T5.DT = '20240719'
LEFT JOIN    edw.loan_customer_relative T6 --客户关联信息
ON      T1.customerid = T6.customerid
AND     T5.OWNERID = T6.relativeid
AND     T5.OWNERID <> ''
AND     T6.DT = '20240719'
LEFT JOIN    edw.dwd_code_library_dd T7
ON      T6.relationship = T7.cd_val
AND     T7.tbl_nm = upper('CUSTOMER_PRIVATELEND')
AND     T7.fld_nm = upper('RELATIONSHIP')
AND     T7.dt = '20240719'
WHERE   T1.DT = '20240719'
AND    COALESCE(T5.OWNERNAME, '')  <> '';




---
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hzkh_SJ20241114106_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hzkh_SJ20241114106_03 AS
SELECT  CASE
          WHEN bc.manageOrgid LIKE 'I%' THEN '乐山银行'
          WHEN bc.manageOrgid LIKE 'G%' THEN '广州银行'
          WHEN bc.manageOrgid LIKE 'H%' THEN '泉州银行'
          WHEN bc.manageOrgid LIKE 'J%' THEN '裕民银行'
          WHEN bc.manageOrgid LIKE 'K%' THEN '潮阳农商行'
        END                  AS 项目
        ,bc.operateorgid     AS 经办机构号
        ,org.orgname         AS 经办机构
        ,bc.SERIALNO AS 合同流水号
        ,bc.customerid       AS 客户编号
        ,bc.customername     AS 客户名称
        ,bc.businesstype     AS 业务品种编号
        ,pd.pd_nm            AS 业务品种
        ,bc.businesssum      AS 贷款金额
        ,bc.BALANCE          AS 贷款余额
        ,bc.occurdate        AS 申请日
        -- ,bc.begindate  as 起始日  --该日期很多为空，18991231
        ,bc.putoutdate as 约定开始日  --最小日期19960818
        ,bc.maturity         AS 到期日
        ,bc.businessrate     AS 执行月利率
        ,CASE
           WHEN bc.vouchtype = '005' THEN '信用'
           WHEN bc.vouchtype = '010' THEN '保证'
           WHEN bc.vouchtype = '020' THEN '抵押'
           WHEN bc.vouchtype = '040' THEN '质押'
         END                 AS 担保方式
        -- ,bc.ictype           AS 还款方式
        ,r.cd_val_dscr       AS 计息方式
        ,CASE
           WHEN bc.freezeflag = 1 THEN '正常'
           WHEN bc.freezeflag = 2 THEN '冻结'
           WHEN bc.freezeflag = 3 THEN '到期失效'
           WHEN bc.freezeflag = 4 THEN '补充资料'
           WHEN bc.freezeflag = 6 THEN '待综合岗签收'
           WHEN bc.freezeflag = 7 THEN '待柜面签收'
           WHEN bc.freezeflag = 8 THEN '终止失效'
           WHEN bc.freezeflag = 9 THEN '到期失效'
           WHEN bc.freezeflag = 0 THEN '签收'
         END                 AS 状态
        -- ,bc.directionname    AS 行业投向
        -- ,bc.subdirection     AS 行业投向细分  --不用用这个
		,bc.direction        AS 行业投向代码
		,B51.cd_val_dscr    AS 一级行业
        ,B52.cd_val_dscr    AS 二级行业
        ,B53.cd_val_dscr    AS 三级行业
        ,B54.cd_val_dscr    AS 四级行业
        -- ,bc.productflag
        ,lab.bus_lab         AS 营销标签
        ,CASE
           WHEN bc.occurtype = '011' THEN '续做'
           WHEN bc.occurtype = '010' THEN '首笔'
           WHEN bc.occurtype = '610' THEN '卡片申请'
         END                 AS 发生类型
        ,bc.operateuserid    AS 经办人工号
        ,ui.username         AS 经办人
        ,bc.manageuserid     AS 管护人工号
        ,uii.username        AS 管护人
        ,A21.cd_val_dscr as 预评估结果
		,COALESCE(B1.annualincome,B2.yearincome   ) AS 收入合计
        ,ast.ast_lbl_rto as 资产负债率
        ,ast.tot_lbl_amt as 总负债金额
		,B41.保证人客户名称  AS   保证人客户名称1
		,B41.担保作用        AS   担保作用1
		,B41.与借款人关系    AS   与借款人关系1
		,B42.保证人客户名称  AS   保证人客户名称2
		,B42.担保作用        AS   担保作用2
		,B42.与借款人关系	 AS    与借款人关系2
		,B43.保证人客户名称  AS   保证人客户名称3
		,B43.担保作用        AS   担保作用3
		,B43.与借款人关系	 AS   与借款人关系3
FROM    edw.loan_business_contract bc --业务合同表
LEFT JOIN    edw.loan_org_info org --机构信息
ON      bc.operateorgid = org.orgid
AND     org.dt = '20240719'
LEFT JOIN    edw.loan_user_info ui --用户信息
ON      bc.operateuserid = ui.userid
AND     ui.dt = '20240719'
LEFT JOIN    edw.loan_user_info uii --用户信息
ON      bc.manageuserid = uii.userid
AND     uii.dt = '20240719'
LEFT JOIN    edw.dim_bus_loan_pd_inf_dd pd --产品
ON      bc.businesstype = pd.pd_cd
AND     pd.dt = '20240719'
LEFT JOIN    edw.dwd_code_library_dd r
ON      bc.ictype = r.cd_val
AND     r.tbl_nm = upper('dim_bus_loan_ctr_inf_dd')
AND     r.fld_nm = upper('intr_mth_cd')
AND     r.dt = '20240719'
LEFT JOIN    (
                 SELECT  a.busi_ctr_id
                         ,a.bus_lab_cd
                         ,WM_CONCAT('|', COALESCE(b.itemname)) AS bus_lab --将多行拼成一行
                 FROM    (
                             SELECT  busi_ctr_id
                                     ,bus_lab_cd
                                     ,bus_lab_cd2
                             FROM    edw.dim_bus_loan_ctr_inf_dd LATERAL VIEW explode(split(bus_lab_cd, ',')) bus_lab_cd AS bus_lab_cd2 --将同一行用分隔符拆成多行
                             WHERE   dt = '20240719'
                             AND     bus_lab_cd IS NOT NULL
                             AND     bus_lab_cd <> ''
                         ) a
                 LEFT JOIN    edw.loan_business_productflag b  --产品标识
                 ON      a.bus_lab_cd2 = b.serialno
                 AND     b.dt ='20240719'
                 GROUP BY a.busi_ctr_id , a.bus_lab_cd
             ) lab
ON      bc.SERIALNO = lab.busi_ctr_id
LEFT JOIN edw.dwd_bus_loan_pre_ases_rsl_dd     A2      --预评估最终结果信息
ON   bc.PREPARESERIALNO = A2.srl_nbr
AND  A2.dt = '20240719'
LEFT JOIN edw.dwd_code_library_dd     A21
ON   A2.pre_ases_rsl = A21.cd_val
AND   A21.fld_nm='PRE_ASES_RSL'
AND   A21.tbl_nm='DWD_BUS_LOAN_PRE_ASES_RSL_DD'
AND  A21.dt = '20240719'
left join  edw.DIM_CST_BAS_AST_LBL_INF_DD ast    --信贷调查记录-客户资产负债信息
on     bc.customerid=ast.cst_id
and    ast.dt='20240719'
LEFT JOIN  edw.loan_ent_info B1 --企业基本信息
ON      bc.customerid = B1.customerid
AND     B1.dt='20240719'
LEFT JOIN  edw.loan_ind_info B2 --个人信息表
ON      bc.customerid = B2.customerid
AND     B2.dt='20240719'
LEFT JOIN lab_bigdata_dev.tmp_hzkh_SJ20241114106_02 B41
ON      bc.SERIALNO = B41.SERIALNO
AND    B41.RN =1
LEFT JOIN lab_bigdata_dev.tmp_hzkh_SJ20241114106_02 B42
ON      bc.SERIALNO = B42.SERIALNO
AND    B42.RN =2
LEFT JOIN lab_bigdata_dev.tmp_hzkh_SJ20241114106_02 B43
ON      bc.SERIALNO = B43.SERIALNO
AND    B43.RN =3
LEFT JOIN    edw.dwd_code_library_dd B51 -- 码值表
ON      SUBSTR(bc.direction,1,1) = B51.cd_val
AND     B51.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     B51.fld_nm = 'LOAN_DIR_CD'
AND     B51.DT =  '20240719'
LEFT JOIN    edw.dwd_code_library_dd B52 -- 码值表
ON      SUBSTR(bc.direction,1,3) = B52.cd_val
AND     B52.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     B52.fld_nm = 'LOAN_DIR_CD'
AND     B52.DT =  '20240719'
LEFT JOIN    edw.dwd_code_library_dd B53 -- 码值表
ON      SUBSTR(bc.direction,1,4) = B53.cd_val
AND     B53.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     B53.fld_nm = 'LOAN_DIR_CD'
AND     B53.DT =  '20240719'
LEFT JOIN    edw.dwd_code_library_dd B54 -- 码值表
ON      bc.direction = B54.cd_val
AND     B54.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     B54.fld_nm = 'LOAN_DIR_CD'
AND     B54.DT =  '20240719'
WHERE   bc.dt = '20240719'
and bc.putoutdate>='2022/01/01'
AND     ( bc.manageOrgid LIKE 'I%'
    OR bc.manageOrgid LIKE 'G%'
    OR bc.manageOrgid LIKE 'H%'
    OR bc.manageOrgid LIKE 'J%'
    OR bc.manageOrgid LIKE 'K%' )
;



SELECT * FROM tmp_hzkh_SJ20241114106_04


--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hzkh_SJ20241114106_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hzkh_SJ20241114106_04 AS
SELECT  A1 . *
        ,A2.银行负债
		,A3.score  AS 模型分
FROM    lab_bigdata_dev.tmp_hzkh_SJ20241114106_03 A1
LEFT JOIN    (
                 SELECT  t1.客户编号
                         ,T4.银行负债
                         ,COALESCE(t3.report_no, t31.report_no) AS report_no
                 FROM    (
                             SELECT  DISTINCT 客户编号
                             FROM    lab_bigdata_dev.tmp_hzkh_SJ20241114106_03
                         ) t1
                 LEFT JOIN    edw.loan_customer_info t2 --客户基本信息
                 ON      t1.客户编号 = t2.customerid
                 AND     t2.dt = '20240719'
                 LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd t3 --个人征信指标信息表
                 ON      t2.certid = t3.doc_id
                 AND     t3.report_dsc_rn = 1
                 AND     t3.dt = '20240719'
                 LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd t31 --企业征信指标信息表
                 ON      t2.certid = t31.doc_id
                 AND     t31.report_dsc_rn = 1
                 AND     t31.dt = '20240719'
                 LEFT JOIN    tmp_hzkh_SJ20241114106_01 T4 --征信贷款信息
                 ON      COALESCE(t3.report_no, t31.report_no) = T4.report_id
                 WHERE   COALESCE(t3.report_no, t31.report_no, '') <> ''
             ) A2
ON      A1.客户编号 = A2.客户编号
LEFT JOIN (
               SELECT
                   T1.param_code	 --关联对象编码/合同流水号
                   ,T1.score
                  ,ROW_NUMBER() OVER(PARTITION BY T1.param_code ORDER BY T1.date_dt DESC ) AS RN
               FROM app_nbpj.ADM_PAPP_NBPJ_MODEL_RESULT_DI  T1 --评级模型结果表
               WHERE T1.DT<='20240719'
              )  A3
ON      A1.合同流水号 = A3.param_code
AND     A3.RN = 1
;
**01-数据需求_其他_D1210_曹春晖_苏州分行一二级信贷调查资质考评官人员.sql
-- SJ20241209141
-- 2024年1月1日-2024年12月9日，苏州分行一二级信贷调查资质考评官人员信息
-- 申请日期	申请人工号	申请人姓名	实务考评官姓名1	实务考评官姓名2

-- CREATE TABLE IF NOT EXISTS xindai_suzhoufenhang
-- (
--     sqrq   STRING COMMENT '申请日期'
--     ,gh    STRING COMMENT '申请人工号'
--     ,sqrxm STRING COMMENT '申请人姓名'
-- )
-- COMMENT
-- '导入清单';

-- INSERT into TABLE xindai_suzhoufenhang
-- (sqrq,gh,sqrxm)
-- values
-- ('2024-01-03','028452','吴宁'),
-- ('2024-01-05','028390','缪淼'),
-- ('2024-01-08','028368','吕倩'),
-- ('2024-01-09','028424','陆静怡'),
-- ('2024-01-09','028365','陈凯伦'),
-- ('2024-01-09','028438','薛嘉伟'),
-- ('2024-01-09','028395','陈湘恬'),
-- ('2024-01-11','028307','朱寅章'),
-- ('2024-01-16','028446','徐培培'),
-- ('2024-01-17','028398','李善望'),
-- ('2024-01-18','028299','王琦'),
-- ('2024-01-25','028257','陆文婷'),
-- ('2024-01-25','028429','郑晓琨'),
-- ('2024-01-25','028337','彭瑜婧'),
-- ('2024-01-31','028423','李百航'),
-- ('2024-02-01','028417','任卓越'),
-- ('2024-02-05','028455','周芳芳'),
-- ('2024-02-19','028453','汪敏伟'),
-- ('2024-02-19','028456','夏伟'),
-- ('2024-02-22','028381','乔永梅'),
-- ('2024-02-27','028468','朱煦莹'),
-- ('2024-03-04','028376','马飞'),
-- ('2024-03-04','028415','邵光耀'),
-- ('2024-03-04','028328','钮惠芬'),
-- ('2024-03-06','028449','沈钰'),
-- ('2024-03-11','028462','孙艳春'),
-- ('2024-03-18','028377','钱思敏'),
-- ('2024-03-19','028270','张莉'),
-- ('2024-03-19','028434','张皓如'),
-- ('2024-03-19','028417','任卓越'),
-- ('2024-03-20','028358','孙启航'),
-- ('2024-03-20','028300','周宇杰'),
-- ('2024-03-21','028353','朱嘉禧'),
-- ('2024-03-22','028472','王译琦'),
-- ('2024-03-22','028350','王力'),
-- ('2024-03-22','028236','陈紫玉'),
-- ('2024-03-25','028322','罗逸青'),
-- ('2024-03-25','028467','张浩杰'),
-- ('2024-03-25','028243','毛心怡'),
-- ('2024-03-26','028396','郁婷美'),
-- ('2024-03-27','019737','曹静怡'),
-- ('2024-04-08','028463','杨荣'),
-- ('2024-04-10','028391','祝铭超'),
-- ('2024-04-10','028327','殷欣荣'),
-- ('2024-04-16','028478','殷佳辉'),
-- ('2024-04-16','028475','张柏宇'),
-- ('2024-04-17','028398','李善望'),
-- ('2024-04-22','028432','陆威'),
-- ('2024-04-24','028352','邓鹏'),
-- ('2024-04-25','028469','储陶杰'),
-- ('2024-04-29','028397','高纪'),
-- ('2024-05-07','028283','龙春艳'),
-- ('2024-05-07','028481','黄丽雯'),
-- ('2024-05-07','028480','王慧'),
-- ('2024-05-09','023470','汪雅'),
-- ('2024-05-21','028394','刘莹莹'),
-- ('2024-05-29','028367','马雯雯'),
-- ('2024-06-11','028356','皇甫奕欢'),
-- ('2024-06-11','028418','薛怡星'),
-- ('2024-06-17','028492','吴孟玲'),
-- ('2024-06-18','028274','汪秋玉'),
-- ('2024-06-18','028501','苏子音'),
-- ('2024-06-21','028382','谭世杰'),
-- ('2024-06-25','028504','沈飞'),
-- ('2024-06-26','028427','张梦春'),
-- ('2024-07-08','028438','薛嘉伟'),
-- ('2024-07-09','028214','朱叶灵'),
-- ('2024-07-12','028414','李辰浩'),
-- ('2024-05-11','028271','杨欣宇'),
-- ('2024-08-05','005264','何秋虹'),
-- ('2024-08-09','028445','张哲皓'),
-- ('2024-08-14','028307','朱寅章'),
-- ('2024-08-22','028446','徐培培'),
-- ('2024-09-03','028489','刘霄鹏'),
-- ('2024-09-10','028336','秦亚娟'),
-- ('2024-09-14','028472','王译琦'),
-- ('2024-09-18','028460','王柯轩'),
-- ('2024-09-20','028376','马飞'),
-- ('2024-09-23','028408','张政欢'),
-- ('2024-10-17','036123','何健帝'),
-- ('2024-10-25','028478','殷佳辉'),
-- ('2024-11-01','028343','徐恬'),
-- ('2024-11-13','028422','张海怡'),
-- ('2024-11-19','028485','吕甜'),
-- ('2024-11-26','028389','李欢'),
-- ('2024-11-26','028395','陈湘恬'),
-- ('2024-11-28','028337','彭瑜婧'),
-- ('2024-12-03','036124','何孟茹'),
-- ('2024-12-04','028410','左梦缘'),
-- ('2024-12-04','028433','孙书闻'),
-- ('2024-12-04','028436','吴梦涛'),
-- ('2024-12-06','028270','张莉')
-- ;



DROP TABLE IF EXISTS tmp_sjxq_SJ20241209141 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241209141 AS
SELECT  c.sqrq             AS 申请日期
        ,c.gh              AS 申请人工号
        -- ,a.sqrxm           AS 申请人姓名编号
        ,c.sqrxm           AS 申请人姓名
        ,b.gh              AS 实务考评官工号
        -- ,b.xm              AS 实务考评官姓名编号
        ,h2.lastname       AS 实务考评官姓名
        --    ,b.gw  as 实务考评官岗位
        ,h2.tljobtitlename AS 实务考评官岗位
FROM    xindai_suzhoufenhang c --导入清单表
LEFT JOIN    edw.oadb_formtable_main_566 a --一二级信贷业务调查资质评定申请表
ON      c.gh = a.sqrgh
AND     c.sqrq = a.sqrq
AND     a.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_requestbase wr ---工作流请求基本信息表，只取流程状态归档的
ON      a.requestid = wr.requestid
AND     wr.dt = '@@{yyyyMMdd}'
and     wr.currentnodetype = '3'   --归档
LEFT JOIN    edw.oadb_formtable_main_566_dt1 b --一二级信贷业务调查资质评定申请表(明细表1)
ON      a.id = b.mainid
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmresource h2 --人力资源表
ON      b.xm = h2.id
AND     h2.dt = '@@{yyyyMMdd}'
ORDER BY c.sqrq;
**01-数据需求_其他_SJ20240715116_沈娅_1_6月宣传费明细.sql
--说明：采购管理岗系统支持导出数据，不用取
--采购目录平台宣传费2024年半年度使用情况分析。
-- 数据日期：2024年1月1日-2024年6月30日
-- 数据范围：全行
-- 取数口径：预算项目-年初预算，预算科目-宣传费
DROP TABLE IF EXISTS tmp_sy_SJ20240715116;

CREATE TABLE IF NOT EXISTS tmp_sy_SJ20240715116 AS
SELECT  (
        CASE t1.bplx
          WHEN 1 THEN '自行采购结果报批'
          WHEN 2 THEN '框架物资采购结果报批'
          WHEN 3 THEN '集中采购结果报批'
          WHEN 4 THEN '框架合同签订结果报批'
          WHEN 5 THEN '电子目录平台结果报批'
        END
        ) 结果报批类型
        ,t1.bpbh 结果报批编号
        ,t1.bpmc 结果报批名称
        ,t1.jgbpje 结果报批金额
        ,(
         CASE t1.zt
           WHEN 0 THEN '正常'
           WHEN 1 THEN '变更中'
           WHEN 2 THEN '变更审批'
           WHEN 3 THEN '变更完成'
           WHEN 4 THEN '已关闭'
           WHEN 5 THEN '已退回'
         END
        ) 状态
        ,t1.gbyy 关闭原因
        ,org.brc_org_nm 上级机构
        -- ,t1.zzid
        ,t1.zzmc 汇报机构
        -- ,t1.bmid
        ,t1.bmmc 汇报部门
        ,t1.qcrmc 创建人
        ,substr(t1.cjsj, 1, 8) 创建时间
        ,t1.gysmc 中标供应商名称
        ,t5.ztdm 中标供应商编号
        ,t1.ywbh 申请单编号
        ,'' 行号
        ,t3.cgml 采购目录编码
        ,t3.cgmlmc 采购目录名称
        ,t3.wpytbh 物品用途编码
        ,t3.wpytmc 物品用途名称
        ,t3.bxlxbh 报销类型编号
        ,t3.bxlxmc 报销类型名称
        ,t3.yskmbh 预算科目编号
        ,t3.yskmmc 预算科目名称
        ,t3.ysxmbh 预算项目编号
        ,t3.ysxmmc 预算项目名称
        ,t3.dj 单价
        ,t3.cgsl 采购数量
        ,t3.cgje 预算金额
        ,(
         CASE T12.status
           WHEN 0    THEN '未审核'
           WHEN 5    THEN '下单失败'
           WHEN 10   THEN '审核中'
           WHEN 15   THEN '已下单'
           WHEN 20   THEN '供应商拒单'
           WHEN 25   THEN '供应商已接收'
           WHEN 30   THEN '供应商已发货'
           WHEN 32   THEN '拒签收'
           WHEN 35   THEN '已签收'
           WHEN 45   THEN '已验收'
           WHEN 50   THEN '已开票'
           WHEN 55   THEN '已撤单'
           WHEN 60   THEN '已支付'
           WHEN - 99 THEN '已删除'
         END
        ) 申请单状态
        ,'' 行明细状态
        ,'' 关闭完结原因
        ,t3.spmc 商品名称
        ,t3.ppmc 品牌
        ,t3.ggxh 规格型号
        ,t3.dj 采购单价
        ,t3.cgsl 数量
        ,t3.cgje 采购金额
FROM    edw.epms_xm_jgbp t1 --结果报批表
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      t1.zzid = org.org_id
AND     org.dt = '@@{yyyyMMdd}'
INNER JOIN    edw.epms_xm_jgbp_spxx t3 --结果报批商品信息
ON      t1.id = t3.jgbp
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.epms_jc_ztbzt t5 --供应商基础信息
ON      t5.id = t1.gysbh
AND     t5.dt = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     ( t1.sfsjqy = 0
    OR t1.sfsjqy IS NULL )
AND     bplx = 5   --'电子目录平台结果报批'
AND     t1.zzid = '990000000'
AND     t1.CJSJ > '20240101235959'
AND     t1.cjsj < '20240630000000'
AND     t3.yskmbh in ('130702','110102') --宣传费,广告宣传
AND     t3.ysxmbh = '99' --年初预算
ORDER BY t1.bpbh;


-- SELECT * FROM  tmp_sy_SJ20240715116;
**01-数据需求_其他_SJ2024080146_王任任_发文_公文流程.sql
--取数范围(2023.1.1-24.6.30)	流程名称（发文）	拟搞人	部门（总行）	发文标题	是否流程干预到部室会签节点
drop TABLE if EXISTS tmp_wrr_SJ2024080146_fawen purge;

CREATE TABLE IF NOT EXISTS tmp_wrr_SJ2024080146_fawen as
SELECT  '发文'  as 流程名称
        -- ,f.requestid 流程编号
        ,h.workcode 拟稿人工号
        ,h.lastname 拟稿人
        ,hs.subcompanyname 分部
        ,f.lcbt 发文标题
        ,'是' as 是否流程干预到部室会签节点
FROM    edw.oadb_formtable_main_60 f --发文
LEFT JOIN    edw.oadb_workflow_requestlog wr --工作流请求签字日志表
ON      f.requestid = wr.requestid
AND     wr.dt = f.dt
LEFT JOIN    edw.oadb_hrmresource h --人力资源基本信息表
ON      h.id = f.nigaoren
AND     h.dt = f.dt
LEFT JOIN    edw.oadb_hrmsubcompany hs --分行信息记录表
ON      hs.id = f.fengbu
AND     hs.dt = f.dt
-- left join workflow_requestbase wb
-- on wb.requestid = f.requestid
WHERE   f.dt = '20240630'
AND     wr.workflowid = '63701'
AND     wr.destnodeid = '83208'
AND     wr.operator = '1'
-- and replace(f.tijiaoriqi,'-','')>='20230101'
-- and replace(f.tijiaoriqi,'-','')<='20240630'
;


--取数范围(2023.1.1-24.6.30)	流程名称(公文撤销/更改审批流程)	申请人	部门（总行）	公文发布日期	撤销/更改日期	撤销/更改文件名称	撤销/更改文号	撤销原因或更改原因及内容

drop TABLE if EXISTS tmp_wrr_SJ2024080146 purge;
CREATE TABLE IF NOT EXISTS tmp_wrr_SJ2024080146 AS
SELECT  '公文撤销/更改审批流程' AS 流程名称
        ,sqr 申请人id
        ,h.lastname 申请人
        ,bumen 部门id
        ,hr.departmentname 部门
        ,hr.subcompanyid1
        ,gwfbrq 公文发布日期
        ,cxrq 撤销_更改日期
        ,cxwjmc 撤销_更改文件名称
        ,cxwh 撤销_更改文号
        ,cxyy 撤销原因或更改原因及内容
FROM    edw.oadb_formtable_main_218 a --公文撤销/更改审批流程
LEFT JOIN    edw.oadb_hrmresource h --人力资源基本信息表
ON      a.sqr = h.id
AND     h.dt = '20240630'
LEFT JOIN    edw.oadb_hrmdepartment hr --人力资源部门表
ON      a.bumen = hr.id
AND     hr.dt = '20240630'
LEFT JOIN    edw.oadb_hrmsubcompany hs --分行信息记录表
ON      hr.subcompanyid1 = hs.id
AND     hs.dt = '20240630'
WHERE   a.dt = '20240630'
AND     REPLACE(gwfbrq, '-', '') >= '20230101'
AND     REPLACE(gwfbrq, '-', '') <= '20240630'
-- and hs.subcompanyname like '%总行'
AND     hr.subcompanyid1 = '1' --总行
;
**01-数据需求_其他_SJ20240806131_庆元村行_2023年7月1日至2024年7月31日行政印章使用数据.sql
-- formtable_main_781 未入仓,转运维处理

-- SJ20240806131
--2023年7月1日至2024年7月31日行政印章使用数据

-- 总/分村行、部门/支行、流程名称、申请时间、申请人、用印材料名称、使用印章、使用个数、用印时间、流程ID

SELECT * FROM  edw.oadb_formtable_main_496 WHERE dt='20240731'


 desc edw.oadb_formtable_main_496  --分支行行政印章及证照复印件使用流程


  id              | bigint     |       | ID                                          |
| requestid       | bigint     |       | 请求ID                                        |
| username        | bigint     |       | 经办人                                         |
| workcode        | string     |       | 经办人工号                                       |
| dept            | bigint     |       | 经办人部门                                       |
| applydate       | string     |       | 申请日期                                        |
| stamptype       | bigint     |       | 印章分类                                        |
| fowardperson    | string     |       | 送达对象                                        |
| searchtitle     | string     |       | 检索标题                                        |
| isapplylicense  | bigint     |       | 是否申请证照                                      |
| uploadfile      | string     |       | 文本上传                                        |
| shortcontent    | string     |       | 内容简述                                        |
| ischushen       | bigint     |       | 是否初审                                        |
| chushenperson   | bigint     |       | 初审人员                                        |
| ismydept        | bigint     |       | 是否本部门章                                      |
| deptorgization  | bigint     |       | 组织负责人                                       |
| needpost        | bigint     |       | 是否需邮寄                                       |
| postaddress     | string     |       | 邮寄地址                                        |
| receiveperson   | string     |       | 收件人                                         |
| receivephone    | string     |       | 联系方式                                        |
| isaboutlaw      | bigint     |       | 是否为法律性文件（合同、协议、证明等）                         |
| layfiletype     | bigint     |       | 法律性文件类型                                     |
| contractname    | string     |       | 合同名称                                        |
| contractlessor  | string     |       | 合同相对方                                       |
| contractmoney   | string     |       | 合同金额                                        |
| imagefile       | string     |       | 影像上传（最终签章版）                                 |
| packagenumber   | string     |       | 快递单号                                        |
| contractsigndate | string     |       | 合同签订日期                                      |
| contractenddate | string     |       | 合同到期日                                       |
| isstorelocal    | bigint     |       | 是否保管在本机构                                    |
| stampdeptmanager | bigint     |       | 印章所属部门负责人                                   |
| subcompanyleader | bigint     |       | 分管行长                                        |
| subdeptleader   | bigint     |       | 分行职能部门负责人                                   |
| zongfenhangfenlei | string     |       | 总分行分类                                       |
| stampcompany    | bigint     |       | 印章所属机构分行                                    |
| stampdept       | bigint     |       | 印章所属机构支行                                    |
| stampblonetype  | bigint     |       | 印章所属机构类型                                    |
| ifsendtosubcomleader | bigint     |       | 是否提交分行行长                                    |
| company         | bigint     |       | 经办人分部                                       |
| companyleaderrole | string     |       | 角色人员分管行长                                    |
| subdeptleadermul | string     |       | 分行职能部门负责人多人                                 |
| gjys            | string     |       | 申请流程是否完整                                    |
| spqxsfyx        | string     |       | 审批权限是否有效                                    |
| yylxsfzq        | string     |       | 用印类型是否正确                                    |
| yyslsfxf        | string     |       | 用印数量是否相符                                    |
| gjrq            | string     |       | 日期                                          |
| gjje            | string     |       | 金额                                          |
| gjqz            | string     |       | 签字                                          |
| gjhtzt          | string     |       | 合同主体                                        |
| gjqlyw          | string     |       | 权利义务                                        |
| gjwytk          | string     |       | 违约条款                                        |
| layworkflow     | string     |       | 法审流程                                        |
| fghz2           | string     |       | 分管行长2                                       |
| licensecompany  | bigint     |       | 证照分部                                        |
| shifoufenhang1  | bigint     |       | 是否分行职能部门会签1                                 |
| shenpiliuzhuan1 | bigint     |       | 审批流转1                                       |
| shifoufenhang2  | bigint     |       | 是否分行职能部门会签2                                 |
| shenpiliuzhuan2 | bigint     |       | 审批流转2                                       |
| fenhangzhinengbumen | bigint     |       | 分行职能部门负责人                                   |
| shiyongleixing  | bigint     |       | 使用类型                                        |
| sfgclht         | bigint     |       | 是否工程类合同                                     |
| gccgdbh         | string     |       | 工程采购审批单号                                    |
| gys             | string     |       | 供应商                                         |
| xmjje           | string     |       | 项目及金额                                       |
| sfxdfqbz        | string     |       | 是否信贷发起标志                                    |
**01-数据需求_其他_SJ2024082031_王志雄_21_24年采购数据.sql
-- 拉取2021.2022.2023.2024年以下数据：
--edw.emps_e_order  --订单表
--edw.epms_e_order_detail  --订单明细表
--取数逻辑不清晰，转运维处理
-- 1全行框架定点物资数量（包括总分支行框架）；总行框架定点全行使用物资数量，总行框架定点仅限总行使用数量。
--全行的框架物资数量，总行使用数量

-- 2全行框架定点物资下单金额；相对应的全量框架定点物资下单金额。（包含下单机构，下单时间）
--全行下单金额

--采购系统（不包含电子目录平台）

DROP TABLE if EXISTS  tmp_wsj_yln_cgxt_011 purge;
CREATE TABLE IF NOT EXISTS tmp_wsj_yln_cgxt_011 as
select
(case t4.sqdlx when 0 then '定点合同申请' when 1 then '定点物料申请' when 2 then '自行采购申请' when 3 then '集中采购申请' end) 申请单类型,
substr(t1.cjsj,1,8) 创建时间,
t1.bmid 需求部门编号,
t1.bmmc 需求部门,
t1.zzid 需求机构编号,
t1.zzmc 需求机构,
org.brc_org_nm 上级机构,
t3.spmc 商品名称,
t3.dj 采购单价,
t3.cgsl 采购数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1   --结果报批表
inner join edw.epms_xm_jgbp_spxx t3   --结果报批商品信息
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'  --结果报批
inner join edw.epms_wt_sqdmx  t2  --申请单明细
on  t3.sqdmx = t2.id and t2.dt='@@{yyyyMMdd}'   --申请id
inner join edw.epms_wt_cgsqd  t4  --采购申请单
on t2.sqdbh = t4.id  and t4.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
-- and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and t1.bplx=2 -- 框架物资采购结果报批
and t4.sqdlx=1  --申请单类型
;

DROP TABLE if EXISTS  tmp_wsj_yln_cgxt_012;
CREATE TABLE IF NOT EXISTS tmp_wsj_yln_cgxt_012 as
SELECT  distinct substr(T12.place_time,1,8) 下单时间
        ,T12.bmbh 部门编号
        ,T12.bmmc 部门名称
        ,T12.dwbh 单位编号
        ,T12.dwmc 单位名称
        ,T13.product_name 商品名称
        ,T13.price 商品价格
        ,T13.total 数量
        ,T13.amount 金额
FROM    edw.emps_e_order T12 --商城订单表
LEFT JOIN    edw.epms_e_order_detail T13 --商城订单明细表
ON      T12.id = T13.order_id   --订单编号
AND     T13.DT = '@@{yyyyMMdd}'
WHERE   T12.DT = '@@{yyyyMMdd}'
AND     nvl(T12.dsbs,'') not in ('DELI','JD')  --框架订单
;

-- 3合同总份数；期限分布：1年多少份，2年多少份，三年多少份，分别占比。（包含合同签订机构）
--指全行的采购，框架类合同。

SELECT DISTINCT htlx FROM edw.epms_xm_cght WHERE dt='@@{yyyyMMdd}';

DROP TABLE IF EXISTS tmp_wsj_yln_oaht purge;

CREATE TABLE IF NOT EXISTS tmp_wsj_yln_oaht as
select
ht.htbh 合同编码,
ht.htmc 合同名称,
ht.bmbh 部门编号,
ht.bmmc 部门名称,
ht.jgbh 机构编号 ,
-- ht.htqdkssj 合同签订开始时间,
-- ht.htqdjssj 合同签订结束时间 ,
ht.ksrq 开始日期 ,
ht.htzzrq 合同结束日期
-- ht.zsl 合同总数量,
-- ht.htxz  ,
-- case ht.htxz when 1 then '合同' when 2 then '订单' when 3 then '补充协议' end 合同性质   --1-合同，2-订单，3-补充协议
from edw.epms_xm_cght ht   --采购合同信息表
-- left join edw.oadb_hrmresource hr  --人力资源基本信息表
-- on  hr.id = ht.jbr
-- and hr.dt='@@{yyyyMMdd}'
-- left join edw.oadb_hrmdepartment hd  --人力资源部门表
-- on hd.departmentcode = ht.signdepartment
-- and hd.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd org
on ht.jgbh=org.org_id
and org.dt='@@{yyyyMMdd}'
where ht.dt='@@{yyyyMMdd}'
--and ht.htxl in(4,5,6,8)  -- (合同小类)4-采购管理类合同5-技术服务类合同6-企划宣传类合同7-租赁管理类合同8-工程管理类合同9-房屋购置合同
;




--4电子目录平台物资品名（京东、得力），数量，下单总额，相对应的物品下单金额
--新：采购管理平台上上架的所有的京东、得力的产品。品名，数量，金额。另外还需下单的信息

SELECT * FROM tmp_wsj_yln_cgxt_02;

DROP TABLE if EXISTS  tmp_wsj_yln_cgxt_02;
CREATE TABLE IF NOT EXISTS tmp_wsj_yln_cgxt_02 as
SELECT   substr(t1.CJSJ, 1, 4) as 创建时间
        ,t1.zzid 需求机构编号
        ,t1.zzmc 需求机构
        ,t1.bmid 需求部门编号
        ,t1.bmmc 需求部门
        ,org.brc_org_nm 上级机构
        ,t1.gysmc 供应商名称
        ,t3.spmc 商品名称
        -- ,t3.dj 采购单价
        -- ,t3.cgsl 采购数量
        -- ,t3.cgje 采购金额
        ,T12.product_total 下单数量
        ,T12.order_amount 订单总金额
        ,T12.product_amount 商品总金额
FROM    edw.epms_xm_jgbp t1  --结果报批表  最早只有20170406
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      t1.zzid = org.org_id
AND     org.dt = '@@{yyyyMMdd}'
left JOIN    edw.epms_xm_jgbp_spxx t3  --结果报批商品信息
ON      t1.id = t3.jgbp
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
-- AND     ( t1.sfsjqy = 0
--     OR t1.sfsjqy IS NULL )  --是否数据迁移
AND     t1.bplx = 5  --电子目录平台
-- and substr(t1.CJSJ, 1, 4) in ('2021','2022','2023','2024')
ORDER BY t1.bpbh;

---*************************************************************************************************************************************************
----开发给的代码，卞皓
-- 全行框架物资下单机构，下单金额 cggldb
select xm_jgbp.ywbh '框架合同编号',xm_jgbp.bpbh '框架物资结果报批编号',xm_jgbp_spxx.spmc '物资名称',xm_jgbp_spxx.DJ '单价',xm_jgbp_spxx.CGSL '数量',wt_sqdmx.SYJGMC '组织名称',wt_sqdmx.SYBMMC '部门名称',xm_jgbp_spxx.cgje '下单金额', wt_sqdmx.YSKMMC '预算科目',wt_cgsqd.SPKSSJ '下单时间' from xm_jgbp
LEFT JOIN xm_jgbp_spxx ON xm_jgbp.id  = xm_jgbp_spxx.JGBP
LEFT JOIN wt_sqdmx ON xm_jgbp_spxx.sqdmx = wt_sqdmx.ID
LEFT JOIN wt_cgsqd ON wt_cgsqd.ID = wt_sqdmx.SQDBH
where bplx = 2 AND xm_jgbp.zt != 4 and sfgcxm != 1 order by ywbh DESC;

-- 框架物资合同
select htbh '合同编号',ksrq '开始时间',HTZZRQ '合同终止时间',bmmc '部门名称',HTMC '合同名称' from xm_cght where sfkjht = 1;

-- 总行框架总行使用
select jc_rwspxx.id '商品id',jc_rwspxx.SPMC '商品名称',jc_rwspxx.GGXH '规格型号',jc_rwspxx.YHL '价格',jc_rwspxx.ZT '状态(1-在用，0-停用)',
jc_rwspxx.DW '单位', jc_rwspxx.CGML '采购目录', jc_rwspxx.PPMC '品牌名称', jc_rwspxx.SFSSC '是否上商城',
(select COUNT(1) FROM wt_sqdmx where wt_sqdmx.htbh = xm_cght.ID) '采购下单数量'
from jc_rwspxx
left JOIN jc_rwgys ON jc_rwspxx.DDGYS = jc_rwgys.ID
left JOIN xm_cght on jc_rwgys.YWBH = xm_cght.ID
WHERE JGBH = '990000000'
and EXISTS (select 1 from jc_rwspxx_syfw where jc_rwspxx_syfw.SPXXID = jc_rwspxx.ID AND SYFW = '990000000');


-- 总行框架全行使用
select jc_rwspxx.id '商品id',jc_rwspxx.SPMC '商品名称',jc_rwspxx.GGXH '规格型号',jc_rwspxx.YHL '价格',jc_rwspxx.ZT '状态(0-在用，1-停用)',
jc_rwspxx.DW '单位', jc_rwspxx.CGML '采购目录', jc_rwspxx.PPMC '品牌名称', jc_rwspxx.SFSSC '是否上商城',
(select COUNT(1) FROM wt_sqdmx where wt_sqdmx.htbh = xm_cght.ID) '采购下单数量'
from jc_rwspxx
left JOIN jc_rwgys ON jc_rwspxx.DDGYS = jc_rwgys.ID
left JOIN xm_cght on jc_rwgys.YWBH = xm_cght.ID
WHERE JGBH = '990000000'
and EXISTS (select 1 from jc_rwspxx_syfw where jc_rwspxx_syfw.SPXXID = jc_rwspxx.ID AND SYFW = 'QH');

-- 商品下单 dzmlptdb执行
select eod.PRODUCT_CODE '商品编码',eod.PRODUCT_NAME '商品名称',eod.BRAND_NAME '品牌名称',eo.GYSMC '店铺',eod.TOTAL '下单商品数量',
eod.AMOUNT '下单金额',
eod.syjgmc '下单机构',
eod.sybmmc '下单部门',
eo.CZYMC '下单人',
eod.FYXMC '下单费用项'
from e_order eo
left JOIN e_order_detail eod ON  eo.id  = eod.ORDER_ID
left JOIN e_product ep ON ep.code = eod.PRODUCT_CODE
where eo.dsbs is NOT NULL order by eod.PRODUCT_CODE desc;
**01-数据需求_其他_SJ2024082186_李留旗_取二代支付系统的银行行号对应的表数据.sql
-- SJ2024082186
--取二代支付系统的银行行号对应的表数据
--银行行号、城市代码、银行名称、银行地址、是否可用、更新日期、母行银行号

-- SELECT * FROM tmp_llq_SJ2024082186;

DROP TABLE IF EXISTS tmp_llq_SJ2024082186 PURGE;

CREATE TABLE IF NOT EXISTS tmp_llq_SJ2024082186 AS
SELECT  bankno 产品代码
        ,bankstatus 人行报文号
        ,banktype 业务类型编码
        ,bankclscode 发起行行号
        ,clearbank 接收行行号
        ,legalperson 人行金额上限
        ,topbanklist 权限权重值
        ,topbankno 备用字段1
        ,topbankname 备用字段2
        ,rplbankno 承接行行号
        ,peoplebankno 所属人行代码
        ,ccpcnodeno 所属ccpc
        ,citycode 城市代码
        ,bankname 行名全称
        ,bankaliasname 行名简称
        ,signflag 加入业务系统标识
        ,address 地址
        ,postcode 邮编
        ,telephone 电话
        ,email 电子邮箱
        ,remark 备注
        ,cnapsgeneration 是否加入二代标识
        ,saccstatus 清算账户状态
        ,saccaltdate 清算账户变更工作日
        ,saccalttime 清算账户更名时间
        ,remark1 备注1
        ,updatedate 更新日期
        ,updateno 最近更新期数
        ,effectdate 生效日期
        ,invaliddate 失效日期
        ,changetype 变更类型
        ,acctbankno 入账行行号
FROM    edw.spmt_t_cpim_cnapsbankinfo a --支付系统行名行号信息表
WHERE   a.dt = '@@{yyyyMMdd}'
;
**01-数据需求_其他_SJ2024082371_姚芝玲_全行团队总岗位信息.sql
--统计分析业务团队负责人长期单一岗位履职情况
-- 截止8月22日，全行业务团队负责人加入本岗位时间。
-- 工号、姓名、公司名称、支行/部门、部门/科室/团队、岗位名称、岗位分类、岗位序列、当前岗位初次聘任时间
DROP TABLE if EXISTS tmp_yzl_SJ2024082371 purge;
CREATE TABLE IF NOT EXISTS tmp_yzl_SJ2024082371 AS
SELECT  a.empe_id 员工工号
        ,a.empe_nm 员工姓名
        ,a.org_id 部门编号
        ,a.org_nm 部门名称
        ,b.sbr_org_nm 支行
        ,b.brc_org_nm 分行
        ,b.cpy_org_nm 法人机构名称
        ,a.pos_id 岗位编号
        ,a.pos_nm 岗位名
        ,a.dty_id 职位族编号
        ,a.dty_nm 职位族名称
        ,a.join_pst_dt 加入当前岗位时间
FROM    edw.dws_hr_empe_team_mng_dd a --员工团队总信息
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd b
ON      a.org_id = b.org_id
AND     b.dt = '20240822'
WHERE   a.dt = '20240822'
;
**01-数据需求_其他_SJ2024091311_张溪淋_核心系统印鉴卡变更的清单.sql
--2023年1月1日至今，核心系统印鉴卡变更的清单
--户名、账号、开户日期、印鉴卡变更日日期、印鉴卡号
DROP TABLE IF EXISTS tmp_zxl_SJ2024091311 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zxl_SJ2024091311 AS
SELECT  a.jiaoyirq  AS 交易日期
        -- ,a.jyzwjigo as 机构
        ,a.yngyjigo AS 营业机构
        ,a.guiylius AS 柜员流水
        ,b.kehuzhmc AS 客户账户名称
        ,a.kehuzhao AS 客户账号
        ,b.kaihriqi AS 开户日期
        ,a.zhhaoxuh AS 账户序号
        ,a.pingzhzl AS 凭证种类
        ,a.pngzphao AS 凭证批号
        ,a.qishipzh AS 起始凭证号
        ,a.zzpzhhao AS 终止凭证号
FROM    edw.core_kceb_pzsjia a --客户凭证事件登记簿
LEFT JOIN    edw.core_kdpa_kehuzh b --客户账号
ON      a.kehuzhao = b.kehuzhao
WHERE   a.dt = '@@{yyyyMMdd}'
and       a.kehuzhao = b.kehuzhao
AND     a.pzsjbzhi = '5' --印鉴更换
AND     a.jiaoyirq >= '20230101'
AND     a.yngyjigo = '330100900'--台州三门支行
;
**01-数据需求_其他_SJ2024091356_理财业务分析.sql
-- SJ2024091356,转雨洁处理
-- 2022年1月1日-2024年8月31日理财交易流水统计数据
-- 时间（年月）、理财产品名称、类型（自营or代销）、期限、机构（支行+分行）、当月理财交易额、当月理财交易笔数、当月首单客户交易额、当月首单客户交易笔数

-- 字段：交易时间、	理财产品名称	类型	产品期限	机构	支行	当月理财交易额	当月理财交易笔数
--交易时间、产品名称、类型、产品期限、机构、支行、当月首单客户交易额、当月首单客户交易笔数

--1、取理财交易明细，区分业务码值
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yl_SJ2024091356_01;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yl_SJ2024091356_01  as
SELECT  t.trx_dt 交易日期
        ,t.trx_tm 交易时间
        ,t.srl_nbr 流水号
        ,t.cst_id 客户号
        ,t.pd_cd 理财产品编码
        ,t1.pd_nm 理财产品名称
        ,DATEDIFF(to_date(t1.pd_end_dt,'yyyymmdd'),to_date(t1.pd_found_dt,'yyyymmdd'),'dd') as 产品期限
        -- ,t1.pd_found_dt 产品成立日期
        -- ,t1.pd_end_dt 产品结束日期
        ,t.tacd ta代码
        ,CASE
           WHEN t.tacd = 'TL' THEN '自营'
           ELSE '代销'
         END 类型
        ,t.trx_afl_org_id 交易所属机构编号
        ,t2.brc_org_nm 分行
        ,t2.sbr_org_nm 支行
        ,t.trx_amt 交易金额
        ,t.trx_lot 交易份额
        ,t.bus_cd 业务代码
        ,t3.cd_val_dscr 业务代码描述
        ,ROW_NUMBER() over(PARTITION BY t.pd_cd,substr(t.trx_dt,1,6) ORDER BY T.trx_tm	) AS RN
FROM    edw.dwd_bus_chm_trx_cfm_dtl_dd t --理财交易确认流水明细
LEFT JOIN    edw.dim_bus_chm_pd_inf_dd t1 --理财产品信息
ON      t.pd_cd = t1.pd_cd
AND     t1.dt = '20240831'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t2
ON      t.trx_afl_org_id = t2.org_id
AND     t2.dt = '20240831'
LEFT JOIN    edw.dwd_code_library_dd t3
ON      t.bus_cd = t3.cd_val
AND     t3.dt = '20240831'
WHERE   t.dt = '20240831'
AND     t.trx_dt >= '20220101'
AND     t.trx_dt <= '20240831'
;


--2、按月份取交易金额、交易份额、交易笔数

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yl_SJ2024091356_02;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yl_SJ2024091356_02  as
SELECT substr(T.交易日期,1,6) 交易月份
       ,T.业务代码描述 AS 交易代码
       ,T.理财产品名称
       ,T.ta代码
       ,T.类型
       ,DATEDIFF(to_date(T.产品结束日期,'yyyymmdd'),to_date(T.产品成立日期,'yyyymmdd'),'dd')  as 产品期限
       ,T.交易所属机构编号 as 机构号
       ,T.支行
       ,T.分行
       ,sum(交易金额) as 当月理财交易金额
       ,sum(交易份额) as 当月理财交易份额
       ,COUNT(1)  as 当月理财交易笔数
FROM lab_bigdata_dev.tmp_yl_SJ2024091356_01 T
GROUP BY substr(T.交易日期,1,6) ,T.业务代码描述 ,T.理财产品名称,T.ta代码,T.类型,T.产品成立日期,T.产品结束日期,T.交易所属机构编号,T.支行,T.分行
;

-- SELECT 分行,类型,count(1) FROM tmp_yl_SJ2024091356_02 GROUP BY 分行,类型;

--3、取当月首单客户交易额、当月首单客户交易笔数
SELECT
    T1.理财产品编码
	,T1.理财产品名称
	,T1.客户号 AS 首单客户号
	,T1.交易月份
	,SUM(交易金额) AS 当月首单客户交易额
		,SUM(交易份额) AS 当月首单客户交易份额
		,COUNT(1)  AS 当月首单客户交易笔数
FROM lab_bigdata_dev.tmp_yl_SJ2024091356_01   T1
LEFT JOIN lab_bigdata_dev.tmp_yl_SJ2024091356_01 T2
ON   T1.客户号 = T2.客户号
AND  T1.交易月份 = T2.交易月份
WHERE  T1.RN= 1
GROUP BY     T1.理财产品编码,T1.理财产品名称,T1.客户号 ,T1.交易月份
**01-数据需求_其他_SJ2024101461_钱国忠_随贷通_泰e贷_融e贷_中发生的当天产生借据_当天归还借据.sql
-- 数据日期：2024年1月1日至2024年9月30日；
-- 数据范围：所有分行
-- 取数口径：下列信贷产品（随贷通、泰e贷、融e贷）中发生的当天产生借据，当天归还借据。
-- 字段：客户号、客户姓名、管户分行、管户支行、管户部门、管户人、所属合同金额、借据金额、借据日期。

--客户姓名	客户姓名	管户分行	管户支行	管户部门	管户人	借据金额	借据归还金额	借据发放日期	借据所属合同金额


--170234条。
DROP TABLE IF EXISTS tmp_qgz_SJ2024101461 PURGE;

CREATE TABLE IF NOT EXISTS tmp_qgz_SJ2024101461 AS
SELECT  T1.cst_id      AS 客户号
        ,T1.cst_nm     AS 客户姓名
        ,T2.brc_org_nm AS 管户分行
        ,T2.sbr_org_nm AS 管户支行
        ,T2.tem_org_nm AS 团队
        ,T6.prm_org_id AS 机构号
        ,T6.prm_org_nm AS 机构
        ,T6.prm_mgr_id AS 主管户人工号
        ,T6.prm_mgr_nm 主管户人
        ,T1.ctr_serno  AS 合同号
        ,T3.dbil_id    AS 借据号
        ,T3.amt        AS 借据金额
        ,T5.借据归还金额
        ,T3.dtrb_dt    AS 借据发放日期
        ,T1.ctr_amt    AS 借据所属合同金额
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T6 --客户主管护，一个客户只有一个主管护
ON      T1.cst_id = T6.cst_id
AND     T6.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T2 --机构树_考核维度
ON      T6.prm_org_id = T2.org_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd T3 --贷款借据信息汇总
ON      T1.ctr_serno = T3.bus_ctr_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.loan_dbil_id
                         ,A1.trx_dt --交易日期
                         ,SUM(trx_amt) AS 借据归还金额
                 FROM    edw.dwd_bus_loan_act_trx_dtl_di A1 --贷款账户交易明细表,交易方向trx_dir=1，还款
                 WHERE   A1.DT <= '@@{yyyyMMdd}'
                --  AND     A1.smr = '归还贷款'
                 and a1.trx_dir=1 --还款
               AND     a1.trx_evt IN ( 'LN_BXTZ' , 'LN_HXGH' , 'LN_TQHK' , 'LN_ZCHK' , 'LN_YQHK' ) --本息调整、核销归还、提前还款、正常还款、逾期还款
                 GROUP BY A1.loan_dbil_id , A1.trx_dt
             ) T5
ON      T3.dbil_id = T5.loan_dbil_id
AND     T3.dtrb_dt = T5.trx_dt
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     T2.cpy_org_nm = '浙江泰隆商业银行股份有限公司'
AND     ( T1.PRD_NO IN ( '2001010101003' , '2001020101003' , '2001010101002' , '2001020101002' ) --随贷通，泰e贷
    OR T1.RVLG_TYP_CD = '1' --循环
AND     substr(T1.PRD_NO, 1, 6) IN ( '200102' , '200101' , '100101' ) ) --融e贷，，筛选&ldquo;循环类型&rdquo;是自助循环，且是个人经营性贷款、个人消费性贷款、流动资金贷款
AND     T5.借据归还金额 > 0
AND     T3.dtrb_dt >= '20240101'
AND     T3.dtrb_dt <= '20240930';
**01-数据需求_其他_SJ2024101611_钱雪颖_同业客户账户信息.sql
--转堡垒机账号

-- 客户证件类型	客户证件号码	客户当前注册资金（元）	注册资金币种	客户当前实收资本（元）	实收资本币种	该客户名下是否存在我行账户（无论账户状态如何）（是/否）
-- 若存在，账号	账户类型	当前账户状态（正常、不动户、转营业外、未启用、销户等）	开户机构	开户日期	销户机构	销户日期

-- SJ2024101611_同业客户在我行留存信息



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ty_zh_SJ2024101611_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_ty_zh_SJ2024101611_01
(
  客户统一编号 STRING
  ,客户名称    STRING
) ;

 --数据插入
INSERT INTO lab_bigdata_dev.tmp_ty_zh_SJ2024101611_01  VALUES
 ('0000004695','吉林公主岭农村商业银行股份有限公司')
,('0000007692','招商证券股份有限公司')
,('0000007793','兴业银行股份有限公司')
,('0600496008','华夏金融租赁有限公司')
,('0600638003','威海蓝海银行股份有限公司')
,('0600658002','齐鲁银行股份有限公司')
,('0600744033','陕西柞水农村商业银行股份有限公司')
,('0600772000','江西鄱阳农村商业银行股份有限公司')
,('0000008273','中国民生银行股份有限公司')
,('0000008754','交银施罗德基金管理有限公司')
,('0600062018','山东肥城农村商业银行股份有限公司')
,('0600078045','山东龙口农村商业银行股份有限公司')
,('0000002976','新时代信托股份有限公司')
,('0600094001','陕西千阳农村商业银行股份有限公司')
,('0600106022','陕西石泉农村商业银行股份有限公司')
,('0600142001','兰州银行股份有限公司')
,('0600156172','济宁银行股份有限公司')
,('0600184021','中天证券股份有限公司')
,('0600194000','银行间市场清算所股份有限公司')
,('0000003090','江苏江阴农村商业银行股份有限公司')
,('0600150006','武汉农村商业银行股份有限公司')
,('0600470019','浙江温州瓯海农村商业银行股份有限公司')
,('0600572009','华夏理财有限责任公司')
,('0600600114','铜川市耀州区农村信用合作联社')
,('0600766006','安徽和县农村商业银行股份有限公司')
,('0601086010','驻马店农村商业银行股份有限公司')
,('0601120018','河南淮滨农村商业银行股份有限公司')
,('0000002736','驻马店银行股份有限公司')
,('0000006059','重庆银行股份有限公司')
,('0000006561','财通证券股份有限公司')
,('0000008374','温岭市国有资产投资集团有限公司')
,('0600040001','韩亚银行(中国)有限公司')
,('0600066007','江苏长江商业银行股份有限公司')
,('0600130058','山东平阴农村商业银行股份有限公司')
,('0600154012','吉林浑江农村商业银行股份有限公司')
,('0600190035','上海东正汽车金融股份有限公司')
,('0600618007','川财证券有限责任公司')
,('0600808002','江苏镇江农村商业银行股份有限公司')
,('0000003463','中海信托股份有限公司')
,('0000005579','国寿安保基金管理有限公司')
,('0000008235','平安银行股份有限公司')
,('0000008499','福建海峡银行股份有限公司')
,('0600030109','国金证券股份有限公司')
,('0600074019','哈密市商业银行股份有限公司')
,('0600156384','长治漳泽农村商业银行股份有限公司')
,('0600164025','国海证券股份有限公司')
,('0600306006','陕西麟游农村商业银行股份有限公司')
,('0600336005','浙江建设融资租赁有限公司')
,('0600382004','浙江兰溪农村商业银行股份有限公司')
,('0600600047','陕西岚皋农村商业银行股份有限公司')
,('0600856002','西部利得基金管理有限公司')
,('0000001117','浙江稠州商业银行股份有限公司')
,('0000007250','廊坊银行股份有限公司')
,('0000008103','华安未来资产管理(上海)有限公司')
,('0000008653','四川苍溪农村商业银行股份有限公司')
,('0000008848','山东兰陵农村商业银行股份有限公司')
,('0600156158','朝阳银行股份有限公司')
,('0600164076','四川高县农村商业银行股份有限公司')
,('0600366007','安信基金管理有限责任公司')
,('0600596007','陕西府谷农村商业银行股份有限公司')
,('0600606003','河南济源农村商业银行股份有限公司')
,('0600698007','石家庄市藁城农村信用合作联社')
,('0000004068','恒丰银行股份有限公司')
,('0000005214','创金合信基金管理有限公司')
,('0000006307','九江银行股份有限公司')
,('0000007801','东北证券股份有限公司')
,('0000008019','永赢基金管理有限公司')
,('0000008406','中国建设银行股份有限公司')
,('0000008468','江西省农村信用社联合社')
,('0600062025','营口银行股份有限公司')
,('0600112060','陆家嘴国际信托有限公司')
,('0600156199','南昌农村商业银行股份有限公司')
,('0600156309','辽阳辽东农村商业银行股份有限公司')
,('0600328010','湖南慈利农村商业银行股份有限公司')
,('0600680003','江苏丹阳农村商业银行股份有限公司')
,('0600722002','虞城县农村信用合作联社')
,('0600754002','河南巩义农村商业银行股份有限公司')
,('0600848007','玉山银行(中国)有限公司')
,('0000007700','杭州联合农村商业银行股份有限公司')
,('0000008615','浙江禾城农村商业银行股份有限公司')
,('0600078001','广东粤财信托有限公司')
,('0600152014','中银消费金融有限公司')
,('0600156064','民生证券股份有限公司')
,('0600158166','宁波余姚农村商业银行股份有限公司')
,('0600158250','浙江武义农村商业银行股份有限公司')
,('0600304012','湖南桃源农村商业银行股份有限公司')
,('0600428002','物产中大集团财务有限公司')
,('0600676017','浙江岱山农村商业银行股份有限公司')
,('0600716049','洛南县农村信用合作联社')
,('0600750037','陕西镇安农村商业银行股份有限公司')
,('0600756003','江苏涟水农村商业银行股份有限公司')
,('0600760023','江西武宁农村商业银行股份有限公司')
,('0600826111','中原银行股份有限公司')
,('0601128009','江苏仪征农村商业银行股份有限公司')
,('0600812008','乐山农村商业银行股份有限公司')
,('0600820000','福建华通银行股份有限公司')
,('0600834005','陕西神木农村商业银行股份有限公司')
,('0601062005','新疆伊犁农村商业银行股份有限公司')
,('0000003519','浙江温州鹿城农村商业银行股份有限公司')
,('0000004455','上海松江民生村镇银行股份有限公司')
,('0000005841','景顺长城基金管理有限公司')
,('0000005904','营口农村商业银行股份有限公司')
,('0000006965','中国信托登记有限责任公司')
,('0600002014','河北涿州农村商业银行股份有限公司')
,('0600032006','国海富兰克林基金管理有限公司')
,('0600102006','广东省农村信用社联合社')
,('0600112084','平安资产管理有限责任公司')
,('0600152004','华润深国投信托有限公司')
,('0600164008','蒙特利尔银行(中国)有限公司')
,('0600200007','湖南三湘银行股份有限公司')
,('0600216017','勉县农村信用合作联社')
,('0600218008','湖北荆州农村商业银行股份有限公司')
,('0600246009','重庆鈊渝金融租赁股份有限公司')
,('0600282005','安徽泾县农村商业银行股份有限公司')
,('0600470026','浙江长兴农村商业银行股份有限公司')
,('0600600064','大荔县农村信用合作联社')
,('0600720001','中国大地财产保险股份有限公司')
,('0600738005','河北定州农村商业银行股份有限公司')
,('0000006237','太平资产管理有限公司')
,('0000007731','长江证券股份有限公司')
,('0000007825','南方基金管理股份有限公司')
,('0600182006','浙江丽水莲都农村商业银行股份有限公司')
,('0600184072','东海证券股份有限公司')
,('0600184125','西部证券股份有限公司')
,('0600186005','三菱日联银行(中国)有限公司')
,('0600050031','葫芦岛银行股份有限公司')
,('0600200082','浙江建德农村商业银行股份有限公司')
,('0600740000','淮南淮河农村商业银行股份有限公司')
,('0600750003','澄城县农村信用合作联社')
,('0600760081','江西新建农村商业银行股份有限公司')
,('0600826051','华宝基金管理有限公司')
,('0600080023','西安银行股份有限公司')
,('0600158149','阜阳颍淮农村商业银行股份有限公司')
,('0600164032','东方证券股份有限公司')
,('0600992007','河南新郑农村商业银行股份有限公司')
,('0000002318','浙江义乌农村商业银行股份有限公司')
,('0000004602','铜陵农村商业银行股份有限公司')
,('0000007010','易方达基金管理有限公司')
,('0000007609','峨山彝族自治县农村信用合作联社')
,('0000008583','河南通许农村商业银行股份有限公司')
,('0600054054','宏信证券有限责任公司')
,('0600130007','中国长城资产管理股份有限公司')
,('0600156290','山东广饶农村商业银行股份有限公司')
,('0600170002','黑河农村商业银行股份有限公司')
,('0600276001','安徽广德农村商业银行股份有限公司')
,('0600324001','湖南安乡农村商业银行股份有限公司')
,('0600562006','宁银理财有限责任公司')
,('0600608004','江苏盐城农村商业银行股份有限公司')
,('0600716032','陕西富县农村合作银行')
,('0600716056','陕西商南农村商业银行股份有限公司')
,('0600758001','河南长垣农村商业银行股份有限公司')
,('0000006996','泰康资产管理有限责任公司')
,('0600004005','广西北部湾银行股份有限公司')
,('0600052005','新疆银行股份有限公司')
,('0600112077','国投泰康信托有限公司')
,('0600132022','阳光人寿保险股份有限公司')
,('0600156360','盐亭县农村信用合作联社')
,('0600182013','河南获嘉农村商业银行股份有限公司')
,('0600274000','广西桂林漓江农村合作银行')
,('0000001319','邯郸银行股份有限公司')
,('0000002224','国通信托有限责任公司')
,('0600318007','陕西旬阳农村商业银行股份有限公司')
,('0600646008','江苏民丰农村商业银行股份有限公司')
,('0600826145','湘财证券股份有限公司')
,('0600120004','黑龙江省农村信用社联合社')
,('0600200048','浙江磐安农村商业银行股份有限公司')
,('0600248000','中国人民人寿保险股份有限公司')
,('0600290017','株洲农村商业银行股份有限公司')
,('0600330015','安徽太湖农村商业银行股份有限公司')
,('0600370000','三井住友银行(中国)有限公司')
,('0600470002','浙江台州路桥农村商业银行股份有限公司')
,('0600570018','恒生银行(中国)有限公司')
,('0600600107','铜川市王益区农村信用合作联社')
,('0600632006','山西银行股份有限公司')
,('0600760030','江西黎川农村商业银行股份有限公司')
,('0000001458','中建投信托股份有限公司')
,('0000002154','湖北大冶泰隆村镇银行有限责任公司')
,('0000007205','广州农村商业银行股份有限公司')
,('0000008730','山东成武农村商业银行股份有限公司')
,('0600000006','光大证券股份有限公司')
,('0600030133','河南辉县农村商业银行股份有限公司')
,('0600074036','浙江安吉农村商业银行股份有限公司')
,('0600082007','抚顺银行股份有限公司')
,('0000002332','温州银行股份有限公司')
,('0000005339','青岛农村商业银行股份有限公司')
,('0000005935','珠海华润银行股份有限公司')
,('0000007445','深圳前海微众银行股份有限公司')
,('0600006064','保定银行股份有限公司')
,('0600008055','兴平市农村信用合作联社')
,('0600030090','徽商银行股份有限公司')
,('0600070010','四川简阳农村商业银行股份有限公司')
,('0600092027','浙江临安农村商业银行股份有限公司')
,('0600128002','北京银行股份有限公司')
,('0600158223','江苏南通农村商业银行股份有限公司')
,('0600164083','山东莒南农村商业银行股份有限公司')
,('0600164090','哈尔滨农村商业银行股份有限公司')
,('0600180005','浙江平湖农村商业银行股份有限公司')
,('0600552003','池州九华农村商业银行股份有限公司')
,('0600726001','浙江龙泉农村商业银行股份有限公司')
,('0600742008','文水县农村信用合作联社')
,('0600760013','河南固始农村商业银行股份有限公司')
,('0600760074','江西赣昌农村商业银行股份有限公司')
,('0600844008','连云港东方农村商业银行股份有限公司')
,('0600948006','武安市农村信用联社股份有限公司')
,('0600974009','招银金融租赁有限公司')
,('0000004688','吉林德惠农村商业银行股份有限公司')
,('0000004765','阳光资产管理股份有限公司')
,('0000005649','攀枝花市商业银行股份有限公司')
,('0000005764','上海银行股份有限公司')
,('0000006523','财通证券资产管理有限公司')
,('0000007647','方正证券股份有限公司')
,('0000008521','河南尉氏农村商业银行股份有限公司')
,('0000008646','陕西定边农村商业银行股份有限公司')
,('0600028054','郑州银行股份有限公司')
,('0600030049','富滇银行股份有限公司')
,('0600030143','新沃基金管理有限公司')
,('0600036022','惠州农村商业银行股份有限公司')
,('0600054013','安徽肥东农村商业银行股份有限公司')
,('0600094025','河南太康农村商业银行股份有限公司')
,('0600184166','东莞证券股份有限公司')
,('0600376000','上汽通用汽车金融有限责任公司')
,('0600690006','青银理财有限责任公司')
,('0600000057','厦门国际银行股份有限公司')
,('0600026106','浙江台州黄岩农村商业银行股份有限公司')
,('0600030008','山东郓城农村商业银行股份有限公司')
,('0600102023','福建龙海泰隆村镇银行股份有限公司')
,('0600158021','江苏紫金农村商业银行股份有限公司')
,('0600328003','安徽宁国农村商业银行股份有限公司')
,('0600378001','上海东方证券资产管理有限公司')
,('0600696006','广东雷州农村商业银行股份有限公司')
,('0600712006','中金基金管理有限公司')
,('0600718006','湖南岳阳农村商业银行股份有限公司')
,('0600778000','巴克莱银行')
,('0600994005','陕西佳县农村商业银行股份有限公司')
,('0601122019','河南农村商业联合银行股份有限公司')
,('0600300006','安徽郎溪农村商业银行股份有限公司')
,('0600372001','江苏睢宁农村商业银行股份有限公司')
,('0000001441','浙江南浔农村商业银行股份有限公司')
,('0000006491','绵阳市涪城区农村信用合作联社')
,('0000007128','哈尔滨银行股份有限公司')
,('0000008778','乌兰察布农村商业银行股份有限公司')
,('0600000023','中国银行股份有限公司')
,('0600002007','平安信托有限责任公司')
,('0600026046','宁波慈溪农村商业银行股份有限公司')
,('0600026123','江苏太仓农村商业银行股份有限公司')
,('0600156071','南京证券股份有限公司')
,('0600212042','河北衡水农村商业银行股份有限公司')
,('0000008280','中信银行股份有限公司')
,('0000008684','湖北恩施农村商业银行股份有限公司')
,('0600108006','日照银行股份有限公司')
,('0600128012','北京农村商业银行股份有限公司')
,('0600156215','宁夏黄河农村商业银行股份有限公司')
,('0600156403','湖州吴兴农村商业银行股份有限公司')
,('0600184055','华龙证券股份有限公司')
,('0600308004','略阳县农村信用合作联社')
,('0600312000','江苏洪泽农村商业银行股份有限公司')
,('0600486005','汇丰银行(中国)有限公司')
,('0600600003','陕西榆林农村商业银行股份有限公司')
,('0600750054','陕西白河农村商业银行股份有限公司')
,('0600912007','南华基金管理有限公司')
,('0000001302','长安国际信托股份有限公司')
,('0000005447','锦州银行股份有限公司')
,('0000005524','南京银行股份有限公司')
,('0000006749','大连银行股份有限公司')
,('0000007926','摩根士丹利基金管理(中国)有限公司')
,('0000008141','安徽明光农村商业银行股份有限公司')
,('0600008021','山东乳山农村商业银行股份有限公司')
,('0600030059','广东顺德农村商业银行股份有限公司')
,('0600050004','富平县农村信用合作联社')
,('0600050014','中国外贸金融租赁有限公司')
,('0600132066','东吴基金管理有限公司')
,('0600156182','河北唐山农村商业银行股份有限公司')
,('0600600071','宁强县农村信用合作联社')
,('0600842007','华侨永亨银行(中国)有限公司')
,('0000001674','浙江温岭联合村镇银行股份有限公司')
,('0000002248','万家基金管理有限公司')
,('0000004640','安信信托股份有限公司')
,('0000008095','上海光大证券资产管理有限公司')
,('0000008413','交通银行股份有限公司')
,('0000008723','宁波奉化农村商业银行股份有限公司')
,('0600022003','渤海银行股份有限公司')
,('0600156326','山东威海农村商业银行股份有限公司')
,('0600164066','浙江常山农村商业银行股份有限公司')
,('0600200072','山东东平农村商业银行股份有限公司')
,('0600214009','安徽无为农村商业银行股份有限公司')
,('0600288116','平安国际融资租赁有限公司')
,('0600610009','浙江桐乡农村商业银行股份有限公司')
,('0600664006','江苏省农村信用社联合社')
,('0600704004','广银理财有限责任公司')
,('0600760057','江西瑞昌农村商业银行股份有限公司')
,('0600784028','江苏高淳农村商业银行股份有限公司')
,('0600830003','诺德基金管理有限公司')
,('0600882002','江苏句容农村商业银行股份有限公司')
,('0000007337','广东南粤银行股份有限公司')
,('0000007786','华夏银行股份有限公司')
,('0600156259','本溪银行股份有限公司')
,('0600156276','六安农村商业银行股份有限公司')
,('0600158089','浙江富阳农村商业银行股份有限公司')
,('0600184048','国盛证券有限责任公司')
,('0600200065','山东章丘农村商业银行股份有限公司')
,('0600232007','江门农村商业银行股份有限公司')
,('0600956001','兴业金融租赁有限责任公司')
,('0601120001','商城县农村信用合作联社')
,('0000007320','招商基金管理有限公司')
,('0600006074','广东华兴银行股份有限公司')
,('0600134023','中信证券股份有限公司')
,('0000002130','芜湖扬子农村商业银行股份有限公司')
,('0000005973','湖南银行股份有限公司')
,('0000006864','江西银行股份有限公司')
,('0600108013','石嘴山银行股份有限公司')
,('0600158173','鄂尔多斯农村商业银行股份有限公司')
,('0600158267','江苏兴化农村商业银行股份有限公司')
,('0600404004','江苏苏州农村商业银行股份有限公司')
,('0600694008','平安理财有限责任公司')
,('0600816007','洛阳农村商业银行股份有限公司')
,('0000005308','汉口银行股份有限公司')
,('0000005656','华宝信托有限责任公司')
,('0000008259','上海浦东发展银行股份有限公司')
,('0000008398','广发银行股份有限公司')
,('0600076044','广东英德泰隆村镇银行有限责任公司')
,('0600110001','国泰君安证券股份有限公司')
,('0600130031','中邮消费金融有限公司')
,('0600156266','友利银行(中国)有限公司')
,('0600156377','三原县农村信用合作联社')
,('0600158300','泸州银行股份有限公司')
,('0600158317','齐商银行股份有限公司')
,('0600296000','陕西岐山农村商业银行股份有限公司')
,('0600516007','山西河津农村商业银行股份有限公司')
,('0600824026','浙商证券股份有限公司')
,('0600954000','中美联泰大都会人寿保险有限公司')
,('0000006314','山西运城农村商业银行股份有限公司')
,('0000007344','新疆汇和银行股份有限公司')
,('0600028020','长安银行股份有限公司')
,('0000000815','宁波鄞州农村商业银行股份有限公司')
,('0000002774','吉林九台农村商业银行股份有限公司')
,('0600006006','浙江临海农村商业银行股份有限公司')
,('0600026113','浙江乐清农村商业银行股份有限公司')
,('0600102013','宁波宁海农村商业银行股份有限公司')
,('0600118009','金鹰基金管理有限公司')
,('0600142018','广东揭阳农村商业银行股份有限公司')
,('0600184065','万联证券股份有限公司')
,('0600650004','吉林亿联银行股份有限公司')
,('0000006129','鹏华基金管理有限公司')
,('0600000016','兴业基金管理有限公司')
,('0600026053','山西昔阳农村商业银行股份有限公司')
,('0600058012','江苏海安农村商业银行股份有限公司')
,('0600074046','河南中牟农村商业银行股份有限公司')
,('0600096009','安徽来安农村商业银行股份有限公司')
,('0600160009','诺安基金管理有限公司')
,('0600326002','浙江淳安农村商业银行股份有限公司')
,('0600352012','江苏建湖农村商业银行股份有限公司')
,('0600648009','江苏宜兴农村商业银行股份有限公司')
,('0600824043','财达证券股份有限公司')
,('0000002022','龙江银行股份有限公司')
,('0000002471','吉林银行股份有限公司')
,('0600016009','河南沈丘农村商业银行股份有限公司')
,('0600020012','湖北利川农村商业银行股份有限公司')
,('0600026012','东吴证券股份有限公司')
,('0600094018','甘孜农村商业银行股份有限公司')
,('0600158240','福建石狮农村商业银行股份有限公司')
,('0600612007','招银理财有限责任公司')
,('0600828001','广东南海农村商业银行股份有限公司')
,('0601054003','广东五华农村商业银行股份有限公司')
,('0601086003','江苏泗洪农村商业银行股份有限公司')
,('0000005959','南洋商业银行(中国)有限公司')
,('0000006136','重庆三峡银行股份有限公司')
,('0000007685','华能贵诚信托有限公司')
,('0000007988','宁波东海银行股份有限公司')
,('0000008367','中国进出口银行')
,('0600008048','湖南芷江农村商业银行股份有限公司')
,('0600024004','贵阳银行股份有限公司')
,('0600028003','河南台前农村商业银行股份有限公司')
,('0600066017','申港证券股份有限公司')
,('0600088014','东莞信托有限公司')
,('0600156208','珠海农村商业银行股份有限公司')
,('0600158096','浙江永康农村商业银行股份有限公司')
,('0600184014','英大证券有限责任公司')
,('0600206004','湖北三峡农村商业银行股份有限公司')
,('0600304005','浙江仙居农村商业银行股份有限公司')
,('0600310009','陕西紫阳农村商业银行股份有限公司')
,('0600588029','天津信托有限责任公司')
,('0000003038','江苏泰州农村商业银行股份有限公司')
,('0000004563','长春发展农村商业银行股份有限公司')
,('0000007654','华澳国际信托有限公司')
,('0600026002','威海市商业银行股份有限公司')
,('0600288157','阳光保险集团股份有限公司')
,('0600316009','武功县农村信用合作联社')
,('0600320012','浙江嘉善农村商业银行股份有限公司')
,('0600026070','江苏滨海农村商业银行股份有限公司')
,('0600050021','丹东银行股份有限公司')
,('0600100015','赣州农村商业银行股份有限公司')
,('0600524002','肇庆农村商业银行股份有限公司')
,('0600536006','山西垣曲农村商业银行股份有限公司')
,('0600826078','中泰证券股份有限公司')
,('0600826085','德邦证券股份有限公司')
,('0600838004','福建晋江农村商业银行股份有限公司')
,('0000002851','浙江义乌联合村镇银行股份有限公司')
,('0600156030','华安证券股份有限公司')
,('0600156054','江海证券有限公司')
,('0600156410','广东博罗农村商业银行股份有限公司')
,('0600158180','江苏大丰农村商业银行股份有限公司')
,('0600942006','交银金融租赁有限责任公司')
,('0000005601','厦门国际信托有限公司')
,('0000006066','江苏江南农村商业银行股份有限公司')
,('0000007351','德阳农村商业银行股份有限公司')
,('0000003300','乌海银行股份有限公司')
,('0000005896','厦门银行股份有限公司')
,('0000008716','聊城农村商业银行股份有限公司')
,('0600028047','景德镇农村商业银行股份有限公司')
,('0600030015','无锡农村商业银行股份有限公司')
,('0600034007','吕梁农村商业银行股份有限公司')
,('0600096016','广东开平农村商业银行股份有限公司')
,('0600114017','宜春农村商业银行股份有限公司')
,('0600156242','新韩银行(中国)有限公司')
,('0600158216','湖南浏阳农村商业银行股份有限公司')
,('0600264007','五矿国际信托有限公司')
,('0600314008','网联清算有限公司')
,('0600468007','江苏淮安农村商业银行股份有限公司')
,('0600620002','四川大竹农村商业银行股份有限公司')
,('0600764005','浙江开化农村商业银行股份有限公司')
,('0600814006','河南宜阳农村商业银行股份有限公司')
,('0000005555','泉州银行股份有限公司')
,('0000005810','赣州银行股份有限公司')
,('0000006198','华夏基金管理有限公司')
,('0000006509','江苏如皋农村商业银行股份有限公司')
,('0600008014','广东惠东农村商业银行股份有限公司')
,('0600012017','嘉实基金管理有限公司')
,('0600014018','浙江永嘉农村商业银行股份有限公司')
,('0600100005','泾阳县农村信用合作联社')
,('0600156343','福建长乐农村商业银行股份有限公司')
,('0600254004','浙江龙游农村商业银行股份有限公司')
,('0600550002','江苏姜堰农村商业银行股份有限公司')
,('0600702003','康保县农村信用联社股份有限公司')
,('0600746007','宜君县农村信用合作联社')
,('0600946008','湖南洪江农村商业银行股份有限公司')
,('0600534005','沈阳农村商业银行股份有限公司')
,('0600760064','江西进贤农村商业银行股份有限公司')
,('0600826044','柳州银行股份有限公司')
,('0601094015','湖北随州农村商业银行股份有限公司')
,('0000001294','渤海国际信托股份有限公司')
,('0000002091','张家口银行股份有限公司')
,('0000006554','广发证券股份有限公司')
,('0600006057','洛阳银行股份有限公司')
,('0600078011','安徽枞阳农村商业银行股份有限公司')
,('0600156013','国融证券股份有限公司')
,('0600158062','济南农村商业银行股份有限公司')
,('0600200031','湖南湘江新区农村商业银行股份有限公司')
,('0600210034','山东单县农村商业银行股份有限公司')
,('0600420001','山西永济农村商业银行股份有限公司')
,('0000003146','中邮证券有限责任公司')
,('0000005593','西藏金融租赁有限公司')
,('0000005788','江苏常熟农村商业银行股份有限公司')
,('0000005997','温州民商银行股份有限公司')
,('0000007577','河北省金融租赁有限公司')
,('0000007964','中英人寿保险有限公司')
,('0600018000','江苏银行股份有限公司')
,('0600112019','中信信托有限责任公司')
,('0600500004','广东新兴农村商业银行股份有限公司')
,('0600616006','高盛高华证券有限责任公司')
,('0600044010','沧州银行股份有限公司')
,('0600052012','铁岭银行股份有限公司')
,('0600070003','中国石化财务有限责任公司')
,('0600112026','渤海证券股份有限公司')
,('0600156020','海通证券股份有限公司')
,('0600156165','临商银行股份有限公司')
,('0600158233','江苏东台农村商业银行股份有限公司')
,('0600204006','横琴华通金融租赁有限公司')
,('0600212008','井研县农村信用合作联社')
,('0600234005','比亚迪汽车金融有限公司')
,('0600476009','衡水银行股份有限公司')
,('0600716066','陕西宝鸡金台农村商业银行股份有限公司')
,('0600760006','湖南星沙农村商业银行股份有限公司')
,('0601008004','招商永隆银行有限公司')
,('0000005618','四川信托有限公司')
,('0000006516','广发证券资产管理(广东)有限公司')
,('0000006547','江苏扬州农村商业银行股份有限公司')
,('0000006617','湖南邵阳昭阳农村商业银行股份有限公司')
,('0000007957','光大永明人寿保险有限公司')
,('0000008266','中国光大银行股份有限公司')
,('0600028037','浙江绍兴瑞丰农村商业银行股份有限公司')
,('0600058005','建信信托有限责任公司')
,('0600078028','浙江萧山农村商业银行股份有限公司')
,('0600090009','长城证券股份有限公司')
,('0600156232','江苏如东农村商业银行股份有限公司')
,('0600184108','国联证券股份有限公司')
,('0600236006','鑫元基金管理有限公司')
,('0600502005','浙江浙商证券资产管理有限公司')
,('0600654003','阳泉农村商业银行股份有限公司')
,('0600724010','湖南衡阳衡州农村商业银行股份有限公司')
,('0601084002','开源证券股份有限公司')
,('0601124000','陕西山阳农村商业银行股份有限公司')
,('0000002604','浙江杭州余杭农村商业银行股份有限公司')
,('0000003362','鹰潭农村商业银行股份有限公司')
,('0000004354','秦皇岛银行股份有限公司')
,('0000008381','中国农业银行股份有限公司')
,('0600126004','深圳农村商业银行股份有限公司')
,('0600136024','山东齐河农村商业银行股份有限公司')
,('0600156088','中信建投证券股份有限公司')
,('0600238007','梅州农村商业银行股份有限公司')
,('0600402006','光大兴陇信托有限责任公司')
,('0600538004','五矿证券有限公司')
,('0600548000','北部湾财产保险股份有限公司')
,('0600716022','陕西宁陕农村商业银行股份有限公司')
,('0600846006','山西稷山农村商业银行股份有限公司')
,('0600952019','黑龙江克山农村商业银行股份有限公司')
,('0601130004','浦银金融租赁股份有限公司')
,('0000005562','厦门农村商业银行股份有限公司')
,('0000005889','浙江新昌农村商业银行股份有限公司')
,('0000008088','博时基金管理有限公司')
,('0600026080','福建南安农村商业银行股份有限公司')
,('0600040011','承德银行股份有限公司')
,('0600040028','焦作中旅银行股份有限公司')
,('0600052022','华金证券股份有限公司')
,('0600148001','平顶山银行股份有限公司')
,('0600156148','合肥科技农村商业银行股份有限公司')
,('0600244001','邦银金融租赁股份有限公司')
,('0600556002','中邮理财有限责任公司')
,('0600750020','陕西安塞农村商业银行股份有限公司')
,('0600826135','湖北银行股份有限公司')
,('0600826152','国都证券股份有限公司')
,('0000002084','金华银行股份有限公司')
,('0000002301','雪松国际信托股份有限公司')
,('0000004587','盛京银行股份有限公司')
,('0000005663','贵州银行股份有限公司')
,('0000008691','浙江舟山普陀农村商业银行股份有限公司')
,('0600012000','福建政和泰隆村镇银行有限责任公司')
,('0600200055','浙江泰顺农村商业银行股份有限公司')
,('0600352005','江苏阜宁农村商业银行股份有限公司')
,('0600600088','志丹县农村信用合作联社')
,('0600700005','广元市贵商村镇银行股份有限公司')
,('0600730004','郑州农村商业银行股份有限公司')
,('0600774008','河南原阳农村商业银行股份有限公司')
,('0600826128','武汉众邦银行股份有限公司')
,('0600990006','山东张店农村商业银行股份有限公司')
,('0601116008','山东鄄城农村商业银行股份有限公司')
,('0000007779','东兴证券股份有限公司')
,('0600114027','浙江浦江农村商业银行股份有限公司')
,('0600132032','东莞银行股份有限公司')
,('0600158011','苏州金融租赁股份有限公司')
,('0600168007','山东巨野农村商业银行股份有限公司')
,('0600540009','辽宁东港农村商业银行股份有限公司')
,('0600676000','河南安阳商都农村商业银行股份有限公司')
,('0600722019','内蒙古五原农村商业银行股份有限公司')
,('0600732005','河南博爱农村商业银行股份有限公司')
,('0600770009','光大理财有限责任公司')
,('0600826092','华创证券有限责任公司')
,('0600872009','中国国际金融股份有限公司')
,('0601106002','富达基金管理(中国)有限公司')
,('0000001504','中原信托有限公司')
,('0000005500','长沙银行股份有限公司')
,('0000008305','中国邮政储蓄银行股份有限公司')
,('0000008817','浙江海盐农村商业银行股份有限公司')
,('0600062008','河北省农村信用社联合社')
,('0600086013','安徽五河农村商业银行股份有限公司')
,('0600286004','衡阳农村商业银行股份有限公司')
,('0600388004','华商银行股份有限公司')
,('0000002628','吉林省信托有限责任公司')
,('0000005430','汇添富基金管理股份有限公司')
,('0000006244','国信证券股份有限公司')
,('0600156107','中国对外经济贸易信托有限公司')
,('0600158190','新疆喀什农村商业银行股份有限公司')
,('0600174001','雅安农村商业银行股份有限公司')
,('0600216000','陕西秦农农村商业银行股份有限公司')
,('0600280004','陕西旬阳泰隆村镇银行股份有限公司')
,('0600448008','韩国国民银行')
,('0600480005','大连农村商业银行股份有限公司')
,('0600598008','浙江衢州柯城农村商业银行股份有限公司')
,('0600602004','洋县农村信用合作联社')
,('0600750010','陕西镇巴农村商业银行股份有限公司')
,('0601040008','浙江平阳农村商业银行股份有限公司')
,('0000001179','中国东方资产管理股份有限公司')
,('0000001225','中国中信金融资产管理股份有限公司')
,('0000007375','紫金信托有限责任公司')
,('0000008862','四川乐至农村商业银行股份有限公司')
,('0600006030','山东滕州农村商业银行股份有限公司')
,('0600854001','湖南临澧农村商业银行股份有限公司')
,('0000002217','杭州银行股份有限公司')
,('0000005733','浙江网商银行股份有限公司')
,('0000006097','华泰柏瑞基金管理有限公司')
,('0000006530','银河金汇证券资产管理有限公司')
,('0600006040','乌鲁木齐银行股份有限公司')
,('0600010009','山东莱州农村商业银行股份有限公司')
,('0600300013','湖南津市农村商业银行股份有限公司')
,('0600604005','麦高证券有限责任公司')
,('0600634014','西南证券股份有限公司')
,('0600826196','农银汇理基金管理有限公司')
,('0600076037','湖北十堰农村商业银行股份有限公司')
,('0600116008','萍乡农村商业银行股份有限公司')
,('0600132049','兴业证券股份有限公司')
,('0600156333','江苏溧水农村商业银行股份有限公司')
,('0600184132','中山证券有限责任公司')
,('0600356004','财信证券股份有限公司')
,('0600600054','淳化县农村信用合作联社')
,('0601132005','凉山农村商业银行股份有限公司')
,('0000006213','唐山银行股份有限公司')
,('0600000040','广州银行股份有限公司')
,('0600008031','浙江海宁农村商业银行股份有限公司')
,('0600158105','中山农村商业银行股份有限公司')
,('0600192016','潍坊农村商业银行股份有限公司')
,('0600332006','中国人寿保险股份有限公司')
,('0600596014','陕西洛川农村商业银行股份有限公司')
,('0600600013','陕西丹凤农村商业银行股份有限公司')
,('0600600020','陕西省农村信用社联合社')
,('0600636005','东方基金管理股份有限公司')
,('0600728026','江西大余农村商业银行股份有限公司')
,('0000003324','国泰元鑫资产管理有限公司')
,('0000004431','贵州仁怀茅台农村商业银行股份有限公司')
,('0000002457','云南国际信托有限公司')
,('0000003045','宁波银行股份有限公司')
,('0000006927','皖江金融租赁股份有限公司')
,('0000007856','河北沧州农村商业银行股份有限公司')
,('0000008879','宁波甬城农村商业银行股份有限公司')
,('0600006023','沐川县农村信用合作联社')
,('0600156283','长治银行股份有限公司')
,('0600190018','恒泰证券股份有限公司')
,('0600194041','上海国际货币经纪有限责任公司')
,('0600228001','三一汽车金融有限公司')
,('0600300023','安徽桐城农村商业银行股份有限公司')
,('0600556012','山西古县农村商业银行股份有限公司')
,('0600598015','焦作市马村区农村信用合作联社')
,('0600630005','北京中关村银行股份有限公司')
,('0600714007','浦银理财有限责任公司')
,('0600760040','江西永修农村商业银行股份有限公司')
,('0601094022','万和证券股份有限公司')
,('0601126001','太平洋证券股份有限公司')
,('0000004291','华安财保资产管理有限责任公司')
,('0000008158','广东潮阳农村商业银行股份有限公司')
,('0000008824','四川旺苍农村商业银行股份有限公司')
,('0600114000','天津滨海农村商业银行股份有限公司')
,('0600156225','营口沿海银行股份有限公司')
,('0600158045','江苏泰兴农村商业银行股份有限公司')
,('0600158115','江苏启东农村商业银行股份有限公司')
,('0600184099','华林证券股份有限公司')
,('0600288046','阳光财产保险股份有限公司')
,('0600302014','广东四会农村商业银行股份有限公司')
,('0600744016','渭南市临渭区农村信用合作联社')
,('0600194017','中央国债登记结算有限责任公司')
,('0600292018','湖南华容农村商业银行股份有限公司')
,('0600600030','陕西平利农村商业银行股份有限公司')
,('0600678008','江苏盱眙农村商业银行股份有限公司')
,('0600728009','陕西陇县农村商业银行股份有限公司')
,('0600826162','富邦华一银行有限公司')
,('0000001605','内蒙古银行股份有限公司')
,('0000002743','浙江天台民生村镇银行股份有限公司')
,('0000005702','昆仑银行股份有限公司')
,('0000006004','中银基金管理有限公司')
,('0000006042','天弘基金管理有限公司')
,('0000006338','浙商银行股份有限公司')
,('0000006826','自贡银行股份有限公司')
,('0000008329','苏州银行股份有限公司')
,('0000008336','绍兴银行股份有限公司')
,('0000008569','桂林银行股份有限公司')
,('0600158139','浙江上虞农村商业银行股份有限公司')
,('0600164109','中信银行国际(中国)有限公司')
,('0000001612','贵阳市南明区农村信用合作联社')
,('0000005771','东莞农村商业银行股份有限公司')
,('0000005834','晋中银行股份有限公司')
,('0000007212','天津银行股份有限公司')
,('0000008350','中国工商银行股份有限公司')
,('0600074053','四川三台农村商业银行股份有限公司')
,('0600094035','安徽霍邱农村商业银行股份有限公司')
,('0600118016','新华基金管理股份有限公司')
,('0600190042','湖北仙桃农村商业银行股份有限公司')
,('0600582005','蜂巢基金管理有限公司')
,('0600706002','河南修武农村商业银行股份有限公司')
,('0600760098','江西万载农村商业银行股份有限公司')
,('0600944007','中粮信托有限责任公司')
,('0000004626','晋城农村商业银行股份有限公司')
,('0000007995','国厚资产管理股份有限公司')
,('0000008639','资中县农村信用合作联社')
,('0000008855','山东阳谷农村商业银行股份有限公司')
,('0600048002','雅安市商业银行股份有限公司')
,('0600086006','百瑞信托有限责任公司')
,('0600158072','浙江诸暨农村商业银行股份有限公司')
,('0600190076','湖南衡山农村商业银行股份有限公司')
,('0600634004','富荣基金管理有限公司')
,('0600760107','江西高安农村商业银行股份有限公司')
,('0600896007','浙江宁银消费金融股份有限公司')
,('0000001580','上饶银行股份有限公司')
,('0000002673','西部信托有限公司')
,('0000005322','富国基金管理有限公司')
,('0000006112','建信基金管理有限责任公司')
,('0000006819','九江农村商业银行股份有限公司')
,('0000008482','浙江桐庐农村商业银行股份有限公司')
,('0000008831','广安农村商业银行股份有限公司')
,('0600026097','晋商银行股份有限公司')
,('0600184159','中银国际证券股份有限公司')
,('0600190001','河南新密农村商业银行股份有限公司')
,('0600204013','江苏苏商银行股份有限公司')
,('0600210027','四川泸县农村商业银行股份有限公司')
,('0600272002','河南汝南泰隆村镇银行股份有限公司')
,('0600302004','浙江农村商业联合银行股份有限公司')
,('0600358002','大华银行(中国)有限公司')
,('0600772017','城银清算服务有限责任公司')
,('0600794007','湖南东安农村商业银行股份有限公司')
,('0600898005','中国人民财产保险股份有限公司')
,('0601086037','山东莱阳农村商业银行股份有限公司')
,('0000008709','新疆昌吉农村商业银行股份有限公司')
,('0600014001','山东荣成农村商业银行股份有限公司')
,('0600036008','潍坊银行股份有限公司')
,('0600112009','中航信托股份有限公司')
,('0600158038','贵阳农村商业银行股份有限公司')
,('0600158274','江苏海门农村商业银行股份有限公司')
,('0600212025','四川仁寿农村商业银行股份有限公司')
,('0600294009','陕西眉县泰隆村镇银行股份有限公司')
,('0600430007','泰康养老保险股份有限公司')
,('0600488003','贵州毕节农村商业银行股份有限公司')
,('0600734003','内蒙古宁城农村商业银行股份有限公司')
,('0600822001','百年保险资产管理有限责任公司')
,('0600840009','同方全球人寿保险有限公司')
,('0000008420','中国农业发展银行')
,('0600054047','上海农村商业银行股份有限公司')
,('0600078035','山西忻州农村商业银行股份有限公司')
,('0600078079','新余农村商业银行股份有限公司')
,('0600158156','浙江苍南农村商业银行股份有限公司')
,('0600200014','鞍山银行股份有限公司')
,('0600212035','浙江玉环农村商业银行股份有限公司')
,('0600320002','湖南新化农村商业银行股份有限公司')
,('0600426001','鑫沅资产管理有限公司')
,('0600582029','汇安基金管理有限责任公司')
,('0600594006','山西夏县农村商业银行股份有限公司')
,('0600744023','陕西凤翔农村商业银行股份有限公司')
,('0600826101','宁夏银行股份有限公司')
,('0000003230','辽阳银行股份有限公司')
,('0000006871','乐山市商业银行股份有限公司')
,('0000006910','华泰证券股份有限公司')
,('0000007623','海亮集团财务有限责任公司')
,('0000003386','浙江天台农村商业银行股份有限公司')
,('0000006321','国民信托有限公司')
,('0000006585','中国银河证券股份有限公司')
,('0000007089','邢台银行股份有限公司')
,('0000008660','浙江金华成泰农村商业银行股份有限公司')
,('0600022013','江苏张家港农村商业银行股份有限公司')
,('0600026039','遂宁银行股份有限公司')
,('0600034014','云南红塔银行股份有限公司')
,('0600074002','陕西榆林榆阳农村商业银行股份有限公司')
,('0600076003','阜阳颍东农村商业银行股份有限公司')
,('0600078052','鲁山县农村信用合作联社')
,('0600158004','贵阳贵银金融租赁有限责任公司')
,('0600158122','长沙农村商业银行股份有限公司')
,('0600164042','青岛银行股份有限公司')
,('0600184149','国元证券股份有限公司')
,('0600212018','河南永城农村商业银行股份有限公司')
,('0600412009','中信百信银行股份有限公司')
,('0600570001','粤开证券股份有限公司')
,('0600716015','陕西绥德农村商业银行股份有限公司')
,('0600732012','江西都昌农村商业银行股份有限公司')
,('0600736004','兴银理财有限责任公司')
,('0600826186','国泰基金管理有限公司')
,('0600832004','河南伊川农村商业银行股份有限公司')
,('0600940008','河南汴京农村商业银行股份有限公司')
,('0000008444','达州银行股份有限公司')
,('0000008590','广州证券股份有限公司')
,('0600092017','四川广汉农村商业银行股份有限公司')
,('0600112050','上海国泰君安证券资产管理有限公司')
,('0600158291','阜新银行股份有限公司')
,('0600992014','陕西杨凌农村商业银行股份有限公司')
,('0600030032','东营银行股份有限公司')
,('0600030076','攀枝花农村商业银行股份有限公司')
,('0600076027','浙江德清农村商业银行股份有限公司')
,('0600298008','陕西泾阳泰隆村镇银行股份有限公司')
,('0600084005','天津农村商业银行股份有限公司')
,('0600146010','亿利集团财务有限公司')
,('0600462014','山西曲沃农村商业银行股份有限公司')
,('0600574017','三菱日联银行(中国)有限公司')
,('0600688004','山西尧都农村商业银行股份有限公司')
,('0600746017','商洛市商州区农村信用合作联社')
,('0600764015','河南光山农村商业银行股份有限公司')
,('0600792006','信阳市明港农村信用合作联社')
,('0600802012','辽宁省农村信用社联合社')
,('0600958002','扶余市农村信用合作联社')
,('0000002015','山西泽州农村商业银行股份有限公司')
,('0000002325','浙江民泰商业银行股份有限公司')
,('0000008134','山东微山农村商业银行股份有限公司')
,('0000008242','招商银行股份有限公司')
,('0000001528','青海银行股份有限公司')
,('0000005409','重庆农村商业银行股份有限公司')
,('0000008204','河南商水农村商业银行股份有限公司')
,('0000008312','国家开发银行')
,('0000008677','山东沂南农村商业银行股份有限公司')
,('0600146000','山西证券股份有限公司')
,('0600156394','北京顺义银座村镇银行股份有限公司')
,('0600728019','江苏响水农村商业银行股份有限公司')
,('0600750044','陕西咸阳渭城农村商业银行股份有限公司')
,('0600826017','华融金融租赁股份有限公司')
,('0000001388','浙江庆元泰隆村镇银行股份有限公司')
,('0000002387','中融国际信托有限公司')
,('0000006105','工银瑞信基金管理有限公司')
,('0000008071','上海爱建信托有限责任公司')
,('0600000030','湖北汉川农村商业银行股份有限公司')
,('0600008007','浙江瑞安农村商业银行股份有限公司')
,('0600028010','浙江东阳农村商业银行股份有限公司')
,('0600190069','河南滑县农村商业银行股份有限公司')
,('0600220003','广东龙门农村商业银行股份有限公司')
,('0600372018','河南杞县农村商业银行股份有限公司')
,('0600526000','江苏射阳农村商业银行股份有限公司')
,('0600610023','宁波北仑农村商业银行股份有限公司')
,('0600744009','陕西彬州农村商业银行股份有限公司')
,('0600826034','天风证券股份有限公司')
,('0000002200','湖州银行股份有限公司')
,('0000003494','晋城银行股份有限公司')
,('0000005872','甘肃银行股份有限公司')
,('0000005966','国新证券股份有限公司')
,('0000006989','浙江省浙商资产管理股份有限公司')
,('0000007065','重庆富民银行股份有限公司')
,('0000008127','成都银行股份有限公司')
,('0000008785','巴中农村商业银行股份有限公司')
,('0600028071','莱商银行股份有限公司')
,('0600048026','新疆天山农村商业银行股份有限公司')
,('0600106005','浙江台州椒江农村商业银行股份有限公司')
,('0600112033','平安养老保险股份有限公司')
,('0600112043','北方国际信托股份有限公司')
,('0600156131','江苏昆山农村商业银行股份有限公司')
,('0600156319','枣庄银行股份有限公司')
,('0600158055','佛山农村商业银行股份有限公司')
,('0600158209','浙江温州龙湾农村商业银行股份有限公司')
,('0600186012','东方证券承销保荐有限公司')
,('0600284006','河北安国农村商业银行股份有限公司')
,('0600468014','江苏靖江农村商业银行股份有限公司')
,('0600600098','黄陵县农村信用合作联社')
,('0600614008','禹州市农村信用合作联社')
,('0600644000','湖南桃江农村商业银行股份有限公司')
,('0600676027','鹤壁农村商业银行股份有限公司')
,('0600780002','安徽歙县农村商业银行股份有限公司')
,('0600824009','中加基金管理有限公司')
,('0600826205','浙江嵊州农村商业银行股份有限公司')
,('0600850002','江苏江都农村商业银行股份有限公司')
;

--客户证件类型	客户证件号码	客户当前注册资金（元）	注册资金币种	客户当前实收资本（元）	实收资本币种
--该客户名下是否存在我行账户（无论账户状态如何）（是/否）	若存在，账号	账户类型	当前账户状态（正常、不动户、转营业外、未启用、销户等）	开户机构	开户日期	销户机构	销户日期



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ty_zh_SJ2024101611_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_ty_zh_SJ2024101611_02 AS
SELECT  T1.客户统一编号
        ,T1.客户名称
        ,T4.cd_val_dscr         AS 客户证件类型
        ,T3.doc_nbr             AS 客户证件号码
        ,T2.REG_CPT             AS 注册资本
        ,T2.REG_CPT_CCY_CD      AS 注册资本币种
        ,T2.ACTL_RCV_CPT        AS 实收资本
        ,T2.ACTL_RCV_CPT_CCY_CD AS 实收资本币种代码
        ,CASE
           WHEN T7.CST_ID IS NOT NULL THEN '是'
           ELSE '否'
         END                    AS 该客户名下是否存在我行账户
        ,T7.cst_act_id          AS 客户账号
        ,T7.dep_act_id          AS 存款账号
        ,T7.prod_id             AS 产品ID
        ,T8.pd_cmt              AS 产品名称
        ,T9.cd_val_dscr         AS 账户分类代码1
        ,T10.cd_val_dscr        AS 账户分类代码2
        ,T11.cd_val_dscr        AS 当前账户状态
        ,T7.opn_org             AS 开户机构编号
        ,T12.org_nm             AS 开户机构
        ,T7.opn_dt              AS 开户日期
        ,T7.act_dstr_act_org    AS 销户机构编号
        ,T13.org_nm             AS 销户机构
        ,T7.act_dstr_act_dt     AS 销户日期
FROM    lab_bigdata_dev.tmp_ty_zh_SJ2024101611_01 T1
LEFT JOIN    edw.dim_cst_entp_bas_inf_dd T2 --企业客户基本信息
ON      T1.客户统一编号 = T2.CST_ID
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_bas_doc_inf_dd T3 --客户证件信息
ON      T1.客户统一编号 = T3.CST_ID
AND     T3.prm_doc_ind = '1' --主证件信息
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T4 -- 码值表
ON      T3.doc_typ_cd = T4.cd_val
AND     T4.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T4.fld_nm = 'DOC_TYP_CD'
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表
ON      T2.reg_cpt_ccy_cd = T5.cd_val
AND     T5.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T5.fld_nm = 'REG_CPT_CCY_CD'
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表
ON      T2.actl_rcv_cpt_ccy_cd = T6.cd_val
AND     T6.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T6.fld_nm = 'ACTL_RCV_CPT_CCY_CD'
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_bus_dep_act_inf_dd T7 --存款账户信息汇总
ON      T1.客户统一编号 = T7.CST_ID
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd T8 --存款产品基础信息表
ON      T7.prod_id = T8.pd_id
AND     T8.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T9 -- 码值表
ON      T7.act_ctg_cd_1 = T9.cd_val
AND     T9.tbl_nm = 'DWS_BUS_DEP_ACT_INF_DD'
AND     T9.fld_nm = 'ACT_CTG_CD_1'
AND     T9.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T10 -- 码值表
ON      T7.act_ctg_cd_2 = T10.cd_val
AND     T10.tbl_nm = 'DWS_BUS_DEP_ACT_INF_DD'
AND     T10.fld_nm = 'ACT_CTG_CD_2'
AND     T10.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T11 -- 码值表
ON      T7.act_sts_cd = T11.cd_val
AND     T11.tbl_nm = 'DWS_BUS_DEP_ACT_INF_DD'
AND     T11.fld_nm = 'ACT_STS_CD'
AND     T11.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T12 --机构树
ON      T7.opn_org = T12.org_id
AND     T12.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T13 --机构树
ON      T7.act_dstr_act_org = T13.org_id
AND     T13.DT = '@@{yyyyMMdd}';
**01-数据需求_分行_2025_D0102_台州分行_潘小菡_逾期信用卡客户地址数据.sql
-- 1.逾期信用卡持卡人身份证号码，户籍地址，居住地址，
-- 2.逾期信用卡担保人客户号，身份证号码，户籍地址，居住地址，
-- 3.逾期信用卡最后一笔消费日期（包括刷卡消费、取现、分期等）


-- SJ2025010366

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_01
-- (
   -- 序号		            STRING
  -- ,客户编号	            STRING
  -- ,卡号	                STRING
  -- ,客户名称	            STRING
  -- ,证件号	            STRING
  -- ,数据中心导出担保人    STRING
  -- ,1231本金	            STRING
  -- ,考核机构名称	        STRING
  -- ,推荐人姓名            STRING
-- ) ;




--1.地址
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_DZ PURGE;

CREATE TABLE lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_DZ AS
SELECT  A1.cst_id
        ,A1.dtl_addr
        ,A1.addr_typ
FROM    edw.loan_cst_ctc_addr A1
WHERE   A1.del_ind = '0'
AND     A1.DT = '@@{yyyyMMdd}'
AND     A1.addr_typ IN ( '050100' , '050200'  );




--2.持卡人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_02 AS
SELECT
   T1.卡号
   ,T0.late_trx_dt AS 逾期信用卡最后一笔消费日期
   ,CASE WHEN T1.证件号 <> '' THEN T1.证件号 ELSE T2.doc_nbr END AS  	逾期信用卡持卡人身份证号码
   ,T3.dtl_addr  AS 持卡人户籍地址
   ,T4.dtl_addr  AS 持卡人居住地址
FROM lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_01  T1
LEFT JOIN edw.dim_bus_crd_cr_crd_inf_dd T0 --信用卡卡片信息
ON  T1.卡号 = T0.cr_crd_card_nbr
AND T0.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_cst_bas_doc_inf_dd T2 --客户证件信息
ON  T1.客户编号 = T2.cst_id
AND T2.doc_typ_cd = 'B0101'
AND T2.DT = '@@{yyyyMMdd}'
LEFT JOIN  lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_DZ T3
ON  T1.客户编号 = T3.cst_id
AND T3.addr_typ ='050100'
LEFT JOIN  lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_DZ T4
ON  T1.客户编号 = T4.cst_id
AND T4.addr_typ ='050200' ;



--3.担保人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_03 AS
SELECT
   T1.卡号
   ,T3.WRNT_CST_ID  AS 担保人客户号
   ,T3.WRNT_CST_NM  AS 担保人客户名称
   ,T3.WRNT_DOC_NBR AS 担保人身份证号码
   ,T4.dtl_addr     AS 担保人户籍地址
   ,T5.dtl_addr     AS 担保人居住地址
FROM lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_01  T1
INNER JOIN edw.dim_bus_crd_cr_crd_inf_dd T2 --信用卡卡片信息
ON  T1.卡号 = T2.cr_crd_card_nbr
AND T2.DT = '@@{yyyyMMdd}'
INNER JOIN edw.dws_bus_grnt_prsn_inf_dd T3 --担保人汇总信息
ON   T2.busi_ctr_id = T3.bus_ctr_id
AND  T3.DT = '@@{yyyyMMdd}'
LEFT JOIN  lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_DZ T4
ON  T3.WRNT_CST_ID = T4.cst_id
AND T4.addr_typ ='050100'
LEFT JOIN  lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_DZ T5
ON  T3.WRNT_CST_ID = T5.cst_id
AND T5.addr_typ ='050200'
;

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_jgb PURGE;

CREATE TABLE lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_jgb AS
SELECT
   A1.序号
  ,A1.客户编号
  ,A1.卡号
  ,A1.客户名称
  ,A1.证件号
  ,A1.数据中心导出担保人
  ,A1.1231本金
  ,A1.考核机构名称
  ,A1.推荐人姓名
  ,A2.逾期信用卡最后一笔消费日期
  ,A2.逾期信用卡持卡人身份证号码
  ,A2.持卡人户籍地址
  ,A2.持卡人居住地址
  ,A3.担保人客户号
  ,A3.担保人客户名称
  ,A3.担保人身份证号码
  ,A3.担保人户籍地址
  ,A3.担保人居住地址
FROM lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_01  A1
LEFT JOIN lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_02  A2
ON A1.卡号 = A2.卡号
LEFT JOIN lab_bigdata_dev.tmp_XYK_yq_SJ2025010366_03  A3
ON A1.卡号 = A3.卡号
;
**01-数据需求_分行_2025_D0103_台州分行_朱宇鹏_信贷系统插叙痕迹.sql
--信贷查询日志目前数据只更新到20240719，

-- 客户：冯一帆
-- 客户号：1043820352
-- 身份证：331082199708274676
-- 查询信贷系统查看客户经理；

-- 客户出现苗头性事件，查询信贷系统查看客户经理；

--无数据
DROP TABLE IF EXISTS tmp_zfk_SJ2025010301 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2025010301 AS
SELECT  substr(aslp.date_only, 1, 10) 执行时间
        --  ,aslp.request_time  --请求时间
        -- ,aslp.request_message 请求信息
        ,REGEXP_REPLACE(aslp.request_message,'\\s','')  --替换数据中的逗号和回车，防止导出时excel错行,REGEXP_REPLACE( REPLACE(t3.description, ',', '|'),'\\s','|')
        ,aslp.user_code 用户号
        ,p.empe_nm 用户姓名
        ,aslp.org_id 机构号
        ,q.org_nm 机构名称
FROM    edw.loan_admin_sm_log_provider aslp --服务方交易日志表，增量表
LEFT JOIN    edw.dws_hr_empe_inf_dd p
ON      aslp.user_code = p.empe_id
AND     p.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd q
ON      aslp.org_id = q.org_id
AND     q.dt ='@@{yyyyMMdd}'
WHERE   aslp.dt <= '@@{yyyyMMdd}'
AND     aslp.SERVICE_CODE LIKE '/api/w/cst/cmm/corpbsc/detail'
AND     aslp.REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;1043820352&quot;%';
**01-数据需求_分行_2025_D0103_杭州分行_陈敏珠_逾期客户地址.sql
-- SJ20250102141_用于杭州分行逾期客户走访


-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_01
-- (
   -- 合同流水号_账户号	     STRING
  -- ,信用卡卡号	         STRING
  -- ,管户机构号	         STRING
  -- ,管户机构名称	         STRING
  -- ,客户名称	             STRING
  -- ,客户号	             STRING
  -- ,1231余额	             STRING
  -- ,业务品种              STRING
-- ) ;





-- 合同流水号、借款人姓名、客户号、管户机构号、借款人联系电话、家庭电话、
-- 户籍地址、户籍地址_省、户籍地址_市、户籍地址_区、
-- 居住地址、居住地址_省、居住地址_市、居住地址_区、
-- 经营地址、经营地址_省、经营地址_市、经营地址_区、
-- 永久地址、永久地址_省、永久地址_市、永久地址_区、
-- 办公地址、办公地址_省、办公地址_市、办公地址_区、
-- 管户机构名称、综合社区编号、综合社区名称、担保人客户号、担保人姓名、保证人序号（例如两个担保人就是1和2）、担保人联系电话、担保人家庭电话、
-- 担保人户籍地址、担保人户籍地址_省、担保人户籍地址_市、担保人户籍地址_区、
-- 担保人居住地址、担保人居住地址_省、担保人居住地址_市、担保人居住地址_区、
-- 担保人经营地址、担保人经营地址_省、担保人经营地址_市、担保人经营地址_区、
-- 担保人永久地址、担保人永久地址_省、担保人永久地址_市、担保人永久地址_区、
-- 担保人办公地址、担保人办公地址_省、担保人办公地址_市、担保人办公地址_区

-- 居住、户籍、经营、办公

-- 1.1 地址省市区
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ PURGE;

CREATE TABLE lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ AS
SELECT  A1.cst_id
        ,A1.dtl_addr
        ,A1.addr_typ
        ,A4.cd_val_dscr AS 省
        ,A3.cd_val_dscr AS 市
        ,A2.cd_val_dscr AS 区
FROM    edw.loan_cst_ctc_addr A1
LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表  区
ON      SUBSTR(A1.adiv, 1, 6) = A2.cd_val
AND     A2.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A2.fld_nm = 'C_HOME_ADDRESS_A'
AND     A2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表   市
ON      RPAD(SUBSTR(A1.adiv, 1, 4), 6, '0') = A3.cd_val
AND     A3.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A3.fld_nm = 'C_HOME_ADDRESS_A'
AND     A3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A4 -- 码值表  省
ON      RPAD(SUBSTR(A1.adiv, 1, 2), 6, '0') = A4.cd_val
AND     A4.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A4.fld_nm = 'C_HOME_ADDRESS_A'
AND     A4.DT = '@@{yyyyMMdd}'
WHERE   A1.del_ind = '0'
AND     A1.DT = '@@{yyyyMMdd}'
AND     A1.addr_typ IN ( '050100' , '050200' ,'050400', '050900' );



--2.借款人
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_02 AS
SELECT T1.合同流水号_账户号
       ,T1.信用卡卡号
       ,T1.管户机构号
       ,T1.管户机构名称
       ,T1.客户名称
       ,T1.客户号
       ,T1.1231余额
       ,T1.业务品种
       ,T2.cprh_cmnt_id  AS 综合社区编号
       ,T21.cmnt_nm	     AS 综合社区名称
       ,T3.ctc_tel       AS 联系电话
       ,T31.ctc_tel      AS 家庭电话
       ,T4.dtl_addr	     AS 户籍地址
       ,T4.省            AS 户籍地址_省
       ,T4.市            AS 户籍地址_市
       ,T4.区            AS 户籍地址_区
       ,T5.dtl_addr	     AS 住宅地址
       ,T5.省            AS 住宅地址_省
       ,T5.市            AS 住宅地址_市
       ,T5.区            AS 住宅地址_区
       ,T6.dtl_addr	     AS 经营地址
       ,T6.省            AS 经营地址_省
       ,T6.市            AS 经营地址_市
       ,T6.区            AS 经营地址_区
       ,T7.dtl_addr	     AS 办公地址
       ,T7.省            AS 办公地址_省
       ,T7.市            AS 办公地址_市
       ,T7.区            AS 办公地址_区
FROM lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_01 T1
LEFT JOIN edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON  T1.客户号  = T2.CST_ID
AND T2.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd T21 --社区信息
ON  T2.cprh_cmnt_id = T21.cmnt_enc
AND T21.DT = '@@{yyyyMMdd}'
LEFT JOIN (
            SELECT
                 A1.cst_id
				 ,WM_CONCAT(DISTINCT '、',A1.ctc_tel) AS ctc_tel   --一个人会有多个联系电话
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.DT = '@@{yyyyMMdd}'
            GROUP BY A1.cst_id
          ) T3
ON  T1.客户号 = T3.cst_id
LEFT JOIN (
            SELECT
                 A1.cst_id
				  ,WM_CONCAT(DISTINCT '、',A1.ctc_tel) AS ctc_tel
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.tel_typ = '020100' --家庭电话
			AND   A1.DT = '@@{yyyyMMdd}'
	        GROUP BY A1.cst_id
          ) T31
ON  T1.客户号 = T31.cst_id
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T4 --联系地址信息
ON  T1.客户号 = T4.cst_id
AND   T4.addr_typ	 = '050100' --户籍
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T5 --联系地址信息
ON  T1.客户号 = T5.cst_id
AND   T5.addr_typ	 = '050200' --住宅
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T6 --联系地址信息
ON  T1.客户号 = T6.cst_id
AND   T6.addr_typ	 = '050900' --经营
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T7 --联系地址信息
ON  T1.客户号 = T7.cst_id
AND   T7.addr_typ	 = '050400' --办公
;



--3.担保人
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 AS
SELECT T1.合同流水号_账户号
       ,T2.WRNT_CST_ID      AS 保证人客户编号
       ,T2.WRNT_CST_NM      AS 保证人客户名称
       ,T2.GRNT_PSN_SEQ_NBR AS 担保人序号
       ,T3.ctc_tel          AS 联系电话
       ,T31.ctc_tel         AS 家庭电话
       ,T4.dtl_addr	        AS 户籍地址
       ,T4.省               AS 户籍地址_省
       ,T4.市               AS 户籍地址_市
       ,T4.区               AS 户籍地址_区
       ,T5.dtl_addr	        AS 住宅地址
       ,T5.省               AS 住宅地址_省
       ,T5.市               AS 住宅地址_市
       ,T5.区               AS 住宅地址_区
       ,T6.dtl_addr	        AS 经营地址
       ,T6.省               AS 经营地址_省
       ,T6.市               AS 经营地址_市
       ,T6.区               AS 经营地址_区
       ,T7.dtl_addr	        AS 办公地址
       ,T7.省               AS 办公地址_省
       ,T7.市               AS 办公地址_市
       ,T7.区               AS 办公地址_区
FROM lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_01 T1
INNER JOIN edw.dws_bus_grnt_prsn_inf_dd T2 --担保人汇总信息
ON   T1.合同流水号_账户号 = T2.bus_ctr_id
AND  T2.DT = '@@{yyyyMMdd}'
LEFT JOIN (
            SELECT
                 A1.cst_id
				 ,WM_CONCAT(DISTINCT '、',A1.ctc_tel) AS ctc_tel
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.DT = '@@{yyyyMMdd}'
            GROUP BY A1.cst_id
          ) T3
ON  T2.WRNT_CST_ID = T3.cst_id
LEFT JOIN (
            SELECT
                 A1.cst_id
				  ,WM_CONCAT(DISTINCT '、',A1.ctc_tel) AS ctc_tel
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.tel_typ = '020100' --家庭电话
			AND   A1.DT = '@@{yyyyMMdd}'
            GROUP BY A1.cst_id
          ) T31
ON  T2.WRNT_CST_ID = T31.cst_id
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T4 --联系地址信息
ON  T2.WRNT_CST_ID = T4.cst_id
AND   T4.addr_typ	 = '050100' --户籍
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T5 --联系地址信息
ON  T2.WRNT_CST_ID = T5.cst_id
AND   T5.addr_typ	 = '050200' --住宅
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T6 --联系地址信息
ON  T2.WRNT_CST_ID = T6.cst_id
AND   T6.addr_typ	 = '050900' --经营
LEFT JOIN lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_DZ T7 --联系地址信息
ON  T2.WRNT_CST_ID = T7.cst_id
AND   T7.addr_typ	 = '050400' --办公
;

-----------------------------------


--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_jbg PURGE;

CREATE TABLE lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_jbg AS
SELECT  T1.合同流水号_账户号
        ,T1.信用卡卡号
        ,T1.管户机构号
        ,T1.管户机构名称
        ,T1.客户名称
        ,T1.客户号
        ,T1.1231余额
        ,T1.业务品种
        ,T1.综合社区编号
        ,T1.综合社区名称
        ,T1.联系电话      AS  借_联系电话
        ,T1.家庭电话      AS  借_家庭电话
        ,T1.户籍地址      AS  借_户籍地址
        ,T1.户籍地址_省   AS  借_户籍地址_省
        ,T1.户籍地址_市   AS  借_户籍地址_市
        ,T1.户籍地址_区   AS  借_户籍地址_区
        ,T1.住宅地址      AS  借_住宅地址
        ,T1.住宅地址_省   AS  借_住宅地址_省
        ,T1.住宅地址_市   AS  借_住宅地址_市
        ,T1.住宅地址_区   AS  借_住宅地址_区
        ,T1.经营地址      AS  借_经营地址
        ,T1.经营地址_省   AS  借_经营地址_省
        ,T1.经营地址_市   AS  借_经营地址_市
        ,T1.经营地址_区   AS  借_经营地址_区
        ,T1.办公地址      AS  借_办公地址
        ,T1.办公地址_省   AS  借_办公地址_省
        ,T1.办公地址_市   AS  借_办公地址_市
        ,T1.办公地址_区   AS  借_办公地址_区

        ,T2.保证人客户编号 AS 保1_客户编号
        ,T2.保证人客户名称 AS 保1_客户名称
        ,T2.担保人序号     AS 保1_担保人序号
        ,T2.联系电话       AS 保1_联系电话
        ,T2.家庭电话       AS 保1_家庭电话
        ,T2.户籍地址       AS 保1_户籍地址
        ,T2.户籍地址_省    AS 保1_户籍地址_省
        ,T2.户籍地址_市    AS 保1_户籍地址_市
        ,T2.户籍地址_区    AS 保1_户籍地址_区
        ,T2.住宅地址       AS 保1_住宅地址
        ,T2.住宅地址_省    AS 保1_住宅地址_省
        ,T2.住宅地址_市    AS 保1_住宅地址_市
        ,T2.住宅地址_区    AS 保1_住宅地址_区
        ,T2.经营地址       AS 保1_经营地址
        ,T2.经营地址_省    AS 保1_经营地址_省
        ,T2.经营地址_市    AS 保1_经营地址_市
        ,T2.经营地址_区    AS 保1_经营地址_区
        ,T2.办公地址       AS 保1_办公地址
        ,T2.办公地址_省    AS 保1_办公地址_省
        ,T2.办公地址_市    AS 保1_办公地址_市
        ,T2.办公地址_区    AS 保1_办公地址_区

        ,T3.保证人客户编号 AS 保2_客户编号
        ,T3.保证人客户名称 AS 保2_客户名称
        ,T3.担保人序号     AS 保2_担保人序号
        ,T3.联系电话       AS 保2_联系电话
        ,T3.家庭电话       AS 保2_家庭电话
        ,T3.户籍地址       AS 保2_户籍地址
        ,T3.户籍地址_省    AS 保2_户籍地址_省
        ,T3.户籍地址_市    AS 保2_户籍地址_市
        ,T3.户籍地址_区    AS 保2_户籍地址_区
        ,T3.住宅地址       AS 保2_住宅地址
        ,T3.住宅地址_省    AS 保2_住宅地址_省
        ,T3.住宅地址_市    AS 保2_住宅地址_市
        ,T3.住宅地址_区    AS 保2_住宅地址_区
        ,T3.经营地址       AS 保2_经营地址
        ,T3.经营地址_省    AS 保2_经营地址_省
        ,T3.经营地址_市    AS 保2_经营地址_市
        ,T3.经营地址_区    AS 保2_经营地址_区
        ,T3.办公地址       AS 保2_办公地址
        ,T3.办公地址_省    AS 保2_办公地址_省
        ,T3.办公地址_市    AS 保2_办公地址_市
        ,T3.办公地址_区    AS 保2_办公地址_区

        ,T4.保证人客户编号 AS 保3_客户编号
        ,T4.保证人客户名称 AS 保3_客户名称
        ,T4.担保人序号     AS 保3_担保人序号
        ,T4.联系电话       AS 保3_联系电话
        ,T4.家庭电话       AS 保3_家庭电话
        ,T4.户籍地址       AS 保3_户籍地址
        ,T4.户籍地址_省    AS 保3_户籍地址_省
        ,T4.户籍地址_市    AS 保3_户籍地址_市
        ,T4.户籍地址_区    AS 保3_户籍地址_区
        ,T4.住宅地址       AS 保3_住宅地址
        ,T4.住宅地址_省    AS 保3_住宅地址_省
        ,T4.住宅地址_市    AS 保3_住宅地址_市
        ,T4.住宅地址_区    AS 保3_住宅地址_区
        ,T4.经营地址       AS 保3_经营地址
        ,T4.经营地址_省    AS 保3_经营地址_省
        ,T4.经营地址_市    AS 保3_经营地址_市
        ,T4.经营地址_区    AS 保3_经营地址_区
        ,T4.办公地址       AS 保3_办公地址
        ,T4.办公地址_省    AS 保3_办公地址_省
        ,T4.办公地址_市    AS 保3_办公地址_市
        ,T4.办公地址_区    AS 保3_办公地址_区

        ,T5.保证人客户编号 AS 保4_客户编号
        ,T5.保证人客户名称 AS 保4_客户名称
        ,T5.担保人序号     AS 保4_担保人序号
        ,T5.联系电话       AS 保4_联系电话
        ,T5.家庭电话       AS 保4_家庭电话
        ,T5.户籍地址       AS 保4_户籍地址
        ,T5.户籍地址_省    AS 保4_户籍地址_省
        ,T5.户籍地址_市    AS 保4_户籍地址_市
        ,T5.户籍地址_区    AS 保4_户籍地址_区
        ,T5.住宅地址       AS 保4_住宅地址
        ,T5.住宅地址_省    AS 保4_住宅地址_省
        ,T5.住宅地址_市    AS 保4_住宅地址_市
        ,T5.住宅地址_区    AS 保4_住宅地址_区
        ,T5.经营地址       AS 保4_经营地址
        ,T5.经营地址_省    AS 保4_经营地址_省
        ,T5.经营地址_市    AS 保4_经营地址_市
        ,T5.经营地址_区    AS 保4_经营地址_区
        ,T5.办公地址       AS 保4_办公地址
        ,T5.办公地址_省    AS 保4_办公地址_省
        ,T5.办公地址_市    AS 保4_办公地址_市
        ,T5.办公地址_区    AS 保4_办公地址_区

        ,T6.保证人客户编号 AS 保5_客户编号
        ,T6.保证人客户名称 AS 保5_客户名称
        ,T6.担保人序号     AS 保5_担保人序号
        ,T6.联系电话       AS 保5_联系电话
        ,T6.家庭电话       AS 保5_家庭电话
        ,T6.户籍地址       AS 保5_户籍地址
        ,T6.户籍地址_省    AS 保5_户籍地址_省
        ,T6.户籍地址_市    AS 保5_户籍地址_市
        ,T6.户籍地址_区    AS 保5_户籍地址_区
        ,T6.住宅地址       AS 保5_住宅地址
        ,T6.住宅地址_省    AS 保5_住宅地址_省
        ,T6.住宅地址_市    AS 保5_住宅地址_市
        ,T6.住宅地址_区    AS 保5_住宅地址_区
        ,T6.经营地址       AS 保5_经营地址
        ,T6.经营地址_省    AS 保5_经营地址_省
        ,T6.经营地址_市    AS 保5_经营地址_市
        ,T6.经营地址_区    AS 保5_经营地址_区
        ,T6.办公地址       AS 保5_办公地址
        ,T6.办公地址_省    AS 保5_办公地址_省
        ,T6.办公地址_市    AS 保5_办公地址_市
        ,T6.办公地址_区    AS 保5_办公地址_区

        ,T7.保证人客户编号 AS 保6_客户编号
        ,T7.保证人客户名称 AS 保6_客户名称
        ,T7.担保人序号     AS 保6_担保人序号
        ,T7.联系电话       AS 保6_联系电话
        ,T7.家庭电话       AS 保6_家庭电话
        ,T7.户籍地址       AS 保6_户籍地址
        ,T7.户籍地址_省    AS 保6_户籍地址_省
        ,T7.户籍地址_市    AS 保6_户籍地址_市
        ,T7.户籍地址_区    AS 保6_户籍地址_区
        ,T7.住宅地址       AS 保6_住宅地址
        ,T7.住宅地址_省    AS 保6_住宅地址_省
        ,T7.住宅地址_市    AS 保6_住宅地址_市
        ,T7.住宅地址_区    AS 保6_住宅地址_区
        ,T7.经营地址       AS 保6_经营地址
        ,T7.经营地址_省    AS 保6_经营地址_省
        ,T7.经营地址_市    AS 保6_经营地址_市
        ,T7.经营地址_区    AS 保6_经营地址_区
        ,T7.办公地址       AS 保6_办公地址
        ,T7.办公地址_省    AS 保6_办公地址_省
        ,T7.办公地址_市    AS 保6_办公地址_市
        ,T7.办公地址_区    AS 保6_办公地址_区
FROM    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_02 T1
LEFT JOIN    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 T2
ON      T1.合同流水号_账户号 = T2.合同流水号_账户号
AND     T2.担保人序号 = 1
LEFT JOIN    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 T3
ON      T1.合同流水号_账户号 = T3.合同流水号_账户号
AND     T3.担保人序号 = 2
LEFT JOIN    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 T4
ON      T1.合同流水号_账户号 = T4.合同流水号_账户号
AND     T4.担保人序号 = 3
LEFT JOIN    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 T5
ON      T1.合同流水号_账户号 = T5.合同流水号_账户号
AND     T5.担保人序号 = 4
LEFT JOIN    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 T6
ON      T1.合同流水号_账户号 = T6.合同流水号_账户号
AND     T6.担保人序号 = 5
LEFT JOIN    lab_bigdata_dev.tmp_HZ_dz_SJ20250102141_03 T7
ON      T1.合同流水号_账户号 = T7.合同流水号_账户号
AND     T7.担保人序号 = 6
;
**01-数据需求_分行_2025_D0110_宁波分行_陈伟_征信短信取数.sql
-- 20180730-20220101：数仓edw.dxpt_gsms_msg_ticket_sms
-- 20220101-20221117：短信平台玄武，无信用卡短信
--20230713-至今：edw.ncrd_smscontent  --银数短信,逾期短信通过银数发
-- 20221117-至今4天前：数仓edw.nsms_gsms_msg_ticket_sms




-- SJ20250109201
-- 25年1月7日，收到征信中心转发的征信异议处理事项。我行需核实是否在2021年4月至2022年5月间向客户预留的手机号码，发送还款短信、逾期上报征信中心的提醒等短信。

-- 2021年4月至2022年5月间，向我行借款款客户吕张滨（身份证号：330281199705151711）预留的手机号码（13429231041、13957467468、13040417888），发送我行贷款还款提醒短信、逾期上报征信中心等提醒短信。


drop table if EXISTS tmp_SJ20250109201_zx purge;
CREATE TABLE IF NOT EXISTS tmp_SJ20250109201_zx AS
SELECT  T2.phone             AS 手机号
        ,T2.sms_content      AS 短信内容
        ,to_char(T2.post_time,'yyyy-mm-dd hh:mm:ss')   as 发送时间
FROM    edw.dxpt_gsms_msg_ticket_sms T2 --20180730-20220101,最早20190926，最晚20221211
WHERE   T2.dt <= '20221211'
AND     T2.phone in ('13429231041','13957467468','13040417888')
AND     T2.number = '0'      --整段
and T2.sms_content rlike '还款|提醒|金融信用信息基础数据库|征信'
-- and to_char(T2.post_time,'yyyy-mm-dd hh:mm:ss') between '2021-04-01 00:00:00'  and '2022-05-31 24:00：00'
and T2.state = '1'   --成功
order by T2.post_time;
;



--无数据
SELECT  A1.phone        AS 手机号
        ,A1.post_time   AS 发送时间
        ,A1.sms_content AS 短信发送内容
        -- ,CASE
        --    WHEN A1.state = '1' THEN '成功'
        --    WHEN A1.state = '7' THEN '失败'
        --    WHEN A1.state = '0' THEN '待发送'
        --  END            AS 发送状态
FROM    edw.nsms_gsms_msg_ticket_sms A1 --20221109-至今4天前：数仓
WHERE   A1.DT >= '20221109'
AND     A1.sms_content RLIKE '还款|提醒|金融信用信息基础数据库|征信'
AND     numbers = '0' --0是整段短信
-- AND     REPLACE(substr(A1.post_time, 1, 10), '-', '') between '20210401'  and '20220531'
-- and  A1.state = '1'
and A1.phone in ('13429231041','13957467468','13040417888')


;

--银联短信通道
--无数据
SELECT  A1.mbl_nbr AS 手机号
        ,substr(A1.sms_snd_tm,1,8) as 发送时间
        ,A1.sms_snd_cntnt as  短信发送内容
FROM    edw.ncrd_smscontent A1 --20230713-至今,银数短信,逾期短信通过银数发
WHERE   A1.DT >= '20230713'
AND    A1.sms_snd_cntnt RLIKE '还款|提醒|金融信用信息基础数据库|征信'
-- and substr(A1.sms_snd_tm,1,8) between '20210401'  and '20220531'
and A1. mbl_nbr in ('13429231041','13957467468','13040417888')

;
**01-数据需求_分行_2025_D0115_t台州分行_冯敏挺_客户对应的地址信息和调查痕迹.sql
-- SJ20250114111
-- 台州分行随贷通劳动竞赛客户检查：①客户是否来源于子社区  ②客户近半年的调查痕迹

-- 清单内随贷通劳动竞赛期间发卡客户对应的地址信息和调查痕迹，字段需求见附件
-- 取数路径：
-- ①信贷系统，个人客户，基本信息，地址信息对应的办公、户籍、居住、经营地址，社区信息对应的所属子社区和综合社区。
-- ②信贷系统，个人客户，接触历史（2024年4月1日之后的调查记录），包括调查方式、时间、参与人、对象、关系、地址。存在多条调查记录的，均需展示（按客户级多条展示）

-- 办公地址行政区划 	办公地址详细地址 	户籍地址行政区划 	户籍地址详细地址 	居住地址行政区划 	居住地址详细地址 	经营地址行政区划 	经营地址详细地址
-- 所属子社区	所属综合社区	调查方式 	调查日期 	参与调查人 	调查对象 	与借款人关系 	调查地址类型 	调查地址行政区划	调查地址


--地址省市区
DROP TABLE if EXISTS tmp_shengshiqu_SJ20250114111_01 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_shengshiqu_SJ20250114111_01 as
SELECT  A1.cst_id
        ,A1.adiv
        ,A1.dtl_addr
        ,A1.addr_typ
        ,concat(A4.cd_val_dscr, A3.cd_val_dscr,A2.cd_val_dscr) AS 行政区划
FROM    edw.loan_cst_ctc_addr A1
LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表  区
ON      SUBSTR(A1.adiv, 1, 6) = A2.cd_val
AND     A2.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A2.fld_nm = 'C_HOME_ADDRESS_A'
AND     A2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表   市
ON      RPAD(SUBSTR(A1.adiv, 1, 4), 6, '0') = A3.cd_val
AND     A3.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A3.fld_nm = 'C_HOME_ADDRESS_A'
AND     A3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A4 -- 码值表  省
ON      RPAD(SUBSTR(A1.adiv, 1, 2), 6, '0') = A4.cd_val
AND     A4.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A4.fld_nm = 'C_HOME_ADDRESS_A'
AND     A4.DT = '@@{yyyyMMdd}'
WHERE   A1.del_ind = '0'
AND     A1.DT = '@@{yyyyMMdd}'
AND     A1.addr_typ IN ( '050100' , '050200' , '050900','050400' );


---结果表45073条数据
DROP TABLE IF EXISTS tmp_shengshiqu_SJ20250114111_f PURGE;

CREATE TABLE IF NOT EXISTS tmp_shengshiqu_SJ20250114111_f AS
SELECT distinct  t0.col_1          AS 客户号
        ,t11.行政区划         AS 办公地址行政区划
        ,t11.dtl_addr      AS 办公地址详细地址
        ,t21.行政区划         AS 户籍地址行政区划
        ,t21.dtl_addr      AS 户籍地址详细地址
        ,t31.行政区划         AS 居住地址行政区划
        ,t31.dtl_addr      AS 居住地址详细地址
        ,t41.行政区划         AS 经营地址行政区划
        ,t41.dtl_addr      AS 经营地址详细地址
        ,cm.sub_cmnt_nm   AS 所属子社区
        ,cm.cprh_cmnt_nm  AS 所属综合社区
        ,svy.svy_mod_cd   AS 调查方式代码
        ,svy3.cd_val_dscr AS 调查方式
        ,svy.svy_dt       AS 调查日期
        ,svy.pcp_psn_nm   AS 参与调查人
        ,obj.svy_obj_nm   AS 调查对象
        -- ,obj.with_be_svy_psn_rel_cd  AS 与借款人关系
        ,lb.cd_val_dscr   AS 与借款人关系
        -- ,svy.svy_addr_typ_cd  as 调查地址类型
        ,svy1.cd_val_dscr AS 调查地址类型
        -- ,svy.adiv         AS 调查地址行政区划
        ,svy2.cd_val_dscr        AS 调查地址行政区划
        ,svy.svy_addr     AS 调查地址
FROM    qbi_file_20250115_14_50_22_0 t0
LEFT JOIN    tmp_shengshiqu_SJ20250114111_01 t11
ON        t0.col_1 = t11.cst_id
AND     t11.addr_typ = '050400' --办公地址
LEFT JOIN    tmp_shengshiqu_SJ20250114111_01 t21
ON      t0.col_1 = t21.cst_id
AND     t21.addr_typ = '050100' --户籍地址
LEFT JOIN    tmp_shengshiqu_SJ20250114111_01 t31
ON      t0.col_1 = t31.cst_id
AND     t31.addr_typ = '050200' --家庭地址
LEFT JOIN    tmp_shengshiqu_SJ20250114111_01 t41
ON      t0.col_1 = t41.cst_id
AND     t41.addr_typ = '050900' --经营地址
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd cm --客户社区信息
ON      t0.col_1 = cm.cst_id
AND     cm.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_cst_svy_rcd_dd svy --客户调查记录信息
ON      t0.col_1 = svy.cst_id
AND     svy.dt = '@@{yyyyMMdd}'
AND     svy.svy_dt >= '20240401' --2024年4月1日之后的调查记录
LEFT JOIN    edw.dwd_code_library_dd svy1
ON      svy.svy_addr_typ_cd = svy1.cd_val
AND     svy1.dt = '@@{yyyyMMdd}'
AND     svy1.tbl_nm = upper('dwd_bus_loan_cst_svy_rcd_dd')
AND     svy1.fld_nm = upper('svy_addr_typ_cd')
LEFT JOIN    edw.dwd_code_library_dd svy3
ON      svy.svy_mod_cd = svy3.cd_val
AND     svy3.dt = '@@{yyyyMMdd}'
AND     svy3.tbl_nm = upper('dwd_bus_loan_cst_svy_rcd_dd')
AND     svy3.fld_nm = upper('svy_mod_cd')
LEFT JOIN    edw.dwd_code_library_dd svy2 -- 码值表  区
ON      SUBSTR(svy.adiv, 1, 6) = svy2.cd_val
AND     svy2.tbl_nm = 'CUSTOMER_ADDRESS'
AND     svy2.fld_nm = 'CITY'
AND     svy2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd obj --调查记录关联调查对象信息
ON      svy.svy_rcd_serno = obj.rel_serno
AND     obj.dt = '@@{yyyyMMdd}'
AND     REPLACE(substr(obj.sys_reg_tm, 1, 10), '-', '') >= '20240401'
LEFT JOIN    edw.dwd_code_library_dd lb
ON      obj.with_be_svy_psn_rel_cd = lb.cd_val
AND     lb.dt = '@@{yyyyMMdd}'
AND     lb.tbl_nm = upper('dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd')
AND     lb.fld_nm = upper('with_be_svy_psn_rel_cd')
WHERE   t0.pt <> ''
ORDER BY T0.COL_1;
**01-数据需求_分行_2025_D0115_嘉兴分行_施燕_客户地址信息.sql
-- SJ2025011101
-- 支行及团队虚拟账户下面地址匹配，按照社区化划给员工做营销
-- 需要按照清单的客户号和客户姓名匹配详细地址（住所、经营地、户籍地址）

-- CREATE TABLE IF NOT EXISTS fuwuzhongxin
-- (
--     客户号   STRING
--     ,客户名称 STRING
--     ,性别   STRING
-- )
-- ;
----1、服务中心
CREATE table IF NOT EXISTS tmp_fuwuzhongxin_SJ2025011101 as
SELECT b.*
       ,a.reg_adr as 户籍或注册地址
       ,a.fml_adr as 家庭地址
       ,a.cmn_adr as 通讯地址
       ,a.wrk_adr as 工作单位或经营地址
 FROM  fuwuzhongxin b
left join  edw.dws_cst_bas_inf_dd a
on  b.客户号=a.cst_id
and  a.dt='@@{yyyyMMdd}'
;


-- CREATE TABLE IF NOT EXISTS yewusanbu
-- (
--     客户号   STRING
--     ,客户名称 STRING
--     ,性别   STRING
-- )
-- ;

--2, 业务三部
CREATE table IF NOT EXISTS tmp_yewusanbu_SJ2025011101 as
SELECT b.*
       ,a.reg_adr as 户籍或注册地址
       ,a.fml_adr as 家庭地址
       ,a.cmn_adr as 通讯地址
       ,a.wrk_adr as 工作单位或经营地址
 FROM  yewusanbu b
left join  edw.dws_cst_bas_inf_dd a
on  b.客户号=a.cst_id
and  a.dt='@@{yyyyMMdd}'
;


-- CREATE TABLE IF NOT EXISTS yewusibu
-- (
--     客户号   STRING
--     ,客户名称 STRING
--     ,性别   STRING
-- )
-- ;

--3，业务四部
CREATE TABLE IF NOT EXISTS tmp_yewusibu_SJ2025011101 AS
SELECT  b . *
        ,a.reg_adr AS 户籍或注册地址
        ,a.fml_adr AS 家庭地址
        ,a.cmn_adr AS 通讯地址
        ,a.wrk_adr AS 工作单位或经营地址
FROM    yewusibu b
LEFT JOIN    edw.dws_cst_bas_inf_dd a
ON      b.客户号 = a.cst_id
AND     a.dt = '@@{yyyyMMdd}'
;

-- CREATE TABLE IF NOT EXISTS yewuyibu
-- (
--     客户号   STRING
--     ,客户名称 STRING
--     ,性别   STRING
-- )
-- ;

--业务一部
CREATE TABLE IF NOT EXISTS tmp_yewuyibu_SJ2025011101 AS
SELECT  b . *
        ,a.reg_adr AS 户籍或注册地址
        ,a.fml_adr AS 家庭地址
        ,a.cmn_adr AS 通讯地址
        ,a.wrk_adr AS 工作单位或经营地址
FROM    yewuyibu b
LEFT JOIN    edw.dws_cst_bas_inf_dd a
ON      b.客户号 = a.cst_id
AND     a.dt = '@@{yyyyMMdd}'
;


---支行本级
CREATE TABLE IF NOT EXISTS tmp_zhihangbenji_SJ2025011101 AS
SELECT  b.col_1 as 客户号
        ,b.col_2 as 客户姓名
        ,a.reg_adr AS 户籍或注册地址
        ,a.fml_adr AS 家庭地址
        ,a.cmn_adr AS 通讯地址
        ,a.wrk_adr AS 工作单位或经营地址
FROM    qbi_file_20250115_11_38_19_0 b
LEFT JOIN    edw.dws_cst_bas_inf_dd a
ON      b.col_1 = a.cst_id
AND     a.dt = '@@{yyyyMMdd}'
WHERE b.pt<>'';


---支行

-- CREATE TABLE IF NOT EXISTS zhihangjiaxing
-- (
--     客户号   STRING
--     ,客户名称 STRING
--     ,性别   STRING
-- )
-- ;

;


CREATE TABLE IF NOT EXISTS tmp_zhihangjiaxing_SJ2025011101 AS
SELECT  b . *
        ,a.reg_adr AS 户籍或注册地址
        ,a.fml_adr AS 家庭地址
        ,a.cmn_adr AS 通讯地址
        ,a.wrk_adr AS 工作单位或经营地址
FROM    zhihangjiaxing b
LEFT JOIN    edw.dws_cst_bas_inf_dd a
ON      b.客户号 = a.cst_id
AND     a.dt = '@@{yyyyMMdd}'
;
**01-数据需求_分行_2025_D0116_宁波分行_诸银君_逾期业务借款人和担保人相关信息.sql
-- SJ2025011571
-- 因批量走访和催收需要，特申请新增往年逾期业务借款人和担保人相关信息，具体清单详见附件


-- 合同流水号、核心客户编号、名称、角色、联系号码、居住地址、户籍地址、经营地址（经营）/办公地址（工薪）、是否主地址

--临时表
drop  TABLE if EXISTS tmp_yuqikexinxi_SJ2025011571 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011571 as
--借款人信息
SELECT  INT(a.col_1)                                       AS 序号
        ,a.col_2                                           AS 合同流水号
        ,a.col_3                                           AS 客户号
        ,a.col_4                                           AS 客户姓名
        ,'借款人'                                             AS 角色
        ,coalesce(b.mbl_nbr, b.fml_tel_nbr, b.cmp_tel_nbr) AS 联系号码
        ,c1.ful_adr                                        AS 居住地址
        ,CASE
           WHEN c11.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 居住地址是否主地址
        ,c2.ful_adr                                        AS 户籍地址
        ,CASE
           WHEN c21.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 户籍地址是否主地址
        ,c3.ful_adr                                        AS 经营地址
        ,CASE
           WHEN c31.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 经营地址是否主地址
        ,c4.ful_adr                                        AS 办公地址
        ,CASE
           WHEN c41.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 办公地址是否主地址
FROM    qbi_file_20250116_16_10_40_0 a
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      a.col_3 = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c1
ON      a.col_3 = c1.cst_id
AND     c1.dt = '@@{yyyyMMdd}'
AND     c1.phy_adr_typ_cd = '050200' --居住地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c11
ON      a.col_3 = c11.cst_id
AND     c11.dt = '@@{yyyyMMdd}'
AND     c11.phy_adr_typ_cd = '050200' --居住地址
AND     c11.prm_adr_ind = 1 --主地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c2
ON      a.col_3 = c2.cst_id
AND     c2.dt = '@@{yyyyMMdd}'
AND     c2.phy_adr_typ_cd = '050100' --户籍地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c21
ON      a.col_3 = c21.cst_id
AND     c21.dt = '@@{yyyyMMdd}'
AND     c21.phy_adr_typ_cd = '050100' --户籍地址
AND     c21.prm_adr_ind = 1 --主地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c3
ON      a.col_3 = c3.cst_id
AND     c3.dt = '@@{yyyyMMdd}'
AND     c3.phy_adr_typ_cd  ='050900' --经营地址（经营)
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c31
ON      a.col_3 = c31.cst_id
AND     c31.dt = '@@{yyyyMMdd}'
AND     c31.phy_adr_typ_cd ='050900' --经营地址（经营）
AND     c31.prm_adr_ind = 1 --主地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c4
ON      a.col_3 = c4.cst_id
AND     c4.dt = '@@{yyyyMMdd}'
AND     c4.phy_adr_typ_cd = '050400' --办公地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c41
ON      a.col_3 = c41.cst_id
AND     c41.dt = '@@{yyyyMMdd}'
AND     c41.phy_adr_typ_cd ='050400' --办公地址
AND     c41.prm_adr_ind = 1 --主地址
WHERE   a.pt <> ''
ORDER BY a.col_1
union all
--担保人信息
--担保人合同流水号即为原借款合同流水号，客户号为担保人的客户号，姓名为担保人姓名，角色写担保人，其他标黄的需求一致
SELECT  INT(a.col_1)                                       AS 序号
        ,a.col_2                                           AS 合同流水号
        ,a.wrnt_cst_id                                     AS 客户号
        ,a.wrnt_cst_nm                                     AS 客户姓名
        ,'担保人'                                             AS 角色
        ,coalesce(b.mbl_nbr, b.fml_tel_nbr, b.cmp_tel_nbr) AS 联系号码
        ,c1.ful_adr                                        AS 居住地址
        ,CASE
           WHEN c11.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 居住地址是否主地址
        ,c2.ful_adr                                        AS 户籍地址
        ,CASE
           WHEN c21.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 户籍地址是否主地址
        ,c3.ful_adr                                        AS 经营地址
        ,CASE
           WHEN c31.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 经营地址是否主地址
        ,c4.ful_adr                                        AS 办公地址
        ,CASE
           WHEN c41.prm_adr_ind = 1 THEN '是'
           ELSE '否'
         END                                               AS 办公地址是否主地址
FROM    (
            SELECT  a . *
                    ,A1.wrnt_cst_id AS wrnt_cst_id
                    ,A1.wrnt_cst_nm AS wrnt_cst_nm
            FROM    qbi_file_20250116_16_10_40_0 a
            LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd A1 --担保人汇总信息
            ON      a.col_2 = A1.bus_ctr_id
            AND     A1.dt = '@@{yyyyMMdd}'
            WHERE   a.pt <> ''
        ) a
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      a.wrnt_cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c1
ON      a.wrnt_cst_id = c1.cst_id
AND     c1.dt = '@@{yyyyMMdd}'
AND     c1.phy_adr_typ_cd = '050200' --居住地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c11
ON      a.wrnt_cst_id = c11.cst_id
AND     c11.dt = '@@{yyyyMMdd}'
AND     c11.phy_adr_typ_cd = '050200' --居住地址
AND     c11.prm_adr_ind = 1 --主地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c2
ON      a.wrnt_cst_id = c2.cst_id
AND     c2.dt = '@@{yyyyMMdd}'
AND     c2.phy_adr_typ_cd = '050100' --户籍地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c21
ON      a.wrnt_cst_id = c21.cst_id
AND     c21.dt = '@@{yyyyMMdd}'
AND     c21.phy_adr_typ_cd = '050100' --户籍地址
AND     c21.prm_adr_ind = 1 --主地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c3
ON      a.wrnt_cst_id = c3.cst_id
AND     c3.dt = '@@{yyyyMMdd}'
AND     c3.phy_adr_typ_cd = '050900' --经营地址（经营)
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c31
ON      a.wrnt_cst_id = c31.cst_id
AND     c31.dt = '@@{yyyyMMdd}'
AND     c31.phy_adr_typ_cd = '050900' --经营地址（经营）
AND     c31.prm_adr_ind = 1 --主地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c4
ON      a.wrnt_cst_id = c4.cst_id
AND     c4.dt = '@@{yyyyMMdd}'
AND     c4.phy_adr_typ_cd = '050400' --办公地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c41
ON      a.wrnt_cst_id = c41.cst_id
AND     c41.dt = '@@{yyyyMMdd}'
AND     c41.phy_adr_typ_cd = '050400' --办公地址
AND     c41.prm_adr_ind = 1 --主地址
ORDER BY a.col_1;

--结果表
DROP TABLE IF EXISTS tmp_yuqikexinxi_SJ2025011571_f PURGE;

CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011571_f AS
SELECT  *
FROM    tmp_yuqikexinxi_SJ2025011571
ORDER BY 序号
;
**01-数据需求_分行_2025_D0116_杭州分行_陈敏珠_逾期客户FTP明细.sql
--SJ20250115111
--内部分析，统计各家支行2024年收回的逾期业务期内利息计入贷款FTP营收金额
--借据号、数据日期，产品编码，产品名称，客户经理工号，客户经理名称，管护机构号、客户号、客户名称、账号，起息日 到期日 当前余额 日均余额 执行利率
-- 对客利率 对客利息 调节前FTP利率（反算） 调节前FTP利息 调节后FTP利率（反算）、调节后FTP利息
--调节后FTP利差（反算）、调节后FTP利润 频率


DROP TABLE IF EXISTS tmp_ftpbaobiao_SJ20250115111 PURGE;

CREATE TABLE IF NOT EXISTS tmp_ftpbaobiao_SJ20250115111 AS
SELECT  TRIM(A.AS_OF_DATE) 数据日期
        ,TRIM(A.CORE_PRODUCT_ID)  AS 产品编码
        ,TRIM(A.PRODUCT_NAME)     AS 产品名称
        ,TRIM(A.CIF_MANAGER)      AS 客户经理工号
        ,TRIM(A.CIF_MANAGER_NAME) AS 客户经理名称
        ,TRIM(A.ORG_UNIT_ID)      AS 管护机构号
        ,TRIM(A.CIF_KEY)          AS 客户号
        ,TRIM(A.CIF_NAME)         AS 客户名称
        ,TRIM(A.ACCOUNT_NO)       AS 账号
        ,TRIM(A.START_DT)         AS 起息日
        ,TRIM(A.MATURITY_DT)      AS 到期日
        ,A.CUR_BOOK_BAL           AS 当前余额
        ,A.AVG_BAL                AS 日均余额
        ,A.CUR_NET_RATE_A         AS 执行利率
        ,A.CUR_NET_RATE           AS 对客利率
        ,A.ACC_INT                AS 对客利息
        ,A.TRANSFER_RATE          AS 调节前FTP利率_反算
        ,A.ftp_int                AS 调节前FTP利息
        ,A.TRANSFER_RATE_AJUST    AS 调节后FTP利率_反算
        ,A.FTP_INT_AJUST          AS 调节后FTP利息
        ,A.FTP_PROFIT_RATE        AS 调节后FTP利差_反算
        ,A.FTP_PROFIT_FINAL       AS 调节后FTP利润
        ,TRIM(A.FLAG)             AS 频率
        ,TRIM(A.IS_OFFSET)        AS 利息冲减标识
        ,TRIM(A.CURRENCY_CD)      AS 原币种
        ,A.BASE_FTP_RATE          AS 调节前FTP利率_时点
        ,A.FINAL_FTP_RATE         AS 调节后FTP利率_时点
FROM    (
            SELECT  DISTINCT col_1
            FROM    qbi_file_20250116_10_47_35_0
            WHERE   pt <> ''
        ) b
LEFT JOIN    APP_IFTP.EVA_RPT_FACT_FTP_CST_A14 A
ON      b.col_1 = TRIM(A.ACCOUNT_NO)
AND     A.DT = '20241231'
AND     TRIM(A.FLAG) = 'Y'
order by TRIM(A.ACCOUNT_NO)
;
**01-数据需求_分行_2025_D0117_上海分行_江长征_代发工资户.sql
-- SJ2025011661
-- --1.上海分行签约了代发协议+企业网银批量转账备注为&ldquo;工资&rdquo;
-- 符合上述条件的企业清单及上述企业开通了我行工资卡的员工卡信息


-- 企业名称、客户号、月平均代发工资金额、管护人信息、管护机构信息；开通了工资卡的员工客户信息（客户名称、客户号、月代发工资金额，管护人信息、管护机构信息

SELECT * FROM edw.ebnk_cb_wage_flow where dt<='@@{yyyyMMdd}'  and dt >= '20240101' and wfl_cstno='2603134368' AND   substr(wfl_month, 1, 4) = '2024'

;
--

---代发工资企业信息
DROP TABLE IF EXISTS lab_bigdata_dev.shfh_daifagongz_SJ2025011661_qy PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.shfh_daifagongz_SJ2025011661_qy AS
SELECT  A.wfl_payname 企业名称
        ,A.wfl_cstno 企业客户号
        -- ,D.opn_dt 账户开立日期
        ,A.wfl_payacc 账号
        -- ,D.act_sts_cd 账户状态ID
        ,t11.cd_val_dscr 账户状态
        ,t9.sbr_org_nm 管护机构支行
        ,t9.tem_org_nm 管护机构团队
        ,t10.empe_nm 管护客户经理
        ,t8.mgr_id 管户客户经理工号
        ,count(DISTINCT wfl_month) AS 工资月份数
        ,sum(nvl(B.wdt_amt, '0')) / ( count(DISTINCT A.wfl_month) ) 月平均代发工资金额
FROM    edw.ebnk_cb_wage_flow A --代发工资差旅流水表，增量表
INNER JOIN    edw.ebnk_cb_wage_detail B --代发工资差旅明细表,增量表
ON      A.WFL_BATCHNO = B.WDT_BATCHNO
AND     A.dt = B.dt
AND     b.dt <= '@@{yyyyMMdd}'
AND     b.dt >= '20240101'
AND     b.wdt_sttmsg = '交易成功'
LEFT JOIN    edw.dim_bus_dep_cst_act_inf_dd D --客户存款账户信息
ON      A.wfl_payacc = D.cst_act_id
AND     D.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd t8 --存款账户管户信息
ON      D.cst_act_id = t8.cst_act_id
AND     t8.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t9 --机构树
ON      t8.acs_org_id = t9.org_id
AND     t9.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd t10 --员工基本信息
ON      t8.mgr_id = t10.empe_id
AND     t10.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd t11
ON      D.act_sts_cd = t11.cd_val
AND     t11.dt = '@@{yyyyMMdd}'
AND     t11.tbl_nm = upper('dim_bus_dep_cst_act_inf_dd')
AND     t11.fld_nm = upper('act_sts_cd')
WHERE   A.dt <= '@@{yyyyMMdd}'
AND     A.dt >= '20240101'
AND     a.wfl_stt = '90'
AND     a.wfl_rem RLIKE '工资'
AND     a.wfl_hosterrormsg = '交易成功'
AND     t8.acs_org_id LIKE '3101%' --上海分行
AND     substr(A.wfl_month, 1, 4) = '2024' --2024年数据
GROUP BY A.wfl_payname , A.wfl_cstno , A.wfl_payacc , t11.cd_val_dscr , t9.sbr_org_nm , t9.tem_org_nm , t10.empe_nm , t8.mgr_id;




--开通了我行工资卡的员工客户信息（客户名称、客户号、月代发工资金额，管护人信息、管护机构信息)
DROP TABLE IF EXISTS lab_bigdata_dev.shfh_daifagongz_SJ2025011661_qyhr PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.shfh_daifagongz_SJ2025011661_qyhr AS
SELECT  F.cst_id 代发工资员工号
        ,F.cst_act_nm 代发工资员工名称
        ,B.wdt_account --员工账号
        ,sum(nvl(B.wdt_amt, '0')) / count(DISTINCT B.wdt_batchno) AS 月代发工资金额
        ,t9.sbr_org_nm 管护机构支行
        ,t9.tem_org_nm 管护机构团队
        ,t10.empe_nm 管护客户经理
        ,t8.mgr_id 管户客户经理工号
FROM    edw.ebnk_cb_wage_flow A --代发工资差旅流水表，增量表
INNER JOIN    edw.ebnk_cb_wage_detail B --代发工资差旅明细表,增量表
ON      A.WFL_BATCHNO = B.WDT_BATCHNO
AND     A.dt = B.dt
AND     b.dt <= '@@{yyyyMMdd}'
AND     b.dt >= '20240101'
INNER JOIN    edw.dim_bus_dep_cst_act_inf_dd F --客户存款账户信息
ON      B.wdt_account = F.cst_act_id
AND     F.dt = '@@{yyyyMMdd}'
AND     F.act_sts_cd = 'A'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd t8 --存款账户管户信息
ON      F.cst_act_id = t8.cst_act_id
AND     t8.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t9 --机构树
ON      t8.acs_org_id = t9.org_id
AND     t9.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd t10 --员工基本信息
ON      t8.mgr_id = t10.empe_id
AND     t10.dt = '@@{yyyyMMdd}'
WHERE   A.dt <= '@@{yyyyMMdd}'
AND     A.dt >= '20240101'
AND     a.wfl_stt = '90'
AND     a.wfl_rem RLIKE '工资'
AND     a.wfl_hosterrormsg = '交易成功'
AND     t8.acs_org_id LIKE '3101%' --上海分行
AND     substr(A.wfl_month, 1, 4) = '2024'  --2024年数据
GROUP BY F.cst_id,F.cst_act_nm,t9.sbr_org_nm,t9.tem_org_nm ,t10.empe_nm ,t8.mgr_id
;
**01-数据需求_分行_2025_D0117_台州分行_潘小菡_逾期客户联系方式.sql
-- SJ2025011601
-- 查询逾期客户的手机号码


-- CREATE TABLE IF NOT EXISTS tmp_yuqikehu_SJ2025011601_01 (
--     seq BIGINT COMMENT '序号'
--     ,cst_id STRING  COMMENT  '客户编号'
--     ,cst_nm string  COMMENT  '客户名称'
--     ,doc_nm BIGINT COMMENT '身份证号码'
-- );

DROP TABLE if EXISTS tmp_yuqikehu_SJ2025011601_02 purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikehu_SJ2025011601_02 as
SELECT  a.seq                           AS 序号
        ,a.cst_id                       AS 客户编号
        ,a.cst_nm                       AS 客户名称
        ,a.doc_nm                       AS 身份证号码
        -- ,coalesce(b.mbl_nbr, c.ctc_tel) AS 手机号码
        ,CASE
           WHEN coalesce(b.mbl_nbr, '') <> '' THEN b.mbl_nbr
           WHEN coalesce(c.ctc_tel, '') <> '' THEN c.ctc_tel
         END                            AS 联系方式
FROM    tmp_yuqikehu_SJ2025011601_01 a
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      a.cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON      a.cst_id = c.cst_id
order by a.seq
;
**01-数据需求_分行_2025_D0117_宁波分行_谢晓勇_信用卡逾期客户联系方式.sql
--
-- SJ2025011696
-- 宁波分行存量逾期信用卡客户对应的身份证号码，联系电话，户籍地址，居住地址，工作单位，工作地址

-- CREATE TABLE IF NOT EXISTS tmp_xinyongka_SJ2025011696 (
--         cst_id BIGINT COMMENT '客户号'
--         ,cst_name STRING COMMENT '客户姓名'
-- )
-- ;


DROP TABLE IF EXISTS tmp_yuqikehu_SJ2025011601_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_yuqikehu_SJ2025011601_02 AS
SELECT  a.cst_id      AS 客户号
        ,a.cst_name   AS 客户名称
        ,b.doc_nbr    AS 身份证号码
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END          AS 联系电话
        ,b.reg_adr    AS 户籍地址
        ,b.fml_adr    AS 居住地址
        ,d.job_unt_nm AS 工作单位
        ,b.wrk_adr    AS 工作地址
FROM    tmp_xinyongka_SJ2025011696 a
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      a.cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd d
ON      a.cst_id = d.cst_id
AND     d.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON      a.cst_id = c.cst_id
ORDER BY a.cst_id;
**01-数据需求_分行_2025_D0120_苏州分行_陈慧_逾期客户信息.sql
--
-- SJ2025011781

--2025存量考核逾期客户需要了解客户信息，以便开展实地催收和电话催收。因数据量较大，因此提请数据需求批量解决。

-- 截止2024年12月31日的存量逾期考核的合同流水号/信用卡卡号及相关字段，具体详见附件。

-- 贷款随贷通合同流水号/信用卡卡号	管护人工号	管护人姓名	业务品种	借款人名称	借款人证件号	借款人联系电话	借款人挂靠的子社区名称	借款人户籍地	借款人居住地	借款人经营地
-- 担保人1名称	担保人1证件号	担保人1联系电话	担保人1挂靠的子社区名称	担保人1户籍地	担保人1居住地	担保人1经营地
-- 担保人2名称	担保人2证件号	担保人2联系电话	担保人2挂靠的子社区名称	担保人2户籍地	担保人2居住地	担保人2经营地
-- 担保人3...	担保人4...

-- DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_daik purge;
-- CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_daik (
--     crd STRING  COMMENT '合同流水号'
-- )
-- ;

-- DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk purge;
-- CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk (
--     crd STRING  COMMENT '卡号'
-- )
-- ;




--贷款（含随贷通）
--借款人信息

DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_daik_01 purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_daik_01 as
SELECT t.crd as 合同流水号
      ,cm.mgr_id 管护人工号
      ,cm.mgr_nm 管护人姓名
      ,cm.mgr_org_id 管护机构号
      ,ctr.prd_no 产品编号
      ,pd.pd_nm 业务品种
      ,ctr.cst_id 借款人工号
      ,ctr.cst_nm 借款人名称
      ,cb.doc_nbr 借款人证件号
      ,cb.mbl_nbr 借款人联系电话
      ,t1.sub_cmnt_nm 借款人挂靠的子社区
      ,cb.reg_adr 借款人户籍地
      ,cb.fml_adr 借款人居住地
      ,cb.wrk_adr 借款人经营地
FROM tmp_yuqikexinxi_SJ2025011781_daik t
LEFT JOIN edw.DWD_BUS_LOAN_CTR_MGR_INF_DD cm
on t.crd=cm.ctr_serno
and cm.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_bse_inf_dd ctr
on t.crd=ctr.ctr_serno
and ctr.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_prd_frml_dd  pd
on  ctr.prd_no=pd.prd_no
and pd.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd cb
on ctr.cst_id=cb.cst_id
and cb.dt='@@{yyyyMMdd}'
left join edw.dwd_cst_mng_cmnt_rel_dd t1
on ctr.cst_id=t1.cst_id
and cb.sub_cmnt_id=t1.sub_cmnt_id
and t1.dt='@@{yyyyMMdd}'
;

--担保人
DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_daik_02 purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_daik_02 as
SELECT  T1.crd
        ,t2.grnt_psn_seq_nbr
        ,t2.wrnt_cst_id
        ,t2.wrnt_cst_nm
        ,t2.wrnt_doc_nbr
        ,cb.mbl_nbr
        ,t3.sub_cmnt_nm
        ,cb.reg_adr
        ,cb.fml_adr
        ,cb.wrk_adr
FROM    tmp_yuqikexinxi_SJ2025011781_daik t1
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t2
ON      t1.crd = t2.bus_ctr_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd cb
ON      t2.wrnt_cst_id = cb.cst_id
AND     cb.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t3
ON      t2.wrnt_cst_id = t3.cst_id
AND     cb.sub_cmnt_id = t3.sub_cmnt_id
AND     t3.dt = '@@{yyyyMMdd}'
ORDER BY T1.crd  , t2.wrnt_cst_id
;

--担保人信息
DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_daik_f purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_daik_f as
SELECT distinct  t1.crd 合同流水号
      --   ,t21.grnt_psn_seq_nbr 担保人1序号
        ,t21.wrnt_cst_id 保证人1客户编号
        ,t21.wrnt_cst_nm 保证人1客户名称
        ,t21.wrnt_doc_nbr 保证人1证件号码
        ,t21.mbl_nbr 保证人1联系电话
        ,t21.sub_cmnt_nm 保证人1挂靠的子社区
        ,t21.reg_adr 保证人1户籍地
        ,t21.fml_adr 保证人1居住地
        ,t21.wrk_adr 保证人1经营地
      --   ,t22.grnt_psn_seq_nbr 担保人2序号
        ,t22.wrnt_cst_id 保证人2客户编号
        ,t22.wrnt_cst_nm 保证人2客户名称
        ,t22.wrnt_doc_nbr 保证人2证件号码
        ,t22.mbl_nbr 保证人2联系电话
        ,t22.sub_cmnt_nm 保证人2挂靠的子社区
        ,t22.reg_adr 保证人2户籍地
        ,t22.fml_adr 保证人2居住地
        ,t22.wrk_adr 保证人2经营地
      --   ,t23.grnt_psn_seq_nbr 担保人3序号
        ,t23.wrnt_cst_id 保证人3客户编号
        ,t23.wrnt_cst_nm 保证人3客户名称
        ,t23.wrnt_doc_nbr 保证人3证件号码
        ,t23.mbl_nbr 保证人3联系电话
        ,t23.sub_cmnt_nm 保证人3挂靠的子社区
        ,t23.reg_adr 保证人3户籍地
        ,t23.fml_adr 保证人3居住地
        ,t23.wrk_adr 保证人3经营地
      --   ,t24.grnt_psn_seq_nbr 担保人4号
        ,t24.wrnt_cst_id 保证人4客户编号
        ,t24.wrnt_cst_nm 保证人4客户名称
        ,t24.wrnt_doc_nbr 保证人4证件号码
        ,t24.mbl_nbr 保证人4联系电话
        ,t24.sub_cmnt_nm 保证人4挂靠的子社区
        ,t24.reg_adr 保证人4户籍地
        ,t24.fml_adr 保证人4居住地
        ,t24.wrk_adr 保证人4经营地
      --   ,t25.grnt_psn_seq_nbr 担保人5序号
        ,t25.wrnt_cst_id 保证人5客户编号
        ,t25.wrnt_cst_nm 保证人5客户名称
        ,t25.wrnt_doc_nbr 保证人5证件号码
        ,t25.mbl_nbr 保证人5联系电话
        ,t25.sub_cmnt_nm 保证人5挂靠的子社区
        ,t25.reg_adr 保证人5户籍地
        ,t25.fml_adr 保证人5居住地
        ,t25.wrk_adr 保证人5经营地
      --   ,t26.grnt_psn_seq_nbr 担保人6序号
        ,t26.wrnt_cst_id 保证人6客户编号
        ,t26.wrnt_cst_nm 保证人6客户名称
        ,t26.wrnt_doc_nbr 保证人6证件号码
        ,t26.mbl_nbr 保证人6联系电话
        ,t26.sub_cmnt_nm 保证人6挂靠的子社区
        ,t26.reg_adr 保证人6户籍地
        ,t26.fml_adr 保证人6居住地
        ,t26.wrk_adr 保证人6经营地
      --   ,t27.grnt_psn_seq_nbr 担保人7序号
        ,t27.wrnt_cst_id 保证人7客户编号
        ,t27.wrnt_cst_nm 保证人7客户名称
        ,t27.wrnt_doc_nbr 保证人7证件号码
        ,t27.mbl_nbr 保证人7联系电话
        ,t27.sub_cmnt_nm 保证人7挂靠的子社区
        ,t27.reg_adr 保证人7户籍地
        ,t27.fml_adr 保证人7居住地
        ,t27.wrk_adr 保证人7经营地
      --   ,t28.grnt_psn_seq_nbr 担保人8序号
        ,t28.wrnt_cst_id 保证人8客户编号
        ,t28.wrnt_cst_nm 保证人8客户名称
        ,t28.wrnt_doc_nbr 保证人8证件号码
        ,t28.mbl_nbr 保证人8联系电话
        ,t28.sub_cmnt_nm 保证人8挂靠的子社区
        ,t28.reg_adr 保证人8户籍地
        ,t28.fml_adr 保证人8居住地
        ,t28.wrk_adr 保证人8经营地
FROM tmp_yuqikexinxi_SJ2025011781_daik_02 t1
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t21
on t1.crd=t21.crd
and t21.grnt_psn_seq_nbr='1'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t22
on t1.crd=t22.crd
and t22.grnt_psn_seq_nbr='2'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t23
on t1.crd=t23.crd
and t23.grnt_psn_seq_nbr='3'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t24
on t1.crd=t24.crd
and t24.grnt_psn_seq_nbr='4'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t25
on t1.crd=t25.crd
and t25.grnt_psn_seq_nbr='5'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t26
on t1.crd=t26.crd
and t26.grnt_psn_seq_nbr='6'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t27
on t1.crd=t27.crd
and t27.grnt_psn_seq_nbr='7'
left join tmp_yuqikexinxi_SJ2025011781_daik_02 t28
on t1.crd=t28.crd
and t28.grnt_psn_seq_nbr='8'
order by t1.crd
;


--最后的结果表：借款人和担保人合并
DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_daik_ff purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_daik_ff as
SELECT
      t1.管护人工号
      ,t1.管护人姓名
      ,t1.管护机构号
      ,t1.产品编号
      ,t1.业务品种
      ,t1.借款人工号
      ,t1.借款人名称
      ,t1.借款人证件号
      ,t1.借款人联系电话
      ,t1.借款人挂靠的子社区
      ,t1.借款人户籍地
      ,t1.借款人居住地
      ,t1.借款人经营地
      ,t2.*
FROM tmp_yuqikexinxi_SJ2025011781_daik_01 t1
LEFT JOIN tmp_yuqikexinxi_SJ2025011781_daik_f t2
on t1.合同流水号=t2.合同流水号


--信用卡
--管护人工号	管护人姓名	业务品种	借款人名称	借款人证件号	借款人联系电话	借款人挂靠的子社区名称	借款人户籍地	借款人居住地	借款人经营地	担保人1名称


DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk_01 purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk_01  as
SELECT  t.crd --卡号
        ,ccd.busi_ctr_id --合同流水号
        ,t1.bsn_mgr_id 管护人工号
        ,t1.bsn_mgr_nm 管护人
        ,t1.bsn_mgr_org_id 管护机构编号
        ,t1.bsn_mgr_org_nm 管护机构
        ,'信用卡' 业务品种
        ,ccd.cst_id 借款人客户号
        ,ccd.cst_nm 借款人客户名称
        ,cb.doc_nbr 借款人证件号
        ,cb.mbl_nbr 借款人联系电话
        ,t2.sub_cmnt_nm 借款人挂靠的子社区
        ,cb.reg_adr 借款人户籍地
        ,cb.fml_adr 借款人居住地
        ,cb.wrk_adr 借款人经营地
FROM    tmp_yuqikexinxi_SJ2025011781_xinyk t
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd ccd
ON      t.crd = ccd.cr_crd_card_nbr
AND     ccd.dt = '@@{yyyyMMdd}'
LEFT JOIN    app_ado.adm_subl_bus_crd_cr_acct_smy_inf_dd t1
ON      t.crd = t1.late_main_card_card_nbr
AND     t1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd cb
ON      ccd.cst_id = cb.cst_id
AND     cb.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t2
ON      ccd.cst_id = t2.cst_id
AND     cb.sub_cmnt_id = t2.sub_cmnt_id
AND     t2.dt = '@@{yyyyMMdd}'
;


--信用卡担保人
DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk_ff purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk_ff  as
SELECT  t1.crd
        ,t1.busi_ctr_id  --
        ,t2.wrnt_cst_id 保证人1客户号
        ,t2.wrnt_cst_nm 保证人1客户名称
        ,t2.wrnt_doc_nbr 保证人1证件号码
        ,cb.mbl_nbr 保证人1联系方式
        ,t3.sub_cmnt_nm 保证人1挂靠的子社区
        ,cb.reg_adr 保证人1户籍地址
        ,cb.fml_adr 保证人1居住地址
        ,cb.wrk_adr 保证人1工作或经营地址
FROM    tmp_yuqikexinxi_SJ2025011781_xinyk_01 t1
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t2
ON      t1.busi_ctr_id = t2.bus_ctr_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd cb
ON      t2.wrnt_cst_id = cb.cst_id
AND     cb.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t3
ON      t2.wrnt_cst_id = t3.cst_id
AND     cb.sub_cmnt_id = t3.sub_cmnt_id
AND     t3.dt = '@@{yyyyMMdd}'
ORDER BY t1.crd
;



---信用卡结果表

DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk_fff purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025011781_xinyk_fff  as
SELECT T1.*
        ,t2.保证人1客户号
        ,t2.保证人1客户名称
        ,t2.保证人1证件号码
        ,t2.保证人1联系方式
        ,t2.保证人1挂靠的子社区
        ,t2.保证人1户籍地址
        ,t2.保证人1居住地址
        ,t2.保证人1工作或经营地址
FROM tmp_yuqikexinxi_SJ2025011781_xinyk_01 t1
left join tmp_yuqikexinxi_SJ2025011781_xinyk_ff t2
on t1.crd=t2.crd
;



































-- FROM    tmp_yuqikexinxi_SJ2025011781_daik t1
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t21
-- ON      t1.crd = t21.bus_ctr_id
-- AND     t21.grnt_psn_seq_nbr = '1'
-- AND     t21.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb1
-- ON      t21.wrnt_cst_id = cb1.cst_id
-- AND     cb1.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t211
-- ON      t21.wrnt_cst_id = t211.cst_id
-- AND     cb1.sub_cmnt_id = t211.sub_cmnt_id
-- AND     t211.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t22
-- ON      t1.crd = t22.bus_ctr_id
-- AND     t22.grnt_psn_seq_nbr = '2'
-- AND     t22.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb2
-- ON      t22.wrnt_cst_id = cb2.cst_id
-- AND     cb2.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t221
-- ON      t22.wrnt_cst_id = t221.cst_id
-- AND     cb2.sub_cmnt_id = t221.sub_cmnt_id
-- AND     t221.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t23
-- ON      t1.crd = t23.bus_ctr_id
-- AND     t23.grnt_psn_seq_nbr = '3'
-- AND     t23.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb3
-- ON      t23.wrnt_cst_id = cb3.cst_id
-- AND     cb3.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t231
-- ON      t23.wrnt_cst_id = t231.cst_id
-- AND     cb3.sub_cmnt_id = t231.sub_cmnt_id
-- AND     t231.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t24
-- ON      t1.crd = t24.bus_ctr_id
-- AND     t24.grnt_psn_seq_nbr = '4'
-- AND     t24.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb4
-- ON      t24.wrnt_cst_id = cb4.cst_id
-- AND     cb4.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t241
-- ON      t24.wrnt_cst_id = t241.cst_id
-- AND     cb4.sub_cmnt_id = t241.sub_cmnt_id
-- AND     t241.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t25
-- ON      t1.crd = t25.bus_ctr_id
-- AND     t25.grnt_psn_seq_nbr = '5'
-- AND     t25.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb5
-- ON      t25.wrnt_cst_id = cb5.cst_id
-- AND     cb5.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t251
-- ON      t25.wrnt_cst_id = t251.cst_id
-- AND     cb5.sub_cmnt_id = t251.sub_cmnt_id
-- AND     t251.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t26
-- ON      t1.crd = t26.bus_ctr_id
-- AND     t26.grnt_psn_seq_nbr = '6'
-- AND     t26.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb6
-- ON      t26.wrnt_cst_id = cb6.cst_id
-- AND     cb6.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t261
-- ON      t26.wrnt_cst_id = t261.cst_id
-- AND     cb6.sub_cmnt_id = t261.sub_cmnt_id
-- AND     t261.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t27
-- ON      t1.crd = t27.bus_ctr_id
-- AND     t27.grnt_psn_seq_nbr = '7'
-- AND     t27.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb7
-- ON      t27.wrnt_cst_id = cb7.cst_id
-- AND     cb7.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t271
-- ON      t27.wrnt_cst_id = t271.cst_id
-- AND     cb7.sub_cmnt_id = t271.sub_cmnt_id
-- AND     t271.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd t28
-- ON      t1.crd = t28.bus_ctr_id
-- AND     t28.grnt_psn_seq_nbr = '8'
-- AND     t28.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd cb8
-- ON      t28.wrnt_cst_id = cb8.cst_id
-- AND     cb8.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t281
-- ON      t28.wrnt_cst_id = t281.cst_id
-- AND     cb8.sub_cmnt_id = t281.sub_cmnt_id
-- AND     t281.dt = '@@{yyyyMMdd}'
-- ;
**01-数据需求_分行_2025_D0121_台州分行_逾期借款人与担保人信息实地走访催收.sql
-- SJ2025012006

-- 借款人和担保人的姓名、客户号、身份证号码、联系电话、户籍地址、住宅地址、经营地址

--合同流水号	借款人姓名	20241231余额	条线


--借款人
DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025012006_daik_01 purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025012006_daik_01 as
SELECT  a.col_1  合同流水号
       ,a.col_2 借款人姓名
       ,a.col_3 20241231余额
       ,a.col_4 条线
       ,ctr.cst_id 借款人客户号
        ,b.doc_nbr    AS 借款人身份证号码
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END          AS 借款人联系电话
        ,b.reg_adr    AS 借款人户籍地址
        ,b.fml_adr    AS 借款人居住地址
        ,b.wrk_adr    AS 借款人工作或经营地址
FROM    qbi_file_20250121_10_41_14_0 a
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd ctr
on a.col_1=ctr.ctr_serno
and ctr.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd b
ON      ctr.cst_id= b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON     ctr.cst_id = c.cst_id
where a.pt<>'';

---结果表

DROP TABLE if EXISTS tmp_yuqikexinxi_SJ2025012006_daik_02 purge;
CREATE TABLE IF NOT EXISTS tmp_yuqikexinxi_SJ2025012006_daik_02 as
SELECT a.*
       ,gr.grnt_psn_seq_nbr 担保人序号
       ,gr.wrnt_cst_id 担保人客户号
       ,gr.wrnt_cst_nm 担保人客户名称
       ,gr.wrnt_doc_nbr 担保人证件号码
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END          AS 担保人联系电话
        ,b.reg_adr    AS 担保人户籍地址
        ,b.fml_adr    AS 担保人居住地址
        ,b.wrk_adr    AS 担保人工作或经营地址
from tmp_yuqikexinxi_SJ2025012006_daik_01 a
left join  edw.dws_bus_grnt_prsn_inf_dd gr
on a.合同流水号=gr.bus_ctr_id
and gr.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd b
ON     gr.wrnt_cst_id= b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON     gr.wrnt_cst_id = c.cst_id
order by a.合同流水号,gr.grnt_psn_seq_nbr
**01-数据需求_分行_2025_D0122_舟山分行_毛传庆_逾期客户担保和配偶信息.sql
--SJ20250121126

-- 1、数据日期：2024年12月31日
-- 2、数据范围：舟山分行
-- 3、业务口径：2024年12月31日的未结清风险信贷业务
-- 具体的合同号流水号、借据流水号，结合分行风险部清单已梳理，详见附件。


-- 1、逾期业务/核销业务合同号、借据流水号
-- 2、借款人客户名称、借款人客户号、借款人手机号、借款人地址（居住、户籍、经营均需要）
-- 3、对应借款人的配偶客户名称、配偶客户号、配偶手机号、配偶地址（居住、户籍、经营均需要）
-- 4、对应担保人客户名称、担保人客户号、担保人手机号、担保人地址（居住、户籍、经营均需要）
-- 5、借款人担保人的年龄
-- 6、对应担保人的担保类型（cd_val_dscr）

-- CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250121126_sample (
--     ctr_sr STRING  COMMENT '合同流水号'
--     ,dbl STRING COMMENT '借据流水号'
--     ,cst_nm STRING COMMENT '客户名称'
--     ,cst_id STRING COMMENT '核心客户编号'
-- )
-- ;



---借款人

DROP TABLE if EXISTS tmp_sjxq_SJ20250121126_jkr purge;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250121126_jkr as
SELECT  a.ctr_sr  合同流水号
        ,a.dbl 借据流水号
       ,a.cst_id 借款人客户编号
       ,a.cst_nm 借款人客户名称
        ,datediff(TO_DATE('@@{yyyyMMdd}','yyyymmdd'),to_date(substr(b.doc_nbr,7,8),'yyyymmdd'),'yyyy') 借款人年龄
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END          AS 借款人联系电话
        ,b.reg_adr    AS 借款人户籍地址
        ,b.fml_adr    AS 借款人居住地址
        ,b.wrk_adr    AS 借款人工作或经营地址
FROM    tmp_sjxq_SJ20250121126_sample a
left join edw.dws_cst_bas_inf_dd b
ON     a.cst_id= b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON     a.cst_id= c.cst_id
;


--担保人
DROP TABLE if EXISTS tmp_sjxq_SJ20250121126_gran purge;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250121126_gran as
SELECT a.*
       ,gr.grnt_psn_seq_nbr 担保人序号
       ,gr.wrnt_cst_id 担保人客户号
       ,gr.wrnt_cst_nm 担保人客户名称
    --    ,gr.wrnt_doc_nbr 担保人证件号码
       ,datediff(TO_DATE('@@{yyyyMMdd}','yyyymmdd'),to_date(substr(gr.wrnt_doc_nbr,7,8),'yyyymmdd'),'yyyy') 担保人年龄
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END          AS 担保人联系电话
        ,b.reg_adr    AS 担保人户籍地址
        ,b.fml_adr    AS 担保人居住地址
        ,b.wrk_adr    AS 担保人工作或经营地址
from tmp_sjxq_SJ20250121126_sample a
left join  edw.dws_bus_grnt_prsn_inf_dd gr
on a.ctr_sr=gr.bus_ctr_id
and gr.dt='@@{yyyyMMdd}'
left join edw.dws_cst_bas_inf_dd b
ON     gr.wrnt_cst_id= b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON     gr.wrnt_cst_id = c.cst_id
order by a.ctr_sr,gr.grnt_psn_seq_nbr


--配偶
DROP TABLE if EXISTS tmp_sjxq_SJ20250121126_cp purge;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250121126_cp as
SELECT a.*
       ,rel.rel_cst_id 配偶客户号
       ,b.cst_chn_nm 配偶名称
       ,datediff(TO_DATE('@@{yyyyMMdd}','yyyymmdd'),to_date(substr(b.doc_nbr,7,8),'yyyymmdd'),'yyyy') 配偶年龄
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END          AS 配偶联系电话
        ,b.reg_adr    AS 配偶户籍地址
        ,b.fml_adr    AS 配偶居住地址
        ,b.wrk_adr    AS 配偶工作或经营地址
from tmp_sjxq_SJ20250121126_sample a
left join  edw.loan_cst_rel rel   --关联关系
on a.cst_id=rel.cst_id
and rel.dt='@@{yyyyMMdd}'
and rel.rel_typ='0301'   --配偶
left join edw.dws_cst_bas_inf_dd b
ON     rel.rel_cst_id= b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON     rel.rel_cst_id= c.cst_id
order by a.cst_id
;


--结果表
--100条数据

DROP TABLE if EXISTS tmp_sjxq_SJ20250121126_f purge;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250121126_f as
SELECT t1.*
       ,t2.担保人序号
       ,t2.担保人客户号
       ,t2.担保人客户名称
       ,t2.担保人年龄
       ,t2.担保人联系电话
       ,t2.担保人户籍地址
       ,t2.担保人居住地址
       ,t2.担保人工作或经营地址
       ,t3.配偶客户号
       ,t3.配偶名称
       ,t3.配偶年龄
       ,t3.配偶联系电话
       ,t3.配偶户籍地址
       ,t3.配偶居住地址
       ,t3.配偶工作或经营地址
FROM tmp_sjxq_SJ20250121126_jkr t1
left join tmp_sjxq_SJ20250121126_gran t2
on t1.合同流水号=t2.ctr_sr
left join tmp_sjxq_SJ20250121126_cp t3
on  t1.借款人客户编号=t3.cst_id
and t1.合同流水号=t3.ctr_sr
;
**01-数据需求_分行_2025_D0205_丽水分行_叶宇_未结清风险信贷业务借款人配偶担保人信息.sql
-- SJ2025012626
-- 1、数据日期：2024年12月31日
-- 2、数据范围：丽水分行
-- 3、业务口径：2024年12月31日的未结清风险信贷业务

-- 1、逾期业务/核销业务合同号、借据流水号
-- 2、借款人客户名称、借款人客户号、借款人手机号、借款人地址（居住、户籍、经营均需要）
-- 3、对应借款人的配偶客户名称、配偶客户号、配偶手机号、配偶地址（居住、户籍、经营均需要）
-- 4、对应担保人客户名称、担保人客户号、担保人手机号、担保人地址（居住、户籍、经营均需要）
-- 5、借款人担保人的年龄
-- 6、对应担保人的担保类型（cd_val_dscr）



DROP TABLE IF EXISTS lab_bigdata_dev.SJ2025012626_tmp_1 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2025012626_tmp_1 AS
SELECT  T1.合同流水号
        ,T1.借据或信用卡号
        ,T1.余额
        ,T1.业务类型
        ,T1.客户名称 借款人客户名称
        ,T1.客户号 借款人客户号
       --  ,T2.mbl_nbr 借款人手机号
        ,CASE
           WHEN coalesce(c1.ctc_tel, '') <> ''     THEN c1.ctc_tel
           WHEN coalesce(T2.mbl_nbr, '') <> ''     THEN T2.mbl_nbr
           WHEN coalesce(T2.fml_tel_nbr, '') <> '' THEN T2.fml_tel_nbr
         END          AS 借款人联系电话
        ,T2.reg_adr 借款人户籍地址
        ,T2.cmn_adr 借款人通讯地址
        ,T2.wrk_adr 借款人经营地址
        ,T4.cst_chn_nm 配偶客户名称
        ,T4.cst_id 配偶客户号
       --  ,T4.mbl_nbr 配偶手机号
        ,CASE
           WHEN coalesce(c2.ctc_tel, '') <> ''     THEN c2.ctc_tel
           WHEN coalesce(T4.mbl_nbr, '') <> ''     THEN T4.mbl_nbr
           WHEN coalesce(T4.fml_tel_nbr, '') <> '' THEN T4.fml_tel_nbr
       end as 配偶联系方式
        ,T4.reg_adr 配偶户籍地址
        ,T4.cmn_adr 配偶通讯地址
        ,T4.wrk_adr 配偶经营地址
        ,cast(T7.grnt_psn_seq_nbr as BIGINT) 担保人序号
        ,T7.wrnt_cst_nm 担保人客户名称
        ,T7.wrnt_cst_id 担保人客户号
       --  ,T8.mbl_nbr 担保人手机号
        ,CASE
           WHEN coalesce(c3.ctc_tel, '') <> ''     THEN c3.ctc_tel
           WHEN coalesce(T8.mbl_nbr, '') <> ''     THEN T8.mbl_nbr
           WHEN coalesce(T8.fml_tel_nbr, '') <> '' THEN T8.fml_tel_nbr
       end as 担保人联系方式
        ,T8.reg_adr 担保人户籍地址
        ,T8.cmn_adr 担保人通讯地址
        ,T8.wrk_adr 担保人经营地址
        ,datediff(to_date('20241231','yyyyMMdd'),to_date(substr(t2.doc_nbr,7,8),'yyyyMMdd'),'yyyy') 借款人年龄
        ,datediff(to_date('20241231','yyyyMMdd'),to_date(substr(t8.doc_nbr,7,8),'yyyyMMdd'),'yyyy') 担保人年龄
        ,decode(T7.grnt_typ_cd,'010','保证','005','信用','020','抵押','040','质押')  担保类型
FROM    (
            select a.col_1 合同流水号
                   ,a.col_2 借据或信用卡号
                   ,a.col_3  客户号
                   ,a.col_4 客户名称
                   ,a.col_5 余额
                   ,a.col_6 业务类型
              --      ,case when length(busi_ctr_id)=10 then '信用卡业务' else '贷款业务' end as 业务类型
            from qbi_file_20250206_14_27_24_0 a
            where substr(a.pt,1,8)='20250206'
        ) T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.CST_ID
AND     T2.DT = '20241231'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c1 --取本人联系方式
on T1.客户号=c1.cst_id
LEFT JOIN    edw.loan_cst_rel T3 --关联关系
ON      T1.客户号 = T3.cst_id
AND     T3.rel_typ = '0301' --配偶
AND     T3.DT = '20241231'
and T3.del_ind='0'
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T3.rel_cst_id = T4.CST_ID
AND     T4.DT = '20241231'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c2 --取配偶联系方式
on T3.rel_cst_id =c2.cst_id
left  join  edw.dws_bus_grnt_prsn_inf_dd T7
on T1.合同流水号=T7.bus_ctr_id
and T7.dt='20241231'
LEFT JOIN    edw.dws_cst_bas_inf_dd T8 --客户基础信息汇总表
ON      T7.wrnt_cst_id = T8.CST_ID
AND     T8.DT = '20241231'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c3 --取担保人联系方式
on T7.wrnt_cst_id=c3.cst_id
WHERE   T1.业务类型 = '贷款/随贷通'
ORDER BY T1.合同流水号,T7.grnt_psn_seq_nbr
;



--**取信用卡担保人，不能直接用edw.dws_bus_grnt_prsn_inf_dd  --担保人汇总，信用卡会有缺失，先根据卡号获取信用卡合同号，再用担保合同和担保物的表关联，


--*****取信用卡担保人
DROP TABLE IF EXISTS lab_bigdata_dev.SJ2025012626_tmp_2 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2025012626_tmp_2 AS
SELECT T1.合同流水号
        ,T1.借据或信用卡号
        ,T1.余额
        ,T1.业务类型
        ,T1.客户名称 借款人客户名称
        ,T1.客户号 借款人客户号
        -- ,T2.mbl_nbr 借款人手机号
        ,CASE
           WHEN coalesce(c1.ctc_tel, '') <> ''     THEN c1.ctc_tel
           WHEN coalesce(T2.mbl_nbr, '') <> ''     THEN T2.mbl_nbr
           WHEN coalesce(T2.fml_tel_nbr, '') <> '' THEN T2.fml_tel_nbr
         END          AS 借款人联系电话
        ,T2.reg_adr 借款人户籍地址
        ,T2.cmn_adr 借款人通讯地址
        ,T2.wrk_adr 借款人经营地址
        ,T4.cst_chn_nm 配偶客户名称
        ,T4.cst_id 配偶客户号
        -- ,T4.mbl_nbr 配偶手机号
        ,CASE
           WHEN coalesce(c2.ctc_tel, '') <> ''     THEN c2.ctc_tel
           WHEN coalesce(T4.mbl_nbr, '') <> ''     THEN T4.mbl_nbr
           WHEN coalesce(T4.fml_tel_nbr, '') <> '' THEN T4.fml_tel_nbr
       end as 配偶联系方式
        ,T4.reg_adr 配偶户籍地址
        ,T4.cmn_adr 配偶通讯地址
        ,T4.wrk_adr 配偶经营地址
        ,dense_rank() over(PARTITION by T1.借据或信用卡号 ORDER by T6.cltr_no ) 担保人序号
        ,T6.cltr_nm 担保人客户名称
        ,T6.cltr_no 担保人客户号
        -- ,T8.mbl_nbr 担保人手机号
        ,CASE
           WHEN coalesce(c3.ctc_tel, '') <> ''     THEN c3.ctc_tel
           WHEN coalesce(T8.mbl_nbr, '') <> ''     THEN T8.mbl_nbr
           WHEN coalesce(T8.fml_tel_nbr, '') <> '' THEN T8.fml_tel_nbr
       end as 担保人联系方式
        ,T8.reg_adr 担保人户籍地址
        ,T8.cmn_adr 担保人通讯地址
        ,T8.wrk_adr 担保人经营地址
        ,datediff(to_date('20241231', 'yyyyMMdd'), to_date(substr(t2.doc_nbr, 7, 8), 'yyyyMMdd'), 'yyyy') 借款人年龄
        ,datediff(to_date('20241231', 'yyyyMMdd'), to_date(substr(t8.doc_nbr, 7, 8), 'yyyyMMdd'), 'yyyy') 担保人年龄
        -- , decode(T9.grnt_mod_colc, '010', '保证', '005', '信用', '020', '抵押', '040', '质押') 担保类型
        ,T9.grnt_mod_nm 担保类型
FROM    (
            SELECT  a.col_1 合同流水号
                    ,a.col_2 借据或信用卡号
                    ,a.col_3 客户号
                    ,a.col_4 客户名称
                    ,a.col_5 余额
                    ,a.col_6 业务类型
            --      ,case when length(busi_ctr_id)=10 then '信用卡业务' else '贷款业务' end as 业务类型
            FROM    qbi_file_20250206_14_27_24_0 a
            WHERE   substr(a.pt, 1, 8) = '20250206'
        ) T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.CST_ID
AND     T2.DT = '20241231'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c1 --取借款人联系方式
on T1.客户号=c1.cst_id
LEFT JOIN    edw.loan_cst_rel T3 --关联关系
ON      T1.客户号 = T3.cst_id
AND     T3.rel_typ = '0301' --配偶
AND     T3.DT = '20241231'
AND     T3.del_ind = '0'
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T3.rel_cst_id = T4.CST_ID
AND     T4.DT = '20241231'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c2 --取配偶联系方式
on T3.rel_cst_id =c2.cst_id
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd T11 --信用卡卡片信息
ON      T1.借据或信用卡号 = T11.cr_crd_card_nbr
AND     T11.DT = '20241231'
LEFT JOIN    edw.dwd_bus_loan_ctr_rel_grnt_dd T5 --主合同、担保合同关系,担保物类型代码 -- 1 保证人 2 押品
ON      T11.busi_ctr_id = T5.ctr_serno
AND     T5.dt = '20241231'
AND     T5.busi_typ_cd = '2'   --业务类型代码：1贷款业务2信用卡业务
LEFT JOIN    edw.DWD_BUS_LOAN_GRNT_CTR_REL_GRNT_DD T6 --担保合同、担保物关系 包括担保合同和押品的关联关系、担保合同和担保人的关联关系
ON      T5.grnt_ctr_no = T6.grnt_ctr_no
AND     T6.dt = '20241231'
LEFT JOIN    edw.dws_cst_bas_inf_dd T8 --客户基础信息汇总表
ON      T6.cltr_no = T8.CST_ID --担保物名称即为担保人
AND     T8.DT = '20241231'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c3 --取担保人联系方式
on T6.cltr_no=c3.cst_id
left JOIN (
          SELECT  a.ctr_serno
                  ,a.grnt_mod_colc
                  ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241231'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '20241231'
                GROUP BY a.ctr_serno , a.grnt_mod_colc
)T9
on T11.busi_ctr_id = T9.ctr_serno
WHERE   T1.业务类型 = '信用卡'
ORDER BY T1.合同流水号
;

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.SJ2025012626_tmp_final PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2025012626_tmp_final AS
select distinct t.* from
(
SELECT  t1 . *
FROM    lab_bigdata_dev.SJ2025012626_tmp_1 t1
UNION ALL
SELECT  t2 . *
FROM    lab_bigdata_dev.SJ2025012626_tmp_2 t2
)t;
**01-数据需求_分行_2025_D0211_杭州分行_陈敏珠_非不良重组客户当前征信及他行逾期_不良情况.sql
-- SJ2025021161
-- 分行非不良重组客户当前征信及他行逾期、不良情况

-- 合同流水号、借款人名字、合同余额、合同到期日、管户机构号、管户人工号、管户人姓名
--当前借款人中征分、他行五级分类、他行贷款当前逾期期数     他行贷款当前逾期金额     他行信用卡当前逾期期数     他行信用卡当前逾期金额     他行不良余额     呆账笔数     呆账余额

----临时表 1.1 附件导入
DROP TABLE if EXISTS tmp_sjxq_SJ2025021161_01 purge;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021161_01 as
SELECT cast(col_1 as int) as 序号
       ,col_2 as 合同流水号_账户号
       ,col_3 as 借据流水号_卡号
       ,col_4 as 管户机构号
       ,col_5 as 管户机构名称
       ,col_6 as 客户名称
       ,col_7 as 客户号
       ,col_8 as 0209借据余额
       ,col_9 as 借据金额
       ,substr(col_10,1,10) as 借据发放日期
       ,substr(col_11,1,10) as 借据约定到期日期
       ,col_12 as 五级分类
       ,col_13 as 本息最长逾期天数
       ,col_14 as 担保方式
       ,col_15 as 还本计息代码
FROM qbi_file_20250211_13_57_33_0
WHERE pt<>''
ORDER BY col_1 ;


--临时表 1.2 中征分
DROP TABLE IF EXISTS tmp_sjxq_SJ2025021161_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021161_02 AS
SELECT
     A1.*
FROM (
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t
	) A1
WHERE A1.RK = 1	;



--临时表 1.3 他行贷款征信信息
DROP TABLE IF EXISTS tmp_sjxq_SJ2025021161_03 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021161_03 AS
-- 个人征信
SELECT  A1.cst_id
        ,A1.report_id
        ,A1.pd_cd
        ,A1.ctr_amt
        ,A1.ctr_bal
        ,A1.ovd_trm
        ,A1.ovd_amt
        ,A1.act_typ_cd
		,A1.five_ctg_cd
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT =  '@@{yyyyMMdd}'
and     A1.dtrb_org <> 'ZJTLCB'    ---- 不含泰隆
AND     A1.cls_dt >= A1.DT  --关闭日期
AND     A1.mtu_dt >= A1.DT  --到期日期
UNION ALL
--企业征信
SELECT  A1.cst_id
        ,A1.report_id
		,A1.bus_pd_cls_cd	  AS pd_cd
        ,A1.loan_amt	                                                   AS ctr_amt
        ,A1.loan_bal                                                       AS ctr_bal
		,CAST(A1.ovd_mon AS STRING)	        AS   ovd_trm
        ,A1.ovd_tot_amt	   	 AS 	ovd_amt
		,A1.act_typ	    AS act_typ_cd
		,A1.five_ctg_cd
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
and     A1.dtrb_org_typ_cd <> '00'   ---- 不含泰隆
AND     A1.cls_dt >= A1.DT  --关闭日期
AND     A1.loan_mtu_dt >= A1.DT  --到期日期
;




-- 结果表
-- 合同流水号、借款人名字、合同余额、合同到期日、管户机构号、管户人工号、管户人姓名
--当前借款人中征分、他行五级分类、他行贷款当前逾期期数     他行贷款当前逾期金额     他行信用卡当前逾期期数     他行信用卡当前逾期金额     他行不良（次级以上）余额     呆账笔数     呆账余额
DROP TABLE IF EXISTS tmp_sjxq_SJ2025021161_jgb PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021161_jgb AS
SELECT  T1.序号
       ,T1.合同流水号_账户号
       ,T1.借据流水号_卡号
       ,T1.管户机构号
       ,T1.管户机构名称
       ,T1.客户名称
       ,T1.客户号
       ,T1.0209借据余额
       ,T1.借据金额
       ,T1.借据发放日期
       ,T1.借据约定到期日期
       ,T1.五级分类
       ,T1.本息最长逾期天数
       ,T1.担保方式
       ,T1.还本计息代码
	   ,T2.ctr_bal	 AS 合同余额
	   ,T2.ctr_mtu_dt	 AS 合同到期日
	   ,T2.mgr_id	    AS 信贷合同管户人工号
	   ,T3.empe_nm	   AS 信贷合同管户人名称
	   ,T2.mgr_org_id	AS 信贷合同管户机构号
	   ,T4.org_nm  AS 信贷合同管户机构名称
	   ,T5.中证评分  AS 当前借款人中征分
	   ,COALESCE(T6.five_cgy_cd	,T61.five_cgy_cd	) AS 征信五级分类代码
       ,CASE
             WHEN COALESCE(T6.five_cgy_cd	,T61.five_cgy_cd ) ='1'	THEN '正常'
             WHEN COALESCE(T6.five_cgy_cd	,T61.five_cgy_cd ) ='2'	THEN '关注'
             WHEN COALESCE(T6.five_cgy_cd	,T61.five_cgy_cd ) ='3'	THEN '次级'
             WHEN COALESCE(T6.five_cgy_cd	,T61.five_cgy_cd ) ='4'	THEN '可疑'
             WHEN COALESCE(T6.five_cgy_cd	,T61.five_cgy_cd ) ='5'	THEN '损失'
        END  AS 征信五级分类
	   ,T7.他行贷款当前最大逾期期数
	   ,T7.他行贷款当前逾期金额
	   ,T7.他行信用卡当前最大逾期期数
	   ,T7.他行信用卡当前逾期金额
	   ,T7.他行不良余额
	   ,T6.dz_acct_num	 AS 呆账笔数
	   ,T6.dz_acct_balan	 AS 呆账余额
FROM tmp_sjxq_SJ2025021161_01 T1
LEFT JOIN edw.dim_bus_loan_ctr_bse_inf_dd T2
ON   T1.合同流水号_账户号 = T2.ctr_serno
AND  T2.DT = '@@{yyyyMMdd}'
LEFT JOIN  edw.dws_hr_empe_inf_dd T3
ON   T2.mgr_id = T3.empe_id
AND  T3.DT = '@@{yyyyMMdd}'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T4
ON   T2.mgr_org_id = T4.org_id
AND  T4.DT = '@@{yyyyMMdd}'
LEFT JOIN tmp_sjxq_SJ2025021161_02 T5
ON   T1.客户号 = T5.cst_id
LEFT JOIN edw.dws_cst_ccrc_idv_ind_inf_dd T6 --个人征信指标信息表
ON   T1.客户号 = T6.cst_id
AND  T6.report_dsc_rn	 = 1
AND  T6.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dws_cst_ccrc_entp_ind_inf_dd T61 --企业征信指标信息表
ON   T1.客户号 = T61.cst_id
AND  T61.report_dsc_rn	 = 1
AND  T61.DT = '@@{yyyyMMdd}'
LEFT JOIN (
             SELECT
                 A1.cst_id
                ,MAX(CASE WHEN A1.act_typ_cd not in ('R2' , 'R3' ,'C1')  THEN A1.ovd_trm END ) AS 他行贷款当前最大逾期期数   --账户类型不为 贷记卡、准贷记卡、催收账户
                ,SUM(CASE WHEN A1.act_typ_cd not in ('R2' , 'R3' ,'C1')  THEN A1.ovd_amt END ) AS 他行贷款当前逾期金额
                ,MAX(CASE WHEN A1.act_typ_cd  IN ('R2' , 'R3' )  THEN A1.ovd_trm END ) AS 他行信用卡当前最大逾期期数     --账户类型为 贷记卡、准贷记卡
                ,SUM(CASE WHEN A1.act_typ_cd  IN ('R2' , 'R3' )  THEN A1.ovd_amt END ) AS 他行信用卡当前逾期金额
                ,SUM(CASE WHEN A1.five_ctg_cd NOT IN ('1','2') THEN A1.ctr_bal END ) AS 他行不良余额    --五级分类不为正常，关注
             FROM tmp_sjxq_SJ2025021161_03 A1
             WHERE A1.RN = 1
             GROUP BY  A1.cst_id
          )  T7
ON   T1.客户号 = T7.cst_id
ORDER BY T1.序号
;
**01-数据需求_分行_2025_D0213_褚雨田_嘉兴分行_逾期客户及联系人基本信息.sql
--SJ2025021341
-- 截止2024年12月31日，嘉兴分行逾期客户用于客户催收走访的数据
--借款人性别、年龄、经营场所地址、办公地址、居住地址、户籍地址；担保人名称、性别、年龄、经营场所地址、办公地址、居住地址、户籍地址、与借款人关系、担保金额、担保能力评价；



--贷款 提供9686条数据，结果有16113条数据
DROP TABLE IF EXISTS tmp_sjxq_SJ2025021341_daikuan PURGE;
create table if not exists tmp_sjxq_SJ2025021341_daikuan as
SELECT DISTINCT '贷款' as 业务类型
        ,a.col_1 合同号
        ,a.col_2 借据或卡号
        ,a.col_3 机构号
        ,a.col_4 客户号
        ,a.col_5 客户姓名
        ,CASE
           WHEN c1.gdr_cd = '1' THEN '男'
           WHEN c1.gdr_cd = '2' THEN '女'
         END 性别
        ,datediff(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(c1.bth_dt, 'yyyymmdd'), 'yyyy')  AS 年龄
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> ''     THEN c.ctc_tel
           WHEN coalesce(b.mbl_nbr, '') <> ''     THEN b.mbl_nbr
           WHEN coalesce(b.fml_tel_nbr, '') <> '' THEN b.fml_tel_nbr
         END                                                                                    AS 联系电话
        ,T60.ful_adr                                                                            AS 经营场所地址
        ,T7.ful_adr                                                                             AS 办公地址
        ,T8.ful_adr                                                                             AS 家庭地址
        ,T9.ful_adr                                                                             AS 户籍地址
        ,gr.grnt_psn_seq_nbr                                                                    AS 担保人序号
        ,gr.wrnt_cst_id                                                                         AS 担保人客户号
        ,gr.wrnt_cst_nm                                                                         AS 担保人姓名
        ,CASE
           WHEN gr1.gdr_cd = '1' THEN '男'
           WHEN gr1.gdr_cd = '2' THEN '女'
         END 担保人性别
        ,datediff(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(gr1.bth_dt, 'yyyymmdd'), 'yyyy') AS 担保人年龄
        ,CASE
           WHEN coalesce(q.ctc_tel, '') <> '' THEN c.ctc_tel
         END                                                                                    AS 担保人联系电话
        ,T601.ful_adr                                                                           AS 担保人经营场所地址
        ,T71.ful_adr                                                                            AS 担保人办公地址
        ,T81.ful_adr                                                                            AS 担保人家庭地址
        ,T91.ful_adr                                                                            AS 担保人户籍地址
        ,gr2.grnt_amt                                                                           AS 担保金额
        ,CASE
           WHEN gr2.with_brwr_rel = '010' THEN '家人'
           WHEN gr2.with_brwr_rel = '020' THEN '亲戚'
           WHEN gr2.with_brwr_rel = '030' THEN '朋友'
           WHEN gr2.with_brwr_rel = '040' THEN '合伙人'
           WHEN gr2.with_brwr_rel = '050' THEN '同事'
           WHEN gr2.with_brwr_rel = '060' THEN '邻居'
           WHEN gr2.with_brwr_rel = '070' THEN '法人与法定代表人'
           WHEN gr2.with_brwr_rel = '080' THEN '法人与实际控制人'
           WHEN gr2.with_brwr_rel = '090' THEN '法人与股东'
           WHEN gr2.with_brwr_rel = '100' THEN '上下游客户'
           WHEN gr2.with_brwr_rel = '102' THEN '借款人所在村村委'
           WHEN gr2.with_brwr_rel = '105' THEN '我行贷款户'
           WHEN gr2.with_brwr_rel = '108' THEN '社区关键人'
           WHEN gr2.with_brwr_rel = '110' THEN '其他'
           WHEN gr2.with_brwr_rel = '6'   THEN '本人'
           ELSE ''
         END                                                                                    AS 与借款人关系
        ,gr3.gtor_cprsv_evl                                                                     AS 担保人能力评价
FROM    qbi_file_20250213_14_55_45_0 a
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd c1
ON      a.col_4 = c1.cst_id
AND     c1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd b --联系电话
ON      a.col_4 = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON      a.col_4 = c.cst_id
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T60
ON      a.col_4 = T60.cst_id
AND     T60.dt = '@@{yyyyMMdd}'
AND     T60.phy_adr_typ_cd = '050900' -- 经营所在地地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T7
ON      a.col_4 = T7.cst_id
AND     T7.dt = '@@{yyyyMMdd}'
AND     T7.phy_adr_typ_cd = '050400' -- 工作单位地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T8
ON      a.col_4 = T8.cst_id
AND     T8.dt = '@@{yyyyMMdd}'
AND     T8.phy_adr_typ_cd = '050200' -- 家庭地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T9
ON      a.col_4 = T9.cst_id
AND     T9.dt = '@@{yyyyMMdd}'
AND     T9.phy_adr_typ_cd = '050100'  -- 户籍地址
--担保人
LEFT JOIN    edw.DWS_BUS_GRNT_PRSN_INF_DD gr --担保人汇总
ON      a.col_1 = gr.bus_ctr_id
AND     gr.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd gr1
ON      gr.wrnt_cst_id = gr1.cst_id
AND     gr1.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) q --取本人联系方式
ON      gr.wrnt_cst_id = q.cst_id
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T601
ON      gr.wrnt_cst_id = T601.cst_id
AND     T601.dt = '@@{yyyyMMdd}'
AND     T601.phy_adr_typ_cd = '050900' -- 经营所在地地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T71
ON      gr.wrnt_cst_id = T71.cst_id
AND     T71.dt = '@@{yyyyMMdd}'
AND     T71.phy_adr_typ_cd = '050400' -- 工作单位地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T81
ON      gr.wrnt_cst_id = T81.cst_id
AND     T81.dt = '@@{yyyyMMdd}'
AND     T81.phy_adr_typ_cd = '050200' -- 家庭地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T91
ON      gr.wrnt_cst_id = T91.cst_id
AND     T91.dt = '@@{yyyyMMdd}'
AND     T91.phy_adr_typ_cd = '050100' -- 户籍地址
LEFT JOIN    edw.loan_ctr_gtor_inf gr2 --保证人信息
ON      a.col_1 = gr2.ctr_serno
AND     gr.wrnt_cst_id = gr2.gtor_no
AND     gr2.dt = '@@{yyyyMMdd}'
AND     gr2.del_ind = '0'
LEFT JOIN    edw.loan_svy_rel_gtor_inf gr3 --关联保证人信息
ON      gr.wrnt_cst_id = gr3.gtor_no
AND     gr3.dt = '@@{yyyyMMdd}'
AND     gr3.del_ind = '0'
WHERE   a.pt <> ''
AND     LENGTH(a.col_1) > '10' --贷款
ORDER BY a.col_1 , gr.grnt_psn_seq_nbr;


--信用卡 提供1078，实际1094条数据，存在一个信用卡，多个担保人情况。

DROP TABLE IF EXISTS tmp_sjxq_SJ2025021341_xinyongka PURGE;
create table if not exists tmp_sjxq_SJ2025021341_xinyongka as
SELECT  '信用卡'                                                                                    AS 业务类型
        ,a.col_1 合同号
         ,b.busi_ctr_id 业务合同编号
        ,a.col_2 借据或卡号
        ,a.col_3 机构号
        ,a.col_4 客户号
        ,a.col_5 客户姓名
        ,CASE
           WHEN c1.gdr_cd = '1' THEN '男'
           WHEN c1.gdr_cd = '2' THEN '女'
         END 性别
        ,datediff(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(c1.bth_dt, 'yyyymmdd'), 'yyyy')   AS 年龄
        ,CASE
           WHEN coalesce(c.ctc_tel, '') <> '' THEN c.ctc_tel
         END                                                                                     AS 联系电话
        ,T60.ful_adr                                                                             AS 经营场所地址
        ,T7.ful_adr                                                                              AS 办公地址
        ,T8.ful_adr                                                                              AS 家庭地址
        ,T9.ful_adr                                                                              AS 户籍地址
        ,b2.grnt_gds_id                                                                          AS 担保人客户号
        ,b2.grnt_gds_nm                                                                          AS 担保人姓名
        ,CASE
           WHEN gr11.gdr_cd = '1' THEN '男'
           WHEN gr11.gdr_cd = '2' THEN '女'
         END 担保人性别
        ,datediff(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(gr11.bth_dt, 'yyyymmdd'), 'yyyy') AS 担保人年龄
        ,CASE
           WHEN coalesce(q.ctc_tel, '') <> '' THEN c.ctc_tel
         END                                                                                     AS 担保人联系电话
        ,T601.ful_adr                                                                            AS 担保人经营场所地址
        ,T71.ful_adr                                                                             AS 担保人办公地址
        ,T81.ful_adr                                                                             AS 担保人家庭地址
        ,T91.ful_adr                                                                             AS 担保人户籍地址
        ,b2.grnt_amt                                                                             AS 担保金额
        ,CASE
           WHEN gr2.with_brwr_rel = '010' THEN '家人'
           WHEN gr2.with_brwr_rel = '020' THEN '亲戚'
           WHEN gr2.with_brwr_rel = '030' THEN '朋友'
           WHEN gr2.with_brwr_rel = '040' THEN '合伙人'
           WHEN gr2.with_brwr_rel = '050' THEN '同事'
           WHEN gr2.with_brwr_rel = '060' THEN '邻居'
           WHEN gr2.with_brwr_rel = '070' THEN '法人与法定代表人'
           WHEN gr2.with_brwr_rel = '080' THEN '法人与实际控制人'
           WHEN gr2.with_brwr_rel = '090' THEN '法人与股东'
           WHEN gr2.with_brwr_rel = '100' THEN '上下游客户'
           WHEN gr2.with_brwr_rel = '102' THEN '借款人所在村村委'
           WHEN gr2.with_brwr_rel = '105' THEN '我行贷款户'
           WHEN gr2.with_brwr_rel = '108' THEN '社区关键人'
           WHEN gr2.with_brwr_rel = '110' THEN '其他'
           WHEN gr2.with_brwr_rel = '6'   THEN '本人'
           ELSE ''
         END                                                                                     AS 与借款人关系
        ,gr3.gtor_cprsv_evl                                                                      AS 担保人能力评价
FROM    qbi_file_20250213_14_55_45_0 a
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd c1
ON      a.col_4 = c1.cst_id
AND     c1.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) c --取本人联系方式
ON      a.col_4 = c.cst_id
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T60
ON      a.col_4 = T60.cst_id
AND     T60.dt = '@@{yyyyMMdd}'
AND     T60.phy_adr_typ_cd = '050900' -- 经营所在地地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T7
ON      a.col_4 = T7.cst_id
AND     T7.dt = '@@{yyyyMMdd}'
AND     T7.phy_adr_typ_cd = '050400' -- 工作单位地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T8
ON      a.col_4 = T8.cst_id
AND     T8.dt = '@@{yyyyMMdd}'
AND     T8.phy_adr_typ_cd = '050200' -- 家庭地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T9
ON      a.col_4 = T9.cst_id
AND     T9.dt = '@@{yyyyMMdd}'
AND     T9.phy_adr_typ_cd = '050100' -- 户籍地址
LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd b
ON      a.col_2 = b.cr_crd_card_nbr
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_ctr_rel_grnt_dd b1
ON      b.busi_ctr_id = b1.ctr_serno
AND     b1.dt = '@@{yyyyMMdd}'
AND     b1.busi_typ_cd = '2' --信用卡业务
LEFT JOIN    edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd b2 --主合同、担保合同、担保物关系
ON      b1.ctr_serno = b2.ctr_serno
AND     b1.grnt_ctr_no = b2.grnt_ctr_no
AND     b2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd gr11
ON      b2.grnt_gds_id = gr11.cst_id
AND     gr11.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  ct.cst_id
                         ,wm_concat(DISTINCT '|', ct.ctc_tel) AS ctc_tel
                 FROM    edw.loan_CST_CTC_TEL ct --联系电话
                 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息
                 ON      ct.serno = cr.rel_serno
                 AND     ct.cst_id = cr.cst_id
                 AND     cr.dt = '@@{yyyyMMdd}'
                 AND     cr.rel_typ = '0001' --本人
                 AND     cr.del_ind = '0'
                 WHERE   ct.dt = '@@{yyyyMMdd}'
                 AND     ct.del_ind = '0'
                 GROUP BY ct.cst_id
             ) q --取本人联系方式
ON      b2.grnt_gds_id = q.cst_id
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T601
ON      b2.grnt_gds_id = T601.cst_id
AND     T601.dt = '@@{yyyyMMdd}'
AND     T601.phy_adr_typ_cd = '050900' -- 经营所在地地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T71
ON      b2.grnt_gds_id = T71.cst_id
AND     T71.dt = '@@{yyyyMMdd}'
AND     T71.phy_adr_typ_cd = '050400' -- 工作单位地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T81
ON      b2.grnt_gds_id = T81.cst_id
AND     T81.dt = '@@{yyyyMMdd}'
AND     T81.phy_adr_typ_cd = '050200' -- 家庭地址
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T91
ON      b2.grnt_gds_id = T91.cst_id
AND     T91.dt = '@@{yyyyMMdd}'
AND     T91.phy_adr_typ_cd = '050100' -- 户籍地址
LEFT JOIN    edw.loan_ctr_gtor_inf gr2 --保证人信息
ON      b.busi_ctr_id = gr2.ctr_serno
AND     b2.grnt_gds_id = gr2.gtor_no
AND     gr2.dt = '@@{yyyyMMdd}'
AND     gr2.del_ind = '0'
LEFT JOIN    edw.loan_svy_rel_gtor_inf gr3 --关联保证人信息
ON      b2.grnt_gds_id = gr3.gtor_no
AND     gr3.dt = '@@{yyyyMMdd}'
AND     gr3.del_ind = '0'
WHERE   a.pt <> ''
AND     LENGTH(a.col_1) = '10'   --信用卡
order by a.col_1
;
**01-数据需求_分行_2025_D0214_方安君_杭州分行一二级信贷调查资质考评官人员.sql
-- SJ2025021346
-- 2024年1月1日-2024年12月9日，苏州分行一二级信贷调查资质考评官人员信息
-- 申请人工号	申请人姓名	申请人所属机构	申请时间	考评官工号	考评官姓名



DROP TABLE IF EXISTS tmp_sjxq_SJ2025021346 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021346 AS
SELECT  a.sqrgh             AS 申请人工号
        -- ,a.sqrxm           AS 申请人姓名编号
        ,a1.empe_nm           AS 申请人姓名
        ,a1.org_id as 申请人所属机构号
        ,a2.org_nm as 申请人所属机构
        ,a.sqrq as 申请时间
        ,b.gh              AS 实务考评官工号
        -- ,b.xm              AS 实务考评官姓名编号
        ,h2.lastname       AS 实务考评官姓名
        --    ,b.gw  as 实务考评官岗位
        ,h2.tljobtitlename AS 实务考评官岗位
FROM   edw.oadb_formtable_main_566 a --一二级信贷业务调查资质评定申请表
-- LEFT JOIN    edw.oadb_workflow_requestbase wr ---工作流请求基本信息表，只取流程状态归档的
-- ON      a.requestid = wr.requestid
-- AND     wr.dt = '20241231'
-- and     wr.currentnodetype = '3'   --归档
left join edw.dws_hr_empe_inf_dd a1
on a.sqrgh=a1.empe_id
and a1.dt='20241231'
left join edw.dim_hr_org_mng_org_tree_dd a2
on a1.org_id=a2.org_id
and a2.dt='20241231'
LEFT JOIN    edw.oadb_formtable_main_566_dt1 b --一二级信贷业务调查资质评定申请表(明细表1)
ON      a.id = b.mainid
AND     b.dt = '20241231'
LEFT JOIN    edw.oadb_hrmresource h2 --人力资源表
ON      b.xm = h2.id
AND     h2.dt = '20241231'
where   a.dt = '20241231'
and replace(a.sqrq,'-','') between '20240101' and '20241231'
and a1.org_id like '3302%'  --杭州分行
ORDER BY a.sqrgh,a.sqrq asc;
**01-数据需求_分行_2025_D0214_邵梦婷_不良成因分析_综合.sql
-- SJ20250213126
-- 支行不良业务成因分析




--临时表1 中征分 2024
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_2024 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_2024 AS
SELECT *
FROM (
SELECT  *,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cr_sco_val                                 AS 中证评分
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20241231'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_cr_grd_val                  AS 中证评分
                                ,prd_dt                          AS qry_tm
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20241231'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t
	) A1
WHERE A1.rk =1 ;

--2022he 2023的征信分用旧表查询
-- --临时表2 中征分 2023
-- DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_2023 PURGE;
-- CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_2023 AS
-- SELECT  *
-- FROM (
-- SELECT  *,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
-- FROM    (
--             SELECT  `(rk)?+.+`
--             FROM    (
--                         SELECT  cst_id
--                                 ,cr_sco_val                                 AS 中证评分
--                                 ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
--                                 ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
--                         FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
--                         WHERE   dt <= '20231231'
--                         AND     cr_sco_val IS NOT NULL
--                     ) t
--             WHERE   rk = 1
--             UNION ALL
--             SELECT  `(rk)?+.+`
--             FROM    (
--                         SELECT  cst_id
--                                 ,cst_cr_grd_val                  AS 中证评分
--                                 ,prd_dt                          AS qry_tm
--                                 ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
--                         FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
--                         WHERE   dt <= '20231231'
--                         AND     cst_cr_grd_val IS NOT NULL
--                     ) t
--             WHERE   rk = 1
--         ) t
-- 	) A1
-- WHERE A1.rk =1 ;

-- --临时表3 中征分 2022
-- DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_2022 PURGE;
-- CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_2022 AS
-- SELECT *
-- FROM (
-- SELECT  *,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
-- FROM    (
--             SELECT  `(rk)?+.+`
--             FROM    (
--                         SELECT  cst_id
--                                 ,cr_sco_val                                 AS 中证评分
--                                 ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
--                                 ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
--                         FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
--                         WHERE   dt <= '20221231'
--                         AND     cr_sco_val IS NOT NULL
--                     ) t
--             WHERE   rk = 1
--             UNION ALL
--             SELECT  `(rk)?+.+`
--             FROM    (
--                         SELECT  cst_id
--                                 ,cst_cr_grd_val                  AS 中证评分
--                                 ,prd_dt                          AS qry_tm
--                                 ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
--                         FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
--                         WHERE   dt <= '20221231'
--                         AND     cst_cr_grd_val IS NOT NULL
--                     ) t
--             WHERE   rk = 1
--         ) t
-- 	) A1
-- WHERE A1.rk =1 ;

--临时表4 配偶征信查询
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_04 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_04 AS
SELECT  T1.合同号
        ,T1.客户号
        ,T1.出险日期
        ,T1.合同类型
        ,T2.rel_serno
        ,T2.ctr_bgn_dt AS 合同起始日
        ,MAX(CASE
               WHEN T4.qry_dt >= TO_CHAR(DATEADD(TO_DATE(T2.ctr_bgn_dt, 'YYYYMMDD'), - 1, 'MM'), 'YYYYMMDD') AND T4.qry_dt <= T2.ctr_bgn_dt THEN '是'
               ELSE '否'
             END)      AS 是否查询配偶征信_发放前1个月
        ,MAX(CASE
               WHEN T4.qry_dt >= TO_CHAR(DATEADD(TO_DATE(T2.ctr_bgn_dt, 'YYYYMMDD'), - 6, 'MM'), 'YYYYMMDD') AND T4.qry_dt <= T2.ctr_bgn_dt THEN '是'
               ELSE '否'
             END)      AS 是否查询配偶征信_发放前6个月
FROM    (
            SELECT  A1.ctr_sero AS 合同号
			        ,A1.cst_id  AS 客户号
                    ,A1.dt_risk AS 出险日期
                    ,'风险业务' AS 合同类型
            FROM    tmp_sjxq_SJ20250213126_RISK A1
            UNION ALL
            SELECT  A1.ctr_sero AS 合同号
                    ,A1.cst_id   AS 客户号
                    ,'' 出险日期
                    ,'正常业务'      AS 合同类型
            FROM    tmp_sjxq_SJ20250213126_normal A1
            WHERE   PT <> ''
        ) T1
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2
ON      T1.合同号 = T2.ctr_serno
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_rel T3 --关系人信息
ON      T1.客户号 = T3.cst_id
AND     T3.rel_typ = '0301' --配偶
AND     T3.del_ind <> '1' --删除标识
AND     T3.vld_ind <> '0' --有效标识
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.qry_dt
                         ,A1.qry_cst_id
                         ,A1.qry_org
                         ,RANK() OVER ( PARTITION BY A1.qry_cst_id ORDER BY A1.rpt_id DESC ) AS RN
                 FROM    edw.dwd_cst_ccrc_ipcr_qry_rcd_di A1   --人行征信报告查询记录明细
                 WHERE   A1.DT <= '@@{yyyyMMdd}'
             ) T4
ON      T3.rel_cst_id = T4.qry_cst_id
AND     T4.qry_org = 'ZJTLCB' --查询机构为泰隆
AND     T4.RN = 1 --最新一次报告
GROUP BY T1.合同号 , T1.客户号 , T1.出险日期 , T1.合同类型 , T2.ctr_bgn_dt , T2.rel_serno;


--临时表5 发放时模型分
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_05 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_05 AS
SELECT  A1.客户号
        ,A1.模型分 AS 模型分_发放时
FROM    (
            SELECT  T1.客户号
                    ,T2.modl_grd                                                               AS 模型分
                    ,ROW_NUMBER() OVER ( PARTITION BY T1.客户号 ORDER BY T2.rsk_lyr_afm_tm DESC ) AS RN
            FROM    tmp_sjxq_BLYW_SJ20250213126_04 T1
            LEFT JOIN    edw.dim_cst_asst_rsk_lyr_dd T2 --风险分层信息
            ON      T1.客户号 = T2.cst_id
            AND     T1.合同起始日 = T2.DT
            AND     T2.DT IN (SELECT  DISTINCT 合同起始日 FROM tmp_sjxq_BLYW_SJ20250213126_04)
        ) A1
WHERE   A1.RN = 1;


--临时表6 资产负债率
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_06 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_06 AS
SELECT  T1.客户号
        ,T2.ast_lbl_rat AS 资产负债率_办理时
        ,T3.ast_lbl_rat AS 资产负债率_办理前一年
        ,CASE
           WHEN T2.ast_lbl_rat > T3.ast_lbl_rat THEN '上升'
           WHEN T2.ast_lbl_rat = T3.ast_lbl_rat THEN '持平'
           WHEN T2.ast_lbl_rat < T3.ast_lbl_rat THEN '下降'
         END 办理业务时资产负债率较上年
FROM    tmp_sjxq_BLYW_SJ20250213126_04 T1
LEFT JOIN    edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd T2 --信贷客户资产负债概况 办理时
ON      T1.客户号 = T2.cst_id
AND     T1.合同起始日 = T2.DT
AND     T2.DT IN (SELECT  DISTINCT 合同起始日 FROM   tmp_sjxq_BLYW_SJ20250213126_04)
LEFT JOIN    edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd T3 --信贷客户资产负债概况 上一年
ON      T1.客户号 = T3.cst_id
AND     TO_CHAR(DATEADD(TO_DATE(T1.合同起始日, 'YYYYMMDD'), - 1, 'YYYY'),'yyyymmdd') = T3.DT
AND     T3.DT IN (SELECT  DISTINCT TO_CHAR(DATEADD(TO_DATE(合同起始日, 'YYYYMMDD'), - 1, 'YYYY'),'yyyymmdd') FROM tmp_sjxq_BLYW_SJ20250213126_04);



--临时表7 业务办理后到出险前交接次数
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_07 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_07 AS
SELECT   T1.合同号
         ,T1.客户号
        ,COUNT(T2.aply_dt) AS 业务办理后到出险前交接次数
FROM  tmp_sjxq_BLYW_SJ20250213126_04 T1
LEFT JOIN edw.dwd_cst_mng_loan_mng_hdv_aply_dd T2  --信贷管户交接信息
ON T1.客户号 = T2.cst_id
AND T1.出险日期 >= T2.aply_dt
AND T1.合同起始日<= T2.aply_dt
AND T2.DT = '@@{yyyyMMdd}'
GROUP BY  T1.合同号 ,T1.客户号 ;


--临时表8 精准贷后次数 :精准贷后次数取办理业务后的次数
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_08 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_08 AS
SELECT   T1.合同号
         ,T1.客户号
         ,COUNT(T3.btch_serno) AS 精准贷后次数_办理后
FROM  tmp_sjxq_BLYW_SJ20250213126_04 T1
LEFT JOIN edw.dwd_bus_loan_psp_chk_btch_inf_dd T2  --贷后检查批次信息表
ON   T1.客户号 = T2.cst_id
AND  T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T3 --贷后检查任务信息
ON      T2.btch_serno = T3.btch_serno
AND     SUBSTR(REPLACE(REPLACE(T3.tsk_gen_dt,'-',''),'/',''),1,8)>=T1.合同起始日  --任务日期大于合同起始日
AND     T3.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
AND     T3.DT ='@@{yyyyMMdd}'
GROUP BY  T1.合同号,T1.客户号;


--临时表9 贷前非银机构信息
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_09 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_09 AS
SELECT T1.合同号
       ,T1.客户号
       ,COUNT(DISTINCT T1.dtrb_org ) AS 贷前非银机构家数
       ,SUM(T1.ctr_bal)               AS 贷前非银机构余额
FROM (
        -- 个人征信
        SELECT     A2.合同号
                  ,A2.客户号
                  ,A2.合同起始日
        		  ,A1.ctr_bal	  --余额
                  ,A1.dtrb_org	 --发放机构代码
        		  ,A1.dtrb_org_typ_cd	 --发放机构类型
                  ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
        FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
        INNER JOIN tmp_sjxq_BLYW_SJ20250213126_04 A2
        ON      A1.cst_id = A2.客户号
        AND     SUBSTR(A1.report_id,1,8 )<= A2.合同起始日
        WHERE   A1.DT =  '@@{yyyyMMdd}'
        UNION ALL
        --企业征信
        SELECT   A2.合同号
                  ,A2.客户号
                  ,A2.合同起始日
                  ,A1.loan_bal	 AS ctr_bal
                  ,A1.dtrb_org_cd	 AS  dtrb_org
                  ,A1.dtrb_org_typ_cd
                ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
        FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
        INNER JOIN tmp_sjxq_BLYW_SJ20250213126_04 A2
        ON      A1.cst_id = A2.客户号
        AND     SUBSTR(A1.report_id,1,8 )<= A2.合同起始日
        WHERE   A1.DT = '@@{yyyyMMdd}'
 )  T1
WHERE T1.RN = 1
AND   T1.dtrb_org_typ_cd not in  ( '11' , '12' , '14' , '15' )  --剔除银行
AND  T1.ctr_bal > 0
GROUP BY  T1.合同号,T1.客户号;



--临时表10 最终审批人
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_10 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_10 AS
SELECT  T1.*
FROM    (
            SELECT  A.客户号
                    ,A.合同号
                    ,B.user_name                                                                   AS 最终审批人
                    ,B.user_id                                                                     AS 最终审批人工号
                    ,ROW_NUMBER() OVER ( PARTITION BY A1.usc_aply_serno ORDER BY B.end_time DESC ) AS RN
            FROM    tmp_sjxq_BLYW_SJ20250213126_04 A
            LEFT JOIN    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案
            ON      A.rel_serno = A1.usc_aply_serno
            AND     A1.DT = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息
            ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
            AND     T.cst_id = A1.cst_id
            AND     T.DT = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表
            ON      t.ahn_ltr_aply_serno = a.biz_id
            AND     SUBSTR(t.sys_reg_psn_id, 1, 6) = SUBSTR(a.flow_starter, 1, 6) ---- 授信申请登记者 = 流程发起者   不然会有多条记录 存在工号-1的情况
            AND     a.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表
            ON      a.main_instance_id = b.instance_id
            AND     b.dt = '@@{yyyyMMdd}'
            WHERE   B.user_id <> 'system'
        ) T1
WHERE   T1.RN = 1;


--临时表11 贷款发放后我行逾期次数 (逾期借据数)
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_11 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_11 AS
SELECT  T1.客户号
        ,COUNT(DISTINCT T2.dbil_id) AS 贷款发放后我行逾期次数
FROM    tmp_sjxq_BLYW_SJ20250213126_04 T1
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd T2 --贷款借据信息汇总
ON      T1.客户号 = T2.cst_id
AND     ( T1.合同起始日 <= T2.ovd_dt OR T1.合同起始日 <= T2.ovd_intr_dt )
AND     T2.DT = '@@{yyyyMMdd}'
GROUP BY T1.客户号;


SELECT * FROM edw.dws_cst_ccrc_idv_ind_inf_dd T31  --个人征信指标信息表
WHERE cst_id=''
AND     T31.report_dsc_rn = 1
AND     T31.DT = '20231231'

--临时表汇总
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_12 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_12 AS
SELECT  T1.客户号
        ,T1.合同号
        ,T1.合同类型
        ,T3.中证评分  AS 2024年征信分
	,greatest(T31.idv_crd_sco_val, T31.idv_crd_sco_val2)  AS 2023年征信分
	,greatest(T32.idv_crd_sco_val, T32.idv_crd_sco_val2)  AS 2022年征信分
        ,T1.是否查询配偶征信_发放前1个月
        ,T1.是否查询配偶征信_发放前6个月
        ,T2.模型分_发放时
        ,T4.资产负债率_办理时
        ,T4.资产负债率_办理前一年
        ,T4.办理业务时资产负债率较上年
        ,T5.业务办理后到出险前交接次数
        ,T6.精准贷后次数_办理后
        ,T7.贷前非银机构家数
        ,T7.贷前非银机构余额
        ,T8.最终审批人
        ,T8.最终审批人工号
        ,T9.贷款发放后我行逾期次数
FROM    tmp_sjxq_BLYW_SJ20250213126_04 T1
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_05 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_2024 T3
ON      T1.客户号 = T3.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T31  --个人征信指标信息表
ON      T1.客户号 = T31.cst_id
AND     T31.report_dsc_rn = 1
AND     T31.DT = '20231231'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T32  --个人征信指标信息表
ON      T1.客户号 = T32.cst_id
AND     T32.report_dsc_rn = 1
AND     T32.DT = '20221231'
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_06 T4
ON      T1.客户号 = T4.客户号
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_07 T5
ON      T1.客户号 = T5.客户号
AND     T1.合同号 = T5.合同号
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_08 T6
ON      T1.客户号 = T6.客户号
AND     T1.合同号 = T6.合同号
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_09 T7
ON      T1.客户号 = T7.客户号
AND     T1.合同号 = T7.合同号
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_10 T8
ON      T1.客户号 = T8.客户号
AND     T1.合同号 = T8.合同号
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_11 T9
ON      T1.客户号 = T9.客户号;



---------------------------------------------------------------------
---------------------------------------------------------------------
--结果表1
-- 办理该笔业务是否无缝续贷	2024年征信分	2023年征信分	2022年征信分 借款人户籍地	是否社区内业务	办理该笔业务时年龄	担保人数量	共同还款人客户号
-- 办理该笔时是否查询了配偶征信	发放时预评估情况	发放时模型分	办理业务时资产负债率较上年（上升/下降）	业务办理后到出险前交接次数	精准贷后次数
-- 贷前非银机构家数	贷前非银机构余额	最终审批人

SELECT * FROM tmp_sjxq_BLYW_SJ20250213126_JGB1

DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_JGB1 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_JGB1 AS
SELECT DISTINCT  T1.cst_id                                              AS 客户号
                   ,T1.cst_nm                                             AS 客户名称
                   ,T6.MRG_SITU_CD                                        AS 婚姻状况代码
                   ,T12.cd_val_dscr                                       AS 婚姻状况
                   ,T1.ctr_sero                                           AS 合同号
                   ,T1.ctr_trc                                            AS 溯源合同号
                   ,T1.dt_risk                                            AS 出险日期
                   ,CASE
                      WHEN T2.smls_reloan_ind = '1' THEN '是'
                      ELSE '否'
                    END                                                   AS 办理该笔业务是否无缝续贷
                   ,T3.2024年征信分
                   ,T3.2023年征信分
                   ,T3.2022年征信分
                   ,CASE
                      WHEN T4.CST_TYP_CD = '1' AND SUBSTR(T4.DOC_NBR, 1, 4) = '3308' THEN '是' --证件号3308开头
                      WHEN T4.REG_ADR RLIKE '衢州'                                     THEN '是' --户籍_注册地址为衢州
                      ELSE '否'
                    END                                                   AS 是否衢州户籍
                   ,CASE
                      WHEN T5.com_order_id RLIKE T2.hdl_opr_id OR T5.com_vindicate_id RLIKE T2.hdl_opr_id THEN '是'
                      ELSE '否'
                    END                                                   AS 是否社区内业务 --子社区定人、主维护人为经办人
                   ,SUBSTR(T2.ctr_bgn_dt, 1, 4) - SUBSTR(T6.BTH_DT, 1, 4) AS 办理该笔业务时年龄
                   ,T7.担保人数量
                   ,T8.共同还款人客户号
                   ,T3.是否查询配偶征信_发放前1个月
                   ,T3.是否查询配偶征信_发放前6个月
                   ,T11.cd_val_dscr                                       AS 预评估情况_发放时
                   ,T3.模型分_发放时
                   ,T3.资产负债率_办理时
                   ,T3.资产负债率_办理前一年
                   ,T3.办理业务时资产负债率较上年
                   ,T3.业务办理后到出险前交接次数
                   ,T3.精准贷后次数_办理后
                   ,T3.贷前非银机构家数
                   ,T3.贷前非银机构余额
                   ,T3.最终审批人
                   ,T3.最终审批人工号
                   ,T3.贷款发放后我行逾期次数
FROM    tmp_sjxq_SJ20250213126_RISK T1 --风险业务
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2
ON      T1.ctr_sero = T2.ctr_serno
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_12 T3
ON      T1.cst_id = T3.客户号
AND     T1.ctr_sero = T3.合同号
AND     T3.合同类型 = '风险业务'
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_xw_community T5 --社区信息表
ON      T4.sub_cmnt_id = T5.com_code
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T6 --个人客户基本信息汇总表
ON      T1.cst_id = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.BUS_CTR_ID
                         ,COUNT(DISTINCT A1.WRNT_CST_ID) AS 担保人数量
                 FROM    edw.dws_bus_grnt_prsn_inf_dd A1 --担保人汇总信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.BUS_CTR_ID
             ) T7
ON      T1.ctr_sero = T7.BUS_CTR_ID
LEFT JOIN    (
                 SELECT  A1.ctr_serno
                         ,WM_CONCAT(DISTINCT '、', A1.cst_id) AS 共同还款人客户号
                 FROM    edw.dim_bus_loan_ctr_jnt_acptor_dd A1 --合同共同承诺人，edw.loan_ctr_jnt_acptor
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.sgn_ctr_obj_typ_cd IN ( '03' , '04' ) --共同还款承诺人/共同借款人
                 GROUP BY A1.ctr_serno
             ) T8
ON      T1.ctr_sero = T8.ctr_serno
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_rel_ases_dd T10 --授信关联预评估信息表
ON      T2.rel_serno = T10.usc_aply_serno
AND     T10.app_cst_rol_cd = '01' --客户角色：主借款人
AND     T10.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T11 -- 码值表
ON      T10.rul_set_rslt_cd = T11.cd_val
AND     T11.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     T11.fld_nm = 'RUL_SET_RSLT_CD'
AND     T11.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T12 -- 码值表
ON      T6.MRG_SITU_CD = T12.cd_val
AND     T12.tbl_nm = 'DWS_CST_IDV_BAS_INF_DD'
AND     T12.fld_nm = 'MRG_SITU_CD'
AND     T12.DT = '@@{yyyyMMdd}';




---------------------------------------------------------------------
---------------------------------------------------------------------
--结果表2
-- 办理该笔业务是否无缝续贷	2024年征信分	2023年征信分	2022年征信分	借款人户籍地	是否社区内业务	办理该笔业务时年龄	担保人数量	共同还款人客户号
-- 办理该笔时是否查询了配偶征信	发放时预评估情况	发放时模型分	办理业务时资产负债率较上年（上升/下降）	业务办理后到出险前交接次数	精准贷后次数
-- 贷前非银机构家数	贷前非银机构余额	最终审批人
DROP TABLE IF EXISTS tmp_sjxq_BLYW_SJ20250213126_JGB2 PURGE;
CREATE TABLE IF NOT EXISTS tmp_sjxq_BLYW_SJ20250213126_JGB2 AS
SELECT DISTINCT  T1.cst_id                                              AS 客户号
                 ,T1.cst_nm                                             AS 客户名称
                 ,T6.MRG_SITU_CD                                        AS 婚姻状况代码
                 ,T12.cd_val_dscr                                       AS 婚姻状况
                 ,T1.ctr_sero                                           AS 合同号
                 ,T1.pd                                                 AS 产品名称
                 ,CASE
                    WHEN T2.smls_reloan_ind = '1' THEN '是'
                    ELSE '否'
                  END                                                   AS 办理该笔业务是否无缝续贷
                 ,T3.2024年征信分
                 ,T3.2023年征信分
                 ,T3.2022年征信分
                 ,CASE
                    WHEN T4.CST_TYP_CD = '1' AND SUBSTR(T4.DOC_NBR, 1, 4) = '3308' THEN '是' --证件号3308开头
                    WHEN T4.REG_ADR RLIKE '衢州'                                     THEN '是' --户籍_注册地址为衢州
                    ELSE '否'
                  END                                                   AS 是否衢州户籍
                 ,CASE
                    WHEN T5.com_order_id RLIKE T2.hdl_opr_id OR T5.com_vindicate_id RLIKE T2.hdl_opr_id THEN '是'
                    ELSE '否'
                  END                                                   AS 是否社区内业务 --子社区定人、主维护人为经办人
                 ,SUBSTR(T2.ctr_bgn_dt, 1, 4) - SUBSTR(T6.BTH_DT, 1, 4) AS 办理该笔业务时年龄
                 ,T7.担保人数量
                 ,T8.共同还款人客户号
                 ,T3.是否查询配偶征信_发放前1个月
                 ,T3.是否查询配偶征信_发放前6个月
                 ,T11.cd_val_dscr                                       AS 预评估情况_发放时
                 ,T3.模型分_发放时
                 ,T3.资产负债率_办理时
                 ,T3.资产负债率_办理前一年
                 ,T3.办理业务时资产负债率较上年
                 ,T3.业务办理后到出险前交接次数
                 ,T3.精准贷后次数_办理后
                 ,T3.贷前非银机构家数
                 ,T3.贷前非银机构余额
                 ,T3.最终审批人
                 ,T3.最终审批人工号
                 ,T3.贷款发放后我行逾期次数
FROM    tmp_sjxq_SJ20250213126_normal T1 --正常业务
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2
ON      T1.ctr_sero = T2.ctr_serno
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    tmp_sjxq_BLYW_SJ20250213126_12 T3
ON      T1.cst_id = T3.客户号
AND     T1.ctr_sero = T3.合同号
AND     T3.合同类型 = '正常业务'
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_xw_community T5 --社区信息表
ON      T4.sub_cmnt_id = T5.com_code
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T6 --个人客户基本信息汇总表
ON      T1.cst_id = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.BUS_CTR_ID
                         ,COUNT(DISTINCT A1.WRNT_CST_ID) AS 担保人数量
                 FROM    edw.dws_bus_grnt_prsn_inf_dd A1 --担保人汇总信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.BUS_CTR_ID
             ) T7
ON      T1.ctr_sero = T7.BUS_CTR_ID
LEFT JOIN    (
                 SELECT  A1.ctr_serno
                         ,WM_CONCAT(DISTINCT '、', A1.cst_id) AS 共同还款人客户号
                 FROM    edw.dim_bus_loan_ctr_jnt_acptor_dd A1 --合同共同承诺人， edw.loan_ctr_jnt_acptor --此表数据多
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.sgn_ctr_obj_typ_cd IN ( '03' , '04' ) --共同还款承诺人/共同借款人
                 GROUP BY A1.ctr_serno
             ) T8
ON      T1.ctr_sero = T8.ctr_serno
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_rel_ases_dd T10 --授信关联预评估信息表
ON      T2.rel_serno = T10.usc_aply_serno
AND     T10.app_cst_rol_cd = '01' --客户角色：主借款人
AND     T10.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T11 -- 码值表
ON      T10.rul_set_rslt_cd = T11.cd_val
AND     T11.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
AND     T11.fld_nm = 'RUL_SET_RSLT_CD'
AND     T11.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T12 -- 码值表
ON      T6.MRG_SITU_CD = T12.cd_val
AND     T12.tbl_nm = 'DWS_CST_IDV_BAS_INF_DD'
AND     T12.fld_nm = 'MRG_SITU_CD'
AND     T12.DT = '@@{yyyyMMdd}'
WHERE   T1.PT <> '';
**01-数据需求_分行_2025_D0218_杭州分行_陈敏珠_重组客户质量分析.sql
SELECT * FROM  edw.loan_lmt_biz_pln_bil_rel_inf WHERE dt= '20250217' and pln_no='RTB20240925000011199';


;
SELECT * FROM edw.zcbq_plan_apply_relative WHERE dt= '20250217' and plan_no='RTB20241221000016517';
**01-数据需求_分行_2025_D0220_嘉兴分行_赵珺_新发随贷通卡的相关数据.sql
--SJ2025022086
-- 嘉兴分行自2025年1月1日（含）起新发随贷通卡的相关数据。
-- 会计日期	客户账号	合同编号	信贷产品编号	卡产品编号	客户号	客户名称	首次授信生效日期	授信额度	启用额度	额度状态代码	合同加权利率	分段计息标识	低段贷款利率
-- 本金余额	本金余额月累计	近90天本金余额积数(含核销)	近180天本金余额积数(含核销)	信贷管户机构编号	信贷管户机构名称	信贷管户员工编号	信贷管户员工名称	经办机构编号	经办机构名称
-- 经办员工编号	经办员工名称

--随贷通客户清单
DROP  TABLE if EXISTS tmp_sjxq_SJ2025022086_01 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025022086_01 as
SELECT  t1.acg_dt 会计日期
        ,t1.cst_ac_id 客户账号
        ,t1.ln_lmt_ctr_id 合同编号
        ,t1.ln_pd_cd 信贷产品编号
        ,t1.ln_pd_nm 信贷产品名称
        ,t1.crd_pd_cd 卡产品编号
        ,t1.cst_id 客户号
        ,t1.cst_nm 客户名称
        ,t1.lmt_fst_vld_dt 首次授信生效日期
        ,t1.hgh_cr_lmt_amt 授信额度
        ,t1.cr_lmt_amt 启用额度
        ,t1.lmt_sts_cd 额度状态代码
        ,t1.lmt_sts_nm 额度状态码值
        ,t1.wt_exe_intr_rat 合同加权利率
        ,decode(t1.seg_intr_rat_ind,'1','是','0','否'） 分段计息标识
        ,t1.low_exe_mon_intr_rat 低段贷款利率
        ,t1.bal 本金余额
        ,t1.mth_acml_bal 本金余额月累计
        ,t1.late_thr_mth_acml_amt 近90天本金余额积数_含核销
        ,t1.late_six_mth_acml_amt 近180天本金余额积数_含核销
        ,t1.mng_org_id 信贷管户机构编号
        ,t1.mng_org_nm 信贷管户机构名称
        ,t1.mng_mgr_id 信贷管户员工编号
        ,t1.mng_mgr_nm 信贷管户员工名称
        ,t2.hdl_org_id 经办机构编号
        ,t3.org_nm 经办机构名称
        ,t2.hdl_opr_id 经办人工号
        ,t4.empe_nm  经办人名称
FROM    app_ado.fct_fnc_svc_db_crd_ar_smy_dd t1 --随贷通账务信息表
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd t2 --合同基础信息
ON      t1.ln_lmt_ctr_id = t2.ctr_serno
AND     t2.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd t3
on t2.hdl_org_id=t3.org_id
and t3.dt='@@{yyyyMMdd}'
left join edw.dim_hr_empe_bas_inf_dd t4
on t2.hdl_opr_id=t4.empe_id
and t4.dt='@@{yyyyMMdd}'
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     substr(t1.eft_dt, 1, 4) = '2025'
AND     t1.brn_org_id LIKE '3309%'    --嘉兴分行
;


--征信分
DROP  TABLE if EXISTS tmp_sjxq_SJ2025022086_02 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025022086_02 as
SELECT  cst_id          AS 客户号
        ,prd_dt         AS 查询日期
        ,cst_cr_grd_val AS 最新征信分
        ,scor_rng       AS 最新征信分数段
        -- ,coalesce(scor_rng,cst_cr_grd_val) AS 最新征信分或分数段1
        ,CASE
           WHEN scor_rng IS NULL OR scor_rng = '' THEN cst_cr_grd_val
           ELSE scor_rng
         END            AS 最新征信分或分数段
        ,sc_src         AS 征信分来源表
FROM    (
            SELECT  cst_id
                    ,prd_dt
                    ,cst_cr_grd_val
                    ,scor_rng
                    ,sc_src
                    ,row_number() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) rn
            FROM    (
                        SELECT  cst_id
                                ,REPLACE(substr(qry_tm, 1, 10), '-', '') AS prd_dt
                                ,cr_sco_val                              AS cst_cr_grd_val
                                ,''                                      AS scor_rng
                                ,'中征分' sc_src
                        FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     nvl(cr_sco_val, '') <> ''
                        UNION
                        SELECT  cst_id
                                ,prd_dt
                                ,cst_cr_grd_val
                                ,'' AS scor_rng
                                ,'中征分' sc_src
                        FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     nvl(cst_cr_grd_val, '') <> ''
                        UNION
                        SELECT  cst_id
                                ,REPLACE(substr(report_dt, 1, 10), '-', '')
                                ,idv_crd_sco_val
                                ,scor_rng
                                ,'指标表' sc_src
                        FROM    edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表
                        WHERE   dt = '@@{yyyyMMdd}'
                        AND     nvl(idv_crd_sco_val, '') <> ''
                        UNION
                        SELECT  cst_id
                                ,SUBSTR(report_id, 1, 8)
                                ,CAST(digital_unscr AS INT)
                                ,'' AS scor_rng
                                ,'集市表' sc_src
                        FROM    adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     nvl(digital_unscr, '') <> ''
                    ) t
        ) t
WHERE   rn = 1;


--590笔数据
--结果表
---- 客户随贷通首次授信生效日期	同一风险控制号	同一风险控制号下随贷通首次授信生效日期	客户出生日期（公历）	征信报告日期	征信分
DROP TABLE IF EXISTS tmp_sjxq_SJ2025022086_ff PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025022086_ff AS
SELECT  DISTINCT t1 . *
                 ,t2.fnc_frs_lmt_dt 客户随贷通首次授信生效日期
                 ,t3.sam_rsk_ctrl_id 同一风险控制号
                 -- ,t21.fnc_frs_lmt_dt 同一风险控制号下随贷通首次授信生效日期
                 ,CASE
                    WHEN t21.fnc_frs_lmt_dt = '' OR t21.fnc_frs_lmt_dt IS NULL THEN '1899-12-31'
                    ELSE t21.fnc_frs_lmt_dt
                  END                      AS 同一风险控制号下随贷通首次授信生效日期
                 ,substr(t3.doc_nbr, 7, 8) AS 客户出生日期_公历
                 ,t4.查询日期                  AS 最新征信报告日期
                 ,t4.最新征信分或分数段             AS 最新征信分或分数段
FROM    tmp_sjxq_SJ2025022086_01 t1
-- left join app_ado.adm_subl_cst_bus_inf_dd  t2  --实验室应用层资产-客户业务信息汇总表，客户视图2.0,对公客户随贷通首次生效日期为空,用对私客户视图，对私有为N
LEFT JOIN    app_ado.adm_subl_cst_idv_inf_dd t2 --对私客户视图
ON      t1.客户号 = t2.cst_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd t3
ON      t1.客户号 = t3.cst_id
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd t31
ON      t3.sam_rsk_ctrl_id = t31.sam_rsk_ctrl_id
AND     t31.dt = '@@{yyyyMMdd}'
AND     COALESCE(t31.sam_rsk_ctrl_id, '') <> ''
AND     COALESCE(t3.sam_rsk_ctrl_id, '') <> ''
LEFT JOIN    app_ado.adm_subl_cst_idv_inf_dd t21 --对私客户视图
ON      t31.cst_id = t21.cst_id
AND     t21.dt = '@@{yyyyMMdd}'
LEFT JOIN    tmp_sjxq_SJ2025022086_02 t4
ON      t1.客户号 = t4.客户号;
**01-数据需求_分行_2025_D0220_湖州分行_佟忻茹_分行考核计量统计清单2024.sql
-- SJ2025021996，查询客户的信用卡FTP营收及中收的明细情况
-- 需要自助取数平台里&ldquo;分行考核计量统计清单&rdquo;2024全年数据，该清单目前无法自助取数2024年的数据，分行需要知晓客户在2024年产生的信用卡FTP营收及中收数据

-- 数据日期，统计周期，账户号，账户累计FTP营收，账户累计信用卡FTP利息收入，账户累计信用卡FTP资金成本，账户累计中间业务营收，账户累计信用卡手续费收入，账户累计信用卡手续费支出，账户累计总收入



--64830
drop table if EXISTS tmp_sjxq_SJ2025021996 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025021996 as
SELECT T2.acg_dt 数据日期
       ,T2.stat_cyc 统计周期
       ,T2.cr_crd_act_id 账户号
       ,T2.ftp_coll 账户累计FTP营收
       ,T2.cr_crd_ftp_intr_inc 账户累计信用卡FTP利息收入
       ,T2.cr_crd_cpt_cost 账户累计信用卡FTP资金成本
       ,T2.mid_bsn_coll 账户累计中间业务营收
       ,T2.cr_crd_cmsn_fee_inc 账户累计信用卡手续费收入
       ,T2.cr_crd_cmsn_fee_xps 账户累计信用卡手续费支出
       ,T2.tot_inc 账户累计总收入
       ,T1.cst_id 客户号
       ,T1.cst_nm 客户姓名
       ,T1.mgr_org_nm 管护机构名称
       ,T1.mgr_id 管护人工号
       ,T1.mgr_nm 管护人姓名
FROM app_ado.fct_brch_asmt_crd_act_act_ftr_dd T1 --分行考核卡账户特征表
left join app_ado.fct_brch_asmt_clc_rwd_cr_crd_act_inc_xps_dd T2 --分行考核计奖贷记卡账户收支明细表
on T1.cr_crd_act_id=T2.cr_crd_act_id
and T2.dt='20241231'
WHERE T1.dt='20241231'
and T1.mgr_org_id like '3310%'   --湖州分行
**01-数据需求_分行_2025_D0224_台州分行_陈超_供应链客户项目下全量客户相关信贷与产效数据_.sql
--
-- 转徐婷处理
--SJ2025022496

--截至2025年2月23日，台州分行供应链项目（小鱼管家平台管理系统中，平台类型为&ldquo;企业类（供应链）&rdquo;的平台）情况及项目下全量客户相关信贷与产效数据。


--【项目维度】会计日期、核心企业管户分行、核心企业管户支行、核心企业管户团队、平台名称、是否当年新增有效项目、当年度供应链新客数、核心企业客户编号、核心企业名称、核心企业管户客户经理工号、核心企业管户客户经理；

--【客户维度】客户号、客户名称、客户主管户支行、客户主管户机构、客户主管户客户经理工号、客户主管户客户经理姓名、行业类型、是否当年度供应链新客、是否累计供应链新客、用信规模（客户级）、贷款月日均（客户级）、
--贷款余额（客户级）、贷款余额净增较年初（客户级）、承兑敞口月日均（客户级）、承兑敞口余额（客户级）、国内信用证月日均（客户级）、国内信用证余额（客户级）、存款月日均（客户级）、存款余额（客户级）、
--保证金余额（客户级）、当年ftp产效（客户级）、客户近12个月客户价值（EVA）

--【业务维度】产品品种、合同流水号、贷款合同起始日、贷款合同到期日、合同金额、合同余额、执行月利率、发生类型、主要担保方式

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_1 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_1 AS
select t1.会计日期
      ,t1.id
      ,t1.plat_id
      ,t1.群组名称
      ,t1.群组创建时间
      ,t1.群组创建用户
      ,t1.创建人机构号
      ,t1.核心企业客户编号
      ,p2.cst_chn_nm as 核心企业名称
      ,max(case when coalesce(t1.核心企业客户编号,'') <> '' and coalesce(t1.核心企业客户编号,'') = coalesce(t2.cust_id,'') then '1' else '0' end ) as 核心企业是否群组内客户
from (
        select dt AS 会计日期
              ,plat_no as id   --平台编号
              ,plat_id
              ,plat_nm as 群组名称
              ,create_time as 群组创建时间
              ,create_employ_id as 群组创建用户
              ,plat_create_org as 创建人机构号
              ,plat_cust_id as 核心企业客户编号
              ,plat_group
              ,plat_type  --平台类型
        from edw.XWDT_XW_PLAT  --平台渠道表,最早创建时间是2012
        where dt = '@@{yyyyMMdd}'
         and plat_status = '3'  --0-已删除 1-草稿 2-待审批 3-审批通过 4-审批不通过
         and plat_type = 'B2'    --限制供应链客群
         and replace(substr(create_time,1,10),'-','') >= '20240101'  --限制创建时间2024年及之后
) t1
left join edw.dws_cst_bas_inf_dd p2 on t1.核心企业客户编号 = p2.cst_id and p2.dt = '@@{yyyyMMdd}'
left join edw.XWDT_XW_PLAT_CUSTOMER t2 on t1.plat_id = t2.plat_id and t2.dt = '@@{yyyyMMdd}' and t2.cust_status = '02'  --&quot;02&quot;:&quot;新增(审批通过)&quot;
group by t1.会计日期
      ,t1.id
      ,t1.plat_id
      ,t1.群组名称
      ,t1.群组创建时间
      ,t1.群组创建用户
      ,t1.创建人机构号
      ,t1.核心企业客户编号
      ,p2.cst_chn_nm
;



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_2 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_2 AS
select t1.会计日期
      ,t1.id
      ,t1.群组名称
      ,t1.群组创建时间
      ,t1.群组创建用户
      ,t1.创建人机构号
      ,t1.核心企业客户编号
      ,t1.核心企业名称
      ,t1.核心企业是否群组内客户
      -- ,t1.plat_type
      -- ,t1.平台类型
      -- ,t1.plat_group
      ,t2.cust_id as cst_id
      ,t2.create_time as 创建时间         --客户创建时间
      ,t2.create_employ_id as 创建人工号  --客户创建人工号
from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_1 t1
left join edw.XWDT_XW_PLAT_CUSTOMER  t2 on t1.plat_id = t2.plat_id and t2.dt = '@@{yyyyMMdd}' and t2.cust_status = '02'  --&quot;02&quot;:&quot;新增(审批通过)&quot;
where t2.cust_id is not null or (核心企业客户编号 is not null and 核心企业是否群组内客户 = '1')

union
	--核心企业不在群组内
select distinct 会计日期
        ,ID
        ,群组名称
        ,群组创建时间
        ,群组创建用户
        ,创建人机构号
        ,核心企业客户编号
        ,核心企业名称
        ,核心企业是否群组内客户
      --   ,plat_type
      --   ,平台类型
      --   ,plat_group
        ,核心企业客户编号 as cst_id  --客户ID
        ,群组创建时间 as 创建时间
        ,群组创建用户 as 创建人工号
FROM    lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_1
WHERE   核心企业是否群组内客户 = '0'
AND     核心企业客户编号 IS NOT NULL
;





drop table if exists lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1 purge ;   --供应链产效监测BI看板中间表01表
create table lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1
as
select ID
      ,t1.群组名称
      ,t1.群组创建时间
      ,t1.群组创建用户
      ,t1.创建人机构号
      ,t1.cst_id  --客户ID
      ,t1.创建时间
      ,t1.创建人工号
      ,t1.核心企业客户编号
      ,t1.核心企业名称
      ,t1.核心企业是否群组内客户
      ,t3.cst_chn_nm as 客户名称
      ,t3.cst_typ_cd as 客户类型
      ,case when t1.cst_id=t1.核心企业客户编号 then '1' else '0' end as 是否核心企业
    --   ,case when t6.核心企业名称 is not null then '1' else '0' end as 是否清单内核心企业
      ,case when t7.平台号 is not null then '存量项目' else '新增项目' end as 初始或新增项目
      ,COALESCE(t4.forml_cst_ind,'0')  as 正式客户标识
      ,COALESCE(t4.vld_cst_ind,'0')  as 有效户标识
      ,COALESCE(t4.vld_dep_cst_ind,'0')  as 有效存款户标识
      ,COALESCE(t4.vld_ln_cst_ind,'0')  as 有效信贷户标识
      ,COALESCE(t4.vld_chm_cst_ind,'0')  as 有效理财户标识
      ,COALESCE(t4.corp_efe_inter_stl_cst_ind,'0')  as 国际业务有效户
      ,COALESCE(t4.efe_wlth_cst_ind,'0')  as 有效财富户标识
      -- ,t4.cst_val_lvl as 客户价值分类
      -- ,t4.cst_val_type  as 客户价值等级
      ,case when t4.cst_val_lvl is not null and t4.cst_val_lvl <> '' then t4.cst_val_lvl
            when t41.cst_val_lvl = '1' then '价值关注客户'
            when t41.cst_val_lvl = '2' then '零价值客户'
            when t41.cst_val_lvl = '3' then '正价值客户'
            when t41.cst_val_lvl = '0' then '不符合价值判断'
            else t41.cst_val_lvl
        end as 客户价值分类
      ,case when t4.cst_val_type is not null and t4.cst_val_type <> '' then t4.cst_val_type
            else concat('V',t41.cst_val_type)
       end as 客户价值等级
      ,COALESCE(t51.is_pay_stl_rch_the_mrk_cst,'0') as 是否支付结算达标
      ,COALESCE(t51.is_opr_lvrg_rch_the_mrk_cst,'0') as 是否经营性融资达标
      ,COALESCE(t51.is_dep_bus_rch_the_mrk_cst,'0') as 是否存款业务达标
      ,COALESCE(t51.is_agn_rch_the_mrk_cst,'0') as 是否代发服务达标
      ,COALESCE(t51.is_chm_agn_rch_the_mrk_cst,'0') as 是否理财or代销达标
      ,COALESCE(t51.is_csm_loan_rch_the_mrk_cst,'0') as 是否消费贷款达标
      ,COALESCE(t51.qty_opr_rte_all,0) as 全路径达成个数
from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1_2 t1
left join edw.dws_cst_bas_inf_dd t3 on t1.cst_id = t3.cst_id and t3.dt = '@@{yyyyMMdd}'
left join app_ado.adm_subl_cst_bus_inf_dd t4 on t1.cst_id = t4.cst_id and t4.dt = '@@{yyyyMMdd}'
left join (select distinct cst_id,cst_val_type,cst_val_lvl from app_ado.adm_subl_cst_bus_inf_dd_khjz where dt = '@@{yyyyMMdd}'  and stat_dim ='近一年' ) t41 on t41.cst_id = t1.cst_id   --20240821修改 价值等级变更 t4表中20240806之后数据已置空
left join app_rpt.FCT_OPR_RTE_ALL_CST_DD t51 on t1.cst_id = t51.cst_id and t51.dt = '@@{yyyyMMdd}' --综合经营全路径清单   --22个客户中有一个关联不上
-- left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_cor_lst t6 on t1.核心企业名称 = t6.核心企业名称  --线下下发的营销清单   --应该使用t1.核心企业名称关联
left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_2023prj t7 on t1.ID = t7.平台号
;





------------------------------------------------------- 20240221修改 该项目下的该客户号是否计算产效 ---------------------------------------------------------------
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre2 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre2 AS
SELECT  T1.*
        ,COALESCE(T3.sbr_org_id,'') AS 创建人支行
        ,COALESCE(T3.brc_org_id,'') AS 创建人分行
        ,COALESCE(T4.prm_org_id,'') AS 客户主管户机构号
        ,COALESCE(T5.sbr_org_id,'') AS 客户主管户支行
        ,COALESCE(T5.brc_org_id,'') AS 客户主管户分行
FROM    lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1 T1
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T1.创建人机构号 = T3.org_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T4 --客户主管户信息
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T4.prm_org_id = T5.org_id
AND     T5.DT = '@@{yyyyMMdd}'
;



------ 20240228 添加主维护支行团队客户经理
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre3 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre3 AS
select distinct t1.id
      ,t1.群组名称
      ,t1.cst_id   --核心企业客户号
      ,t2.prm_mgr_id as 主维护客户经理   --即核心企业的主管户客户经理
      ,t2.prm_org_id as 主维护机构号  --即核心企业的主管户机构号
      ,t3.brc_org_id as 主维护分行机构号
      ,t3.brc_org_nm as 主维护分行名称
      ,t3.sbr_org_id as 主维护支行机构号
      ,t3.sbr_org_nm as 主维护支行名称
      ,t3.tem_org_id as 主维护团队机构号
      ,t3.tem_org_nm as 主维护团队名称
from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre1 t1
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t2 on t1.cst_id = t2.cst_id and t2.dt = '@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd t3 on t2.prm_org_id = t3.org_id and t3.dt = '@@{yyyyMMdd}'
where 是否核心企业 = '1'
;



------------ 根据业务提供的逻辑判断该项目下的该客户是否计算产效
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01 PURGE;
CREATE TABLE lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01 AS
SELECT  B1 . *
       ,CASE WHEN B2.cst_id IS NOT NULL THEN '1' ELSE '0' END AS 是否计算产效
       ,b3.主维护客户经理   --即核心企业的主管户客户经理
       ,b3.主维护机构号  --即核心企业的主管户机构号
       ,b3.主维护分行机构号
       ,b3.主维护分行名称
       ,b3.主维护支行机构号
       ,b3.主维护支行名称
       ,b3.主维护团队机构号
       ,b3.主维护团队名称
FROM    lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre2 B1
LEFT    JOIN (
SELECT  A1.ID
        ,A1.群组名称
        ,A1.群组创建时间
        ,A1.cst_id
        ,A1.优先级
        ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.优先级 , A1.群组创建时间 ) AS RN --排序，取优先级最前和项目时间最早的数据
FROM    (
            -----创建支行和主管户支行相同 优先级为1
            SELECT  T1.群组名称
                   ,t1.id
                    ,T1.群组创建时间
                    ,T1.cst_id
                    ,'1' AS 优先级
            FROM    lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre2 T1
            WHERE   创建人支行 = 客户主管户支行
            AND     创建人支行 <> ''
            -----创建分行和主管户分行相同 优先级为2
            UNION ALL
            SELECT  T1.群组名称
                   ,t1.id
                    ,T1.群组创建时间
                    ,T1.cst_id
                    ,'2' AS 优先级
            FROM    lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre2 T1
            WHERE   创建人分行 = 客户主管户分行
            AND     (创建人支行 <> 客户主管户支行 OR 创建人支行 = '')
            UNION ALL
            ------其它情况 优先级为3
            SELECT  T1.群组名称
                   ,t1.id
                    ,T1.群组创建时间
                    ,T1.cst_id
                    ,'3' AS 优先级
            FROM    lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre2 T1
            WHERE   创建人分行 <> 客户主管户分行
        ) A1
 ) B2
ON  B1.ID = B2.ID
and B1.群组名称=B2.群组名称
AND B1.cst_id=B2.cst_id
and b1.群组创建时间 = b2.群组创建时间
AND B2.RN=1
left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01_pre3 b3 on b1.id = b3.id
;





------------------------------------------------------------------------------ 供应链新客 --------------------------------------------------------------------------
drop table if exists lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_1 purge ;   --供应链新客部分
create table lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_1
as
select  t.id
      ,t.群组名称
      ,t.群组创建时间
      ,t.主维护客户经理
      ,t.主维护机构号
      ,t.主维护分行机构号
      ,t.主维护分行名称
      ,t.主维护支行机构号
      ,t.主维护支行名称
      ,t.主维护团队机构号
      ,t.主维护团队名称
      ,t.cst_id
      ,max(当年度供应链新客) as 当年度供应链新客
      ,max(累计供应链新客) as 累计供应链新客
      ,sum(合同余额) as 合同余额
      -- ,sum(余额月日均) as 余额月日均
from (
      select t0.id
            ,t0.群组名称
            ,t0.群组创建时间
            ,t0.主维护客户经理
            ,t0.主维护机构号
            ,t0.主维护分行机构号
            ,t0.主维护分行名称
            ,t0.主维护支行机构号
            ,t0.主维护支行名称
            ,t0.主维护团队机构号
            ,t0.主维护团队名称
            ,t0.cst_id
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then t1.ctr_serno end as 合同编号
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then t1.hpn_typ_cd end as 发生类型代码  --010首笔
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then t1.ctr_eff_dt end as 合同生效日期
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then  t1.ctr_amt*exr.avg_prc/exr.quo_unt end as 合同金额
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then  t1.ctr_epsr_amt*exr.avg_prc/exr.quo_unt end as 敞口金额
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then (t1.ctr_bal-coalesce(t2.MRGN_AMT,0))*exr.avg_prc/exr.quo_unt end as 合同余额   -- 合同余额-保证金

            -- ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then t2.本金余额 else 0 end 本金余额
            -- ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') then t2.余额月日均 else 0 end 余额月日均
            ------ 当年度供应链新客
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') and t1.ctr_eff_dt >= concat(substr(t1.dt,1,4),'0101') and t1.hpn_typ_cd = '010' then '1' else '0' end as 当年度供应链新客
            ------ 累计供应链新客
            ,case when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') and t0.群组名称 like '%2023' and t1.ctr_eff_dt >= '20230101' and t1.hpn_typ_cd = '010' then '1'  --2023年存量项目起点为20230101
                  when (substr(t1.prd_no,1,4) in ('1001','2001','1003') or substr(t1.prd_no,1,6) = '100201' or substr(t1.prd_no,1,8)='10030301') and t0.群组名称 not like '%2023' and t1.ctr_eff_dt >= concat(substr(t0.群组创建时间,1,4),'0101') and t1.hpn_typ_cd = '010' then '1'  --2024及之后的项目起点为项目创建当年度1月1号
                  else '0' end as 累计供应链新客
      from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01 t0
      left join edw.dim_bus_loan_ctr_bse_inf_dd t1 on t0.cst_id = t1.cst_id and t1.dt = '@@{yyyyMMdd}' and substr(t1.prd_no,1,6) <> '200101' and t1.prd_no not in ('2001010101002','2001010101003','2002010101001') and t1.prd_no <> ''   --剔除个人消费性贷款/泰e贷消费/随贷通消费/信用卡/资产池
      left join edw.dim_bus_com_exr_inf_dd exr on t1.bsn_ccy_cd = exr.ccy_cd and exr.dt = '@@{yyyyMMdd}'
      left join APP_ADO.FCT_ACC_BAL_LST t2 on t1.ctr_serno = t2.BUS_CTR_ID and t2.dt = t1.dt
      -- left join (
      --       select bus_ctr_id
      --             ,sum(prcp_bal*exr.avg_prc/exr.quo_unt) as 本金余额
      --             ,sum(mon_acm_prcp_bal_acml*exr.avg_prc/exr.quo_unt)/substr(a.dt,7,2) as 余额月日均
      --       from edw.dws_bus_loan_dbil_inf_dd a
      --       left join edw.dim_bus_com_exr_inf_dd exr on exr.ccy_cd = a.ccy_cd and exr.dt = a.dt
      --       where a.dt = '@@{yyyyMMdd}'
      --       group by bus_ctr_id,a.dt
      -- ) t2 on t1.ctr_serno = t2.bus_ctr_id
      where 是否计算产效 = '1'
) t
group by t.id
        ,t.群组名称
        ,t.群组创建时间
        ,t.主维护客户经理
        ,t.主维护机构号
        ,t.主维护分行机构号
        ,t.主维护分行名称
        ,t.主维护支行机构号
        ,t.主维护支行名称
        ,t.主维护团队机构号
        ,t.主维护团队名称
        ,t.cst_id
;





-- alter table lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_2 drop if exists partition (dt = '@@{yyyyMMdd}');
-- insert into lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_2  partition (dt = '@@{yyyyMMdd}')
-- select
--       主维护分行机构号
--       ,主维护分行名称
--       ,主维护支行机构号
--       ,主维护支行名称
--       ,主维护团队机构号
--       ,主维护团队名称
--       ,主维护机构号
--       -- ,count(distinct id) as 项目总数   ----20241129 xt 迁到平台之后 项目名称重复  与陈梦霞沟通按照项目名称去重统计
--       -- ,count(distinct case when 是否本年度有效项目 = '1' then id end) as 当年新增有效项目数

--       ,count(distinct 群组名称) as 项目总数
--       ,count(distinct case when 是否本年度有效项目 = '1' then 群组名称 end) as 当年新增有效项目数

--       ,count(distinct case when (有效户标识_上年末 is null or 有效户标识_上年末 = '0') then cst_id end) as 当年新增有效户数

--       ,count(distinct case when 当年度供应链新客 = '1' then cst_id end) as 当年度供应链新客数
--       ,sum(case when 当年度供应链新客 = '1' then 合同余额 else 0 end) as 当年度新客用信规模
--       -- ,sum(case when 当年度供应链新客 = '1' then 余额月日均 else 0 end) as 当年度新客用信规模月日均

--       ,count(distinct case when 累计供应链新客 = '1' then cst_id end) as 累计供应链新客数
--       ,sum(case when 累计供应链新客 = '1' then 合同余额 else 0 end) as 累计新客用信规模
--       -- ,sum(case when 累计供应链新客 = '1' then 余额月日均 else 0 end) as 累计新客用信规模月日均
-- from (
-- select t1.id
--       ,t1.群组名称
--       ,t1.群组创建时间
--       ,t1.主维护客户经理
--       ,t1.主维护机构号
--       ,t1.主维护分行机构号
--       ,t1.主维护分行名称
--       ,t1.主维护支行机构号
--       ,t1.主维护支行名称
--       ,t1.主维护团队机构号
--       ,t1.主维护团队名称
--       ,t4.项目是否有效   --累计有效项目
--       ,t4.是否本年度有效项目
--       ,t1.cst_id
--       ,t1.当年度供应链新客
--       ,t1.累计供应链新客
--       ,t1.合同余额
--       -- ,t1.余额月日均
--       ,t2.efe_cst_ind as 有效户标识_cur
--       ,t3.efe_cst_ind as 有效户标识_上年末
-- from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_1 t1
-- left join adm_pub.adm_csm_cbas_ind_inf_dd t2 on t1.cst_id = t2.cst_id and  t2.dt = '@@{yyyyMMdd}'  --当前是否为有效户
-- left join adm_pub.adm_csm_cbas_ind_inf_dd t3 on t1.cst_id = t3.cst_id and t3.dt = concat('@@{yyyy-1y}','1231')  --上年末是否为有效户
-- left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_vld_ind  t4 on t1.id = t4.id and t1.群组名称 = t4.群组名称
-- ) t
-- group by 主维护分行机构号
--       ,主维护分行名称
--       ,主维护支行机构号
--       ,主维护支行名称
--       ,主维护团队机构号
--       ,主维护团队名称
--       ,主维护机构号
-- ;



-- alter table lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_final drop if exists partition (dt = '@@{yyyyMMdd}') ;
-- insert into lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_final partition (dt = '@@{yyyyMMdd}')
-- select t1.主维护分行机构号
--       ,t1.主维护分行名称
--       ,t1.主维护支行机构号
--       ,t1.主维护支行名称
--       ,t1.主维护团队机构号
--       ,t1.主维护团队名称
--       ,t1.主维护机构号
--       ,t1.项目总数
--       ,t1.当年新增有效项目数
--       ,t1.当年新增有效户数

--       ,t1.当年度供应链新客数
--       ,t1.当年度新客用信规模
--       -- ,t1.当年度新客用信规模月日均

--       ,t1.累计供应链新客数
--       ,t1.累计新客用信规模
--       -- ,t1.累计新客用信规模月日均
-- --------- 较上月
--       ,coalesce(t1.当年度供应链新客数,0) - coalesce(t2.当年度供应链新客数,0) as 当年度供应链新客数_较上月
--       ,coalesce(t1.当年度新客用信规模,0) - coalesce(t2.当年度新客用信规模,0) as 当年度新客用信规模_较上月

--       ,coalesce(t1.累计新客用信规模,0) - coalesce(t2.累计新客用信规模,0) as 累计新客用信规模_较上月
--       -- ,coalesce(t1.累计新客用信规模月日均,0) - coalesce(t2.累计新客用信规模月日均,0) as 累计新客用信规模月日均_较上月
-- --------- 较上年末
--       ,coalesce(t1.当年度供应链新客数,0) - coalesce(t3.当年度供应链新客数,0) as 当年度供应链新客数_较上年末
--       ,coalesce(t1.当年度新客用信规模,0) - coalesce(t3.当年度新客用信规模,0) as 当年度新客用信规模_较上年末

--       ,coalesce(t1.累计新客用信规模,0) - coalesce(t3.累计新客用信规模,0) as 累计新客用信规模_较上年末
--       -- ,coalesce(t1.累计新客用信规模月日均,0) - coalesce(t3.累计新客用信规模月日均,0) as 累计新客用信规模月日均_较上年末
-- from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_2 t1
-- left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_2 t2 on t1.主维护机构号 = t2.主维护机构号 and t2.dt = to_char(lastday(dateadd(to_date(t1.dt,'yyyyMMdd'),-1,'MM')),'yyyyMMdd')  --上月末
-- left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_2 t3 on t1.主维护机构号 = t3.主维护机构号 and t3.dt = to_char(dateadd(to_date(concat(substr(t1.dt,1,4),'0101'),'yyyyMMdd'),-1,'dd'),'yyyyMMdd')  --上年末
-- where t1.dt = '@@{yyyyMMdd}'
-- ;


select * from lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_final where dt = '@@{yyyyMMdd}';





---临时表 11月贷款余额,11月贷款月日均,11月承兑敞口月日均
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_02 AS
SELECT  T1.cst_id
        ,MAX(CASE WHEN T1.DT = '@@{yyyyMMdd}' THEN loan_bal_acs ELSE 0 END)          AS 11月贷款余额
        ,MAX(CASE WHEN T1.DT = '@@{yyyyMMdd}' THEN loan_bal_acs_mon_avg ELSE 0 END)  AS 11月贷款月日均
        ,SUM(T1.open_acc_bal) / 30                                               AS 11月承兑敞口月日均

      --   ,MAX(CASE WHEN T1.DT = '@@{yyyyMMdd}' THEN lc_loan_bal ELSE 0 END)          AS 11月信用证余额
      --   ,MAX(CASE WHEN T1.DT = '@@{yyyyMMdd}' THEN lc_loan_mon_avg ELSE 0 END)          AS 11月信用证余额月日均

FROM    adm_pub.adm_csm_cbus_loan_inf_dd T1 --客户集市-业务信息-客户贷款业务信息表
WHERE   substr(t1.dt ,1,6) = '202411'
GROUP BY T1.cst_id ;






---临时表 存款余额,存款月日均,保证金余额
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_03 AS
SELECT  t2.cst_id
        ,COALESCE(SUM(t2.gl_bal), 0)  AS 存款余额
        ,SUM(T2.act_mth_acm_bal) / 30 AS 存款月日均
        ,SUM(CASE WHEN t2.prod_id IN ( '00203010200' , '00203010100' ) THEN t2.gl_bal ELSE 0 END) AS 保证金余额


FROM    edw.dws_bus_dep_act_inf_dd t2 --存款账户信息汇总
WHERE   t2.dt = '@@{yyyyMMdd}'
AND     t2.act_sts_cd <> 'C' --筛选未销户
GROUP BY t2.cst_id ;




-------- 国内信用证余额
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_04 AS
select id,群组名称,群组创建时间,cst_id
      ,sum(case when substr(t.prd_no,1,8)='10030301' and dt = '@@{yyyyMMdd}' then 合同余额 else 0 end ) as 11月信用证余额
      ,sum(case when substr(t.prd_no,1,8)='10030301' then 合同余额 else 0 end )/30 as 11月信用证余额日均

      ,sum(case when substr(t.prd_no,1,6) = '100201' and dt = '@@{yyyyMMdd}' then 合同余额 else 0 end ) as 11月承兑敞口余额
      ,sum(case when substr(t.prd_no,1,6) = '100201' then 合同余额 else 0 end )/30 as 11月承兑敞口余额日均
from (
      select t0.id
            ,t0.群组名称
            ,t0.群组创建时间
            ,t0.cst_id
            ,t1.dt
            ,prd_no
            ,case when substr(t1.prd_no,1,8)='10030301' or substr(t1.prd_no,1,6) = '100201' then (t1.ctr_bal-coalesce(t2.MRGN_AMT,0))*exr.avg_prc/exr.quo_unt end as 合同余额   -- 合同余额-保证金
      from lab_bigdata_dev.new_xqy_cst_seg_gyl_bi_mid_tbl_01 t0
      left join edw.dim_bus_loan_ctr_bse_inf_dd t1 on t0.cst_id = t1.cst_id and substr(t1.dt,1,6) = '202411' and substr(t1.prd_no,1,6) <> '200101' and t1.prd_no not in ('2001010101002','2001010101003','2002010101001') and t1.prd_no <> ''   --剔除个人消费性贷款/泰e贷消费/随贷通消费/信用卡/资产池
      left join edw.dim_bus_com_exr_inf_dd exr on t1.bsn_ccy_cd = exr.ccy_cd and substr(exr.dt,1,6) = '202411' and t1.dt = exr.dt
      left join APP_ADO.FCT_ACC_BAL_LST t2 on t1.ctr_serno = t2.BUS_CTR_ID and t2.dt = t1.dt
      where 是否计算产效 = '1'
      and t0.平台类型 = '企业类（供应链）'
) t
group by id,群组名称,群组创建时间,cst_id
;
select count(1),count(distinct cst_id)  from lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_04 ;


--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_final PURGE;

CREATE TABLE lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_final AS
SELECT  '@@{yyyyMMdd}' as 会计日期
        -- ,A1.群组创建分行
        ,a1.群组创建时间
        ,a1.群组创建用户
        ,a1.创建人机构号
        ,b3.brc_org_nm as 创建人分行机构名称
        ,a1.id
        ,A1.群组名称 as 供应链群组名称
        ,A1.核心企业客户编号
        ,A1.核心企业名称
        ,A21.sbr_org_nm                                   AS 核心企业管户支行名称
        ,A2.prm_org_nm                                    AS 核心企业管户机构名称
        ,A2.prm_mgr_id                                    AS 核心企业管户客户经理工号
        ,A2.prm_mgr_nm                                    AS 核心企业管户客户经理
        ,A1.cst_id as 供应链下客户编号
        ,a1.是否计算产效
        ,A3.cst_nm                                        AS 客户名称
        ,A31.sbr_org_nm                                   AS 客户管户支行名称
        ,A3.prm_org_nm                                    AS 客户管户机构名称
        ,A3.prm_mgr_id                                    AS 客户管户客户经理工号
        ,A3.prm_mgr_nm                                    AS 客户管户客户经理
        ,A4.存款月日均                                         AS 客户维度存款月日均
        ,A4.存款余额                                          AS 客户维度存款余额
        ,A4.保证金余额
        ,A5.cur_year_ftp_inc                              AS 客户维度FTP产效_当年
        ,A61.cd_val_dscr                                  AS 行业类型
        ,A71.cd_val_dscr                                  AS 贷款投向
        ,A7.prd_no                                         AS 产品代码
        ,A72.pd_nm                                        AS 产品品种
        ,A73.cd_val_dscr                                  AS 产品标识客群
        ,A7.ctr_serno                                   AS 合同流水号
        ,A7.ctr_amt                                       AS 合同金额
        ,A7.ctr_bal                                       AS 合同余额
        ,A7.ctr_bgn_dt                                 AS 贷款合同起始日
        ,A7.ctr_mtu_dt                                   AS 贷款合同到期日
        ,A7.exec_intr_rat                                      AS 执行月贷款利率
        ,A74.cd_val_dscr                                  AS 发生类型
        -- ,CASE
        --    WHEN A7.main_grnt_mth_cd = '020' THEN '抵押'
        --    WHEN A7.main_grnt_mth_cd = '010' THEN '保证'
        --    WHEN A7.main_grnt_mth_cd = '040' THEN '质押'
        --    WHEN A7.main_grnt_mth_cd = '005' THEN '信用'
        --  END                                              AS 主要担保方式
        ,A7.grnt_mod_colc 担保方式集合
         ,row_number() over(order by 1 desc) as rk

        ,A8.11月贷款月日均                                       AS 11月贷款月日均_客户级
      --   ,A8.11月承兑敞口月日均                                     AS 11月承兑敞口月日均_客户级
        ,b4.11月承兑敞口余额 as 11月承兑敞口余额_客户级
        ,b4.11月承兑敞口余额日均 as 11月承兑敞口余额日均_客户级
        ,A8.11月贷款余额                                        AS 贷款余额_客户级
        ,COALESCE(A8.11月贷款余额) - COALESCE(A81.loan_bal_acs) AS 贷款余额净增较年初_客户级
        ,b4.11月信用证余额 as 11月信用证余额_客户级
        ,b4.11月信用证余额日均  as 11月信用证余额月日均_客户级

        ,b1.当年度供应链新客
        ,b1.累计供应链新客
        ,b2.存款余额 as 存款余额_客户级
        ,b2.存款月日均 as 存款月日均_客户级
        ,b2.保证金余额 as 保证金余额_客户级
FROM     lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_mid_tbl_01 a1
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd A2 --客户主管户信息
ON      A1.核心企业客户编号 = A2.cst_id
AND     A2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd A21 --机构树_考核维度
ON      A2.prm_org_id = A21.org_id
AND     A21.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd A3 --客户主管户信息
ON      a1.cst_id = A3.cst_id
AND     A3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd A31 --机构树_考核维度
ON      A3.prm_org_id = A31.org_id
AND     A31.dt = '@@{yyyyMMdd}'
LEFT JOIN    tmp_gongyinglian_SJ2024042431_03 A4
ON      a1.cst_id = A4.cst_id
LEFT JOIN    adm_pub.adm_csm_cbus_ftp_inf_dd A5 --客户集市-业务信息-客户FTP业务
ON      a1.cst_id = A5.cst_id
AND     A5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd A6 --客户基础信息汇总表
ON      a1.cst_id = A6.cst_id
AND     A6.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A61 --行业
ON      A6.idt_cd = A61.cd_val
AND     A61.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     A61.fld_nm = 'IDT_CD'
AND     A61.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd A7 --信贷合同信息
ON      a1.cst_id = A7.cst_id
AND     ( A7.ctr_bgn_dt <= A7.dt
AND     A7.ctr_mtu_dt >= A7.dt
AND     A7.tmt_dt = '18991231' ) --限制合同未结清
AND     A7.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A71 --贷款投向
ON      A7.inv_in_indy_cd = A71.cd_val
AND     tolower(A71.tbl_nm) = 'dim_bus_loan_ctr_bse_inf_dd'
AND     tolower(A71.fld_nm) = 'inv_in_indy_cd'
AND     A71.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD A72 --信贷产品信息
ON      A7.prd_no = A72.prd_no
AND     A72.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A73 --产品标识客群
ON      A7.prd_cstgrp_mark = A73.cd_val
AND     tolower(A73.tbl_nm) = 'dim_bus_loan_ctr_bse_inf_dd'
AND     tolower(A73.fld_nm) = 'prd_cstgrp_mark'
AND     A73.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A74 --发生类型
ON      A7.hpn_typ_cd = A74.cd_val
AND     tolower(A74.tbl_nm) = 'dim_bus_loan_ctr_bse_inf_dd'
AND     A74.fld_nm = 'HPN_TYP_CD'
AND     A74.dt = '@@{yyyyMMdd}'
LEFT JOIN    tmp_gongyinglian_SJ2025022496_02 A8
ON      a1.cst_id = A8.cst_id
LEFT JOIN    adm_pub.adm_csm_cbus_loan_inf_dd A81 --客户集市-业务信息-客户贷款业务信息表
ON      a1.cst_id = A81.cst_id
AND     A81.dt = '20240101'
left join lab_bigdata_dev.tmp_xqy_gyl_SJ2025022496_new_cst_part_1 b1 on a1.cst_id = b1.cst_id    --取新客标签
left join lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_03 b2 on a1.cst_id = b2.cst_id  --取存款信息
left join edw.dim_hr_org_mng_org_tree_dd b3 on a1.创建人机构号 = b3.org_id and b3.dt = '@@{yyyyMMdd}'
left join lab_bigdata_dev.tmp_gongyinglian_SJ2025022496_04 b4 on a1.cst_id = b4.cst_id  --取国内信用证余额
;
**01-数据需求_分行_2025_D0224_绍兴分行_徐倩倩_小微商户与外部工商信息匹配.sql
-- SJ2025022411
---商户号	简称	全称	商户类型	分行	支行	客户经理姓名	工号	营业执照号码	商户状态	外数工商数据企业名称

SELECT * FROM tmp_wz_jczb_SJ2025022411_fr
--个人工商,客户号有空的，不用
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wz_jczb_SJ2025022411_fr PURGE;

CREATE TABLE lab_bigdata_dev.tmp_wz_jczb_SJ2025022411_fr AS
SELECT  distinct B1.*
FROM    (
            SELECT  A1.*
                    ,RANK() OVER ( PARTITION BY A1.by_qry_psn_doc_nbr  ORDER BY substr(replace(DAT_INS_TM,'-',''),1,8) DESC ) AS RN   -- 取某个证件号最新一次（精确到天）的查询信息
            FROM    (
                        SELECT  CST_ID              AS CST_ID
                                ,BY_QRY_PSN_NM      AS BY_QRY_PSN_NM
                                ,by_qry_psn_doc_nbr AS by_qry_psn_doc_nbr
                                ,DAT_INS_TM         AS DAT_INS_TM
                                ,USCC               AS USCC
                                ,entp_nm            AS entp_nm
                                ,ENTP_TYP           AS ENTP_TYP
                                ,ENTP_STS           AS ENTP_STS
                                ,PVC                AS PVC
                        FROM    edw.DIM_CST_OUT_GEB_IDV_PPL_LGP_INF_DD --工商个人人员法人信息事实表新
                        WHERE   DT = '@@{yyyyMMdd}'
                        AND     by_qry_psn_doc_nbr <> ''
                        and (coalesce(uscc,'')<>'' or coalesce(entp_id,'') <>'' or coalesce(entp_nm,'')<>'')
                        UNION
                        SELECT  CST_ID       AS CST_ID
                                ,CST_NM      AS BY_QRY_PSN_NM
                                ,doc_nbr     AS by_qry_psn_doc_nbr
                                ,QRY_TM      AS DAT_INS_TM
                                ,CSLD_CRD_CD AS USCC
                                ,entp_nm     AS entp_nm
                                ,ENTP_TYP    AS ENTP_TYP
                                ,ENTP_STS    AS ENTP_STS
                                ,PVC         AS PVC
                        FROM    edw.DIM_CST_OUT_GEB_IDV_LGP_INF_DD  --工商个人人员法人信息事实表老
                        -- WHERE   DT = MAX_PT('${odps_edw}.DIM_CST_OUT_GEB_IDV_LGP_INF_DD');
                        WHERE   DT = '@@{yyyyMMdd}'
                        AND     doc_nbr <> ''
                        and (coalesce(csld_crd_cd,'')<>'' or coalesce(entp_id,'')<>'' or coalesce(entp_nm,'')<>'')
                    ) A1
        ) B1
WHERE   B1.RN = 1;


---结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wz_jczb_SJ2025022411_ff PURGE;

CREATE TABLE lab_bigdata_dev.tmp_wz_jczb_SJ2025022411_ff AS
SELECT  a.mch_id 商户号
        ,a.mch_sht_nm 简称
        ,a.mch_nm 全称
        ,decode(a.mch_typ_cd, '04', '个体工商', '01', '企业', '06', '小微') AS 商户类型
        -- ,a.lgp_doc_nbr 法人证件号码
        ,a.lgp_nm 法人姓名
        ,a.entp_lgp_cst_id 企业法人客户号
        ,a.entp_cst_id 企业客户号
        ,a.afl_org_id 机构号
        ,a1.brc_org_nm 分行
        ,a1.sbr_org_nm 支行
        ,a.mgr_id 客户经理工号
        ,a2.empe_nm 客户经理姓名
        ,a.bus_lcn_nbr 营业执照号码
        ,decode(a.mch_sts_cd, '00', '执行中', '16', '注销', '99', '中止')  AS 商户状态
        ,b.uscc 统一社会信用代码_外数工商
        ,b.entp_nm 企业名称_外数工商
        ,b.entp_sts 企业状态_外数工商
FROM    edw.dws_bus_chnl_ths_mch_inf_dd a
LEFT JOIN    tmp_wz_jczb_SJ2025022411_fr b
ON      a.lgp_doc_nbr = b.by_qry_psn_doc_nbr
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a1
ON      a.afl_org_id = a1.org_id
AND     a1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a2
ON      a.mgr_id = a2.empe_id
AND     a2.dt = '@@{yyyyMMdd}'
WHERE   a.dt = '@@{yyyyMMdd}'
AND     a.afl_org_id LIKE '3307%';
**01-数据需求_分行_2025_D0304_舟山分行_毛传庆_逾期客户利息收入.sql
-- SJ20250303196

-- 舟山分行2024年不良贷款清单中利息收入逐笔情况

-- 舟山分行截至2025年1月底不良贷款清单中2024年一整年利息收入情况

-- 客户名称 合同号  借据号 利息



-- DROP TABLE if EXISTS tmp_sjxq_SJ20250303196_01 PURGE ;

-- CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250303196_01 (

--     ctr_sero STRING COMMENT '合同编号'

--     ,dbt STRING COMMENT '借据号或卡号'

--     ,cst_id STRING COMMENT '客户号'

--     ,cst_nm STRING COMMENT '客户名称'

-- ) ;



SELECT * FROM tmp_sjxq_SJ20250303196



DROP TABLE IF EXISTS tmp_sjxq_SJ20250303196 PURGE;



CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20250303196 AS

SELECT  t1.ctr_sero                                          AS 合同编号

        ,t1.dbt                                              AS 借据号或卡号

        ,t1.cst_id                                           AS 客户号

        ,t1.cst_nm                                           AS 客户名称

        ,coalesce(t2.lixishru, 0) - coalesce(t3.lixishru, 0) AS 利息收入

        --     ,sum(t2.jiaoyije) AS 利息收入

        -- ,t2.jiaoyije

        -- ,t2.jiaoyirq AS 交易日期

        -- ,t2.jiaoyifx AS 交易方向

FROM    tmp_sjxq_SJ20250303196_01 t1

LEFT JOIN    edw.core_klna_dkzhzb t2

ON      t1.dbt = t2.dkjiejuh

AND     t2.dt = '20241231'

LEFT JOIN    edw.core_klna_dkzhzb t3  --贷款账户主表

ON      t1.dbt = t3.dkjiejuh

AND     t3.dt = '20231231'

--     LEFT JOIN    edw.core_klnl_dkzhmx t2 --贷款账户交易明细表

--     ON      t1.dbt = t2.dkjiejuh

--     AND     substr(t2.dt, 1, 4) = '2024'

--     AND     t2.jiaoyirq <= '20241231'

--     AND     t2.jiaoyirq >= '20240101'

WHERE   length(t1.ctr_sero) > 10     --贷款

--     AND     t2.yeziduan = 'LIXISHRU' --利息收入

--     AND     t2.jiaoyifx = 0 --0 增加 1减少

--     GROUP BY t1.ctr_sero , t1.dbt , t1.cst_id , t1.cst_nm

UNION ALL

SELECT  t1.ctr_sero                           AS 合同编号

        ,t1.dbt                               AS 借据号或卡号

        ,t1.cst_id                            AS 客户号

        ,t1.cst_nm                            AS 客户名称

        ,CAST(t3.year_acm_intr_inc AS DOUBLE) AS 利息收入

FROM    tmp_sjxq_SJ20250303196_01 t1

LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd t2 --信用卡卡片

ON      t1.dbt = t2.cr_crd_card_nbr

AND     t2.dt = '20241231'

LEFT JOIN    edw.dws_bus_crd_cr_crd_act_acm_inf_dd t3 --信用卡账户汇总

ON      t2.cr_crd_act_id = t3.cr_crd_act_id

AND     t3.dt = '20241231'

WHERE   length(t1.ctr_sero) <= 10    --信用卡

;
**01-数据需求_分行_2025_D0307_苏州分行_金艺_信贷系统查询明细.sql
DROP TABLE IF EXISTS tmp_sjxq_SJ2025030676 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025030676 AS
SELECT  distinct_id 查询人
        ,customerid 被查询客户
        ,time 查询时间
        ,t1.prm_mgr_id 主管护人工号
        ,t1.prm_mgr_nm 主管护人名称
FROM    qbi_file_20250307_16_55_31_0 t
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1
ON      t.customerid = t1.cst_id
AND     t1.dt = '20250228'
WHERE   t.pt <> ''
AND     substr(t.time, 1, 10) BETWEEN '2025-02-01' AND '2025-02-28';
**01-数据需求_分行_2025_D0312_绍兴分行_何灵杰_信贷客户量化画像指标.sql
-- SJ2025031271
-- 截至2025年3月12日分行信贷客户量化指标，包括泰隆分、信用风险等级指标

-- 客户号、客户名、贷款金额、贷款余额、授信额度、泰隆分、信用风险等级、管户机构号


SELECT a.cst_id
       ,a.cst_nm

FROM adm_pub_app.adm_pblc_cst_prm_mng_inf_dd a
WHERE a.dt='20250312'
;
lab_bigdata_dev.quant_portr_upper_idv_cst_credit_score_bas_info
QUANT_PORTR_ZZQS_IDV_CST_CREDIT_RISK_INFO
SELECT * FROM  quant_portr_upper_idv_cst_credit_score_bas_info

quant_portr_upper_entp_cst_credit_score_bas_info
**01-数据需求_分行_2025_D0318_杭州分行_王菲梵_交易对手在我行的开户信息.sql
-- SJ2025031426
-- 截至取数日，客户赵彬的交易对手中涉及全行的客户信息。
-- 客户名称、客户号、账号、开户日期、分行、管护支行、管护团队、管护客户经理、是否有信贷业务
SELECT  dep.cst_act_id 账号
        ,dep.cst_id 客户号
        ,cst.cst_chn_nm 客户名称
        ,dep.opn_dt 开户日期
        ,case when ctr.cst_id is not null then '是' else '否' end  as 是否有信贷业务
        ,mgr.mgr_id 管护人
        ,mgr.acs_org_id 管护机构
FROM    edw.dws_bus_dep_act_inf_dd dep
LEFT JOIN edw.dim_cst_bas_inf_dd cst
on dep.cst_id=cst.cst_id
and cst.dt='@@{yyyyMMdd}'
left join edw.dwd_bus_dep_cst_act_mgr_inf_dd mgr
on mgr.cst_act_id=dep.cst_act_id
and mgr.dt='@@{yyyyMMdd}'
left join edw.dim_bus_loan_ctr_bse_inf_dd ctr
on dep.cst_id=ctr.cst_id
and ctr.dt='@@{yyyyMMdd}'
WHERE   dep.dt = '@@{yyyyMMdd}'
and dep.cst_id='1679957492'
-- AND     dep.cst_act_id IN ( '6217000110016905029' , '6228481829177659779' , '6214850248148899' , '842584073990004' , '6222803110021000237' , '6228482392190067016' , '6217001370037757333' , '1000050201' , '6217001820037629213' , '623061571514809289' , '674428478' , '11165288221' , '1000050201' , '10334303225' , '621278435170004473' , '6217906400010904226' , '6217000680002238809' , '6210812430032192680' , '621278435170004473' , '6217996900138904272' , '20886329770726780156' , '6217996526000015101' , '10334303225' , '6217856100093973607' , '6222031001034887260' , '1800008432' , '6227000060014079765' , '2088052049686145' , '6228481009177076270' , '621278435170004473' , '6230351892246626' , '6227003173020362047' , '6236680410006256194' , '6228482139111278077' , '2088842816600544' , '10334303225' , '6217004470045497364' , '6236682090001310101' , '6230520830027863677' , '6212264000000082566' , '2088842816600544' , '10334303225' , '6228481958457247771' , '6212260502007814432' , '6227002007580096226' , '11932574945' , '6228480391592335916' , '2088052049686145' , '6210137292911321' , '1800008432' , '2088052049686145' , '6228480188456063778' , '6222082006000263956' , '10334303225' , '11944089350' , '6217858400027400133' , '6228480397119963270' , '20886127206271660156' , '6215582309000790286' , '2088052049686145' , '10334303225' , '10334303225' , '6222031202007088262' , '6228482379503620375' , '6217993632000410103' , '11944089350' , '2088052049686145' , '6217856300038439108' , '6228482379503620375' , '11944089350' , '6217001860004721601' , '6226229102901543' , '6217991460005883591' , '20880520496861450156' , '6214680063533523' , '2088842769581651' , '6212261202057428188' , '6231120100016309799' , '11944089350' , '11944089350' , '6217001860004721601' , '621278435170004473' , '6217001830041228167' , '1800008262' , '11944089350' , '6212262010027641874' , '11944089350' , '2088842816600544' , '6216690400001878027' , '6227001892720002585' , '6217001820044288722' , '865700757' , '6214837402128593' , '6217003640008448478' , '2088842816600544' , '6222030302003563713' , '11944089350' , '6214857214390371' , '6217001860004721601' , '6217876100017309314' , '11944089350' , '2088842769581651' , '2088842769581651' , '6212260200133041182' , '11944089350' , '1800002761' , '621278435170004473' , '6223093050011392102' , '6214832845054712' , '6228480038646733170' , '6217858400027400133' , '6217852700027356375' , '6217004470024723053' , '6222034200006000079' , '11944089350' , '6217998800026241522' , '2088842769581651' , '6215590612006686790' , '6217003200000918075' , '6217001860004721601' , '6217001860004721601' , '11944089350' , '6228450320025069616' , '6222802201431495116' , '2088842816600544' , '2088842769581651' , '11944089350' , '6214800602002563290' , '2088842769581651' , '6217001860004721601' , '2088842769581651' , '2088842769581651' , '6217997300108487201' , '11944089350' , '2088842816600544' , '2088842816600544' , '2088842816600544' , '11944089350' , '2088052049686145' , '6228410504640257073' , '6217001860004721601' , '6228482668449603572' , '6217852700027356375' , '11932574945' , '6230200057534534' , '2088052049686145' , '6228481630271923016' , '6217857500028327549' , '6217001860004721601' , '20882236820613300156' , '11944089350' , '11944089350' , '2088842769581651' , '2088842769581651' , '6222032008015344954' , '6217857600057711611' , '6236682650003467645' , '2088842816600544' , '6217995620016671451' , '2088842769581651' , '11944089350' , '11932574945' , '784603759' , '20885221287999200156' , '6228480218949885675' , '1800008262' , '2088842816600544' , '6236562080001176227' , '2088842816600544' , '2088842769581651' , '2088842816600544' , '6217004470024723053' , '6230523960001311570' , '6217000890003408620' , '6217858400027400133' , '6214660510052053' , '2088842816600544' , '6222032703010157035' , '20882223837521740156' , '6212262013011595502' , '6212960104000457757' , '6222804411000080235' , '2088052049686145' , '1800008262' , '6217991430006241396' , '6222620310009280881' , '6217004400012271716' , '6227001265020104551' , '2088052049686145' , '6212260402010365383' , '2088842816600544' , '6228480639312514875' , '2088842816600544' , '6214633131166264100' , '6217000330002675457' , '11944089350' , '2088052049686145' , '6214834263004542' , '6217000940044661990' , '11944089350' , '2088842816600544' , '2088052049686145' , '6222804411000080235' , '6212261402019555256' , '6214633131166264100' , '2088052049686145' , '11944089350' , '6217856100046687056' , '2088842769581651' , '11944089350' , '6235696101000124132' , '6226632000674387' , '6216603600000325567' , '2088842816600544' , '6217003590002559335' , '11944089350' , '6217003810049229811' , '11944089350' , '6217001760003382209' , '11932574945' , '11932574945' , '6217004260035809284' , '001980099990002' , '6222621210006975781' , '11944089350' , '4563516206013585925' , '11944089350' , '6217876100038162494' , '2088842816600544' , '6222033100047385995' , '6217993000362696638' , '6217681805406058' , '20881324595917880156' , '11944089350' , '6217002030004362462' , '6217003090009758154' , '6230944140000047654' , '2088842816600544' , '6217212002015584612' , '6228480318281580577' , '2088842985502261' , '2088842816600544' , '6217003090019275280' , '11975506748' , '1239641701' , '1140077212' , '6231995200000574242' , '2088842816600544' , '6217867600002941709' , '6212261607015524003' , '6217000066035172159' , '11944089350' , '6230500400045896507' , '11932574945' , '20880326548217640156' , '6230580000016214459' , '6230500400045896507' , '2088842985502261' , '2088842816600544' , '2088842816600544' , '6217001680017492770' , '6213361909981546870' , '6221887111003024121' , '9559980718004099310' , '2088842816600544' , '2088842816600544' , '622908453113966217' , '6236682000029704607' , '6217004260018920389' , '1800008262' , '2088842769581651' , '11897793719' , '2088842816600544' , '6226651900253613' , '20880026551637410156' , '6217001250018668610' , '6222623290000828911' , '20888429855022610156' , '20888428166005440156' , '11944089350' , '6214633131166264100' , '20888429855022610156' , '11944089350' , '6222031102000023912' , '6228481099458190270' , '20888427695816510156' , 'DP117XXXXXX0D999' , '20888429855022610156' , '6228230505724018461' , '1414427914' , '20888427695816510156' , '6228230505724018461' , '20888427695816510156' , '11216289288' , '6222020302023761935' , '6217856100021903247' , '20888022611387660156' , '6227003090320101521' , '20888428166005440156' , '20888428166005440156' , '6228230189024226874' , '6217993000375395673' , '1800008262' , '6217993320022900679' , '20888427695816510156' , '6217680804959661' , '6227001482200209056' , '20888428166005440156' , '6222031102018951880' , '6217000840006691730' , '11944089350' , '6215340302636716489' , '11932574945' , '6231039910046375424' , '11944089350' , '11944089350' , '6217002030012483789' , '6227001312810123423' , '10944846980' , '6217995060000125695' , '6230399991013254590' , '6227001312810123423' , '6227001312810123423' , '6230399991013254590' , '11944089350' , '6225882906529588' , '6230399991013254590' , '6230399991013254590' , '6221881600039296832' , '6226159901634732' , '11944089350' , '6230910699007333623' , '6212263602080906696' , '6217931075224610' , '11944089350' , '20888429855022610156' , '11944089350' , '20888429855022610156' , '6222002012102021950' , '6217001860004721601' , '20888428166005440156' , '6236691260000037182' , '6222021001127661624' , '11944089350' , '20888428166005440156' , '20888429855022610156' , '6228270129914697777' , '6228271036502934075' , '20888427695816510156' , '20888427695816510156' , '303980094985841' , '6217931674046034' , '6217003940003494166' , '6225881251549993' , '20888427695816510156' , '20888427695816510156' , '6231900020006974327' , '20888428166005440156' , '6228482928135551273' , '6213380020200276963' , '20888427695816510156' , '11944089350' , '6217231615000834515' , '11944089350' , '20888428166005440156' , '20888429855022610156' , '20888429855022610156' , '6217000120022589956' , '6217680512474664' , '20888429855022610156' , '6212264402000508295' , '20888429855022610156' , '20888427695816510156' , '6217997150010060590' , '20880226938047500156' , '11944089350' , '6228480339517618379' , '20888427695816510156' , '215500690' , '6217997710001051336' , '215500690' , '215500690' , '6217003570006535044' , '6228270021256064577' , '001980099990002' , '6217002500015107478' , '11932574945' , '6230523420035725873' , '6217856100003473045' , '6217002030012483789' , '6227001280070054663' , '6217906101004817719' , '215500690' , '6216605000001631832' , '6216613000003514440' , '6212260407004854995' , '6214673800035970425' , '11944089350' , '20885028246394470156' , '001980099990002' , '20888129730766300156' , '215500690' , '11932574945' , '6217868100000767817' , '11932574945' , '1000050201' , '11944089350' , '1000050201' , '1000050201' , '1000050201' , '215500690' , '6226154800079550' , '6217211804022239036' , '001980099990002' , '6222031407000786040' , '10783975353' , '001980099990002' , '11932574945' , '11932574945' , '6217991910057347085' , '215500690' , '1800008262' , '11932574945' , '11932574945' , '215500690' , '6214990880072666' , '20887225977482340156' , '11932574945' , '215500690' , '215500690' , '6217906101004817719' , '215500690' , '6217853100021742952' , '6217906101004817719' , '215500690' , '215500690' , '6226159901634732' , '215500690' , '6217790006026170410' , '001980099990002' , '1319423101' , '428161760' , '536300676' , '6212260407001896247' , '6223201305588230' , '001980099990002' , '6217856300038439108' , '1800008262' , '1800008262' , '215500690' , '1800008262' , '1800008262' , '6222626160000150243' , '215500690' , '6230580000367102337' , '215500690' , '215500690' , '215500690' , '215500690' , '215500690' , '215500690' , '215500690' , '6230520470041810972' , '11944089350' , '6231700190081306836' , '20888222206492470156' , '6236681270003265476' , '215500690' , '20886226877530710156' , '11944089350' , '001980099990002' , '215500690' , '20887229470554920156' , '001980099990002' , '215500690' , '215500690' , '6210810900000230672' , '1800008262' , '20884327052022520156' , '215500690' , '11932574945' , '11944089350' , '215500690' , '4563516206013585925' , '215500690' , '6228480445830377971' , '11944089350' , '215500690' , '001980099990002' , '6217007130010430421' , '215500690' , '001980099990002' , '215500690' , '11944089350' , '6228480568053378879' , '215500690' , '001980099990002' , '11944089350' , '6231700190081306836' , '001980099990002' , '6222620620051576519' , '11932574945' , '11944089350' , '001980099990002' , '6217003920010308294' , '11932574945' , '1000050201' , '6227001463710092174' , '11932574945' , 'DP117XXXXXX0D999' , '001980099990002' , '11932574945' , '6222620620051576519' , '11932574945' , '215500690' , '6217002030004362462' , '215500690' , '6226159901395896' , '001980099990002' , '6217856100015149716' , '001980099990002' , '20881228808805350156' , '001980099990002' , '6228484148645297675' , '1000050201' , '11932574945' , '6217000690000156481' , '001980099990002' , '215500690' , '215500690' , '11932574945' , '11932574945' , '215500690' , '215500690' , '215500690' , '001980099990002' , '1800008262' )
**01-数据需求_分行_2025_常态化_D0107_台州分行_江丽娜_分析循环类贷款业务_了解支行对该类业务是否有设置冻结方式_单笔用信期限上限_.sql
--定期跑数
-- SJ2024110636
-- 截止2024.11.5，台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况
-- 用于分析循环类贷款业务，了解支行对该类业务是否有设置冻结方式、单笔用信期限上限
--字段：数据日期	合同流水号	客户编号	客户名称	风险分层	发生类型	业务标识	业务品种	营销标签	循环贷款类型
--若泰e贷，需要显示是否人工审批	合同冻结方式	合同冻结期限(月)	单笔用信期限上限(天)	合同金额	合同余额
--未结清借据金额	执行月利率(&permil;)	执行年利率(%) 结息方式	资金用途	合同起始日	合同到期日	主要担保方式	是否异地
--管户机构号	管户机构名称	管户人工号	管户人姓名	发放人	发放姓名	发放人机构	发放人机构名称

--SJ2024120336
-- 用于分析循环类贷款业务，了解支行对该类业务是否有设置冻结方式、单笔用信期限上限
--截止2024.12.3，台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况
-- 同需求SJ2024110636


--SJ2025010621
-- 用于分析循环类贷款业务，了解支行对该类业务是否有设置冻结方式、单笔用信期限上限
-- 截止2025.1.6（数据取数最近日期），台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况

-- SJ2025011341


-- SJ2025012051
--取数203763条

SELECT * FROM tmp_sjxq_jln_SJ2025012051

SELECT count(1) FROM tmp_sjxq_jln_SJ2025012051;

DROP TABLE IF EXISTS tmp_sjxq_jln_SJ2025012051 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_jln_SJ2025012051 AS
SELECT  a.dt                          AS 数据日期
        ,a.ctr_serno                  AS 合同流水号
        -- ,a.ctr_sts_cd as 合同状态
        ,a.cst_id                     AS 客户编号
        ,a.cst_nm                     AS 客户名称
        ,CASE
           WHEN f.rsk_lyr = '1' THEN '低风险'
           WHEN f.rsk_lyr = '2' THEN '中低风险'
           WHEN f.rsk_lyr = '3' THEN '中风险'
           WHEN f.rsk_lyr = '4' THEN '中高风险'
           WHEN f.rsk_lyr = '5' THEN '高风险'
           ELSE ''
         END                          AS 风险分层 --不是合同表的客户风险等级
        ,CASE
           WHEN a.hpn_typ_cd = '011' THEN '续做'
           WHEN a.hpn_typ_cd = '010' THEN '首笔'
         END                          AS 发生类型
        ,CASE
           WHEN a.bsn_mark_cd = 01 THEN '员工贷款'
           WHEN a.bsn_mark_cd = 02 THEN '信贷人员亲属业务'
           WHEN a.bsn_mark_cd = 03 THEN '预保预报业务'
           WHEN a.bsn_mark_cd = 04 THEN '重组业务'
           WHEN a.bsn_mark_cd = 05 THEN '协作业务'
         END                          AS 业务标识
        ,a.prd_no                     AS 业务品种代码
        ,T4.pd_nm                     AS 业务名称
        ,a.prd_tag                    AS 产品标签编号集合 --即原来的营销标签
        ,a.prd_tag_nm                 AS 产品标签名称
        ,CASE
           WHEN a.rvlg_typ_cd = 0 THEN '非循环'
           WHEN a.rvlg_typ_cd = 1 THEN '自助循环'
           WHEN a.rvlg_typ_cd = 2 THEN '半自助循环'
         END                          AS 循环贷款类型
        ,CASE
           WHEN e.bsn_aprv_mod_cd = 1 THEN '机批'
           WHEN e.bsn_aprv_mod_cd = 2 THEN '人批'
         END                          AS 业务审批模式
        ,CASE
           WHEN c.ctr_frz_mod = 05 THEN '每笔贷款发放后'
           WHEN c.ctr_frz_mod = 06 THEN '无'
           WHEN c.ctr_frz_mod = 07 THEN '冻结一次'
           WHEN c.ctr_frz_mod = 08 THEN '循环冻结'
           WHEN c.ctr_frz_mod = 09 THEN '到期前3个月'
         END                          AS 合同冻结方式 --合同表的ctr_frz_mod_cd不能用，废弃字段
        ,c.frz_trm                    AS 合同冻结期限
        ,d.sngl_usc_trm_ceil          AS 单笔用信期限上限
        ,a.ctr_amt                    AS 合同金额
        ,a.ctr_bal                    AS 合同余额
        ,b.amt                        AS 未结清借据金额
        ,a.exec_intr_rat              AS 执行月利率
        ,a.exec_intr_rat * 1.2        AS 执行年利率
        ,a.rpay_prcp_setl_intr_mod_cd AS 还本结息方式代码
        ,T1.cd_val_dscr               AS 结息方式
        ,a.cpt_usg_cd                 AS 资金用途代码
        ,a.cpt_usg_rmk                AS 资金用途
        ,a.ctr_bgn_dt                 AS 合同起始日
        ,a.ctr_mtu_dt                 AS 合同到期日
        ,a1.grnt_mod_nm               AS 担保方式集合
        -- ,CASE
        --    WHEN a.grnt_mod_colc = 010 THEN '保证'
        --    WHEN a.grnt_mod_colc = 005 THEN '信用'
        --    WHEN a.grnt_mod_colc = 020 THEN '抵押'
        --    WHEN a.grnt_mod_colc = 040 THEN '质押'
        --  END                          AS 担保方式集合
        ,CASE
           WHEN a.dif_plc_bsn_ind = 0 THEN '否'
           WHEN a.dif_plc_bsn_ind = 1 THEN '是'
         END                          AS 乡情贷业务标志 --即是否异地
        ,a.mgr_org_id                 AS 管户机构号
        ,a1.org_nm                    AS 管护机构名
        ,a.mgr_id                     AS 管户人工号
        ,a3.empe_nm                   AS 管户人姓名
        ,a.hdl_opr_id                 AS 经办人工号
        ,a4.empe_nm                   AS 经办人姓名
        ,a.hdl_org_id                 AS 经办机构号
        ,a2.org_nm                    AS 经办机构名称
FROM    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息
--取担保方式
LEFT JOIN    (
                 SELECT  a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '@@{yyyyMMdd}'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '@@{yyyyMMdd}'
                 GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc
             ) a1
ON      a.ctr_serno = a1.ctr_serno
LEFT JOIN    (
                 SELECT  t.ctr_serno
                         ,sum(t.prcp_bal) AS amt --未结清借据金额
                 FROM    edw.DIM_BUS_LOAN_DBIL_INF_DD t --借据
                 WHERE   t.dt = '@@{yyyyMMdd}'
                 AND     ( t.TMT_DT = '18991231'
                     OR t.prcp_bal > 0 ) ----未终结未结清
                 GROUP BY t.ctr_serno
             ) b
ON      a.ctr_serno = b.ctr_serno
LEFT JOIN    edw.loan_ctr_intr_rat c --合同利率
ON      a.ctr_serno = c.ctr_serno
AND     c.dt = '@@{yyyyMMdd}'
AND     c.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_ctr_oth_dtl_inf d --合同其它明细信息 ，模型层表edw.dim_bus_loan_ctr_oth_dtl_inf_dd
ON      a.ctr_serno = d.ctr_serno
AND     d.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_biz_dd e --用信方案
ON      a.rel_serno = e.usc_aply_serno
AND     e.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_lmt_biz_stat_inf f --统计类信息，模型层表edw.dwd_bus_loan_lmt_biz_stat_inf_dd
ON      a.rel_serno = f.usc_aply_serno
AND     f.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T4 --产品信息
ON      a.prd_no = T4.prd_no
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a1
ON      a.mgr_org_id = a1.org_id
AND     a1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a2
ON      a.hdl_org_id = a2.org_id
AND     a2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a3
ON      a.mgr_id = a3.empe_id
AND     a3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a4
ON      a.hdl_opr_id = a4.empe_id
AND     a4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T1
ON      a.rpay_prcp_setl_intr_mod_cd = T1.cd_val
AND     T1.dt = '@@{yyyyMMdd}'
AND     T1.tbl_nm = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T1.fld_nm = upper('rpay_prcp_setl_intr_mod_cd')
WHERE   a.dt = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( A.CTR_STS_CD IN ( '2' , '4' )
AND     A.TMT_DT = '18991231'
AND     to_date(A.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A.DT, 'yyyyMMdd') )
    OR A.CTR_BAL > 0 )
AND     a.rvlg_typ_cd <> '0' --循环类贷款
AND     a.prd_no <> '2002010101001' --剔除信用卡
AND     a.mgr_org_id LIKE '3301%'    --台州分行
;
**01-数据需求_分行_2025_温州分行_卢博赫_存单质押_常态化.sql
-- 客户号、客户姓名、存款帐号（子户帐号）、客户存款账户、存单产品（对公、对私的定期、大额存单）、存单期限、管护机构号、管护支行、管护团队、管护客户经理、日均、余额
-- 24年12，温州分行存单质押数据

SELECT * FROM tmp_cth_wz_cd_20250228

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cth_wz_cd_20250228;

CREATE TABLE lab_bigdata_dev.tmp_cth_wz_cd_20250228 AS
SELECT  T2.dt                                                               AS 数据日期
        ,T2.cst_id                                                          AS 客户号
        ,T2.act_nm                                                          AS 客户姓名
        ,T2.cst_act_id                                                      AS 客户账号
        ,T2.dep_act_id                                                      AS 存款账号
        ,T8.pd_cmt                                                          AS 存单产品
        ,T2.dep_trm                                                         AS 存期
        ,T4.acs_org_id                                                      AS 管护机构号
        ,T5.org_nm                                                          AS 管护机构名
        ,T5.sbr_org_nm                                                      AS 管护支行
        ,T5.tem_org_nm                                                      AS 管护团队
        ,T4.mgr_id                                                          AS 管护人工号
        ,NVL(T6.empe_nm, '')                                                AS 管护客户经理
        ,T2.gl_bal * T3.AVG_PRC / T3.QUO_UNT                                AS 余额
        ,T2.act_mth_acm_bal * T3.AVG_PRC / T3.QUO_UNT / SUBSTR(T2.DT, 7, 2) AS 月日均
-- ,T2.act_year_acm_bal*T3.AVG_PRC / T3.QUO_UNT /(DATEDIFF(TO_DATE(T2.dt,'yyyymmdd'),to_date('20231231','yyyymmdd'),'dd')) as 年日均
FROM    edw.dws_bus_dep_act_inf_dd T2 --存款账户信息汇总
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD T3 --汇率信息
ON      T2.CCY_CD = T3.CCY_CD
AND     T2.dt = T3.dt
AND     T3.DT ='${yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T4 --客户存款账户管护信息
ON      T2.cst_act_id = T4.cst_act_id
AND     T2.dt = T4.dt
AND     T4.DT ='${yyyyMMdd}'
AND     T4.frs_ctc_ind = '1'
 --第一联系人标志
-- AND     T4.act_rel_chr_cd <> '6' --剔除资源性存款
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T4.acs_org_id = T5.org_id
AND     T4.dt = T5.dt
AND     T5.DT ='${yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T4.mgr_id = T6.empe_id
AND     T4.dt = T6.dt
AND     T6.DT ='${yyyyMMdd}'
INNER JOIN    (
                  SELECT  dt
                          ,act_id
                  FROM    edw.dim_bus_loan_cltr_dep_cert_spcl_dd --贷款客户押品存单专项信息
                  WHERE   DT ='${yyyyMMdd}'
                  GROUP BY dt , act_id
              ) T7
ON      T2.cst_act_id = T7.act_id
AND     T2.dt = T7.dt
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd T8 --存款产品
ON      T2.prod_id = T8.pd_id
AND     T2.dt = T8.dt
AND     T8.dt ='${yyyyMMdd}'
WHERE   T2.DT ='${yyyyMMdd}'
AND     T2.prod_id IN ( '00202040100' , '00201040100' , '00201020100' , '00201020105','00202020100') --单位大额存单,个人大额存单,个人整存整取,新成长乐,单位定期
AND     T5.brc_org_id = '330599999'   --温州分行
;
**01-数据需求_分行_D0108_滑茹瑶_随贷通配卡数据.sql
-- SJ2025010881

-- 行业标签	是否社区	是否舟山本地人	资产负债率	担保方式	配偶是否纳入担保	销售额	当前融资总敞口	净资产	存款近6个月日均	经营性负债金额	信用评级
-- 预评估是否异常	预评估禁止&ge;2类	模型分	当前征信分	三个月前征信分	近三个月在多家机构频繁申请	近六个月在多家机构频繁申请	当前风险等级
-- 近三个月是否触发过精准贷后预警或处置类规则	近三个月触发过精准贷后预警或处置类规则原因




DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_DEPK_SJ2025010881_01
(    征信分                          STRING
    ,数据日期                        STRING
    ,客户号                          STRING
    ,客户名称                        STRING
    ,客户类型                        STRING
    ,同一风险控制号                  STRING
    ,所属分行                        STRING
    ,所属支行编号                    STRING
    ,所属支行                        STRING
    ,管户机构号                      STRING
    ,管户机构名称                    STRING
    ,管户客户经理                    STRING
    ,管户客户经理名称                STRING
    ,客户经营性贷款汇总合同金额      STRING
    ,客户经营性贷款汇总金额分层      STRING
    ,经营性贷款到期时间              STRING
    ,风险关注_仅供参考               STRING
    ,他行融资家数                    STRING
    ,是否配卡                        STRING
    ,是否本人配卡                    STRING
) ;



-- 1.1 征信分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_zxf1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_zxf1 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20250107'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20250107'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;


--1.2 三个月前征信分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_zxf2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_zxf2 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20241007'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20241007'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;

--1.3 客户风险等级
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_02 AS
SELECT  A1.cst_id
         ,CASE
            WHEN A1.rsk_lyr_cd = '1' THEN '低风险'
            WHEN A1.rsk_lyr_cd = '5' THEN '高风险'
            WHEN A1.rsk_lyr_cd = '2' THEN '中低风险'
            WHEN A1.rsk_lyr_cd = '3' THEN '中风险'
            WHEN A1.rsk_lyr_cd = '4' THEN '中高风险'
          END                                                                          AS 风险等级
		 ,A1.modl_grd                  AS 模型分
		 ,A1.pct                       AS 相对位置
         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.rsk_lyr_afm_tm DESC ) AS RN
 FROM    edw.dim_cst_asst_rsk_lyr_dd A1  --风险分层信息
 WHERE   A1.DT = '20250107'
 AND     A1.rsk_lyr_cd <> '' ;


--1.4 担保方式
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_03 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_03 AS
SELECT  a.dt
        ,a.ctr_serno
        ,a.grnt_mod_colc
        ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
FROM    (
            SELECT  dt
                    ,ctr_serno
                    ,grnt_mod_colc
                    ,grnt_mod_colc2
            FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
            WHERE   dt = '20250107'
            AND     grnt_mod_colc IS NOT NULL
            AND     grnt_mod_colc <> ''
        ) a
LEFT JOIN    edw.dwd_code_library_dd b --码值表
ON      a.grnt_mod_colc2 = b.cd_val
AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
AND     b.fld_nm = 'GRNT_MOD_CD'
AND     b.DT = '20250107'
GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc;




--1.5 配偶是否纳入担保
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_04 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_04 AS
SELECT
   A1.ctr_serno
   ,A1.cst_id	 AS  客户号
   --,A2.WRNT_CST_ID AS  担保人客户号
   ,A4.grnt_mod_nm AS 担保方式
   ,MAX(CASE WHEN A3.rel_cst_id IS NOT NULL THEN '是' ELSE '否' END) AS 配偶是否纳入担保
FROM edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
LEFT JOIN edw.dws_bus_grnt_prsn_inf_dd A2 --担保人汇总信息
ON   A1.ctr_serno  = A2.BUS_CTR_ID
AND  A2.DT = '20250107'
LEFT JOIN    edw.loan_cst_rel A3  --联系人
ON      A1.cst_id = A3.cst_id
AND     A2.wrnt_cst_id = A3.rel_cst_id
AND     A3.rel_typ	= '0301'  --配偶
AND     A3.del_ind	<> '1'   --删除标识
AND     A3.vld_ind	 = '1'
AND     A3.DT = '20250107'
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_03 A4
ON      A1.ctr_serno = A4.ctr_serno
WHERE A1.DT = '20250107'
AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') )
       OR A1.CTR_BAL > 0 )
AND  A1.DT = '20250107'
GROUP BY A1.ctr_serno,A1.cst_id ,A4.grnt_mod_nm ;



--1.6  征信信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_DEPK_SJ2025010881_05  AS
-- 个人征信
SELECT  A1.cst_id
        ,A1.report_id
        ,A1.pd_cd
        ,A1.ctr_amt
        ,A1.ctr_bal
		,'1'      AS 客户类型
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT = '20250107'
AND     A1.dtrb_org <> 'ZJTLCB'
AND     A1.cls_dt >= A1.DT  --关闭日期
AND     A1.mtu_dt >= A1.DT  --到期日期
--AND     A1.pd_cd IN ( '41' , '42' , '52' )  --经营性
UNION ALL
--企业征信
SELECT  A1.cst_id
        ,A1.report_id
		,A1.bus_pd_cls_cd	  AS pd_cd
        ,A1.loan_amt	                                                   AS ctr_amt
        ,A1.loan_bal                                                       AS ctr_bal
		,'2'      AS 客户类型
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
WHERE   A1.DT = '20250107'
AND     A1.cls_dt >= A1.DT  --关闭日期
AND     A1.loan_mtu_dt >= A1.DT  --到期日期
;



-- 1010	通过
-- 1020	抗辩通过
-- 1030	上诉通过

--1.7 预评估信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_06 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_DEPK_SJ2025010881_06  AS
SELECT
   A1.客户号
   ,MAX(CASE WHEN  A1.预评估结果代码 NOT IN ('1020','1030','1010') THEN '是' ELSE '否' END) AS 预评估是否异常
   ,COUNT(A2.rul_no)   AS 预评估禁止数量
FROM (
                 SELECT  T1.cst_id                                                                  AS 客户号
			 ,T0.rul_set_rslt_cd                                                        AS 预评估结果代码
                         ,T2.cd_val_dscr                                                            AS 最近一次预评估结果
                         ,T1.last_upd_tm                                                            AS 最近一次预评估时间
                         ,T0.rul_set_rslt_serno --规则集结果流水号
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T1.last_upd_tm DESC,T1.sys_reg_tm	DESC ) AS RN
                 FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估业务申请
                 INNER JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
                 ON      T1.pre_ases_serno = T0.pre_ases_serno
                 AND     T0.DT = '20250107'
                 LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
                 ON      T0.rul_set_rslt_cd = T2.cd_val
                 AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'   --授信关联预评估信息表
                 AND     T2.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     T2.DT = '20250107'
                 WHERE   T1.DT = '20250107'
			)  A1
LEFT JOIN    edw.dwd_bus_loan_pre_ases_rul_dtl_dd A2  --预评估规则明细
ON      A1.rul_set_rslt_serno = A2.rul_set_rslt_serno
AND     A2.rsk_dgr_cd ='2'  --原则
AND     A2.DT = '20250107'
WHERE   A1.RN = 1
GROUP BY  A1.客户号
;


--1.8 贷款审批查询机构数

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_07 PURGE;


CREATE TABLE lab_bigdata_dev.tmp_DEPK_SJ2025010881_07 AS
SELECT  T1.qry_cst_id        AS 客户号
        ,COUNT(DISTINCT CASE
                          WHEN T1.qry_dt >= '20241007' THEN T1.qry_org
                        END) AS 近三个月贷款审批查询机构数
        ,COUNT(DISTINCT CASE
                          WHEN T1.qry_dt >= '20240707' THEN T1.qry_org
                        END) AS 近六个月贷款审批查询机构数
FROM    (
            SELECT  *
                    ,rank() OVER ( PARTITION BY qry_cst_id ORDER BY rpt_id DESC ) rn
            FROM    edw.dwd_cst_ccrc_ipcr_qry_rcd_di --人行征信报告查询记录明细
            WHERE   dt >= '20240101'
        ) T1
WHERE   T1.rn = 1
AND     T1.qry_rsn_cd = '02' --贷款审批
GROUP BY T1.qry_cst_id;


--1.9 精准贷后
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_08 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_08 AS
SELECT  T1.cst_id      AS 客户号
        ,MAX(CASE WHEN T2.btch_serno IS NOT NULL THEN '是' ELSE '否' END) AS  近三个月是否触发过精准贷后预警或处置类规则
		,WM_CONCAT(DISTINCT '||',T3.prmpt_msg)                         AS  近三个月触发过精准贷后预警或处置类规则原因
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
LEFT JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03'  ) --01	处置1级, 02	处置2级, 03	预警类, 04	提示类
AND     T2.DT = '20250107'
LEFT JOIN    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd T3 --任务关联信号明细
ON      T2.btch_serno = T3.btch_serno
AND     T3.DT = '20250107'
WHERE   T1.DT = '20250107'
AND     SUBSTR(REPLACE(REPLACE(T2.tsk_gen_dt,'-',''),'/',''),1,8) >= '20241007'
GROUP BY T1.cst_id
;



--2.结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_JGB PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_DEPK_SJ2025010881_JGB AS
SELECT  A1.数据日期
        ,A1.客户号
        ,A1.客户名称
        ,A1.客户类型
        ,A1.同一风险控制号
        ,A1.所属分行
        ,A1.所属支行编号
        ,A1.所属支行
        ,A1.管户机构号
        ,A1.管户机构名称
        ,A1.管户客户经理
        ,A1.管户客户经理名称
        ,A1.客户经营性贷款汇总合同金额
        ,A1.客户经营性贷款汇总金额分层
        ,A1.经营性贷款到期时间
        ,A1.征信分
        ,A1.风险关注_仅供参考
        ,A1.他行融资家数
        ,A1.是否配卡
        ,A1.是否本人配卡
        ,A2.IDT_CD      AS 行业类型代码
        ,A3.cd_val_dscr AS 行业类型
        ,CASE
           WHEN A21.com_order_id RLIKE A1.管户客户经理 OR A21.com_vindicate_id RLIKE A1.管户客户经理 THEN '是'
           ELSE '否'
         END            AS 是否社区
        ,CASE
           WHEN A2.REG_ADR RLIKE '舟山' THEN '是'
           ELSE '否'
         END            AS 是否舟山本地人
        ,A4.ast_lbl_rat AS 资产负债率
        ,A5.担保方式
        ,A5.合同号_配偶是否纳入担保
        ,A6.销售开始日期
        ,A6.销售结束日期
        ,A6.销售额
        ,A7.当前融资总敞口
        ,A4.net_ast     AS 净资产
        ,A8.存款近6个月日均
        ,A7.经营性负债金额
        ,A9.预评估是否异常
        ,A9.预评估禁止数量
        ,A10.模型分
        ,A11.中证评分       AS 当前征信分
        ,A12.中证评分       AS 三个月前征信分
        ,A13.近三个月贷款审批查询机构数
        ,A13.近六个月贷款审批查询机构数
        ,A10.风险等级       AS 当前风险等级
        ,A14.近三个月是否触发过精准贷后预警或处置类规则
        ,A14.近三个月触发过精准贷后预警或处置类规则原因
FROM    lab_bigdata_dev.tmp_DEPK_SJ2025010881_01 A1
LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
ON      A1.客户号 = A2.CST_ID
AND     A2.DT = '20250107'
LEFT JOIN    edw.xwdt_xw_community A21 --社区信息表
ON      A2.SUB_CMNT_ID = A21.com_code
AND     A21.DT = '20250107'
LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表
ON      A2.IDT_CD = A3.cd_val
AND     A3.tbl_nm = 'DWS_CST_BAS_INF_DD'
AND     A3.fld_nm = 'IDT_CD'
AND     A3.DT = '20250107'
LEFT JOIN    edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd A4 --信贷客户资产负债概况
ON      A1.客户号 = A4.cst_id
AND     A4.DT = '20250107'
LEFT JOIN    (
                 SELECT  T1.客户号
                         ,WM_CONCAT(DISTINCT '||', T1.担保方式) AS 担保方式
                         ,WM_CONCAT(DISTINCT '||', CONCAT(T1.ctr_serno, T1.配偶是否纳入担保)) 合同号_配偶是否纳入担保
                 FROM    lab_bigdata_dev.tmp_DEPK_SJ2025010881_04 T1
                 GROUP BY T1.客户号
             ) A5
ON      A1.客户号 = A5.客户号
LEFT JOIN    (
                 SELECT  cst_id
                         ,bgn_dt                                                              AS 销售开始日期
                         ,end_dt                                                              AS 销售结束日期
                         ,sal_amt                                                             AS 销售额
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY last_upd_tm DESC ) AS RN
                 FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd --信贷客户经营信息销售额及净利润信息
                 WHERE   DT = '20250107'
             ) A6
ON      A1.客户号 = A6.cst_id
AND     A6.RN = 1
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,SUM(T1.ctr_amt) AS 当前融资总敞口
                         ,SUM(CASE
                                WHEN T1.客户类型 = 1 AND pd_cd IN ( '41' , '42' , '52' ) THEN T1.ctr_bal
                                WHEN T1.客户类型 = 2                                     THEN T1.ctr_bal
                                ELSE 0
                              END)        AS 经营性负债金额
                 FROM    lab_bigdata_dev.tmp_DEPK_SJ2025010881_05 T1
                 WHERE   T1.RN = 1
                 GROUP BY T1.cst_id
             ) A7
ON      A1.客户号 = A7.cst_id
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,SUM(last_180_days_gl_bal_acml) / 180 AS 存款近6个月日均
                 FROM    edw.dws_bus_dep_act_inf_dd T1
                 WHERE   T1.DT = '20250107'
                 GROUP BY T1.cst_id
             ) A8
ON      A1.客户号 = A8.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_06 A9
ON      A1.客户号 = A9.客户号
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_02 A10
ON      A1.客户号 = A10.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_zxf1 A11
ON      A1.客户号 = A11.cst_id
AND     A11.RK = 1
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_zxf2 A12
ON      A1.客户号 = A12.cst_id
AND     A12.RK = 1
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_07 A13
ON      A1.客户号 = A13.客户号
LEFT JOIN    lab_bigdata_dev.tmp_DEPK_SJ2025010881_08 A14
ON      A1.客户号 = A14.客户号
;
**01-数据需求_分行_D0109_林珍敏_监管投诉_短信.sql
-- SJ2025010946


-- 客户逾期，我行诉讼该客户，客户的房子被我行拍卖，借款人配偶投诉到银监，银监来查我们该笔的业务流程

-- 客户潘天宋，手机号码13738635186在2019.03.01-2025.01.01期间
-- 我行对客户电话通知内容、电话状态、客户名字、电话拨打时间、电话接通状态、电话小结单、短信发送时间、短信内容、短信发送状态、提交时间、发送时间、发送耗时、时效、发送通道、发送结果、状态码描述

-- 20180730-20220101：数仓edw.dxpt_gsms_msg_ticket_sms
-- 20220101-20221117：短信平台玄武，无信用卡短信
--20230713-至今：edw.ncrd_smscontent  --银数短信,逾期短信通过银数发
-- 20221117-至今4天前：数仓edw.nsms_gsms_msg_ticket_sms

SELECT  A1.phone        AS 手机号
        ,A1.post_time   AS 发送时间
        ,A1.sms_content AS 短信发送内容
        ,CASE
           WHEN A1.state = '1' THEN '成功'
           WHEN A1.state = '7' THEN '失败'
           WHEN A1.state = '0' THEN '待发送'
         END            AS 发送状态
FROM    edw.nsms_gsms_msg_ticket_sms A1 --20221109-至今4天前：数仓
WHERE   A1.DT >= '20221109'
-- AND     A1.sms_content RLIKE '金融信用信息基础数据库'
AND     numbers = '0' --0是整段短信
and A1.phone='13738635186'
AND     REPLACE(substr(A1.post_time, 1, 10), '-', '') >= '20230101';



SELECT  A1.mbl_nbr AS 手机号
        ,substr(A1.sms_snd_tm,1,8) as 发送时间
        ,A1.sms_snd_cntnt as  短信发送内容
FROM    edw.ncrd_smscontent A1 --20230713-至今,银数短信,逾期短信通过银数发
WHERE   A1.DT >= '20230713'
AND    A1.sms_snd_cntnt RLIKE '征信'
;
**01-数据需求_分行_D0109_林蓉云_客户短信数据提取.sql
-- SJ2025010946


-- 客户逾期，我行诉讼该客户，客户的房子被我行拍卖，借款人配偶投诉到银监，银监来查我们该笔的业务流程

-- 客户潘天宋，手机号码13738635186在2019.03.01-2025.01.01期间
-- 我行对客户电话通知内容、电话状态、客户名字、电话拨打时间、电话接通状态、电话小结单、短信发送时间、短信内容、短信发送状态、提交时间、发送时间、发送耗时、时效、发送通道、发送结果、状态码描述

-- 20180730-20220101：数仓edw.dxpt_gsms_msg_ticket_sms
-- 20220101-20221117：短信平台玄武，无信用卡短信
--20230713-至今：edw.ncrd_smscontent  --银数短信,逾期短信通过银数发
-- 20221117-至今4天前：数仓edw.nsms_gsms_msg_ticket_sms


-- 最后需要字段：手机号码、姓名、短信内容、提交时间、发送时间、发送耗时、时效、发送通道、发送结果、状态码描述



DROP TABLE IF EXISTS tmp_SJ2025010946_dx PURGE;
CREATE TABLE IF NOT EXISTS tmp_SJ2025010946_dx as
SELECT  A1.phone                                                                                                                                                      AS 手机号
        ,'潘天宋'                                                                                                                                                        AS 姓名
        ,A1.sms_content                                                                                                                                               AS 短信内容
        ,to_char(A1.post_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                                 AS 提交时间
        ,to_char(A1.submit_resp_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                          AS 发送时间
        ,DATEDIFF(to_char(A1.submit_resp_time, 'yyyy-mm-dd hh:mm:ss'), to_char(A1.post_time, 'yyyy-mm-dd hh:mm:ss'), 'ss')                                            AS 发送时效
        ,CASE
           WHEN A1.state = '1' THEN '成功'
           WHEN A1.state = '7' THEN '失败'
           WHEN A1.state = '0' THEN '待发送'
         END                                                                                                                                                          AS 发送结果
        ,A1.spec_number                                                                                                                                               AS 发送端口
        ,A2.result
        ,A2.origin_result
        ,decode(A2.origin_result,'MI:0013', '停机', 'MI:0029', '关机', 'MK:0001', '空号', 'MK:0011', '停机', 'MK:0013', '手机终端问题', 'MK:0029', '用户关机，无法接通','DELIVRD', '', NULL, '') AS 号码状态
FROM    edw.nsms_gsms_msg_ticket_sms A1 --20221109-至今4天前：数仓,最早日期20221109
LEFT JOIN    edw.nsms_gsms_statereport A2 ---存放状态报告信息,最早日期20221109
ON      A1.msg_id = A2.msg_id
AND     A1.dt = A2.dt
AND     A2.dt >= '20221109'
WHERE   A1.DT >= '20221109'
AND     numbers = '0' --0是整段短信
AND     A1.phone = '13738635186'
UNION ALL
SELECT  T2.phone                                                                                                                                                      AS 手机号
        ,'潘天宋'                                                                                                                                                        AS 姓名
        ,T2.sms_content                                                                                                                                               AS 短信内容
        ,to_char(T2.post_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                                 AS 提交时间
        ,to_char(T2.submit_resp_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                          AS 发送时间
        ,DATEDIFF(to_char(T2.submit_resp_time, 'yyyy-mm-dd hh:mm:ss'), to_char(T2.post_time, 'yyyy-mm-dd hh:mm:ss'), 'ss')                                            AS 发送时效
        ,CASE
           WHEN T2.state = '1' THEN '成功'
           WHEN T2.state = '7' THEN '失败'
           WHEN T2.state = '0' THEN '待发送'
         END                                                                                                                                                          AS 发送结果
        ,T2.spec_number                                                                                                                                               AS 发送端口
        ,A2.result
        ,A2.origin_result
        ,decode(A2.origin_result,'MI:0013', '停机', 'MI:0029', '关机', 'MK:0001', '空号', 'MK:0011', '停机', 'MK:0013', '手机终端问题', 'MK:0029', '用户关机，无法接通','DELIVRD', '', NULL, '') AS 号码状态
FROM    edw.dxpt_gsms_msg_ticket_sms T2 --20180730-20220101,最早20190926，最晚20221211
LEFT JOIN    edw.nsms_gsms_statereport A2 ---存放状态报告信息,最早日期20221109
ON      T2.msg_id = A2.msg_id
AND     A2.dt >= '20221109'
AND     A2.dt = T2.dt
WHERE   T2.dt <= '20221211'
AND     T2.phone = '13738635186'
AND     T2.number = '0' --整段
;



-- --短信记录为空,可以不用看这张表。
-- SELECT mbl_nbr  as 手机号
--       ,sms_snd_tm  as 发送时间
--       ,sms_snd_cntnt as 短息内容
-- FROM edw.ncrd_smscontent    --20230713至今
-- WHERE dt>='20230713'
-- and mbl_nbr= '13738635186'
**01-数据需求_分行_D0211_台州分行_李友德_冠字号信息查询.sql
--转运维 刘振，开发联系 赵佳明
-- SJ2025021046
-- 20240626当日玉环沙门支行冠字号数据信息，客户陈金苏，证件号332627195511302785于2024年6月26日办理定期账号33010870107000002329的子户增存4100三年业和，
-- 现客户对此有异议，需调取当天的冠字号数据，冠字号系统及点钞机U盘数据已被覆盖
--330108781   ---玉环沙门小微企业专营支行服务中心

SELECT  dt,count(*)
FROM    edw.gzhs_cml_sent_infos_day -- --纸币冠字号码日表,增量表
WHERE   dt <='20240627' and  dt >='20240501'  group by dt ORDER BY dt ASC

--经查询，无数据
SELECT  c_term_id 终端编号
        ,c_seria_no  纸币冠字号码
        ,c_tran_date 交易时间
FROM    edw.gzhs_cml_sent_infos_day -- --纸币冠字号码日表,增量表
WHERE   dt ='20240626'
-- AND     c_tran_date > '20240626150000'
-- AND     c_tran_date < '20240626153500'
AND     c_pathcode IN (
                          SELECT  c_pathcode
                          FROM    edw.gzhs_org_info --机构
                          WHERE   dt = '20240626'
                          AND     c_orgcode = '330108700' --玉环沙门小微企业专营支行
)
AND     c_machine_type = '3'
;

--330108781   ---玉环沙门小微企业专营支行服务中心




DROP TABLE IF EXISTS tmp_sjxq_guanzihaochaxun PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_guanzihaochaxun AS
SELECT  c_term_id 终端编号
        ,c_seria_no 纸币冠字号码
        ,c_tran_date 交易时间
FROM    edw.gzhs_cml_sent_infos_day -- --纸币冠字号码日表,增量表
WHERE   dt = '20240626'
-- AND     c_tran_date > '20240626150000'
-- AND     c_tran_date < '20240626153500'
AND     c_pathcode IN (
                          SELECT  c_pathcode
                          FROM    edw.gzhs_org_info --机构
                          WHERE   dt = '20240626'
                          AND     c_orgcode = '330108700' --玉环沙门小微企业专营支行
                      )
AND     c_machine_type = '3';
**01-数据需求_分行_D0508_金华分行_胡静婕_21_23年综合积分.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 卫少洁
-- 创建日期: 2024-05-08 16:57:08
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************

-- --1-出账就是积分消费(D)
-- DROP TABLE IF EXISTS lab_bigdata_dev.jffh_wss0814_01 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.jffh_wss0814_01 AS
-- SELECT  --T2.prm_org_id 管户机构号
--         --,T2.prm_org_nm 管户机构
--         --,T1.CST_ID 客户号
--         --,T2.cst_nm 客户姓名
--         substr(T1.trx_dt,1,4) 年份
--         --,coalesce(T3.cd_val_dscr,T1.trx_chnl_cd) 兑换渠道
--         ,sum(T1.PNT_NBR_AMT) 兑换积分值
--         -- ,t1.CRD_AND_DBT_IND  借贷标志
--         -- ,CASE
--         --    WHEN t1.RVS_IND = '0' AND t1.CRD_AND_DBT_IND = 'D'  THEN t1.PNT_NBR_AMT
--         --    WHEN t1.RVS_IND <> '0' AND t1.CRD_AND_DBT_IND = 'C' THEN - t1.PNT_NBR_AMT
--         --    ELSE 0
--         --  END 产生积分值
--         --,T1.smr_dscr 摘要描述
-- FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI T1 --积分交易明细
-- LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息
-- ON      T1.cst_id = T2.cst_id
-- AND     T2.dt = '20231231'
-- -- LEFT JOIN    edw.dwd_code_library_dd T3
-- -- ON      T1.trx_chnl_cd = T3.cd_val
-- -- AND     T3.dt = '20231231'
-- -- AND     T3.fld_nm = 'TRX_CHNL_CD'
-- -- AND     T3.tbl_nm = 'DWD_BUS_CMPN_PNT_TRX_DTL_DI'
-- WHERE   T1.DT >= '20210101'
-- AND     T1.DT <= '20231231'
-- AND     T1.PNT_TYP_CD = '0001' --综合积分
-- AND     T1.RVS_IND = '0'
-- AND     T1.TRX_STS_CD = '1'
-- AND     T1.CRD_AND_DBT_IND = 'D'
-- AND     T1.TRX_TYP_CD = '1001' --积分消费
-- AND     T2.prm_org_id LIKE '3308%' --金华分行
-- GROUP BY  substr(T1.trx_dt,1,4)
-- ;

-- SELECT  sum(兑换积分值) FROM lab_bigdata_dev.jffh_wss0814_01  WHERE substr(兑换日期,1,4)='2021';


-- ---2,入账就是积分产生(C)

-- DROP TABLE IF EXISTS lab_bigdata_dev.jffh_wss0814_02 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.jffh_wss0814_02 AS
-- SELECT  --T2.prm_org_id 管户机构号
--         --,T2.prm_org_nm 管户机构
--         --,T1.CST_ID 客户号
--         --,T2.cst_nm 客户姓名
--         substr(T1.trx_dt,1,4) 年份
--         --,coalesce(T3.cd_val_dscr,T1.trx_chnl_cd) 交易渠道
--         ,sum(T1.PNT_NBR_AMT) 积分产生值
--         -- ,t1.CRD_AND_DBT_IND  借贷标志
--         -- ,CASE
--         --    WHEN t1.RVS_IND = '0' AND t1.CRD_AND_DBT_IND = 'D'  THEN t1.PNT_NBR_AMT   --积分兑换
--         --    WHEN t1.RVS_IND <> '0' AND t1.CRD_AND_DBT_IND = 'C' THEN - t1.PNT_NBR_AMT  --积分产生
--         --    ELSE 0
--         --  END 产生积分值
--         --,T1.smr_dscr 摘要描述
-- FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI T1 --积分交易明细
-- LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息
-- ON      T1.cst_id = T2.cst_id
-- AND     T2.dt = '20231231'
-- LEFT JOIN    edw.dwd_code_library_dd T3
-- ON      T1.trx_chnl_cd = T3.cd_val
-- AND     T3.dt = '20231231'
-- AND     T3.fld_nm = 'TRX_CHNL_CD'
-- AND     T3.tbl_nm = 'DWD_BUS_CMPN_PNT_TRX_DTL_DI'
-- WHERE   T1.DT >= '20210101'
-- AND     T1.DT <= '20231231'
-- AND     T1.PNT_TYP_CD = '0001' --综合积分
-- AND     T1.RVS_IND = '0'
-- AND     T1.TRX_STS_CD = '1'
-- AND     T1.CRD_AND_DBT_IND = 'C'
-- --AND     T1.TRX_TYP_CD = '1001' --积分消费
-- AND     T1.trx_typ_cd not in ('0003','0001','0042','0064','0071','0074','0029')   --剔除存款基础积分和信用卡积分
-- AND     T2.prm_org_id LIKE '3308%' --金华分行
-- GROUP BY substr(T1.trx_dt,1,4)
-- ;


-- SELECT sum(积分产生值) from lab_bigdata_dev.jffh_wss0814_02 WHERE substr(交易日期,1,4)='2022'


--最终 ****************************************************************************************************************
--1-积分产生
SELECT
       SUBSTR(trx_dt,1,4)    AS 年份
        ,sum(T1.PNT_NBR_AMT)/10000/100 积分价值_万元
FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI T1 --积分交易明细
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20231231'
WHERE   T1.DT >= '20210101'
AND     T1.DT <= '20231231'
AND     T1.PNT_TYP_CD = '0001' --综合积分
AND     T1.RVS_IND = '0'  --冲正标志正常
AND     T1.TRX_STS_CD = '1'   --交易状态成功
AND     T1.CRD_AND_DBT_IND = 'C'   --借贷标识：借
AND     T1.trx_typ_cd not in ('0003','0001','0042','0064','0071','0074','0029')   --剔除部分
AND     T2.prm_org_id LIKE '3308%' --金华分行
GROUP BY SUBSTR(trx_dt,1,4)
;

-- 年份	积分价值_万元
-- 2021	628.03040346
-- 2022	860.25673197
-- 2023	1084.25896433




--2-积分使用

SELECT
        SUBSTR(trx_dt,1,4)    AS 年份
        ,sum(T1.PNT_NBR_AMT) / 10000 / 100 AS 积分使用_万元
FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI T1 --积分交易明细
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20231231'
WHERE   T1.DT >= '20210101'
AND     T1.DT <= '20231231'
AND     T1.PNT_TYP_CD = '0001' --综合积分
AND     T1.RVS_IND = '0'  --冲正标志正常
AND     T1.TRX_STS_CD = '1'  --交易状态成功
AND     T1.CRD_AND_DBT_IND = 'D'  --借贷标识：贷
AND     T1.TRX_TYP_CD = '1001' --积分消费
--AND     T1.trx_typ_cd not in ('0003','0001','0042','0064','0071','0074','0029')   --剔除部分
AND     T2.prm_org_id LIKE '3308%' --金华分行
GROUP BY  SUBSTR(trx_dt,1,4)
;

-- 年份	积分使用_万元
-- 2021	858.907118
-- 2022	972.861407
-- 2023	1015.891208
**01-数据需求_分行_D0516_嘉兴分行_余舟_联系方式.sql
--针对在我分行购买贵金属和保险的客户，由分行对总行未回访的客户进行回访，故需要科技同事补充清单中的客户手机号码

--71个企业无客户号，1个客户号待补充

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024051522 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024051522 AS
SELECT  p.COL_1 交易日期
        ,p.COL_2 客户号
        ,p.COL_3 姓名
        ,p.COL_4 产品类型
        ,p.COL_5 产品名称
        ,p.COL_6 金额
        ,p.COL_7 所属机构
        ,p.COL_8 推荐人
        ,p.COL_9 总行已回访
        ,p.COL_10 是否风险清单
        ,p.COL_11 回访情况
        ,p1.hand_phone_no 手机号码
        ,p1.corp_phone_no 单位电话
FROM    qbi_file_20240516_19_36_57 p
LEFT JOIN    adm_upss.l_cust_contact p1 --客户联系信息
ON      p.COL_2 = p1.cust_id
AND     p1.dt = '@@{yyyyMMdd}'
WHERE   p.pt = MAX_PT('qbi_file_20240516_19_36_57')
;

--SELECT * FROM lab_bigdata_dev.tmp_sjxq_SJ2024051522 WHERE 电话号码 is not null
**01-数据需求_分行_D0520_嘉兴分行_张依宁_嘉兴分行首笔发放业务数据.sql
-- &quot;首笔准入时：客户征信分&quot;	&quot;首笔准入时：客户年龄&quot;	&quot;首笔准入时:客户资产负债率&quot;	&quot;首笔准入时:他行授信总额&quot;	&quot;预评估结果（通过/上诉通过/抗辩通过）&quot;
-- 预评估拦截（上诉或抗辩）具体原因	&quot;首笔发放三个月后同一客户号下的合同笔数&quot;	&quot;首笔发放三个月后同一客户号下的合同金额&quot;
-- 实地调查地址类型（经营地/居住地）	调查参与人工号	调查人员名称	调查人员中管理者工号	调查人员中管理者名称


-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_01;

-- CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_01
-- (
  -- 合同流水号	  STRING
  -- ,借据流水号	  STRING
  -- ,分行	          STRING
  -- ,管户机构号	  STRING
  -- ,管户机构	      STRING
  -- ,核心客户编号	  STRING
  -- ,客户名称	      STRING
  -- ,业务标识	      STRING
  -- ,出险日期       STRING
-- )  ;



--临时表1 附件客户首次准入日期
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02;

CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 AS
SELECT  T1.核心客户编号
        ,T2.首笔准入日期
        ,T2.busi_ctr_id   AS 首笔合同号
FROM    (
            SELECT  DISTINCT 核心客户编号
            FROM    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_01
        ) T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,CASE WHEN A1.hpn_dt <>'18991231' THEN A1.hpn_dt ELSE  A1.apnt_start_dt END AS 首笔准入日期
                         ,A1.busi_ctr_id
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY CASE WHEN A1.hpn_dt <>'18991231' THEN A1.hpn_dt ELSE  A1.apnt_start_dt END ) AS RN
                 FROM    edw.dim_bus_loan_ctr_inf_dd A1 --信贷合同信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
             ) T2
ON      T1.核心客户编号 = T2.cst_id
AND     T2.RN = 1;

--临时表2 首次准入时征信信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_03 AS
SELECT  T1.cst_id
        ,T1.report_id
        ,SUM(T1.ctr_bal) AS 贷款总余额
        ,SUm(T1.ctr_amt) AS 授信总额
FROM    (
            SELECT  A1.cst_id
                    ,A1.report_id
                    ,A1.ctr_bal
                    ,A1.ctr_amt
                    ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY SUBSTR(A1.report_id, 1, 8) DESC ) AS RN
            FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
            INNER JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 A2
            ON      A1.cst_id = A2.核心客户编号
            AND     SUBSTR(A1.report_id, 1, 8) <= A2.首笔准入日期
            WHERE   A1.DT = '@@{yyyyMMdd}'
            AND     A1.dtrb_org <> 'ZJTLCB' --发放机构不为泰隆
            AND     A1.cls_dt >= '@@{yyyyMMdd}' --未关闭
            AND     A1.pd_cd IN ( '11' , '12' , '13' , '21' , '31' , '32' , '33' , '41' , '51' , '52' , '53' , '91' , '99' ) --业务品种贷款
            AND     LENGTH(NVL(A1.cst_id, '')) > 0
        ) T1
WHERE   T1.RN = 1
GROUP BY T1.cst_id , T1.report_id
UNION ALL
SELECT  T1.cst_id
        ,T1.report_id
        ,SUM(T1.loan_bal) AS 贷款总余额
        ,SUm(T1.loan_amt) AS 授信总额
FROM    (
            SELECT  A1.cst_id
                    ,A1.report_id
                    ,A1.loan_bal
                    ,A1.loan_amt
                    ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY SUBSTR(A1.report_id, 1, 8) DESC ) AS RN
            FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
            INNER JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 A2
            ON      A1.cst_id = A2.核心客户编号
            AND     SUBSTR(A1.report_id, 1, 8) <= A2.首笔准入日期
            WHERE   A1.DT = '@@{yyyyMMdd}'
            AND     A1.dtrb_org_typ_cd <> '' --排除发放机构为泰隆
            AND     A1.cls_dt >= '@@{yyyyMMdd}' --未关闭
            AND     A1.bus_pd_cls_cd = '11' --业务产品种类代码贷款
            AND     LENGTH(NVL(A1.cst_id, '')) > 0
        ) T1
WHERE   T1.RN = 1
GROUP BY T1.cst_id , T1.report_id;


--临时表3 首次准入时预评估信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_05 AS
SELECT  T1.核心客户编号
        ,T1.抗辩上诉理由
        ,T1.预评估结果
        ,T1.预评估日期
        ,T1.预评估拦截原因
FROM    (
            SELECT  A1.核心客户编号
                    ,A4.抗辩上诉理由
                    ,A5.预评估拦截原因
                    ,A2.reg_tm                                                                              AS 预评估日期
                    ,A2.PRE_ASES_SRL_NBR
                    ,A3.cd_val_dscr                                                                         AS 预评估结果
                    ,ROW_NUMBER() OVER ( PARTITION BY A1.核心客户编号 ORDER BY A2.reg_tm DESC , A2.SRL_NBR DESC ) AS RN
            FROM    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 A1
            LEFT JOIN    edw.dwd_bus_loan_pre_ases_rsl_dd A2 --预评估最终结果信息
            ON      A1.核心客户编号 = A2.cst_id
            AND     A1.首笔准入日期 >= SUBSTR(REPLACE(A2.reg_tm, '/', ''), 1, 8)
            AND     SUBSTR(A2.pre_ases_rsl, 1, 2) = '10' --通过/上诉通过/抗辩通过
            AND     A2.DT = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表
            ON      A2.pre_ases_rsl = A3.cd_val
            AND     A3.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'
            AND     A3.fld_nm = 'PREEVALUATERESULT'
            AND     A3.dt = '@@{yyyyMMdd}'
            LEFT JOIN    (
                             SELECT  applyserialno
                                     ,WM_CONCAT(DISTINCT '||', opinion) AS 抗辩上诉理由
                             FROM    edw.loan_defend_opinion --预评估抗辩意见
                             WHERE   COALESCE(opinion, '') <> ''
                             AND     opiniontype IN ( '1' , '4' ) --抗辩理由,重新提交理由
                             AND     DT = '@@{yyyyMMdd}'
                             GROUP BY applyserialno
                         ) A4
            ON      A2.PRE_ASES_SRL_NBR = A4.applyserialno
            LEFT JOIN    (
                             SELECT  apl_srl_nbr
                                     ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 预评估拦截原因
                             FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                             WHERE   DT = '@@{yyyyMMdd}'
                             AND     COALESCE(sgs_inf, '') <> ''
                             AND     COALESCE(sgs_inf, '') <> '查询成功'
                             GROUP BY apl_srl_nbr
                         ) A5
            ON      A2.PRE_ASES_SRL_NBR = A5.apl_srl_nbr
        ) T1
WHERE   T1.RN = 1;


--临时表4 首笔发放三个月后合同信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_06 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_06 AS
SELECT  T1.核心客户编号
        ,COUNT(1)        AS 首笔发放三个月后同一客户号下的合同笔数
        ,SUM(T2.ctr_amt) AS 首笔发放三个月后同一客户号下的合同金额
FROM    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 T1
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd T2 --信贷合同信息
ON      T1.核心客户编号 = T2.cst_id
--AND    ( T2.hpn_dt <= T2.dt AND T2.apnt_mtu_dt >= T2.dt AND T2.end_dt = '18991231' ) --限制合同未结清
AND     T2.DT = TO_CHAR(DATEADD(TO_DATE(T1.首笔准入日期, 'YYYYMMDD'), 3, 'MM'), 'YYYYMMDD')
GROUP BY T1.核心客户编号
;


--临时表5 首笔贷款信贷调查信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_07 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_07 AS
SELECT    T1.核心客户编号
          ,t4.cd_val_dscr AS 实地调查地址类型
          ,t3.svy_ppl_id  AS 调查参与人工号
          ,t3.svy_ppl_nm  AS 调查人员名称
          ,T6.调查人员中管理者工号
          ,T6.调查人员中管理者名称
FROM    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 t1
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd t2
ON      t1.首笔合同号 = t2.busi_ctr_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_asst_crd_cst_svy_inf_dd AS t3 --信贷客户调查信息
ON      t2.busi_apl_id = t3.obj_id
AND     t2.cst_id = t3.cst_id
AND     t3.dt = '@@{yyyyMMdd}'
AND     t3.svy_typ_cd = '010' --010,客户调查,020侧面打听记录,030,法院、税务、工商及相关网站查询
LEFT JOIN    edw.dwd_code_library_dd t4 --码值表
ON      t3.svy_act_typ_cd = t4.cd_val
AND     t4.tbl_nm = 'DWD_CST_ASST_CRD_CST_SVY_INF_DD'
AND     t4.fld_nm = 'SVY_ACT_TYP_CD'
AND     t4.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  DISTINCT t1.obj_id
                                  ,T2.empe_id AS 调查人员中管理者工号
                                  ,T2.empe_nm AS 调查人员中管理者名称
                 FROM    (
                             SELECT  DISTINCT t1.obj_id
                                              ,emp_id
                                              ,REGEXP_REPLACE(t1.svy_tm, '/', '') AS surdate
                             FROM    edw.dwd_cst_asst_crd_cst_svy_inf_dd AS t1 --信贷客户调查信息
                                    LATERAL VIEW EXPLODE(SPLIT(t1.svy_ppl_id, '、')) test_emp_id AS emp_id  --将一行拆成多行
                             WHERE   t1.dt = '@@{yyyyMMdd}'
                             AND     t1.obj_typ = 'CreditApply'
                         ) AS t1
                 INNER JOIN    edw.dws_hr_empe_inf_dd AS t2 --员工汇总信息
                 ON      t1.emp_id = t2.empe_id
                 AND     t1.surdate = t2.dt
                 INNER JOIN    edw.dim_hr_org_job_inf_dd AS t3 --职位信息
                 ON      t2.pos_enc = t3.pos_id
                 AND     t1.surdate = t3.dt
                 WHERE   t3.pos_nm IN ( '业务团队正职' , '业务团队副职' , '支行班子正职' , '支行班子副职' )
             ) AS t6
ON      t2.busi_apl_id = t6.obj_id;



--------------------------------------------
--------------------------------------------
--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_08;

CREATE TABLE lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_08 AS
SELECT  DISTINCT T1.合同流水号
                 ,T1.借据流水号
                 ,T1.分行
                 ,T1.管户机构号
                 ,T1.管户机构
                 ,T1.核心客户编号
                 ,T1.客户名称
                 ,T1.业务标识
                 ,T1.出险日期
                 ,T4.idv_crd_sco_val                                                               AS 首笔准入时客户征信分
                 ,DATEDIFF(TO_DATE(T0.首笔准入日期, 'YYYYMMDD'), TO_DATE(T6.bth_dt, 'YYYYMMDD'), 'YYYY') AS 首笔准入时客户年龄
                 ,T5.首笔准入时客户资产负债率
                 ,T2.授信总额                                                                          AS 首笔准入时他行授信总额
                 ,T7.预评估结果                                                                         AS 首笔准入时预评估结果
                 ,T7.抗辩上诉理由                                                                        AS 首笔准入时抗辩上诉理由
                 ,T7.预评估拦截原因                                                                       AS 首笔准入时预评估拦截原因
                 ,T8.首笔发放三个月后同一客户号下的合同笔数
                 ,T8.首笔发放三个月后同一客户号下的合同金额
                 ,T9.实地调查地址类型
                 ,T9.调查参与人工号
                 ,T9.调查人员名称
                 ,T9.调查人员中管理者工号
                 ,T9.调查人员中管理者名称
FROM    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_01 T1
LEFT JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 T0
ON      T1.核心客户编号 = T0.核心客户编号
LEFT JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_03 T2
ON      T1.核心客户编号 = T2.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T4 --个人征信指标信息表
ON      T1.核心客户编号 = T4.cst_id
AND     T2.report_id = T4.report_no
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.核心客户编号
                         ,A2.ast_lbl_rto AS 首笔准入时客户资产负债率
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.核心客户编号 ORDER BY A2.rcd_dt DESC ) RN
                 FROM    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_02 A1
                 LEFT JOIN    edw.dwd_bus_loan_cst_ast_lbl_inf_dd A2 --客户资产概况
                 ON      A1.核心客户编号 = A2.cst_id
                 AND     A1.首笔准入日期 >= A2.rcd_dt
                 AND     A2.DT = '@@{yyyyMMdd}'
             ) T5
ON      T1.核心客户编号 = T5.核心客户编号
AND     T5.RN = 1
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T6 --个人客户基本信息汇总表
ON      T1.核心客户编号 = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_05 T7
ON      T1.核心客户编号 = T7.核心客户编号
LEFT JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_06 T8
ON      T1.核心客户编号 = T8.核心客户编号
LEFT JOIN    lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_07 T9
ON      T1.核心客户编号 = T9.核心客户编号;



SELECT * from lab_bigdata_dev.tmp_jiaxin_sbdk_20240530_08
**01-数据需求_分行_D0531_金华分行_胡静婕_头寸管理统计单日存在资金大额流出情形的客户.sql
-- 用于头寸管理，统计单日存在资金大额流出情形的客户

-- 截止日期：2024年5月30日
-- 数据范围：金华分行曾单日资金流出累计超2亿元的客户（不考虑流入）

--字段：当前管护机构、当前管护人、客户号、客户名称、资金流出日期、资金流出金额
**01-数据需求_分行_D0702杭州分行_周方锴_用于内部管理排查_copy.sql
-- 2023年1月-2024年6月期间杭州分行申请的业务（剔除3302004萧山支行业务），在业务申请的前后一个月内，被萧山支行客户经理在信贷系统-快速统计查询-个人/对公客户信息查询这边查询了客户。
--字段：业务申请流水号，客户名称，客户编号，查询人

-- SELECT * FROM tmp_zfk_SJ20240702121_f;


DROP TABLE IF EXISTS tmp_zfk_SJ20240702121_f PURGE ;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ20240702121_f AS
SELECT  DISTINCT T1 . *
                 ,T2.业务申请流水号
                 ,T2.业务发生时间
FROM    (
            SELECT  T.queryuserid 查询人工号
                    ,T.querydate 查询日期
                    ,T.querytime 查询时间
                    ,CASE
                       WHEN T.querytype = '010'              THEN '客户详情查看'
                       WHEN T.querytype = '020'              THEN '客户风险提示查询'
                       WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
                       WHEN T.querytype = '040'              THEN '客户账户查询'
                       WHEN T.querytype = '050'              THEN '客户影像查询'
                       WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
                     END           AS 查询类型
                    ,T.objectno 查询客户号
                    ,T.objectname 查询客户名称
                    ,t2.org_nm 被查询客户管护机构
                    ,t2.sbr_org_nm AS 被查询客户管护支行
                    ,t3.empe_nm 被查询客户管护人
            FROM    edw.LOAN_QUERY_LOG T --信贷查询日志
            LEFT JOIN    edw.loan_customer_belong t1 --客户所属列表
            ON      T.objectno = T1.customerid
            AND     T1.dt = '@@{yyyyMMdd}'
            and    t1.belongattribute='1'     --当前主管护
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t2 --机构
            ON      t1.orgid = t2.org_id
            AND     t2.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dws_hr_empe_inf_dd t3 --员工汇总信息
            ON      t1.userid = t3.empe_id
            AND     t3.dt = '@@{yyyyMMdd}'
            WHERE   T.dt = '@@{yyyyMMdd}'
            AND     T.queryuserid IN ( '028961' , '025565' , '020210' , '020337' , '023581' , '028934' , '004103' , '020357' , '023555' , '010642' , '013838' , '018452' , '020352' , '025629' , '028935' , '029900' , '020147' , '013963' )
            AND     T.querydate BETWEEN '2022/12/01' AND '2024/07/31'
             AND     T.objectno NOT IN (
             SELECT  t1.customerid
             FROM    edw.loan_customer_belong t1 --客户所属列表
             WHERE   T1.dt = '@@{yyyyMMdd}'
             AND     t1.userid IN ( '028961' , '025565' , '020210' , '020337' , '023581' , '028934' , '004103' , '020357' , '023555' , '010642' , '013838' , '018452' , '020352' , '025629' , '028935' , '029900' , '020147' , '013963' )
             ) --剔除本人名下的管护客户
        ) T1  --23-24年萧山支行客户经理查询记录
INNER JOIN    (
                  SELECT  A1.customerid
                          ,A1.serialno  AS 业务申请流水号
                          ,A1.occurdate AS 业务发生时间
                  FROM    edw.loan_business_apply A1 --业务申请表
                  LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd A2 --机构树_考核维度
                  ON      A1.operateorgid = A2.org_id
                  AND     A2.dt = '@@{yyyyMMdd}'
                  WHERE   A1.dt = '@@{yyyyMMdd}'
                  AND     A1.occurdate BETWEEN '2023/01/01' AND '2024/06/30'
                  AND     A2.brc_org_nm = '杭州分行'
                  AND     A2.sbr_org_nm <> '杭州萧山支行'
              ) T2 -- 2023年1月-2024年6月期间杭州分行申请的业务（剔除3302004萧山支行业务）
ON      T1.查询客户号 = T2.customerid
AND     TO_CHAR(DATEADD(TO_DATE(REPLACE(T2.业务发生时间, '/', ''), 'YYYYMMDD'), '1', 'MM'), 'YYYYMMDD') >= REPLACE(T1.查询日期, '/', '') --查询日期在业务发生时间后一个月
AND     TO_CHAR(DATEADD(TO_DATE(REPLACE(T2.业务发生时间, '/', ''), 'YYYYMMDD'), '-1', 'MM'), 'YYYYMMDD') <= REPLACE(T1.查询日期, '/', '') --查询日期在业务发生时间前一个月
;


-- DROP TABLE IF EXISTS tmp_zfk_SJ20240702121 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_zfk_SJ20240702121 AS
-- SELECT   distinct
--          T1.customerid 客户号
--         ,T1.customername 客户名称
--         ,T1.serialno 业务申请流水号
--         ,T1.occurdate 业务发生日期
--         ,T2.查询日期
--         ,T2.查询时间
--         ,T1.operateorgid 机构号
--         ,T1.org_nm 机构名称
--         ,T2.查询人工号
--         ,t3.empe_nm 查询人姓名
-- FROM    (
--             SELECT  T2.customerid
--                     ,T2.customername
--                     ,T2.serialno
--                     ,T2.occurdate
--                     ,T3.org_nm
--                     ,T2.operateorgid
--             FROM    edw.loan_business_apply T2 --业务申请表
--             LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构
--             ON      T2.operateorgid = T3.org_id
--             AND     T3.dt = '@@{yyyyMMdd}'
--             WHERE   T2.dt = '@@{yyyyMMdd}'
--             AND     T2.occurdate BETWEEN '2023/01/01' AND '2024/06/30'
--             AND     T2.operateorgid LIKE '3302%' --杭州分行
--             AND     T2.operateorgid NOT LIKE '3302004%' --剔除萧山支行
--         ) T1 --杭州分行，剔除萧山支行的业务申请信息
-- left JOIN    (
--                   SELECT  T.queryuserid 查询人工号
--                           ,T.querydate 查询日期
--                           ,T.querytime 查询时间
--                           ,CASE
--                              WHEN T.querytype = '010'              THEN '客户详情查看'
--                              WHEN T.querytype = '020'              THEN '客户风险提示查询'
--                              WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
--                              WHEN T.querytype = '040'              THEN '客户账户查询'
--                              WHEN T.querytype = '050'              THEN '客户影像查询'
--                              WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
--                            END AS 查询类型
--                           ,T.objectno 查询客户号
--                           ,T.objectname 查询客户名称
--                   FROM    edw.LOAN_QUERY_LOG T --信贷查询日志
--                   LEFT JOIN    edw.loan_customer_belong t1 --客户所属列表
--                   ON      T.objectno = T1.customerid
--                   AND     T1.dt = '@@{yyyyMMdd}'
--                   WHERE   T.dt = '@@{yyyyMMdd}'
--                   AND     T.queryuserid IN ( '028961' , '025565' , '020210' , '020337' , '023581' , '028934' , '004103' , '020357' , '023555' , '010642' , '013838' , '018452' , '020352' , '025629' , '028935' , '029900' , '020147' , '013963' )
--                   AND     T.querydate BETWEEN '2023/01/01' AND '2024/06/30'
--                   AND     T.objectno NOT IN (
--                                                 SELECT  t1.customerid
--                                                 FROM    edw.loan_customer_belong t1 --客户所属列表
--                                                 WHERE   T1.dt = '@@{yyyyMMdd}'
--                                                 AND     t1.userid IN ( '028961' , '025565' , '020210' , '020337' , '023581' , '028934' , '004103' , '020357' , '023555' , '010642' , '013838' , '018452' , '020352' , '025629' , '028935' , '029900' , '020147' , '013963' )
--                                             )
--               ) T2  --客户经理查询的其他客户，剔除本人名下的管护客户
-- ON      T1.customerid = T2.查询客户号
-- LEFT JOIN    edw.dws_hr_empe_inf_dd t3 --员工汇总信息
-- ON      t2.查询人工号 = t3.empe_id
-- AND     t3.dt = '@@{yyyyMMdd}'
-- -- where abs(datediff(TO_DATE(occurdate,'yyyymmdd'),TO_DATE(查询日期,'yyyymmdd'),'mm'))=1
-- ;
**01-数据需求_分行_D0704杭州分行_周方锴_用于内部管理排查.sql
-- 2023年1月起至2024年6月30日，客户经理016204在信贷系统-快速统计查询-客户信息快速查询-对公/个人客户信息查询模块，查询了非其管护的客户信息的记录
--	客户名称/客户编号/查询时间/被查询客户管护机构/被查询客户管护人

DROP TABLE IF EXISTS tmp_zfk_SJ20240703101 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ20240703101 AS
SELECT  T.queryuserid 查询人工号
        ,T.querydate 查询日期
        ,T.querytime 查询时间
        ,CASE
           WHEN T.querytype = '010'              THEN '客户详情查看'
           WHEN T.querytype = '020'              THEN '客户风险提示查询'
           WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
           WHEN T.querytype = '040'              THEN '客户账户查询'
           WHEN T.querytype = '050'              THEN '客户影像查询'
           WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
         END AS 查询类型
        ,T.objectno 查询客户号
        ,T.objectname 查询客户名称
        ,T1.prm_org_nm 被查询客户管护机构
        ,T1.prm_mgr_nm 被查询客户管护人
FROM    edw.LOAN_QUERY_LOG T --信贷查询日志
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管护
on T.objectno=T1.cst_id
and T1.dt='@@{yyyyMMdd}'
WHERE   T.dt = '@@{yyyyMMdd}'
AND     T.queryuserid = '016204'
AND     T.querydate BETWEEN '2023/01/01' AND '2024/06/30'
AND     T.objectno NOT IN (
                              SELECT  t1.cst_id
                              FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1
                              WHERE   T1.dt = '@@{yyyyMMdd}'
                              AND     T1.prm_mgr_id = '016204'
                           )  --剔除本人名下的管护客户
;
-- AND     T.objectno NOT IN (
--                               SELECT  t1.cst_id
--                               FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1
--                               WHERE   T1.dt = '@@{yyyyMMdd}'
--                               AND      t1.prm_org_id like '3302004%'  --剔除萧山支行
--                            )  --剔除-剔除萧山支行的管护客户


-- SELECT * FROM tmp_zfk_SJ20240703101;
**01-数据需求_分行_D0918_衢州分行_王雯_泰惠收商户成本分析.sql
--转彬彬处理

--SJ2024091881，衢州分行2024年新入驻泰惠收商户成本分析

---字段：商户号	入驻日期	管户机构名称	管户支行机构名称	客户经理姓名	客户经理工号	商户简称	商户全称	商户类型	MCC类型	商户状态名称
--手续费率	清算周期	垫资成本	购买机具类型	购买金额	购买时间	是否返现	返现时间


-- dim_bus_chnl_ths_mch_inf_dd T1 --泰惠收商户基本信息
-- dim_bus_chnl_ths_ctr_inf_dd T2 --泰惠收商户合同信息


--edw.dpss_bth_mer_in_acc_dtl   --商户入账明细表


SELECT  t.ths_store_no 泰惠收商户号
        ,t.store_id
        ,REPLACE(substr(t.shiptime, 1, 10), '-', '') trx_dt
        , t.id
        ,t.act_num 活动编号
        ,t.integral_all 总积分
        ,t.order_status 订单状态 --，0为订单取消，10为已提交待付款，15为线下付款提交申请(已经取消该付款方式)，16为货到付款，20为已付款待发货，30为已发货待收货，
        ,t.addtime
        ,t.goods_amount 商品总价格
        ,t.order_sign
        ,t1.goods_name
        ,CASE
           WHEN t.act_num = 'taihuishou_shanghujinjian_01' THEN '赠送'
           WHEN t.integral_all > 0                         THEN '积分兑换'
           WHEN t.integral_all = 0 AND t.goods_amount > 0  THEN '购买'
         END type
FROM    edw.tlsc_sunyardmall_orderform t
LEFT JOIN    edw.tlsc_sunyardmall_orderform_goods t1
ON       t.id  = t1.oid
AND     t1.dt = t.dt
LEFT JOIN    edw.tlsc_sunyardmall_goods t2
ON      t1.goods_id =  t2.id
AND     t2.dt = t1.dt
WHERE   t.dt = '@@{yyyyMMdd}'
AND     t1.goods_name LIKE '%音响%'
AND     t2.tenant_code = 'taihuishou';
**01-数据需求_分行_D0920_台州分行_江丽娜_核循环类贷款业务冻结方式_单笔用信期限上限等数据.sql
--截止2024.9.20，台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况
-- 用于分析循环类贷款业务，了解支行对该类业务是否有设置冻结方式、单笔用信期限上限

--字段：数据日期	合同流水号	客户编号	客户名称	风险分层	发生类型	业务标识	业务品种	营销标签	循环贷款类型
--若泰e贷，需要显示是否人工审批	合同冻结方式	合同冻结期限(月)	单笔用信期限上限(天)	合同金额	合同余额
--未结清借据金额	执行月利率(&permil;)	执行年利率(%)	资金用途	合同起始日	合同到期日	主要担保方式	是否异地
--管户机构号	管户机构名称	管户人工号	管户人姓名	发放人	发放姓名	发放人机构	发放人机构名称


DROP TABLE IF EXISTS tmp_sjxq_jln_SJ20240920106 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_jln_SJ20240920106 AS
SELECT  a.dt                   AS 数据日期
        ,a.ctr_serno           AS 合同流水号
        -- ,a.ctr_sts_cd as 合同状态
        ,a.cst_id              AS 客户编号
        ,a.cst_nm              AS 客户名称
        ,CASE
           WHEN f.rsk_lyr = '1' THEN '低风险'
           WHEN f.rsk_lyr = '2' THEN '中低风险'
           WHEN f.rsk_lyr = '3' THEN '中风险'
           WHEN f.rsk_lyr = '4' THEN '中高风险'
           WHEN f.rsk_lyr = '5' THEN '高风险'
        else ''
         END                   AS 风险分层      --不是合同表的客户风险等级
        ,CASE
           WHEN a.hpn_typ_cd = '011' THEN '续做'
           WHEN a.hpn_typ_cd = '010' THEN '首笔'
         END                   AS 发生类型
        ,CASE
           WHEN a.bsn_mark_cd = 01 THEN '员工贷款'
           WHEN a.bsn_mark_cd = 02 THEN '信贷人员亲属业务'
           WHEN a.bsn_mark_cd = 03 THEN '预保预报业务'
           WHEN a.bsn_mark_cd = 04 THEN '重组业务'
           WHEN a.bsn_mark_cd = 05 THEN '协作业务'
         END                   AS 业务标识
        ,a.prd_no              AS 业务品种代码
        ,T4.pd_nm              AS 业务名称
        ,a.prd_tag             AS 产品标签编号集合 --即原来的营销标签
        ,a.prd_tag_nm          AS 产品标签名称
        ,CASE
           WHEN a.rvlg_typ_cd = 0 THEN '非循环'
           WHEN a.rvlg_typ_cd = 1 THEN '自助循环'
           WHEN a.rvlg_typ_cd = 2 THEN '半自助循环'
         END                   AS 循环贷款类型
        ,CASE
           WHEN e.bsn_aprv_mod_cd = 1 THEN '机批'
           WHEN e.bsn_aprv_mod_cd = 2 THEN '人批'
         END                   AS 业务审批模式
        ,CASE
           WHEN c.ctr_frz_mod = 05 THEN '每笔贷款发放后'
           WHEN c.ctr_frz_mod = 06 THEN '无'
           WHEN c.ctr_frz_mod = 07 THEN '冻结一次'
           WHEN c.ctr_frz_mod = 08 THEN '循环冻结'
           WHEN c.ctr_frz_mod = 09 THEN '到期前3个月'
         END                   AS 合同冻结方式     --合同表的ctr_frz_mod_cd不能用
        ,c.frz_trm             AS 合同冻结期限
        ,d.sngl_usc_trm_ceil   AS 单笔用信期限上限
        ,a.ctr_amt             AS 合同金额
        ,a.ctr_bal             AS 合同余额
        ,b.amt                 AS 未结清借据金额
        ,a.exec_intr_rat       AS 执行月利率
        ,a.exec_intr_rat * 1.2 AS 执行年利率
        ,a.cpt_usg_cd          AS 资金用途代码
        ,a.cpt_usg_rmk         AS 资金用途
        ,a.ctr_bgn_dt          AS 合同起始日
        ,a.ctr_mtu_dt          AS 合同到期日
        ,CASE
           WHEN a.grnt_mod_colc = 010 THEN '保证'
           WHEN a.grnt_mod_colc = 005 THEN '信用'
           WHEN a.grnt_mod_colc = 020 THEN '抵押'
           WHEN a.grnt_mod_colc = 040 THEN '质押'
         END                   AS 担保方式集合
        ,CASE
           WHEN a.dif_plc_bsn_ind = 0 THEN '否'
           WHEN a.dif_plc_bsn_ind = 1 THEN '是'
         END                   AS 乡情贷业务标志 --即是否异地
        ,a.mgr_org_id          AS 管户机构号
        ,a1.org_nm             AS 管护机构名
        ,a.mgr_id              AS 管户人工号
        ,a3.empe_nm            AS 管户人姓名
        ,a.hdl_opr_id          AS 经办人工号
        ,a4.empe_nm            AS 经办人姓名
        ,a.hdl_org_id          AS 经办机构号
        ,a2.org_nm             AS 经办机构名称
FROM    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息  对应贴源层表edw.loan_ctr_bse_inf
LEFT JOIN    (
                 SELECT  t.ctr_serno
                         ,sum(t.prcp_bal) AS amt --未结清借据金额
                 FROM    edw.DIM_BUS_LOAN_DBIL_INF_DD t
                 WHERE   t.dt = '20240920'
                 AND     ( t.TMT_DT = '18991231'
                     OR t.prcp_bal > 0 ) ----未终结未结清
                 GROUP BY t.ctr_serno
             ) b
ON      a.ctr_serno = b.ctr_serno
LEFT JOIN    edw.loan_ctr_intr_rat c --合同利率
ON      a.ctr_serno = c.ctr_serno
AND     c.dt = '20240920'
LEFT JOIN    edw.loan_ctr_oth_dtl_inf d --合同其它明细信息
ON      a.ctr_serno = d.ctr_serno
AND     d.dt = '20240920'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_biz_dd e --用信方案
ON      a.rel_serno = e.usc_aply_serno
AND     e.dt = '20240920'
LEFT JOIN    edw.loan_lmt_biz_stat_inf f --统计类信息
ON      a.rel_serno = f.usc_aply_serno
AND     f.dt = '20240920'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T4 --产品信息
ON      a.prd_no = T4.prd_no
AND     T4.DT = '20240920'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a1
ON      a.mgr_org_id = a1.org_id
AND     a1.dt = '20240920'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a2
ON      a.hdl_org_id = a2.org_id
AND     a2.dt = '20240920'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a3
ON      a.mgr_id = a3.empe_id
AND     a3.dt = '20240920'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a4
ON      a.hdl_opr_id = a4.empe_id
AND     a4.dt = '20240920'
WHERE   a.dt = '20240920'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( A.CTR_STS_CD IN ( '2' , '4' )
AND     A.TMT_DT = '18991231'
AND     to_date(A.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A.DT, 'yyyyMMdd') )
    OR A.CTR_BAL > 0 )
AND     a.rvlg_typ_cd <> '0' --循环类贷款
AND     a.prd_no <> '2002010101001' --剔除信用卡
AND     a.mgr_org_id LIKE '3301%'     --台州分行
;
**01-数据需求_分行_D0924_金华分行_叶心怡_用于评估区域内行业容量_为后期社区调研_开拓提供参考.sql
--	SJ2024092416
-- 用于评估区域内行业容量，为后期社区调研、开拓提供参考依据
-- 截止9月20日，金华分行区域内关于&ldquo;酒、饮料及茶叶批发&rdquo;、&ldquo;酒、饮料及茶叶零售&rdquo;、&ldquo;日用家电批发&rdquo;、&ldquo;日用家电零售&rdquo;、&ldquo;果品、蔬菜批发&rdquo;、&ldquo;果品、蔬菜零售&rdquo;这几个行业小鱼管家工商铺底数据。
-- 字段：支行名称、子社区名称、商户数

--总共14130条数据
-- SELECT 企业类型,COUNT(统一社会信用代码) FROM tmp_yxy_qiye_shequ_SJ2024092416 GROUP BY 企业类型 ;

-- SELECT * FROM tmp_yxy_qiye_shequ_SJ2024092416 WHERE (统一社会信用代码 is null or 统一社会信用代码='');

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxy_qiye_shequ_SJ2024092416;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxy_qiye_shequ_SJ2024092416 AS
SELECT  DISTINCT T2.org_id            AS 子社区所属机构号
                 ,T3.org_nm           AS 子社区所属机构名称
                 ,T3.sbr_org_nm       AS 子社区所属支行
                 ,T2.com_code         AS 子社区编号
                 ,T2.com_name         AS 子社区名称
                 ,T2.com_vindicate_id AS 子社区主维护人工号
                 ,T1.entname          AS 企业名称
                 ,T1.socialcreditcode AS 统一社会信用代码
                 ,CASE
                    WHEN T1.enttype = '1' THEN '个体'
                    WHEN T1.enttype = '3' THEN '注册企业'
                    ELSE '其它'
                  END                 AS 企业类型
                 ,T1.cust_no          AS 客户号
                 ,T1.industrycode     AS 行业类型
                 ,T1.industryname     AS 行业名称
                 ,CASE
                    WHEN T1.custtype = '0' THEN '正式'
                    WHEN T1.custtype = '1' THEN '潜在'
                    ELSE '未建档'
                  END                 AS 客户状态
FROM    edw.xwdt_xw_com_nearbyent T1 --社区企业信息表
LEFT JOIN    edw.xwdt_xw_community T2 --社区信息表
ON      T1.com_id = T2.id
AND     T2.com_type IN ( '03' , '04' , '05' ) --03子社区，04社区单元，05虚拟子社区
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3
ON      T2.org_id = T3.org_id
AND     T3.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     substr(T2.org_id, 1, 4) = '3308' --金华分行
AND     T1.industryname IN ( '酒、饮料及茶叶批发' , '酒、饮料及茶叶零售' , '日用家电批发' , '日用家电零售' , '果品、蔬菜批发' , '果品、蔬菜零售' )
-- and T1.industrycode in ('F5123','F5127','F5226','F5138','F5272','F5223')
;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yxy_qiye_shequ_SJ2024092416_f;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yxy_qiye_shequ_SJ2024092416_f AS
SELECT  子社区所属支行
        ,子社区名称
        ,行业名称
        ,COUNT(CASE
                 WHEN 企业类型 = '个体' THEN 统一社会信用代码
               END) AS 个体工商户数
        ,count(CASE
                 WHEN 企业类型 = '注册企业' THEN 统一社会信用代码
               END) AS 注册企业数
        ,count(CASE
                 WHEN 企业类型 = '其它' THEN 统一社会信用代码
               END) AS 其他企业数
FROM    tmp_yxy_qiye_shequ_SJ2024092416
GROUP BY 子社区所属支行 , 子社区名称 , 行业名称
;

-- SELECT sum(个体工商户数),sum(注册企业数),sum(其他企业数)FROM tmp_yxy_qiye_shequ_SJ2024092416_f
-- SELECT * FROM tmp_yxy_qiye_shequ_SJ2024092416_f
**01-数据需求_分行_D0925_绍兴分行_何灵杰_绍兴分行随贷通卡有余额业务数据.sql
---*******************************************************************

--SJ2024092581
-- 截止9月25日，绍兴分行随贷通卡有余额业务数据

--字段：
--业务合同流水号、借据号、客户号、客户名、管户机构、管户人、随贷通卡当前使用率（余额/绑定额度）、
--中征分550分以下、中征分600分以下且较上期下降幅度大于5%、办卡2年后征信分下降100分上且负债家数增加5家以上、借据期限1年以上且未触发精准贷后和无常规贷后


---1、中征分
DROP TABLE IF EXISTS tmp_hlj_SJ2024092581_01 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hlj_SJ2024092581_01 AS
SELECT  t.cst_id
        ,t.prd_dt
        ,t.cst_cr_grd_val
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
FROM    (
            SELECT  cst_id
                    ,to_date(REPLACE(substr(qry_tm, 1, 10), '-', ''), 'yyyymmdd') AS prd_dt
                    ,cr_sco_val                                                   AS cst_cr_grd_val
            FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI --单笔评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
            WHERE   dt <= '20240925'
            UNION
            SELECT  cst_id
                    ,to_date(prd_dt, 'yyyymmdd') AS prd_dt
                    ,cst_cr_grd_val
            FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI --月底批量的征信分, 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
            WHERE   dt <= '20240925'
        ) t
;


--2、合同，中征分
DROP TABLE IF EXISTS tmp_hlj_SJ2024092581_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hlj_SJ2024092581_02 AS
SELECT  a.ctr_serno   AS 合同流水号
        ,d.dbil_id    AS 借据号
        ,a.cst_id     AS 客户号
        ,a.cst_nm     AS 客户名
        ,a.mgr_id     AS 管护人工号
        ,c.empe_nm    AS 管护人姓名
        ,a.mgr_org_id AS 管护机构号
        ,b.org_nm     AS 管护机构名称
        ,a.ctr_amt    AS 合同金额
        ,a.ctr_bal    AS 合同余额
        ,a.ctr_bgn_dt AS 合同起始日
        ,d.amt        AS 发放金额
        ,d.prcp_bal   AS 本金余额
        ,CASE
           WHEN DATEDIFF(to_date(d.apnt_mtu_dt, 'yyyymmdd'), to_date(d.LVE_ACT_BGN_DT, 'yyyymmdd'), 'yyyy') >= 1 AND f.cst_id IS NULL THEN '是'
           ELSE '否'
         END          AS 借据期限1年以上且未触发精准贷后和无常规贷后
	,T1.cst_cr_grd_val AS 本期中征分
	,T2.cst_cr_grd_val AS 上期中征分
FROM    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息
INNER JOIN    edw.DIM_BUS_LOAN_DBIL_INF_DD d --借据
ON      a.ctr_serno = d.ctr_serno
AND     D.prcp_bal > 0
AND     d.dt = '20240925'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd b
ON      a.mgr_org_id = b.org_id
AND     b.dt = '20240925'
LEFT JOIN    edw.dws_hr_empe_inf_dd c --员工汇总信息
ON      a.cst_id = c.empe_id
AND     c.dt = '20240925'
LEFT JOIN    (
                 SELECT  DISTINCT T1.cst_id
                 FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
                 INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
                 ON      T1.btch_serno = T2.btch_serno
                 AND     T2.dt = '20240925'
                 AND     T2.pst_loan_chk_tsk_src_cd IN ( '01' , '02' ) --  01，精准贷后，02，常规贷后，03，自主贷后，04，精准贷后-信用卡
                 WHERE   T1.dt = '20240925'
             ) f
ON      a.cst_id = f.cst_id
LEFT  JOIN tmp_hlj_SJ2024092581_01 T1
ON      a.cst_id = T1.cst_id
AND    T1.rn = 1
LEFT  JOIN tmp_hlj_SJ2024092581_01 T2
ON      a.cst_id = T2.cst_id
AND    T2.rn = 2
WHERE   a.dt = '20240925'
AND     a.prd_no IN ( '2001010101003' , '2001020101003' )  --随贷通（消费）/随贷通（经营）
---未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( a.CTR_STS_CD IN ( '2' , '4' )
AND     a.TMT_DT = '18991231'
AND     to_date(a.CTR_MTU_DT, 'yyyyMMdd') >= to_date(a.DT, 'yyyyMMdd') )
    OR a.CTR_BAL > 0 )
AND     a.mgr_org_id LIKE '3307%' --绍兴分行
;


--3、征信评分、授信机构数
DROP TABLE IF EXISTS tmp_hlj_SJ2024092581_03 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hlj_SJ2024092581_03 AS
SELECT  T1.客户号
        ,T1.合同流水号
        ,T1.合同起始日
        -- ,COALESCE(greatest(T2.idv_crd_sco_val, T2.idv_crd_sco_val2), greatest(T3.idv_crd_sco_val, T3.idv_crd_sco_val2)) AS 征信评分  --企业无征信分
        ,greatest(T2.idv_crd_sco_val, T2.idv_crd_sco_val2) AS 征信评分
        ,COALESCE(T2.cred_busi_org_out_wjq, T3.un_sett_credit_org_num)                                                   AS 授信机构数
        ,COALESCE(T2.report_dsc_rn, T3.report_dsc_rn)                                                                   AS 报告降序排序号
        ,COALESCE(REPLACE(substr(T2.report_dt, 1, 10), '-', ''), REPLACE(substr(T3.report_dt, 1, 10), '-', ''))         AS 报告日期
FROM    (
            SELECT  DISTINCT T1.客户号
                             ,T1.合同流水号
                             ,T1.合同起始日
            FROM    tmp_hlj_SJ2024092581_02 T1
        ) T1
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T2 --个人征信指标信息表
ON      T1.客户号 = T2.cst_id
AND     T2.dt = '20240925'
LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd T3 --企业征信指标信息表  --可不用看
ON      T1.客户号 = T3.cst_id
AND     T3.dt = '20240925';



--4、结果表


DROP TABLE IF EXISTS tmp_hlj_SJ2024092581_04 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hlj_SJ2024092581_04 AS
SELECT  T1.合同流水号
        ,T1.借据号
        ,T1.客户号
        ,T1.客户名
        ,T1.管护人工号
        ,T1.管护机构号
        ,T1.管护机构名称
        ,T1.合同金额
        ,T1.合同余额
        ,T1.合同起始日
        ,T1.发放金额
        ,T1.本金余额
        ,T1.借据期限1年以上且未触发精准贷后和无常规贷后
        ,T1.本期中征分
        ,T1.上期中征分
        ,T2.授信机构数 AS 合同发放时授信机构数
        ,T2.征信评分  AS 合同发放时征信评分
        ,COALESCE(T3.授信机构数,T4.授信机构数) AS 办卡2年后授信机构数
        ,COALESCE(T3.征信评分,T4.征信评分)  AS 办卡2年后征信评分
FROM    tmp_hlj_SJ2024092581_02 T1
LEFT JOIN    (
                 SELECT  A1.客户号
                         ,A1.合同流水号
                         ,A1.征信评分
                         ,A1.授信机构数
                         ,A1.报告日期
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.客户号 , A1.合同流水号 ORDER BY A1.报告降序排序号 ) AS RN
                 FROM    tmp_hlj_SJ2024092581_03 A1
                 WHERE   A1.报告日期 <= A1.合同起始日
             ) T2 --发放时
ON      T1.客户号 = T2.客户号
AND     T1.合同流水号 = T2.合同流水号
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  A1.客户号
                         ,A1.合同流水号
                         ,A1.征信评分
                         ,A1.授信机构数
                         ,A1.报告日期
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.客户号 , A1.合同流水号 ORDER BY A1.报告降序排序号 DESC ) AS RN
                 FROM    tmp_hlj_SJ2024092581_03 A1
                 WHERE   A1.报告日期 >= TO_CHAR(DATEADD(TO_DATE(A1.合同起始日, 'YYYYMMDD'), 2, 'yyyy'), 'YYYYMMDD')
             ) T3  --发放时间两年后首期
ON      T1.客户号 = T3.客户号
AND     T1.合同流水号 = T3.合同流水号
AND     T3.RN = 1
LEFT JOIN tmp_hlj_SJ2024092581_03 T4   --
ON      T1.客户号 = T4.客户号
AND     T1.合同流水号 = T4.合同流水号
AND     T4.报告降序排序号 = 1
;
**01-数据需求_分行_D1022_嘉兴分行_张依宁_客户查询清单.sql
--嘉兴分行在途离职人员包玉凤013476自2024年9月1日以来的，客户查询清单及打印记录
--客户号，客户名称，查询时间，是否打印

SELECT DISTINCT 客户号 FROM tmp_cx_SJ2024102261

DROP TABLE IF EXISTS tmp_cx_SJ2024102261 PURGE;

CREATE TABLE IF NOT EXISTS tmp_cx_SJ2024102261 AS
SELECT  T.cst_id 客户号
        ,T1.cst_chn_nm 客户名称
        ,concat(T.qdt,'-',T.request_time) AS 查询时间
        ,user_code 查询人
FROM    (
            SELECT
                    -- substr(REGEXP_REPLACE(aslp.request_message, '\\s', ''), 12, 10) --替换数据中的逗号和回车，防止导出时excel错行,REGEXP_REPLACE( REPLACE(t3.description, ',', '|'),'\\s','|')
                    split_part(REGEXP_REPLACE(aslp.request_message, '\\s', ''), '&quot;', 4) AS cst_id
                    -- ,REGEXP_REPLACE(REGEXP_REPLACE(aslp.request_message, '\\s', ''), '[^0-9]', '') --只保留数据
                    ,user_code
                    ,substr(date_only, 1, 10)                                            AS qdt
                    ,request_time
            FROM    edw.loan_admin_sm_log_provider aslp --增量表
            WHERE   aslp.dt <= '20241024'
            AND     aslp.dt >= '20240901'
            AND     SERVICE_CODE = '/api/w/cst/cmm/corpbsc/detail'
            -- AND     REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;2613016068&quot;%'
            AND     user_code = '013476'   --包玉凤
        ) T
LEFT JOIN    edw.dws_cst_bas_inf_dd T1
ON      T.cst_id = T1.cst_id
AND     T1.dt = '20241024';
**01-数据需求_分行_D1023_台州分行_徐冰清_随贷通卡业务审批流程明细数据.sql
-- SJ20241028111 徐冰清
-- 7月1日至10月27日，台州分行随贷通卡业务审批流程明细数据。

-- 合同流水号、申请流水号、客户号、客户姓名、风险控制号、管护机构号、管护机构、管护人工号、管护人、经办机构、经办人工号、经办人、经办日期、合同到期日、
-- 首贷标识、合同金额、启用绑定金额、余额、本月本金余额月日均、本年本金余额年日均、是否用过信、合同利率、业务类型、担保方式、审批人员、额度是否超支行审批权限、
-- 利率是否超支行审批权限、预评估是否发起抗辩



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_tz_sdt_SJ20241028111_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_tz_sdt_SJ20241028111_01 AS
SELECT  T1.ctr_serno                                                                               AS 合同流水号
        ,T1.rel_serno                                                                              AS 用信申请流水号
        ,T1.cst_id                                                                                 AS 客户号
        ,T1.cst_nm                                                                                 AS 客户姓名
        ,T2.sam_rsk_ctrl_id                                                                        AS 风险控制号
        ,T1.mgr_org_id                                                                             AS 管护机构号
        ,T3.org_nm                                                                                 AS 管护机构
        ,T1.mgr_id                                                                                 AS 管护人工号
        ,T4.empe_nm                                                                                AS 管护人
        ,T1.hdl_org_id                                                                             AS 经办机构编号
        ,T5.org_nm                                                                                 AS 经办机构
        ,T1.hdl_opr_id                                                                             AS 经办人工号
        ,T6.empe_nm                                                                                AS 经办人
        ,T1.SYS_REG_DT                                                                             AS 经办日期
        ,T1.ctr_bgn_dt                                                                             AS 合同起始日期
        ,T1.ctr_mtu_dt                                                                             AS 合同到期日
        ,CASE
           WHEN T1.hpn_typ_cd = '010' THEN '首笔'
           WHEN T1.hpn_typ_cd = '011' THEN '续做'
         END                                                                                       AS 首贷标识
        ,T1.ctr_amt                                                                                AS 合同金额
        ,T1.strt_use_amt                                                                           AS 启用金额
        ,T1.ctr_bal                                                                                AS 余额
        ,T7.本月本金余额积数 / SUBSTR(T1.DT, 7, 2)                                                         AS 本月本金余额月日均
        ,T7.本年本金余额积数 / DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE('20231231', 'YYYYMMDD'), 'DD') AS 本年本金余额年日均
        ,CASE WHEN T7.bus_ctr_id IS NOT NULL THEN '是' ELSE '否' END                                      AS 是否用过信
        ,T1.exec_intr_rat                                                                          AS 合同利率
        ,T8.pd_nm                                                                                  AS 业务类型
        ,T1.grnt_mod_colc                                                                          AS 担保方式集合
        ,T9.grnt_mod_nm                                                                            AS 担保方式集合名称
        ,T10.aply_epsr_amt                                                                         AS 申请金额
        ,T10.exec_intr_rat                                                                         AS 申请利率
        ,T10.node_name                                                                             AS 审批节点名称
        ,T10.user_name                                                                             AS 审批经办人姓名
        ,T10.user_id                                                                               AS 审批经办人工号
        ,T11.预评估是否发起抗辩                            AS 预评估是否发起抗辩
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20241027'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T1.mgr_org_id = T3.org_id
AND     T3.DT = '20241027'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T1.mgr_id = T4.empe_id
AND     T4.DT = '20241027'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T1.mgr_org_id = T5.org_id
AND     T5.DT = '20241027'
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T1.hdl_opr_id = T6.empe_id
AND     T6.DT = '20241027'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,SUM(mon_acm_prcp_bal_acml)  AS 本月本金余额积数
                         ,SUM(year_acm_prcp_bal_acml) AS 本年本金余额积数
                 FROM    edw.dws_bus_loan_dbil_inf_dd --贷款借据信息汇总
                 WHERE   DT = '20241027'
                 GROUP BY bus_ctr_id
             ) T7
ON      T1.ctr_serno = T7.bus_ctr_id
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T8 --产品信息
ON      T1.prd_no = T8.prd_no
AND     T8.DT = '20241027'
LEFT JOIN    (
                 SELECT  a.dt
                         ,a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241027'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '20241027'
                 GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc
             ) T9
ON      T1.ctr_serno = T9.ctr_serno
LEFT JOIN    (
                 SELECT  A1.usc_aply_serno
                         ,A1.aply_epsr_amt
                         ,A1.apl_amt
                         ,t.exec_intr_rat
                         ,B.user_name
                         ,B.user_id
                         ,B.node_name
                         ,c.comment_sign
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.usc_aply_serno ORDER BY B.end_time DESC ) AS RN
                 FROM    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案
                 LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息
                 ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
                 AND     T.cst_id = A1.cst_id
                 AND     T.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表
                 ON      t.ahn_ltr_aply_serno = a.biz_id
                 AND     t.sys_reg_psn_id = a.flow_starter ---- 授信申请登记者 = 流程发起者   不然会有多条记录
                 AND     a.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表  --只保留了最后一次流程提交或审批的时间
                 ON      a.main_instance_id = b.instance_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 left join edw.dwd_bus_loan_n_wf_comment_his_dd c   --流程审批意见历史
                 on      a.main_instance_id=c.main_instance_id
                 and     c.dt = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
             ) T10
ON      T1.rel_serno = T10.usc_aply_serno
LEFT JOIN    (
                 SELECT  A1.usc_aply_serno
                         ,MAX(CASE
                                WHEN A3.cd_val_dscr RLIKE '抗辩' THEN '是'
                                ELSE '否'
                              END) AS 预评估是否发起抗辩
                 FROM    edw.dwd_bus_loan_lmt_aply_rel_ases_dd A1 --授信关联预评估信息表
                 LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表
                 ON      A1.rul_set_rslt_cd = A3.cd_val
                 AND     A3.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
                 AND     A3.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     A3.DT = '@@{yyyyMMdd}'
                 where   A1.dt='@@{yyyyMMdd}'
                 GROUP BY A1.usc_aply_serno
             ) T11
ON      T1.rel_serno = T11.usc_aply_serno
WHERE   T1.DT = '20241027'
AND     T1.mgr_org_id LIKE '3301%' --台州分行
AND     T1.prd_no IN ( '2001010101003' , '2001020101003' ) --随贷通
AND     T1.ctr_bgn_dt >= '20240701'
AND     T1.ctr_bgn_dt <= '20241027';
**01-数据需求_分行_D1023_台州分行_陈鹏_企业生产经营及资产负债情况调研撰写调研报告.sql
-- SJ2024102386
-- 企业名称、企业行业类别、企业规模、2024年6月末资产总计、2023年6月末资产总计、2024年6月末负债合计、2023年6月末负债合计、
-- 2024年6月末主营业务收入、2023年6月末主营业务收入、2024年6月末利润总额、2023年6月末利润总额、2024年6月末净利润、2023年6月末净利润


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ2024102386_caibao_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ2024102386_caibao_01 AS
SELECT T.objectno	 AS 客户号
        ,T.reportdate	 AS 报表期次
		,MAX(CASE WHEN  T.modelno ='0001' AND T1.rowsubject='804' THEN T1.col1value END)   AS 期初值_资产总计           --0001资产负债表
		,MAX(CASE WHEN  T.modelno ='0001' AND T1.rowsubject='804' THEN T1.col2value END)   AS 期末值_资产总计
		,MAX(CASE WHEN  T.modelno ='0001' AND T1.rowsubject='807' THEN T1.col1value END)   AS 期初值_负债合计
		,MAX(CASE WHEN  T.modelno ='0001' AND T1.rowsubject='807' THEN T1.col2value END)   AS 期末值_负债合计
		,MAX(CASE WHEN  T.modelno ='0002' AND T1.rowsubject='501' THEN T1.col1value END)  AS 期初值_一主营业务收入	   --0002利润表
		,MAX(CASE WHEN  T.modelno ='0002' AND T1.rowsubject='501' THEN T1.col2value END)  AS 期末值_一主营业务收入
	 	,MAX(CASE WHEN  T.modelno ='0002' AND T1.rowsubject='515' THEN T1.col1value END)  AS 期初值_四利润总额
		,MAX(CASE WHEN  T.modelno ='0002' AND T1.rowsubject='515' THEN T1.col2value END)  AS 期末值_四利润总额
	 	,MAX(CASE WHEN  T.modelno ='0002' AND T1.rowsubject='517' THEN T1.col1value END)  AS 期初值_五净利润
		,MAX(CASE WHEN  T.modelno ='0002' AND T1.rowsubject='517' THEN T1.col2value END)  AS 期末值_五净利润
FROM    edw.loan_REPORT_RECORD T --报表记录  --20220118
INNER JOIN    edw.loan_REPORT_DATA T1 --报表数据  --20220118
ON      T.reportno = T1.reportno
AND     T1.DT = '20240719'
WHERE T.DT = '20240719'
AND   T.ObjectType = 'CustomerFS' -- 对象类型为客户号
AND   T.reportstatus = '02' --报表状态
GROUP BY T.objectno,T.reportdate;



--结果表1
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qiyexinxi_SJ2024102386_caibao_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qiyexinxi_SJ2024102386_caibao_02 AS
SELECT  T0.cst_id        AS 客户号
        ,T0.cst_nm       AS 企业名称
        ,T0.IDT_CTG_CD   AS 行业分类代码
        ,T31.cd_val_dscr AS 一级行业分类
        ,T32.cd_val_dscr AS 二级行业分类
        ,T33.cd_val_dscr AS 三级行业分类
        ,T3.cd_val_dscr  AS 四级行业分类
        ,CASE
           WHEN T0.ENTP_SIZ_CD = '2' THEN '大型企业'
           WHEN T0.ENTP_SIZ_CD = '5' THEN '微型企业'
           WHEN T0.ENTP_SIZ_CD = '9' THEN '其他'
           WHEN T0.ENTP_SIZ_CD = '3' THEN '中型企业'
           WHEN T0.ENTP_SIZ_CD = '4' THEN '小型企业'
         END             AS 企业规模
        ,CASE
           WHEN T2.REPORTPERIOD = '1' THEN '年报'
           WHEN T2.REPORTPERIOD = '2' THEN '半年报'
           WHEN T2.REPORTPERIOD = '3' THEN '季报'
           WHEN T2.REPORTPERIOD = '4' THEN '月报'
           WHEN T2.REPORTPERIOD = '9' THEN '其他'
         END 报表周期
        ,T1.报表期次
        ,T1.期初值_资产总计
        ,T1.期末值_资产总计
        ,T1.期初值_负债合计
        ,T1.期末值_负债合计
        ,T1.期初值_一主营业务收入
        ,T1.期末值_一主营业务收入
        ,T1.期初值_四利润总额
        ,T1.期末值_四利润总额
        ,T1.期初值_五净利润
        ,T1.期末值_五净利润
FROM    edw.dim_cst_entp_bas_inf_dd T0 --企业客户基本信息
LEFT JOIN    lab_bigdata_dev.tmp_qiyexinxi_SJ2024102386_caibao_01 T1 -----客户财务报表记录
ON      T0.cst_id = T1.客户号
AND     T1.报表期次 IN ( '2023/06' , '2024/06' )
LEFT JOIN    edw.loan_customer_fsrecord T2 --客户财务报表记录
ON      T2.customerid = T0.cst_id
AND     T2.REPORTDATE = T1.报表期次
AND     T2.DT = '20240719'
LEFT JOIN    edw.dwd_code_library_dd T3 -- 码值表
ON      T0.IDT_CTG_CD = T3.cd_val
AND     T3.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T3.fld_nm = 'IDT_CTG_CD'
AND     T3.DT = '20240719'
LEFT JOIN    edw.dwd_code_library_dd T31 -- 码值表
ON      SUBSTR(T0.IDT_CTG_CD, 1, 1) = T31.cd_val
AND     T31.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T31.fld_nm = 'IDT_CTG_CD'
AND     T31.DT = '20240719'
LEFT JOIN    edw.dwd_code_library_dd T32 -- 码值表
ON      SUBSTR(T0.IDT_CTG_CD, 1, 3) = T32.cd_val
AND     T32.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T32.fld_nm = 'IDT_CTG_CD'
AND     T32.DT = '20240719'
LEFT JOIN    edw.dwd_code_library_dd T33 -- 码值表
ON      SUBSTR(T0.IDT_CTG_CD, 1, 4) = T33.cd_val
AND     T33.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'
AND     T33.fld_nm = 'IDT_CTG_CD'
AND     T33.DT = '20240719'
LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T4
ON      T0.cst_id = T4.cst_id
AND     T4.DT = '20240719'
WHERE   T0.DT = '20240719'
AND     SUBSTR(T4.prm_org_id,1,4) ='3301'	  --台州分行
;
**01-数据需求_分行_D1024_龚丽娜_所有存款户和贷款户在外部数据中匹配工商登记信息.sql
--SJ2024102476
--截止2024.10.23，台州分行温岭淋川小微综合支行（机构号 330110400 ）的所有存款户和贷款户在外部数据中匹配工商登记信息
--只需要取个人客户

-- 这个就查这个人在外面有担任法定代表人的企业就行，不用到股东、高管


-- 字段：支行名称，客户号，客户名字，所属管户客户经理工号，工商登记信息(企业名称，注册地址，营业执照号码)



--1.1 个人股东信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_tz_SJ2024102476_gs_fr PURGE;

CREATE TABLE lab_bigdata_dev.tmp_tz_SJ2024102476_gs_fr AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
                                ,in_namecn --高管姓名
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息
                        WHERE   dt <= '20241023' ---------------xt:添加查得标识=1
                        AND     gpr_ifrichard = '1'  --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno in_ctfno
                                ,gpm_namecn in_namecn
                                ,gpr_entname dt_gpr_entname
                                ,gpr_enttype dt_gpr_enttype
                                ,gpr_entstatus dt_gpr_entstatus   --企业状态
                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno --被查询人证件号码
                                                        ,gpm_namecn --被查询人姓名
                                                        ,c.gpr_entname --企业(机构)名称
                                                        ,c.gpr_entstatus --企业状态
                                                        ,c.gpr_enttype --企业(机构)类型
                                                        ,c.gpr_creditcode --统一社会信用代码
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '20241023' ---- 作为法人的企业信息
                                                WHERE   a.dt <= '20241023'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '20241023'
                                            ) aa
                                    WHERE   aa.rn = 1
                                ) cc
                    ) bb
        ) d
WHERE   d.rk = 1
AND     d.dt_gpr_entstatus RLIKE '在营';



---结果表
-- 字段：支行名称，客户号，客户名字，所属管户客户经理工号，工商登记信息(企业名称，注册地址，营业执照号码)
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_tz_SJ2024102476_JGB PURGE;

CREATE TABLE lab_bigdata_dev.tmp_tz_SJ2024102476_JGB AS
SELECT  A3.sbr_org_nm         AS 支行名称
        ,A1.cst_id            AS 客户号
        ,A1.cst_nm            AS 客户名字
        ,A1.prm_mgr_id        AS 所属管户客户经理工号
        ,A1.prm_mgr_nm        AS 主管护人名称
        ,A4.dt_gpr_entname    AS 企业名称
        ,A4.dt_gpr_creditcode AS 营业执照号码
        ,A5.注册地址
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd A1
INNER JOIN    edw.dws_cst_idv_bas_inf_dd A0 --个人客户基本信息汇总表
ON      A1.cst_id = A0.cst_id
AND     A0.DT = '20241023'
INNER JOIN    (
                  SELECT  DISTINCT T1.cst_id
                  FROM    edw.dws_bus_dep_act_inf_dd T1 --存款账户信息汇总
                  WHERE   T1.DT = '20241023'
                  AND     T1.act_sts_cd <> 'C'  --剔除销户
                  UNION
                  SELECT  DISTINCT T1.cst_id
                  FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
                  WHERE   T1.DT = '20241023'
                  --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                  AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
                  AND     t1.TMT_DT = '18991231'
                  AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T1.DT, 'yyyyMMdd') )
                      OR t1.CTR_BAL > 0 )
              ) A2
ON      A1.cst_id = A2.cst_id
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd A3 --机构树_考核维度
ON      A1.prm_org_id = A3.org_id
AND     A3.DT = '20241023'
LEFT JOIN    lab_bigdata_dev.tmp_tz_SJ2024102476_gs_fr A4
ON      A0.DOC_NBR = A4.in_ctfno
LEFT JOIN    (
                 SELECT  A1.socialcreditcode                                                         AS 统一社会信用代码
                         ,A1.entname                                                                 AS 企业名称
                         ,A1.address                                                                 AS 注册地址
                         ,row_number() OVER ( PARTITION BY A1.socialcreditcode ORDER BY A1.dt DESC ) AS rn
                 FROM    edw.nout_gs_label_total_sub A1 --工商底库 （取注册地址）
                 WHERE   A1.dt <= '20241023'
             ) A5
ON      A4.dt_gpr_creditcode = A5.统一社会信用代码
AND     A5.RN = 1
WHERE   A1.DT = '20241023'
AND     A3.sbr_org_id = '330110400' --台州分行温岭淋川小微综合支行
;
**01-数据需求_分行_D1031_金华分行_蒋睿之_全量消费性贷款_含消费性随贷通_数据.sql
--SJ20241031121
--截止2024年10月31日，金华分行，全量消费性贷款_含消费性随贷通）数据.
--截止2024年10月31日，累计的数据
--产品编码	产品名称	客户经理编号	客户经理名称	管户机构号	机构名称C200	客户号	客户名称
--账号	起息日	到期日	当前余额	日均余额	执行利率	对客利率	对客利息
--调节后FTP利率_时点）	调节后FTP利息	调节后FTP利差_反算）	调节后FTP利润	数据日期	原币种	折人民币汇率




--月累计
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jrz_SJ20241031121_1031M PURGE;

CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.tmp_jrz_SJ20241031121_1031M AS
SELECT  as_of_date 数据日期
        ,core_product_id 产品编码
        ,product_name 产品名称
        ,cif_manager 客户经理编号
        ,cif_manager_name 客户经理名称
        ,org_unit_id 管户机构号
        ,b.org_nm 机构名称
        ,cif_key 客户号
        ,cif_name 客户名称
        ,account_no 账号
        ,start_dt 起息日
        ,maturity_dt 到期日
        ,cur_book_bal 当前余额
        ,avg_bal 日均余额
        ,cur_net_rate_a 执行利率
        ,cur_net_rate 对客利率
        ,acc_int 对客利息
        ,transfer_rate 调节前FTP利率_反算
        ,ftp_int 调节前FTP利息
        ,transfer_rate_ajust 调节后FTP利率_反算
        ,ftp_int_ajust 调节后FTP利息
        ,ftp_profit_rate 调节后FTP利差_反算
        ,ftp_profit_final 调节后FTP利润
        ,currency_cd 原币种
        ,cny_rate 折人民币汇率
        ,final_ftp_rate 调节后FTP利率_时点
FROM    app_iftp.adm_papp_ftp_eva_rpt_fact_ftp_cst_a14 a
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd b
ON      a.org_unit_id = b.org_id
AND     b.dt = '20241031'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd c
ON      a.account_no = c.dbil_id
AND     c.dt = '20241031'
WHERE   a.dt = '20241031'
AND     flag = 'M'
AND     c.pd_cd LIKE '200101%' --消费贷
AND     org_unit_id LIKE '3308%'    --金华分行
;

--年累计
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jrz_SJ20241031121_2024Y PURGE;

CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.tmp_jrz_SJ20241031121_2024Y AS
SELECT  as_of_date 数据日期
        ,core_product_id 产品编码
        ,product_name 产品名称
        ,cif_manager 客户经理编号
        ,cif_manager_name 客户经理名称
        ,org_unit_id 管户机构号
        ,b.org_nm 机构名称
        ,cif_key 客户号
        ,cif_name 客户名称
        ,account_no 账号
        ,start_dt 起息日
        ,maturity_dt 到期日
        ,cur_book_bal 当前余额
        ,avg_bal 日均余额
        ,cur_net_rate_a 执行利率
        ,cur_net_rate 对客利率
        ,acc_int 对客利息
        ,transfer_rate 调节前FTP利率_反算
        ,ftp_int 调节前FTP利息
        ,transfer_rate_ajust 调节后FTP利率_反算
        ,ftp_int_ajust 调节后FTP利息
        ,ftp_profit_rate 调节后FTP利差_反算
        ,ftp_profit_final 调节后FTP利润
        ,currency_cd 原币种
        ,cny_rate 折人民币汇率
        ,final_ftp_rate 调节后FTP利率_时点
FROM    app_iftp.adm_papp_ftp_eva_rpt_fact_ftp_cst_a14 a
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd b
ON      a.org_unit_id = b.org_id
AND     b.dt = '20241031'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd c
ON      a.account_no = c.dbil_id
AND     c.dt = '20241031'
WHERE   a.dt = '20241031'
AND     flag = 'Y'
AND     c.pd_cd LIKE '200101%' --消费贷
AND     org_unit_id LIKE '3308%'    --金华分行
;
**01-数据需求_分行_D1101_鲁豪杰_同一风险控制号敞口.sql
--
-- SJ2024110121
--截止10月31日，绍兴分行所有客户在我行的授信敞口，及其同一风险控制号在我行的合计授信敞口

--客户号，客户姓名，我行敞口金额，同一风险控制号，同一风险控制号下我行合计授信敞口

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_shaoxing_SJ2024110121 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_shaoxing_SJ2024110121 AS
SELECT  T1.cst_id           AS 客户号
        ,T1.cst_nm          AS 客户姓名
        ,T3.exps_amt        AS 我行敞口金额
        ,T3.cmn_rsk_ctrl_id AS 同一风险控制号
        ,T4.同一风险控制号下我行合计授信敞口
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
INNER JOIN    (
                  SELECT  cst_id
                  FROM    edw.dim_bus_loan_ctr_bse_inf_dd --信贷合同信息
                  WHERE   DT = '20241031'
                  AND     ( ctr_eff_dt <= dt
                  AND     ctr_mtu_dt >= dt
                  AND     tmt_dt = '18991231' ) --合同未结清
                  GROUP BY cst_id
              ) T0
ON      T1.cst_id = T0.cst_id
INNER JOIN    adm_rsk.adm_rsk_apl_cst_use_crdt_cst_info_dd T3 --风险集市客户授信用信客户维度信息表&mdash;&mdash;信用卡和贷款合同整合宽表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20241031'
LEFT JOIN    (
                 SELECT  cmn_rsk_ctrl_id
                         ,SUM(exps_amt) AS 同一风险控制号下我行合计授信敞口
                 FROM    adm_rsk.adm_rsk_apl_cst_use_crdt_cst_info_dd
                 WHERE   DT = '20241031'
                 GROUP BY cmn_rsk_ctrl_id
             ) T4
ON      T3.cmn_rsk_ctrl_id = T4.cmn_rsk_ctrl_id
WHERE   T1.DT = '20241031'
AND     SUBSTR(T1.prm_org_id, 1, 4) = '3307'   --绍兴分行
;
**01-数据需求_分行_D1104_李晨鹏_法院执行记录_预评估结果_风险分层.sql
-- SJ2024110401
--台州分行
-- 客户号	客户名称	法院执行记录	预评估结果	风险分层	管户客户经理	管户客户经理名称	管户机构名称	管户支行
-- 现有贷款授信银行数不含泰隆	信用卡近6个月平均透支率	最近6个月审批查询金融机构家数	近2年信贷连续逾期最大月份数	他行经营性贷款授信机构数	他行授信银行数剔除车贷房贷
-- 除房贷外当前有余额的贷款机构数	当前未结清非银行贷款机构数	当前未结清非银行贷款笔数	近2年逾期次数含信用卡	近2年逾期贷款次数不含信用卡	近2年最长逾期月数	最近5年内经营性贷款逾期机构数
-- 近6个月的最高逾期金额信用卡和贷款	对外担保笔数	处于最低还款状态的贷记卡账户数	个人信用评分分值	他行用信银行数剔除车贷房贷	他行用信银行数剔除房贷	他行用信银行数	最新一次征信查询时间
-- SELECT  *
-- FROM    SJ2024110401_tmp_yxw_wxf_20241108
-- WHERE   客户名称 = '包永明';

DROP TABLE IF EXISTS lab_bigdata_dev.SJ2024110401_tmp_yxw_wxf_20241108 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJ2024110401_tmp_yxw_wxf_20241108 AS
SELECT  t1.col_1                          AS 客户号
        ,t1.col_2                         AS 客户名称
        ,t2.CORT_EXE_RCD                  AS 法院执行记录
        ,t2.PRE_ASES_RSL                  AS 预评估结果
        ,t2.RSK_GRD                       AS 风险分层
        ,t2.PRM_MGR_ID                    AS 管户客户经理
        ,t2.PRM_MGR_NM                    AS 管户客户经理名称
        ,t2.PRM_ORG_NM                    AS 管户机构名称
        ,t2.PRM_SBR_ORG_ID                AS 管户支行
        ,t2.CUR_LOAN_OTHER_BANK_NUM       AS 现有贷款授信银行数_不含泰隆
        ,t2.C_C_6M_AVG_USE_RATE           AS 信用卡近6个月平均透支率
        ,t2.LATE_6MON_ENQU_ORG_NUM        AS 最近6个月审批查询金融机构家数
        ,t2.LATE_2_Y_OD_MON               AS 近2年信贷连续逾期最大月份数
        ,t2.OTHR_BNK_MNGMT_LOAN_ORG_NUM   AS 他行经营性贷款授信机构数
        ,t2.CURR_UNSETT_XFX_LOAN_ORG_NUM  AS 他行授信银行数剔除车贷房贷
        ,t2.REM_HOUSE_LOAN_UNSETT_ORG_NUM AS 除房贷外当前有余额的贷款机构数
        ,t2.CURR_UNSETT_FYH_LOAN_ORG_NUM  AS 当前未结清非银行贷款机构数
        ,t2.CURR_UNSETT_FYH_LOAN_NUM      AS 当前未结清非银行贷款笔数
        ,t2.LATE_2Y_ALL_OD_NUM            AS 近2年逾期次数含信用卡
        ,t2.LATE_2Y_LOAN_OD_NUM           AS 近2年逾期贷款次数不含信用卡
        ,t2.LATE_2Y_MAX_OD_NUM            AS 近2年最长逾期月数
        ,t2.LATE_5Y_JYX_LOAN_OD_NUM       AS 最近5年内经营性贷款逾期机构数
        ,t2.LATE_6_MON_MAX_OD_AMT         AS 近6个月的最高逾期金额信用卡和贷款
        ,t2.EXT_GUAR_NUM                  AS 对外担保笔数
        ,t2.MIN_RP_DJK_NUM                AS 处于最低还款状态的贷记卡账户数
        -- ,t2.IDV_CRD_SCO_VAL               AS 个人信用评分分值
        ,t2.OTH_BNK_USC_BNK_CNT_NOHSCAR   AS 他行用信银行数剔除车贷房贷
        ,t2.OTH_BNK_USC_BNK_CNT_NOHS      AS 他行用信银行数剔除房贷
        ,t2.OTH_BNK_USC_BNK_CNT           AS 他行用信银行数
        ,t3.report_dt                     AS 最新一次征信查询时间
FROM    qbi_file_20241107_14_02_56 t1
LEFT JOIN    app_ado.fct_ado_cst_prc_ind_inf t2 --定价小工具-指标信息
ON      t1.col_1 = t2.cst_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.dt_typ = 1 --最新
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd t3 --个人征信指标信息表
ON      t1.col_1 = t3.cst_id
AND     t3.report_dsc_rn = 1
AND     t3.dt = '@@{yyyyMMdd}'
WHERE   t1.pt <> ''
AND     t2.prm_org_id LIKE '3301%'    --台州分行;
**01-数据需求_分行_D1104_栾成_首笔业务中征分_预评估准入情况.sql
-- SJ2024110482

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_01
(
   合同登记流水号	 STRING
   ,申请书流水号	 STRING
   ,客户号	         STRING
   ,客户名称	     STRING
   ,发生类型	     STRING
   ,合同状态         STRING
);


--插入数据
INSERT INTO lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_01 VALUES ( 'HTBH2024103000003969' , '' , '1003602220' , '冯冬林' , '首笔' , '已生效' ) , ( 'HTBH2024102200002791' , '' , '1003700340' , '高力' , '首笔' , '已生效' ) , ( 'HTBH2024102900001129' , '' , '1003818436' , '马丽佳' , '首笔' , '已生效' ) , ( 'HTBH2024102500003400' , '' , '1003852144' , '舒春芳' , '首笔' , '已生效' ) , ( 'HTBH2024102500003310' , '' , '1004762611' , '程千里' , '首笔' , '已生效' ) , ( 'HTBH2024102600000093' , '' , '1005869142' , '胡余坚' , '首笔' , '已生效' ) , ( 'HTBH2024101000002955' , '' , '1007283382' , '陈一平' , '首笔' , '已生效' ) , ( 'HTBH2024101400000946' , '' , '1007637455' , '郑小红' , '首笔' , '已生效' ) , ( 'HTBH2024100800005423' , 'BA2019112300000564' , '1008455144' , '陈国富' , '首笔' , '未生效' ) , ( 'HTBH2024100800004845' , 'BA2019102100001543' , '1008599343' , '罗程远' , '首笔' , '已生效' ) , ( 'HTBH2024100800004502' , 'BA2019111000000323' , '1009302193' , '董剑文' , '首笔' , '已生效' ) , ( 'HTBH2024101800002969' , 'BA2024101800000070' , '1009400307' , '郑淑瑾' , '首笔' , '未生效' ) , ( 'HTBH2024100800004319' , 'BA2019110800002069' , '1009616621' , '陈久益' , '首笔' , '已生效' ) , ( 'HTBH2024100800004566' , 'BA2019111900002348' , '1010317418' , '冯国军' , '首笔' , '已生效' ) , ( 'HTBH2024102300001306' , '' , '1010712446' , '章秀明' , '首笔' , '已生效' ) , ( 'HTBH2024101400002711' , 'BA2019091100002708' , '1011427998' , '沈夏意' , '首笔' , '已生效' ) , ( 'HTBH2024101200001238' , 'BA2024101200000290' , '1011785580' , '王凤丽' , '首笔' , '未生效' ) , ( 'HTBH2024100800004518' , 'BA2019110200000131' , '1013603714' , '毛潇豪' , '首笔' , '已生效' ) , ( 'HTBH2024102300001602' , '' , '1014307943' , '池洁' , '首笔' , '已生效' ) , ( 'HTBH2024102100001095' , '' , '1014672054' , '杨云' , '首笔' , '已生效' ) , ( 'HTBH2024102300002751' , '' , '1014815459' , '姜爱群' , '首笔' , '未生效' ) , ( 'HTBH2024102100000728' , '' , '1015252521' , '孙俊' , '首笔' , '已生效' ) , ( 'HTBH2024103100000266' , '' , '1016516200' , '冯小青' , '首笔' , '已生效' ) , ( 'HTBH2024100800003369' , 'BA2019110300000546' , '1017421525' , '梅先俊' , '首笔' , '已生效' ) , ( 'HTBH2024110100001436' , '' , '1017792375' , '张现伟' , '首笔' , '未生效' ) , ( 'HTBH2024100800005170' , 'BA2019112200002438' , '1018075035' , '吴银娟' , '首笔' , '已生效' ) , ( 'HTBH2024101800002466' , '' , '1018799423' , '周渊' , '首笔' , '已生效' ) , ( 'HTBH2024101100000175' , '' , '1018846664' , '严全根' , '首笔' , '未生效' ) , ( 'HTBH2024100800005275' , 'BA2019112100000957' , '1019683769' , '孙亚鹏' , '首笔' , '已生效' ) , ( 'HTBH2024102400002178' , 'BA2024102400000367' , '1020097746' , '毛镔瑶' , '首笔' , '未生效' ) , ( 'HTBH2024100800004125' , 'BA2019102200003458' , '1021790565' , '王超' , '首笔' , '已生效' ) , ( 'HTBH2024102100001825' , '' , '1022464630' , '方秋平' , '首笔' , '已生效' ) , ( 'HTBH2024100900002675' , '' , '1022631304' , '孙建' , '首笔' , '已生效' ) , ( 'HTBH2024110400001506' , '' , '1026394519' , '丁丽红' , '首笔' , '未生效' ) , ( 'HTBH2024100800004650' , 'BA2019101100000982' , '1026961773' , '王哲鑫' , '首笔' , '已生效' ) , ( 'HTBH2024102900003361' , '' , '1027870722' , '叶瑞平' , '首笔' , '已生效' ) , ( 'HTBH2024102900002622' , '' , '1028124884' , '周作勇' , '首笔' , '已生效' ) , ( 'HTBH2024101400002595' , '' , '1029109024' , '李新良' , '首笔' , '已生效' ) , ( 'HTBH2024101400002494' , '' , '1029896191' , '张学苏' , '首笔' , '未生效' ) , ( 'HTBH2024101400000249' , '' , '1030377546' , '俞禄敏' , '首笔' , '已生效' ) , ( 'HTBH2024103000001232' , 'BA2024103000000303' , '1031401660' , '周骏' , '首笔' , '未生效' ) , ( 'HTBH2024101000000443' , '' , '1033539758' , '徐平飞' , '首笔' , '已生效' ) , ( 'HTBH2024101500000444' , 'BA2024101500000088' , '1033713561' , '方俊翔' , '首笔' , '已生效' ) , ( 'HTBH2024100800003031' , 'BA2019110100001582' , '1034355386' , '丁金长' , '首笔' , '已生效' ) , ( 'HTBH2024101700000712' , '' , '1034380166' , '张卫平' , '首笔' , '已生效' ) , ( 'HTBH2024101000000891' , '' , '1035272341' , '许欢欢' , '首笔' , '已生效' ) , ( 'HTBH2024101400001290' , 'BA2024101400000263' , '1036143251' , '徐林芝' , '首笔' , '未生效' ) , ( 'HTBH2024102800001856' , 'BA2024102800000302' , '1036568670' , '王屹' , '首笔' , '未生效' ) , ( 'HTBH2024103000003221' , '' , '1037334520' , '陈涛' , '首笔' , '未生效' ) , ( 'HTBH2024102200000045' , '' , '1037532201' , '范丽君' , '首笔' , '已生效' ) , ( 'HTBH2024100800004538' , 'BA2019112100001806' , '1038546373' , '瞿潇潇' , '首笔' , '已生效' ) , ( 'HTBH2024100800003823' , 'BA2019102200001054' , '1038691213' , '陈伟锋' , '首笔' , '已生效' ) , ( 'HTBH2024101200000911' , 'BA2024101200000219' , '1038703792' , '王红娣' , '首笔' , '已生效' ) , ( 'HTBH2024101400001102' , '' , '1038703792' , '王红娣' , '首笔' , '已生效' ) , ( 'HTBH2024101500002982' , 'BA2024101500000534' , '1038751946' , '景晨涛' , '首笔' , '未生效' ) , ( 'HTBH2024100100000108' , 'BA2024100100000075' , '1038871789' , '林煜南' , '首笔' , '已生效' ) , ( 'HTBH2024101800003168' , '' , '1039006191' , '阮奇华' , '首笔' , '已生效' ) , ( 'HTBH2024101400000613' , 'BA2024101400000140' , '1039208258' , '卓红' , '首笔' , '已生效' ) , ( 'HTBH2024100900001560' , '' , '1039211322' , '陈卫送' , '首笔' , '已生效' ) , ( 'HTBH2024100800003751' , 'BA2019111400001505' , '1040231788' , '张志奇' , '首笔' , '已生效' ) , ( 'HTBH2024101400000258' , '' , '1040288229' , '朱有忠' , '首笔' , '已生效' ) , ( 'HTBH2024102400002715' , 'BA2024102400000457' , '1040552261' , '张炎' , '首笔' , '未生效' ) , ( 'HTBH2024102900001333' , 'BA2024102900000268' , '1040762738' , '吴伟' , '首笔' , '未生效' ) , ( 'HTBH2024102300001500' , '' , '1040773525' , '陈永根' , '首笔' , '已生效' ) , ( 'HTBH2024102800001773' , 'BA2024102800000296' , '1042853382' , '陈佳利' , '首笔' , '已生效' ) , ( 'HTBH2024102900001024' , 'BA2024102900000216' , '1042899555' , '李晓峰' , '首笔' , '未生效' ) , ( 'HTBH2024102100002096' , '' , '1043460721' , '张静' , '首笔' , '已生效' ) , ( 'HTBH2024100800004064' , 'BA2019111700000370' , '1044000834' , '郑丽' , '首笔' , '已生效' ) , ( 'HTBH2024102100001406' , 'BA2021090200003663' , '1044594294' , '陈建欣' , '首笔' , '已生效' ) , ( 'HTBH2024101100001898' , 'BA2024101100000297' , '1044799574' , '王强' , '首笔' , '未生效' ) , ( 'HTBH2024100800002294' , 'BA2019112700001185' , '1044809846' , '杨慧兰' , '首笔' , '已生效' ) , ( 'HTBH2024102200001843' , 'BA2024102200000386' , '1044965100' , '张明聪' , '首笔' , '已生效' ) , ( 'HTBH2024103000004054' , '' , '1045118037' , '徐凯丽' , '首笔' , '已生效' ) , ( 'HTBH2024100800003535' , 'BA2019111800000531' , '1045122573' , '罗月清' , '首笔' , '已生效' ) , ( 'HTBH2024102300001406' , '' , '1045191535' , '毛一锋' , '首笔' , '已生效' ) , ( 'HTBH2024101300000102' , 'BA2024101300000109' , '1045455587' , '赵利友' , '首笔' , '已生效' ) , ( 'HTBH2024101400002801' , 'BA2019092600002418' , '1045503239' , '翁悦芬' , '首笔' , '已生效' ) , ( 'HTBH2024100800003001' , 'BA2019112800001409' , '1045613323' , '王莹' , '首笔' , '已生效' ) , ( 'HTBH2024101300000035' , 'BA2024101300000036' , '1600740515' , '黄生江' , '首笔' , '未生效' ) , ( 'HTBH2024101600002623' , '' , '1600855973' , '钱俞家' , '首笔' , '已生效' ) , ( 'HTBH2024102800001954' , '' , '1600943530' , '邵洪豹' , '首笔' , '已生效' ) , ( 'HTBH2024100800002526' , 'BA2019110800002134' , '1601085432' , '赵远成' , '首笔' , '已生效' ) , ( 'HTBH2024100800003119' , 'BA2019111700000044' , '1601444182' , '周普顺' , '首笔' , '已生效' ) , ( 'HTBH2024102800000739' , 'BA2024102800000149' , '1602427876' , '裘媛萍' , '首笔' , '已生效' ) , ( 'HTBH2024100800005314' , 'BA2019111900001109' , '1602515373' , '张正平' , '首笔' , '已生效' ) , ( 'HTBH2024102400003249' , '' , '1602596906' , '裘春风' , '首笔' , '冻结' ) , ( 'HTBH2024102900001022' , 'BA2024102900000217' , '1602724045' , '梁丽兵' , '首笔' , '已生效' ) , ( 'HTBH2024103100003086' , '' , '1603552163' , '陈卫红' , '首笔' , '未生效' ) , ( 'HTBH2024102600000315' , 'BA2024102600000144' , '1604014861' , '徐灵灵' , '首笔' , '未生效' ) , ( 'HTBH2024110100002774' , '' , '1604793901' , '黄丽丹' , '首笔' , '未生效' ) , ( 'HTBH2024101600002013' , '' , '1605026778' , '成晨' , '首笔' , '已生效' ) , ( 'HTBH2024101500001647' , 'BA2024101500000323' , '1605026778' , '成晨' , '首笔' , '已生效' ) , ( 'HTBH2024101500000281' , '' , '1605176684' , '徐德林' , '首笔' , '已生效' ) , ( 'HTBH2024100800003728' , 'BA2019112100000298' , '1605382611' , '王朕' , '首笔' , '已生效' ) , ( 'HTBH2024102300000793' , '' , '1605428132' , '汪华英' , '首笔' , '已生效' ) , ( 'HTBH2024101400002803' , 'BA2019092400000708' , '1605548318' , '华楠' , '首笔' , '已生效' ) , ( 'HTBH2024102200001539' , '' , '1605663060' , '孙程骏' , '首笔' , '已生效' ) , ( 'HTBH2024103000004031' , '' , '1605844309' , '赵敢' , '首笔' , '已生效' ) , ( 'HTBH2024101700002117' , 'BA2024101700000449' , '1605846866' , '徐雄明' , '首笔' , '未生效' ) , ( 'HTBH2024101400000847' , '' , '1606376147' , '谢作威' , '首笔' , '已生效' ) , ( 'HTBH2024100800000206' , 'BA2024100800000038' , '1606482658' , '刘理森' , '首笔' , '已生效' ) , ( 'HTBH2024101100001426' , '' , '1606482658' , '刘理森' , '首笔' , '已生效' ) , ( 'HTBH2024101000001397' , '' , '1606703691' , '幸冬冬' , '首笔' , '已生效' ) , ( 'HTBH2024102900002302' , '' , '1606741028' , '董梅芳' , '首笔' , '已生效' ) , ( 'HTBH2024102300000931' , '' , '1607131728' , '娄寿娟' , '首笔' , '已生效' ) , ( 'HTBH2024102100001623' , 'BA2024102100000337' , '1607323052' , '周琼' , '首笔' , '已生效' ) , ( 'HTBH2024100800004201' , 'BA2019112600000762' , '1607540059' , '徐波' , '首笔' , '已生效' ) , ( 'HTBH2024103000001409' , '' , '1607780775' , '叶辉' , '首笔' , '已生效' ) , ( 'HTBH2024101000001395' , 'BA2024101000000220' , '1608422399' , '许静' , '首笔' , '已生效' ) , ( 'HTBH2024102900000958' , '' , '1608440235' , '陈晓东' , '首笔' , '已生效' ) , ( 'HTBH2024101000002663' , '' , '1609245098' , '顾红民' , '首笔' , '已生效' ) , ( 'HTBH2024103100001472' , 'BA2024103100000256' , '1609834372' , '赵泽伟' , '首笔' , '已生效' ) , ( 'HTBH2024102500000915' , 'BA2024102500000216' , '1610029708' , '余寿亮' , '首笔' , '未生效' ) , ( 'HTBH2024100800002714' , 'BA2019110400002161' , '1610924382' , '梁快' , '首笔' , '已生效' ) , ( 'HTBH2024102200000261' , '' , '1611138920' , '王霞飞' , '首笔' , '未生效' ) , ( 'HTBH2024102200000520' , 'BA2024102200000100' , '1611340829' , '吾旋' , '首笔' , '已生效' ) , ( 'HTBH2024102400001085' , '' , '1611340829' , '吾旋' , '首笔' , '已生效' ) , ( 'HTBH2024102500000937' , 'BA2024102500000222' , '1611817394' , '王锦其' , '首笔' , '已生效' ) , ( 'HTBH2024101100000553' , 'BA2024101100000098' , '1612547631' , '魏承璐' , '首笔' , '已生效' ) , ( 'HTBH2024100800002934' , 'BA2019110900000591' , '1612566147' , '董志敏' , '首笔' , '已生效' ) , ( 'HTBH2024102800000493' , '' , '1612906761' , '陈威明' , '首笔' , '已生效' ) , ( 'HTBH2024101700000271' , '' , '1613518585' , '韩小飞' , '首笔' , '已生效' ) , ( 'HTBH2024102200001862' , '' , '1613518585' , '韩小飞' , '首笔' , '未生效' ) , ( 'HTBH2024101100001840' , 'BA2024101100000282' , '1613526929' , '冯华冰' , '首笔' , '已生效' ) , ( 'HTBH2024101100000275' , '' , '1613546935' , '余斌' , '首笔' , '已生效' ) , ( 'HTBH2024103100000741' , '' , '1614298982' , '胡轶琼' , '首笔' , '已生效' ) , ( 'HTBH2024100800004177' , 'BA2019111200001788' , '1614305658' , '许甜甜' , '首笔' , '已生效' ) , ( 'HTBH2024103100001126' , 'BA2024103100000199' , '1614727365' , '单丽' , '首笔' , '未生效' ) , ( 'HTBH2024102800001207' , '' , '1615115633' , '马中华' , '首笔' , '已生效' ) , ( 'HTBH2024102300000938' , '' , '1615614548' , '杨向勤' , '首笔' , '已生效' ) , ( 'HTBH2024100800003338' , 'BA2019112200000833' , '1615679251' , '潘建瑛' , '首笔' , '已生效' ) , ( 'HTBH2024100800003188' , 'BA2019110500000406' , '1615680849' , '周玉燕' , '首笔' , '已生效' ) , ( 'HTBH2024101400002718' , 'BA2019092600000589' , '1616133520' , '陈锋' , '首笔' , '已生效' ) , ( 'HTBH2024101600002412' , '' , '1616226119' , '朱有钿' , '首笔' , '未生效' ) , ( 'HTBH2024100800005120' , 'BA2019100700000338' , '1616389348' , '王君' , '首笔' , '已生效' ) , ( 'HTBH2024100800004735' , 'BA2019101400003253' , '1616639821' , '陈佳乐' , '首笔' , '已生效' ) , ( 'HTBH2024100800004294' , 'BA2019112600001250' , '1616740470' , '姜璎芸' , '首笔' , '已生效' ) , ( 'HTBH2024100800004850' , 'BA2019102000000485' , '1617096960' , '金嘉琪' , '首笔' , '已生效' ) , ( 'HTBH2024100800004393' , 'BA2019110200000184' , '1618346660' , '陈向' , '首笔' , '已生效' ) , ( 'HTBH2024100800004766' , 'BA2019112200002415' , '1618353259' , '陈利娅' , '首笔' , '已生效' ) , ( 'HTBH2024100800004477' , 'BA2019110200000408' , '1618370248' , '刘梦娜' , '首笔' , '已生效' ) , ( 'HTBH2024100800003492' , 'BA2019110400000083' , '1618526790' , '李影' , '首笔' , '已生效' ) , ( 'HTBH2024100800003910' , 'BA2019110400001642' , '1618575035' , '洪堃英' , '首笔' , '已生效' ) , ( 'HTBH2024100800002717' , 'BA2019110400001901' , '1618582404' , '周敏' , '首笔' , '已生效' ) , ( 'HTBH2024100800003913' , 'BA2019111200000080' , '1618698565' , '江浩' , '首笔' , '已生效' ) , ( 'HTBH2024101200001290' , 'BA2024101100000474' , '1618720639' , '庞渭东' , '首笔' , '已生效' ) , ( 'HTBH2024100800002882' , 'BA2019110500003757' , '1618784182' , '沈一鑫' , '首笔' , '已生效' ) , ( 'HTBH2024100800005097' , 'BA2019110600000524' , '1618824324' , '王鉴' , '首笔' , '已生效' ) , ( 'HTBH2024100800003566' , 'BA2019110600001537' , '1618856647' , '叶海洋' , '首笔' , '已生效' ) , ( 'HTBH2024100800002573' , 'BA2019110700001553' , '1618977728' , '陈丽妹' , '首笔' , '已生效' ) , ( 'HTBH2024100800003057' , 'BA2019110700001753' , '1618982003' , '续三贵' , '首笔' , '已生效' ) , ( 'HTBH2024100800004274' , 'BA2019110800000686' , '1619006352' , '华江强' , '首笔' , '已生效' ) , ( 'HTBH2024100800002916' , 'BA2019110700003066' , '1619009012' , '张郑' , '首笔' , '已生效' ) , ( 'HTBH2024100800004386' , 'BA2019110900000598' , '1619049905' , '黄文华' , '首笔' , '已生效' ) , ( 'HTBH2024100800003538' , 'BA2019110900000014' , '1619169641' , '李志英' , '首笔' , '已生效' ) , ( 'HTBH2024100800005271' , 'BA2019110900000033' , '1619175440' , '谢浩安' , '首笔' , '已生效' ) , ( 'HTBH2024100800004351' , 'BA2019110900000465' , '1619220299' , '潘晓英' , '首笔' , '已生效' ) , ( 'HTBH2024100800004086' , 'BA2019111000000471' , '1619305444' , '陈蓝宁' , '首笔' , '已生效' ) , ( 'HTBH2024100800003708' , 'BA2019111100000729' , '1619364352' , '吴超' , '首笔' , '已生效' ) , ( 'HTBH2024100800004487' , 'BA2019111200001492' , '1619472958' , '郑志明' , '首笔' , '已生效' ) , ( 'HTBH2024100800004618' , 'BA2019111200001786' , '1619479735' , '胡善美' , '首笔' , '已生效' ) , ( 'HTBH2024100800003713' , 'BA2019111200002208' , '1619487249' , '金飞' , '首笔' , '已生效' ) , ( 'HTBH2024100800003073' , 'BA2019111300001480' , '1619596023' , '王梦迪' , '首笔' , '已生效' ) , ( 'HTBH2024102900003595' , '' , '1619693352' , '温绅' , '首笔' , '已生效' ) , ( 'HTBH2024100800005067' , 'BA2019111400001723' , '1619700808' , '袁虎猴' , '首笔' , '已生效' ) , ( 'HTBH2024100800002787' , 'BA2019111500000343' , '1619757967' , '赵璐' , '首笔' , '已生效' ) , ( 'HTBH2024100800003457' , 'BA2019111500001015' , '1619774677' , '李敏宝' , '首笔' , '已生效' ) , ( 'HTBH2024100800005416' , 'BA2019111500002126' , '1619804611' , '涂瑞淳' , '首笔' , '已生效' ) , ( 'HTBH2024100800003417' , 'BA2019111600000304' , '1619868460' , '何培峰' , '首笔' , '已生效' ) , ( 'HTBH2024100800004313' , 'BA2019111600000519' , '1619879862' , '胡鑫' , '首笔' , '已生效' ) , ( 'HTBH2024100800004262' , 'BA2019111700000234' , '1619918343' , '郭云飞' , '首笔' , '已生效' ) , ( 'HTBH2024100800004839' , 'BA2019111800000609' , '1619957050' , '胡丹' , '首笔' , '已生效' ) , ( 'HTBH2024100800005434' , 'BA2019111800001955' , '1619961732' , '谢美红' , '首笔' , '已生效' ) , ( 'HTBH2024100800003808' , 'BA2019111800002665' , '1619994089' , '刘伟' , '首笔' , '已生效' ) , ( 'HTBH2024100800004740' , 'BA2019111800002936' , '1619998596' , '汪立云' , '首笔' , '已生效' ) , ( 'HTBH2024100800004528' , 'BA2019111900000985' , '1620064393' , '徐威' , '首笔' , '已生效' ) , ( 'HTBH2024100800002917' , 'BA2019111900002806' , '1620121531' , '林一飞' , '首笔' , '已生效' ) , ( 'HTBH2024101100002206' , '' , '1620212004' , '李一凡' , '首笔' , '已生效' ) , ( 'HTBH2024100800002841' , 'BA2019112100000321' , '1620276496' , '余美珍' , '首笔' , '已生效' ) , ( 'HTBH2024100800003427' , 'BA2019112100000415' , '1620279893' , '陈正亮' , '首笔' , '已生效' ) , ( 'HTBH2024100800002441' , 'BA2019112100001428' , '1620314240' , '李国洪' , '首笔' , '已生效' ) , ( 'HTBH2024100800002901' , 'BA2019112200000176' , '1620326278' , '余林峰' , '首笔' , '已生效' ) , ( 'HTBH2024100800003364' , 'BA2019112200000743' , '1620395764' , '段洪飞' , '首笔' , '已生效' ) , ( 'HTBH2024100800003201' , 'BA2019112200002466' , '1620459387' , '罗太江' , '首笔' , '已生效' ) , ( 'HTBH2024100800003898' , 'BA2019112200002539' , '1620467637' , '徐伟' , '首笔' , '已生效' ) , ( 'HTBH2024100800002669' , 'BA2019112300000280' , '1620512163' , '谢小东' , '首笔' , '已生效' ) , ( 'HTBH2024100800003609' , 'BA2019112500002341' , '1620703379' , '潘盈盈' , '首笔' , '已生效' ) , ( 'HTBH2024100800005123' , 'BA2019112500002981' , '1620715272' , '姜一心' , '首笔' , '已生效' ) , ( 'HTBH2024102200002712' , 'BA2024102200000528' , '1620852023' , '胡永海' , '首笔' , '未生效' ) , ( 'HTBH2024100800004051' , 'BA2019112900001557' , '1621100711' , '谢思齐' , '首笔' , '已生效' ) , ( 'HTBH2024101600001591' , '' , '1621103032' , '方禹轩' , '首笔' , '已生效' ) , ( 'HTBH2024100800004910' , 'BA2019112900002496' , '1621121615' , '汤玲丽' , '首笔' , '已生效' ) , ( 'HTBH2024101800001761' , '' , '1621866251' , '沈佳乐' , '首笔' , '已生效' ) , ( 'HTBH2024101100003055' , 'BA2024101100000475' , '1621943025' , '陆盈盈' , '首笔' , '已生效' ) , ( 'HTBH2024102500002360' , 'BA2024102300000349' , '1622000625' , '胡书芯' , '首笔' , '已生效' ) , ( 'HTBH2024110400000113' , '' , '1623672819' , '俞都' , '首笔' , '未生效' ) , ( 'HTBH2024102800001778' , '' , '1623854913' , '凌燕' , '首笔' , '已生效' ) , ( 'HTBH2024102300001001' , 'BA2024102300000240' , '1624216883' , '余秀秀' , '首笔' , '未生效' ) , ( 'HTBH2024103000004051' , '' , '1625252768' , '缪沛晶' , '首笔' , '已生效' ) , ( 'HTBH2024102500001412' , 'BA2024102500000328' , '1625508743' , '俞丹飞' , '首笔' , '未生效' ) , ( 'HTBH2024101900000033' , 'BA2024101900000013' , '1626019525' , '吴小燕' , '首笔' , '未生效' ) , ( 'HTBH2024102900003716' , 'BA2024102900000636' , '1627289477' , '张丽萍' , '首笔' , '未生效' ) , ( 'HTBH2024101000002919' , '' , '1627304249' , '王群' , '首笔' , '已生效' ) , ( 'HTBH2024101200002083' , 'BA2024101200000421' , '1627823184' , '胡昭云' , '首笔' , '未生效' ) , ( 'HTBH2024101200001953' , 'BA2024101200000398' , '1627825175' , '沈国萍' , '首笔' , '未生效' ) , ( 'HTBH2024100800000682' , '' , '1628071462' , '冯海军' , '首笔' , '已生效' ) , ( 'HTBH2024100900001889' , '' , '1628072185' , '韩权' , '首笔' , '已生效' ) , ( 'HTBH2024102900000294' , '' , '1629581073' , '何兵' , '首笔' , '已生效' ) , ( 'HTBH2024102900000783' , 'BA2024102900000166' , '1630374456' , '朱一帆' , '首笔' , '未生效' ) , ( 'HTBH2024101600002327' , '' , '1630481612' , '丁京涛' , '首笔' , '已生效' ) , ( 'HTBH2024101200000529' , 'BA2024101200000107' , '1630481612' , '丁京涛' , '首笔' , '已生效' ) , ( 'HTBH2024100300000017' , 'BA2024100300000033' , '1631245030' , '付健' , '首笔' , '未生效' ) , ( 'HTBH2024102500002075' , 'BA2024102500000399' , '1632227251' , '董佳铭' , '首笔' , '未生效' ) , ( 'HTBH2024101100002200' , '' , '1632573512' , '祝广敏' , '首笔' , '已生效' ) , ( 'HTBH2024102400002652' , '' , '1633206190' , '邢英杰' , '首笔' , '未生效' ) , ( 'HTBH2024101200001589' , '' , '1634048847' , '杨琴' , '首笔' , '已生效' ) , ( 'HTBH2024103100002205' , '' , '1635651472' , '何茂森' , '首笔' , '已生效' ) , ( 'HTBH2024102500001239' , 'BA2024102400000449' , '1635760330' , '韩金金' , '首笔' , '未生效' ) , ( 'HTBH2024101200001300' , '' , '1636753291' , '瞿叶红' , '首笔' , '已生效' ) , ( 'HTBH2024102500000890' , 'BA2024102500000196' , '1637622731' , '洪霞' , '首笔' , '已生效' ) , ( 'HTBH2024101400002658' , '' , '1638170482' , '董潜' , '首笔' , '已生效' ) , ( 'HTBH2024101300000123' , 'BA2024101300000132' , '1639800618' , '肖彤' , '首笔' , '已生效' ) , ( 'HTBH2024103000001696' , 'BA2024103000000354' , '1639986863' , '孙英滢' , '首笔' , '已生效' ) , ( 'HTBH2024110100000100' , '' , '1640190044' , '钱星琴' , '首笔' , '已生效' ) , ( 'HTBH2024101400001889' , 'BA2024101400000374' , '1640319153' , '章庆红' , '首笔' , '未生效' ) , ( 'HTBH2024101800002021' , '' , '1640319153' , '章庆红' , '首笔' , '已生效' ) , ( 'HTBH2024101100002136' , '' , '1640702106' , '章寿军' , '首笔' , '已生效' ) , ( 'HTBH2024101800003009' , '' , '1640823941' , '张照' , '首笔' , '已生效' ) , ( 'HTBH2024102700000038' , 'BA2024102700000036' , '1641706459' , '周石炳' , '首笔' , '已生效' ) , ( 'HTBH2024100900002567' , '' , '1641855992' , '陈学文' , '首笔' , '已生效' ) , ( 'HTBH2024102100002131' , '' , '1642454789' , '怀锐' , '首笔' , '已生效' ) , ( 'HTBH2024101100002803' , '' , '1642474310' , '何广文' , '首笔' , '已生效' ) , ( 'HTBH2024100800000434' , '' , '1642861205' , '李中友' , '首笔' , '已生效' ) , ( 'HTBH2024102400003294' , '' , '1643084516' , '高圆圆' , '首笔' , '已生效' ) , ( 'HTBH2024100800001318' , '' , '1643392273' , '来延安' , '首笔' , '已生效' ) , ( 'HTBH2024102300000008' , '' , '1643598187' , '邵永浩' , '首笔' , '已生效' ) , ( 'HTBH2024102800000794' , 'BA2024102800000153' , '1643679451' , '傅新新' , '首笔' , '未生效' ) , ( 'HTBH2024102800000682' , '' , '1643879281' , '蒋美玲' , '首笔' , '已生效' ) , ( 'HTBH2024102900001475' , '' , '1644065194' , '萧炜倩' , '首笔' , '已生效' ) , ( 'HTBH2024102100002258' , '' , '1644088862' , '樊丹怡' , '首笔' , '已生效' ) , ( 'HTBH2024100900000703' , '' , '1644787223' , '程丽' , '首笔' , '已生效' ) , ( 'HTBH2024101600002780' , 'BA2024101600000559' , '1644908613' , '李佳锋' , '首笔' , '未生效' ) , ( 'HTBH2024101600000174' , 'BA2024101600000024' , '1645332437' , '王康' , '首笔' , '未生效' ) , ( 'HTBH2024102200000135' , '' , '1645873184' , '管钟颖' , '首笔' , '已生效' ) , ( 'HTBH2024103000000365' , '' , '1646356745' , '唐国其' , '首笔' , '已生效' ) , ( 'HTBH2024102400001039' , '' , '1647749714' , '张水林' , '首笔' , '已生效' ) , ( 'HTBH2024110200000200' , '' , '1648450132' , '赵静静' , '首笔' , '未生效' ) , ( 'HTBH2024102400002362' , '' , '1651898354' , '黄风月' , '首笔' , '已生效' ) , ( 'HTBH2024100800001361' , '' , '1653542107' , '詹志生' , '首笔' , '已生效' ) , ( 'HTBH2024102100001680' , '' , '1654206000' , '胡益凤' , '首笔' , '已生效' ) , ( 'HTBH2024101600000002' , '' , '1655607268' , '向忠平' , '首笔' , '已生效' ) , ( 'HTBH2024103000004173' , 'BA2024103000000756' , '1656057649' , '邓林涛' , '首笔' , '未生效' ) , ( 'HTBH2024100800000220' , '' , '1666442070' , '徐仕刚' , '首笔' , '冻结' ) , ( 'HTBH2024101400002534' , '' , '1666542822' , '俞增平' , '首笔' , '已生效' ) , ( 'HTBH2024102900001009' , '' , '1666626562' , '徐观明' , '首笔' , '已生效' ) , ( 'HTBH2024102900000697' , '' , '1667937812' , '金银' , '首笔' , '已生效' ) , ( 'HTBH2024101700000262' , '' , '1668010948' , '范建荣' , '首笔' , '已生效' ) , ( 'HTBH2024102900000228' , 'BA2024102900000020' , '1669092987' , '翁项鑫' , '首笔' , '未生效' ) , ( 'HTBH2024102200001410' , '' , '1670286786' , '赵健凯' , '首笔' , '已生效' ) , ( 'HTBH2024101200001163' , 'BA2024101200000281' , '1671470475' , '徐春燕' , '首笔' , '已生效' ) , ( 'HTBH2024103000003558' , '' , '1671521535' , '刘国常' , '首笔' , '已生效' ) , ( 'HTBH2024101100001125' , 'BA2024101100000186' , '1671885246' , '莫国海' , '首笔' , '已生效' ) , ( 'HTBH2024101500000616' , 'BA2024101500000128' , '1673186354' , '张佳涛' , '首笔' , '已生效' ) , ( 'HTBH2024102200000413' , '' , '1673186354' , '张佳涛' , '首笔' , '已生效' ) , ( 'HTBH2024102500000655' , 'BA2024102500000121' , '1673535084' , '杨晓芳' , '首笔' , '已生效' ) , ( 'HTBH2024103000001141' , '' , '1673978841' , '卓瑜琳' , '首笔' , '已生效' ) , ( 'HTBH2024100600000077' , 'BA2024100600000126' , '1674641696' , '曹冠亚' , '首笔' , '未生效' ) , ( 'HTBH2024102900001209' , '' , '1675184403' , '徐斌杰' , '首笔' , '已生效' ) , ( 'HTBH2024102400000969' , '' , '1675197618' , '袁方伟' , '首笔' , '已生效' ) , ( 'HTBH2024103100000791' , 'BA2024103100000116' , '1675808163' , '包剑琦' , '首笔' , '未生效' ) , ( 'HTBH2024102200002771' , '' , '1676783738' , '章甜甜' , '首笔' , '已生效' ) , ( 'HTBH2024103000000360' , '' , '1677621055' , '曹辉' , '首笔' , '已生效' ) , ( 'HTBH2024101000003293' , 'BA2024101000000451' , '1677707287' , '钱卓恒' , '首笔' , '已生效' ) , ( 'HTBH2024101100002034' , 'BA2024101100000305' , '1677720563' , '曾苏莹' , '首笔' , '未生效' ) , ( 'HTBH2024101000003294' , 'BA2024101000000453' , '1677911738' , '陈佳怡' , '首笔' , '未生效' ) , ( 'HTBH2024101500003007' , 'BA2024101500000542' , '1678165371' , '孙莹瑛' , '首笔' , '已生效' ) , ( 'HTBH2024101500001996' , '' , '1678199822' , '赵栋寅' , '首笔' , '已生效' ) , ( 'HTBH2024102500001471' , 'BA2024102500000333' , '1678325851' , '吴伊伦' , '首笔' , '未生效' ) , ( 'HTBH2024101500003006' , 'BA2024101500000541' , '1678604116' , '钱炜强' , '首笔' , '已生效' ) , ( 'HTBH2024102200002731' , '' , '1678746508' , '周品妍' , '首笔' , '已生效' ) , ( 'HTBH2024101500002674' , '' , '1678951986' , '汪轮欢' , '首笔' , '已生效' ) , ( 'HTBH2024102900003287' , '' , '1678953011' , '沈宏' , '首笔' , '已生效' ) , ( 'HTBH2024101700001807' , 'BA2024101700000385' , '1678962412' , '崔振' , '首笔' , '已生效' ) , ( 'HTBH2024103100000709' , 'BA2024103100000117' , '1678962429' , '董凯' , '首笔' , '未生效' ) , ( 'HTBH2024101100000233' , 'BA2024101100000031' , '1679091490' , '李楚慧' , '首笔' , '未生效' ) , ( 'HTBH2024101400001316' , 'BA2024101400000264' , '1679348091' , '胡敬' , '首笔' , '未生效' ) , ( 'HTBH2024101500000219' , 'BA2024101500000025' , '1679541126' , '袁满桂' , '首笔' , '已生效' ) , ( 'HTBH2024102200002725' , '' , '1679716742' , '魏波' , '首笔' , '已生效' ) , ( 'HTBH2024101600001584' , '' , '1679764318' , '毛金娣' , '首笔' , '已生效' ) , ( 'HTBH2024102500000654' , 'BA2024102500000123' , '1680358016' , '张志文' , '首笔' , '未生效' ) , ( 'HTBH2024101800000921' , 'BA2024101800000164' , '1680807616' , '郑杰' , '首笔' , '未生效' ) , ( 'HTBH2024101600000152' , '' , '1681115918' , '陈吴珍' , '首笔' , '已生效' ) , ( 'HTBH2024102300002575' , '' , '1681231430' , '丁墨旅' , '首笔' , '已生效' ) , ( 'HTBH2024102400000670' , 'BA2024102400000089' , '1681396482' , '汪诗恬' , '首笔' , '已生效' ) , ( 'HTBH2024101700000783' , '' , '1681551742' , '羊颖姣' , '首笔' , '已生效' ) , ( 'HTBH2024102300000255' , 'BA2024102300000029' , '1682044160' , '邢颖' , '首笔' , '已生效' ) , ( 'HTBH2024102800001689' , 'BA2024102800000285' , '1682481520' , '俞桑' , '首笔' , '未生效' ) , ( 'HTBH2024103100000696' , '' , '1682483437' , '柯根明' , '首笔' , '已生效' ) , ( 'HTBH2024101200002779' , 'BA2024101200000567' , '1682488452' , '冯倪滢' , '首笔' , '已生效' ) , ( 'HTBH2024102300000858' , '' , '1683334318' , '饶连春' , '首笔' , '已生效' ) , ( 'HTBH2024101500002899' , 'BA2024101500000513' , '1683380086' , '江文波' , '首笔' , '已生效' ) , ( 'HTBH2024101200000136' , '' , '1683683348' , '翁泽辉' , '首笔' , '已生效' ) , ( 'HTBH2024103100001471' , '' , '1683711123' , '余秉钧' , '首笔' , '已生效' ) , ( 'HTBH2024101200000662' , 'BA2024101200000154' , '1684082322' , '张屹锋' , '首笔' , '未生效' ) , ( 'HTBH2024101100002527' , '' , '1684184975' , '韩潇' , '首笔' , '已生效' ) , ( 'HTBH2024102400000067' , '' , '1684444274' , '黄燕峰' , '首笔' , '已生效' ) , ( 'HTBH2024102300000241' , '' , '1684447240' , '张坤鹏' , '首笔' , '已生效' ) , ( 'HTBH2024102100002532' , '' , '1684572664' , '曹建芳' , '首笔' , '已生效' ) , ( 'HTBH2024101400000921' , '' , '1684666924' , '王国方' , '首笔' , '已生效' ) , ( 'HTBH2024103000003312' , '' , '1684722751' , '陈彬翔' , '首笔' , '已生效' ) , ( 'HTBH2024101000002451' , '' , '1685005794' , '李依' , '首笔' , '已生效' ) , ( 'HTBH2024101400001566' , 'BA2024101400000300' , '1685134745' , '徐林静' , '首笔' , '未生效' ) , ( 'HTBH2024101400001558' , 'BA2024101400000293' , '1685134745' , '徐林静' , '首笔' , '未生效' ) , ( 'HTBH2024102400000597' , '' , '1685148485' , '马娟芳' , '首笔' , '已生效' ) , ( 'HTBH2024101700000932' , 'BA2024101700000215' , '1685148485' , '马娟芳' , '首笔' , '已生效' ) , ( 'HTBH2024103000000368' , 'BA2024103000000059' , '1685180303' , '管志花' , '首笔' , '已生效' ) , ( 'HTBH2024101400002855' , '' , '1685182480' , '姚佳莉' , '首笔' , '已生效' ) , ( 'HTBH2024101500000831' , 'BA2024101500000175' , '1685188718' , '夏俐伟' , '首笔' , '未生效' ) , ( 'HTBH2024101200000735' , '' , '1685193569' , '胡桐' , '首笔' , '已生效' ) , ( 'HTBH2024102900001386' , 'BA2024102900000274' , '1685328790' , '杨奕' , '首笔' , '未生效' ) , ( 'HTBH2024102300001140' , '' , '1685419078' , '沈平舟' , '首笔' , '已生效' ) , ( 'HTBH2024103000004050' , '' , '1685620267' , '杨春富' , '首笔' , '已生效' ) , ( 'HTBH2024101600002142' , 'BA2024101600000439' , '1685649246' , '王波波' , '首笔' , '未生效' ) , ( 'HTBH2024103100000142' , '' , '1685717568' , '张小明' , '首笔' , '已生效' ) , ( 'HTBH2024101900000276' , '' , '1686304657' , '钟琴' , '首笔' , '已生效' ) , ( 'HTBH2024101900000269' , '' , '1686304741' , '张嘉成' , '首笔' , '已生效' ) , ( 'HTBH2024102900003704' , 'BA2024102900000627' , '1687245413' , '朱建夫' , '首笔' , '未生效' ) , ( 'HTBH2024103000001402' , '' , '1687253688' , '王玉臣' , '首笔' , '已生效' ) , ( 'HTBH2024103100002067' , '' , '1687854075' , '冯恬恬' , '首笔' , '已生效' ) , ( 'HTBH2024102300000444' , 'BA2024102300000079' , '1688451133' , '詹燕龙' , '首笔' , '未生效' ) , ( 'HTBH2024101800000847' , 'BA2024101800000101' , '1689203778' , '王雪飞' , '首笔' , '未生效' ) , ( 'HTBH2024101200002390' , 'BA2024101200000481' , '1689552020' , '李慧敏' , '首笔' , '未生效' ) , ( 'HTBH2024103100000228' , 'BA2024103100000035' , '1689601574' , '候东铭' , '首笔' , '已生效' ) , ( 'HTBH2024102500001424' , '' , '1689722258' , '姚国钧' , '首笔' , '已生效' ) , ( 'HTBH2024101100001921' , '' , '1690560106' , '杨卫平' , '首笔' , '已生效' ) , ( 'HTBH2024102900000301' , 'BA2024102900000034' , '1690594777' , '姚芳' , '首笔' , '已生效' ) , ( 'HTBH2024103000000233' , '' , '1690955127' , '来驰' , '首笔' , '已生效' ) , ( 'HTBH2024102400001172' , '' , '1690973250' , '游乔晖' , '首笔' , '已生效' ) , ( 'HTBH2024101700000817' , '' , '1690999656' , '汪俊杰' , '首笔' , '已生效' ) , ( 'HTBH2024103100000822' , '' , '1692707913' , '杨小龙' , '首笔' , '已生效' ) , ( 'HTBH2024102500000927' , 'BA2024102500000221' , '1692836583' , '钱俊燕' , '首笔' , '未生效' ) , ( 'HTBH2024102900001513' , '' , '1693426790' , '何晓丽' , '首笔' , '已生效' ) , ( 'HTBH2024102200000138' , '' , '1693543788' , '徐宏军' , '首笔' , '已生效' ) , ( 'HTBH2024101800001345' , '' , '1694011813' , '来建楠' , '首笔' , '已生效' ) , ( 'HTBH2024101600002832' , '' , '1694176908' , '储圆芳' , '首笔' , '已生效' ) , ( 'HTBH2024102400003205' , '' , '1694214778' , '高芸钰' , '首笔' , '已生效' ) , ( 'HTBH2024102900002802' , '' , '1695141226' , '雷梦宇' , '首笔' , '已生效' ) , ( 'HTBH2024102800002667' , 'BA2024102800000428' , '1695578818' , '唐德兰' , '首笔' , '已生效' ) , ( 'HTBH2024102200001183' , '' , '1695604000' , '叶旭光' , '首笔' , '未生效' ) , ( 'HTBH2024101700001054' , '' , '1695609584' , '周雯' , '首笔' , '已生效' ) , ( 'HTBH2024101700001056' , '' , '1695609897' , '赵叶琪' , '首笔' , '已生效' ) , ( 'HTBH2024101500002509' , '' , '1695901219' , '何羽雯' , '首笔' , '已生效' ) , ( 'HTBH2024103000002155' , 'BA2024103000000406' , '1696108136' , '施锦辉' , '首笔' , '未生效' ) , ( 'HTBH2024101800001028' , '' , '1696492738' , '郑慧华' , '首笔' , '已生效' ) , ( 'HTBH2024101800001187' , 'BA2024101800000198' , '1696499340' , '江鑫宇' , '首笔' , '已生效' ) , ( 'HTBH2024102900001514' , '' , '1696539506' , '倪观跃' , '首笔' , '已生效' ) , ( 'HTBH2024102300000433' , '' , '1696751479' , '陆国泉' , '首笔' , '已生效' ) , ( 'HTBH2024103100001739' , 'BA2024103100000339' , '1697083497' , '李潇婷' , '首笔' , '未生效' ) , ( 'HTBH2024101500000899' , '' , '1697201080' , '江佳涛' , '首笔' , '已生效' ) , ( 'HTBH2024101600000386' , '' , '1697379958' , '许海鹏' , '首笔' , '已生效' ) , ( 'HTBH2024102200000391' , '' , '1698183156' , '何星月' , '首笔' , '已生效' ) , ( 'HTBH2024100900002523' , 'BA2024100900000275' , '1699672963' , '蔡雨轩' , '首笔' , '未生效' ) , ( 'HTBH2024102100002537' , '' , '1699672963' , '蔡雨轩' , '首笔' , '已生效' ) , ( 'HTBH2024101700002727' , '' , '1701594291' , '胡腊辉' , '首笔' , '已生效' ) , ( 'HTBH2024101800000569' , 'BA2024101800000074' , '1703185870' , '洪啸天' , '首笔' , '未生效' ) , ( 'HTBH2024103000004058' , 'BA2024103000000685' , '1703958587' , '厉才峰' , '首笔' , '未生效' ) , ( 'HTBH2024102200001718' , 'BA2024102200000373' , '1705218021' , '李更丰' , '首笔' , '已生效' ) , ( 'HTBH2024101600002625' , '' , '1706081695' , '吴胜' , '首笔' , '已生效' ) , ( 'HTBH2024102300000086' , '' , '1706320328' , '蒋帆' , '首笔' , '已生效' ) , ( 'HTBH2024101700001525' , 'BA2024101700000327' , '1708541396' , '赵春祥' , '首笔' , '未生效' ) , ( 'HTBH2024101400002144' , '' , '1709057576' , '邓艳丽' , '首笔' , '已生效' ) , ( 'HTBH2024102800001046' , '' , '1709864230' , '李忠春' , '首笔' , '已生效' ) , ( 'HTBH2024101500000913' , '' , '1709969298' , '项月琴' , '首笔' , '已生效' ) , ( 'HTBH2024102100001091' , '' , '1709969873' , '洪玛丽' , '首笔' , '已生效' ) , ( 'HTBH2024102200000032' , 'BA2024102100000530' , '1710067535' , '吴建英' , '首笔' , '已生效' ) , ( 'HTBH2024102100002059' , '' , '1710251268' , '吴佳斌' , '首笔' , '已生效' ) , ( 'HTBH2024100900001519' , 'BA2024100900000260' , '1710432134' , '吴加程' , '首笔' , '已生效' ) , ( 'HTBH2024101000002100' , '' , '1710432134' , '吴加程' , '首笔' , '已生效' ) , ( 'HTBH2024101700002088' , '' , '1710817303' , '商睿' , '首笔' , '已生效' ) , ( 'HTBH2024102800000746' , '' , '1711539768' , '王冬英' , '首笔' , '已生效' ) , ( 'HTBH2024101500002102' , 'BA2024101500000411' , '1711710743' , '王海港' , '首笔' , '已生效' ) , ( 'HTBH2024101200001261' , '' , '1711758534' , '朱红娟' , '首笔' , '已生效' ) , ( 'HTBH2024103100000238' , 'BA2024103100000036' , '1711840643' , '朱阳杨' , '首笔' , '未生效' ) , ( 'HTBH2024102800002654' , 'BA2024102800000421' , '1712094006' , '郭定龙' , '首笔' , '未生效' ) , ( 'HTBH2024100800001593' , '' , '1712559152' , '洪萍' , '首笔' , '冻结' ) , ( 'HTBH2024103000004162' , '' , '1712628439' , '严亮' , '首笔' , '已生效' ) , ( 'HTBH2024100800000871' , 'BA2024100800000143' , '1712838770' , '鲁庙达' , '首笔' , '未生效' ) , ( 'HTBH2024102300002224' , '' , '1712945664' , '张博' , '首笔' , '已生效' ) , ( 'HTBH2024102400000132' , '' , '1713093869' , '杨梅' , '首笔' , '未生效' ) , ( 'HTBH2024101700000934' , 'BA2024101700000216' , '1713500050' , '谢媛' , '首笔' , '未生效' ) , ( 'HTBH2024102700000154' , '' , '1713669178' , '潘孟英' , '首笔' , '已生效' ) , ( 'HTBH2024102500002036' , '' , '1713725438' , '杨子颢' , '首笔' , '已生效' ) , ( 'HTBH2024103000002789' , '' , '1713812706' , '韦武面' , '首笔' , '已生效' ) , ( 'HTBH2024102600000073' , 'BA2024102600000041' , '1714427231' , '汪欢松' , '首笔' , '未生效' ) , ( 'HTBH2024102800002784' , '' , '1714491380' , '何蒋依' , '首笔' , '已生效' ) , ( 'HTBH2024102500000689' , '' , '1714543644' , '佟强' , '首笔' , '已生效' ) , ( 'HTBH2024101800000764' , 'BA2024101800000067' , '1714588929' , '朱记南' , '首笔' , '未生效' ) , ( 'HTBH2024102900001954' , 'BA2024102900000331' , '1714645967' , '潘华华' , '首笔' , '未生效' ) , ( 'HTBH2024102200002023' , '' , '1714701336' , '吴敏超' , '首笔' , '已生效' ) , ( 'HTBH2024102200000675' , '' , '1715187377' , '张光宇' , '首笔' , '已生效' ) , ( 'HTBH2024101400002324' , '' , '1715425139' , '黄永平' , '首笔' , '已生效' ) , ( 'HTBH2024103100001778' , 'BA2024103100000337' , '1716744453' , '薛韵钰' , '首笔' , '已生效' ) , ( 'HTBH2024101000001078' , 'BA2024101000000187' , '1716769621' , '杨睿' , '首笔' , '未生效' ) , ( 'HTBH2024101000001194' , '' , '1717754675' , '沈伟英' , '首笔' , '已生效' ) , ( 'HTBH2024100900002701' , '' , '1717961712' , '丁勇' , '首笔' , '已生效' ) , ( 'HTBH2024102500000041' , '' , '1718510932' , '俞王丽' , '首笔' , '未生效' ) , ( 'HTBH2024101700001655' , 'BA2024101700000365' , '1718607453' , '袁俊海' , '首笔' , '已生效' ) , ( 'HTBH2024102500003313' , '' , '1718819482' , '张帅' , '首笔' , '已生效' ) , ( 'HTBH2024102800002290' , '' , '1718819482' , '张帅' , '首笔' , '未生效' ) , ( 'HTBH2024101800001946' , 'BA2024101800000317' , '1719045992' , '穆思宇' , '首笔' , '已生效' ) , ( 'HTBH2024100900002374' , '' , '1719509536' , '华荣明' , '首笔' , '已生效' ) , ( 'HTBH2024102500000909' , 'BA2024102500000209' , '1719596973' , '吴玉琴' , '首笔' , '未生效' ) , ( 'HTBH2024101400001124' , '' , '1719644990' , '陈晓伟' , '首笔' , '已生效' ) , ( 'HTBH2024101800001296' , '' , '1719772559' , '黄昌军' , '首笔' , '已生效' ) , ( 'HTBH2024101500001058' , 'BA2024101500000209' , '1719814454' , '竹杭丽' , '首笔' , '未生效' ) , ( 'HTBH2024103100002188' , '' , '1719890132' , '姚新华' , '首笔' , '未生效' ) , ( 'HTBH2024100900000840' , '' , '1720142607' , '萧春良' , '首笔' , '已生效' ) , ( 'HTBH2024101500000864' , '' , '1720285705' , '孙青' , '首笔' , '已生效' ) , ( 'HTBH2024102300000425' , '' , '1720431400' , '周飞翔' , '首笔' , '已生效' ) , ( 'HTBH2024102900000243' , '' , '1720588195' , '许怡' , '首笔' , '已生效' ) , ( 'HTBH2024102800000185' , '' , '1720793809' , '罗标' , '首笔' , '已生效' ) , ( 'HTBH2024101800001005' , 'BA2024101700000504' , '1720905745' , '张来君' , '首笔' , '未生效' ) , ( 'HTBH2024102300001977' , '' , '1720964407' , '吴赛芬' , '首笔' , '已生效' ) , ( 'HTBH2024101600001202' , 'BA2024101600000228' , '1721148766' , '车佩佩' , '首笔' , '已生效' ) , ( 'HTBH2024102300001744' , 'BA2024102300000315' , '1721225802' , '詹旭丹' , '首笔' , '已生效' ) , ( 'HTBH2024102300001647' , 'BA2024102300000361' , '1721344815' , '杨元竹' , '首笔' , '已生效' ) , ( 'HTBH2024101700002337' , '' , '1722138625' , '倪梦云' , '首笔' , '已生效' ) , ( 'HTBH2024103000000096' , '' , '1722177383' , '张艳彬' , '首笔' , '已生效' ) , ( 'HTBH2024101700001463' , 'BA2024101700000318' , '1722449678' , '张朝鲜' , '首笔' , '已生效' ) , ( 'HTBH2024102100000972' , '' , '1722449678' , '张朝鲜' , '首笔' , '已生效' ) , ( 'HTBH2024102300000906' , '' , '1722649370' , '邵亚君' , '首笔' , '已生效' ) , ( 'HTBH2024102800000579' , '' , '1722788418' , '周凯波' , '首笔' , '已生效' ) , ( 'HTBH2024102900003106' , '' , '1723184275' , '毛小红' , '首笔' , '已生效' ) , ( 'HTBH2024103000004097' , 'BA2024103000000707' , '1723227078' , '温泓涛' , '首笔' , '未生效' ) , ( 'HTBH2024101400001372' , '' , '1724158255' , '陈奉连' , '首笔' , '已生效' ) , ( 'HTBH2024102400001883' , '' , '1724332950' , '刘晓慧' , '首笔' , '已生效' ) , ( 'HTBH2024100600000065' , 'BA2024100600000053' , '1724465359' , '田俊来' , '首笔' , '已生效' ) , ( 'HTBH2024101700001021' , '' , '1724565587' , '周琪' , '首笔' , '已生效' ) , ( 'HTBH2024101500000368' , '' , '1724724564' , '赵成祥' , '首笔' , '已生效' ) , ( 'HTBH2024101800002191' , 'BA2024101800000360' , '1724851346' , '李若新' , '首笔' , '已生效' ) , ( 'HTBH2024102400002586' , '' , '1725112122' , '郑瑾' , '首笔' , '已生效' ) , ( 'HTBH2024101000002353' , '' , '1725428623' , '唐菊华' , '首笔' , '已生效' ) , ( 'HTBH2024101800001463' , '' , '1725761075' , '郑泽刚' , '首笔' , '已生效' ) , ( 'HTBH2024100600000067' , 'BA2024100600000102' , '1725962371' , '张子涵' , '首笔' , '已生效' ) , ( 'HTBH2024102300002316' , '' , '1726511964' , '陶蓓蓓' , '首笔' , '已生效' ) , ( 'HTBH2024102700000135' , 'BA2024102700000111' , '1726622443' , '顾宇晨' , '首笔' , '未生效' ) , ( 'HTBH2024102300002633' , '' , '1726676339' , '王春辉' , '首笔' , '已生效' ) , ( 'HTBH2024101500001650' , '' , '1726683453' , '姜利民' , '首笔' , '已生效' ) , ( 'HTBH2024100900002442' , 'BA2024100900000389' , '1726736420' , '冯一哲' , '首笔' , '未生效' ) , ( 'HTBH2024102400001383' , '' , '1727236386' , '赵军海' , '首笔' , '已生效' ) , ( 'HTBH2024102400000126' , '' , '1727257340' , '鲁靖靖' , '首笔' , '未生效' ) , ( 'HTBH2024102100002427' , '' , '1727287722' , '翁来超' , '首笔' , '未生效' ) , ( 'HTBH2024101400000174' , '' , '1727304758' , '邵光业' , '首笔' , '已生效' ) , ( 'HTBH2024101800000855' , 'BA2024101800000148' , '1727308256' , '沈张玲' , '首笔' , '未生效' ) , ( 'HTBH2024101800002095' , 'BA2024101800000332' , '1727377913' , '吕华斌' , '首笔' , '未生效' ) , ( 'HTBH2024101500000024' , '' , '1727534122' , '章加鸿' , '首笔' , '已生效' ) , ( 'HTBH2024103000002951' , '' , '1727540617' , '殷健' , '首笔' , '已生效' ) , ( 'HTBH2024101600002615' , '' , '1727556923' , '余一帆' , '首笔' , '未生效' ) , ( 'HTBH2024100200000018' , 'BA2024100200000028' , '1727559772' , '叶建南' , '首笔' , '已生效' ) , ( 'HTBH2024102500001965' , '' , '1727607483' , '夏小龙' , '首笔' , '已生效' ) , ( 'HTBH2024101700000416' , '' , '1727658533' , '潘兰煜' , '首笔' , '已生效' ) , ( 'HTBH2024101600002306' , '' , '1727660232' , '丁金炜' , '首笔' , '已生效' ) , ( 'HTBH2024101600002769' , '' , '1727694462' , '唐娟' , '首笔' , '已生效' ) , ( 'HTBH2024101500002288' , '' , '1727738613' , '巫筱仙' , '首笔' , '已生效' ) , ( 'HTBH2024100900000565' , '' , '1727843564' , '高文华' , '首笔' , '已生效' ) , ( 'HTBH2024102400000298' , '' , '1727870320' , '葛晋铭' , '首笔' , '已生效' ) , ( 'HTBH2024102200001057' , '' , '1727882382' , '王康' , '首笔' , '已生效' ) , ( 'HTBH2024101000001571' , '' , '1727922676' , '余聪' , '首笔' , '已生效' ) , ( 'HTBH2024101500000512' , '' , '1727939808' , '方丹峰' , '首笔' , '已生效' ) , ( 'HTBH2024100800000223' , '' , '1727994613' , '汤立华' , '首笔' , '未生效' ) , ( 'HTBH2024100800000213' , '' , '1727995384' , '孙国顺' , '首笔' , '冻结' ) , ( 'HTBH2024101600001979' , '' , '1728093275' , '段永' , '首笔' , '已生效' ) , ( 'HTBH2024101100003128' , '' , '1728102299' , '朱宝龙' , '首笔' , '已生效' ) , ( 'HTBH2024102200000268' , '' , '1728121195' , '严建军' , '首笔' , '已生效' ) , ( 'HTBH2024102300000917' , '' , '1728155855' , '朱公正' , '首笔' , '未生效' ) , ( 'HTBH2024102200000334' , '' , '1728214547' , '童未黎' , '首笔' , '已生效' ) , ( 'HTBH2024100800000431' , '' , '1728226178' , '黄维云' , '首笔' , '已生效' ) , ( 'HTBH2024101500002984' , '' , '1728273472' , '王炜' , '首笔' , '已生效' ) , ( 'HTBH2024102600000292' , '' , '1728282940' , '沈学川' , '首笔' , '已生效' ) , ( 'HTBH2024102900000774' , '' , '1728348776' , '褚永明' , '首笔' , '已生效' ) , ( 'HTBH2024101200000830' , '' , '1728349869' , '汪华军' , '首笔' , '已生效' ) , ( 'HTBH2024100800002172' , '' , '1728351982' , '王涛' , '首笔' , '已生效' ) , ( 'HTBH2024102500001004' , '' , '1728359398' , '韦晓东' , '首笔' , '已生效' ) , ( 'HTBH2024101700000030' , '' , '1728361927' , '丁巨波' , '首笔' , '已生效' ) , ( 'HTBH2024102500000127' , '' , '1728364299' , '陈建余' , '首笔' , '已生效' ) , ( 'HTBH2024101500000047' , '' , '1728374140' , '陈静' , '首笔' , '已生效' ) , ( 'HTBH2024102100000394' , 'BA2024102100000072' , '1728377752' , '章建英' , '首笔' , '未生效' ) , ( 'HTBH2024102100001136' , '' , '1728377752' , '章建英' , '首笔' , '已生效' ) , ( 'HTBH2024102500002914' , '' , '1728383322' , '唐卫国' , '首笔' , '已生效' ) , ( 'HTBH2024100900002591' , '' , '1728392800' , '史万余' , '首笔' , '已生效' ) , ( 'HTBH2024102200002673' , '' , '1728412631' , '吴志华' , '首笔' , '已生效' ) , ( 'HTBH2024101500002504' , 'BA2024101500000477' , '1728431426' , '赵一镮' , '首笔' , '已生效' ) , ( 'HTBH2024102200000123' , '' , '1728467442' , '王钟鸣' , '首笔' , '已生效' ) , ( 'HTBH2024101400001842' , '' , '1728480442' , '刁琳琳' , '首笔' , '已生效' ) , ( 'HTBH2024100800002240' , '' , '1728488289' , '金荣升' , '首笔' , '已生效' ) , ( 'HTBH2024103000000886' , '' , '1728488380' , '陈婵娥' , '首笔' , '已生效' ) , ( 'HTBH2024102800001000' , '' , '1728511749' , '高强' , '首笔' , '已生效' ) , ( 'HTBH2024101400000447' , '' , '1728514537' , '刘琼' , '首笔' , '已生效' ) , ( 'HTBH2024100900000488' , '' , '1728514951' , '徐弋斌' , '首笔' , '已生效' ) , ( 'HTBH2024103000001694' , '' , '1728552322' , '刘康' , '首笔' , '已生效' ) , ( 'HTBH2024101400000596' , '' , '1728565248' , '李少军' , '首笔' , '未生效' ) , ( 'HTBH2024100800000205' , '' , '1728581423' , '滕伟波' , '首笔' , '已生效' ) , ( 'HTBH2024101200000753' , 'BA2024101200000169' , '1728590003' , '莫兴康' , '首笔' , '未生效' ) , ( 'HTBH2024101700002719' , '' , '1728590003' , '莫兴康' , '首笔' , '已生效' ) , ( 'HTBH2024101000003297' , '' , '1728634475' , '董赟赟' , '首笔' , '已生效' ) , ( 'HTBH2024101400000388' , '' , '1728635705' , '张奇能' , '首笔' , '已生效' ) , ( 'HTBH2024101400000050' , '' , '1728678616' , '陈利军' , '首笔' , '未生效' ) , ( 'HTBH2024102500000222' , '' , '1728687025' , '李颖灏' , '首笔' , '已生效' ) , ( 'HTBH2024101000003317' , '' , '1728689507' , '魏剑华' , '首笔' , '已生效' ) , ( 'HTBH2024102900003250' , '' , '1728694859' , '杨力' , '首笔' , '已生效' ) , ( 'HTBH2024101800002630' , 'BA2024101800000451' , '1728734322' , '王帅' , '首笔' , '未生效' ) , ( 'HTBH2024101600001139' , '' , '1728738314' , '傅鑫杰' , '首笔' , '未生效' ) , ( 'HTBH2024100900000681' , '' , '1728741335' , '张丽富' , '首笔' , '已生效' ) , ( 'HTBH2024100900000170' , '' , '1728744258' , '夏靖' , '首笔' , '已生效' ) , ( 'HTBH2024102800001848' , '' , '1728759575' , '李锴波' , '首笔' , '已生效' ) , ( 'HTBH2024102800003219' , '' , '1728761950' , '石黎明' , '首笔' , '已生效' ) , ( 'HTBH2024101000001027' , '' , '1728766019' , '丁杰' , '首笔' , '已生效' ) , ( 'HTBH2024103000000876' , '' , '1728767170' , '张诗燕' , '首笔' , '已生效' ) , ( 'HTBH2024101400001244' , '' , '1728775878' , '何佳霖' , '首笔' , '已生效' ) , ( 'HTBH2024100900001827' , '' , '1728775878' , '何佳霖' , '首笔' , '已生效' ) , ( 'HTBH2024101500000907' , 'BA2024101500000162' , '1728816037' , '刘戴宇' , '首笔' , '已生效' ) , ( 'HTBH2024100800001293' , '' , '1728816104' , '李谷' , '首笔' , '已生效' ) , ( 'HTBH2024100900000151' , '' , '1728817823' , '曾婵' , '首笔' , '已生效' ) , ( 'HTBH2024101600001199' , '' , '1728826218' , '李苏晖' , '首笔' , '已生效' ) , ( 'HTBH2024101200000672' , '' , '1728841011' , '杜锡兰' , '首笔' , '已生效' ) , ( 'HTBH2024100300000007' , 'BA2024100300000020' , '1728894722' , '杨明敏' , '首笔' , '已生效' ) , ( 'HTBH2024100600000037' , 'BA2024100600000059' , '1728918518' , '王琳' , '首笔' , '未生效' ) , ( 'HTBH2024100700000096' , 'BA2024100700000113' , '1728927539' , '莫鹏飞' , '首笔' , '未生效' ) , ( 'HTBH2024100700000101' , 'BA2024100700000118' , '1728927539' , '莫鹏飞' , '首笔' , '未生效' ) , ( 'HTBH2024101500001259' , '' , '1728929920' , '夏玉娥' , '首笔' , '已生效' ) , ( 'HTBH2024101400001573' , '' , '1728930247' , '余岚' , '首笔' , '已生效' ) , ( 'HTBH2024100900001840' , '' , '1728932100' , '俞军良' , '首笔' , '已生效' ) , ( 'HTBH2024101100000570' , '' , '1728932289' , '任方胜' , '首笔' , '已生效' ) , ( 'HTBH2024102800000091' , '' , '1728932406' , '许吉' , '首笔' , '已生效' ) , ( 'HTBH2024100800000503' , '' , '1728936008' , '余修修' , '首笔' , '已生效' ) , ( 'HTBH2024102100001351' , 'BA2024102100000214' , '1728938914' , '孙翠兰' , '首笔' , '未生效' ) , ( 'HTBH2024100800001857' , '' , '1728943197' , '方春风' , '首笔' , '已生效' ) , ( 'HTBH2024100800001227' , 'BA2024100800000203' , '1728943197' , '方春风' , '首笔' , '已生效' ) , ( 'HTBH2024100800001261' , '' , '1728944868' , '叶娜' , '首笔' , '已生效' ) , ( 'HTBH2024100800001319' , 'BA2024100800000229' , '1728945443' , '程择怡' , '首笔' , '已生效' ) , ( 'HTBH2024100800001855' , '' , '1728945443' , '程择怡' , '首笔' , '已生效' ) , ( 'HTBH2024102900000784' , '' , '1728947309' , '王刚' , '首笔' , '已生效' ) , ( 'HTBH2024102800002214' , 'BA2024102800000346' , '1728947309' , '王刚' , '首笔' , '未生效' ) , ( 'HTBH2024102900000789' , '' , '1728947713' , '邹杭川' , '首笔' , '已生效' ) , ( 'HTBH2024100800001664' , 'BA2024100800000252' , '1728948816' , '刘晓静' , '首笔' , '已生效' ) , ( 'HTBH2024102200000558' , '' , '1728949375' , '杨华良' , '首笔' , '已生效' ) , ( 'HTBH2024102200001572' , '' , '1728949587' , '年浩' , '首笔' , '已生效' ) , ( 'HTBH2024101000002280' , '' , '1728949714' , '孙书堂' , '首笔' , '已生效' ) , ( 'HTBH2024101100002921' , '' , '1728967450' , '陈奇' , '首笔' , '已生效' ) , ( 'HTBH2024100900002373' , '' , '1728967517' , '姜贵姣' , '首笔' , '已生效' ) , ( 'HTBH2024101000000660' , 'BA2024101000000095' , '1728969330' , '方勇华' , '首笔' , '已生效' ) , ( 'HTBH2024101400000999' , '' , '1728970615' , '陈彩儿' , '首笔' , '已生效' ) , ( 'HTBH2024101100002930' , '' , '1728971944' , '葛永钢' , '首笔' , '已生效' ) , ( 'HTBH2024100900000551' , 'BA2024100900000111' , '1728972190' , '詹月琴' , '首笔' , '未生效' ) , ( 'HTBH2024100900002328' , '' , '1728972190' , '詹月琴' , '首笔' , '未生效' ) , ( 'HTBH2024100900000572' , 'BA2024100900000117' , '1728972936' , '孙良' , '首笔' , '未生效' ) , ( 'HTBH2024101100003066' , '' , '1728973003' , '王震' , '首笔' , '已生效' ) , ( 'HTBH2024101000001933' , 'BA2024101000000300' , '1728973817' , '张晨' , '首笔' , '未生效' ) , ( 'HTBH2024101400000795' , '' , '1728973817' , '张晨' , '首笔' , '已生效' ) , ( 'HTBH2024100900000694' , 'BA2024100900000146' , '1728974995' , '杜燊' , '首笔' , '已生效' ) , ( 'HTBH2024100900001843' , '' , '1728976817' , '宋小霞' , '首笔' , '已生效' ) , ( 'HTBH2024101000002762' , '' , '1728978623' , '朱易赧' , '首笔' , '已生效' ) , ( 'HTBH2024101400002022' , '' , '1728981584' , '周波' , '首笔' , '已生效' ) , ( 'HTBH2024100900001450' , 'BA2024100900000253' , '1728982414' , '徐佳明' , '首笔' , '未生效' ) , ( 'HTBH2024100900002157' , '' , '1728982525' , '宋明月' , '首笔' , '已生效' ) , ( 'HTBH2024101200001324' , '' , '1728995771' , '屠潇潇' , '首笔' , '已生效' ) , ( 'HTBH2024102800000273' , '' , '1728995976' , '马钰' , '首笔' , '已生效' ) , ( 'HTBH2024101400002515' , '' , '1728996110' , '李玉燕' , '首笔' , '已生效' ) , ( 'HTBH2024100900001552' , 'BA2024100900000273' , '1728997206' , '孙永芳' , '首笔' , '未生效' ) , ( 'HTBH2024101000000840' , '' , '1728998485' , '戚清波' , '首笔' , '已生效' ) , ( 'HTBH2024100900002584' , 'BA2024100900000289' , '1728999349' , '胡梦超' , '首笔' , '已生效' ) , ( 'HTBH2024101500001266' , '' , '1729000575' , '梁治东' , '首笔' , '已生效' ) , ( 'HTBH2024100900002588' , 'BA2024100900000311' , '1729001432' , '胡梦磊' , '首笔' , '已生效' ) , ( 'HTBH2024102000000031' , '' , '1729002196' , '周洁钦' , '首笔' , '已生效' ) , ( 'HTBH2024103100000752' , '' , '1729003084' , '施琦' , '首笔' , '已生效' ) , ( 'HTBH2024102400001452' , '' , '1729006339' , '孙佐成' , '首笔' , '冻结' ) , ( 'HTBH2024100900002402' , 'BA2024100900000390' , '1729006736' , '李密迦' , '首笔' , '未生效' ) , ( 'HTBH2024103100001637' , '' , '1729007456' , '李拾益' , '首笔' , '已生效' ) , ( 'HTBH2024100900002599' , 'BA2024100900000411' , '1729010275' , '王安逸' , '首笔' , '未生效' ) , ( 'HTBH2024100900002720' , 'BA2024100900000427' , '1729077369' , '金宗日' , '首笔' , '未生效' ) , ( 'HTBH2024101500001629' , '' , '1729078099' , '楼俊强' , '首笔' , '已生效' ) , ( 'HTBH2024101200002648' , 'BA2024101100000421' , '1729080797' , '程国胜' , '首笔' , '已生效' ) , ( 'HTBH2024101100003074' , '' , '1729087126' , '彭栋' , '首笔' , '已生效' ) , ( 'HTBH2024101000001100' , 'BA2024101000000191' , '1729091197' , '金潇' , '首笔' , '未生效' ) , ( 'HTBH2024101000002296' , '' , '1729094731' , '孙浩楠' , '首笔' , '已生效' ) , ( 'HTBH2024101600000974' , '' , '1729097341' , '彭嗣精' , '首笔' , '已生效' ) , ( 'HTBH2024103100003322' , '' , '1729142630' , '邱卫忠' , '首笔' , '已生效' ) , ( 'HTBH2024101000002167' , '' , '1729143259' , '马路杰' , '首笔' , '已生效' ) , ( 'HTBH2024101000002518' , 'BA2024101000000386' , '1729143562' , '毛蓉丽' , '首笔' , '未生效' ) , ( 'HTBH2024101000002240' , '' , '1729144198' , '卢毅' , '首笔' , '已生效' ) , ( 'HTBH2024101700002393' , '' , '1729144275' , '唐琳' , '首笔' , '已生效' ) , ( 'HTBH2024101000002308' , '' , '1729144325' , '朱文光' , '首笔' , '已生效' ) , ( 'HTBH2024101000002273' , 'BA2024101000000353' , '1729144614' , '孙凯月' , '首笔' , '未生效' ) , ( 'HTBH2024101000002303' , '' , '1729144826' , '娜仁' , '首笔' , '已生效' ) , ( 'HTBH2024101000002299' , 'BA2024101000000359' , '1729145139' , '王建华' , '首笔' , '未生效' ) , ( 'HTBH2024101000002873' , 'BA2024101000000405' , '1729149121' , '杨斌' , '首笔' , '未生效' ) , ( 'HTBH2024101000003052' , 'BA2024101000000426' , '1729153787' , '赵梦蝶' , '首笔' , '未生效' ) , ( 'HTBH2024101000003189' , 'BA2024101000000438' , '1729193442' , '马思文' , '首笔' , '未生效' ) , ( 'HTBH2024101100000323' , 'BA2024101100000037' , '1729197222' , '陆家豪' , '首笔' , '未生效' ) , ( 'HTBH2024101200000707' , '' , '1729201830' , '王彩艳' , '首笔' , '未生效' ) , ( 'HTBH2024101200001111' , '' , '1729201854' , '郑祖标' , '首笔' , '已生效' ) , ( 'HTBH2024102200002729' , '' , '1729202627' , '王蕾' , '首笔' , '已生效' ) , ( 'HTBH2024101100000389' , 'BA2024101100000058' , '1729202627' , '王蕾' , '首笔' , '未生效' ) , ( 'HTBH2024102200002730' , '' , '1729204346' , '郑红华' , '首笔' , '已生效' ) , ( 'HTBH2024102400000981' , '' , '1729205389' , '王晓波' , '首笔' , '已生效' ) , ( 'HTBH2024101100000629' , 'BA2024101100000111' , '1729206677' , '李燕' , '首笔' , '已生效' ) , ( 'HTBH2024102100000653' , '' , '1729207531' , '钭朝龙' , '首笔' , '已生效' ) , ( 'HTBH2024101400000767' , '' , '1729209270' , '黄艳' , '首笔' , '已生效' ) , ( 'HTBH2024102300002761' , '' , '1729212324' , '邓晶' , '首笔' , '已生效' ) , ( 'HTBH2024101400000758' , '' , '1729220218' , '陈斌' , '首笔' , '已生效' ) , ( 'HTBH2024101100000969' , 'BA2024101100000154' , '1729228226' , '王蒋宏' , '首笔' , '未生效' ) , ( 'HTBH2024101100001231' , 'BA2024101100000206' , '1729231584' , '吕哲仪' , '首笔' , '已生效' ) , ( 'HTBH2024101100001249' , 'BA2024101100000207' , '1729231644' , '方品一' , '首笔' , '已生效' ) , ( 'HTBH2024101100001516' , 'BA2024101100000225' , '1729234981' , '徐宁宁' , '首笔' , '已生效' ) , ( 'HTBH2024101100001518' , 'BA2024101100000228' , '1729235414' , '汪鋆媛' , '首笔' , '未生效' ) , ( 'HTBH2024101200001106' , '' , '1729238482' , '王宇彤' , '首笔' , '已生效' ) , ( 'HTBH2024101100001754' , 'BA2024101100000269' , '1729238482' , '王宇彤' , '首笔' , '未生效' ) , ( 'HTBH2024101100001987' , 'BA2024101100000306' , '1729238508' , '岳学元' , '首笔' , '未生效' ) , ( 'HTBH2024102300000488' , '' , '1729238737' , '赵金超' , '首笔' , '冻结' ) , ( 'HTBH2024101100002111' , 'BA2024101100000323' , '1729242562' , '尉宛蓉' , '首笔' , '未生效' ) , ( 'HTBH2024101100002230' , 'BA2024101100000358' , '1729244223' , '华紫仪' , '首笔' , '未生效' ) , ( 'HTBH2024101500001561' , '' , '1729244876' , '吴鸣天' , '首笔' , '已生效' ) , ( 'HTBH2024101700001745' , '' , '1729248918' , '方超斐' , '首笔' , '已生效' ) , ( 'HTBH2024101100002666' , 'BA2024101100000417' , '1729248918' , '方超斐' , '首笔' , '已生效' ) , ( 'HTBH2024102400001703' , '' , '1729250581' , '沈益卫' , '首笔' , '已生效' ) , ( 'HTBH2024101100002839' , 'BA2024101100000434' , '1729251414' , '陈铭' , '首笔' , '未生效' ) , ( 'HTBH2024101100003031' , 'BA2024101100000465' , '1729254522' , '毛淑婷' , '首笔' , '未生效' ) , ( 'HTBH2024101100003025' , 'BA2024101100000457' , '1729255312' , '苏美美' , '首笔' , '已生效' ) , ( 'HTBH2024101100003041' , 'BA2024101100000469' , '1729255837' , '吴纯妹' , '首笔' , '未生效' ) , ( 'HTBH2024101100003051' , 'BA2024101100000473' , '1729255871' , '余志辉' , '首笔' , '未生效' ) , ( 'HTBH2024101100003103' , 'BA2024101100000487' , '1729256786' , '黄心恺' , '首笔' , '未生效' ) , ( 'HTBH2024101500001242' , '' , '1729260916' , '陈曦' , '首笔' , '已生效' ) , ( 'HTBH2024102900000185' , '' , '1729261831' , '李伟锋' , '首笔' , '已生效' ) , ( 'HTBH2024102500000319' , '' , '1729264263' , '石向阳' , '首笔' , '已生效' ) , ( 'HTBH2024101400001503' , '' , '1729266153' , '余清富' , '首笔' , '已生效' ) , ( 'HTBH2024102500001107' , '' , '1729266314' , '周红' , '首笔' , '已生效' ) , ( 'HTBH2024101700002309' , 'BA2024101200000186' , '1729269442' , '宋杰华' , '首笔' , '已生效' ) , ( 'HTBH2024101700002310' , '' , '1729269442' , '宋杰华' , '首笔' , '已生效' ) , ( 'HTBH2024101200000873' , 'BA2024101200000210' , '1729270852' , '杨海坤' , '首笔' , '已生效' ) , ( 'HTBH2024101200000965' , '' , '1729271851' , '方永健' , '首笔' , '已生效' ) , ( 'HTBH2024102000000122' , '' , '1729271979' , '汪燕萍' , '首笔' , '已生效' ) , ( 'HTBH2024101400001486' , '' , '1729272732' , '董波' , '首笔' , '已生效' ) , ( 'HTBH2024101200001030' , 'BA2024101200000247' , '1729272732' , '董波' , '首笔' , '已生效' ) , ( 'HTBH2024101200001073' , 'BA2024101200000258' , '1729272978' , '董银良' , '首笔' , '未生效' ) , ( 'HTBH2024101200001101' , 'BA2024101200000266' , '1729273055' , '田春婷' , '首笔' , '已生效' ) , ( 'HTBH2024102400000889' , '' , '1729276919' , '庄建华' , '首笔' , '已生效' ) , ( 'HTBH2024101200001637' , 'BA2024101200000330' , '1729278140' , '陈钰' , '首笔' , '已生效' ) , ( 'HTBH2024101700001742' , '' , '1729278140' , '陈钰' , '首笔' , '已生效' ) , ( 'HTBH2024101700000021' , '' , '1729278776' , '胡凌怀' , '首笔' , '已生效' ) , ( 'HTBH2024101800000155' , '' , '1729278776' , '胡凌怀' , '首笔' , '已生效' ) , ( 'HTBH2024101400001394' , 'BA2024101200000365' , '1729281091' , '高子叶' , '首笔' , '已生效' ) , ( 'HTBH2024101400002468' , '' , '1729281736' , '黄摩西' , '首笔' , '未生效' ) , ( 'HTBH2024101200002013' , 'BA2024101200000407' , '1729284084' , '李伟' , '首笔' , '未生效' ) , ( 'HTBH2024101500000505' , '' , '1729285143' , '王一帆' , '首笔' , '未生效' ) , ( 'HTBH2024102300000002' , '' , '1729287457' , '叶芮' , '首笔' , '已生效' ) , ( 'HTBH2024101700000629' , '' , '1729292079' , '孟丁瑜' , '首笔' , '已生效' ) , ( 'HTBH2024101200002778' , 'BA2024101200000574' , '1729304345' , '诸红杰' , '首笔' , '已生效' ) , ( 'HTBH2024101400001917' , '' , '1729307574' , '黄丽' , '首笔' , '已生效' ) , ( 'HTBH2024101300000118' , 'BA2024101300000128' , '1729312993' , '陈斌' , '首笔' , '已生效' ) , ( 'HTBH2024101500001459' , '' , '1729317213' , '帅三宏' , '首笔' , '已生效' ) , ( 'HTBH2024101400000238' , 'BA2024101400000041' , '1729318475' , '方远' , '首笔' , '已生效' ) , ( 'HTBH2024101700001738' , '' , '1729318475' , '方远' , '首笔' , '已生效' ) , ( 'HTBH2024102500000958' , '' , '1729319500' , '周文跃' , '首笔' , '已生效' ) , ( 'HTBH2024101400000385' , 'BA2024101400000079' , '1729322837' , '商雅贤' , '首笔' , '已生效' ) , ( 'HTBH2024101400001477' , '' , '1729322837' , '商雅贤' , '首笔' , '已生效' ) , ( 'HTBH2024101400000439' , 'BA2024101400000096' , '1729323826' , '张林' , '首笔' , '已生效' ) , ( 'HTBH2024101400001471' , '' , '1729323826' , '张林' , '首笔' , '已生效' ) , ( 'HTBH2024102300000131' , '' , '1729323971' , '王博' , '首笔' , '已生效' ) , ( 'HTBH2024102300000302' , '' , '1729324115' , '钱松瑜' , '首笔' , '已生效' ) , ( 'HTBH2024102300000262' , '' , '1729324835' , '陈梦莹' , '首笔' , '已生效' ) , ( 'HTBH2024101400000505' , 'BA2024101400000116' , '1729325006' , '孙聪颖' , '首笔' , '已生效' ) , ( 'HTBH2024101800001469' , '' , '1729325208' , '朱合良' , '首笔' , '已生效' ) , ( 'HTBH2024102300002431' , '' , '1729325319' , '姜玉华' , '首笔' , '已生效' ) , ( 'HTBH2024101400001466' , '' , '1729326073' , '方淑珍' , '首笔' , '已生效' ) , ( 'HTBH2024101400000571' , 'BA2024101400000130' , '1729326073' , '方淑珍' , '首笔' , '已生效' ) , ( 'HTBH2024101400000701' , 'BA2024101400000154' , '1729327724' , '周蕾' , '首笔' , '未生效' ) , ( 'HTBH2024101600002618' , '' , '1729328767' , '余宾' , '首笔' , '已生效' ) , ( 'HTBH2024101400001221' , 'BA2024101400000251' , '1729330449' , '高会会' , '首笔' , '未生效' ) , ( 'HTBH2024101400001154' , 'BA2024101400000236' , '1729331381' , '林早敏' , '首笔' , '已生效' ) , ( 'HTBH2024101400002618' , '' , '1729332491' , '陈宇娇' , '首笔' , '已生效' ) , ( 'HTBH2024101400001484' , 'BA2024101400000315' , '1729335806' , '罗微' , '首笔' , '已生效' ) , ( 'HTBH2024101400001679' , 'BA2024101400000350' , '1729338262' , '方利华' , '首笔' , '已生效' ) , ( 'HTBH2024102100002191' , '' , '1729338262' , '方利华' , '首笔' , '已生效' ) , ( 'HTBH2024101400001877' , 'BA2024101400000367' , '1729339567' , '刘生华' , '首笔' , '未生效' ) , ( 'HTBH2024101900000251' , '' , '1729341165' , '孔苏珊' , '首笔' , '冻结' ) , ( 'HTBH2024101700001659' , '' , '1729343782' , '何赛楠' , '首笔' , '已生效' ) , ( 'HTBH2024101700000134' , '' , '1729346324' , '於裕幸' , '首笔' , '已生效' ) , ( 'HTBH2024101500000519' , 'BA2024101400000488' , '1729350795' , '吕佳璐' , '首笔' , '未生效' ) , ( 'HTBH2024101700001592' , '' , '1729350795' , '吕佳璐' , '首笔' , '已生效' ) , ( 'HTBH2024101400002847' , 'BA2024101400000492' , '1729350896' , '王嘉睿' , '首笔' , '已生效' ) , ( 'HTBH2024101500000356' , 'BA2024101500000011' , '1729353448' , '黄鹏程' , '首笔' , '未生效' ) , ( 'HTBH2024101500000725' , '' , '1729355295' , '张耀东' , '首笔' , '已生效' ) , ( 'HTBH2024101500000693' , 'BA2024101500000155' , '1729367322' , '刁立可' , '首笔' , '已生效' ) , ( 'HTBH2024101700002721' , '' , '1729371282' , '周鑫' , '首笔' , '已生效' ) , ( 'HTBH2024102400002981' , '' , '1729372496' , '许龙勋' , '首笔' , '已生效' ) , ( 'HTBH2024101500000946' , 'BA2024101500000193' , '1729372597' , '周丽娜' , '首笔' , '未生效' ) , ( 'HTBH2024101600000998' , '' , '1729372953' , '王欢' , '首笔' , '已生效' ) , ( 'HTBH2024101700002043' , '' , '1729373511' , '孟芳芳' , '首笔' , '冻结' ) , ( 'HTBH2024102100000909' , '' , '1729375115' , '汪静' , '首笔' , '已生效' ) , ( 'HTBH2024102100001022' , 'BA2024102100000199' , '1729375613' , '王娟' , '首笔' , '已生效' ) , ( 'HTBH2024102800002729' , '' , '1729375613' , '王娟' , '首笔' , '已生效' ) , ( 'HTBH2024102100001854' , '' , '1729376504' , '叶航佐' , '首笔' , '已生效' ) , ( 'HTBH2024101500001432' , 'BA2024101500000273' , '1729376504' , '叶航佐' , '首笔' , '已生效' ) , ( 'HTBH2024101600000355' , '' , '1729376538' , '方飞翔' , '首笔' , '已生效' ) , ( 'HTBH2024101500001395' , 'BA2024101500000292' , '1729376538' , '方飞翔' , '首笔' , '已生效' ) , ( 'HTBH2024101600000073' , 'BA2024101600000011' , '1729376690' , '邢越' , '首笔' , '未生效' ) , ( 'HTBH2024101500001625' , 'BA2024101500000310' , '1729377588' , '方振邦' , '首笔' , '已生效' ) , ( 'HTBH2024101700001732' , '' , '1729377588' , '方振邦' , '首笔' , '已生效' ) , ( 'HTBH2024103100001036' , '' , '1729377672' , '陈立新' , '首笔' , '未生效' ) , ( 'HTBH2024101500001718' , 'BA2024101500000334' , '1729378630' , '刘嘉晖' , '首笔' , '已生效' ) , ( 'HTBH2024101600000243' , '' , '1729378630' , '刘嘉晖' , '首笔' , '已生效' ) , ( 'HTBH2024101700002879' , '' , '1729391223' , '李玲' , '首笔' , '未生效' ) , ( 'HTBH2024101500002093' , 'BA2024101500000405' , '1729391873' , '王晓芸' , '首笔' , '未生效' ) , ( 'HTBH2024101500002128' , 'BA2024101500000413' , '1729392051' , '汪善迪' , '首笔' , '已生效' ) , ( 'HTBH2024103000003564' , '' , '1729392427' , '姚军' , '首笔' , '已生效' ) , ( 'HTBH2024101500002231' , 'BA2024101500000439' , '1729392427' , '姚军' , '首笔' , '未生效' ) , ( 'HTBH2024101500002307' , 'BA2024101500000440' , '1729393359' , '吴建林' , '首笔' , '已生效' ) , ( 'HTBH2024101600000280' , '' , '1729393359' , '吴建林' , '首笔' , '已生效' ) , ( 'HTBH2024101500002525' , 'BA2024101500000483' , '1729395865' , '于子淇' , '首笔' , '未生效' ) , ( 'HTBH2024101500003087' , 'BA2024101500000564' , '1729395983' , '杨程' , '首笔' , '未生效' ) , ( 'HTBH2024101500002518' , 'BA2024101500000480' , '1729396110' , '张洋' , '首笔' , '已生效' ) , ( 'HTBH2024101500002756' , 'BA2024101500000505' , '1729397748' , '伍泽坤' , '首笔' , '未生效' ) , ( 'HTBH2024101500002969' , 'BA2024101500000530' , '1729401371' , '方世阳' , '首笔' , '未生效' ) , ( 'HTBH2024101500003014' , 'BA2024101500000544' , '1729402009' , '严宇平' , '首笔' , '未生效' ) , ( 'HTBH2024101500003091' , 'BA2024101500000567' , '1729404320' , '丁丽毓' , '首笔' , '未生效' ) , ( 'HTBH2024101800000399' , '' , '1729406133' , '江亚萍' , '首笔' , '已生效' ) , ( 'HTBH2024101700000031' , '' , '1729435856' , '刘川江' , '首笔' , '已生效' ) , ( 'HTBH2024101600000703' , 'BA2024101600000131' , '1729437127' , '陈权' , '首笔' , '已生效' ) , ( 'HTBH2024101600000726' , 'BA2024101600000136' , '1729437457' , '张旭' , '首笔' , '已生效' ) , ( 'HTBH2024101700000204' , 'BA2024101700000031' , '1729438574' , '胡品山' , '首笔' , '已生效' ) , ( 'HTBH2024101700002599' , '' , '1729438617' , '黄勇民' , '首笔' , '已生效' ) , ( 'HTBH2024101600000902' , 'BA2024101600000156' , '1729440208' , '丁夏良' , '首笔' , '已生效' ) , ( 'HTBH2024101600002202' , '' , '1729441120' , '曹剑龙' , '首笔' , '已生效' ) , ( 'HTBH2024101600000933' , 'BA2024101600000180' , '1729441147' , '柯常春' , '首笔' , '未生效' ) , ( 'HTBH2024101600000963' , 'BA2024101600000195' , '1729441318' , '米鑫' , '首笔' , '已生效' ) , ( 'HTBH2024101600001106' , 'BA2024101600000223' , '1729443384' , '许丽丽' , '首笔' , '已生效' ) , ( 'HTBH2024101800000831' , '' , '1729443444' , '祝家辉' , '首笔' , '已生效' ) , ( 'HTBH2024101600001309' , 'BA2024101600000243' , '1729444823' , '李进煊' , '首笔' , '未生效' ) , ( 'HTBH2024102900003622' , '' , '1729444850' , '陆乐' , '首笔' , '已生效' ) , ( 'HTBH2024101600001315' , 'BA2024101600000247' , '1729445163' , '王吉韬' , '首笔' , '未生效' ) , ( 'HTBH2024101600002630' , '' , '1729448096' , '杨艳芬' , '首笔' , '已生效' ) , ( 'HTBH2024101700002789' , '' , '1729449586' , '姚国华' , '首笔' , '已生效' ) , ( 'HTBH2024101800001237' , '' , '1729451497' , '孙会志' , '首笔' , '已生效' ) , ( 'HTBH2024101600001982' , 'BA2024101600000416' , '1729453269' , '李君一' , '首笔' , '已生效' ) , ( 'HTBH2024101600002131' , '' , '1729454735' , '韩丽丽' , '首笔' , '已生效' ) , ( 'HTBH2024101600002166' , 'BA2024101600000451' , '1729455395' , '高超' , '首笔' , '已生效' ) , ( 'HTBH2024102300001093' , '' , '1729455395' , '高超' , '首笔' , '已生效' ) , ( 'HTBH2024102200000799' , '' , '1729455556' , '孙刘伟' , '首笔' , '已生效' ) , ( 'HTBH2024101700000050' , 'BA2024101600000575' , '1729461755' , '章天一' , '首笔' , '未生效' ) , ( 'HTBH2024101800002722' , 'BA2024101800000447' , '1729466255' , '沈佳意' , '首笔' , '未生效' ) , ( 'HTBH2024101700000255' , 'BA2024101700000038' , '1729466433' , '朱玲亚' , '首笔' , '未生效' ) , ( 'HTBH2024101700000368' , '' , '1729467863' , '朱佳丽' , '首笔' , '已生效' ) , ( 'HTBH2024102200002069' , '' , '1729468263' , '孔劼人' , '首笔' , '已生效' ) , ( 'HTBH2024101700001706' , '' , '1729469787' , '方潮' , '首笔' , '已生效' ) , ( 'HTBH2024102400000545' , '' , '1729469881' , '刘润成' , '首笔' , '已生效' ) , ( 'HTBH2024102900003517' , '' , '1729470207' , '朱志刚' , '首笔' , '未生效' ) , ( 'HTBH2024101700000508' , 'BA2024101700000079' , '1729470520' , '王咪咪' , '首笔' , '已生效' ) , ( 'HTBH2024102800002422' , '' , '1729472088' , '汪鹏' , '首笔' , '已生效' ) , ( 'HTBH2024101700000573' , 'BA2024101700000109' , '1729472088' , '汪鹏' , '首笔' , '已生效' ) , ( 'HTBH2024102300001235' , '' , '1729473460' , '王维河' , '首笔' , '已生效' ) , ( 'HTBH2024101700000634' , 'BA2024101700000134' , '1729473621' , '陈聪' , '首笔' , '已生效' ) , ( 'HTBH2024102500003309' , '' , '1729473621' , '陈聪' , '首笔' , '已生效' ) , ( 'HTBH2024101700002065' , 'BA2024101700000184' , '1729473900' , '秦晶晶' , '首笔' , '未生效' ) , ( 'HTBH2024103100003333' , '' , '1729474011' , '陶太原' , '首笔' , '已生效' ) , ( 'HTBH2024102900000240' , '' , '1729474385' , '庞珂' , '首笔' , '未生效' ) , ( 'HTBH2024101700000683' , 'BA2024101700000150' , '1729474496' , '王丽娜' , '首笔' , '已生效' ) , ( 'HTBH2024102200000942' , '' , '1729475037' , '朱静羽' , '首笔' , '已生效' ) , ( 'HTBH2024101700000727' , 'BA2024101700000161' , '1729475589' , '王光伟' , '首笔' , '已生效' ) , ( 'HTBH2024101700000767' , 'BA2024101700000167' , '1729476070' , '李志飞' , '首笔' , '已生效' ) , ( 'HTBH2024101700000911' , 'BA2024101700000203' , '1729477351' , '程雪瑶' , '首笔' , '已生效' ) , ( 'HTBH2024101700000989' , 'BA2024101700000237' , '1729477808' , '沈春丽' , '首笔' , '已生效' ) , ( 'HTBH2024102400000268' , '' , '1729478427' , '王超娟' , '首笔' , '已生效' ) , ( 'HTBH2024101700001620' , 'BA2024101700000360' , '1729490230' , '杨伟' , '首笔' , '未生效' ) , ( 'HTBH2024101800003167' , '' , '1729490435' , '郭雪松' , '首笔' , '已生效' ) , ( 'HTBH2024101800001834' , '' , '1729490859' , '郑频' , '首笔' , '已生效' ) , ( 'HTBH2024101700001686' , 'BA2024101700000311' , '1729491000' , '陈圣洁' , '首笔' , '未生效' ) , ( 'HTBH2024101700001493' , 'BA2024101700000321' , '1729491730' , '唐逊' , '首笔' , '已生效' ) , ( 'HTBH2024101800001375' , '' , '1729492830' , '李锦辉' , '首笔' , '已生效' ) , ( 'HTBH2024101700001589' , 'BA2024101700000351' , '1729492992' , '康小梅' , '首笔' , '未生效' ) , ( 'HTBH2024102300002440' , '' , '1729495373' , '卢艳明' , '首笔' , '已生效' ) , ( 'HTBH2024101700002029' , 'BA2024101700000431' , '1729497061' , '王鹏' , '首笔' , '已生效' ) , ( 'HTBH2024101800000770' , 'BA2024101800000129' , '1729497104' , '万威威' , '首笔' , '已生效' ) , ( 'HTBH2024102900002604' , '' , '1729497104' , '万威威' , '首笔' , '已生效' ) , ( 'HTBH2024101700002137' , 'BA2024101700000446' , '1729498433' , '莘英发' , '首笔' , '已生效' ) , ( 'HTBH2024103100003320' , '' , '1729499324' , '李霞' , '首笔' , '未生效' ) , ( 'HTBH2024101700002246' , 'BA2024101700000469' , '1729499483' , '戴嘉蔚' , '首笔' , '未生效' ) , ( 'HTBH2024103000003019' , '' , '1729502506' , '王登科' , '首笔' , '已生效' ) , ( 'HTBH2024102900003606' , 'BA2024102900000575' , '1729502506' , '王登科' , '首笔' , '未生效' ) , ( 'HTBH2024102200000874' , 'BA2024102200000003' , '1729510205' , '许冰燕' , '首笔' , '未生效' ) , ( 'HTBH2024101800000414' , 'BA2024101800000044' , '1729516391' , '李琛' , '首笔' , '未生效' ) , ( 'HTBH2024101800000411' , 'BA2024101800000045' , '1729516458' , '吴丹翡' , '首笔' , '未生效' ) , ( 'HTBH2024101800001139' , '' , '1729517830' , '郑白' , '首笔' , '已生效' ) , ( 'HTBH2024102900000778' , '' , '1729526437' , '李克军' , '首笔' , '已生效' ) , ( 'HTBH2024101800001203' , '' , '1729528479' , '黄文柬' , '首笔' , '已生效' ) , ( 'HTBH2024101800000673' , 'BA2024101800000096' , '1729528505' , '李熵飞' , '首笔' , '未生效' ) , ( 'HTBH2024101800001160' , 'BA2024101800000195' , '1729530770' , '徐红月' , '首笔' , '未生效' ) , ( 'HTBH2024102200000678' , '' , '1729530864' , '李兴仙' , '首笔' , '已生效' ) , ( 'HTBH2024101800001454' , 'BA2024101800000138' , '1729532202' , '潘妤' , '首笔' , '未生效' ) , ( 'HTBH2024101800000941' , 'BA2024101800000167' , '1729535202' , '李文杰' , '首笔' , '已生效' ) , ( 'HTBH2024101800001011' , 'BA2024101800000175' , '1729535778' , '郭征寰' , '首笔' , '未生效' ) , ( 'HTBH2024102500002948' , '' , '1729536669' , '李娴' , '首笔' , '已生效' ) , ( 'HTBH2024101800001190' , 'BA2024101800000203' , '1729536669' , '李娴' , '首笔' , '已生效' ) , ( 'HTBH2024102400000452' , '' , '1729536914' , '章叶盛' , '首笔' , '已生效' ) , ( 'HTBH2024102200002727' , '' , '1729538041' , '潘冬兰' , '首笔' , '已生效' ) , ( 'HTBH2024101800001724' , 'BA2024101800000271' , '1729541866' , '俞佳炬' , '首笔' , '未生效' ) , ( 'HTBH2024102300000088' , '' , '1729572477' , '束庆波' , '首笔' , '已生效' ) , ( 'HTBH2024101800001967' , 'BA2024101800000322' , '1729574986' , '孟祥萍' , '首笔' , '已生效' ) , ( 'HTBH2024102200002323' , '' , '1729575171' , '贺云飞' , '首笔' , '已生效' ) , ( 'HTBH2024102100002540' , '' , '1729575214' , '方怡' , '首笔' , '已生效' ) , ( 'HTBH2024101800001984' , 'BA2024101800000327' , '1729575369' , '薛越' , '首笔' , '未生效' ) , ( 'HTBH2024102400001400' , '' , '1729579291' , '李扬' , '首笔' , '未生效' ) , ( 'HTBH2024103100004181' , '' , '1729581413' , '闻学良' , '首笔' , '已生效' ) , ( 'HTBH2024102300000386' , 'BA2024101900000020' , '1729631431' , '高翔' , '首笔' , '未生效' ) , ( 'HTBH2024102100001105' , '' , '1729640197' , '李东宇' , '首笔' , '已生效' ) , ( 'HTBH2024102000000003' , 'BA2024101900000169' , '1729640230' , '沈晓燕' , '首笔' , '未生效' ) , ( 'HTBH2024102000000094' , 'BA2024102000000087' , '1729682650' , '毛培俊' , '首笔' , '已生效' ) , ( 'HTBH2024102000000092' , 'BA2024102000000085' , '1729682667' , '毛鑫霞' , '首笔' , '已生效' ) , ( 'HTBH2024102500001686' , '' , '1729696568' , '李文军' , '首笔' , '已生效' ) , ( 'HTBH2024102100000085' , 'BA2024102100000013' , '1729698754' , '梁雨静' , '首笔' , '未生效' ) , ( 'HTBH2024102100000252' , 'BA2024102100000035' , '1729701811' , '杨小娟' , '首笔' , '未生效' ) , ( 'HTBH2024102100002397' , '' , '1729702074' , '唐大明' , '首笔' , '已生效' ) , ( 'HTBH2024110100001435' , '' , '1729712601' , '何海燕' , '首笔' , '未生效' ) , ( 'HTBH2024102300001963' , '' , '1729713247' , '朱聪' , '首笔' , '已生效' ) , ( 'HTBH2024102100002189' , '' , '1729713459' , '姚名展' , '首笔' , '已生效' ) , ( 'HTBH2024102100000538' , 'BA2024102100000110' , '1729713459' , '姚名展' , '首笔' , '未生效' ) , ( 'HTBH2024102400000701' , '' , '1729713704' , '沈生达' , '首笔' , '已生效' ) , ( 'HTBH2024102400000713' , '' , '1729715103' , '余明明' , '首笔' , '已生效' ) , ( 'HTBH2024102400001868' , '' , '1729715440' , '应培洪' , '首笔' , '已生效' ) , ( 'HTBH2024102500000030' , '' , '1729716042' , '陈志平' , '首笔' , '已生效' ) , ( 'HTBH2024102400001984' , '' , '1729716839' , '江锋' , '首笔' , '已生效' ) , ( 'HTBH2024102500001802' , '' , '1729719822' , '宋波' , '首笔' , '已生效' ) , ( 'HTBH2024102100001292' , 'BA2024102100000228' , '1729719822' , '宋波' , '首笔' , '未生效' ) , ( 'HTBH2024102500002051' , '' , '1729721649' , '陈锡锰' , '首笔' , '已生效' ) , ( 'HTBH2024102100001465' , 'BA2024102100000267' , '1729723674' , '宋恒宇' , '首笔' , '已生效' ) , ( 'HTBH2024102400002477' , '' , '1729723775' , '岑志超' , '首笔' , '已生效' ) , ( 'HTBH2024102400000837' , '' , '1729724071' , '徐斌' , '首笔' , '已生效' ) , ( 'HTBH2024102400002318' , '' , '1729726173' , '赖林坤' , '首笔' , '已生效' ) , ( 'HTBH2024102100001627' , 'BA2024102100000311' , '1729729486' , '傅莹' , '首笔' , '未生效' ) , ( 'HTBH2024102100001605' , 'BA2024102100000319' , '1729729563' , '蒋姝婧' , '首笔' , '未生效' ) , ( 'HTBH2024102100001904' , '' , '1729732745' , '陈桂芳' , '首笔' , '已生效' ) , ( 'HTBH2024102100001981' , 'BA2024102100000416' , '1729734430' , '王荣志' , '首笔' , '未生效' ) , ( 'HTBH2024103100002102' , '' , '1729736169' , '金旖青' , '首笔' , '已生效' ) , ( 'HTBH2024102200000546' , '' , '1729746798' , '陈浩' , '首笔' , '已生效' ) , ( 'HTBH2024102200001457' , '' , '1729746976' , '李博' , '首笔' , '已生效' ) , ( 'HTBH2024102300001065' , '' , '1729747103' , '倪云龙' , '首笔' , '已生效' ) , ( 'HTBH2024102400003219' , '' , '1729747255' , '汪仕元' , '首笔' , '已生效' ) , ( 'HTBH2024102200000393' , 'BA2024102200000058' , '1729747255' , '汪仕元' , '首笔' , '已生效' ) , ( 'HTBH2024102200000410' , 'BA2024102200000061' , '1729748519' , '邵春' , '首笔' , '未生效' ) , ( 'HTBH2024102400003218' , '' , '1729748519' , '邵春' , '首笔' , '已生效' ) , ( 'HTBH2024102200001553' , '' , '1729748704' , '应浩' , '首笔' , '已生效' ) , ( 'HTBH2024102300002227' , '' , '1729749458' , '华一飞' , '首笔' , '已生效' ) , ( 'HTBH2024102200000577' , '' , '1729749747' , '何金贵' , '首笔' , '已生效' ) , ( 'HTBH2024102300002746' , '' , '1729751116' , '姚敏' , '首笔' , '已生效' ) , ( 'HTBH2024102300000258' , '' , '1729751167' , '周成根' , '首笔' , '已生效' ) , ( 'HTBH2024102200002414' , '' , '1729751285' , '倪元军' , '首笔' , '已生效' ) , ( 'HTBH2024102200000610' , 'BA2024102200000120' , '1729752055' , '曹开浩' , '首笔' , '已生效' ) , ( 'HTBH2024102200000672' , '' , '1729753302' , '曹娟' , '首笔' , '已生效' ) , ( 'HTBH2024102200001717' , '' , '1729753420' , '郑贤芳' , '首笔' , '已生效' ) , ( 'HTBH2024102200000862' , 'BA2024102200000180' , '1729777883' , '郭智远' , '首笔' , '未生效' ) , ( 'HTBH2024102200001021' , '' , '1729780126' , '陈君招' , '首笔' , '已生效' ) , ( 'HTBH2024102800002146' , '' , '1729780184' , '汪海波' , '首笔' , '已生效' ) , ( 'HTBH2024102200001032' , '' , '1729780295' , '罗国峰' , '首笔' , '已生效' ) , ( 'HTBH2024102200002496' , '' , '1729780412' , '夏豪' , '首笔' , '已生效' ) , ( 'HTBH2024103000001214' , '' , '1729780497' , '蔡瑛' , '首笔' , '未生效' ) , ( 'HTBH2024102200001076' , 'BA2024102200000254' , '1729780497' , '蔡瑛' , '首笔' , '未生效' ) , ( 'HTBH2024102300000109' , 'BA2024102300000016' , '1729780513' , '许润铭' , '首笔' , '未生效' ) , ( 'HTBH2024102900002075' , '' , '1729780523' , '吴欣' , '首笔' , '已生效' ) , ( 'HTBH2024102200001072' , 'BA2024102200000253' , '1729780523' , '吴欣' , '首笔' , '未生效' ) , ( 'HTBH2024102200001086' , 'BA2024102200000255' , '1729780894' , '邱雨琪' , '首笔' , '未生效' ) , ( 'HTBH2024102400001143' , '' , '1729781115' , '李博文' , '首笔' , '已生效' ) , ( 'HTBH2024102300002491' , '' , '1729787539' , '钱一泓' , '首笔' , '冻结' ) , ( 'HTBH2024102300000299' , '' , '1729789335' , '蒋文文' , '首笔' , '已生效' ) , ( 'HTBH2024102400002045' , '' , '1729789769' , '祝丽艳' , '首笔' , '已生效' ) , ( 'HTBH2024102200002300' , 'BA2024102200000457' , '1729792380' , '马俊飞' , '首笔' , '未生效' ) , ( 'HTBH2024102900002851' , '' , '1729792729' , '刘丽娜' , '首笔' , '已生效' ) , ( 'HTBH2024102200002256' , 'BA2024102200000469' , '1729793509' , '王程远' , '首笔' , '已生效' ) , ( 'HTBH2024102300000631' , '' , '1729793603' , '周科明' , '首笔' , '已生效' ) , ( 'HTBH2024102400002803' , '' , '1729794212' , '沈永卫' , '首笔' , '未生效' ) , ( 'HTBH2024102300002400' , '' , '1729794212' , '沈永卫' , '首笔' , '已生效' ) , ( 'HTBH2024102300000149' , 'BA2024102300000019' , '1729804413' , '李淑敏' , '首笔' , '已生效' ) , ( 'HTBH2024102300000294' , 'BA2024102300000030' , '1729805547' , '王梅' , '首笔' , '未生效' ) , ( 'HTBH2024102800000459' , '' , '1729809734' , '吴群' , '首笔' , '未生效' ) , ( 'HTBH2024102500000838' , '' , '1729810085' , '叶璇' , '首笔' , '已生效' ) , ( 'HTBH2024102300000565' , 'BA2024102300000117' , '1729810713' , '贾红霞' , '首笔' , '已生效' ) , ( 'HTBH2024102800000705' , '' , '1729810713' , '贾红霞' , '首笔' , '已生效' ) , ( 'HTBH2024102800000461' , '' , '1729811137' , '鲍牵' , '首笔' , '未生效' ) , ( 'HTBH2024102300002556' , '' , '1729811289' , '祁明君' , '首笔' , '已生效' ) , ( 'HTBH2024102300000502' , 'BA2024102300000093' , '1729811289' , '祁明君' , '首笔' , '已生效' ) , ( 'HTBH2024102800000464' , '' , '1729812213' , '张露露' , '首笔' , '未生效' ) , ( 'HTBH2024102300000774' , '' , '1729814238' , '洪奕' , '首笔' , '已生效' ) , ( 'HTBH2024102300000674' , 'BA2024102300000166' , '1729814517' , '李丽容' , '首笔' , '未生效' ) , ( 'HTBH2024102300002558' , '' , '1729814592' , '孙程' , '首笔' , '已生效' ) , ( 'HTBH2024102300000649' , 'BA2024102300000158' , '1729814592' , '孙程' , '首笔' , '已生效' ) , ( 'HTBH2024102400000997' , '' , '1729815382' , '余爱霞' , '首笔' , '已生效' ) , ( 'HTBH2024102300000845' , '' , '1729817746' , '魏盈' , '首笔' , '已生效' ) , ( 'HTBH2024102500002716' , '' , '1729818516' , '占文君' , '首笔' , '已生效' ) , ( 'HTBH2024102300000981' , 'BA2024102300000234' , '1729821494' , '胡珊珊' , '首笔' , '已生效' ) , ( 'HTBH2024110100002480' , '' , '1729823013' , '孙一平' , '首笔' , '未生效' ) , ( 'HTBH2024102500001691' , '' , '1729829639' , '金群' , '首笔' , '已生效' ) , ( 'HTBH2024102600000138' , '' , '1729832855' , '陈阳' , '首笔' , '已生效' ) , ( 'HTBH2024110400001376' , '' , '1729832946' , '赵世洲' , '首笔' , '未生效' ) , ( 'HTBH2024103100000383' , '' , '1729833413' , '王伟英' , '首笔' , '已生效' ) , ( 'HTBH2024102800002881' , '' , '1729833810' , '鲍晓峰' , '首笔' , '已生效' ) , ( 'HTBH2024102900000288' , '' , '1729834600' , '王韬钧' , '首笔' , '已生效' ) , ( 'HTBH2024102400002850' , '' , '1729835455' , '徐攀' , '首笔' , '已生效' ) , ( 'HTBH2024102900000614' , '' , '1729835489' , '汤秋' , '首笔' , '已生效' ) , ( 'HTBH2024102500000581' , '' , '1729835852' , '金园园' , '首笔' , '已生效' ) , ( 'HTBH2024102400003097' , '' , '1729836683' , '朱成义' , '首笔' , '已生效' ) , ( 'HTBH2024103100004713' , '' , '1729837116' , '杨景' , '首笔' , '未生效' ) , ( 'HTBH2024102500000359' , '' , '1729838193' , '李主东' , '首笔' , '已生效' ) , ( 'HTBH2024102500003250' , '' , '1729838852' , '潘佳平' , '首笔' , '已生效' ) , ( 'HTBH2024102500000006' , '' , '1729839276' , '郭文俊' , '首笔' , '已生效' ) , ( 'HTBH2024102300002011' , 'BA2024102300000465' , '1729842706' , '陈雨珂' , '首笔' , '未生效' ) , ( 'HTBH2024102500003208' , '' , '1729843019' , '姚望镇' , '首笔' , '已生效' ) , ( 'HTBH2024102800000655' , '' , '1729843248' , '刘芬' , '首笔' , '已生效' ) , ( 'HTBH2024103000000575' , '' , '1729846161' , '廖观发' , '首笔' , '未生效' ) , ( 'HTBH2024103100001846' , '' , '1729848034' , '王龙生' , '首笔' , '已生效' ) , ( 'HTBH2024102300002489' , 'BA2024102300000512' , '1729849305' , '丁可威' , '首笔' , '未生效' ) , ( 'HTBH2024102800001326' , '' , '1729853436' , '邵辰啸' , '首笔' , '已生效' ) , ( 'HTBH2024103000003864' , '' , '1729854310' , '崔保忠' , '首笔' , '未生效' ) , ( 'HTBH2024102400000558' , 'BA2024102400000066' , '1729862958' , '方彬' , '首笔' , '已生效' ) , ( 'HTBH2024102400001350' , '' , '1729862958' , '方彬' , '首笔' , '已生效' ) , ( 'HTBH2024102500001540' , '' , '1729863338' , '胡丽青' , '首笔' , '已生效' ) , ( 'HTBH2024102400000660' , 'BA2024102400000085' , '1729864448' , '叶春晖' , '首笔' , '已生效' ) , ( 'HTBH2024102500000841' , '' , '1729864448' , '叶春晖' , '首笔' , '已生效' ) , ( 'HTBH2024102400002132' , 'BA2024102400000355' , '1729864684' , '王祥' , '首笔' , '已生效' ) , ( 'HTBH2024102700000152' , '' , '1729864754' , '田卫芬' , '首笔' , '已生效' ) , ( 'HTBH2024102500003398' , '' , '1729864966' , '郎春霞' , '首笔' , '未生效' ) , ( 'HTBH2024102500003399' , '' , '1729865406' , '董国强' , '首笔' , '已生效' ) , ( 'HTBH2024102400000766' , 'BA2024102400000097' , '1729865642' , '傅婷婷' , '首笔' , '已生效' ) , ( 'HTBH2024102500000843' , '' , '1729867219' , '谢庆龄' , '首笔' , '已生效' ) , ( 'HTBH2024102400000928' , 'BA2024102400000151' , '1729867219' , '谢庆龄' , '首笔' , '已生效' ) , ( 'HTBH2024102500003076' , '' , '1729872258' , '叶春香' , '首笔' , '已生效' ) , ( 'HTBH2024102500002687' , '' , '1729875154' , '严杰' , '首笔' , '已生效' ) , ( 'HTBH2024102800000370' , '' , '1729876425' , '姜雅颖' , '首笔' , '已生效' ) , ( 'HTBH2024102500003031' , '' , '1729876984' , '王天敏' , '首笔' , '已生效' ) , ( 'HTBH2024103000003552' , '' , '1729877612' , '李伊峰' , '首笔' , '已生效' ) , ( 'HTBH2024110100000677' , '' , '1729878171' , '郭喜林' , '首笔' , '未生效' ) , ( 'HTBH2024102800001888' , '' , '1729879324' , '毛贵英' , '首笔' , '已生效' ) , ( 'HTBH2024102400001930' , 'BA2024102400000316' , '1729879324' , '毛贵英' , '首笔' , '已生效' ) , ( 'HTBH2024103000003579' , '' , '1729883209' , '徐金娃' , '首笔' , '已生效' ) , ( 'HTBH2024103100002166' , '' , '1729885718' , '朱琼贵' , '首笔' , '未生效' ) , ( 'HTBH2024102400002600' , 'BA2024102400000442' , '1729887521' , '陈宇航' , '首笔' , '未生效' ) , ( 'HTBH2024102900002020' , '' , '1729888049' , '吴碎微' , '首笔' , '未生效' ) , ( 'HTBH2024102500002390' , '' , '1729892762' , '赵烈' , '首笔' , '已生效' ) , ( 'HTBH2024102400003307' , 'BA2024102400000523' , '1729911567' , '陈湘宏' , '首笔' , '未生效' ) , ( 'HTBH2024102900000494' , '' , '1729916982' , '程倩' , '首笔' , '已生效' ) , ( 'HTBH2024102900001595' , '' , '1729917136' , '李祎' , '首笔' , '已生效' ) , ( 'HTBH2024102500000770' , 'BA2024102500000163' , '1729918889' , '王丽' , '首笔' , '已生效' ) , ( 'HTBH2024102500000633' , 'BA2024102500000114' , '1729918899' , '俞颖俐' , '首笔' , '已生效' ) , ( 'HTBH2024102500000665' , 'BA2024102500000125' , '1729918973' , '许宝娣' , '首笔' , '已生效' ) , ( 'HTBH2024102500000641' , 'BA2024102500000117' , '1729919211' , '胡芬' , '首笔' , '已生效' ) , ( 'HTBH2024102500002905' , '' , '1729919289' , '王金玉' , '首笔' , '已生效' ) , ( 'HTBH2024102500000742' , 'BA2024102500000154' , '1729919948' , '邵晨劼' , '首笔' , '已生效' ) , ( 'HTBH2024102500000712' , 'BA2024102500000143' , '1729920053' , '李青' , '首笔' , '已生效' ) , ( 'HTBH2024102500000702' , 'BA2024102500000139' , '1729920097' , '金磊' , '首笔' , '未生效' ) , ( 'HTBH2024102500000741' , 'BA2024102500000149' , '1729920106' , '胡佳' , '首笔' , '已生效' ) , ( 'HTBH2024103000001313' , '' , '1729920106' , '胡佳' , '首笔' , '已生效' ) , ( 'HTBH2024102500000747' , 'BA2024102500000155' , '1729920436' , '李娇' , '首笔' , '已生效' ) , ( 'HTBH2024102800000216' , '' , '1729920443' , '陈棋英' , '首笔' , '已生效' ) , ( 'HTBH2024102500000757' , 'BA2024102500000156' , '1729920520' , '何张园' , '首笔' , '已生效' ) , ( 'HTBH2024102900003641' , '' , '1729920689' , '陆林林' , '首笔' , '已生效' ) , ( 'HTBH2024102500000769' , 'BA2024102500000164' , '1729920699' , '张凌' , '首笔' , '未生效' ) , ( 'HTBH2024102500000797' , 'BA2024102500000174' , '1729921156' , '俞小霞' , '首笔' , '未生效' ) , ( 'HTBH2024102500000896' , 'BA2024102500000205' , '1729921493' , '叶志勇' , '首笔' , '未生效' ) , ( 'HTBH2024102500000914' , 'BA2024102500000214' , '1729921536' , '朱理坤' , '首笔' , '已生效' ) , ( 'HTBH2024102500000902' , 'BA2024102500000207' , '1729921994' , '许珏瑾' , '首笔' , '已生效' ) , ( 'HTBH2024102500000880' , 'BA2024102500000201' , '1729922104' , '姚天越' , '首笔' , '未生效' ) , ( 'HTBH2024102500000905' , 'BA2024102500000210' , '1729922208' , '刘青翠' , '首笔' , '已生效' ) , ( 'HTBH2024102500000911' , 'BA2024102500000212' , '1729922326' , '赖铭鸣' , '首笔' , '已生效' ) , ( 'HTBH2024102500001008' , 'BA2024102500000257' , '1729922400' , '范晓红' , '首笔' , '已生效' ) , ( 'HTBH2024102500000920' , 'BA2024102500000218' , '1729922461' , '方雪兰' , '首笔' , '已生效' ) , ( 'HTBH2024102500000934' , 'BA2024102500000226' , '1729922545' , '徐俊杰' , '首笔' , '已生效' ) , ( 'HTBH2024102500000955' , 'BA2024102500000238' , '1729922562' , '祝金兰' , '首笔' , '未生效' ) , ( 'HTBH2024102500000942' , 'BA2024102500000232' , '1729922605' , '黄芳' , '首笔' , '已生效' ) , ( 'HTBH2024102500002028' , 'BA2024102500000267' , '1729923106' , '祝堂卫' , '首笔' , '已生效' ) , ( 'HTBH2024102500001012' , 'BA2024102500000259' , '1729923181' , '沈国富' , '首笔' , '未生效' ) , ( 'HTBH2024102500001067' , 'BA2024102500000270' , '1729923595' , '黄燕秋' , '首笔' , '未生效' ) , ( 'HTBH2024102500001354' , 'BA2024102500000288' , '1729924748' , '叶燕' , '首笔' , '已生效' ) , ( 'HTBH2024102500001287' , 'BA2024102500000312' , '1729925003' , '汤灵潇' , '首笔' , '未生效' ) , ( 'HTBH2024102500001538' , 'BA2024102500000349' , '1729927647' , '朱英莲' , '首笔' , '已生效' ) , ( 'HTBH2024102500002357' , '' , '1729927765' , '雷建平' , '首笔' , '已生效' ) , ( 'HTBH2024102500001651' , 'BA2024102500000355' , '1729933964' , '吴仁重' , '首笔' , '已生效' ) , ( 'HTBH2024102500001897' , 'BA2024102500000374' , '1729961652' , '林芳芳' , '首笔' , '已生效' ) , ( 'HTBH2024102800001962' , '' , '1729962288' , '余建芳' , '首笔' , '已生效' ) , ( 'HTBH2024102500002082' , 'BA2024102500000400' , '1729962805' , '鄢则民' , '首笔' , '未生效' ) , ( 'HTBH2024102800001065' , '' , '1729965119' , '吴磊' , '首笔' , '未生效' ) , ( 'HTBH2024102500002559' , 'BA2024102500000473' , '1729967117' , '桂鹏飞' , '首笔' , '已生效' ) , ( 'HTBH2024103000000186' , '' , '1729968745' , '蔡灿丰' , '首笔' , '已生效' ) , ( 'HTBH2024102500003382' , 'BA2024102500000547' , '1729971715' , '温承超' , '首笔' , '未生效' ) , ( 'HTBH2024102600000142' , 'BA2024102600000060' , '1729973391' , '金宇泽' , '首笔' , '未生效' ) , ( 'HTBH2024102900003225' , '' , '1729976111' , '董沛玲' , '首笔' , '冻结' ) , ( 'HTBH2024102800000198' , 'BA2024102500000583' , '1729976249' , '朱健坤' , '首笔' , '未生效' ) , ( 'HTBH2024102600000309' , 'BA2024102600000138' , '1729985734' , '张宗林' , '首笔' , '未生效' ) , ( 'HTBH2024102600000314' , 'BA2024102600000141' , '1729985792' , '刘振德' , '首笔' , '未生效' ) , ( 'HTBH2024102600000319' , 'BA2024102600000149' , '1729985801' , '郑怡' , '首笔' , '未生效' ) , ( 'HTBH2024102600000316' , 'BA2024102600000143' , '1729985828' , '张望浩' , '首笔' , '未生效' ) , ( 'HTBH2024102600000318' , 'BA2024102600000148' , '1729985835' , '朱飞飞' , '首笔' , '未生效' ) , ( 'HTBH2024102600000317' , 'BA2024102600000147' , '1729985842' , '孙廷' , '首笔' , '未生效' ) , ( 'HTBH2024102600000320' , 'BA2024102600000150' , '1729985852' , '胡婷' , '首笔' , '未生效' ) , ( 'HTBH2024102600000323' , 'BA2024102600000151' , '1729985869' , '俞之焕' , '首笔' , '未生效' ) , ( 'HTBH2024102700000072' , 'BA2024102700000074' , '1729990524' , '郑霞' , '首笔' , '已生效' ) , ( 'HTBH2024102900001437' , '' , '1729999238' , '姜来兵' , '首笔' , '已生效' ) , ( 'HTBH2024102800000589' , 'BA2024102800000123' , '1730008284' , '李金檬' , '首笔' , '未生效' ) , ( 'HTBH2024102800000609' , 'BA2024102800000131' , '1730009225' , '陆佳燕' , '首笔' , '未生效' ) , ( 'HTBH2024103100003143' , '' , '1730010144' , '陆建强' , '首笔' , '已生效' ) , ( 'HTBH2024103100000002' , '' , '1730010346' , '商向阳' , '首笔' , '已生效' ) , ( 'HTBH2024103100001934' , '' , '1730011762' , '赵增辉' , '首笔' , '已生效' ) , ( 'HTBH2024103100003642' , '' , '1730013729' , '吴爱香' , '首笔' , '已生效' ) , ( 'HTBH2024102900000836' , '' , '1730016252' , '赵定华' , '首笔' , '已生效' ) , ( 'HTBH2024102800001517' , 'BA2024102800000257' , '1730017066' , '朱国剑' , '首笔' , '未生效' ) , ( 'HTBH2024110100002962' , '' , '1730017066' , '朱国剑' , '首笔' , '未生效' ) , ( 'HTBH2024103000002611' , '' , '1730018007' , '代钦奎' , '首笔' , '已生效' ) , ( 'HTBH2024102800001846' , 'BA2024102800000288' , '1730018576' , '李锋' , '首笔' , '未生效' ) , ( 'HTBH2024102800001852' , 'BA2024102800000301' , '1730018855' , '王洁' , '首笔' , '未生效' ) , ( 'HTBH2024103100000003' , '' , '1730018855' , '王洁' , '首笔' , '已生效' ) , ( 'HTBH2024103100000004' , '' , '1730019134' , '邵航远' , '首笔' , '已生效' ) , ( 'HTBH2024103000002638' , '' , '1730019286' , '方卫琪' , '首笔' , '已生效' ) , ( 'HTBH2024103000000513' , 'BA2024103000000103' , '1730019286' , '方卫琪' , '首笔' , '已生效' ) , ( 'HTBH2024102800001774' , 'BA2024102800000297' , '1730019356' , '徐一曼' , '首笔' , '已生效' ) , ( 'HTBH2024102800001990' , 'BA2024102800000335' , '1730020840' , '杨川博' , '首笔' , '未生效' ) , ( 'HTBH2024103100002040' , '' , '1730020840' , '杨川博' , '首笔' , '已生效' ) , ( 'HTBH2024102800002041' , 'BA2024102800000343' , '1730021476' , '汪宁宁' , '首笔' , '未生效' ) , ( 'HTBH2024102900003537' , '' , '1730024206' , '朱镇红' , '首笔' , '已生效' ) , ( 'HTBH2024102900000161' , '' , '1730024688' , '王凯玄' , '首笔' , '已生效' ) , ( 'HTBH2024102800002861' , 'BA2024102800000473' , '1730049399' , '邹泽晖' , '首笔' , '未生效' ) , ( 'HTBH2024102800003221' , 'BA2024102800000549' , '1730053392' , '符晓斌' , '首笔' , '已生效' ) , ( 'HTBH2024103100000394' , '' , '1730057400' , '熊欣' , '首笔' , '未生效' ) , ( 'HTBH2024103000000707' , '' , '1730057612' , '蒋灿飞' , '首笔' , '已生效' ) , ( 'HTBH2024103100004209' , 'BA2024103100000694' , '1730059180' , '杨浩' , '首笔' , '未生效' ) , ( 'HTBH2024102900000706' , '' , '1730063879' , '罗红梅' , '首笔' , '已生效' ) , ( 'HTBH2024103000003044' , '' , '1730064794' , '胡鹏' , '首笔' , '未生效' ) , ( 'HTBH2024103100002928' , '' , '1730065244' , '汪俏俏' , '首笔' , '已生效' ) , ( 'HTBH2024102900000978' , 'BA2024102900000206' , '1730068362' , '王杰' , '首笔' , '未生效' ) , ( 'HTBH2024103000004066' , '' , '1730073246' , '程春梅' , '首笔' , '已生效' ) , ( 'HTBH2024102900001773' , 'BA2024102900000330' , '1730075493' , '童静斌' , '首笔' , '未生效' ) , ( 'HTBH2024102900001988' , 'BA2024102900000355' , '1730077043' , '方建贤' , '首笔' , '已生效' ) , ( 'HTBH2024103100001579' , '' , '1730077043' , '方建贤' , '首笔' , '已生效' ) , ( 'HTBH2024103000002644' , '' , '1730077941' , '吴勇昌' , '首笔' , '已生效' ) , ( 'HTBH2024102900003263' , '' , '1730079976' , '罗婷' , '首笔' , '已生效' ) , ( 'HTBH2024102900003638' , 'BA2024102900000588' , '1730082438' , '丘礼开' , '首笔' , '未生效' ) , ( 'HTBH2024102900003049' , '' , '1730088919' , '宣萍' , '首笔' , '已生效' ) , ( 'HTBH2024102900003674' , 'BA2024102900000611' , '1730099854' , '胡晓卉' , '首笔' , '未生效' ) , ( 'HTBH2024103100000670' , '' , '1730109903' , '阮江晨' , '首笔' , '已生效' ) , ( 'HTBH2024103000000404' , 'BA2024103000000073' , '1730111320' , '沈琦' , '首笔' , '已生效' ) , ( 'HTBH2024103000000485' , '' , '1730112568' , '祝辉明' , '首笔' , '已生效' ) , ( 'HTBH2024103000000548' , 'BA2024103000000107' , '1730114795' , '郑弘伟' , '首笔' , '未生效' ) , ( 'HTBH2024103000002109' , '' , '1730118507' , '朱芳芮' , '首笔' , '已生效' ) , ( 'HTBH2024103000004100' , '' , '1730120721' , '孟燕贤' , '首笔' , '已生效' ) , ( 'HTBH2024103000000937' , 'BA2024103000000236' , '1730122308' , '应观鹏' , '首笔' , '已生效' ) , ( 'HTBH2024110100000067' , 'BA2024103000000745' , '1730122756' , '王铖超' , '首笔' , '未生效' ) , ( 'HTBH2024103100003029' , '' , '1730123035' , '阮霞晨' , '首笔' , '已生效' ) , ( 'HTBH2024103100003083' , '' , '1730123476' , '郦旭东' , '首笔' , '已生效' ) , ( 'HTBH2024103100000608' , '' , '1730123984' , '朱敏翔' , '首笔' , '已生效' ) , ( 'HTBH2024103000001195' , 'BA2024103000000294' , '1730124333' , '申屠晨露' , '首笔' , '未生效' ) , ( 'HTBH2024103100000869' , '' , '1730124993' , '顾佳' , '首笔' , '已生效' ) , ( 'HTBH2024103000001359' , '' , '1730125383' , '王孝瑜' , '首笔' , '未生效' ) , ( 'HTBH2024103000001528' , 'BA2024103000000340' , '1730130007' , '吴清雅' , '首笔' , '未生效' ) , ( 'HTBH2024103000004146' , '' , '1730138234' , '刘文杰' , '首笔' , '已生效' ) , ( 'HTBH2024103000003964' , '' , '1730138318' , '陈嘉楠' , '首笔' , '已生效' ) , ( 'HTBH2024103000002483' , 'BA2024103000000461' , '1730138961' , '陈磊' , '首笔' , '未生效' ) , ( 'HTBH2024103000003683' , '' , '1730139291' , '郑刚' , '首笔' , '已生效' ) , ( 'HTBH2024103000002584' , 'BA2024103000000478' , '1730139505' , '徐文照' , '首笔' , '已生效' ) , ( 'HTBH2024103000003971' , '' , '1730141033' , '倪小文' , '首笔' , '已生效' ) , ( 'HTBH2024103000003354' , 'BA2024103000000577' , '1730147151' , '姚瑾颖' , '首笔' , '未生效' ) , ( 'HTBH2024103100003288' , '' , '1730148695' , '孟冠宇' , '首笔' , '已生效' ) , ( 'HTBH2024103000003937' , 'BA2024103000000628' , '1730152324' , '陈殷娟' , '首笔' , '未生效' ) , ( 'HTBH2024103000004147' , 'BA2024103000000734' , '1730161581' , '叶锋' , '首笔' , '未生效' ) , ( 'HTBH2024103100003366' , '' , '1730174603' , '王建超' , '首笔' , '已生效' ) , ( 'HTBH2024103100000792' , 'BA2024103100000138' , '1730177160' , '储著彬' , '首笔' , '已生效' ) , ( 'HTBH2024103100003100' , '' , '1730177772' , '陆维维' , '首笔' , '已生效' ) , ( 'HTBH2024103100002452' , '' , '1730179154' , '包玲玲' , '首笔' , '已生效' ) , ( 'HTBH2024103100001522' , 'BA2024103100000273' , '1730186140' , '俞辰琳' , '首笔' , '未生效' ) , ( 'HTBH2024103100001705' , 'BA2024103100000325' , '1730186174' , '陈嘉茹' , '首笔' , '未生效' ) , ( 'HTBH2024103100001687' , 'BA2024103100000321' , '1730187563' , '陆正天' , '首笔' , '未生效' ) , ( 'HTBH2024103100001830' , 'BA2024103100000348' , '1730188757' , '梁皓宸' , '首笔' , '未生效' ) , ( 'HTBH2024103100002141' , 'BA2024103100000394' , '1730190805' , '邹锡江' , '首笔' , '未生效' ) , ( 'HTBH2024103100002108' , 'BA2024103100000390' , '1730190829' , '何国平' , '首笔' , '未生效' ) , ( 'HTBH2024103100003934' , '' , '1730221975' , '杨莉敏' , '首笔' , '已生效' ) , ( 'HTBH2024110100000002' , 'BA2024103100000495' , '1730226256' , '常亮' , '首笔' , '未生效' ) , ( 'HTBH2024103100004030' , 'BA2024103100000669' , '1730249948' , '沈晓阳' , '首笔' , '未生效' ) , ( 'HTBH2024103100004605' , 'BA2024103100000734' , '1730263701' , '梅思思' , '首笔' , '未生效' ) , ( 'HTBH2024103100004700' , 'BA2024103100000785' , '1730264566' , '王佳俊' , '首笔' , '未生效' ) , ( 'HTBH2024103100004722' , 'BA2024103100000792' , '1730275440' , '钱涛' , '首笔' , '未生效' ) , ( 'HTBH2024102200000325' , '' , '2001498969' , '淳安华通云数据科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102400000433' , '' , '2602222503' , '杭州南宇医疗器械有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024100900001593' , '' , '2602698412' , '杭州强顺印刷有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101900000190' , '' , '2602781722' , '杭州琳恩进出口有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102900003703' , '' , '2603441997' , '杭州宏怀贸易有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024102800002014' , '' , '2605186912' , '杭州绛璟商贸有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101100002432' , '' , '2605520352' , '杭州吉仕进出口有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101500002834' , '' , '2606027309' , '杭州慧能科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102500001560' , '' , '2607122001' , '宝立星(杭州)国际贸易有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102400000013' , '' , '2607367513' , '杭州友联轴承有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102800001563' , '' , '2609627300' , '瑞安市东虹汽摩配有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102200002760' , '' , '2610403342' , '杭州鸣旺物流有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024103000001503' , '' , '2611302950' , '浙江创新世纪信息科技有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024101700002060' , '' , '2612738810' , '杭州美易特科技有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024102900000672' , '' , '2613268626' , '杭州嘉网科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101100002559' , '' , '2615640892' , '杭州凌薇贸易有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024103000003643' , '' , '2618171653' , '杭州树源医药科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102100002578' , '' , '2618197702' , '浙江厚安电力器材有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101600001101' , '' , '2618279804' , '杭州威盛电子工程有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102200001857' , '' , '2619492393' , '杭州泰康汽车销售有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102400000091' , '' , '2619655177' , '杭州丰览建设工程有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101000003258' , '' , '2620019797' , '杭州通冠医药有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024100800005474' , '' , '2620033812' , '杭州富阳飞翔服饰有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101400000802' , '' , '2620231870' , '杭州奎氪工业科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102800002027' , '' , '2620366465' , '杭州越凯复合材料有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102200000642' , '' , '2620624382' , '杭州联唐科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102400001456' , '' , '2622592224' , '杭州赤骥贸易有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102400002252' , '' , '2622605957' , '杭州萧山新塘英海食品店' , '首笔' , '冻结' ) , ( 'HTBH2024101600000805' , '' , '2622804636' , '杭州晨露化纤有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102800002358' , '' , '2624534632' , '浙江云聚橙科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102200001849' , '' , '2624580920' , '浙江顺展电力科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102100002666' , '' , '2625038505' , '杭州碳氢氧科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024100900002329' , '' , '2625042660' , '浙江聚捷健康医药有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024100900000511' , '' , '2625151555' , '杭州先欧生物科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101100002785' , '' , '2625371212' , '杭州德屹建材有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101900000217' , '' , '2625373143' , '杭州渤兰湾茶业有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024100900002763' , '' , '2625414244' , '杭州原美生态农业开发有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102100000480' , '' , '2625466674' , '杭州维田国际贸易有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101800001261' , '' , '2625472025' , '杭州赫沅贸易有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101700001425' , '' , '2625475119' , '杭州丰止观纺织有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101700001112' , '' , '2625545769' , '杭州钱塘新区余水军水上运输户' , '首笔' , '已生效' ) , ( 'HTBH2024101100001985' , '' , '2625553172' , '浙江自贸区同乐物业服务有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101400002478' , '' , '2625721550' , '杭州新拍档体育文化有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102900000922' , '' , '2625768063' , '杭州极盛进出口有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024100900002481' , '' , '2625768376' , '浙江驭川能源发展有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101100001740' , '' , '2625837511' , '杭州祁诚建筑工程有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101500000494' , '' , '2625972558' , '杭州铭泽安装设备有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101600002351' , '' , '2625975192' , '杭州恒锐废品回收有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102500000122' , '' , '2626004868' , '桐庐一家人超市有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024101400001317' , '' , '2626005715' , '浙江集优物流有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102900000496' , '' , '2626016277' , '杭州福胜建材有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024102200001300' , '' , '2626458262' , '杭州星光灵动网络有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024103000004072' , '' , '2626458312' , '浙江中宸安保服务有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024102200001404' , '' , '2626529557' , '杭州康源工程有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102300001051' , '' , '2626545285' , '杭州无甲新零售有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102100002573' , '' , '2626600923' , '杭州戈尔基科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102800002755' , '' , '2626605864' , '百信居(杭州)置业有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024102600000231' , '' , '2626619782' , '六言(杭州)文化艺术有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024103000001718' , '' , '2626622829' , '杭州商岳智能科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102900002428' , '' , '2626657779' , '杭州力尚品牌管理有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102800000432' , '' , '2626709212' , '杭州零磁医疗设备有限公司' , '首笔' , '未生效' ) , ( 'HTBH2024103000003757' , '' , '2626725354' , '杭州临平区东湖街道名妍尚品服装经营部' , '首笔' , '未生效' ) , ( 'HTBH2024102800003077' , '' , '2626749927' , '杭州亮霞科技有限公司' , '首笔' , '已生效' ) , ( 'HTBH2024102300000772' , 'BA2024102300000174' , '7005564225' , '沈芦芬' , '首笔' , '未生效' ) , ( 'HTBH2024102600000246' , 'BA2024102600000101' , '7005760674' , '刘小红' , '首笔' , '未生效' ) , ( 'HTBH2024102200001203' , '' , '7697933074' , '邵璟' , '首笔' , '已生效' );


-- SJ2024110482
-- 客户最新中征分	法定代表人客户号	法定代表人最新中征分	借款人预评估结果


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_02 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中征评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 ,按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中征评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;


SELECT * FROM lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_03 WHERE  客户号='1692707913'


--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_03 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_03 AS
SELECT  A1.合同登记流水号
        ,A1.申请书流水号
        ,A1.客户号
        ,A1.客户名称
        ,A1.发生类型
        ,A1.合同状态
        ,A2.中证评分
        ,A3.lgp_cst_id AS 法定代表人客户号
        ,A4.中证评分       AS 法定代表人最新中征分
        ,A5.最近一次预评估结果  AS 借款人预评估结果
FROM    lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_01 A1
LEFT JOIN    lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_02 A2
ON      A1.客户号 = A2.cst_id
AND     A2.rk = 1
LEFT JOIN    edw.dim_cst_entp_lgp_inf_dd A3 --对公客户法人信息表
ON      A1.客户号 = A3.lgp_cst_id
AND     A3.dt = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_shoubi_pp_SJ2024110482_02 A4
ON      A1.客户号 = A4.cst_id
AND     A4.rk = 1
LEFT JOIN    (
                 SELECT  T1.cst_id	                                                                          AS 客户号
                         ,T2.cd_val_dscr                                                                     AS 最近一次预评估结果
                         ,T1.sys_reg_tm	                                                                      AS 最近一次预评估时间
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T0.serno	DESC ) AS RN  --按照预评估结果流水号排序
                 FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估业务申请，替代预评估结果表
                 LEFT JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
                 ON      T1.PRE_ASES_SERNO = T0.pre_ases_serno
                 AND     T0.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
                 ON      T0.rul_set_rslt_cd = T2.cd_val
                 AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
                 AND     T2.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     T2.DT = '@@{yyyyMMdd}'
                 WHERE   T1.DT = '@@{yyyyMMdd}'
             ) A5
ON      A1.客户号 = A5.客户号
AND     A5.RN = 1;
**01-数据需求_分行_D1104_绍兴分行_何灵杰_中征分.sql
--
-- SJ2024110466
-- 截止10月31日，绍兴分行10056预警报表中，中征分550以下的客户占比16.22%，该字段下分子、分母清单
--客户名、客户号、管户机构、管户人、中征分分数


DROP TABLE IF EXISTS tmp_hlj_SJ2024110466 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hlj_SJ2024110466 AS
SELECT  a.cst_id as 客户号
        ,a.cst_nm as 客户名
        ,a.prm_org_id as 主管护机构号
        ,a.prm_org_nm as 主管护机构
        ,a.prm_mgr_id as 主管护人工号
        ,a.prm_mgr_nm as 主管护人名称
        ,b.cst_cr_grd_val as 中征分
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd a
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,t.prd_dt
                         ,t.cst_cr_grd_val
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
                 FROM    (
                             SELECT  cst_id
                                     ,to_date(REPLACE(substr(qry_tm, 1, 10), '-', ''), 'yyyymmdd') AS prd_dt
                                     ,cr_sco_val                                                   AS cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI --单笔评分查询记录
                             WHERE   dt <= '20241031'
                             AND     cr_sco_val IS NOT NULL
                             UNION ALL
                             SELECT  cst_id
                                     ,to_date(prd_dt, 'yyyymmdd') AS prd_dt
                                     ,cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI --批量评分查询记录
                             WHERE   dt <= '20241031'
                             AND     cst_cr_grd_val IS NOT NULL
                         ) t
             ) b
ON      a.cst_id = b.cst_id
AND     b.rn = 1
WHERE   a.dt = '20241031'
AND     a.prm_org_id LIKE '3307%'  --绍兴分行
;
**01-数据需求_分行_D1106_台州分行_江丽娜_分析循环类贷款业务_了解支行对该类业务是否有设置冻结方式_单笔用信期限上限.sql
--定期跑数
-- SJ2024110636
-- 截止2024.11.5，台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况
-- 用于分析循环类贷款业务，了解支行对该类业务是否有设置冻结方式、单笔用信期限上限
--字段：数据日期	合同流水号	客户编号	客户名称	风险分层	发生类型	业务标识	业务品种	营销标签	循环贷款类型
--若泰e贷，需要显示是否人工审批	合同冻结方式	合同冻结期限(月)	单笔用信期限上限(天)	合同金额	合同余额
--未结清借据金额	执行月利率(&permil;)	执行年利率(%) 结息方式	资金用途	合同起始日	合同到期日	主要担保方式	是否异地
--管户机构号	管户机构名称	管户人工号	管户人姓名	发放人	发放姓名	发放人机构	发放人机构名称

--SJ2024120336
-- 用于分析循环类贷款业务，了解支行对该类业务是否有设置冻结方式、单笔用信期限上限
--截止2024.12.3，台州分行合同未终止的循环类贷款业务（含泰e贷）数据情况
-- 同需求SJ2024110636

--取数201198条
DROP TABLE IF EXISTS tmp_sjxq_jln_SJ2024120336 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_jln_SJ2024120336 AS
SELECT  a.dt                          AS 数据日期
        ,a.ctr_serno                  AS 合同流水号
        -- ,a.ctr_sts_cd as 合同状态
        ,a.cst_id                     AS 客户编号
        ,a.cst_nm                     AS 客户名称
        ,CASE
           WHEN f.rsk_lyr = '1' THEN '低风险'
           WHEN f.rsk_lyr = '2' THEN '中低风险'
           WHEN f.rsk_lyr = '3' THEN '中风险'
           WHEN f.rsk_lyr = '4' THEN '中高风险'
           WHEN f.rsk_lyr = '5' THEN '高风险'
           ELSE ''
         END                          AS 风险分层 --不是合同表的客户风险等级
        ,CASE
           WHEN a.hpn_typ_cd = '011' THEN '续做'
           WHEN a.hpn_typ_cd = '010' THEN '首笔'
         END                          AS 发生类型
        ,CASE
           WHEN a.bsn_mark_cd = 01 THEN '员工贷款'
           WHEN a.bsn_mark_cd = 02 THEN '信贷人员亲属业务'
           WHEN a.bsn_mark_cd = 03 THEN '预保预报业务'
           WHEN a.bsn_mark_cd = 04 THEN '重组业务'
           WHEN a.bsn_mark_cd = 05 THEN '协作业务'
         END                          AS 业务标识
        ,a.prd_no                     AS 业务品种代码
        ,T4.pd_nm                     AS 业务名称
        ,a.prd_tag                    AS 产品标签编号集合 --即原来的营销标签
        ,a.prd_tag_nm                 AS 产品标签名称
        ,CASE
           WHEN a.rvlg_typ_cd = 0 THEN '非循环'
           WHEN a.rvlg_typ_cd = 1 THEN '自助循环'
           WHEN a.rvlg_typ_cd = 2 THEN '半自助循环'
         END                          AS 循环贷款类型
        ,CASE
           WHEN e.bsn_aprv_mod_cd = 1 THEN '机批'
           WHEN e.bsn_aprv_mod_cd = 2 THEN '人批'
         END                          AS 业务审批模式
        ,CASE
           WHEN c.ctr_frz_mod = 05 THEN '每笔贷款发放后'
           WHEN c.ctr_frz_mod = 06 THEN '无'
           WHEN c.ctr_frz_mod = 07 THEN '冻结一次'
           WHEN c.ctr_frz_mod = 08 THEN '循环冻结'
           WHEN c.ctr_frz_mod = 09 THEN '到期前3个月'
         END                          AS 合同冻结方式 --合同表的ctr_frz_mod_cd不能用，废弃字段
        ,c.frz_trm                    AS 合同冻结期限
        ,d.sngl_usc_trm_ceil          AS 单笔用信期限上限
        ,a.ctr_amt                    AS 合同金额
        ,a.ctr_bal                    AS 合同余额
        ,b.amt                        AS 未结清借据金额
        ,a.exec_intr_rat              AS 执行月利率
        ,a.exec_intr_rat * 1.2        AS 执行年利率
        ,a.rpay_prcp_setl_intr_mod_cd AS 还本结息方式代码
        ,T1.cd_val_dscr               AS 结息方式
        ,a.cpt_usg_cd                 AS 资金用途代码
        ,a.cpt_usg_rmk                AS 资金用途
        ,a.ctr_bgn_dt                 AS 合同起始日
        ,a.ctr_mtu_dt                 AS 合同到期日
        ,a1.grnt_mod_nm               AS 担保方式集合
        -- ,CASE
        --    WHEN a.grnt_mod_colc = 010 THEN '保证'
        --    WHEN a.grnt_mod_colc = 005 THEN '信用'
        --    WHEN a.grnt_mod_colc = 020 THEN '抵押'
        --    WHEN a.grnt_mod_colc = 040 THEN '质押'
        --  END                          AS 担保方式集合
        ,CASE
           WHEN a.dif_plc_bsn_ind = 0 THEN '否'
           WHEN a.dif_plc_bsn_ind = 1 THEN '是'
         END                          AS 乡情贷业务标志 --即是否异地
        ,a.mgr_org_id                 AS 管户机构号
        ,a1.org_nm                    AS 管护机构名
        ,a.mgr_id                     AS 管户人工号
        ,a3.empe_nm                   AS 管户人姓名
        ,a.hdl_opr_id                 AS 经办人工号
        ,a4.empe_nm                   AS 经办人姓名
        ,a.hdl_org_id                 AS 经办机构号
        ,a2.org_nm                    AS 经办机构名称
FROM    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息
--取担保方式
LEFT JOIN    (
                 SELECT  a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '@@{yyyyMMdd}'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '@@{yyyyMMdd}'
                 GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc
             ) a1
ON      a.ctr_serno = a1.ctr_serno
LEFT JOIN    (
                 SELECT  t.ctr_serno
                         ,sum(t.prcp_bal) AS amt --未结清借据金额
                 FROM    edw.DIM_BUS_LOAN_DBIL_INF_DD t --借据
                 WHERE   t.dt = '@@{yyyyMMdd}'
                 AND     ( t.TMT_DT = '18991231'
                     OR t.prcp_bal > 0 ) ----未终结未结清
                 GROUP BY t.ctr_serno
             ) b
ON      a.ctr_serno = b.ctr_serno
LEFT JOIN    edw.loan_ctr_intr_rat c --合同利率
ON      a.ctr_serno = c.ctr_serno
AND     c.dt = '@@{yyyyMMdd}'
AND     c.del_ind = 0 --删除标识
LEFT JOIN    edw.loan_ctr_oth_dtl_inf d --合同其它明细信息
ON      a.ctr_serno = d.ctr_serno
AND     d.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_biz_dd e --用信方案
ON      a.rel_serno = e.usc_aply_serno
AND     e.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_lmt_biz_stat_inf f --统计类信息
ON      a.rel_serno = f.usc_aply_serno
AND     f.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T4 --产品信息
ON      a.prd_no = T4.prd_no
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a1
ON      a.mgr_org_id = a1.org_id
AND     a1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a2
ON      a.hdl_org_id = a2.org_id
AND     a2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a3
ON      a.mgr_id = a3.empe_id
AND     a3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a4
ON      a.hdl_opr_id = a4.empe_id
AND     a4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T1
ON      a.rpay_prcp_setl_intr_mod_cd = T1.cd_val
AND     T1.dt = '@@{yyyyMMdd}'
AND     T1.tbl_nm = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T1.fld_nm = upper('rpay_prcp_setl_intr_mod_cd')
WHERE   a.dt = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( A.CTR_STS_CD IN ( '2' , '4' )
AND     A.TMT_DT = '18991231'
AND     to_date(A.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A.DT, 'yyyyMMdd') )
    OR A.CTR_BAL > 0 )
AND     a.rvlg_typ_cd <> '0' --循环类贷款
AND     a.prd_no <> '2002010101001' --剔除信用卡
AND     a.mgr_org_id LIKE '3301%'    --台州分行
;
**01-数据需求_分行_D1106_舟山分行_滑茹瑶_10月首笔和增额实地走访.sql
--SJ2024110666
--检查支行管理者10月首笔和增额业务是否实地走访到位
-- 用信申请流水号	合同登记流水号	客户号	客户名称	调查方式	调查地址类型	参与人姓名


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hry_SJ202411066 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_hry_SJ202411066 AS
SELECT  a.col_1            AS 用信申请流水号
        ,a.col_2           AS 合同登记流水号
        ,a.col_3           AS 客户号
        ,a.col_4           AS 客户名称
        -- ,b.svy_mod_cd      AS 调查方式代码
        ,b2.cd_val_dscr    AS 最近一次调查方式
        -- ,b.svy_addr_typ_cd AS 调查地址类型代码
        ,b1.cd_val_dscr    AS 最近一次调查地址类型
        ,b.pcp_mnl_no      AS 参与人工号
        ,b.pcp_psn_nm      AS 参与人姓名
        ,b.svy_dt          AS 最近一次调查日期
FROM    qbi_file_20241107_17_49_46 a
LEFT JOIN    (
                 SELECT  *
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY svy_dt DESC ) AS rn
                 FROM    edw.DWD_BUS_LOAN_CST_SVY_RCD_DD --客户调查记录信息,一个客户会有多个调查记录
                 WHERE   dt = '@@{yyyyMMdd}'
             ) b
ON      a.col_3 = b.cst_id
AND     b.rn = 1
LEFT JOIN    edw.dwd_code_library_dd b1
ON      b.svy_addr_typ_cd = b1.cd_val
AND     b1.dt = '@@{yyyyMMdd}'
AND     b1.tbl_nm = upper('DWD_BUS_LOAN_CST_SVY_RCD_DD')
AND     b1.fld_nm = upper('svy_addr_typ_cd')
LEFT JOIN    edw.dwd_code_library_dd b2
ON      b.svy_mod_cd = b2.cd_val
AND     b2.dt = '@@{yyyyMMdd}'
AND     b2.tbl_nm = upper('DWD_BUS_LOAN_CST_SVY_RCD_DD')
AND     b2.fld_nm = upper('svy_mod_cd')
WHERE   a.pt <> ''
;
**01-数据需求_分行_D1107_台州分行_李铭雪_冠字号信息查询.sql
--经查询，无数据
SELECT  c_term_id 终端编号
        ,c_seria_no  纸币冠字号码
        ,c_tran_date 交易时间
FROM    edw.gzhs_cml_sent_infos_day -- --纸币冠字号码日表,增量表
WHERE   dt ='20221030'
-- AND     c_tran_date > '20221030150000'
-- AND     c_tran_date < '20221030153500'
AND     c_pathcode IN (
                          SELECT  c_pathcode
                          FROM    edw.gzhs_org_info --机构
                          WHERE   dt = '20221030'
                          AND     c_orgcode = '330110500' --黄岩江口小微专营支行
                      )
AND     c_machine_type = '3';

--温岭城南支行330105700,20240206当天点钞机的数据

SELECT count(1) FROM tmp_sjxq_guanzihaochaxun;

SELECT * FROM tmp_sjxq_guanzihaochaxun;


DROP TABLE IF EXISTS tmp_sjxq_guanzihaochaxun PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_guanzihaochaxun AS
SELECT  c_term_id 终端编号
        ,c_seria_no 纸币冠字号码
        ,c_tran_date 交易时间
FROM    edw.gzhs_cml_sent_infos_day -- --纸币冠字号码日表,增量表
WHERE   dt = '20240206'
-- AND     c_tran_date > '20221030150000'
-- AND     c_tran_date < '20221030153500'
AND     c_pathcode IN (
                          SELECT  c_pathcode
                          FROM    edw.gzhs_org_info --机构
                          WHERE   dt = '20221030'
                          AND     c_orgcode = '330105700'  --温岭城南支行
                      )
AND     c_machine_type = '3';
**01-数据需求_分行_D1107_张文文_舟山分行_全量客户积分数据.sql
-- SJ20241107121
-- 截止2024年10月30日，舟山分行全量客户的积分数据

SELECT * FROM tmp_xqy_ZS_SJ20241107121_01

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_ZS_SJ20241107121_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xqy_ZS_SJ20241107121_01 AS
SELECT  T1.cst_id             AS 客户号
        ,T1.cst_nm            AS 客户姓名
        ,T2.pnt_typ_cd        AS 积分类型代码
        ,T2.pnt_cst_id        AS 积分客户号
        ,T2.pnt_bal           AS 积分余额
        ,T2.frz_pnt           AS 冻结积分
        ,T2.prgr_pnt          AS 在途积分
        ,CASE
           WHEN T2.act_sts_cd = '1' THEN '正常'
           WHEN T2.act_sts_cd = '2' THEN '未激活'
           WHEN T2.act_sts_cd = '3' THEN '注销'
           WHEN T2.act_sts_cd = '4' THEN '锁定'
         END                  AS 账户状态
        ,T2.cur_mon_acm_pnt   AS 本月累计获得积分
        ,T2.cur_qtr_acm_pnt   AS 本季累计获得积分
        ,T2.cur_year_acm_pnt  AS 本年累计获得积分
        ,T2.last_year_acm_pnt AS 上年累计获得积分
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dim_bus_cmpn_pnt_act_inf_dd T2 --积分账户信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20241030'
WHERE   T1.DT = '20241030'
AND     SUBSTR(T1.prm_org_id, 1, 4) = '3312' --舟山分行
;

SELECT * FROM edw.dwd_code_library_dd WHERE dt='20241030' and tbl_nm=upper('dim_bus_cmpn_pnt_act_inf_dd') and fld_nm=upper('pnt_typ_cd')
**01-数据需求_分行_D1108_嘉兴分行_何文骏_账户交接v2.0排查.sql
--
-- SJ2024111201
--流程发起时间、申请人工号、申请人姓名、申请人岗位、申请人所属机构(行政维度)、申请人所属机构号(行政维度)、申请账号、转出人、
-- 考核维度机构号、原拥有交接比例、交接比例、原帐户关联性质、帐户关联性质、转出人姓名、转出人工号、转出机构(考核维度)、
-- 转出机构号(考核维度)、转入机构名称(考核维度)、转入机构号(考核维度)、转入机构负责人、转入人姓名、转入人工号、转出机构负责人、交接情况

转入人姓名:inName
转入人工号:inLoginid
原拥有交接比例:preExchangeP
交接比例:exchangeP
原帐户关联性质:accountKindP
帐户关联性质:accountKInd

这几个字段数仓表没有，转运维处理



SELECT  applaydate        申请日期
,loginid     申请人工号
,lastname        申请人姓名
,position   申请人岗位
,applaydeptcode    申请人所属机构号_行政维度
,sqrssjg    申请人所属机构_行政维度
,queryaccount      账号查询
,qoutname 转出人
,qdeptcode 考核维度机构号
,qdeptname 考核维度机构名称
,'' 原拥有交接比例
,'' 交接比例
,'' 原帐户关联性质
,'' 帐户关联性质
,qoutloginid  转出人工号
,outdeptname      转出机构名称_考核维度
,outdeptcode       转出机构号_考核维度
,indeptcode        转入机构号_考核维度
,indeptname        转入机构名称_考核维度
,indeptleader     转入机构负责人
,''  转入人姓名
,''  转入人工号
,outdeptholder     转出机构负责人
,issamesubcompany  交接情况
,comments    交接备注
,applayline       申请条线


,insubcom   转入机构分部
,outsubcom        转出机构分部
,hasmanindept      转出客户经理是否挂靠在转入机构下
,indeptleader1     转入机构负责人集合
FROM edw.oadb_formtable_main_448
WHERE dt='@@{yyyyMMdd}'
;

desc edw.oadb_formtable_main_448


| id              | decimal    | 1     |                                             |
| requestid       | decimal    |       |                                             |
| loginid         | string     |       | 申请人工号                                       |
| lastname        | decimal    | 3     | 申请人姓名                                       |
| position        | decimal    |       | 申请人岗位                                       |
| applaydate      | string     |       | 申请日期                                        |
| indeptcode      | string     |       | 转入机构号(考核维度)                                 |
| outdeptname     | decimal    |       | 转出机构名称(考核维度)                                |
| outdeptcode     | string     |       | 转出机构号(考核维度)                                 |
| queryaccount    | string     |       | 账号查询                                        |
| attache         | string     |       | 附件上传                                        |
| outdeptholder   | string     |       | 转出机构负责人                                     |
| comments        | string     |       | 交接备注                                        |
| issamesubcompany | decimal    |       | 交接情况                                        |
| insubcom        | decimal    |       | 转入机构分部                                      |
| outsubcom       | decimal    |       | 转出机构分部                                      |
| applaydeptcode  | string     |       | 申请人所属机构号(行政维度)                              |
| indeptname      | string     |       | 转入机构名称(考核维度)                                |
| indeptleader    | decimal    |       | 转入机构负责人                                     |
| applayline      | decimal    |       | 申请条线                                        |
| hasmanindept    | string     |       | 转出客户经理是否挂靠在转入机构下                            |
| sqrssjg         | decimal    |       | 申请人所属机构(行政维度)                               |
| indeptleader1   | string     |       | 转入机构负责人集合                                   |
| qoutname        | decimal    |       |                                             |
| qdeptname       | string     |       |                                             |
| qdeptcode       | string     |       |                                             |
| qoutloginid     | string     |       |                                             |


qoutname：转出人
qdeptname：考核维度机构名称
qdeptcode：考核维度机构号
qoutloginid：转出人工号
**01-数据需求_分行_D1112_陈鹏_台州分行对公客户_含个体工商户_合作社_家庭农场等经营主体_相关指标信息.sql
--按照业务新口径调整
--SJ2024111166,台州分行
--客户号	客户名称 划型结果 名下企业或个体工商户名称	企业或个体工商户统一信用证号	企业或个体工商户经营地址	手机号

-- 说明：
-- 1、手机号中间4位脱敏处理，取信贷表，loan_cst_ctc_tel
-- 2、经营地址取信贷表，loan_cst_ctc_addr，到 XX区（县、市）XX街道（镇、村）
-- 3、取信贷系统划型结果为个体工商户或小微企业主客户名下的企业或个体工商户名称，通过划型结果表edw.loan_cst_indiv_div  --个人划型；edw.loan_cst_corp_entp_siz  --企业划型
--loan_cst_bsc 客户基本信息--统代取证件号码
-- edw.loan_cst_indiv_ind  --个人客户标识信息

--导入的客户清单:qbi_file_20241127_10_59_02_0    --172532条数据

-- loan_cst_indiv_bsc 个人信息
-- loan_cst_corp_bsc 对公信息



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gt_xwqy_sj2024111166_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_gt_xwqy_sj2024111166_01 AS
SELECT  T1.COL_1        AS 客户号
        ,T1.COL_2       AS 客户名称
        ,CASE
           WHEN T2.indiv_div_rslt = '7' THEN '小微企业主'
           WHEN T2.indiv_div_rslt = '8' THEN '个体工商户主'
         END            AS 划型结果
        ,T2.entp_cst_id AS 名下企业或个体工商户客户号
        ,T3.cst_nm      AS 名下企业或个体工商户名称
        ,T3.cert_no     AS 企业或个体工商户统一信用证号
        ,T4.adiv        AS 企业或个体工商户经营地址行政区划
		,T4.dtl_addr	AS 企业或个体工商户经营地址
		,T92.cd_val_dscr           AS  经营地址省
		,T91.cd_val_dscr           AS  经营地址市
		,T9.cd_val_dscr            AS  经营地址区
        ,concat(substr(T6.ctc_tel,1,3) ,'****',substr(T6.ctc_tel,8,4)) AS 手机号
FROM   (SELECT DISTINCT COL_1,COL_2 FROM  qbi_file_20241127_10_59_02_0 WHERE PT <> '' )T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.entp_cst_id
                         ,A1.indiv_div_rslt -- 个人划型结果
                         ,A1.afm_sts -- 认定状态
                         ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.last_upd_tm DESC , A1.sys_reg_tm DESC ) AS RN
                 FROM    edw.loan_cst_indiv_div A1
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.del_ind = '0' --删除标识
             ) T2
ON      T1.COL_1 = T2.cst_id
AND     T2.indiv_div_rslt IN ( '7' , '8' )
AND     T2.RN = 1
LEFT JOIN    edw.loan_cst_bsc T3 --客户基本信息
ON      T2.entp_cst_id = T3.cst_id
AND     T3.del_ind = '0' --删除标识
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_addr T4 --联系地址信息
ON      T2.entp_cst_id = T4.cst_id
AND     T4.addr_typ = '050900' --经营地址
AND     T4.del_ind = '0' --删除标识
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T9 -- 码值表  区
ON      SUBSTR(T4.adiv,1,6)	 = T9.cd_val
AND     T9.tbl_nm = 'TB_STA_COMMUNICATION'
AND     T9.fld_nm = 'C_HOME_ADDRESS_A'
AND     T9.DT =  '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T91 -- 码值表   市
ON      RPAD(SUBSTR(T4.adiv,1,4),6,'0')	 = T91.cd_val
AND     T91.tbl_nm = 'TB_STA_COMMUNICATION'
AND     T91.fld_nm = 'C_HOME_ADDRESS_A'
AND     T91.DT =  '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T92 -- 码值表  省
ON      RPAD(SUBSTR(T4.adiv,1,2),6,'0')	 = T92.cd_val
AND     T92.tbl_nm = 'TB_STA_COMMUNICATION'
AND     T92.fld_nm = 'C_HOME_ADDRESS_A'
AND     T92.DT =  '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_ctc_tel T6 --联系电话信息
ON      T2.entp_cst_id = T6.cst_id
AND     T6.del_ind = '0' --删除标识
AND     T6.DT = '@@{yyyyMMdd}'
;














-- SJ2024111166，台州分行，我行对公客户（含个体工商户、合作社、家庭农场等经营主体）相关指标信息：
-- 管户支行、客户名称、统一社会信用代码、经营地址、企业联系人、企业联系人手机号、授信时间、授信金额

-- adm_upss.L_CUST_P_xdgz C --对私客户补充信息表
-- adm_upss.L_CUST_C_xdgz B --对公客户补充信息表
-- adm_upss.L_AGRE_LOAN_CONTRACT E --贷款合同信息表
-- adm_upss.l_acct_loan_xdgz A --贷款借据信息表
-- adm_upss.L_PUBL_RATE_xdgz U --汇率表


-- --工商法人
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_TZFH_SJ2024111166_gs_fr PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_TZFH_SJ2024111166_gs_fr AS
-- SELECT  *
-- FROM    (
--             SELECT  *
--                     ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
--             FROM    (
--                         SELECT  dt
--                                 ,in_ctfno --高管证件号
--                                 ,in_namecn --高管姓名
--                                 ,dt_gpr_entname --企业(机构)名称
--                                 ,dt_gpr_enttype --企业(机构)类型
--                                 ,dt_gpr_entstatus --企业状态
--                                 ,dt_gpr_creditcode --统一社会信用代码
--                         FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息
--                         WHERE   dt <= '@@{yyyyMMdd}' ---------------xt:添加查得标识=1
--                         AND     gpr_ifrichard = '1'  --查的标识=1
--                         UNION ALL
--                         SELECT  dt
--                                 ,gpm_ctfno in_ctfno
--                                 ,gpm_namecn in_namecn
--                                 ,gpr_entname dt_gpr_entname
--                                 ,gpr_enttype dt_gpr_enttype
--                                 ,gpr_entstatus dt_gpr_entstatus --旧表
--                                 ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码
--                         FROM    (
--                                     SELECT  *
--                                     FROM    (
--                                                 SELECT  c.dt
--                                                         ,gpm_ctfno --被查询人证件号码
--                                                         ,gpm_namecn --被查询人姓名
--                                                         ,c.gpr_entname --企业(机构)名称
--                                                         ,c.gpr_entstatus --企业状态
--                                                         ,c.gpr_enttype --企业(机构)类型
--                                                         ,c.gpr_creditcode --统一社会信用代码
--                                                         ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
--                                                 FROM    edw.outd_gs_person_main a --工商个人主表
--                                                 INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息
--                                                 ON      a.gpm_flowno = c.gpr_flowno
--                                                 AND     c.dt <= '@@{yyyyMMdd}' ---- 作为法人的企业信息
--                                                 WHERE   a.dt <= '@@{yyyyMMdd}'
--                                                 AND     substr(a.gpm_hostsendtime, 1, 8) <= '20241025'
--                                             ) aa
--                                     WHERE   aa.rn = 1
--                                 ) cc
--                     ) bb
--         ) d
-- WHERE   d.rk = 1
-- AND     d.dt_gpr_entstatus RLIKE '在营';



-- -- 查询工商企业基本信息
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_TZFH_SJ2024111166_gs_CX PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_TZFH_SJ2024111166_gs_CX AS
-- select GEB_ENTNAME -------客户名称,
--      ,GEB_CREDITCODE -----统一社会信用代码,
--      ,GEB_ENTTYPE -----企业机构类型,
--      ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,
--      ,GEB_ENTSTATUS -----经营状态,
--      ,GEB_RECCAP -----实收资本万元,
--      ,GEB_REGCAPCUR -----注册资本币种,
--      ,GEB_REGORGCITY -----所在城市,
--      ,GEB_REGORGDISTRICT -----所在区县,
--      ,GEB_ZSOPSCOPE -----经营业务范围,
--      ,GEB_DOM -----住所,
--      ,GEB_INDUSTRYCONAME -----国民经济代码名称,
--      ,geb_esdate
--      ,geb_othertel
--      ,ROW_NO
-- from (
--    select *
--          ,row_number()over(partition by GEB_CREDITCODE order by GEB_HOSTSENDTIME desc) as ROW_NO
--    from
--    (
--        select      GEB_ENTNAME -------客户名称,
--                    ,GEB_CREDITCODE -----统一社会信用代码,
--                    ,GEB_ENTTYPE -----企业机构类型,
--                    ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,
--                    ,GEB_ENTSTATUS -----经营状态,
--                    ,GEB_RECCAP -----实收资本万元,
--                    ,GEB_REGCAPCUR -----注册资本币种,
--                    ,GEB_REGORGCITY -----所在城市,
--                    ,GEB_REGORGDISTRICT -----所在区县,
--                    ,GEB_ZSOPSCOPE -----经营业务范围,
--                    ,GEB_DOM -----住所,
--                    ,GEB_INDUSTRYCONAME -----国民经济代码名称,
--                    ,geb_esdate   ----成立日期
--                    ,geb_othertel   ----其他电话
--                    ,GEB_HOSTSENDTIME    ------geb_hostsendtime
--        from edw.OUTD_GS_ENTINFO_BASIC
--        where dt <= '@@{yyyyMMdd}'
--        union all
--        select dt_entname as GEB_ENTNAME   -----企业名称
--          ,dt_creditcode as GEB_CREDITCODE  ---统一信用代码
--          ,dt_enttype as GEB_ENTTYPE  -----企业类型
--          ,dt_frname as GEB_FRNAME -----法定代表人负责人执行事务合伙人
--          ,dt_entstatus as GEB_ENTSTATUS   -----经营状态
--          ,dt_reccap as GEB_RECCAP   -----实收资本万元
--          ,dt_regcapcur as GEB_REGCAPCUR    -----注册资本币种
--          ,dt_regorgcity as GEB_REGORGCITY -----所在城市
--          ,dt_regorgdistrict as GEB_REGORGDISTRICT -----所在区县
--          ,dt_zsopscope as GEB_ZSOPSCOPE -----经营业务范围
--          ,dt_dom as GEB_DOM -----住所
--          ,dt_industryconame as GEB_INDUSTRYCONAME -----国民经济代码名称
--          ,dt_esdate as geb_esdate
--          ,dt_othertel as geb_othertel   ----其他电话
--          ,insert_time_chinadaas as GEB_HOSTSENDTIME
--        from edw.nout_zs_ent_basic
--        where dt <= '@@{yyyyMMdd}'
--    ) t1
-- ) t2
-- where t2.ROW_NO = 1
-- AND   T2.GEB_ENTSTATUS RLIKE '在营'
-- ;



-- --取企业经营地址
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_TZFH_SJ2024111166_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_TZFH_SJ2024111166_01 AS
-- SELECT  A1.in_ctfno --高管证件号
--         ,A1.in_namecn --高管姓名
--         ,COALESCE(A1.dt_gpr_entname, '')    AS dt_gpr_entname --企业(机构)名称
--         ,COALESCE(A1.dt_gpr_creditcode, '') AS dt_gpr_creditcode --统一社会信用代码
--         ,COALESCE(A2.GEB_DOM, '')           AS GEB_DOM -----住所
-- FROM    lab_bigdata_dev.tmp_TZFH_SJ2024111166_gs_fr A1
-- LEFT JOIN    lab_bigdata_dev.tmp_TZFH_SJ2024111166_gs_CX A2
-- ON      A1.dt_gpr_creditcode = A2.GEB_CREDITCODE;


-- SELECT count(1) FROM tmp_TZFH_SJ2024111166_02 WHERE  客户号='1000053433'

-- -- 管户支行、客户名称、统一社会信用代码、经营地址、企业联系人、企业联系人手机号、授信时间、授信金额

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_TZFH_SJ2024111166_02 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_TZFH_SJ2024111166_02 AS
-- SELECT  T3.sbr_org_nm             AS 管户支行
--         ,T1.cst_id                AS 客户号
--         ,T2.cst_nm                AS 客户名称
--         ,CASE
--            WHEN T4.CST_TYP_CD = '2' THEN T4.doc_nbr
--          END                      AS 统一社会信用代码
--         ,T8.dtl_addr              AS 经营地址
-- 		,T8.adiv                  AS 经营地址行政区划
-- 		,T92.cd_val_dscr           AS  经营地址省
-- 		,T91.cd_val_dscr           AS  经营地址市
-- 		,T9.cd_val_dscr            AS  经营地址区
--         ,T7.个体工商户名下企业信息
--         ,T5.lgp_nm                AS 企业联系人
--         ,T5.lgp_tel               AS 企业联系人手机号
--         ,T6.ctr_serno             AS 合同号
--         ,T6.ctr_bgn_dt            AS 授信时间
--         ,T6.ctr_amt               AS 授信金额
--         ,T6.ctr_amt * T61.cny_exr AS 授信金额折人民币
-- FROM    (
--             SELECT  A1.CUST_ID AS cst_id
--             FROM    adm_upss.L_CUST_C A1 --对公客户补充信息表
--             WHERE   A1.DT = '@@{yyyyMMdd}'
--             UNION ALL
--             SELECT  A1.CUST_ID AS cst_id
--             FROM    adm_upss.L_CUST_P A1 --对私客户补充信息表
--             WHERE   A1.DT = '@@{yyyyMMdd}'
--             AND     A1.OPERATE_CUST_TYPE_CBRC IN ( 'A' , 'B' )  --- --A（个体工商户主）/B（小微企业主）
--         ) T1
-- LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息
-- ON      T1.cst_id = T2.cst_id
-- AND     T2.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
-- ON      T2.prm_org_id = T3.org_id
-- AND     T3.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
-- ON      T1.cst_id = T4.cst_id
-- AND     T4.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dim_cst_entp_lgp_inf_dd T5 --对公客户法人信息表
-- ON      T1.cst_id = T5.cst_id
-- AND     T5.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T6 --合同基础信息
-- ON      T1.cst_id = T6.cst_id
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( T6.CTR_STS_CD IN ( '2' , '4' )
-- AND     T6.TMT_DT = '18991231'
-- AND     to_date(T6.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T6.dt, 'yyyyMMdd') )
--     OR T6.CTR_BAL > 0 )
-- AND     T6.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dim_bus_com_exr_inf_dd T61 --汇率表
-- ON      T6.bsn_ccy_cd = T61.ccy_cd
-- AND     T61.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    (
--                  SELECT  A1.in_ctfno
--                          ,WM_CONCAT('|', CONCAT(A1.dt_gpr_entname, '-', A1.dt_gpr_creditcode, '-', A1.GEB_DOM)) AS 个体工商户名下企业信息
--                  FROM    lab_bigdata_dev.tmp_TZFH_SJ2024111166_01 A1
--                  GROUP BY A1.in_ctfno
--              ) T7
-- ON      T4.doc_nbr = T7.in_ctfno
-- AND     T4.CST_TYP_CD = '1' --对私
-- LEFT JOIN (
--               SELECT
--                   A1.cst_id
--               	 ,A1.adiv
--               	 ,A1.dtl_addr
--               	 ,ROW_NUMBER() over(PARTITION BY A1.cst_id ORDER BY A1.sys_reg_tm  DESC ) AS RN
--               FROM edw.loan_cst_ctc_addr  A1
--               WHERE A1.DT ='@@{yyyyMMdd}'
--               AND     A1.addr_typ = '050900' --经营地址
--               AND     A1.del_ind	= '0'  --删除标识
--   )  T8  --联系地址信息
-- ON      T1.cst_id = T8.cst_id
-- AND     T8.RN = 1
-- LEFT JOIN    edw.dwd_code_library_dd T9 -- 码值表  区
-- ON      T8.adiv	 = T9.cd_val
-- AND     T9.tbl_nm = 'TB_STA_COMMUNICATION'
-- AND     T9.fld_nm = 'C_HOME_ADDRESS_A'
-- AND     T9.DT =  '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_code_library_dd T91 -- 码值表   市
-- ON      RPAD(SUBSTR(T8.adiv,1,4),6,'0')	 = T91.cd_val
-- AND     T91.tbl_nm = 'TB_STA_COMMUNICATION'
-- AND     T91.fld_nm = 'C_HOME_ADDRESS_A'
-- AND     T91.DT =  '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_code_library_dd T92 -- 码值表  省
-- ON      RPAD(SUBSTR(T8.adiv,1,2),6,'0')	 = T92.cd_val
-- AND     T92.tbl_nm = 'TB_STA_COMMUNICATION'
-- AND     T92.fld_nm = 'C_HOME_ADDRESS_A'
-- AND     T92.DT =  '@@{yyyyMMdd}'
-- WHERE   SUBSTR(T2.prm_org_id, 1, 4) = '3301'   --台州分行
-- ;
**01-数据需求_分行_D1113_嘉兴分行_张依宁_精准贷后数据.sql
--张依宁030720-嘉兴分行精准贷后数据
-- SJ20241107101
--截止2024年10月31日，嘉兴分行全量清单中各客户2024年中征分及三类精准贷后触碰的时间、规则细类及规则名称
--合同流水号	借据流水号	管户机构号	分行	账户类型	客户名称	是否年度新发生	出险日期	是否风险贷款
--中征分2024	最近一次触碰精准贷后（处置类）时间	最近一次触碰精准贷后（处置类）规则细类	最近一次触碰精准贷后（处置类）规则名称	最近一次触碰精准贷后（预警类）时间
-- 最近一次触碰精准贷后（预警类）规则细类	最近一次触碰精准贷后（预警类）规则名称	最近一次触碰精准贷后（提示类）时间
-- 最近一次触碰精准贷后（提示类）规则细类	最近一次触碰精准贷后（提示类）规则名称



DROP TABLE IF EXISTS LAB_BIGDATA_DEV.SJ20241107101_jxfh_cst_jzdh_inf_20240925;

CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.SJ20241107101_jxfh_cst_jzdh_inf_20240925 AS
SELECT  t1.col_1           AS 合同流水号
        ,t1.col_2 借据流水号
        ,t1.col_3 管户机构号
        ,t1.col_4 分行
        ,t1.col_5 账户类型
        ,t1.cst_id 客户号
        ,t1.col_6 客户名称
        ,t1.col_7 是否年度新发生
        ,t1.col_8 出险日期
        ,t1.col_9 是否风险贷款
        ,t2.cst_cr_grd_val AS 中征分
        ,t3.最近一次触碰精准贷后_处置类时间
        ,t3.最近一次触碰精准贷后_处置类规则细类
        ,t3.最近一次触碰精准贷后_处置类规则分类名称
        ,t4.最近一次触碰精准贷后_预警类时间
        ,t4.最近一次触碰精准贷后_预警类规则细类
        ,t4.最近一次触碰精准贷后_预警类规则分类名称
        ,t5.最近一次触碰精准贷后_提示类时间
        ,t5.最近一次触碰精准贷后_提示类规则细类
        ,t5.最近一次触碰精准贷后_提示类规则分类名称
FROM    (
            SELECT  t1 . *
                    ,coalesce(cb.cst_id, cd.cst_id) AS cst_id --取客户号
            FROM    qbi_file_20241113_14_01_30_0 t1
            LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd cb
            ON      t1.COL_1 = cb.ctr_serno
            AND     cb.dt = '20241031'
            LEFT JOIN    edw.dim_bus_crd_cr_crd_inf_dd cd
            ON      t1.COL_2 = cd.cr_crd_card_nbr
            AND     cd.dt = '20241031'
            WHERE   t1.pt <> ''
        ) t1
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,t.prd_dt
                         ,t.cst_cr_grd_val
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
                 FROM    (
                             SELECT  cst_id
                                     ,to_date(REPLACE(substr(qry_tm, 1, 10), '-', ''), 'yyyymmdd') AS prd_dt
                                     ,cr_sco_val                                                   AS cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI --评分查询记录
                             WHERE   dt <= '20241031'
                             UNION
                             SELECT  cst_id
                                     ,to_date(prd_dt, 'yyyymmdd') AS prd_dt
                                     ,cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI --中征信评分批量解析结果表
                             WHERE   dt <= '20241031'
                         ) t
             ) t2
ON      t1.cst_id = t2.cst_id
AND     t2.rn = 1
LEFT JOIN    (
                 SELECT  T1.cst_id                                                                 AS 客户号
                         ,T2.tsk_gen_dt                                                            AS 最近一次触碰精准贷后_处置类时间
                         ,CASE
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类'
                          END                                                                      AS 触发类型
                         ,t3.rul_sub_clss_nm                                                       AS 最近一次触碰精准贷后_处置类规则细类
                         ,t3.rul_ctg_nm                                                            AS 最近一次触碰精准贷后_处置类规则分类名称
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T2.tsk_gen_dt DESC ) AS RN --倒序
                 FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
                 INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
                 ON      T1.btch_serno = T2.btch_serno
                 AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
                 AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
                 AND     T2.DT = '20241031'
                 LEFT JOIN    (
                                  SELECT  A1.btch_serno
                                          --,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)                                AS 触发规则分类名称
                                          ,A1.rul_ctg_nm --规则分类名称
                                          ,A1.rul_sub_clss_nm --规则细类名称
                                          ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
                                  FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
                                  WHERE   A1.DT = '20241031'
                              ) T3
                 ON      T1.btch_serno = T3.btch_serno
                 AND     T3.RN = 1
                 WHERE   T1.DT = '20241031'
             ) t3
ON      t1.cst_id = t3.客户号
AND     t3.RN = 1
LEFT JOIN    (
                 SELECT  T1.cst_id                                                                 AS 客户号
                         ,T2.tsk_gen_dt                                                            AS 最近一次触碰精准贷后_预警类时间
                         ,CASE
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类'
                          END                                                                      AS 触发类型
                         ,t3.rul_sub_clss_nm                                                       AS 最近一次触碰精准贷后_预警类规则细类
                         ,t3.rul_ctg_nm                                                            AS 最近一次触碰精准贷后_预警类规则分类名称
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T2.tsk_gen_dt DESC ) AS RN --倒序
                 FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
                 INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
                 ON      T1.btch_serno = T2.btch_serno
                 AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
                 AND     T2.pst_loan_chk_tsk_typ_cd = '03' --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
                 AND     T2.DT = '20241031'
                 LEFT JOIN    (
                                  SELECT  A1.btch_serno
                                          ,A1.rul_ctg_nm --规则分类名称
                                          ,A1.rul_sub_clss_nm --规则细类名称
                                          ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
                                  FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
                                  WHERE   A1.DT = '20241031'
                              ) T3
                 ON      T1.btch_serno = T3.btch_serno
                 AND     T3.RN = 1
                 WHERE   T1.DT = '20241031'
             ) t4
ON      t1.cst_id = t4.客户号
AND     t4.RN = 1
LEFT JOIN    (
                 SELECT  T1.cst_id                                                                 AS 客户号
                         ,T2.tsk_gen_dt                                                            AS 最近一次触碰精准贷后_提示类时间
                         ,CASE
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
                            WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类'
                          END                                                                      AS 触发类型
                         ,t3.rul_sub_clss_nm                                                       AS 最近一次触碰精准贷后_提示类规则细类
                         ,t3.rul_ctg_nm                                                            AS 最近一次触碰精准贷后_提示类规则分类名称
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T2.tsk_gen_dt DESC ) AS RN --倒序
                 FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
                 INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
                 ON      T1.btch_serno = T2.btch_serno
                 AND     T2.pst_loan_chk_tsk_src_cd = '01' --贷后检查任务来源代码: 01 精准贷后
                 AND     T2.pst_loan_chk_tsk_typ_cd = '04' --01     处置1级, 02     处置2级, 03     预警类, 04     提示类
                 AND     T2.DT = '20241031'
                 LEFT JOIN    (
                                  SELECT  A1.btch_serno
                                          ,A1.rul_ctg_nm --规则分类名称
                                          ,A1.rul_sub_clss_nm --规则细类名称
                                          ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
                                  FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
                                  WHERE   A1.DT = '20241031'
                              ) T3
                 ON      T1.btch_serno = T3.btch_serno
                 AND     T3.RN = 1
                 WHERE   T1.DT = '20241031'
             ) t5
ON      t1.cst_id = t5.客户号
AND     t5.RN = 1;
**01-数据需求_分行_D1119_张文文_舟山分行_社区企业客群清单.sql
-- SJ20241119136。截止11月18日日期，舟山分行社区企业、个体工商户信息（舟山分行内所有企业、个体工商户，未规划子社区部分企业、个体工商户清单也需要）
-- 字段：1. 主要包含以下字段：业务部门、企业名称、法人名称、营业执照号、企业类型（个体工商户、注册企业、其他)、注册地址、行业分类、行业名称、
         -- 客户类型（正式客户、潜在客户、未建档客户）、所属综合社区版块、子社区、子社区主维护人等字段。
         -- 2.舟山分行内所有企业、个体工商户，未规划子社区部分企业清单也需要，无子社区的显示综合社区版块即可。



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zs_sqqy_SJ20241119136_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_zs_sqqy_SJ20241119136_01 AS
SELECT  T4.org_nm            AS 业务部门
        ,T3.org_id           AS 业务部门编号
        ,T1.entname          AS 企业名称
        ,T1.legalname        AS 法人名称
        ,T1.socialcreditcode AS 营业执照号
        ,CASE
           WHEN T1.enttype = '3' THEN '工商注册企业'
           WHEN T1.enttype = '2' THEN '其他'
           WHEN T1.enttype = '1' THEN '个体工商户'
         END                 AS 企业类型
        ,T1.address          AS 注册地址
        ,T1.industrycode     AS 行业分类
        ,T1.industryname     AS 行业名称
        ,T1.cust_no          AS 客户号
        ,CASE
           WHEN T1.custtype = '0' THEN '正式'
           WHEN T1.custtype = '1' THEN '潜在'
           WHEN T1.custtype = '3' THEN '未建档'
         END                 AS 客户类型
        ,CASE
           WHEN T3.com_type = '01'  THEN T3.com_code
           WHEN T31.com_type = '01' THEN T31.com_code
           WHEN T32.com_type = '01' THEN T32.com_code
         END                 AS 综合社区编号
        ,CASE
           WHEN T3.com_type = '01'  THEN T3.com_name
           WHEN T31.com_type = '01' THEN T31.com_name
           WHEN T32.com_type = '01' THEN T32.com_name
         END                 AS 综合社区
        ,CASE
           WHEN T3.com_type = '02'  THEN T3.com_code
           WHEN T31.com_type = '02' THEN T31.com_code
         END                 AS 综合社区版块编号
        ,CASE
           WHEN T3.com_type = '02'  THEN T3.com_name
           WHEN T31.com_type = '02' THEN T31.com_name
         END                 AS 综合社区版块
        ,CASE
           WHEN T3.com_type IN ( '03' , '04' , '05' ) THEN T3.com_code
         END                 AS 子社区编号
        ,CASE
           WHEN T3.com_type IN ( '03' , '04' , '05' ) THEN T3.com_name
         END                 AS 子社区
        ,CASE
           WHEN T3.com_type IN ( '03' , '04' , '05' ) THEN T3.com_vindicate_id
         END                 AS 子社区主维护人ID
        ,CASE
           WHEN T3.com_type IN ( '03' , '04' , '05' ) THEN T5.empe_nm
         END                 AS 子社区主维护人
FROM    edw.xwdt_xw_com_nearbyent T1 --社区企业信息表
LEFT JOIN    edw.xwdt_xw_community T3 --社区信息表  -- :01: 综合社区，02：综合社区版块，03子社区，04社区单元，05虚拟子社区
ON      T1.com_id = T3.id
AND     T3.DT = '20241118'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T3.org_id = T4.org_id
AND     T4.DT = '20241118'
LEFT JOIN    edw.xwdt_xw_community T31 --社区信息表  --取上一级社区
ON      T3.PARENT_ID = T31.ID
AND     T31.DT = '20241118'
LEFT JOIN    edw.xwdt_xw_community T32 --社区信息表 --取上一级社区
ON      T31.PARENT_ID = T32.ID
AND     T32.DT = '20241118'
LEFT JOIN    edw.dws_hr_empe_inf_dd T5 --员工汇总信息
ON      T3.com_vindicate_id = T5.empe_id
AND     T5.DT = '20241118'
WHERE   T1.DT = '20241118'
AND     T4.brc_org_nm = '舟山分行';
**01-数据需求_分行_D1119_王荣_舟山分行全量信贷类客户的资产负债率数据.sql
-- SJ2024111856截，止10月末，舟山分行全量信贷类客户的资产负债率数据。
-- 字段：管护机构、部门、管护人、管护人工号、客户号、客户姓名、同一风险控制号、资产总额、负债总额、我行授信敞口金额（同一风险控制号）、资产负债率数据

SELECT count(1) FROM tmp_zhoushan_SJ2024111856_01;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhoushan_SJ2024111856_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhoushan_SJ2024111856_01 AS
SELECT  T1.prm_org_id       AS 管护机构号
        ,T1.prm_org_id      AS 管护机构名称
        ,T2.tem_org_id      AS 团队层级机构编号
        ,T2.tem_org_nm      AS 团队层级机构名称
        ,T2.sbr_org_id      AS 支行层级机构编号
        ,T2.sbr_org_nm      AS 支行层级机构名称
        ,T1.prm_mgr_id      AS 管护人工号
        ,T1.prm_mgr_nm      AS 管护人
        ,T1.cst_id          AS 客户号
        ,T1.cst_nm          AS 客户姓名
        ,T3.SAM_RSK_CTRL_ID AS 同一风险控制号
        ,T4.ast_amt         AS 资产总额
        ,T4.lbl_tot_amt     AS 负债总额
        ,T4.ast_lbl_rat     AS 资产负债率
        ,T5.我行授信敞口金额_同一风险控制号
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T2 --机构树_考核维度
ON      T1.prm_org_id = T2.org_id
AND     T2.DT = '20241031'
LEFT JOIN    edw.dws_cst_bas_inf_dd T3 --客户基础信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20241031'
LEFT JOIN    edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd T4 --信贷客户资产负债概况
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20241031'
LEFT JOIN    (
                 SELECT  CASE
                           WHEN A2.SAM_RSK_CTRL_ID <> '' THEN A2.SAM_RSK_CTRL_ID
                           ELSE A1.cst_id
                         END                   AS SAM_RSK_CTRL_ID
                         ,SUM(A1.ctr_epsr_amt) AS 我行授信敞口金额_同一风险控制号
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
                 INNER JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.cst_id = A2.cst_id
                 AND     A2.DT = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') )
                       OR A1.CTR_BAL > 0 )
                 GROUP BY CASE WHEN A2.SAM_RSK_CTRL_ID <> '' THEN A2.SAM_RSK_CTRL_ID ELSE A1.cst_id END
             ) T5
ON      CASE WHEN T3.SAM_RSK_CTRL_ID <> '' THEN T3.SAM_RSK_CTRL_ID ELSE T1.cst_id END = T5.SAM_RSK_CTRL_ID
LEFT JOIN    (
                 SELECT   A1.cst_id
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') )
                       OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T6
ON      T1.cst_id  = T6.cst_id
WHERE   T1.DT = '20241031'
AND     T6.cst_id IS NOT NULL --有效信贷合同
AND     T2.brc_org_nm = '舟山分行';
**01-数据需求_分行_D1119_黄志伟_信用卡未配贷款的客户进行授信.sql
--转思灏处理
--SJ2024111946
--截止2024年11月19日,绍兴分行信用卡全量清单。
--针对信用卡未配贷款的客户进行授信。

--字段：统计日期	管户分行	信贷管户支行	信贷管户机构	客户经理工号	客户经理姓名	客户号	客户姓名	客群标签
--卡号	开户日期	发卡日期	激活日期	首刷日期	授信额度	产品名称	透支本金(含分期付款余额)	余额	是否逾期	逾期期数	卡状态	帐户状态	溢缴款金额
--账单地址	申请渠道	二维码推荐人工号	二维码推荐人姓名	分期剩余未还本金
--是否配贷	是否信贷有效户	子社区名称	综合版块名称

--adm_pub.adm_pub_cbus_cr_crd_apl_inf_dd  --公共应用集市-信用卡申请信息表
--edw.dwd_bus_crd_cr_crd_mgr_inf_dd  --信用卡管护

--edw.dim_bus_crd_cr_crd_inf_dd  --信用卡卡片信息
--app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd  --信用卡卡片信息汇总
--edw.dim_bus_crd_cr_crd_pd_inf_dd   --信用卡产品信息

--edw.dws_bus_crd_cr_crd_act_inf_dd --信用卡账户汇总信息

--adm_pub.adm_csm_cbas_ind_inf_dd   --客户集市-基础信息-客户基础标识信息

--edw.dwd_cst_mng_cmnt_rel_dd  --客户社区信息


--先取绍兴分行全量信用卡客户，再判断是否信贷有效户

SELECT t1.cst_id
       ,t1.cst_nm
       ,t1.cr_crd_card_nbr
       ,t1.cr_crd_act_id
       ,t1.cr_crd_mgr_id 业务管护人工号
       ,t1.cr_crd_mgr_nm 业务管护人
       ,t1.cr_crd_org_id 业务管护机构号
       ,t1.cr_crd_org_nm 业务管护机构
       ,t1.cr_crd_brc_org_nm 业务管护分行
    --    ,t1.cst_mgr_id 客户主管护客户经理工号
    --    ,t1.cst_mgr_nm 客户主管护客户经理
    --    ,t1.cst_org_id 客户主管护机构号
    --    ,t1.cst_org_nm 客户主管护机构名称
    --    ,t1.cst_brc_org_nm 客户主管护分行
       ,t1.cd_val_dscr 卡状态
       ,t1.card_sts_cd 卡状态码值
       ,t1.applytype 申请渠道
       ,t1.card_actv_dt  激活日期
FROM app_ado.adm_subl_bus_crd_cr_card_smy_inf_dd t1 --信用卡卡片信息汇总
WHERE dt='@@{yyyyMMdd}'
;
**01-数据需求_分行_D1120_潘滔_温州分行_未被领取预约卡数据.sql
drop table if exists lab_bigdata_dev.tmp_lq_czl_20241126_01 purge ;
create table  lab_bigdata_dev.tmp_lq_czl_20241126_01  --20231031的主键类数据
(
    卡号 string
    ,卡种 string
);


-- 户名	申请家长姓名（仅成长乐）	管护机构	管户客户经理姓名	管户客户经理工号


INSERT INTO lab_bigdata_dev.tmp_lq_czl_20241126_01 VALUES
('6214800800020130921','成长乐卡（蛇）空白卡')
,('6214800800020181116','成长乐卡（狗）空白卡')
,('6214800800020220117','成长乐卡（牛）空白卡')
,('6214800800020221020','成长乐卡（虎）空白卡')
,('6214800800120190224','成长乐卡（猪）空白卡')
,('6214800800820000211','成长乐卡（龙）空白卡')
,('6214800800820060626','成长乐卡（狗）空白卡')
,('6214800800820080222','成长乐卡（鼠）空白卡')
,('6214800800820080912','成长乐卡（鼠）空白卡')
,('6214800800820080925','成长乐卡（鼠）空白卡')
,('6214800800820081008','成长乐卡（鼠）空白卡')
,('6214800800820090704','成长乐卡（牛）空白卡')
,('6214800800820091116','成长乐卡（牛）空白卡')
,('6214800800820100611','成长乐卡（虎）空白卡')
,('6214800800820110220','成长乐卡（兔）空白卡')
,('6214800800820110714','成长乐卡（兔）空白卡')
,('6214800800820140825','成长乐卡（马）空白卡')
,('6214800800820150616','成长乐卡（羊）空白卡')
,('6214800800820161230','成长乐卡（猴）空白卡')
,('6214800800820170524','成长乐卡（鸡）空白卡')
,('6214800800820180409','成长乐卡（狗）空白卡')
,('6214800800820220303','成长乐卡（虎）空白卡')
,('6214800800920160908','成长乐卡（龙）空白卡')
,('6214800800920220216','成长乐卡（虎）空白卡')
,('6214800801020081024','成长乐卡（鼠）空白卡')
,('6214800801020110702','成长乐卡（兔）空白卡')
,('6214800801220191107','成长乐卡（猪）空白卡')
,('6214800801220230716','成长乐卡（兔）空白卡')
,('6214800801820070920','成长乐卡（猪）空白卡')
,('6214800801820080311','成长乐卡（鼠）空白卡')
,('6214800801820080728','成长乐卡（鼠）空白卡')
,('6214800801820181224','成长乐卡（狗）空白卡')
,('6214800801820211104','成长乐卡（牛）空白卡')
,('6214808888000188888','泰隆借记IC空白卡')
,('6214808888001001115','泰隆借记IC空白卡')
,('6214808888022288888','泰隆借记IC空白卡')
,('6214808888310588888','泰隆借记IC空白卡')
,('6214808888668638888','泰隆借记IC空白卡')
,('6214808888808028888','泰隆借记IC空白卡')
,('6214808888999588888','泰隆借记IC空白卡')
,('6214809801004295841','存贷卡空白卡')
,('6214809801004303942','存贷卡空白卡')
,('6214809801006336106','存贷卡空白卡')
,('6214809801006493949','存贷卡空白卡')
,('6214809801000550256','存贷卡空白卡')
,('6214809801003190217','存贷卡空白卡')
,('6214809801004036617','存贷卡空白卡')
,('6214809801004085200','存贷卡空白卡')
,('6214809801004270794','存贷卡空白卡')
,('6214809801004295429','存贷卡空白卡')
,('6214809801004911124','存贷卡空白卡')
,('6214809801005112847','存贷卡空白卡')
,('6214809801005274340','存贷卡空白卡')
,('6214809801005276055','存贷卡空白卡')
,('6214809801005296376','存贷卡空白卡')
,('6214809801005304618','存贷卡空白卡')
,('6214809801005304642','存贷卡空白卡')
,('6214809801005364810','存贷卡空白卡')
,('6214809801005812198','存贷卡空白卡')
,('6214808800002110185','泰隆福卡空白卡')
,('6214808801000365839','泰隆借记IC空白卡')
,('6214808801001776794','泰隆借记IC空白卡')
,('6214808801002405450','泰隆借记IC空白卡')
,('6214808801002409650','泰隆借记IC空白卡')
,('6214808801002409759','泰隆借记IC空白卡')
,('6214808801002410518','泰隆借记IC空白卡')
,('6214808801002410609','泰隆借记IC空白卡')
,('6214808801002435416','泰隆借记IC空白卡')
,('6214808801002438337','泰隆借记IC空白卡')
,('6214808801002443410','泰隆借记IC空白卡')
,('6214808801002444780','泰隆借记IC空白卡')
,('6214808801002446025','泰隆借记IC空白卡')
,('6214808801002447155','泰隆借记IC空白卡')
,('6214808801002449714','泰隆借记IC空白卡')
,('6214808801002450894','泰隆借记IC空白卡')
,('6214808801002452718','泰隆借记IC空白卡')
,('6214808801002453831','泰隆借记IC空白卡')
,('6214808801002454136','泰隆借记IC空白卡')
,('6214808801002455562','泰隆借记IC空白卡')
,('6214808801002456966','泰隆借记IC空白卡')
,('6214808801002458871','泰隆借记IC空白卡')
,('6214808801002459184','泰隆借记IC空白卡')
,('6214808801002461370','泰隆借记IC空白卡')
,('6214808801002462527','泰隆借记IC空白卡')
,('6214808801002462980','泰隆借记IC空白卡')
,('6214808801002464333','泰隆借记IC空白卡')
,('6214808801002467161','泰隆借记IC空白卡')
,('6214808801002467625','泰隆借记IC空白卡')
,('6214808801002470926','泰隆借记IC空白卡')
,('6214808801002470983','泰隆借记IC空白卡')
,('6214808801002480131','泰隆借记IC空白卡')
,('6214808801002480826','泰隆借记IC空白卡')
,('6214808801002482582','泰隆借记IC空白卡')
,('6214808801002482731','泰隆借记IC空白卡')
,('6214808801002487680','泰隆借记IC空白卡')
,('6214808801002488738','泰隆借记IC空白卡')
,('6214808801002495022','泰隆借记IC空白卡')
,('6214808801002495733','泰隆借记IC空白卡')
,('6214808801002496244','泰隆借记IC空白卡')
,('6214808801002497044','泰隆借记IC空白卡')
,('6214808801002498521','泰隆借记IC空白卡')
,('6214808801002499149','泰隆借记IC空白卡')
,('6214808801002500862','泰隆借记IC空白卡')
,('6214808801002502181','泰隆借记IC空白卡')
,('6214808801002502223','泰隆借记IC空白卡')
,('6214808801002506323','泰隆借记IC空白卡')
,('6214808801002512222','泰隆借记IC空白卡')
,('6214808801002518096','泰隆借记IC空白卡')
,('6214808801002518161','泰隆借记IC空白卡')
,('6214808801002518286','泰隆借记IC空白卡')
,('6214808801002519532','泰隆借记IC空白卡')
,('6214808801002520514','泰隆借记IC空白卡')
,('6214808801002544480','泰隆借记IC空白卡')
,('6214808801002544837','泰隆借记IC空白卡')
,('6214808801002545610','泰隆借记IC空白卡')
,('6214808801002546576','泰隆借记IC空白卡')
,('6214808801002546592','泰隆借记IC空白卡')
,('6214808801002546766','泰隆借记IC空白卡')
,('6214808801002546899','泰隆借记IC空白卡')
,('6214808801004864480','泰隆借记IC空白卡')
,('6214808801005340043','泰隆借记IC空白卡')
,('6214808801005340084','泰隆借记IC空白卡')
,('6214808801005340555','泰隆借记IC空白卡')
,('6214808801005341322','泰隆借记IC空白卡')
,('6214808801005341413','泰隆借记IC空白卡')
,('6214808801005341835','泰隆借记IC空白卡')
,('6214808801005342668','泰隆借记IC空白卡')
,('6214808801005352816','泰隆借记IC空白卡')
,('6214808801005370735','泰隆借记IC空白卡')
,('6214808801005400540','泰隆借记IC空白卡')
,('6214808801005401571','泰隆借记IC空白卡')
,('6214808801005402488','泰隆借记IC空白卡')
,('6214808801005402983','泰隆借记IC空白卡')
,('6214808801005403114','泰隆借记IC空白卡')
,('6214808801005403155','泰隆借记IC空白卡')
,('6214808801005403536','泰隆借记IC空白卡')
,('6214808801009373370','泰隆借记IC空白卡')
,('6214808801009841905','泰隆借记IC空白卡')
,('6214808801010385454','泰隆借记IC空白卡')
,('6214808801011185614','泰隆借记IC空白卡')
,('6214808801011186018','泰隆借记IC空白卡')
,('6214808801011186224','泰隆借记IC空白卡')
,('6214808801012620635','泰隆借记IC空白卡')
,('6214808801013275876','泰隆借记IC空白卡')
,('6214808801013275959','泰隆借记IC空白卡')
,('6214808801027880125','泰隆借记IC空白卡')
,('6214808811000037189','泰隆梦想卡(蓝色借记IC)空白卡')
,('6214809803000784877','泰隆借记IC空白卡')
,('6214809901000071244','随贷通卡空白卡')
,('6214809938000385968','随贷通卡空白卡')
,('6214809938000552989','随贷通卡空白卡')
,('6214809938000619044','随贷通卡空白卡')
,('6214809938001062095','随贷通卡空白卡')
,('6214809938001089361','随贷通卡空白卡')
,('6214809938001104459','随贷通卡空白卡')
,('6214809938001108708','随贷通卡空白卡')
,('6214809938001134936','随贷通卡空白卡')
,('6214809938001160139','随贷通卡空白卡')
,('6214809938001179436','随贷通卡空白卡')
,('6221410007804181','泰隆借记IC空白卡')
,('6221417300090442','随贷通卡空白卡')
,('6214800000000627235','泰隆借记IC空白卡') ;




DROP TABLE IF EXISTS lab_bigdata_dev.tmp_lq_czl_20241126_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_lq_czl_20241126_02 AS
SELECT  DISTINCT T1.卡号
        ,T1.卡种
        ,T2.cst_act_nm AS 户名
        ,T2.cst_id     AS 客户编号
        ,CASE
           WHEN T1.卡种 LIKE '成长乐%' THEN T211.cd_val_dscr
           ELSE ''
         END           AS 关系类型
        ,CASE
           WHEN T1.卡种 LIKE '成长乐%' THEN T22.cst_chn_nm
           ELSE ''
         END           AS 申请家长姓名仅成长乐
        ,T3.acs_org_id AS 存款账户管护机构号
        ,T4.org_nm     AS 存款账户管护机构名称
        ,T3.mgr_id     AS 存款账户客户经理工号
        ,T5.empe_nm    AS 存款账户客户经理姓名
        ,T6.prm_org_id AS 主管护机构号
        ,T6.prm_org_nm AS 主管护机构名称
        ,T6.prm_mgr_id AS 主管护人工号
        ,T6.prm_mgr_nm AS 主管护人名称
FROM    lab_bigdata_dev.tmp_lq_czl_20241126_01 T1
LEFT JOIN    edw.dim_bus_dep_cst_act_inf_dd T2 --客户存款账户信息
ON      T1.卡号 = T2.cst_act_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_rel_inf_dd T21   --关联关系
ON      T2.cst_id = T21.cst_id
AND     T21.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T211
ON      coalesce(T21.rel_typ_cd) = T211.cd_val
AND     T211.dt = '@@{yyyyMMdd}'
AND     T211.tbl_nm = upper('dim_cst_rel_inf_dd')
AND     T211.fld_nm = upper('rel_typ_cd')
LEFT JOIN    edw.dws_cst_bas_inf_dd T22
ON      T21.rel_cst_id = T22.cst_id
AND     T22.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T3 --客户存款账户管护信息
ON      T1.卡号 = T3.cst_act_id
AND     T3.frs_ctc_ind = '1' --第一联系人标志
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T3.acs_org_id = T4.org_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd T5 --员工汇总信息
ON      T3.mgr_id = T5.empe_id
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T6 --客户主管户信息
ON      T2.cst_id = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}';
**01-数据需求_分行_D1121_台州分行_许琼鹏_庞献勇的重组调查方案.sql
--SJ20241119101

--用于庞献勇的举报材料
--庞献勇的重组调查方案，2023年08月02日，天台平桥支行重组调查方案

--1015571145

-- 需要客户方案的内容以及借款人的详细情况和担保人的详细情况



SELECT  rp.serialno 方案编号
        ,rp.plantype 方案类型
        ,rp.restructtype 重组类型
        ,rp.totalrestructnum 累计重组次数
        ,rp.restructdate 拟重组期限
        ,rp.restructrate 拟重组利率
        ,rp.guarantytype 担保方式
        ,rp.oldborrower 原借款人
        ,rp.newborrower 新借款人
        ,guarantyischange 担保人物是否变更或新增
        ,oldguarantor 原担保人
        ,newguarantor 新担保人
        ,conditiionmatch 新借款人或担保人情况分析
        ,cashisback 是否存在现金收回
        ,actrualsum 实收总和
        ,actrualcapitalsum 实收本金总和
        ,actrualratesum 实收正常利息总和
        ,actrualpenaltysum 实收罚息总和
        ,backdescribe 简述每笔业务收回情况
        ,rateisavoid 是否存在利息减免
        ,avoidsum 申请减免金额
        ,avoidcapital 减免贷款本金
        ,avoidrate 减免正常利息
        ,avoidpenalty 减免罚息
        ,avoiddescribe 情况说明及申请减免理由
        ,contextinfo 重组贷款背景情况
        ,restructpaln 重组方案说明及后续的处置计划
        ,ratechangedescribe 利率调整说明
        ,remark 备注及特殊情况说明
        ,inputuserid 登记人
        ,inputorgid 登记机构
        ,inputdate 登记日期
        ,updatedate 更新日期
        ,actualrestructborrow 实际重组借款人
        ,actualrestructsum 实际重组金额
        ,actualrestructdate 实际重组期限
        ,actualrestructrate 实际重组利率
        ,actualbusinesssort 实际重组业务品种
        ,actualrestructremark 实际重组贷款用途
        ,actualguarantytype 实际担保方式
        ,actualremark 备注
        ,isexecuted 是否已执行完成1是已完成
        ,isover 是否超出指导意见需上报总行
        ,restructresult 重组效果认定
        ,completeflag 信息完整性标志
        ,businesstype 重组后的业务品种
        ,oldbusinesstype 重组前的业务品种
        ,customername 拟重组客户姓名
        ,certtype 拟重组客户证件类型
        ,oldcerttype 原客户证件类型
        ,customerid 拟重组客户编号
        ,oldcustomerid 原客户编号
        ,oldcertid 原客户证件号码
        ,businesssum 拟重组金额
        ,oldbusinesssum 原客户授信金额
        ,restructcount 拟重组分期期数
        ,overdueamt 原客户逾期本金
        ,restructfee 拟重组分期手续费
        ,oldcontractno 原卡号或合同号
        ,guarantor1 拟重组客户担保人1
        ,oldguarantor1 原担保人1
        ,guarantor2 拟重组客户担保人2
        ,oldguarantor2 原担保人2
        ,guarantor3 拟重组客户担保人3
        ,oldguarantor3 原担保人3
        ,oldcustomername 原客户姓名
        ,certid 拟重组客户证件号码
        ,actualcertid 实际重组客户证件号码
        ,actualcount 实际重组分期手续费
        -- ,actualrestructfee  --
        ,actualguarantor1 实际重组客户担保人1
        ,actualguarantor2 实际重组客户担保人2
        ,actualguarantor3 实际重组客户担保人2
        ,actualcontractno 实际重组客户卡号
        ,upperbusinesssum 拟重组金额_大写
        ,tempsaveflag 暂存标志
        ,maturity 到期日
        ,putoutdate 借款日
        ,actrualczsum 实际CZ金额
        ,ictype 还款方式
        ,avoidcardcapital 减免信用卡金额
        ,avoidcardrate 减免信用卡正常利息
        ,avoidcardpenalty 减免信用卡违约金
        ,avoidloancardcapital 减免随贷通卡金额
        ,avoidloancardrate 减免随贷通卡正常利息
        ,avoidloancardpenalty 减免随贷通卡罚息
        ,beimport 是否被引入1是2否
FROM    edw.loan_restruct_plan rp --重组方案表
WHERE   rp.dt = '20240719'
AND     oldborrower LIKE '庞献勇';





-- select * from edw.zcbq_plan_apply_relative  --方案申请关联表
-- ;
**01-数据需求_分行_D1122_李铭雪_统计司法协助业务笔数_有权机关类型.sql
-- SJ2024111971
--时间：20230101-20240930
-- 经办机构：台州分行所有支行以及总行营业部
-- 数据：


-- 1.2135冻结明细表查询中交易机构为台州分行所有支行以及总行营业部，时间为20230101-20240930全量数据；
--冻结编号	客户账号	负债账号	冻结范围	冻结种类	限制类型	解冻标志	需冻/控金额	冻结起始日期	冻结终止日期	冻结通知书编号 	冻结证明文书类别	冻结原因	冻结来源
-- 执法部门	执法部门名称	执法人1证件种类	执法人1证件号码	执法人员1姓名	执法人2证件种类	执法人2证件号码	执法人员2姓名
-- 办理机构	经办人	复核人	审批人	交易代码	冻结时间	冻结日期	冻结操作标志	子账户序号
-- 解冻金额	解冻通知书编号	解冻证明文书类别	解冻原因	解冻日期	外部交易码	账户名称	渠道



DROP TABLE IF EXISTS tmp_sjxq_SJ2024111971_001 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024111971_001 AS
SELECT  dongjbho 冻结编号
        ,CASE
           WHEN donjczbz = 1 THEN '冻结'
           WHEN donjczbz = 2 THEN '全部解冻'
           WHEN donjczbz = 3 THEN '部分解冻'
           WHEN donjczbz = 4 THEN '金额续冻'
           WHEN donjczbz = 5 THEN '控制'
           WHEN donjczbz = 6 THEN '解控'
           WHEN donjczbz = 7 THEN '续控'
           WHEN donjczbz = 8 THEN '扣划'
         END                                  AS 冻结操作标志
        ,shunxhao 顺序号
        ,xudongxh 续冻序号
        ,kd.kehuzhao 客户账号
        ,zhanghao 负债账号
        ,CASE
           WHEN donjfanw = 0 THEN '指定子账户'
           WHEN donjfanw = 1 THEN '全部子账户'
           WHEN donjfanw = 2 THEN '客户账号'
           WHEN donjfanw = 3 THEN '客户号'
           WHEN donjfanw = 4 THEN '客户账号群'
           WHEN donjfanw = 5 THEN '客户群'
         END                                  AS 冻结范围
        -- ,jixibioz 计息标志
        ,CASE
           WHEN donjlaiy = 1 THEN '冻结'
           WHEN donjlaiy = 2 THEN '控制'
           WHEN donjlaiy = 3 THEN '其他'
         END                                  AS 冻结来源
        -- ,donjzhgl 冻结种类
        ,cd.cd_val_dscr 冻结种类
        ,xudonjje 需冻结金额
        ,xndonjje 现冻结金额
        ,ljdonjje 累计冻结金额
        ,yikouhje 已扣划金额
        ,sfyxcedj 是否允许超额冻结1允许0不允许
        ,donjjibe 冻结级别
        ,djqsriqi 冻结起始日期
        ,djzzriqi 冻结终止日期
        ,djtzsbho 冻结通知书编号
        ,CASE
           WHEN donjwslx = 1 THEN '企业名称预先核准通知书'
           WHEN donjwslx = 2 THEN '质押贷款合同号'
           WHEN donjwslx = 3 THEN '财政部门证明文件'
           WHEN donjwslx = 4 THEN '开户许可证'
           WHEN donjwslx = 5 THEN '驳回公司（企业）登记申请通知书'
         END                                  AS 冻结证明文书类别
        ,jiedonbz AS 解冻标志0未解冻1已解冻
        ,donjyyin 冻结原因
        -- ,zfbmleix 执法部门
        ,zfbmminc 执法部门名称
        -- ,zfrzjzl1 执法人1证件种类
        ,zf1.cd_val_dscr 执法人1证件种类
        ,zfrzjhm1 执法人1证件号码
        ,zfrxinm1 执法人员1姓名
        -- ,zfrzjzl2 执法人2证件种类
        ,zf2.cd_val_dscr 执法人2证件种类
        ,zfrzjhm2 执法人2证件号码
        ,zfrxinm2 执法人员2姓名
        -- ,jiaoyijg   交易机构
        ,a.org_nm 交易机构
        -- ,jinbguiy   经办人
        ,h1.empe_nm 经办人
        -- ,fuheguiy   复核人
        ,h2.empe_nm 复核人
        -- ,shnpguiy   审批人
        ,h3.empe_nm 审批人
        ,wbjoyima 外部交易码
        ,nbjoyima 内部交易码
        ,donjriqi 冻结日期
        ,donjshij 冻结时间
        ,pjszhxrq 判决书执行日期
        ,jiedjine 解冻金额
        ,tonzshbh 解冻通知书编号
        ,CASE
           WHEN jdzmwslx = 1 THEN '企业名称预先核准通知书'
           WHEN jdzmwslx = 2 THEN '质押贷款合同号'
           WHEN jdzmwslx = 3 THEN '财政部门证明文件'
           WHEN jdzmwslx = 4 THEN '开户许可证'
           WHEN jdzmwslx = 5 THEN '驳回公司（企业）登记申请通知书'
         END                                  AS 解冻证明文书类别
        ,jiedyyin 解冻原因
        ,jiaoyirq 交易日期
        ,kk.kehuzhmc 账户名称
        -- ,qudaohao 渠道
        ,cd1.cd_val_dscr 渠道
        ,kd.jiluztai 记录状态
FROM    edw.core_kdpb_dngjdj kd --负债账户冻结登记簿
LEFT JOIN    edw.core_kdpa_kehuzh kk --客户账号表
ON      kd.kehuzhao = kk.kehuzhao
AND     kk.dt = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a
ON      kd.jiaoyijg = a.org_id
AND     a.dt = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd h1
ON      kd.jinbguiy = h1.empe_id
AND     h1.dt = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd h2
ON      kd.fuheguiy = h2.empe_id
AND     h2.dt = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd h3
ON      kd.shnpguiy = h3.empe_id
AND     h3.dt = '20240930'
LEFT JOIN    edw.dwd_code_library_dd cd
ON      kd.donjzhgl = cd.cd_val
AND     cd.dt = '20240930'
AND     cd.tbl_nm = upper('dwd_bus_dep_frz_inf_dd')
AND     cd.fld_nm = upper('frz_cls_cd')
LEFT JOIN    edw.dwd_code_library_dd cd1
ON      kd.donjzhgl = cd1.cd_val
AND     cd1.dt = '20240930'
AND     cd1.tbl_nm = upper('dwd_bus_dep_frz_inf_dd')
AND     cd1.fld_nm = upper('chnl_cd')
LEFT JOIN    edw.dwd_code_library_dd zf1
ON      kd.zfrzjzl1 = zf1.cd_val
AND     zf1.dt = '20240930'
AND     zf1.tbl_nm = upper('dim_cst_bas_doc_inf_dd')
AND     zf1.fld_nm = upper('doc_typ_cd')
LEFT JOIN    edw.dwd_code_library_dd zf2
ON      kd.zfrzjzl1 = zf2.cd_val
AND     zf2.dt = '20240930'
AND     zf2.tbl_nm = upper('dim_cst_bas_doc_inf_dd')
AND     zf2.fld_nm = upper('doc_typ_cd')
WHERE   kd.dt = '20240930'
AND     (kd.jiaoyijg LIKE '3301%' --台州分行
or kd.jiaoyijg='999900000'  --总行营业部
)
AND     kd.weihriqi BETWEEN '20230101' AND '20240930';


-- 2.柜面渠道办理的全量2126有权机关查询登记交易机构为台州分行所有支行以及总行营业部，时间为20230101-20240930全量数据；
-- 录入信息编号	机关类型	机关名称	客户名称	客户账号	证件号码	证件类型	执法人员姓名1	执法人员证件类型1	执法人员证件号码1	执法人员姓名2	执法人员证件类型2	执法人员证件号码2
-- 法律文书名称	法律文书编号	查询内容	经办机构	经办柜员	复核柜员	经办日期	经办时间	渠道名称	修改标志
-- 修改柜员号	修改复核柜员	修改机构	修改日期	修改时间	修改内容	影像批次号	执行案号	查询类型
-- 回执内容	回执交接方式	快递单号	电子邮箱号	回执领取人证件类型	回执领取人证件号码	回执领取人名字	回执登记日期


DROP TABLE IF EXISTS tmp_sjxq_SJ2024111971_002 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024111971_002 AS
SELECT  T2.inpt_inf_id      AS 录入信息编号
        ,T2.pow_inst_typ_cd AS 机关类型
        ,T2.pow_inst_nm     AS 机关名称
        ,T2.cst_nm          AS 客户名称
        ,T2.cst_act_id	      AS 客户账号
        ,T2.doc_nbr         AS 证件号码
        ,T5.cd_val_dscr     AS 证件类型
        ,T2.psn_a_nm        AS 执法人员姓名1
        ,T6.cd_val_dscr     AS 执法人员证件类型1
        ,T2.psn_a_doc_nbr   AS 执法人员证件号码1
        ,T2.psn_b_nm        AS 执法人员姓名2
        ,T7.cd_val_dscr     AS 执法人员证件类型2
        ,T2.psn_b_doc_nbr   AS 执法人员证件号码2
        ,T2.law_doc_nm      AS 法律文书名称
        ,T2.law_doc_id      AS 法律文书编号
        ,T2.qry_cnt         AS 查询内容
        ,T2.hdl_org_id      AS 经办机构ID
        ,T8.org_nm          AS 经办机构
        ,T2.hdl_tlr_id      AS 经办柜员ID
        ,T9.empe_nm         AS 经办柜员
        ,T2.chk_tlr_id      AS 复核柜员ID
        ,T91.empe_nm        AS 复核柜员
        ,T2.hdl_dt          AS 经办日期
        ,T2.opr_tm          AS 经办时间
        ,T2.qry_chnl_typ_cd AS 渠道名称
        ,T2.mdf_ind         AS 修改标志
        ,T2.mdf_hdl_tlr_id  AS 修改柜员号
        ,T92.empe_nm        AS 修改柜员
        ,T2.mdf_chk_tlr_id  AS 修改复核柜员号
        ,T93.empe_nm        AS 修改复核柜员
        ,T2.mdf_org_id      AS 修改机构ID
        ,T81.org_nm         AS 修改机构
        ,T2.mdf_dt          AS 修改日期
        ,T2.mdf_tm          AS 修改时间
        ,T2.mdf_inf         AS 修改内容
        ,T2.blp_plf_bch_seq AS 影像批次号
        ,T3.exe_case_id     AS 执行案号
        ,T3.rcp_cnt         AS 回执内容
        ,T3.rcp_mth_cd      AS 回执交接方式
        ,T3.exp_ord_nbr     AS 快递单号
        ,T3.eml             AS 电子邮箱号
        ,T10.cd_val_dscr    AS 回执领取人证件类型
        ,T3.doc_nbr        AS 回执领取人证件号码
        ,T3.psn_nm         AS 回执领取人名字
        ,T3.rcp_tm         AS 回执登记日期
FROM   edw.dwd_bus_chnl_fr_cnt_pow_inst_reg_inf_dd T2 --综合前置平台柜面有权机关登记信息
LEFT JOIN    edw.dwd_bus_chnl_fr_cnt_pow_inst_rcp_inf_dd T3 --综合前置平台柜面有权机关回执信息
ON      T2.blp_plf_bch_seq = T3.blp_plf_bch_seq
AND     T3.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd T5 --码值表
ON      T2.doc_typ_cd = T5.cd_val
AND     T5.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T5.fld_nm = 'DOC_TYP_CD'
AND     T5.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd T6 --码值表
ON      T2.psn_a_doc_typ_cd = T6.cd_val
AND     T6.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T6.fld_nm = 'DOC_TYP_CD'
AND     T6.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd T7 --码值表
ON      T2.psn_b_doc_typ_cd = T7.cd_val
AND     T7.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T7.fld_nm = 'DOC_TYP_CD'
AND     T7.DT = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T8 --机构树_考核维度
ON      T2.hdl_org_id = T8.org_id
AND     T8.DT = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T81 --机构树_考核维度
ON      T2.mdf_org_id = T81.org_id
AND     T81.DT = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd T9 --员工汇总信息
ON      T2.hdl_tlr_id = T9.empe_id
AND     T9.DT = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd T91 --员工汇总信息
ON      T2.chk_tlr_id = T91.empe_id
AND     T91.DT = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd T92 --员工汇总信息
ON      T2.mdf_hdl_tlr_id = T92.empe_id
AND     T92.DT = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd T93 --员工汇总信息
ON      T2.mdf_chk_tlr_id = T93.empe_id
AND     T93.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd T10 --码值表
ON      T3.doc_typ_cd = T10.cd_val
AND     T10.tbl_nm = 'DIM_CST_BAS_DOC_INF_DD'
AND     T10.fld_nm = 'DOC_TYP_CD'
AND     T10.DT = '20240930'
WHERE   T2.DT = '20240930'
AND     T2.hdl_dt >= '20230101'
AND     T2.hdl_dt <= '20240930'
AND     ( T8.brc_org_nm = '台州分行'
    OR T8.brc_org_nm = '总行营业部' );



-- 3.全量2123强制扣划中有权机关扣划数据（交易机构为台州分行所有支行以及总行营业部，时间为20230101-20240930)。
-- 冻结编号	客户账号	负债账号	扣划编号	扣划方式	已扣划金额	待销账序号	执法部门名称	扣划文书号	执法人1证件种类	执法人1证件号码	执法人员1姓名	执法人2证件种类
-- 执法人2证件号码	执法人员2姓名	办理机构	经办人	复核人	审批人	外部交易码	交易日期	交易时间 	子账户序号	账户名称	扣划渠道



DROP TABLE IF EXISTS tmp_sjxq_SJ2024111971_003 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024111971_003 AS
SELECT  dongjbho 冻结编号
        ,kh.kehuzhao 客户账号
        ,zhanghao 负债账号
        ,kouhabho 扣划编号
        ,case when kouhuafs=0 then '冻结扣划'
        when kouhuafs=1 then '直接扣划'
        end as 扣划方式
        ,kouhuaje 扣划金额
        ,dxzhxhao 待销账序号
        ,zfbmleix 执法部门
        ,khwshaoo 扣划文书号
        -- ,khryzle1 扣划人1证件种类
        ,zf1.cd_val_dscr  扣划人1证件种类
        ,khryzjh1 扣划人1证件号码
        ,khryxmm1 扣划人员1姓名
        -- ,khryzle2 扣划人2证件种类
        ,zf2.cd_val_dscr 扣划人2证件种类
        ,khryzjh2 扣划人2证件号码
        ,khryxmm2 扣划人员2姓名
        ,jiaoyijg 交易机构号
        ,a.org_nm 交易机构
        -- ,jinbguiy 经办人
        ,h1.empe_nm 经办人
        -- ,fuheguiy 复核人
        ,h2.empe_nm 复核人
        -- ,shnpguiy 审批人
        ,h3.empe_nm 审批人
        ,wbjoyima 外部交易码
        ,jiaoyirq 交易日期
        ,jiaoyisj 交易时间
        ,skrkhuzh 收款人客户账号
        ,skzhxuho 收款人子账户序号
        ,kk.kehuzhmc 账户名称
        ,khbmenmc 扣划部门名称
        ,kh.jiluztai 记录状态
FROM    edw.core_kdpb_kouhua kh --负债账户扣划登记簿
LEFT JOIN    edw.core_kdpa_kehuzh kk --客户账号表
ON      kh.kehuzhao = kk.kehuzhao
AND     kk.dt = '20240930'
left join  edw.dim_hr_org_mng_org_tree_dd  a
on kh.jiaoyijg=a.org_id
and a.dt='20240930'
left join edw.dws_hr_empe_inf_dd h1
on kh.jinbguiy=h1.empe_id
and h1.dt='20240930'
left join edw.dws_hr_empe_inf_dd h2
on kh.fuheguiy=h2.empe_id
and h2.dt='20240930'
left join edw.dws_hr_empe_inf_dd h3
on kh.shnpguiy=h3.empe_id
and h3.dt='20240930'
LEFT JOIN    edw.dwd_code_library_dd zf1
ON      kh.khryzle1 = zf1.cd_val
AND     zf1.dt = '20240930'
AND     zf1.tbl_nm = upper('dim_cst_bas_doc_inf_dd')
AND     zf1.fld_nm = upper('doc_typ_cd')
LEFT JOIN    edw.dwd_code_library_dd zf2
ON      kh.khryzle2 = zf2.cd_val
AND     zf2.dt = '20240930'
AND     zf2.tbl_nm = upper('dim_cst_bas_doc_inf_dd')
AND     zf2.fld_nm = upper('doc_typ_cd')
WHERE   kh.dt = '20240930'
AND     (kh.jiaoyijg LIKE '3301%' --台州分行
or kh.jiaoyijg='999900000'  --总行营业部
)
AND     kh.jiaoyirq BETWEEN '20230101' AND '20240930'
;
**01-数据需求_分行_D1122_金华分行_翁晨_司法查询账户.sql
--SJ2024112251
--账号、业务办理日期、金额、办理渠道、具体办理银行网点
--6221410005203337




SELECT * FROM edw.dwd_bus_chnl_fr_unionpay_trx_srl_di
WHERE in ('20120223','20120525','20120612','20120725','20120727','20120811','20120823','20120928','20121011','20121106','20121123','20130123','20130401','20130424')
and( trsf_out_act_id='6221410005203337'  or trsf_in_act_id='6221410005203337' )



-- edw.dwd_bus_chnl_spmt_lrg_amt_pay_inf_di  --大额单笔支付信息
--edw.dwd_bus_chnl_spmt_sml_amt_pay_inf_di  --小额单笔支付信息
---edw.wyhl_ibps_pay_trans_reg  --网银互联支付业务主流水表
--edw.dwd_bus_chnl_fr_cbcg_trx_srl_di   --城商行交易流水信息


SELECT *
FROM edw.dwd_bus_chnl_spmt_lrg_amt_pay_inf_di  --大额单笔支付信息
WHERE dt in ('20120223','20120525','20120612','20120725','20120727','20120811','20120823','20120928','20121011','20121106','20121123','20130123','20130401','20130424')
and thd_pty_deal_sts='PR04'  -----状态为已清算
and ( rcv_act_id='6221410005203337' or pay_act_id='6221410005203337')
;


SELECT *
FROM edw.dwd_bus_chnl_spmt_sml_amt_pay_inf_di  --小额单笔支付信息
WHERE dt in ('20120223','20120525','20120612','20120725','20120727','20120811','20120823','20120928','20121011','20121106','20121123','20130123','20130401','20130424')
and thd_pty_deal_sts='PR04'  -----状态为已清算
and ( rcv_act_id='6221410005203337' or pay_act_id='6221410005203337');

SELECT *
FROM edw.wyhl_ibps_pay_trans_reg  --网银互联支付业务主流水表
WHERE dt in ('20120223','20120525','20120612','20120725','20120727','20120811','20120823','20120928','20121011','20121106','20121123','20130123','20130401','20130424')
and ( payeracctno='6221410005203337' or rcveracctno='6221410005203337')
AND  txsts='PR04'      ----状态为已清算
AND  srflag='1';



SELECT *
FROM edw.dwd_bus_chnl_fr_cbcg_trx_srl_di   --城商行交易流水信息
WHERE dt in ('20120223','20120525','20120612','20120725','20120727','20120811','20120823','20120928','20121011','20121106','20121123','20130123','20130401','20130424')
and ( rcv_act_id='6221410005203337' or pay_act_id='6221410005203337')
AND entr_sts_cd in ('431','111')       ---交易状态为431-已清算,111-入账成功
-- AND bus_typ_cd='A100'                  -- 业务类型A100-普通汇兑
-- AND dbt_crd_act_typ_cd='2'
;








DROP TABLE IF EXISTS tmp_sjxq_wc_SJ2024112251 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_wc_SJ2024112251 AS
SELECT  a.cst_act_id 账号
        ,a.trx_dt 业务办理日期
        ,a.trx_amt 金额
        -- ,a.trx_chnl_cd 我行交易渠道ID
        -- ,cd.cd_val_dscr 我行交易渠道
        ,a.smr_dscr As 摘要描述
        -- ,a.trx_bus_org 我行交易机构id
        -- ,org.org_nm 我行交易机构
        ,'贷' AS 借贷标识
        ,a.cnt_pty_fin_instt_nm As 对方金融机构名称
        ,a.cnt_pty_fin_instt_cd As 对方金融机构代码
        ,a.cnt_pty_fin_instt_typ_cd as 对方金融机构类型代码
FROM    edw.dwd_bus_dep_bal_chg_dtl_di a
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
-- ON      a.trx_bus_org = org.org_id
-- AND     org.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_code_library_dd cd
-- ON      a.trx_chnl_cd = cd.cd_val
-- AND     cd.dt = '@@{yyyyMMdd}'
-- AND     cd.tbl_nm = upper('dwd_bus_dep_bal_chg_dtl_di')
-- AND     cd.fld_nm = upper('trx_chnl_cd')
WHERE   a.dt >= '20120223'
AND     a.dt <= '20130424'
AND     a.trx_dt in('20120223','20120525','20120612','20120725','20120727','20120811','20120823','20120928','20121011','20121106','20121123','20130123','20130401','20130424')
AND     a.cst_act_id = '6221410005203337'
AND     a.crd_and_dbt_ind = 'C'  --转入
and a.cnt_pty_fin_instt_typ_cd<>'13'  --银行内部机构号
;
**01-数据需求_分行_D1125_庞晴芳_信贷业务流失_授信业务授信结清且用信余额为零_且2024年未办过信贷业务的客户清单.sql
-- SJ20241125126，针对2023年12月31日前信贷业务流失（授信业务授信结清且用信余额为零）且2024年未办过信贷业务的客户，开展综合经营。



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xdls_SJ20241125126_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_xdls_SJ20241125126_01 AS
SELECT  A1.cst_id        AS 客户号
       ,A2.cst_nm        AS 姓名
	   ,A1.ln_mgr_id	 AS 信贷归属客户经理
       ,A1.ln_mgr_nm	 AS 信贷归属客户经理名称
	   ,A1.ln_org_id	 AS 信贷归属机构
       ,A1.ln_org_nm	 AS 信贷归属机构名称
       ,A5.tem_org_id	 AS 信贷归属团队
       ,A5.tem_org_nm	 AS 信贷归属团队名称
       ,A5.sbr_org_id	 AS 信贷归属支行
       ,A5.sbr_org_nm	 AS 信贷归属支行名称
	   ,CASE WHEN A4.cst_id IS NOT NULL THEN '是' ELSE '否' END AS 是否办过贷记卡
FROM    adm_pub.adm_csm_cbas_mng_inf_dd A1 --客户集市-客户基础-客户管户信息
LEFT JOIN    (
                 SELECT  T1.cst_id
				         ,T1.cst_nm
                         ,MAX(CASE
                                WHEN ( T1.CTR_STS_CD IN ( '2' , '4' ) AND T1.TMT_DT = '18991231' AND to_date(T1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T1.dt, 'yyyyMMdd') ) OR T1.CTR_BAL > 0 THEN 1
                                ELSE 0
                              END)        AS 是否有未结清合同
                         ,SUM(T1.CTR_BAL) AS 用信余额
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
                 WHERE   T1.DT = '20231231'
                 GROUP BY T1.cst_id,T1.cst_nm
             ) A2
ON      A1.cst_id = A2.cst_id
LEFT JOIN    (
                 SELECT  DISTINCT cst_id
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     ctr_bgn_dt >= '20240101'
             ) A3 --合同基础信息
ON      A1.cst_id = A3.cst_id
LEFT JOIN (SELECT DISTINCT cst_id FROM  edw.dim_bus_crd_cr_crd_inf_dd WHERE DT= '@@{yyyyMMdd}' ) A4  --信用卡卡片信息
ON      A1.cst_id = A4.cst_id
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd A5 --机构树_考核维度
ON     A1.ln_org_id = A5.org_id
AND    A5.DT= '@@{yyyyMMdd}'
WHERE   A1.DT =  '@@{yyyyMMdd}'
AND     A2.用信余额 = 0
AND     A2.是否有未结清合同 = 0
AND     SUBSTR(A1.ln_org_id	, 1, 4) = '3310' --湖州分行
AND     A3.cst_id IS NULL  -- 且2024年未办过信贷业务的客户
;
**01-数据需求_分行_D1125_方安君_杭州分行_江社区东_蓝钱小区综合积分数据.sql
--
-- SJ2024112546

--截止20241125杭州分行营业部中涌江社区东，蓝钱小区所有杭州分行客户
--客户名、客户号、地址、联系方式、管户客户经理、管户团队、可用综合积分。

--字段：客户号	客户姓名	客户所属机构号	客户所属机构名称	客户所属团队机构号	客户所属团队名称名称	客户经理工号	客户经理姓名	当前可用综合积分合计	地址	联系方式


--edw.dwd_cst_mng_cmnt_rel_dd  --客户社区信息
--edw.sirs_pointstransminutes  --积分帐户详细记录表，增量表，综合积分0001，pointsamount--积分金额
--edw.sirs_customers   --客户表，通过customersid关联，取行里客户号hostcustno
--edw.sirs_pointsaccountinfo   --积分账户信息表
--edw.dim_bus_cmpn_pnt_act_inf_dd  --积分账户信息，积分类型pnt_typ_cd=0001，取积分余额



DROP TABLE IF EXISTS TMP_SJXQ_SJ2024112546 PURGE;
CREATE TABLE IF NOT EXISTS TMP_SJXQ_SJ2024112546 AS
SELECT  a.cst_id 客户号
        ,a.cst_nm 客户姓名
        ,a.prm_mgr_id 主管护人工号
        ,a.prm_mgr_nm 主管护人
        ,a.prm_org_id 主管护机构号
        ,a.prm_org_nm 主管护机构
        ,org.sbr_org_id 主管护支行ID
        ,org.sbr_org_nm 主管护支行
        ,org.tem_org_id 主管护团队ID
        ,org.tem_org_nm 主管护团队
        ,pnt.pnt_bal 积分余额
        ,b.reg_adr 户籍地址或注册地
        ,b.cmn_adr 通讯地址
        ,b.wrk_adr 工作单位地址或经营所在地地
        ,b.fml_adr  家庭地址
        ,b.sub_cmnt_id 子社区编号
        ,b.cprh_cmnt_id 综合社区编号
        ,b.cprh_cmnt_plt_id 综合社区板块编号
        ,cmn.sub_cmnt_nm 子社区
        ,cmn.cprh_cmnt_nm 综合社区
        ,cmn.cprh_cmnt_plt_nm 综合社区板块
        ,b.mbl_nbr  联系方式
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd a --客户主管护
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org --机构
ON      a.prm_org_id = org.org_id
AND     org.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_cmpn_pnt_act_inf_dd pnt --积分账户信息
ON      a.cst_id = pnt.cst_id
AND     pnt.dt = '@@{yyyyMMdd}'
AND     pnt.pnt_typ_cd = '0001' --综合积分
INNER JOIN    edw.dws_cst_bas_inf_dd b
ON      a.cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
AND     ( b.reg_adr RLIKE '蓝色钱江'
    OR b.cmn_adr RLIKE '蓝色钱江'
    OR b.wrk_adr RLIKE '蓝色钱江'
    OR b.fml_adr RLIKE '蓝色钱江' )
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd cmn --客户社区信息
ON      b.cst_id = cmn.cst_id
AND     cmn.dt = '@@{yyyyMMdd}'
WHERE   a.dt = '@@{yyyyMMdd}'
AND     a.prm_org_id LIKE '3302%';


--edw.xwdt_xw_community  社区信息表
**01-数据需求_分行_D1126_舟山分行_王荣_舟山分行存量信贷客户_有有效的在途合同_的三匹配数据.sql
-- SJ20241126116

--截止10月末，舟山分行存量信贷客户（有有效的在途合同）的三匹配数据，即客户净资产与我行融资总敞口比、客户近1年销售总额与总的融资敞口比、客户近6个月流水日均与他行经营性融资负债比。

--字段：客户号、客户姓名、管护人工号及姓名、管护部门、支行、客户同一风险控制号、客户同一风险控制号总敞口金额、客户净资产与我行融资总敞口比、客户近1年销售总额与总的融资敞口比、客户近6个月流水日均与他行经营性融资负债比

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zs_clxdkh_SJ20241126116_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zs_clxdkh_SJ20241126116_01 AS
SELECT cb.cst_id             AS 客户号
       ,cb.cst_nm            AS 客户姓名
	   ,T2.ln_mgr_id	     AS 管护人工号
	   ,T2.ln_mgr_nm	 AS 管护人姓名
	   ,T2.ln_org_id	 AS 管护人机构号
	   ,T2.ln_org_nm	 AS 管护人机构
	   ,T3.sbr_org_id	 AS 管护人支行编号
	   ,T3.sbr_org_nm	 AS 管护人支行
       ,sum(cb.ctr_amt)      AS 我行融资总敞口 -- 我行融资总敞口
FROM edw.dim_bus_loan_ctr_bse_inf_dd cb
LEFT JOIN adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户集市-客户基础-客户管户信息
ON    cb.cst_id = T2.cst_id
AND   T2.DT ='20241031'
LEFT JOIN  edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON    T2.ln_org_id = T3.org_id
AND   T3.DT ='20241031'
WHERE cb.dt='20241031'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( cb.CTR_STS_CD IN ( '2' , '4' ) AND     cb.TMT_DT = '18991231' AND to_date(cb.CTR_MTU_DT, 'yyyyMMdd') >= to_date(cb.DT, 'yyyyMMdd') )
                     OR cb.CTR_BAL > 0 )
and T2.ln_org_id like '3312%'   --舟山
GROUP BY  cb.cst_id  ,cb.cst_nm  ,T2.ln_mgr_id  ,T2.ln_mgr_nm   ,T2.ln_org_id ,T2.ln_org_nm	 ,T3.sbr_org_id	  ,T3.sbr_org_nm
;



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zs_clxdkh_SJ20241126116_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zs_clxdkh_SJ20241126116_02 AS
SELECT  CB.客户号
        ,CB.客户姓名
        ,CB.管护人工号
        ,CB.管护人姓名
        ,CB.管护人机构号
        ,CB.管护人机构
        ,CB.管护人支行编号
        ,CB.管护人支行
        ,CB.我行融资总敞口
        ,bi.sam_rsk_ctrl_id                      AS 同一风险控制号
        ,sr.sam_rsk_ctrl_cst_xpos_amt            AS 同一风险控制号下客户贷款敞口金额
        ,T1.net_ast                              AS 客户净资产
        ,T1.net_ast / NULLIF(CB.我行融资总敞口, 0)      AS 客户净资产与我行融资总敞口比
        ,T2.销售开始日期
        ,T2.销售结束日期
        ,T2.销售额
        ,T2.销售额 / NULLIF(CB.我行融资总敞口, 0)          AS 销售总额与我行融资总敞口比
        ,T3.客户近6个月流水日均
        ,T4.他行经营性融资负债
        ,T3.客户近6个月流水日均 / NULLIF(T4.他行经营性融资负债, 0) AS 客户近6个月流水日均与他行经营性融资负债比
FROM    lab_bigdata_dev.tmp_zs_clxdkh_SJ20241126116_01 CB
LEFT JOIN    edw.dws_cst_bas_inf_dd bi
ON      cb.客户号 = bi.cst_id
AND     bi.dt = '20241031'
LEFT JOIN    edw.dws_bus_loan_sam_rsk_ctrl_inf_dd sr --贷款同一风险控制号信息
ON      bi.sam_rsk_ctrl_id = sr.sam_rsk_ctrl_id
AND     sr.dt = '20241031'
LEFT JOIN    edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd T1 --信贷客户资产负债概况
ON      cb.客户号 = T1.cst_id
AND     T1.dt = '20241031'
LEFT JOIN    (
                 SELECT  cst_id
                         ,bgn_dt                                                                                AS 销售开始日期
                         ,end_dt                                                                                AS 销售结束日期
                         ,sal_amt                                                                               AS 销售额
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY last_upd_tm DESC , sys_reg_tm DESC ) AS RN
                 FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd --信贷客户经营信息销售额及净利润信息
                 WHERE   DT = '20241031'
             ) T2
ON      cb.客户号 = T2.cst_id
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  A2.cst_id
                         ,SUM(A1.trx_amt) / DATEDIFF(TO_DATE('20241031', 'YYYYMMDD'), TO_DATE('20240430', 'YYYYMMDD'), 'DD') AS 客户近6个月流水日均
                 FROM    edw.dwd_bus_dep_bal_chg_dtl_di A1  --存款账户余额发生明细
                 INNER JOIN    edw.dws_bus_dep_act_inf_dd A2 --存款账户信息汇总
                 ON      A1.cst_act_id = A2.cst_act_id
                 AND     A1.dep_act_id = A2.dep_act_id
                 AND     A2.DT = '20241031'
                 WHERE   A1.DT > '20240430'
                 GROUP BY A2.cst_id
             ) T3
ON      cb.客户号 = T3.cst_id
LEFT JOIN    (
                 SELECT  B1.cst_id
                         ,SUM(B1.ctr_bal) AS 他行经营性融资负债
                 FROM    (
                             SELECT  A1.dt
                                     ,A1.cst_id
                                     ,A1.ctr_bal --贷款余额
                                     ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
                             FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
                             WHERE   A1.DT = '20241031'
                             AND     A1.cls_dt > A1.DT --关闭日期
                             AND     A1.pd_cd IN ( '41' , '42' , '52' ) --经营性
                             AND     A1.dtrb_org <> 'ZJTLCB' --剔除泰隆
                             and     LENGTH(NVL(A1.cst_id, '')) > 0
                             UNION ALL
                             SELECT  A1.dt
                                     ,A1.cst_id
                                     ,A1.loan_bal  as ctr_bal  --贷款余额
                                     ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
                             FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
                             WHERE   A1.DT = '20241031'
                             AND     A1.cls_dt > A1.DT --关闭日期
                             AND     A1.dtrb_org_typ_cd <> '' --剔除泰隆
                        --       AND     A1.bus_pd_cls_cd IN ( '11' , '12' , '13' , '14' , '15' , '21' , '31' , '41' ) --贷款，贸易融资，保理融资，融资租赁，证券类融资，票据贴现，黄金借贷，垫款
                             and  LENGTH(NVL(A1.cst_id, '')) > 0
                         ) B1
                 WHERE   B1.RN = 1
                 GROUP BY B1.cst_id
             ) T4
ON      cb.客户号 = T4.cst_id
;





-- SJ20241126116
--截止10月末，舟山分行存量信贷客户（有有效的在途合同）的三匹配数据，即客户净资产与我行融资总敞口比、客户近1年销售总额与总的融资敞口比、客户近6个月流水日均与他行经营性融资负债比。
--字段：客户号、客户姓名、管护人工号及姓名、管护部门、支行、客户同一风险控制号、客户同一风险控制号总敞口金额、客户净资产与我行融资总敞口比、客户近1年销售总额与总的融资敞口比、客户近6个月流水日均与他行经营性融资负债比
--他行经营性贷款
-- DROP TABLE IF EXISTS tmp_sjxq_SJ20241126116_01 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241126116_01 AS
-- SELECT  cst_id
--         ,sum(ctr_amt) AS ctr_amt
--         ,sum(ctr_bal) AS ctr_bal
-- FROM    (
--             SELECT  *
--                     ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) rn
--             FROM    edw.dim_cst_ccrc_idv_loan_inf_dd --个人征信客户贷款信息
--             WHERE   dt = '20241031'
--             AND     dtrb_org <> 'ZJTLCB' --发放机构不为泰隆
--             AND     cls_dt >= '@@{yyyyMMdd}' --未关闭
--             AND     LENGTH(NVL(cst_id, '')) > 0
--             AND     pd_cd IN ( '41' , '52' )   --个人经营性贷款,经营性农户贷款
--         ) t
-- WHERE   t.rn = 1
-- UNION ALL
-- SELECT  cst_id
--         ,sum(loan_amt) AS ctr_amt
--         ,sum(loan_bal) AS ctr_bal
-- FROM    (
--             SELECT  cst_id
--                     ,report_id
--                     ,loan_amt
--                     ,loan_bal
--                     ,bus_pd_cls_cd
--                     ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) rn
--             FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
--             WHERE   dt = '20241031'
--             AND     A1.dtrb_org_typ_cd <> '' --排除发放机构为泰隆
--             AND     A1.cls_dt >= '@@{yyyyMMdd}' --未关闭
--             AND     A1.bus_pd_cls_cd IN ( '11' , '12' , '13' , '14' , '15' , '21' , '31' , '41' ) --贷款，贸易融资，保理融资，融资租赁，证券类融资，票据贴现，黄金借贷，垫款
--             AND     LENGTH(NVL(A1.cst_id, '')) > 0
--         ) t
-- WHERE   t.rn = 1;


-- DROP TABLE IF EXISTS tmp_sjxq_SJ20241126116_02 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241126116_02 AS
-- SELECT  cb.cst_id                     AS 客户号
--         ,cb.cst_nm                    AS 客户姓名
--         ,cb.mgr_id                    AS 管护人工号
--         ,hr.empe_nm                   AS 管护人
--         ,cb.mgr_org_id                AS 管护机构号
--         ,org.org_nm                   AS 管护机构
--         ,org.sbr_org_nm               AS 管护支行
--         ,org.tem_org_nm               AS 管护部门
--         ,bi.sam_rsk_ctrl_id           AS 同一风险控制号
--         ,sr.sam_rsk_ctrl_cst_xpos_amt AS 同一风险控制号下客户贷款敞口金额
--         ,sum(cb.ctr_amt)              AS 我行融资总敞口
--         ,max(ass.net_ast)             AS 客户净资产
--         ,max(inc.year_sal_amt)        AS 年销售额
--         ,max(round(dep.amt, 2))       AS 近6个月流水日均
--         ,max(q.ctr_bal)               AS 他行经营性融资负债
-- FROM    edw.dim_bus_loan_ctr_bse_inf_dd cb
-- LEFT JOIN    edw.dws_cst_bas_inf_dd bi
-- ON      cb.cst_id = bi.cst_id
-- AND     bi.dt = '20241031'
-- LEFT JOIN    edw.dws_bus_loan_sam_rsk_ctrl_inf_dd sr --贷款同一风险控制号信息
-- ON      bi.sam_rsk_ctrl_id = sr.sam_rsk_ctrl_id
-- AND     sr.dt = '20241031'
-- LEFT JOIN    (
--                  SELECT  *
--                          ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY rcd_tm DESC ) AS rn
--                  FROM    edw.dwd_bus_loan_svy_fnc_stat_cus_ass_lib_ovew_dd ---资产负债概况,取最新，不用改该表
--                  WHERE   dt = '20241031'
--              ) ass
-- ON      cb.cst_id = ass.cst_id
-- AND     ass.rn = 1
-- LEFT JOIN    (
--                  SELECT  *
--                          ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY sys_reg_tm DESC ) rn
--                  FROM    edw.dwd_bus_loan_svy_cst_indiv_inc_dd --调查报告-个人客户收入详情，取最新
--                  WHERE   dt = '20241031'
--              ) inc
-- ON      cb.cst_id = inc.cst_id
-- AND     inc.rn = 1
-- LEFT JOIN    (
--                  SELECT  cst_id
--                          ,sum(last_180_days_gl_bal_acml) / 180 AS amt --近6个月流水日均
--                  FROM    edw.dws_bus_dep_act_inf_dd
--                  WHERE   dt = '20241031'
--                  GROUP BY cst_id
--              ) dep
-- ON      cb.cst_id = dep.cst_id
-- LEFT JOIN    tmp_sjxq_SJ20241126116_01 q
-- ON      cb.cst_id = q.cst_id
-- LEFT JOIN    edw.dws_hr_empe_inf_dd hr
-- ON      cb.mgr_id = hr.empe_id
-- AND     hr.dt = '20241031'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
-- ON      cb.mgr_org_id = org.org_id
-- AND     org.dt = '20241031'
-- WHERE   cb.dt = '20241031'
-- --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( cb.CTR_STS_CD IN ( '2' , '4' )
-- AND     cb.TMT_DT = '18991231'
-- AND     to_date(cb.CTR_MTU_DT, 'yyyyMMdd') >= to_date(cb.DT, 'yyyyMMdd') )
--     OR cb.CTR_BAL > 0 )
-- AND     cb.mgr_org_id LIKE '3312%'
-- GROUP BY cb.cst_id , cb.cst_nm , cb.mgr_id , hr.empe_nm , cb.mgr_org_id , org.org_nm ,org.sbr_org_nm,org.tem_org_nm   , bi.sam_rsk_ctrl_id , sr.sam_rsk_ctrl_cst_xpos_amt
-- ;
**01-数据需求_分行_D1129_叶倩利_核心系统查询记录.sql
--
-- SJ2024112966
-- 客户卢竟玲（客户号：1006693700）发现客户有风险，准备回收贷款不再续办，为避免客户有过激情形导致我行贷款无法正常偿还，和客户沟通先还款再办理。
--  客户与资金中介调剂资金。联系我行客户经理说系统未生产续办，且原业务合同已冻结，不愿意还款。
--  疑似资金中介知晓我行信贷信息。 现申请查询核心系统内查询过该客户的员工。时间截至2024年11月21日。

--查询痕迹：核心系统内查询过该客户的员工

-- SELECT * FROM tmp_zw_SJ2024112966;

CREATE TABLE IF NOT EXISTS tmp_zw_SJ2024112966 as
select a.weihguiy 维护柜员工号
      ,b.empe_nm 维护柜员姓名
      ,a.weihriqi 维护日期
      ,a.weihshij 维护时间
      ,a.weihjigo 维护机构
      ,a.qudaohao 渠道
      ,a.qnqbwvar 请求报文
      ,a.jiaoyima 交易码
      ,a.waibclma 第三方交易码
      ,a.zhaiyoms 摘要代码
      ,a.zhaiyoms 摘要描述
from edw.core_kapb_jioybw a   -- 交易报文表
left join edw.dws_hr_empe_inf_dd b
on a.weihguiy=b.empe_id
and b.dt='@@{yyyyMMdd}'
where a.dt<='@@{yyyyMMdd}'
-- and a.dt>='20240101'
-- and a.jiaoyirq>='20240101'
and a.jiaoyirq<='@@{yyyyMMdd}'
-- and a.qudaohao='A01' --筛选柜面渠道
and (a.qnqbwvar like '%1006693700%' or a.qnqbwvar like '%33262319690203342X%' or a.qnqbwvar like '%卢竟玲%'
or a.qnqbwvar like '%6221417100041801%' or a.qnqbwvar like '%6221410003681130%'   )  --请求报文varchar2型
-- and a.weihjigo like '3301%' --台州分行
;



-- SELECT concat(doc_nbr,'%') FROM edw.dws_cst_bas_inf_dd WHERE dt='@@{yyyyMMdd}'  and cst_id='1006693700';

-- SELECT cst_id,cst_act_id FROM edw.dws_bus_dep_act_inf_dd WHERE  dt='@@{yyyyMMdd}' and cst_id='1006693700' ;
**01-数据需求_分行_D1202_冯莉莉_台州分行信保贷数据.sql
-- 统计10月份台州分行信保贷数据用于数据分析，与信保公司谈自主保新协议
-- 截止24年10月信贷系统担保函信息选了&ldquo;台州市信保基金融资担保有限责任公司&rdquo;的业务
-- 数据日期	分行机构名称	支行机构编号	支行机构名称	客户号	客户名称	产品名称	营销标签	合同金额	合同余额	执行月利率	合同起始日	业务发放日	合同到期日	发生类型
-- 合作方名称	合作方	担保函金额	担保函起始日	担保函到期日	担保函是否循环	循环贷款方式	是否自助	主要担保方式	管户机构号	管户机构名称	管户客户经理工号	管户客户经理名称
-- 贷款用途代码码值	产品大类	五级分类


SELECT * FROM tmp_sjxq_SJ2024120221

DROP TABLE IF EXISTS tmp_sjxq_SJ2024120221;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024120221 AS
SELECT  DISTINCT t1.dt as 数据日期
                 ,t4.brc_org_nm 分行机构名称
                 ,t4.sbr_org_nm 支行机构名称
                 ,t1.mgr_org_id 管户机构号
                 ,t4.org_nm 管户机构名称
                 ,t1.mgr_id 管户人工号
                 ,t1.ctr_serno as 合同流水号
                 ,t1.cst_id 客户号
                 ,t1.cst_nm 客户名称
                 ,t1.prd_no 产品编号
                 ,t0.pd_nm 产品名称
                 ,t0.lvl1_ctlg_nm 一级产品分类
                 ,t0.lvl2_ctlg_nm 二级产品分类
                 ,t0.lvl3_ctlg_nm 三级产品分类
                 ,t1.ctr_amt 合同金额
                 ,t1.ctr_bal 合同余额
                 ,t1.exec_intr_rat 执行利率
                 ,t1.ctr_bgn_dt 合同起始日期
                 ,t1.ctr_mtu_dt 合同到期日期
                 ,t1.hpn_typ_cd 发生类型代码
                 ,t9.cd_val_dscr 发生类型
                 ,t1.grnt_mod_colc 担保方式合集
                 ,t1.rvlg_typ_cd 循环类型代码
                 ,t5.cd_val_dscr 循环类型
                 ,t1.cpt_usg_cd 资金用途代码
                 ,t6.cd_val_dscr 资金用途
                 ,t1.cur_rsk_ctg_rslt_cd 当前风险分类代码
                 ,t7.cd_val_dscr 当前风险分类
                 ,t2.prtn_no 合作方编号
                 ,t2.prtn_nm 合作方名称
                 ,t2.ltr_grnt_amt 担保函金额
                 ,t2.ltr_grnt_bgn_dt 担保函起始日期
                 ,t2.ltr_grnt_mtu_dt 担保函到期日期
                 ,t2.rvlg_typ 担保函循环类型代码
                 ,t8.cd_val_dscr 担保函循环类型
FROM    edw.dim_bus_loan_ctr_bse_inf_dd t1
INNER JOIN    edw.loan_ctr_rel_grnt t --主合同关联担保合同表
ON      t1.ctr_serno = t.ctr_serno
AND     t.dt = '20241130'
AND     t.GRNT_CTR_TYP = '030' --担保函
INNER JOIN    edw.loan_ctr_ltr_grnt t2 --合同担保函信息
ON      t.GRNT_CTR_NO = t2.LTR_GRNT_NO
AND     t2.dt = '20241130'
LEFT JOIN    edw.dws_hr_empe_inf_dd t3
ON      t1.mgr_id = t3.empe_id
AND     t3.dt = '20241130'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t4
ON      t1.mgr_org_id = t4.org_id
AND     t4.dt = '20241130'
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd t0 -- 新信贷产品码值表
ON      t1.prd_no = t0.prd_no
AND     t0.dt = '20241130'
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T5 -- 循环类型
ON      T5.DT = '20241130'
AND     T5.TBL_NM = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T5.FLD_NM = upper('rvlg_typ_cd')
AND     T1.rvlg_typ_cd = T5.CD_VAL
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T6
ON      T6.DT = '20241130'
AND     T6.TBL_NM = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T6.FLD_NM = upper('cpt_usg_cd')
AND     T1.cpt_usg_cd = T6.CD_VAL
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T7
ON      T7.DT = '20241130'
AND     T7.TBL_NM = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T7.FLD_NM = upper('cur_rsk_ctg_rslt_cd')
AND     T1.cur_rsk_ctg_rslt_cd = T7.CD_VAL
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T8
ON      T8.DT = '20241130'
AND     T8.TBL_NM = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T8.FLD_NM = upper('rvlg_typ_cd')
AND     t2.rvlg_typ = T8.CD_VAL
LEFT JOIN    edw.DWD_CODE_LIBRARY_DD T9
ON      T9.DT = '20241130'
AND     T9.TBL_NM = upper('dim_bus_loan_ctr_bse_inf_dd')
AND     T9.FLD_NM = upper('hpn_typ_cd')
AND     T1.hpn_typ_cd = T9.CD_VAL
WHERE   t1.dt = '20241130'
AND     t2.prtn_nm = '台州市信保基金融资担保有限责任公司';
**01-数据需求_分行_D1203_周方锴_信贷系统查询记录.sql
--信贷查询日志目前数据只更新到20240719，

-- 截至2024年11月30日，客户2601006694杭州必灵网络科技有限公司在信贷系统的查询记录
--查询人工号、名称      查询人所在机构     查询时间     查询原因

-- SELECT * FROM tmp_zfk_SJ2024120281;


--本次只有8笔数据
DROP TABLE IF EXISTS tmp_zfk_SJ2024120281 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2024120281 AS
SELECT  substr(aslp.date_only, 1, 10) 执行时间
        --  ,aslp.request_time  --请求时间
        ,aslp.request_message 请求信息
        ,REGEXP_REPLACE(aslp.request_message,'\\s','')  --替换数据中的逗号和回车，防止导出时excel错行,REGEXP_REPLACE( REPLACE(t3.description, ',', '|'),'\\s','|')
        ,aslp.user_code 用户号
        ,p.empe_nm 用户姓名
        ,aslp.org_id 机构号
        ,q.org_nm 机构名称
FROM    edw.loan_admin_sm_log_provider aslp --服务方交易日志表，增量表
LEFT JOIN    edw.dws_hr_empe_inf_dd p
ON      aslp.user_code = p.empe_id
AND     p.dt = '20241130'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd q
ON      aslp.org_id = q.org_id
AND     q.dt = '20241130'
WHERE   aslp.dt <= '20241130'
AND     aslp.SERVICE_CODE LIKE '/api/w/cst/cmm/corpbsc/detail'
AND     aslp.SERVICE_CODE like '/api/w/cst/cmm/indivbsc/detail'
and     aslp.user_code like '015924%'
-- AND     aslp.REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;2601006694&quot;%';
**01-数据需求_分行_D1205_万喆健_嘉兴分行信保业务全量清单.sql
-- SJ20241203131
-- 嘉兴分行信保业务全量清单
-- 合同到期时间在23年11月30日24年11月30日的业务，一般保证合同中含有&ldquo;嘉兴市融资担保有限公司&rdquo;作为保证人的业务合同号流水号
-- 字段：合同流水号;客户号；客户名称；；合同金额；合同余额；合同起始日；合同到期日；保证人：嘉兴市融资担保有限公司

drop TABLE IF EXISTS tmp_sjxq_wzj_SJ20241203131 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_wzj_SJ20241203131 as
SELECT ctr.ctr_serno as 合同流水号
       ,ctr.cst_id as 客户号
       ,ctr.cst_nm as 客户名称
       ,ctr.ctr_amt as 合同金额
       ,ctr.ctr_bal as 合同余额
       ,ctr.ctr_bgn_dt as 合同起始日
       ,ctr.ctr_mtu_dt as 合同到期日
       ,g.grnt_ctr_no as 担保合同编号
       ,g1.gtor_nm as 保证人
FROM edw.dim_bus_loan_ctr_bse_inf_dd ctr
LEFT JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd  g --主合同、担保合同关系
on ctr.ctr_serno=g.ctr_serno
and g.grnt_ctr_typ_cd='010'   --一般担保
and g.dt='@@{yyyyMMdd}'
left join  edw.dim_bus_loan_grnt_ctr_gtor_inf_dd g1  --担保合同保证人信息
on g.grnt_ctr_no=g1.grnt_ctr_no
and g1.dt='@@{yyyyMMdd}'
WHERE ctr.dt='@@{yyyyMMdd}'
and ctr.mgr_org_id like '3309%'   --嘉兴分行
and ctr.ctr_mtu_dt between '20231130' and '20241130'
and  g1.gtor_nm rlike '嘉兴市融资担保有限公司';

--合同到期时间在23年11月30日25年11月30日的业务，一般保证合同中含有&ldquo;嘉兴市融资担保有限公司&rdquo;作为保证人的业务合同号流水号



drop TABLE IF EXISTS tmp_sjxq_wzj_SJ2024120616 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_wzj_SJ2024120616 as
SELECT ctr.ctr_serno as 合同流水号
       ,ctr.cst_id as 客户号
       ,ctr.cst_nm as 客户名称
       ,ctr.ctr_amt as 合同金额
       ,ctr.ctr_bal as 合同余额
       ,ctr.ctr_bgn_dt as 合同起始日
       ,ctr.ctr_mtu_dt as 合同到期日
       ,g.grnt_ctr_no as 担保合同编号
       ,g1.gtor_nm as 保证人
FROM edw.dim_bus_loan_ctr_bse_inf_dd ctr
LEFT JOIN edw.dwd_bus_loan_ctr_rel_grnt_dd  g --主合同、担保合同关系
on ctr.ctr_serno=g.ctr_serno
and g.grnt_ctr_typ_cd='010'   --一般担保
and g.dt='@@{yyyyMMdd}'
left join  edw.dim_bus_loan_grnt_ctr_gtor_inf_dd g1  --担保合同保证人信息
on g.grnt_ctr_no=g1.grnt_ctr_no
and g1.dt='@@{yyyyMMdd}'
WHERE ctr.dt='@@{yyyyMMdd}'
and ctr.mgr_org_id like '3309%'   --嘉兴分行
and ctr.ctr_mtu_dt between '20231130' and '20251130'
and  g1.gtor_nm rlike '嘉兴市融资担保有限公司';
**01-数据需求_分行_D1205_张依宁_嘉兴分行_全量清单业务对应的预评估和精准贷后.sql
-- SJ20241203171
-- 截止2024年11月30日，嘉兴分行全量清单业务对应的数字化风控相关指标数据。
-- 预评估结果；上诉/抗辩通过触碰刚性规则大类、刚性规则细类、刚性指标内容、原则规则大类、原则规则细类、原则指标内容；
-- 最近一次触碰精准贷后（处置类）时间、（处置类）规则分类、（处置类）规则细类、（处置类）规则名称、（处置类）提示信息



------1.预评估
-- 预评估结果；上诉/抗辩通过触碰刚性规则大类、刚性规则细类、刚性指标内容、原则规则大类、原则规则细类、原则指标内容；


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_JX_SJ20241203171_ypg PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_JX_SJ20241203171_ypg AS
SELECT  DISTINCT A1.COL_1         AS 合同流水号
                 ,A1.COL_2        AS 借据流水号
                 ,A1.COL_3        AS 管户机构号
                 ,A1.COL_4        AS 分行
                 ,A1.COL_5        AS 账户类型
                 ,A1.COL_6        AS 核心客户编号
                 ,A1.COL_7        AS 客户名称
                 ,A1.COL_8        AS 余额
                 ,A1.COL_9        AS 余额_万元
                 ,A2.最近一次预评估结果
                 ,A2.最近一次预评估时间
                 ,CASE
                    WHEN A3.rsk_dgr_cd = '1' THEN '刚性'
                    WHEN A3.rsk_dgr_cd = '2' THEN '原则'
                    WHEN A3.rsk_dgr_cd = '3' THEN '提示'
                  END             AS 风险程度
                 ,A31.cd_val_dscr AS 规则大类
                 ,A32.cd_val_dscr AS 规则细类
                 ,A3.rul_nm       AS 规则名称
                 ,A3.prmpt_msg    AS 提示内容
FROM    lab_bigdata_dev.qbi_file_20241205_09_21_26_0 A1
LEFT JOIN    (
                 SELECT  T1.cst_id                                                                  AS 客户号
                         ,T2.cd_val_dscr                                                            AS 最近一次预评估结果
                         ,T1.last_upd_tm                                                            AS 最近一次预评估时间
                         ,T0.rul_set_rslt_serno --规则集结果流水号
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T1.last_upd_tm ASC ) AS RN
                 FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估业务申请
                 INNER JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
                 ON      T1.pre_ases_serno = T0.pre_ases_serno
                 AND     T0.DT = '20241130'
                 LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
                 ON      T0.rul_set_rslt_cd = T2.cd_val
                 AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD' --授信关联预评估信息表
                 AND     T2.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     T2.DT = '20241130'
                 WHERE   T1.DT = '20241130'
             ) A2
ON      A1.COL_6 = A2.客户号
AND     A2.RN = 1
LEFT JOIN    edw.dwd_bus_loan_pre_ases_rul_dtl_dd A3 --预评估规则明细
ON      A2.rul_set_rslt_serno = A3.rul_set_rslt_serno
AND     A3.rsk_dgr_cd IN ( '1' , '2' ) --刚性,原则
AND     A3.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd A31 -- 码值表
ON      A3.rul_ctg_cd = A31.cd_val
AND     A31.tbl_nm = 'DWD_BUS_LOAN_PRE_ASES_RUL_DTL_DD'
AND     A31.fld_nm = 'RUL_CTG_CD'
AND     A31.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd A32 -- 码值表
ON      A3.rul_sub_clss = A32.cd_val
AND     A32.tbl_nm = 'DWD_BUS_LOAN_PRE_ASES_RUL_DTL_DD'
AND     A32.fld_nm = 'RUL_SUB_CLSS'
AND     A32.DT = '20241130'
WHERE   A1.PT <> '';


------2.精准贷后
-- 最近一次触碰精准贷后（处置类）时间、（处置类）规则分类、（处置类）规则细类、（处置类）规则名称、（处置类）提示信息


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_jzdh PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_jzdh AS
SELECT DISTINCT  A1.COL_1            AS 合同流水号
                 ,A1.COL_2           AS 借据流水号
                 ,A1.COL_3           AS 管户机构号
                 ,A1.COL_4           AS 分行
                 ,A1.COL_5           AS 账户类型
                 ,A1.COL_6           AS 核心客户编号
                 ,A1.COL_7           AS 客户名称
                 ,A1.COL_8           AS 余额
                 ,A1.COL_9           AS 余额_万元
                 ,A2.tsk_gen_dt      AS 最近一次触碰精准贷后处置类时间
                 ,A3.rul_ctg_nm      AS 处置类规则分类
                 ,A3.rul_sub_clss_nm AS 处置类规则细类
                 ,A3.rul_nm          AS 处置类规则名称
                 ,A3.prmpt_msg       AS 处置类提示信息
FROM    lab_bigdata_dev.qbi_file_20241205_09_21_26_0 A1
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,T2.tsk_gen_dt
                         ,T1.btch_serno
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T2.tsk_gen_dt DESC ) AS RN
                 FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
                 INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
                 ON      T1.btch_serno = T2.btch_serno
                 AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
                 AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' ) --01	处置1级, 02	处置2级, 03	预警类, 04	提示类
                 AND     T2.DT = '20241130'
                 WHERE   T1.DT = '20241130'
             ) A2
ON      A1.COL_6 = A2.cst_id
AND     A2.RN = 1
LEFT JOIN    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A3 --任务关联信号明细
ON      A2.btch_serno = A3.btch_serno
AND     A3.DT = '20241130'
WHERE   A1.PT <> '';
**01-数据需求_分行_D1210-台州分行-梁茜雨-9-12月份出险_逾期随贷通卡借据的发放人.sql
-- SJ2024120986
-- 截止最新日期，台州分行9-12月份出险/逾期随贷通卡借据的发放人
-- 随贷通卡借据流水号、合同流水号、是否风险贷款、是否本年新发生、是否逾期、逾期日期、管户人工号、借据发放人工号

--app_ado.adm_subl_bus_loan_fnc_crd_dbil_inf_dd  --实验室应用层资产-随贷通借据信息汇总表,数据只更新到20240715，不全



DROP TABLE IF EXISTS tmp_sjxq_SJ2024120986 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024120986 AS
SELECT  a.ctr_srl_no     AS 合同流水号
        ,a.dbil_srl_no   AS 随贷通卡借据流水号
        ,a.is_rsk_loan   AS 是否风险贷款
        ,a.is_yr_new_hpn AS 是否本年度新发生
        ,CASE
           WHEN ( a.ovd_day > 0 OR a.prcp_ovd_date IS NOT NULL OR a.intr_ovd_date IS NOT NULL ) THEN '是'
           ELSE '否'
         END             AS 是否逾期
        ,a.prcp_ovd_date AS 本金逾期日期
        ,a.intr_ovd_date AS 利息逾期日期
        ,a.mng_empe_id   AS 管户人工号
        ,a.grant_empe_id AS 发放人工号
        ,a.mng_org_id as 管护机构号
        ,a.hpn_rsk_date  AS 出险日期
FROM    adm_rsk.ADM_RSK_APL_INTER_ALL a --风险集市应用表-资产质量日常监测源表
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd b
ON      a.ctr_srl_no = b.ctr_serno
AND     b.dt = '@@{yyyyMMdd}'
WHERE   a.dt = '@@{yyyyMMdd}'
AND     b.prd_no IN ( '2001010101003' , '2001020101003' ) --随贷通（消费）/随贷通（经营）
AND     a.mng_org_id LIKE '3301%' --台州分行
AND     ( a.hpn_rsk_date BETWEEN '20240901' AND '@@{yyyyMMdd}'
    OR a.prcp_ovd_date BETWEEN '20240901' AND '@@{yyyyMMdd}'
    OR a.intr_ovd_date BETWEEN '20240901' AND '@@{yyyyMMdd}' )
ORDER BY a.ctr_srl_no , a.dbil_srl_no
;
**01-数据需求_分行_D1213_嘉兴分行_罗颖_存款账户交易流水明细查询.sql
--SJ2024121251

--客户贾婷婷，客户号1626938197，查询2023年6月6日具体进出账单笔明细
--6214808801017775756
--商户编号8202103230183419
--字段：交易日期，交易金额，对方户名
--只有一条结果

SELECT d.trx_dt as 交易日期
      ,d.trx_amt as  交易金额
      ,d.cnt_pty_act_nm as 对方户名
      ,d.crd_and_dbt_ind as 借贷标识
FROM edw.dwd_bus_dep_bal_chg_dtl_di d
WHERE d.dt='20230605'
and d.cst_act_id='6214808801017775756';




--商户编号 8202103230183419


SELECT * FROM edw.dpss_pbs_order_info ord WHERE ord.dt='20230606' and ord.mer_id='8202103230183419';

SELECT  iac.stlm_date  as 清算日期
        ,iac.in_acct_date as 入账日期
        ,iac.chl_mer_id as 商户编号
        ,iac.pay_txn_acc_no as 支付账户号
        ,iac.pay_txn_acc_na as 支付账户
        ,iac.ecif_client_no as 客户号
        ,iac.txn_amt/100 as 交易金额 -- 交易金额是到分，需要/100
FROM    edw.dpss_bth_mer_in_acc_dtl iac  --商户入账明细表，T+1入账
WHERE   iac.dt = '20230606'
AND     chl_mer_id = '8202103230183419';
**01-数据需求_分行_D1218_台州分行_郑思源_提取全量逾期借款人担保人信息.sql
-- SJ2024121841
-- 提取全量逾期业务相关信息，内部跟踪管理，提高清收效率。
-- 全量逾期业务借款人及担保人、共债人客户编号、证件号码、联系号码及地址（户籍/住宅/经营）信息。
-- 根据提供的合同号，调取全量逾期业务借款人及担保人、共债人客户编号、证件号码、联系号码及地址（户籍/住宅/经营）信息。

-- 字段：合同流水号/卡号	客户名称	借款人客户编号	借款人证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）
-- 担保人1名称	担保人1客户编号	担保人1证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）
-- 担保人2名称	担保人2客户编号	担保人2证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）
-- 担保人3名称	担保人3客户编号	担保人3证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）
-- 担保人4名称	担保人4客户编号	担保人4证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）
-- 担保人5名称	担保人5客户编号	担保人5证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）
-- 共同还款人名称	共同还款人客户编号	共同还款人证件号码	系统联系电话	系统地址（户籍）	系统地址（住宅\经营）


--edw.loan_cst_ctc_addr 联系地址
--edw.loan_cst_ctc_tel cct --联系电话信息
--edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息


--1.插入附件数据
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yqdk_SJ2024121841_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_yqdk_SJ2024121841_01
-- (
    -- 合同流水号_卡号  STRING
    -- ,客户名称        STRING
	-- ,借款人客户编号  STRING
-- ) ;


-- 1.1 地址省市区
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ AS
SELECT  A1.cst_id
        ,A1.dtl_addr
        ,A1.addr_typ
        ,A4.cd_val_dscr AS 省
        ,A3.cd_val_dscr AS 市
        ,A2.cd_val_dscr AS 区
FROM    edw.loan_cst_ctc_addr A1
LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表  区
ON      SUBSTR(A1.adiv, 1, 6) = A2.cd_val
AND     A2.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A2.fld_nm = 'C_HOME_ADDRESS_A'
AND     A2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表   市
ON      RPAD(SUBSTR(A1.adiv, 1, 4), 6, '0') = A3.cd_val
AND     A3.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A3.fld_nm = 'C_HOME_ADDRESS_A'
AND     A3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A4 -- 码值表  省
ON      RPAD(SUBSTR(A1.adiv, 1, 2), 6, '0') = A4.cd_val
AND     A4.tbl_nm = 'TB_STA_COMMUNICATION'
AND     A4.fld_nm = 'C_HOME_ADDRESS_A'
AND     A4.DT = '@@{yyyyMMdd}'
WHERE   A1.del_ind = '0'
AND     A1.DT = '@@{yyyyMMdd}'
AND     A1.addr_typ IN ( '050100' , '050200' , '050900' );





--2.借款人
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yqdk_SJ2024121841_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yqdk_SJ2024121841_02 AS
SELECT
    T1.合同流水号_卡号
   ,T1.客户名称
   ,T1.借款人客户编号
   ,T2.DOC_NBR       AS 证件号码_借款人
   ,T3.ctc_tel       AS 系统联系电话_借款人
   ,T4.dtl_addr	     AS 户籍地址_借款人
   ,T4.省            AS 户籍地址_省
   ,T4.市            AS 户籍地址_市
   ,T4.区            AS 户籍地址_区
   ,T5.dtl_addr	     AS 住宅地址_借款人
   ,T5.省            AS 住宅地址_省
   ,T5.市            AS 住宅地址_市
   ,T5.区            AS 住宅地址_区
   ,T6.dtl_addr	     AS 经营地址_借款人
   ,T6.省            AS 经营地址_省
   ,T6.市            AS 经营地址_市
   ,T6.区            AS 经营地址_区
FROM lab_bigdata_dev.tmp_yqdk_SJ2024121841_01 T1
LEFT JOIN edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON  T1.借款人客户编号  = T2.CST_ID
AND T2.DT = '@@{yyyyMMdd}'
LEFT JOIN (
            SELECT
                 A1.cst_id
				 ,WM_CONCAT('、',A1.ctc_tel) AS ctc_tel   --一个人会有多个联系电话
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.DT = '@@{yyyyMMdd}'
            GROUP BY A1.cst_id
          ) T3
ON  T1.借款人客户编号 = T3.cst_id
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T4 --联系地址信息
ON  T1.借款人客户编号 = T4.cst_id
AND   T4.addr_typ	 = '050100' --户籍
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T5 --联系地址信息
ON  T1.借款人客户编号 = T5.cst_id
AND   T5.addr_typ	 = '050200' --住宅
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T6 --联系地址信息
ON  T1.借款人客户编号 = T6.cst_id
AND   T6.addr_typ	 = '050900' --经营
;



--3.担保人
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 AS
SELECT
   T1.合同流水号_卡号
   ,T2.WRNT_CST_ID      AS 保证人客户编号
   ,T2.WRNT_CST_NM      AS 保证人客户名称
   ,T2.WRNT_DOC_NBR     AS 保证人证件号码
   ,T2.GRNT_PSN_SEQ_NBR AS 担保人序号
   ,T3.ctc_tel          AS 系统联系电话
   ,T4.dtl_addr	        AS 户籍地址
   ,T4.省            AS 户籍地址_省
   ,T4.市            AS 户籍地址_市
   ,T4.区            AS 户籍地址_区
   ,T5.dtl_addr	        AS 住宅地址
   ,T5.省            AS 住宅地址_省
   ,T5.市            AS 住宅地址_市
   ,T5.区            AS 住宅地址_区
   ,T6.dtl_addr	        AS 经营地址
   ,T6.省            AS 经营地址_省
   ,T6.市            AS 经营地址_市
   ,T6.区            AS 经营地址_区
FROM lab_bigdata_dev.tmp_yqdk_SJ2024121841_01 T1
LEFT JOIN edw.dws_bus_grnt_prsn_inf_dd T2 --担保人汇总信息
ON   T1.合同流水号_卡号 = T2.bus_ctr_id
AND  T2.DT = '@@{yyyyMMdd}'
LEFT JOIN (
            SELECT
                 A1.cst_id
				 ,WM_CONCAT('、',A1.ctc_tel) AS ctc_tel
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.DT = '@@{yyyyMMdd}'
            GROUP BY A1.cst_id
          ) T3
ON  T2.WRNT_CST_ID = T3.cst_id
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T4 --联系地址信息
ON  T2.WRNT_CST_ID = T4.cst_id
AND   T4.addr_typ	 = '050100' --户籍
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T5 --联系地址信息
ON  T2.WRNT_CST_ID = T5.cst_id
AND   T5.addr_typ	 = '050200' --住宅
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T6 --联系地址信息
ON  T2.WRNT_CST_ID = T6.cst_id
AND   T6.addr_typ	 = '050900' --经营
;

--4.共同还款人
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yqdk_SJ2024121841_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yqdk_SJ2024121841_04 AS
SELECT
   T1.合同流水号_卡号
   ,T2.cst_id  AS 共同还款人客户编号
   ,T2.cst_nm	   AS 共同还款人名称
   ,T21.DOC_NBR  AS 共同还款人证件号码
   ,T3.ctc_tel       AS 系统联系电话
   ,T4.dtl_addr	     AS 户籍地址
   ,T4.省            AS 户籍地址_省
   ,T4.市            AS 户籍地址_市
   ,T4.区            AS 户籍地址_区
   ,T5.dtl_addr	     AS 住宅地址
   ,T5.省            AS 住宅地址_省
   ,T5.市            AS 住宅地址_市
   ,T5.区            AS 住宅地址_区
   ,T6.dtl_addr	     AS 经营地址
   ,T6.省            AS 经营地址_省
   ,T6.市            AS 经营地址_市
   ,T6.区            AS 经营地址_区
FROM lab_bigdata_dev.tmp_yqdk_SJ2024121841_01 T1
LEFT JOIN edw.dim_bus_loan_ctr_jnt_acptor_dd T2 --合同共同承诺人
ON   T1.合同流水号_卡号 = T2.ctr_serno
AND  T1.借款人客户编号 <> T2.cst_id	 --剔除借款人本人
AND  T2.DT = '@@{yyyyMMdd}'
and T2.sgn_ctr_obj_typ_cd in ('03','04')  --共同还款承诺人/共同借款人
LEFT JOIN edw.dws_cst_bas_inf_dd T21 --客户基础信息汇总表
ON  T2.cst_id  = T21.CST_ID
AND T21.DT = '@@{yyyyMMdd}'
LEFT JOIN (
            SELECT
                 A1.cst_id
				 ,WM_CONCAT('、',A1.ctc_tel) AS ctc_tel
			FROM edw.loan_cst_ctc_tel A1 --联系电话信息
			LEFT JOIN edw.loan_cst_ctc_tel_rel A2 --联系电话关联信息
			ON  A1.cst_id = A2.cst_id
			AND A2.del_ind	 = '0'
            AND  A2.DT = '@@{yyyyMMdd}'
			WHERE A1.del_ind  = '0'
			AND   A2.rel_typ = '0001'  --本人
			AND   A1.DT = '@@{yyyyMMdd}'
            GROUP BY A1.cst_id
          ) T3
ON  T2.cst_id = T3.cst_id
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T4 --联系地址信息
ON  T2.cst_id = T4.cst_id
AND   T4.addr_typ	 = '050100' --户籍
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T5 --联系地址信息
ON  T2.cst_id = T5.cst_id
AND   T5.addr_typ	 = '050200' --住宅
LEFT JOIN lab_bigdata_dev.tmp_yqdk_SJ2024121841_DZ T6 --联系地址信息
ON  T2.cst_id = T6.cst_id
AND   T6.addr_typ	 = '050900' --经营
;


-----------------------------------

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yqdk_SJ2024121841_jgb PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yqdk_SJ2024121841_jgb AS
SELECT  T1.合同流水号_卡号
        ,T1.客户名称
        ,T1.借款人客户编号
        ,T1.证件号码_借款人
        ,T1.系统联系电话_借款人

        ,T1.户籍地址_借款人
        ,T1.户籍地址_省 AS 户籍地址_省_借款人
        ,T1.户籍地址_市	AS 户籍地址_市_借款人
        ,T1.户籍地址_区	AS 户籍地址_区_借款人
        ,T1.住宅地址_借款人
        ,T1.住宅地址_省 AS 住宅地址_省_借款人
        ,T1.住宅地址_市	AS 住宅地址_市_借款人
        ,T1.住宅地址_区	AS 住宅地址_区_借款人
        ,T1.经营地址_借款人
        ,T1.经营地址_省 AS 经营地址_省_借款人
        ,T1.经营地址_市	AS 经营地址_市_借款人
        ,T1.经营地址_区	AS 经营地址_区_借款人

        ,T2.保证人客户编号 AS 客户编号_保证人1
        ,T2.保证人客户名称 AS 客户名称_保证人1
        ,T2.保证人证件号码 AS 证件号码_保证人1
        ,T2.系统联系电话   AS 系统联系电话_保证人1
        ,T2.户籍地址       AS 户籍地址_保证人1
        ,T2.户籍地址_省    AS 户籍地址_省_保证人1
        ,T2.户籍地址_市	   AS 户籍地址_市_保证人1
        ,T2.户籍地址_区	   AS 户籍地址_区_保证人1
        ,T2.住宅地址       AS 住宅地址_保证人1
        ,T2.住宅地址_省    AS 住宅地址_省_保证人1
        ,T2.住宅地址_市	   AS 住宅地址_市_保证人1
        ,T2.住宅地址_区	   AS 住宅地址_区_保证人1
        ,T2.经营地址       AS 经营地址_保证人1
        ,T2.经营地址_省    AS 经营地址_省_保证人1
        ,T2.经营地址_市    AS 经营地址_市_保证人1
        ,T2.经营地址_区	   AS 经营地址_区_保证人1

        ,T3.保证人客户编号 AS 客户编号_保证人2
        ,T3.保证人客户名称 AS 客户名称_保证人2
        ,T3.保证人证件号码 AS 证件号码_保证人2
        ,T3.系统联系电话   AS 系统联系电话_保证人2
        ,T3.户籍地址       AS 户籍地址_保证人2
        ,T3.户籍地址_省    AS 户籍地址_省_保证人2
        ,T3.户籍地址_市	   AS 户籍地址_市_保证人2
        ,T3.户籍地址_区	   AS 户籍地址_区_保证人2
        ,T3.住宅地址       AS 住宅地址_保证人2
        ,T3.住宅地址_省    AS 住宅地址_省_保证人2
        ,T3.住宅地址_市	   AS 住宅地址_市_保证人2
        ,T3.住宅地址_区	   AS 住宅地址_区_保证人2
        ,T3.经营地址       AS 经营地址_保证人2
        ,T3.经营地址_省    AS 经营地址_省_保证人2
        ,T3.经营地址_市    AS 经营地址_市_保证人2
        ,T3.经营地址_区	   AS 经营地址_区_保证人2

        ,T4.保证人客户编号 AS 客户编号_保证人3
        ,T4.保证人客户名称 AS 客户名称_保证人3
        ,T4.保证人证件号码 AS 证件号码_保证人3
        ,T4.系统联系电话   AS 系统联系电话_保证人3
        ,T4.户籍地址       AS 户籍地址_保证人3
        ,T4.户籍地址_省    AS 户籍地址_省_保证人3
        ,T4.户籍地址_市	   AS 户籍地址_市_保证人3
        ,T4.户籍地址_区	   AS 户籍地址_区_保证人3
        ,T4.住宅地址       AS 住宅地址_保证人3
        ,T4.住宅地址_省    AS 住宅地址_省_保证人3
        ,T4.住宅地址_市	   AS 住宅地址_市_保证人3
        ,T4.住宅地址_区	   AS 住宅地址_区_保证人3
        ,T4.经营地址       AS 经营地址_保证人3
        ,T4.经营地址_省    AS 经营地址_省_保证人3
        ,T4.经营地址_市    AS 经营地址_市_保证人3
        ,T4.经营地址_区	   AS 经营地址_区_保证人3

        ,T5.保证人客户编号 AS 客户编号_保证人4
        ,T5.保证人客户名称 AS 客户名称_保证人4
        ,T5.保证人证件号码 AS 证件号码_保证人4
        ,T5.系统联系电话   AS 系统联系电话_保证人4
        ,T5.户籍地址       AS 户籍地址_保证人4
        ,T5.户籍地址_省    AS 户籍地址_省_保证人4
        ,T5.户籍地址_市	   AS 户籍地址_市_保证人4
        ,T5.户籍地址_区	   AS 户籍地址_区_保证人4
        ,T5.住宅地址       AS 住宅地址_保证人4
        ,T5.住宅地址_省    AS 住宅地址_省_保证人4
        ,T5.住宅地址_市	   AS 住宅地址_市_保证人4
        ,T5.住宅地址_区	   AS 住宅地址_区_保证人4
        ,T5.经营地址       AS 经营地址_保证人4
        ,T5.经营地址_省    AS 经营地址_省_保证人4
        ,T5.经营地址_市    AS 经营地址_市_保证人4
        ,T5.经营地址_区	   AS 经营地址_区_保证人4

        ,T6.保证人客户编号 AS 客户编号_保证人5
        ,T6.保证人客户名称 AS 客户名称_保证人5
        ,T6.保证人证件号码 AS 证件号码_保证人5
        ,T6.系统联系电话   AS 系统联系电话_保证人5
        ,T6.户籍地址       AS 户籍地址_保证人5
        ,T6.户籍地址_省    AS 户籍地址_省_保证人5
        ,T6.户籍地址_市	   AS 户籍地址_市_保证人5
        ,T6.户籍地址_区	   AS 户籍地址_区_保证人5
        ,T6.住宅地址       AS 住宅地址_保证人5
        ,T6.住宅地址_省    AS 住宅地址_省_保证人5
        ,T6.住宅地址_市	   AS 住宅地址_市_保证人5
        ,T6.住宅地址_区	   AS 住宅地址_区_保证人5
        ,T6.经营地址       AS 经营地址_保证人5
        ,T6.经营地址_省    AS 经营地址_省_保证人5
        ,T6.经营地址_市    AS 经营地址_市_保证人5
        ,T6.经营地址_区	   AS 经营地址_区_保证人5

        ,T7.共同还款人客户编号 AS 客户编号_共同还款人
        ,T7.共同还款人名称   AS 客户名称_共同还款人
        ,T7.共同还款人证件号码 AS 证件号码_共同还款人
        ,T7.系统联系电话    AS 系统联系电话_共同还款人
        ,T7.户籍地址      AS 户籍地址_共同还款人
        ,T7.户籍地址_省    AS 户籍地址_省_共同还款人
        ,T7.户籍地址_市	   AS 户籍地址_市_共同还款人
        ,T7.户籍地址_区	   AS 户籍地址_区_共同还款人

        ,T7.住宅地址      AS 住宅地址_共同还款人
        ,T7.住宅地址_省    AS 住宅地址_省_共同还款人
        ,T7.住宅地址_市	   AS 住宅地址_市_共同还款人
        ,T7.住宅地址_区	   AS 住宅地址_区_共同还款人
        ,T7.经营地址      AS 经营地址_共同还款人
        ,T7.经营地址_省    AS 经营地址_省_共同还款人
        ,T7.经营地址_市    AS 经营地址_市_共同还款人
        ,T7.经营地址_区	   AS 经营地址_区_共同还款人
FROM    lab_bigdata_dev.tmp_yqdk_SJ2024121841_02 T1
LEFT JOIN    lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 T2
ON      T1.合同流水号_卡号 = T2.合同流水号_卡号
AND     T2.担保人序号 = 1
LEFT JOIN    lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 T3
ON      T1.合同流水号_卡号 = T3.合同流水号_卡号
AND     T3.担保人序号 = 2
LEFT JOIN    lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 T4
ON      T1.合同流水号_卡号 = T4.合同流水号_卡号
AND     T4.担保人序号 = 3
LEFT JOIN    lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 T5
ON      T1.合同流水号_卡号 = T5.合同流水号_卡号
AND     T5.担保人序号 = 4
LEFT JOIN    lab_bigdata_dev.tmp_yqdk_SJ2024121841_03 T6
ON      T1.合同流水号_卡号 = T6.合同流水号_卡号
AND     T6.担保人序号 = 5
LEFT JOIN    lab_bigdata_dev.tmp_yqdk_SJ2024121841_04 T7
ON      T1.合同流水号_卡号 = T7.合同流水号_卡号;
**01-数据需求_分行_D1219_台州分行_成长乐客户营销.sql
-- SJ2024121851，2024.12.17，成长乐客户，代理人名字；
-- 客户号,客户名称,成长乐账户余额,管护机构,管护机构名称,管护客户经理,管护客户经理名称,代理人客户号,代理人客户名称,代理人的存款余额,授信金额,随贷通卡授信金额,
-- 是否持有我行贷记卡,是否持有我行保险,是否购买我行封闭式理财



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_tz_czl_SJ2024121851_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_tz_czl_SJ2024121851_01 AS
SELECT DISTINCT  T1.cst_id      AS 客户号
                 ,T1.act_nm     AS 客户名称
                 ,T1.cst_act_id AS 成长乐账号
                 ,T1.成长乐账户余额
                 ,T3.acs_org_id AS 管护机构
                 ,T4.org_nm     AS 管护机构名称
                 ,T3.mgr_id     AS 管护客户经理
                 ,T5.empe_nm    AS 管护客户经理名称
                 ,T7.cst_id     AS 代理人客户号
                 ,T6.cst_chn_nm AS 代理人客户名称
                 ,T8.dep_bal    AS 存款余额_代理人
                 ,T9.授信金额   AS 授信金额_代理人
                 ,T9.随贷通卡授信金额                                       AS 随贷通卡授信金额_代理人
                 ,CASE WHEN T10.cst_id IS NOT NULL THEN '是' ELSE '否' END  AS 是否持有我行贷记卡
                 ,CASE WHEN T11.cst_id IS NOT NULL THEN '是' ELSE '否' END  AS 是否持有我行保险
                 ,CASE WHEN T12.cls_chm_bal > 0 THEN '是' ELSE '否' END     AS 是否购买我行封闭式理财
FROM    (
           SELECT A1.cst_act_id
                  ,A1.cst_id
				  ,A1.act_nm
                  ,SUM(A1.gl_bal) AS 成长乐账户余额
            FROM edw.dws_bus_dep_act_inf_dd A1
            WHERE A1.act_sts_cd <> 'C'  --剔除销户
			AND   A1.prod_id IN ( '00201020105' , '00201030502' ) --新成长乐，成长乐
			AND   A1.DT = '@@{yyyyMMdd}'
			GROUP BY A1.cst_act_id,A1.cst_id ,A1.act_nm
	    ) T1
LEFT JOIN edw.dwd_bus_dep_agn_bus_trx_reg_inf_dd T2 --代理业务交易登记簿
ON      T1.cst_act_id = T2.cst_act_id
AND     T2.agn_bus_typ = '1' --代理业务类型代码:代理开户
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T3 --客户存款账户管护信息
ON      T1.cst_act_id = T3.cst_act_id
AND     T3.frs_ctc_ind = '1'
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T3.acs_org_id = T4.org_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd T5 --员工汇总信息
ON      T3.mgr_id = T5.empe_id
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_bas_doc_inf_dd T7 --客户证件信息
ON      T2.agn_doc_nbr = T7.doc_nbr
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd T6 --客户基础信息汇总表
ON      T7.cst_id = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd T8 --客户集市-业务信息-客户存款业务信息表
ON      T7.cst_id = T8.cst_id
AND     T8.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.ctr_amt) AS 授信金额
                         ,SUM(CASE WHEN A1.prd_no IN ( '2001010101003' , '2001020101003' ) THEN A1.ctr_amt END)        AS 随贷通卡授信金额
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') )
                           OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T9
ON      T7.cst_id = T9.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id FROM  edw.dim_bus_crd_cr_crd_inf_dd A1 --信用卡卡片信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.card_sts_cd <> 'V' --核销
                 GROUP BY A1.cst_id
             ) T10
ON      T7.cst_id = T10.cst_id
LEFT JOIN    (
                 SELECT  cst_id FROM  edw.dwd_bus_insu_plcy_insu_inf_dd --保险保单投保信息
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     insu_plcy_sts = '0' --正常
                 GROUP BY CST_ID
             ) T11
ON      T7.cst_id = T11.cst_id
LEFT JOIN    adm_pub.adm_csm_cbus_chm_inf_dd T12 --客户集市-业务信息-客户理财业务信息表
ON      T7.cst_id = T12.cst_id
AND     T12.DT = '@@{yyyyMMdd}'
WHERE   T4.brc_org_nm = '台州分行'
;
**01-数据需求_分行_D1220_宁波分行_湛振雄_合同量_类型测算支行综合支持岗编制.sql
--     SJ2024121836
-- 根据合同量、类型测算支行综合支持岗编制（取2024年1月-2024年11月，宁波分行的数据）
-- 一、非信用卡业务数据口径：
-- 1.合同流水号以'BC202401' 至 'BC202411'
-- 2.业务品种剔除&ldquo;e票通-线上承兑单笔&rdquo;&ldquo;e票通-线上秒贴&rdquo;&ldquo;综合授信额度&rdquo;；
-- 3.合同类型剔除空值；
-- 4.&rdquo;泰e贷-经营&ldquo;、&rdquo;泰e贷-享贷&ldquo;业务剔除纯自动审批进件业务（筛选条件及数据表详见sheet2、3）
-- 5.&ldquo;是否员工贷款&rdquo;字段，对合同业务标识为&rdquo;员工车贷&rdquo;、&ldquo;员工消费贷&rdquo;的，标记为是。
-- 二、线下信用卡数据：取线下进件办理的信用卡（即申请渠道为信贷管理系统和PAD信贷工厂发起，无值的字段置空）


-- 4.&rdquo;泰e贷-经营&ldquo;、&rdquo;泰e贷-享贷&ldquo;业务剔除纯自动审批进件业务（筛选条件及数据表详见sheet2、3）
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ted_zdssp240314 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_ted_zdssp240314 AS
-- SELECT  T1.APL_SRL_NBR                AS 进件流水号
--         ,SUBSTR(T1.APL_SRL_NBR, 3, 8) AS 进件日期
--         ,T1.STS_CD                    AS 进件状态
--         ,T1.STRT_ID_FLG               AS 策略标识
--         ,T5.APL_SRL_NBR               AS 申请流水号
--         ,T6.BUSI_CTR_ID               AS 合同流水号
-- FROM    EDW.DWD_BUS_LOAN_ENTR_FORM_DD T1 -- 信贷业务进件单信息，新表DWD_BUS_LOAN_APLY_ACPT_INF_DD --申请受理信息
-- LEFT JOIN    EDW.DWD_BUS_LOAN_REL_APL_INF_DD T5 -- 信贷业务关联申请信息，新表，DWD_BUS_LOAN_APLY_ACPT_REL_FACL_DD  --申请受理与授信表关联关系
-- ON      T1.APL_SRL_NBR = T5.REL_OBJ_ID -- 进件流水号
-- AND     T5.REL_OBJ_TYP = 'EntryForm' -- 关联类型为进件
-- AND     T5.DT = '20230831'
-- LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_INF_DD T6 --信贷合同信息，新表DIM_BUS_LOAN_CTR_BSE_INF_DD
-- ON      T5.APL_SRL_NBR = T6.REL_SERNO -- 申请流水号
-- AND     T6.DT = '20230831'
-- LEFT JOIN    EDW.DWD_BUS_LOAN_APL_REL_DD T7 -- 进件单关联表，表废弃
-- ON      T1.APL_SRL_NBR = T7.XUDAI_LST_SRL_NBR -- 关联 进件流水号
-- AND     T7.OBJ_TYP = 'CusPreLoan' -- 关联类型为 预评估
-- AND     T7.DT = '20230831'
-- LEFT JOIN    EDW.LOAN_CUSTOMER_PREEVALUATE T8 -- 客户预评估申请表 新表 loan_PRE_ASES_BSN --预评估业务
-- ON      T8.SERIALNO = T7.OBJ_ID -- 预评估申请流水号
-- AND     T8.DT = '20230831'
-- WHERE   T1.APL_STYP = '060040' -- 泰e贷2.0工薪  --字段废弃
-- AND     T8.FQZRESULT = 'Accept'
-- AND     T8.ISQDENTRY = '1'  --策略准入结果
-- AND     T1.dt = '20230831'
-- and   T6.BUSI_CTR_ID is not null;

-- -- SELECT  *
-- -- FROM    edw.dim_bus_loan_ctr_inf_dd
-- -- WHERE   dt = '20221008'
-- -- AND     substr(busi_ctr_id, 3, 16) IN ( '2022032900006935' , '2022032900002528' , '2022032900000816' , '2022032800007006' , '2022032800010791' , '2022032800006859' )



-- -- 泰e贷信贷客户准入策略 edw.JCSJ_XSH_TED_XD_CST_ADMT ，准入标志 admt_flg，审批结果类型 appr_rslt_tp，自动审批通过条件：admt_flg='1' and appr_rslt_tp='07'
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ted_zrcl240314 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_ted_zrcl240314 AS
-- SELECT  buss_seq_no 业务流水号
--         ,client_name 客户名称
--         ,client_no 客户号
--         ,event_time 事件发生时间
--         ,pre_eval_seq_no 预评估流水号
--         ,t6.busi_ctr_id 合同流水号
--         ,t.preevaluateresult 预评估结果
-- FROM    (
--             SELECT  buss_seq_no --业务流水号
--                     ,client_name --客户名称
--                     ,client_no --客户号
--                     ,event_time --事件发生时间
--                     ,pre_eval_seq_no --预评估流水号
--                     ,ROW_NUMBER() OVER ( PARTITION BY pre_eval_seq_no ORDER BY event_time ) rn
--             FROM    edw.jcsj_xsh_ted_xd_cst_admt a   --泰e贷信贷客户准入策略
--             LEFT JOIN    edw.dwd_code_library_dd a1 --码值表
--             ON      a.strtgy_flg = substr(a1.cd_val, 2, 1)
--             AND     a1.dt = '20230831'
--             AND     a1.fld_nm = upper('STRT_ID_FLG')
--             AND     a1.tbl_nm = upper('DWD_BUS_LOAN_ENTR_FORM_DD')
--             WHERE   a.dt <= '20230831'
--             and      a.dt >= '20230601'
--             AND     admt_flg = '1'
--             AND     appr_rslt_tp = '07'
--         ) a
-- LEFT JOIN    edw.loan_customer_preevaluate_result t --预评估结果
-- ON      a.pre_eval_seq_no = t.applyserialno --预评估流水号
-- AND     t.dt = '20230831'
-- LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_INF_DD T6 --信贷合同信息
-- ON      t.serialno = T6.pre_apl_srl_nbr -- 申请流水号
-- AND     T6.DT = '20230831'
-- where rn = 1
-- and t6.busi_ctr_id is not null;



-- 字段：申请流水号、合同流水号、客户编号、客户姓名、业务品种、发生类型、合同金额、申请发起渠道、合同签订渠道、合同类型、是否员工贷款、管户机构编号、管户机构名称、管户支行编号、管户支行名称

--结果表1--非信用卡：

SELECT count(1) FROM tmp_nb_SJ2024121836_fxyk;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_nb_SJ2024121836_fxyk PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_nb_SJ2024121836_fxyk AS
SELECT  t1.rel_serno              AS 申请流水号
        ,T1.ctr_serno             AS 合同流水号
        ,T1.cst_id                AS 客户编号
        ,t1.cst_nm                AS 客户名称
        ,NVL(T4.pd_nm, T1.prd_no) AS 业务品种
        ,t1.hpn_typ_cd 发生类型代码
        ,t6.cd_val_dscr 发生类型
        ,T1.ctr_amt               AS 合同金额
        ,T1.ctr_bal               AS 合同余额
        ,B.aply_chnl_cd           AS 申请渠道代码
        ,t5.cd_val_dscr           AS 申请渠道
        ,T8.sgn_ctr_chnl_cd       AS 签约渠道代码
        ,T9.cd_val_dscr           AS 签约渠道
        ,T7.cd_val_dscr           AS 合同类型
        ,CASE
           WHEN T1.bsn_mark_cd = '01' THEN '是'
           ELSE '否'
         END 是否员工贷
        ,T3.org_nm                AS 管户机构名称
        ,T3.org_id                AS 管户机构编号
        ,t3.brc_org_id            AS 管户分行编号
        ,t3.brc_org_nm            AS 管户分行名称
        ,t3.sbr_org_id            AS 管户支行编号
        ,t3.sbr_org_nm            AS 管户支行名称
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN edw.dwd_bus_loan_lmt_aply_biz_dd T2 --用信方案
ON      T1.rel_serno = T2.usc_aply_serno
AND     T1.prd_no  IN ( '2001010101002' , '2001020101002' )	  --泰E贷
AND     T2.BSN_APRV_MOD_CD = '1'  --1 - 机批 2 - 人批
AND     T2.DT = '20241130'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T1.mgr_org_id = T3.org_id
AND     T3.DT = '20241130'
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T4 --产品信息
ON      T1.prd_no = T4.prd_no
AND     T4.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T6 --码值表
ON      t1.hpn_typ_cd = T6.cd_val
AND     T6.fld_nm = 'HPN_TYP_CD'
AND     T6.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     T6.DT = '20241130'
LEFT JOIN    edw.dim_bus_loan_ctr_oth_dtl_inf_dd B --合同其它明细信息
ON      T1.ctr_serno = B.ctr_serno
AND     B.dt = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T5 --码值表
ON      B.aply_chnl_cd = T5.cd_val
AND     T5.fld_nm = 'APLY_CHNL_CD'
AND     T5.tbl_nm = 'DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD'
AND     T5.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T7 --码值表
ON      T1.sgn_ctr_prtfl_mod_cd = T7.cd_val
AND     T7.fld_nm = 'SGN_CTR_PRTFL_MOD_CD'   --对应合同类型
AND     T7.tbl_nm = 'DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD'
AND     T7.DT = '20241130'
LEFT JOIN    edw.dwd_bus_loan_ctr_sgn_tsk_dd T8 --合同签署任务信息
ON      T1.ctr_serno = T8.ctr_serno   --用合同流水号，不用合同编号（对应老业务合同表BUSINESS_CONTRACT的手写合同号）
AND     T8.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T9 --码值表
ON      T8.sgn_ctr_chnl_cd = T9.cd_val
AND     T9.fld_nm = 'SGN_CTR_CHNL_CD'
AND     T9.tbl_nm = 'DWD_BUS_LOAN_CTR_SGN_TSK_DD'
AND     T9.DT = '20241130'
WHERE   T1.DT = '20241130'
AND     substr(T1.ctr_serno, 1, 8) BETWEEN 'BC202401' AND 'BC202411'
AND     T1.prd_no NOT IN ( '1002010101001' , '1002020101002' )--银行承兑汇票承兑、e票通-线上秒贴
AND     T2.usc_aply_serno IS NULL --剔除机批的泰E贷
AND     COALESCE(B.sgn_ctr_prtfl_mod_cd, '') <> ''
-- and T1.busi_ctr_id not in (
-- select DISTINCT 合同流水号 from tmp_ted_zdssp240314 union  select DISTINCT 合同流水号 from tmp_ted_zrcl240314
-- )
AND     t3.brc_org_nm = '宁波分行';



-- 二、线下信用卡数据：取线下进件办理的信用卡（即申请渠道为信贷管理系统和PAD信贷工厂发起，无值的字段置空）
-- B12	信贷工厂（PAD）
-- M01	信贷管理系统

-- 字段：申请流水号、合同流水号、客户编号、客户姓名、业务品种、发生类型、合同金额、申请发起渠道、合同签订渠道、合同类型、是否员工贷款、管户机构编号、管户机构名称、管户支行编号、管户支行名称

SELECT * FROM tmp_nb_SJ2024121836_xyk

--结果表2：信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_nb_SJ2024121836_xyk PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_nb_SJ2024121836_xyk AS
SELECT  T1.cr_crd_act_id    AS 信用卡账号
        ,T1.cr_crd_card_nbr AS 信用卡卡号
        ,T1.busi_apl_id     AS 申请流水号
        ,t1.busi_ctr_id     AS 合同流水号
        ,T1.cst_id          AS 客户编号
        ,t1.cst_nm          AS 客户姓名
        ,T10.cr_crd_pd_cmt  AS 业务品种
        ,t4.hpn_typ_cd      AS 发生类型代码
        ,t6.cd_val_dscr     AS 发生类型
        ,a.ctr_amt          AS 合同金额
        ,a.ctr_bal          AS 合同余额
        ,t4.apl_chnl_cd     AS 申请渠道代码
        ,t5.cd_val_dscr     AS 申请渠道
        ,T8.sgn_ctr_chnl_cd AS 签约渠道代码
        ,T9.cd_val_dscr     AS 签约渠道
        ,T7.cd_val_dscr     AS 合同类型
        ,CASE
           WHEN a.bsn_mark_cd = '01' THEN '是'  --'01-员工贷款02-信贷人员亲属业务03-预保预报业务04-重组业务05-协作业务
           ELSE '否'
         END                AS 是否员工贷
        ,t3.brc_org_id      AS 管户分行编号
        ,t3.brc_org_nm      AS 管户分行名称
        ,t3.sbr_org_id      AS 管户支行编号
        ,t3.sbr_org_nm      AS 管户支行名称
FROM    edw.dim_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息
INNER JOIN    edw.dwd_bus_loan_lmt_aply_biz_dd T4 --用信方案
ON      T1.busi_apl_id = T4.usc_aply_serno
AND     T4.DT = '20241130'
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息
ON      a.ctr_serno = t1.busi_ctr_id
AND     a.dt = '20241130'
LEFT JOIN    edw.dim_bus_loan_ctr_oth_dtl_inf_dd B --合同其它明细信息
ON      a.ctr_serno = B.ctr_serno
AND     B.dt = '20241130'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户管户信息
ON      t1.cst_id = T2.cst_id
AND     T2.DT = '20241130'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.prm_org_id = T3.org_id
AND     T3.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T6 --码值表
ON      t4.hpn_typ_cd = T6.cd_val
AND     T6.fld_nm = 'HPN_TYP_CD'
AND     T6.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_BIZ_DD'
AND     T6.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T5 --码值表
ON      T4.apl_chnl_cd = T5.cd_val
AND     T5.fld_nm = 'APL_CHNL_CD'
AND     T5.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_BIZ_DD'
AND     T5.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T7 --码值表
ON      a.sgn_ctr_prtfl_mod_cd = T7.cd_val
AND     T7.fld_nm = 'SGN_CTR_PRTFL_MOD_CD'
AND     T7.tbl_nm = 'DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD'
AND     T7.DT = '20241130'
LEFT JOIN    edw.dwd_bus_loan_ctr_sgn_tsk_dd T8 --合同签署任务信息
ON      T1.busi_ctr_id = T8.ctr_serno
AND     T8.DT = '20241130'
LEFT JOIN    edw.dwd_code_library_dd T9 --码值表
ON      T8.sgn_ctr_chnl_cd = T9.cd_val
AND     T9.fld_nm = 'SGN_CTR_CHNL_CD'
AND     T9.tbl_nm = 'DWD_BUS_LOAN_CTR_SGN_TSK_DD'
AND     T9.DT = '20241130'
LEFT JOIN    edw.dim_bus_crd_cr_crd_pd_inf_dd T10 --信用卡产品信息
ON      T1.cr_crd_pd_id = T10.cr_crd_pd_id
AND     T10.DT = '20241130'
WHERE   T1.DT = '20241130'
AND     T4.apl_chnl_cd IN ( 'B12' , 'M01' )   --PAD信贷工厂和信贷管理系统
AND     T4.apl_dt >= '20240101'
AND     T4.apl_dt <= '20241130'
AND     t3.brc_org_nm = '宁波分行';
**01-数据需求_分行_D1223_台州分行_黄利铭_部门内信审人员工作量_审查质量.sql
-- SJ2024122356
-- 导出部门副总徐标鸿（000693）、部门信审人员冯伟伟（000890）、冯莉莉（001363）、何安青（002317）、杨钧（002588）、陈园（003940）、
              -- 郑成志（004558）、邓冬华（010898）、黄利铭（014519）、吴晓薇（014895）
-- 24年全年在分行小企业部岗位上审查的全量业务清单。按照一人独立一表，数据包括：申请流水号、客户编号、客户名称、业务类型、产品名称、单笔业务敞口、审批节点下同一风险控制号总敞口。
-- 如新老系统数据无法连续，则导出新系统下数据（尽量导出全年）


-- 数据包括：申请流水号、客户编号、客户名称、业务类型、产品名称、单笔业务敞口、审批节点下同一风险控制号总敞口。


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sp_SJ2024122356_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_sp_SJ2024122356_01 AS
SELECT  A1.usc_aply_serno  AS 申请流水号
        ,A1.cst_id   AS 客户编号
		 ,A1.cst_nm	  AS 客户名称
         ,A1.mgr_id as 经办人ID
         ,emp.empe_nm as 经办人
         ,A1.mgr_org_id as 经办机构号
         ,org.org_nm as 经办机构
		 ,A1.prd_no	 AS  产品编号
		 ,A1.pd_nm	 AS  产品名称
		 ,A1.aply_epsr_amt AS 单笔业务敞口
	     ,SUBSTR(REPLACE(REPLACE(B.end_time	,'-',''),'/',''),1,8)     AS 审批日期
        ,B.user_name    AS 审批人
        ,B.user_id      AS 审批人ID
		 ,B.node_name    AS 审批岗位
FROM    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息
ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
AND     T.cst_id = A1.cst_id
AND     T.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表
ON      t.ahn_ltr_aply_serno = a.biz_id
AND     t.sys_reg_psn_id = a.flow_starter ---- 授信申请登记者 = 流程发起者   不然会有多条记录
AND     a.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表
ON      a.main_instance_id = b.instance_id
AND     b.dt =  '@@{yyyyMMdd}'
left  join edw.dim_hr_org_mng_org_tree_dd org
on A1.mgr_org_id=org.org_id
and org.dt='@@{yyyyMMdd}'
left join edw.dim_hr_empe_bas_inf_dd emp
on A1.mgr_id=emp.empe_id
and emp.dt='@@{yyyyMMdd}'
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     B.user_id IN ('000693','000890','001363','002317','002588','003940','004558','010898','014519','014895' )
AND     SUBSTR(B.end_time,1,4) ='2024'
;

--审批日期_同一风险控制号总敞口
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sp_SJ2024122356_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_sp_SJ2024122356_02 AS
SELECT  T1.sam_rsk_ctrl_id
        ,T0.审批日期
        ,T1.cst_id
        ,SUM(T3.ctr_epsr_amt) AS 同一风险控制号总敞口
FROM    edw.dws_cst_bas_inf_dd T1 --客户基础信息汇总表
INNER JOIN    (
                  SELECT  DISTINCT 客户编号
                                   ,审批日期
                  FROM    lab_bigdata_dev.tmp_sp_SJ2024122356_01
              ) T0
ON      T1.cst_id = T0.客户编号
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.sam_rsk_ctrl_id = T2.sam_rsk_ctrl_id
AND     T2.sam_rsk_ctrl_id <> ''
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T3 --合同基础信息
ON      COALESCE(T2.cst_id, T1.cst_id) = T3.cst_id
AND     ( ( T3.CTR_STS_CD IN ( '2' , '4' ) AND T3.TMT_DT = '18991231' AND to_date(T3.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T3.dt, 'yyyyMMdd') )
       OR T3.CTR_BAL > 0 )
AND     T0.审批日期 = T3.DT
AND     T3.DT IN (
                     SELECT  DISTINCT 审批日期
                     FROM    lab_bigdata_dev.tmp_sp_SJ2024122356_01
                 )
WHERE   T1.DT = '@@{yyyyMMdd}'
GROUP BY T1.sam_rsk_ctrl_id , T0.审批日期 , T1.cst_id;

--结果表

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sp_SJ2024122356_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_sp_SJ2024122356_03 AS
SELECT
   T1.*
   ,T2.同一风险控制号总敞口 AS 审批节点下同一风险控制号总敞口
FROM lab_bigdata_dev.tmp_sp_SJ2024122356_01 T1
LEFT JOIN  lab_bigdata_dev.tmp_sp_SJ2024122356_02 T2
ON  T1.客户编号 = T2.cst_id
AND  T1.审批日期 = T2.审批日期 ;
**01-数据需求_分行_D1225_绍兴分行_何灵杰_信贷系统查询日志.sql
-- SJ2024122401
-- 截止2024年12月23日，越城支行3名客户，栾伟芳（客户号1669381009）、绍兴市越城区宏业食品有限公司（客户号2600226421）、王海涛（客户号：1602896678）
-- 今年以来信贷系统查看查询用户工号、姓名


--老信贷
DROP TABLE IF EXISTS tmp_zfk_SJ2024122401_xxd PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2024122401_xxd  AS
SELECT  T.queryuserid 查询人工号
        ,T1.empe_nm 查询人姓名
        ,T2.org_nm 查询人员所在机构
        ,T.querydate 查询日期
        ,T.querytime 查询时间
        ,CASE
           WHEN T.querytype = '010'              THEN '客户详情查看'
           WHEN T.querytype = '020'              THEN '客户风险提示查询'
           WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
           WHEN T.querytype = '040'              THEN '客户账户查询'
           WHEN T.querytype = '050'              THEN '客户影像查询'
           WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
         END AS 查询类型
        ,T.objectno 查询客户号
        ,T.objectname 查询客户名称
FROM    edw.LOAN_QUERY_LOG T --信贷查询日志   --只更新到20240719
left join edw.dws_hr_empe_inf_dd T1
on T.queryuserid=T1.empe_id
and T1.dt='20240719'
left join edw.dim_hr_org_mng_org_tree_dd T2
on T1.org_id=T2.org_id
and T2.dt='@@{yyyyMMdd}'
WHERE   T.dt = '20240719'
AND     T.objectno in ('1669381009','2600226421','1602896678')
and T.querydate is not null
and T.querydate between '2024/01/01' and '2024/07/19'--今年无查询记录
;


--新信贷
DROP TABLE IF EXISTS tmp_zfk_SJ2024122401_nxd PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2024122401_nxd AS
SELECT  substr(aslp.date_only, 1, 10) 执行时间
        --  ,aslp.request_time  --请求时间
        -- ,aslp.request_message 请求信息
        ,REGEXP_REPLACE(aslp.request_message,'\\s','')  as 请求信息 --替换数据中的逗号和回车，防止导出时excel错行,REGEXP_REPLACE( REPLACE(t3.description, ',', '|'),'\\s','|')
        ,aslp.user_code 用户号
        ,p.empe_nm 用户姓名
        ,aslp.org_id 机构号
        ,q.org_nm 机构名称
FROM    edw.loan_admin_sm_log_provider aslp --服务方交易日志表，增量表
LEFT JOIN    edw.dws_hr_empe_inf_dd p
ON      substr(aslp.user_code,1,6) = p.empe_id
AND     p.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd q
ON      aslp.org_id = q.org_id
AND     q.dt = '@@{yyyyMMdd}'
WHERE   aslp.dt <= '@@{yyyyMMdd}'
AND     aslp.SERVICE_CODE LIKE '/api/w/cst/cmm/corpbsc/detail'
AND    ( aslp.REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;1669381009&quot;%' or aslp.REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;2600226421&quot;%'
or  aslp.REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;1602896678&quot;%')
;
**01-数据需求_分行_SJ2024020256_宁波分行普惠_报送移动支付便民工程月报及季度比对商户信息整改.sql
--用途：报送移动支付便民工程月报及季度比对商户信息整改
--已有字段：商户号、商户全称、法人（店主姓名）、营业执照号、商户状态名称
--需取字段：行内登记商户经营地址、统一社会信用代码证号、根据营业执照号匹配工商登记商户名称、工商登记法人姓名

--edw.nout_gs_label_total_sub，工商查询企业基本信息：客户名称，统一社会信用代码，营业执照上的商户名称，法人姓名
--app_rpt.FCT_THS_MCH_INF_CESHI，泰惠收商户信息表：商户号，商户简称，商户全称，法人（店主姓名），营业执照号，商户状态名称，商户经营地址

--第一种方法，取工商企业-企业基本信息表，edw.outd_gs_entinfo_basic
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.GUANXISHU_ZHISHITUPU_GS_ZHAOMIANXINXI PURGE ;

CREATE TABLE if not EXISTS LAB_BIGDATA_DEV.GUANXISHU_ZHISHITUPU_GS_ZHAOMIANXINXI
(
    GEB_ENTNAME         STRING COMMENT '企业名称'
    ,GEB_CREDITCODE     STRING COMMENT '统一社会信用代码'
    ,GEB_ENTTYPE        STRING COMMENT '企业机构类型'
    ,GEB_FRNAME         STRING COMMENT '法定代表人负责人执行事务合伙人'
    ,GEB_ENTSTATUS      STRING COMMENT '经营状态'
    ,GEB_RECCAP         STRING COMMENT '实收资本万元'
    ,GEB_REGCAPCUR      STRING COMMENT '注册资本币种'
    ,GEB_REGORGCITY     STRING COMMENT '所在城市'
    ,GEB_REGORGDISTRICT STRING COMMENT '所在区县'
    ,GEB_ZSOPSCOPE      STRING COMMENT '经营业务范围'
    ,GEB_DOM            STRING COMMENT '住所'
    ,GEB_INDUSTRYCONAME STRING COMMENT '国民经济代码名称'
    ,ROW_NO             BIGINT
);

INSERT INTO LAB_BIGDATA_DEV.GUANXISHU_ZHISHITUPU_GS_ZHAOMIANXINXI
SELECT  *
FROM    (
            SELECT  GEB_ENTNAME -------企业名称,
                    ,GEB_CREDITCODE -----统一社会信用代码,
                    ,GEB_ENTTYPE -----企业机构类型,
                    ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,
                    ,GEB_ENTSTATUS -----经营状态,
                    ,GEB_RECCAP -----实收资本万元,
                    ,GEB_REGCAPCUR -----注册资本币种,
                    ,GEB_REGORGCITY -----所在城市,
                    ,GEB_REGORGDISTRICT -----所在区县,
                    ,GEB_ZSOPSCOPE -----经营业务范围,
                    ,GEB_DOM -----住所,
                    ,GEB_INDUSTRYCONAME -----国民经济代码名称,
                    ,ROW_NUMBER() OVER ( PARTITION BY GEB_ENTNAME ORDER BY GEB_HOSTSENDTIME DESC ) ROW_NO
            FROM    edw.outd_gs_entinfo_basic
            WHERE   DT <= '@@{yyyyMMdd}'
        ) A
WHERE   ROW_NO = 1;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jhfh_ths0204 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jhfh_ths0204 as
SELECT p.col_1 商户号
       ,p.col_2 商户名称
       ,p.col_3 商户全称
       ,p.col_4 法人_店主姓名
       ,p.col_5 营业执照号
       ,p.col_6 商户状态名称
       ,p1.mch_addr 商户经营地址
       ,NVL(p2.GEB_CREDITCODE,p3.GEB_CREDITCODE) 统一社会信用代码
       ,NVL(p3.GEB_ENTNAME,p2.GEB_ENTNAME) 企业名称
       ,nvl(p2.GEB_FRNAME,p3.GEB_FRNAME) 法定代表人负责人执行事务合伙人
FROM qbi_file_20240204_17_03_54 p
left join app_rpt.FCT_THS_MCH_INF_CESHI p1
ON p.col_1=p1.mch_id
and p1.dt='@@{yyyyMMdd}'
left join LAB_BIGDATA_DEV.GUANXISHU_ZHISHITUPU_GS_ZHAOMIANXINXI p2
ON p.col_5=P2.GEB_CREDITCODE  AND p2.GEB_CREDITCODE IS NOT NULL  --优先用营业执照或统一社会信用匹配
left join LAB_BIGDATA_DEV.GUANXISHU_ZHISHITUPU_GS_ZHAOMIANXINXI p3
ON p.col_3=P3.GEB_ENTNAME AND p3.GEB_ENTNAME IS NOT NULL  --其次用商户全称/企业名称匹配
WHERE p.pt=MAX_PT('lab_bigdata_dev.qbi_file_20240204_17_03_54');

-- SELECT count(*) FROM lab_bigdata_dev.tmp_jhfh_ths0204;

-- -------------------------------------------------------------------------------------------------------

--第二种方法，取工商库底表，edw.nout_gs_label_total_sub
DROP TABLE IF EXISTS LAB_BIGDATA_DEV.gongshangku_0205 PURGE ;

CREATE TABLE if not EXISTS LAB_BIGDATA_DEV.gongshangku_0205  AS
SELECT  D . *
FROM    (
            SELECT  A.entid STRING COMMENT '主体唯一健'
                    ,A.entname STRING COMMENT '企业名称'
                    ,A.enttype STRING COMMENT '企业类型'
                    ,A.socialcreditcode STRING COMMENT '统一社会信用代码'
                    ,A.legalname STRING COMMENT '法人姓名'
                    ,A.entnameold STRING COMMENT'曾用名'
                    ,A.entstatuscode STRING COMMENT '企业状态码值'
                    ,ROW_NUMBER() OVER ( PARTITION BY A.entid ORDER BY A.dt DESC ) RN
            FROM    edw.nout_gs_label_total_sub A --企业标签总表(工商库展业地区铺底数据)
            WHERE   A.DT <= '@@{yyyyMMdd}'
        ) D
WHERE   D.RN = 1;   --取每个企业最新一笔的数据

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jhfh_ths0205 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jhfh_ths0205 as
SELECT p.col_1 商户号
       ,p.col_2 商户名称
       ,p.col_3 商户全称
       ,p.col_4 法人_店主姓名
       ,p.col_5 营业执照号
       ,p.col_6 商户状态名称
       ,p1.mch_addr 商户经营地址
       ,NVL(p2.socialcreditcodeE,p3.socialcreditcodeE) 统一社会信用代码
       ,NVL(p3.entname,p2.entname) 企业名称
       ,nvl(p2.legalname,p3.legalname) 法定代表人负责人执行事务合伙人
FROM qbi_file_20240204_17_03_54 p
left join app_rpt.FCT_THS_MCH_INF_CESHI p1
ON p.col_1=p1.mch_id
and p1.dt='@@{yyyyMMdd}'
--关联工商库底表
left join LAB_BIGDATA_DEV.gongshangku_0205 p2
ON p.col_5=P2.socialcreditcode AND P2.socialcreditcode IS NOT NULL  --优先用营业执照或统一社会信用匹配
left join LAB_BIGDATA_DEV.gongshangku_0205 p3
ON p.col_3=P3.entname AND p3.entname IS NOT NULL  --其次用商户全称/企业名称匹配
WHERE p.pt=MAX_PT('lab_bigdata_dev.qbi_file_20240204_17_03_54');


-- SELECT  GEB_ENTNAME        企业名称
--     ,GEB_CREDITCODE      统一社会信用代码
--     ,GEB_ENTTYPE     企业机构类型
--     ,GEB_FRNAME          法定代表人负责人执行事务合伙人
--     ,GEB_ENTSTATUS      经营状态
--     ,GEB_RECCAP          实收资本万元
--     ,GEB_REGCAPCUR       注册资本币种
--     ,GEB_REGORGCITY      所在城市
--     ,GEB_REGORGDISTRICT  所在区县
--     ,GEB_ZSOPSCOPE       经营业务范围
--     ,GEB_DOM            住所
--     ,GEB_INDUSTRYCONAME 国民经济代码名称
-- FROM edw.outd_gs_entinfo_basic
-- WHERE dt='@@{yyyyMMdd}'
-- AND GEB_CREDITCODE LIKE'91330803%' ;
**01-数据需求_分行_SJ20240219141_杭州分行客户手机号.sql
--截至2月17日，客户电话号码
--edw.dws_cst_bas_inf_dd，客户基础信息信息汇总表，手机号

DROP TABLE IF EXISTS lab_bigdata_dev.hzfhkhdianhua20240220 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.hzfhkhdianhua20240220 AS
SELECT  p1.col_1 客户号
        ,p2.mbl_nbr 电话号码
FROM    LAB_BIGDATA_DEV.qbi_file_20240220_10_35_02 p1
LEFT JOIN    edw.dws_cst_bas_inf_dd p2 --客户基础信息汇总表
ON      p2.cst_id = p1.col_1
AND     p2.dt = '@@{yyyyMMdd}'
WHERE   p1.pt = MAX_PT('LAB_BIGDATA_DEV.qbi_file_20240220_10_35_02');
--wHERE substr(p1.pt,1,8)='${date_dt}'   ;


-- SELECT * FROM lab_bigdata_dev.hzfhkhdianhua20240220

SELECT * FROM LAB_BIGDATA_DEV.qbi_file_20240220_10_35_02 p1 WHERE pt=MAX_PT('qbi_file_20240220_10_35_02')
**01-数据需求_分行_SJ2024022017_湖州分行福卡累计发卡和新发卡量.sql
-------------------------------------------------------------------------------------------
--需求：乡村振兴评估材料中需要截至2023年12月31日的湖州分行&ldquo;福卡&rdquo;的累计发卡量和2023年当年的&ldquo;福卡&rdquo;新发卡量
--字段：
-- 截止23年底 湖州分行 福卡 累计发卡量 当年发卡量
DROP   TABLE IF     EXISTS lab_bigdata_dev.SJXQ_SJ2024022017_CST_01 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.SJXQ_SJ2024022017_CST_01 AS
select b.brc_org_nm 分行层级机构名称
       ,b.sbr_org_id 支行层级机构编号
       ,b.sbr_org_nm 支行层级机构名称
       ,a.ic_crd_prod_id 卡产品号
    ,count(distinct case when a.isu_dt<='20231231' then a.ic_crd_card_nbr
                    end ) 截止23年底累计发卡量_不区分销户
    ,count(distinct case when a.isu_dt between '20230101' and '20231231' then a.ic_crd_card_nbr
                    end ) 截止23年底当年发卡量_不区分销户
from  edw.dim_bus_crd_ic_crd_inf_dd a ---IC卡信息
inner join edw.dim_hr_org_mng_org_tree_dd b  --机构树_考核维度
on a.isu_org=b.org_id   --发卡机构和机构号关联
and b.dt='@@{yyyyMMdd}'
and b.brc_org_nm='湖州分行'
where a.dt='@@{yyyyMMdd}'  ---dw.dim_bus_crd_ic_crd_inf_dd
and a.ic_crd_prod_id in ( '1005' ,'5016','6001' ,'9014' ,'9015' ,'9016' ,'9019' ,'9020' ,'9021' ,'9022' ,'9023' ,'9024' ,'9027' ,'9043' ,'9047' )   --泰隆福卡（1005）的标记
-- and a.isu_org <>''  --发卡机构不为空
group by b.brc_org_nm,b.SBR_ORG_ID,b.SBR_ORG_NM,a.ic_crd_prod_id
;

SELECT sum(截止23年底累计发卡量_不区分销户) 截止23年底累计发卡量_不区分销户
    ,sum(截止23年底当年发卡量_不区分销户)   截止23年底当年发卡量_不区分销户
from lab_bigdata_dev.SJXQ_SJ2024022017_CST_01
;
**01-数据需求_分行_SJ2024022216_温州分行信贷客户及配偶数据.sql
--截至2月22日，温州分行信贷客户数据
--字段：客户号，客户姓名，合同号，授信金额，用信余额，婚姻状况，关联配偶姓名，业务状态（是否冻结）--即冻结状态代码，管户支行，管户客户经理
--条件：合同余额大于0的客户，温州分行
--edw.dim_bus_loan_ctr_inf_dd --信贷合同信息，客户号，客户名称，合同编号，授信金额（合同金额），用信余额（合同余额），业务状态（冻结状态代码|）(1正常 2冻结 3 到期失效 4 终止失效)
--edw.dim_cst_idv_bas_inf_dd  --个人客户基本信息，婚姻状况代码识别婚姻状况，10 未婚 20 已婚 21 初婚 22 再婚 23 复婚 30 丧偶 40 离婚 90 未说明的婚姻状况
--edw.loan_customer_relative --客户关联信息，关联关系：0301 配偶
--edw.dws_cst_bas_inf_dd  --客户基础信息汇总表， 根据关联客户编号识别关联配偶姓名
--adm_pub_app.adm_pblc_cst_prm_mng_inf_dd --客户主管护，管护支行（主管护机构名称），主管护人（管护客户经理）

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wzxdcst20240220 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_wzxdcst20240220 AS
SELECT  p.cst_id 客户号
        ,p.cst_nm 客户姓名
        ,p.busi_ctr_id 业务合同编号  --合同流水号
        --,p.busi_ctr_id 业务合同编号 --业务申请流水号
        --p.crd_ctr_id 授信合同编号
        --,p.crd_tot_lmt 授信总额度
        ,p.ctr_amt 合同金额
        ,p.ctr_bal 合同余额
        ,CASE
           WHEN p.frz_sts_cd = 1 THEN '正常'
           WHEN p.frz_sts_cd = 2 THEN '冻结'
           WHEN p.frz_sts_cd = 3 THEN '到期失效'
           WHEN p.frz_sts_cd = 4 THEN '终止失效'
           ELSE NULL
         END AS 冻结状态
        ,CASE p1.mrg_situ_cd
           WHEN 10 THEN '未婚'
           WHEN 20 THEN '已婚'
           WHEN 21 THEN '初婚'
           WHEN 22 THEN '再婚'
           WHEN 23 THEN '复婚'
           WHEN 30 THEN '丧偶'
           WHEN 40 THEN '离婚'
           ELSE '未说明的婚姻状况'
         END 婚姻状态
        ,p3.cst_chn_nm 配偶姓名
        ,p4.prm_org_nm 主管护机构名称
        ,p4.prm_mgr_nm 主管护人名称
FROM    edw.dim_bus_loan_ctr_inf_dd p --信贷合同信息
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd p1 --个人客户基本信息,取婚姻状况
ON      p1.cst_id = p.cst_id
AND     p1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_customer_relative p2 --信贷的客户关联信息,不用客户关联关系表(edw.dim_cst_rel_inf_dd)
ON      p2.customerid = p.cst_id
AND     p2.dt = '@@{yyyyMMdd}'
AND     p2.relationship = '0301' --关联关系为配偶
LEFT JOIN    edw.dws_cst_bas_inf_dd p3 --客户基础信息汇总
ON      p3.cst_id = p2.relativeid
AND     p3.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd p4 --客户主管护
ON      p4.cst_id = p.cst_id
AND     p4.dt = '@@{yyyyMMdd}'
WHERE   p.DT = '@@{yyyyMMdd}'
AND     P4.prm_org_id LIKE '3305%' --主管护机构为温州分行
GROUP BY p.cst_id , p.cst_nm , p.crd_ctr_id , p.busi_ctr_id , p.ctr_amt , p.ctr_bal , p3.cst_chn_nm , p4.prm_org_nm , p4.prm_mgr_nm , p.frz_sts_cd , p1.mrg_situ_cd
HAVING p.ctr_bal > 0;



SELECT count(*) FROM lab_bigdata_dev.tmp_wzxdcst20240220 where 客户号='1615727685';
**01-数据需求_分行_SJ20240226106_宁波分行_孙莉丽_泰惠收冻结商户数据.sql
--截止2024年2月21日的泰惠收冻结商户数据
--	找出泰惠收商户冻结原因，一方面是宁波人行要求对冻结客户做好管理，若存在执照变更等工商变更的要及时更新信息，另一方面也是为梳理清单联动一线对僵尸客户进行促活营销。
--字段：统计日期、商户号、商户简称、商户状态名称、冻结原因，若冻结原因为商户名称变更，请注明商户最新名称
--edw.dpss_pbs_mcht_busin_mod_record 商户权限修改记录表

---数据导入--
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ths_0301_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_ths_0301_1 AS
SELECT  p1.dt 日期
        ,p0.col_2 商户编号
        ,p0.col_3 商户简称
        ,p0.COL_4 登记的商户状态
        -- ,CASE
        --    WHEN p1.BUSINESS_TYPE = '01' THEN '结算业务'
        --    WHEN p1.BUSINESS_TYPE = '02' THEN '支付业务-微信'
        --    WHEN p1.BUSINESS_TYPE = '03' THEN '支付业务-支付宝'
        --    WHEN p1.BUSINESS_TYPE = '04' THEN '支付业务-手机银行'
        --    WHEN p1.BUSINESS_TYPE = '05' THEN '支付业务-银联'
        --    WHEN p1.BUSINESS_TYPE = '06' THEN '提现业务'
        --    WHEN p1.BUSINESS_TYPE = '07' THEN '信用卡支付'
        --    WHEN p1.BUSINESS_TYPE = '08' THEN '商户中止'
        --    WHEN p1.BUSINESS_TYPE = '09' THEN '商户恢复'
        --    WHEN p1.BUSINESS_TYPE = '10' THEN '商户注销'
        --    WHEN p1.BUSINESS_TYPE = '11' THEN '智慧经营'
        --    WHEN p1.BUSINESS_TYPE = '12' THEN '储值协议'
        --    ELSE ''
        --  END AS 业务类型
        ,CASE
           WHEN p1.BUSINESS_STATE = '00' THEN '已禁用'
           WHEN p1.BUSINESS_STATE = '01' THEN '已开启'
           WHEN p1.BUSINESS_STATE = '02' THEN '中止或冻结'
           WHEN p1.BUSINESS_STATE = '03' THEN '恢复'
           WHEN p1.BUSINESS_STATE = '04' THEN '注销'
           ELSE ''
         END AS 数据库的商户状态
         ,p1.msg 调整原因
FROM    lab_bigdata_dev.qbi_file_20240301_11_08_46 p0
LEFT JOIN    EDW.DPSS_PBS_MCHT_BUSIN_MOD_RECORD p1
ON      p1.mcht_id = p0.col_2
AND     p1.dt = '20240221'
WHERE   p0.pt = MAX_PT('qbi_file_20240301_11_08_46')
GROUP BY p1.dt,p0.col_2,p0.col_3,p0.COL_4,p1.BUSINESS_STATE,p1.msg;

SELECT count(*) FROM  lab_bigdata_dev.tmp_ths_0301_1

select * from lab_bigdata_dev.qbi_file_20240301_11_08_46 p0 WHERE dt=SUBSTR(pt,1,8)
**01-数据需求_分行_SJ20240226131_宁波分行_孙莉丽_泰惠收商户支付信息.sql
--截止2024年2月29日的宁波分行管户的泰惠收商户支付信息
--字段：审核日期、商户号、所属渠道、管护机构、总收单笔数(笔)、总收单金额(元)、银联-借记卡总收单笔数、银联-借记卡总收单金额、银联-贷记卡总收单笔数、银联-贷记卡总收单金额、
--支付宝总收单笔数、支付宝总收单金额、行内登记商户经营地址（需包含省市县/区）
--交易状态：交易成功: &quot;00&quot;;交易成功（已发生退货，已发生撤销）: TXN_STATE_01 = &quot;01&quot;;
-- PAY_PD_TYP 支付账户类型：1  PD1001 微信；  2 PD1003 支付宝  ；3  PD1004  银联二维码 ；4 PD1005 泰隆手机银行 ；5 PD1007 小精灵余额
--TRX_PAY_ACT_TYP_ID  交易支付账户类型编号：3-HB   花呗分期3期；3-CC 信用卡分期  3期
--泰惠收表的数据会延迟1天，T+1

DROP TABLE if EXISTS LAB_BIGDATA_DEV.temp_SJ2024032816 PURGE;

CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.temp_SJ2024032816 AS
SELECT   A.rvw_date 审核日期
        ,A.mch_id 商户号
        ,A.mch_name 商户全称
        ,A.mcht_chl_name 所属渠道
        ,总收单笔数
        ,总收单金额
        ,银联借记卡总收单笔数
        ,银联借记卡总收单金额
        ,银联贷记卡总收单笔数
        ,银联贷记卡总收单金额
        ,支付宝总收单笔数
        ,支付宝总收单金额
        ,A.mch_addr 商户经营地址
FROM    app_rpt.fct_ths_mch_inf_ceshi A     --泰惠收商户信息表
LEFT JOIN    (
                 SELECT  FRS_LVL_MCH_ID
                         ,SUM(CASE
                                WHEN trx_sts = '00' THEN 1
                                ELSE 0
                              END) 总收单笔数
                         ,SUM(CASE
                                WHEN trx_sts = '00' THEN trx_pay_amt
                                ELSE 0
                              END) 总收单金额
                         ,SUM(CASE
                                WHEN trx_sts = '00' AND A.TRX_PAY_ACT_TYP_ID LIKE '%DEBIT%' AND A.PAY_PD_TYP = 'PD1004' THEN 1
                                ELSE 0
                              END) 银联借记卡总收单笔数
                         ,SUM(CASE
                                WHEN trx_sts = '00' AND A.TRX_PAY_ACT_TYP_ID LIKE '%DEBIT%' AND A.PAY_PD_TYP = 'PD1004' THEN trx_pay_amt
                                ELSE 0
                              END) 银联借记卡总收单金额
                         ,SUM(CASE
                                WHEN trx_sts = '00' AND A.TRX_PAY_ACT_TYP_ID LIKE '%CREDIT%' AND A.PAY_PD_TYP = 'PD1004' THEN 1
                                ELSE 0
                              END) 银联贷记卡总收单笔数
                         ,SUM(CASE
                                WHEN trx_sts = '00' AND A.TRX_PAY_ACT_TYP_ID LIKE '%CREDIT%' AND A.PAY_PD_TYP = 'PD1004' THEN trx_pay_amt
                                ELSE 0
                              END) 银联贷记卡总收单金额
                        ,SUM(CASE
                                WHEN trx_sts = '00' AND A.PAY_PD_TYP = 'PD1003' THEN 1
                                ELSE 0
                              END) 支付宝总收单笔数
                        ,SUM(CASE
                                WHEN trx_sts = '00' AND A.PAY_PD_TYP = 'PD1003' THEN trx_pay_amt
                                ELSE 0
                              END) 支付宝总收单金额
                 FROM    edw.dws_bus_chnl_ths_ord_inf_di A   --泰惠收订单信息汇总
                 WHERE   DT <= '20240401'  --泰惠收是T+1更新
                 and dt >='20240302'
                 AND     trx_sts IN ( '00' , '01' )
                 GROUP BY FRS_LVL_MCH_ID
             ) C
ON      A.mch_id = C.FRS_LVL_MCH_ID
WHERE   A.DT = '20240401'
AND A.org_id like '3303%'
ORDER BY A.rvw_date ASC  ;


SELECT * from LAB_BIGDATA_DEV.temp_SJ2024032816
**01-数据需求_分行_SJ2024030551_非金_王文林_泰惠收对账_未入仓.sql
--2月泰惠收商城交易流水数据、商城2月正向订单数据、2月泰惠收退款订单数据，用于泰惠收与商城之间的对账。

-- 明确数据日期，数据范围，以及取数口径等；例如，截止xx日期，xx分行xx数据；


-- 1、2024年2月泰惠收商城交易流水数据

select
ord.TXN_ORDER_ID as 流水号,
ord.txn_dt as 内部交易日期,
ord.TXN_ORDER_AMT as 订单金额,
dtl.TXN_AMT as 清算金额,  --交易金额
dtl.SETL_AMT as 入账金额,  --T+1商户清算金额;T+0垫资平账金额（单位：分）
dtl.SETL_FEE_AMT as 手续费,
ord.TXN_ORDER_AMT-nvl(ord.CARD_HOLDER_ACTV_MCHT_EXP_AMT,0)-nvl(ord.CARD_HOLDER_ACTV_EXP_AMT,0)-nvl(ord.ORDER_GOODS_TAG,0)-nvl(ord.C_PORT_CON_DEDUCTIO_AMT,0) as 客户实付金额,
ord.C_PORT_CON_DEDUCTIO_AMT as 积分抵扣金额,
ord.CARD_HOLDER_ACTV_EXP_AMT as 营销泰隆出资,
ord.CARD_HOLDER_ACTV_MCHT_EXP_AMT as 营销商户出资,
ord.ORDER_GOODS_TAG as 权益卡卷抵扣
from bbsdata.Bth_Mer_In_Acc_Dtl dtl      --对应DG中odps.edw.dpss_bth_mer_in_acc_dtl，商户入账明细表
left join bbsdata.pbs_order_info ord     --edw.dpss_pbs_order_info 支付平台订单信息登记表
on dtl.CHL_TXN_SSN = ord.txn_seq_id
where dtl.chl_mer_id='8202007039000245' and dtl.stlm_date between '20220501' and '20220630'


-- 2、商城2024年2月正向订单数据；
SELECT
      of.id ,
     of.order_id AS &quot;订单号&quot;,
     of.order_main,
     of.child_order_detail,
     of.order_sign AS &quot;订单标签&quot;,
     of.trade_no AS &quot;交易流水号&quot;,
     s.store_name AS &quot;商户名称&quot;,
     of.payTime AS &quot;付款时间&quot;,
     CASE of.mail_type
WHEN 0 THEN
     '在线邮寄'
ELSE
     '自提'
END AS &quot;邮寄方式&quot;,
 of.integral_all AS &quot;订单实付积分&quot;,
 of.totalPrice AS &quot;订单实付现金&quot;,
 of.settle_total_price AS &quot;商户结算价&quot;,
 of.channel AS &quot;渠道&quot;,
 of.parent_order_id,
of.total_coupon_amount,
of.total_coupon_integral
FROM
     sunyardmall_orderform of,
     sunyardmall_store s
WHERE
     of.store_id =  s.id
AND of.payTime > &quot;2023-12-01 00:00:00&quot;
AND of.payTime < &quot;2024-01-01 00:00:00&quot;
AND of.tenant_code=&quot;tlcard&quot;
AND of.payment_mark=&quot;taihuishou&quot;;


-- 3、2024年2月泰惠收退款订单数据

SELECT
     o.order_id AS &quot;订单号&quot;,
o.order_sign AS &quot;订单标签&quot;,
o.trade_no AS &quot;交易流水号&quot;,
     s.store_name AS &quot;商户名称&quot;,
     o.payTime AS &quot;付款时间&quot;,
     CASE o.mail_type
WHEN 0 THEN
     '在线邮寄'
ELSE
     '自提'
END AS &quot;邮寄方式&quot;,
o.integral_all as &quot;订单实付积分&quot;,
o.totalPrice as &quot;订单实付现金&quot;,
     o.settle_total_price as &quot;商户结算价&quot;,
 o.channel AS &quot;渠道&quot;,
l.audit_time as &quot;退款时间&quot;,
l.integral_all AS &quot;退款积分&quot;,
l.goods_all_price AS &quot;退款现金&quot;,
l.refund_order_no
FROM
     sunyardmall_returngoods_log l LEFT JOIN sunyardmall_orderform o on l.return_order_id =  o.id
     LEFT JOIN sunyardmall_store s on  s.id =o.store_id
WHERE
     l.goods_return_status = 11
AND l.audit_time > &quot;2023-12-01 00:00:00&quot;
AND l.audit_time < &quot;2024-01-01 00:00:00&quot;
AND o.tenant_code=&quot;tlcard&quot;
AND o.payment_mark=&quot;taihuishou&quot;;
**01-数据需求_分行_SJ2024030866_嘉兴分行_王洋_无贷企业户外部数据_社区信息.sql
-----------1、取社区信息-------------------------------------------------------------------------------------

--普惠_子社区	小企业_子社区	普惠_综合社区板块  小企业_综合社区板块 	普惠_综合社区	小企业_综合社区  普惠_子社区_主维护人工号	普惠_子社区_主维护人名称

--edw.xwdt_xw_community 社区信息表	 edw.xwdt_xw_com_nearbyent 社区企业信息表

--edw.dwd_cst_mng_cmnt_rel_dd 客户社区信息表（dpd_typ_cd='1' --挂靠类型：1普惠，2小企业）或edw.dim_cst_mng_cmnt_inf_dd社区信息，CMNT_SRC_CD --社区来源代码 1：普惠 2：小企业



DROP TABLE IF EXISTS lab_bigdata_dev.temp_jxph_20240312_01 PURGE;



CREATE TABLE IF NOT EXISTS lab_bigdata_dev.temp_jxph_20240312_01 AS

SELECT  q1.col_1 统一社会信用代码

        ,q1.col_2 表中企业名称

        ,q3.com_code 社区编码

        ,q3.com_name 社区名称

        ,CASE

           WHEN q3.com_state = '1' THEN '潜在'

           WHEN q3.com_state = '2' THEN '正在开发'

           WHEN q3.com_state = '3' THEN '有效'

           WHEN q3.com_state = '4' THEN '关闭'

           ELSE ''

         END AS 社区状态

        ,CASE

           WHEN q3.com_type = '01' THEN '综合社区'

           WHEN q3.com_type = '02' THEN '综合社区版块'

           WHEN q3.com_type = '03' THEN '子社区'

           WHEN q3.com_type = '04' THEN '社区单元'

           WHEN q3.com_type = '05' THEN '虚拟子社区'

           ELSE ''

         END 社区类型

        ,q2.cust_no 客户号

        ,CASE

           WHEN q9.cmnt_src_cd = '1' THEN '普惠'

           WHEN q9.cmnt_src_cd = '2' THEN '小企业'

           ELSE ''

         END AS 挂靠社区类型

        ,CASE

           WHEN q2.custtype = '0' THEN '正式'

           WHEN q2.custtype = '1' THEN '潜在'

           WHEN q2.custtype = '3' THEN '未建档'

           ELSE ''

         END AS 客户状态

        ,q3.com_vindicate_id 主维护人id

        ,q4.empe_nm 主维护人名称

        ,CASE

           WHEN q10.chm_cst_ind = '1' THEN '是'

           WHEN q10.chm_cst_ind = '0' THEN '否'

           ELSE ''

         END AS 是否我行理财客户

        ,q11.vld_pd_cnt 有效产品持有数

        ,q12.aum_bal 客户综合金融资产aum

FROM    lab_bigdata_dev.qbi_file_20240311_17_17_08 q1 --导入的清单信息

LEFT JOIN    edw.xwdt_xw_com_nearbyent q2 --社区企业信息表   --存在部分企业查不到，已同开发确认，要等到4月份更新，后续按天更新此表

ON      q1.col_1 = q2.socialcreditcode

AND     q2.dt = '@@{yyyyMMdd}'

LEFT JOIN    adm_pub.adm_csm_clab_wlth_oth_lab_inf_dd q10 --客户集市-客户标签信息-财富-其它标签信息

ON      q2.cust_no = q10.cst_id

AND     q10.dt = '@@{yyyyMMdd}'

LEFT JOIN    app_ado.adm_subl_cst_bus_inf_dd q11 --实验室应用层资产-客户业务信息汇总表

ON      q2.cust_no = q11.cst_id

AND     q11.dt = '@@{yyyyMMdd}'

LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd q12 -- 客户集市-业务信息-客户金融资产信息表

ON      q2.cust_no = q12.cst_id

AND     q12.dt = '@@{yyyyMMdd}'

LEFT JOIN    edw.xwdt_xw_community q3 --社区信息表

ON      q2.com_id = q3.id

AND     q3.dt = '@@{yyyyMMdd}'

LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd q9 --社区信息，CMNT_SRC_CD --社区来源代码 1：普惠 2：小企业

ON      q3.com_code = q9.cmnt_enc

AND     q9.dt = '@@{yyyyMMdd}'

LEFT JOIN    edw.dim_hr_empe_bas_inf_dd q4 --员工基本信息

ON      q3.com_vindicate_id = q4.empe_id

AND     q4.dt = '@@{yyyyMMdd}'

WHERE   pt = MAX_PT('qbi_file_20240311_17_17_08');





SELECT * fROM edw.xwdt_xw_customer_addr WHERE dt='@@{yyyyMMdd}' and cust_no='2601623400'



---------------------------根据地址匹配社区,取经营地址，注册地址-----------------------------------------------------

DROP TABLE IF EXISTS lab_bigdata_dev.temp_adr_20240320 PURGE;



CREATE TABLE IF NOT EXISTS lab_bigdata_dev.temp_adr_20240320  AS

SELECT  q1.col_1 统一社会信用代码

        ,q1.col_2 表中企业名称

        ,q2.cust_no 客户号

        ,q3.operate_add 经营地址

        ,q3.con_regist_add 注册地址

FROM    lab_bigdata_dev.qbi_file_20240311_17_17_08 q1 --导入的清单信息

LEFT JOIN    edw.xwdt_xw_customer q2 --客户表(正潜灰)

ON      q1.col_1 = q2.open_card_no

AND     q2.dt = '@@{yyyyMMdd}'

LEFT JOIN    edw.xwdt_xw_customer_addr q3 --客户地址信息表(全量表)

ON      q2.cust_no = q3.cust_no

AND     q3.dt = '@@{yyyyMMdd}'

WHERE   pt = MAX_PT('qbi_file_20240311_17_17_08');



SELECT count(*)  FROM lab_bigdata_dev.temp_adr_20240320



SELECT * FROM edw.xwdt_xw_customer q2 WHERE q2.dt='@@{yyyyMMdd}' and q2.open_card_no='91330424MA2CWD5A5W'



-- -----2、取法院及年报数据--------------------------------------------------------------------------------

-- --字段：城镇职工基本养老保险参保人数	企业主体是否失信执行人	欠税名单记录笔数	纳税非正常户笔数	欠款欠费名单笔数	风险信息条数	执行公开信息笔数

-- --edw.nout_fy_query_main 法院精确查询主信息表；edw.dim_cst_out_geb_year_rpt_insu_inf_dd 工商企业年报社会保险信息 （或edw.nout_zs_ent_yearsocsec 工商企业-年报-社会保险信息，增量表）；



-- DROP TABLE IF EXISTS lab_bigdata_dev.fy_0001 PURGE;



-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.fy_0001 AS

-- SELECT  G.统一社会信用代码

--         ,g.企业名称

--         ,G.纳税非正常户数

--         ,g.风险信息条数

--         ,g.欠款欠费名单数

--         ,g.失信老赖名单数

--         ,g.执行公开信息笔数

--         ,h.insu_nbr 城镇职工基本养老保险参保人数

--         ,max(h.qry_tm) 最近查询时间

--         ,MAX(Y.year_rpt_dt) 最近年报日期

-- FROM    (

--             SELECT  f.fqm_ctfno 统一社会信用代码

--                     ,f.fqm_feizhengnum 纳税非正常户数

--                     ,f.fqm_fxmsgnum 风险信息条数

--                     ,f.fqm_namecn 企业名称

--                     ,f.fqm_qiankuannum 欠款欠费名单数

--                     ,f.fqm_shixinnum 失信老赖名单数

--                     ,f.fqm_zhixingnum 执行公开信息笔数

--                     ,ROW_NUMBER() OVER ( PARTITION BY f.fqm_ctfno ORDER BY f.dt DESC ) AS RN2

--             FROM    edw.nout_fy_query_main f

--             WHERE   f.dt <= '@@{yyyyMMdd}'

--         ) G

-- LEFT JOIN    edw.dim_cst_out_geb_year_rpt_insu_inf_dd h --工商企业年报社会保险信息

-- ON      g.统一社会信用代码 = h.csld_crd_cd

-- AND     h.dt = '@@{yyyyMMdd}'

-- ---edw.nout_zs_ent_yearbasic （增量表）工商企业-年报-企业年报基本信息；或edw.dim_cst_out_geb_year_rpt_bas_inf_dd （全量表）工商企业年报基本信息。取最新的年报

-- LEFT JOIN    edw.dim_cst_out_geb_year_rpt_bas_inf_dd Y

-- ON      h.year_rpt_id = Y.year_rpt_id --用年报ID关联

-- AND     y.dt = '@@{yyyyMMdd}'

-- WHERE   g.RN2 = 1

-- GROUP BY G.统一社会信用代码 , g.企业名称 , G.纳税非正常户数 , g.风险信息条数 , g.欠款欠费名单数 , g.失信老赖名单数 , g.执行公开信息笔数 , h.insu_nbr;







-- SELECT * FROM lab_bigdata_dev.fy_0001 WHERE 统一社会信用代码='91330400751172372E'





-- ------------------3、取所有的外部数据：

-- ----工商数据，企业标签总表edw.nout_gs_label_total_sub-----------------------------------------------

-- --1、统一社会信用代码	企业名称	国民经济行业名称	经营范围	成立日期 	注册地址	通讯地址

-- --edw.outd_gs_entinfo_basic 工商企业-企业基本信息,或edw.nout_gs_label_total_sub 企业标签总表

-- --经营范围和社保缴纳人数有变化



-- DROP TABLE if EXISTS lab_bigdata_dev.tem_gs_01;

-- CREATE TABLE if not EXISTS  lab_bigdata_dev.tem_gs_01 AS

-- SELECT  p.统一社会信用代码

--         ,p.企业名称

--         ,p.法人姓名

--         ,p.国民经济行业名称小类

--         ,p.国民经济行业名称大类

--         ,p.注册地址

--         ,p.省份

--         ,p.市

--         ,p.区或县

--         ,p.是否A级纳税人

--         ,p.是否有专利

--         ,CASE

--            WHEN p.latestrecruittime = 'A' THEN '无招聘信息'

--            WHEN p.latestrecruittime = 'B' THEN '6个月内'

--            WHEN p.latestrecruittime = 'C' THEN '6个月-1年'

--            WHEN p.latestrecruittime = 'D' THEN '1年-3年'

--            WHEN p.latestrecruittime = 'E' THEN '3年以上'

--            ELSE ''

--          END AS 最近一次招聘时间

--         ,C.opr_bus_scp 经营范围    --经营范围会变更

--         ,C.found_dt 成立日期

--         ,C.cd_nm 国民经济名称

--         ,C.adr 住址

--         ,D.纳税非正常户数

--         ,D.风险信息条数

--         ,D.欠款欠费名单数

--         ,D.失信老赖名单数

--         ,D.执行公开信息笔数

--         ,D.城镇职工基本养老保险参保人数

-- FROM    (

--             SELECT  t.entid 主体唯一健

--                     ,t.socialcreditcode 统一社会信用代码

--                     ,t.entname 企业名称

--                     ,t.legalname 法人姓名

--                     ,t.industryname 国民经济行业名称小类

--                     ,t.industryphyname 国民经济行业名称大类

--                     ,t.address 注册地址

--                     ,t.provincecode 省份

--                     ,t.citycode 市

--                     ,t.districtname 区或县

--                     ,t.iscontrigradea 是否A级纳税人

--                     ,t.isholdpatent 是否有专利

--                     ,t.latestrecruittime --最近一次招聘时间

--                     ,ROW_NUMBER() OVER ( PARTITION BY t.socialcreditcode ORDER BY t.dt DESC ) rn

--             FROM    edw.nout_gs_label_total_sub t --企业标签总表(工商库展业地区铺底数据)

--             WHERE   t.dt <= '@@{yyyyMMdd}'

--         ) p

-- LEFT JOIN    edw.dim_cst_out_geb_bas_inf_dd C --工商查询企业基本信息

-- ON      p.统一社会信用代码 = C.csld_crd_cd

-- AND     C.csld_crd_cd IS NOT NULL

-- AND     C.dt = '@@{yyyyMMdd}'

-- LEFT JOIN    lab_bigdata_dev.fy_0001 D

-- ON      p.统一社会信用代码 = D.统一社会信用代码

-- AND     D.统一社会信用代码 IS NOT NULL

-- WHERE   p.rn = '1';





-- ----最后，所有字段拼接---

-- DROP TABLE if EXISTS lab_bigdata_dev.jxfenhang_wangyang_20240314;



-- CREATE TABLE if not EXISTS  lab_bigdata_dev.jxfenhang_wangyang_20240314 AS

-- select A.统一社会信用代码

--         ,A.社区企业名称

--         ,A.社区编码

--         ,A.社区名称

--         ,A.社区状态

--         ,concat(A.挂靠社区类型,A.社区类型) as 所属社区类型

--         ,A.客户号

--         ,A.客户状态

--         ,A.主维护人id

--         ,A.主维护人名称

--         ,A.是否我行理财客户

--         ,A.有效产品持有数

--         ,A.客户综合金融资产aum

--         ,B.企业名称

--         ,B.法人姓名

--         -- ,B.国民经济行业名称大类

--         -- ,B.国民经济行业名称小类

--         ,B.注册地址

--         ,B.省份

--         ,B.市

--         ,B.区或县

--         ,B.是否A级纳税人

--         ,B.是否有专利

--         ,B.最近一次招聘时间

--         ,B.经营范围

--         ,B.成立日期

--         ,B.国民经济名称

--         ,B.住址

--         ,B.纳税非正常户数

--         ,B.风险信息条数

--         ,B.欠款欠费名单数

--         ,B.失信老赖名单数

--         ,B.执行公开信息笔数

--         ,B.城镇职工基本养老保险参保人数

-- from lab_bigdata_dev.temp_jxph_20240312_01 A

-- left join lab_bigdata_dev.tem_gs_01 B

-- on a.统一社会信用代码=B.统一社会信用代码



-------------------------***总表：工商，法院，社区***---------------------------------------------------------------------------------------





DROP TABLE IF EXISTS lab_bigdata_dev.temp_jxph_20240312_02 PURGE;



CREATE TABLE IF NOT EXISTS lab_bigdata_dev.temp_jxph_20240312_02 AS

SELECT  t1.统一社会信用代码

        ,t1.表中企业名称

        ,t1.社区编码

        ,t1.社区名称

        ,t1.社区状态

        ,concat(t1.挂靠社区类型, t1.社区类型) AS 所属社区类型

        ,t1.客户号

        ,t1.客户状态

        ,t1.主维护人id

        ,t1.主维护人名称

        ,t1.是否我行理财客户

        ,t1.有效产品持有数

        ,t1.客户综合金融资产aum

        ,t2.col_2 当前企业名称

        ,t2.col_3 经营状态

        ,t2.col_4 国民经济行业名称

        ,t2.col_5 经营范围

        ,substr(t2.col_6, 1, 10) 成立日期

        ,substr(t2.col_7, 1, 4) 参保年份

        ,CAST(t2.col_8 AS INT) 城镇职工基本养老保险参保人数

        ,t2.col_9 注册地址

        ,t2.col_10 通讯地址

        ,t2.col_11 企业类型

        ,substr(t2.col_12, 1, 10) 最近一次开始招聘时间

        ,t2.col_13 纳税等级

        ,t2.col_14 是否有专利

        ,t2.col_15 是否有经营异常

        ,CASE

           WHEN G.失信老赖名单数 > 0 THEN '是'

           ELSE '否'

         END 企业主体是否失信执行人

        ,G.欠税名单数

        ,G.纳税非正常户数

        ,G.欠款欠费名单数

        ,G.风险信息条数

        ,G.执行公开信息笔数

FROM    lab_bigdata_dev.temp_jxph_20240312_01 t1 --原客户列表

LEFT JOIN    lab_bigdata_dev.qbi_file_20240315_17_33_38 t2 --导入的工商数据

ON      t1.统一社会信用代码 = t2.col_1

AND     t2.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240315_17_33_38')

LEFT JOIN    (

                 SELECT  f.fqm_ctfno 统一社会信用代码

                         ,f.fqm_feizhengnum 纳税非正常户数

                         ,f.fqm_fxmsgnum 风险信息条数

                         ,f.fqm_namecn 企业名称

                         ,f.fqm_qiankuannum 欠款欠费名单数

                         ,f.fqm_shixinnum 失信老赖名单数

                         ,f.fqm_zhixingnum 执行公开信息笔数

                         ,f.fqm_qianshuinum 欠税名单数

                         ,ROW_NUMBER() OVER ( PARTITION BY f.fqm_ctfno ORDER BY f.dt DESC ) AS RN2

                 FROM    edw.nout_fy_query_main f --法院精确查询主信息表

                 WHERE   f.dt <= '@@{yyyyMMdd}'

             ) G

ON      G.RN2 = '1'

AND     t1.统一社会信用代码 = G.统一社会信用代码;







select t.org_id,t.org_nm from  edw.dim_hr_org_bas_inf_dd t where t.dt='@@{yyyyMMdd}' AND t.org_id='330902401'



-------------------------***取单独的电话号码---------------------------------------------------------------------------------------



DROP TABLE IF EXISTS lab_bigdata_dev.jxfenhang_wangyang_20240314_02;



CREATE TABLE IF NOT EXISTS lab_bigdata_dev.jxfenhang_wangyang_20240314_02 AS

SELECT  a1.col_1 统代

        ,a1.col_2 企业名称

        ,a2.oth_tel 电话

FROM    lab_bigdata_dev.qbi_file_20240311_17_17_08 a1

LEFT JOIN    edw.dim_cst_out_geb_bas_inf_dd a2  --工商查询企业基本信息

ON      a1.col_1 = a2.csld_crd_cd

AND     a2.dt = '@@{yyyyMMdd}'

WHERE   pt = MAX_PT('qbi_file_20240311_17_17_08');



SELECT COUNT(distinct 统代) FROM lab_bigdata_dev.jxfenhang_wangyang_20240314_02 WHERE  统代 is null
**01-数据需求_分行_SJ2024031566_杭州分行_日落集市手续费调账.sql
--1.附件sheet1中的15个商户2024年1月及2月需返还的手续费
-- 附件sheet2中的16个商户2024年2月需返还的手续费
--2.商户的手续费免费额度计算口径：依据上个月的日均活期存款--1万以下不减免；1万（含）-20万给予商户1倍月日均的免费交易额度；20万（含）以上给予商户1.5倍月日均的免费交易额度。
--需求字段：商户号、商户名称、XX月应收手续费（元）、XX月实收手续费（元）、上月活期存款月日均、当月活期存款月日均、本月交易金额

DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_01 AS
SELECT  t1.data_src
        ,t1.mcht_id
        ,t1.mcht_nm
        ,t1.act_id
        ,t2.ecif_client_no cst_id
        ,t2.mcht_name --商户名称
        ,t2.mcht_simple_name --商户简称
        ,t2.mcht_mng_no --上级商户号
        ,t2.mcht_org_id --机构号
        ,t2.mcht_amr_no --客户经理工号
        ,t2.mcht_amr_name --客户经理姓名
FROM    qbi_file_20240318_13_45_49 t1
LEFT JOIN    edw.dpss_pbs_mcht_base_info t2 --商户基本信息表
ON      t1.mcht_id = t2.MCHT_ID
AND     t2.dt = '@@{yyyyMMdd}'
WHERE   T1.PT = MAX_PT('qbi_file_20240318_13_45_49')
;

DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_02 AS
SELECT  t1.dt
        ,t1.cst_id
        ,t1.dmnd_dep_bal_mon_avg --活期存款余额月日均
FROM    adm_pub.adm_csm_cbus_dep_inf_dd t1 --客户集市-业务信息-客户存款业务信息表
INNER JOIN    SJXQ_SJ2024031566_CST_01 t2
ON      t1.cst_id = t2.cst_id
WHERE   t1.dt IN ( '20231231' , '20240131' )
;

DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_03 AS
select t1.mcht_id
    ,t2.txn_seq_id                               --内部流水号
	,t2.txn_sub_type                             --交易子类型：010001:普通支付;010002:担保支付;010003:快捷支付（接口类）;030001:交易状态查询(支持：支付、退货等);040001:退货交易;051001：普通代收交易;030501：普通代收交易;
	,t2.txn_order_id                             --订单号(外部系统流水号)
    ,t2.txn_dt
    ,t2.dt
	-- ,t2.txn_amt                                  --交易支付金额(包含：消费、退货、撤销,交易单位为分，例:1.23元=123)
    ,CASE WHEN sign(nvl(t2.TXN_AMT,0) - 100) = -1 THEN nvl(t2.TXN_AMT, 0) / 100
        ELSE t2.TXN_AMT / 100 END           TXN_AMT
    ,CASE WHEN sign(nvl(t3.FEE_IN_AMT, 0) - 100) = - 1 THEN nvl(t3.FEE_IN_AMT, 0) / 100
        ELSE t3.FEE_IN_AMT / 100 END        shod_handfee   --手续费收入金额（单位：分）
    ,case when sign(nvl(( t3.SETL_FEE_AMT ), 0) - 100) = - 1 THEN nvl(( t3.SETL_FEE_AMT ), 0) / 100
        ELSE ( t3.SETL_FEE_AMT ) / 100 END  real_handfee    --商户手续费（单位：分）
FROM SJXQ_SJ2024031566_CST_01           t1
INNER join edw.dpss_pbs_order_info      t2  --支付平台订单信息登记表
on  t1.mcht_id=t2.MER_ID
and t2.dt>='20240101' and t2.dt <='20240229'
AND t2.TXN_SUB_TYPE IN ('100601','100603','100604','100701','100702','100704','100800'
    ,'101000','110603','110702','110704','100411','100412','100413','100414','100417'
    ,'100419','100423','100499','201003','201002','201001','201007' )
LEFT JOIN edw.dpss_bth_mer_in_acc_dtl   t3  --商户入账明细表
ON  t2.TXN_SEQ_ID = t3.CHL_TXN_SSN   --内部流水号=渠道交易流水号
AND t3.dt = t2.dt
;

DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_04 AS
SELECT  substr(txn_dt, 1, 6) mons
        ,mcht_id
        ,round(sum(TXN_AMT), 2) TXN_AMT --交易金额
        ,round(sum(shod_handfee), 2) shod_handfee --应收手续费
        ,round(sum(real_handfee), 2) real_handfee --实收手续费
FROM    SJXQ_SJ2024031566_CST_03
GROUP BY mons , mcht_id
;

--sheet1
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_05 AS
SELECT  t1.mcht_id 商户号
        ,t1.mcht_nm 商户名称
        ,t1.act_id 账号
        ,t1.dmnd_dep_bal_mon_avg 12月月日均_活期
        ,t1.TXN_AMT 1月交易金额
        ,t1.shod_handfee 1月应收手续费
        ,t1.real_handfee 1月实收手续费
        ,t2.dmnd_dep_bal_mon_avg 1月月日均_活期
        ,t2.TXN_AMT 2月交易金额
        ,t2.shod_handfee 2月应收手续费
        ,t2.real_handfee 2月实收手续费
FROM    (
            SELECT  t1.mcht_id
                    ,t1.mcht_nm
                    ,t1.act_id
                    ,t2.dmnd_dep_bal_mon_avg
                    ,t4.TXN_AMT
                    ,t4.shod_handfee
                    ,t4.real_handfee
            FROM    SJXQ_SJ2024031566_CST_01 t1
            LEFT JOIN    SJXQ_SJ2024031566_CST_02 t2
            ON      t1.cst_id = t2.cst_id
            AND     t2.dt = '20231231'
            LEFT JOIN    SJXQ_SJ2024031566_CST_04 t4
            ON      t1.mcht_id = t4.mcht_id
            AND     t4.mons = '202401'
            WHERE   t1.data_src = 'sheet1'
        ) t1
LEFT JOIN    (
                 SELECT  t1.mcht_id
                         ,t2.dmnd_dep_bal_mon_avg
                         ,t4.TXN_AMT
                         ,t4.shod_handfee
                         ,t4.real_handfee
                 FROM    SJXQ_SJ2024031566_CST_01 t1
                 LEFT JOIN    SJXQ_SJ2024031566_CST_02 t2
                 ON      t1.cst_id = t2.cst_id
                 AND     t2.dt = '20240131'
                 LEFT JOIN    SJXQ_SJ2024031566_CST_04 t4
                 ON      t1.mcht_id = t4.mcht_id
                 AND     t4.mons = '202402'
                 WHERE   t1.data_src = 'sheet1'
             ) t2
ON      t1.mcht_id = t2.mcht_id;


--sheet2
DROP   TABLE IF     EXISTS SJXQ_SJ2024031566_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024031566_CST_06 AS
SELECT  t1.mcht_id 商户号
        ,t1.mcht_nm 商户名称
        ,t1.act_id 账号
        ,t2.dmnd_dep_bal_mon_avg 1月月日均_活期
        ,t4.TXN_AMT 2月交易金额
        ,t4.shod_handfee 2月应收手续费
        ,t4.real_handfee 2月实收手续费
FROM    SJXQ_SJ2024031566_CST_01 t1
LEFT JOIN    SJXQ_SJ2024031566_CST_02 t2
ON      t1.cst_id = t2.cst_id
AND     t2.dt = '20240131'
LEFT JOIN    SJXQ_SJ2024031566_CST_04 t4
ON      t1.mcht_id = t4.mcht_id
AND     t4.mons = '202402'
WHERE   t1.data_src = 'sheet2';

SELECT * from  SJXQ_SJ2024031566_CST_06

SElECT '01' seq, count(1) cnt, count(distinct mcht_id) custs
from SJXQ_SJ2024031566_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct dt,cst_id) custs
from SJXQ_SJ2024031566_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct mcht_id,txn_dt) custs
from SJXQ_SJ2024031566_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct mons,mcht_id) custs
from SJXQ_SJ2024031566_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct 商户号) custs
from SJXQ_SJ2024031566_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 商户号) custs
from SJXQ_SJ2024031566_CST_06
;

/*
01	31	31
02	62	62
03	12526	762
04	57	57
05	15	15
06	16	16
*/
**01-数据需求_分行_SJ2024040381_宁波分行_孙莉丽_商户信息比对.sql
--用于报送收单商户季度报表给宁波人行（数据需求在本月7日前）。
--因早期收单商户数据质量不佳，部分商户执照号码登记错误，同时有部分商户营业执照名称、法人变更或销户后未及时在我行系统进行变更或销户，导致系统导出的数据不准确，故需要与外部工商信息进行比对。

--已有字段：银联通道商户号	审核日期	商户状态	商户号	商户全称	我行系统登记执照号码	我行系统登记法人姓名

--app_rpt.FCT_THS_MCH_INF_CESHI，泰惠收商户信息表：商户号，商户简称，商户全称，法人（店主姓名），营业执照号，商户状态名称，商户经营地址
--edw.nout_gs_label_total_sub 企业标签总表：法人，企业名称，营业执照号码

DROP TABLE IF EXISTS LAB_BIGDATA_DEV.gongshangku_0205 PURGE;

CREATE TABLE IF NOT EXISTS LAB_BIGDATA_DEV.gongshangku_0205 AS
SELECT  D . *
FROM    (
            SELECT  A.entname
                    ,A.enttype
                    ,A.socialcreditcode
                    ,A.legalname
                    ,A.entnameold
                    ,A.entstatuscode
                    ,ROW_NUMBER() OVER ( PARTITION BY A.entid ORDER BY A.dt DESC ) RN
            FROM    edw.nout_gs_label_total_sub A --企业标签总表(工商库展业地区铺底数据)
            WHERE   A.DT <= '@@{yyyyMMdd}'
        ) D
WHERE   D.RN = 1;

--补充字段：外部工商数据-根据商户名称匹配证照号码/外部工商数据-根据证照号码匹配商户名称/外部工商数据-根据商户名称匹配法人姓名/外部工商数据-根据证照号码匹配法人姓名
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jhfh_ths0205 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jhfh_ths0205 AS
SELECT  p.col_1 银联通道商户号
        ,p.col_2 审核日期
        ,p.col_3 商户状态
        ,p.col_4 核心客户号
        ,p.col_5 商户号
        ,p.col_6 商户全称
        ,p.col_7 我行系统登记执照号码
        ,p.col_8 我行系统登记法人姓名
        ,NVL(p2.socialcreditcode, p3.socialcreditcode) 统一社会信用代码 --根据营业执照或统代匹配
        ,NVL(p3.entname, p2.entname) 企业名称 --根据商户全称
        ,NVL(p2.legalname, p3.legalname) 法人姓名
FROM    qbi_file_20240407_16_38_53 p --业务提供的商户清单
LEFT JOIN    LAB_BIGDATA_DEV.gongshangku_0205 p2
ON      p.col_7 = P2.socialcreditcode --优先用营业执照或统一社会信用匹配
AND     P2.socialcreditcode IS NOT NULL
AND     p.col_7 IS NOT NULL
AND     p.col_7 <> ''
LEFT JOIN    LAB_BIGDATA_DEV.gongshangku_0205 p3
ON      p.col_6 = P3.entname --其次用商户全称/企业名称匹配
AND     p3.entname IS NOT NULL
AND     p.col_6 IS NOT NULL
AND     p.col_6 <> ''
WHERE   p.pt = MAX_PT('qbi_file_20240407_16_38_53');
;









-- ---------S1-查询企业基本信息，获取最新---------------------------------------------------------------------------------------

-- DROP TABLE IF EXISTS lab_bigdata_dev.gongshangku0407 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gongshangku0407 AS
-- SELECT  A . *
-- FROM    (
--             SELECT  t.dt_entname
--                     ,t.dt_creditcode
--                     ,t.otdt_query_no     ---客户号，不是通常意义上的客户号，一长串的字符串
--                     ,t.dt_frname
--                     ,ROW_NUMBER() OVER ( PARTITION BY t.dt_creditcode ORDER BY t.dt DESC ) rn
--             FROM    edw.nout_zs_ent_basic t --企业基本信息表
--             WHERE   t.dt <= '@@{yyyyMMdd}'
--         ) A
-- WHERE   A.rn = 1;

-- SELECT * from lab_bigdata_dev.gongshangku0407;


-- -------------S2-根据客户号查询企业工商信息-------------------------------------------------------------------------
-- DROP TABLE IF EXISTS lab_bigdata_dev.temp_kehuhao_0407 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.temp_kehuhao_0407 AS
-- SELECT  q0.col_1 银联通道商户号
--         ,q0.col_2 审核日期
--         ,q0.col_3 商户状态
--         ,q0.col_4 核心客户号
--         ,q0.col_5 商户号
--         ,q0.col_6 商户全称
--         ,q0.col_7 我行系统登记执照号码
--         ,q0.col_8 我行系统登记法人姓名
--         ,q1.dt_entname 企业名称
--         ,q1.dt_creditcode 统一信用代码
-- FROM    qbi_file_20240407_16_38_53 q0
-- LEFT JOIN    lab_bigdata_dev.gongshangku0407 q1
-- ON      q0.COL_4 = q1.otdt_query_no
-- WHERE   q0.pt = MAX_PT('qbi_file_20240407_16_38_53');
**01-数据需求_分行_SJ2024060406杭州分行_吴雨伦_本年消费贷款新发生风险率.sql
--本年消费贷款新发生风险率=1.47%,--本年消费贷款新发生风险率=sum(贷款余额（不含核销）,且是风险，是新发生）/sum贷款余额（不含核销）
-- 杭州分行消费贷
DROP TABLE IF EXISTS tmp_hf_wel_SJ2024060406 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hf_wel_SJ2024060406 AS
SELECT  a.cst_id 客户号
        ,a.ctr_srl_no 合同流水号
        ,a.dbil_srl_no 借据号
        ,a.dbil_bal_cny 借据余额
        ,a.bsn_sts 业务状态
        ,a.is_rsk_loan 是否风险贷款
        ,a.is_yr_new_hpn 是否年度新发生
FROM    adm_pub.adm_rsk_app_inter_all a --风险集市应用表-资产质量日常监测源表
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd b --信贷合同
ON      a.ctr_srl_no = b.busi_ctr_id
AND     b.dt = '20240531'
LEFT JOIN    adm_rsk.adm_rsk_ast_loan_ctr_inf_dd t --风险集市合同基本信息模型表
ON      a.ctr_srl_no = t.ctr_srl_no
AND     t.dt = '20240531'
WHERE   a.dt = '20240531'
AND     ( a.acc_type LIKE '0%'
    OR a.acc_type = '信用卡' ) -- 剔除表外
AND     a.acc_type NOT LIKE '0301%' -- 剔除贴现
AND     a.bsn_line NOT LIKE '%网贷%' -- 剔除网贷
AND     a.mng_org_id NOT LIKE '330188811%' -- 剔除总行台州交接业务（近期可用，20年19年机构号可能会变，不准）
AND     a.mng_org_id LIKE '3302%' --杭州分行
AND     ( b.pd_cd LIKE '201050101%'
    OR ( b.pd_cd LIKE '2010503%'
AND     b.loan_usg_cd LIKE '02%' ) ) --消费贷
AND     t.spc_bsn_label_cd NOT IN ( 'a' , 'b' , 'h' , 'i' , 'o' , 'p' )  --员工贷,需要确认下剔除哪些码值
-- and     b.bus_cd not in ( 'a' , 'b' , 'h' , 'i' , 'o' , 'p' )

-- AND     a.bsn_sts NOT LIKE '%核销%'
-- AND     a.is_rsk_loan = 'Y'
-- AND     a.is_yr_new_hpn = 'Y'
;

-- SELECT sum(CASE
--               WHEN 是否风险贷款= 'Y' AND 是否年度新发生= 'Y' THEN 借据余额
--               ELSE 0
--               END)/sum(借据余额) FROM tmp_hf_wel_SJ2024060406 ;

--员工贷款
--edw.dim_bus_loan_ctr_inf_dd  --信贷合同信息
--bus_cd 业务标识
-- A 员工贷款
-- B 员工车贷
-- H 特殊员工消费
-- I 员工消费贷
-- O 安居贷
-- P 其他员工贷款

-- SELECT * from edw.dwd_code_library_dd WHERE dt='20240624' and tbl_nm=upper('dim_bus_loan_ctr_inf_dd') and fld_nm=upper('bus_cd')
**01-数据需求_分行_SJ20240613131_王莉倩_4_6月新增综合授信企业.sql
--金华分行义乌支行4-6月新增授信企业
--企业名称、统一社会信用代码、业务发生地金融机构、获批授信额度、授信生效起始日期、授信终止日期、银行内部评级结果、上报日期、
--信用类授信额、授信敞口额度、抵押类授信额度、质押类授信额度、保证类授信额度

--SELECT * from lab_bigdata_dev.tmp_ymy_SJ20240613131;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ymy_SJ20240613131 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_ymy_SJ20240613131 AS
SELECT
--t1.freezeflag 状态,
--a.cd_val_dscr 业务品种,
t1.serialno 合同流水号
,t1.customerid 客户编号
,t2.enterprisename 企业名称
,t2.midcertno 统一社会信用代码
,t1.operateorgid 业务发生地金融机构
,t7.org_nm 业务发生地金融机构名称
,t1.totalcredit 获批授信额度
,t1.putoutdate 授信生效起始日期
,t1.maturity 授信终止日期
,t2.creditlevel 银行内部评级结果   --本行评估即期信用等级
,'' as 上报日期
,t3.信用类授信额度 信用类授信额度
,t1.businesssum 授信敞口额度
,t4.抵押类授信额度 抵押类授信额度
,t5.质押类授信额度 质押类授信额度
,t6.保证类授信额度 保证类授信额度
FROM    edw.loan_business_contract t1 --业务合同表
INNER JOIN    edw.loan_ent_info t2 --企业基本信息
ON      t1.customerid = t2.customerid
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  bcserialno
                         ,sum(linesum1) 信用类授信额度
                 FROM    edw.loan_subcl_info --额度信息
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     vouchtype = '005' --担保方式-信用类授信额度
                 GROUP BY bcserialno
             ) t3
ON      t1.serialno = t3.bcserialno
LEFT JOIN    (
                 SELECT  bcserialno
                         ,sum(linesum1) 抵押类授信额度
                 FROM    edw.loan_subcl_info --额度信息
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     vouchtype = '020' --担保方式-抵押类授信额度
                 GROUP BY bcserialno
             ) t4
ON      t1.serialno = t4.bcserialno
LEFT JOIN    (
                 SELECT  bcserialno
                         ,sum(linesum1) 质押类授信额度
                 FROM    edw.loan_subcl_info --额度信息
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     vouchtype = '040' --担保方式-质押类授信额度
                 GROUP BY bcserialno
             ) t5
ON      t1.serialno = t5.bcserialno
LEFT JOIN    (
                 SELECT  bcserialno
                         ,sum(linesum1) 保证类授信额度
                 FROM    edw.loan_subcl_info --额度信息
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     vouchtype = '010' --担保方式-保证类授信额度
                 GROUP BY bcserialno
             ) t6
ON      t1.serialno = t6.bcserialno
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t7  --机构树
ON      t1.operateorgid = t7.org_id
AND     t7.dt = '@@{yyyyMMdd}'
WHERE   t1.dt = '@@{yyyyMMdd}'
-- AND     substr(t1.operateorgid, 1, 7) IN ( '3308002' , '3308005' , '3308006' , '3308008' , '3308015' , '3308030' ) --金华分行义乌区域六家支行
AND     t7.sbr_org_id = '330800200'   --金华义乌支行
AND     t1.putoutdate >= '2024/04/01' --发放日在4月--6月
AND     t1.putoutdate <= '@@{yyyyMMdd}'
AND     substr(t1.businesstype, 1, 9) LIKE '101030101%' --业务品种为综合授信额度
ORDER BY t1.serialno , t1.putoutdate;
**01-数据需求_分行_SJ2024070431嘉兴分行_李琳_企业客户手机银行登录信息.sql
---企业手机银行日志表，设备字段无，未从数据抽取上来，转运维处理

-- 该公司当前的法人和前法人、股东有纠纷，需要走司法程序，律师让其提供数据资料。

-- 客户号：2614586486，查询时间：2024年1月15日，
-- 客户需要的资料：在2024年1月15日，登入公司：浙江志雨包装有限公司，对公手机银行的登录时间、登录的手机设备型号、IP地址。

SELECT t.alg_orgid  --企业客户号
       ,t.alg_userip --登录IP
       ,t.alg_sysname  --系统名称
       ,t.alg_optime  --操作时间
FROM edw.ebnk_cmb_audit_log t   --企业手机银行日志表
WHERE t.dt<='20240115' and t.dt>='20240101'
and t.alg_orgid='2614586486'
**01-数据需求_分行_SJ2024070906_嘉兴分行_何文骏_核算分行及各部门积分成本使用情况.sql
-----最新的代码----------------
-- 数据日期：2024年4月1日至2024年6月30日
-- 嘉兴分行综合积分系统下，自助赠分交易类型0141至0149所有代码下各团队赠分明细金额情况,手工调账增加积分交易类型0265代码下分行积分赠送金额情况。

-- 处理非1024,1027 ，客户号、交易日期、积分交易类型、借贷标识、积分交易数额、凭证号、积分归属机构号与机构名称
DROP TABLE IF EXISTS tmp_hwj_SJ2024070906_01 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hwj_SJ2024070906_01 AS
SELECT  sc.hostcustno 客户号
        ,sp.transdate 交易日期
        ,sp.transtime 交易时间
        ,sp.pointstypeno 积分类型代码
        ,sp.transtypeno 交易类型
        ,sp.debitorcredit 借贷标识
        ,sp.pointsamount 积分数额
        ,sp.voucherno 凭证号
        ,sp.belongbranch 积分机构号
        ,t3.org_nm 积分机构名称
        ,sp.transstatus 交易状态
FROM    edw.sirs_pointstrans sp --交易流水表，源表;
LEFT JOIN    edw.sirs_customers sc --积分客户表，hostcustno，银行客户号
ON      sp.customersid = sc.customersid
AND     sc.dt = '20240630'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 --机构树_考核维度
ON      sp.belongbranch = t3.org_id
AND     t3.dt = '20240630'
WHERE   sp.dt <= '20240630'
AND     sp.dt >= '20240401'
AND     sp.pointstypeno = '0001' --综合积分
AND     sp.transstatus = '1' ----交易状态成功
AND     sp.reversedflag = '0' --冲正标志正常
AND     sp.belongbranch LIKE '3309%' --嘉兴分行
;

-- SELECT * FROM tmp_hwj_SJ2024070906_01 WHERE 交易类型='1024';


---处理1024，，客户号、交易日期、积分交易类型、借贷标识、积分交易数额、凭证号、积分归属机构号与机构名称
DROP TABLE IF EXISTS tmp_hwj_SJ2024070906_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hwj_SJ2024070906_02 AS
SELECT  t1.cst_id 客户号
        ,t1.trx_dt 交易日期
        ,t1.trx_tm 交易时间
        ,t1.pnt_typ_cd 积分类型代码
        ,t1.trx_typ_cd 交易类型
        ,t2.trx_typ_dscr 交易类型说明
        ,t1.crd_and_dbt_ind 借贷标识
        ,t1.pnt_nbr_amt 积分数额
        ,t1.vch_id 凭证号
        ,t1.org_id 积分机构号
        ,t3.org_nm 积分机构名称
        ,t1.trx_sts_cd 交易状态
FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI t1 --积分交易明细
LEFT JOIN    edw.dim_bus_cmpn_pnt_trx_typ_dd t2 --积分交易类型表
ON      t1.trx_typ_cd = t2.trx_typ_no
AND     t2.dt = '20240630'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 --机构树_考核维度
ON      t1.org_id = t3.org_id
AND     t3.dt = '20240630'
WHERE   t1.dt <= '20240630'
AND     t1.dt >= '20240401'
AND     t1.pnt_typ_cd = '0001' --综合积分
AND     t1.TRX_STS_CD = '1' ----交易状态成功
AND     t1.RVS_IND = '0'  --冲正标志正常
-- and t1.TRX_TYP_CD = '1001' --积分消费
AND     t1.org_id LIKE '3309%'  --嘉兴分行
-- and     t1.trx_typ_cd ='1024'
;

SELECT * FROM tmp_hwj_SJ2024070906_02 WHERE 交易类型='1024'
**01-数据需求_分行_SJ2024071821_丽水分行_吴淑媛_各机构相关数据_包含客户数_存贷规模.sql
-- SJ2024071821丽水分行企业信息情况需求申请


-- 1. 工商法人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_01;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_01 AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息
                        WHERE   dt <= '@@{yyyyMMdd}' ---------------xt:添加查得标识=1
                        AND     gpr_ifrichard = '1' --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno in_ctfno
                                ,gpr_entname dt_gpr_entname
                                ,gpr_enttype dt_gpr_enttype
                                ,gpr_entstatus dt_gpr_enttype --旧表
                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno --被查询人证件号码
                                                        ,c.gpr_entname --企业(机构)名称
                                                        ,c.gpr_entstatus --企业状态
                                                        ,c.gpr_enttype --企业(机构)类型
                                                        ,c.gpr_creditcode --统一社会信用代码
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为法人的企业信息
                                                WHERE   a.dt <= '@@{yyyyMMdd}'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'
                                            ) aa
                                    WHERE   aa.rn = 1
                                ) cc
                    ) bb
        ) d
WHERE   d.rk = 1
;





--2. 企业基本信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02 AS
SELECT  DISTINCT T1.entname                                           AS 企业名称
                 ,T1.socialcreditcode                                 AS 统一社会信用代码
                 ,T1.cust_no                                          AS 客户号
                 ,COALESCE(T3.lgp_cst_id, T5.CST_ID,MD5(T4.in_ctfno))      AS 法人客户号  ---md5加密
                 ,CASE
                    WHEN T1.enttype = '1' THEN '个体'
                    WHEN T1.enttype = '3' THEN '注册企业'
                    ELSE '其它'
                  END                                                 AS 企业类型
                 ,CASE
                    WHEN T1.custtype = '0' THEN '正式'
                    WHEN T1.custtype = '1' THEN '潜在'
                    ELSE '未建档'
                  END                                                 AS 客户状态
                 ,T6.prm_mgr_id                                       AS 主管护客户经理工号
                 ,T6.prm_mgr_nm                                       AS 主管护客户经理姓名
                 ,T6.prm_org_id                                       AS 主管护机构号
                 ,T6.prm_org_nm                                       AS 主管户机构名称
                 ,T6.ln_mgr_id                                        AS 信贷归属客户经理
                 ,T6.ln_mgr_nm                                        AS 信贷归属客户经理名称
                 ,T6.ln_org_id                                        AS 信贷归属机构
                 ,T6.ln_org_nm                                        AS 信贷归属机构名称
                 ,CASE
                    WHEN T21.sub_cmnt_id <> '' THEN T21.sub_cmnt_id
                    ELSE T2.com_code
                  END                                                 AS 子社区编号
                 ,CASE
                    WHEN T21.sub_cmnt_id <> '' THEN T21.sub_cmnt_nm
                    ELSE T2.com_name
                  END                                                 AS 子社区名称
                 ,COALESCE(T22.com_vindicate_id, T2.com_vindicate_id) AS 子社区主维护人工号
                 ,COALESCE(T22.org_id, T2.org_id)                     AS 子社区所属机构号
FROM    edw.xwdt_xw_com_nearbyent T1 --社区企业信息表
LEFT JOIN    edw.xwdt_xw_community T2 --社区信息表
ON      T1.com_id = T2.id
AND     T2.com_type IN ( '03' , '04' , '05' ) --03子社区，04社区单元，05虚拟子社区
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd T21 --客户社区信息
ON      T1.cust_no = T21.cst_id
AND     T21.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_xw_community T22 --社区信息表  --取子社区主维护人
ON      T21.sub_cmnt_id = T22.com_code
AND     T22.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_entp_lgp_inf_dd T3 --对公客户法人信息表
ON      T1.cust_no = T3.cst_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_01 T4 --工商法人信息
ON      T1.socialcreditcode = T4.dt_gpr_creditcode
LEFT JOIN    edw.dws_cst_bas_inf_dd T5 --客户基础信息汇总
ON      T4.in_ctfno = T5.DOC_NBR
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T6 --客户集市-客户基础-客户管户信息
ON      T1.cust_no = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}';


--3. 企业存款信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_03;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_03 AS
SELECT  T1.客户号
        ,T1.统一社会信用代码
        ,T1.法人客户号
        ,T1.子社区编号
        ,T1.子社区名称
		,CASE WHEN T6.cst_id IS NOT NULL THEN 1 ELSE 0 END AS 企业是否在我行开户
		,T6.企业存款余额
		,CASE WHEN T7.cst_id IS NOT NULL THEN 1 ELSE 0 END AS 法定代表人是否在我行开户
		,T7.法人存款余额
		,T8.同一风险控制号下存款余额总数
FROM    (
            SELECT  DISTINCT 客户号
                             ,法人客户号
                             ,子社区编号
                             ,子社区名称
							 ,统一社会信用代码
            FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02
        ) T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.gl_bal) AS 企业存款余额
                 FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.act_sts_cd <> 'C'
                 GROUP BY A1.cst_id
             ) T6
ON      T1.客户号 = T6.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.gl_bal) AS 法人存款余额
                 FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.act_sts_cd <> 'C'
                 GROUP BY A1.cst_id
             ) T7
ON      T1.法人客户号 = T7.cst_id   --会存在身份号匹配不上企业，无影响
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A3.gl_bal) AS 同一风险控制号下存款余额总数   --会有部分客户没有存款账户
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.SAM_RSK_CTRL_ID = A2.SAM_RSK_CTRL_ID
                 AND     A2.SAM_RSK_CTRL_ID <> ''
                 AND     A2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dws_bus_dep_act_inf_dd A3 --存款账户信息汇总
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 AND     A3.act_sts_cd <> 'C'
                 AND     A3.DT = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.cst_id
             ) T8
ON      T1.客户号 = T8.cst_id ;



--4. 贷款情况
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04 AS
SELECT  T1.客户号
        ,T1.法人客户号
        ,T1.子社区编号
        ,T1.子社区名称
	    ,T1.统一社会信用代码
        ,T1.信贷归属客户经理
        ,T1.信贷归属客户经理名称
        ,T1.信贷归属机构
        ,T1.信贷归属机构名称
        ,T6.授信金额
        ,T6.企业贷款余额
        ,T7.法定代表人贷款余额
        ,T8.同一风险控制号下贷款余额总数
FROM    (
            SELECT  DISTINCT 客户号
                             ,法人客户号
                             ,子社区编号
                             ,子社区名称
							 ,统一社会信用代码
                             ,信贷归属客户经理
                             ,信贷归属客户经理名称
                             ,信贷归属机构
                             ,信贷归属机构名称
            FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02
        ) T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.ctr_amt) AS 授信金额
                         ,SUM(A1.ctr_bal) AS 企业贷款余额
                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD A1 --合同基础信息
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD A2 --合同其它明细信息
                 ON      A1.CTR_SERNO = A2.CTR_SERNO
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
                 AND     A1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                 AND     ( A2.APLY_CHNL_CD <> 'L08'
                     OR A1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                 AND     A1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                 AND     A1.PRD_NO <> '2001010101010' --剔除百度分期贷
                 AND     ( A1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                     OR nvl(A1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
                 AND     A1.TMT_DT = '18991231'
                 AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.DT, 'yyyyMMdd') )
                     OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T6
ON      T1.客户号 = T6.cst_id   --计算企业贷款余额
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.ctr_bal) AS 法定代表人贷款余额
                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD A1 --合同基础信息
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD A2 --合同其它明细信息
                 ON      A1.CTR_SERNO = A2.CTR_SERNO
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
                 AND     A1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                 AND     ( A2.APLY_CHNL_CD <> 'L08'
                     OR A1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                 AND     A1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                 AND     A1.PRD_NO <> '2001010101010' --剔除百度分期贷
                 AND     ( A1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                     OR nvl(A1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
                 AND     A1.TMT_DT = '18991231'
                 AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.DT, 'yyyyMMdd') )
                     OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T7
ON      T1.法人客户号 = T7.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A3.授信余额) AS 同一风险控制号下贷款余额总数
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.SAM_RSK_CTRL_ID = A2.SAM_RSK_CTRL_ID
                 AND     A2.SAM_RSK_CTRL_ID <> ''
                 AND     A2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  B1.cst_id
                                          ,SUM(B1.ctr_bal) AS 授信余额
                                  FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B1 --合同基础信息
                                  LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD B2 --合同其它明细信息
                                  ON      B1.CTR_SERNO = B2.CTR_SERNO
                                  AND     B2.dt = '@@{yyyyMMdd}'
                                  WHERE   B1.dt = '@@{yyyyMMdd}'
                                  AND     B1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                                  AND     ( B2.APLY_CHNL_CD <> 'L08'
                                      OR B1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                                  AND     B1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                                  AND     B1.PRD_NO <> '2001010101010' --剔除百度分期贷
                                  AND     ( B1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                                      OR nvl(B1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                                  --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                                  AND     ( ( B1.CTR_STS_CD IN ( '2' , '4' )
                                  AND     B1.TMT_DT = '18991231'
                                  AND     to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )
                                      OR B1.CTR_BAL > 0 )
                                  GROUP BY B1.cst_id
                              ) A3 --合同基础信息
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.cst_id
             ) T8
ON      T1.客户号 = T8.cst_id;





--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_05;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_05 AS
SELECT  D1.子社区编号
        ,D1.子社区名称
        ,D1.全量企业数
        ,D1.注册企业数
        ,D1.法定代表人数量
        ,D1.个体工商户数
        ,D1.其它企业数量
        ,D1.正式客户数
        ,D1.潜在客户数
        ,D1.未建档客户数
        ,D2.企业在我行开户数
        ,D2.法定代表人在我行开户数
        ,D2.企业存款余额
        ,D2.法人存款余额
        ,D2.同一风险控制号下存款余额总数
        ,D3.授信金额
        ,D3.企业贷款余额
        ,D3.法定代表人贷款余额
        ,D3.同一风险控制号下贷款余额总数
        ,D3.授信总额最大信贷归属客户经理
        ,D3.授信总额最大信贷归属客户经理名称
        ,D3.授信总额最大信贷归属机构
        ,D3.授信总额最大信贷归属机构名称
        ,D4.潜在客户中社区主维护人管护数
        ,D4.正式客户中社区主维护人管护数
        ,D4.正式客户中子社区的管护机构的管护数
        ,D4.子社区所属机构号
FROM
----------------------------------------
--企业基本情况汇总
       (
            SELECT  A1.子社区编号
                    ,A1.子社区名称
                    ,COUNT(DISTINCT A1.统一社会信用代码) AS 全量企业数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.企业类型 = '注册企业' THEN A1.统一社会信用代码
                                    END)         AS 注册企业数
                    ,COUNT(DISTINCT A1.法人客户号)    AS 法定代表人数量
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.企业类型 = '个体' THEN A1.统一社会信用代码
                                    END)         AS 个体工商户数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.企业类型 = '其它' THEN A1.统一社会信用代码
                                    END)         AS 其它企业数量
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.客户状态 = '正式' THEN A1.统一社会信用代码
                                    END)         AS 正式客户数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.客户状态 = '潜在' THEN A1.统一社会信用代码
                                    END)         AS 潜在客户数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.客户状态 = '未建档' THEN A1.统一社会信用代码
                                    END)         AS 未建档客户数
            FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02 A1
            WHERE   COALESCE(A1.子社区编号, '') <> ''
            GROUP BY A1.子社区编号 , A1.子社区名称
        ) D1
----------------------------------------
--存款情况汇总
LEFT JOIN    (
                 SELECT  A1.子社区编号
                         ,A1.子社区名称
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.企业是否在我行开户 = '1' THEN A1.统一社会信用代码
                                         END)    AS 企业在我行开户数
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.法定代表人是否在我行开户 = '1' THEN A1.统一社会信用代码
                                         END)    AS 法定代表人在我行开户数
                         ,SUM(A1.企业存款余额)         AS 企业存款余额
                         ,SUM(A1.法人存款余额)         AS 法人存款余额
                         ,SUM(A1.同一风险控制号下存款余额总数) AS 同一风险控制号下存款余额总数
                 FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_03 A1
                 WHERE   COALESCE(A1.子社区编号, '') <> ''
                 GROUP BY A1.子社区编号 , A1.子社区名称
             ) D2
ON      D1.子社区编号 = D2.子社区编号
AND     D1.子社区名称 = D2.子社区名称
----------------------------------------
--贷款情况汇总
LEFT JOIN    (
                 SELECT  T1.子社区编号
                         ,T1.子社区名称
                         ,SUM(T1.授信金额)           AS 授信金额
                         ,SUM(T1.企业贷款余额)         AS 企业贷款余额
                         ,SUM(T1.法定代表人贷款余额)      AS 法定代表人贷款余额
                         ,SUM(T1.同一风险控制号下贷款余额总数) AS 同一风险控制号下贷款余额总数
                         ,T2.信贷归属客户经理            AS 授信总额最大信贷归属客户经理
                         ,T2.信贷归属客户经理名称          AS 授信总额最大信贷归属客户经理名称
                         ,T2.信贷归属机构              AS 授信总额最大信贷归属机构
                         ,T2.信贷归属机构名称            AS 授信总额最大信贷归属机构名称
                 FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04 T1
                 LEFT JOIN    (
                                  SELECT  B1.子社区编号
                                          ,B1.子社区名称
                                          ,B1.信贷归属客户经理
                                          ,B1.信贷归属客户经理名称
                                          ,B1.信贷归属机构
                                          ,B1.信贷归属机构名称
                                          ,B1.授信金额
                                          ,ROW_NUMBER() OVER ( PARTITION BY B1.子社区编号 , B1.子社区名称 ORDER BY B1.授信金额 DESC ) AS RN
                                  FROM    (
                                              SELECT  A1.子社区编号
                                                      ,A1.子社区名称
                                                      ,A1.信贷归属客户经理
                                                      ,A1.信贷归属客户经理名称
                                                      ,A1.信贷归属机构
                                                      ,A1.信贷归属机构名称
                                                      ,SUM(A1.授信金额) AS 授信金额
                                              FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04 A1
                                              WHERE   COALESCE(A1.子社区编号, '') <> ''
                                              GROUP BY A1.子社区编号 , A1.子社区名称 , A1.信贷归属客户经理 , A1.信贷归属客户经理名称 , A1.信贷归属机构 , A1.信贷归属机构名称
                                          ) B1
                              ) T2
                 ON      T1.子社区编号 = T2.子社区编号
                 AND     T2.RN = 1
                 WHERE   COALESCE(T1.子社区编号, '') <> ''
                 GROUP BY T1.子社区编号 , T1.子社区名称 , T2.信贷归属客户经理 , T2.信贷归属客户经理名称 , T2.信贷归属机构 , T2.信贷归属机构名称
             ) D3
ON      D1.子社区编号 = D3.子社区编号
AND     D1.子社区名称 = D3.子社区名称
----------------------------------------
--管护情况汇总
LEFT JOIN    (
                 SELECT  A1.子社区编号
                         ,A1.子社区名称
                         ,A1.子社区所属机构号
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.客户状态 = '潜在' AND A1.主管护客户经理工号 = A1.子社区主维护人工号 THEN A1.统一社会信用代码
                                         END) AS 潜在客户中社区主维护人管护数
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.客户状态 = '正式' AND A1.主管护客户经理工号 = A1.子社区主维护人工号 THEN A1.统一社会信用代码
                                         END) AS 正式客户中社区主维护人管护数
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.客户状态 = '正式' THEN A1.统一社会信用代码
                                          -- AND A1.主管护机构号 = A1.子社区所属机构号
                                         END) AS 正式客户中子社区的管护机构的管护数
                 FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02 A1
                 WHERE   COALESCE(A1.子社区编号, '') <> ''
                 GROUP BY A1.子社区编号 , A1.子社区名称 , A1.子社区所属机构号
             ) D4
ON      D1.子社区编号 = D4.子社区编号
AND     D1.子社区名称 = D4.子社区名称 ;
**01-数据需求_分行_SJ2024071821_丽水分行_吴淑媛_社区业务数据0827.sql
--存款：企业存款余额	法定代表人存款余额	同一风险控制号下存款余额总数
--贷款：授信金额	企业贷款余额	法定代表人贷款余额	同一风险控制号下贷款余额总数	贷款管护客户经理（按授信金额大的）	贷款管护客户经理所属机构
--公共：潜在客户中社区主维护人管护数	正式客户中社区主维护人管护数	正式客户中子社区的管护机构的管护数	社区管护机构

-- SJ2024071821丽水分行企业信息情况需求申请


-- 1. 工商法人信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_01;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_01 AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息
                        WHERE   dt <= '@@{yyyyMMdd}' ---------------xt:添加查得标识=1
                        AND     gpr_ifrichard = '1' --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno in_ctfno
                                ,gpr_entname dt_gpr_entname
                                ,gpr_enttype dt_gpr_enttype
                                ,gpr_entstatus dt_gpr_enttype --旧表
                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno --被查询人证件号码
                                                        ,c.gpr_entname --企业(机构)名称
                                                        ,c.gpr_entstatus --企业状态
                                                        ,c.gpr_enttype --企业(机构)类型
                                                        ,c.gpr_creditcode --统一社会信用代码
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为法人的企业信息
                                                WHERE   a.dt <= '@@{yyyyMMdd}'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'
                                            ) aa
                                    WHERE   aa.rn = 1
                                ) cc
                    ) bb
              WHERE  in_ctfno IS NOT NULL
        ) d
WHERE   d.rk = 1
;





--2. 企业基本信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02 AS
SELECT  DISTINCT T1.entname                                            AS 企业名称
                 ,T1.socialcreditcode                                  AS 统一社会信用代码
                 ,T1.cust_no                                           AS 客户号
                 ,COALESCE(T3.lgp_cst_id, T5.CST_ID, MD5(T4.in_ctfno)) AS 法人客户号
                 ,CASE
                    WHEN T1.enttype = '1' THEN '个体'
                    WHEN T1.enttype = '3' THEN '注册企业'
                    ELSE '其它'
                  END                                                  AS 企业类型
                 ,CASE
                    WHEN T1.custtype = '0' THEN '正式'
                    WHEN T1.custtype = '1' THEN '潜在'
                    ELSE '未建档'
                  END                                                  AS 客户状态
                 ,T6.prm_mgr_id                                        AS 主管护客户经理工号
                 ,T6.prm_mgr_nm                                        AS 主管护客户经理姓名
                 ,T6.prm_org_id                                        AS 主管护机构号
                 ,T6.prm_org_nm                                        AS 主管户机构名称
                 ,T6.ln_mgr_id                                         AS 信贷归属客户经理
                 ,T6.ln_mgr_nm                                         AS 信贷归属客户经理名称
                 ,T6.ln_org_id                                         AS 信贷归属机构
                 ,T6.ln_org_nm                                         AS 信贷归属机构名称
                 ,CASE
                    WHEN T21.sub_cmnt_id <> '' THEN T21.sub_cmnt_id
                    ELSE T2.com_code
                  END                                                  AS 子社区编号
                 ,CASE
                    WHEN T21.sub_cmnt_id <> '' THEN T21.sub_cmnt_nm
                    ELSE T2.com_name
                  END                                                  AS 子社区名称
                 ,COALESCE(T22.com_vindicate_id, T2.com_vindicate_id)  AS 子社区主维护人工号
                 ,COALESCE(T22.org_id, T2.org_id)                      AS 子社区所属机构号
FROM    edw.xwdt_xw_com_nearbyent T1 --社区企业信息表
LEFT JOIN    edw.xwdt_xw_community T2 --社区信息表
ON      T1.com_id = T2.id
AND     T2.com_type IN ( '03' , '04' , '05' ) --03子社区，04社区单元，05虚拟子社区
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd T21 --客户社区信息
ON      T1.cust_no = T21.cst_id
AND     T21.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_xw_community T22 --社区信息表  --取子社区主维护人
ON      T21.sub_cmnt_id = T22.com_code
AND     T22.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_entp_lgp_inf_dd T3 --对公客户法人信息表
ON      T1.cust_no = T3.cst_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_01 T4 --工商法人信息
ON      T1.socialcreditcode = T4.dt_gpr_creditcode
LEFT JOIN    (
                 SELECT  DOC_NBR
                         ,cst_id
                         ,ROW_NUMBER() OVER ( PARTITION BY DOC_NBR ORDER BY FILE_DT ) AS RN
                 FROM    edw.dws_cst_bas_inf_dd
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     CST_TYP_CD = '1'
             ) T5
ON      T4.in_ctfno = T5.DOC_NBR
AND     T5.RN = 1
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T6 --客户集市-客户基础-客户管户信息
ON      T1.cust_no = T6.cst_id
AND     T6.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}';




--3. 企业存款信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_03;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_03 AS
SELECT  T1.客户号
        ,T1.统一社会信用代码
        ,T1.法人客户号
        ,T1.子社区编号
        ,T1.子社区名称
		,CASE WHEN T6.cst_id IS NOT NULL THEN 1 ELSE 0 END AS 企业是否在我行开户
		,T6.企业存款余额
		,CASE WHEN T7.cst_id IS NOT NULL THEN 1 ELSE 0 END AS 法定代表人是否在我行开户
		,T7.法人存款余额
		,T8.同一风险控制号下存款余额总数
FROM    (
            SELECT  DISTINCT 客户号
                             ,法人客户号
                             ,子社区编号
                             ,子社区名称
							 ,统一社会信用代码
            FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02
            WHERE   子社区所属机构号 LIKE '3306%'
            AND     主管护机构号 LIKE '3306%'  --丽水分行
            AND    ( 客户号 IS NOT NULL OR 法人客户号 IS NOT NULL )
        ) T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.gl_bal) AS 企业存款余额
                 FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.act_sts_cd <> 'C'
                 GROUP BY A1.cst_id
             ) T6
ON      T1.客户号 = T6.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.gl_bal) AS 法人存款余额
                 FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.act_sts_cd <> 'C'
                 GROUP BY A1.cst_id
             ) T7
ON      T1.法人客户号 = T7.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A3.gl_bal) AS 同一风险控制号下存款余额总数
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.SAM_RSK_CTRL_ID = A2.SAM_RSK_CTRL_ID
                 AND     A2.SAM_RSK_CTRL_ID <> ''
                 AND     A2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dws_bus_dep_act_inf_dd A3 --存款账户信息汇总
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 AND     A3.act_sts_cd <> 'C'
                 AND     A3.DT = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.cst_id
             ) T8
ON      T1.客户号 = T8.cst_id
;



--4. 贷款情况
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04 AS
SELECT  T1.客户号
        ,T1.法人客户号
        ,T1.子社区编号
        ,T1.子社区名称
	    ,T1.统一社会信用代码
        ,T1.信贷归属客户经理
        ,T1.信贷归属客户经理名称
        ,T1.信贷归属机构
        ,T1.信贷归属机构名称
        ,T6.授信金额
        ,T6.企业贷款余额
        ,T7.法定代表人贷款余额
        ,T8.同一风险控制号下贷款余额总数
FROM    (
            SELECT  DISTINCT 客户号
                             ,法人客户号
                             ,子社区编号
                             ,子社区名称
							 ,统一社会信用代码
                             ,信贷归属客户经理
                             ,信贷归属客户经理名称
                             ,信贷归属机构
                             ,信贷归属机构名称
            FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02
           WHERE   子社区所属机构号 LIKE '3306%'
            AND     主管护机构号 LIKE '3306%'
            AND    ( 客户号 IS NOT NULL OR 法人客户号 IS NOT NULL )
        ) T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.ctr_amt) AS 授信金额
                         ,SUM(A1.ctr_bal) AS 企业贷款余额
                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD A1 --合同基础信息
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD A2 --合同其它明细信息
                 ON      A1.CTR_SERNO = A2.CTR_SERNO
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
                 AND     A1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                 AND     ( A2.APLY_CHNL_CD <> 'L08'
                     OR A1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                 AND     A1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                 AND     A1.PRD_NO <> '2001010101010' --剔除百度分期贷
                 AND     ( A1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                     OR nvl(A1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
                 AND     A1.TMT_DT = '18991231'
                 AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.DT, 'yyyyMMdd') )
                     OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T6
ON      T1.客户号 = T6.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.ctr_bal) AS 法定代表人贷款余额
                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD A1 --合同基础信息
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD A2 --合同其它明细信息
                 ON      A1.CTR_SERNO = A2.CTR_SERNO
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
                 AND     A1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                 AND     ( A2.APLY_CHNL_CD <> 'L08'
                     OR A1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                 AND     A1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                 AND     A1.PRD_NO <> '2001010101010' --剔除百度分期贷
                 AND     ( A1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                     OR nvl(A1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
                 AND     A1.TMT_DT = '18991231'
                 AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.DT, 'yyyyMMdd') )
                     OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T7
ON      T1.法人客户号 = T7.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A3.授信余额) AS 同一风险控制号下贷款余额总数
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.SAM_RSK_CTRL_ID = A2.SAM_RSK_CTRL_ID
                 AND     A2.SAM_RSK_CTRL_ID <> ''
                 AND     A2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  B1.cst_id
                                          ,SUM(B1.ctr_bal) AS 授信余额
                                  FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B1 --合同基础信息
                                  LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD B2 --合同其它明细信息
                                  ON      B1.CTR_SERNO = B2.CTR_SERNO
                                  AND     B2.dt = '@@{yyyyMMdd}'
                                  WHERE   B1.dt = '@@{yyyyMMdd}'
                                  AND     B1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                                  AND     ( B2.APLY_CHNL_CD <> 'L08'
                                      OR B1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                                  AND     B1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                                  AND     B1.PRD_NO <> '2001010101010' --剔除百度分期贷
                                  AND     ( B1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                                      OR nvl(B1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                                  --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                                  AND     ( ( B1.CTR_STS_CD IN ( '2' , '4' )
                                  AND     B1.TMT_DT = '18991231'
                                  AND     to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )
                                      OR B1.CTR_BAL > 0 )
                                  GROUP BY B1.cst_id
                              ) A3 --合同基础信息
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 GROUP BY A1.cst_id
             ) T8
ON      T1.客户号 = T8.cst_id;





--结果表
-- SELECT * FROM tmp_ls_qiye_shequ_SJ2024071821_05

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_05;

CREATE TABLE lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_05 AS
SELECT  D1.子社区编号
        ,D1.子社区名称
        ,D1.全量企业数
        ,D1.注册企业数
        ,D1.法定代表人数量
        ,D1.个体工商户数
        ,D1.其它企业数量
        ,D1.正式客户数
        ,D1.潜在客户数
        ,D1.未建档客户数
        ,D2.企业在我行开户数
        ,D2.法定代表人在我行开户数
        ,D2.企业存款余额
        ,D2.法人存款余额
        ,D2.同一风险控制号下存款余额总数
        ,D3.授信金额
        ,D3.企业贷款余额
        ,D3.法定代表人贷款余额
        ,D3.同一风险控制号下贷款余额总数
        ,D3.授信总额最大信贷归属客户经理
        ,D3.授信总额最大信贷归属客户经理名称
        ,D3.授信总额最大信贷归属机构
        ,D3.授信总额最大信贷归属机构名称
        ,D4.潜在客户中社区主维护人管护数
        ,D4.正式客户中社区主维护人管护数
        ,D4.正式客户中子社区的管护机构的管护数
        ,D4.子社区所属机构号
FROM
----------------------------------------
--企业基本情况汇总
       (
            SELECT  A1.子社区编号
                    ,A1.子社区名称
                    ,COUNT(DISTINCT A1.统一社会信用代码) AS 全量企业数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.企业类型 = '注册企业' THEN A1.统一社会信用代码
                                    END)         AS 注册企业数
                    ,COUNT(DISTINCT A1.法人客户号)    AS 法定代表人数量
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.企业类型 = '个体' THEN A1.统一社会信用代码
                                    END)         AS 个体工商户数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.企业类型 = '其它' THEN A1.统一社会信用代码
                                    END)         AS 其它企业数量
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.客户状态 = '正式' THEN A1.统一社会信用代码
                                    END)         AS 正式客户数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.客户状态 = '潜在' THEN A1.统一社会信用代码
                                    END)         AS 潜在客户数
                    ,COUNT(DISTINCT CASE
                                      WHEN A1.客户状态 = '未建档' THEN A1.统一社会信用代码
                                    END)         AS 未建档客户数
            FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02 A1
            WHERE   COALESCE(A1.子社区编号, '') <> ''
            GROUP BY A1.子社区编号 , A1.子社区名称
        ) D1
----------------------------------------
--存款情况汇总
LEFT JOIN    (
                 SELECT  A1.子社区编号
                         ,A1.子社区名称
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.企业是否在我行开户 = '1' THEN A1.统一社会信用代码
                                         END)    AS 企业在我行开户数
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.法定代表人是否在我行开户 = '1' THEN A1.统一社会信用代码
                                         END)    AS 法定代表人在我行开户数
                         ,SUM(A1.企业存款余额)         AS 企业存款余额
                         ,SUM(A1.法人存款余额)         AS 法人存款余额
                         ,SUM(A1.同一风险控制号下存款余额总数) AS 同一风险控制号下存款余额总数
                 FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_03 A1
                 WHERE   COALESCE(A1.子社区编号, '') <> ''
                 GROUP BY A1.子社区编号 , A1.子社区名称
             ) D2
ON      D1.子社区编号 = D2.子社区编号
AND     D1.子社区名称 = D2.子社区名称
----------------------------------------
--贷款情况汇总
LEFT JOIN    (
                 SELECT  T1.子社区编号
                         ,T1.子社区名称
                         ,SUM(T1.授信金额)           AS 授信金额
                         ,SUM(T1.企业贷款余额)         AS 企业贷款余额
                         ,SUM(T1.法定代表人贷款余额)      AS 法定代表人贷款余额
                         ,SUM(T1.同一风险控制号下贷款余额总数) AS 同一风险控制号下贷款余额总数
                         ,T2.信贷归属客户经理            AS 授信总额最大信贷归属客户经理
                         ,T2.信贷归属客户经理名称          AS 授信总额最大信贷归属客户经理名称
                         ,T2.信贷归属机构              AS 授信总额最大信贷归属机构
                         ,T2.信贷归属机构名称            AS 授信总额最大信贷归属机构名称
                 FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04 T1
                 LEFT JOIN    (
                                  SELECT  B1.子社区编号
                                          ,B1.子社区名称
                                          ,B1.信贷归属客户经理
                                          ,B1.信贷归属客户经理名称
                                          ,B1.信贷归属机构
                                          ,B1.信贷归属机构名称
                                          ,B1.授信金额
                                          ,ROW_NUMBER() OVER ( PARTITION BY B1.子社区编号 , B1.子社区名称 ORDER BY B1.授信金额 DESC ) AS RN
                                  FROM    (
                                              SELECT  A1.子社区编号
                                                      ,A1.子社区名称
                                                      ,A1.信贷归属客户经理
                                                      ,A1.信贷归属客户经理名称
                                                      ,A1.信贷归属机构
                                                      ,A1.信贷归属机构名称
                                                      ,SUM(A1.授信金额) AS 授信金额
                                              FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_04 A1
                                              WHERE   COALESCE(A1.子社区编号, '') <> ''
                                              GROUP BY A1.子社区编号 , A1.子社区名称 , A1.信贷归属客户经理 , A1.信贷归属客户经理名称 , A1.信贷归属机构 , A1.信贷归属机构名称
                                          ) B1
                              ) T2
                 ON      T1.子社区编号 = T2.子社区编号
                 AND     T2.RN = 1
                 WHERE   COALESCE(T1.子社区编号, '') <> ''
                 GROUP BY T1.子社区编号 , T1.子社区名称 , T2.信贷归属客户经理 , T2.信贷归属客户经理名称 , T2.信贷归属机构 , T2.信贷归属机构名称
             ) D3
ON      D1.子社区编号 = D3.子社区编号
AND     D1.子社区名称 = D3.子社区名称
----------------------------------------
--管护情况汇总
LEFT JOIN    (
                 SELECT  A1.子社区编号
                         ,A1.子社区名称
                         ,A1.子社区所属机构号
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.客户状态 = '潜在' AND A1.主管护客户经理工号 = A1.子社区主维护人工号 THEN A1.统一社会信用代码
                                         END) AS 潜在客户中社区主维护人管护数
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.客户状态 = '正式' AND A1.主管护客户经理工号 = A1.子社区主维护人工号 THEN A1.统一社会信用代码
                                         END) AS 正式客户中社区主维护人管护数
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.客户状态 = '正式'  THEN A1.统一社会信用代码
                                         END) AS 正式客户中子社区的管护机构的管护数
                 FROM    lab_bigdata_dev.tmp_ls_qiye_shequ_SJ2024071821_02 A1
                 WHERE   COALESCE(A1.子社区编号, '') <> ''
                 GROUP BY A1.子社区编号 , A1.子社区名称 , A1.子社区所属机构号
             ) D4
ON      D1.子社区编号 = D4.子社区编号
AND     D1.子社区名称 = D4.子社区名称
WHERE   SUBSTR(子社区所属机构号,1,4) = '3306'
;
**01-数据需求_分行_SJ20240719101_嘉兴分行_余舟_嘉兴分行客户的兴业银行TA_非天添宝那个TA_的推荐人.sql
-- 因代销兴业银行挂钩理财上线，而每个TA的销售人字段目前没有地方查询，且该销售人字段会影响到理财大部分计奖。
-- 截止7月19日。嘉兴分行客户的兴业银行TA（非天添宝那个TA）的推荐人字段
-- 客户号，客户姓名，客户管护支行，客户管护团队，客户主管护人，兴业银行ta在理财系统中的销售人工号及姓名。
**01-数据需求_分行_SJ2024071996_湖州分行_姬晨延_涉分裂融资活动_利用电商平台洗钱_组织套取金融机构贷款的风险排查.sql
-- 涉分裂融资活动、利用电商平台洗钱、组织套取金融机构贷款的风险排查

-- 以客户号为单位，湖州分行所有满足近一年（2023年7月20日至2024年7月19日）对私客户累计交易总额>=100万元和对公客户累计交易总额>=500万元的客户

-- A列提供客户号，B列至J列反馈是否符合条件，K列提供该客户近一年交易总笔数，L列提供该客户近一年交易总金额

-- 字段:
-- 客户号交易附言中涉及&ldquo;供奉&rdquo;或&ldquo;随喜&rdquo;或&ldquo;放生&rdquo;	资金流向尼泊尔、印度	资金流向香港	交易对手名称涉及关键字&ldquo;京东&rdquo;或&ldquo;网银在线&rdquo;
-- 交易对手名称涉及关键字&ldquo;个贷&rdquo;或&ldquo;放款&rdquo;或&ldquo;零贷&rdquo;或&ldquo;贷款&rdquo;或&ldquo;受托&rdquo;	近一年账户现金交易总额大于20万元	近一年账户交易单笔交易金额大于90万元的交易笔数大于5笔
-- 公司成立时间晚于2023年1月1日	交易备注含关键字&ldquo;佣金&rdquo;	累计交易笔数	累计交易金额折人民币

--客户交易流水信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xq_SJ2024071996_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_xq_SJ2024071996_01 AS
SELECT  A1.cst_id
        ,A1.cst_act_id
        ,MAX(CASE WHEN A2.cmt RLIKE '供奉|随喜|放生' THEN 1 ELSE 0 END)                                    AS 交易附言含供奉_随喜_放生
        ,MAX(CASE WHEN A2.cnt_pty_act_nm RLIKE '京东|网银在线' THEN 1 ELSE 0 END)                          AS 交易对手名称涉及京东_网银在线
        ,MAX(CASE WHEN A2.cnt_pty_act_nm RLIKE '个贷|放款|零贷|贷款|受托' THEN 1 ELSE 0 END)               AS 交易对手名称涉及京东_个贷_放款_零贷_贷款_受托
        ,SUM(CASE WHEN A2.smr_dscr RLIKE '存现|取现|现金' THEN A2.trx_amt * A3.cny_exr ELSE 0 END)         AS 近一年账户现金交易总额大于20万元
        ,SUM(CASE WHEN A2.trx_amt * A3.cny_exr >= 900000 THEN 1 ELSE 0 END )	                           AS 近一年账户交易单笔交易金额大于90万元的交易笔数大于5笔
        ,MAX(CASE WHEN A2.cmt RLIKE '佣金' THEN 1 ELSE 0 END)                                              AS 交易备注涉及佣金
        ,SUM(A2.trx_amt * A3.cny_exr)                                                                      AS 累计交易金额折人民币
        ,COUNT(1)                                                                                          AS 累计交易笔数
FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
INNER JOIN    edw.dwd_bus_dep_bal_chg_dtl_di A2 --存款账户余额发生明细
ON      A1.dep_act_id = A2.dep_act_id
AND     A1.cst_act_id = A2.cst_act_id
AND     A2.trx_amt > 0
AND     A2.DT >= '20230720'
AND     A2.DT <= '20240719'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd A3 --汇率信息
ON      A2.trx_ccy_cd = A3.ccy_cd
AND     A3.DT = '20240719'
WHERE   A1.DT = '20240719'
GROUP BY A1.cst_id , A1.cst_act_id;




--客户交易IP信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xq_SJ2024071996_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_xq_SJ2024071996_02 AS
SELECT  A1.pmt_act_id
       ,MAX(CASE WHEN A1.cnr_nm  IN ('尼泊尔','印度') THEN 1 ELSE 0 END)            AS 资金流向尼泊尔_印度
	   ,MAX(CASE WHEN A1.cty_nm ='中国香港'  THEN 1 ELSE 0 END)            AS 资金流向香港
FROM    edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di A1 --个人网银各渠道汇总流水信息
WHERE   A1.DT >= '20230720'
AND     A1.DT <= '20240719'
AND     A1.hst_rtn_err_cd = '000000' --交易成功
GROUP BY A1.pmt_act_id
UNION ALL
SELECT  A1.pmt_act_id
       ,MAX(CASE WHEN A1.cnr_nm  IN ('尼泊尔','印度') THEN 1 ELSE 0 END)            AS 资金流向尼泊尔_印度
	   ,MAX(CASE WHEN A1.cty_nm ='中国香港'  THEN 1 ELSE 0 END)            AS 资金流向香港
FROM    edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di A1 --企业网银各渠道汇总流水信息
WHERE   A1.DT >= '20230720'
AND     A1.DT <= '20240719'
AND     A1.hst_rtn_err_cd = '000000' --交易成功
GROUP BY A1.pmt_act_id ;





--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xq_SJ2024071996_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_xq_SJ2024071996_03 AS
SELECT  T1.cst_id                                                                                                                                             AS 客户号
        ,T2.cst_act_id                                                                                                                                        AS 客户账户
		,T21.资金流向尼泊尔_印度
		,T21.资金流向香港
		,T2.交易附言含供奉_随喜_放生
		,T2.交易对手名称涉及京东_网银在线
		,T2.交易对手名称涉及京东_个贷_放款_零贷_贷款_受托
		,T2.近一年账户现金交易总额大于20万元
		,T2.近一年账户交易单笔交易金额大于90万元的交易笔数大于5笔
	    ,CASE WHEN SUBSTR(REPLACE(T4.org_org_found_dt, '-', ''), 1, 8) >= '20230101' THEN '是' ELSE '否' END    AS 对公客户成立时间晚于20230101
		,T2.交易备注涉及佣金
		,T2.累计交易金额折人民币
		,T2.累计交易笔数
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
INNER JOIN    lab_bigdata_dev.tmp_hz_xq_SJ2024071996_01 T2 --客户交易流水信息
ON      T1.cst_id = T2.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_hz_xq_SJ2024071996_02 T21 --客户交易IP信息
ON      T2.cst_act_id = T21.pmt_act_id
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20240712'
LEFT JOIN    edw.dim_cst_entp_bas_inf_dd T4 --企业客户基本信息
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20240712'
WHERE   T1.DT = '20240712'
AND     T1.prm_org_id LIKE '3310%' --湖州分行
--湖州分行所有满足近一年（2023年7月20至2024年7月19日）对私客户累计交易总额>=100万元和对公客户累计交易总额>=500万元的客户
AND     (
          ( T3.cst_id IS NOT NULL AND 累计交易金额折人民币 >= '1000000' )
       OR ( T4.cst_id IS NOT NULL AND 累计交易金额折人民币 >= '5000000' )
	   )
;

-- SELECT * from tmp_hz_xq_SJ2024071996_03
**01-数据需求_分行_SJ2024072346_林小素_年审匹配清单.sql
-- 备注：产品类型为循环类贷款，含随贷通卡。截止7月22日，合同状态非失效状态。
-- 序号	营销标签	合同流水号	申请流水号	年审申请流水号	机构编号	机构名称	管户人工号	管户人姓名

SELECT count(*) FROM tmp_xh_ns_SJ2024072346;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xh_ns_SJ2024072346;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_xh_ns_SJ2024072346 AS
SELECT DISTINCT  T0.prd_tag_nm       AS 营销标签
                ,T1.ctr_serno       AS 合同流水号
                ,T1.rel_serno       AS 申请流水号
                ,T3.btch_serno      AS 批次流水号
                ,T4.mgr_org_id      AS 合同管护机构
                ,T5.org_nm          AS 合同管护机构名称
                ,T4.mgr_id          AS 管户人工号
                ,T6.empe_nm         AS 管户人姓名
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '20240722'
LEFT JOIN    (
                 SELECT  a.dt
                         ,a.ctr_serno
                         ,a.prd_tag
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr )) AS prd_tag_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,prd_tag
                                     ,prd_tag2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(prd_tag, ',')) prd_tag AS prd_tag2
                             WHERE   dt = '20240722'
                             AND     prd_tag IS NOT NULL
                             AND     prd_tag <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.prd_tag2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
                 AND     b.fld_nm = 'BUS_LAB_CD'
                 AND     b.DT = '20240722'
                 GROUP BY a.dt , a.ctr_serno , a.prd_tag
             ) T0
ON      T1.ctr_serno = T0.ctr_serno
LEFT JOIN    edw.loan_psp_chk_info T3  --贷后检查批次信息表
ON      T1.cst_id	= T3.cst_id
AND     T3.dt = '20240722'
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T4 --信贷合同管护信息
ON      T1.ctr_serno = T4.ctr_serno
AND     T4.dt = '20240722'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T4.mgr_org_id = T5.org_id
AND     T5.dt = '20240722'
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T4.mgr_id = T6.empe_id
AND     T6.dt = '20240722'
WHERE   T1.DT = '20240722'
AND     ( T1.rvlg_typ_cd IN ( '1' , '2' ) --当RVLG_TYP_CD为1、2时，为循环，0非循环
    OR T1.prd_no IN ( '2001010101003' , '2001020101003' ) --  随贷通（消费）,随贷通（经营）
        )
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08'
    OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 )
and T5.brc_org_id like '3305%'  --温州分行
;
**01-数据需求_分行_SJ2024072906_顾佳萍_存款余额时间段汇总值.sql
--截至7月，杭州分行个性化积分清单中客户的日均情况

-- 序号	存款账户&mdash;&mdash;总户	账户名	子户账号	积数开始日期	积数终止日期	积数（开始日期至终止日期的累计余额值）


DROP TABLE IF EXISTS tmp_SJ2024072906_gjp PURGE;

CREATE TABLE IF NOT EXISTS tmp_SJ2024072906_gjp AS
SELECT  P.COL_2 存款账户_总户
        ,P.COL_3 账户名
        ,P.COL_4 子户账号
        ,substr(REPLACE(P.COL_5, '-', ''), 1, 8) 积数开始日期
        ,substr(REPLACE(P.COL_6, '-', ''), 1, 8) 积数终止日期
        ,sum(nvl(T.gl_bal, 0)) 余额积数
FROM    qbi_file_20240730_15_23_43 P
LEFT JOIN    edw.dws_bus_dep_act_inf_dd T --存款账户信息汇总
ON      P.COL_2 = T.cst_act_id
AND     P.COL_4 = T.dep_act_id
AND     T.dt >= substr(REPLACE(P.COL_5, '-', ''), 1, 8)
AND     T.dt <= substr(REPLACE(P.COL_6, '-', ''), 1, 8)
AND     T.dt >= '20240415'
WHERE   P.pt = MAX_PT('qbi_file_20240730_15_23_43')
GROUP BY P.COL_2 , P.COL_3 , P.COL_4 , P.COL_5 , P.COL_6;

-- SELECT * FROM tmp_SJ2024072906_gjp
**01-数据需求_分行_SJ20240730146_金晶_2023年1_6月_2024年1_6月累计金华分行积分赠送账户层级数据.sql
-- 2023年1-6月、2024年1-6月累计金华分行积分赠送账户层级数据

-- 积分产生月份、支行编号、支行名称、部门编号、部门名称、客户号、客户名称、账号、产品编码、产品名称、产生积分价值-当月累计、交易类型名称、积分类型、分行承担比例(%)、产品类型

-- SELECT DISTINCT 积分产生月份 FROM tmp_jh_jf_SJ20240730146_01
;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jh_jf_SJ20240730146_01;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jh_jf_SJ20240730146_01 AS
SELECT substr(T.txn_dt,1,6) as  积分产生月份
       ,T1.sbr_org_id 支行编号
       ,T1.sbr_org_nm 支行名称
       ,T.ases_org_cd 部门编号
       ,T1.org_nm 部门名称
       ,T.cust_no 客户号
       ,T.cust_nm 客户名称
       ,T.dpst_acct_tp 存款账户
    --    ,T.acct_nm 账户名称
       ,T.dpst_prod_id 存款产品编码
       ,case
       when T.prd_tp=1 then '信用卡'
       when T.prd_tp=2 then '存款'
       when T.prd_tp=3 then '贷款'
       when T.prd_tp=4 then '理财'
       when T.prd_tp=5 then '国际业务'
       ELSE '其他'
       end as  产品类型
       ,T.pnt_amt_m 产生积分价值_当月累计
       ,T.trx_tp 交易类型代码
       ,T.trx_nm 交易类型名称
       ,case
       when T.pnt_tp=2 then '总行活动积分'
       when T.pnt_tp=3 then '分行活动积分'
       when T.pnt_tp=4 then '存款基础积分'
       when T.pnt_tp=5 then '信用卡基础积分'
       end as 积分类型
       ,T.record_proportion 分行承担比例
FROM app_iftp.vpftp_acct_pnt_detail T --综合积分账户费用明细表-年累计
left JOIN edw.dim_hr_org_mng_org_tree_dd T1 --机构树_考核维度
on T.ases_org_cd=T1.org_id
and T1.dt='@@{yyyyMMdd}'
WHERE T.dt='@@{yyyyMMdd}'
and substr(T.txn_dt,1,6) in ('202301','202302','202303','202304','202305','202306','202401','202402','202403','202404','202405','202406')
and T.ases_org_cd like '3308%'  --金华分行
;
**01-数据需求_分行_SJ2024080716_杭州分行_周方锴_查询记录.sql
-- 客户编号：1645975634；客户姓名：孙泽镔，该客户自2023年至今，在快速统计查询-客户信息快速查询-个人客户信息查询那边的查询记录日志
--客户名称  客户编号  查询人工号  查询人名称，查询原因
DROP TABLE IF EXISTS tmp_zfk_SJ2024080716 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2024080716 AS
SELECT  T.queryuserid 查询人工号
        ,T.querydate 查询日期
        ,T.querytime 查询时间
        ,CASE
           WHEN T.querytype = '010'              THEN '客户详情查看'
           WHEN T.querytype = '020'              THEN '客户风险提示查询'
           WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
           WHEN T.querytype = '040'              THEN '客户账户查询'
           WHEN T.querytype = '050'              THEN '客户影像查询'
           WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
         END AS 查询类型
        ,T.objectno 查询客户号
        ,T.objectname 查询客户名称
FROM    edw.LOAN_QUERY_LOG T --信贷查询日志
WHERE   T.dt = '20240718'
AND     T.objectno = '1645975634'
and T.querydate is not null
and T.querydate between '2023/01/01' and '2024/07/18'

--SELECT count(1) FROM tmp_zfk_SJ2024080716
**01-数据需求_分行_SJ20240820101_林小素_长授信业务信息表.sql
--营销标签	合同流水号	申请流水号	批次流水号	合同管护机构	合同管护机构名称	管户人工号	管户人姓名
--要取字段：客户编号、客户名称、合同金额、合同余额、月利率、合同状态、是否触发精准贷后、客户风险等级、近一年内有无调查定位(近1年调查方式为现场（实地），只要出现一次，就是调查定位为&ldquo;是&rdquo;)

--s1,根据合同取客户信息

DROP TABLE IF EXISTS tmp_LXS_SJ20240820101_01 PURGE;

CREATE TABLE IF NOT EXISTS tmp_LXS_SJ20240820101_01 AS
SELECT  --bc.prd_tag_nm 营销标签
        a.col_2 合同流水号
        ,d.USC_APLY_SERNO 用信申请流水号
        -- ,a.col_4 批次流水号
        ,T4.mgr_org_id 合同管护机构
        ,T5.org_nm 合同管护机构名称
        ,T4.mgr_id 管户人工号
        ,T6.empe_nm 管户人姓名
        ,bc.cst_id 客户编号
        ,bc.cst_nm 客户名称
        ,bc.ctr_amt 合同金额
        ,bc.ctr_bal 合同余额
        ,bc.exec_intr_rat 执行月利率
        ,bc.ref_intr_rat 参考月利率
        ,CASE
           WHEN bc.ctr_sts_cd = 1 THEN '未生效'
           WHEN bc.ctr_sts_cd = 2 THEN '已生效'
           WHEN bc.ctr_sts_cd = 3 THEN '终止'
           WHEN bc.ctr_sts_cd = 4 THEN '冻结'
           WHEN bc.ctr_sts_cd = 5 THEN '作废'
         END AS 合同状态
        ,CASE
           WHEN d.RSK_LYR = 1 THEN '低风险'
           WHEN d.RSK_LYR = 2 THEN '中低风险'
           WHEN d.RSK_LYR = 3 THEN '中风险'
           WHEN d.RSK_LYR = 4 THEN '中高风险'
           WHEN d.RSK_LYR = 5 THEN '高风险'
           WHEN d.RSK_LYR = 6 THEN '黑名单'
           ELSE ''
         END AS 风险等级
FROM    (
            SELECT  DISTINCT col_2
            FROM    qbi_file_20240820_17_45_32
            WHERE   pt <> ''
        ) a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD bc --合同基础信息
ON      a.col_2 = bc.ctr_serno
AND     bc.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T4 --信贷合同管护信息
ON      a.col_2 = T4.ctr_serno
AND     T4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T4.mgr_org_id = T5.org_id
AND     T5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T4.mgr_id = T6.empe_id
AND     T6.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  cbi.ctr_serno
                         ,lbsi.USC_APLY_SERNO --用信申请流水号
                         ,lbsi.RSK_LYR --风险分层
                 FROM    edw.loan_lmt_biz_stat_inf lbsi --单笔用信申请
                 LEFT JOIN    edw.loan_ctr_bse_inf cbi --合同基础信息
                 ON      lbsi.USC_APLY_SERNO = cbi.rel_serno
                 AND     cbi.REG_TYP = '01' --登记类型，用信申请
                 AND     cbi.dt = '@@{yyyyMMdd}'
                 WHERE   lbsi.dt = '@@{yyyyMMdd}'
             ) d
ON      a.col_2 = d.ctr_serno;



--S2：再取客户调查信息，精准贷后
DROP TABLE IF EXISTS tmp_LXS_SJ20240820101_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_LXS_SJ20240820101_02 AS
SELECT  a . *
        ,CASE
           WHEN b.cst_id IS NOT NULL THEN '有'
           ELSE '无'
         END AS 近一年内有无调查定位
        --  ,case when b.svy_mod_cd=1 then '有' else '无'  END AS 近一年内有无调查定位
        ,b.SVY_DT 最近一次现场_实地调查日期
        ,c.tsk_gen_dt 最近一次触犯精准贷后时间
FROM    tmp_LXS_SJ20240820101_01 a
LEFT JOIN    (
                 SELECT  q.cst_id
                         ,q.svy_mod_cd
                        --  ,max(case when q.svy_mod_cd='01' then 1 else 0 end) as svy_mod_cd
                         ,max(q.SVY_DT) as SVY_DT
                 FROM    edw.DWD_BUS_LOAN_CST_SVY_RCD_DD q --信贷客户调查信息
                 WHERE   q.dt = '@@{yyyyMMdd}'
                 AND     q.SVY_DT BETWEEN '@@{yyyyMMdd-1y}' AND '@@{yyyyMMdd}' --近1年调查方式为现场（实地），只要出现一次，就是调查定位为&ldquo;是&rdquo;
                 AND     q.svy_mod_cd = '01'  --'现场实地'
                 GROUP BY q.cst_id,q.svy_mod_cd
             ) b
ON      a.客户编号 = b.cst_id
LEFT JOIN    (
                 SELECT  T1.BTCH_SERNO --批次流水号
                         ,T2.cst_id
                         ,T2.cst_nm
                         ,t1.tsk_gen_dt --任务生成日期
                         ,t1.pst_loan_chk_tsk_src_cd --贷后检查任务来源代码：01 精准贷后 04 精准贷后-信用卡 03自主贷后 02 常规贷后
                         ,T1.pst_loan_chk_tsk_typ_cd --贷后检查任务类型代码 ：01处置1级 03预警类 05统一授信年审 10其他 02处置2级 04示类 06循环贷款年审 07预保预报业务 08批复意见 09自主贷后
                         ,RANK() OVER ( PARTITION BY t2.cst_id ORDER BY T1.BTCH_SERNO DESC ) AS RN
                 FROM    edw.DWD_BUS_LOAN_PSP_CHK_TSK_INF_DD T1 --贷后检查任务信息
                 LEFT JOIN    edw.DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD T2 --贷后检查批次信息表
                 ON      T1.BTCH_SERNO = T2.BTCH_SERNO --批次流水号
                 AND     T2.dt = '@@{yyyyMMdd}'
                 WHERE   T1.dt = '@@{yyyyMMdd}'
                 AND     t1.pst_loan_chk_tsk_src_cd IN ( '01' , '04' )
             ) c
ON      a.客户编号 = c.cst_id
AND     c.RN = 1
;


--     WHEN b.svy_mod_cd = 02 THEN '云调查'
--     WHEN b.svy_mod_cd = 03 THEN '非现场'
--     WHEN b.svy_mod_cd = 04 THEN '侧面打听（现场）'
--     WHEN b.svy_mod_cd = 05 THEN '侧面打听（非现场）'
--     WHEN b.svy_mod_cd = 06 THEN '侧面打听（批量）'
**01-数据需求_分行_SJ2024082181_台州分行_郑娅娅_流失客户地址信息.sql
-- 清单客户为支行流失客户，需要对这些客户的户籍地址、住宅地址及工作地址（经营地址）进行补充，支行会根据具体地址进行社区回归，开展流失客户挽回工作

-- 截止2024年08月21日，附件流失客户的户籍地址、住宅地址及工作地址（经营地址）

CREATE table if not EXISTS lab_bigdata_dev.tmp_zyy_SJ2024082181 as
SELECT  a.col_1     AS 客户号
        ,a.col_2    AS 客户名称
        ,b1.ful_adr AS 户籍地址
        ,b2.ful_adr AS 居住地址
        ,b3.ful_adr AS 办公地址
        ,b4.ful_adr AS 经营地址
        ,b5.ful_adr AS 主地址
FROM    qbi_file_20240827_10_50_39 a
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd b1 --客户物理地址信息
ON      a.col_1 = b1.cst_id
AND     b1.dt = '20240821'
AND     b1.phy_adr_typ_cd = '050100'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd b2 --客户物理地址信息
ON      a.col_1 = b2.cst_id
AND     b2.dt = '20240821'
AND     b2.phy_adr_typ_cd = '050200'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd b3 --客户物理地址信息
ON      a.col_1 = b3.cst_id
AND     b3.dt = '20240821'
AND     b3.phy_adr_typ_cd = '050400'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd b4 --客户物理地址信息
ON      a.col_1 = b4.cst_id
AND     b4.dt = '20240821'
AND     b4.phy_adr_typ_cd = '050900'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd b5 --客户物理地址信息
ON      a.col_1 = b5.cst_id
AND     b5.dt = '20240821'
AND     b5.prm_adr_ind = 1 --主地址
WHERE   a.pt <> ''
;
**01-数据需求_分行_SJ2024082266_江慧芳_潜客是否作为担保人.sql
--业务提供潜客名单
CREATE TABLE IF NOT EXISTS  tmp_jhf_SJ2024082266 as
SELECT  a.COL_1 支行机构名称
        ,a.COL_2 客户号
        ,CASE
           WHEN a.COL_2 IN (
                               SELECT  wrnt_cst_id
                               FROM    edw.DWS_BUS_GRNT_PRSN_INF_DD
                               WHERE   dt = '@@{yyyyMMdd}'
                           ) THEN 1
           ELSE 0
         END AS 是否为担保人
FROM    qbi_file_20240823_17_03_37 a
WHERE   a.pt <> '';

SELECT  *
FROM    edw.DWS_BUS_GRNT_PRSN_INF_DD
WHERE   dt = '@@{yyyyMMdd}'
-- and wrnt_cst_id='1006598308'

select *
FROM    qbi_file_20240823_18_08_22 a
WHERE   a.pt <> '';
**01-数据需求_分行_SJ20240905171_温州分行_吴智慧_信贷系统导数日志.sql
-- 龙湾一部，2024年7月1日至2024年9月5日期间，所有员工通过信贷系统批量导数功能的导数日志。蒋相017685、陈勇军024949、陈达029944、陈律030051、汪家诚030147

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsrz_027127_20231011_t1 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dsrz_027127_20231011_t1 AS
select
     serialno	as 流水号
    ,compname	as 组件名
    ,exporttype	as 导出类型
    ,submitdate	as 提交日期
    ,exportfilename	as 数据文件名称
    ,rowcount	as 导出总条数
    ,filesize	as 数据文件大小
    ,downloaddate	as 文件下载日期
    ,inputorgid	as 任务提交机构
    ,inputuserid	as 任务提交人
from edw.loan_export_data_info     --信贷系统数据导出表
where dt = '@@{yyyyMMdd}'
   and inputuserid in ('024976','017688','017753','030063','029974','024953')
   and submitdate >= '2023/01/31 00:00:00'
   and submitdate <= '2023/08/31 00:00:00'
;


SELECT * FROM  edw.loan_tlcb_file_upl_inf WHERE dt='20240908'
**01-数据需求_分行_SJ2024090671_杭州分行_周晨辉_大额逾期客户关联关系分析.sql
-- 同一风险控制号、客户号、客户姓名、合同流水号/信用卡号、业务类型、合同项下借款余额、逾期本金、逾期天数、支行、管户机构、管户人
-- 截至2024年09月06日，杭州分行余额大于0的客户的同一风险控制号下关联业务

--贷款，新信贷合同表包含信用卡，需剔除信用卡  --104949

DROP TABLE IF EXISTS TMP_SJXQ_SJ2024090671_TABLE1;

CREATE TABLE TMP_SJXQ_SJ2024090671_TABLE1 AS
SELECT  t1.sam_rsk_ctrl_id 同一风险控制号
        ,t1.cst_id 客户号
        ,t1.cst_chn_nm 客户姓名
        ,T4.sbr_org_nm 支行
        ,t5.empe_nm 管户人
        ,t3.prm_org_id 管户机构
        ,t2.ctr_serno 合同号或信用卡卡号
        ,t6.pd_nm 业务类型
        ,t2.ctr_bal 合同金额
        ,t2.ctr_amt 合同项下借款余额
        ,t7.ovd_prcp_amt 逾期本金
        ,t7.ovd_day 最长逾期天数或期数
FROM    edw.dws_cst_bas_inf_dd t1
INNER   JOIN  edw.dim_bus_loan_ctr_bse_inf_dd T2 --合同基础信息
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20240906'
--- 未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( T2.CTR_STS_CD IN ( '2' , '4' )
AND     T2.TMT_DT = '18991231'
AND     to_date(T2.CTR_MTU_DT, 'yyyyMMdd') >= to_date('20240906', 'yyyyMMdd') )
                     OR T2.CTR_BAL > 0 )
AND    T2.PRD_NO <> '2002010101001'  --剔除信用卡
LEFT JOIN    (
                 SELECT  ctr_serno
                         ,SUM(ovd_prcp_amt) AS ovd_prcp_amt --逾期本金
                         ,MAX(ovd_day)      AS ovd_day --合同项下借据最大逾期天数
                 FROM    edw.dim_bus_loan_dbil_inf_dd --信贷借据表
                 WHERE   DT = '20240906'
                 GROUP BY ctr_serno
             ) t7
ON      t2.ctr_serno = t7.ctr_serno
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3 --客户主管护
ON      t1.cst_id = t3.cst_id
AND     t3.dt = '20240906'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4
ON      T3.prm_org_id = T4.org_id
AND     T4.dt = '20240906'
LEFT JOIN    edw.dws_hr_empe_inf_dd T5
ON      T3.prm_mgr_id = T5.empe_id
AND     T5.dt = '20240906'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD t6 --产品信息
ON      t2.prd_no = t6.prd_no
AND     T6.dt = '20240906'
WHERE   t1.dt = '20240906'
AND     t3.prm_org_id LIKE '3302%' --杭州分行管护
AND     T1.sam_rsk_ctrl_id <>''
-- AND    (T2.PRD_NO <> '2002010101001'  --剔除信用卡
--       OR     T2.cst_id IS NULL )
;


--信用卡--26320客户


DROP TABLE IF EXISTS TMP_SJXQ_SJ2024090671_TABLE2;

CREATE TABLE TMP_SJXQ_SJ2024090671_TABLE2 AS
SELECT  sam_rsk_ctrl_id 同一风险控制号
        ,cst_id 客户号
        ,cst_chn_nm 客户姓名
        ,sbr_org_nm 支行
        ,tem_org_nm 管户机构
        ,empe_nm 管户人
        ,ctr_serno 合同号或信用卡卡号
        ,pd_nm 业务类型
        ,max(ctr_amt) 合同金额
        ,MAX(ctr_bal) 合同项下借款余额
        ,SUM(ovd_prcp_amt) 逾期本金
        -- ,SUM(ovd_intr) 逾期利息
        ,MAX(ovd_day) 最长逾期天数或期数
FROM    (
            SELECT  t1.sam_rsk_ctrl_id
                    ,t1.cst_id
                    ,t1.cst_chn_nm
                    ,t2.late_main_card_card_nbr AS ctr_serno
                    ,t2.bal                     AS ctr_bal
                    ,t2.crd_lmt                 AS ctr_amt
                    ,t2.ovd_hi_trm              AS ovd_day
                    -- ,T2.intr_pnty_bal           AS ovd_intr  逾期利息
                    ,T2.ovd_amt                 AS ovd_prcp_amt
                    ,t4.tem_org_nm
                    ,t5.empe_nm
                    ,t3.acs_org_id
                    ,T4.sbr_org_nm
                    ,t6.cr_crd_pd_cmt as pd_nm
            FROM    edw.dws_cst_bas_inf_dd t1
            LEFT JOIN    edw.dws_bus_crd_cr_crd_act_inf_dd t2  --信用卡账户信息汇总
            ON      t1.cst_id = t2.cst_id
            AND     t2.dt = '20240906'
            LEFT JOIN    edw.dwd_bus_crd_cr_crd_mgr_inf_dd t3 --信用卡管户
            ON      t2.late_main_card_card_nbr = t3.cr_crd_card_nbr
            AND     t3.dt = '20240906'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4
            ON      T3.acs_org_id = T4.org_id
            AND     T4.dt = '20240906'
            LEFT JOIN    edw.dws_hr_empe_inf_dd T5
            ON      T3.frs_mgr_id = T5.empe_id
            AND     T5.dt = '20240906'
            LEFT JOIN    edw.dim_bus_crd_cr_crd_pd_inf_dd t6  --信用卡产品
            ON      t2.late_main_card_pd_cls_cd = t6.cr_crd_pd_id
            AND     T6.dt = '20240906'
            WHERE   t1.dt = '20240906'
            AND     T1.sam_rsk_ctrl_id IS NOT NULL
            AND     t3.acs_org_id LIKE '3302%'
            AND     t2.act_sts_cd = ''   --信用卡账户为空就是正常的意思，码值表对应为&lsquo;&mdash;&rsquo;
        ) T
GROUP BY sam_rsk_ctrl_id , cst_id , cst_chn_nm , sbr_org_nm , tem_org_nm , empe_nm , ctr_serno , pd_nm;


--结果表


DROP TABLE IF EXISTS TMP_SJXQ_SJ2024090671_TABLE3;

CREATE TABLE TMP_SJXQ_SJ2024090671_TABLE3 AS
select * from TMP_SJXQ_SJ2024090671_TABLE1
union
select * from TMP_SJXQ_SJ2024090671_TABLE2
;

-- SELECT count(*) FROM TMP_SJXQ_SJ2024090671_TABLE3   --131269
**01-数据需求_分行_SJ2024092446_杭州分行_吴奇_查询记录.sql
-- 22年11月至今查询2609077843客户信息的人员清单；
-- 23年8月至今查询1679001369客户信息的人员清单；
-- 23年8月至今查询2604956767客户信息的人员清单；
-- 23年8月至今查询1648584852客户信息的人员清单。
--字段：查询人员，查询人员工号，查询人员所在机构，查询时间。

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wq_SJ2024092446 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_wq_SJ2024092446 AS
SELECT  T.queryuserid 查询人工号
        ,T1.empe_nm 查询人姓名
        ,T2.org_nm 查询人员所在机构
        ,T.querydate 查询日期
        ,T.querytime 查询时间
        ,CASE
           WHEN T.querytype = '010'              THEN '客户详情查看'
           WHEN T.querytype = '020'              THEN '客户风险提示查询'
           WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
           WHEN T.querytype = '040'              THEN '客户账户查询'
           WHEN T.querytype = '050'              THEN '客户影像查询'
           WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
         END AS 查询类型
        ,T.objectno 查询客户号
        ,T.objectname 查询客户名称
FROM    edw.LOAN_QUERY_LOG T --信贷查询日志
left join edw.dws_hr_empe_inf_dd T1
on T.queryuserid=T1.empe_id
and T1.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd T2
on T1.org_id=T2.org_id
and T2.dt='@@{yyyyMMdd}'
WHERE   T.dt = '20240718'
AND     T.objectno in('2609077843','1679001369','2604956767','1648584852')
and T.querydate is not null
and T.querydate between '2022/11/01' and '2024/07/18'
;

SELECT * FROM lab_sjxq.tmp_wq_SJ2024092446
**01-数据需求_分行_SJ2024092521_温州分行_林小素_客户风险分层分析.sql
--字段：客户号、客户名称、最新一次的风险分层、去年同期的风险分层、管户客户经理编号、管户客户经理名称、管户机构名称

--最新一次的风险分层不为空的有23223条，总共29422条
SELECT count(*) FROM tmp_sjxq_jln_SJ20240920106 WHERE  最新一次的风险分层 <>'';

DROP TABLE IF EXISTS tmp_sjxq_jln_SJ20240920106 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_jln_SJ20240920106 AS
SELECT  a.cst_id      AS 客户编号
        ,a.cst_nm     AS 客户名称
        ,a.ctr_serno  AS 合同流水号
        -- ,a.ctr_sts_cd as 合同状态
        -- ,a.rel_serno  AS 用信申请流水号
        ,CASE
           WHEN f.rsk_lyr = '1' THEN '低风险'
           WHEN f.rsk_lyr = '2' THEN '中低风险'
           WHEN f.rsk_lyr = '3' THEN '中风险'
           WHEN f.rsk_lyr = '4' THEN '中高风险'
           WHEN f.rsk_lyr = '5' THEN '高风险'
           ELSE ''
         END          AS 最新一次的风险分层 --不是合同表的客户风险等级
        ,CASE
           WHEN f1.rsk_lyr_cd = '1' THEN '低风险'
           WHEN f1.rsk_lyr_cd = '2' THEN '中低风险'
           WHEN f1.rsk_lyr_cd = '3' THEN '中风险'
           WHEN f1.rsk_lyr_cd = '4' THEN '中高风险'
           WHEN f1.rsk_lyr_cd = '5' THEN '高风险'
           ELSE ''
         END          AS 去年同期的风险分层
        ,a.mgr_id     AS 管户人工号
        ,a3.empe_nm   AS 管户人姓名
        ,a.mgr_org_id AS 管户机构号
        ,a1.org_nm    AS 管护机构名
FROM    edw.dim_bus_loan_ctr_bse_inf_dd a --合同基础信息  对应贴源层表edw.loan_ctr_bse_inf
LEFT JOIN    edw.loan_lmt_biz_stat_inf f --统计类信息
ON      a.rel_serno = f.usc_aply_serno
AND     f.dt = '@@{yyyyMMdd}'
LEFT JOIN   edw.DWD_BUS_LOAN_LMT_BIZ_STAT_INF_DD f1 --统计类信息   --对应贴源层表， edw.loan_lmt_biz_stat_inf，数据只有20240719之后的
ON      a.rel_serno = f1.usc_aply_serno
AND     f1.dt = TO_CHAR(DATEADD(TO_DATE(a.dt,'YYYYMMDD'),-1,'YYYY'),'YYYYMMDD')  --去年同期dt
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd a1
ON      a.mgr_org_id = a1.org_id
AND     a1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_empe_bas_inf_dd a3
ON      a.mgr_id = a3.empe_id
AND     a3.dt = '@@{yyyyMMdd}'
WHERE   a.dt = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( A.CTR_STS_CD IN ( '2' , '4' )
AND     A.TMT_DT = '18991231'
AND     to_date(A.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A.DT, 'yyyyMMdd') )
                     OR A.CTR_BAL > 0 )
AND     a.prd_no <> '2002010101001' --剔除信用卡
AND     a.mgr_org_id LIKE '3305%'  --温州分行
;
**01-数据需求_分行_SJ2024092961_杭州分行_周方锴_查询记录.sql
--信贷查询日志目前数据只更新到20240719，无法查询，需联系开发处理

-- 截至2024年9月29日，客户2613016068杭州丙尚教育科技有限公司在信贷系统的查询记录
--查询人工号、名称 、查询人所在机构 、查询时间、查询原因

DROP TABLE IF EXISTS tmp_zfk_SJ2024092961 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2024092961 AS
SELECT  substr(aslp.date_only, 1, 10) 执行时间
        --  ,aslp.request_time  --请求时间
        ,aslp.request_message 请求信息
        ,REGEXP_REPLACE(aslp.request_message,'\\s','')  --替换数据中的逗号和回车，防止导出时excel错行,REGEXP_REPLACE( REPLACE(t3.description, ',', '|'),'\\s','|')
        -- ,aslp.return_message 返回信息
        ,aslp.user_code 用户号
        ,p.empe_nm 用户姓名
        ,aslp.org_id 机构号
        ,q.org_nm 机构名称
FROM    edw.loan_admin_sm_log_provider aslp --服务方交易日志表，增量表
LEFT JOIN    edw.dws_hr_empe_inf_dd p
ON      aslp.user_code = p.empe_id
AND     p.dt = '20240929'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd q
ON      aslp.org_id = q.org_id
AND     q.dt = '20240929'
WHERE   aslp.dt <= '20240929'
AND     aslp.SERVICE_CODE LIKE '/api/w/cst/cmm/corpbsc/detail'
AND     aslp.REQUEST_MESSAGE LIKE '%&quot;cstId&quot; : &quot;2613016068&quot;%';
**01-数据需求_分行_SJ2024092966_苏州分行_何丽芹_客户地址手动修改记录.sql
-- 苏州检察院办理周市支行原客户经理周彦君联合中介违规发放贷款案件，要求我行提供案件所需证据材料
--2021年1月至5月期间昆山周市支行发放的泰e贷客户，客户系统内各项地址（居住/户籍/经营/单位/注册地址）手动修改记录
--字段：修改时间	修改人工号	修改人姓名	修改字段	修改字段原内容	修改后内容（）  --居住地址/户籍地址/经营地址/单位地址/注册地址


DROP TABLE IF EXISTS tmp_hlj_SJ2024092966 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hlj_SJ2024092966 AS
SELECT  T1.col_1 客户号
        ,T1.col_2 客户姓名
        ,T1.col_3 管户机构名称
        ,T1.col_4 管户客户经理工号
        ,T1.col_5 管户客户经理名称
        ,T.修改时间
        ,T.修改人工号
        ,T.修改人姓名
        ,T.地址类型
        ,T.修改字段名
        ,T.修改原内容
        ,T.修改后内容
FROM    qbi_file_20241010_14_35_23 T1
LEFT JOIN    (
                 SELECT  c.cust_no 客户号
                         ,a.created_ts 修改时间
                         ,a.create_user 修改人工号
                         ,d.empe_nm 修改人姓名
                         ,CASE
                            WHEN a.data_type = '050900' THEN '经营地址'
                            WHEN a.data_type = '050100' THEN '户籍地址'
                            WHEN a.data_type = '050800' THEN '注册地址'
                            WHEN a.data_type = '050200' THEN '家庭地址'
                            WHEN a.data_type = '050400' THEN '单位地址'
                            WHEN a.data_type = '050300' THEN '通讯地址'
                            ELSE '其他'
                          END AS 地址类型
                         ,b.clum_nm 修改字段名
                         ,b.old_val 修改原内容
                         ,b.new_val 修改后内容
                 FROM    edw.ecif_t00_nor_cust_no_rec c --对私客户号识别信息表
                 LEFT JOIN    edw.ecif_nor_clum_change_log a --对私客户字段修改日志表
                 ON      a.party_id = c.party_id
                 AND     a.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.ecif_nor_clum_change_sub b --对私客户字段修改日志子表（联系、关系信息）
                 ON      a.trans_sn = b.trans_sn
                 AND     a.data_id = b.data_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dim_hr_empe_bas_inf_dd d
                 ON      a.create_user = d.empe_id
                 AND     d.dt = '@@{yyyyMMdd}'
                 WHERE   c.dt = '@@{yyyyMMdd}'
                 AND     a.data_type IS NOT NULL
                 AND     a.data_type IN ( '050100' , '050200' , '050300' , '050400' , '050500' , '050600' , '050700' , '050800' , '050900' , '051000' )
             ) T
ON      T.客户号 = T1.COL_1
WHERE   T1.pt <> '';
**01-数据需求_分行_SJ20241008136_嘉兴分行_何文骏_核算分行及各部门积分成本使用情况.sql
-- -- 处理非1024,1027 ，客户号、交易日期、积分交易类型、借贷标识、积分交易数额、凭证号、积分归属机构号与机构名称
-- DROP TABLE IF EXISTS tmp_hwj_SJ20241008136_01 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_hwj_SJ20241008136_01 AS
-- SELECT  sc.hostcustno 客户号
--         ,sp.transdate 交易日期
--         ,sp.transtime 交易时间
--         ,sp.pointstypeno 积分类型代码
--         ,sp.transtypeno 交易类型
--         ,sp.debitorcredit 借贷标识
--         ,sp.pointsamount 积分数额
--         ,sp.voucherno 凭证号
--         ,sp.belongbranch 积分机构号
--         ,t3.org_nm 积分机构名称
--         ,sp.transstatus 交易状态
-- FROM    edw.sirs_pointstrans sp --交易流水表，源表;贴源层表错行，勿用
-- LEFT JOIN    edw.sirs_customers sc --积分客户表，hostcustno，银行客户号
-- ON      sp.customersid = sc.customersid
-- AND     sc.dt = '20240930'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 --机构树_考核维度
-- ON      sp.belongbranch = t3.org_id
-- AND     t3.dt = '20240930'
-- WHERE   sp.dt <= '20240930'
-- AND     sp.dt >= '20240701'
-- AND     sp.pointstypeno = '0001' --综合积分
-- AND     sp.transstatus = '1' ----交易状态成功
-- AND     sp.reversedflag = '0' --冲正标志正常
-- AND     sp.belongbranch LIKE '3309%' --嘉兴分行
-- ;


-- --上下两段代码结合看。
-- --结果：3季度1024--活动积分扣回，数据为空。
-- --387760条
-- ---处理1024，，客户号、交易日期、积分交易类型、借贷标识、积分交易数额、凭证号、积分归属机构号与机构名称
-- DROP TABLE IF EXISTS tmp_hwj_SJ20241008136_02 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_hwj_SJ20241008136_02 AS
-- SELECT  t1.cst_id 客户号
--         ,t1.trx_dt 交易日期
--         ,t1.trx_tm 交易时间
--         ,t1.pnt_typ_cd 积分类型代码
--         ,t1.trx_typ_cd 交易类型
--         ,t2.trx_typ_dscr 交易类型说明
--         ,t1.crd_and_dbt_ind 借贷标识
--         ,t1.pnt_nbr_amt 积分数额
--         ,t1.vch_id 凭证号
--         ,t1.org_id 积分机构号
--         ,t3.org_nm 积分机构名称
--         ,t1.trx_sts_cd 交易状态
-- FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI t1 --积分交易明细  ,表有误，勿用
-- LEFT JOIN    edw.dim_bus_cmpn_pnt_trx_typ_dd t2 --积分交易类型表
-- ON      t1.trx_typ_cd = t2.trx_typ_no
-- AND     t2.dt = '20240930'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 --机构树_考核维度
-- ON      t1.org_id = t3.org_id
-- AND     t3.dt = '20240930'
-- WHERE   t1.dt <= '20240930'
-- AND     t1.dt >= '20240701'
-- AND     t1.pnt_typ_cd = '0001' --综合积分
-- AND     t1.TRX_STS_CD = '1' ----交易状态成功
-- AND     t1.RVS_IND = '0'  --冲正标志正常
-- -- and t1.TRX_TYP_CD = '1001' --积分消费
-- AND     t1.org_id LIKE '3309%'  --嘉兴分行
-- -- and     t1.trx_typ_cd ='1024'   --活动积分扣回
-- ;

-- 数据日期：2024年7月1日至2024年9月30日
-- 嘉兴分行综合积分系统下，交易类型0141至0149所有代码、交易类型0265代码下分行积分赠送金额情况

-----最新的代码----------------
----用edw.sirs_pointstransminutes--积分帐户详细记录表
--2833221条数据
--字段：客户号、交易日期、积分交易类型、借贷标识、积分交易数额、凭证号、积分归属机构号与机构名称
--需要关联客户信息表，通过积分客户号取行里的客户号
DROP TABLE IF EXISTS tmp_hwj_SJ20241008136_03 PURGE;

CREATE TABLE IF NOT EXISTS tmp_hwj_SJ20241008136_03 AS
SELECT  t1.customersid 积分客户号
        ,t4.hostcustno 银行客户号
        ,t1.transdate 交易日期
        ,t1.pointstypeno 积分类型
        ,t1.transtypeno 交易类型
        ,t2.description 交易类型说明
        ,t1.debitorcredit 借贷标识
        ,t1.pointsamount 积分交易金额
        ,t1.voucherno 凭证号
        ,t1.belongbranch 积分归属机构号
        ,t3.org_nm 积分归属机构名称
        ,t1.transstatus 交易状态
FROM    edw.sirs_pointstransminutes t1 --积分帐户详细记录表，增量表
LEFT JOIN    edw.sirs_transtype t2 --积分交易类型表
ON      t1.transtypeno = t2.TRANSTYPENO
AND     t2.dt = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3 --机构树_考核维度
ON      t1.belongbranch = t3.org_id
AND     t3.dt = '20240930'
left join edw.sirs_customers t4  --客户表
on t1.customersid=t4.customersid
and t4.dt='20240930'
WHERE   t1.dt <= '20240930'
AND     t1.dt >= '20240701'
AND     t1.pointstypeno = '0001' --综合积分
AND     t1.transstatus = 1 --交易正常
AND     t1.reversedflag = 0   --冲正标志正常
--0141 0142 ...到0149，外加0265
and     t1.transtypeno in ('0141','0142','0143','0144','0145','0146','0147','0148','0149','0265')
AND     t1.belongbranch LIKE '3309%'     --嘉兴分行
;

-- SELECT distinct 交易类型,交易类型说明 FROM tmp_hwj_SJ20241008136_03;

SELECT * FROM tmp_hwj_SJ20241008136_03
**01-数据需求_分行_SJ20241010108_嘉兴分行_叶翼_中介客户交易流水明细.sql
--SJ20241010108
--截至2024年10月9日，嘉兴分行客户潘伟伟（客户号1023164748）与嘉兴分行员工交易数据及与嘉兴分行客户交易数据

--字段：序号 交易日期 客户编号 客户名称 客户账号 账户余额 借贷标志 交易金额 摘要描述 交易备注 管户人工号 管护人名称 管户机构名称 对方账号 对方户名 对方金融机构名称

-- 序号 交易日期 员工工号 员工姓名 岗位名称 机构名称 员工关联关系 客户号 证件号 客户账号 账户名称 借贷标识 交易金额 账户余额 对方户名 对方账户 行外账户来源 信贷客户号 信贷客户名称

--1、先找名下的客户账号
CREATE TABLE IF NOT EXISTS tmp_yq_SJ20241010108_01 AS
SELECT cst_id 客户号
,cst_act_id 客户账号
,dep_act_id 存款账户
,act_nm 账户名称
,act_sts_fld 账户状态
,act_sts_cd 存款账户状态代码 --A 正常,C销户
,opn_dt 开户日期
FROM edw.dws_bus_dep_act_inf_dd  --存款账户信息汇总
where dt='20241009'
and cst_id='1023164748'
;

--2、再去客户账号的交易明细
drop TABLE if EXISTS tmp_yq_SJ20241010108_02 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_yq_SJ20241010108_02 AS
SELECT a.dtl_seq_nbr 明细序号
       ,a.trx_dt 交易日期
       ,b.客户号
       ,b.账户名称 as 客户名称
       ,b.客户账号
       ,b.存款账户
       ,b.存款账户状态代码
       ,a.act_bal 账户余额
       ,a.crd_and_dbt_ind 借贷标志
       ,a.trx_amt 交易金额
       ,a.smr_dscr 摘要描述
       ,a.cmt 备注
       ,a.cnt_pty_cst_act_id 对方账号
       ,a.cnt_pty_act_nm 对方户名
       ,a.cnt_pty_fin_instt_nm 对方金融机构名称
       ,c.prm_mgr_id 主管护人工号
       ,c.prm_mgr_nm 主管护人姓名
FROM tmp_yq_SJ20241010108_01 b
left join edw.dwd_bus_dep_bal_chg_dtl_di a   --存款账户余额发生明细
on a.cst_act_id=b.客户账号
and a.dep_act_id=b.存款账户
and  a.dt>='20141127'
left join adm_pub_app.adm_pblc_cst_prm_mng_inf_dd c  --客户主管护
on b.客户号=c.cst_id
and  c.dt='20241011'
;

--3、判断是否我行客户，是否我行员工
--3.1 判断哪些是我行客户
DROP TABLE IF EXISTS tmp_yq_SJ20241010108_03 PURGE;

CREATE TABLE IF NOT EXISTS tmp_yq_SJ20241010108_03 AS
SELECT  cst_id
        ,cst_act_id
FROM    edw.dws_bus_dep_act_inf_dd
WHERE   dt = '20241011'
AND     cst_act_id IN (
                          SELECT  DISTINCT 对方账号
                          FROM    tmp_yq_SJ20241010108_02
                      )
;

--3.2 判断哪些客户是属于我行员工
DROP TABLE IF EXISTS tmp_yq_SJ20241010108_04 PURGE;

CREATE TABLE IF NOT EXISTS tmp_yq_SJ20241010108_04 AS
SELECT  T1.cst_act_id
        ,T2.own_empe_ind  --本行员工标志
FROM tmp_yq_SJ20241010108_03  T1
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T2  --个人客户信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20241011';


--结果表，

DROP TABLE IF EXISTS tmp_yq_SJ20241010108_05 PURGE;

CREATE TABLE IF NOT EXISTS tmp_yq_SJ20241010108_05 AS
SELECT a1.*
       ,case when a3.cst_id is not null then '是' else '否' end as 对方是否我行客户
       ,case when a2.own_empe_ind=1 then '是' else '否'  end as 对方是否我行员工
FROM tmp_yq_SJ20241010108_02 a1
left join tmp_yq_SJ20241010108_04 a2
on a1.对方账号=a2.cst_act_id
left join tmp_yq_SJ20241010108_03 a3
on  a1.对方账号=a3.cst_act_id
;
**01-数据需求_分行_SJ2024101096_湖州分行_赵薇_信贷审批业务清单.sql
--SJ2024101096
--2024年7月26日至2024年10月9日，湖州分行营业部支行行长何建伟004483及湖州长兴支行小企业业务一部陈东010291审批信贷业务的清单

SELECT count(1) FROM tmp_zw_SJ2024101096

DROP TABLE if EXISTS  tmp_zw_SJ2024101096 PURGE ;
create TABLE IF NOT EXISTS  tmp_zw_SJ2024101096 AS
SELECT  cbi.CTR_SERNO
FROM    edw.loan_ctr_bse_inf cbi  --合同基础信息
left JOIN    edw.loan_lmt_aply_biz lab  --用信方案
ON      lab.USC_APLY_SERNO = cbi.REL_SERNO
AND     cbi.REG_TYP = '01'
and lab.dt='20241009'
WHERE   lab.AHN_LTR_APLY_SERNO IN (
                                      SELECT  p.biz_id   --业务流水号
                                      FROM    (
                                                  SELECT  INSTANCE_ID,biz_id,biz_type
                                                  FROM    edw.loan_n_wf_instance nwi  --流程运行实例表
                                                  WHERE  nwi.dt='20241009'
                                                  and  INSTANCE_ID IN (
                                                                             SELECT  INSTANCE_ID
                                                                             FROM    edw.loan_n_wf_user_done nwud   --流程运行实例节点用户已办表
                                                                             WHERE  nwud.dt= '20241009'
                                                                             and USER_ID in ('004483','010291')
                                                                             and substr(nwud.end_time,1,10) between '2024-07-26'  and '2024-10-09'
                                                                         )  --流程实例id
                                                  UNION ALL
                                                  SELECT INSTANCE_ID,biz_id,biz_type
                                                  FROM    edw.loan_n_wf_instance_his nwih   --流程运行实例历史表
                                                  WHERE   INSTANCE_ID IN (
                                                                             SELECT  INSTANCE_ID
                                                                             FROM    edw.loan_n_wf_user_his nwuh  --历史流程运行实例节点用户已办表
                                                                             WHERE   USER_ID in ('004483','010291')
                                                                             and nwuh.dt='20241009'
                                                                             and substr(nwuh.end_time,1,10) between '2024-07-26'  and '2024-10-09'
                                                                         )
                                                  and nwih.dt='20241009'
                                              ) p
                                      WHERE   p.biz_type IN ( 'AHN_LTR_APLY' , 'AHN_LTR_APLY_SIGN' )  --
                                  )
and cbi.dt='20241009'
;
**01-数据需求_分行_SJ2024101171_杭州分行_吴雨伦_创业担保贷款客户营业执照注册时间.sql
-- 表格SHEET1为分行全量经营性授信客户，需批量获取信贷系统中-经营信息-主营企业名称及营业执照登记注册时间；
-- 表格SHEET2为分行全量企业授信客户，需批量获取营业执照登记注册时间；
-- 表格SHEET3为分行全量企业存款日均＞0的对公存款客户，需批量获取柜面开户登记信息中的营业执照登记注册时间

-- 个人：
-- 基本信息：cst_indiv_bsc
-- 经营信息：cst_opr_bsc

-- 对公：
-- 基本信息：cst_corp_bsc
-- 经营信息：cst_opr_bsc
-- 如果对私客户的客户类型是05对私其他或者03个体经营户非持牌的，就要查cst_opr_bsc表用客户号关联
-- 如果是其他对私客户就查cst_rel表里rel_psn_typ = '6'的


---表1,40156条
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yyzz_SJ2024101171_sheet1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yyzz_SJ2024101171_sheet1 AS
SELECT  DISTINCT T1.COL_1        AS 客户号
                 ,T1.COL_2       AS 客户名
                 ,CASE
                    WHEN T2.cst_typ = '01' THEN '企业关系人'
                    WHEN T2.cst_typ = '08' THEN '公务员'
                    WHEN T2.cst_typ = '02' THEN '个体工商户关系人'
                    WHEN T2.cst_typ = '09' THEN '事业单位编制人员'
                    WHEN T2.cst_typ = '04' THEN '其他工薪族'
                    WHEN T2.cst_typ = '07' THEN '个体工商户主'
                    WHEN T2.cst_typ = '03' THEN '个体经营者（非持牌）'
                    WHEN T2.cst_typ = '06' THEN '企业主'
                    WHEN T2.cst_typ = '05' THEN '对私其他'
                  END            AS 客户类型
                 ,T1.COL_5       AS 管户机构名称
                 ,T1.COL_6       AS 管户客户经理工号
                 ,T1.COL_7       AS 管户客户经理名称
                 ,T8.cst_nm      AS 关联企业名称
                 ,T8.cert_isu_dt AS 证件签发日期
                 ,T8.fd_dt       AS 成立日期
                 ,T4.经营项目
                 ,T4.经营起始年份
FROM    qbi_file_20241012_15_00_26 T1
LEFT JOIN    edw.loan_cst_indiv_bsc T2 --个人客户基本信息
ON      T1.COL_1 = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
--如果是其他对私客户就查cst_rel表里rel_psn_typ = '6'--经营企业
LEFT JOIN    edw.loan_cst_rel T3 --关系人信息
ON      T1.COL_1 = T3.cst_id
AND     T3.rel_psn_typ = '6' --经营企业
AND     T2.cst_typ NOT IN ( '03' , '05' )
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_corp_bsc T8 --企业基本信息
ON      T3.rel_cst_id = T8.cst_id
AND     T8.dt = '@@{yyyyMMdd}'
-- 如果对私客户的客户类型是05对私其他或者03个体经营户非持牌的，就要查cst_opr_bsc表用客户号关联
LEFT JOIN    (
                 SELECT  cst_id
                         ,opr_prj      AS 经营项目
                         ,opr_bgn_year AS 经营起始年份
                 FROM    edw.loan_cst_opr_bsc
                 WHERE   DT = '@@{yyyyMMdd}'
             ) T4
ON      T1.COL_1 = T4.cst_id
AND     T2.cst_typ IN ( '03' , '05' )
WHERE   T1.PT <> '';


--表2,7479条
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yyzz_SJ2024101171_sheet2_f PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yyzz_SJ2024101171_sheet2_f AS
SELECT DISTINCT T1.COL_1        AS 客户号
        ,T1.COL_2       AS 客户名
        ,T2.cert_typ    AS 证件类型ID
        ,T3.lookup_item_name as 证件类型名称
        ,T2.cert_no as 证件号码
        ,T2.cert_isu_dt AS 证件签发日期
        ,T2.fd_dt       AS 成立日期
        ,T1.COL_4       AS 管户机构名称
        ,T1.COL_5       AS 管户客户经理工号
        ,T1.COL_6       AS 管户客户经理名称
FROM    qbi_file_20241012_15_01_16 T1
LEFT JOIN    edw.loan_cst_corp_bsc T2
ON      T1.COL_1 = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
left join edw.loan_admin_sm_lookup_dict T3
on T2.cert_typ=T3.lookup_item_code
and T3.dt='@@{yyyyMMdd}'
WHERE   T1.pt <> '';




--表3，36116条,安基葆国际有限公司多一条，因为证件类型，银行swiftbic和银行swift bic


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yyzz_SJ2024101171_sheet3_f PURGE;

CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.tmp_yyzz_SJ2024101171_sheet3_f AS
SELECT  DISTINCT T1.COL_1             AS 客户号
                 ,T1.COL_2            AS 客户名
                 ,T2.cert_typ         AS 证件类型ID
                 ,T3.lookup_item_name AS 证件类型名称
                 ,T2.cert_no          AS 证件号码
                 ,T2.cert_isu_dt      AS 证件签发日期
                 ,T2.fd_dt            AS 成立日期
                 ,T1.COL_4            AS 管户机构名称
                 ,T1.COL_5            AS 管户客户经理工号
                 ,T1.COL_6            AS 管户客户经理名称
FROM    qbi_file_20241012_15_02_07 T1
LEFT JOIN    edw.loan_cst_corp_bsc T2
ON      T1.COL_1 = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_admin_sm_lookup_dict T3
ON      T2.cert_typ = T3.lookup_item_code
AND     T3.dt = '@@{yyyyMMdd}'
WHERE   T1.pt <> '';

-- SELECT * FROM tmp_yyzz_SJ2024101171_sheet3_f WHERE 证件类型名称='银行swiftbic'
**01-数据需求_分行_SJ2024101276_温州分行_卢博赫_温州分行存单质押数据.sql
-- 客户号、客户姓名、存款帐号（子户帐号）、客户存款账户、存单产品（对公、对私的定期、大额存单）、存单期限、管护机构号、管护支行、管护团队、管护客户经理、日均、余额
-- 24年7、8、9月末，温州分行存单质押数据

SELECT * FROM tmp_SJ2024101276_wz_cd_01;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SJ2024101276_wz_cd_01;

CREATE TABLE lab_bigdata_dev.tmp_SJ2024101276_wz_cd_01 AS
SELECT  T2.dt                                                               AS 数据日期
        ,T2.cst_id                                                          AS 客户号
        ,T2.act_nm                                                          AS 客户姓名
        ,T2.cst_act_id                                                      AS 客户账号
        ,T2.dep_act_id                                                      AS 存款账号
        ,T8.pd_cmt                                                          AS 存单产品
        ,T2.dep_trm                                                         AS 存期
        ,T4.acs_org_id                                                      AS 管护机构号
        ,T5.org_nm                                                          AS 管护机构名
        ,T5.sbr_org_nm                                                      AS 管护支行
        ,T5.tem_org_nm                                                      AS 管护团队
        ,T4.mgr_id                                                          AS 管护人工号
        ,NVL(T6.empe_nm, '')                                                AS 管护客户经理
        ,T2.gl_bal * T3.AVG_PRC / T3.QUO_UNT                                AS 余额
        ,T2.act_mth_acm_bal * T3.AVG_PRC / T3.QUO_UNT / SUBSTR(T2.DT, 7, 2) AS 月日均
-- ,T2.act_year_acm_bal*T3.AVG_PRC / T3.QUO_UNT /(DATEDIFF(TO_DATE(T2.dt,'yyyymmdd'),to_date('20231231','yyyymmdd'),'dd')) as 年日均
FROM    edw.dws_bus_dep_act_inf_dd T2 --存款账户信息汇总
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD T3 --汇率信息
ON      T2.CCY_CD = T3.CCY_CD
AND     T2.dt = T3.dt
AND     T3.DT IN ( '20240731' , '20240831' , '20240930' )
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T4 --客户存款账户管护信息
ON      T2.cst_act_id = T4.cst_act_id
AND     T2.dt = T4.dt
AND     T4.DT IN ( '20240731' , '20240831' , '20240930' )
AND     T4.frs_ctc_ind = '1'
 --第一联系人标志
-- AND     T4.act_rel_chr_cd <> '6' --剔除资源性存款
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T4.acs_org_id = T5.org_id
AND     T4.dt = T5.dt
AND     T5.DT IN ( '20240731' , '20240831' , '20240930' )
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T4.mgr_id = T6.empe_id
AND     T4.dt = T6.dt
AND     T6.DT IN ( '20240731' , '20240831' , '20240930' )
INNER JOIN    (
                  SELECT  dt
                          ,act_id
                  FROM    edw.dim_bus_loan_cltr_dep_cert_spcl_dd --贷款客户押品存单专项信息
                  WHERE   DT IN ( '20240731' , '20240831' , '20240930' )
                  GROUP BY dt , act_id
              ) T7
ON      T2.cst_act_id = T7.act_id
AND     T2.dt = T7.dt
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd T8 --存款产品
ON      T2.prod_id = T8.pd_id
AND     T2.dt = T8.dt
AND     T8.dt IN ( '20240731' , '20240831' , '20240930' )
WHERE   T2.DT IN ( '20240731' , '20240831' , '20240930' )
AND     T2.prod_id IN ( '00202040100' , '00201040100' , '00201020100' , '00201020105','00202020100') --单位大额存单,个人大额存单,个人整存整取,新成长乐,单位定期
AND     T5.brc_org_id = '330599999'   --温州分行
;
**01-数据需求_分行_SJ20241014101_杭州分行_方安君_信贷管理系统中杭州分行合同信息查询.sql
-- 因新系统上线，信贷管理系统中合同信息查询无法全量导出数据（一次只能导出2万条），我分行需要向国金局浙江局报送三季度7-9月新增十大授信客户表

-- 截止2024年9月30日，数据范围为2024年7月1日-20249月30日，信贷管理系统中杭州分行合同信息查询，时间为2024年7月1日-20249月30日。

--字段：客户编号	客户名称	业务品种	合同金额	合同金额	合同起始日	合同到期日	授信总金额 发放金额  发放金额折人民币

--按照核算机构取，21896，按照管护取21790
DROP TABLE IF EXISTS tmp_faj_SJ20241014101 PURGE;

CREATE TABLE IF NOT EXISTS tmp_faj_SJ20241014101 AS
SELECT  cb.cst_id 客户编号
        ,cb.cst_nm 客户名称
        ,cb.prd_no 产品编码
        ,pf.pd_nm 产品名称
        ,cb.ctr_serno 合同号
        ,cb.ctr_amt 合同金额
        ,cb.ctr_bal 合同余额
        ,cb.ctr_bgn_dt 合同起始日
        ,cb.ctr_mtu_dt 合同到期日
        ,T3.dbil_id 借据号
        ,T3.dtrb_dt 发放日期
        ,T3.amt 发放金额
        ,T3.amt * T4.cny_exr AS 发放金额折人民币
        ,CASE
           WHEN cb.ctr_sts_cd = 2 THEN '正常'
           WHEN cb.ctr_sts_cd = 4 THEN '冻结'
           WHEN cb.ctr_sts_cd = 1 THEN '未生效'
           WHEN cb.ctr_sts_cd = 3 THEN '终止'
           WHEN cb.ctr_sts_cd = 5 THEN '作废'
         END                    AS 合同状态
        ,cb.tmt_dt 终结日期
FROM    edw.dim_bus_loan_ctr_bse_inf_dd cb
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD pf --产品
ON      cb.prd_no = pf.prd_no
AND     pf.dt = '20240930'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd T3 --贷款借据信息汇总
ON      cb.ctr_serno = T3.bus_ctr_id
AND     T3.dt = '20240930'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd T4 --汇率
ON      T3.ccy_cd = T4.ccy_cd
AND     T4.dt = '20240930'
WHERE   cb.dt = '20240930'
AND     cb.ctr_bgn_dt >= '20240701'
AND     cb.ctr_bgn_dt <= '20240930'
AND     T3.dtrb_dt >= '20240701'
AND     T3.dtrb_dt <= '20240930'
--  未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( cb.CTR_STS_CD IN ( '2' , '4' )
AND     cb.TMT_DT = '18991231'
AND     to_date(cb.CTR_MTU_DT, 'yyyyMMdd') >= to_date(cb.DT, 'yyyyMMdd') )
    OR cb.CTR_BAL > 0 )
AND     T3.act_org_id LIKE '3302%'  --杭州分行
;


SELECT * FROM tmp_faj_SJ20241014101
**01-数据需求_分行_SJ2024101416_宁波分行_金如意_全量贷款清单中涉及贸易融资以及泰e贷等各角色审批流程.sql
-- SJ2024101416
-- 数据日期：2024.9.30；数据范围：宁波分行全量贷款清单中涉及贸易融资以及泰e贷等各角色审批流程（客户经理、部门负责人、支行行长）

--字段：合同流水号、业务品种、经办客户经理、经办部门负责人、经办支行行长

--1、2泰e贷，走小鱼管家预授信查询,用方案编号关联信贷系统的表。小鱼管家数据未迁移到信贷，无法提取

--从小鱼管家取20240719之前的泰e贷数据
-- DROP TABLE IF EXISTS tmp_jry_SJ2024101416_ted_20240719 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_jry_SJ2024101416_ted_20240719 AS
-- SELECT  t.contract_no  方案编号
--         ,el.cust_no   客户号
--         ,t.app_state         AS 状态   --状态 1-未审批 2-审批中 3-审批通过 4-审批否决 5 审批退回 6：未审批（退回修改）
--         ,t.approve_time      AS 提交或审批时间  --（提交）审批时间
--         ,t.approve_employ_no AS 提交或审批人工号
--         -- ,t.approve_employ_role_no as approve_employ_role_no   --（提交）审批人角色号
--         ,e.employ_name       AS 员工名称
--         ,concat(t.approve_employ_no,e.employ_name) 提交人
--         -- ,t.APPROVE_OPINION   AS 审批意见  --审批意见
--         ,t.nest_cust_no      AS 下一审批人工号
--         ,em.employ_name      AS 下一审批人工号
--         ,CONCAT(t.nest_cust_no,em.employ_name) AS 下一审批人
--         -- ,e.org_id 机构号
-- FROM    edw.xwdt_xw_loan_approval_history t --预授信审批历史表
-- LEFT JOIN    edw.xwdt_xw_employ e  --员工表
-- ON      e.employ_no = t.approve_employ_no
-- and e.dt='@@{yyyyMMdd}'
-- LEFT JOIN    edw.xwdt_xw_employ em
-- ON      t.nest_cust_no = em.employ_no
-- and em.dt='@@{yyyyMMdd}'
-- inner JOIN    edw.xwdt_xw_e_loan_approval el  --泰E贷方案信息表
-- ON      t.contract_no = el.id
-- and el.dt='@@{yyyyMMdd}'
-- WHERE  t.dt='@@{yyyyMMdd}'
-- and el.id IS NOT NULL
-- and e.org_id like '3303%'  --宁波分行
-- ORDER BY t.CONTRACT_NO , t.approve_time DESC
-- ;



--2、贸易贷，走信贷系统查询，需要老信贷和新信贷的数据拼起来。

--合同流水号、业务品种、经办客户经理、经办部门负责人、经办支行行长
--2.1 老信贷的贸易贷_20240719

--先取主合同和主合同对应的申请流水

--DROP TABLE IF EXISTS tmp_zhuhetonghao_SJ2024101416_20240719 PURGE;
--
--CREATE TABLE IF NOT EXISTS tmp_zhuhetonghao_SJ2024101416_20240719 AS
--SELECT  a.col_1              AS 虚拟合同号
--        ,A.COL_2             AS 客户名称
--        ,a.pd_nm             AS 虚拟合同对应的业务
--        ,a.relativeagreement AS 主合同号
--        -- ,''                  AS 主合同对应的业务
--        ,b.relativeserialno  AS 主合同对应的申请流水号
--FROM    (
--            SELECT  t1.COL_1 --合同号
--                    ,T1.COL_2
--                    ,t2.relativeagreement --主合同号
--                    ,t3.pd_nm
--            FROM    qbi_file_20241018_18_00_04 t1
--            INNER JOIN    edw.loan_business_contract t2
--            ON      t1.COL_1 = t2.serialno
--            AND     t2.dt = '20240719'
--            LEFT JOIN    edw.dim_bus_loan_pd_inf_dd t3
--            ON      t2.businesstype = t3.pd_cd
--            AND     t3.dt = '20240719'
--            WHERE   t1.pt <> ''
--        ) a
--LEFT JOIN    edw.loan_business_contract b
--ON      a.relativeagreement = b.serialno
--AND     b.dt = '20240719'
--UNION
--SELECT  a.col_1            AS 虚拟合同号
--        ,A.COL_2           AS 客户名称
--        ,a.prd_nm          AS 虚拟合同对应的业务
--        ,a.rel_main_ctr_no AS 主合同号
--        -- ,b.prd_nm          AS 主合同对应的业务
--        ,b.rel_serno       AS 主合同对应的申请流水号
--FROM    (
--            SELECT  t1.COL_1 --合同号
--                    ,T1.COL_2
--                    ,t2.rel_main_ctr_no --主合同号
--                    ,t2.prd_nm
--            FROM    qbi_file_20241018_18_00_04 t1
--            INNER JOIN    edw.loan_ctr_bse_inf t2
--            ON      t1.COL_1 = t2.ctr_serno
--            AND     t2.dt = '20240930'
--            WHERE   t1.pt <> ''
--        ) a
--LEFT JOIN    edw.loan_ctr_bse_inf b   --合同基础信息
--ON      a.rel_main_ctr_no = b.ctr_serno
--and     b.reg_typ='01'       --   用信申请
--AND     b.dt = '20240930';


DROP TABLE IF EXISTS tmp_zhuhetonghao_SJ2024101416_20240719 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zhuhetonghao_SJ2024101416_20240719 AS
SELECT  a.col_1            AS 虚拟合同号
        ,A.COL_2           AS 客户名称
        ,a.prd_nm          AS 虚拟合同对应的业务
        ,a.rel_main_ctr_no AS 主合同号
        -- ,b.prd_nm          AS 主合同对应的业务
        ,COALESCE(b.rel_serno,B1.relativeserialno)       AS 主合同对应的申请流水号
FROM    (
            SELECT  t1.COL_1 --合同号
                    ,T1.COL_2
                    ,COALESCE(t2.rel_main_ctr_no,T21.relativeagreement) AS rel_main_ctr_no  --主合同号
                    ,COALESCE(t2.prd_nm,T3.pd_nm) AS  prd_nm
            FROM    qbi_file_20241018_18_00_04 t1
            LEFT JOIN    edw.loan_ctr_bse_inf t2
            ON      t1.COL_1 = t2.ctr_serno
            AND     t2.dt = '20240930'
            LEFT JOIN    edw.loan_business_contract t21
            ON      t1.COL_1 = t21.serialno
            AND     t21.dt = '20240719'
            LEFT JOIN    edw.dim_bus_loan_pd_inf_dd t3
            ON      t21.businesstype = t3.pd_cd
            AND     t3.dt = '20240719'
            WHERE   t1.pt <> ''
        ) a
LEFT JOIN    edw.loan_ctr_bse_inf b   --合同基础信息
ON      a.rel_main_ctr_no = b.ctr_serno
and     b.reg_typ='01'       --   用信申请
AND     b.dt = '20240930'
LEFT JOIN    edw.loan_business_contract b1
ON      a.rel_main_ctr_no = b1.serialno
AND     b1.dt = '20240719'
;


---20240719的贸易贷流程表,泰e贷在小鱼管家，无法取


DROP TABLE IF EXISTS tmp_jry_SJ2024101416_myd_2024071911 PURGE;

CREATE TABLE IF NOT EXISTS tmp_jry_SJ2024101416_myd_2024071911 AS
SELECT  distinct  A.虚拟合同号
                  ,A.客户名称
                  ,A.虚拟合同对应的业务
                  ,A.主合同号
                  ,A.主合同对应的申请流水号
                --  ,A.审批时间
                  ,A.客户经理ID
                  ,D.empe_nm AS 客户经理
                  ,concat(A.客户经理ID,D.empe_nm) 经办客户经理
                  ,A.部门负责人ID AS 部门负责人id
                  ,B.empe_nm 部门负责人
                  ,concat(A.部门负责人ID,B.empe_nm) as 经办部门负责人
                  ,A.支行行长ID as 支行行长id
                  ,c.empe_nm 支行行长
                  ,CONCAT(A.支行行长ID,c.empe_nm) as 经办支行行长
FROM    (
            SELECT  t2.*
                   -- ,t1.endtime 审批时间
                    ,MAX(CASE
                       WHEN t1.phasename LIKE '%客户经理%' THEN substr(t1.userid,1,6)
                     END) AS 客户经理ID
                    ,MAX(CASE
                       WHEN t1.phasename LIKE '%部门总经理%' THEN substr(t1.userid,1,6)
                     END) AS 部门负责人ID
                    ,MAX(CASE
                       WHEN t1.phasename LIKE '%支行行长%' THEN substr(t1.userid,1,6)
                     END) AS 支行行长ID
            FROM    edw.loan_flow_task t1 --流程任务,数据只到20240719
            inner JOIN    tmp_zhuhetonghao_SJ2024101416_20240719 t2
            ON      t1.objectno = t2.主合同对应的申请流水号
            WHERE   t1.dt = '20240719'
            AND     t1.orgid LIKE '3303%'    --宁波分行
            AND     t1.phasename RLIKE '客户经理|部门总经理|支行行长'
	    GROUP BY T2.虚拟合同号,T2.客户名称,T2.虚拟合同对应的业务,T2.主合同号,T2.主合同对应的申请流水号
        ) A
LEFT JOIN    edw.dws_hr_empe_inf_dd B
ON      部门负责人ID = B.empe_id
AND     B.dt = '20240719'
LEFT JOIN    edw.dws_hr_empe_inf_dd c
ON      支行行长ID = c.empe_id
AND     C.dt = '20240719'
LEFT JOIN    edw.dws_hr_empe_inf_dd d
ON      客户经理ID = d.empe_id
AND     d.dt = '20240719'
;

--2.2 新信贷系统的贸易融资和泰e贷，数据从20240720开始至今


DROP TABLE IF EXISTS tmp_jry_SJ2024101416_03 PURGE;

CREATE TABLE IF NOT EXISTS tmp_jry_SJ2024101416_03 AS
SELECT distinct T.虚拟合同号
                ,t.usc_aply_serno 用信申请流水号
                ,T.虚拟合同对应的业务
                ,nwc.start_time 审批时间
                ,nwc.user_id 用户ID
                ,nwc.node_name 审批节点
                ,nwc.user_name 审批人
FROM    (
            SELECT  p.instance_id
                    ,p.biz_id ---授用信申请流水号
                    ,lab2.usc_aply_serno --用信申请流水号
                    ,cbi.虚拟合同号
                    ,cbi.客户名称
                    ,cbi.虚拟合同对应的业务
            FROM    tmp_zhuhetonghao_SJ2024101416_20240719 cbi
            LEFT JOIN    edw.loan_lmt_aply_biz lab2 --用信方案 --全量表
            ON      lab2.usc_aply_serno = cbi.主合同对应的申请流水号
            AND     lab2.dt = '20240930'
            AND     lab2.DEL_IND = '0' --否
            LEFT JOIN    (
                             SELECT  instance_id --流程id
                                     ,biz_id ----业务流水号即授用信申请流水号
                                     ,biz_type --业务类型
                             FROM    edw.loan_n_wf_instance nwi
                             WHERE   nwi.org_id LIKE '3303%'
                             AND     nwi.dt = '20240930'
                             UNION ALL
                             SELECT  instance_id
                                     ,biz_id
                                     ,biz_type
                             FROM    edw.loan_n_wf_instance_his nwih --全量表
                             WHERE   nwih.org_id LIKE '3303%'
                             AND     nwih.dt = '20240930'
                         ) p
            ON      lab2.AHN_LTR_APLY_SERNO = p.biz_id
            WHERE   p.biz_type IN ( 'AHN_LTR_APLY' , 'AHN_LTR_APLY_SIGN' )   --授用信申请、单笔用信申请
        ) T
LEFT JOIN    edw.loan_n_wf_comment nwc --流程意见表 --增量表
ON      nwc.instance_id = T.instance_id
AND     nwc.dt <= '20240930';









--林宇航给的代码
-- 新信贷
-- select * from n_wf_instance a
-- left join n_wf_comment b on a.INSTANCE_ID = b.INSTANCE_ID
-- left join loan_biz.lmt_aply_biz c on a.BIZ_ID = C.ahn_ltr_aply_serno
-- where flow_id ='195' AND C.ahn_ltr_aply_serno like 'CUCN%' and c.prd_no in ('贸易融资产品')

-- node_name
-- 【分行产品复核岗】
-- 【总行产品维护岗】
-- 一级支行行长
-- 业务授权技术配置岗
-- 业务支行副行长
-- 二级支行行长
-- 二级支行行长、支行行长
-- 二级支行行长、支行行长、总行营业部总经理
-- 交出方-团队总经理
-- 交出方-客户经理
-- 交出方-支行行长
-- 交出方分行普惠金融部授信审查岗
-- 交出方团队总经理
-- 交出方支行行长
-- 借款人管户客户经理
-- 借款人管户客户经理的团队总经理
-- 分行/总行同业业务交易员
-- 分行业务主管部门负责人
-- 分行业务授权配置岗
-- 分行人员授权配置岗
-- 分行人民币利率配置岗
-- 分行副行长
-- 分行国际业务利率管理岗
-- 分行国际业务部总经理
-- 分行审查岗
-- 分行小企业主审岗
-- 分行小企业初审岗
-- 分行小企业初（主）审岗
-- 分行小企业部信审科经理
-- 分行小企业部副总经理
-- 分行小企业部审查岗
-- 分行小企业部总经理
-- 分行小企业部授信主审岗
-- 分行小企业部授信初审岗
-- 分行小企业部授信审查岗
-- 分行征信管理员
-- 分行担保管理员
-- 分行普惠审查岗
-- 分行普惠部总经理
-- 分行普惠金融部信审科经理
-- 分行普惠金融部副总经理
-- 分行普惠金融部审查岗
-- 分行普惠金融部总经理
-- 分行普惠金融部授信审查岗
-- 分行票据管理岗
-- 分行行长
-- 分行资质审查岗
-- 分行资质审查岗（分行普惠部）
-- 分行资质审查岗（村行市场部）
-- 分行风险管理岗
-- 分行风险管理岗、分行普惠金融部授信审查岗
-- 分行风险管理部总经理
-- 分行风险经理
-- 分行风险部总经理
-- 团队审查岗
-- 团队审查岗（可选）
-- 团队总经理
-- 团队负责人
-- 团队长
-- 客户经理
-- 客户经理/服务经理
-- 客户经理1发起
-- 客户经理及发起人发起
-- 客户经理发起
-- 小企业分行业务主管部门审查岗（主审）
-- 小企业分行业务主管部门审查岗（初审）
-- 小企业分行业务主管部门负责人
-- 小企业团队审查岗
-- 小企业团队负责人
-- 总行业务部门总经理
-- 总行产品复核岗
-- 总行人员授权配置岗
-- 总行小企业部审批中心主任
-- 总行小企业部总经理
-- 总行小企业部授信主审岗
-- 总行小企业部授信初审岗
-- 总行普惠金融部审查岗
-- 总行科技企业审查岗
-- 总行风险管理岗
-- 总行风险管理部信用风险审查岗
-- 接收方-分行小企业部授信主审岗
-- 接收方-分行小企业部授信初审岗
-- 接收方-分行普惠金融部授信审查岗
-- 接收方-团队总经理
-- 接收方-客户经理
-- 接收方团队总经理
-- 接收方客户经理
-- 接收方总行营业部-团队总经理
-- 支行专职审查岗
-- 支行行长
-- 支行行长、二级支行行长、总行营业部总经理
-- 普惠分行业务主管部门负责人
-- 普惠团队负责人
-- 村行副行长
-- 村行团队负责人
-- 村行市场部审查岗
-- 村行市场部总经理
-- 村行市场部负责人
-- 村行执行董事
-- 村行行长
-- 村行资质审查岗
-- 村行风险管理岗
-- 村行风险管理部总经理
-- 村行风险经理
-- 村行风险经理岗
-- 流程发起者
-- 管户人
-- 管户人批准
-- 经办人申请
-- 综合岗
-- 部门负责人













--陈鹏给的表，不是按照业务的规则来加工的不能用
-- DROP TABLE IF EXISTS tmp_jry_SJ2024101416 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_faj_SJ2024101416 AS
-- SELECT  cbi.ctr_serno AS 合同流水号
--         ,T4.pd_nm     AS 业务品种
--         ,T1.opr_user_nm 经办客户经理名称
--         ,T1.opr_org_chger_id 经办部门负责人工号1
--         ,T1.opr_org_chger_nm 经办部门负责人名称1
--         ,T1.opr_org_chger_id2 经办部门负责人工号2
--         ,T1.opr_org_chger_nm2 经办部门负责人名称2
--         ,T1.pr_apv_flg 是否经办行长审批
--         ,T1.opr_pr_user_id 经办管理支行行长工号1
--         ,T1.opr_pr_user_nm 经办管理支行行长名称1
--         ,T1.opr_pr_user_id2 经办管理支行行长工号2
--         ,T1.opr_pr_user_nm2 经办管理支行行长名称2
--         ,T1.rvw_stage 审批阶段
-- FROM    adm_rsk.ADM_RSK_APL_AST_APL_FLOW_INF_DD T1 ----风险集市应用表-INTER表底层信贷审批流程表
-- LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd cbi --合同基础信息
-- ON      T1.apl_srl_no = cbi.rel_serno
-- AND     cbi.dt = '20240930'
-- LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T4 --产品信息
-- ON      cbi.PRD_NO = T4.prd_no
-- AND     T4.DT = '20240930'
-- WHERE   T1.dt = '20240930'
-- AND     T1.opr_org_id LIKE '3303%'  --宁波分行
-- --  未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
-- AND     ( ( cbi.CTR_STS_CD IN ( '2' , '4' )
-- AND     cbi.TMT_DT = '18991231'
-- AND     to_date(cbi.CTR_MTU_DT, 'yyyyMMdd') >= to_date(cbi.DT, 'yyyyMMdd') )
--     OR cbi.CTR_BAL > 0 )
-- AND     ( cbi.PRD_NO LIKE '1003%' --贸易融资
--     OR cbi.PRD_NO IN ( '2001010101002' , '2001020101002' ) )--泰E贷
-- ;
**01-数据需求_分行_SJ2024101506_蒋泽宇_上海分行_报送2024年上海银行业无缝续贷统计表.sql
--报送2024年上海银行业无缝续贷统计表
--SJ2024101506
--借据流水号、合同流水号、客户编号	客户名称、企业规模、是否个体工商户或小微企业、是否自助循环、业务品种、营销标签、发生类型	关联交易类型、币种、合同起始、合同到期日、贷款金额(元)、贷款余额(元）
--借据到期日	借据起息日	上一笔业务结清日	利率(&permil;)	行业投向代码	行业投向名称	主要担保方式	管户人工号	管户人	管户机机构号	管户机构

--说明：非循环贷款当天结清当天发放的，非循环贷款的借据结清即合同终止


------------2024年1-X月结清贷款清单
DROP TABLE IF EXISTS temp_yxd_20240930_1 PURGE ;
CREATE TABLE IF NOT EXISTS temp_yxd_20240930_1 AS
SELECT  DISTINCT t2.dbil_id 借据流水号
                 ,t1.ctr_serno 合同流水号
                 ,t2.cst_id 客户编号
                 --,t2.cst_nm 客户名称
                 ,CASE
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'B'                                    THEN '大型企业'
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'M'                                    THEN '中型企业'
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                                    THEN '小型企业'
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                                    THEN '微型企业'
                    WHEN ( ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' ) OR ( c.cust_typ = '3' ) ) THEN '个体工商户' --对公对私均有个体工商户
                    WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                                 THEN '小微企业主'
                    WHEN b.operate_cust_type_cbrc = 'C'                                                                       THEN '其他个人经营性客户'
                  END   AS 企业规模
                 ,CASE
                    WHEN ( ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' ) OR ( c.cust_typ = '3' ) ) THEN '个体工商户'
                    WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                                 THEN '小微企业主'
                    ELSE '否'
                  END 是否个体工商户或小微企业主
                 --case when t1.crc_ind='1' then '是' else '否' end 是否循环,
                 ,CASE
                    WHEN t1.RVLG_TYP_CD = '1' THEN '是'
                    ELSE '否'
                  END 是否自助循环
                 ,t4.pd_nm 业务品种
                 ,t1.prd_tag_nm 营销标签
            --      ,t3.cd_val_dscr 营销标签
                 ,t5.cd_val_dscr 发生类型
                 ,CASE
                    WHEN t1.REL_TRX_TYP_CD = '1' THEN '一般关联交易'
                    WHEN t1.rel_trx_typ_cd = '2' THEN '重大关联交易'
                    WHEN t1.rel_trx_typ_cd = '3' THEN '非关联交易'
                  END 关联交易类型
                 ,'人民币' AS 币种
                 ,t1.CTR_BGN_DT 合同起始日
                 ,t1.CTR_MTU_DT 合同到期日
                 ,( T1.ctr_amt * T6.AVG_PRC ) / T6.QUO_UNT 贷款金额元
                 ,( T1.ctr_bal * T6.AVG_PRC ) / T6.QUO_UNT 贷款余额元
                 ,t2.APNT_MTU_DT 借据到期日
                 ,t2.LVE_ACT_BGN_DT 借据起息日
                 ,t1.TMT_DT 结清日
                 ,t2.EXEC_INTR_RAT 利率
                 ,t1.inv_in_indy_cd 行业投向代码
                 ,t7.cd_val_dscr 行业投向名称
                 ,CASE
                    WHEN t1.GRNT_MOD_COLC = '005' THEN '信用'
                    WHEN t1.GRNT_MOD_COLC = '010' THEN '保证'
                    WHEN t1.GRNT_MOD_COLC = '020' THEN '抵押'
                    WHEN t1.GRNT_MOD_COLC = '040' THEN '质押'
                  END 主要担保方式
                 ,t8.mgr_id 管户人工号
                 ,t9.empe_nm 管户人
                 ,t8.mgr_org_id 管户机机构号
                 ,t10.org_nm 管户机构
FROM    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd t2 --信贷借据信息
ON      t1.ctr_serno = t2.ctr_serno
AND     t2.dt = '20240930'
LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
ON      t1.cst_id = b.cust_id
AND     b.dt = '20240930'
LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
ON      t1.cst_id = c.cust_id
AND     c.dt = '20240930'
LEFT JOIN    (
                 SELECT  DISTINCT cust_id
                                  ,acct_typ
                 FROM    adm_upss.l_acct_loan --贷款借据信息表
                 WHERE   dt = '20240930'
                 AND     substr(acct_typ, 1, 4) = '0102' --经营性
             ) d
ON      t1.cst_id = d.cust_id
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD t4 --产品信息
ON      t1.prd_no = t4.prd_no
AND     t4.dt = '20240930'
-- LEFT JOIN    edw.dwd_code_library_dd t3 --码值表
-- ON      t1.prd_tag = t3.cd_val
-- AND     t3.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
-- AND     t3.fld_nm = 'prd_tag'
-- AND     t3.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd t5 --码值表
ON      t1.HPN_TYP_CD = t5.cd_val
AND     t5.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND     t5.fld_nm = 'HPN_TYP_CD'
AND     t5.DT = '20240930'
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD t6 ----汇率
ON      T6.CCY_CD = t1.bsn_ccy_cd
AND     T6.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd t7 --码值表
ON      t1.inv_in_indy_cd = t7.cd_val
AND     t7.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'  --合同表
AND     t7.fld_nm = upper('inv_in_indy_cd')   --行业投向
AND     t7.DT = '20240930'
LEFT JOIN    edw.DWD_BUS_LOAN_CTR_MGR_INF_DD t8 --信贷合同管护信息
ON      t8.ctr_serno = t1.ctr_serno
AND     t8.dt = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd t9 --员工汇总信息
ON      t8.MGR_ID = t9.empe_id
AND     t9.dt = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t10 --机构树
ON      t10.org_id = t8.mgr_org_id
AND     t10.dt = '20240930'
WHERE   t1.dt = '20240930'
--and t4.pd_nm like '%经营性%'     --经营性贷款
AND     t1.RVLG_TYP_CD <> '1' --非循环
AND     t1.prd_no NOT in ('2001010101003','2001020101003')  --剔除随贷通
AND     t1.TMT_DT >= '20240101'
AND     t1.TMT_DT <= '20240930' --2024年1-X月结清
AND     t8.mgr_org_id LIKE '3101%'  --上海分行
;


--2024年1-X月续贷清单
DROP TABLE IF EXISTS temp_xd_041415 PURGE ;
CREATE TABLE IF NOT EXISTS temp_xd_041415 AS
SELECT  DISTINCT t2.dbil_id 借据流水号
                 ,t1.ctr_serno 合同流水号
                 ,t2.cst_id 客户编号
                 --,t2.cst_nm 客户名称
                 ,CASE
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'B'                                    THEN '大型企业'
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'M'                                    THEN '中型企业'
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                                    THEN '小型企业'
                    WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                                    THEN '微型企业'
                    WHEN ( ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' ) OR ( c.cust_typ = '3' ) ) THEN '个体工商户' --对公对私均有个体工商户
                    WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                                 THEN '小微企业主'
                    WHEN b.operate_cust_type_cbrc = 'C'                                                                       THEN '其他个人经营性客户'
                  END   AS 企业规模
                 ,CASE
                    WHEN ( ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' ) OR ( c.cust_typ = '3' ) ) THEN '个体工商户'
                    WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                                 THEN '小微企业主'
                    ELSE '否'
                  END 是否个体工商户或小微企业主
                 --case when t1.crc_ind='1' then '是' else '否' end 是否循环,
                 ,CASE
                    WHEN t1.RVLG_TYP_CD = '1' THEN '是'
                    ELSE '否'
                  END 是否自助循环
                 ,t4.pd_nm 业务品种
            --      ,t3.cd_val_dscr 营销标签
                 ,t1.prd_tag_nm 营销标签
                 ,t5.cd_val_dscr 发生类型
                 ,CASE
                    WHEN t1.rel_trx_typ_cd = '1' THEN '一般关联交易'
                    WHEN t1.rel_trx_typ_cd = '2' THEN '重大关联交易'
                    WHEN t1.rel_trx_typ_cd = '3' THEN '非关联交易'
                  END 关联交易类型
                 ,'人民币' AS 币种
                 ,t1.CTR_BGN_DT 合同起始日
                 ,t1.CTR_MTU_DT 合同到期日
                 ,( T1.ctr_amt * T6.AVG_PRC ) / T6.QUO_UNT 贷款金额元
                 ,( T1.ctr_bal * T6.AVG_PRC ) / T6.QUO_UNT 贷款余额元
                 ,t2.APNT_MTU_DT 借据到期日
                 ,t2.LVE_ACT_BGN_DT 借据起息日
                 ,t1.TMT_DT 结清日
                 ,t2.EXEC_INTR_RAT 利率
                 ,t1.inv_in_indy_cd 行业投向代码
                 ,t7.cd_val_dscr 行业投向名称
                 ,CASE
                    WHEN t1.GRNT_MOD_COLC = '005' THEN '信用'
                    WHEN t1.GRNT_MOD_COLC = '010' THEN '保证'
                    WHEN t1.GRNT_MOD_COLC = '020' THEN '抵押'
                    WHEN t1.GRNT_MOD_COLC = '040' THEN '质押'
                  END 主要担保方式
                 ,t8.mgr_id 管户人工号
                 ,t9.empe_nm 管户人
                 ,t8.mgr_org_id 管户机机构号
                 ,t10.org_nm 管户机构
FROM    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd t2 --信贷借据信息
ON     t1.ctr_serno = t2.ctr_serno
AND     t2.dt = '20240930'
LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
ON      t1.cst_id = b.cust_id
AND     b.dt = '20240930'
LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
ON      t1.cst_id = c.cust_id
AND     c.dt = '20240930'
LEFT JOIN    (
                 SELECT  DISTINCT cust_id
                                  ,acct_typ
                 FROM    adm_upss.l_acct_loan --贷款借据信息表
                 WHERE   dt = '20240930'
                 AND     substr(acct_typ, 1, 4) = '0102' --经营性
             ) d
ON      t1.cst_id = d.cust_id
LEFT JOIN   edw.DIM_BUS_LOAN_PRD_FRML_DD t4 --产品信息
ON      t1.prd_no = t4.prd_no
AND     t4.dt = '20240930'
-- LEFT JOIN    edw.dwd_code_library_dd t3 --码值表
-- ON      t1.BUS_LAB_CD = t3.cd_val
-- AND     t3.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
-- AND     t3.fld_nm = 'BUS_LAB_CD'
-- AND     t3.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd t5 --码值表
ON      t1.HPN_TYP_CD = t5.cd_val
AND     t5.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND     t5.fld_nm = 'HPN_TYP_CD'
AND     t5.DT = '20240930'
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD t6 ----汇率
ON      T6.CCY_CD = T1.bsn_ccy_cd
AND     T6.DT = '20240930'
LEFT JOIN    edw.dwd_code_library_dd t7 --码值表
ON      t1.inv_in_indy_cd = t7.cd_val
AND     t7.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND     t7.fld_nm = upper('inv_in_indy_cd')
AND     t7.DT = '20240930'
LEFT JOIN    edw.DWD_BUS_LOAN_CTR_MGR_INF_DD t8 --信贷合同管护信息
ON      t8.ctr_serno = t1.ctr_serno
AND     t8.dt = '20240930'
LEFT JOIN    edw.dws_hr_empe_inf_dd t9 --员工汇总信息
ON      t8.MGR_ID = t9.empe_id
AND     t9.dt = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t10 --机构树
ON      t10.org_id = t8.mgr_org_id
AND     t10.dt = '20240930'
WHERE   t1.dt = '20240930'
--and t4.pd_nm like '%经营性%'     --经营性贷款
AND     t1.RVLG_TYP_CD <> '1' --非循环
AND     t1.prd_no NOT in ('2001010101003','2001020101003')
AND     t2.LVE_ACT_BGN_DT >= '20240101'
AND     t2.LVE_ACT_BGN_DT <= '20240930' --2024年1-X月续贷
AND     t8.mgr_org_id LIKE '3101%'  --上海分行
;

---------结果表 ，发放日等于上一笔结清日

DROP TABLE IF EXISTS tmp_jzy_SJ2024101506_01 PURGE ;

CREATE TABLE IF NOT EXISTS tmp_jzy_SJ2024101506_01 AS
SELECT  a.借据流水号
        ,a.合同流水号
        ,a.客户编号  ---/*a.客户名称,*/
        ,a.企业规模
        ,a.是否个体工商户或小微企业主
        ,a.是否自助循环
        ,a.业务品种
        ,a.营销标签
        ,a.发生类型
        ,a.关联交易类型
        ,a.币种
        ,a.合同起始日
        ,a.合同到期日
        ,a.贷款金额元
        ,a.贷款余额元
        ,a.借据到期日
        ,a.借据起息日
        ,b.结清日 as 上一笔业务结清日
        ,a.利率
        ,a.行业投向代码
        ,a.行业投向名称
        ,a.主要担保方式
        ,a.管户人工号
        ,a.管户人
        ,a.管户机机构号
        ,a.管户机构
FROM    temp_xd_041415 a
INNER JOIN    temp_yxd_20240930_1 b
ON      a.客户编号 = b.客户编号
AND     a.借据起息日 = b.结清日
;




--本次不用取

-----------长授信短风控的数据需求
-- 1、清单统计中型企业贷款、小型企业贷款、微型企业贷款、个体工商户经营性贷款、小微企业主经营性贷款，只统计经营性贷款。
-- 2、选取清单中是否循环选&ldquo;是&rdquo;，是否自助选&ldquo;否&rdquo;的清单；
-- 3、贷款期限选1-X年
-- 4、底层清单和计财对外报送的累计发放清单一致；
--字段：借据流水号	合同流水号	客户编号	客户名称	企业规模	是否个体工商户或小微企业主	是否循环	是否自助	业务品种	营销标签	发生类型	关联交易类型、币种、合同起始日、合同到期日
--贷款金额(元)	贷款余额(元)	借据到期日	借据起息日	利率(&permil;)	行业投向代码	行业投向名称	主要担保方式	管户人工号	管户人	管户机机构号	管户机构

-- drop table if exists temp_yxd_20240930_3;
-- create table if not exists temp_yxd_20240930_3 as
-- SELECT DISTINCT
--          T2.dbil_id 借据流水号
--         ,T1.ctr_serno 合同流水号
--         ,T1.cst_id 客户编号
--         --,T1.cst_nm 客户名称
--         ,CASE
--            WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'B'                                    THEN '大型企业'
--            WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'M'                                    THEN '中型企业'
--            WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                                    THEN '小型企业'
--            WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                                    THEN '微型企业'
--            WHEN ( ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' ) OR ( c.cust_typ = '3' ) ) THEN '个体工商户' --对公对私均有个体工商户
--            WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                                 THEN '小微企业主'
--            WHEN b.operate_cust_type_cbrc = 'C'                                                                       THEN '其他个人经营性客户'
--          END AS 企业规模
--         ,CASE
--            WHEN ( ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' ) OR ( c.cust_typ = '3' ) ) THEN '个体工商户' --对公对私均有个体工商户
--            WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                                 THEN '小微企业主'
--            ELSE '否'
--          END AS 是否个体工商户或小微企业主
--         ,CASE
--            WHEN T1.RVLG_TYP_CD= '1' THEN '是'
--            ELSE '否'
--          END 是否循环
--         ,CASE
--            WHEN T1.RVLG_TYP_CD = '1' THEN '是'
--            WHEN T1.RVLG_TYP_CD = '2' THEN '否'
--            ELSE '空'
--          END 是否自助
--         ,T3.pd_nm 业务品种
--       --   ,T4.cd_val_dscr 营销标签
--         ,T1.prd_tag_nm 营销标签
--         ,T5.cd_val_dscr 发生类型
--         ,CASE
--            WHEN T1.rel_trx_typ_cd = '1' THEN '一般关联交易'
--            WHEN T1.rel_trx_typ_cd = '2' THEN '重大关联交易'
--            WHEN T1.rel_trx_typ_cd = '3' THEN '非关联交易'
--            ELSE T1.rel_trx_typ_cd
--          END 关联交易类型
--         ,'人民币' 币种
--         ,T1.CTR_BGN_DT 合同起始日
--         ,T1.CTR_MTU_DT 合同到期日
--         ,( T1.ctr_amt * T6.AVG_PRC ) / T6.QUO_UNT 贷款金额元
--         ,( T1.ctr_bal * T6.AVG_PRC ) / T6.QUO_UNT 贷款余额元
--         ,T2.APNT_MTU_DT 借据到期日
--         ,T2.LVE_ACT_BGN_DT 借据起息日
--         ,T2.EXEC_INTR_RAT 利率
--         ,T1.inv_in_indy_cd 行业投向代码
--         ,T7.cd_val_dscr 行业投向名称
--         ,CASE
--                     WHEN t1.GRNT_MOD_COLC = '005' THEN '信用'
--                     WHEN t1.GRNT_MOD_COLC = '010' THEN '保证'
--                     WHEN t1.GRNT_MOD_COLC = '020' THEN '抵押'
--                     WHEN t1.GRNT_MOD_COLC = '040' THEN '质押'
--          END 主要担保方式
--         ,T8.mgr_id 管户人工号
--         ,T9.empe_nm 管户人
--         ,T8.mgr_org_id 管户机机构号
--         ,T10.org_nm 管户机构
-- FROM    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD T1 --合同基础信息表
-- LEFT JOIN    edw.dim_bus_loan_dbil_inf_dd T2 --贷款借据信息
-- ON      T1.ctr_serno = T2.ctr_serno
-- AND     T2.DT = '20240930'
-- LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T3 --信贷产品信息
-- ON      T1.prd_no = T3.prd_no
-- AND     T3.DT = '20240930'
-- -- LEFT JOIN    edw.dwd_code_library_dd T4 -- 码值表
-- -- ON      T1.bus_lab_cd = T4.cd_val
-- -- AND     T4.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
-- -- AND     T4.fld_nm = 'BUS_LAB_CD'
-- -- AND     T4.dt = '20240930'
-- LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表
-- ON      T1.hpn_typ_cd = T5.cd_val
-- AND     T5.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
-- AND     T5.fld_nm = 'HPN_TYP_CD'
-- AND     T5.dt = '20240930'
-- LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD T6 --汇率信息
-- ON      T1.bsn_ccy_cd = T6.ccy_cd
-- AND     T6.dt = '20240930'
-- LEFT JOIN    edw.dwd_code_library_dd T7 -- 码值表
-- ON      T1.inv_in_indy_cd = T7.cd_val
-- AND     T7.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
-- AND     T7.fld_nm = upper('inv_in_indy_cd')
-- AND     T7.dt = '20240930'
-- LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T8 --信贷合同管护信息
-- ON      T1.ctr_serno = T8.ctr_serno
-- AND     T8.dt = '20240930'
-- LEFT JOIN    edw.dws_hr_empe_inf_dd T9 --员工信息
-- ON      T8.MGR_ID = T9.empe_id
-- AND     T9.dt = '20240930'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T10 --机构数
-- ON      T8.mgr_org_id = T10.org_id
-- AND     T10.dt = '20240930'
-- LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
-- ON      T1.cst_id = b.cust_id
-- AND     b.dt = '20240930'
-- LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
-- ON      T1.cst_id = c.cust_id
-- AND     c.dt = '20240930'
-- LEFT JOIN    (
--                  SELECT  DISTINCT cust_id
--                                   ,acct_typ
--                  FROM    adm_upss.l_acct_loan
--                  WHERE   dt = '20240930'
--                  AND     substr(acct_typ, 1, 4) = '0102' --经营性
--              ) d
-- ON      T1.cst_id = d.cust_id
-- WHERE   T1.DT = '20240930'
-- --AND     T3.pd_nm LIKE '%经营性%' --经营性贷款
-- AND     (T1.RVLG_TYP_CD = '1' or T1.prd_no in ('2001010101003','2001020101003'))     --是否循环选&ldquo;是&rdquo;
-- AND     T1.RVLG_TYP_CD <> '1' --是否自助选&ldquo;否&rdquo;,老信贷对应字段为is_slf_crc，逻辑需要修改
-- AND     T1.FACL_TRM >= '12'
-- AND     T1.FACL_TRM <= '36'    --贷款期限选1-3年，长授信
-- AND     T8.MGR_ORG_ID LIKE '%3101%'   --发放机构为上海分行
-- AND     T2.LVE_ACT_BGN_DT>='20240101'   --发放日期大于20240101
-- ;
**01-数据需求_分行_SJ2024101526台州分行_J金蕴_客户经理资质查询.sql
--SJ2024101526，截至2024-9-30的台州分行内客户经理业务办理资质清单

-- 工号、用户所在机构、用户姓名、资质类型、资质子类、状态、资质金额、生效时间(新表废弃))、岗位


DROP TABLE IF EXISTS tmp_jy_SJ2024101526 PURGE;

CREATE TABLE IF NOT EXISTS tmp_jy_SJ2024101526 AS
SELECT  a.empe_id 工号
        ,a.usr_org_nbr 用户所在机构id
        ,d.org_nm 用户所在机构
        ,b.empe_nm 用户姓名
        ,a.qua_typ_cd 资质类型ID
        ,c1.cd_val_dscr 资质类型
        ,a.qua_sub_cls_cd 资质子类ID
        ,c2.cd_val_dscr 资质子类
        ,c3.cd_val_dscr 状态
        ,a.qua_amt 资质金额
FROM    edw.DIM_HR_EMPE_MGR_QUA_INF_DD a
LEFT JOIN    edw.dws_hr_empe_inf_dd b
ON      a.empe_id = b.empe_id
AND     b.dt = '20240930'
LEFT JOIN    edw.dwd_code_library_dd c1
ON      a.qua_typ_cd = c1.cd_val
AND     c1.dt = '20240930'
AND     c1.tbl_nm = upper('DIM_HR_EMPE_MGR_QUA_INF_DD')
LEFT JOIN    edw.dwd_code_library_dd c2
ON      a.qua_sub_cls_cd = c2.cd_val
AND     c2.dt = '20240930'
AND     c2.tbl_nm = upper('DIM_HR_EMPE_MGR_QUA_INF_DD')
LEFT JOIN    edw.dwd_code_library_dd c3
ON      a.sts_cd = c3.cd_val
AND     c3.dt = '20240930'
AND     c3.tbl_nm = upper('DIM_HR_EMPE_MGR_QUA_INF_DD')
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd d
ON      a.usr_org_nbr = d.org_id
AND     d.dt = '20240930'
WHERE   a.dt = '20240930'
AND     a.usr_org_nbr LIKE '3301%'   --台州分行
;



--20240718的具有泰e贷资质的客户经理,0070-大类为线上业务经办资质，子类0070001-授予泰e贷业务权限
CREATE TABLE qua_20240718 as
SELECT * FROM edw.DIM_HR_EMPE_MGR_QUA_INF_DD WHERE dt='20240718' and usr_org_nbr like '3301%' and qua_sub_cls_cd='0070001';

--当前资质
CREATE TABLE qua_20241015 as
SELECT * FROM edw.DIM_HR_EMPE_MGR_QUA_INF_DD WHERE dt='20241015' and usr_org_nbr like '3301%'
;

--旧和新比对映射关系，结果：把旧表中的授予泰e贷业务权限资质都合并到1-5级里面去了，无法区分泰e贷资质客户经理
drop TABLE if exists qua_final PURGE ;
CREATE TABLE  if not exists qua_final as
SELECT t1.*
       ,t2.qua_typ_cd as qua_typ_cd_n
       ,t2.qua_sub_cls_cd as qua_sub_cls_cd_n
       ,t2.sts_cd as sts_cd_n
FROM qua_20240718 t1
LEFT JOIN qua_20241015 t2
on t1.empe_id=t2.empe_id
;



-- cd_val	cd_val_dscr
-- 2	已失效
-- 0	待生效
-- 1	已生效
**01-数据需求_分行_SJ20241016116杭州分行_栾成_信贷系统中接触记录调查对象为_朱重德_的客户清单.sql
--
-- SJ20241016116
--截止2024/10/16，杭州分行信贷系统中接触记录调查对象为&ldquo;朱重德&rdquo;的客户清单

-- 1、被调查对象：客户号、客户名称
-- 2、调查日期
-- 3、参与调查人
-- 4、参与调查人工号
-- 5、调查方式
SELECT  t.cst_id 客户号
        ,t.cst_nm 客户名称
        ,t.svy_dt 调查日期
        ,t.pcp_mnl_no 参与调查人工号
        ,t.pcp_psn_nm 参与调查人
        ,t.svy_mod_cd 调查方式代码
        ,t1.cd_val_dscr 调查方式
FROM    edw.DWD_BUS_LOAN_CST_SVY_RCD_DD t --新表，客户调查记录信息
LEFT JOIN edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd t2  -- 调查记录关联调查对象信息
LEFT JOIN    edw.dwd_code_library_dd t1
ON      t.svy_mod_cd = t1.cd_val
AND     t1.dt = '@@{yyyyMMdd}'
AND     tbl_nm = upper('DWD_BUS_LOAN_CST_SVY_RCD_DD')
AND     fld_nm = upper('svy_mod_cd')
WHERE   t.dt = '@@{yyyyMMdd}'
and t.svy_mod_cd in('04','05','06')  --侧面打听
;

SELECT * FROM edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd WHERE dt='20240920' LIMIT 1000;

DESC edw.loan_svy_rcd_rel_svy_obj_inf  -- 调查记录关联调查对象信息
serno           | string     |       | 流水号                                         |
| rel_typ         | string     |       | 关联类型                                        |
| rel_serno       | string     |       | 关联流水号                                       |
| pcp_svy_obj_id  | string     |       | 参与调查对象编号                                    |
| svy_obj         | string     | 2     | 调查对象                                        |
| svy_obj_mbl_no  | string     | 4     | 调查对象手机号                                     |
| svy_obj_job     | string     |       | 调查对象职业                                      |
| with_be_svy_psn_rel_cd | string     |       | 与被调查人关系代码                                   |
| last_upd_tm     | string     |       | 最后更新时间                                      |
| last_upd_org    | string     |       | 最后更新机构                                      |
| last_upd_psn    | string     |       | 最后更新人                                       |
| sys_reg_tm      | string     |       | 系统登记时间                                      |
| sys_reg_org     | string     |       | 系统登记机构                                      |
| sys_reg_psn     | string     |       | 系统登记人                                       |
| del_ind         | string     |       | 删除标识                                        |
| bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
| lgp_id          | string     |       | 法人编号                                        |



--调查方式
-- 04	侧面打听（现场）
-- 01	现场（实地）
-- 02	云调查
-- 03	非现场
-- 05	侧面打听（非现场）
-- 06	侧面打听（批量）


-- SELECT *
-- from edw.DWD_CST_ASST_CRD_CST_SVY_INF_DD t  --老表，信贷客户调查信息
-- where dt='20240719'
**01-数据需求_分行_SJ2024101631_湖州分行_施怡婷_大额授信业务数据_授信敞口500万以上_.sql
-- * 截止24年10月15日，湖州分行大额授信业务数据（授信敞口500万以上）

-- * 合同流水号。客户编号，合同金额，合同余额，同一风险控制号，同一风险控制号下余额，投向行业，融资金额，融资家数，固定资产总额，
-- * 我行近六个月日均存款（剔除保证金），担保方式，担保人名称，（担保人与借款人关系备注）

SELECT COUNT(1) FROM tmp_hz_SJ2024101631_01 WHERE 关系类型 is  null;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_SJ2024101631_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_SJ2024101631_01 AS
SELECT DISTINCT T1.ctr_serno                                           AS 合同流水号
        ,T1.cst_id                                                     AS 客户编号
        ,T1.cst_nm                                                     AS 客户名称
        ,T1.ctr_amt                                                    AS 合同金额
        ,T1.ctr_bal                                                    AS 合同余额
        ,T2.同一风险控制号
        ,T2.同一风险控制号下余额
        ,T1.inv_in_indy_cd                                             AS 投向代码
        ,T3.cd_val_dscr                                                AS 投向行业
        ,COALESCE(T4.cred_total_amt, T5.cred_total_amt)                AS 融资金额
        ,COALESCE(T4.cred_busi_org_out_wjq, T5.un_sett_credit_org_num) AS 融资家数
        ,T7.资产不动产                                                      AS 固定资产贷款余额
        ,T9.grnt_mod_colc                                              AS 担保方式集合
        ,T9.grnt_mod_nm                                                AS 担保方式
        ,T10.WRNT_CST_NM                                               AS 担保人名称
        ,T12.cd_val_dscr                                               AS 关系类型
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    (
                 SELECT  A1.sam_rsk_ctrl_id AS 同一风险控制号
                         ,A1.cst_id         AS 客户号
                         ,SUM(A3.ctr_bal)   AS 同一风险控制号下余额
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.sam_rsk_ctrl_id = A2.sam_rsk_ctrl_id
                 AND     A2.sam_rsk_ctrl_id <> ''
                 AND     A2.DT = '20241015'
                 LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd A3 --合同基础信息
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 ---未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A3.CTR_STS_CD IN ( '2' , '4' )
                 AND     A3.TMT_DT = '18991231'
                 AND     to_date(A3.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A3.DT, 'yyyyMMdd') )
                     OR A3.CTR_BAL > 0 )
                 AND     A3.DT = '20241015'
                 WHERE   A1.DT = '20241015'
                 GROUP BY A1.sam_rsk_ctrl_id , A1.cst_id
             ) T2
ON      T1.cst_id = T2.客户号
LEFT JOIN    edw.dwd_code_library_dd T3 -- 码值表
ON      T1.inv_in_indy_cd = T3.cd_val
AND     T3.tbl_nm = 'DIM_BUS_LOAN_CTR_BSE_INF_DD'
AND     T3.fld_nm = 'INV_IN_INDY_CD'
AND     T3.DT = '20241015'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T4 --个人征信指标信息表
ON      T1.cst_id = T4.cst_id
AND     T4.report_dsc_rn = 1
AND     T4.DT = '20241015'
LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd T5 --企业征信指标信息表
ON      T1.cst_id = T5.cst_id
AND     T5.report_dsc_rn = 1
AND     T5.DT = '20241015'
LEFT JOIN    app_ado.adm_subl_cst_bus_inf_dd T6 --实验室应用层资产-客户业务信息汇总表
ON      T1.cst_id = T6.cst_id
AND     T6.DT = '20241015'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,MAX(CASE
                                WHEN A1.ast_lbl_typ_cd = '15' THEN A1.slf_ast_amt
                                ELSE 0
                              END) AS 资产不动产
                 FROM    edw.dwd_cst_asst_fnc_stat_cus_ass_lib_dtl_dd A1
                 WHERE   A1.DT = '20241015'
                 GROUP BY A1.cst_id
             ) T7
ON      T1.cst_id = T7.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(A1.last_180_days_gl_bal_acml) / 180 AS 我行近六个月日均存款_剔除保证金
                 FROM    edw.dws_bus_dep_act_inf_dd A1
                 WHERE   A1.DT = '20241015'
                 AND     A1.prod_id NOT IN ( '203010100' , '203010200' )  --存款产品代码为 203010100-单位保证金活期、203010200-单位保证金定期
			     GROUP BY A1.cst_id
             ) T8
ON      T1.cst_id = T8.cst_id
LEFT JOIN    (
                 SELECT  a.dt
                         ,a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241015'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '20241015'
                 GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc
             ) T9
ON      T1.ctr_serno = T9.ctr_serno
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd T10 --担保人汇总信息
ON      T1.ctr_serno = T10.BUS_CTR_ID
AND     T10.DT = '20241015'
LEFT JOIN    edw.loan_cst_rel T11 -- 关系人
ON      T1.cst_id = T11.cst_id
AND     T10.wrnt_cst_id = T11.rel_cst_id
AND     T11.DT = '20241015'
LEFT JOIN    edw.dwd_code_library_dd T12 --码值表
ON      T11.rel_typ = T12.cd_val
AND     T12.tbl_nm = 'DIM_CST_REL_INF_DD'
AND     T12.fld_nm = 'REL_TYP_CD'
AND     T12.DT = '20241015'
WHERE   T1.DT = '20241015'
AND     SUBSTR(T1.mgr_org_id, 1, 4) = '3310' --湖州分行
AND     T1.ctr_epsr_amt >= 100 * 10000;
**01-数据需求_分行_SJ2024101831_湖州分行_赵薇_信贷审批合同信息.sql
-- 2024年7月26日至2024年10月9日，湖州分行营业部支行行长何建伟004483及湖州长兴支行小企业业务一部负责人陈东010291审批信贷业务的清单，具体包含合同流水号（10.12已取数）、
-- 申请流水号、客户名称、客户号、经办客户经理、最终审批人、统一授信授信金额、统一授信敞口金额、统一授信个人敞口金额、
-- 合计敞口金额、信用卡敞口金额、消费贷敞口金额、随贷通(经营)敞口金额、个人敞口金额

-- SJ2024101831



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_ck_SJ2024101831_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_hz_ck_SJ2024101831_01
(

   合同流水号 STRING

) ;

INSERT INTO lab_bigdata_dev.tmp_hz_ck_SJ2024101831_01  VALUES
   ('HTBH2024081900001610')
  ,('HTBH2024091100001850')
  ,('HTBH2024072900000106')
  ,('HTBH2024073000002413')
  ,('HTBH2024080200001744')
  ,('HTBH2024100900001708')
  ,('HTBH2024080600004315')
  ,('HTBH2024081500000519')
  ,('HTBH2024100800002195')
  ,('HTBH2024091100001187')
  ,('HTBH2024091100000037')
  ,('HTBH2024080600004313')
  ,('HTBH2024082200001940')
  ,('HTBH2024080200001174')
  ,('HTBH2024090500002534')
  ,('HTBH2024091400001821')
  ,('HTBH2024080600003128')
  ,('HTBH2024081400000160')
  ,('HTBH2024080900002470')
  ,('HTBH2024092500001986')
  ,('HTBH2024080700001568')
  ,('HTBH2024082800000313')
  ,('HTBH2024082200002085')
  ,('HTBH2024090300002275')
  ,('HTBH2024091300000704')
  ,('HTBH2024082900000549')
  ,('HTBH2024091900001876')
  ,('HTBH2024092000001352')
  ,('HTBH2024082800002093')
  ,('HTBH2024080200000380')
  ,('HTBH2024080200000562')
  ,('HTBH2024082900000881')
  ,('HTBH2024081500001375')
  ,('HTBH2024091100002062')
  ,('HTBH2024091900000594')
  ,('HTBH2024091000002000')
  ,('HTBH2024090300001930')
  ,('HTBH2024083000002715')
  ,('HTBH2024092300002298')
  ,('HTBH2024090400000176')
  ,('HTBH2024080700000153')
  ,('HTBH2024082900000027')
  ,('HTBH2024091000000745')
  ,('HTBH2024092600002901')
  ,('HTBH2024091000001210')
  ,('HTBH2024081500000514')
  ,('HTBH2024090500001511')
  ,('HTBH2024080200000113')
  ,('HTBH2024091800000855')
  ,('HTBH2024091800000877')
  ,('HTBH2024073100003266')
  ,('HTBH2024080100002434')
  ,('HTBH2024080900002861')
  ,('HTBH2024081400002199')
  ,('HTBH2024083000000707')
  ,('HTBH2024080700000152')
  ,('HTBH2024082200001845')
  ,('HTBH2024091900002552')
  ,('HTBH2024082300001681')
  ,('HTBH2024090200002496')
  ,('HTBH2024081600001524')
  ,('HTBH2024073100003294')
  ,('HTBH2024082300000258')
  ,('HTBH2024092300002012')
  ,('HTBH2024092300002078')
  ,('HTBH2024091400000621')
  ,('HTBH2024091400002276')
  ,('HTBH2024080500000838')
  ,('HTBH2024080100002584')
  ,('HTBH2024081300002395')
  ,('HTBH2024092900001611')
  ,('HTBH2024081500002326')
  ,('HTBH2024081300000307')
  ,('HTBH2024090300001929')
  ,('HTBH2024082900000026')
  ,('HTBH2024100900000487')
  ,('HTBH2024090600004003')
  ,('HTBH2024093000002294')
  ,('HTBH2024090300000351')
  ,('HTBH2024091800000283')
  ,('HTBH2024081900001426')
  ,('HTBH2024082100000091')
  ,('HTBH2024090200001645')
  ,('HTBH2024072600000963')
  ,('HTBH2024072600000603')
  ,('HTBH2024072600000821')
  ,('HTBH2024093000003146')
  ,('HTBH2024073100001048')
  ,('HTBH2024091100002107')
  ,('HTBH2024073100001040')
  ,('HTBH2024091400002166')
  ,('HTBH2024090500001351')
  ,('HTBH2024091200001469')
  ,('HTBH2024080800002215')
  ,('HTBH2024080900001171')
  ,('HTBH2024081900000076')
  ,('HTBH2024082900000615')
  ,('HTBH2024093000000920')
  ,('HTBH2024090500000387')
  ,('HTBH2024090500000268')
  ,('HTBH2024091200000447')
  ,('HTBH2024091300000078')
  ,('HTBH2024081500001600')
  ,('HTBH2024092700002725')
  ,('HTBH2024081200001136')
  ,('HTBH2024080800002812')
  ,('HTBH2024081200001115')
  ,('HTBH2024081200001139')
  ,('HTBH2024081200001128')
  ,('HTBH2024093000002281')
  ,('HTBH2024081500000520')
  ,('HTBH2024081900001003')
  ,('HTBH2024091000001213')
  ,('HTBH2024100800000516')
  ,('HTBH2024092600001215')
  ,('HTBH2024092900001842')
  ,('HTBH2024092500002063')
  ,('HTBH2024092500001626')
  ,('HTBH2024080100000324')
  ,('HTBH2024090200001417')
  ,('HTBH2024091400001102')
  ,('HTBH2024091900000195')
  ,('HTBH2024091400000873')
  ,('HTBH2024091400000905')
  ,('HTBH2024091400001093')
  ,('HTBH2024091000001279')
  ,('HTBH2024073100003327')
  ,('HTBH2024080900000581')
  ,('HTBH2024082900003173')
  ,('HTBH2024100800001352')
  ,('HTBH2024091100001670')
  ,('HTBH2024091100000782')
  ,('HTBH2024092400001859')
  ,('HTBH2024092600001938')
  ,('HTBH2024091400002081')
  ,('HTBH2024081500002253')
  ,('HTBH2024082200001827')
  ,('HTBH2024082900002130')
  ,('HTBH2024082200002242')
  ,('HTBH2024093000002403')
  ,('HTBH2024082000000031')
  ,('HTBH2024082800000226')
  ,('HTBH2024082900003172')
  ,('HTBH2024082000001579')
  ,('HTBH2024090900002271')
  ,('HTBH2024082100000973')
  ,('HTBH2024083000003507')
  ,('HTBH2024083000003723')
  ,('HTBH2024083000003727')
  ,('HTBH2024083000003720')
  ,('HTBH2024083000000374')
  ,('HTBH2024080900000515')
  ,('HTBH2024081300001724')
  ,('HTBH2024082700001519')
  ,('HTBH2024072900001137')
  ,('HTBH2024081500001316')
  ,('HTBH2024073000002684')
  ,('HTBH2024081300001725')
  ,('HTBH2024082200001854')
  ,('HTBH2024081400000550')
  ,('HTBH2024091200002404')
  ,('HTBH2024093000001075')
  ,('HTBH2024082700001954')
  ,('HTBH2024091900000179')
  ,('HTBH2024080500002190')
  ,('HTBH2024080600002623')
  ,('HTBH2024080600002627')
  ,('HTBH2024081300000290')
  ,('HTBH2024081300001646')
  ,('HTBH2024090500001497')
  ,('HTBH2024092000002093')
  ,('HTBH2024080600002631')
  ,('HTBH2024080500002191')
  ,('HTBH2024092400000099')
  ,('HTBH2024080100000314')
  ,('HTBH2024082200001492')
  ,('HTBH2024092300000085')
  ,('HTBH2024080100002066')
  ,('HTBH2024090500000816')
  ,('HTBH2024090500000795')
  ,('HTBH2024080900002798')
  ,('HTBH2024082800000230')
  ,('HTBH2024091100001841')
  ,('HTBH2024091300001312')
  ,('HTBH2024072600001873')
  ,('HTBH2024082200001813')
  ,('HTBH2024073100002158')
  ,('HTBH2024082100001123')
  ,('HTBH2024081600000590')
  ,('HTBH2024080800000482')
  ,('HTBH2024091300001529')
  ,('HTBH2024092600001021')
  ,('HTBH2024091900000181')
  ,('HTBH2024092500001979')
  ,('HTBH2024091100000144')
  ,('HTBH2024092700000524')
  ,('HTBH2024092500002013')
  ,('HTBH2024092600001060')
  ,('HTBH2024090900000279')
  ,('HTBH2024091900000618')
  ,('HTBH2024073100003296')
  ,('HTBH2024091800001327')
  ,('HTBH2024100800001365')
  ,('HTBH2024080700002832')
  ,('HTBH2024092400000232')
  ,('HTBH2024090900002154')
  ,('HTBH2024082300001632')
  ,('HTBH2024082700001525')
  ,('HTBH2024090900001251')
  ,('HTBH2024081400001609')
  ,('HTBH2024100800000038')
  ,('HTBH2024083000000201')
  ,('HTBH2024090500001417')
  ,('HTBH2024081300001412')
  ,('HTBH2024091400000959')
  ,('HTBH2024073100003454')
  ,('HTBH2024080700001956')
  ,('HTBH2024081500002199')
  ,('HTBH2024090500000635')
  ,('HTBH2024090400000794')
  ,('HTBH2024090500000342')
  ,('HTBH2024080600002702')
  ,('HTBH2024073100000078')
  ,('HTBH2024082900003181')
  ,('HTBH2024100900001494')
  ,('HTBH2024080100000329')
  ,('HTBH2024080600004475')
  ,('HTBH2024093000002498')
  ,('HTBH2024091300000500')
  ,('HTBH2024091000001578')
  ,('HTBH2024091000001961')
  ,('HTBH2024091000001777')
  ,('HTBH2024082900003254')
  ,('HTBH2024082200001771')
  ,('HTBH2024082300000284')
  ,('HTBH2024091000000116')
  ,('HTBH2024100900002113')
  ,('HTBH2024080100001815')
  ,('HTBH2024072900002628')
  ,('HTBH2024081300000318')
  ,('HTBH2024072900001850')
  ,('HTBH2024072600000275')
  ,('HTBH2024091200001517')
  ,('HTBH2024072600001904')
  ,('HTBH2024080700002192')
  ,('HTBH2024100800002196')
  ,('HTBH2024080600004330')
  ,('HTBH2024090400000838')
  ,('HTBH2024091000000243')
  ,('HTBH2024081500001386')
  ,('HTBH2024090500000285')
  ,('HTBH2024092400001821')
  ,('HTBH2024090200000087')
  ,('HTBH2024091900000566')
  ,('HTBH2024090500000798')
  ,('HTBH2024082900000546')
  ,('HTBH2024100800000155')
  ,('HTBH2024092900003298')
  ,('HTBH2024082600002203')
  ,('HTBH2024082800001282')
  ,('HTBH2024082900000617')
  ,('HTBH2024082200002246')
  ,('HTBH2024092500002401')
  ,('HTBH2024080500001450')
  ,('HTBH2024092000000123')
  ,('HTBH2024072700000053')
  ,('HTBH2024080500001452')
  ,('HTBH2024082600001050')
  ,('HTBH2024080600004547')
  ,('HTBH2024080500001451')
  ,('HTBH2024080500001635')
  ,('HTBH2024082300001594')
  ,('HTBH2024091200000774')
  ,('HTBH2024092000001179')
  ,('HTBH2024073100002159')
  ,('HTBH2024091200002412')
  ,('HTBH2024092400000307')
  ,('HTBH2024080500001455')
  ,('HTBH2024080700000065')
  ,('HTBH2024092700002521')
  ,('HTBH2024092900001848')
  ,('HTBH2024080500001454')
  ,('HTBH2024080600004548')
  ,('HTBH2024082600002037')
  ,('HTBH2024092500002662')
  ,('HTBH2024090500000734')
  ,('HTBH2024090500000704')
  ,('HTBH2024080500001633')
  ,('HTBH2024080700000066')
  ,('HTBH2024080500001449')
  ,('HTBH2024082900002409')
  ,('HTBH2024090900001402')
  ,('HTBH2024082200001821')
 ;


--合同流水号、申请流水号、客户名称、客户号、经办客户经理、最终审批人、统一授信授信金额、统一授信敞口金额、统一授信个人敞口金额、合计敞口金额、信用卡敞口金额
--消费贷敞口金额、随贷通(经营)敞口金额、个人敞口金额

-- SELECT * FROM tmp_hz_ck_SJ2024101831_02 WHERE 用信申请流水号 is null

--DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_ck_SJ2024101831_02 PURGE;
--
--CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_hz_ck_SJ2024101831_02 AS
--SELECT  T1.合同流水号
--        ,T2.rel_serno                AS 用信申请流水号
--        ,T2.cst_nm                   AS 客户名称
--        ,T2.cst_id                   AS 客户号
--        ,T2.hdl_opr_id               AS 经办客户经理ID
--        ,T3.empe_nm                  AS 经办客户经理
--        ,T4.user_id                  AS 最终审批人ID
--        ,T4.user_name                AS 最终审批人
--        ,T2.prd_no                   AS 产品编号
--        ,T5.pd_nm                    AS 产品名称
--        ,T4.aply_epsr_amt            AS 申请敞口金额
--        ,T6.cprh_crdt_authr_crdt_amt AS 客户级_统一授信授信金额
--        ,T6.cprh_crdt_exps_amt       AS 客户级_统一授信敞口金额
--        ,T6.crdt_card_exps_amt       AS 客户级_信用卡敞口金额
--        ,T6.exps_amt                 AS 客户级_敞口金额
--FROM    lab_bigdata_dev.tmp_hz_ck_SJ2024101831_01 T1
--LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2 --合同基础信息
--ON      T1.合同流水号 = T2.ctr_serno
--AND     T2.DT = '@@{yyyyMMdd}'
--LEFT JOIN    edw.dws_hr_empe_inf_dd T3 --员工汇总信息
--ON      T2.hdl_opr_id = T3.empe_id
--AND     T3.DT = '@@{yyyyMMdd}'
--LEFT JOIN    (
--                 SELECT  A1.usc_aply_serno
--                         ,A1.aply_epsr_amt
--                         ,B.user_name
--                         ,B.user_id
--                         ,ROW_NUMBER() OVER ( PARTITION BY A1.usc_aply_serno ORDER BY B.end_time DESC ) AS RN
--                 FROM    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案
--                 LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息
--                 ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
--                 AND     T.cst_id = A1.cst_id
--                 AND     T.DT = '@@{yyyyMMdd}'
--                 LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表
--                 ON      t.ahn_ltr_aply_serno = a.biz_id
--                 AND     t.sys_reg_psn_id = a.flow_starter ---- 授信申请登记者 = 流程发起者   不然会有多条记录
--                 AND     a.dt = '@@{yyyyMMdd}'
--                 LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表  --只保留了最后一次流程提交或审批的时间
--                 ON      a.main_instance_id = b.instance_id
--                 AND     b.dt = '@@{yyyyMMdd}'
--                 where   A1.dt='@@{yyyyMMdd}'
--             ) T4
--ON      T2.rel_serno = T4.usc_aply_serno
--AND     T4.RN = 1
--LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T5 --产品信息
--ON      T2.prd_no = T5.prd_no
--AND     T5.dt = '@@{yyyyMMdd}'
--LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD T6 --风险集市客户-单法人授信用信情况表
--ON      T2.cst_id = T6.cst_id
--AND     T6.dt = '@@{yyyyMMdd}';



--用贴源层的合同表，有个删除标识 del_ind=1，都是无用的数据，合同号在新信贷都做了逻辑删除，所以模型层和贴源表数据不一致

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_ck_SJ2024101831_03 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_hz_ck_SJ2024101831_03 AS
SELECT  T1.合同流水号
        ,T2.rel_serno                AS 用信申请流水号
        ,T2.cst_nm                   AS 客户名称
        ,T2.cst_id                   AS 客户号
        ,T2.opr_id	               AS 经办客户经理ID
        ,T3.empe_nm                  AS 经办客户经理
        ,T4.user_id                  AS 最终审批人ID
        ,T4.user_name                AS 最终审批人
        ,T2.prd_no                   AS 产品编号
        ,T5.pd_nm                    AS 产品名称
        ,T4.aply_epsr_amt            AS 申请敞口金额
        ,T6.cprh_crdt_authr_crdt_amt AS 客户级_统一授信授信金额
        ,T6.cprh_crdt_exps_amt       AS 客户级_统一授信敞口金额
        ,T6.crdt_card_exps_amt       AS 客户级_信用卡敞口金额
        ,T6.exps_amt                 AS 客户级_敞口金额
FROM    lab_bigdata_dev.tmp_hz_ck_SJ2024101831_01 T1
LEFT JOIN    edw.loan_ctr_bse_inf T2 --合同基础信息
ON      T1.合同流水号 = T2.ctr_serno
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd T3 --员工汇总信息
ON      T2.opr_id	 = T3.empe_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.usc_aply_serno
                         ,A1.aply_epsr_amt
                         ,B.user_name
                         ,B.user_id
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.usc_aply_serno ORDER BY B.end_time DESC ) AS RN
                 FROM    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案
                 LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息
                 ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno
                 AND     T.cst_id = A1.cst_id
                 AND     T.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表
                 ON      t.ahn_ltr_aply_serno = a.biz_id
                 AND     t.sys_reg_psn_id = a.flow_starter ---- 授信申请登记者 = 流程发起者   不然会有多条记录
                 AND     a.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表  --只保留了最后一次流程提交或审批的时间
                 ON      a.main_instance_id = b.instance_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 where   A1.dt='@@{yyyyMMdd}'
             ) T4
ON      T2.rel_serno = T4.usc_aply_serno
AND     T4.RN = 1
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T5 --产品信息
ON      T2.prd_no = T5.prd_no
AND     T5.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD T6 --风险集市客户-单法人授信用信情况表
ON      T2.cst_id = T6.cst_id
AND     T6.dt = '@@{yyyyMMdd}';
**01-数据需求_分行_上海分行_江长征_企业管护信息.sql
--用作分行推进企业团办
--字段：截止2024年4月30日，附件清单的企业客户的管户信息，包括信贷管户机构、存款管户机构、信贷管户人、存款管户人信息
drop TABLE if EXISTS  lab_bigdata_dev.tmp_sjxqSJ2024051441 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxqSJ2024051441 as
SELECT  distinct t.COL_1 编号
      ,t.COL_2 客户编号
      ,t.COL_3 客户名称
      ,t.COL_4 统一社会信用代码
      ,t1.prm_mgr_id 管护人工号
      ,t1.prm_mgr_nm 管护人姓名
      ,t1.prm_org_id 管护机构号
      ,t1.prm_org_nm 管护机构名称
      ,case when t1.mgr_typ_cd='3' then '贷款'
      when t1.mgr_typ_cd='5' then '存款及财富业务管护人'
      else '其他'
      end as 管护类型
FROM qbi_file_20240516_16_53_35 t
LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1  --客户主管护
ON t.COL_2=t1.cst_id
and t1.dt='@@{yyyyMMdd}'
WHERE t.pt=MAX_PT('qbi_file_20240516_16_53_35')
;

SELECT * FROM lab_bigdata_dev.tmp_sjxqSJ2024051441
--'管户类型(1-旧小微,2-oa流程,3-贷款,4-信用卡,5-存款及财富业务管护人, 6-普通信用卡管户（兜底）,7-小微地图数据回流)'
**01-数据需求_分行_上海分行_谢芸茜_交接质量情况中出现计奖中断业务.sql
-- SJ2024091926
-- 用途：用于盘点分析分行交接质量情况中出现计奖中断业务
-- 时间范围：2023年1月1日-2024年9月19日，上海分行计奖中断数据，计奖中断选择&ldquo;是&rdquo;
-- 字段：交接日期、客户号、客户名称、产品编号、产品名称、交出人工号、交出人姓名、账户转出机构、接手人工号、接手人姓名、账户转入机构、计奖中断标识、计奖中断时间



SELECT DISTINCT a.tran_date 交接日期
       ,a.cst_id 客户号
       ,a.cst_nm 客户名称
       ,a.caliber_no 产品编号
       ,b.p_lvl0_desc 产品名称
       ,a.hand_emp_id 交出人工号
       ,a.hand_emp_name 交出人姓名
       ,a.hand_org_id 账户转出机构号
       ,c.org_nm 账户转出机构
       ,a.take_emp_id 接手人工号
       ,a.take_emp_name 接手人姓名
       ,a.take_org_id 账户转入机构号
       ,d.org_nm 账户转入机构
FROM edw.tljx_t_su_trans_rst_acct_smy a   --EVA账户级交接汇总表
left join app_iftp.adm_papp_ftp_dim_ftp_product_dd b  --FTP产品维度表
on substr(a.caliber_no,1,12)=b.p_lvl0_id
left join  edw.dim_hr_org_mng_org_tree_dd c
on a.hand_org_id=c.org_id
and c.dt='20240918'
left join  edw.dim_hr_org_mng_org_tree_dd d
on a.take_org_id=d.org_id
and d.dt='20240918'
WHERE a.dt='20240918'
and a.cst_id='1018218911'
and replace(substr(a.tran_date,1,10),'-','') BETWEEN '20230101' AND '20240919'
;

SELECT DISTINCT * FROM edw.tljx_t_su_trans_rst_acct_smy WHERE dt= '20240918' and cst_id='1018218911'































select  sss.cst_id
    ,MDF_DT
    ,mdf_qorg_cd ---变更前机构代码
    ,mdf_qppl_cd ---变更前人员代码
    ,aft_mdf_org_cd ---变更后机构代码
    ,aft_mdf_ppl_cd ---变更后人员代码
   ,busi_ctr_id
   ,'交接客户' mdf_type --全量客户类型：全量客户 未全量客户
from
	(select *
		,row_number() over(partition by cst_id order by MDF_DT asc) as ranking
	from
		(select t1.obj_id as busi_ctr_id
			,t2.cst_id
			,SUBSTR(MDF_TM, 1, 8) as MDF_DT  --变更时间
			,mdf_qorg_cd   ---变更前机构代码
			,mdf_qppl_cd  -----变更前人员代码
			,aft_mdf_org_cd  ----变更后机构代码
			,aft_mdf_ppl_cd  ----变更后人员代码
			,t2.ctr_amt
		from EDW.DWD_BUS_LOAN_MNG_MDF_RCD_DD t1  --管理人变更记录
		left join  edw.dim_bus_loan_ctr_inf_dd t2
		on t1.obj_id = t2.busi_ctr_id
		and t2.dt = '20231031'
		WHERE   t1.DT = '20231031'
		AND     t1.OBJ_TYP in ('Loan','SDTCard')
		AND     SUBSTR(t1.MDF_TM, 1, 8) >= '20230501'  --变更时间
		AND     SUBSTR(t1.MDF_TM, 1, 8) <= '20231031'
		and     t1.obj_id is not null
	) ss
) sss
and substr(sss.mdf_dt,1,6)=substr(c.dt,1,6)  --月份相同，取交接月末的授信金额
where ranking = 1   ----全量客户226726	226725
and coalesce(sss.cst_id,'')<>''


--交接日期90天内是否计奖中断
drop table if exists lab_bigdata_dev.mdf_trans_is_zd ;
create table  lab_bigdata_dev.mdf_trans_is_zd as
select t1.cst_id
--,t1.mdf_qorg_cd ---变更前机构代码
,max(case when  t2.rewardattribute in ('E','F') then 1 else  0  END)   as  交接日期90天内是否计奖中断
		,t13.brc_org_nm --分行层级机构名称
from  lab_bigdata_dev.mdf_sample_process  t1
inner join lab_bigdata_dev.efe_ctr t5
on t1.cst_id=t5.cst_id
left join  edw.tljx_t_su_trans_rst_acct_smy    t2   --EVA账户级交接汇总表
on  t1.cst_id = t2.cst_id
and  t2.dt <= '@@{yyyyMMdd}'
and  t2.dt >= t1.MDF_DT
and  t2.dt <= to_char(DATEADD(to_date(t1.mdf_dt,'yyyymmdd'),90,'dd'),'yyyymmdd')
left join edw.dim_hr_org_mng_org_tree_dd t13 --机构树考核
on t1.mdf_qorg_cd=t13.org_id and t13.dt='20240630'
group by  t1.cst_id,t13.brc_org_nm --分行层级机构名称
;

select brc_org_nm,sum(交接日期90天内是否计奖中断) 交接日期90天内是否计奖中断,count(distinct cst_id) 发生过交接的信贷客户20231001_20240630
from lab_bigdata_dev.mdf_trans_is_zd
group by brc_org_nm
;

8101050201010101
810205010201
**01-数据需求_分行_台州分行_应玲丽_核心系统查询日志.sql
--烦请查看以下2个账户：6214808801018312591(正常)和6214809938000228648（销户，销户日期20200227），王高金
-- 在2024年9月17日和18日这两天期间的核心查询记录，并导出查询的支行号、支行名、查询人员工号、姓名以及查询的时间点、查看的界面等。

CREATE TABLE IF NOT EXISTS tmp_zw_SJ2024082351 as
select a.weihguiy 维护柜员工号
      ,b.empe_nm 维护柜员姓名
      ,a.weihriqi 维护日期
      ,a.weihshij 维护时间
      ,a.weihjigo 维护机构
      ,a.qudaohao 渠道
      ,a.qnqbwvar 请求报文
      ,a.jiaoyima 交易码
      ,a.waibclma 第三方交易码
      ,a.zhaiyoms 摘要代码
      ,a.zhaiyoms 摘要描述
from edw.core_kapb_jioybw a   -- 交易报文表
left join edw.dws_hr_empe_inf_dd b
on a.weihguiy=b.empe_id
and b.dt='@@{yyyyMMdd}'
where a.dt<='@@{yyyyMMdd}'
and a.dt>='20240101'
and a.jiaoyirq>='20240917'
and a.jiaoyirq<='20240918'
and a.qudaohao='A01' --筛选柜面渠道
-- and (a.qnqbwvar like '%1027563576%' or a.qnqbwvar like '%330125197308054330%' or a.qnqbwvar like '%喻力荣%'  or a.qnqbwvar like '%6214808801018312591%' )  --请求报文varchar2型
and a.qnqbwvar like '%6214808801018312591%'  --请求报文varchar2型
-- union all
-- select a.weihguiy 维护柜员工号
--       ,b.empe_nm 维护柜员姓名
--       ,a.weihriqi 维护日期
--       ,a.weihshij 维护时间
--       ,a.weihjigo 维护机构
--       ,a.qudaohao 渠道
--       ,a.qnqbwvar 请求报文
--       ,a.jiaoyima 交易码
--       ,a.waibclma 第三方交易码
--       ,a.zhaiyoms 摘要代码
--       ,a.zhaiyoms 摘要描述
-- from edw.core_kapb_jioybw a   -- 交易报文表
-- left join edw.dws_hr_empe_inf_dd b
-- on a.weihguiy=b.empe_id
-- and b.dt='@@{yyyyMMdd}'
-- where a.dt<='@@{yyyyMMdd}'
-- and a.dt>='20240101'
-- and a.jiaoyirq>='20240917'
-- and a.jiaoyirq<='20240918'
-- and a.qudaohao='A01' --筛选柜面渠道
-- -- and (a.qnqbwvar like '%1027563576%' or a.qnqbwvar like '%330125197308054330%' or a.qnqbwvar like '%喻力荣%'  or a.qnqbwvar like '%6214808801018312591%' )  --请求报文varchar2型
-- and a.qnqbwvar like '%6214809938000228648%'  --请求报文varchar2型
;

SELECT kehuzhao,kehuzhmc FROM edw.core_kdpa_kehuzh WHERE dt='20240801' and kehuzhao in ('6214808801018312591','6214809938000228648');


SELECT * FROM edw.dim_bus_dep_cst_act_inf_dd WHERE dt='20240801' and cst_act_id in ('6214808801018312591','6214809938000228648');

SELECT * FROM edw.dwd_code_library_dd WHERE dt='20240801' and tbl_nm=upper('dim_bus_dep_cst_act_inf_dd') and fld_nm=upper('act_sts_cd')
**01-数据需求_分行_台州分行_方美娇_分行检查需要_冠字号.sql
--日期：2022年1月10日，大概下午2点40分左右; 交易机构：台州经济开发区支行（330100400）；交易柜员：D00039
--取数口径：1、账户6214808801023932193取款7万现金的冠字号；
--2、账户6221410009643496存款6.99万现金的冠字号；【当时（大概下午2点40分左右）存入时有卡钞，需要卡钞时的冠字号，非长款后入账的冠字号】
--字段：卡号、冠字号、交易时间

-- edw.dwd_bus_chnl_atm_trx_srl_di a --ATM流水
-- edw.dim_bus_dep_act_inf_dd t1 --存款账户，a.prm_act_id = t1.cst_act_id
--edw.gzhs_atm_tran_info a1  --ATM交易信息表
--edw.gzhs_cml_sent_infos_day a2  --纸币冠字号码日表,a1.c_id = a2.c_tran_id,a2.c_seria_no 现金冠字号

-- --atm_tran_info---自助机具的主交易表
-- cml_counter_record---柜面的主交易表
-- cml_sent_infos_day---冠字号详情表

-- 1、正常是自助机具或者柜面做了交易后，会在对应的主交易表中登记一条记录，包含设备编号，日期，交易账号，金额等等
-- 2、冠字号详情表会登记每一笔交易的冠字号详情
-- 3、比如自助机具取款10张100元，那么会在atm_tran_info有一条主交易记录，在cml_sent_infos_day中有10条冠字号的记录，因为是10张钱，两表间通过c_id字段关联

select * from edw.gzhs_atm_tran_info a1 --自助机具的主交易表 ,用c_id关联
where dt<='20240825'
-- and c_term_id = '400039'
and c_td_account_no='6214808801032856912'
and c_tran_time like '20240328%'
;

SELECT a2.dt,a2.c_seria_no from edw.gzhs_cml_sent_infos_day a2  ----纸币冠字号码日表
WHERE a2.dt<='20240625'
and a2.c_tran_id='96e97f40be874a1f9ec556a036272327'
;

-- SELECT  t1.act_nm 银行卡账户名
--                  ,a.trx_amt 交易金额
--                  ,a.card_nbr 主帐号
--                  ,a.trx_tm 交易时间
--                  ,a2.c_seria_no 现金冠字号
--                 --  ,a2.c_denomination  --面额
--                 --  ,a2.c_tran_id
--                 --  ,a1.c_id
--                 --  ,a.atm_eqp_srl_nbr ATM设备流水号
--                 --  ,a2.c_journal_no --清分流水号
--                 --  ,a2.c_tran_date --交易时间
--                 --  ,a2.c_tran_monthday  --交易日期(月日)
-- FROM    edw.dwd_bus_chnl_atm_trx_dtl_di a --自助机具交易明细信息
-- -- LEFT JOIN    edw.dim_bus_chnl_atm_eqp_inf_dd t --ATM设备基本信息表
-- -- ON      a.atm_eqp_id = t.eqp_id
-- -- AND     t.dt = '20220110'
-- LEFT JOIN    edw.dim_bus_dep_act_inf_dd t1 --存款账户
-- ON      a.card_nbr = t1.cst_act_id
-- AND     t1.dt ='20220110'
-- -- LEFT JOIN    edw.gzhs_atm_tran_info a1   --ATM交易信息表  20220322
-- -- ON      a.atm_eqp_srl_nbr = a1.c_td_journal_no  --设备流水号关联
-- -- AND     a1.dt = '20220110'
-- LEFT JOIN    edw.gzhs_cml_sent_infos_day a2  --纸币冠字号码日表
-- ON      a.eqp_nbr = a2.c_machinesno  --关联ID
-- AND     a2.dt = edw.gzhs_cml_sent_infos_day a2
-- WHERE   a.dt ='20220110'
-- AND     substr(a.trx_tm,1,8) ='20220110'
-- AND     a.trx_amt > 0
-- and a.card_nbr in ('6214808801023932193','6221410009643496');

-- SELECT a2.c_denomination,a2.c_machinesno,a2.c_machine_type,a2.c_seria_no,a2.c_term_id,a2.c_tran_date from  edw.gzhs_cml_sent_infos_day a2 WHERE a2.dt='20220110'
-- --
**01-数据需求_分行_台州分行_林佳莺_汇票交易信息.sql
--.需要查询以下汇票的背书情况，最后一手是否为深圳市刚泰黄金珠宝有限公司44250100017000000912，入到哪个银行。2如果不是，需要了解最后一手兑付的银行信息，账户名称、账号。

---edw.spmt_pdms_billbook    --城商行汇票登记薄

SELECT T.billno 票据号码
       ,T.billapplyacc 申请人账号
       ,T.billapplyname 申请人名称
       ,t.billamount 出票金额
       ,T.billdate 票据日期
       ,T.billkind 汇票类型
       ,T.billpayeeacc 收款人帐号
       ,T.billpayeename 收款人名称
       ,T.billholdaccbank 最后持票人开户行号
       ,T.billholdacc  最后持票人帐号
       ,T.billholdname 最后持票人名称
from edw.spmt_pdms_billbook  T  --城商行汇票登记薄
WHERE T.dt='@@{yyyyMMdd}'
and T.billapplyacc='3301090120100023332'    --上海悦玺网络科技有限公司台州分公司
**01-数据需求_分行_台州分行_蒋玉英_手机银行登录_人脸识别日志.sql
-- 调取姓名为：何冬秒，客户号 --1627230808
--身份证号码为：331082198409106934在我行系统内操作手机银行、人脸识别等记录信息或其他登陆志等数据信息


--手机银行登录
SELECT A.*
    --    ,C.*
FROM EDW.EBNK_MB_AUDIT_LOG A  --手机操作审计日志表，增量表
-- INNER JOIN EDW.EBNK_PB_CSTINF_CHANNEL C   --个人渠道信息表（新增），全量表
-- ON C.PCC_CSTNO=A.ALG_USERID  --客户号
-- -- AND C.PCC_CHANNEL='1'   --0:个人;1:手机WAP;2:手机客户端
-- AND C.PCC_BRANCHID<>'' --开通网点
-- AND C.PCC_CSTNO<>''   --网银客户号
-- AND C.DT='20240918'
WHERE
A.DT>='20230101'
--AND A.DT<='20240431'
AND ALG_BSNCODE='100001'                             ---alg_optype: '13' --登录
AND (ALG_ERRORCODE = '' OR ALG_ERRORCODE IS NULL)
----AND ALG_BANKID='020200'
--AND ALG_SYSID ='MBC'           --1：手机WAP；2:手机客户端MBC)   -- 修改逻辑判断方式，因2015年WAP银行已下线，今后所有WAP银行访问量均计算为微信访问量
-- AND LENGTH(ALG_USERID) = 10
and A.ALG_USERID='1627230808'
;

--查询是否有开通手机银行，柜面20200310开通，wap和客户端君有开通
SELECT * FROM EDW.EBNK_PB_CSTINF_CHANNEL C   --个人渠道信息表（新增），全量表
WHERE  C.DT='20240918'
and C.PCC_CSTNO='1627230808'
;


--人脸识别流水表
SELECT  mfl_flow_id 人脸识别流水号
        ,mfl_trxcode 交易场景码
        ,mfl_channel 渠道标识 --1：手机WAP；2:手机客户端MBC)
        ,mfl_customer_name MFL_CUSTOMER_NAME
        ,mfl_cert_no 证件号
        ,mfl_request_id 请求Id
        ,mfl_error_code 错误码
        ,mfl_error_message 错误信息
        ,mfl_rate 比对分数
        ,mfl_date 识别时间
        -- mfl_bankid	多法人标志
FROM    edw.ebnk_mb_facechack_log a --人脸识别流水记录表 ，增量表
WHERE   A.DT >= '20230101'
-- AND     a.mfl_cert_no = '331082198409106934'
-- and a.mfl_customer_name='何冬秒'
and a.mfl_request_id like '1627230808%'
;
**01-数据需求_分行_台州分行_郑洁_企业法人联系方式.sql
--15分汇票的交易信息，对方的银行信息，账户名称、账号。

--票据承兑
SELECT t.acpt_stat as 票据状态
       ,t.bill_attr as 票据介质 --1纸票 2电票
       ,t.bill_no as 票据ID
       ,t.cst_acct As 出票人账号
       ,t.cst_acct_nm as 出票人账号户名
       ,t.cst_bk_id  as 出票人账号
       ,t.cst_id as 出票人客户ID
       ,t.cst_bk_id as 出票人开户行
       ,t.cst_role as 出票人类别   --RC00接入行 RC01企业 RC02人民银行 RC03被代理行 RC04被代理财务公司 RC05接入财务公司
       ,t.drwe_org_id as 付款行机构号
       ,t.org_id as 机构ID  ---（行内机构号，同IFS_ORG.ID）
from edw.dwd_bill_acpt_cont_dd t
WHERE t.dt='20240506'
and 上海悦玺网络科技有限公司台州分公司


--票据基本信息

SELECT a.drft_no 票据号码
       ,a.accptr_acct  承兑人账号
       ,a.accptr_bk_id 承兑人开户行ID
       ,a.accptr_bk_nm 承兑人开户行名称
       ,a.accptr_nm 承兑人名称
      -- ,a.accptr_role  --承兑人类别 RC00-接入行 RC01-企业 RC02-人民银行 RC03-被代理行 RC04-被代理财务公司 RC05-接入财务公司
       ,a.acpt_dt    --承兑日期
       ,a.drft_stat   --出票状态
       ,a.drwr_acct  出票人账号
       ,a.drwr_bk_id 出票人开户行ID
       ,a.drwr_bk_nm 出票人开户行名称
       ,a.drwr_cust_id 出票人客户ID
       ,a.drwr_nm 出票人名称
       ,a.pyee_acct   收款人账号
       ,a.pyee_bk_id 收款人开户行ID
       ,a.pyee_bk_nm 收款人开户行名称
       ,a.pyee_cust_id 收款人客户ID
       ,a.pyee_nm  收款人名称
       ,a.isse_dt 出票日
       ,a.org_id
from edw.nbms_ifb_comm_drft_inf a  --票据基本信息
WHERE a.dt='20240506'
and a.drwr_nm ='上海悦玺网络科技有限公司台州分公司'
**01-数据需求_分行_嘉兴分行_何文俊_客户回访联系方式.sql
--机构-支行	客户号	客户名称	管户人名称	产品名称	贴息终止日期	综合收益率	是否退出（原标签）
--0516总余额	沟通备注	是否已签约	是否积分审批表	0516续办产品	续办产品	0516通知+协定余额	0516理财余额	0423理财余额	较结息理财增量	联系方式
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024051786 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024051786 AS
SELECT DISTINCT t.col_1 机构_支行
        ,t.col_2 客户号
        ,t.col_3 客户名称
        ,t.col_4 管户人名称
        ,t.col_5 产品名称
        ,substr(t.col_6,1,10) 贴息终止日期
        ,t.col_7 综合收益率
        ,t.col_8 是否退出_原标签
        ,t.col_9 0516总余额
        ,t.col_10 沟通备注
        ,t.col_11 是否已签约
        ,t.col_12 是否积分审批表
        ,t.col_13 0516续办产品
        ,t.col_14 续办产品
        ,t.col_15 0516通知_协定余额
        ,t.col_16 0516理财余额
        ,t.col_17 0423理财余额
        ,t.col_18 较结息理财增量
        ,CASE
           WHEN telephone IS NOT NULL AND length(telephone) > 0     THEN telephone
           WHEN cmp_tel_nbr IS NOT NULL AND length(cmp_tel_nbr) > 0 THEN cmp_tel_nbr
           WHEN fml_tel_nbr IS NOT NULL AND length(fml_tel_nbr) > 0 THEN fml_tel_nbr
           ELSE mbl_nbr
         END AS 联系方式
        -- ,telephone 电话号码
        -- ,cmp_tel_nbr 公司电话
        -- ,fml_tel_nbr 家庭电话
        -- ,mbl_nbr 手机
FROM    qbi_file_20240522_10_35_31 t --导入的表
LEFT JOIN    edw.dws_cst_bas_inf_dd t1 --客户基础信息汇总表
ON      t.col_2 = t1.cst_id
AND     t1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_customer_tel T2 --客户联系电话
ON      t.col_2 = t2.customerid
AND     t2.dt = '@@{yyyyMMdd}'
and  T2.isnew='1'  --最新
WHERE   t.pt = MAX_PT('qbi_file_20240522_10_35_31');


-- SELECT 客户号,concat(联系方式,'%') FROM tmp_sjxq_SJ2024051786 where 客户号='2603530486'

-- SELECT count(1)  FROM tmp_sjxq_SJ2024051786

-- SELECT length(telephone)  FROM tmp_sjxq_SJ2024051786 where 客户号='2603530486'

-- coalesce(telephone,'')<>''   --剔除null，空子串
-- ;
**01-数据需求_分行_嘉兴分行_余舟_财富客户手机号码.sql
--客户联系方式
DROP TABLE if EXISTS tmp_yz_SJ2024062411 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_yz_SJ2024062411 AS
SELECT  T.cst_id 客户号
        ,T1.mbl_nbr 手机号码
FROM    (
            SELECT  DISTINCT col_1 as cst_id
            FROM    qbi_file_20240626_14_43_06  --业务提供客户清单，去重
            WHERE   pt = MAX_PT('qbi_file_20240626_14_43_06')
        ) T
LEFT JOIN    edw.dws_cst_bas_inf_dd T1  --客户基础信息汇总表
ON      T.cst_id= T1.cst_id
AND     T1.dt = '@@{yyyyMMdd}'
;

-- SELECT count(1) FROM tmp_yz_SJ2024062411
**01-数据需求_分行_嘉兴分行_徐依蕾_泰惠收商户授信和用信情况.sql
--目前嘉兴分行已经办理的全量泰惠收，在2024年3月1日后到2024年6月18日期间的授信商户清单和金额、用信授信商户清单和金额
--合同状态，01：签订中； 00：执行中； 02：即将到期； 03：已过期； 04：新增待审核； 05：新增被拒绝； 06：修改待审核； 07：修改被拒绝；08：中止待审核；
--商户状态，00 正常； 01 冻结； 02 注销； 03 添加待审核； 04 修改待审核； 05 冻结待审核； 06 恢复待审核； 07 注销待审核；08 新增被拒绝；09 修改被拒绝；98-入网中；
--对法人授信，用信信息
SELECT T.mch_id 商户编号
       ,T.mch_nm 商户名称
       ,T.mch_sts_cd 商户状态
       ,T.afl_org_id 所属机构
       ,T.bus_lcn_nbr 营业执照号码
       ,T.bus_lcn_typ_cd 营业执照类型代码
       ,T.ctr_id 	合同编号
       ,T.ctr_sts_cd 合同状态代码
       ,T.entp_cst_id 企业客户号
       ,T.entp_lgp_cst_id 企业法人客户号
       ,T.lgp_cst_id 法人客户号
       ,T.start_dt 合同开始日期
       ,T.end_dt 合同失效日期
       ,T.reg_dt 注册日期
from edw.dws_bus_chnl_ths_mch_inf_dd T  --泰惠收商户汇总信息
WHERE T.dt='@@{yyyyMMdd}'
and T.afl_org_id like '3309%'  --嘉兴分行
**01-数据需求_分行_定期跑数_杭州分行_顾佳萍_一年期定期存单质押情况_含大额存单_.sql
--定期跑数
-- 杭州分行截至2024年9月30日、2024年10月31日一年期定期存单质押情况（含大额存单）；两个时间点的数据

--SJ2024103061
-- 数据日期；客户号；存款账号（子户）；客户存款账号（总户）；存款产品名称；开户日期；币种代码；存期；余额(折人民币)；月日均(折人民币)；管护客户经理工号；管护客户经理姓名；管护机构编号；考核比例；是否质押

--591573条数据

--SJ2024120306
--截至2024年11月30日一年期定期存单质押情况（含大额存单）的数据
--数据日期；客户号；存款账号（子户）；客户存款账号（总户）；存款产品名称；开户日期；币种代码；存期；余额(折人民币)；月日均(折人民币)；管护客户经理工号；管护客户经理姓名；管护机构编号；考核比例；是否质押

--306551条数据



--SJ20241231131
--截至20241231

SELECT count(1) FROM tmp_SJ20241231131_wz_cd_01

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SJ20241231131_wz_cd_01;

CREATE TABLE lab_bigdata_dev.tmp_SJ20241231131_wz_cd_01 AS
SELECT  T2.dt                                                               AS 数据日期
        ,T2.cst_id                                                          AS 客户号
        ,T2.act_nm                                                          AS 客户姓名
        ,T2.cst_act_id                                                      AS 客户账号
        ,T2.dep_act_id                                                      AS 存款账号
        ,T8.pd_cmt                                                          AS 存款产品
        ,T2.opn_dt                                                          As 开户日期
        ,T2.ccy_cd                                                          AS 币种代码
        ,T2.dep_trm                                                         AS 存期
        ,T2.gl_bal * T3.AVG_PRC / T3.QUO_UNT                                AS 余额
        ,T2.act_mth_acm_bal * T3.AVG_PRC / T3.QUO_UNT / SUBSTR(T2.DT, 7, 2) AS 月日均
        ,T4.acs_org_id                                                      AS 管护机构号
        ,T5.org_nm                                                          AS 管护机构
        ,T5.sbr_org_nm                                                      AS 管护支行
        ,T5.tem_org_nm                                                      AS 管护团队
        ,T4.mgr_id                                                          AS 管护人工号
        ,NVL(T6.empe_nm, '')                                                AS 管护客户经理
        ,T4.mgr_rto                                                         AS 管护比例
        ,case when T7.act_id is not null then '是' else '否' end            as 是否质押
-- ,T2.act_year_acm_bal*T3.AVG_PRC / T3.QUO_UNT /(DATEDIFF(TO_DATE(T2.dt,'yyyymmdd'),to_date('20231231','yyyymmdd'),'dd')) as 年日均
FROM    edw.dws_bus_dep_act_inf_dd T2 --存款账户信息汇总
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD T3 --汇率信息
ON      T2.CCY_CD = T3.CCY_CD
AND     T2.dt = T3.dt
AND     T3.DT IN ('20241231')
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T4 --客户存款账户管护信息
ON      T2.cst_act_id = T4.cst_act_id
AND     T2.dt = T4.dt
AND     T4.DT IN  ('20241231')
-- AND     T4.frs_ctc_ind = '1'  --第一联系人标志
-- AND     T4.act_rel_chr_cd <> '6' --剔除资源性存款
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度
ON      T4.acs_org_id = T5.org_id
AND     T4.dt = T5.dt
AND     T5.DT IN  ('20241231')
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T4.mgr_id = T6.empe_id
AND     T4.dt = T6.dt
AND     T6.DT IN  ('20241231')
left JOIN    (
                  SELECT  dt
                          ,act_id
                  FROM    edw.dim_bus_loan_cltr_dep_cert_spcl_dd --贷款客户押品存单专项信息
                  WHERE   DT IN  ('20241231')
                  GROUP BY dt , act_id
              ) T7
ON      T2.cst_act_id = T7.act_id
AND     T2.dt = T7.dt
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd T8 --存款产品
ON      T2.prod_id = T8.pd_id
AND     T2.dt = T8.dt
AND     T8.dt IN  ('20241231')
WHERE   T2.DT IN  ('20241231')
and     T2.dep_trm in('1Y','12M','361D','363D','364D','365D','366D','368D','369D')  --1年期
AND     T2.prod_id IN ( '00202040100' , '00201040100' , '00201020100' , '00201020105','00202020100') --单位大额存单,个人大额存单,个人整存整取,新成长乐,单位定期
AND     T5.brc_org_id like  '3302%'   --杭州分行
;
**01-数据需求_分行_杭州分行_吴莹凯_杭州分行有效户.sql
-- 客户级数据，截止时间6月30日，杭州分行有效户
-- 客户号、客户名称、管护机构号、主管护客户经理编号、主管护客户经理名称、AUM、存款（6月日均）、理财（6月日均）、基金（6月日均）、保险（客户累计量）、贵金属（2024年累计额）、国际业务数据（2024年结算量）



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_wd_ckyouxiaohu_SJ20240701126_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_wd_ckyouxiaohu_SJ20240701126_01 AS
SELECT  T1.cst_id                  AS 客户号
        ,T1.cst_nm                 AS 客户名称
        ,T1.prm_org_id             AS 管护机构号
        ,T1.prm_mgr_id             AS 主管护客户经理编号
        ,T1.prm_mgr_nm             AS 主管护客户经理名称
        ,T4.aum_bal                AS AUM
        ,T5.dep_bal_mon_avg        AS 存款6月日均
        ,T4.fnc_mon_avg_amt        AS 理财6月日均
        ,T4.fund_mon_avg_amt       AS 基金6月日均
        ,T4.insu_amt               AS 保险保费
        ,T4.insu_mon_avg_amt       AS 保险保费6月日均
        ,T6.nob_met_year_tot_acml  AS 贵金属2024年累计额
        ,T7.cur_year_inter_stl_nbr AS 2024年国际结算量
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T2 --客户集市-基础信息-客户基础标识信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20240630'
LEFT JOIN    (
                 SELECT  DISTINCT cst_id
                 FROM    edw.dim_bus_loan_ctr_inf_dd --信贷合同信息
                 WHERE   DT = '20240630'
                 AND     ( CTR_BAL > 0 --余额>0
                     OR ( CTR_BAL = 0
                      AND APNT_MTU_DT >= '@@{yyyyMMdd}' --约定到期日期大于等于当前
                      AND NVL(FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
                      AND END_DT = '18991231' --终结日期=18991231即为合同未终结
                          )
						 ) --合同未结清
             ) T3
ON      T1.cst_id = T3.cst_id
LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd T4 --客户集市-业务信息-客户金融资产信息表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20240630'
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd T5 --客户集市-业务信息-客户存款业务信息表
ON      T1.cst_id = T5.cst_id
AND     T5.DT = '20240630'
LEFT JOIN    adm_pub.adm_csm_cbus_wlth_nob_met_bus_inf_dd T6 --客户集市-业务信息-财富-贵金属-业务信息
ON      T1.cst_id = T6.cst_id
AND     T6.DT = '20240630'
LEFT JOIN    adm_pub.adm_csm_cbus_inter_bus_inf_dd T7 --客户集市-业务信息-国际业务信息
ON      T1.cst_id = T7.cst_id
AND     T7.DT = '20240630'
WHERE   T1.DT = '20240630'
AND     T1.prm_org_id LIKE '3302%' --杭州分行
AND     T2.efe_dep_cst_ind = '1' --有效存款户
AND     T3.cst_id IS NULL  --剔除有信贷业务的客户
;



-- 客户号  客户名称	管护机构号	主管护客户经理编号	主管护客户经理名称	AUM	存款（6月日均）	理财（6月日均）	基金（6月日均）	保险（客户累计量）
-- 贵金属（2024年累计额）	国际业务数据（2024年结算量）	一般贷款（含随贷通）6月日均	随贷通（6月日均）	政策类贷款（6月日均）	信用卡（6月日均）
-- 他行借贷笔数	客户历史逾期笔数	消费透支率	同控下资金归行率	征信分
-- 同控下资金归行率：同一风险控制号下，客户存款和贷款的比值。消费透支率不用取
 --201050101,201050102 2010503   泰E贷 '201050102010146' , '201050101040348'

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_youdaihu_SJ20240701126_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_hz_youdaihu_SJ20240701126_02 AS
SELECT  T1.cst_id                               AS 客户号
        ,T1.cst_nm                              AS 客户名称
        ,T1.prm_org_id                          AS 管护机构号
        ,T1.prm_mgr_id                          AS 主管护客户经理编号
        ,T1.prm_mgr_nm                          AS 主管护客户经理名称
        ,T4.aum_bal                             AS AUM
        ,T5.dep_bal_mon_avg                     AS 存款6月日均
        ,T4.fnc_mon_avg_amt                     AS 理财6月日均
        ,T4.fund_mon_avg_amt                    AS 基金6月日均
        ,T4.insu_amt                            AS 保险
        ,T6.nob_met_year_tot_acml               AS 贵金属2024年累计额
        ,T7.cur_year_inter_stl_nbr              AS 2024年国际结算量
        -- ,T8.一般贷款含随贷通_6月日均
        ,T8.loan_mon_avg                        AS 一般贷款余额月日均
        -- ,T8.随贷通_6月日均
        ,T8.sdt_loan_mon_avg                    AS 随贷通余额月日均
        -- ,T8.政策性贷款_6月日均
        ,T8.policy_loan_mon_avg                 AS 政策性贷款月日均
        -- ,T9.信用卡垫款_6月日均
        ,T8.cr_cr_crd_mon_avg                   AS 信用卡余额月日均
        ,T10.他行借贷笔数
        ,T10.客户逾期期数
        ,T11.同一风险存款余额 / NULLIF(T12.同一风险贷款余额, 0) AS 同控下资金归行率
        ,greatest(T13.idv_crd_sco_val,T13.idv_crd_sco_val2)   AS 征信分
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T2 --客户集市-基础信息-客户基础标识信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20240630'
LEFT JOIN    (
                 SELECT  DISTINCT cst_id
                 FROM    edw.dim_bus_loan_ctr_inf_dd --信贷合同信息
                 WHERE   DT = '20240630'
                 AND     ( CTR_BAL > 0 --余额>0
                     OR ( CTR_BAL = 0
                 AND     APNT_MTU_DT >= '@@{yyyyMMdd}' --约定到期日期大于等于当前
                 AND     NVL(FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
                 AND     END_DT = '18991231' --终结日期=18991231即为合同未终结
				          ) ) --合同未结清
             ) T3
ON      T1.cst_id = T3.cst_id
LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd T4 --客户集市-业务信息-客户金融资产信息表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20240630'
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd T5 --客户集市-业务信息-客户存款业务信息表
ON      T1.cst_id = T5.cst_id
AND     T5.DT = '20240630'
LEFT JOIN    adm_pub.adm_csm_cbus_wlth_nob_met_bus_inf_dd T6 --客户集市-业务信息-财富-贵金属-业务信息
ON      T1.cst_id = T6.cst_id
AND     T6.DT = '20240630'
LEFT JOIN    adm_pub.adm_csm_cbus_inter_bus_inf_dd T7 --客户集市-业务信息-国际业务信息
ON      T1.cst_id = T7.cst_id
AND     T7.DT = '20240630'
-- LEFT JOIN    (
--                  SELECT  A1.cst_id
--                          ,SUM(CASE
--                                 WHEN SUBSTR(A1.pd_cd, 1, 9) IN ( '201050102', '201040101','201040102' ) OR SUBSTR(A1.pd_cd, 1, 7) IN ( '2010503' , '2010403','2010402' )
--                                 OR SUBSTR(A1.pd_cd, 1, 11) ='20105010100' THEN A1.mon_acm_prcp_bal_acml
--                               END) / 30 AS 一般贷款含随贷通_6月日均
--                          ,SUM(CASE
--                                 WHEN SUBSTR(A1.pd_cd, 1, 7) = '2010503' THEN A1.mon_acm_prcp_bal_acml
--                               END) / 30 AS 随贷通_6月日均
--                          ,SUM(CASE
--                                 WHEN A2.pd_cd LIKE '8101100101%' THEN A1.mon_acm_prcp_bal_acml
--                               END) / 30 AS 政策性贷款_6月日均
--                  FROM    edw.dws_bus_loan_dbil_inf_dd A1   --贷款借据信息汇总
--                  LEFT JOIN    edw.dws_bus_fin_ftp_act_smy_inf_dd A2  --FTP账户汇总信息表
--                  ON      A1.dbil_id = A2.src_act_id
--                  AND     A2.DT = '20240630'
--                  LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd A3  --信贷合同
-- 		 ON      A1.bus_ctr_id = A3.busi_ctr_id
--                  AND     A3.DT = '20240630'
--                  WHERE   A1.DT = '20240630'
-- 		 AND     A3.bus_cd	<> 'J'   --剔除助兴通业务
--                  AND 	 ( A3.CTR_BAL > 0 --余额>0
--                        OR
--                           (
--                                 A3.CTR_BAL = 0
--                            and  A3.APNT_MTU_DT >= '@@{yyyyMMdd}'--约定到期日期大于等于当前
--                            AND     NVL(A3.FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
--                            AND     A3.END_DT = '18991231' --终结日期=18991231即为合同未终结
--                            ) --合同未结清
--                            )
--                  GROUP BY A1.cst_id
--              ) T8
-- ON      T1.cst_id = T8.cst_id
left JOIN adm_pub.adm_csm_cbus_loan_inf_dd T8  --客户集市-业务信息-客户贷款业务信息表
on T1.cst_id=T8.cst_id
and T8.dt='20240630'
-- LEFT JOIN    (
--                  SELECT  A1.cst_id
--                          ,SUM(A2.tmon_cur_mon_adv_mny_bal_acm) / 30 AS 信用卡垫款_6月日均
--                  FROM    edw.dws_bus_crd_cr_crd_act_inf_dd A1 --信用卡账户信息汇总
--                  LEFT JOIN    edw.dws_bus_crd_cr_crd_act_acm_inf_dd A2 --信用卡账户汇总信息
--                  ON      A1.cr_crd_act_id = A2.cr_crd_act_id
--                  AND     A2.DT = '20240630'
--                  WHERE   A1.DT = '20240630'
--                  GROUP BY A1.cst_id
--              ) T9
-- ON      T1.cst_id = T9.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.dtrb_org <> 'ZJTLCB' AND A1.cls_dt >= '20240630' THEN 1
                                           ELSE 0
                                         END) AS 他行借贷笔数
                         ,SUM(A1.ovd_trm)     AS 客户逾期期数
                 FROM    (
                             SELECT  *
                                     ,RANK() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) AS RN
                             FROM    edw.dim_cst_ccrc_idv_loan_inf_dd --个人征信客户贷款信息
                             WHERE   DT = '20240630'
                         ) A1
                 WHERE   A1.RN = 1
                 AND     A1.act_typ_cd IN ( 'D1' , 'R1' , 'R4' )
                 AND     LENGTH(NVL(A1.cst_id, '')) > 0
                 GROUP BY A1.cst_id
                 UNION ALL
                 SELECT  A1.cst_id
                         ,COUNT(DISTINCT CASE
                                           WHEN A1.dtrb_org_typ_cd <> '' AND A1.cls_dt >= '20240630' THEN 1
                                           ELSE 0
                                         END) AS 他行借贷笔数
                         ,SUM(A1.ovd_mon)     AS 客户逾期期数
                 FROM    (
                             SELECT  *
                                     ,RANK() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) AS RN
                             FROM    edw.dim_cst_ccrc_entp_loan_inf_dd --企业征信客户贷款信息
                             WHERE   DT = '20240630'
                         ) A1
                 WHERE   A1.RN = 1
                 AND     A1.bus_pd_cls_cd = '11' --业务产品种类代码贷款
                 AND     LENGTH(NVL(A1.cst_id, '')) > 0
                 GROUP BY A1.cst_id
             ) T10
ON      T1.cst_id = T10.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.sam_rsk_ctrl_id
                         ,COALESCE(SUM(A3.gl_bal), 0) AS 同一风险存款余额
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.sam_rsk_ctrl_id = A2.sam_rsk_ctrl_id
                 AND     A2.sam_rsk_ctrl_id <> ''
                 AND     A2.DT = '20240630'
                 LEFT JOIN    edw.dws_bus_dep_act_inf_dd A3 --存款账户信息汇总
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 AND     A3.DT = '20240630'
                 WHERE   A1.DT = '20240630'
                 GROUP BY A1.cst_id , A1.sam_rsk_ctrl_id
             ) T11
ON      T1.cst_id = T11.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.sam_rsk_ctrl_id
                         ,COALESCE(SUM(A3.ctr_bal), 0) AS 同一风险贷款余额
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 LEFT JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.sam_rsk_ctrl_id = A2.sam_rsk_ctrl_id
                 AND     A2.sam_rsk_ctrl_id <> ''
                 AND     A2.DT = '20240630'
                 LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd A3 --信贷合同信息
                 ON      COALESCE(A2.cst_id, A1.cst_id) = A3.cst_id
                 AND     A3.DT = '20240630'
                 WHERE   A1.DT = '20240630'
                 GROUP BY A1.cst_id , A1.sam_rsk_ctrl_id
             ) T12
ON      T1.cst_id = T12.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T13 --个人征信指标信息表
ON      T1.cst_id = T13.cst_id
AND     T13.report_dsc_rn = 1
AND     T13.DT = '20240630'
WHERE   T1.DT = '20240630'
AND     T1.prm_org_id LIKE '3302%' --杭州分行
AND     T3.cst_id IS NOT NULL  --有信贷业务的客户
;

-- SELECT sum(一般贷款余额月日均) FROM lab_bigdata_dev.tmp_hz_youdaihu_SJ20240701126_02
**01-数据需求_分行_杭州分行_周微微_冠字号查询.sql
-- edw.dwd_bus_chnl_atm_trx_srl_di a --ATM流水
-- edw.dim_bus_dep_act_inf_dd t1 --存款账户，a.prm_act_id = t1.cst_act_id
--edw.gzhs_atm_tran_info a1  --ATM交易信息表
--edw.gzhs_cml_sent_infos_day a2  --纸币冠字号码日表,a1.c_id = a2.c_tran_id,a2.c_seria_no 现金冠字号

-- --atm_tran_info---自助机具的主交易表
-- cml_counter_record---柜面的主交易表
-- cml_sent_infos_day---冠字号详情表

-- 1、正常是自助机具或者柜面做了交易后，会在对应的主交易表中登记一条记录，包含设备编号，日期，交易账号，金额等等
-- 2、冠字号详情表会登记每一笔交易的冠字号详情
-- 3、比如自助机具取款10张100元，那么会在atm_tran_info有一条主交易记录，在cml_sent_infos_day中有10条冠字号的记录，因为是10张钱，两表间通过c_id字段关联


-- 需调取20240315，13：00-14：00期间的取款现金冠字号码。
-- （取款人户名：龚丽华，账号：6214808801030268284，取款金额11000元，流水号01602400000014，取款业务时间点20240315.13：36。）

DROP TABLE IF EXISTS temp_sjxq_zww_SJ2024091846 PURGE;

CREATE TABLE IF NOT EXISTS temp_sjxq_zww_SJ2024091846 AS
SELECT  a1.c_td_account_no 账号
        ,a3.kehuzhmc 账户名称
        ,a1.c_td_journal_no 交易流水号
        ,a1.c_tran_time 交易时间
        ,a1.i_tran_count 交易张数
        ,a1.i_td_tran_amt 交易金额
        ,a2.c_seria_no 纸币冠字号码
        ,a1.c_td_operator_id 交易柜员
FROM    edw.gzhs_cml_counter_record a1 --柜面交易表  --增量表
LEFT JOIN    edw.gzhs_cml_sent_infos_day a2 ----纸币冠字号码日表
ON      a1.c_id = a2.c_tran_id
AND     a2.dt = '20240315'
LEFT JOIN    edw.core_kdpa_kehuzh a3 --客户账号表
ON      a1.c_td_account_no = a3.kehuzhao
AND     a3.dt = '20240315'
WHERE   a1.dt = '20240315'
AND     a1.c_tran_time LIKE '20240315%'
AND     a1.c_td_account_no = '6214808801030268284'
;
**01-数据需求_分行_杭州分行_周方锴_用于内部管理排查.sql
--用于内部管理排查，2022年1月起至2024年5月31日，客户经理020352在信贷系统-快速统计查询-客户信息快速查询-对公/个人客户信息查询模块，查询了非其管护的客户信息的记录。
--客户名称/客户编号/查询时间/查询原因
DROP TABLE IF EXISTS tmp_zfk_SJ2024060701 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zfk_SJ2024060701 AS
SELECT  T.queryuserid 查询人工号
        ,T.querydate 查询日期
        ,T.querytime 查询时间
        ,CASE
           WHEN T.querytype = '010'              THEN '客户详情查看'
           WHEN T.querytype = '020'              THEN '客户风险提示查询'
           WHEN T.querytype IN ( '030' , '080' ) THEN '客户征信查询'
           WHEN T.querytype = '040'              THEN '客户账户查询'
           WHEN T.querytype = '050'              THEN '客户影像查询'
           WHEN T.querytype IN ( '060' , '070' ) THEN '客户外部数据查询'
         END AS 查询类型
        ,T.objectno 查询客户号
        ,T.objectname 查询客户名称
FROM    edw.LOAN_QUERY_LOG T --信贷查询日志
WHERE   T.dt = '@@{yyyyMMdd}'
AND     T.queryuserid = '020352'
AND     T.querydate BETWEEN '2022/01/01' AND '2024/05/31'
AND     T.objectno NOT IN (
                              SELECT  t1.cst_id
                              FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1
                              WHERE   T1.dt = '@@{yyyyMMdd}'
                              AND     T1.prm_mgr_id = '020352'
                           )  --剔除本人名下的管护客户
AND     T.objectno NOT IN (
                              SELECT  t1.cst_id
                              FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1
                              WHERE   T1.dt = '@@{yyyyMMdd}'
                              AND      t1.prm_org_id like '3302004%'  --剔除萧山支行
                           )  --剔除-剔除萧山支行的管护客户
;

--SELECT count(1) FROM tmp_zfk_SJ2024060701
**01-数据需求_分行_杭州分行_周晨辉_向萧山法院证明客户借出借据利率调整情况.sql
--合同号：BC2021012900003208，客户号：1042326888，随贷通卡号：6214809938000461520。
-- 1、客户该笔业务的2022-09-17至今所有借据的信息【包含合同流水号、借据流水号、借据金额、借据余额、借出时间（精确到年月日时分）、到期时间、借据利率】；
-- 2、客户该笔业务的随贷通贷款要素变更情况：客户该笔业务涉及借款利率下调，需要调取利率下调完成时间（精确到年月日时分）

-- 1、借据：合同流水号、借据流水号、借据金额、借据余额、借出时间（精确到年月日时分）、到期时间、借据利率；
-- 2、随贷通贷款要素变更情况：利率下调完成时间（精确到年月日时分）。

SELECT T.bus_ctr_id 合同号
       ,T.dbil_id 借据流水号
       ,T.cst_id 客户号
       ,T.amt 借据金额
       ,T.prcp_bal 借据余额
       ,T.dtrb_dt 借出时间
       ,T.apnt_mtu_day 到期时间
       ,T.exe_intr_rat 借据利率
FROM edw.dws_bus_loan_dbil_inf_dd T --贷款借据信息汇总
WHERE T.dt='@@{yyyyMMdd}'
and T.bus_ctr_id='BC2021012900003208'
and T.dtrb_dt>='20220917'
;

SELECT finishdate from edw.loan_creditchange_record where dt='@@{yyyyMMdd}' and contractno='BC2021012900003208';







-- SELECT T1.hetongbh,T1.dkjiejuh,T1.dkzhangh,T2.weihriqi,T2.weihriqi
--        --concat(T2.weihriqi,'-',T2.weihriqi) as jiechurq
-- from edw.core_klna_dkzhzb T1  --贷款账户主表
-- LEFT JOIN edw.core_klnl_dkkhmx T2 --贷款客户账户交易明细表
-- ON T1.dkjiejuh=T2.dkjiejuh
-- and T2.dt='@@{yyyyMMdd}'
-- and T2.mingxibh='1'   --放款
-- WHERE T1.dt='@@{yyyyMMdd}'
-- and T1.hetongbh='BC2021012900003208'
-- ;



-- --edw.core_klna_dkzhzb   --贷款账户主表
-- --edw.core_kclb_dkedjj  --贷款额度借据主表
**01-数据需求_分行_杭州分行_王萧_已批未放贷款余额_审批阶段的贷款余额.sql
--信贷需求调查表，2024年5月末分行业已批未放贷款余额、尚处于审批阶段的贷款余额，2023年5月末分行业已批未放贷款余额、尚处于审批阶段的贷款余额，杭州分行数据。

---已批未放贷款余额
DROP TABLE  if exists  TMP_SJ20240607116_ct_ypwf_20240531;
CREATE TABLE           TMP_SJ20240607116_ct_ypwf_20240531 AS
SELECT  t1.busi_ctr_id
        ,t1.loan_dir_cd
        ,t1.cst_id
        ,t1.cst_nm
        ,t1.pd_cd
        ,t2.pd_nm
        ,t1.ctr_amt
        ,t1.hpn_dt
        ,t1.apnt_mtu_dt
        ,t1.frz_sts_cd
        ,T1.ccy_cd
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'C' THEN t1.ctr_amt
           ELSE 0
         END AS 制造业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'C' AND datediff(to_date(t1.apnt_mtu_dt, 'yyyyMMdd'), to_date(t1.hpn_dt, 'yyyyMMdd'), 'dd') >= 366 THEN t1.ctr_amt
           ELSE 0
         END AS 制造业中长期贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'D' THEN t1.ctr_amt
           ELSE 0
         END AS 电力热力燃气及水生产和供应业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'G' THEN t1.ctr_amt
           ELSE 0
         END AS 交通运输仓储和邮政业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'L' THEN t1.ctr_amt
           ELSE 0
         END AS 租赁和商务服务业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'N' THEN t1.ctr_amt
           ELSE 0
         END AS 水利环境和公共设施管理业贷款余额
FROM    edw.dim_bus_loan_ctr_inf_dd t1
LEFT JOIN    edw.dim_bus_loan_pd_inf_dd t2
ON      t1.pd_cd = t2.pd_cd
AND     t2.dt = '20240531'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t1.hdl_org_id = t3.org_id
AND     t3.dt = '20240531'
left join edw.dim_cst_entp_bas_inf_dd t4
  on t1.cst_id=t4.cst_id
  and t4.dt='20240531'
WHERE   t1.dt = '20240531'
AND     LENGTH(t1.cst_id) = 10 --剔除合作行客户
AND     t1.cst_id <> '2000000001' --剔除公共客户号
AND     t3.cpy_org_nm <> '泰隆村镇银行' --剔除村行
and substr(t1.hdl_org_id,1,4)  in ('3302')  --杭州分行
AND     t1.pd_cd NOT IN ( '201040201010202' , '201040201010203' , '201040302020102' , '201040303010102' , '201040501020102' , '201040201010103' , '201040201010108' )
--剔除e票通-线上承兑额度、e票通-线上承兑单笔、非融资性保函、开立国内信用证\开立进口信用证\银行承兑汇票承兑-普惠\银行承兑汇票承兑-小企业等表外业务
AND     NVL(T1.frz_sts_cd, '') NOT IN ( '3' , '4' , '8' , '9' ) --剔除到期失效和终止失效
AND     NVL(T1.apnt_mtu_dt, '') > '20240531' --剔除到期日在8月之前
AND     t1.busi_ctr_id NOT IN (
                                  SELECT  DISTINCT bus_ctr_id
                                  FROM    edw.dim_bus_loan_dbil_inf_dd
                                  WHERE   dt = '20240531'
                              ) --合同编号不在借据表里的合同编号
AND     t1.ctr_bal = 0; --已批未放合同余额为0，合同余额大于0的为特殊业务需剔除


------已批未发结果表
DROP TABLE IF EXISTS TMP_SJ20240607116_ct_ypwf_JGB;

CREATE TABLE TMP_SJ20240607116_ct_ypwf_JGB AS
SELECT  '已批未发'  AS 类型
        , P1 . *
        ,P2.普惠小微贷款_人民币
FROM    (
            SELECT  '20240531' AS 日期
                    ,sum(ctr_amt) 各项贷款余额
                    ,sum(制造业贷款余额) 制造业贷款余额
                    ,sum(制造业中长期贷款余额) 制造业中长期贷款余额
                    ,sum(电力热力燃气及水生产和供应业贷款余额) 电力热力燃气及水生产和供应业贷款余额
                    ,sum(交通运输仓储和邮政业贷款余额) 交通运输仓储和邮政业贷款余额
                    ,sum(租赁和商务服务业贷款余额) 租赁和商务服务业贷款余额
                    ,sum(水利环境和公共设施管理业贷款余额) 水利环境和公共设施管理业贷款余额
            FROM    TMP_SJ20240607116_ct_ypwf_20240531
			UNION ALL
            SELECT  '20230531' AS 日期
                    ,sum(ctr_amt) 各项贷款余额
                    ,sum(制造业贷款余额) 制造业贷款余额
                    ,sum(制造业中长期贷款余额) 制造业中长期贷款余额
                    ,sum(电力热力燃气及水生产和供应业贷款余额) 电力热力燃气及水生产和供应业贷款余额
                    ,sum(交通运输仓储和邮政业贷款余额) 交通运输仓储和邮政业贷款余额
                    ,sum(租赁和商务服务业贷款余额) 租赁和商务服务业贷款余额
                    ,sum(水利环境和公共设施管理业贷款余额) 水利环境和公共设施管理业贷款余额
            FROM    TMP_SJ20240607116_ct_ypwf_20230531
        ) P1
LEFT JOIN    (
                 SELECT  SUM(T1.ctr_amt) AS 普惠小微贷款_人民币
                         ,'20240531'     AS 日期
                 FROM    (
                             SELECT  A . *
                                     ,CASE
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                            THEN '小型企业'
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                            THEN '微型企业'
                                        WHEN ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' OR c.cust_typ = '3' ) THEN '个体工商户' --对公对私均有个体工商户
                                        WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                         THEN '小微企业主'
                                      END AS 客户类型
                             FROM    TMP_SJ20240607116_ct_ypwf_20240531 A
                             LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
                             ON      a.cst_id = b.cust_id
                             AND     b.dt = '20240531'
                             LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
                             ON      a.cst_id = c.cust_id
                             AND     c.dt = '20240531'
                             LEFT JOIN    (
                                              SELECT  DISTINCT cust_id
                                                               ,acct_typ
                                              FROM    adm_upss.l_acct_loan --贷款借据信息表
                                              WHERE   dt = '20240531'
                                              AND     substr(acct_typ, 1, 4) = '0102' --经营性
                                          ) d
                             ON      a.cst_id = d.cust_id
                         ) T1
                 WHERE   ( T1.客户类型 IN ( '个体工商户' , '小微企业主' )
                        OR ( T1.客户类型 IN ( '小型企业' , '微型企业' ) AND ctr_amt <= 20000000 ) )
                 AND     T1.ccy_cd = '156'
                 UNION ALL
                 SELECT  SUM(T1.ctr_amt) AS 普惠小微贷款_人民币
                         ,'20230531'     AS 日期
                 FROM    (
                             SELECT  A . *
                                     ,CASE
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                            THEN '小型企业'
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                            THEN '微型企业'
                                        WHEN ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' OR c.cust_typ = '3' ) THEN '个体工商户' --对公对私均有个体工商户
                                        WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                         THEN '小微企业主'
                                      END AS 客户类型
                             FROM    TMP_SJ20240607116_ct_ypwf_20230531 A
                             LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
                             ON      a.cst_id = b.cust_id
                             AND     b.dt = '20230531'
                             LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
                             ON      a.cst_id = c.cust_id
                             AND     c.dt = '20230531'
                             LEFT JOIN    (
                                              SELECT  DISTINCT cust_id
                                                               ,acct_typ
                                              FROM    adm_upss.l_acct_loan --贷款借据信息表
                                              WHERE   dt = '20230531'
                                              AND     substr(acct_typ, 1, 4) = '0102' --经营性
                                          ) d
                             ON      a.cst_id = d.cust_id
                         ) T1
                 WHERE   ( T1.客户类型 IN ( '个体工商户' , '小微企业主' )
                        OR ( T1.客户类型 IN ( '小型企业' , '微型企业' ) AND ctr_amt <= 20000000 ) )
                 AND     T1.ccy_cd = '156'
             ) P2
ON      P1.日期 = P2.日期;

SELECT * FROM TMP_SJ20240607116_ct_ypwf_JGB


--尚处于审批阶段的贷款余额
DROP TABLE  if EXISTS   TMP_SJ20240607116_ct_scyspjd_20240531;
CREATE TABLE            TMP_SJ20240607116_ct_scyspjd_20240531 AS
SELECT  T.apl_id
        ,t.apl_amt
        ,t.pd_id
		    ,T.cst_id
        ,t.hpn_dt
        ,t.mtu_dt
		    ,T.ccy_cd
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'C' THEN t.apl_amt
           ELSE 0
         END AS 制造业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'C' AND datediff(to_date(t.mtu_dt, 'yyyyMMdd'), to_date(t.hpn_dt, 'yyyyMMdd'), 'dd') >= 366 THEN t.apl_amt
           ELSE 0
         END AS 制造业中长期贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'D' THEN t.apl_amt
           ELSE 0
         END AS 电力热力燃气及水生产和供应业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'G' THEN t.apl_amt
           ELSE 0
         END AS 交通运输仓储和邮政业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'L' THEN t.apl_amt
           ELSE 0
         END AS 租赁和商务服务业贷款余额
        ,CASE
           WHEN substr(t4.idt_ctg_cd, 1, 1) = 'N' THEN t.apl_amt
           ELSE 0
         END AS 水利环境和公共设施管理业贷款余额
FROM    edw.dwd_bus_loan_apl_inf_dd T
INNER JOIN    EDW.dwd_bus_loan_prcs_obj_tbl_dd T1
ON      T1.DT = '20240531'
AND     T1.obj_id = T.apl_id
AND     T1.APL_TYP IN ( 'CreditSingleApply' , 'CycleCardApply' , 'IndependentApply' , 'ConsumeCardApply' , 'DependentApply1' , 'IndependentApply1' , 'DependentApply' )
--单笔单批业务申请\随贷通卡业务申请\备用金贷款业务申请\贷款及贴现业务单笔申请\额度项下承兑业务申请\承兑业务单笔申请\额度项下贷款及贴现业务申请
AND     NVL(T1.stg_typ_cd, '') NOT IN ( '1050' , '1010' ) --剔除客户经理调查阶段和否决的业务
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t.hdl_org_id = t3.org_id
AND     t3.dt = '20240531'
left join edw.dim_cst_entp_bas_inf_dd t4
  on t.cst_id=t4.cst_id
  and t4.dt='20240531'
WHERE   T.DT = '20240531'
AND     NVL(T.hpn_typ_cd, '') NOT IN ( '620' , '630' , '640' , '660' ) --剔除卡片绑定额度调高、卡片绑定额度调低、授信终止、授信额度调高
AND     NVL(T.mtu_dt, '') > '20240531' --剔除到期日在8月之前
AND     t3.cpy_org_nm <> '泰隆村镇银行'
and substr(t.hdl_org_id,1,4)  in ('3302')  --杭州分行
AND     t.pd_id NOT IN ( '201040201010202' , '201040201010203' , '201040302020102' , '201040303010102' , '201040501020102' , '201040201010103' , '201040201010108' )
--剔除e票通-线上承兑额度、e票通-线上承兑单笔、非融资性保函、开立国内信用证\开立进口信用证\银行承兑汇票承兑-普惠\银行承兑汇票承兑-小企业等表外业务
AND     NVL(T.hpn_dt, '') > '20240430' --我行申请一般为一个月，剔除申请日期在一个月前的业务
AND     NOT EXISTS (
                       SELECT  'X'
                       FROM    EDW.dim_bus_loan_ctr_inf_dd T2
                       WHERE   T2.DT = '20240531'
                       AND     T2.busi_apl_id = T.apl_id
                   );


--审批阶段结果表
DROP TABLE IF EXISTS TMP_SJ20240607116_ct_scyspjd_JGB;

CREATE TABLE TMP_SJ20240607116_ct_scyspjd_JGB AS
SELECT  '审批阶段'  AS 类型
        , P1 . *
        ,P2.普惠小微贷款_人民币
FROM    (
            SELECT  '20240531' AS 日期
                    ,sum(apl_amt) 各项贷款余额
                    ,sum(制造业贷款余额) 制造业贷款余额
                    ,sum(制造业中长期贷款余额) 制造业中长期贷款余额
                    ,sum(电力热力燃气及水生产和供应业贷款余额) 电力热力燃气及水生产和供应业贷款余额
                    ,sum(交通运输仓储和邮政业贷款余额) 交通运输仓储和邮政业贷款余额
                    ,sum(租赁和商务服务业贷款余额) 租赁和商务服务业贷款余额
                    ,sum(水利环境和公共设施管理业贷款余额) 水利环境和公共设施管理业贷款余额
            FROM    TMP_SJ20240607116_ct_scyspjd_20240531
			UNION ALL
            SELECT  '20230531' AS 日期
                    ,sum(apl_amt) 各项贷款余额
                    ,sum(制造业贷款余额) 制造业贷款余额
                    ,sum(制造业中长期贷款余额) 制造业中长期贷款余额
                    ,sum(电力热力燃气及水生产和供应业贷款余额) 电力热力燃气及水生产和供应业贷款余额
                    ,sum(交通运输仓储和邮政业贷款余额) 交通运输仓储和邮政业贷款余额
                    ,sum(租赁和商务服务业贷款余额) 租赁和商务服务业贷款余额
                    ,sum(水利环境和公共设施管理业贷款余额) 水利环境和公共设施管理业贷款余额
            FROM    TMP_SJ20240607116_ct_scyspjd_20230531
			) P1
LEFT JOIN    (
                 SELECT  SUM(T1.apl_amt) AS 普惠小微贷款_人民币
                         ,'20240531'     AS 日期
                 FROM    (
                             SELECT  A . *
                                     ,CASE
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                            THEN '小型企业'
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                            THEN '微型企业'
                                        WHEN ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' OR c.cust_typ = '3' ) THEN '个体工商户' --对公对私均有个体工商户
                                        WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                         THEN '小微企业主'
                                      END AS 客户类型
                             FROM    TMP_SJ20240607116_ct_scyspjd_20240531 A
                             LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
                             ON      a.cst_id = b.cust_id
                             AND     b.dt = '20240531'
                             LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
                             ON      a.cst_id = c.cust_id
                             AND     c.dt = '20240531'
                             LEFT JOIN    (
                                              SELECT  DISTINCT cust_id
                                                               ,acct_typ
                                              FROM    adm_upss.l_acct_loan --贷款借据信息表
                                              WHERE   dt = '20240531'
                                              AND     substr(acct_typ, 1, 4) = '0102' --经营性
                                          ) d
                             ON      a.cst_id = d.cust_id
                         ) T1
                 WHERE   ( T1.客户类型 IN ( '个体工商户' , '小微企业主' )
                        OR ( T1.客户类型 IN ( '小型企业' , '微型企业' ) AND apl_amt <= 20000000 ) )
                 AND     T1.ccy_cd = '156'
                 UNION ALL
                 SELECT  SUM(T1.apl_amt) AS 普惠小微贷款_人民币
                         ,'20230531'     AS 日期
                 FROM    (
                             SELECT  A . *
                                     ,CASE
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'S'                            THEN '小型企业'
                                        WHEN ( c.cust_typ = '11' OR c.cust_typ = '12' ) AND c.corp_scale = 'T'                            THEN '微型企业'
                                        WHEN ( b.operate_cust_type_cbrc = 'A' AND substr(d.acct_typ, 1, 4) = '0102' OR c.cust_typ = '3' ) THEN '个体工商户' --对公对私均有个体工商户
                                        WHEN b.operate_cust_type_cbrc = 'B' AND substr(d.acct_typ, 1, 4) = '0102'                         THEN '小微企业主'
                                      END AS 客户类型
                             FROM    TMP_SJ20240607116_ct_scyspjd_20230531 A
                             LEFT JOIN    adm_upss.l_cust_p b --监管集市对私客户
                             ON      a.cst_id = b.cust_id
                             AND     b.dt = '20230531'
                             LEFT JOIN    adm_upss.l_cust_c c --监管集市对公客户
                             ON      a.cst_id = c.cust_id
                             AND     c.dt = '20230531'
                             LEFT JOIN    (
                                              SELECT  DISTINCT cust_id
                                                               ,acct_typ
                                              FROM    adm_upss.l_acct_loan --贷款借据信息表
                                              WHERE   dt = '20230531'
                                              AND     substr(acct_typ, 1, 4) = '0102' --经营性
                                          ) d
                             ON      a.cst_id = d.cust_id
                         ) T1
                 WHERE   ( T1.客户类型 IN ( '个体工商户' , '小微企业主' )
                        OR ( T1.客户类型 IN ( '小型企业' , '微型企业' ) AND apl_amt <= 20000000 ) )
                 AND     T1.ccy_cd = '156'
             ) P2
ON      P1.日期 = P2.日期;

-- SELECT * FROM  TMP_SJ20240607116_ct_scyspjd_JGB
**01-数据需求_分行_杭州分行_章炜_查询柜面查询记录.sql
-- 通过核心5116、2074、5112、5110口令查询过&ldquo;账号6214808801031378827，户名喻力荣，核心客户号1027563576&rdquo;相关流水的记录。



-- 查询人姓名、工号，查询时间

CREATE TABLE IF NOT EXISTS tmp_zw_SJ2024082351 as

select a.weihguiy 维护柜员工号

      ,b.empe_nm 维护柜员姓名

      ,a.weihriqi 维护日期

      ,a.weihshij 维护时间

      ,a.weihjigo 维护机构

      ,a.qudaohao 渠道

      ,a.qnqbwvar 请求报文

      ,a.jiaoyima 交易码

      ,a.waibclma 第三方交易码

      ,a.zhaiyoms 摘要代码

      ,a.zhaiyoms 摘要描述

from edw.core_kapb_jioybw a   -- 交易报文表

left join edw.dws_hr_empe_inf_dd b

on a.weihguiy=b.empe_id

and b.dt='@@{yyyyMMdd}'

where a.dt<='@@{yyyyMMdd}'

and a.dt>='20240101'

and a.jiaoyirq>='20240101'

and a.jiaoyirq<='@@{yyyyMMdd}'

and a.qudaohao='A01' --筛选柜面渠道

and (a.qnqbwvar like '%1027563576%' or a.qnqbwvar like '%330125197308054330%' or a.qnqbwvar like '%喻力荣%'  or a.qnqbwvar like '%6214808801031378827%' )  --请求报文varchar2型

and a.weihjigo like '3302%' --杭州分行

;



-- SELECT b.kehuhaoo,concat(b.zhjhaoma,'%') from  edw.core_kcfb_cfdsjc b  --对私客户基本信息表

-- WHERE b.dt='@@{yyyyMMdd}'

-- and b.kehuhaoo='1027563576'
**01-数据需求_分行_杭州分行_陶琨炜_用于查询杭州分行全量客户落在118个市场内的客户清单.sql
--用于查询杭州分行全量客户落在118个市场内的客户清单
--对杭州分行全量客户进行查询，通过调查报告里3个模块的内容，共模糊匹配7个关键词，关键词详见附件：&ldquo;杭州市辖内各市场统计&rdquo;excel里的E-K列，如果有任意一个关键词匹配命中
--，就在&ldquo;数据提取需求内容&rdquo;excel里生成一条数据（同一个客户可能生成多条），并在每一条数据的H列反显&ldquo;杭州市辖内各市场统计&rdquo;excel中C列的市场名称。
--客户号	客户名称	同一风险控制号	管户机构号	管户客户经理工号	手机号	经营地址（或其他登记过的地址）
--&quot;调查报告7项模糊匹配坐落的市场名称（《杭州市辖内各市场统计》表中C列的市场名称）'	&quot;客户类型标签（有效户、准有效户、睡眠户、沉睡客户）&quot;

--1、取杭州分行的客户信息
DROP TABLE if EXISTS tmp_sjxq_SJ20240612141_01 PURGE ;
create table IF NOT EXISTS  tmp_sjxq_SJ20240612141_01 AS
SELECT  P.cst_id
        ,P1.cst_chn_nm
        ,P.prm_org_id
        ,P.prm_org_nm
        ,P.prm_mgr_id
        ,P.prm_mgr_nm
        -- ,P1.mbl_nbr 手机号
        ,P1.sam_rsk_ctrl_id
        ,P2.efe_cst_ind
        ,P2.qefe_cst_ind
        ,P2.qefe_lost_cst_ind
        ,P2.qefe_slp_cst_ind
FROM    adm_pub.adm_csm_cbas_mng_inf_dd P --客户集市-客户基础-客户管户信息
LEFT JOIN    edw.dws_cst_bas_inf_dd P1 --客户基础信息汇总表
ON      P.cst_id = P1.cst_id
AND     P1.dt = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd P2 --客户集市-基础信息-客户基础标识信息
ON      P1.cst_id = P2.cst_id
AND     P2.dt = '@@{yyyyMMdd}'
WHERE   P.dt = '@@{yyyyMMdd}'
AND     p.prm_org_id LIKE '3302%'  --杭州分行
;

--2.取调查报告中的经营地址对应的市场名称
DROP TABLE IF EXISTS tmp_sjxq_SJ20240612141_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20240612141_02 AS
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.address4,t2.sc
FROM edw.loan_customer_address T1 --客户联系地址
--FROM  edw.dwd_bus_loan_cvy_opr_inf_dd T1  --信贷业务调查报告-客户经营信息
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.address4 RLIKE T2.jy01
and T2.jy01<>''
WHERE T1.DT='@@{yyyyMMdd}'
and T1.addtype = '40'  --经营
union
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.address4,t2.sc
FROM edw.loan_customer_address T1 --客户联系地址
--FROM  edw.dwd_bus_loan_cvy_opr_inf_dd T1  --信贷业务调查报告-客户经营信息
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.address4 RLIKE T2.jy02
and T2.jy02<>''
WHERE T1.DT='@@{yyyyMMdd}'
and T1.addtype = '40'  --经营
union
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.address4,t2.sc
FROM edw.loan_customer_address T1 --客户联系地址
--FROM  edw.dwd_bus_loan_cvy_opr_inf_dd T1  --信贷业务调查报告-客户经营信息
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.address4 RLIKE T2.jy03
and T2.jy03<>''
WHERE T1.DT='@@{yyyyMMdd}'
and T1.addtype = '40'  --经营
;

SELECT count(distinct customerid) FROM tmp_sjxq_SJ20240612141_02

--3.取调查报告中的经营基本情况分析，以及申请人及关联人的整体综合评价对应的市场名称
DROP TABLE IF EXISTS tmp_sjxq_SJ20240612141_03 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20240612141_03 AS
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.ad,t2.sc
FROM  (SELECT T.customerid
       ,case WHEN T.analysistype in ('040040','035020040','090010') then T.analysisinfo end as ad
FROM edw.loan_survey_analysis T --调查报告分析表：【经营基本情况分析表】，【申请人及关联人的整体综合评价】
WHERE T.dt='@@{yyyyMMdd}'
) T1
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.ad RLIKE T2.jyjb01
and T2.jyjb01 <>''
union
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.ad,t2.sc
FROM  (SELECT T.customerid
       ,case WHEN T.analysistype in ('040040','035020040','090010') then T.analysisinfo end as ad
FROM edw.loan_survey_analysis T --调查报告分析表：【经营基本情况分析表】，【申请人及关联人的整体综合评价】
WHERE T.dt='@@{yyyyMMdd}'
) T1
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.ad RLIKE T2.jyjb02
and T2.jyjb02 <>''
union
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.ad,t2.sc
FROM  (SELECT T.customerid
       ,case WHEN T.analysistype in ('040040','035020040','090010') then T.analysisinfo end as ad
FROM edw.loan_survey_analysis T --调查报告分析表：【经营基本情况分析表】，【申请人及关联人的整体综合评价】
WHERE T.dt='@@{yyyyMMdd}'
) T1
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.ad RLIKE T2.pj01
and T2.pj01 <>''
union
SELECT
   /*+ MAPJOIN (T2) */
   T1.customerid,T1.ad,t2.sc
FROM  (SELECT T.customerid
       ,case WHEN T.analysistype in ('040040','035020040','090010') then T.analysisinfo end as ad
FROM edw.loan_survey_analysis T --调查报告分析表：【经营基本情况分析表】，【申请人及关联人的整体综合评价】
WHERE T.dt='@@{yyyyMMdd}'
) T1
inner JOIN (SELECT * FROM  qbi_file_20240620_15_43_55 WHERE  pt=MAX_PT('qbi_file_20240620_15_43_55') ) T2
ON T1.ad RLIKE T2.pj02
and T2.pj02 <>''

-- SELECT count(1) from tmp_sjxq_SJ20240612141_03 limit 1000

--结果表
DROP TABLE IF EXISTS tmp_sjxq_SJ20240612141 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20240612141 AS
SELECT distinct T.cst_id 客户号
        ,T.cst_chn_nm 客户姓名
        ,T.prm_org_id 管护机构号
        ,T.prm_org_nm 管护机构名称
        ,T.prm_mgr_id 管护人工号
        ,T.prm_mgr_nm 管护人姓名
        -- ,T..mbl_nbr 手机号
        ,T.sam_rsk_ctrl_id 同一风险控制号
        ,T1.sc 市场1
        ,T2.sc 市场2
        ,T.efe_cst_ind 有效户标识
        ,T.qefe_cst_ind 准有效户标识
        ,T.qefe_lost_cst_ind 沉睡客户
        ,T.qefe_slp_cst_ind 睡眠户客户标识
from tmp_sjxq_SJ20240612141_01 T
left JOIN tmp_sjxq_SJ20240612141_02 T1
ON T.cst_id=T1.customerid
left join tmp_sjxq_SJ20240612141_03 T2
on T.cst_id=T2.customerid
;

CREATE TABLE IF NOT EXISTS smp_tkw_SJ20240612141 as
SELECT * FROM tmp_sjxq_SJ20240612141
WHERE (市场1 is not null or 市场2 is not null);

SELECT count(DISTINCT 客户号) FROM smp_tkw_SJ20240612141
**01-数据需求_分行_温州分行_王驰_贷款类商机_贷款类商机具体详见附件备注_未过期的客户明细.sql
--温州分行需要现有贷款类商机（贷款类商机具体详见附件备注）未过期的客户明细，同时需标注客户商机查看时间、商机客户跟进时间、商机客户转化时间。用于分析分行小鱼管家商机功能推动情况
--字段：商机类型	客户号	客户姓名	商机查看时间	商机跟进时间	商机转化时间
--需要他行贷款到期商机2.0版、普惠授信业务到期商机202406、无贷担保人配贷202406、贷款客户流失挽回202406、贷款提额商机202406、2024年5月存量信用卡配贷、取现信用卡客户配贷清单

SELECT T4.bank_oppt_id 行方商机id
       ,T4.succ_stat  --转化状态（1：已成功 2：未成功）
       ,T3.oppt_type 商机类型
       ,T3.oppt_type_name 商机类型名称
       ,T3.oppt_sub_type 商机子类型
       ,T3.oppt_sub_type_name 商机子类型名称
       ,T3.bank_oppt_batch_name 行方批次名称
       ,T4.oppt_bgn_dt 商机有效期起始日期
       ,T4.oppt_to_dt	商机有效期结束日期
       ,T4.cust_id 客户号
       ,T4.cust_name 客户姓名
       ,T4.follow_up_stat     --	跟进状态（0：未分配 1：未跟进 2：已跟进 9：已终止）
       ,T4.view_flag      --已读标志 1已读，0未读默认0
       ,T4.oppt_follow_date  商机跟进时间
       ,T4.oppt_succ_date 商机转化时间
       ,T4.oppt_batch_id 	所属批次id
from EDW.XWDT_MKC_OPPT_INFO T4  --商机信息表
LEFT JOIN EDW.XWDT_MKC_OPPT_BATCH T3  --商机批次表
ON T3.PK_ID=T4.OPPT_BATCH_ID
and T3.dt='@@{yyyyMMdd}'
WHERE T4.dt='@@{yyyyMMdd}'
-- and T4.oppt_to_dt>='@@{yyyyMMdd}'  --商机未失效
and coalesce(T4.oppt_batch_id,'')<>''
and   T4.oppt_succ_date is not null
;





SELECT
--T3.pk_id  --l	自增主键
     DISTINCT
     T3.oppt_type --	商机类型
     ,T3.oppt_type_name --商机类型名称
     ,T3.oppt_sub_type --商机子类型
     ,T3.oppt_sub_type_name  --商机子类型名称
FROM EDW.XWDT_MKC_OPPT_BATCH T3  --商机批次表
WHERE T3.dt='20240703';


--商机类型
-- oppt_type	oppt_type_name	oppt_sub_type	oppt_sub_type_name
-- 77	销售提升	89	存款提升
-- 77	销售提升	91	贷款提升
-- 77	销售提升	92	理财挖掘
-- 77	销售提升	93	信用卡挖掘
-- 77	销售提升	94	国际业务挖掘
-- 79	客户关怀	90	客户生日关怀
-- 79	客户关怀	100	生日关怀
-- 83	到期承接	95	理财续购
-- 83	到期承接	96	贷款续贷
-- 83	到期承接	97	定期续存
-- 84	业务挖潜	99	贷款挖潜
-- 84	业务挖潜	101	国际业务挖潜
-- 84	业务挖潜	102	信用卡挖潜
-- 84	业务挖潜	103	对公业务挖潜
-- 84	业务挖潜	104	理财挖潜
-- 84	业务挖潜	109	存款提升
-- 84	业务挖潜	110	财富挖潜
-- 85	厅堂识客	107	积分业务



--
SELECT  T.CASE_NO
        ,T.CASE_NAME
        ,T.CASE_PHASE
        ,T.CST_ID
        ,T.EXEC_DATE
        ,T.ADJUST_DUE_DATE
        ,T.INIT_DATE --取数日期
        ,T.REL_CST_ID --关联人
		,T.IS_SLF --是否本人
		,T2.BANK_OPPT_BATCH_NAME  --商机行方批次名称
		,T.PRM_FH_ORG_ID --'产效归属分行机构号'
        ,T.PRM_FH_ORG_NM --'产效归属分行机构名称'
        ,T.PRM_ZH_ORG_ID --'产效归属支行机构号'
        ,T.PRM_ZH_ORG_NM --'产效归属支行机构名称'
        ,T.PRM_TD_ORG_ID --'产效归属团队机构号'
        ,T.PRM_TD_ORG_NM --'产效归属团队名称'
        ,T.PRM_MGR_ID --'指定接收客户经理工号'
        ,T.PRM_EMPE_NM --'指定接收客户经理姓名'
		,MAX(COALESCE(T4.VIEW_FLAG,0)) AS VIEW_FLAG --查看 1已读，0未读
		,MAX(CASE WHEN T4.FOLLOW_UP_STAT='2' THEN 1 ELSE 0 END) AS IS_FOLLOW_UP  --跟进 0：未分配 1：未跟进 2：已跟进 转为1已跟进，0未跟进跟进
FROM     LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_CST_REL T
LEFT JOIN    LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_RECORD T2  --用例记录表 BANK_OPPT_BATCH_NAME 商机行方批次名称
ON      T.CASE_NO = T2.CASE_NO
AND     T.CASE_PHASE = T2.CASE_PHASE
LEFT JOIN EDW.XWDT_MKC_OPPT_BATCH T3  --商机批次表
ON T2.BANK_OPPT_BATCH_NAME=T3.BANK_OPPT_BATCH_NAME --行方批次名称
AND T3.DT='@@{yyyyMMdd}'
LEFT JOIN    EDW.XWDT_MKC_OPPT_INFO T4  --商机信息表
ON T3.PK_ID=T4.OPPT_BATCH_ID
AND    T.CST_ID=T4.CUST_ID
AND T4.DT='@@{yyyyMMdd}'
where coalesce(t4.oppt_batch_id,'')<>''  --立英必须加，不然不唯一
GROUP BY T.CASE_NO
        ,T.CASE_NAME
        ,T.CASE_PHASE
        ,T.CST_ID
        ,T.EXEC_DATE
        ,T.ADJUST_DUE_DATE
        ,T.INIT_DATE --取数日期
        ,T.REL_CST_ID --关联人
		,T.IS_SLF --是否本人
		,T2.BANK_OPPT_BATCH_NAME  --商机行方批次名称
		,T.PRM_FH_ORG_ID --'产效归属分行机构号'
        ,T.PRM_FH_ORG_NM --'产效归属分行机构名称'
        ,T.PRM_ZH_ORG_ID --'产效归属支行机构号'
        ,T.PRM_ZH_ORG_NM --'产效归属支行机构名称'
        ,T.PRM_TD_ORG_ID --'产效归属团队机构号'
        ,T.PRM_TD_ORG_NM --'产效归属团队名称'
        ,T.PRM_MGR_ID --'指定接收客户经理工号'
        ,T.PRM_EMPE_NM --'指定接收客户经理姓名'
;

		--商机
		,COALESCE(T5.VIEW_FLAG,0) AS VIEW_FLAG --查看 1已读，0未读
		,COALESCE(T5.IS_FOLLOW_UP,0) AS IS_FOLLOW_UP   --转为：1已跟进，0未跟进
		,COALESCE(T5.BANK_OPPT_BATCH_NAME,0) AS BANK_OPPT_BATCH_NAME  --商机行方批次名称
FROM    LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_CST_REL T
LEFT JOIN   LAB_BIGDATA_DEV.OPPO_CASE_VIEW_FOLLOW T5  --机跟进率查看率
ON      T.CASE_NO = T5.CASE_NO
AND     T.CASE_NAME = T5.CASE_NAME
AND     T.CASE_PHASE = T5.CASE_PHASE
AND     T.CST_ID = T5.CST_ID
AND     T.REL_CST_ID = T5.REL_CST_ID
;

SELECT * FROM LAB_BIGDATA_DEV.OPPO_CASE_VIEW_FOLLOW
SELECT * FROM LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_CST_REL
SELECT * FROM LAB_BIGDATA_DEV.WUSHAN_MARKET_CASE_RECORD
**01-数据需求_分行_湖州分行_姬晨延_虚拟币洗钱风险排查.sql
-- &quot;湖州分行所有满足以下条件的客户号：1.对私客户账户在回顾周期内累计交易总额>=10万元；2.对公客户账户在回顾周期内累计交易总额>=50万元&quot;
-- 是否满足条件：对私客户户籍地址涉及&ldquo;新疆&rdquo;或&ldquo;内蒙古&rdquo;或&ldquo;云南&rdquo;或&ldquo;四川&rdquo;或&ldquo;贵州&rdquo;
-- 是否满足条件：对私客户证件类型为&ldquo;B0400-港澳居民来往内地通行证&rdquo;或&ldquo;B0600-台湾居民来往大陆通行证&rdquo;或&ldquo;B3600-港澳居民居住证&rdquo;或&ldquo;B3700-台湾居民居住证&rdquo;
-- 是否满足条件：对公名称涉及&ldquo;科技&rdquo;或&ldquo;电子商务&rdquo;或&ldquo;广告&rdquo;机或&ldquo;咨询&rdquo;且成立时间晚于20230101
-- 是否满足条件：对公名称涉及&ldquo;科技&rdquo;或&ldquo;云&rdquo;或&ldquo;数字&rdquo;或&ldquo;网络&rdquo;或&ldquo;贸易&rdquo;或&ldquo;商行&rdquo;或&ldquo;工程&rdquo;且法定代表人年龄<=35
-- 是否满足条件：对公客户注册地址在国外
-- 是否满足条件：账户在回顾周期内发生交易的交易天数<=100
-- 是否满足条件：账户在回顾周期内单日发生持续交易（即一天24小时里客户账户交易小时数>=18小时）
-- 是否满足条件：账户在回顾周期内取现笔数>=10或累计取现总额>=20万元
-- 是否满足条件：交易备注涉及&ldquo;OTC&rdquo;或&ldquo;币&rdquo;或&ldquo;U&rdquo;或&ldquo;HB&rdquo;或&ldquo;GUSD&rdquo;或&ldquo;泰达&rdquo;或&ldquo;泰da&rdquo;或&ldquo;USDT&rdquo;或&ldquo;狗狗&rdquo;或&ldquo;DOGE&rdquo;或&ldquo;ETH&rdquo;或&ldquo;BTC&rdquo;或&ldquo;比特&rdquo;或&ldquo;矿机&rdquo;或&ldquo;节点&rdquo;或&ldquo;算力&rdquo;
-- 是否满足条件：账户在回顾周期内IP地址不为国内IP地址范围
-- 是否满足条件：IP地址涉及省份>=5
-- 该客户账户在回顾周期内交易总笔数
-- 该客户账户在回顾周期内交易总金额折合人民币


-- 湖州分行所有满足在2023年1月1日至2024年7月12日期间对私客户号累计交易总额>=10万元和对公客户号累计交易总额>=50万元的客户

-- ，在A列提供客户号，B列至L列反馈是否符合条件，M列提供该客户账户交易总笔数，N列提供该客户账户交易总金额


--1.1 客户交易流水信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156_01 AS
SELECT  B1.cst_id
        ,B1.cst_act_id
        ,COUNT(DISTINCT B1.trx_dt)      AS 交易天数
        ,MAX(B1.交易小时数)             AS 交易小时数
        ,SUM(B1.取现笔数)               AS 取现笔数
        ,SUM(B1.取现金额)               AS 取现金额
        ,MAX(B1.交易备注涉及关建字)     AS 交易备注涉及关建字
        ,SUM(B1.累计交易金额)           AS 累计交易金额
        ,SUM(B1.累计交易笔数)           AS 累计交易笔数
FROM    (
            SELECT  A1.cst_id
                    ,A1.cst_act_id
                    ,A2.trx_dt
                    ,COUNT(DISTINCT SUBSTR(A2.trx_tm, 1, 2))                                                                                AS 交易小时数
                    ,SUM(CASE WHEN A2.txt_code IN ( 'DP0203' , 'DP2137' ) THEN 1 ELSE 0 END)                                                AS 取现笔数   --取现 人脸识别无介质取现
                    ,SUM(CASE WHEN A2.txt_code IN ( 'DP0203' , 'DP2137' ) THEN A2.trx_amt * A3.cny_exr ELSE 0 END)                          AS 取现金额
                    ,SUM(A2.trx_amt * A3.cny_exr)                                                                                           AS 累计交易金额
                    ,COUNT(1)                                                                                                               AS 累计交易笔数
                --     ,MAX(CASE WHEN A2.cmt RLIKE 'OTC|币|U|HB|GUSD|泰达|泰da|USDT|狗狗|DOGE|ETH|BTC|比特|矿机|节点|算力' THEN 1 ELSE 0 END)  AS 交易备注涉及关建字
                    ,MAX(CASE WHEN A2.cmt RLIKE 'OTC|HB|GUSD|泰达|泰da|USDT|狗狗|DOGE|ETH|BTC|比特|矿机|节点|算力' THEN 1 ELSE 0 END)  AS 交易备注涉及关建字

            FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
            INNER JOIN    edw.dwd_bus_dep_bal_chg_dtl_di A2 --存款账户余额发生明细
            ON      A1.dep_act_id = A2.dep_act_id
            AND     A1.cst_act_id = A2.cst_act_id
            AND     A2.trx_amt > 0
            AND     A2.DT >= '20230101'
            AND     A2.DT <= '20240712'
            LEFT JOIN    edw.dim_bus_com_exr_inf_dd A3 --汇率信息
            ON      A2.trx_ccy_cd = A3.ccy_cd
            AND     A3.DT = '20240712'
            WHERE   A1.DT = '20240712'
            GROUP BY A1.cst_id , A1.cst_act_id , A2.trx_dt
        ) B1
GROUP BY B1.cst_id , B1.cst_act_id
;


--1.2 客户交易IP信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156_02 PURGE;

CREATE TABLE if not EXISTS lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156_02 AS
SELECT  A1.pmt_act_id
        ,MAX(CASE WHEN A1.ovs_ind = '1' THEN 1 ELSE 0 END)            AS 是否境外
        ,COUNT(DISTINCT CASE WHEN A1.pvc_nm <> '' THEN A1.pvc_nm END) AS IP地址涉及省份
FROM    edw.dwd_bus_chnl_elec_nb_idv_nb_all_trx_srl_di A1 --个人网银各渠道汇总流水信息
WHERE   A1.DT >= '20230101'
AND     A1.DT <= '20240712'
AND     A1.hst_rtn_err_cd = '000000' --交易成功
GROUP BY A1.pmt_act_id
UNION ALL
SELECT  A1.pmt_act_id
        ,MAX(CASE WHEN A1.ovs_ind = '1' THEN 1 ELSE 0 END)            AS 是否境外
        ,COUNT(DISTINCT CASE WHEN A1.pvc_nm <> '' THEN A1.pvc_nm END) AS IP地址涉及省份
FROM    edw.dwd_bus_chnl_elec_nb_entp_nb_all_trx_srl_di A1 --企业网银各渠道汇总流水信息
WHERE   A1.DT >= '20230101'
AND     A1.DT <= '20240712'
AND     A1.hst_rtn_err_cd = '000000' --交易成功
GROUP BY A1.pmt_act_id ;




--1.3 结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156 PURGE;

CREATE TABLE IF NOT EXISTS  lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156 AS
SELECT  T1.cst_id                                                                                                                                             AS 客户号
        ,T2.cst_act_id                                                                                                                                        AS 客户账户
        ,CASE WHEN T3.reg_adr RLIKE '新疆|内蒙古|云南|四川|贵州' THEN '是' ELSE '否' END                                                                      AS 对私客户户籍地址是否涉及关建字
        ,CASE WHEN T3.doc_typ_cd IN ( 'B0400' , 'B0600' , 'B3600' , 'B3700' ) THEN '是' ELSE '否' END                                                         AS 对私客户证件类型是否满足条件
        ,CASE WHEN T4.cst_nm RLIKE '科技|电子商务|广告|咨询' AND SUBSTR(REPLACE(T4.org_org_found_dt, '-', ''), 1, 8) >= '20230101' THEN '是' ELSE '否' END    AS 对公名称涉及关建字且成立时间晚于20230101
        ,CASE WHEN T4.cst_nm RLIKE '科技|云|数字|网络|贸易|商行|工程' AND SUBSTR(T1.DT, 1, 4) - SUBSTR(T51.bth_dt, 1, 4) <= 35 THEN '是' ELSE '否' END        AS 对公名称涉及关建字且法定代表人年龄小于35
        ,CASE WHEN T4.reg_cnr_cd <> '156' THEN '是' ELSE '否' END                                                                                             AS 对公客户注册地址是否在国外
        ,CASE WHEN T2.交易天数 <= 100 THEN '是' ELSE '否' END                                                                                                 AS 交易天数小于等于100
        ,CASE WHEN T2.交易小时数 >= 18 THEN '是' ELSE '否' END                                                                                                AS 单日交易小时数大于等于18
        ,CASE WHEN T2.取现笔数 >= 10 OR T2.取现金额 >= 200000 THEN '是' ELSE '否' END                                                                         AS 取现笔数大于等于10或累计取现总额大于等于20万元
        ,CASE WHEN T2.交易备注涉及关建字 = 1 THEN '是' ELSE '否' END                                                                                          AS 交易备注涉及关建字
        ,CASE WHEN T21.是否境外 = 1 THEN '是' ELSE '否' END                                                                                                   AS IP地址不为国内IP地址范围
        ,CASE WHEN T21.IP地址涉及省份 >= 5 THEN '是' ELSE '否' END                                                                                            AS IP地址涉及省份大于等于5
        ,T2.累计交易笔数
        ,T2.累计交易金额                                                                                                                                      AS 累计交易金额折人民币
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
INNER JOIN    lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156_01 T2 --客户交易流水信息
ON      T1.cst_id = T2.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156_02 T21 --客户交易IP信息
ON      T2.cst_act_id = T21.pmt_act_id
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20240712'
LEFT JOIN    edw.dim_cst_entp_bas_inf_dd T4 --企业客户基本信息
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20240712'
LEFT JOIN    edw.dim_cst_entp_lgp_inf_dd T5 --对公客户法人信息表
ON      T4.cst_id = T5.cst_id
AND     T5.DT = '20240712'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T51 --个人客户基本信息汇总表
ON      T5.lgp_cst_id = T51.cst_id
AND     T51.DT = '20240712'
WHERE   T1.DT = '20240712'
AND     T1.prm_org_id LIKE '3310%' --湖州分行
AND     (
          ( T3.cst_id IS NOT NULL AND 累计交易金额 >= '100000' ) --1.对私客户账户在回顾周期内累计交易总额>=10万元；
       OR ( T4.cst_id IS NOT NULL AND 累计交易金额 >= '500000' ) --2.对公客户账户在回顾周期内累计交易总额>=50万元
	   )
;



SELECT count(1) FROM lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156

SELECT count(1) FROM lab_bigdata_dev.tmp_hz_xnhb_fxq_SJ20240712156 where 交易备注涉及关建字='是'
;

SELECT * FROM tmp_hz_xnhb_fxq_SJ20240712156
**01-数据需求_分行_绍兴分行_陈佳涔_普惠消费营收考核.sql
--数据时间：2023.1-2024.4，客户经理每月消费业务相关数据
-- 数据范围：绍兴分行客户经理
-- 取数口径：同总行普惠消费营收考核口径
--字段：取数dt,上月dt,上年末dt,去年同期dt,机构编号,机构名称,机构维度,客户经理工号,客户经理姓名

-- 贷款标签、当月贷款ftp营收(万元)、当年贷款ftp营收(万元)、当月营收占比	利息收入月(万元)、余额累计月(万元)、收息率_月频	利息收入年(万元)、余额累计年、收息率_年频、
--月日均(万元)、当月新发放执行利率分子(万元)、新发放执行利率_当月



-----1.营收
drop table IF EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081_001 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081_001 as
SELECT  t1.bus_ctr_id
       ,T1.DT
        --,'${yyyyMMdd}'               AS acg_dt
        ,nvl(SUM(T2.SUM_FTP_MON), 0) AS FTP_INC_MON    --当月贷款ftp营收(元)
        ,nvl(SUM(T3.SUM_FTP_YR), 0)  AS FTP_INC_YR     --当年贷款ftp营收(元)
        -- ,nvl(SUM(T2.SUM_EVA_MON), 0) AS SUM_EVA_MON
        -- ,nvl(SUM(T3.SUM_EVA_YR), 0)  AS SUM_EVA_YR
        ,T2.assess_org_cd
        ,T2.assess_org_nm
        ,T2.mgr_no
        ,T2.mgr_nm
        ,sum(T2.avg_bal ) as sum_avg_bal  --月日均
        -- ,T2.data_dt
FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD T1 -------信贷借据信息
LEFT JOIN    (
                 SELECT  --T1.ACCT_NO
                        --  T1.data_dt
                         T1.t_acct_no   --借据号
						 ,T1.DT
                         ,SUM(T1.ORG_FTP_BUS_INC) AS SUM_FTP_MON  -- 月度FTP营收-机构考核
                        --  ,sum(t1.org_ec_profit)   AS SUM_EVA_MON  --最终经济利润-机构考核-累计值
                        ,T1.assess_org_cd
                        ,T1.assess_org_nm
                        ,T1.mgr_no
                        ,T1.mgr_nm
                        ,T1.avg_bal     --月日均
                 FROM    APP_IFTP.ADM_PAPP_FTP_EVA_ACCT_SUMM_RST_INF T1   --存贷款客户账户级汇总数据信息表
                 WHERE   T1.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
                 AND     T1.FREQ_DT = 'M'   --月
                 and     T1.prod_cd like '8101%'   --限定贷款产品
                 GROUP BY T1.DT,T1.avg_bal,T1.assess_org_cd,T1.assess_org_nm ,T1.mgr_no,T1.mgr_nm,T1.t_acct_no,T1.ACCT_NO
             ) T2
ON      T1.DBIL_ID = T2.t_acct_no
AND     T1.DT = T2.DT
LEFT JOIN    (
                 SELECT  --T1.ACCT_NO
                         T1.t_acct_no  --借据号
						 ,T1.DT
                         ,SUM(T1.ORG_FTP_BUS_INC) AS SUM_FTP_YR  --年度FTP营收-机构考核
                        --  ,sum(t1.org_ec_profit)   AS SUM_EVA_YR
                 FROM    APP_IFTP.ADM_PAPP_FTP_EVA_ACCT_SUMM_RST_INF T1  --存贷款客户账户级汇总数据信息表
                 WHERE   T1.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
                 AND     T1.FREQ_DT = 'Y'  --年
                 and     T1.prod_cd like '8101%'   --限定贷款产品
                 GROUP BY T1.DT,T1.t_acct_no
             ) T3
ON      T1.DBIL_ID = T3.t_acct_no
AND     T1.DT = T3.DT
WHERE   T1.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
--and substr(T2.assess_org_cd,1,4)='3307'--绍兴
GROUP BY T1.DT,T2.assess_org_cd,T2.assess_org_nm ,T2.mgr_no,T2.mgr_nm,t1.bus_ctr_id;

--SELECT * FROM lab_bigdata_dev.tmp_sjcq_SJ2024053081_001 WHERE sum_avg_bal is not null

------2.收息率
drop table IF EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081_002 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081_002 as
SELECT  t.bus_ctr_id
        ,T.DT
        ,t.sum_accint_month  --利息收入月
        ,t.sum_accbal_month  --余额累计月
        ,CASE
           WHEN t.sum_accbal_month = 0 THEN 0
           ELSE t.sum_accint_month / t.sum_accbal_month * 365 * 100
         END AS month_rat  --收息率_月频
        ,t.sum_accint_year   --利息收入年
        ,t.sum_accbal_year   --余额累计年
        ,CASE
           WHEN t.sum_accbal_year = 0 THEN 0
           ELSE t.sum_accint_year / t.sum_accbal_year * 365 * 100
         END AS year_rat --收息率_年频
FROM    (
            SELECT  t1.bus_ctr_id
			        ,T1.DT
                    ,nvl(SUM(t2.accint_month * T3.AVG_PRC / T3.QUO_UNT), 0) AS sum_accint_month  --利息收支月累计
                    ,nvl(sum(t2.accbal_month * T3.AVG_PRC / T3.QUO_UNT), 0) AS sum_accbal_month  --月累计余额
                    ,nvl(sum(t2.accint_year * T3.AVG_PRC / T3.QUO_UNT), 0)  AS sum_accint_year   --利息收支年累计
                    ,nvl(sum(t2.accbal_year * T3.AVG_PRC / T3.QUO_UNT), 0)  AS sum_accbal_year   --年累计余额
            FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD T1 -------信贷借据信息
            LEFT JOIN    app_iftp.adm_papp_ftp_eva_app_rst_ftp t2   --FTP当日结果集-EVA视角
            ON      T1.DBIL_ID = T2.t_acct_no
			AND     T1.DT = t2.DT
            AND     t2.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')

            AND     ( t2.accbal_month <> 0
                OR t2.accbal_quar <> 0
                OR t2.accbal_year <> 0 )
            LEFT JOIN    EDW.DIM_BUS_COM_EXR_INF_DD T3 --汇率信息表
            ON      T1.ccy_cd = T3.ccy_cd --币种代码
            AND     T1.DT = T3.DT
            AND     T3.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
            WHERE   t1.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
            GROUP BY t1.bus_ctr_id,T1.DT
        ) t;

------3.当月发放利率
drop table IF EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081_003 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081_003 as
SELECT  t.bus_ctr_id
         ,T.DT
        ,SUM(CASE
               WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
               WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
               WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
               ELSE 0
             END)      AS 当月新发放执行利率分子
        -- ,SUM(CASE
        --        WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
        --        WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
        --        WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
        --        ELSE 0
        --      END)      AS 当年新发放执行利率分子
        -- ,SUM(CASE
        --        WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --        WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --        WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --        ELSE 0
        --      END)      AS 当月新发放执行利率分母
        -- ,SUM(CASE
        --        WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --        WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --        WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --        ELSE 0
        --      END)      AS 当年新发放执行利率分母
        ,CASE
           WHEN SUM(CASE
                      WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
                      WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
                      WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
                      ELSE 0
                    END) = 0 THEN 0
           ELSE SUM(CASE
                      WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
                      WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
                      WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
                      ELSE 0
                    END) / SUM(CASE
                                 WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
                                 WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
                                 WHEN substr(T.DTRB_DT, 1, 6) = substr(T.DT, 1, 6) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
                                 ELSE 0
                               END) * 1.2
         END           AS 当月新发放执行利率
        -- ,CASE
        --    WHEN SUM(CASE
        --               WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --               WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --               WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --               ELSE 0
        --             END) = 0 THEN 0
        --    ELSE SUM(CASE
        --               WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
        --               WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
        --               WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 ) * T.EXE_INTR_RAT
        --               ELSE 0
        --             END) / SUM(CASE
        --                          WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT <> '18991231'                                 THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.END_DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --                          WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY <> '18991231' THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.APNT_MTU_DAY, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --                          WHEN substr(T.DTRB_DT, 1, 4) = substr(T.DT, 1, 4) AND T.END_DT = '18991231' AND T.APNT_MTU_DAY = '18991231'  THEN T.AMT * T5.AVG_PRC / T5.QUO_UNT * ( DATEDIFF(TO_DATE(T.DT, 'YYYYMMDD'), TO_DATE(T.DTRB_DT, 'YYYYMMDD'), 'DD') + 1 )
        --                          ELSE 0
        --                        END) * 1.2
        --  END           AS 当年新发放执行利率
FROM    EDW.DWS_BUS_LOAN_DBIL_INF_DD T   --借据
LEFT JOIN    EDW.DIM_BUS_COM_EXR_INF_DD T5 --汇率信息表
ON      T.CCY_CD = T5.CCY_CD --币种代码
AND     T.DT = T5.DT
AND     T5.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
WHERE   t.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
GROUP BY t.bus_ctr_id ,T.DT;

--SELECT * from lab_bigdata_dev.tmp_sjcq_SJ2024053081_003 WHERE 当月新发放执行利率分子 <>0


--结果表
drop table IF EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjcq_SJ2024053081 as
SELECT  T.DT AS 取数dt
       ,to_char(dateadd(to_date(concat(substr(t.dt,1,6),'01'),'yyyyMMdd'),-1,'dd'),'yyyyMMdd') AS  上月dt
	   ,to_char(dateadd(DATETRUNC(to_date(t1.dt,'yyyyMMdd'),'yyyy'),-1,'dd'),'yyyyMMdd')  AS  上年末dt
       ,TO_CHAR(DATEADD(TO_DATE(t1.dt,'YYYYMMDD'),-1,'YYYY'),'YYYYMMDD') AS 去年同期dt
        ,T1.assess_org_cd 考核机构号
        ,T1.assess_org_nm 考核机构名称
        ,T1.mgr_no 客户经理编号
        ,T1.mgr_nm 客户经理名称
        --,org.org_rltn_dim_nm 机构维度
        --,T4.pd_nm 产品名称
        ,T1.FTP_INC_MON 当月贷款ftp营收_元
        ,T1.FTP_INC_YR 当年贷款ftp营收_元
        ,T1.sum_avg_bal 月日均
        ,T2.sum_accint_month 利息收入月
        ,T2.sum_accbal_month 余额累计月
        ,T2.month_rat 收息率_月频
        ,T2.sum_accint_year 利息收入年
        ,T2.sum_accbal_year 余额累计年
        ,T2.year_rat 收息率_年频
        ,T3.当月新发放执行利率分子
        ,T3.当月新发放执行利率
from edw.dim_bus_loan_ctr_inf_dd T  --信贷合同信息
LEFT  JOIN   lab_bigdata_dev.tmp_sjcq_SJ2024053081_001 T1
on T.busi_ctr_id=T1.bus_ctr_id
AND    T.DT = T1.DT
-- left join edw.dim_hr_org_sum_org_rel_dd org -- 汇总机构映射关系
-- on T1.assess_org_cd=org.sum_org_id
-- AND    T.DT = org.DT
-- and org.DT IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
left join lab_bigdata_dev.tmp_sjcq_SJ2024053081_002 T2
on T.busi_ctr_id=T2.bus_ctr_id
AND    T.DT = T2.DT
left JOIN lab_bigdata_dev.tmp_sjcq_SJ2024053081_003 T3
on T.busi_ctr_id=T3.bus_ctr_id
AND    T.DT = T3.DT
left join edw.dim_bus_loan_pd_inf_dd T4  --信贷产品信息
ON T.pd_cd=T4.pd_cd
and T.DT = T4.DT
WHERE T.dt IN ('20230131','20230228','20230331','20230430','20230531','20230630','20230731','20230831','20230930','20231031','20231130','20231231','20240131','20240229','20240331','20240430')
--产品编码201050101%，及2010503%贷款用途02%的业务范围（剔除员工贷款、重组贷款）
and (T.pd_cd like '201050101%'
OR  (  substr(T.pd_cd,1,7)='2010503' and T.loan_usg_cd like '02%' )
)
AND  t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P','J' ) --剔除 员工,重组贷款
and substr(T1.assess_org_cd,1,4)='3307'  --绍兴分行
;

--SELECT * FROM lab_bigdata_dev.tmp_sjcq_SJ2024053081
**01-数据需求_分行_绍兴分行_马子奇_绍兴市名特优新个体工商户名单_取数.sql
-- 为了分析我行对于&ldquo;名特优新&rdquo;客户的贷款服务情况，人行、市监局等较为关注该指标。
--统一社会信用代码、名称、客户号、当前是否存在信贷合同、是否存在已结清信贷合同

DROP TABLE IF EXISTS tmp_mzq_SJ2024071841 PURGE;

CREATE TABLE IF NOT EXISTS tmp_mzq_SJ2024071841 AS
SELECT  T.col_1 统一社会信用代码
        ,T1.cst_id 客户号
        ,coalesce(T1.cst_chn_nm, P.entname) 企业名称
        ,CASE
           WHEN T1.cst_id IN (
                                 SELECT  cst_id
                                 FROM    edw.dim_bus_loan_ctr_inf_dd
                                 WHERE   dt = '@@{yyyyMMdd}'
                             ) THEN '1'
           ELSE '0'
         END AS 当前是否存在信贷合同
        ,CASE
           WHEN T1.cst_id IN (
                                 SELECT  cst_id
                                 FROM    edw.dim_bus_loan_ctr_inf_dd
                                 WHERE   dt = '@@{yyyyMMdd}' AND end_dt <> '18991231'
                             ) THEN '1'
           ELSE '0'
         END AS 是否存在已结清信贷合同
FROM    qbi_file_20240719_09_37_49 T
LEFT JOIN    edw.dws_cst_bas_inf_dd T1 --客户基础信息汇总表
ON      T.col_1 = T1.doc_nbr
AND     T1.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  *
                 FROM    (
                             SELECT  t.socialcreditcode
                                     ,t.entname
                                     ,ROW_NUMBER() OVER ( PARTITION BY t.entid ORDER BY t.dt DESC ) rn
                             FROM    edw.nout_gs_label_total_sub t --企业标签总表(工商库展业地区铺底数据)
                             WHERE   t.dt <= '@@{yyyyMMdd}'
                         ) q
                 WHERE   q.rn = 1
             ) P
ON      T.col_1 = P.socialcreditcode
WHERE   pt = MAX_PT('qbi_file_20240719_09_37_49')
;


-- SELECT COUNT(1) FROM tmp_mzq_SJ2024071841







-- SELECT cb.cst_id
--        ,cb.doc_typ_cd
--        ,cb.doc_nbr
--        ,cb.cst_typ_cd
-- FROM edw.dim_cst_bas_doc_inf_dd cb --客户证件，A0100'，统一社会信用代码，A0500，营业执照
-- WHERE cb.dt='20240718'
-- and cb.doc_nbr='92330602MA288TET7T'
-- ;

-- SELECT doc_nbr,doc_typ_cd FROM edw.dws_cst_bas_inf_dd WHERE dt='20240718';


-- SELECT *
-- FROM edw.dwd_code_library_dd
-- WHERE dt='20240701'
-- and tbl_nm=upper('dim_cst_bas_doc_inf_dd')
-- and fld_nm=upper('doc_typ_cd')
**01-数据需求_总行普惠_SJ2024011551_总行普惠_谢乐冰_智能通知存款产品优化.sql
--取数日期：2024.1.15、全行数据包括村行。智能通知存款产品优化，停办原产品自动开立子户功能需通知客户，故获取清单下发至客户经理。智能通知存款和通知存款共同一个产品号，自助取数清单无法区分。

--字段：日期、客户号、客户名称、存款子账户、开户日期、开户机构、余额、管护机构、管护客户经理工号、管护客户经理姓名、管护比例

--负债账户（核心）=存款子账户（数仓），理财账户=存款账户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zntzck_20240118 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zntzck_20240118 AS
SELECT  a.dt 日期
        ,a.kehuzhao 客户账号
     -- ,concat(a.kehuzhao,'%') 客户账号
        ,a.kehuhaoo 客户号
        ,c.act_nm 客户名称
        ,b.licazhao 理财账户
        --,c.dep_act_id 存款子账户
        ,c.opn_dt 开户日期
        ,c.opn_org 开户机构编号
        ,c.gl_bal 余额
        ,round(c.last_90_days_gl_bal_acml/90,2) 近三个月日均
        ,d.acs_org_id 管护机构编号
        ,F.org_nm 管护机构名称
        ,d.mgr_id 管护客户经理工号
        ,E.empe_nm 管护客户经理姓名
        ,d.mgr_rto 管护比例
FROM    edw.core_kdpb_zhlcqy a ----账户理财签约登记簿
INNER JOIN    edw.core_kdpb_lckaih b ---理财开户表
ON      a.kehuzhao = b.kehuzhao
AND     b.dt = 20240122
--	产品编号
AND     b.chapbhao = '00201030600'
LEFT JOIN    edw.dws_bus_dep_act_inf_dd c --存款账户信息汇总
ON      b.licazhao = c.dep_act_id
AND     c.dt = 20240122
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd d ---客户存款账户管护信息
ON      a.kehuzhao = d.cst_act_id
AND     d.dt = 20240122
LEFT JOIN    EDW.dws_hr_empe_inf_dd E --员工汇总信息表
ON      D.mgr_id = E.empe_id
AND     E.DT = 20240122
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd F --机构树_考核维度表
ON      D.acs_org_id = F.org_id
AND     F.DT = 20240122
WHERE   1 = 1
AND     a.dt = 20240122
--业务签约状态
AND     a.ywqyztai = '1'
--资金转移产品号
AND     a.zjzychap = '998809'
;
**01-数据需求_总行普惠_SJ2024011776_总行普惠_杨菲_消费贷款流失挽回和未来到期客户续贷.sql
--需求；消费贷款流失挽回和未来到期客户的续贷提醒

--1、流失部分：上一笔消费贷款合同终结日期在2023.6.30-当前日期的客户，且客户当前无生效消费性贷款合同；


--2、未来到期部分：当前最后一笔消费合同到期日在2024.4.30前，且客户当前消费性贷款合同未到期、未终结;

--3、之前他行贷款加权平均利率=求和（银行贷款额度*贷款利率）/贷款金额总额，是除以的所有他行机构数，需要调整为推测出利率的机构数

--4、他行贷款的情况需要区分银行机构贷款和非银机构贷款

--字段1：当前是否有他银行消费贷款/当前有他银行消费贷款合同金额合计/当前有他银行消费贷款余额/当前有他银行消费贷款加权平均利率/当前有他银行消费贷款最高利率/当前他行消费贷款最低利率/他行3个月内即将到期金额

--字段2：是否有非银行机构消费贷款/非银行机构消费性贷款金额/非银行机构消费性贷款余额/非银行机构消费贷款加权平均利率
DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_zhengxin PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_zhengxin AS
SELECT  t1.report_id
        -- ,SUM(CASE
        --        WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) THEN t1.ctr_amt
        --        WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' )  THEN t1.ctr_amt
        --        ELSE 0
        --      END) 他行消费性贷款金额
        , t2.cst_id
        ,SUM(CASE
               WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )   THEN t1.act_crd_lmt
               WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )   THEN t1.ctr_amt
               WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' ) THEN t1.ctr_amt
               ELSE 0
             END) 其他银行消费性贷款金额
        ,SUM(CASE
               WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )  THEN t1.ctr_bal
               WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )  THEN t1.ctr_bal
               ELSE 0
             END) 其他银行消费性贷款余额
        -- ,round(SUM(CASE
        --        WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) THEN t1.ctr_amt * t3.intr_rat
        --        WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' )  THEN t1.ctr_amt * t3.intr_rat
        --        ELSE 0
        --      END) / SUM(CASE
        --                   WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) THEN t1.ctr_amt
        --                   WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' )  THEN t1.ctr_amt
        --                   ELSE 1
        --                 END),2) 他行消费贷款加权平均利率
        ,CASE
           WHEN SUM(CASE
                      WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.act_crd_lmt
                      WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.ctr_amt
                      WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )  THEN t1.ctr_amt
                      ELSE 1
                    END) = '0' THEN '0'
           ELSE round(SUM(CASE
                            WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )    THEN t1.act_crd_lmt * t3.intr_rat
                            WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )    THEN t1.ctr_amt * t3.intr_rat
                            WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' ) THEN t1.ctr_amt * t3.intr_rat
                            ELSE 0
                          END) / SUM(CASE
                                       WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' ) AND T3.INTR_RAT IS NOT NULL  AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.act_crd_lmt
                                       WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' ) AND T3.INTR_RAT IS NOT NULL  AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.ctr_amt
                                       WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND T3.INTR_RAT IS NOT NULL AND nvl(T1.dtrb_org_typ_cd,'') IN ( '11' , '12' , '14' , '15' , '16' ) THEN t1.ctr_amt
                                       ELSE 1   --默认分母=1
                                     END), 2)
         END 其他银行消费贷款加权平均利率
        -- ,round(MAX(CASE
        --              WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) THEN t3.intr_rat
        --              WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' )  THEN t3.intr_rat
        --              ELSE 0
        --            END), 2) 他行消费性贷款最高利率
        ,SUM(CASE
               WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )   THEN t1.act_crd_lmt
               WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )   THEN t1.ctr_amt
               WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' ) THEN t1.ctr_amt
               ELSE 0
             END) 其他非银行消费性贷款金额
        ,SUM(CASE
               WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )  THEN t1.ctr_bal
               WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )  THEN t1.ctr_bal
               ELSE 0
             END) 其他非银行消费性贷款余额
         ,CASE
           WHEN SUM(CASE
                      WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.act_crd_lmt
                      WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.ctr_amt
                      WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )  THEN t1.ctr_amt
                      ELSE 1
                    END) = '0' THEN '0'
           ELSE round(SUM(CASE
                            WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )    THEN t1.act_crd_lmt * t3.intr_rat
                            WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' )  AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )    THEN t1.ctr_amt * t3.intr_rat
                            WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' ) THEN t1.ctr_amt * t3.intr_rat
                            ELSE 0
                          END) / SUM(CASE
                                       WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' ) AND T3.INTR_RAT IS NOT NULL  AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.act_crd_lmt
                                       WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' ) AND T3.INTR_RAT IS NOT NULL  AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' )           THEN t1.ctr_amt
                                       WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND T3.INTR_RAT IS NOT NULL AND nvl(T1.dtrb_org_typ_cd,'') not IN ( '11' , '12' , '14' , '15' , '16' ) THEN t1.ctr_amt
                                       ELSE 1   --默认分母=1
                                     END), 2)
         END 其他非银行消费贷款加权平均利率
        ,round(MAX(CASE
                     WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' )            THEN t3.intr_rat
                     WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' )            THEN t3.intr_rat
                     WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) THEN t3.intr_rat
                     ELSE 0
                   END), 2) 他行消费性贷款最高利率
        -- ,round(MIN(CASE
        --              WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) THEN t3.intr_rat
        --              WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' )  THEN t3.intr_rat
        --              ELSE 0
        --            END), 2) 他行消费性贷款最低利率
        ,round(MIN(CASE
                     WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' )            THEN t3.intr_rat
                     WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' )            THEN t3.intr_rat
                     WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) THEN t3.intr_rat
                     ELSE 0
                   END), 2) 他行消费性贷款最低利率
        -- ,SUM(CASE
        --        WHEN T1.act_typ_cd IN ( 'R1' , 'R4' ) AND t1.act_sts_cd NOT IN ( '3' ) AND t1.mtu_dt <> '18991231' AND t1.mtu_dt >= '@@{yyyyMMdd}' AND datediff(to_date(t1.mtu_dt, 'yyyymmdd'), to_date('@@{yyyyMMdd}', 'yyyymmdd'), 'mm') <= 3 THEN t1.ctr_amt
        --        WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND t1.mtu_dt <> '18991231' AND t1.mtu_dt >= '@@{yyyyMMdd}' AND datediff(to_date(t1.mtu_dt, 'yyyymmdd'), to_date('@@{yyyyMMdd}', 'yyyymmdd'), 'mm') <= 3  THEN t1.ctr_amt
        --        ELSE 0
        --      END) 他行消费性贷款3个月内即将到期金额
        ,SUM(CASE
               WHEN T1.act_typ_cd = 'R1' AND t1.act_sts_cd NOT IN ( '3' ) AND t1.mtu_dt <> '18991231' AND t1.mtu_dt >= '@@{yyyyMMdd}' AND datediff(to_date(t1.mtu_dt, 'yyyymmdd'), to_date('@@{yyyyMMdd}', 'yyyymmdd'), 'mm') <= 3            THEN t1.act_crd_lmt
               WHEN T1.act_typ_cd = 'R4' AND t1.act_sts_cd NOT IN ( '3' ) AND t1.mtu_dt <> '18991231' AND t1.mtu_dt >= '@@{yyyyMMdd}' AND datediff(to_date(t1.mtu_dt, 'yyyymmdd'), to_date('@@{yyyyMMdd}', 'yyyymmdd'), 'mm') <= 3            THEN t1.ctr_amt
               WHEN T1.act_typ_cd IN ( 'D1' ) AND t1.act_sts_cd NOT IN ( '3' , '5' ) AND t1.mtu_dt <> '18991231' AND t1.mtu_dt >= '@@{yyyyMMdd}' AND datediff(to_date(t1.mtu_dt, 'yyyymmdd'), to_date('@@{yyyyMMdd}', 'yyyymmdd'), 'mm') <= 3 THEN t1.ctr_amt
               ELSE 0
             END) 他行消费性贷款3个月内即将到期金额        --未到期且近3个月
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd t1 --个人征信客户贷款信息
INNER JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd t2 --个人征信指标信息表
ON      t1.report_id = t2.report_no
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.report_dsc_rn = '1' --最新一期
LEFT JOIN    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t3 --个人征信借贷账户利率计算
ON      t1.report_id = t3.crd_rpt_id
AND     t1.act_id = t3.act_id
AND     t3.dt = '@@{yyyyMMdd}'
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.pd_cd IN ( '21' , '53' , '91' )
AND     t1.act_typ_cd IN ( 'D1' , 'R1' , 'R4' )
AND     T1.dtrb_org <> 'ZJTLCB'
AND     ( ( T1.act_typ_cd IN ( 'R1' , 'R4' )
AND     t1.act_sts_cd NOT IN ( '3' ) )
    OR ( T1.act_typ_cd IN ( 'D1' )
AND     t1.act_sts_cd NOT IN ( '3' , '5' ) ) )
-- AND    t1.ctr_amt > 0
GROUP BY t1.report_id , t2.cst_id;



-- 1、流失客户清单      select * from lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi01
----1.1  2023.6.30到当前日期已结清的合同数据
DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi01 purge;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi01 AS
SELECT  q1 . *
FROM    (
            SELECT  t1.cst_id 客户号
                    ,t1.cst_chn_nm 客户名称
                    ,coalesce(t8.cd_val_dscr, t7.loan_cst_typ_cd) 客户类型
                    ,t1.age 客户年龄
                    ,CASE
                       WHEN t1.gdr_cd = '1' THEN '男'
                       WHEN t1.gdr_cd = '2' THEN '女'
                     END 客户性别
                    ,CASE
                       WHEN T1.reg_adr_dtl_inf RLIKE SUBSTR(T5.brc_org_nm, 1, 2) THEN '1'
                       ELSE '0'
                     END AS 是否本地户籍
                    ,t1.fm_ind 是否农户
                    ,coalesce(t10.cd_val_dscr, t1.hi_acdm_deg_cd) 最高学历
                    ,t1.job_unt_nm 工作单位名称
                    ,CASE
                       WHEN t12.bus_ctr_id IS NOT NULL THEN '1'
                       ELSE '0'
                     END 是否风险客户
                    ,t2.busi_ctr_id 上一笔消费贷款合同流水号
                    ,coalesce(t6.pd_nm, t2.pd_cd) 上一笔消费贷款产品码值
                    ,t2.end_dt 上一笔消费贷款终结日期
                    ,t2.apnt_start_dt 上一笔消费贷款开始日期
                    ,t2.apnt_mtu_dt 上一笔消费贷款到期日期
                    --,t2.frz_sts_cd --冻结状态代码
                    ,t2.ctr_amt 上一笔消费贷款合同金额
                    ,t2.ctr_bal 上一笔消费贷款合同余额
                    ,t2.intr_rat 上一笔消费贷款利率
                    ,CASE
                       WHEN coalesce(t11.last_360_days_prcp_bal_acml, 0) > 0 THEN '1'
                       ELSE '0'
                     END 上一笔消费贷款近360天是否用信
                    ,t14.last_year_acm_prcp_bal_acml_avg 上一笔消费贷款2022年末日均余额
                    ,t3.aum_bal 当前AUM余额
                    ,t3.fnc_amt 其中_理财余额
                    ,t3.fund_amt as 其中_基金余额
                    ,t3.insu_amt as 其中_保险余额
                    ,t3.wlth_bal-t3.fund_amt-t3.fnc_amt-t3.insu_amt as 其中_其他财富产品余额
                    ,t13.dep_bal 其中_存款余额
                    ,t5.brc_org_nm 上一笔消费贷款管户分行
                    ,t5.sbr_org_nm 上一笔消费贷款管户支行
                    ,t5.tem_org_nm 上一笔消费贷款管户团队
                    ,t4.acs_mngr_id 上一笔消费贷款管户经理工号
                    ,t9.empe_nm 上一笔消费贷款管户经理姓名
                    ,row_number() OVER ( PARTITION BY t1.cst_id ORDER BY t2.end_dt DESC ) rn        --
            FROM    adm_pub.adm_csm_cbas_idv_bas_inf_dd t1 --客户集市-客户基础-对私客户基础信息
            INNER JOIN    edw.dim_bus_loan_ctr_inf_dd t2 --信贷合同信息
            ON      t1.cst_id = t2.cst_id
            AND     t2.dt = '@@{yyyyMMdd}'
            LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd t3 --客户集市-业务信息-客户金融资产信息表
            ON      t1.cst_id = t3.cst_id
            AND     t3.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd t4 --信贷合同管护信息
            ON      t2.busi_ctr_id = t4.busi_ctr_id
            AND     t4.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t5 --机构树_考核维度
            ON      t4.acs_org_id = t5.org_id
            AND     t5.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_bus_loan_pd_inf_dd t6 --信贷产品消息
            ON      t2.pd_cd = t6.pd_cd
            AND     t6.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_cst_bas_inf_dd t7 -- 客户基本信息
            ON      t1.cst_id = t7.cst_id
            AND     t7.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_code_library_dd t8
            ON      t7.loan_cst_typ_cd = t8.cd_val
            AND     t8.fld_nm = upper('loan_cst_typ_cd')
            AND     t8.tbl_nm = 'DIM_CST_BAS_INF_DD'
            AND     t8.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dws_hr_empe_inf_dd t9 --员工汇总信息
            ON      t4.acs_mngr_id = t9.empe_id
            AND     t9.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_code_library_dd t10
            ON      t1.hi_acdm_deg_cd = t10.cd_val
            AND     t10.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
            AND     t10.fld_nm = 'HI_ACDM_DEG_CD'
            AND     t10.dt = '@@{yyyyMMdd}'
            LEFT JOIN    (
                             SELECT  bus_ctr_id
                                     ,sum(last_360_days_prcp_bal_acml)  last_360_days_prcp_bal_acml
                             FROM    edw.dws_bus_loan_dbil_acm_inf_dd --信贷借据累计汇总信息
                             WHERE   dt = '@@{yyyyMMdd}'
                             GROUP BY bus_ctr_id
                         ) t11
            ON      t2.busi_ctr_id = t11.bus_ctr_id
            LEFT JOIN    (
                             SELECT  DISTINCT bus_ctr_id
                             FROM    edw.dws_bus_loan_dbil_inf_dd --贷款借据信息汇总
                             WHERE   dt = '@@{yyyyMMdd}'
                             AND     ovd_day > 30
                         ) t12
            ON      t2.busi_ctr_id = t12.bus_ctr_id
            LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd t13 --客户集市-业务信息-客户存款业务信息表
            ON      t2.cst_id = t13.cst_id
            AND     t13.dt = '@@{yyyyMMdd}'
            LEFT JOIN    (
                             SELECT  bus_ctr_id
                                     ,round(sum(year_acm_prcp_bal_acml) / 365, 2) last_year_acm_prcp_bal_acml_avg
                             FROM    edw.dws_bus_loan_dbil_acm_inf_dd --信贷借据累计汇总信息
                             WHERE   dt = '20221231'
                             GROUP BY bus_ctr_id
                         ) t14
            ON      t2.busi_ctr_id = t14.bus_ctr_id
            WHERE   t1.dt = '@@{yyyyMMdd}'
            AND     T2.BUS_CD NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
            AND     ( T2.CHNL_CD <> 'L08'
                OR T2.PD_CD <> '201050101040335' ) --剔除 小鱼分期
            AND     T2.PD_CD <> '201050101040332' --剔除 蚂蚁借呗
            AND     T2.PD_CD <> '201050101040319' --剔除百度分期贷
            AND     ( T2.PD_CD NOT IN ( '201050102010146' , '201050101040348' )
                OR T2.FRZ_STS_CD <> '' ) --剔除未签约的泰e贷
            AND     ( T2.PD_CD LIKE '201050101%'
                OR ( T2.PD_CD LIKE '2010503%'
            AND     T2.LOAN_USG_CD LIKE '02%' ) )
            AND     t2.end_dt >= '20230630'
            AND     t2.end_dt <= '@@{yyyyMMdd}'
            AND     SUBSTR(t5.brc_org_id, 3, 1) <> '6'
        ) q1
WHERE   q1.rn = 1;



----1.2  在1.1基础上剔除t2中的客户数据（当前生效的消费性贷款合同数据）
DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi02;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi02 AS
SELECT  t1 . *
        ,CASE
           WHEN t4.cst_id IS NOT NULL AND t4.其他银行消费性贷款金额>0 THEN '1'
           ELSE '0'
         END 是否有其他银行消费贷款
        ,t4.其他银行消费性贷款金额
        ,t4.其他银行消费性贷款余额
        ,t4.其他银行消费贷款加权平均利率
        ,CASE
           WHEN t4.cst_id IS NOT NULL  AND t4.其他非银行消费性贷款金额>0 THEN '1'
           ELSE '0'
         END 是否有其他非银行消费贷款
        ,t4.其他非银行消费性贷款金额
        ,t4.其他非银行消费性贷款余额
        ,t4.其他非银行消费贷款加权平均利率
        ,t4.他行消费性贷款最高利率
        ,t4.他行消费性贷款最低利率
        ,t4.他行消费性贷款3个月内即将到期金额
        ,CASE
           WHEN t3.cst_id IS NOT NULL THEN '1'
           ELSE '0'
         END 当前是否有生效经营性贷款
        ,t3.busi_ctr_id 当前生效经营性贷款合同流水号
        ,t3.pd_nm 当前生效经营性贷款产品编号码值
        ,t3.apnt_start_dt 当前生效经营性贷款合同起始日期
        ,t3.ctr_amt 当前生效经营性贷款合同金额
        ,t3.ctr_bal 当前生效经营性贷款合同余额
        ,t3.brc_org_nm 当前生效经营性贷款管户分行
        ,t3.sbr_org_nm 当前生效经营性贷款管户支行
        ,t3.tem_org_nm 当前生效经营性贷款管户团队
        ,t3.acs_mngr_id 当前生效经营性贷款管户经理工号
        ,t3.empe_nm 当前生效经营性贷款管户经理姓名
        ,t5.aum_bal 上一笔消费贷结清时点AUM余额
        ,t6.dep_bal 上一笔消费贷结清时点存款余额
FROM    lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi01 t1 --上一笔消费贷款
LEFT JOIN    lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_zhengxin t4 --他行征信
ON      t1.客户号 = t4.cst_id
LEFT JOIN    (
                 SELECT  DISTINCT a.cst_id
                 FROM    edw.dim_bus_loan_ctr_inf_dd a --信贷合同信息
                 LEFT JOIN    edw.dim_bus_loan_pd_inf_dd b --信贷产品消息
                 ON      a.pd_cd = b.pd_cd
                 AND     b.dt = '@@{yyyyMMdd}'
                 WHERE   a.dt = '@@{yyyyMMdd}'
                 AND     a.BUS_CD NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
                 AND     ( a.CHNL_CD <> 'L08'
                     OR a.PD_CD <> '201050101040335' ) --剔除 小鱼分期
                 AND     a.PD_CD <> '201050101040332' --剔除 蚂蚁借呗
                 AND     a.PD_CD <> '201050101040319' --剔除百度分期贷
                 AND     ( a.PD_CD NOT IN ( '201050102010146' , '201050101040348' )
                     OR a.FRZ_STS_CD <> '' ) --剔除未签约的泰e贷
                 AND     ( a.PD_CD LIKE '201050101%'
                     OR ( a.PD_CD LIKE '2010503%'
                 AND     a.LOAN_USG_CD LIKE '02%' ) )
                 AND     ( ( ( a.ctr_bal > 0
                     OR ( a.ctr_bal IS NULL
                 AND     nvl(a.crc_ind, '0') = '0' )
                     OR ( ( nvl(a.crc_ind, '0') <> '0'
                     OR a.pd_cd LIKE '2010503%' )
                 AND     ( a.ctr_bal = 0
                     OR a.ctr_bal IS NULL )
                 AND     a.apnt_mtu_dt >= a.dt ) )
                 AND     nvl(a.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
                     OR ( a.ctr_bal > 0
                 AND     a.pd_cd LIKE '2010503%'
                 AND     a.apnt_mtu_dt <= a.dt
                 AND     a.frz_sts_cd IN ( '3' , '4' ) ) )
             ) t2
ON      t1.客户号 = t2.cst_id
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.busi_ctr_id
                         ,a.apnt_start_dt
                         ,a.ctr_amt
                         ,a.ctr_bal
                         ,coalesce(b.pd_nm, a.pd_cd) pd_nm
                         ,d.brc_org_nm
                         ,d.sbr_org_nm
                         ,d.tem_org_nm
                         ,c.acs_mngr_id
                         ,e.empe_nm
                         ,row_number() OVER ( PARTITION BY a.cst_id ORDER BY a.apnt_start_dt DESC ) rn
                 FROM    edw.dim_bus_loan_ctr_inf_dd a --信贷合同信息
                 LEFT JOIN    edw.dim_bus_loan_pd_inf_dd b --信贷产品消息
                 ON      a.pd_cd = b.pd_cd
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd c --信贷合同管护信息
                 ON      a.busi_ctr_id = c.busi_ctr_id
                 AND     c.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd d --机构树_考核维度
                 ON      c.acs_org_id = d.org_id
                 AND     d.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dws_hr_empe_inf_dd e --员工汇总信息
                 ON      c.acs_mngr_id = e.empe_id
                 AND     e.dt = '@@{yyyyMMdd}'
                 WHERE   a.dt = '@@{yyyyMMdd}'
                 AND     a.BUS_CD NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
                 AND     ( a.CHNL_CD <> 'L08'
                     OR a.PD_CD <> '201050101040335' ) --剔除 小鱼分期
                 AND     a.PD_CD <> '201050101040332' --剔除 蚂蚁借呗
                 AND     a.PD_CD <> '201050101040319' --剔除百度分期贷
                 AND     ( a.PD_CD NOT IN ( '201050102010146' , '201050101040348' )
                     OR a.FRZ_STS_CD <> '' ) --剔除未签约的泰e贷
                 AND     ( a.PD_CD LIKE '201050102%'
                     OR ( a.PD_CD LIKE '2010503%'
                 AND     a.LOAN_USG_CD LIKE '01%' ) ) --个人一般经营性贷款、经营用途随贷通
                 AND     ( ( ( a.ctr_bal > 0
                     OR ( a.ctr_bal IS NULL
                 AND     nvl(a.crc_ind, '0') = '0' )
                     OR ( ( nvl(a.crc_ind, '0') <> '0'
                     OR a.pd_cd LIKE '2010503%' )
                 AND     ( a.ctr_bal = 0
                     OR a.ctr_bal IS NULL )
                 AND     a.apnt_mtu_dt >= a.dt ) )
                 AND     nvl(a.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
                     OR ( a.ctr_bal > 0
                 AND     a.pd_cd LIKE '2010503%'
                 AND     a.apnt_mtu_dt <= a.dt
                 AND     a.frz_sts_cd IN ( '3' , '4' ) ) )
             ) t3 --经营性贷款
ON      t1.客户号 = t3.cst_id
AND     t3.rn = 1
LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd t5 --客户集市-业务信息-客户金融资产信息表
ON      t1.客户号 = t5.cst_id
AND     t5.dt = t1.上一笔消费贷款终结日期
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd t6 --客户集市-业务信息-客户存款业务信息表
ON      t1.客户号 = t6.cst_id
AND     t6.dt = t1.上一笔消费贷款终结日期
WHERE   t2.cst_id IS NULL --当前无生效消费性贷款
;


--select * from lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi03
DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi03 purge;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi03 AS
SELECT  t1 . *
        ,t2.sub_cmnt_nm 子社区名称
        ,t3.com_vindicate_id 主维护人ID
        ,t3.com_vindicate_name 主维护人名称
FROM    lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi02 t1
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t2 --客户社区信息
ON      t1.客户号 = t2.cst_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.sub_cmnt_id <> ''
LEFT JOIN    edw.xwdt_xw_community t3 --社区信息表
ON      t2.sub_cmnt_id = t3.COM_CODE
AND     t3.dt = '@@{yyyyMMdd}';

----------------------------------------------------------
-------------------------------------------------------------------
--未来到期部分：当前最后一笔消费合同到期日在2024.4.30前，且客户当前消费性贷款合同未到期、未终结;
--2.到期客户清单

DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi01 AS
SELECT  q1 . *
FROM    (
            SELECT  t1.cst_id 客户号
                    ,t1.cst_chn_nm 客户名称
                    ,coalesce(t8.cd_val_dscr, t7.loan_cst_typ_cd) 客户类型
                    ,t1.age 客户年龄
                    ,CASE
                       WHEN t1.gdr_cd = '1' THEN '男'
                       WHEN t1.gdr_cd = '2' THEN '女'
                     END 客户性别
                    ,CASE
                       WHEN T1.reg_adr_dtl_inf RLIKE SUBSTR(T5.brc_org_nm, 1, 2) THEN '1'
                       ELSE '0'
                     END AS 是否本地户籍
                    ,t1.fm_ind 是否农户
                    ,coalesce(t10.cd_val_dscr, t1.hi_acdm_deg_cd) 最高学历
                    ,t1.job_unt_nm 工作单位名称
                    ,CASE
                       WHEN t12.bus_ctr_id IS NOT NULL THEN '1'
                       ELSE '0'
                     END 是否风险客户
                    ,t2.busi_ctr_id 当前最后一笔消费贷款合同编号
                    ,coalesce(t6.pd_nm, t2.pd_cd) 当前最后一笔消费贷款产品码值
                    ,t2.end_dt 当前最后一笔消费贷款终结日期
                    ,t2.apnt_start_dt 当前最后一笔消费贷款开始日期
                    ,t2.apnt_mtu_dt 当前最后一笔消费贷款到期日期
                    --,t2.frz_sts_cd --冻结状态代码
                    ,t2.ctr_amt 当前最后一笔消费贷款合同金额
                    ,t2.ctr_bal 当前最后一笔消费贷款合同余额
                    ,t2.intr_rat 当前最后一笔消费贷款利率
                    ,CASE
                       WHEN coalesce(t11.last_180_days_prcp_bal_acml, 0) > 0 THEN '1'
                       ELSE '0'
                     END 当前最后一笔消费贷款近180天是否用信
                    ,t11.year_acm_prcp_bal_acml_avg 本年年日均余额
                    ,t3.aum_bal 当前AUM余额
                    ,t3.fnc_amt 其中_理财余额
                    ,t3.fund_amt as 其中_基金余额
                    ,t3.insu_amt as 其中_保险余额
                    ,t3.wlth_bal-t3.fund_amt-t3.fnc_amt-t3.insu_amt as 其中_其他财富产品余额
                    ,t13.dep_bal 其中_存款余额
                    ,t5.brc_org_nm 当前最后一笔消费贷款管户分行
                    ,t5.sbr_org_nm 当前最后一笔消费贷款管户支行
                    ,t5.tem_org_nm 当前最后一笔消费贷款管户团队
                    ,t4.acs_mngr_id 当前最后一笔消费贷款管户经理工号
                    ,t9.empe_nm 当前最后一笔消费贷款管户经理姓名
                    ,row_number() OVER ( PARTITION BY t1.cst_id ORDER BY t2.apnt_mtu_dt DESC ) rn
            FROM    adm_pub.adm_csm_cbas_idv_bas_inf_dd t1 --客户集市-客户基础-对私客户基础信息
            INNER JOIN    edw.dim_bus_loan_ctr_inf_dd t2 --信贷合同信息
            ON      t1.cst_id = t2.cst_id
            AND     t2.dt = '@@{yyyyMMdd}'
            LEFT JOIN    adm_pub.adm_csm_cbus_cst_fin_ast_inf_dd t3 --客户集市-业务信息-客户金融资产信息表
            ON      t1.cst_id = t3.cst_id
            AND     t3.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd t4 --信贷合同管护信息
            ON      t2.busi_ctr_id = t4.busi_ctr_id
            AND     t4.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t5 --机构树_考核维度
            ON      t4.acs_org_id = t5.org_id
            AND     t5.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_bus_loan_pd_inf_dd t6 --信贷产品消息
            ON      t2.pd_cd = t6.pd_cd
            AND     t6.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_cst_bas_inf_dd t7 -- 客户基本信息
            ON      t1.cst_id = t7.cst_id
            AND     t7.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_code_library_dd t8
            ON      t7.loan_cst_typ_cd = t8.cd_val
            AND     t8.fld_nm = upper('loan_cst_typ_cd')
            AND     t8.tbl_nm = 'DIM_CST_BAS_INF_DD'
            AND     t8.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dws_hr_empe_inf_dd t9 --员工汇总信息
            ON      t4.acs_mngr_id = t9.empe_id
            AND     t9.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dwd_code_library_dd t10
            ON      t1.hi_acdm_deg_cd = t10.cd_val
            AND     t10.tbl_nm = 'DIM_CST_IDV_BAS_INF_DD'
            AND     t10.fld_nm = 'HI_ACDM_DEG_CD'
            AND     t10.dt = '@@{yyyyMMdd}'
            LEFT JOIN    (
                             SELECT  bus_ctr_id
                                     ,sum(last_180_days_prcp_bal_acml) last_180_days_prcp_bal_acml
                                     ,sum(year_acm_prcp_bal_acml) / ( datediff(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date('20230101', 'yyyymmdd'), 'dd') + 1 ) year_acm_prcp_bal_acml_avg
                             FROM    edw.dws_bus_loan_dbil_acm_inf_dd --信贷借据累计汇总信息
                             WHERE   dt = '@@{yyyyMMdd}'
                             GROUP BY bus_ctr_id
                         ) t11
            ON      t2.busi_ctr_id = t11.bus_ctr_id
            LEFT JOIN    (
                             SELECT  DISTINCT bus_ctr_id
                             FROM    edw.dws_bus_loan_dbil_inf_dd --贷款借据信息汇总
                             WHERE   dt = '@@{yyyyMMdd}'
                             AND     ovd_day > 30
                         ) t12
            ON      t2.busi_ctr_id = t12.bus_ctr_id
            LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd t13 --客户集市-业务信息-客户存款业务信息表
            ON      t2.cst_id = t13.cst_id
            AND     t13.dt = '@@{yyyyMMdd}'
            WHERE   t1.dt = '@@{yyyyMMdd}'
            AND     T2.BUS_CD NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
            AND     ( T2.CHNL_CD <> 'L08'
                OR T2.PD_CD <> '201050101040335' ) --剔除 小鱼分期
            AND     T2.PD_CD <> '201050101040332' --剔除 蚂蚁借呗
            AND     T2.PD_CD <> '201050101040319' --剔除百度分期贷
            AND     ( T2.PD_CD NOT IN ( '201050102010146' , '201050101040348' )
                OR T2.FRZ_STS_CD <> '' ) --剔除未签约的泰e贷
            AND     ( T2.PD_CD LIKE '201050101%'
                OR ( T2.PD_CD LIKE '2010503%'
            AND     T2.LOAN_USG_CD LIKE '02%' ) )
            --AND     t2.apnt_mtu_dt <= '20231231'
            AND     SUBSTR(t5.brc_org_id, 3, 1) <> '6'
            AND     ( ( ( t2.ctr_bal > 0
                OR ( t2.ctr_bal IS NULL
            AND     nvl(t2.crc_ind, '0') = '0' )
                OR ( ( nvl(t2.crc_ind, '0') <> '0'
                OR t2.pd_cd LIKE '2010503%' )
            AND     ( t2.ctr_bal = 0
                OR t2.ctr_bal IS NULL )
            AND     t2.apnt_mtu_dt >= t2.dt ) )
            AND     nvl(t2.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
                OR ( t2.ctr_bal > 0
            AND     t2.pd_cd LIKE '2010503%'
            AND     t2.apnt_mtu_dt <= t2.dt
            AND     t2.frz_sts_cd IN ( '3' , '4' ) ) )
        ) q1
WHERE   q1.rn = 1
AND     q1.当前最后一笔消费贷款到期日期<='20240430';



DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi02 AS
SELECT  t1 . *
        ,t2.ctr_cnt 当前生效消费贷合同数
        ,t2.ctr_amt 当前生效消费贷合同金额
        ,t2.ACTL_START_USE_CRD_LMT 当前生效消费贷启用金额
        ,t2.ctr_bal 当前生效消费贷余额
        -- ,CASE
        --    WHEN t4.cst_id IS NOT NULL THEN '1'
        --    ELSE '0'
        --  END 是否有他行消费贷款
        -- ,t4.他行消费性贷款金额
        -- ,t4.他行消费性贷款余额
        -- ,t4.他行消费贷款加权平均利率
        ,CASE
           WHEN t4.cst_id IS NOT NULL AND t4.其他银行消费性贷款金额>0 THEN '1'
           ELSE '0'
         END 是否有其他银行消费贷款
        ,t4.其他银行消费性贷款金额
        ,t4.其他银行消费性贷款余额
        ,t4.其他银行消费贷款加权平均利率
        ,CASE
           WHEN t4.cst_id IS NOT NULL AND t4.其他非银行消费性贷款金额>0 THEN '1'
           ELSE '0'
         END 是否有其他非银行消费贷款
        ,t4.其他非银行消费性贷款金额
        ,t4.其他非银行消费性贷款余额
        ,t4.其他非银行消费贷款加权平均利率
        ,t4.他行消费性贷款最高利率
        ,t4.他行消费性贷款最低利率
        ,t4.他行消费性贷款3个月内即将到期金额
        ,CASE
           WHEN t3.cst_id IS NOT NULL THEN '1'
           ELSE '0'
         END 当前是否有生效经营性贷款
        ,t3.busi_ctr_id 当前生效经营性贷款合同流水号
        ,t3.pd_nm 当前生效经营性贷款产品编号码值
        ,t3.apnt_start_dt 当前生效经营性贷款合同起始日期
        ,t3.ctr_amt 当前生效经营性贷款合同金额
        ,t3.ctr_bal 当前生效经营性贷款合同余额
        ,t3.brc_org_nm 当前生效经营性贷款管户分行
        ,t3.sbr_org_nm 当前生效经营性贷款管户支行
        ,t3.tem_org_nm 当前生效经营性贷款管户团队
        ,t3.acs_mngr_id 当前生效经营性贷款管户经理工号
        ,t3.empe_nm 当前生效经营性贷款管户经理姓名
FROM    lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi01 t1 --当前最后一笔消费贷款
LEFT JOIN    lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_zhengxin t4 --他行征信
ON      t1.客户号 = t4.cst_id
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,count(DISTINCT a.busi_ctr_id) ctr_cnt
                         ,sum(a.ctr_amt) ctr_amt
                         ,sum(a.ctr_bal) ctr_bal
                         ,sum(CASE
                                WHEN T2.BUS_CTR_ID IS NOT NULL                                       THEN T2.BIND_LMT
                                WHEN T2.BUS_CTR_ID IS NULL AND T6.ACTL_START_USE_CRD_LMT IS NOT NULL THEN T6.ACTL_START_USE_CRD_LMT
                                ELSE a.CTR_AMT
                              END) ACTL_START_USE_CRD_LMT
                 FROM    edw.dim_bus_loan_ctr_inf_dd a --信贷合同信息
                 LEFT JOIN    edw.dim_bus_loan_pd_inf_dd b --信贷产品消息
                 ON      a.pd_cd = b.pd_cd
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    EDW.DWD_BUS_LOAN_FNC_CRD_LMT_INF_DD T2 ----随贷通授信额度信息
                 ON      a.BUSI_CTR_ID = T2.BUS_CTR_ID
                 AND     T2.LOAN_USG_CD = '2' --随贷通消费性贷款
                 AND     T2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  T6 . *
                                          ,ROW_NUMBER() OVER ( PARTITION BY T6.BUS_CTR_ID ORDER BY T6.UPD_DT DESC ) RN
                                  FROM    EDW.DIM_BUS_LOAN_CRC_CTR_INF_DD T6 --循环贷款合同信息
                                  WHERE   T6.DT = '@@{yyyyMMdd}'
                              ) T6
                 ON      a.BUSI_CTR_ID = T6.BUS_CTR_ID
                 AND     T6.RN = 1
                 WHERE   a.dt = '@@{yyyyMMdd}'
                 AND     a.BUS_CD NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
                 AND     ( a.CHNL_CD <> 'L08'
                     OR a.PD_CD <> '201050101040335' ) --剔除 小鱼分期
                 AND     a.PD_CD <> '201050101040332' --剔除 蚂蚁借呗
                 AND     a.PD_CD <> '201050101040319' --剔除百度分期贷
                 AND     ( a.PD_CD NOT IN ( '201050102010146' , '201050101040348' )
                     OR a.FRZ_STS_CD <> '' ) --剔除未签约的泰e贷
                 AND     ( a.PD_CD LIKE '201050101%'
                     OR ( a.PD_CD LIKE '2010503%'
                 AND     a.LOAN_USG_CD LIKE '02%' ) )
                 AND     ( ( ( a.ctr_bal > 0
                     OR ( a.ctr_bal IS NULL
                 AND     nvl(a.crc_ind, '0') = '0' )
                     OR ( ( nvl(a.crc_ind, '0') <> '0'
                     OR a.pd_cd LIKE '2010503%' )
                 AND     ( a.ctr_bal = 0
                     OR a.ctr_bal IS NULL )
                 AND     a.apnt_mtu_dt >= a.dt ) )
                 AND     nvl(a.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
                     OR ( a.ctr_bal > 0
                 AND     a.pd_cd LIKE '2010503%'
                 AND     a.apnt_mtu_dt <= a.dt
                 AND     a.frz_sts_cd IN ( '3' , '4' ) ) )
                 GROUP BY a.cst_id
             ) t2
ON      t1.客户号 = t2.cst_id
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.busi_ctr_id
                         ,a.apnt_start_dt
                         ,a.ctr_amt
                         ,a.ctr_bal
                         ,coalesce(b.pd_nm, a.pd_cd) pd_nm
                         ,d.brc_org_nm
                         ,d.sbr_org_nm
                         ,d.tem_org_nm
                         ,c.acs_mngr_id
                         ,e.empe_nm
                         ,row_number() OVER ( PARTITION BY a.cst_id ORDER BY a.apnt_start_dt DESC ) rn
                 FROM    edw.dim_bus_loan_ctr_inf_dd a --信贷合同信息
                 LEFT JOIN    edw.dim_bus_loan_pd_inf_dd b --信贷产品消息
                 ON      a.pd_cd = b.pd_cd
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd c --信贷合同管护信息
                 ON      a.busi_ctr_id = c.busi_ctr_id
                 AND     c.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd d --机构树_考核维度
                 ON      c.acs_org_id = d.org_id
                 AND     d.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dws_hr_empe_inf_dd e --员工汇总信息
                 ON      c.acs_mngr_id = e.empe_id
                 AND     e.dt = '@@{yyyyMMdd}'
                 WHERE   a.dt = '@@{yyyyMMdd}'
                 AND     a.BUS_CD NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
                 AND     ( a.CHNL_CD <> 'L08'
                     OR a.PD_CD <> '201050101040335' ) --剔除 小鱼分期
                 AND     a.PD_CD <> '201050101040332' --剔除 蚂蚁借呗
                 AND     a.PD_CD <> '201050101040319' --剔除百度分期贷
                 AND     ( a.PD_CD NOT IN ( '201050102010146' , '201050101040348' )
                     OR a.FRZ_STS_CD <> '' ) --剔除未签约的泰e贷
                 AND     ( a.PD_CD LIKE '201050102%'
                     OR ( a.PD_CD LIKE '2010503%'
                 AND     a.LOAN_USG_CD LIKE '01%' ) ) --个人一般经营性贷款、经营用途随贷通
                 AND     ( ( ( a.ctr_bal > 0
                     OR ( a.ctr_bal IS NULL
                 AND     nvl(a.crc_ind, '0') = '0' )
                     OR ( ( nvl(a.crc_ind, '0') <> '0'
                     OR a.pd_cd LIKE '2010503%' )
                 AND     ( a.ctr_bal = 0
                     OR a.ctr_bal IS NULL )
                 AND     a.apnt_mtu_dt >= a.dt ) )
                 AND     nvl(a.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
                     OR ( a.ctr_bal > 0
                 AND     a.pd_cd LIKE '2010503%'
                 AND     a.apnt_mtu_dt <= a.dt
                 AND     a.frz_sts_cd IN ( '3' , '4' ) ) )
             ) t3 --经营性贷款
ON      t1.客户号 = t3.cst_id
AND     t3.rn = 1
WHERE   t2.cst_id IS NOT NULL --当前有生效消费性贷款
;


DROP TABLE IF EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi03 purge;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi03 AS
SELECT  t1 . *
        ,t2.sub_cmnt_nm 子社区名称
        ,t3.com_vindicate_id 主维护人ID
        ,t3.com_vindicate_name 主维护人名称
FROM    lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi02 t1
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t2 --客户社区信息
ON      t1.客户号 = t2.cst_id
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.sub_cmnt_id <> ''
LEFT JOIN    edw.xwdt_xw_community t3 --社区信息表
ON      t2.sub_cmnt_id = t3.COM_CODE
AND     t3.dt = '@@{yyyyMMdd}';

-- select * from lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_liushi03
-- select * from lab_bigdata_dev.gjj_tmp_cst_csm_loan_inf_20231122_daoqi03
**01-数据需求_总行计财_2025_D0102_陈晓宇_月初报送准备金信息至人行ACS系统_常态化.sql
-- 业务负责人: 许登辉
-- 报表名称：计划财务部-美元存款准备金月报
-- 频度：月
-- 目标表：FCT_COM_DEP_PRVS_USD_MON 美元存款准备金月报
-- 源表：  DIM_BUS_ACT_ITM_DD 会计科目
--         DWS_BUS_ACT_ITM_BAL_DS 科目总账
--         DIM_BUS_COM_DATE_ST 日期维表
--         DIM_BUS_COM_EXR_INF_DD 汇率信息
-- 创建日期: 2020-06-12 09:29:33
-- **
-- 修改日志:
-- 20221212         施敏娟          增加港币存款准备金的数据出数
--20240102                          增加欧元存款准备经的数据出数


--
--临时表,按日维度取本期贷方余额
-- DROP TABLE IF EXISTS TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_1;

-- CREATE TABLE IF NOT EXISTS TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_1
-- (
--     ACT_ITM_ID   STRING  COMMENT '科目号'
--     ,ACT_ITM_NM  STRING  COMMENT '科目名称'
--     ,ORG_ID      STRING  COMMENT '机构号'
--     ,DT          STRING  COMMENT '日期'
--     ,CUR_CRD_BAL DECIMAL COMMENT '本期贷方余额'
--     ,UNT_ID      STRING  COMMENT '单位标识'
-- );



--插入数据
-- INSERT INTO TABLE TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_1 ( ACT_ITM_ID -- '科目号'
-- , ACT_ITM_NM -- '科目名称'
-- , ORG_ID -- '机构号'
-- , DT -- '日期'
-- , CUR_CRD_BAL -- '本期贷方余额'
-- , UNT_ID -- '单位标识'
-- )
;


SELECT * FROM TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_20250131;

DROP TABLE IF EXISTS TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_20250131 PURGE;

CREATE TABLE IF NOT EXISTS TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_20250131 AS
SELECT  P1.ACT_ITM_ID --as 科目号
        ,P1.ACT_ITM_NM --as 科目名称
        ,P2.ORG_ID --as 机构号
        ,P1.DT --as 日期
        ,SUM(CASE
               WHEN P1.ACT_ITM_ID IN ( '25010611' , '25010612' , '25010617' , '25010618' , '25010605' , '25010606' , '25010608' , '25010609' , '25010614' , '25010615' , '25010620' , '25010621' , '25010623' , '25010624' ) THEN ROUND(( COALESCE(P2.CUR_DBT_BAL_ACM, 0) * ROUND(( ( P3.AVG_PRC / P3.QUO_UNT ) / ( P4.AVG_PRC / P4.QUO_UNT ) ), 6) ), 2) --上述科目取借方
               WHEN P1.ACT_ITM_ID IN ( '3001' , '3002' )                                                                                                                                                                     THEN ROUND(( ( COALESCE(P2.CUR_CRD_BAL_ACM, 0) - COALESCE(P2.CUR_DBT_BAL_ACM, 0) ) * ROUND(( ( P3.AVG_PRC / P3.QUO_UNT ) / ( P4.AVG_PRC / P4.QUO_UNT ) ), 6) ), 2) --上述科目取贷方-借方
               ELSE ROUND(( COALESCE(P2.CUR_CRD_BAL, 0) * ROUND(( ( P3.AVG_PRC / P3.QUO_UNT ) / ( P4.AVG_PRC / P4.QUO_UNT ) ), 6) ), 2) --剩余取贷方
             END) AS CUR_CRD_BAL --本期贷方余额
        ,'美元存款准备金'  as UNT_ID
FROM    edw.DIM_BUS_ACT_ITM_DD P1 --会计科目
LEFT JOIN    edw.DWS_BUS_ACT_ITM_BAL_DS P2 --科目总账
ON      P1.ACT_ITM_ID = P2.ACT_ITM_ID
AND     P2.DAT_PRD_CD = '2' --时间维度：月
AND     P2.CCY_CD NOT IN ( 'CN' , 'FC' , 'US' , '156' , '344' , '978' ) --最新要改为除港币、人民币、欧元外的其他外币,978为欧元
AND     P2.DT = P1.DT
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD P3 --汇率信息
ON      P2.CCY_CD = P3.CCY_CD
AND     P3.DT = P1.DT
LEFT JOIN    edw.DIM_BUS_COM_EXR_INF_DD P4 --汇率信息
ON      P4.CCY_CD = '840' --美元
AND     P4.DT = P1.DT
WHERE   ( P1.DT = '20250131'
    OR P1.DT = '20241231' )
AND     P1.ACT_ITM_ID IN ( '2001' , '2002' , '2003' , '2004' , '2005' , '2006' , '2007' , '2008' , '2009' , '2010' , '2016' , '205105' , '205107' , '205305' , '205307' , '22410601' , '25010610' , '25010611' , '25010612' , '25010616' , '25010617' , '25010618' , '3001' , '3002' , '205103' , '205104' , '205106' , '205108' , '205199' , '2052' , '205303' , '205304' , '205306' , '205308' , '205399' , '2054' , '25010604' , '25010605' , '25010606' , '25010607' , '25010608' , '25010609' , '25010613' , '25010614' , '25010615' , '25010619' , '25010620' , '25010621' , '25010622' , '25010623' , '25010624' )
GROUP BY P1.ACT_ITM_ID , P1.ACT_ITM_NM , P2.ORG_ID , P1.DT , '美元存款准备金'

--港币
UNION ALL
SELECT  P1.ACT_ITM_ID
        ,P1.ACT_ITM_NM
        ,P2.ORG_ID
        ,P1.DT
        ,SUM(CASE
               WHEN P1.ACT_ITM_ID IN ( '25010611' , '25010612' , '25010617' , '25010618' , '25010605' , '25010606' , '25010608' , '25010609' , '25010614' , '25010615' , '25010620' , '25010621' , '25010623' , '25010624' ) THEN COALESCE(P2.CUR_DBT_BAL, 0) --上述科目取借方
               WHEN P1.ACT_ITM_ID IN ( '3001' , '3002' )                                                                                                                                                                     THEN COALESCE(P2.CUR_CRD_BAL_ACM, 0) - COALESCE(P2.CUR_DBT_BAL_ACM, 0) --上述科目取贷方-借方
               ELSE COALESCE(P2.CUR_CRD_BAL, 0) --剩余取贷方
             END) AS CUR_CRD_BAL
        ,'港币存款准备金' as UNT_ID
FROM    edw.DIM_BUS_ACT_ITM_DD P1 --会计科目
LEFT JOIN    edw.DWS_BUS_ACT_ITM_BAL_DS P2 --科目总账
ON      P1.ACT_ITM_ID = P2.ACT_ITM_ID
AND     P2.DAT_PRD_CD = '1' --时间维度：日
AND     P2.CCY_CD = '344' --取港币
AND     P2.DT = P1.DT
WHERE   ( P1.DT = '20250131'
    OR P1.DT = '20241231' )
AND     P1.ACT_ITM_ID IN ( '2001' , '2002' , '2003' , '2004' , '2005' , '2006' , '2007' , '2008' , '2009' , '2010' , '2016' , '205105' , '205107' , '205305' , '205307' , '22410601' , '25010610' , '25010611' , '25010612' , '25010616' , '25010617' , '25010618' , '3001' , '3002' , '205103' , '205104' , '205106' , '205108' , '205199' , '2052' , '205303' , '205304' , '205306' , '205308' , '205399' , '2054' , '25010604' , '25010605' , '25010606' , '25010607' , '25010608' , '25010609' , '25010613' , '25010614' , '25010615' , '25010619' , '25010620' , '25010621' , '25010622' , '25010623' , '25010624' )
GROUP BY P1.ACT_ITM_ID , P1.ACT_ITM_NM , P2.ORG_ID , P1.DT , '港币存款准备金'

--新增欧元准备金，不用折币，取欧元原币即可
UNION ALL
SELECT  P1.ACT_ITM_ID
        ,P1.ACT_ITM_NM
        ,P2.ORG_ID
        ,P1.DT
        ,SUM(CASE
               WHEN P1.ACT_ITM_ID IN ( '25010611' , '25010612' , '25010617' , '25010618' , '25010605' , '25010606' , '25010608' , '25010609' , '25010614' , '25010615' , '25010620' , '25010621' , '25010623' , '25010624' ) THEN COALESCE(P2.CUR_DBT_BAL, 0) --上述科目取借方
               WHEN P1.ACT_ITM_ID IN ( '3001' , '3002' )                                                                                                                                                                     THEN COALESCE(P2.CUR_CRD_BAL_ACM, 0) - COALESCE(P2.CUR_DBT_BAL_ACM, 0) --上述科目取贷方-借方
               ELSE COALESCE(P2.CUR_CRD_BAL, 0) --剩余取贷方
             END) AS CUR_CRD_BAL
        ,'欧元存款准备金' as UNT_ID
FROM    edw.DIM_BUS_ACT_ITM_DD P1 --会计科目
LEFT JOIN    edw.DWS_BUS_ACT_ITM_BAL_DS P2 --科目总账
ON      P1.ACT_ITM_ID = P2.ACT_ITM_ID
AND     P2.DAT_PRD_CD = '1' --时间维度：日
AND     P2.CCY_CD = '978' --取欧元
AND     P2.DT = P1.DT
WHERE   ( P1.DT = '20250131'
    OR P1.DT = '20241231' )
AND     P1.ACT_ITM_ID IN ( '2001' , '2002' , '2003' , '2004' , '2005' , '2006' , '2007' , '2008' , '2009' , '2010' , '2016' , '205105' , '205107' , '205305' , '205307' , '22410601' , '25010610' , '25010611' , '25010612' , '25010616' , '25010617' , '25010618' , '3001' , '3002' , '205103' , '205104' , '205106' , '205108' , '205199' , '2052' , '205303' , '205304' , '205306' , '205308' , '205399' , '2054' , '25010604' , '25010605' , '25010606' , '25010607' , '25010608' , '25010609' , '25010613' , '25010614' , '25010615' , '25010619' , '25010620' , '25010621' , '25010622' , '25010623' , '25010624' )
GROUP BY P1.ACT_ITM_ID , P1.ACT_ITM_NM , P2.ORG_ID , P1.DT , '欧元存款准备金';



--外汇存款准备金月报
-- CREATE TABLE IF NOT EXISTS FCT_COM_DEP_PRVS_USD_MON
-- (
--     ACG_DT                STRING  COMMENT '会计日期'
--     ,ACT_ITM_ID           STRING  COMMENT '科目号'
--     ,ACT_ITM_NM           STRING  COMMENT '科目名称'
--     ,ORG_ID               STRING  COMMENT '机构号'
--     ,CUR_CRD_BAL_MON      DECIMAL COMMENT '当月余额'
--     ,LAST_CUR_CRD_BAL_MON DECIMAL COMMENT '上月余额'
--     ,CHG_AMT              DECIMAL COMMENT '变动额'
--     ,CHG_XTNT             DECIMAL COMMENT '变动幅度'
--     ,UNT_ID               STRING  COMMENT '单位标识'
-- )
-- COMMENT
-- '外币一般存款准备金月报'
-- PARTITIONED BY
-- (
--     DT STRING COMMENT '日期分区'
-- );

--重跑机制
-- ALTER TABLE FCT_COM_DEP_PRVS_USD_MON DROP IF EXISTS PARTITION ( DT = '${yyyyMMdd' );

-- INSERT INTO TABLE FCT_COM_DEP_PRVS_USD_MON PARTITION (DT = '${yyyyMMdd') ( ACG_DT -- '会计日期'
-- , ACT_ITM_ID -- '科目号'
-- , ACT_ITM_NM -- '科目名称'
-- , ORG_ID -- '机构号'
-- , CUR_CRD_BAL_MON -- '当月余额'
-- , LAST_CUR_CRD_BAL_MON -- '上月余额'
-- , CHG_AMT -- '变动额'
-- , CHG_XTNT -- '变动幅度'
-- , UNT_ID -- '单位标识'
-- )


-- --
-- DROP TABLE IF EXISTS FCT_COM_DEP_PRVS_USD_MON PURGE;

-- CREATE TABLE IF NOT EXISTS FCT_COM_DEP_PRVS_USD_MON AS
-- SELECT  '@@{yyyy-MM-dd}'  as 数据日期
--         ,COALESCE(P1.ACT_ITM_ID, P2.ACT_ITM_ID, '')   as 科目号
--         ,COALESCE(P1.ACT_ITM_NM, P2.ACT_ITM_NM, '') as 科目名称
--         ,COALESCE(P1.ORG_ID, P2.ORG_ID, '') as 机构号 --HZX null导致导出报错
--         ,COALESCE(P1.CUR_CRD_BAL, 0)                                   AS 当月余额
--         ,COALESCE(P2.CUR_CRD_BAL, 0)                                   AS 上月余额
--         ,( COALESCE(P1.CUR_CRD_BAL, 0) - COALESCE(P2.CUR_CRD_BAL, 0) ) AS 变动额
--         ,CASE
--            WHEN COALESCE(P2.CUR_CRD_BAL, 0) = 0 THEN 0
--            ELSE ( COALESCE(P1.CUR_CRD_BAL, 0) - COALESCE(P2.CUR_CRD_BAL, 0) ) / COALESCE(P2.CUR_CRD_BAL, 0)
--          END                                                           AS 变动幅度
--         ,COALESCE(P1.UNT_ID, P2.UNT_ID, '') as 单位标识
-- FROM    (
--             SELECT  ACT_ITM_ID -- '科目号'
--                     ,ACT_ITM_NM -- '科目名称'
--                     ,ORG_ID -- '机构号'
--                     ,DT -- '日期'
--                     ,CUR_CRD_BAL -- '本期贷方余额'
--                     ,UNT_ID -- '单位标识'
--             FROM    TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_1
--             WHERE   DT = '20241231'
--         ) P1
-- FULL OUTER JOIN    (
--                        SELECT  ACT_ITM_ID -- '科目号'
--                                ,ACT_ITM_NM -- '科目名称'
--                                ,ORG_ID -- '机构号'
--                                ,DT -- '日期'
--                                ,CUR_CRD_BAL -- '本期贷方余额'
--                                ,UNT_ID -- '单位标识'
--                        FROM    TMP_FCT_COM_DEP_PRVS_USD_MON_TAB_1
--                        WHERE   DT = '20250131'
--                    ) P2
-- ON      P1.ACT_ITM_ID = P2.ACT_ITM_ID
-- AND     P1.ORG_ID = P2.ORG_ID
-- AND     P1.UNT_ID = P2.UNT_ID
-- WHERE   COALESCE(P1.ORG_ID, P2.ORG_ID, '') <> '';
**01-数据需求_总行计财_2025_D0103_绍兴分行_张莉_用于分析授信额度变化导致的用信数据迁移情况分析.sql
SELECT  d1.dt                                 AS 数据日期
        ,d1.freq_dt                           AS `频率`
        ,substr(assess_org_cd, 1, 4)          AS 考核机构号
        ,CASE
           WHEN substr(prod_cd, 1, 6) IN ( '810101' , '810110' ) THEN '一般贷款'
           WHEN substr(prod_cd, 1, 6) IN ( '810105' )            THEN '随贷通'
           ELSE ''
         END                                  AS 产品
        ,CASE
           WHEN d3.合同金额 IS NULL    THEN '匹配不到'
           WHEN d3.合同金额 <= 500000  THEN '1_(0,50]'
           WHEN d3.合同金额 <= 1500000 THEN '2_(50,150]'
           WHEN d3.合同金额 <= 3000000 THEN '3_(150,300]'
           WHEN d3.合同金额 <= 5000000 THEN '4_(300,500]'
           WHEN d3.合同金额 > 5000000  THEN '5_(500,+]'
           ELSE '匹配不到'
         END                                  AS 额度区间
        ,count(DISTINCT d2.客户号)               AS 户数
        ,sum(nvl(avg_bal, 0)) / 10000         AS `日均余额`
        ,sum(nvl(org_ftp_bus_inc, 0)) / 10000 AS `FTP营收_机构考核`
FROM    app_iftp.adm_papp_ftp_eva_acct_summ_rst_inf d1
LEFT JOIN    (
                 SELECT  to_char(COL_1, 'yyyymmdd') 数据日期
                         ,COL_2 分行机构编号
                         ,COL_3 分行机构名称
                         ,COL_4 支行机构编号
                         ,COL_5 支行机构名称
                         ,COL_6 客户号
                         ,COL_7 合同金额
                         ,COL_8 同一风险控制号
                 FROM    qbi_file_20241230_22_31_52_0
                 WHERE   pt IS NOT NULL
             ) d2
ON      d1.cust_id = d2.客户号
AND     d1.dt = d2.数据日期
LEFT JOIN    (
                 SELECT  to_char(COL_1, 'yyyymmdd') 数据日期
                         ,COL_8 同一风险控制号
                         ,sum(nvl(COL_7, 0)) 合同金额
                 FROM    qbi_file_20241230_22_31_52_0
                 WHERE   pt IS NOT NULL
                 GROUP BY to_char(COL_1, 'yyyymmdd') , COL_8
             ) d3
ON      d2.同一风险控制号 = d3.同一风险控制号
AND     d2.数据日期 = d3.数据日期
WHERE   d1.dt IN ( '20231231' , '20241225' )
AND     d1.freq_dt IN ( 'Y' , 'M' )
AND     substr(prod_cd, 1, 6) IN ( '810101' , '810110' , '810105' )
AND     substr(assess_org_cd, 1, 2) IN ( '31' , '32' , '33' )
AND     substr(assess_org_cd, 1, 4) <> '3361'
GROUP BY d1.dt , d1.freq_dt , substr(assess_org_cd, 1, 4) , CASE
                                                              WHEN d3.合同金额 IS NULL    THEN '匹配不到'
                                                              WHEN d3.合同金额 <= 500000  THEN '1_(0,50]'
                                                              WHEN d3.合同金额 <= 1500000 THEN '2_(50,150]'
                                                              WHEN d3.合同金额 <= 3000000 THEN '3_(150,300]'
                                                              WHEN d3.合同金额 <= 5000000 THEN '4_(300,500]'
                                                              WHEN d3.合同金额 > 5000000  THEN '5_(500,+]'
                                                              ELSE '匹配不到'
                                                            END , CASE
                                                                    WHEN substr(prod_cd, 1, 6) IN ( '810101' , '810110' ) THEN '一般贷款'
                                                                    WHEN substr(prod_cd, 1, 6) IN ( '810105' )            THEN '随贷通'
                                                                    ELSE ''
                                                                  END
**01-数据需求_总行计财_D0419_总行计财_张婉蓉_手工补息数据.sql
--账户清单
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_01 AS
SELECT  T2.bal_itm_id    AS 会计科目编号
        ,T3.act_itm_nm   AS 会计科目名称
        ,T1.cunqiiii     AS 存期
        ,CASE
           WHEN T13.fzlvleix = 'ZHENLXLV' THEN T13.zhxililv
         END             AS 挂牌利率
        ,T4.zhxililv     AS 当前执行利率
        ,CASE
           WHEN T15.zhxililv IS NOT NULL THEN T15.zhxililv
           ELSE T4.tiexlilv
         END             AS 贴息利率
        ,T4.zonghsyl     AS 综合收益率
        ,T4.txqishrq     AS 贴息起始日期
        ,T4.txzhgzrq     AS 贴息终止日期
        ,T4.zhzdlced     AS 最低留存额度
        ,T4.qianybho     AS 签约编号
        ,CASE
           WHEN T4.zhuangti = '2' THEN '正常'
         END             AS 签约状态
        ,CASE
           WHEN T4.yewubios = '1' THEN '基础性存款1'
           WHEN T4.yewubios = '2' THEN '基础性存款2'
           WHEN T4.yewubios = '3' THEN '资源性存款'
           WHEN T4.yewubios = '4' THEN '外币资源性存款1'
           WHEN T4.yewubios = '5' THEN '外币资源性存款2'
         END             AS 业务标识类型
        ,CASE
           WHEN T4.cunkleix = '0' THEN '按余额'
           WHEN T4.cunkleix = '1' THEN '按日均'
         END             AS 控制类型
        ,T4.fuxipinl     AS 付息频率
        ,CASE
           WHEN SUBSTR(T4.fuxipinl, 1, 3) = '1QA' THEN '按季'
           WHEN SUBSTR(T4.fuxipinl, 1, 3) = '1YA' THEN '按年'
           WHEN SUBSTR(T4.fuxipinl, 1, 3) = '1MA' THEN '按月'
           WHEN COALESCE(T4.fuxipinl, '') = ''    THEN '到期付息'
         END             AS 付息频率_1
        ,CASE
           WHEN T5.qianyulx = '01' THEN '合并控制'
           WHEN T5.qianyulx = '02' THEN '单笔控制'
           WHEN T5.qianyulx = '03' THEN '超上限控制'
           WHEN T5.qianyulx = '99' THEN '其它'
         END             AS 签约类型
        ,CASE
           WHEN T5.lilvlxng = '01' THEN '固定利率'
           WHEN T5.lilvlxng = '02' THEN '靠档利率'
           WHEN T5.lilvlxng = '03' THEN '分层利率'
         END             AS 利率类型
        ,T1.kehuhaoo     AS 客户号
        ,T1.zhhuzwmc     AS 客户名称
        ,T1.kehuzhao     AS 客户账号
        ,T1.zhanghao     AS 负债账号
        ,T1.chapbhao     AS 核心产品编号
        ,T14.chanpshm    AS 核心产品名称
        ,T1.kaihriqi     AS 开户日期
        ,T1.doqiriqi     AS 到期日
        ,T1.zhhuyuee     AS 当前余额
        ,T1.DT           AS 数据日期
        ,T1.huobdaih     AS 币种
        ,T1.kaihjigo     AS 开户机构
        ,T12.org_nm      AS 开户机构名称
        ,T1.zhhuztai     AS 账户状态码值
        ,T7.cd_val_dscr  AS 账户状态
        ,CASE
           WHEN T6.yzhhuglx = 'I' THEN '其他I'
           WHEN T6.yzhhuglx = '3' THEN '保证金自有'
           WHEN T6.yzhhuglx = 'B' THEN '其他B'
           WHEN T6.yzhhuglx = 'D' THEN '其他D'
           WHEN T6.yzhhuglx = '8' THEN '公共账户'
           WHEN T6.yzhhuglx = 'H' THEN '其他H'
           WHEN T6.yzhhuglx = '4' THEN '保证金划片'
           WHEN T6.yzhhuglx = 'A' THEN '其他A'
           WHEN T6.yzhhuglx = 'G' THEN '其他G'
           WHEN T6.yzhhuglx = '7' THEN '待分配账户'
           WHEN T6.yzhhuglx = 'F' THEN '其他F'
           WHEN T6.yzhhuglx = '5' THEN '支农支小信息员'
           WHEN T6.yzhhuglx = '6' THEN '资源性存款'
           WHEN T6.yzhhuglx = 'C' THEN '其他C'
           WHEN T6.yzhhuglx = '1' THEN '划片'
           WHEN T6.yzhhuglx = '2' THEN '衍生'
           WHEN T6.yzhhuglx = 'E' THEN '其他E'
           WHEN T6.yzhhuglx = '0' THEN '自有'
           WHEN T6.yzhhuglx = '9' THEN '客户营销员'
         END             AS 原账户关联性质
        ,CASE
           WHEN T6.zhhuglxz = 'I' THEN '其他I'
           WHEN T6.zhhuglxz = '3' THEN '保证金自有'
           WHEN T6.zhhuglxz = 'B' THEN '其他B'
           WHEN T6.zhhuglxz = 'D' THEN '其他D'
           WHEN T6.zhhuglxz = '8' THEN '公共账户'
           WHEN T6.zhhuglxz = 'H' THEN '其他H'
           WHEN T6.zhhuglxz = '4' THEN '保证金划片'
           WHEN T6.zhhuglxz = 'A' THEN '其他A'
           WHEN T6.zhhuglxz = 'G' THEN '其他G'
           WHEN T6.zhhuglxz = '7' THEN '待分配账户'
           WHEN T6.zhhuglxz = 'F' THEN '其他F'
           WHEN T6.zhhuglxz = '5' THEN '支农支小信息员'
           WHEN T6.zhhuglxz = '6' THEN '资源性存款'
           WHEN T6.zhhuglxz = 'C' THEN '其他C'
           WHEN T6.zhhuglxz = '1' THEN '划片'
           WHEN T6.zhhuglxz = '2' THEN '衍生'
           WHEN T6.zhhuglxz = 'E' THEN '其他E'
           WHEN T6.zhhuglxz = '0' THEN '自有'
           WHEN T6.zhhuglxz = '9' THEN '客户营销员'
         END             AS 账户关联性质
        -- ,T8.scjexirq     AS 贴息利息计提开始日
        ,T16.jixiqsrq    AS 贴息利息计提开始日
        ,'20240423'      AS 贴息利息计提结束日
        ,T8.lxzrzhao     AS 利息转入账号
        ,T8.jixiljye     AS 积数
        ,T8.jitilixi     AS 计提利息
        ,nvl(T17.SJLXFSJE,0)     AS 调整利息
        ,T1.ZHUFLDM1     AS 账户分类一代码
        ,T9.cd_val_dscr  AS 账户分类一
        ,T1.ZHUFLDM2     AS 账户分类二代码
        ,T10.cd_val_dscr AS 账户分类二
FROM    edw.core_kdpa_zhxinx T1 --负债账户信息表
LEFT JOIN    edw.dim_bus_dep_act_inf_dd T2 --存款账户信息
ON      T1.zhanghao = T2.dep_act_id
AND     T1.kehuzhao = T2.cst_act_id
AND     T2.DT = '20240423'
LEFT JOIN    edw.dim_bus_act_itm_dd T3 --会计科目
ON      T2.bal_itm_id = T3.act_itm_id
AND     T3.DT = '20240423'
inner JOIN    edw.core_kdpb_txlxqy T4 --贴息利息签约登记簿
ON      T1.zhanghao = T4.zhanghao
AND     T1.kehuzhao = T4.kehuzhao
AND     T4.DT = '20240423'
inner JOIN    edw.core_kdpb_txqyzb T5 -- 贴息签约主表
ON      T4.qianybho = T5.qianybho
AND     T5.DT = '20240423'
LEFT JOIN    (
                 SELECT  kehuzhao
                         ,jiaoyirq
                         ,yzhhuglx
                         ,zhhuglxz
                         ,ROW_NUMBER() OVER ( PARTITION BY kehuzhao , jiaoyirq ORDER BY shijchuo DESC ) AS RN
                 FROM    edw.core_kdpl_kjwhmx -- 客户经理维护变更登记簿
                 WHERE   DT >= '20190101'
             ) T6
ON      T4.kehuzhao = T6.kehuzhao
AND     T5.qyueriqi = T6.jiaoyirq
AND     T6.RN = 1
LEFT JOIN    edw.dwd_code_library_dd T7 --码值表  账户状态
ON      T1.zhhuztai = T7.cd_val
AND     T7.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     T7.fld_nm = 'ACT_STS_CD'
AND     T7.dt = '20240423'
left JOIN    edw.core_kdpa_zhjxdy T8 --负债账户计息定义
ON      T1.zhanghao = T8.zhanghao
AND     T8.lixileix = 'TIEXIILX'
AND     T8.dt = '20240423'
LEFT JOIN    edw.dwd_code_library_dd T9 --码值表  账户类型一
ON      T1.ZHUFLDM1 = T9.cd_val
AND     T9.tbl_nm = 'KDPA_ZHXINX'
AND     T9.fld_nm = 'ZHUFLDM1'
AND     T9.dt = '20240423'
LEFT JOIN    edw.dwd_code_library_dd T10 --码值表  账户类型二
ON      T1.ZHUFLDM2 = T10.cd_val
AND     T10.tbl_nm = 'KDPA_ZHXINX'
AND     T10.fld_nm = 'ZHUFLDM2'
AND     T10.dt = '20240423'
LEFT  JOIN    edw.core_kcsp_frjgou T11 --法人机构参数表
ON      SUBSTR(T1.kaihjigo, 1, 4) = substr(T11.jigouhao, 1, 4)
AND     T11.dt = '20240423'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T12 --机构树_考核维度
ON      T1.kaihjigo = T12.org_id
AND     T12.dt = '20240423'
LEFT JOIN    edw.core_kdpa_zhlldy T13 --负债账户利率定义
ON      T1.zhanghao = T13.zhanghao
AND     T13.fzlvleix = 'ZHENLXLV'
AND     T13.DT = '20240423'
LEFT JOIN    edw.core_kdpa_zhlldy T15 --负债账户利率定义
ON      T1.zhanghao = T15.zhanghao
AND     T5.lilvlxng = '01'
AND     T15.fzlvleix = 'TIEXIILV'
AND     T15.DT = '20240423'
LEFT JOIN    edw.core_kdpf_chpshx T14 --产品基础属性表
ON      T1.chapbhao = T14.chapbhao
AND     T14.dt = '20240423'
LEFT JOIN (
                 SELECT  zhanghao
                         ,MIN(jixiqsrq) AS jixiqsrq
                 FROM    edw.core_kdpl_zhlxmx
                 WHERE   DT = '20240423'
                 AND     lixileix = 'TIEXIILX'
                 AND     mnxisybz = 1
                 AND     lixiczdm <> 'ADJUSTMENT'
				         AND     TZSHYNBZ = '1'
                 GROUP BY zhanghao
             ) T16
ON      T1.zhanghao = T16.zhanghao
LEFT JOIN    (
                 SELECT  zhanghao
				         ,nvl(SJLXFSJE,'0') as SJLXFSJE
                 FROM    edw.core_kdpl_zhlxmx
                 WHERE   DT = '20240423'
                 AND     lixileix = 'TIEXIILX'
                 AND     mnxisybz = 1
                 AND     lixiczdm = 'ADJUSTMENT'
                 and     TZSHYNBZ = '1'
                 GROUP BY zhanghao,SJLXFSJE
             ) T17
ON      T1.zhanghao = T17.zhanghao
WHERE   T1.DT = '20240423'
AND     T1.huobdaih = '156' -- 人民币
AND     T4.zhuangti = '2' -- 签约状态正常
AND     T11.jigouhao IS NULL --剔除村行
;


---账户整合
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_02 AS
SELECT  mm.zhanghao    AS 负债账号
        ,mm.kaihjigo   AS 开户机构
        ,zz.hesuanjg   AS 核算机构
        ,zz.zhanghao   AS 账号
        ,zz.zhanghmc   AS 账户名称
        ,zz.zhanghxh   AS 账号序号
FROM    (
            SELECT  aa.zhanghao
                    ,aa.kaihjigo
                    ,bb.kemuhaoo
                    ,bb.ZHANGHXH
            FROM    (
                        SELECT  n.zhanghao
                                ,n.kaihjigo
                                ,CASE
                                   WHEN substr(m.yeshux02, 1, 2) = 'BM' THEN substr(m.yeshux02, instr(m.yeshux02, 'BM_') + 3)
                                   ELSE m.yeshux02
                                 END AS yeshux02
                        FROM    edw.core_kfap_yeshux m   --余额属性参数表
                        INNER JOIN    (
                                          SELECT  a . *
                                          FROM    edw.core_kdpa_zhxinx a
                                          WHERE   a.chapbhao IN (
                                                                    SELECT  chapbhao
                                                                    FROM    edw.core_kdpf_chpshx  --产品基础属性表
																	WHERE   DT='20240423'
                                                                )
                                          AND     a.zhhuztai <> 'C'
										  AND   a.DT='20240423'
                                      ) n
                        ON      m.yewubima = n.JITIYWBM
						WHERE   m.DT='20240423'
                    ) aa
            INNER JOIN    edw.core_kfap_neibhs bb  --内部管理核算表
            ON      aa.yeshux02 = bb.nbuhesdm
			AND     bb.DT='20240423'
            WHERE   substr(yeshux02, 1, 2) = 'HS'
            UNION ALL
            SELECT  aa.zhanghao
                    ,aa.kaihjigo
                    ,bb.kemuhaoo
                    ,bb.ZHANGHXH
            FROM    (
                        SELECT  n.zhanghao
                                ,n.kaihjigo
                                ,CASE
                                   WHEN substr(m.yeshux02, 1, 2) = 'BM' THEN substr(m.yeshux02, instr(m.yeshux02, 'BM_') + 3)
                                   ELSE m.yeshux02
                                 END AS yeshux02
                        FROM    edw.core_kfap_yeshux m
                        INNER JOIN    (
                                          SELECT  a . *
                                          FROM    edw.core_kdpa_zhxinx a
                                          WHERE   a.chapbhao IN (
                                                                    SELECT  chapbhao
                                                                    FROM    edw.core_kdpf_chpshx
																	WHERE   DT='20240423'
                                                                )
                                          AND     zhhuztai <> 'C'
										  AND   a.DT='20240423'
                                      ) n
                        ON      m.yewubima = n.JITIYWBM
                        WHERE   m.DT='20240423'
                    ) aa
            INNER JOIN    edw.core_kfaa_nbfhzh bb  --内部分户账
            ON      aa.yeshux02 = bb.kemuhaoo
            AND     aa.kaihjigo = bb.hesuanjg
            AND     bb.huobdaih = '156'
			AND     bb.DT='20240423'
            WHERE   substr(yeshux02, 1, 2) <> 'HS'
            AND     bb.zhanghxh = '00001'
        ) mm
INNER JOIN    edw.core_kfap_cejtcs nn  --差额计提参数表
ON      mm.kemuhaoo = nn.jitikemu
AND     mm.ZHANGHXH = nn.JITIZHXH
AND     nn.DT='20240423'
INNER JOIN    edw.core_kfaa_nbfhzh zz  --内部分户账
ON      nn.sunykemu = zz.kemuhaoo
AND     nn.sunyzhxh = zz.ZHANGHXH
AND     zz.DT='20240423'
WHERE   zz.hesuanjg = mm.kaihjigo
AND     zz.huobdaih = '156' ;


-- 查询在我行是否有活期账户，若有，如果是个人客户，优先取一类户，没有一类户就取其他活期账户；如果是对公客户，取所有的活期账户，但是不含专户，仅取基本户、一般户、临时户


--定期存款的客户，需要查询是否在我行开立活期账户，账户属性是一类户、还是二类户、还是对单位活期
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_03 AS
SELECT  A1.客户账号
        ,A1.负债账号
		,A1.客户名称
		,A1.客户号
		,A1.核心产品编号
		,A1.核心产品名称
		,CASE
               WHEN A3.cst_typ_cd='1' AND A2.kehuhaoo IS NOT NULL THEN '1'   --1，个人
			   WHEN A3.cst_typ_cd='2' AND A2.ZHUFLDM1 IN ('0001','0002','0003') THEN '1'    --2，对公
               ELSE '0'
             END     AS 是否在我行开立活期账户
	    ,A2.kehuzhao AS 活期客户账户
		,A2.zhanghao AS 活期负债账户
		,A2.zhhuzwmc     AS 活期账户名称
        ,A4.cd_val_dscr  AS 活期账户分类一
		,A5.cd_val_dscr  AS 活期账户分类二
		,A6.cd_val_dscr  AS 账户状态
		,A3.cst_typ_cd	 AS 客户类型
FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_01 A1
LEFT JOIN    edw.core_kdpa_zhxinx A2 --负债账户信息表
ON      A1.客户号 = A2.kehuhaoo
AND     A2.zhhuztai <> 'C'
AND     A2.fzcpleix = '0'
AND     A2.DT = '20240423'
LEFT JOIN  edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON   A1.客户号 = A3.cst_id
AND  A3.DT = '20240423'
LEFT JOIN    edw.dwd_code_library_dd A4 --码值表  账户类型一
ON      A2.ZHUFLDM1 = A4.cd_val
AND     A4.tbl_nm = 'KDPA_ZHXINX'
AND     A4.fld_nm = 'ZHUFLDM1'
AND     A4.dt = '20240423'
LEFT JOIN    edw.dwd_code_library_dd A5 --码值表  账户类型二
ON      A2.ZHUFLDM2 = A5.cd_val
AND     A5.tbl_nm = 'KDPA_ZHXINX'
AND     A5.fld_nm = 'ZHUFLDM2'
AND     A5.dt = '20240423'
LEFT JOIN    edw.dwd_code_library_dd A6 --码值表  账户状态
ON      A2.zhhuztai = A6.cd_val
AND     A6.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     A6.fld_nm = 'ACT_STS_CD'
AND     A6.dt = '20240423'
WHERE   A1.核心产品编号 IN ( '00201020100' , '00202020100'  , '00203010200' , '00202030101' , '00202030100' , '00201030601' , '00201030600' , '00201030305' , '00201030303' , '00201030304' , '00201030502' , '00201020102' )
;



--结果表1 清单明细
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_04 AS
SELECT  DISTINCT T1 . *
                 ,T2.账号   AS 账号_1
                 ,T2.账户名称 AS 账户名称_1
                 ,T2.开户机构 AS 开户机构_1
                 ,T2.核算机构 AS 核算机构_1
                 ,T2.账号序号 AS 账号序号_1
FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_01 T1
LEFT JOIN    lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_02 T2
ON      T1.负债账号 = T2.负债账号;




--结果表2 FTP信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_05 AS
SELECT DISTINCT T1.客户号
               ,T1.客户名称
               ,T1.客户账号
               ,T1.负债账号
		       ,T5.as_of_date       AS 数据日期
               ,T5.core_product_id  AS 产品码
               ,T5.product_name     AS 产品名称
               ,T5.cif_manager      AS 管户人id
               ,T5.cif_manager_name AS 管户人名称
               ,T5.org_unit_id      AS 机构号
               ,T5.acc_int          AS 当月累计对客利息
	           ,T6.org_nm           AS 机构名称
               ,T6.brc_org_id       AS 分行代码
               ,T6.brc_org_nm       AS 分行名称
FROM 	lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_01 T1
LEFT JOIN    app_iftp.adm_papp_ftp_eva_rpt_fact_ftp_cst_a14 T5 ---FTP报表
ON      T1.负债账号 = T5.account_no
AND     T1.客户号 = T5.cif_key
AND     T5.flag = 'M' --频率月
AND     T5.dt = '20240423'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T6 --机构树_考核维度
ON      T5.org_unit_id = T6.org_id
AND     T6.DT = '20240423' ;


---------结果表3、定期存款客户其它活期账户信息
-- 查询在我行是否有活期账户，若有，如果是个人客户，优先取一类户，没有一类户就取其他活期账户；如果是对公客户，取所有的活期账户，但是不含专户，仅取基本户、一般户、临时户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_06 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_06 AS
SELECT  A1.客户账号
        ,A1.负债账号
		,A1.客户号
		,A1.客户名称
		,A1.核心产品编号
		,A1.核心产品名称
		,A1.是否在我行开立活期账户
	    ,A1.活期客户账户
		,A1.活期负债账户
		,A1.活期账户名称
        ,A1.活期账户分类一
		,A1.活期账户分类二
		,A1.账户状态
FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_03 A1
WHERE   A1.客户类型= '1'
AND     A1.活期账户分类二='I类账户'
UNION  ALL
SELECT  A1.客户账号
        ,A1.负债账号
		,A1.客户号
		,A1.客户名称
		,A1.核心产品编号
		,A1.核心产品名称
		,A1.是否在我行开立活期账户
	    ,A1.活期客户账户
		,A1.活期负债账户
		,A1.活期账户名称
        ,A1.活期账户分类一
		,A1.活期账户分类二
		,A1.账户状态
FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_03 A1
WHERE   A1.客户类型= '1'
AND   A1.客户号 NOT IN (SELECT DISTINCT 客户号  FROM lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_03 WHERE   客户类型= '1' AND     活期账户分类二='I类账户')
UNION  ALL
SELECT  A1.客户账号
        ,A1.负债账号
		,A1.客户号
		,A1.客户名称
		,A1.核心产品编号
		,A1.核心产品名称
		,A1.是否在我行开立活期账户
	    ,A1.活期客户账户
		,A1.活期负债账户
		,A1.活期账户名称
        ,A1.活期账户分类一
		,A1.活期账户分类二
		,A1.账户状态
FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240422_1803_03 A1
WHERE   A1.客户类型= '2'
AND     A1.活期账户分类一 IN ('基本户','一般户','临时户' )
;



----协定存款，取协定存款标志=1，利率类型为正利率----
DROP TABLE IF EXISTS lab_bigdata_dev.tem_xiedingcunkuan_20240429 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tem_xiedingcunkuan_20240429 AS
SELECT  t.kehuhaoo 客户号
        ,t.kehuzhao 客户账号
        ,t.zhanghao 负债账号
        ,t.xiedckbz 协定存款标志
        ,t1.fzlvleix 利率类型
        ,t1.zhxililv 当前执行利率
        ,t2.shenxriq 生效日期
        ,t2.fzcpsxri 失效日期
FROM    edw.core_kdpa_zhxinx t --负债账户信息表
LEFT JOIN    edw.core_kdpa_zhlldy t1 --利率定义
ON      t.zhanghao = t1.zhanghao
AND     t1.dt = '20240423'
AND     t1.fzlvleix = 'ZHENLXLV' --正利率
LEFT JOIN    edw.core_kdpb_xdckdj t2 --协定存款登记簿
ON      t.zhanghao = t2.zhanghao
AND     t2.dt = '20240423'
WHERE   t.dt = '20240423'
AND     t.xiedckbz = 1
 --协定存款标志1
;

--SELECT * FROM lab_bigdata_dev.tem_xiedingcunkuan_20240429

SELECT * FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240426_1803_01

SELECT count(*) FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240426_1803_01 where 协定存款标志='是'

SELECT * FROM    lab_bigdata_dev.tmp_cunkuan_fuxi_20240426_1803_04
**01-数据需求_总行计财_D0516_周敏_用于分析个体工商户主税务政策适用风险情况.sql
-- SELECT  count(*)
-- FROM    (
            -- SELECT  *
            -- FROM    edw.yxpt_cust_part_1
            -- 客户模型 BUSI_SERIAL_NO 取客户号
            -- WHERE   CONTENT_ID IN (
                                      -- SELECT  CONTENT_ID
                                      -- FROM    edw.yxpt_cust_1
                                      -- WHERE   BUSI_SERIAL_NO = '2600516994'
                                  -- )
        -- ) t
-- INNER JOIN    edw.yxpt_cms_file_type c
-- ON      t.BUSI_FILE_TYPE = c.FILE_TYPE_BARCODE
-- AND     c.FILE_TYPE_NAME LIKE '营业执照%';

-- SELECT  count(*)
-- FROM    (
            -- SELECT  *
            -- FROM    edw.yxpt_xindai_part_1
            -- 信贷模型 BUSI_SERIAL_NO 取合同编号
            -- WHERE   CONTENT_ID IN (
                                      -- SELECT  CONTENT_ID
                                      -- FROM    edw.yxpt_xindai_1
                                      -- WHERE   BUSI_SERIAL_NO = '30332441829836286678799157389671'
                                  -- )
        -- ) t
-- INNER JOIN    edw.yxpt_cms_file_type c
-- ON      t.BUSI_FILE_TYPE = c.FILE_TYPE_BARCODE
-- AND     c.FILE_TYPE_NAME LIKE '营业执照%';


-- 取截至2022年12月31日，截至2023年12月31日，截至2024年4月30日，贷款清单中（不含贴现、贸易融资）个体工商户主标识为是的清单

-- 字段：客户号、借据号、借据金额、借据余额、，是否个体工商户主、借据开始日期、借据到期日期、贷款用途、营业执照是否有影像
--edw.dws_bus_loan_dbil_inf_dd  -- 贷款借据信息汇总
--edw.loan_ind_info  --个人信息表,isindindustry 是否个体工商户主


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_01;

CREATE TABLE lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_01 AS
SELECT  T1.DT            AS 数据日期
        ,T1.cst_id       AS 客户号
        ,T1.dbil_id      AS 借据号
        ,T1.amt          AS 借据金额
        ,T1.prcp_bal     AS 借据余额
        ,CASE
           WHEN T2.isindindustry = '1' THEN '是'
         END             AS 是否个体工商户主
        ,T1.dtrb_dt      AS 借据开始日期
        ,T1.apnt_mtu_day AS 借据到期日期
        ,T3.cd_val_dscr  AS 贷款用途
        ,CASE
           WHEN T4.BUSI_SERIAL_NO IS NOT NULL OR T5.BUSI_SERIAL_NO IS NOT NULL THEN '是'
           ELSE '否'
         END             AS 营业执照是否有影像
FROM    edw.dws_bus_loan_dbil_inf_dd T1 -- 贷款借据信息汇总
INNER JOIN    edw.loan_ind_info T2 --个人信息表
ON      T1.cst_id = T2.customerid
AND     T1.DT = T2.DT
AND     T2.isindindustry = '1' --个体工商户主标识为是
AND     T2.DT IN ( '20221231' , '20231231' , '20240430' )
LEFT JOIN    edw.dwd_code_library_dd T3 -- 码值表
ON      T1.loan_usg_cd = T3.cd_val
AND     T3.tbl_nm = 'DIM_BUS_LOAN_CTR_INF_DD'
AND     T3.fld_nm = 'LOAN_USG_CD'
AND     T3.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  DISTINCT T.DT
                                  ,T.BUSI_SERIAL_NO
                 FROM    (
                             SELECT  A1.DT
                                     ,A1.BUSI_FILE_TYPE
                                     ,A2.BUSI_SERIAL_NO
                             FROM    edw.yxpt_cust_part_1 A1
                             INNER JOIN    edw.yxpt_cust_1 A2
                             ON      A1.CONTENT_ID = A2.CONTENT_ID
                             AND     A1.DT = A2.DT
                             AND     A2.DT IN ( '20221231' , '20231231' , '20240430' )
                             WHERE   A1.DT IN ( '20221231' , '20231231' , '20240430' )
                         ) t
                 INNER JOIN    edw.yxpt_cms_file_type c
                 ON      t.BUSI_FILE_TYPE = c.FILE_TYPE_BARCODE
                 AND     t.DT = C.DT
                 AND     c.FILE_TYPE_NAME LIKE '营业执照%'
                 AND     c.DT IN ( '20221231' , '20231231' , '20240430' )
             ) T4
ON      T1.cst_id = T4.BUSI_SERIAL_NO
AND     T1.DT = T4.DT
LEFT JOIN    (
                 SELECT  DISTINCT T.DT
                                  ,T.BUSI_SERIAL_NO
                 FROM    (
                             SELECT  A1.DT
                                     ,A1.BUSI_FILE_TYPE
                                     ,A2.BUSI_SERIAL_NO
                             FROM    edw.yxpt_xindai_part_1 A1
                             INNER JOIN    edw.yxpt_xindai_1 A2
                             ON      A1.CONTENT_ID = A2.CONTENT_ID
                             AND     A1.DT = A2.DT
                             AND     A2.DT IN ( '20221231' , '20231231' , '20240430' )
                             WHERE   A1.DT IN ( '20221231' , '20231231' , '20240430' )
                         ) t
                 INNER JOIN    edw.yxpt_cms_file_type c
                 ON      t.BUSI_FILE_TYPE = c.FILE_TYPE_BARCODE
                 AND     t.DT = C.DT
                 AND     c.FILE_TYPE_NAME LIKE '营业执照%'
                 AND     c.DT IN ( '20221231' , '20231231' , '20240430' )
             ) T5
ON      T1.bus_apl_id = T5.BUSI_SERIAL_NO
AND     T1.DT = T5.DT
WHERE   T1.DT IN ( '20221231' , '20231231' , '20240430' )
AND     T1.pd_cd NOT like '201040202%'  --贴现
AND     T1.pd_cd NOT like '2010403%'  --贸易融资
;


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_20221231;

CREATE TABLE lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_20221231 AS
SELECT
   *
FROM lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_01
WHERE 数据日期= '20221231'
AND   借据余额>0
;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_20231231;

CREATE TABLE lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_20231231 AS
SELECT
   *
FROM lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_01
WHERE 数据日期= '20231231'
AND   借据余额>0
;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_20240430;

CREATE TABLE lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_20240430 AS
SELECT
   *
FROM lab_bigdata_dev.tmp_gt_gongshang_dk_20240520_01
WHERE 数据日期= '20240430'
AND   借据余额>0
 ;
**01-数据需求_总行计财_D0527_叶峰_取出新采购管理系统中走框架物资采购的订单信息.sql
--取出新采购管理系统中走框架物资采购的订单信息 ，时间范围：2023年5月1日-2024年5月20日
--框架订单/框架物资采购申请、行号、验收单号、使用机构、使用部门、采购目录、数量、单价、总金额、商品名称、报销类型
DROP TABLE if EXISTS  lab_bigdata_dev.tmp_yf_SJ2024052726 PURGE ;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_yf_SJ2024052726 as
SELECT (case t1.bplx when 1 then '自行采购结果报批'
                    when 2 then '框架物资采购结果报批'
                    when 3 then '集中采购结果报批'
                    when 4 then '框架合同签订结果报批'
                    when 5 then '电子目录平台结果报批'
                     end) 结果报批类型
        -- ,t4.sqdbh 申请单编号
        -- ,t4.sqdmc 申请单名称
        --  ,(case t4.sqdlx when 0 then '定点合同申请' when 1 then '定点物料申请' when 2 then '自行采购申请' when 3 then '集中采购申请' end) 申请单类型
        --  ,(case t4.zt when 0 then '初始化' when 3 then '已退回' when 5 then '审批中' when 10 then '审批完成' when -1 then '已终止' end) 申请单状态
        -- ,(case t2.xmzt when 0 then '待处理' when 1 then '部分处理' when 2 then '已处理' when 3 then '已完结' when 4 then '已关闭' end ) 明细行状态
        ,t2.hh 行号
        ,t6.ysdh 验收单号
        ,t2.syjgmc 使用机构
        ,t2.sybmmc 使用部门
        ,t2.cgml 采购目录
        ,t2.cgmlmc 采购目录名称
        -- ,t2.dj 申请单价
        -- ,t2.cgsl 申请数量
        -- ,t2.ys  预算金额
        ,t3.dj 采购单价
        ,t3.cgsl 采购数量
        ,t3.cgje 采购金额
        ,t3.spmc 商品名称
        ,t2.bxlxbh 报销类型编号
        ,t2.bxlxmc 报销类型名称
        ,substr(t1.cjsj,1,8) 创建时间
from edw.epms_xm_jgbp  t1   --结果报批表
inner join edw.epms_xm_jgbp_spxx t3   --结果报批商品信息表
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'                    --结果报批id关联
inner join edw.epms_wt_sqdmx  t2  --申请单明细表
on  t3.sqdmx = t2.id and t2.dt='@@{yyyyMMdd}'                   --申请id关联
inner join edw.epms_wt_cgsqd  t4  --采购申请单表
on t2.sqdbh = t4.id  and t4.dt='@@{yyyyMMdd}'                  --申请单编号关联
-- left join edw.epms_jc_ztbzt t5  --供应商基础信息表
-- on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'   --供应商编号关联
-- left join edw.dim_hr_org_mng_org_tree_dd org
-- on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
left join edw.epms_xm_htys t6  --验收信息表
on t6.ywid=t1.id and t6.dt='@@{yyyyMMdd}'
WHERE t1.dt='@@{yyyyMMdd}'
and substr(t1.CJSJ,1,8) >='20230501'  and substr(t1.CJSJ,1,8) <='20240520'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)    --是否数据迁移
and t1.bplx='2'   --框架物资采购结果报批
;


--SELECT * FROM lab_bigdata_dev.tmp_yf_SJ2024052726
;
**01-数据需求_总行计财_D0527杭州分行_周晨辉_诉讼费用报销明细.sql
--2014年至今的，杭州分行的，已报销诉讼费用清单
--字段：单据编号、单据类型、报销日期、入池时间、审核日期、报销金额、已付金额、申请人、审批状态，以及每条报销单据对应的具体事项内容

--edw.ncms_exp_report_headers T1 --费用报销单头表
-- edw.ncms_exp_report_lines T2 --费用报销单行表
--edw.ncms_fnd_companies T3 --公司定义

SELECT T1.DT,count(1) from  edw.ncms_exp_report_headers T1  WHERE T1.DT>='20240101' and T1.DT<='20240527' GROUP BY T1.DT ORDER BY T1.DT;

SELECT T1.DT,count(1) from  edw.ncms_exp_report_lines T1  WHERE T1.DT>='20240101' and T1.DT<='20240527' GROUP BY T1.DT ORDER BY T1.DT;

SELECT T1.DT,count(1) from  edw.ncms_fnd_companies T1  WHERE T1.DT>='20240101' and T1.DT<='20240527' GROUP BY T1.DT ORDER BY T1.DT;



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240524101 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_tmp_sjxq_SJ20240524101 AS
SELECT  T1.exp_report_number               AS 单据编号
        ,T1.exp_report_type_id             AS 单据类型id
        ,T1.report_date                    AS 报销日期
        ,T1.pool_date                      AS 入池时间
        ,T1.audit_date                     as 审核日期
        ,T2.report_functional_amount       AS 报销金额
        ,T1.total_amount                   AS 总金额
        ,T1.paid_money                     AS 已付金额
        ,T3.company_code                   AS 机构号
        ,T4.description_text               AS 机构名称
        ,T1.created_by                     AS 创建人
        ,CONCAT(T5.employee_code, T5.name) AS 报销人
        ,T1.report_status                  AS 审批状态
        -- ,T2.amount_and_tax - T2.tax_amount AS 不含税金额
        -- ,T2.tax_amount                     AS 税额
        -- ,T2.invoice_code                   AS 发票代码
        -- ,T2.invoice_number                 AS 发票号码
        --,T6.description_text               AS 发票类型
        ,T1.description                    AS 头表摘要
        ,T2.description                    AS 行表摘要
        -- ,T7.payee_name                     AS 收款方
        --,T1.write_off_completed_date       AS 付款日期
FROM    edw.ncms_exp_report_headers T1 --费用报销单头表
LEFT JOIN    edw.ncms_exp_report_lines T2 --费用报销单行表
ON      T1.exp_report_header_id = T2.exp_report_header_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.ncms_fnd_companies T3 --公司定义
ON      T2.company_id = T3.company_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.ncms_fnd_descriptions T4 --系统描述文本
ON      T3.company_short_name_id = T4.description_id --公司简称ID
AND     T4.DT = '@@{yyyyMMdd}'
AND     T4.ref_table = 'FND_COMPANIES'
AND     T4.ref_field = 'COMPANY_SHORT_NAME_ID'
AND     T4.language = 'ZHS'
LEFT JOIN    edw.ncms_exp_employees T5 --员工基础定义
ON      T1.employee_id = T5.employee_id --员工ID
AND     T5.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    (
--                  SELECT  ta.invoice_id
--                          ,b.description_text
--                  FROM    edw.ncms_tax_invoice_types t --发票类型
--                  LEFT JOIN    edw.ncms_fnd_descriptions b --系统描述说明文本表
--                  ON      t.description_id = b.description_id
--                  AND     b.ref_table = 'TAX_INVOICE_TYPES'
--                  AND     b.ref_field = 'DESCRIPTION_ID'
--                  AND     b.language = 'ZHS'
--                  AND     B.DT = '@@{yyyyMMdd}'
--                  INNER JOIN    edw.ncms_tax_invoices ta --发票信息表
--                  ON      T.invoice_type_id = ta.invoice_type_id
--                  AND     TA.DT = '@@{yyyyMMdd}'
--                  WHERE   T.DT = '@@{yyyyMMdd}'
--              ) T6
-- ON      T2.invoice_id = T6.invoice_id
-- LEFT JOIN    lab_bigdata_dev.tmp_ymy_2207071545 T7
-- ON      T1.exp_report_header_id = T7.exp_report_header_id
WHERE  T3.company_code LIKE '3302%' --杭州分行
and    T1.DT = '@@{yyyyMMdd}'
AND    substr(T1.report_date,1,10) >= '2014-01-01';

SELECT * from lab_bigdata_dev.tmp_tmp_sjxq_SJ20240524101
**01-数据需求_总行计财_D0530_郑城城_研发需求申请流程明细.sql
--分析手机银行科技成本，20-24年科技需求清单（OA-需求准入申请）
--requestid	需求编号	需求名称	申请人姓名	申请人部门	申请日期	需求实施方式	主系统	关联系统
--紧急程度1	紧急程度2	紧急程度3	紧急程度4	专业部门_计划财务部	专业部门_核算	专业部门_监管报送	专业部门_合规部	专业部门_大数据部
--专业部门_基础标准	专业部门_指标标准	专业部门_数据安全	专业部门_分险管理部	主题组_客户关系管理项目组	主题组_产品管理与创新项目组	主题组_数字化风控项目组	主题组_渠道建设与运营项目组
--需求来源	技术经理	产品经理	一级指标	二级指标	价值指标	价值指标口径	基线值	目标值	达成时间	痛点、根因、监管要求	举措

--结果表：
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024052936 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024052936 AS
SELECT  fm.requestid
        ,fm.xqbh                                AS 需求编号
        ,fm.xqmc                                AS 需求名称
        ,CONCAT(hr.loginid, '-', hr.lastname)   AS 申请人姓名
        -- hr.loginid || ' ' || hr.lastname AS 申请人姓名,
        ,hd.departmentmark                      AS 申请人部门
        ,fm.sqrq                                AS 申请日期
        ,A1.selectname                          AS 需求实施方式
        ,it.systemname                          AS 主系统
        ,ff.systemname                          AS 关联系统
        ,A2.selectname                          AS 紧急程度1
        ,A3.selectname                          AS 紧急程度2
        ,A4.selectname                          AS 紧急程度3
        ,fm.xqlxqt                              AS 紧急程度4
        --专业部门
        ,fm.jhcwb                               AS 专业部门_计划财务部
        ,fm.hs                                  AS 专业部门_核算
        ,fm.jgbs                                AS 专业部门_监管报送
        ,fm.hgb                                 AS 专业部门_合规部
        ,fm.dsjb                                AS 专业部门_大数据部
        ,fm.jcbz                                AS 专业部门_基础标准
        ,fm.zbbz                                AS 专业部门_指标标准
        ,fm.sjaq                                AS 专业部门_数据安全
        ,fm.fxglb                               AS 专业部门_风险险管理部
        --主题组
        ,fm.khgx                                AS 主题组_客户关系管理项目组
        ,fm.cpgl                                AS 主题组_产品管理与创新项目组
        ,fm.szh                                 AS 主题组_数字化风控项目组
        ,fm.qdjs                                AS 主题组_渠道建设与运营项目组
        ,B1.selectname                          AS 需求来源
        ,CONCAT(hr2.loginid, '-', hr2.lastname) AS 技术经理
        ,CONCAT(hr3.loginid, '-', hr3.lastname) AS 产品经理
        -- hr2.loginid || ' ' || hr2.lastname AS 技术经理,
        -- hr3.loginid || ' ' || hr3.lastname AS 产品经理,
        ,B2.selectname                          AS 一级指标
        ,B3.selectname                          AS 二级指标
        ,B4.selectname                          AS 价值指标
        ,fm_dt1.zbkj                            AS 价值指标口径
        ,fm_dt1.jxz                             AS 基线值
        ,fm_dt1.mbz                             AS 目标值
        ,fm_dt1.dcsj                            AS 达成时间
        ,fm.jgyq                                AS 痛点根因监管要求
        ,fm.jc                                  AS 举措
FROM    edw.oadb_formtable_main_660 fm    --目前只有22年3月份之后的数据
LEFT JOIN    edw.oadb_hrmresource hr
ON      hr.ID = fm.sqr
AND     hr.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmdepartment hd
ON      hd.ID = fm.sqbm
AND     hd.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_new_itms_system it
ON      to_char(it.systemid) = fm.zyxt1
AND     it.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_formtable_main_660_dt1 fm_dt1
ON      fm_dt1.mainid = fm.id
AND     fm_dt1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmresource hr2
ON      to_char(hr2.id) = fm.jsjl
AND     hr2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmresource hr3
ON      to_char(hr3.id) = fm.cpjl
AND     hr3.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  requestid
                         ,WM_CONCAT('||', h3.systemname) systemname   --将关联系统多行拼在一行
                 FROM    (
                             SELECT  A.requestid
                                     ,A.glxt1
                                     ,glxt_1
                             FROM    edw.oadb_formtable_main_660 A LATERAL VIEW explode(split(A.glxt1, ',')) glxt_1 AS glxt_1 --紧密客户号拆解
                             WHERE   DT = '@@{yyyyMMdd}'
                             AND     A.glxt1 <> ''
                         ) fm2
                 LEFT JOIN    edw.oadb_new_itms_system h3
                 ON      h3.systemid = fm2.glxt_1
                 AND     h3.dt = '@@{yyyyMMdd}'
                 GROUP BY requestid
             ) ff
ON      ff.requestid = fm.requestid
LEFT JOIN    edw.oadb_workflow_selectitem A1 --需求实施方式
ON      A1.selectvalue = fm.ssfs
AND     A1.fieldid = '204266'
AND     A1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem A2 --紧急程度1
ON      A2.selectvalue = fm.xqlx
AND     A2.fieldid = '204267'
AND     A2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem A3 --紧急程度2
ON      A3.selectvalue = fm.nwb
AND     A3.fieldid = '204279'
AND     A3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem A4 --紧急程度3
ON      A4.selectvalue = fm.wb
AND     A4.fieldid = '204280'
AND     A4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B1 --需求来源
ON      B1.selectvalue = fm.xqly
AND     B1.fieldid = '204272'
AND     B1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B2 --一级指标
ON      B2.selectvalue = fm_dt1.yjzb
AND     B2.fieldid = '204296'
AND     B2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B3 --二级指标
ON      B3.selectvalue = fm_dt1.rjzb
AND     B3.fieldid = '204297'
AND     B3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B4 --价值指标
ON      B4.selectvalue = fm_dt1.jzzb
AND     B4.fieldid = '204298'
AND     B4.dt = '@@{yyyyMMdd}'
WHERE   fm.dt = '@@{yyyyMMdd}'
AND     substr(fm.sqrq, 1,4) >= '2020';

SELECT count(*) FROM lab_bigdata_dev.tmp_sjxq_SJ2024052936
-- ;
-- SELECT * from edw.oadb_formtable_main_660 where  dt = '@@{yyyyMMdd}' AND substr(fm.sqrq, 1,4) = '2021'

-- desc edw.oadb_hrmdepartment
--desc  edw.oadb_formtable_main_660
-- | id              | decimal    |       | id                                          |
-- | requestid       | decimal    |       | 请求ID                                        |
-- | sqr             | decimal    |       | 拟申请员工                                       |
-- | sqbm            | decimal    |       | 申请部门                                        |
-- | sqrq            | string     |       | 申请日期                                        |
-- | xqbh            | string     |       | 需求编号                                        |
-- | xqmc            | string     |       | 需求名称                                        |
-- | ssfs            | decimal    |       | 实施方式                                        |
-- | xqlx            | decimal    |       | 紧急程度                                        |
-- | sptd            | decimal    |       | 评审通道                                        |
-- | spjg            | decimal    |       | 评审结果                                        |
-- | btgyy           | string     |       | 不通过原因/待办描述                                  |
-- | lhhpgzb         | decimal    |       | 是否有量化后评估指标                                  |
-- | xqly            | decimal    |       | 需求来源                                        |
-- | zrpsfs          | decimal    |       | 需求类型                                        |
-- | ssxq            | string     |       | 需求实施详情                                      |
-- | sqrgh           | string     |       | 申请人工号                                       |
-- | thlx            | decimal    |       | 退回类型                                        |
-- | nwb             | decimal    |       | 内外部                                         |
-- | wb              | decimal    |       | 外部内部                                        |
-- | xqlxqt          | string     |       | 其他                                          |
-- | jhcwb           | string     |       | 计划财务部                                       |
-- | hgb             | string     |       | 合规部（监管合规）                                   |
-- | dsjb            | string     |       | 大数据部                                        |
-- | fxglb           | string     |       |  风险管理部（操作风险）                                |
-- | wu              | string     |       | 无                                           |
-- | khgx            | string     |       | 客户关系管理项目组                                   |
-- | cpgl            | string     |       | 产品管理与创新项目组                                  |
-- | szh             | string     |       | 数字化风控项目组                                    |
-- | qdjs            | string     |       | 渠道建设与运营项目组                                  |
-- | w               | string     |       | 无                                           |
-- | ywxqwd          | string     |       | 业务需求文档                                      |
-- | th              | decimal    |       | 退回                                          |
-- | cpjl            | string     |       | 产品经理                                        |
-- | jsjl            | string     |       | 技术经理                                        |
-- | ywlxr           | string     |       | 关联部门联系人                                     |
-- | jhjsr           | string     |       | 需求实施计划接收人                                   |
-- | ztbm            | string     |       | 专业部门                                        |
-- | ztxmz           | string     |       | 专题项目组                                       |
-- | zxtywfzr        | string     |       | 主系统业务负责人                                    |
-- | zxtdydjsjl      | decimal    |       | 主系统对应的技术经理                                  |
-- | glxtjsjl        | decimal    |       | 关联系统对应的技术经理                                 |
-- | sfdr            | decimal    |       | 是否导入                                        |
-- | zyxt1           | string     |       | 主系统                                         |
-- | glxt1           | string     |       | 关联系统                                        |
-- | jsoninfo        | string     |       | 创建失败信息                                      |
-- | jgyq            | string     |       | 痛点、根因/监管要求                                  |
-- | jc              | string     |       | 举措                                          |
-- | sshl            | string     |       | 所属行类                                        |
-- | duorenli        | string     |       | 多人力                                         |
-- | ywlxr1          | string     |       | 关联部门联系人                                     |
-- | xtzgbmfzr       | string     |       | 系统主管部门负责人                                   |
-- | sdxtzgbmfzr     | string     |       | 手动系统主管部门负责人                                 |
-- | sfbj            | decimal    |       | 是否编辑                                        |
-- | zxtdydcpjl      | decimal    |       | 主系统对应的产品经理                                  |
-- | glzd            | string     |       | 关联字段                                        |
-- | sfyz            | decimal    |       | 是否有值                                        |
-- | jcbz            | string     |       | 基础标准                                        |
-- | zbbz            | string     |       | 指标标准                                        |
-- | sjaq            | string     |       | 数据安全                                        |
-- | hs              | string     |       | 核算                                          |
-- | jgbs            | string     |       | 监管报送                                        |
-- | sftg            | string     |       | 是否跳过                                        |
-- | sfgd            | string     |       | 是否归档                                        |
-- | sfcs            | string     |       | 是否初审                                        |
-- | csr             | string     |       | 初审人（不要）                                     |
-- | csr1            | string     |       | 初审人1                                        |
-- | csr2            | string     |       | 初审人2                                        |

--日常需求申请新
-- SELECT
-- 	fm.requestid,
-- 	fm.xqbh AS 需求编号,
-- 	fm.xqmc AS 需求名称,
-- 	--hr.loginid || ' ' || hr.lastname AS 申请人姓名,
-- 	concat(hr.loginid,'-',hr.lastname)
-- 	hd.departmentmark AS 申请人部门,
-- 	fm.sqsj AS 申请日期,
-- --需求实施方式
-- 	it.systemname AS 主系统,
-- 	ff.systemname AS 关联系统,
-- --紧急程度
-- --专业部门
-- --主题组
-- 	(select ws.selectname from workflow_selectitem ws where ws.fieldid = '192328' and to_char(selectvalue) = fm.xqly)	 需求来源,
-- 	--hr2.loginid || ' ' || hr2.lastname AS 技术经理,
-- 	--hr3.loginid || ' ' || hr3.lastname AS 产品经理,
-- 	concat(hr2.loginid,'-',hr2.lastname) as 技术经理,
-- 	concat(hr3.loginid,'-',hr3.lastname) as 产品经理,
-- 	(select ws.selectname from edw.oadb_workflow_selectitem ws where ws.fieldid = '192298' and to_char(selectvalue) = fm_dt1.yjzb)	 一级指标,
-- 	(select ws.selectname from edw.oadb_workflow_selectitem ws where ws.fieldid = '192299' and to_char(selectvalue) = fm_dt1.ejzb)	 二级指标,
-- 	(select ws.selectname from edw.oadb_workflow_selectitem ws where ws.fieldid = '192300' and to_char(selectvalue) = fm_dt1.jzzb)	 价值指标,
-- 	fm_dt1.zbkj as 价值指标口径,
-- 	fm_dt1.jxz as 基线值,
-- 	fm_dt1.mbz as 目标值,
-- 	fm_dt1.dcsj as 达成时间,
-- 	fm.td as 痛点、根因、监管要求,
-- 	fm.jzmbdcjc as 举措
-- FROM
-- 	edw.oadb_formtable_main_634 fm
-- 	left JOIN edw.oadb_hrmresource hr ON hr.ID = fm.sqr
-- 	left JOIN edw.oadb_hrmdepartment hd ON hd.ID = fm.sqbm
-- 	left JOIN edw.oadb_itms_system it ON it.systemid = fm.zyxt
-- 	left JOIN edw.oadb_Matrixtable_55 mt ON mt.systemname = fm.zyxt
-- 	left join edw.oadb_formtable_main_634_dt1 fm_dt1 on fm_dt1.mainid = fm.id
-- 	left join edw.oadb_hrmresource hr2 on hr2.id = fm.jsjl
-- 	left join edw.oadb_hrmresource hr3 on hr3.id = fm.cpjl
-- 	left JOIN (
-- 	SELECT
-- 		requestid,
-- 		--string_agg ( h3.systemname || '', ',' ) systemname
-- 		,WM_CONCAT('||', h3.systemname) systemname
-- 	FROM
-- 		( SELECT A.requestid,
-- 		         ,A.glxt1
--                          ,glxt_1
-- 		     FROM    edw.oadb_formtable_main_634 A LATERAL VIEW explode(split(A.glxt1, ',')) glxt1 AS glxt_1
-- 			 WHERE A.glxt <> '' ) fm2
-- 	LEFT JOIN edw.oadb_itms_system h3 ON h3.systemid = fm2.glxt
-- 	GROUP BY requestid
-- 	) ff ON ff.requestid = fm.requestid
-- WHERE
-- 	fm.sqsj > '2021-01-01'

-- ;

-- DESC edw.oadb_formtable_main_634
**01-数据需求_总行计财_D1225_毛晨烨_客户价值.sql
--2023年近1年客户价值

drop TABLE if EXISTS  tmp_sjxq_mcy_SJ20241224156 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_mcy_SJ20241224156 as
SELECT
eq_risk_cntl_nm AS `同一风险控制号`
,cust_no AS `客户号`
,cust_nm AS `客户名称`
,prm_org_id AS `主管户机构`
,prm_org_nm AS `主管户机构名称`
,prm_mgr_id AS `主管户客户经理工号`
,prm_mgr_nm AS `主管户客户经理名称`
		,'J12Y'
		,SUM(T1.dep_nrt_int_inc++T1.ln_nrt_int_inc+T1.cc_ln_int_net_inc
             +T1.fin_bus_nrt_inc+T1.ibiz_inter_bus_int_inc
             +T1.unpay_debit_frr_nrt+T1.cd_nrt_fee_inc+T1.ths_nrt_fee_inc+T1.stt_fee_nrt_inc+T1.stt_wxjjk_nrt_inc+T1.entr_ln_fee_inc+T1.stt_fee_wxdjk_inc+T1.stt_fee_zfbdjk_inc
             -(T1.crdt_cap_cost+T1.cc_ln_cap_cost+T1.ofb_crdt_xyk_cost)
             -(-T1.ln_tax_out+T1.oth_ln_trx_cost +T1.cd_ln_trx_inc)
             -(T1.prdu_pnt_cnt+T1.dep_insu_out+T1.msg_cost+T1.ths_matrl_cost+T1.bill_stt_fee_exp))  AS val
,sum(nvl(dep_nrt_int_inc,0)) as `存款业务FTP净收入`
,sum(nvl(bs_dep_hq_int_net_inc,0)) as `基础性存款活期存款利息净收入`
,sum(nvl(bs_dep_dq_int_net_inc,0)) as `基础性存款定期存款利息净收入`
,sum(nvl(bs_dep_ybt_int_net_inc,0)) as `基础性存款一本通利息净收入`
,sum(nvl(bs_dep_bzj_int_net_inc,0)) as `基础性存款保证金利息净收入`
,sum(nvl(zy_dep_hq_int_net_inc,0)) as `资源性存款活期存款利息净收入`
,sum(nvl(zy_dep_bzj_int_net_inc,0)) as `资源性存款保证金利息净收入`
,sum(nvl(zy_dep_dq_int_net_inc,0)) as `资源性存款定期存款利息净收入`
,sum(nvl(fx_dep_cd_int_net_inc,0)) as `发行性存款大额存单利息净收入`
,sum(nvl(fx_dep_jgx_int_net_inc,0)) as `发行性存款结构性利息净收入`
,sum(nvl(oth_dep_int_net_inc,0)) as `其他存款利息净收入`
,sum(nvl(ln_nrt_int_inc,0)) as `贷款业务FTP净收入`
,sum(nvl(yb_ln_int_net_inc,0)) as `一般贷款（剔除随贷通）利息净收入`
,sum(nvl(zz_ln_int_net_inc,0)) as `随贷通利息净收入`
,sum(nvl(thr_ln_int_net_inc,0)) as `政策性贷款利息净收入`
,sum(nvl(my_ln_int_net_inc,0)) as `贸易融资利息净收入`
,sum(nvl(cc_ln_int_net_inc,0)) as `信用卡利息净收入`
,sum(nvl(oth_ln_int_net_inc,0)) as `其他贷款利息净收入`
,sum(nvl(ln_gnxyz_fee_inc,0)) as `贷款国内信用证收入`
,sum(nvl(fin_bus_nrt_inc,0)) as `财富业务手续费净收入`
,sum(nvl(fin_sale_fee_inc,0)) as `理财销售中间业务收入`
,sum(nvl(fin_drct_fee_inc,0)) as `理财直融中间业务收入`
,sum(nvl(agn_insur_fee_inc,0)) as `代销保险业务手续费收入`
,sum(nvl(agn_fund_fee_inc,0)) as `代销基金业务手续费收入`
,sum(nvl(psn_trsf_bond_fee_inc,0)) as `私募可转债中间业务收入`
,sum(nvl(agnall_fee_inc,0)) as `贵金属代销中间业务收入`
,sum(nvl(agn_fin_fee_inc,0)) as `代销理财中间业务收入`
,sum(nvl(ibiz_inter_bus_int_inc,0)) as `国际业务中间业务净收入`
,sum(nvl(jsh_nrt_inc,0)) as `国际业务结售汇收入`
,sum(nvl(der_nrt_inc,0)) as `国际业务衍生品净收益`
,sum(nvl(ibiz_bus_inc,0)) as `国际业务手续费收入`
,sum(nvl(ibiz_bus_inc_exp,0)) as `国际结算手续费支出`
,sum(nvl(unpay_debit_frr_nrt,0)) as `借记卡手续费净收入`
,sum(nvl(cd_nrt_fee_inc,0)) as `贷记卡业务手续费净收入`
,sum(nvl(ths_nrt_fee_inc,0)) as `三、收单业务手续费净收入`
,sum(nvl(stt_fee_nrt_inc,0)) as `结算手续费净收入`
,sum(nvl(stt_wxjjk_nrt_inc,0)) as `其他手续费净收入微信支付宝`
,sum(nvl(entr_ln_fee_inc,0)) as `委托贷款手续费净收入`
,sum(nvl(stt_fee_wxdjk_inc,0)) as `第三方手续费收入结算类微信贷记卡`
,sum(nvl(stt_fee_zfbdjk_inc,0)) as `第三方手续费收入结算类支付宝贷记卡`
,sum(nvl(crdt_cap_cost,0)) as `信用风险`
,sum(nvl(cc_ln_cap_cost,0)) as `信用卡`
,sum(nvl(ofb_crdt_xyk_cost,0)) as `表外信用卡资本成本`
,sum(nvl(oth_ln_trx_cost,0)) as `五、其他业务销项税`
,sum(nvl(cd_ln_trx_inc,0)) as `手续费收入贷记卡销项税`
,sum(nvl(ln_tax_out,0)) as `贷款免税额加回`
,sum(nvl(prdu_pnt_cnt,0)) as `业务费用综合积分成本产生口径`
,sum(nvl(dep_insu_out,0)) as `存款保险费`
,sum(nvl(msg_cost,0)) as `短信费用`
,sum(nvl(ths_matrl_cost,0)) as `收单业务物料费用`
,sum(nvl(bill_stt_fee_exp,0)) as `票据结算手续费支出`
FROM	app_iftp.eva_app_cust_assess_inf_hz T1

WHERE	T1.DT IN (
'20230131',
'20230228',
'20230331',
'20230430',
'20230531',
'20230630',
'20230731',
'20230831',
'20230930',
'20231031',
'20231130',
'20231231'
)
    AND T1.freq_cd = 'M'
    AND SUBSTR(T1.prm_org_id,1,4) = '3307'
GROUP BY eq_risk_cntl_nm,cust_no,cust_nm
,prm_org_id,prm_org_nm,prm_mgr_id,prm_mgr_nm

;


--2024年11月近1年客户价值
drop TABLE if EXISTS  tmp_sjxq_mcy_SJ20241224156_20241130 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_mcy_SJ20241224156_20241130 as
SELECT
eq_risk_cntl_nm AS `同一风险控制号`
,cust_no AS `客户号`
,cust_nm AS `客户名称`
,prm_org_id AS `主管户机构`
,prm_org_nm AS `主管户机构名称`
,prm_mgr_id AS `主管户客户经理工号`
,prm_mgr_nm AS `主管户客户经理名称`
		,'J12Y'
		,SUM(T1.dep_nrt_int_inc++T1.ln_nrt_int_inc+T1.cc_ln_int_net_inc
             +T1.fin_bus_nrt_inc+T1.ibiz_inter_bus_int_inc
             +T1.unpay_debit_frr_nrt+T1.cd_nrt_fee_inc+T1.ths_nrt_fee_inc+T1.stt_fee_nrt_inc+T1.stt_wxjjk_nrt_inc+T1.entr_ln_fee_inc+T1.stt_fee_wxdjk_inc+T1.stt_fee_zfbdjk_inc
             -(T1.crdt_cap_cost+T1.cc_ln_cap_cost+T1.ofb_crdt_xyk_cost)
             -(-T1.ln_tax_out+T1.oth_ln_trx_cost +T1.cd_ln_trx_inc)
             -(T1.prdu_pnt_cnt+T1.dep_insu_out+T1.msg_cost+T1.ths_matrl_cost+T1.bill_stt_fee_exp))  AS val
,sum(nvl(dep_nrt_int_inc,0)) as `存款业务FTP净收入`
,sum(nvl(bs_dep_hq_int_net_inc,0)) as `基础性存款活期存款利息净收入`
,sum(nvl(bs_dep_dq_int_net_inc,0)) as `基础性存款定期存款利息净收入`
,sum(nvl(bs_dep_ybt_int_net_inc,0)) as `基础性存款一本通利息净收入`
,sum(nvl(bs_dep_bzj_int_net_inc,0)) as `基础性存款保证金利息净收入`
,sum(nvl(zy_dep_hq_int_net_inc,0)) as `资源性存款活期存款利息净收入`
,sum(nvl(zy_dep_bzj_int_net_inc,0)) as `资源性存款保证金利息净收入`
,sum(nvl(zy_dep_dq_int_net_inc,0)) as `资源性存款定期存款利息净收入`
,sum(nvl(fx_dep_cd_int_net_inc,0)) as `发行性存款大额存单利息净收入`
,sum(nvl(fx_dep_jgx_int_net_inc,0)) as `发行性存款结构性利息净收入`
,sum(nvl(oth_dep_int_net_inc,0)) as `其他存款利息净收入`
,sum(nvl(ln_nrt_int_inc,0)) as `贷款业务FTP净收入`
,sum(nvl(yb_ln_int_net_inc,0)) as `一般贷款（剔除随贷通）利息净收入`
,sum(nvl(zz_ln_int_net_inc,0)) as `随贷通利息净收入`
,sum(nvl(thr_ln_int_net_inc,0)) as `政策性贷款利息净收入`
,sum(nvl(my_ln_int_net_inc,0)) as `贸易融资利息净收入`
,sum(nvl(cc_ln_int_net_inc,0)) as `信用卡利息净收入`
,sum(nvl(oth_ln_int_net_inc,0)) as `其他贷款利息净收入`
,sum(nvl(ln_gnxyz_fee_inc,0)) as `贷款国内信用证收入`
,sum(nvl(fin_bus_nrt_inc,0)) as `财富业务手续费净收入`
,sum(nvl(fin_sale_fee_inc,0)) as `理财销售中间业务收入`
,sum(nvl(fin_drct_fee_inc,0)) as `理财直融中间业务收入`
,sum(nvl(agn_insur_fee_inc,0)) as `代销保险业务手续费收入`
,sum(nvl(agn_fund_fee_inc,0)) as `代销基金业务手续费收入`
,sum(nvl(psn_trsf_bond_fee_inc,0)) as `私募可转债中间业务收入`
,sum(nvl(agnall_fee_inc,0)) as `贵金属代销中间业务收入`
,sum(nvl(agn_fin_fee_inc,0)) as `代销理财中间业务收入`
,sum(nvl(ibiz_inter_bus_int_inc,0)) as `国际业务中间业务净收入`
,sum(nvl(jsh_nrt_inc,0)) as `国际业务结售汇收入`
,sum(nvl(der_nrt_inc,0)) as `国际业务衍生品净收益`
,sum(nvl(ibiz_bus_inc,0)) as `国际业务手续费收入`
,sum(nvl(ibiz_bus_inc_exp,0)) as `国际结算手续费支出`
,sum(nvl(unpay_debit_frr_nrt,0)) as `借记卡手续费净收入`
,sum(nvl(cd_nrt_fee_inc,0)) as `贷记卡业务手续费净收入`
,sum(nvl(ths_nrt_fee_inc,0)) as `三、收单业务手续费净收入`
,sum(nvl(stt_fee_nrt_inc,0)) as `结算手续费净收入`
,sum(nvl(stt_wxjjk_nrt_inc,0)) as `其他手续费净收入微信支付宝`
,sum(nvl(entr_ln_fee_inc,0)) as `委托贷款手续费净收入`
,sum(nvl(stt_fee_wxdjk_inc,0)) as `第三方手续费收入结算类微信贷记卡`
,sum(nvl(stt_fee_zfbdjk_inc,0)) as `第三方手续费收入结算类支付宝贷记卡`
,sum(nvl(crdt_cap_cost,0)) as `信用风险`
,sum(nvl(cc_ln_cap_cost,0)) as `信用卡`
,sum(nvl(ofb_crdt_xyk_cost,0)) as `表外信用卡资本成本`
,sum(nvl(oth_ln_trx_cost,0)) as `五、其他业务销项税`
,sum(nvl(cd_ln_trx_inc,0)) as `手续费收入贷记卡销项税`
,sum(nvl(ln_tax_out,0)) as `贷款免税额加回`
,sum(nvl(prdu_pnt_cnt,0)) as `业务费用综合积分成本产生口径`
,sum(nvl(dep_insu_out,0)) as `存款保险费`
,sum(nvl(msg_cost,0)) as `短信费用`
,sum(nvl(ths_matrl_cost,0)) as `收单业务物料费用`
,sum(nvl(bill_stt_fee_exp,0)) as `票据结算手续费支出`
FROM	app_iftp.eva_app_cust_assess_inf_hz T1

WHERE	T1.DT IN (
'20231231',
'20240131',
'20240229',
'20240331',
'20240430',
'20240531',
'20240630',
'20240731',
'20240831',
'20240930',
'20241031',
'20241130'
)
    AND T1.freq_cd = 'M'
    AND SUBSTR(T1.prm_org_id,1,4) = '3307'
GROUP BY eq_risk_cntl_nm,cust_no,cust_nm
,prm_org_id,prm_org_nm,prm_mgr_id,prm_mgr_nm

;
**01-数据需求_总行计财_SJ2024061786_卢梦江_判断核销清单中客户是否农户.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 卫少洁
-- 创建日期: 2024-03-07 10:47:45
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************

--对公用办公判断  对私用居住
--step1，先取客户的地址数据
drop table  if EXISTS  tmp_wsj_lmj_dzxx_20211231;
CREATE TABLE tmp_wsj_lmj_dzxx_20211231 AS
SELECT  p.cst_id
        ,t.customername cst_nm
        ,t1.address4 jz
        ,t1.city jz_city
        ,t1.ismainaddress jz_ismainaddress
        ,t1.fourthaddress  jz_fourthaddress
        ,tmp1.name          jz_name
        ,t2.address4 bg
        ,t2.city bg_city
        ,t2.ismainaddress bg_ismainaddress
        ,t2.fourthaddress  bg_fourthaddress
        ,tmp2.name         bg_name
        ,t3.address4 hj
        ,t3.city hj_city
        ,t3.ismainaddress hj_ismainaddress
        ,t3.fourthaddress  hj_fourthaddress
        ,tmp3.name         hj_name
        ,t4.address4 zc
        ,t4.city zc_city
        ,t4.ismainaddress zc_ismainaddress
        ,t4.fourthaddress  zc_fourthaddress
        ,tmp4.name         zc_name
FROM    edw.loan_customer_info t --客户基本信息
LEFT JOIN    (
                 SELECT  customerid
                         ,address4
                         ,city
                         ,ismainaddress
                         ,fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY customerid , addtype ORDER BY updatedate DESC ) rn
                 FROM    edw.loan_customer_address  --客户联系地址
                 WHERE   dt = '20231231'
                 AND     addtype = '60'
             ) t1 -----居住地址
ON      t.customerid = t1.customerid
AND     t1.rn = 1
left join  tmp_hc_jddm tmp1   --街道数据
on t1.fourthaddress =tmp1.adcode
LEFT JOIN    (
                 SELECT  customerid
                         ,address4
                         ,city
                         ,ismainaddress
                         ,fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY customerid , addtype ORDER BY updatedate DESC ) rn
                 FROM    edw.loan_customer_address
                 WHERE   dt = '20231124'
                 AND     addtype = '20'
             ) t2 ----:办公地址
ON      t.customerid = t2.customerid
AND     t2.rn = 1
left join  tmp_hc_jddm tmp2
on t2.fourthaddress =tmp2.adcode
LEFT JOIN    (
                 SELECT  customerid
                         ,address4
                         ,city
                         ,ismainaddress
                         ,fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY customerid , addtype ORDER BY updatedate DESC ) rn
                 FROM    edw.loan_customer_address
                 WHERE   dt = '20231231'
                 AND     addtype = '50'
             ) t3 ----:户籍地址
ON      t.customerid = t3.customerid
AND     t3.rn = 1
left join  tmp_hc_jddm tmp3
on t3.fourthaddress =tmp3.adcode
LEFT JOIN    (
                 SELECT  customerid
                         ,address4
                         ,city
                         ,ismainaddress
                         ,fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY customerid , addtype ORDER BY updatedate DESC ) rn
                 FROM    edw.loan_customer_address
                 WHERE   dt = '20231231'
                 AND     addtype = '10'
             ) t4 ----:注册地址
ON      t.customerid = t4.customerid
AND     t4.rn = 1
left join  tmp_hc_jddm tmp4
on t4.fourthaddress =tmp4.adcode
inner join (
SELECT distinct COL_1 as cst_id
from qbi_file_20240617_17_23_54   --导入的待查2021年客户清单
where pt=MAX_PT('lab_bigdata_dev.qbi_file_20240617_17_23_54')
)p
on t.customerid = p.cst_id
WHERE   t.dt = '20231231';


-- SELECT * from tmp_wsj_lmj_nhbs_20231231


----- step2 ,再判断 居住、户籍、办公、注册 是否农村   1是 0否
drop table if EXISTS  tmp_wsj_lmj_nhbs_20231231 ;
create table tmp_wsj_lmj_nhbs_20231231 as
SELECT
cast(cst_id as int) cst_id
,cst_nm
-- ,jz_city
-- ,bg_city
-- ,hj_city
-- ,zc_city
-- ,jz_fourthaddress
-- ,bg_fourthaddress
-- ,hj_fourthaddress
-- ,zc_fourthaddress
-- ,jz_name
-- ,bg_name
-- ,hj_name
-- ,zc_name
-- ,jz_ismainaddress
-- ,bg_ismainaddress
-- ,hj_ismainaddress
-- ,zc_ismainaddress
,jz
,CASE
 WHEN NVL(jz_fourthaddress,'')<>'' and substr(jz_fourthaddress,7,6) <>'999999' AND NVL(jz_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(jz_fourthaddress,'')<>'' and substr(jz_fourthaddress,7,6) <>'999999' AND NVL(jz_name,'') LIKE '%镇'
        AND ( ( NVL(jz_name,'')  LIKE '%熊山镇'   AND jz_city ='350725' )---城关镇
           OR ( NVL(jz_name,'')  LIKE '%双溪镇'  AND  jz_city ='350721' )
           OR ( NVL(jz_name,'')  LIKE '%雪峰镇'  AND  jz_city ='350421' )
           OR ( NVL(jz_name,'')  LIKE '%龙津镇'  AND  jz_city ='350423' )
           OR ( NVL(jz_name,'')  LIKE '%杨舍镇'  AND  jz_city ='320582' )
           OR ( NVL(jz_name,'')  LIKE '%玉山镇'  AND  jz_city ='320583' )
           OR ( NVL(jz_name,'')  LIKE '%城厢镇'  AND  jz_city ='320585' )
           OR ( NVL(jz_name,'')  LIKE '%城关镇'  AND  jz_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(jz_name,'')  LIKE '%首善镇'  AND  jz_city ='610326' )
           OR ( NVL(jz_name,'')  LIKE '%高亭镇'  AND  jz_city ='330921' )
           OR ( NVL(jz_name,'')  LIKE '%华埠镇'  AND  jz_city ='330824' )
           OR ( NVL(jz_name,'')  LIKE '%灵溪镇'  AND  jz_city ='330327' )
           OR ( NVL(jz_name,'')  LIKE '%昆阳镇'  AND  jz_city ='330326' )
           OR ( NVL(jz_name,'')  LIKE '%罗阳镇'  AND  jz_city ='330329' )
           OR ( NVL(jz_name,'')  LIKE '%大峃镇'  AND  jz_city ='330328' )
           OR ( NVL(jz_name,'')  LIKE '%龙港镇'  AND  jz_city ='330383' ))
       AND NVL(jz,'')  LIKE '%村%'  AND NVL(jz,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(jz_fourthaddress,'') <>'' and substr(jz_fourthaddress,7,6) <>'999999'  AND  NVL(jz_name,'') LIKE '%镇'
        AND ((  NVL(jz_name,'')   LIKE '%熊山镇'   AND  jz_city  <> '350725' )---城关镇
           OR ( NVL(jz_name,'')   LIKE '%双溪镇'  AND  jz_city <>'350721' )
           OR ( NVL(jz_name,'')   LIKE '%雪峰镇'  AND  jz_city <>'350421' )
           OR ( NVL(jz_name,'')   LIKE '%龙津镇'  AND  jz_city <>'350423' )
           OR ( NVL(jz_name,'')   LIKE '%杨舍镇'  AND  jz_city <>'320582' )
           OR ( NVL(jz_name,'')   LIKE '%玉山镇'  AND  jz_city <>'320583' )
           OR ( NVL(jz_name,'')   LIKE '%城厢镇'  AND  jz_city <>'320585' )
           OR ( NVL(jz_name,'')   LIKE '%城关镇'  AND  jz_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(jz_name,'')   LIKE '%首善镇'  AND  jz_city <>'610326' )
           OR ( NVL(jz_name,'')   LIKE '%高亭镇'  AND  jz_city <>'330921' )
           OR ( NVL(jz_name,'')   LIKE '%华埠镇'  AND  jz_city <>'330824' )
           OR ( NVL(jz_name,'')   LIKE '%灵溪镇'  AND  jz_city <>'330327' )
           OR ( NVL(jz_name,'')   LIKE '%昆阳镇'  AND  jz_city <>'330326' )
           OR ( NVL(jz_name,'')   LIKE '%罗阳镇'  AND  jz_city <>'330329' )
           OR ( NVL(jz_name,'')   LIKE '%大峃镇'  AND  jz_city <>'330328' )
           OR ( NVL(jz_name,'')   LIKE '%龙港镇'  AND  jz_city <>'330383' ))
        THEN  '1'
WHEN NVL(jz_fourthaddress,'') <>'' and substr(jz_fourthaddress,7,6) <>'999999' AND  NVL(jz_name,'') LIKE '%镇'
        AND (  NVL(jz_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(jz_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(jz_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(jz_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(jz_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(jz_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(jz_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(jz_name,'')  NOT LIKE '%城关镇'
           AND  NVL(jz_name,'')  NOT LIKE '%首善镇'
           AND  NVL(jz_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(jz_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(jz_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(jz_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(jz_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(jz_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(jz_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(jz_fourthaddress,'')<>'' and substr(jz_fourthaddress,7,6) <>'999999' AND NVL(jz,'')  LIKE '%村%'  AND NVL(jz,'') not LIKE '%新村%'  THEN  '1'
when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and LENGTH(jz)-length(replace(jz,'乡',''))=1 and (
          jz not like '%肥乡区%'
     and  jz not like '%柏乡县%'
     and  jz not like '%平乡县%'
     and  jz not like '%武乡县%'
     and  jz not like '%乡宁县%'
     and  jz not like '%桐乡市%'
     and  jz not like '%萍乡市%'
     and  jz not like '%东乡区%'
     and  jz not like '%金乡县%'
     and  jz not like '%新乡市%'
     and  jz not like '%新乡县%'
     and  jz not like '%内乡县%'
     and  jz not like '%宁乡市%'
     and  jz not like '%湘乡市%'
     and  jz not like '%安乡县%'
     and  jz not like '%西乡塘区%'
     and  jz not like '%乡城县%'
     and  jz not like '%西乡县%'
     and  jz not like '%东乡族自治县%'
     and  jz not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and LENGTH(jz)-length(replace(jz,'乡',''))> 1 then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  LENGTH(jz)-length(replace(jz,'镇','')) =1  and
 (
          jz  like '%天镇县%'
     OR  jz  like '%丰镇市%'
     OR  jz  like '%北镇市%'
     OR  jz  like '%镇赉县%'
     OR  jz  like '%镇江市%'
     OR  jz  like '%镇海区%'
     OR  jz  like '%固镇县%'
     OR  jz  like '%景德镇市%'
     OR  jz  like '%镇平县%'
     OR  jz  like '%清镇市%'
     OR  jz  like '%镇宁布依族苗族自治县%'
     OR  jz  like '%镇远县%'
     OR  jz  like '%镇雄县%'
     OR  jz  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  jz  like '%镇康县%'
     OR  jz  like '%镇巴县%'
     OR  jz  like '%镇坪县%'
     OR  jz  like '%镇安县%'
     OR  jz  like '%镇原县%'   ---区县
     OR (jz  like '%熊山镇%'   and  jz_city ='350725' )---城关镇
     OR ( jz  like '%双溪镇%'  and  jz_city ='350721' )
     OR ( jz  like '%雪峰镇%'  and  jz_city ='350421' )
     OR ( jz  like '%龙津镇%'  and  jz_city ='350423' )
     OR ( jz  like '%杨舍镇%'  and  jz_city ='320582' )
     OR ( jz  like '%玉山镇%'  and  jz_city ='320583' )
     OR ( jz  like '%城厢镇%'  and  jz_city ='320585' )
     OR ( jz  like '%城关镇%'  and  jz_city  in ('610981','610928','610921','610929','610924','610926') )
     OR ( jz  like '%首善镇%'  and  jz_city ='610326' )
     OR ( jz  like '%高亭镇%'  and  jz_city ='330921' )
     OR ( jz  like '%华埠镇%'  and  jz_city ='330824' )
     OR ( jz  like '%灵溪镇%'  and  jz_city ='330327' )
     OR ( jz  like '%昆阳镇%'  and  jz_city ='330326' )
     OR ( jz  like '%罗阳镇%'  and  jz_city ='330329' )
     OR ( jz  like '%大峃镇%'  and  jz_city ='330328' )
     OR ( jz  like '%龙港镇%'  and  jz_city ='330383' )
 )  and jz  like '%村%'  and jz not like '%新村%'  then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  LENGTH(jz)-length(replace(jz,'镇','')) =1  and
(

   (      jz  like '%熊山镇%'   and jz_city  <>'350725' )---城关镇
     OR ( jz  like '%双溪镇%'  and  jz_city  <>'350721' )
     OR ( jz  like '%雪峰镇%'  and  jz_city <>'350421' )
     OR ( jz  like '%龙津镇%'  and  jz_city <>'350423' )
     OR ( jz  like '%杨舍镇%'  and  jz_city <>'320582' )
     OR ( jz  like '%玉山镇%'  and  jz_city <>'320583' )
     OR ( jz  like '%城厢镇%'  and  jz_city <>'320585' )
     OR ( jz  like '%城关镇%'  and  jz_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( jz  like '%首善镇%'  and  jz_city <> '610326' )
     OR ( jz  like '%高亭镇%'  and  jz_city <>'330921' )
     OR ( jz  like '%华埠镇%'  and  jz_city <>'330824' )
     OR ( jz  like '%灵溪镇%'  and  jz_city <>'330327' )
     OR ( jz  like '%昆阳镇%'  and  jz_city <>'330326' )
     OR ( jz  like '%罗阳镇%'  and  jz_city <>'330329' )
     OR ( jz  like '%大峃镇%'  and  jz_city <>'330328' )
     OR ( jz  like '%龙港镇%'  and  jz_city <>'330383' )
	 ) then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  LENGTH(jz)-length(replace(jz,'镇','')) =1  and
 (    ----区县
          jz not like '%天镇县%'
     and  jz not like '%丰镇市%'
     and  jz not like '%北镇市%'
     and  jz not like '%镇赉县%'
     and  jz not like '%镇江市%'
     and  jz not like '%镇海区%'
     and  jz not like '%固镇县%'
     and  jz not like '%景德镇市%'
     and  jz not like '%镇平县%'
     and  jz not like '%清镇市%'
     and  jz not like '%镇宁布依族苗族自治县%'
     and  jz not like '%镇远县%'
     and  jz not like '%镇雄县%'
     and  jz not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  jz not like '%镇康县%'
     and  jz not like '%镇巴县%'
     and  jz not like '%镇坪县%'
     and  jz not like '%镇安县%'
     and  jz not like '%镇原县%'
)
and (     jz not like '%熊山镇%'   ----城关镇
     and  jz not like '%双溪镇%'
     and  jz not like '%雪峰镇%'
     and  jz not like '%龙津镇%'
     and  jz not like '%杨舍镇%'
     and  jz not like '%玉山镇%'
     and  jz not like '%城厢镇%'
     and  jz not like '%城关镇%'
     and  jz not like '%首善镇%'
     and  jz not like '%高亭镇%'
     and  jz not like '%华埠镇%'
     and  jz not like '%灵溪镇%'
     and  jz not like '%昆阳镇%'
     and  jz not like '%罗阳镇%'
     and  jz not like '%大峃镇%'
     and  jz not like '%龙港镇%'
 )       then '1'
  when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  LENGTH(jz)-length(replace(jz,'镇','')) >1 and  (
         ( substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%熊山镇%'  and  jz_city ='350725' )---城关镇
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%双溪镇%'   and  jz_city ='350721' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%雪峰镇%'   and  jz_city ='350421' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%龙津镇%'   and  jz_city ='350423' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%杨舍镇%'   and  jz_city ='320582' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%玉山镇%'   and  jz_city ='320583' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%城厢镇%'   and  jz_city ='320585' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%城关镇%'  and  jz_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%首善镇%'  and  jz_city ='610326' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%高亭镇%'  and  jz_city='330921' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%华埠镇%'  and  jz_city='330824' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%灵溪镇%'  and  jz_city='330327' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%昆阳镇%'  and  jz_city='330326' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%罗阳镇%'  and  jz_city='330329' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%大峃镇%'  and  jz_city='330328' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%龙港镇%'  and  jz_city ='330383' )
 ) AND jz LIKE '%村%' AND jz not LIKE '%新村%' then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  LENGTH(jz)-length(replace(jz,'镇','')) >1 and  (
         ( substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%熊山镇%'  and  jz_city <>'350725' )---城关镇
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%双溪镇%'   and  jz_city <>'350721' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%雪峰镇%'   and  jz_city <>'350421' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%龙津镇%'   and  jz_city <>'350423' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%杨舍镇%'   and  jz_city <>'320582' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%玉山镇%'   and  jz_city <>'320583' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%城厢镇%'   and  jz_city <>'320585' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%城关镇%'  and  jz_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%首善镇%'  and  jz_city <>'610326' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%高亭镇%'  and  jz_city <>'330921' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%华埠镇%'  and  jz_city <> '330824' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%灵溪镇%'  and  jz_city <> '330327' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%昆阳镇%'  and  jz_city <>'330326' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%罗阳镇%'  and  jz_city <>'330329' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%大峃镇%'  and  jz_city <>'330328' )
     OR  (substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1))  like '%龙港镇%'  and  jz_city <>'330383' )
 )  then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  LENGTH(jz)-length(replace(jz,'镇','')) >1 and  (
          substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%熊山镇%'   ---城关镇
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%双溪镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%雪峰镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%龙津镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%杨舍镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%玉山镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%城厢镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%城关镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%首善镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%高亭镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%华埠镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%灵溪镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%昆阳镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%罗阳镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%大峃镇%'
     and  substr(jz,instr(jz,'镇',-2),instr(jz,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when (nvl(jz_fourthaddress,'')='' or substr(jz_fourthaddress,7,6) ='999999' ) and  jz like '%村%' and jz not like '%新村%'  then '1'
    else '0' end  is_jz
    ,bg
  ,CASE
   WHEN NVL(bg_fourthaddress,'')<>'' and substr(bg_fourthaddress,7,6) <> '999999'  AND NVL(bg_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(bg_fourthaddress,'')<>'' and substr(bg_fourthaddress,7,6) <> '999999' AND NVL(bg_name,'') LIKE '%镇'
        AND ( ( NVL(bg_name,'')  LIKE '%熊山镇'   AND bg_city ='350725' )---城关镇
           OR ( NVL(bg_name,'')  LIKE '%双溪镇'  AND  bg_city ='350721' )
           OR ( NVL(bg_name,'')  LIKE '%雪峰镇'  AND  bg_city ='350421' )
           OR ( NVL(bg_name,'')  LIKE '%龙津镇'  AND  bg_city ='350423' )
           OR ( NVL(bg_name,'')  LIKE '%杨舍镇'  AND  bg_city ='320582' )
           OR ( NVL(bg_name,'')  LIKE '%玉山镇'  AND  bg_city ='320583' )
           OR ( NVL(bg_name,'')  LIKE '%城厢镇'  AND  bg_city ='320585' )
           OR ( NVL(bg_name,'')  LIKE '%城关镇'  AND  bg_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(bg_name,'')  LIKE '%首善镇'  AND  bg_city ='610326' )
           OR ( NVL(bg_name,'')  LIKE '%高亭镇'  AND  bg_city ='330921' )
           OR ( NVL(bg_name,'')  LIKE '%华埠镇'  AND  bg_city ='330824' )
           OR ( NVL(bg_name,'')  LIKE '%灵溪镇'  AND  bg_city ='330327' )
           OR ( NVL(bg_name,'')  LIKE '%昆阳镇'  AND  bg_city ='330326' )
           OR ( NVL(bg_name,'')  LIKE '%罗阳镇'  AND  bg_city ='330329' )
           OR ( NVL(bg_name,'')  LIKE '%大峃镇'  AND  bg_city ='330328' )
           OR ( NVL(bg_name,'')  LIKE '%龙港镇'  AND  bg_city ='330383' ))
       AND NVL(bg,'')  LIKE '%村%'  AND NVL(bg,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(bg_fourthaddress,'') <>'' and substr(bg_fourthaddress,7,6) <> '999999' AND  NVL(bg_name,'') LIKE '%镇'
        AND (  NVL(bg_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(bg_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(bg_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(bg_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(bg_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(bg_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(bg_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(bg_name,'')  NOT LIKE '%城关镇'
           AND  NVL(bg_name,'')  NOT LIKE '%首善镇'
           AND  NVL(bg_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(bg_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(bg_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(bg_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(bg_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(bg_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(bg_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(bg_fourthaddress,'')<>'' and substr(bg_fourthaddress,7,6) <> '999999' AND NVL(bg_name,'') LIKE '%镇'
        AND ((NVL(bg_name,'')   LIKE '%熊山镇'   AND  bg_city  <> '350725' )---城关镇
           OR ( NVL(bg_name,'')   LIKE '%双溪镇'  AND  bg_city <>'350721' )
           OR ( NVL(bg_name,'')   LIKE '%雪峰镇'  AND  bg_city <>'350421' )
           OR ( NVL(bg_name,'')   LIKE '%龙津镇'  AND  bg_city <>'350423' )
           OR ( NVL(bg_name,'')   LIKE '%杨舍镇'  AND  bg_city <>'320582' )
           OR ( NVL(bg_name,'')   LIKE '%玉山镇'  AND  bg_city <>'320583' )
           OR ( NVL(bg_name,'')   LIKE '%城厢镇'  AND  bg_city <>'320585' )
           OR ( NVL(bg_name,'')   LIKE '%城关镇'  AND  bg_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(bg_name,'')   LIKE '%首善镇'  AND  bg_city <>'610326' )
           OR ( NVL(bg_name,'')   LIKE '%高亭镇'  AND  bg_city <>'330921' )
           OR ( NVL(bg_name,'')   LIKE '%华埠镇'  AND  bg_city <>'330824' )
           OR ( NVL(bg_name,'')   LIKE '%灵溪镇'  AND  bg_city <>'330327' )
           OR ( NVL(bg_name,'')   LIKE '%昆阳镇'  AND  bg_city <>'330326' )
           OR ( NVL(bg_name,'')   LIKE '%罗阳镇'  AND  bg_city <>'330329' )
           OR ( NVL(bg_name,'')   LIKE '%大峃镇'  AND  bg_city <>'330328' )
           OR ( NVL(bg_name,'')   LIKE '%龙港镇'  AND  bg_city <>'330383' ))
        THEN  '1'
WHEN NVL(bg_fourthaddress,'')<>'' and substr(bg_fourthaddress,7,6) <> '999999' AND NVL(bg,'')  LIKE '%村%'  AND NVL(bg,'') not LIKE '%新村%'  THEN  '1'
   when  ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND LENGTH(bg)-length(replace(bg,'乡','')) =1 and (
          bg not like '%肥乡区%'
     and  bg not like '%柏乡县%'
     and  bg not like '%平乡县%'
     and  bg not like '%武乡县%'
     and  bg not like '%乡宁县%'
     and  bg not like '%桐乡市%'
     and  bg not like '%萍乡市%'
     and  bg not like '%东乡区%'
     and  bg not like '%金乡县%'
     and  bg not like '%新乡市%'
     and  bg not like '%新乡县%'
     and  bg not like '%内乡县%'
     and  bg not like '%宁乡市%'
     and  bg not like '%湘乡市%'
     and  bg not like '%安乡县%'
     and  bg not like '%西乡塘区%'
     and  bg not like '%乡城县%'
     and  bg not like '%西乡县%'
     and  bg not like '%东乡族自治县%'
     and  bg not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND LENGTH(bg)-length(replace(bg,'乡','')) >1 then '1'
 when  ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND LENGTH(bg)-length(replace(bg,'镇','')) =1  and
 (
          bg  like '%天镇县%'
     OR  bg  like '%丰镇市%'
     OR  bg  like '%北镇市%'
     OR  bg  like '%镇赉县%'
     OR  bg  like '%镇江市%'
     OR  bg  like '%镇海区%'
     OR  bg  like '%固镇县%'
     OR  bg  like '%景德镇市%'
     OR  bg  like '%镇平县%'
     OR  bg  like '%清镇市%'
     OR  bg  like '%镇宁布依族苗族自治县%'
     OR  bg  like '%镇远县%'
     OR  bg  like '%镇雄县%'
     OR  bg  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  bg  like '%镇康县%'
     OR  bg  like '%镇巴县%'
     OR  bg  like '%镇坪县%'
     OR  bg  like '%镇安县%'
     OR  bg  like '%镇原县%'   ---区县
     OR  (bg  like '%熊山镇%'  and  bg_city ='350725' )---城关镇
     OR  (bg  like '%双溪镇%'  and  bg_city ='350721' )
     OR  (bg  like '%雪峰镇%'  and  bg_city ='350421' )
     OR  (bg  like '%龙津镇%'  and  bg_city ='350423' )
     OR  (bg  like '%杨舍镇%'  and  bg_city ='320582' )
     OR  (bg  like '%玉山镇%'  and  bg_city ='320583' )
     OR  (bg  like '%城厢镇%'  and  bg_city ='320585' )
     OR  (bg  like '%城关镇%'  and  bg_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (bg  like '%首善镇%'  and  bg_city ='610326' )
     OR  (bg  like '%高亭镇%'  and  bg_city ='330921' )
     OR  (bg  like '%华埠镇%'  and  bg_city ='330824' )
     OR  (bg  like '%灵溪镇%'  and  bg_city ='330327' )
     OR  (bg  like '%昆阳镇%'  and  bg_city ='330326' )
     OR  (bg  like '%罗阳镇%'  and  bg_city ='330329' )
     OR  (bg  like '%大峃镇%'  and  bg_city ='330328' )
     OR  (bg  like '%龙港镇%'  and  bg_city ='330383' )
 )   and bg like '%村%' and bg not like '%新村%'  then '1'
 when ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) and  LENGTH(bg)-length(replace(bg,'镇','')) =1  and
(
   (      bg  like '%熊山镇%'   and bg_city  <>'350725' )---城关镇
     OR ( bg  like '%双溪镇%'  and  bg_city  <>'350721' )
     OR ( bg  like '%雪峰镇%'  and  bg_city <>'350421' )
     OR ( bg  like '%龙津镇%'  and  bg_city <>'350423' )
     OR ( bg  like '%杨舍镇%'  and  bg_city <>'320582' )
     OR ( bg  like '%玉山镇%'  and  bg_city <>'320583' )
     OR ( bg  like '%城厢镇%'  and  bg_city <>'320585' )
     OR ( bg  like '%城关镇%'  and  bg_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( bg  like '%首善镇%'  and  bg_city <> '610326' )
     OR ( bg  like '%高亭镇%'  and  bg_city <>'330921' )
     OR ( bg  like '%华埠镇%'  and  bg_city <>'330824' )
     OR ( bg  like '%灵溪镇%'  and  bg_city <>'330327' )
     OR ( bg  like '%昆阳镇%'  and  bg_city <>'330326' )
     OR ( bg  like '%罗阳镇%'  and  bg_city <>'330329' )
     OR ( bg  like '%大峃镇%'  and  bg_city <>'330328' )
     OR ( bg  like '%龙港镇%'  and  bg_city <>'330383' )
	 ) then '1'
 when  ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND LENGTH(bg)-length(replace(bg,'镇','')) =1  and
 (
          bg not like '%天镇县%'
     and  bg not like '%丰镇市%'
     and  bg not like '%北镇市%'
     and  bg not like '%镇赉县%'
     and  bg not like '%镇江市%'
     and  bg not like '%镇海区%'
     and  bg not like '%固镇县%'
     and  bg not like '%景德镇市%'
     and  bg not like '%镇平县%'
     and  bg not like '%清镇市%'
     and  bg not like '%镇宁布依族苗族自治县%'
     and  bg not like '%镇远县%'
     and  bg not like '%镇雄县%'
     and  bg not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  bg not like '%镇康县%'
     and  bg not like '%镇巴县%'
     and  bg not like '%镇坪县%'
     and  bg not like '%镇安县%'
     and  bg not like '%镇原县%'
)
and ( bg not like '%熊山镇%'     ---城关镇
     and  bg not like '%双溪镇%'
     and  bg not like '%雪峰镇%'
     and  bg not like '%龙津镇%'
     and  bg not like '%杨舍镇%'
     and  bg not like '%玉山镇%'
     and  bg not like '%城厢镇%'
     and  bg not like '%城关镇%'
     and  bg not like '%首善镇%'
     and  bg not like '%高亭镇%'
     and  bg not like '%华埠镇%'
     and  bg not like '%灵溪镇%'
     and  bg not like '%昆阳镇%'
     and  bg not like '%罗阳镇%'
     and  bg not like '%大峃镇%'
     and  bg not like '%龙港镇%'
 )   then '1'
  when  ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND LENGTH(bg)-length(replace(bg,'镇','')) >1 and  (
         ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%熊山镇%' and  bg_city ='350725' )---城关镇
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%双溪镇%'  and  bg_city ='350721' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%雪峰镇%'  and  bg_city ='350421' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%龙津镇%'  and  bg_city ='350423' )
     OR (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%杨舍镇%'   and  bg_city ='320582' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%玉山镇%'  and  bg_city ='320583' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%城厢镇%'  and  bg_city ='320585' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%城关镇%'  and  bg_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%首善镇%'  and  bg_city ='610326' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%高亭镇%'  and  bg_city ='330921' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%华埠镇%'  and  bg_city ='330824' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%灵溪镇%'  and  bg_city ='330327' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%昆阳镇%'  and  bg_city ='330326' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%罗阳镇%'  and  bg_city ='330329' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%大峃镇%'  and  bg_city ='330328' )
     OR ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%龙港镇%'  and  bg_city ='330383' )
 ) AND bg LIKE '%村%' AND bg not LIKE '%新村%' then '1'
 when ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) and  LENGTH(bg)-length(replace(bg,'镇','')) >1 and  (
         ( substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%熊山镇%'  and  bg_city <>'350725' )---城关镇
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%双溪镇%'   and  bg_city <>'350721' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%雪峰镇%'   and  bg_city <>'350421' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%龙津镇%'   and  bg_city <>'350423' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%杨舍镇%'   and  bg_city <>'320582' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%玉山镇%'   and  bg_city <>'320583' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%城厢镇%'   and  bg_city <>'320585' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%城关镇%'  and  bg_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%首善镇%'  and  bg_city <>'610326' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%高亭镇%'  and  bg_city <>'330921' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%华埠镇%'  and  bg_city <> '330824' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%灵溪镇%'  and  bg_city <> '330327' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%昆阳镇%'  and  bg_city <>'330326' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%罗阳镇%'  and  bg_city <>'330329' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%大峃镇%'  and  bg_city <>'330328' )
     OR  (substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1))  like '%龙港镇%'  and  bg_city <>'330383' )
 )  then '1'
 when  ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND LENGTH(bg)-length(replace(bg,'镇','')) >1 and  (
          substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%熊山镇%' ---城关镇
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%双溪镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%雪峰镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%龙津镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%杨舍镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%玉山镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%城厢镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%城关镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%首善镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%高亭镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%华埠镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%灵溪镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%昆阳镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%罗阳镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%大峃镇%'
     and  substr(bg,instr(bg,'镇',-2),instr(bg,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when  ( NVL(bg_fourthaddress,'')='' or substr(bg_fourthaddress,7,6) = '999999' ) AND bg like '%村%' and bg not like '%新村%'  then '1'
    else '0' end  is_bg
    ,hj
    ,CASE
     WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj_name,'') LIKE '%镇'
        AND ( ( NVL(hj_name,'')  LIKE '%熊山镇'   AND hj_city ='350725' )---城关镇
           OR ( NVL(hj_name,'')  LIKE '%双溪镇'  AND  hj_city ='350721' )
           OR ( NVL(hj_name,'')  LIKE '%雪峰镇'  AND  hj_city ='350421' )
           OR ( NVL(hj_name,'')  LIKE '%龙津镇'  AND  hj_city ='350423' )
           OR ( NVL(hj_name,'')  LIKE '%杨舍镇'  AND  hj_city ='320582' )
           OR ( NVL(hj_name,'')  LIKE '%玉山镇'  AND  hj_city ='320583' )
           OR ( NVL(hj_name,'')  LIKE '%城厢镇'  AND  hj_city ='320585' )
           OR ( NVL(hj_name,'')  LIKE '%城关镇'  AND  hj_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(hj_name,'')  LIKE '%首善镇'  AND  hj_city ='610326' )
           OR ( NVL(hj_name,'')  LIKE '%高亭镇'  AND  hj_city ='330921' )
           OR ( NVL(hj_name,'')  LIKE '%华埠镇'  AND  hj_city ='330824' )
           OR ( NVL(hj_name,'')  LIKE '%灵溪镇'  AND  hj_city ='330327' )
           OR ( NVL(hj_name,'')  LIKE '%昆阳镇'  AND  hj_city ='330326' )
           OR ( NVL(hj_name,'')  LIKE '%罗阳镇'  AND  hj_city ='330329' )
           OR ( NVL(hj_name,'')  LIKE '%大峃镇'  AND  hj_city ='330328' )
           OR ( NVL(hj_name,'')  LIKE '%龙港镇'  AND  hj_city ='330383' ))
       AND NVL(hj,'')  LIKE '%村%'  AND NVL(hj,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(hj_fourthaddress,'') <>''and  substr(hj_fourthaddress,7,6) <> '999999' AND  NVL(hj_name,'') LIKE '%镇'
        AND (  NVL(hj_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(hj_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(hj_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(hj_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(hj_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(hj_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(hj_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(hj_name,'')  NOT LIKE '%城关镇'
           AND  NVL(hj_name,'')  NOT LIKE '%首善镇'
           AND  NVL(hj_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(hj_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(hj_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(hj_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(hj_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(hj_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(hj_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj_name,'') LIKE '%镇'
        AND ((NVL(hj_name,'')   LIKE '%熊山镇'   AND  hj_city  <> '350725' )---城关镇
           OR ( NVL(hj_name,'')   LIKE '%双溪镇'  AND  hj_city <>'350721' )
           OR ( NVL(hj_name,'')   LIKE '%雪峰镇'  AND  hj_city <>'350421' )
           OR ( NVL(hj_name,'')   LIKE '%龙津镇'  AND  hj_city <>'350423' )
           OR ( NVL(hj_name,'')   LIKE '%杨舍镇'  AND  hj_city <>'320582' )
           OR ( NVL(hj_name,'')   LIKE '%玉山镇'  AND  hj_city <>'320583' )
           OR ( NVL(hj_name,'')   LIKE '%城厢镇'  AND  hj_city <>'320585' )
           OR ( NVL(hj_name,'')   LIKE '%城关镇'  AND  hj_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(hj_name,'')   LIKE '%首善镇'  AND  hj_city <>'610326' )
           OR ( NVL(hj_name,'')   LIKE '%高亭镇'  AND  hj_city <>'330921' )
           OR ( NVL(hj_name,'')   LIKE '%华埠镇'  AND  hj_city <>'330824' )
           OR ( NVL(hj_name,'')   LIKE '%灵溪镇'  AND  hj_city <>'330327' )
           OR ( NVL(hj_name,'')   LIKE '%昆阳镇'  AND  hj_city <>'330326' )
           OR ( NVL(hj_name,'')   LIKE '%罗阳镇'  AND  hj_city <>'330329' )
           OR ( NVL(hj_name,'')   LIKE '%大峃镇'  AND  hj_city <>'330328' )
           OR ( NVL(hj_name,'')   LIKE '%龙港镇'  AND  hj_city <>'330383' ))
        THEN  '1'
WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj,'')  LIKE '%村%'  AND NVL(hj,'') not LIKE '%新村%'  THEN  '1'
     when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'乡','')) =1 and (
          hj not like '%肥乡区%'
     and  hj not like '%柏乡县%'
     and  hj not like '%平乡县%'
     and  hj not like '%武乡县%'
     and  hj not like '%乡宁县%'
     and  hj not like '%桐乡市%'
     and  hj not like '%萍乡市%'
     and  hj not like '%东乡区%'
     and  hj not like '%金乡县%'
     and  hj not like '%新乡市%'
     and  hj not like '%新乡县%'
     and  hj not like '%内乡县%'
     and  hj not like '%宁乡市%'
     and  hj not like '%湘乡市%'
     and  hj not like '%安乡县%'
     and  hj not like '%西乡塘区%'
     and  hj not like '%乡城县%'
     and  hj not like '%西乡县%'
     and  hj not like '%东乡族自治县%'
     and  hj not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'乡',''))>1 then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) =1  and
 (
          hj  like '%天镇县%'
     OR  hj  like '%丰镇市%'
     OR  hj  like '%北镇市%'
     OR  hj  like '%镇赉县%'
     OR  hj  like '%镇江市%'
     OR  hj  like '%镇海区%'
     OR  hj  like '%固镇县%'
     OR  hj  like '%景德镇市%'
     OR  hj  like '%镇平县%'
     OR  hj  like '%清镇市%'
     OR  hj  like '%镇宁布依族苗族自治县%'
     OR  hj  like '%镇远县%'
     OR  hj  like '%镇雄县%'
     OR  hj  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  hj  like '%镇康县%'
     OR  hj  like '%镇巴县%'
     OR  hj  like '%镇坪县%'
     OR  hj  like '%镇安县%'
     OR  hj  like '%镇原县%'   ---区县
     OR ( hj  like '%熊山镇%'  and  hj_city ='350725' )---城关镇
     OR ( hj  like '%双溪镇%'  and  hj_city ='350721' )
     OR ( hj  like '%雪峰镇%'  and  hj_city ='350421' )
     OR ( hj  like '%龙津镇%'  and  hj_city ='350423' )
     OR ( hj  like '%杨舍镇%'  and  hj_city ='320582' )
     OR ( hj  like '%玉山镇%'  and  hj_city ='320583' )
     OR ( hj  like '%城厢镇%'  and  hj_city ='320585' )
     OR ( hj  like '%城关镇%'  and  hj_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( hj  like '%首善镇%'  and  hj_city ='610326' )
     OR ( hj  like '%高亭镇%'  and  hj_city ='330921' )
     OR ( hj  like '%华埠镇%'  and  hj_city ='330824' )
     OR ( hj  like '%灵溪镇%'  and  hj_city ='330327' )
     OR ( hj  like '%昆阳镇%'  and  hj_city ='330326' )
     OR ( hj  like '%罗阳镇%'  and  hj_city ='330329' )
     OR ( hj  like '%大峃镇%'  and  hj_city ='330328' )
     OR ( hj  like '%龙港镇%'  and  hj_city ='330383' )
 )   and hj like '%村%' and hj not like '%新村%'  then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) and  LENGTH(hj)-length(replace(hj,'镇','')) =1  and
(

   (      hj  like '%熊山镇%'   and hj_city  <>'350725' )---城关镇
     OR ( hj  like '%双溪镇%'  and  hj_city  <>'350721' )
     OR ( hj  like '%雪峰镇%'  and  hj_city <>'350421' )
     OR ( hj  like '%龙津镇%'  and  hj_city <>'350423' )
     OR ( hj  like '%杨舍镇%'  and  hj_city <>'320582' )
     OR ( hj  like '%玉山镇%'  and  hj_city <>'320583' )
     OR ( hj  like '%城厢镇%'  and  hj_city <>'320585' )
     OR ( hj  like '%城关镇%'  and  hj_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( hj  like '%首善镇%'  and  hj_city <> '610326' )
     OR ( hj  like '%高亭镇%'  and  hj_city <>'330921' )
     OR ( hj  like '%华埠镇%'  and  hj_city <>'330824' )
     OR ( hj  like '%灵溪镇%'  and  hj_city <>'330327' )
     OR ( hj  like '%昆阳镇%'  and  hj_city <>'330326' )
     OR ( hj  like '%罗阳镇%'  and  hj_city <>'330329' )
     OR ( hj  like '%大峃镇%'  and  hj_city <>'330328' )
     OR ( hj  like '%龙港镇%'  and  hj_city <>'330383' )

	 ) then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) =1  and
 (
          hj not like '%天镇县%'
     and  hj not like '%丰镇市%'
     and  hj not like '%北镇市%'
     and  hj not like '%镇赉县%'
     and  hj not like '%镇江市%'
     and  hj not like '%镇海区%'
     and  hj not like '%固镇县%'
     and  hj not like '%景德镇市%'
     and  hj not like '%镇平县%'
     and  hj not like '%清镇市%'
     and  hj not like '%镇宁布依族苗族自治县%'
     and  hj not like '%镇远县%'
     and  hj not like '%镇雄县%'
     and  hj not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  hj not like '%镇康县%'
     and  hj not like '%镇巴县%'
     and  hj not like '%镇坪县%'
     and  hj not like '%镇安县%'
     and  hj not like '%镇原县%'
)
and ( hj not like '%熊山镇%'
     and  hj not like '%双溪镇%'
     and  hj not like '%雪峰镇%'
     and  hj not like '%龙津镇%'
     and  hj not like '%杨舍镇%'
     and  hj not like '%玉山镇%'
     and  hj not like '%城厢镇%'
     and  hj not like '%城关镇%'
     and  hj not like '%首善镇%'
     and  hj not like '%高亭镇%'
     and  hj not like '%华埠镇%'
     and  hj not like '%灵溪镇%'
     and  hj not like '%昆阳镇%'
     and  hj not like '%罗阳镇%'
     and  hj not like '%大峃镇%'
     and  hj not like '%龙港镇%'
 )   then '1'
  when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) >1 and  (
         ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%熊山镇%' and  hj_city ='350725' )---城关镇
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%双溪镇%'  and  hj_city ='350721' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%雪峰镇%'  and  hj_city ='350421' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙津镇%'  and  hj_city ='350423' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%杨舍镇%'  and  hj_city ='320582' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%玉山镇%'  and  hj_city ='320583' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城厢镇%'  and  hj_city ='320585' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城关镇%'  and  hj_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%首善镇%'  and  hj_city ='610326' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%高亭镇%'  and  hj_city ='330921' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%华埠镇%'  and  hj_city ='330824' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%灵溪镇%'  and  hj_city ='330327' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%昆阳镇%'  and  hj_city ='330326' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%罗阳镇%'  and  hj_city ='330329' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%大峃镇%'  and  hj_city ='330328' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙港镇%'  and  hj_city ='330383' )
 ) AND hj LIKE '%村%' AND hj not LIKE '%新村%' then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) and  LENGTH(hj)-length(replace(hj,'镇','')) >1 and  (
         ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%熊山镇%'  and  hj_city <>'350725' )---城关镇
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%双溪镇%'   and  hj_city <>'350721' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%雪峰镇%'   and  hj_city <>'350421' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙津镇%'   and  hj_city <>'350423' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%杨舍镇%'   and  hj_city <>'320582' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%玉山镇%'   and  hj_city <>'320583' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城厢镇%'   and  hj_city <>'320585' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城关镇%'  and  hj_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%首善镇%'  and  hj_city <>'610326' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%高亭镇%'  and  hj_city <>'330921' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%华埠镇%'  and  hj_city <> '330824' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%灵溪镇%'  and  hj_city <> '330327' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%昆阳镇%'  and  hj_city <>'330326' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%罗阳镇%'  and  hj_city <>'330329' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%大峃镇%'  and  hj_city <>'330328' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙港镇%'  and  hj_city <>'330383' )
 )  then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) >1 and  (
          substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%熊山镇%' ---城关镇
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%双溪镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%雪峰镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%龙津镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%杨舍镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%玉山镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%城厢镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%城关镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%首善镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%高亭镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%华埠镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%灵溪镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%昆阳镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%罗阳镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%大峃镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND hj like '%村%' and hj not like '%新村%'  then '1'
    else '0' end  is_hj
    ,zc
  ,CASE
   WHEN NVL(zc_fourthaddress,'')<>''  and   substr(zc_fourthaddress,7,6) <>'999999'  AND NVL(zc_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(zc_fourthaddress,'')<>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND NVL(zc_name,'') LIKE '%镇'
        AND ( ( NVL(zc_name,'')  LIKE '%熊山镇'   AND zc_city ='350725' )---城关镇
           OR ( NVL(zc_name,'')  LIKE '%双溪镇'  AND  zc_city ='350721' )
           OR ( NVL(zc_name,'')  LIKE '%雪峰镇'  AND  zc_city ='350421' )
           OR ( NVL(zc_name,'')  LIKE '%龙津镇'  AND  zc_city ='350423' )
           OR ( NVL(zc_name,'')  LIKE '%杨舍镇'  AND  zc_city ='320582' )
           OR ( NVL(zc_name,'')  LIKE '%玉山镇'  AND  zc_city ='320583' )
           OR ( NVL(zc_name,'')  LIKE '%城厢镇'  AND  zc_city ='320585' )
           OR ( NVL(zc_name,'')  LIKE '%城关镇'  AND  zc_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(zc_name,'')  LIKE '%首善镇'  AND  zc_city ='610326' )
           OR ( NVL(zc_name,'')  LIKE '%高亭镇'  AND  zc_city ='330921' )
           OR ( NVL(zc_name,'')  LIKE '%华埠镇'  AND  zc_city ='330824' )
           OR ( NVL(zc_name,'')  LIKE '%灵溪镇'  AND  zc_city ='330327' )
           OR ( NVL(zc_name,'')  LIKE '%昆阳镇'  AND  zc_city ='330326' )
           OR ( NVL(zc_name,'')  LIKE '%罗阳镇'  AND  zc_city ='330329' )
           OR ( NVL(zc_name,'')  LIKE '%大峃镇'  AND  zc_city ='330328' )
           OR ( NVL(zc_name,'')  LIKE '%龙港镇'  AND  zc_city ='330383' ))
       AND NVL(zc,'')  LIKE '%村%'  AND NVL(zc,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(zc_fourthaddress,'') <>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND  NVL(zc_name,'') LIKE '%镇'
        AND (  NVL(zc_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(zc_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(zc_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(zc_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(zc_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(zc_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(zc_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(zc_name,'')  NOT LIKE '%城关镇'
           AND  NVL(zc_name,'')  NOT LIKE '%首善镇'
           AND  NVL(zc_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(zc_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(zc_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(zc_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(zc_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(zc_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(zc_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(zc_fourthaddress,'')<>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND NVL(zc_name,'') LIKE '%镇'
        AND ((NVL(zc_name,'')   LIKE '%熊山镇'   AND  zc_city  <> '350725' )---城关镇
           OR ( NVL(zc_name,'')   LIKE '%双溪镇'  AND  zc_city <>'350721' )
           OR ( NVL(zc_name,'')   LIKE '%雪峰镇'  AND  zc_city <>'350421' )
           OR ( NVL(zc_name,'')   LIKE '%龙津镇'  AND  zc_city <>'350423' )
           OR ( NVL(zc_name,'')   LIKE '%杨舍镇'  AND  zc_city <>'320582' )
           OR ( NVL(zc_name,'')   LIKE '%玉山镇'  AND  zc_city <>'320583' )
           OR ( NVL(zc_name,'')   LIKE '%城厢镇'  AND  zc_city <>'320585' )
           OR ( NVL(zc_name,'')   LIKE '%城关镇'  AND  zc_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(zc_name,'')   LIKE '%首善镇'  AND  zc_city <>'610326' )
           OR ( NVL(zc_name,'')   LIKE '%高亭镇'  AND  zc_city <>'330921' )
           OR ( NVL(zc_name,'')   LIKE '%华埠镇'  AND  zc_city <>'330824' )
           OR ( NVL(zc_name,'')   LIKE '%灵溪镇'  AND  zc_city <>'330327' )
           OR ( NVL(zc_name,'')   LIKE '%昆阳镇'  AND  zc_city <>'330326' )
           OR ( NVL(zc_name,'')   LIKE '%罗阳镇'  AND  zc_city <>'330329' )
           OR ( NVL(zc_name,'')   LIKE '%大峃镇'  AND  zc_city <>'330328' )
           OR ( NVL(zc_name,'')   LIKE '%龙港镇'  AND  zc_city <>'330383' ))
        THEN  '1'
WHEN NVL(zc_fourthaddress,'')<>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND NVL(zc,'')  LIKE '%村%'  AND NVL(zc,'') not LIKE '%新村%'  THEN  '1'
  when NVL(zc_fourthaddress,'')='' and   substr(zc_fourthaddress,7,6) <>'999999' AND LENGTH(zc)-length(replace(zc,'乡','')) =1 and (
          zc not like '%肥乡区%'
     and  zc not like '%柏乡县%'
     and  zc not like '%平乡县%'
     and  zc not like '%武乡县%'
     and  zc not like '%乡宁县%'
     and  zc not like '%桐乡市%'
     and  zc not like '%萍乡市%'
     and  zc not like '%东乡区%'
     and  zc not like '%金乡县%'
     and  zc not like '%新乡市%'
     and  zc not like '%新乡县%'
     and  zc not like '%内乡县%'
     and  zc not like '%宁乡市%'
     and  zc not like '%湘乡市%'
     and  zc not like '%安乡县%'
     and  zc not like '%西乡塘区%'
     and  zc not like '%乡城县%'
     and  zc not like '%西乡县%'
     and  zc not like '%东乡族自治县%'
     and  zc not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999') and LENGTH(zc)-length(replace(zc,'乡','')) >1 then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) =1  and
 (
          zc  like '%天镇县%'
     OR  zc  like '%丰镇市%'
     OR  zc  like '%北镇市%'
     OR  zc  like '%镇赉县%'
     OR  zc  like '%镇江市%'
     OR  zc  like '%镇海区%'
     OR  zc  like '%固镇县%'
     OR  zc  like '%景德镇市%'
     OR  zc  like '%镇平县%'
     OR  zc  like '%清镇市%'
     OR  zc  like '%镇宁布依族苗族自治县%'
     OR  zc  like '%镇远县%'
     OR  zc  like '%镇雄县%'
     OR  zc  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  zc  like '%镇康县%'
     OR  zc  like '%镇巴县%'
     OR  zc  like '%镇坪县%'
     OR  zc  like '%镇安县%'
     OR  zc  like '%镇原县%'   ---区县
     OR (zc  like '%熊山镇%'    and  zc_city ='350725' )---城关镇
     OR ( zc  like '%双溪镇%'   and  zc_city ='350721' )
     OR ( zc  like '%雪峰镇%'   and  zc_city ='350421' )
     OR ( zc  like '%龙津镇%'   and  zc_city ='350423' )
     OR ( zc  like '%杨舍镇%'   and  zc_city ='320582' )
     OR ( zc  like '%玉山镇%'   and  zc_city ='320583' )
     OR ( zc  like '%城厢镇%'   and  zc_city ='320585' )
     OR ( zc  like '%城关镇%'   and  zc_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( zc  like '%首善镇%'   and  zc_city ='610326' )
     OR ( zc  like '%高亭镇%'   and  zc_city ='330921' )
     OR ( zc  like '%华埠镇%'   and  zc_city ='330824' )
     OR ( zc  like '%灵溪镇%'   and  zc_city ='330327' )
     OR ( zc  like '%昆阳镇%'   and  zc_city ='330326' )
     OR ( zc  like '%罗阳镇%'   and  zc_city ='330329' )
     OR ( zc  like '%大峃镇%'   and  zc_city ='330328' )
     OR ( zc  like '%龙港镇%'   and  zc_city ='330383' )
 )   and zc like '%村%' and zc not like '%新村%'  then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and  LENGTH(zc)-length(replace(zc,'镇','')) =1  and
(

   (      zc  like '%熊山镇%'   and zc_city  <>'350725' )---城关镇
     OR ( zc  like '%双溪镇%'  and  zc_city  <>'350721' )
     OR ( zc  like '%雪峰镇%'  and  zc_city <>'350421' )
     OR ( zc  like '%龙津镇%'  and  zc_city <>'350423' )
     OR ( zc  like '%杨舍镇%'  and  zc_city <>'320582' )
     OR ( zc  like '%玉山镇%'  and  zc_city <>'320583' )
     OR ( zc  like '%城厢镇%'  and  zc_city <>'320585' )
     OR ( zc  like '%城关镇%'  and  zc_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( zc  like '%首善镇%'  and  zc_city <> '610326' )
     OR ( zc  like '%高亭镇%'  and  zc_city <>'330921' )
     OR ( zc  like '%华埠镇%'  and  zc_city <>'330824' )
     OR ( zc  like '%灵溪镇%'  and  zc_city <>'330327' )
     OR ( zc  like '%昆阳镇%'  and  zc_city <>'330326' )
     OR ( zc  like '%罗阳镇%'  and  zc_city <>'330329' )
     OR ( zc  like '%大峃镇%'  and  zc_city <>'330328' )
     OR ( zc  like '%龙港镇%'  and  zc_city <>'330383' )

	 ) then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) =1  and
 (
          zc not like '%天镇县%'
     and  zc not like '%丰镇市%'
     and  zc not like '%北镇市%'
     and  zc not like '%镇赉县%'
     and  zc not like '%镇江市%'
     and  zc not like '%镇海区%'
     and  zc not like '%固镇县%'
     and  zc not like '%景德镇市%'
     and  zc not like '%镇平县%'
     and  zc not like '%清镇市%'
     and  zc not like '%镇宁布依族苗族自治县%'
     and  zc not like '%镇远县%'
     and  zc not like '%镇雄县%'
     and  zc not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  zc not like '%镇康县%'
     and  zc not like '%镇巴县%'
     and  zc not like '%镇坪县%'
     and  zc not like '%镇安县%'
     and  zc not like '%镇原县%'
)
and ( zc not like '%熊山镇%'
     and  zc not like '%双溪镇%'
     and  zc not like '%雪峰镇%'
     and  zc not like '%龙津镇%'
     and  zc not like '%杨舍镇%'
     and  zc not like '%玉山镇%'
     and  zc not like '%城厢镇%'
     and  zc not like '%城关镇%'
     and  zc not like '%首善镇%'
     and  zc not like '%高亭镇%'
     and  zc not like '%华埠镇%'
     and  zc not like '%灵溪镇%'
     and  zc not like '%昆阳镇%'
     and  zc not like '%罗阳镇%'
     and  zc not like '%大峃镇%'
     and  zc not like '%龙港镇%'
 )  then '1'
  when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) >1 and  (
         ( substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%熊山镇%'  and  zc_city ='350725' )---城关镇
     OR  ( substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%双溪镇%'  and  zc_city ='350721' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%雪峰镇%'   and  zc_city ='350421' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙津镇%'   and  zc_city ='350423' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%杨舍镇%'   and  zc_city ='320582' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%玉山镇%'   and  zc_city ='320583' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城厢镇%'   and  zc_city ='320585' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城关镇%'   and  zc_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%首善镇%'   and  zc_city ='610326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%高亭镇%'   and  zc_city ='330921' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%华埠镇%'   and  zc_city ='330824' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%灵溪镇%'   and  zc_city ='330327' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%昆阳镇%'   and  zc_city ='330326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%罗阳镇%'   and  zc_city ='330329' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%大峃镇%'   and  zc_city ='330328' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙港镇%'   and  zc_city ='330383' )
 ) AND zc LIKE '%村%' AND zc not LIKE '%新村%' then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and  LENGTH(zc)-length(replace(zc,'镇','')) >1 and  (
         ( substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%熊山镇%'  and  zc_city <>'350725' )---城关镇
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%双溪镇%'   and  zc_city <>'350721' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%雪峰镇%'   and  zc_city <>'350421' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙津镇%'   and  zc_city <>'350423' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%杨舍镇%'   and  zc_city <>'320582' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%玉山镇%'   and  zc_city <>'320583' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城厢镇%'   and  zc_city <>'320585' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城关镇%'  and  zc_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%首善镇%'  and  zc_city <>'610326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%高亭镇%'  and  zc_city <>'330921' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%华埠镇%'  and  zc_city <> '330824' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%灵溪镇%'  and  zc_city <> '330327' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%昆阳镇%'  and  zc_city <>'330326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%罗阳镇%'  and  zc_city <>'330329' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%大峃镇%'  and  zc_city <>'330328' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙港镇%'  and  zc_city <>'330383' )
 )  then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) >1 and  (
          substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%熊山镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%双溪镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%雪峰镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%龙津镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%杨舍镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%玉山镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%城厢镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%城关镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%首善镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%高亭镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%华埠镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%灵溪镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%昆阳镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%罗阳镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%大峃镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and zc like '%村%' and zc not like '%新村%'  then '1'
    else '0' end  is_zc
 from tmp_wsj_lmj_dzxx_20211231 ;
**01-数据需求_总行计财_SJ20240705131_钦高霞_新信贷迁移前后利率.sql
-- 取数范围：单段的循环贷款、定价方式为系统定价，迁移前执行月利率不为空，大于0且不等于15的经营性贷款合同信息，合同状态为未终结。
-- 取数字段：合同号产品编号客户号  循环方式 发生日期到期日期终结日期合同金额合同余额利率选取方式（迁移前）执行月利率（迁移前）   利率选取方式（迁移后）  执行月利率（迁移后）
-- 取数时点：20240630.


-- 取数字段：合同号 产品编号 客户号 循环方式 发生日期 到期日期 终结日期 合同金额 合同余额 利率选取方式（迁移前）执行月利率（迁移前） 利率选取方式（迁移后）  执行月利率（迁移后）

SELECT T.serialno
       ,T.productcode
       ,T.customerid
       ,T.customername
       ,T.cycleflag
       ,T.occurdate
       ,T.enddate
       ,T.finishdate
       ,T.businesssum
       ,T.balance
       ,T.businessrate
       ,T.CYCLETYPE --单段的循环贷款

FROM edw.loan_business_contract T --
WHERE T.dt='20240630'
**01-数据需求_总行计财_SJ20240711116_郑城城_新采购系统中总行PO明细_1_6月_.sql
--SJ20240711116，新采购系统中总行PO明细(1-6月)

DROP TABLE if EXISTS  tmp_wsj_zcc_0630_01;
CREATE TABLE IF NOT EXISTS tmp_wsj_zcc_0630_01 as
select (case t1.bplx when 1 then '自行采购结果报批'when 2 then '框架物资采购结果报批' when 3 then '集中采购结果报批' when 4 then '框架合同签订结果报批' when 5 then '电子目录平台结果报批' end) 结果报批类型,
t1.bpbh 结果报批编号,
t1.bpmc 结果报批名称,
t1.jgbpje 结果报批金额,
(case t1.zt when 0 then '正常' when 1 then '变更中' when 2 then '变更审批' when 3 then '变更完成' when 4 then '已关闭' when 5 then '已退回' end) 状态,
t1.gbyy 关闭原因,
org.brc_org_nm 上级机构,
t1.zzid ,
t1.zzmc 汇报机构,
t1.bmid,
t1.bmmc 汇报部门,
t1.qcrmc 创建人,
substr(t1.cjsj,1,8) 创建时间,
t1.gysmc 中标供应商名称,
t5.ztdm  中标供应商编号,
t4.sqdbh 申请单编号,
t2.hh 行号,
t2.cgml 采购目录编码,
t2.cgmlmc 采购目录名称,
t2.wpytbh 物品用途编码,
t2.wpytmc 物品用途名称,
t2.bxlxbh 报销类型编号,
t2.bxlxmc 报销类型名称,
t2.yskmbh 预算科目编号,
t2.yskmmc 预算科目名称,
t2.ysxmbh 预算项目编号,
t2.ysxmmc 预算项目名称,
t2.dj 单价,
t2.cgsl 采购数量,
t2.ys 预算金额,
(case t4.zt when 0 then '初始化' when 3 then '已退回' when 5 then '审批中' when 10 then '审批完成' when -1 then '已终止' end) 申请单状态,
(case t2.xmzt when 0 then '待处理' when 1 then '部分处理' when 2 then '已处理' when 3 then '已完结' when 4 then '已关闭' end ) 明细行状态,
t2.yy 完结关闭原因 ,
t3.spmc 商品名称,
t3.ppmc 品牌,
t3.ggxh 规格型号,
t3.dj 采购单价,
t3.cgsl 数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1
inner join edw.epms_xm_jgbp_spxx t3
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'
inner join edw.epms_wt_sqdmx  t2
on  t3.sqdmx = t2.id and t2.dt='@@{yyyyMMdd}'
inner join edw.epms_wt_cgsqd  t4
on t2.sqdbh = t4.id  and t4.dt='@@{yyyyMMdd}'
left join edw.epms_jc_ztbzt t5
on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
and t1.CJSJ >'20231231235959'
AND t1.cjsj < '20240630000000'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and t1.bplx<>5
and t1.zzid='990000000'
order by t1.bpbh;




DROP TABLE if EXISTS  tmp_wsj_zcc_0630_02;
CREATE TABLE IF NOT EXISTS tmp_wsj_zcc_0630_02 as
select (case t1.bplx when 1 then '自行采购结果报批' when 2 then '框架物资采购结果报批' when 3 then '集中采购结果报批' when 4 then '框架合同签订结果报批' when 5 then '电子目录平台结果报批' end) 结果报批类型,
t1.bpbh 结果报批编号,
t1.bpmc 结果报批名称,
t1.jgbpje 结果报批金额,
 (case t1.zt when 0 then '正常' when 1 then '变更中' when 2 then '变更审批' when 3 then '变更完成' when 4 then '已关闭' when 5 then '已退回' end) 状态,
 t1.gbyy 关闭原因,
org.brc_org_nm 上级机构,
 t1.zzid ,
 t1.zzmc 汇报机构,
 t1.bmid,t1.bmmc 汇报部门,
 t1.qcrmc 创建人,
substr(t1.cjsj,1,8) 创建时间,
 t1.gysmc 中标供应商名称,
t5.ztdm  中标供应商编号,
t1.ywbh 申请单编号,
'' 行号,
t3.cgml 采购目录编码,
t3.cgmlmc 采购目录名称,
t3.wpytbh 物品用途编码,
t3.wpytmc 物品用途名称,
t3.bxlxbh 报销类型编号,
t3.bxlxmc 报销类型名称,
t3.yskmbh 预算科目编号,
t3.yskmmc 预算科目名称,
t3.ysxmbh 预算项目编号,
t3.ysxmmc 预算项目名称,
t3.dj 单价,
t3.cgsl 采购数量,
t3.cgje 预算金额,
(case  T12.status when 0 then '未审核' when 5 then '下单失败' when 10 then '审核中' when 15 then '已下单' when 20 then '供应商拒单' when 25 then '供应商已接收' when 30 then '供应商已发货' when 32 then '拒签收' when 35 then '已签收' when 45 then '已验收' when 50 then '已开票' when 55 then '已撤单' when 60 then '已支付' when -99 then '已删除'  end) 申请单状态,
'' 行明细状态,
'' 关闭完结原因,
t3.spmc 商品名称,
t3.ppmc 品牌,
t3.ggxh 规格型号,
t3.dj 采购单价,
t3.cgsl 数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
inner join edw.epms_xm_jgbp_spxx t3
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
left join edw.epms_jc_ztbzt t5
on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and bplx=5 and t1.zzid='990000000'
and t1.CJSJ >'20231231235959'
AND t1.cjsj < '20240630000000'
order by t1.bpbh
;

-- SELECT * from tmp_wsj_zcc_0630_02;
**01-数据需求_总行计财_SJ2024071111_叶峰_用于配合公安协查银盛支付服务股份有限公司与我行2017年交易明细.sql
-- SJ2024071111
-- 用于配合公安协查银盛支付服务股份有限公司与我行2017年交易明细
-- 数据日期：2017年-2018年
-- 取数口径：查询我行内部账户贷方，对方账户名称包含&lsquo;银盛&rsquo;的交易流水；及我刚基本户账户999999012350100000011贷方，对方账户名称包含&lsquo;银盛&rsquo;的交易流水

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sj2024071111_yinsheng_ls_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_sj2024071111_yinsheng_ls_01 AS
SELECT
    lgp_id                 AS  法人编号
    ,trx_srl               AS  交易流水
    ,trx_dt                AS  交易日期
    ,bok_entr_vch_seq_nbr  AS  记账凭证序号
    ,act_id                AS  账号
    ,trx_no                AS  交易码
    ,trx_org_id            AS  交易机构号
    ,act_org               AS  核算机构号
    ,ccy_cd                AS  货币代号
    ,crd_and_dbt_ind       AS  借贷标志
    ,bok_entr_amt          AS  记账金额
    ,bal_chr_cd            AS  余额性质代码
    ,bal_dir_cd            AS  余额方向代码
    ,act_bal               AS  账户余额
    ,dat_upd_ind           AS  数据更新标志
    ,act_bus_org_id        AS  账户营业机构号
    ,gl_ind                AS  入总账标志
    ,trx_tlr_id            AS  交易柜员号
    ,aut_tlr_id            AS  授权柜员号
    ,csh_ind               AS  现转标志
    ,txt_code              AS  摘要代码
    ,cnt_pty_act_id        AS  对方账号
    ,cnt_pty_act_nm        AS  对方账户名称
    ,smr_dscr              AS  摘要描述
    ,tms                   AS  时间戳
FROM edw.dwd_bus_act_int_act_trx_dtl_di   --内部账户交易明细
WHERE DT>='20170101'
AND  DT<='20181231'
AND  trx_dt>='20170101'
AND  trx_dt<='20181231'
AND  cnt_pty_act_nm	RLIKE '银盛'
AND  crd_and_dbt_ind='C' --贷
;

-- SELECT * FROM tmp_sj2024071111_yinsheng_ls_01;




DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sj2024071111_yinsheng_ls_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_sj2024071111_yinsheng_ls_02 AS
SELECT
       lgp_id                     AS 法人编号
    ,dep_act_id                AS 存款账号
    ,dtl_seq_nbr               AS 明细序号
    ,trx_dt                    AS 交易日期
    ,trx_tm                    AS 交易时间
    ,crd_and_dbt_ind           AS 借贷标志
    ,trx_ccy_cd                AS 交易币种代码
    ,act_cr_ind                AS 账户钞汇标志
    ,trx_amt                   AS 交易金额
    ,act_bal                   AS 账户余额
    ,cst_act_id                AS 客户账号
    ,sub_act_seq_nbr           AS 子账户序号
    ,part_rdrw_ind             AS 部提标志
    ,vch_cls_cd                AS 凭证种类代码
    ,vch_bch_nbr               AS 凭证批号
    ,vch_seq_nbr               AS 凭证序号
    ,txt_code                  AS 摘要代码
    ,smr_dscr                  AS 摘要描述
    ,trx_chnl_cd               AS 交易渠道代码
    ,ext_trx_no                AS 外部交易码
    ,int_trx_no                AS 内部交易码
    ,csh_ind                   AS 现转标志
    ,cnt_pty_cst_act_id        AS 对方客户账号
    ,cnt_pty_sub_act_seq_nbr   AS 对方子账户序号
    ,cnt_pty_sys_act_id        AS 对方系统账号
    ,cnt_pty_act_nm            AS 对方户名
    ,cnt_pty_cst_typ_cd        AS 对方客户类型代码
    ,cnt_pty_fin_instt_nm      AS 对方金融机构名称
    ,cnt_pty_fin_instt_typ_cd  AS 对方金融机构类型代码
    ,cnt_pty_fin_instt_cd      AS 对方金融机构代码
    ,agn_nm                    AS 代理人姓名
    ,agn_doc_typ_cd            AS 代理人证件类型代码
    ,agn_doc_nbr               AS 代理人证件号码
    ,agn_ntn_cd                AS 代理人国籍代码
    ,tlr_srl_nbr               AS 柜员流水号
    ,trx_bus_org               AS 交易营业机构
    ,opn_org                   AS 开户机构
    ,opr_tlr                   AS 操作柜员
    ,chk_tlr                   AS 复核柜员
    ,aut_tlr                   AS 授权柜员
    ,rvs_ind                   AS 冲正标志
    ,rvsd_ind                  AS 被冲正标志
    ,mtk_act_orig_dt           AS 错账原日期
    ,mtk_act_orig_tlr_srl_nbr  AS 错账原柜员流水号
    ,cmt                       AS 备注
    ,trx_trg_mth               AS 交易触发方式
    ,hst_dt                    AS 主机日期
    ,tms                       AS 时间戳
    ,act_nm                    AS 账户名称
    ,bal_fld_nm                AS 余额字段名称
    ,prod_id                   AS 产品编号
    ,bnk_bus_id                AS 银行业务编号
    ,mnt_tlr_id                AS 维护柜员编号
    ,crad_ind_cd               AS 卡标志代码
    ,agn_psn_tel               AS 代理人电话
    ,cst_act_typ_cd            AS 客户账户类型代码
    ,bus_now_trsf_ind          AS 业务现转标志
FROM edw.dwd_bus_dep_bal_chg_dtl_di  --存款账户余额发生明细
WHERE DT>='20170101'
AND  DT<='20181231'
AND  trx_dt>='20170101'
AND  trx_dt<='20181231'
AND  cst_act_id	='999999012350100000011'
-- AND  cnt_pty_act_nm	RLIKE '银盛'
AND  crd_and_dbt_ind='C'	 --贷
;
**01-数据需求_总行计财_SJ20240712161_瞿潇潇_购目录为_电商平台_货物_的订单明细以及商品清单.sql
-- 采购管理系统&mdash;&mdash;电子目录平台&mdash;&mdash;采购目录为&ldquo;电商平台（货物）&rdquo;的订单明细以及商品清单
-- 时间：2023年4月28日至今

SELECT * from dmeta.adm_meta_dict_table_dd --元数据-数据字典-表信息
WHERE dt='20240723'
and table_guid like 'odps.edw.emps_%'
;


--订单开票，收货地址，商品信息表未入仓，转运维处理
-- edw.emps_e_order  --订单表
-- edw.epms_e_order_detail  --订单明细表
-- edw.epms_e_order_invoice     订单开票,未入仓
SELECT * from edw.epms_e_order_invoice  WHERE dt='20240528';
-- e_order_distribution  --收货地址，未入仓
SELECT * from edw.epms_e_order_distribution WHERE dt='20240528';
-- e_product --商品信息，未入仓
SELECT * from edw.epms_e_product WHERE dt='20240528';


-- 一、订单维度字段：1. 订单编号；2. 下单日期；3. 下单人；4. 下单机构；5. 商品编码；6. 商品品牌；7. 商品名称；8. 订单金额；9. 订单金额；10. 商品类目（一、二、三级）；
-- 11. 收货人信息（收货人，收货地址）；12. 销售数量；13. 商品单价；14. 订单状态；15. 验收状态；16. 开票状态；17. 报销状态；18. 报销金额；19. 下单店铺（京东or得力）。


SELECT T12.czyid  --下单人
       ,T12.czymc  --下单人名称
       ,T12.ddbh  --订单编号
       ,T12.kpzt  --开票状态，0-未开票 1-已开票
       ,T12.add_time  --创建时间
       ,T12.bmbh  --部门编号
       ,T12.bmmc  --部门名称
       ,T12.dwbh --单位编号
       ,T12.place_time  --下单时间
       ,T12.status   --状态，0-未审核，1 下单失败 5-审核中，10-已下单，14-供应商拒单 15-供应商已接收 20-已签收，30-拒签收，-1-已撤单
       ,T12.gkbm   --归口部门
       ,T12.gysbh  --供应商编号
       ,T12.gysmc  --供应商名称
       ,T12.product_total  --商品数量
       ,T12.product_amount --商品总金额
       ,T12.order_amount --订单总金额
       ,T12.budget_code  --预算科目
       ,T12.budget_dept --预算部门
       ,T12.budget_org  --预算机构
from edw.emps_e_order T12 --商城订单表
WHERE T12.dt= '@@{yyyyMMdd}';



-- 二、商品维度：全量商品，包含：1. 商品编码；2. 商品名称；3. 商品品牌；4. 下单次数；5. 销售数量（总）；6. 销售金额（总）；7. 在售金额（单价）；8. 历史最低采购价格（单价）
-- ；9. 历史最高采购价格（单价）；10.  商品类目（一、二、三级）；11. 行方采购目录（一、二、三级）；12. 下单店铺（京东or得力）；13. 商品状态（上架or下架）。


DROP TABLE IF EXISTS tmp_qxx_SJ20240712161;

CREATE TABLE IF NOT EXISTS tmp_qxx_SJ20240712161 AS
SELECT  (
        CASE t1.bplx
          WHEN 1 THEN '自行采购结果报批'
          WHEN 2 THEN '框架物资采购结果报批'
          WHEN 3 THEN '集中采购结果报批'
          WHEN 4 THEN '框架合同签订结果报批'
          WHEN 5 THEN '电子目录平台结果报批'
        END
        ) 结果报批类型
        ,t1.bpbh 结果报批编号
        ,t1.bpmc 结果报批名称
        ,t1.jgbpje 结果报批金额
        ,(
         CASE t1.zt
           WHEN 0 THEN '正常'
           WHEN 1 THEN '变更中'
           WHEN 2 THEN '变更审批'
           WHEN 3 THEN '变更完成'
           WHEN 4 THEN '已关闭'
           WHEN 5 THEN '已退回'
         END
        ) 状态
        ,t1.gbyy 关闭原因
        ,org.brc_org_nm 上级机构
        ,t1.zzid
        ,t1.zzmc 汇报机构
        ,t1.bmid
        ,t1.bmmc 汇报部门
        ,t1.qcrmc 创建人
        ,substr(t1.cjsj, 1, 8) 创建时间
        ,t1.gysmc 中标供应商名称
        ,t5.ztdm 中标供应商编号
        ,t1.ywbh 申请单编号
        ,'' 行号
        ,t3.cgml 采购目录编码
        ,t3.cgmlmc 采购目录名称
        ,t3.wpytbh 物品用途编码
        ,t3.wpytmc 物品用途名称
        ,t3.bxlxbh 报销类型编号
        ,t3.bxlxmc 报销类型名称
        ,t3.yskmbh 预算科目编号
        ,t3.yskmmc 预算科目名称
        ,t3.ysxmbh 预算项目编号
        ,t3.ysxmmc 预算项目名称
        ,t3.dj 单价
        ,t3.cgsl 采购数量
        ,t3.cgje 预算金额
        ,(
         CASE T12.status
           WHEN 0    THEN '未审核'
           WHEN 5    THEN '下单失败'
           WHEN 10   THEN '审核中'
           WHEN 15   THEN '已下单'
           WHEN 20   THEN '供应商拒单'
           WHEN 25   THEN '供应商已接收'
           WHEN 30   THEN '供应商已发货'
           WHEN 32   THEN '拒签收'
           WHEN 35   THEN '已签收'
           WHEN 45   THEN '已验收'
           WHEN 50   THEN '已开票'
           WHEN 55   THEN '已撤单'
           WHEN 60   THEN '已支付'
           WHEN - 99 THEN '已删除'
         END
        ) 申请单状态
        ,'' 行明细状态
        ,'' 关闭完结原因
        ,t3.spmc 商品名称
        ,t3.ppmc 品牌
        ,t3.ggxh 规格型号
        ,t3.dj 采购单价
        ,t3.cgsl 数量
        ,t3.cgje 采购金额
FROM    edw.epms_xm_jgbp t1 --结果报批表
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      t1.zzid = org.org_id
AND     org.dt = '@@{yyyyMMdd}'
INNER JOIN    edw.epms_xm_jgbp_spxx t3 --结果报批商品信息
ON      t1.id = t3.jgbp
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.epms_jc_ztbzt t5 --供应商基础信息
ON      t5.id = t1.gysbh
AND     t5.dt = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     ( t1.sfsjqy = 0
    OR t1.sfsjqy IS NULL )   --是否数据迁移
AND     t1.bplx = 5  --电子目录平台
AND     t1.zzid = '990000000'
AND     t1.CJSJ > '20231231235959'
AND     t1.cjsj < '20240401000000'
ORDER BY t1.bpbh;

--------------------------------------------------------------------------------------------------------------------------
DROP TABLE IF EXISTS tmp_wsj_yln_cgxt_02;

CREATE TABLE IF NOT EXISTS tmp_wsj_yln_cgxt_02 AS
SELECT  t1.ywbh 申请单编号
        ,t1.ywmc 申请单名称
        ,(
         CASE T12.status
           WHEN 0    THEN '未审核'
           WHEN 5    THEN '下单失败'
           WHEN 10   THEN '审核中'
           WHEN 15   THEN '已下单'
           WHEN 20   THEN '供应商拒单'
           WHEN 25   THEN '供应商已接收'
           WHEN 30   THEN '供应商已发货'
           WHEN 32   THEN '拒签收'
           WHEN 35   THEN '已签收'
           WHEN 45   THEN '已验收'
           WHEN 50   THEN '已开票'
           WHEN 55   THEN '已撤单'
           WHEN 60   THEN '已支付'
           WHEN - 99 THEN '已删除'
         END
        ) 申请单状态
        ,t3.cgml 采购目录编码
        ,t3.cgmlmc 采购目录名称
        ,t3.wpytbh 物品用途编码
        ,t3.wpytmc 物品用途名称
        ,t3.bxlxbh 报销类型编号
        ,t3.bxlxmc 报销类型名称
        ,t3.yskmbh 预算科目编号
        ,t3.yskmmc 预算科目名称
        ,t3.ysxmbh 预算项目编号
        ,t3.ysxmmc 预算项目名称
        ,t3.dj 采购单价
        ,t3.cgsl 采购数量
        ,t3.cgje 采购金额
        ,t1.zzid 需求机构编号
        ,t1.zzmc 需求机构
        ,t1.bmid 需求部门编号
        ,t1.bmmc 需求部门
        ,org.brc_org_nm 上级机构
        ,t1.qcrmc 创建人
        ,t6.ysdh 验收单号
        ,t6.syrmc 验收人名称
        ,t6.yssj 验收时间
        ,t6.sjyssj 实际验收时间
        ,t6.ysly 验收来源0结果报批1合同
        ,t6.ysjd 验收节点0预付款1发货款2到货款3验收款4尾款
        ,t6.ysyj 验收意见
        ,t6.fkpcxh 付款批次
        ,t6.fkje 付款批次金额
        ,(
         CASE t1.bplx
           WHEN 1 THEN '自行采购结果报批'
           WHEN 2 THEN '框架物资采购结果报批'
           WHEN 3 THEN '集中采购结果报批'
           WHEN 4 THEN '框架合同签订结果报批'
           WHEN 5 THEN '电子目录平台结果报批'
         END
        ) 结果报批类型
        ,t1.bpbh 结果报批编号
        ,t1.bpmc 结果报批名称
        ,t1.jgbpje 结果报批金额
        ,(
         CASE t1.zt
           WHEN 0 THEN '正常'
           WHEN 1 THEN '变更中'
           WHEN 2 THEN '变更审批'
           WHEN 3 THEN '变更完成'
           WHEN 4 THEN '已关闭'
           WHEN 5 THEN '已退回'
         END
        ) 状态
        ,substr(t1.cjsj, 1, 8) 创建时间
        ,t1.gysmc 中标供应商名称
        ,t6.ysje 验收金额
FROM    edw.epms_xm_jgbp t1   --结果报批表
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      t1.zzid = org.org_id
AND     org.dt = '@@{yyyyMMdd}'
INNER JOIN    edw.epms_xm_jgbp_spxx t3  --结果报批商品信息
ON      t1.id = t3.jgbp
AND     t3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.epms_jc_ztbzt t5  --供应商基础信息
ON      t5.id = t1.gysbh
AND     t5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.epms_xm_htys t6   --验收信息
ON      t6.ywid = t1.id
AND     t6.dt = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     ( t1.sfsjqy = 0
    OR t1.sfsjqy IS NULL )
AND     t1.bplx = 5  --电子目录平台
AND     substr(t1.CJSJ, 1, 8) > '20230428'
ORDER BY t1.bpbh
;
**01-数据需求_总行计财_SJ2024073091-罗静-取202405_202406的各类贷款日均余额数据及对应的利息收入_分集团和单体_当月和年累计4个口径_.sql
-- SJ2024073091
-- 需取202405/202406的各类贷款日均余额数据及对应的利息收入（分集团和单体、当月和年累计4个口径）

---------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------
--第一部分 贷款月日均

--临时表 贷款月日均
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj AS
-- SELECT  P3.dbil_id
        -- ,P3.bus_ctr_id
        -- ,P3.DT
        -- ,SUM(p3.mon_acm_prcp_bal_acml * p2.cny_exr) / SUBSTR(p3.DT, 7, 2)                                                           AS 贷款月日均
        -- ,SUM(p3.year_acm_prcp_bal_acml * p2.cny_exr) / DATEDIFF(TO_DATE(p3.DT, 'YYYYMMDD'), TO_DATE('20231231', 'YYYYMMDD'), 'DD')  AS 贷款年日均
-- FROM    edw.dws_bus_loan_dbil_inf_dd p3 --贷款借据信息汇总
-- LEFT JOIN    edw.dim_bus_com_exr_inf_dd p2 --汇率信息
-- ON      p3.ccy_cd = p2.ccy_cd
-- AND     p3.DT = p2.DT
-- AND     p2.dt IN ( '20240531' , '20240630' , '20240731')
-- WHERE   p3.dt IN ( '20240531' , '20240630' , '20240731')
-- GROUP BY P3.dbil_id ,P3.bus_ctr_id , P3.DT;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj AS
SELECT
   T1.loan_num	  AS dbil_id
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202405' THEN T1.loan_acct_bal_cny END)/31 AS 贷款月日均
   ,SUM(T1.loan_acct_bal_cny	)/DATEDIFF(TO_DATE('20240531','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 贷款年日均
FROM adm_upss.adm_upss_qd_ln_bal_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240531'
GROUP BY T1.loan_num
UNION ALL
SELECT
   T1.loan_num	AS dbil_id
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202406' THEN T1.loan_acct_bal_cny END	)/30 AS 贷款月日均
   ,SUM(T1.loan_acct_bal_cny	)/DATEDIFF(TO_DATE('20240630','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 贷款年日均
FROM adm_upss.adm_upss_qd_ln_bal_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240630'
GROUP BY T1.loan_num
UNION ALL
SELECT
   T1.loan_num	AS dbil_id
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202407' THEN T1.loan_acct_bal_cny END	)/31 AS 贷款月日均
   ,SUM(T1.loan_acct_bal_cny	)/DATEDIFF(TO_DATE('20240731','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 贷款年日均
FROM adm_upss.adm_upss_qd_ln_bal_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240731'
GROUP BY T1.loan_num
;


--临时表 信用卡垫款月日均
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_xyk;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_xyk AS
-- SELECT
    -- T1.cr_crd_card_nbr	  --卡号
	-- ,T1.cr_crd_act_id     --账号
	-- ,T1.DT
	-- ,SUM(T2.tmon_cur_mon_adv_mny_bal_acm)/SUBSTR(T1.DT, 7, 2)  AS    垫款月日均
	-- ,SUM(T2.tyear_year_adv_mny_bal_acm)/ DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE('20231231', 'YYYYMMDD'), 'DD')  AS    垫款年日均
-- FROM edw.dim_bus_crd_cr_crd_inf_dd T1 --信用卡卡片信息
-- LEFT JOIN edw.dws_bus_crd_cr_crd_act_acm_inf_dd T2  --信用卡账户汇总信息
-- ON T1.cr_crd_act_id	= T2.cr_crd_act_id
-- AND T1.DT = T2.DT
-- AND T2.DT IN ( '20240531' , '20240630' , '20240731' )
-- WHERE T1.DT IN ( '20240531' , '20240630' , '20240731' )
-- GROUP BY T1.cr_crd_card_nbr ,T1.cr_crd_act_id , T1.DT;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_xyk;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_xyk AS
SELECT
   T1.loan_num	  AS cr_crd_card_nbr
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202405' THEN T1.loan_acct_bal_cny END	)/31 AS 垫款月日均
   ,SUM(T1.loan_acct_bal_cny	)/DATEDIFF(TO_DATE('20240531','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 垫款年日均
FROM adm_upss.adm_upss_qd_cr_crd_bal_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240531'
GROUP BY T1.loan_num
UNION ALL
SELECT
   T1.loan_num	AS cr_crd_card_nbr
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202406' THEN T1.loan_acct_bal_cny END		)/30 AS 垫款月日均
   ,SUM(T1.loan_acct_bal_cny	)/DATEDIFF(TO_DATE('20240630','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 垫款年日均
FROM adm_upss.adm_upss_qd_cr_crd_bal_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240630'
GROUP BY T1.loan_num
UNION ALL
SELECT
   T1.loan_num	AS cr_crd_card_nbr
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202407' THEN T1.loan_acct_bal_cny END		)/31 AS 垫款月日均
   ,SUM(T1.loan_acct_bal_cny	)/DATEDIFF(TO_DATE('20240731','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 垫款年日均
FROM adm_upss.adm_upss_qd_cr_crd_bal_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240731'
GROUP BY T1.loan_num
;


--临时表 票据融资-买断式转贴现/公司-其他月日均
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_pj;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_pj AS
SELECT
   T1.acct_num
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202405' THEN T1.face_val END	)/31 AS 月日均
   ,SUM(T1.face_val)/DATEDIFF(TO_DATE('20240531','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 年日均
FROM adm_upss.adm_upss_qd_mdztx_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240531'
GROUP BY T1.acct_num
UNION ALL
SELECT
   T1.acct_num
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202406' THEN T1.face_val END)/30 AS 月日均
   ,SUM(T1.face_val)/DATEDIFF(TO_DATE('20240630','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 年日均
FROM adm_upss.adm_upss_qd_mdztx_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240630'
GROUP BY T1.acct_num
UNION ALL
SELECT
   T1.acct_num
   ,MAX(T1.DT)  AS DT
   ,SUM(CASE WHEN SUBSTR(T1.DT,1,6)='202407' THEN T1.face_val END)/31 AS 月日均
   ,SUM(T1.face_val)/DATEDIFF(TO_DATE('20240731','YYYYMMDD') ,  TO_DATE('20231231','YYYYMMDD') ,'DD') AS 年日均
FROM adm_upss.adm_upss_qd_mdztx_dd T1
WHERE T1.DT>='20240101'
AND   T1.DT<='20240731'
GROUP BY T1.acct_num
;

--结果表1  全量贷款
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_01;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_01 AS
SELECT  A.DT              AS 日期
       ,SUM(A.贷款月日均) AS 贷款月日均
	   ,SUM(A.贷款年日均) AS 贷款年日均
FROM    (
            SELECT  T.DT
			       ,SUM(T1.贷款月日均) / 10000 AS 贷款月日均
				   ,SUM(T1.贷款年日均) / 10000 AS 贷款年日均
            FROM    adm_upss.adm_upss_qd_ln_bal_dd T   --贷款余额清单
			LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj T1 --贷款月日均
            ON  T.loan_num	 = T1.dbil_id
            AND T.DT = T1.DT
            WHERE   T.dt IN ( '20240531' ,'20240630' , '20240731'  )
            AND     T.ACCT_TYP NOT LIKE '90%'
            AND     substr(T.org_num, 3, 1) <> '6'
			GROUP BY T.DT
            UNION ALL
            SELECT  T.DT
			       ,SUM(T1.垫款月日均) / 10000 AS 贷款月日均
				   ,SUM(T1.垫款年日均) / 10000 AS 贷款年日均
            FROM    adm_upss.adm_upss_qd_cr_crd_bal_dd T   --清单-贷款余额清单
			LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_xyk T1 --贷款月日均
            ON  T.loan_num	 = T1.cr_crd_card_nbr
            AND T.DT = T1.DT
            WHERE   T.dt IN ( '20240531' ,'20240630' , '20240731'  )
            AND     substr(T.org_num, 3, 1) <> '6'
			GROUP BY T.DT
            UNION ALL
            SELECT  T.DT
			       ,SUM(T1.月日均) / 10000 AS 贷款月日均
				   ,SUM(T1.年日均) / 10000 AS 贷款年日均
            FROM    adm_upss.adm_upss_qd_mdztx_dd T
			LEFT JOIN  lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_pj T1 --贷款月日均
            ON T.acct_num	 = T1.acct_num
		    AND T.DT = T1.DT
            WHERE   T.dt IN ( '20240531' ,'20240630' , '20240731'  )
            AND     substr(T.org_num, 3, 1) <> '6'
			GROUP BY T.DT
        ) A
GROUP BY A.DT ;

-- SELECT * FROM tmp_jinguan_SJ2024073091_01

--结果表2  全量贷款-各项贷款结构月日均

-- SELECT * FROM tmp_jinguan_SJ2024073091_02

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_02;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_02 AS
SELECT  T.DT                                                                                                                              AS 日期
        ,'个人经营贷款'                                                                                                                   AS 种类
         ,SUM(T1.贷款月日均) / 10000 AS 贷款月日均
         ,SUM(T1.贷款年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj T1 --贷款月日均
ON      T.loan_num	 = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630' , '20240731' )
AND     T.ACCT_TYP NOT LIKE '90%'
AND     T.ACCT_TYP NOT LIKE '03%'
AND     ( CUST_TYP = '3'
    OR ( CUST_TYP IS NULL
AND     substr(T.ACCT_TYP, 1, 4) IN ( '0102' , '0202' ) ) )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                                                                                                                              AS 日期
        ,'个人消费贷款'                                                                                                                   AS 种类
         ,SUM(T1.贷款月日均) / 10000 AS 贷款月日均
         ,SUM(T1.贷款年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj T1 --贷款月日均
ON      T.loan_num	 = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.ACCT_TYP NOT LIKE '90%'
AND     T.ACCT_TYP NOT LIKE '03%'
AND     ( T.CUST_TYP IS NULL
AND     substr(T.ACCT_TYP, 1, 4) NOT IN ( '0102' , '0202' ) )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                                                                                                                              AS 日期
        ,'单位贷款'                                                                                                                       AS 种类
         ,SUM(T1.贷款月日均) / 10000 AS 贷款月日均
         ,SUM(T1.贷款年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj T1 --贷款月日均
ON      T.loan_num	 = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.ACCT_TYP NOT LIKE '90%'
AND     T.ACCT_TYP NOT LIKE '03%'
AND     ( CUST_TYP <> '3'
AND     CUST_TYP IS NOT NULL )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                                                                                                                              AS 日期
        ,'票据融资-贴现'                                                                                                                  AS 种类
         ,SUM(T1.贷款月日均) / 10000 AS 贷款月日均
         ,SUM(T1.贷款年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj T1 --贷款月日均
ON      T.loan_num= T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630' , '20240731' )
AND     T.ACCT_TYP LIKE '03%'
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                                                                                                                              AS 日期
        ,'个人信用卡'                                                                                                                     AS 种类
         ,SUM(T1.垫款月日均) / 10000 AS 贷款月日均
         ,SUM(T1.垫款年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_cr_crd_bal_dd T
LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_xyk T1 --贷款月日均
ON  T.loan_num	 = T1.cr_crd_card_nbr
AND T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                                                                                                                              AS 日期
        ,'票据融资-买断式转贴现'                                                                                                          AS 种类
         ,SUM(T1.月日均) / 10000 AS 贷款月日均
         ,SUM(T1.年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_mdztx_dd T
LEFT JOIN   lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_pj  T1 --贷款月日均
ON T.acct_num	 = T1.acct_num
AND T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     INVEST_TYP = '11'
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                                                                                                                              AS 日期
        ,'公司-其他'                                                                                                                      AS 种类
         ,SUM(T1.月日均) / 10000 AS 贷款月日均
         ,SUM(T1.年日均) / 10000 AS 贷款年日均
FROM    adm_upss.adm_upss_qd_mdztx_dd T
LEFT JOIN   lab_bigdata_dev.tmp_jinguan_SJ2024073091_yrj_pj  T1 --贷款月日均
ON T.acct_num	 = T1.acct_num
AND T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.INVEST_TYP <> '11'
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT;



---------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------
--第二部分 贷款利息收入
-- 临时表 ：利息收入
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX AS
SELECT  P3.dbil_id
        ,P3.bus_ctr_id
        ,P3.DT
        ,sum(P1.accint_month * p2.cny_exr) AS 当月ftp利息收入--已折人民币
       ,sum(P1.accint_year * p2.cny_exr) AS 当年ftp利息收入 --已折人民币
FROM    edw.dws_bus_loan_dbil_inf_dd p3 --贷款借据信息汇总
INNER JOIN    app_iftp.adm_papp_ftp_eva_app_rst_ftp P1 --FTP当日结果集-EVA视角
ON      p1.t_acct_no = P3.dbil_id
AND     P1.DT = P3.DT
AND     p1.dt IN ( '20240531' , '20240630' , '20240731' )
LEFT JOIN    (
                 SELECT  p1.ccy_cd
                         ,p2.ccy
                         ,p1.cny_exr
                         ,p1.DT
                 FROM    edw.dim_bus_com_exr_inf_dd p1 --汇率信息
                 LEFT JOIN    edw.neop_ifs_currency P2 --币种表
                 ON      P1.ccy_cd = P2.ccy_digit_code
                 AND     P2.DT = P1.DT
                 WHERE   P1.DT IN ( '20240531' , '20240630' , '20240731' )
             ) p2
ON      p1.currency_cd = p2.ccy --p1,币种，CNY、EUR、USD;P2:156,702
AND     P1.DT = p2.DT
WHERE   p3.dt IN ( '20240531' , '20240630' , '20240731' )
GROUP BY P3.dbil_id , P3.bus_ctr_id , P3.DT;


-- 临时表 ：利息收入_信用卡
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX_xyk;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX_xyk AS
SELECT  P3.cr_crd_card_nbr
        ,P3.DT
        ,sum(P1.accint_month * p2.cny_exr)   AS 当月ftp利息收入 --已折人民币
        ,sum(P1.accint_year  * p2.cny_exr) AS 当年ftp利息收入 --已折人民币
FROM    edw.dim_bus_crd_cr_crd_inf_dd p3 --信用卡卡片信息
INNER JOIN   app_iftp.adm_papp_ftp_eva_app_rst_ftp   P1 --FTP当日结果集-EVA视角
ON      p1.t_acct_no = P3.cr_crd_card_nbr
AND     P1.DT = P3.DT
AND     p1.dt IN ( '20240531' , '20240630', '20240731'  )
LEFT JOIN    (
                 SELECT  p1.ccy_cd
                         ,p2.ccy
                         ,p1.cny_exr
                         ,p1.DT
                 FROM    edw.dim_bus_com_exr_inf_dd p1 --汇率信息
                 LEFT JOIN    edw.neop_ifs_currency P2 --币种表
                 ON      P1.ccy_cd = P2.ccy_digit_code
                 AND     P2.DT = P1.DT
                 WHERE   P1.DT IN ( '20240531' , '20240630' , '20240731' )
             ) p2
ON      p1.currency_cd = p2.ccy --p1,币种，CNY、EUR、USD;P2:156,702
AND     P1.DT = p2.DT
WHERE   p3.dt IN ( '20240531' , '20240630', '20240731'  )
GROUP BY P3.cr_crd_card_nbr,P3.DT ;



--结果表3  全量贷款利息收入
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_03;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_03 AS
SELECT  A.DT              AS 日期
       ,SUM(A.当月ftp利息收入) AS 当月ftp利息收入
	   ,SUM(A.当年ftp利息收入) AS 当年ftp利息收入
FROM    (
            SELECT  T.DT
			       ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
				   ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
            FROM    adm_upss.adm_upss_qd_ln_bal_dd T   --贷款余额清单
			LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX   T1 --FTP当日结果集-EVA视角
            ON  T.loan_num	 = T1.dbil_id
            AND T.DT = T1.DT
            WHERE   T.dt IN ( '20240531' ,'20240630', '20240731'  )
            AND     T.ACCT_TYP NOT LIKE '90%'
            AND     substr(T.org_num, 3, 1) <> '6'
			GROUP BY T.DT
            UNION ALL
            SELECT  T.DT
			       ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
				   ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
            FROM    adm_upss.adm_upss_qd_cr_crd_bal_dd T   --清单-贷款余额清单
			LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX_xyk T1 --利息收入
            ON  T.loan_num	 = T1.cr_crd_card_nbr
            AND T.DT = T1.DT
            WHERE   T.dt IN ( '20240531' ,'20240630', '20240731'  )
            AND     substr(T.org_num, 3, 1) <> '6'
			GROUP BY T.DT
            -- UNION ALL
            -- SELECT  T.DT
			       -- ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
				   -- ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
            -- FROM    adm_upss.adm_upss_qd_mdztx_dd T
			-- LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
            -- ON  T1.loan_num	 = T1.bus_ctr_id
            -- AND T1.DT = T1.DT
            -- WHERE   T.dt IN ( '20240531' ,'20240630', '20240731'  )
            -- AND     substr(T.org_num, 3, 1) <> '6'
			-- GROUP BY T.DT
        ) A
GROUP BY A.DT ;



--结果表2  全量贷款-各项贷款结构月日均

-- SELECT * FROM tmp_jinguan_SJ2024073091_04

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_04;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_jinguan_SJ2024073091_04 AS
SELECT  T.DT                       AS 日期
        ,'个人经营贷款'                  AS 种类
        ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN    lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
ON      T.loan_num = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.ACCT_TYP NOT LIKE '90%'
AND     T.ACCT_TYP NOT LIKE '03%'
AND     ( CUST_TYP = '3'
    OR ( CUST_TYP IS NULL
AND     substr(T.ACCT_TYP, 1, 4) IN ( '0102' , '0202' ) ) )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                       AS 日期
        ,'个人消费贷款'                  AS 种类
        ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN    lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
ON      T.loan_num = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.ACCT_TYP NOT LIKE '90%'
AND     T.ACCT_TYP NOT LIKE '03%'
AND     ( T.CUST_TYP IS NULL
AND     substr(T.ACCT_TYP, 1, 4) NOT IN ( '0102' , '0202' ) )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                       AS 日期
        ,'单位贷款'                    AS 种类
        ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN    lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
ON      T.loan_num = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.ACCT_TYP NOT LIKE '90%'
AND     T.ACCT_TYP NOT LIKE '03%'
AND     ( CUST_TYP <> '3'
AND     CUST_TYP IS NOT NULL )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                       AS 日期
        ,'票据融资-贴现'                 AS 种类
        ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
FROM    adm_upss.adm_upss_qd_ln_bal_dd T
LEFT JOIN    lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
ON      T.loan_num = T1.dbil_id
AND     T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     T.ACCT_TYP LIKE '03%'
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
UNION ALL
SELECT  T.DT                       AS 日期
        ,'个人信用卡'                   AS 种类
        ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
FROM    adm_upss.adm_upss_qd_cr_crd_bal_dd T
LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX_xyk T1 --利息收入
ON  T.loan_num	 = T1.cr_crd_card_nbr
AND T.DT = T1.DT
WHERE   T.dt IN ( '20240531' , '20240630', '20240731'  )
AND     substr(T.org_num, 3, 1) <> '6'
GROUP BY T.DT
-- UNION ALL
-- SELECT  T.DT                       AS 日期
        -- ,'票据融资-买断式转贴现'             AS 种类
        -- ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        -- ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
-- FROM    adm_upss.adm_upss_qd_mdztx_dd T
-- LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
-- ON  T1.loan_num	 = T1.bus_ctr_id
-- AND T1.DT = T1.DT
-- WHERE   T.dt IN ( '20240531' , '20240630' )
-- AND     INVEST_TYP = '11'
-- AND     substr(T.org_num, 3, 1) <> '6'
-- GROUP BY T.DT
-- UNION ALL
-- SELECT  T.DT                       AS 日期
        -- ,'公司-其他'                   AS 种类
        -- ,SUM(T1.当月ftp利息收入) / 10000 AS 当月ftp利息收入
        -- ,SUM(T1.当年ftp利息收入) / 10000 AS 当年ftp利息收入
-- FROM    adm_upss.adm_upss_qd_mdztx_dd T
-- LEFT JOIN lab_bigdata_dev.tmp_jinguan_SJ2024073091_LX T1 --利息收入
-- ON  T1.loan_num	 = T1.bus_ctr_id
-- AND T1.DT = T1.DT
-- WHERE   T.dt IN ( '20240531' , '20240630' )
-- AND     T.INVEST_TYP <> '11'
-- AND     substr(T.org_num, 3, 1) <> '6'
-- GROUP BY T.DT
;
**01-数据需求_总行计财_SJ20240814126_叶峰_公出旅游行程.sql
-- SJ20240814126
-- 用于开展分行财务收支纪律自查结果验证（查看分行班子公出旅游行程）
-- 附件中人员的20230101-20240630的公出行程
-- 公出申请单号、出行人、出行开始时间、出行结束时间、出发城市、到达城市、外出事由、公出类型

--edw.oadb_formtable_main_693  未入仓

-- edw.infs_tlsl_apply_order_info 数据最早日期为20240319，不全需取OA的表


DROP TABLE if EXISTS tmp_yf_SJ20240814126 purge;
CREATE TABLE IF NOT EXISTS tmp_yf_SJ20240814126 as
SELECT a.oa_apply_id 公出申请单号
       ,a.itinerary_user  出行人id
       ,a.itinerary_user_name 出行人姓名
       ,a.start_date 出行开始时间
       ,a.end_date 出行结束时间
       ,a.dep_city 出发城市
       ,a.arr_city 到达城市
       ,a.trip_cause 外出事由
       ,case
       when a.traffic_type='0' THEN  '公出'
       when a.traffic_type='1' THEN  '春节离岗报备'
       when a.traffic_type='2' THEN  '居家办公（个人原因）'
       when a.traffic_type='3' THEN  '居家办公（不可抗力）'
       when a.traffic_type='4' THEN  '其他'
       end as 外出类型   -- 0-公出1-春节离岗报备2-居家办公（个人原因）3-居家办公（不可抗力）4-其他
       ,case when a.traffic_sub_type='0' THEN  '会议出差'
       when a.traffic_sub_type='1' THEN  '培训出差'
       when a.traffic_sub_type='2' THEN  '招聘出差'
       when a.traffic_sub_type='3' THEN  '调研检查出差'
       when a.traffic_sub_type='4' THEN  '业务拓展出差'
       when a.traffic_sub_type='5' THEN  '其他出差'
       end as 公出类型
       ,replace(substr(a.apply_time,1,10),'-','') 创建时间
from edw.infs_tlsl_apply_order_info a  --外出申请信息表
WHERE dt='@@{yyyyMMdd}'
and replace(substr(a.apply_time,1,10),'-','') >='20230101'
and replace(substr(a.apply_time,1,10),'-','') <='20240630'
and a.itinerary_user in ('000928',
'000217',
'001551',
'003021',
'001669',
'024266',
'000636',
'000829',
'002518',
'002035',
'011068',
'003797',
'005605',
'002500',
'000350',
'001777',
'000919',
'000163',
'001778',
'005482',
'005548',
'001204',
'001641',
'001174',
'000012',
'000292',
'004270',
'001208',
'000141',
'001206',
'011999',
'000649',
'001640',
'001279',
'003121',
'000082',
'008902',
'000240',
'000313',
'013216',
'000315',
'000700',
'013698',
'000289'
)
;
**01-数据需求_总行计财_SJ20240814146_郑城城_科技需求清单_OA_需求准入申请_.sql
--分析手机银行科技成本，20-24年科技需求清单（OA-需求准入申请）
--requestid	需求编号	需求名称	申请人姓名	申请人部门	申请日期	需求实施方式	主系统	关联系统
--紧急程度1	紧急程度2	紧急程度3	紧急程度4	专业部门_计划财务部	专业部门_核算	专业部门_监管报送	专业部门_合规部	专业部门_大数据部
--专业部门_基础标准	专业部门_指标标准	专业部门_数据安全	专业部门_分险管理部	主题组_客户关系管理项目组	主题组_产品管理与创新项目组	主题组_数字化风控项目组	主题组_渠道建设与运营项目组
--需求来源	技术经理	产品经理	一级指标	二级指标	价值指标	价值指标口径	基线值	目标值	达成时间	痛点、根因、监管要求	举措

--需求准入申请完成日期即流程归档时间
--结果表：

-- SELECT * FROM tmp_sjxq_SJ20240814146 WHERE 需求编号='XQ20230308007';

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240814146 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240814146 AS
SELECT  distinct fm.requestid
        ,fm.xqbh                                AS 需求编号
        ,fm.xqmc                                AS 需求名称
        ,CONCAT(hr.loginid, '-', hr.lastname)   AS 申请人姓名
        -- hr.loginid || ' ' || hr.lastname AS 申请人姓名,
        ,hd.departmentmark                      AS 申请人部门
        ,fm.sqrq                                AS 申请日期
        ,A1.selectname                          AS 需求实施方式
        ,it.systemname                          AS 主系统
        ,ff.systemname                          AS 关联系统
        ,A2.selectname                          AS 紧急程度1
        ,A3.selectname                          AS 紧急程度2
        ,A4.selectname                          AS 紧急程度3
        ,fm.xqlxqt                              AS 紧急程度4
        --专业部门
        ,fm.jhcwb                               AS 专业部门_计划财务部
        ,fm.hs                                  AS 专业部门_核算
        ,fm.jgbs                                AS 专业部门_监管报送
        ,fm.hgb                                 AS 专业部门_合规部
        ,fm.dsjb                                AS 专业部门_大数据部
        ,fm.jcbz                                AS 专业部门_基础标准
        ,fm.zbbz                                AS 专业部门_指标标准
        ,fm.sjaq                                AS 专业部门_数据安全
        ,fm.fxglb                               AS 专业部门_风险险管理部
        --主题组
        ,fm.khgx                                AS 主题组_客户关系管理项目组
        ,fm.cpgl                                AS 主题组_产品管理与创新项目组
        ,fm.szh                                 AS 主题组_数字化风控项目组
        ,fm.qdjs                                AS 主题组_渠道建设与运营项目组
        ,B1.selectname                          AS 需求来源
        ,CONCAT(hr2.loginid, '-', hr2.lastname) AS 技术经理
        ,CONCAT(hr3.loginid, '-', hr3.lastname) AS 产品经理
        -- hr2.loginid || ' ' || hr2.lastname AS 技术经理,
        -- hr3.loginid || ' ' || hr3.lastname AS 产品经理,
        ,B2.selectname                          AS 一级指标
        ,B3.selectname                          AS 二级指标
        ,B4.selectname                          AS 价值指标
        ,fm_dt1.zbkj                            AS 价值指标口径
        ,fm_dt1.jxz                             AS 基线值
        ,fm_dt1.mbz                             AS 目标值
        ,fm_dt1.dcsj                            AS 达成时间
        ,fm.jgyq                                AS 痛点根因监管要求
        ,fm.jc                                  AS 举措
        ,p.currentnodeid                        AS 流程当前所在节点
        ,p.nodename                            AS 节点名称
        ,p.receivedate                         as 接收日期
FROM   edw.oadb_formtable_main_660 fm    --目前只有22年3月份之后的数据
left join (
        SELECT wr.currentnodeid  --流程当前所在节点
               ,wn.nodename  --节点名称
               ,wc.requestid  --
               ,wc.receivedate
        from edw.oadb_workflow_requestbase wr  -- 工作流请求基本信息表
        LEFT JOIN edw.oadb_workflow_nodebase wn --工作流节点基本信息表
        on wr.currentnodeid=wn.id  --流程當前当前所在节点
        and wn.dt='@@{yyyyMMdd}'
        LEFT JOIN edw.oadb_workflow_currentoperator wc --工作流请求节点操作人信息表
        on wc.nodeid=wr.currentnodeid
       -- AND WC.isremark = '4'  --归档
        and wc.dt='@@{yyyyMMdd}'
        WHERE wr.dt='@@{yyyyMMdd}'
        and wr.workflowid = '109201'   --需求准入流程
)p
on p.requestid=fm.requestid
LEFT JOIN    edw.oadb_hrmresource hr  --人力资源基本信息表
ON      hr.ID = fm.sqr
AND     hr.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmdepartment hd
ON      hd.ID = fm.sqbm
AND     hd.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_new_itms_system it  --同步CMDB系统数据
ON      to_char(it.systemid) = fm.zyxt1
AND     it.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_formtable_main_660_dt1 fm_dt1   --数据需求申请_dt1-老
ON      fm_dt1.mainid = fm.id
AND     fm_dt1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmresource hr2
ON      to_char(hr2.id) = fm.jsjl
AND     hr2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_hrmresource hr3
ON      to_char(hr3.id) = fm.cpjl
AND     hr3.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  requestid
                         ,WM_CONCAT('||', h3.systemname) systemname   --将关联系统多行拼在一行
                 FROM    (
                             SELECT  A.requestid
                                     ,A.glxt1
                                     ,glxt_1
                             FROM    edw.oadb_formtable_main_660 A LATERAL VIEW explode(split(A.glxt1, ',')) glxt_1 AS glxt_1 --一行拆解多行
                             WHERE   DT = '@@{yyyyMMdd}'
                             AND     A.glxt1 <> ''
                         ) fm2
                 LEFT JOIN    edw.oadb_new_itms_system h3  --同步CMDB系统数据
                 ON      h3.systemid = fm2.glxt_1
                 AND     h3.dt = '@@{yyyyMMdd}'
                 GROUP BY requestid
             ) ff
ON      ff.requestid = fm.requestid
LEFT JOIN    edw.oadb_workflow_selectitem A1 --。流程选择条目表  需求实施方式
ON      A1.selectvalue = fm.ssfs
AND     A1.fieldid = '204266'
AND     A1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem A2 --紧急程度1
ON      A2.selectvalue = fm.xqlx
AND     A2.fieldid = '204267'
AND     A2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem A3 --紧急程度2
ON      A3.selectvalue = fm.nwb
AND     A3.fieldid = '204279'
AND     A3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem A4 --紧急程度3
ON      A4.selectvalue = fm.wb
AND     A4.fieldid = '204280'
AND     A4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B1 --需求来源
ON      B1.selectvalue = fm.xqly
AND     B1.fieldid = '204272'
AND     B1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B2 --一级指标
ON      B2.selectvalue = fm_dt1.yjzb
AND     B2.fieldid = '204296'
AND     B2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B3 --二级指标
ON      B3.selectvalue = fm_dt1.rjzb
AND     B3.fieldid = '204297'
AND     B3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.oadb_workflow_selectitem B4 --价值指标
ON      B4.selectvalue = fm_dt1.jzzb
AND     B4.fieldid = '204298'
AND     B4.dt = '@@{yyyyMMdd}'
WHERE   fm.dt = '@@{yyyyMMdd}'
AND     substr(fm.sqrq, 1,4) >= '2020';



--edw.oadb_workflow_selectitem  --流程选择条目表
--  Field           | Type       | Label | Comment                                     |
+------------------------------------------------------------------------------------+
-- | fieldid         | bigint     | 1     | 字段ID                                        |
-- | isbill          | bigint     |       | 是否为单据                                       |
-- | selectvalue     | bigint     |       | 下拉框的值                                       |
-- | selectname      | string     |       | 下拉框名称                                       |
-- | id              | bigint     |       | ID                                          |
-- | listorder       | decimal    |       | 列表顺序                                        |
-- | isdefault       | string     |       | 是否为默认                                       |
-- | docpath         | string     |       | 文档路径                                        |
-- | doccategory     | string     |       | 文档分类                                        |
-- | isaccordtosubcom | string     |       | 是否与下属机构相关                                   |
-- | childitemid     | string     |       | 子条目ID                                       |
-- | cancel          | string     |       | 取消                                          |
-- | pubid           | bigint     |       |                                             |

--desc  edw.oadb_formtable_main_660
-- | id              | decimal    |       | id                                          |
-- | requestid       | decimal    |       | 请求ID                                        |
-- | sqr             | decimal    |       | 拟申请员工                                       |
-- | sqbm            | decimal    |       | 申请部门                                        |
-- | sqrq            | string     |       | 申请日期                                        |
-- | xqbh            | string     |       | 需求编号                                        |
-- | xqmc            | string     |       | 需求名称                                        |
-- | ssfs            | decimal    |       | 实施方式                                        |
-- | xqlx            | decimal    |       | 紧急程度                                        |
-- | sptd            | decimal    |       | 评审通道                                        |
-- | spjg            | decimal    |       | 评审结果                                        |
-- | btgyy           | string     |       | 不通过原因/待办描述                                  |
-- | lhhpgzb         | decimal    |       | 是否有量化后评估指标                                  |
-- | xqly            | decimal    |       | 需求来源                                        |
-- | zrpsfs          | decimal    |       | 需求类型                                        |
-- | ssxq            | string     |       | 需求实施详情                                      |
-- | sqrgh           | string     |       | 申请人工号                                       |
-- | thlx            | decimal    |       | 退回类型                                        |
-- | nwb             | decimal    |       | 内外部                                         |
-- | wb              | decimal    |       | 外部内部                                        |
-- | xqlxqt          | string     |       | 其他                                          |
-- | jhcwb           | string     |       | 计划财务部                                       |
-- | hgb             | string     |       | 合规部（监管合规）                                   |
-- | dsjb            | string     |       | 大数据部                                        |
-- | fxglb           | string     |       |  风险管理部（操作风险）                                |
-- | wu              | string     |       | 无                                           |
-- | khgx            | string     |       | 客户关系管理项目组                                   |
-- | cpgl            | string     |       | 产品管理与创新项目组                                  |
-- | szh             | string     |       | 数字化风控项目组                                    |
-- | qdjs            | string     |       | 渠道建设与运营项目组                                  |
-- | w               | string     |       | 无                                           |
-- | ywxqwd          | string     |       | 业务需求文档                                      |
-- | th              | decimal    |       | 退回                                          |
-- | cpjl            | string     |       | 产品经理                                        |
-- | jsjl            | string     |       | 技术经理                                        |
-- | ywlxr           | string     |       | 关联部门联系人                                     |
-- | jhjsr           | string     |       | 需求实施计划接收人                                   |
-- | ztbm            | string     |       | 专业部门                                        |
-- | ztxmz           | string     |       | 专题项目组                                       |
-- | zxtywfzr        | string     |       | 主系统业务负责人                                    |
-- | zxtdydjsjl      | decimal    |       | 主系统对应的技术经理                                  |
-- | glxtjsjl        | decimal    |       | 关联系统对应的技术经理                                 |
-- | sfdr            | decimal    |       | 是否导入                                        |
-- | zyxt1           | string     |       | 主系统                                         |
-- | glxt1           | string     |       | 关联系统                                        |
-- | jsoninfo        | string     |       | 创建失败信息                                      |
-- | jgyq            | string     |       | 痛点、根因/监管要求                                  |
-- | jc              | string     |       | 举措                                          |
-- | sshl            | string     |       | 所属行类                                        |
-- | duorenli        | string     |       | 多人力                                         |
-- | ywlxr1          | string     |       | 关联部门联系人                                     |
-- | xtzgbmfzr       | string     |       | 系统主管部门负责人                                   |
-- | sdxtzgbmfzr     | string     |       | 手动系统主管部门负责人                                 |
-- | sfbj            | decimal    |       | 是否编辑                                        |
-- | zxtdydcpjl      | decimal    |       | 主系统对应的产品经理                                  |
-- | glzd            | string     |       | 关联字段                                        |
-- | sfyz            | decimal    |       | 是否有值                                        |
-- | jcbz            | string     |       | 基础标准                                        |
-- | zbbz            | string     |       | 指标标准                                        |
-- | sjaq            | string     |       | 数据安全                                        |
-- | hs              | string     |       | 核算                                          |
-- | jgbs            | string     |       | 监管报送                                        |
-- | sftg            | string     |       | 是否跳过                                        |
-- | sfgd            | string     |       | 是否归档                                        |
-- | sfcs            | string     |       | 是否初审                                        |
-- | csr             | string     |       | 初审人（不要）                                     |
-- | csr1            | string     |       | 初审人1                                        |
-- | csr2            | string     |       | 初审人2                                        |

--日常需求申请新
-- SELECT
-- 	fm.requestid,
-- 	fm.xqbh AS 需求编号,
-- 	fm.xqmc AS 需求名称,
-- 	--hr.loginid || ' ' || hr.lastname AS 申请人姓名,
-- 	concat(hr.loginid,'-',hr.lastname)
-- 	hd.departmentmark AS 申请人部门,
-- 	fm.sqsj AS 申请日期,
-- --需求实施方式
-- 	it.systemname AS 主系统,
-- 	ff.systemname AS 关联系统,
-- --紧急程度
-- --专业部门
-- --主题组
-- 	(select ws.selectname from workflow_selectitem ws where ws.fieldid = '192328' and to_char(selectvalue) = fm.xqly)	 需求来源,
-- 	--hr2.loginid || ' ' || hr2.lastname AS 技术经理,
-- 	--hr3.loginid || ' ' || hr3.lastname AS 产品经理,
-- 	concat(hr2.loginid,'-',hr2.lastname) as 技术经理,
-- 	concat(hr3.loginid,'-',hr3.lastname) as 产品经理,
-- 	(select ws.selectname from edw.oadb_workflow_selectitem ws where ws.fieldid = '192298' and to_char(selectvalue) = fm_dt1.yjzb)	 一级指标,
-- 	(select ws.selectname from edw.oadb_workflow_selectitem ws where ws.fieldid = '192299' and to_char(selectvalue) = fm_dt1.ejzb)	 二级指标,
-- 	(select ws.selectname from edw.oadb_workflow_selectitem ws where ws.fieldid = '192300' and to_char(selectvalue) = fm_dt1.jzzb)	 价值指标,
-- 	fm_dt1.zbkj as 价值指标口径,
-- 	fm_dt1.jxz as 基线值,
-- 	fm_dt1.mbz as 目标值,
-- 	fm_dt1.dcsj as 达成时间,
-- 	fm.td as 痛点、根因、监管要求,
-- 	fm.jzmbdcjc as 举措
-- FROM
-- 	edw.oadb_formtable_main_634 fm
-- 	left JOIN edw.oadb_hrmresource hr ON hr.ID = fm.sqr
-- 	left JOIN edw.oadb_hrmdepartment hd ON hd.ID = fm.sqbm
-- 	left JOIN edw.oadb_itms_system it ON it.systemid = fm.zyxt
-- 	left JOIN edw.oadb_Matrixtable_55 mt ON mt.systemname = fm.zyxt
-- 	left join edw.oadb_formtable_main_634_dt1 fm_dt1 on fm_dt1.mainid = fm.id
-- 	left join edw.oadb_hrmresource hr2 on hr2.id = fm.jsjl
-- 	left join edw.oadb_hrmresource hr3 on hr3.id = fm.cpjl
-- 	left JOIN (
-- 	SELECT
-- 		requestid,
-- 		--string_agg ( h3.systemname || '', ',' ) systemname
-- 		,WM_CONCAT('||', h3.systemname) systemname
-- 	FROM
-- 		( SELECT A.requestid,
-- 		         ,A.glxt1
--                          ,glxt_1
-- 		     FROM    edw.oadb_formtable_main_634 A LATERAL VIEW explode(split(A.glxt1, ',')) glxt1 AS glxt_1
-- 			 WHERE A.glxt <> '' ) fm2
-- 	LEFT JOIN edw.oadb_itms_system h3 ON h3.systemid = fm2.glxt
-- 	GROUP BY requestid
-- 	) ff ON ff.requestid = fm.requestid
-- WHERE
-- 	fm.sqsj > '2021-01-01'

-- ;

-- DESC edw.oadb_formtable_main_634
**01-数据需求_总行计财_SJ2024081506_绍兴分行_张莉_贷款账户交易明细.sql
-- 数据截止日8月15日，请根据附件中&ldquo;贷款借据号&rdquo;，拉取7月18日-8月15日这段时间对客催收回来的金额归还了多少应收欠息和催收欠息。


DROP TABLE IF EXISTS tmp_zl_SJ2024081506 PURGE;

CREATE TABLE IF NOT EXISTS lab_risk_dev.tmp_zl_SJ2024081506 AS
SELECT  b.col_1 贷款账号
        ,b.col_2 贷款借据号
        ,b.col_3 合同编号
        ,b.col_4 客户号
        ,b.col_5 客户名称
        ,b.col_6 还款账号
        ,b.col_7 营业机构
        ,a.jiaoyirq 交易日期
        ,a.jiaoyifx AS 交易方向
        ,a.jiaoyije 交易金额
        ,a.yuezdshm 余额说明
FROM    qbi_file_20240815_14_51_26 b
LEFT JOIN    edw.core_klnl_dkzhmx a --贷款账户交易明细表
ON      b.COL_2 = a.dkjiejuh
AND     a.dt <= '@@{yyyyMMdd}'
AND     a.dt >= '20240718'
AND     a.jiaoyirq >= '20240718'
AND     a.jiaoyirq <= '@@{yyyyMMdd}'
AND     a.jiaoyifx = '1' --减少
AND     ( a.yuezdshm LIKE '应收欠息%'
    OR a.yuezdshm LIKE '催收欠息%' )
WHERE   b.pt = MAX_PT('qbi_file_20240815_14_51_26');
**01-数据需求_总行计财_SJ2024082201_绍兴分行_张莉_贷款账户交易明细.sql
-- 数据截止日8月22日，请根据附件中&ldquo;贷款借据号&rdquo;，拉取7月18日-8月22日期间收回的应收欠息和催收欠息。


DROP TABLE IF EXISTS lab_risk_dev.tmp_zl_SJ2024082201 PURGE;

CREATE TABLE IF NOT EXISTS lab_risk_dev.tmp_zl_SJ2024082201 AS
SELECT  b.col_1 贷款账号
        ,b.col_2 贷款借据号
        ,b.col_3 合同编号
        ,b.col_4 客户号
        ,b.col_5 客户名称
        ,b.col_6 还款账号
        ,b.col_7 营业机构
        ,a.trx_dt 交易日期
        ,a.trx_dir AS 交易方向
        ,a.trx_amt 交易金额
        ,a.bal_fld_cmt 余额说明
FROM    lab_risk_dev.qbi_file_20240815_14_51_26 b
LEFT JOIN    app_ado.view_dwd_bus_loan_act_trx_dtl_di_3307 a --贷款账户交易明细表
ON      b.COL_2 = a.loan_dbil_id
AND     a.dt <= '@@{yyyyMMdd}'
AND     a.dt >= '20240718'
AND     a.trx_dt >= '20240718'
AND     a.trx_dt <= '@@{yyyyMMdd}'
AND     a.trx_dir = '1' --减少
AND     ( a.bal_fld_cmt LIKE '应收欠息%'
    OR a.bal_fld_cmt LIKE '催收欠息%' )
WHERE   b.pt = MAX_PT('lab_risk_dev.qbi_file_20240815_14_51_26');
**01-数据需求_总行计财_SJ20241009161_郑城城_新采购系统中总行PO明细_1_11月__copy.sql
--SJ20250102201，新采购系统中总行PO明细(1-12月)




DROP TABLE if EXISTS  tmp_wsj_zcc_1231_01;
CREATE TABLE IF NOT EXISTS tmp_wsj_zcc_1231_01 as
select (case t1.bplx when 1 then '自行采购结果报批'when 2 then '框架物资采购结果报批' when 3 then '集中采购结果报批' when 4 then '框架合同签订结果报批' when 5 then '电子目录平台结果报批' end) 结果报批类型,
t1.bpbh 结果报批编号,
t1.bpmc 结果报批名称,
t1.jgbpje 结果报批金额,
(case t1.zt when 0 then '正常' when 1 then '变更中' when 2 then '变更审批' when 3 then '变更完成' when 4 then '已关闭' when 5 then '已退回' end) 状态,
t1.gbyy 关闭原因,
org.brc_org_nm 上级机构,
t1.zzid ,
t1.zzmc 汇报机构,
t1.bmid,
t1.bmmc 汇报部门,
t1.qcrmc 创建人,
substr(t1.cjsj,1,8) 创建时间,
t1.gysmc 中标供应商名称,
t5.ztdm  中标供应商编号,
t4.sqdbh 申请单编号,
t2.hh 行号,
t2.cgml 采购目录编码,
t2.cgmlmc 采购目录名称,
t2.wpytbh 物品用途编码,
t2.wpytmc 物品用途名称,
t2.bxlxbh 报销类型编号,
t2.bxlxmc 报销类型名称,
t2.yskmbh 预算科目编号,
t2.yskmmc 预算科目名称,
t2.ysxmbh 预算项目编号,
t2.ysxmmc 预算项目名称,
t2.dj 单价,
t2.cgsl 采购数量,
t2.ys 预算金额,
(case t4.zt when 0 then '初始化' when 3 then '已退回' when 5 then '审批中' when 10 then '审批完成' when -1 then '已终止' end) 申请单状态,
(case t2.xmzt when 0 then '待处理' when 1 then '部分处理' when 2 then '已处理' when 3 then '已完结' when 4 then '已关闭' end ) 明细行状态,
t2.yy 完结关闭原因 ,
t3.spmc 商品名称,
t3.ppmc 品牌,
t3.ggxh 规格型号,
t3.dj 采购单价,
t3.cgsl 数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1
inner join edw.epms_xm_jgbp_spxx t3
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'
inner join edw.epms_wt_sqdmx  t2
on  t3.sqdmx = t2.id and t2.dt='@@{yyyyMMdd}'
inner join edw.epms_wt_cgsqd  t4
on t2.sqdbh = t4.id  and t4.dt='@@{yyyyMMdd}'
left join edw.epms_jc_ztbzt t5
on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
and t1.CJSJ >'20231231235959'
AND t1.cjsj < '20241231000000'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and t1.bplx<>5
and t1.zzid='990000000'
order by t1.bpbh;



DROP TABLE if EXISTS  tmp_wsj_zcc_1231_02;
CREATE TABLE IF NOT EXISTS tmp_wsj_zcc_1231_02 as
select (case t1.bplx when 1 then '自行采购结果报批' when 2 then '框架物资采购结果报批' when 3 then '集中采购结果报批' when 4 then '框架合同签订结果报批' when 5 then '电子目录平台结果报批' end) 结果报批类型,
t1.bpbh 结果报批编号,
t1.bpmc 结果报批名称,
t1.jgbpje 结果报批金额,
 (case t1.zt when 0 then '正常' when 1 then '变更中' when 2 then '变更审批' when 3 then '变更完成' when 4 then '已关闭' when 5 then '已退回' end) 状态,
 t1.gbyy 关闭原因,
org.brc_org_nm 上级机构,
 t1.zzid ,
 t1.zzmc 汇报机构,
 t1.bmid,t1.bmmc 汇报部门,
 t1.qcrmc 创建人,
substr(t1.cjsj,1,8) 创建时间,
 t1.gysmc 中标供应商名称,
t5.ztdm  中标供应商编号,
t1.ywbh 申请单编号,
'' 行号,
t3.cgml 采购目录编码,
t3.cgmlmc 采购目录名称,
t3.wpytbh 物品用途编码,
t3.wpytmc 物品用途名称,
t3.bxlxbh 报销类型编号,
t3.bxlxmc 报销类型名称,
t3.yskmbh 预算科目编号,
t3.yskmmc 预算科目名称,
t3.ysxmbh 预算项目编号,
t3.ysxmmc 预算项目名称,
t3.dj 单价,
t3.cgsl 采购数量,
t3.cgje 预算金额,
(case  T12.status when 0 then '未审核' when 5 then '下单失败' when 10 then '审核中' when 15 then '已下单' when 20 then '供应商拒单' when 25 then '供应商已接收' when 30 then '供应商已发货' when 32 then '拒签收' when 35 then '已签收' when 45 then '已验收' when 50 then '已开票' when 55 then '已撤单' when 60 then '已支付' when -99 then '已删除'  end) 申请单状态,
'' 行明细状态,
'' 关闭完结原因,
t3.spmc 商品名称,
t3.ppmc 品牌,
t3.ggxh 规格型号,
t3.dj 采购单价,
t3.cgsl 数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
inner join edw.epms_xm_jgbp_spxx t3
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
left join edw.epms_jc_ztbzt t5
on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and bplx=5 and t1.zzid='990000000'
and t1.CJSJ >'20231231235959'
AND t1.cjsj < '20241231000000'
order by t1.bpbh
;

-- SELECT * from tmp_wsj_zcc_0930_02;
**01-数据需求_总行计财_SJ20241009161_郑城城_新采购系统中总行PO明细_1_9月_.sql
--SJ20241009161，新采购系统中总行PO明细(1-9月)

DROP TABLE if EXISTS  tmp_wsj_zcc_0930_01;
CREATE TABLE IF NOT EXISTS tmp_wsj_zcc_0930_01 as
select (case t1.bplx when 1 then '自行采购结果报批'when 2 then '框架物资采购结果报批' when 3 then '集中采购结果报批' when 4 then '框架合同签订结果报批' when 5 then '电子目录平台结果报批' end) 结果报批类型,
t1.bpbh 结果报批编号,
t1.bpmc 结果报批名称,
t1.jgbpje 结果报批金额,
(case t1.zt when 0 then '正常' when 1 then '变更中' when 2 then '变更审批' when 3 then '变更完成' when 4 then '已关闭' when 5 then '已退回' end) 状态,
t1.gbyy 关闭原因,
org.brc_org_nm 上级机构,
t1.zzid ,
t1.zzmc 汇报机构,
t1.bmid,
t1.bmmc 汇报部门,
t1.qcrmc 创建人,
substr(t1.cjsj,1,8) 创建时间,
t1.gysmc 中标供应商名称,
t5.ztdm  中标供应商编号,
t4.sqdbh 申请单编号,
t2.hh 行号,
t2.cgml 采购目录编码,
t2.cgmlmc 采购目录名称,
t2.wpytbh 物品用途编码,
t2.wpytmc 物品用途名称,
t2.bxlxbh 报销类型编号,
t2.bxlxmc 报销类型名称,
t2.yskmbh 预算科目编号,
t2.yskmmc 预算科目名称,
t2.ysxmbh 预算项目编号,
t2.ysxmmc 预算项目名称,
t2.dj 单价,
t2.cgsl 采购数量,
t2.ys 预算金额,
(case t4.zt when 0 then '初始化' when 3 then '已退回' when 5 then '审批中' when 10 then '审批完成' when -1 then '已终止' end) 申请单状态,
(case t2.xmzt when 0 then '待处理' when 1 then '部分处理' when 2 then '已处理' when 3 then '已完结' when 4 then '已关闭' end ) 明细行状态,
t2.yy 完结关闭原因 ,
t3.spmc 商品名称,
t3.ppmc 品牌,
t3.ggxh 规格型号,
t3.dj 采购单价,
t3.cgsl 数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1
inner join edw.epms_xm_jgbp_spxx t3
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'
inner join edw.epms_wt_sqdmx  t2
on  t3.sqdmx = t2.id and t2.dt='@@{yyyyMMdd}'
inner join edw.epms_wt_cgsqd  t4
on t2.sqdbh = t4.id  and t4.dt='@@{yyyyMMdd}'
left join edw.epms_jc_ztbzt t5
on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
and t1.CJSJ >'20231231235959'
AND t1.cjsj < '20240930000000'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and t1.bplx<>5
and t1.zzid='990000000'
order by t1.bpbh;




DROP TABLE if EXISTS  tmp_wsj_zcc_0930_02;
CREATE TABLE IF NOT EXISTS tmp_wsj_zcc_0930_02 as
select (case t1.bplx when 1 then '自行采购结果报批' when 2 then '框架物资采购结果报批' when 3 then '集中采购结果报批' when 4 then '框架合同签订结果报批' when 5 then '电子目录平台结果报批' end) 结果报批类型,
t1.bpbh 结果报批编号,
t1.bpmc 结果报批名称,
t1.jgbpje 结果报批金额,
 (case t1.zt when 0 then '正常' when 1 then '变更中' when 2 then '变更审批' when 3 then '变更完成' when 4 then '已关闭' when 5 then '已退回' end) 状态,
 t1.gbyy 关闭原因,
org.brc_org_nm 上级机构,
 t1.zzid ,
 t1.zzmc 汇报机构,
 t1.bmid,t1.bmmc 汇报部门,
 t1.qcrmc 创建人,
substr(t1.cjsj,1,8) 创建时间,
 t1.gysmc 中标供应商名称,
t5.ztdm  中标供应商编号,
t1.ywbh 申请单编号,
'' 行号,
t3.cgml 采购目录编码,
t3.cgmlmc 采购目录名称,
t3.wpytbh 物品用途编码,
t3.wpytmc 物品用途名称,
t3.bxlxbh 报销类型编号,
t3.bxlxmc 报销类型名称,
t3.yskmbh 预算科目编号,
t3.yskmmc 预算科目名称,
t3.ysxmbh 预算项目编号,
t3.ysxmmc 预算项目名称,
t3.dj 单价,
t3.cgsl 采购数量,
t3.cgje 预算金额,
(case  T12.status when 0 then '未审核' when 5 then '下单失败' when 10 then '审核中' when 15 then '已下单' when 20 then '供应商拒单' when 25 then '供应商已接收' when 30 then '供应商已发货' when 32 then '拒签收' when 35 then '已签收' when 45 then '已验收' when 50 then '已开票' when 55 then '已撤单' when 60 then '已支付' when -99 then '已删除'  end) 申请单状态,
'' 行明细状态,
'' 关闭完结原因,
t3.spmc 商品名称,
t3.ppmc 品牌,
t3.ggxh 规格型号,
t3.dj 采购单价,
t3.cgsl 数量,
t3.cgje 采购金额
from edw.epms_xm_jgbp  t1
left join edw.dim_hr_org_mng_org_tree_dd org
on     t1.zzid=org.org_id and org.dt='@@{yyyyMMdd}'
inner join edw.epms_xm_jgbp_spxx t3
on t1.id = t3.jgbp and t3.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.emps_e_order T12 --商城订单表
ON      T1.ywid = T12.id
AND     T12.DT = '@@{yyyyMMdd}'
left join edw.epms_jc_ztbzt t5
on t5.id=t1.gysbh  and t5.dt='@@{yyyyMMdd}'
where T1.DT ='@@{yyyyMMdd}'
and  (t1.sfsjqy=0 or t1.sfsjqy is null)
and bplx=5 and t1.zzid='990000000'
and t1.CJSJ >'20231231235959'
AND t1.cjsj < '20240930000000'
order by t1.bpbh
;

-- SELECT * from tmp_wsj_zcc_0930_02;
**01-数据需求_总行计财_温州分行_吴瑞豪_报销单审批流对应各级审批信息.sql
--表未入仓，开发联系许腾，转运维处理
SELECT
cf.FUNCTX &quot;单据类型&quot;,cfb.BILLNO &quot;单据号&quot;,cfb.statusna &quot;单据状态&quot;,c.PROCCD &quot;流程编码&quot;, c.PROCNA &quot;流程名称&quot;, c.TASKND &quot;办理环节编码&quot;,c.TASKNA &quot;办理环节名称&quot;,
IF(d.NODETP = '5', 'zhongTai', case when a.task_id_ is null then a.user_id_ when a.user_id_ is not null then a.user_id_ else b.ASSIGN end) as &quot;办理人工号&quot;,
case when a.task_id_ is null then f.username when a.user_id_ is not null then f.username else e.username end as &quot;办理人名称&quot;,
IF(d.NODETP = '5', null, ppd.deptcode) as &quot;办理机构编码&quot;,
IF(d.NODETP = '5', null, ppd.deptname) as &quot;办理机构名称&quot;,
pd.deptcode &quot;办理部门编码&quot;,
pd.deptname &quot;办理部门名称&quot;,cbp.POSTCD as &quot;办理职位编码&quot;, cbp.POSTNA as &quot;办理职位名称&quot;,
a.message_ &quot;办理意见&quot;,a.time_ as &quot;办理时间&quot;
  FROM edw.infs_act_hi_comment a   --历史注释表
     INNER JOIN edw.infs_sys_wkfw_hibu hibu  --公共平台流程业务表
     ON a.proc_inst_id_ = hibu.procid
     inner join edw.infs_COM_FLOW_BUSS cfb   --流程与单据关联关系表
     on hibu.BUSSTP = cfb.BUSSTP
     inner join AFB_RGST ar   --未入仓
     on cfb.BILLNO = ar.BILLNO
     inner join edw.infs_COM_FUNC cf  --功能定义表
     on cfb.PRCSCD = cf.FUNCNO
     inner JOIN edw.infs_SYS_WKFW_TASK_RELA b  --工作流任务关联表
     ON a.TASK_ID_ = b.TASK_ID
     LEFT JOIN edw.infs_SYS_WKFW_TASK_HIS c  --工作流任务表
     ON a.TASK_ID_ = c.TASK_ID
     LEFT JOIN edw.infs_pcmc_user e  --人员表
     ON b.ASSIGN = e.usercode
     LEFT JOIN edw.infs_pcmc_user f
     ON a.user_id_ = f.usercode
     and hibu.bankcd=f.corpcode
     LEFT JOIN edw.infs_PCMC_DEPT pd   --机构表
     ON b.DEPTCD = pd.deptcode
     LEFT JOIN edw.infs_PCMC_DEPT ppd
     ON ppd.deptcode=b.BRCHCD
     LEFT JOIN edw.infs_COM_FLOW_NODE d   --流程节点配置
     ON d.NODECD = b.TASKND
     left join COM_BRCH_POST cbp   --未入仓
     on cbp.POSTCD = b.POSTCD
 WHERE a.type_='comment'
 and ar.CENTCD like '3305%'
 and date_format(hibu.STARTM ,'%Y%m%d') BETWEEN '20230428' and '20240831'
ORDER BY  a.proc_inst_id_,a.time_ ASC;
**01-数据需求_总行计财_绍兴分行_张莉_用于分析330700605嵊州五部交接后的账户FTP变化情况.sql
--用于分析330700605嵊州五部交接后的账户FTP变化情况，需要附件清单中账户3、4、5月产生的FTP营收日均

--数据截止日期5月31日，请根据附件中的交接账号/借据号/卡号、主账号、客户号、产品编号等信息，拉取3、4、5月产生的FTP营收日均
--app_iftp.adm_papp_ftp_eva_rpt_fact_ftp_cst_a14
--APP_IFTP.ADM_PAPP_FTP_EVA_ACCT_SUMM_RST_INF  --存贷款客户账户级汇总数据信息表

--jjqd_sanjie_0614  --存贷

DROP TABLE if EXISTS cundaiftp_SJ2024061381_202403 purge;
CREATE TABLE IF NOT EXISTS cundaiftp_SJ2024061381_202403 as
SELECT  T.col_1 交接日期
        ,T.col_2 交接账号_借据号_卡号
        ,T.col_3 主账号
        ,T.col_4 客户号
        ,T.col_5 客户名称
        ,T.col_6 个人有效标识
        ,T.col_7 团队有效标识
        ,T.col_8 支行有效标识
        ,T.col_9 管户比例
        ,T.col_10 产品编号
        ,T.col_11 产品名称
        ,T.col_12 交出人工号
        ,T.col_13 交出人姓名
        ,T.col_14 交出人员工类别
        ,T.col_15 账户转出机构号
        ,T.col_16 账户转出机构名称
        ,T.col_17 账户转出支行机构号
        ,T.col_18 账户转出支行机构名称
        ,T.col_19 接手人工号
        ,T.col_20 接手人姓名
        ,T.col_21 接手人员工类别
        ,T.col_22 账户转入机构号
        ,T.col_23 账户转入机构名称
        ,T.col_24 账户转入支行机构号
        ,T.col_25 账户转入支行机构名称
        ,T.col_26 当月ftp营收日均
        ,T.col_27 交接前3月ftp营收日均
        ,T.col_28 交接ftp影响值_个人
        ,T.col_29 交接ftp影响值_团队
        ,T.col_30 交接ftp影响值_支行
        ,T.col_31 当月eva日均
        ,T.col_32 交接前3月eva日均
        ,T.col_33 交接eva影响值_个人
        ,T.col_34 交接eva影响值_团队
        ,T.col_35 交接eva影响值_支行
        ,T.col_36 交接前三月规模日均
        ,T.col_37 交出人初始调整系数
        ,T.col_38 接手人初始调整系数
        ,T.col_39 特殊调节次数
        ,T.col_40 第一次特殊调整日期
        ,T.col_41 第一次交出人调节系数
        ,T.col_42 第一次接手人调节系数
        ,T.col_43 第二次特殊调整日期
        ,T.col_44 第二次交出人调节系数
        ,T.col_45 第二次接手人调节系数
        ,T.col_46 数据状态
        ,T.col_47 计奖账户类型
        ,T.col_48 考核账户类型
        ,T.col_49 记奖中断标识
        ,T.col_50 交接前记奖中断标识
        ,T.col_51 交出人推荐分成比例
        ,T.col_52 接手人推荐分成比例
        ,T.col_53 交接当月规模日均
        ,T.col_54 机构当月EVA营收日均
        ,T.col_55 机构交接前3月EVA营收日均
        ,T.col_56 机构账户交接EVA影响值
        ,sum_org_ftp_bus_inc / 31 3月FTP营收日均
FROM    lab_bigdata_dev.jjqd_sanjie_0614 T
LEFT JOIN    (
                 SELECT  acct_no
                         ,sum(org_ftp_bus_inc) AS sum_org_ftp_bus_inc
                 FROM    APP_IFTP.ADM_PAPP_FTP_EVA_ACCT_SUMM_RST_INF  --存贷款客户账户级汇总数据信息表
                 WHERE dt = '20240331'
                 AND  freq_dt = 'M' --月
                 AND  assess_org_cd LIKE '3307%' --绍兴分行
                 GROUP BY acct_no
             ) T1
ON      T.COL_2 = T1.acct_no
WHERE   T.pt = MAX_PT('jjqd_sanjie_0614');


DROP TABLE if EXISTS cundaiftp_SJ2024061381_202404 purge;
CREATE TABLE IF NOT EXISTS cundaiftp_SJ2024061381_202404 as
SELECT  T.col_1 交接日期
        ,T.col_2 交接账号_借据号_卡号
        ,T.col_3 主账号
        ,T.col_4 客户号
        ,T.col_5 客户名称
        ,T.col_6 个人有效标识
        ,T.col_7 团队有效标识
        ,T.col_8 支行有效标识
        ,T.col_9 管户比例
        ,T.col_10 产品编号
        ,T.col_11 产品名称
        ,T.col_12 交出人工号
        ,T.col_13 交出人姓名
        ,T.col_14 交出人员工类别
        ,T.col_15 账户转出机构号
        ,T.col_16 账户转出机构名称
        ,T.col_17 账户转出支行机构号
        ,T.col_18 账户转出支行机构名称
        ,T.col_19 接手人工号
        ,T.col_20 接手人姓名
        ,T.col_21 接手人员工类别
        ,T.col_22 账户转入机构号
        ,T.col_23 账户转入机构名称
        ,T.col_24 账户转入支行机构号
        ,T.col_25 账户转入支行机构名称
        ,T.col_26 当月ftp营收日均
        ,T.col_27 交接前3月ftp营收日均
        ,T.col_28 交接ftp影响值_个人
        ,T.col_29 交接ftp影响值_团队
        ,T.col_30 交接ftp影响值_支行
        ,T.col_31 当月eva日均
        ,T.col_32 交接前3月eva日均
        ,T.col_33 交接eva影响值_个人
        ,T.col_34 交接eva影响值_团队
        ,T.col_35 交接eva影响值_支行
        ,T.col_36 交接前三月规模日均
        ,T.col_37 交出人初始调整系数
        ,T.col_38 接手人初始调整系数
        ,T.col_39 特殊调节次数
        ,T.col_40 第一次特殊调整日期
        ,T.col_41 第一次交出人调节系数
        ,T.col_42 第一次接手人调节系数
        ,T.col_43 第二次特殊调整日期
        ,T.col_44 第二次交出人调节系数
        ,T.col_45 第二次接手人调节系数
        ,T.col_46 数据状态
        ,T.col_47 计奖账户类型
        ,T.col_48 考核账户类型
        ,T.col_49 记奖中断标识
        ,T.col_50 交接前记奖中断标识
        ,T.col_51 交出人推荐分成比例
        ,T.col_52 接手人推荐分成比例
        ,T.col_53 交接当月规模日均
        ,T.col_54 机构当月EVA营收日均
        ,T.col_55 机构交接前3月EVA营收日均
        ,T.col_56 机构账户交接EVA影响值
        ,sum_org_ftp_bus_inc / 30 4月FTP营收日均
FROM    lab_bigdata_dev.jjqd_sanjie_0614 T
LEFT JOIN    (
                 SELECT  acct_no
                         ,sum(org_ftp_bus_inc) AS sum_org_ftp_bus_inc
                 FROM    APP_IFTP.ADM_PAPP_FTP_EVA_ACCT_SUMM_RST_INF  --存贷款客户账户级汇总数据信息表
                 WHERE dt = '20240430'
                 AND  freq_dt = 'M' --月
                 AND  assess_org_cd LIKE '3307%' --绍兴分行
                 GROUP BY acct_no
             ) T1
ON      T.COL_2 = T1.acct_no
WHERE   T.pt = MAX_PT('jjqd_sanjie_0614');

DROP TABLE if EXISTS cundaiftp_SJ2024061381_202405 purge;
CREATE TABLE IF NOT EXISTS cundaiftp_SJ2024061381_202405 as
SELECT  T.col_1 交接日期
        ,T.col_2 交接账号_借据号_卡号
        ,T.col_3 主账号
        ,T.col_4 客户号
        ,T.col_5 客户名称
        ,T.col_6 个人有效标识
        ,T.col_7 团队有效标识
        ,T.col_8 支行有效标识
        ,T.col_9 管户比例
        ,T.col_10 产品编号
        ,T.col_11 产品名称
        ,T.col_12 交出人工号
        ,T.col_13 交出人姓名
        ,T.col_14 交出人员工类别
        ,T.col_15 账户转出机构号
        ,T.col_16 账户转出机构名称
        ,T.col_17 账户转出支行机构号
        ,T.col_18 账户转出支行机构名称
        ,T.col_19 接手人工号
        ,T.col_20 接手人姓名
        ,T.col_21 接手人员工类别
        ,T.col_22 账户转入机构号
        ,T.col_23 账户转入机构名称
        ,T.col_24 账户转入支行机构号
        ,T.col_25 账户转入支行机构名称
        ,T.col_26 当月ftp营收日均
        ,T.col_27 交接前3月ftp营收日均
        ,T.col_28 交接ftp影响值_个人
        ,T.col_29 交接ftp影响值_团队
        ,T.col_30 交接ftp影响值_支行
        ,T.col_31 当月eva日均
        ,T.col_32 交接前3月eva日均
        ,T.col_33 交接eva影响值_个人
        ,T.col_34 交接eva影响值_团队
        ,T.col_35 交接eva影响值_支行
        ,T.col_36 交接前三月规模日均
        ,T.col_37 交出人初始调整系数
        ,T.col_38 接手人初始调整系数
        ,T.col_39 特殊调节次数
        ,T.col_40 第一次特殊调整日期
        ,T.col_41 第一次交出人调节系数
        ,T.col_42 第一次接手人调节系数
        ,T.col_43 第二次特殊调整日期
        ,T.col_44 第二次交出人调节系数
        ,T.col_45 第二次接手人调节系数
        ,T.col_46 数据状态
        ,T.col_47 计奖账户类型
        ,T.col_48 考核账户类型
        ,T.col_49 记奖中断标识
        ,T.col_50 交接前记奖中断标识
        ,T.col_51 交出人推荐分成比例
        ,T.col_52 接手人推荐分成比例
        ,T.col_53 交接当月规模日均
        ,T.col_54 机构当月EVA营收日均
        ,T.col_55 机构交接前3月EVA营收日均
        ,T.col_56 机构账户交接EVA影响值
        ,sum_org_ftp_bus_inc / 31 5月FTP营收日均
FROM    lab_bigdata_dev.jjqd_sanjie_0614 T
LEFT JOIN    (
                 SELECT  acct_no
                         ,sum(org_ftp_bus_inc) AS sum_org_ftp_bus_inc
                 FROM    APP_IFTP.ADM_PAPP_FTP_EVA_ACCT_SUMM_RST_INF  --存贷款客户账户级汇总数据信息表
                 WHERE dt = '20240531'
                 AND  freq_dt = 'M' --月
                 AND  assess_org_cd LIKE '3307%' --绍兴分行
                 GROUP BY acct_no
             ) T1
ON      T.COL_2 = T1.acct_no
WHERE   T.pt = MAX_PT('jjqd_sanjie_0614')
;

---结果表：存贷-交接FTP营收日均
DROP TABLE IF EXISTS cundaiftp_SJ2024061381_01 PURGE;

CREATE TABLE IF NOT EXISTS cundaiftp_SJ2024061381_01 AS
SELECT DISTINCT T.交接日期
        ,T.交接账号_借据号_卡号
        ,T.主账号
        ,T.客户号
        ,T.客户名称
        ,T.个人有效标识
        ,T.团队有效标识
        ,T.支行有效标识
        ,T.管户比例
        ,T.产品编号
        ,T.产品名称
        ,T.交出人工号
        ,T.交出人姓名
        ,T.交出人员工类别
        ,T.账户转出机构号
        ,T.账户转出机构名称
        ,T.账户转出支行机构号
        ,T.账户转出支行机构名称
        ,T.接手人工号
        ,T.接手人姓名
        ,T.接手人员工类别
        ,T.账户转入机构号
        ,T.账户转入机构名称
        ,T.账户转入支行机构号
        ,T.账户转入支行机构名称
        ,T.当月ftp营收日均
        ,T.交接前3月ftp营收日均
        ,T.交接ftp影响值_个人
        ,T.交接ftp影响值_团队
        ,T.交接ftp影响值_支行
        ,T.当月eva日均
        ,T.交接前3月eva日均
        ,T.交接eva影响值_个人
        ,T.交接eva影响值_团队
        ,T.交接eva影响值_支行
        ,T.交接前三月规模日均
        ,T.交出人初始调整系数
        ,T.接手人初始调整系数
        ,T.特殊调节次数
        ,T.第一次特殊调整日期
        ,T.第一次交出人调节系数
        ,T.第一次接手人调节系数
        ,T.第二次特殊调整日期
        ,T.第二次交出人调节系数
        ,T.第二次接手人调节系数
        ,T.数据状态
        ,T.计奖账户类型
        ,T.考核账户类型
        ,T.记奖中断标识
        ,T.交接前记奖中断标识
        ,T.交出人推荐分成比例
        ,T.接手人推荐分成比例
        ,T.交接当月规模日均
        ,T.机构当月EVA营收日均
        ,T.机构交接前3月EVA营收日均
        ,T.机构账户交接EVA影响值
        ,T.3月FTP营收日均
        ,T1.4月FTP营收日均
        ,T2.5月FTP营收日均
FROM    cundaiftp_SJ2024061381_202403 T
INNER  JOIN    cundaiftp_SJ2024061381_202404 T1
ON      T.交接账号_借据号_卡号 = T1.交接账号_借据号_卡号
inner JOIN    cundaiftp_SJ2024061381_202405 T2
ON      T.交接账号_借据号_卡号 = T2.交接账号_借据号_卡号;


--财富交接中收数据
--jiaojie_caifu_0614 导入的财富表

DROP TABLE if EXISTS caifuzs_SJ2024061381_202403 purge;
CREATE TABLE if not EXISTS caifuzs_SJ2024061381_202403 as
SELECT  substr(P.COL_1,1,10) 交接日期
        ,P.COL_2 交接账号_借据号_卡号
        ,P.COL_3 主账号
        ,P1.pd_cd 财富产品编码
        ,P.COL_4 客户号
        ,P.COL_5 客户名称
        ,P.COL_6 个人有效标识
        ,P.COL_7 团队有效标识
        ,P.COL_8 支行有效标识
        ,P.COL_9 管户比例
        ,P.COL_10 产品编号
        ,P.COL_11 产品名称
        ,P.COL_12 交出人工号
        ,P.COL_13 交出人姓名
        ,P.COL_14 交出人员工类别
        ,P.COL_15 账户转出机构号
        ,P.COL_16 账户转出机构名称
        ,P.COL_17 账户转出支行机构号
        ,P.COL_18 账户转出支行机构名称
        ,P.COL_19 接手人工号
        ,P.COL_20 接手人姓名
        ,P.COL_21 接手人员工类别
        ,P.COL_22 账户转入机构号
        ,P.COL_23 账户转入机构名称
        ,P.COL_24 账户转入支行机构号
        ,P.COL_25 账户转入支行机构名称
        ,P.COL_26 当月ftp营收日均
        ,P.COL_27 交接前3月ftp营收日均
        ,P.COL_28 交接ftp影响值_个人
        ,P.COL_29 交接ftp影响值_团队
        ,P.COL_30 交接ftp影响值_支行
        ,P.COL_31 当月eva日均
        ,P.COL_32 交接前3月eva日均
        ,P.COL_33 交接eva影响值_个人
        ,P.COL_34 交接eva影响值_团队
        ,P.COL_35 交接eva影响值_支行
        ,P.COL_36 交接前三月规模日均
        ,P.COL_37 交出人初始调整系数
        ,P.COL_38 接手人初始调整系数
        ,P.COL_39 特殊调节次数
        ,P.COL_40 第一次特殊调整日期
        ,P.COL_41 第一次交出人调节系数
        ,P.COL_42 第一次接手人调节系数
        ,P.COL_43 第二次特殊调整日期
        ,P.COL_44 第二次交出人调节系数
        ,P.COL_45 第二次接手人调节系数
        ,P.COL_46 数据状态
        ,P.COL_47 计奖账户类型
        ,P.COL_48 考核账户类型
        ,P.COL_49 记奖中断标识
        ,P.COL_50 交接前记奖中断标识
        ,P.COL_51 交出人推荐分成比例
        ,P.COL_52 接手人推荐分成比例
        ,P.COL_53 交接当月规模日均
        ,P.COL_54 机构当月EVA营收日均
        ,P.COL_55 机构交接前3月EVA营收日均
        ,P.COL_56 机构账户交接EVA影响值
        ,P1.sum_mid_amt/31 3月中收日均
FROM    jiaojie_caifu_0614 P
LEFT JOIN    (
                 SELECT  A.ori_trx_act_id --原始交易帐号
                         ,A.bnk_act_id --银行账号
                         ,A.pd_cd --产品代码
                         ,sum(A.mid_amt) AS sum_mid_amt
                 FROM    edw.DWS_BUS_CHM_ACT_MGR_INF_DD A
                 WHERE   A.dt <= '20240331'
                 AND     A.dt >= '20240301'
                 AND     A.acs_org_id LIKE '3307%' --绍兴
                 AND     A.mng_typ_cd = '1' --1考核 2销售
                 GROUP BY A.ori_trx_act_id , A.bnk_act_id , A.pd_cd
             ) P1
ON      P.COL_3 = P1.bnk_act_id
WHERE   P.pt = MAX_PT('jiaojie_caifu_0614');


DROP TABLE if EXISTS caifuzs_SJ2024061381_202404 purge;
CREATE TABLE if not EXISTS caifuzs_SJ2024061381_202404 as
SELECT  substr(P.COL_1,1,10) 交接日期
        ,P.COL_2 交接账号_借据号_卡号
        ,P.COL_3 主账号
        ,P1.pd_cd 财富产品编码
        ,P.COL_4 客户号
        ,P.COL_5 客户名称
        ,P.COL_6 个人有效标识
        ,P.COL_7 团队有效标识
        ,P.COL_8 支行有效标识
        ,P.COL_9 管户比例
        ,P.COL_10 产品编号
        ,P.COL_11 产品名称
        ,P.COL_12 交出人工号
        ,P.COL_13 交出人姓名
        ,P.COL_14 交出人员工类别
        ,P.COL_15 账户转出机构号
        ,P.COL_16 账户转出机构名称
        ,P.COL_17 账户转出支行机构号
        ,P.COL_18 账户转出支行机构名称
        ,P.COL_19 接手人工号
        ,P.COL_20 接手人姓名
        ,P.COL_21 接手人员工类别
        ,P.COL_22 账户转入机构号
        ,P.COL_23 账户转入机构名称
        ,P.COL_24 账户转入支行机构号
        ,P.COL_25 账户转入支行机构名称
        ,P.COL_26 当月ftp营收日均
        ,P.COL_27 交接前3月ftp营收日均
        ,P.COL_28 交接ftp影响值_个人
        ,P.COL_29 交接ftp影响值_团队
        ,P.COL_30 交接ftp影响值_支行
        ,P.COL_31 当月eva日均
        ,P.COL_32 交接前3月eva日均
        ,P.COL_33 交接eva影响值_个人
        ,P.COL_34 交接eva影响值_团队
        ,P.COL_35 交接eva影响值_支行
        ,P.COL_36 交接前三月规模日均
        ,P.COL_37 交出人初始调整系数
        ,P.COL_38 接手人初始调整系数
        ,P.COL_39 特殊调节次数
        ,P.COL_40 第一次特殊调整日期
        ,P.COL_41 第一次交出人调节系数
        ,P.COL_42 第一次接手人调节系数
        ,P.COL_43 第二次特殊调整日期
        ,P.COL_44 第二次交出人调节系数
        ,P.COL_45 第二次接手人调节系数
        ,P.COL_46 数据状态
        ,P.COL_47 计奖账户类型
        ,P.COL_48 考核账户类型
        ,P.COL_49 记奖中断标识
        ,P.COL_50 交接前记奖中断标识
        ,P.COL_51 交出人推荐分成比例
        ,P.COL_52 接手人推荐分成比例
        ,P.COL_53 交接当月规模日均
        ,P.COL_54 机构当月EVA营收日均
        ,P.COL_55 机构交接前3月EVA营收日均
        ,P.COL_56 机构账户交接EVA影响值
        ,P1.sum_mid_amt/30 4月中收日均
FROM    jiaojie_caifu_0614 P
LEFT JOIN    (
                 SELECT  A.ori_trx_act_id --原始交易帐号
                         ,A.bnk_act_id --银行账号
                         ,A.pd_cd --产品代码
                         ,sum(A.mid_amt) AS sum_mid_amt
                 FROM    edw.DWS_BUS_CHM_ACT_MGR_INF_DD A
                 WHERE   A.dt <= '20240430'
                 AND     A.dt >= '20240401'
                 AND     A.acs_org_id LIKE '3307%' --绍兴
                 AND     A.mng_typ_cd = '1' --1考核 2销售
                 GROUP BY A.ori_trx_act_id , A.bnk_act_id , A.pd_cd
             ) P1
ON      P.COL_3 = P1.bnk_act_id
WHERE   P.pt = MAX_PT('jiaojie_caifu_0614');


DROP TABLE if EXISTS caifuzs_SJ2024061381_202405 purge;
CREATE TABLE if not EXISTS caifuzs_SJ2024061381_202405 as
SELECT  substr(P.COL_1,1,10) 交接日期
        ,P.COL_2 交接账号_借据号_卡号
        ,P.COL_3 主账号
        ,P1.pd_cd 财富产品编码
        ,P.COL_4 客户号
        ,P.COL_5 客户名称
        ,P.COL_6 个人有效标识
        ,P.COL_7 团队有效标识
        ,P.COL_8 支行有效标识
        ,P.COL_9 管户比例
        ,P.COL_10 产品编号
        ,P.COL_11 产品名称
        ,P.COL_12 交出人工号
        ,P.COL_13 交出人姓名
        ,P.COL_14 交出人员工类别
        ,P.COL_15 账户转出机构号
        ,P.COL_16 账户转出机构名称
        ,P.COL_17 账户转出支行机构号
        ,P.COL_18 账户转出支行机构名称
        ,P.COL_19 接手人工号
        ,P.COL_20 接手人姓名
        ,P.COL_21 接手人员工类别
        ,P.COL_22 账户转入机构号
        ,P.COL_23 账户转入机构名称
        ,P.COL_24 账户转入支行机构号
        ,P.COL_25 账户转入支行机构名称
        ,P.COL_26 当月ftp营收日均
        ,P.COL_27 交接前3月ftp营收日均
        ,P.COL_28 交接ftp影响值_个人
        ,P.COL_29 交接ftp影响值_团队
        ,P.COL_30 交接ftp影响值_支行
        ,P.COL_31 当月eva日均
        ,P.COL_32 交接前3月eva日均
        ,P.COL_33 交接eva影响值_个人
        ,P.COL_34 交接eva影响值_团队
        ,P.COL_35 交接eva影响值_支行
        ,P.COL_36 交接前三月规模日均
        ,P.COL_37 交出人初始调整系数
        ,P.COL_38 接手人初始调整系数
        ,P.COL_39 特殊调节次数
        ,P.COL_40 第一次特殊调整日期
        ,P.COL_41 第一次交出人调节系数
        ,P.COL_42 第一次接手人调节系数
        ,P.COL_43 第二次特殊调整日期
        ,P.COL_44 第二次交出人调节系数
        ,P.COL_45 第二次接手人调节系数
        ,P.COL_46 数据状态
        ,P.COL_47 计奖账户类型
        ,P.COL_48 考核账户类型
        ,P.COL_49 记奖中断标识
        ,P.COL_50 交接前记奖中断标识
        ,P.COL_51 交出人推荐分成比例
        ,P.COL_52 接手人推荐分成比例
        ,P.COL_53 交接当月规模日均
        ,P.COL_54 机构当月EVA营收日均
        ,P.COL_55 机构交接前3月EVA营收日均
        ,P.COL_56 机构账户交接EVA影响值
        ,P1.sum_mid_amt/31 5月中收日均
FROM    jiaojie_caifu_0614 P
LEFT JOIN    (
                 SELECT  A.ori_trx_act_id --原始交易帐号
                         ,A.bnk_act_id --银行账号
                         ,A.pd_cd --产品代码
                         ,sum(A.mid_amt) AS sum_mid_amt
                 FROM    edw.DWS_BUS_CHM_ACT_MGR_INF_DD A
                 WHERE   A.dt <= '20240531'
                 AND     A.dt >= '20240501'
                 AND     A.acs_org_id LIKE '3307%' --绍兴
                 AND     A.mng_typ_cd = '1' --1考核 2销售
                 GROUP BY A.ori_trx_act_id , A.bnk_act_id , A.pd_cd
             ) P1
ON      P.COL_3 = P1.bnk_act_id
WHERE   P.pt = MAX_PT('jiaojie_caifu_0614');

SELECT * FROM caifuzs_SJ2024061381_202405

--财富结果表2
DROP TABLE IF EXISTS caifuzs_SJ2024061381_02 PURGE;

CREATE TABLE IF NOT EXISTS caifuzs_SJ2024061381_02 AS
SELECT  DISTINCT T.交接账号_借据号_卡号
                 ,T.主账号
                 ,T.财富产品编码
                 ,T.客户号
                 ,T.客户名称
                 ,T.个人有效标识
                 ,T.团队有效标识
                 ,T.支行有效标识
                 ,T.管户比例
                 ,T.产品编号
                 ,T.产品名称
                 ,T.交出人工号
                 ,T.交出人姓名
                 ,T.交出人员工类别
                 ,T.账户转出机构号
                 ,T.账户转出机构名称
                 ,T.账户转出支行机构号
                 ,T.账户转出支行机构名称
                 ,T.接手人工号
                 ,T.接手人姓名
                 ,T.接手人员工类别
                 ,T.账户转入机构号
                 ,T.账户转入机构名称
                 ,T.账户转入支行机构号
                 ,T.账户转入支行机构名称
                 ,T.当月ftp营收日均
                 ,T.交接前3月ftp营收日均
                 ,T.交接ftp影响值_个人
                 ,T.交接ftp影响值_团队
                 ,T.交接ftp影响值_支行
                 ,T.当月eva日均
                 ,T.交接前3月eva日均
                 ,T.交接eva影响值_个人
                 ,T.交接eva影响值_团队
                 ,T.交接eva影响值_支行
                 ,T.交接前三月规模日均
                 ,T.交出人初始调整系数
                 ,T.接手人初始调整系数
                 ,T.特殊调节次数
                 ,T.第一次特殊调整日期
                 ,T.第一次交出人调节系数
                 ,T.第一次接手人调节系数
                 ,T.第二次特殊调整日期
                 ,T.第二次交出人调节系数
                 ,T.第二次接手人调节系数
                 ,T.数据状态
                 ,T.计奖账户类型
                 ,T.考核账户类型
                 ,T.记奖中断标识
                 ,T.交接前记奖中断标识
                 ,T.交出人推荐分成比例
                 ,T.接手人推荐分成比例
                 ,T.交接当月规模日均
                 ,T.机构当月EVA营收日均
                 ,T.机构交接前3月EVA营收日均
                 ,T.机构账户交接EVA影响值
                 ,T.3月中收日均
                 ,T1.4月中收日均
                 ,T2.5月中收日均
FROM    caifuzs_SJ2024061381_202403 T
INNER JOIN    caifuzs_SJ2024061381_202404 T1
ON      T.主账号 = T1.主账号
and T.财富产品编码=T1.财富产品编码
INNER JOIN    caifuzs_SJ2024061381_202405 T2
ON      T.主账号 = T2.主账号
and T.财富产品编码=T2.财富产品编码;
**01-数据需求_总行计财_计财_周敏_取附件所列客户户籍地址_居住地址和工作地址_.sql
--用于台州市税务局现场检查
--取附件所列客户户籍地址、居住地址和工作地址
DROP TABLE IF EXISTS tmp_zm_SJ2024062666 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zm_SJ2024062666 AS
SELECT  T.col_1 客户号
        ,T1.reg_adr 户籍地址
        ,T1.fml_adr 居住地址
        ,T1.wrk_adr 工作地址
FROM    qbi_file_20240626_16_54_55 T
LEFT JOIN    edw.dws_cst_bas_inf_dd T1 --客户基础信息汇总表
ON      T.col_1 = T1.cst_id
AND     T1.dt = '@@{yyyyMMdd}'
WHERE   T.pt = MAX_PT('qbi_file_20240626_16_54_55');

-- SELECT * FROM tmp_zm_SJ2024062666

--SELECT cst_id,phy_adr_typ_cd,ful_adr FROM edw.dim_cst_bas_phy_adr_dtl_dd WHERE dt='@@{yyyyMMdd}' AND  cst_id='1008442241'

--地址类型
-- '050800' 注册地址
--  '050300'通讯地址
--  '050900' 经营地址
--   '050200' 家庭地址
--   '050100' 户籍地址
--    '050400' 工作单位地址
**01-数据需求_总行计财_金华分行_姜嘉慧_客户证件号码.sql
--导入的客户表
--2022年个体工商户，gtgsh_2022
--2022年小微企业主，xwqy_2022
--2023年个体工商户 ，gtgsh_2023
--2023年小微企业主，xwqyz_2023
-- dim_cst_bas_doc_inf_dd  --客户证件信息,'A0100'   --统一社会信用代码;'A0200'   --组织机构代码;'A0500'   --营业执照；--A0400--法人营业执照

--edw.outd_gs_person_main   --工商个人主表
--edw.outd_gs_person_ryposfr  --工商个人-人员法人信息
--edw.outd_gs_person_rypossha  --工商个人-人员股东信息


--********************************第一种渠道，外部数据的表，数据不全******************************************************
--临时表一：作为法人的企业信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_01;

CREATE TABLE lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_01 AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息
                        WHERE   dt <= '@@{yyyyMMdd}' ---------------xt:添加查得标识=1
                        AND     gpr_ifrichard = '1' --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno in_ctfno
                                ,gpr_entname dt_gpr_entname
                                ,gpr_enttype dt_gpr_enttype
                                ,gpr_entstatus dt_gpr_enttype --旧表
                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno --被查询人证件号码
                                                        ,c.gpr_entname --企业(机构)名称
                                                        ,c.gpr_entstatus --企业状态
                                                        ,c.gpr_enttype --企业(机构)类型
                                                        ,c.gpr_creditcode --统一社会信用代码
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为法人的企业信息
                                                WHERE   a.dt <= '@@{yyyyMMdd}'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'
                                            ) aa
                                    WHERE   aa.rn = 1
                                ) cc
                    ) bb
        ) d
WHERE   d.rk = 1
AND     d.dt_gpr_entstatus RLIKE '在营';




---临时表二： 作为股东的企业信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_02;

CREATE TABLE lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_02 AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_fundedratio --投资比例
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposshatd --工商个人替代-人员股东信息
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     REPLACE(dt_gpr_fundedratio, '%', '') >= 40 --占股40%以上
                        AND     gpr_ifrichard = '1' --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno in_ctfno
                                ,gpr_entname dt_gpr_entname
                                ,gpr_enttype dt_gpr_enttype
                                ,gpr_entstatus dt_gpr_entstatus
                                ,gpr_fundedratio dt_gpr_fundedratio
                                ,gpr_creditcode dt_gpr_creditcode
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno
                                                        ,c.gpr_entname
                                                        ,c.gpr_entstatus
                                                        ,c.gpr_enttype
                                                        ,c.gpr_fundedratio
                                                        ,c.gpr_creditcode
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_rypossha c --工商个人-人员股东信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为股东的企业信息
                                                WHERE   a.dt <= '@@{yyyyMMdd}'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'
                                                AND     REPLACE(gpr_fundedratio, '%', '') >= 40  --占股40%以上
                                            ) aa
                                    WHERE   rn = 1
                                ) bb
                    ) aa
        ) B
WHERE   B.rk = 1
AND     B.dt_gpr_entstatus RLIKE '在营';



--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_03;

CREATE TABLE lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_03 AS
SELECT
 distinct T1.清单类型
        ,T1.数据日期
        ,T1.客户号
        ,T1.客户名称
        ,T1.贷款余额折人民币
        ,T3.dt_gpr_creditcode AS 客户对应单位证件号码
        ,T3.dt_gpr_entname    AS 客户对应单位名称
        ,T3.关系类型
FROM (
        SELECT  '2022年个体工商户' AS 清单类型 , col_1 AS 数据日期 ,col_2 AS 客户号 ,col_3 AS 客户名称	,col_4 AS 贷款余额折人民币 FROM gtgsh_2022 WHERE PT <>''
        UNION ALL
        SELECT  '2022年小微企业主' AS 清单类型 , col_1 AS 数据日期 ,col_2 AS 客户号 ,col_3 AS 客户名称	,col_4 AS 贷款余额折人民币 FROM xwqy_2022  WHERE PT <>''
        UNION ALL
        SELECT  '2023年个体工商户' AS 清单类型 , col_1 AS 数据日期 ,col_2 AS 客户号 ,col_3 AS 客户名称	,col_4 AS 贷款余额折人民币 FROM gtgsh_2023 WHERE PT <>''
        UNION ALL
        SELECT  '2023年小微企业主' AS 清单类型 , col_1 AS 数据日期 ,col_2 AS 客户号 ,col_3 AS 客户名称	,col_4 AS 贷款余额折人民币 FROM xwqyz_2023 WHERE PT <>''
      ) T1
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T2 --个人客户基本信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT =  '@@{yyyyMMdd}'
LEFT JOIN  (
            SELECT  A1.in_ctfno
                    ,A1.dt_gpr_entname --企业(机构)名称
                    ,A1.dt_gpr_enttype --企业(机构)类型
                    ,A1.dt_gpr_entstatus --企业状态
                    ,A1.dt_gpr_creditcode --统一社会信用代码
                    ,'客户担任法人企业' 关系类型
            FROM    lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_01 A1 --法人
			WHERE   ( COALESCE(A1.dt_gpr_entname,'')<>'' OR COALESCE(A1.dt_gpr_creditcode,'')<>'' )
            UNION ALL
            SELECT  A1.in_ctfno
                    ,A1.dt_gpr_entname --企业(机构)名称
                    ,A1.dt_gpr_enttype --企业(机构)类型
                    ,A1.dt_gpr_entstatus --企业状态
                    ,A1.dt_gpr_creditcode --统一社会信用代码
                    ,'客户担任股东企业' 关系类型
            FROM    lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_02 A1 --股东
			LEFT   JOIN  lab_bigdata_dev.tmp_kehuzhengjian_20240517_1130_01 A2 --法人
			ON     A1.in_ctfno =A2.in_ctfno
			AND    A1.dt_gpr_creditcode = A2.dt_gpr_creditcode
			WHERE  ( COALESCE(A1.dt_gpr_entname,'')<>'' OR COALESCE(A1.dt_gpr_creditcode,'')<>'' )
			AND     A2.dt_gpr_creditcode IS NULL   --剔除客户担任法人的企业
            ) T3
ON      T2.doc_nbr = T3.in_ctfno
;

--**************第二种渠道，用信贷的表查询，直接查询经营单位信息**********************

SELECT T.customerid 客户号
       ,T.certtype 证件类型
       ,T.certid 证件号码
       ,T.companyname 经营单位名称
FROM edw.loan_customer_operation T --客户经营基本情况表
WHERE T.dt='@@{yyyyMMdd}'
AND     T.certtype IN ( 'A0100' , 'A0500','A0200') --统代或营业执照或组织机构代码证
and T.customerid ='1655009481';

---补充证件号码为空的客户数据

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_kehuzhengjian_20240517SJ2024051656 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_kehuzhengjian_20240517SJ2024051656 AS
SELECT  DISTINCT P.COL_1 清单类型
        ,P.COL_2 数据日期
        ,p.COL_3 客户号
        ,p.COL_4 客户名称
        ,T.certtype 证件类型
        ,T.certid 证件号码
        ,T.companyname 经营单位名称
FROM    qbi_file_20240517_14_37_58 P
LEFT JOIN    edw.loan_customer_operation T --客户经营基本情况表
ON      p.COL_3 = T.customerid
AND     T.dt = '@@{yyyyMMdd}'
AND     T.certtype IN ( 'A0100' , 'A0500','A0200') --统代或营业执照或组织机构代码证
WHERE   P.pt = MAX_PT('qbi_file_20240517_14_37_58')
;

--SELECT * FROM lab_bigdata_dev.tmp_kehuzhengjian_20240517SJ2024051656
**01-数据需求_总行风险_D0511_陆奇_全行抵质押客户合同信息.sql
--用途
-- 1.浙江省银行业协会关于落实浙江省高级人民法院《关于加强风险源头管理防范有担保金融债权不能兑现的司法建议书》的通知要求排查是否有&ldquo;未全面依规办理抵押登记&rdquo;。
-- 2.新信贷系统配置，押品在放款阶段，必须有权利证明为入库状态，但老信贷只对房地产和土地使用权强控了他项权证必须入库，存量押品可能存在权利证明未入库，会影响后续新信贷的放款，考虑是否要提前治理或者放开对老数据的控制

--最新时间点，全行（含村行），担保方式为抵质押的，业务未结清，且押品的权证类型为附件1的码值时的数据清单


--1，先取担保类型为抵质押的业务，业务合同编号、合同金额、合同余额、合同起始日期、合同到期日期、担保合同编号，客户号，管护人，管护机构
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_00 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_00 AS
SELECT  DISTINCT F.busi_ctr_id 业务合同编号
                 ,F.ctr_amt 合同金额
                 ,F.ctr_bal 合同余额
                 ,F.apnt_start_dt 合同起始日期
                 ,F.apnt_mtu_dt 合同到期日期
                 ,B.grnt_ctr_id 担保合同编号
                 ,F.cst_id
                 ,D.acs_mngr_id
                 ,D.acs_org_id
FROM    (
            SELECT  A.busi_ctr_id
                    ,A.cst_id
                    ,A.ctr_amt
                    ,A.ctr_bal
                    ,A.apnt_start_dt
                    ,A.apnt_mtu_dt
            FROM    edw.dim_bus_loan_ctr_inf_dd A --信贷合同
            WHERE   a.dt = '@@{yyyyMMdd}'
            AND     ( A.CTR_BAL > 0 --余额>0
                OR ( A.CTR_BAL = 0
            AND     A.APNT_MTU_DT >= '@@{yyyyMMdd}' --约定到期日期大于等于当前
            AND     NVL(A.FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
            AND     A.END_DT = '18991231' --终结日期=18991231即为合同未终结
) --合同未结清
)
        ) F
left join edw.dwd_bus_loan_ctr_mgr_inf_dd D     --信贷合同管护信息
on F.busi_ctr_id=D.busi_ctr_id
and D.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_grnt_ctr_grnt_ctr_rel_dd B --业务合同担保合同关系
ON      F.busi_ctr_id = B.busi_ctr_id
AND     B.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_grnt_ctr_inf_dd C --担保合同信息
ON      B.grnt_ctr_id = C.grnt_ctr_id
AND     C.dt = '@@{yyyyMMdd}'
where   C.grnt_typ_cd IN ( '020' , '040' )  --担保类型为抵押、质押
;

-- SELECT * from edw.dim_bus_grnt_ctr_inf_dd WHERE dt = '@@{yyyyMMdd}' and grnt_ctr_id='GC2021091300000721'
-- ;


--结果表1
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_01 AS
SELECT  业务合同编号
        ,合同金额
        ,合同余额
        ,合同起始日期
        ,合同到期日期
        ,担保合同编号
FROM    lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_00;

SELECT * FROM lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_01 ;

---结果表2：担保合同编号、管护机构、押品编号、客户编号、管护人工号、权证类型、权证状态
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_02 AS
SELECT  A . *
FROM    (
            SELECT  T.业务合同编号
                    ,T.担保合同编号
                    ,T.cst_id 客户号
                    ,T.acs_mngr_id 管护人ID
                    ,B.empe_nm 管护人名称
                    ,T.acs_org_id 管护机构ID
                    ,C.org_nm 管护机构名称
                    ,t10.cltr_id 押品编号
                    ,t10.wrnt_typ_cd 权证类型ID
                    ,CASE
                       WHEN t10.sts_cd = '01' THEN '未入库'
                       WHEN t10.sts_cd  = '02' THEN '入库'
                       WHEN t10.sts_cd  = '03' THEN '临时出库'
                       WHEN t10.sts_cd  = '04' THEN '释放'
                       WHEN t10.sts_cd  = '05' THEN '待入库'
                       WHEN t10.sts_cd  = '06' THEN '待临时出库'
                       WHEN t10.sts_cd  = '07' THEN '待回库'
                       WHEN t10.sts_cd  = '08' THEN '待释放'
                     END AS 权证状态
            FROM    lab_bigdata_dev.tmp_fxdzydanba_luqi_SJ20240423101_00 T
            LEFT JOIN    edw.dwd_bus_grnt_ctr_grnt_rel_dd t7 --担保合同担保物关系
            ON      T.担保合同编号 = t7.grnt_ctr_id
            AND     t7.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.loan_guaranty_info t8 --担保物信息表
            ON      t7.grnt_id = t8.guarantyid --担保物编号
            AND     t8.dt = '@@{yyyyMMdd}'
            LEFT JOIN    edw.DIM_BUS_GRNT_CLTR_INF_DD t10 --抵质押物信息
            ON      t8.guarantyid = t10.cltr_id
            AND     t10.dt = '@@{yyyyMMdd}'
            left JOIN edw.dim_hr_empe_bas_inf_dd B   --员工信息
            on T.acs_mngr_id=B.empe_id
            and B.dt='@@{yyyyMMdd}'
            left join edw.dim_hr_org_bas_inf_dd C   --机构信息
            on T.acs_org_id=C.org_id
            and C.dt='@@{yyyyMMdd}'
        ) A
WHERE   A.权证类型ID IN ( '43' , '04' , '05' , '17' , '11' , '13' , '15' , '19' , '28' , '27' , '29' , '30' , '31' , '32' , '33' , '34' , '35' , '44' , '45' ) --押品的权证类型为附件1的码值时的数据清单;
;




--码值表，押品类型代码 如01，码值中为1，匹配不出来，需要特殊处理

-- -- LEFT JOIN    edw.dwd_code_library_dd t9 --码值表
-- -- ON      t10.wrnt_typ_cd = t9.cd_val
-- -- AND     t9.tbl_nm = 'DIM_BUS_GRNT_CLTR_INF_DD'    --抵质押物信息
-- -- AND     t9.fld_nm = upper('wrnt_typ_cd')    --押品类型代码
-- -- AND     t9.DT = '@@{yyyyMMdd}'
-- -- ;


-- --edw.loan_guaranty_right t10 --押品权证信息
**01-数据需求_总行风险_D0926_朱燕妮_EAST5.0集团表10月报送.sql
--截止2024年9月末，报送在本行纳入集团授信的客户及授信情况。
--集团客户名称和编号、母公司客户名称和编号、成员客户名称和编号、实控人名称、币种、授信敞口金额、授信敞口余额、集团资产与负债、采集日期


---管护信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20240827_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20240827_02 AS
SELECT  t.cst_id                      AS 客户号
        ,t.cst_nm                     AS 客户名称
        ,b.prm_mgr_id                 AS 主管客户经理工号
        ,b1.empe_nm                   AS 主管客户经理姓名
        ,b.prm_org_id                 AS 主管护机构号
        ,b2.org_nm                    AS 主管护机构名称
        ,cd1.cd_val_dscr              AS 最新更新系统名称
        ,c.last_updated_ts            AS 最新更新时间
        ,cd2.cd_val_dscr              AS 创建源系统名称
        ,substr(d.cust_fol_dt, 1, 10) AS 客户建档日期
FROM    edw.dim_cst_entp_bas_inf_dd t  --企业客户基本信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd b  --客户主管护
ON      t.cst_id = b.cst_id
AND     b.dt = '${yyyyMMdd}'   -- DATE***
LEFT JOIN    edw.dws_hr_empe_inf_dd b1
ON      b1.empe_id = b.prm_mgr_id
AND     b1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dim_hr_org_bas_inf_dd b2
ON      b.prm_org_id = b2.org_id
AND     b2.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.ecif_t00_org_cust_no_rec c
ON      t.cst_id = c.cust_no
AND     c.dt = '${yyyyMMdd}'   -- DATE***
AND     c.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.ecif_t01_org_cust_info d
ON      c.party_id = d.party_id
AND     d.dt = '${yyyyMMdd}'   -- DATE***
AND     d.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.dwd_code_library_dd cd1
ON      c.last_system_id = cd1.cd_val
AND     cd1.tbl_nm = 'KFAB_JYTOZZ'
AND     cd1.fld_nm = 'XITONGBS'
AND     cd1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dwd_code_library_dd cd2
ON      c.init_system_id = cd2.cd_val
AND     cd2.tbl_nm = 'KFAB_JYTOZZ'
AND     cd2.fld_nm = 'XITONGBS'
AND     cd2.dt = '${yyyyMMdd}'
WHERE   t.dt = '${yyyyMMdd}';  -- DATE***



------在我行有业务的客户

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 AS
SELECT  DISTINCT CST_ID
FROM    (
            SELECT  CST_ID
            FROM    edw.dim_bus_dep_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --存款账户信息
            UNION
            SELECT  CST_ID
            FROM    edw.dws_bus_crd_cr_crd_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信用卡账户汇总信息
            UNION
            SELECT  CST_ID
            FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信贷合同信息
            UNION
            SELECT  GTOR_NO AS CST_ID
            FROM    edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(GTOR_NO, '') <> ''
            GROUP BY GTOR_NO
        ) a;



----有未结清的信贷合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_07_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_07_2 AS
SELECT  DISTINCT t1.cst_id  AS customerid
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '${yyyyMMdd}'
WHERE   t1.dt = '${yyyyMMdd}'
AND     T1.PRD_NO <> '2002010101001' --剔除信用卡合同
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08'
    OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date('${yyyyMMdd}', 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 );



--名字带有集团且有未结清合同的企业客户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT AS
SELECT  DISTINCT t.cst_id 客户号
                 ,t.cst_nm 客户名称
                 ,CASE
                    WHEN t2.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END 是否曾发生过业务
                 ,cr.rel_cst_id 实控人客户号
                 ,t4.cst_chn_nm 实控人名称
                 ,t4.ntn_cd 实控人国籍
                 ,t.reg_cpt_ccy 币种
                 ,t3.主管客户经理工号
                 ,t3.主管客户经理姓名
                 ,t3.主管护机构号
                 ,t3.主管护机构名称
                 ,t6.cmn_rsk_ctrl_id 同一风险控制号
                 ,t6.use_crdt_bal 用信余额
                 ,t6.exps_amt 敞口金额
                 ,t6.exps_bal 敞口余额
FROM    edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
INNER JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_07_2 t1 --有未结清合同
ON      t1.customerid = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 t2 -----有业务
ON      t2.cst_id = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw20240827_02 t3  --管护信息
ON      t3.客户号 = t.cst_id
LEFT JOIN    EDW.LOAN_cst_rel cr -- 客户实控人
ON      t.cst_id = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
ON      t.cst_id = t6.cst_id
AND     t6.DT = '${yyyyMMdd}'
WHERE   t.DT = '${yyyyMMdd}' -- DATE***
AND     t.cst_nm RLIKE '集团';



--占股50%以上的为母公司
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_1 AS
SELECT
    A1.csld_crd_cd
   ,A1.shh_nm
   ,A1.shh_typ
   ,A1.ctrb_rto
   ,A3.CST_ID AS 企业客户号
FROM (
       SELECT
            csld_crd_cd
           ,shh_nm
           ,shh_typ
           ,ctrb_rto
           ,RANK() OVER(PARTITION BY csld_crd_cd ORDER BY qry_tm DESC ) AS RN
       FROM edw.dim_cst_out_geb_shh_inf_dd --工商企业股东及出资信息
       WHERE DT = '${yyyyMMdd}'
    ) A1
LEFT JOIN edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON REPLACE(REPLACE(A1.shh_nm,'(','（'),')','）') =  REPLACE(REPLACE(A3.CST_CHN_NM,'(','（'),')','）')
AND A3.DT = '${yyyyMMdd}'
WHERE A1.shh_typ = '企业法人'
AND   REPLACE(A1.ctrb_rto ,'%','') >= 50 ;



--结果表
SELECT * FROM tmp_zhc_fxglb_whw_20240827_08_3_JT_2

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_2 AS
SELECT  T3.shh_nm    AS 母公司名称
        ,T3.企业客户号    AS 母公司客户号
        ,T3.ctrb_rto AS 母公司占股
        ,CASE
           WHEN T5.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END 母公司是否曾发生过业务
        ,cr.rel_cst_id 母公司实控人客户号
        ,t4.cst_chn_nm 母公司实控人名称
        ,t4.ntn_cd 母公司实控人国籍
        ,T1.客户号
        ,T1.客户名称
        ,T1.是否曾发生过业务
        ,T1.实控人客户号
        ,T1.实控人名称
        ,T1.实控人国籍
        ,T1.币种
        ,T1.主管客户经理工号
        ,T1.主管客户经理姓名
        ,T1.主管护机构号
        ,T1.主管护机构名称
        ,T1.同一风险控制号
        ,T1.用信余额
        ,T1.敞口金额
        ,T1.敞口余额
FROM    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_1 T3
ON      T2.DOC_NBR = T3.csld_crd_cd
LEFT JOIN    edw.loan_cst_rel cr -- 客户实控人
ON      T3.企业客户号 = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 T5 -----有业务
ON      T3.企业客户号 = T5.cst_id;




---补充未识别到的敞口金额，敞口余额，只有14个有金额，其他无(是合同已结清或流失原因)

SELECT t6.cst_id 客户号
       ,t6.cst_chn_nm 客户名称
       ,T6.exps_amt 敞口金额
       ,T6.exps_bal 敞口余额
FROM adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
WHERE t6.dt='20240831'
and t6.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2000449779',
'2000564959',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
)
;

SELECT t.cst_id,t.reg_cpt_ccy 币种
FROM  edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
WHERE t.dt='20240831'
and t.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2000449779',
'2000564959',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
);
**01-数据需求_总行风险_D1024_杜威林_湖州分行专项检查_1人为多人担保.sql
-- ODPS SQL
-- **********************************************************************
-- 功能描述:
-- **
-- 创建者: 龙彬彬
-- 创建日期: 2024-10-29 16:23:35
-- **
-- 修改日志:
-- 修改日期          修改人          修改内容
-- **
-- **********************************************************************
**01-数据需求_总行风险_D1101_朱燕妮_EAST5.0集团表11月报送.sql
--截止2024年10月末，报送在本行纳入集团授信的客户及授信情况。集团客户名称和编号、母公司客户名称和编号、成员客户名称和编号、实控人名称、币种、授信敞口金额、授信敞口余额、集团资产与负债、采集日期


---管护信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20241101_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20241101_02 AS
SELECT  t.cst_id                      AS 客户号
        ,t.cst_nm                     AS 客户名称
        ,b.prm_mgr_id                 AS 主管客户经理工号
        ,b1.empe_nm                   AS 主管客户经理姓名
        ,b.prm_org_id                 AS 主管护机构号
        ,b2.org_nm                    AS 主管护机构名称
        ,cd1.cd_val_dscr              AS 最新更新系统名称
        ,c.last_updated_ts            AS 最新更新时间
        ,cd2.cd_val_dscr              AS 创建源系统名称
        ,substr(d.cust_fol_dt, 1, 10) AS 客户建档日期
FROM    edw.dim_cst_entp_bas_inf_dd t  --企业客户基本信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd b  --客户主管护
ON      t.cst_id = b.cst_id
AND     b.dt = '${yyyyMMdd}'   -- DATE***
LEFT JOIN    edw.dws_hr_empe_inf_dd b1
ON      b1.empe_id = b.prm_mgr_id
AND     b1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dim_hr_org_bas_inf_dd b2
ON      b.prm_org_id = b2.org_id
AND     b2.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.ecif_t00_org_cust_no_rec c
ON      t.cst_id = c.cust_no
AND     c.dt = '${yyyyMMdd}'   -- DATE***
AND     c.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.ecif_t01_org_cust_info d
ON      c.party_id = d.party_id
AND     d.dt = '${yyyyMMdd}'   -- DATE***
AND     d.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.dwd_code_library_dd cd1
ON      c.last_system_id = cd1.cd_val
AND     cd1.tbl_nm = 'KFAB_JYTOZZ'
AND     cd1.fld_nm = 'XITONGBS'
AND     cd1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dwd_code_library_dd cd2
ON      c.init_system_id = cd2.cd_val
AND     cd2.tbl_nm = 'KFAB_JYTOZZ'
AND     cd2.fld_nm = 'XITONGBS'
AND     cd2.dt = '${yyyyMMdd}'
WHERE   t.dt = '${yyyyMMdd}';  -- DATE***



------在我行有业务的客户

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241101_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241101_05 AS
SELECT  DISTINCT CST_ID
FROM    (
            SELECT  CST_ID
            FROM    edw.dim_bus_dep_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --存款账户信息
            UNION
            SELECT  CST_ID
            FROM    edw.dws_bus_crd_cr_crd_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信用卡账户汇总信息
            UNION
            SELECT  CST_ID
            FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信贷合同信息
            UNION
            SELECT  GTOR_NO AS CST_ID
            FROM    edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(GTOR_NO, '') <> ''
            GROUP BY GTOR_NO
        ) a;



----有未结清的信贷合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_07_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_07_2 AS
SELECT  DISTINCT t1.cst_id  AS customerid
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '${yyyyMMdd}'
WHERE   t1.dt = '${yyyyMMdd}'
AND     T1.PRD_NO <> '2002010101001' --剔除信用卡合同
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08'
    OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date('${yyyyMMdd}', 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 );



--名字带有集团且有未结清合同的企业客户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT AS
SELECT  DISTINCT t.cst_id 客户号
                 ,t.cst_nm 客户名称
                 ,CASE
                    WHEN t2.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END 是否曾发生过业务
                 ,cr.rel_cst_id 实控人客户号
                 ,t4.cst_chn_nm 实控人名称
                 ,t4.ntn_cd 实控人国籍
                 ,t.reg_cpt_ccy 币种
                 ,t3.主管客户经理工号
                 ,t3.主管客户经理姓名
                 ,t3.主管护机构号
                 ,t3.主管护机构名称
                 ,t6.cmn_rsk_ctrl_id 同一风险控制号
                 ,t6.use_crdt_bal 用信余额
                 ,t6.exps_amt 敞口金额
                 ,t6.exps_bal 敞口余额
FROM    edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
INNER JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_07_2 t1 --有未结清合同
ON      t1.customerid = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241101_05 t2 -----有业务
ON      t2.cst_id = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw20241101_02 t3  --管护信息
ON      t3.客户号 = t.cst_id
LEFT JOIN    EDW.LOAN_cst_rel cr -- 客户实控人
ON      t.cst_id = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
ON      t.cst_id = t6.cst_id
AND     t6.DT = '${yyyyMMdd}'
WHERE   t.DT = '${yyyyMMdd}' -- DATE***
AND     t.cst_nm RLIKE '集团';



--占股50%以上的为母公司
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT_1 AS
SELECT
    A1.csld_crd_cd
   ,A1.shh_nm
   ,A1.shh_typ
   ,A1.ctrb_rto
   ,A3.CST_ID AS 企业客户号
FROM (
       SELECT
            csld_crd_cd
           ,shh_nm
           ,shh_typ
           ,ctrb_rto
           ,RANK() OVER(PARTITION BY csld_crd_cd ORDER BY qry_tm DESC ) AS RN
       FROM edw.dim_cst_out_geb_shh_inf_dd --工商企业股东及出资信息
       WHERE DT = '${yyyyMMdd}'
    ) A1
LEFT JOIN edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON REPLACE(REPLACE(A1.shh_nm,'(','（'),')','）') =  REPLACE(REPLACE(A3.CST_CHN_NM,'(','（'),')','）')
AND A3.DT = '${yyyyMMdd}'
WHERE A1.shh_typ = '企业法人'
AND   REPLACE(A1.ctrb_rto ,'%','') >= 50 ;



--结果表
SELECT * FROM tmp_zhc_fxglb_whw_20241101_08_3_JT_2

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT_2 AS
SELECT  T3.shh_nm    AS 母公司名称
        ,T3.企业客户号    AS 母公司客户号
        ,T3.ctrb_rto AS 母公司占股
        ,CASE
           WHEN T5.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END 母公司是否曾发生过业务
        ,cr.rel_cst_id 母公司实控人客户号
        ,t4.cst_chn_nm 母公司实控人名称
        ,t4.ntn_cd 母公司实控人国籍
        ,T1.客户号
        ,T1.客户名称
        ,T1.是否曾发生过业务
        ,T1.实控人客户号
        ,T1.实控人名称
        ,T1.实控人国籍
        ,T1.币种
        ,T1.主管客户经理工号
        ,T1.主管客户经理姓名
        ,T1.主管护机构号
        ,T1.主管护机构名称
        ,T1.同一风险控制号
        ,T1.用信余额
        ,T1.敞口金额
        ,T1.敞口余额
FROM    lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20241101_08_3_JT_1 T3
ON      T2.DOC_NBR = T3.csld_crd_cd
LEFT JOIN    edw.loan_cst_rel cr -- 客户实控人
ON      T3.企业客户号 = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241101_05 T5 -----有业务
ON      T3.企业客户号 = T5.cst_id;


---补充未识别到的敞口金额，敞口余额，只有14个有金额，其他无(是合同已结清或流失原因)

SELECT t6.cst_id 客户号
       ,t6.cst_chn_nm 客户名称
       ,T6.exps_amt 敞口金额
       ,T6.exps_bal 敞口余额
FROM adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
WHERE t6.dt='20240831'
and t6.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2002941732',
'2000449779',
'2000564959',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
)
;

SELECT t.cst_id,t.reg_cpt_ccy 币种
FROM  edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
WHERE t.dt='20240831'
and t.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2002941732',
'2000449779',
'2000564959',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
);
**01-数据需求_总行风险_D1101_闫政_绍兴分行有余额的信贷有效户_对公出险数据.sql
-- 1.目前我们分行有信贷余额的信贷有效户中没有开对公结算户的有多少数量，占比；
-- 2.开了对公结算户的活期近一年或近6个月日均有多少，目前现金流比率多少，这些客户的出险率多少；
-- 3.没开对公结算户的出险率有多少。
-- 出险率=逾期超过7天的贷款余额/绍兴分行总贷款余额
-- 用这个判断出险率吧，先找出风险贷款，adm_rsk.adm_rsk_apl_inter_all 里的is_rsk_loan是否风险贷款，再用余额公式计算
-- 加上对私
-- SELECT  COUNT(1)                                                 AS 有信贷余额的信贷有效户
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '1' THEN 1 ELSE 0 END)    AS 对私_有信贷余额的信贷有效户
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '2' THEN 1 ELSE 0 END)    AS 对公_有信贷余额的信贷有效户
-- ,COUNT(CASE WHEN T5.cst_id IS NULL THEN T1.cst_id END)                                  AS 未开结算户
-- ,COUNT(CASE WHEN T5.cst_id IS NULL AND T0.CST_TYP_CD = '1' THEN T1.cst_id END)          AS 对私_未开结算户
-- ,COUNT(CASE WHEN T5.cst_id IS NULL AND T0.CST_TYP_CD = '2' THEN T1.cst_id END)          AS 对公_未开结算户
-- ,SUM(T5.活期近180天余额日均)                                             AS 活期近180天余额日均
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '1' THEN T5.活期近180天余额日均 END)      AS 对私_活期近180天余额日均
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '2' THEN T5.活期近180天余额日均 END)      AS 对公_活期近180天余额日均
-- ,SUM(T5.活期近360天余额日均)                                             AS 活期近360天余额日均
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '1' THEN T5.活期近360天余额日均 END)      AS 对私_活期近360天余额日均
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '2' THEN T5.活期近360天余额日均 END)      AS 对公_活期近360天余额日均
-- ,SUM(T4.贷款余额)                                                                         AS 总贷款余额
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '1' THEN T4.贷款余额 END)                                  AS 对私_贷款余额
-- ,SUM(CASE WHEN T0.CST_TYP_CD = '2' THEN T4.贷款余额 END)                                  AS 对公_贷款余额
-- ,SUM(CASE WHEN T5.cst_id IS NOT NULL AND T0.CST_TYP_CD = '1' THEN T6.出险贷款余额 END)    AS 对私_开结算户出险贷款余额
-- ,SUM(CASE WHEN T5.cst_id IS NOT NULL AND T0.CST_TYP_CD = '2' THEN T6.出险贷款余额 END)    AS 对公_开结算户出险贷款余额
-- ,SUM(CASE WHEN T5.cst_id IS NULL AND T0.CST_TYP_CD = '1' THEN T6.出险贷款余额 END)        AS 对私_未开结算户出险贷款余额
-- ,SUM(CASE WHEN T5.cst_id IS NULL AND T0.CST_TYP_CD = '2' THEN T6.出险贷款余额 END)        AS 对公_未开结算户出险贷款余额
-- FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
-- LEFT JOIN    edw.dws_cst_bas_inf_dd T0 --客户基础信息汇总表
-- ON      T1.cst_id = T0.cst_id
-- AND     T0.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T2 --客户集市-基础信息-客户基础标识信息
-- ON      T1.cst_id = T2.cst_id
-- AND     T2.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    (
-- SELECT  A1.cst_id
-- ,SUM(ctr_bal) AS 贷款余额
-- FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
-- WHERE   A1.DT = '@@{yyyyMMdd}'
-- AND     A1.ctr_bal > 0
-- GROUP BY A1.cst_id
-- ) T4
-- ON      T1.cst_id = T4.cst_id
-- LEFT JOIN    (
-- SELECT  cst_id
-- ,SUM(CASE WHEN A1.lbl_prod_typ_cd = '0' THEN A1.last_180_days_gl_bal_acml END) / 180 AS 活期近180天余额日均
-- ,SUM(CASE WHEN A1.lbl_prod_typ_cd = '0' THEN A1.last_360_days_gl_bal_acml END) / 360 AS 活期近360天余额日均
-- FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
-- WHERE   A1.DT = '@@{yyyyMMdd}'
-- AND     A1.stl_act_ind = '1' --结算账户
-- AND     A1.act_sts_cd <> 'C' --未销户
-- GROUP BY cst_id
-- ) T5
-- ON      T1.cst_id = T5.cst_id
-- LEFT JOIN    (
-- SELECT  A1.cst_id
-- ,SUM(dbil_bal_cny) AS 出险贷款余额
-- FROM    adm_rsk.adm_rsk_apl_inter_all A1  --风险集市应用表-资产质量日常监测源表
-- WHERE   A1.DT = '@@{yyyyMMdd}'
-- AND     A1.is_rsk_loan = 'Y'
-- GROUP BY A1.cst_id
-- ) T6
-- ON      T1.cst_id = T6.cst_id
-- WHERE   T1.DT = '@@{yyyyMMdd}'
-- AND     T2.efe_loan_cst_ind = 1 --信贷有效户
-- AND     T4.cst_id IS NOT NULL --有信贷余额
-- AND     SUBSTR(T1.prm_org_id, 1, 4) = '3307' --绍兴分行
-- ;



--绍兴分行所有客户业务信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SHAOXING_JSH_20241112_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_SHAOXING_JSH_20241112_01 AS
SELECT  T1.cst_id           AS 客户号
        ,T1.cst_nm          AS 客户姓名
        ,T0.SAM_RSK_CTRL_ID AS 同一风险控制号
        ,T1.prm_org_id      AS 主管护机构
        ,CASE
           WHEN T0.CST_TYP_CD = '1' THEN '对私'
           WHEN T0.CST_TYP_CD = '2' THEN '对公'
         END                AS 客户类型
        ,CASE
           WHEN T2.efe_loan_cst_ind = '1' THEN '是'
           ELSE '否'
         END                AS 信贷有效户标识
        ,CASE
           WHEN T5.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END                AS 是否开结算户
        ,T5.活期近180天余额日均
        ,T5.活期近360天余额日均
        ,T4.贷款余额
        ,T6.出险贷款余额
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dws_cst_bas_inf_dd T0 --客户基础信息汇总表
ON      T1.cst_id = T0.cst_id
AND     T0.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T2 --客户集市-基础信息-客户基础标识信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(ctr_bal) AS 贷款余额
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.ctr_bal > 0
                 GROUP BY A1.cst_id
             ) T4
ON      T1.cst_id = T4.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(CASE
                                WHEN A1.lbl_prod_typ_cd = '0' THEN A1.last_180_days_gl_bal_acml
                              END) / 180 AS 活期近180天余额日均
                         ,SUM(CASE
                                WHEN A1.lbl_prod_typ_cd = '0' THEN A1.last_360_days_gl_bal_acml
                              END) / 360 AS 活期近360天余额日均
                 FROM    edw.dws_bus_dep_act_inf_dd A1 --存款账户信息汇总
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.stl_act_ind = '1' --结算账户
                 AND     A1.act_sts_cd <> 'C' --未销户
                 GROUP BY cst_id
             ) T5
ON      T1.cst_id = T5.cst_id
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(dbil_bal_cny) AS 出险贷款余额
                 FROM    adm_rsk.adm_rsk_apl_inter_all A1 --风险集市应用表-资产质量日常监测源表
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.is_rsk_loan = 'Y'
                 GROUP BY A1.cst_id
             ) T6
ON      T1.cst_id = T6.cst_id
WHERE   T1.DT = '@@{yyyyMMdd}'
--AND     T2.efe_loan_cst_ind = 1 --信贷有效户
--AND     T4.cst_id IS NOT NULL --有信贷余额
AND     SUBSTR(T1.prm_org_id, 1, 4) = '3307'--绍兴分行
;


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SHAOXING_JSH_20241112_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_SHAOXING_JSH_20241112_02 AS
SELECT
        T1.客户号
        ,T1.客户姓名
        ,T1.同一风险控制号
        ,T1.主管护机构
	,T1.客户类型
        ,T1.信贷有效户标识
        ,T1.是否开结算户
        ,T1.活期近180天余额日均
        ,T1.活期近360天余额日均
        ,T1.贷款余额
        ,T1.出险贷款余额
        ,T2.同一风险控制号_贷款余额
        ,T2.同一风险控制号_出险贷款余额
        ,T2.同一风险控制号_活期近180天余额日均
        ,T2.同一风险控制号_活期近360天余额日均
        ,T2.同一风险控制号_未开结算户客户数
        ,T2.同一风险控制号_未开结算户客户
FROM  lab_bigdata_dev.tmp_SHAOXING_JSH_20241112_01 T1
LEFT JOIN (
            SELECT
                 A1.同一风险控制号
                ,SUM(A1.贷款余额)                                                                     AS 同一风险控制号_贷款余额
                ,SUM(A1.出险贷款余额)                                                                 AS 同一风险控制号_出险贷款余额
                ,SUM(A1.活期近180天余额日均)                                                          AS 同一风险控制号_活期近180天余额日均
                ,SUM(A1.活期近360天余额日均)                                                          AS 同一风险控制号_活期近360天余额日均
                ,sum(CASE WHEN A1.是否开结算户 ='否' THEN 1 else 0 END )                              AS  同一风险控制号_未开结算户客户数
            	,WM_CONCAT(DISTINCT ',' ,CASE WHEN A1.是否开结算户 ='否' THEN A1.客户号 ELSE '' END ) AS 同一风险控制号_未开结算户客户
            FROM  lab_bigdata_dev.tmp_SHAOXING_JSH_20241112_01 A1
            where   A1.同一风险控制号 <> ''
            GROUP BY  A1.同一风险控制号
        ) T2
ON  	T1.同一风险控制号 = T2.同一风险控制号
WHERE T1.信贷有效户标识 = '是'
AND   T1.贷款余额 > 0  ;
**01-数据需求_总行风险_D1104_10月集团客户数据报送.sql
--截止2024年10月末，报送在本行纳入集团授信的客户及授信情况。集团客户名称和编号、母公司客户名称和编号、成员客户名称和编号、实控人名称、币种、授信敞口金额、授信敞口余额、集团资产与负债、采集日期


---管护信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20241104_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20241104_02 AS
SELECT  t.cst_id                      AS 客户号
        ,t.cst_nm                     AS 客户名称
        ,b.prm_mgr_id                 AS 主管客户经理工号
        ,b1.empe_nm                   AS 主管客户经理姓名
        ,b.prm_org_id                 AS 主管护机构号
        ,b2.org_nm                    AS 主管护机构名称
        ,cd1.cd_val_dscr              AS 最新更新系统名称
        ,c.last_updated_ts            AS 最新更新时间
        ,cd2.cd_val_dscr              AS 创建源系统名称
        ,substr(d.cust_fol_dt, 1, 10) AS 客户建档日期
FROM    edw.dim_cst_entp_bas_inf_dd t  --企业客户基本信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd b  --客户主管护
ON      t.cst_id = b.cst_id
AND     b.dt = '${yyyyMMdd}'   -- DATE***
LEFT JOIN    edw.dws_hr_empe_inf_dd b1
ON      b1.empe_id = b.prm_mgr_id
AND     b1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dim_hr_org_bas_inf_dd b2
ON      b.prm_org_id = b2.org_id
AND     b2.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.ecif_t00_org_cust_no_rec c
ON      t.cst_id = c.cust_no
AND     c.dt = '${yyyyMMdd}'   -- DATE***
AND     c.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.ecif_t01_org_cust_info d
ON      c.party_id = d.party_id
AND     d.dt = '${yyyyMMdd}'   -- DATE***
AND     d.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.dwd_code_library_dd cd1
ON      c.last_system_id = cd1.cd_val
AND     cd1.tbl_nm = 'KFAB_JYTOZZ'
AND     cd1.fld_nm = 'XITONGBS'
AND     cd1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dwd_code_library_dd cd2
ON      c.init_system_id = cd2.cd_val
AND     cd2.tbl_nm = 'KFAB_JYTOZZ'
AND     cd2.fld_nm = 'XITONGBS'
AND     cd2.dt = '${yyyyMMdd}'
WHERE   t.dt = '${yyyyMMdd}';  -- DATE***



------在我行有业务的客户

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241104_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241104_05 AS
SELECT  DISTINCT CST_ID
FROM    (
            SELECT  CST_ID
            FROM    edw.dim_bus_dep_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --存款账户信息
            UNION
            SELECT  CST_ID
            FROM    edw.dws_bus_crd_cr_crd_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信用卡账户汇总信息
            UNION
            SELECT  CST_ID
            FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信贷合同信息
            UNION
            SELECT  GTOR_NO AS CST_ID
            FROM    edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(GTOR_NO, '') <> ''
            GROUP BY GTOR_NO
        ) a;



----有未结清的信贷合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_07_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_07_2 AS
SELECT  DISTINCT t1.cst_id  AS customerid
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '${yyyyMMdd}'
WHERE   t1.dt = '${yyyyMMdd}'
AND     T1.PRD_NO <> '2002010101001' --剔除信用卡合同
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08'
    OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date('${yyyyMMdd}', 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 );



--名字带有集团且有未结清合同的企业客户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT AS
SELECT  DISTINCT t.cst_id 客户号
                 ,t.cst_nm 客户名称
                 ,CASE
                    WHEN t2.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END 是否曾发生过业务
                 ,cr.rel_cst_id 实控人客户号
                 ,t4.cst_chn_nm 实控人名称
                 ,t4.ntn_cd 实控人国籍
                 ,t.reg_cpt_ccy 币种
                 ,t3.主管客户经理工号
                 ,t3.主管客户经理姓名
                 ,t3.主管护机构号
                 ,t3.主管护机构名称
                 ,t6.cmn_rsk_ctrl_id 同一风险控制号
                 ,t6.use_crdt_bal 用信余额
                 ,t6.exps_amt 敞口金额
                 ,t6.exps_bal 敞口余额
FROM    edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
INNER JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_07_2 t1 --有未结清合同
ON      t1.customerid = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241104_05 t2 -----有业务
ON      t2.cst_id = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw20241104_02 t3  --管护信息
ON      t3.客户号 = t.cst_id
LEFT JOIN    EDW.LOAN_cst_rel cr -- 客户实控人
ON      t.cst_id = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
ON      t.cst_id = t6.cst_id
AND     t6.DT = '${yyyyMMdd}'
WHERE   t.DT = '${yyyyMMdd}' -- DATE***
AND     t.cst_nm RLIKE '集团';



--占股50%以上的为母公司
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT_1 AS
SELECT
    A1.csld_crd_cd
   ,A1.shh_nm
   ,A1.shh_typ
   ,A1.ctrb_rto
   ,A3.CST_ID AS 企业客户号
FROM (
       SELECT
            csld_crd_cd
           ,shh_nm
           ,shh_typ
           ,ctrb_rto
           ,RANK() OVER(PARTITION BY csld_crd_cd ORDER BY qry_tm DESC ) AS RN
       FROM edw.dim_cst_out_geb_shh_inf_dd --工商企业股东及出资信息
       WHERE DT = '${yyyyMMdd}'
    ) A1
LEFT JOIN edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON REPLACE(REPLACE(A1.shh_nm,'(','（'),')','）') =  REPLACE(REPLACE(A3.CST_CHN_NM,'(','（'),')','）')
AND A3.DT = '${yyyyMMdd}'
WHERE A1.shh_typ = '企业法人'
AND   REPLACE(A1.ctrb_rto ,'%','') >= 50 ;



--结果表
SELECT * FROM tmp_zhc_fxglb_whw_20241104_08_3_JT_2 WHERE 客户号='2001784275';

SELECT * FROM adm_rsk.adm_rsk_apl_sngl_legal_person_authr_crdt_use_crdt_dd WHERE cst_id='2001784275' and dt='20241031';


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT_2 AS
SELECT  T3.shh_nm    AS 母公司名称
        ,T3.企业客户号    AS 母公司客户号
        ,T3.ctrb_rto AS 母公司占股
        ,CASE
           WHEN T5.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END 母公司是否曾发生过业务
        ,cr.rel_cst_id 母公司实控人客户号
        ,t4.cst_chn_nm 母公司实控人名称
        ,t4.ntn_cd 母公司实控人国籍
        ,T1.客户号
        ,T1.客户名称
        ,T1.是否曾发生过业务
        ,T1.实控人客户号
        ,T1.实控人名称
        ,T1.实控人国籍
        ,T1.币种
        ,T1.主管客户经理工号
        ,T1.主管客户经理姓名
        ,T1.主管护机构号
        ,T1.主管护机构名称
        ,T1.同一风险控制号
        ,T1.用信余额
        ,T1.敞口金额
        ,T1.敞口余额
FROM    lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20241104_08_3_JT_1 T3
ON      T2.DOC_NBR = T3.csld_crd_cd
LEFT JOIN    edw.loan_cst_rel cr -- 客户实控人
ON      T3.企业客户号 = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20241104_05 T5 -----有业务
ON      T3.企业客户号 = T5.cst_id;


---补充未识别到的敞口金额，敞口余额，只有14个有金额，其他无(是合同已结清或流失原因)

SELECT t6.cst_id 客户号
       ,t6.cst_chn_nm 客户名称
       ,T6.exps_amt 敞口金额
       ,T6.exps_bal 敞口余额
FROM adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
WHERE t6.dt='20240831'
and t6.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2000449779',
'2000564959',
'2608740841',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
)
;

SELECT t.cst_id,t.reg_cpt_ccy 币种
FROM  edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
WHERE t.dt='20240831'
and t.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2000449779',
'2000564959',
'2608740841',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
);
**01-数据需求_总行风险_D1105_陆奇_抵押贷明细.sql
--
-- SJ20241105111
-- 2024年9月末，抵押贷款明细清单（法人数据），即担保方式限制为抵押，需要字段：业务发生行名称、客户名称、贷款品种、抵押物名称、抵押物地址、押品类型、贷款发放时间、贷款到期时间；
--贷款余额、利率，押品权利人编号（多个权利人时只取1个，能区分是否个人住房即可）。
--字段：业务发生行名称、客户名称、贷款品种、贷款发放时间、贷款到期时间、贷款余额、利率，抵押物名称、抵押物地址、押品类型、押品权利人编号（多个权利人时只取1个，能区分是否个人住房即可）



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_lq_SJ20241105111 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_lq_SJ20241105111 AS
SELECT  A.ctr_serno                                                                       AS 合同流水号
        ,cb.hdl_org_id                                                                    AS 经办机构号
        ,T3.sbr_org_nm                                                                    AS 经办支行
        --  ,A.grnt_ctr_no                                                           AS 担保合同号
        ,cb.cst_id                                                                        AS 客户号
        ,cb.cst_nm                                                                        AS 客户名称
        ,cb.prd_no                                                                        AS 产品编号
        ,T2.pd_nm                                                                         AS 产品名称
        ,cb.bsn_ccy_cd                                                                    AS 业务币种代码
        ,cb.ctr_bgn_dt                                                                    AS 合同起始日
        ,cb.ctr_mtu_dt                                                                    AS 合同到期日
        ,ld.bal                                                                           AS 贷款余额
        ,cb.ctr_bal                                                                       AS 合同余额
        ,cb.exec_intr_rat                                                                 AS 执行利率
        ,wm_concat(DISTINCT '，', C.cltr_no)                                               AS 押品编号
        ,wm_concat(DISTINCT '，', C.cltr_nm)                                               AS 押品名称
        ,wm_concat(DISTINCT '，', COALESCE(J.dtl_lct, J1.dtl_lct, J2.dtl_lct, J3.dtl_lct)) AS 详细坐落位置
        ,wm_concat(DISTINCT '，', C.cltr_typ_cd)                                           AS 押品类型代码
        ,wm_concat(DISTINCT '，', T1.cd_val_dscr)                                          AS 押品类型
        ,wm_concat(DISTINCT '，', C.obg_id)                                                AS 权利人编号
        ,wm_concat(DISTINCT '，', C.obg_nm)                                                AS 权利人名称
        ,wm_concat(DISTINCT '，', c.wrnt_no)                                               AS 权证编号
        ,cb.grnt_mod_colc                                                                 AS 担保方式集合
        ,T4.grnt_mod_nm                                                                   AS 担保方式名称
FROM    edw.DWD_BUS_LOAN_CTR_REL_GRNT_DD A --主合同、担保合同关系
INNER JOIN    edw.dim_bus_loan_ctr_bse_inf_dd cb
ON      cb.ctr_serno = A.ctr_serno
AND     cb.dt = '20240930'
-- 未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( cb.CTR_STS_CD IN ( '2' , '4' )
AND     cb.TMT_DT = '18991231'
AND     to_date(cb.CTR_MTU_DT, 'yyyyMMdd') >= to_date(cb.DT, 'yyyyMMdd') )
    OR cb.CTR_BAL > 0 )
AND     cb.grnt_mod_colc RLIKE '020'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,sum(prcp_bal) AS bal
                 FROM    edw.dws_bus_loan_dbil_inf_dd
                 WHERE   dt = '20240930'
                 GROUP BY bus_ctr_id
             ) ld
ON      cb.ctr_serno = ld.bus_ctr_id
INNER JOIN    edw.DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD C --担保合同抵质押信息
ON      A.grnt_ctr_no = C.grnt_ctr_no
AND     C.dt = '20240930'
AND     C.eff_sts_cd = '1' --已生效
LEFT JOIN    edw.dim_bus_loan_cltr_prpt_spcl_dd J --不动产专项信息
ON      C.cltr_no = J.cltr_no
AND     J.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_BUS_LOAN_CLTR_CMRC_PRPT_SPCL_DD J1 --商业不动产专项信息
ON      C.cltr_no = J1.cltr_no
AND     J1.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_BUS_LOAN_CLTR_PLT_WHS_SPCL_DD J2 --厂房仓库专项信息
ON      C.cltr_no = J2.cltr_no
AND     J2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_bus_loan_cltr_use_land_spcl_dd J3 --用地专项信息
ON      C.cltr_no = J3.cltr_no
AND     J3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T1 -- 码值表
ON      C.cltr_typ_cd = T1.cd_val
AND     T1.tbl_nm = 'DIM_BUS_LOAN_GRNT_CTR_MORT_PLDG_DD'
AND     T1.fld_nm = upper('cltr_typ_cd')
AND     T1.dt = '20240930'
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T2 -- 码值表
ON      cb.prd_no = T2.prd_no
AND     T2.dt = '20240930'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      cb.hdl_org_id = T3.org_id
AND     T3.dt = '20240930'
LEFT JOIN    (
                 SELECT  a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241027'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '20241027'
                 GROUP BY a.ctr_serno , a.grnt_mod_colc
             ) T4
ON      cb.ctr_serno = T4.ctr_serno
WHERE   A.dt = '20240930'
GROUP BY A.ctr_serno , cb.hdl_org_id , T3.sbr_org_nm , cb.cst_id , cb.cst_nm , cb.prd_no , T2.pd_nm ,cb.bsn_ccy_cd , cb.ctr_bgn_dt , cb.ctr_mtu_dt , ld.bal , cb.ctr_bal , cb.exec_intr_rat , cb.grnt_mod_colc , T4.grnt_mod_nm;

-- SELECT * FROM edw.dim_bus_loan_cltr_use_land_spcl_dd WHERE dt='20241031' and cltr_no= '2023072700000630'
-- 担保方式：
-- 005 信用
-- 010 保证
-- 020 抵押
-- 040 质押
--050 资产池
**01-数据需求_总行风险_D1122_杜威林_担保人.sql
-- SJ2024102451
-- 合同流水号 客户编号 客户名称 合同金额 启用金额 合同开始日期 合同结束日期 合同是否有效 担保人编号 担保人名称 担保人为客户担保的数量


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_danbao_sj2024102451_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_danbao_sj2024102451_01 AS
SELECT  T1.ctr_serno     AS 合同流水号
        ,T1.cst_id       AS 客户编号
        ,T1.cst_nm       AS 客户名称
        ,T1.ctr_amt      AS 合同金额
        ,T1.strt_use_amt AS 启用金额
        ,T1.ctr_bgn_dt   AS 合同开始日期
        ,T1.ctr_mtu_dt   AS 合同结束日期
        ,CASE
           WHEN T1.CTR_STS_CD = '1' THEN '未生效'
           WHEN T1.CTR_STS_CD = '2' THEN '已生效'
           WHEN T1.CTR_STS_CD = '3' THEN '终止'
           WHEN T1.CTR_STS_CD = '4' THEN '冻结'
           WHEN T1.CTR_STS_CD = '5' THEN '作废'
         END             AS 合同状态
        ,T2.WRNT_CST_ID  AS 担保人编号
        ,T2.WRNT_CST_NM  AS 担保人名称
        ,T3.担保人为客户担保的数量
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    edw.dws_bus_grnt_prsn_inf_dd T2 --担保人汇总信息
ON      T1.ctr_serno = T2.BUS_CTR_ID
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A2.WRNT_CST_ID
                         ,COUNT(DISTINCT cst_id) AS 担保人为客户担保的数量
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
                 INNER JOIN    edw.dws_bus_grnt_prsn_inf_dd A2 --担保人汇总信息
                 ON      A1.ctr_serno = A2.BUS_CTR_ID
                 AND     A2.DT = '@@{yyyyMMdd}'
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' ) AND A1.TMT_DT = '18991231' AND to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') )
                         OR A1.CTR_BAL > 0 )
                 GROUP BY A2.WRNT_CST_ID
             ) T3
ON      T2.WRNT_CST_ID = T3.WRNT_CST_ID
WHERE   T1.DT = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( T1.CTR_STS_CD IN ( '2' , '4' ) AND T1.TMT_DT = '18991231' AND to_date(T1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T1.dt, 'yyyyMMdd') )
        OR T1.CTR_BAL > 0 )
;
**01-数据需求_总行风险_SJ2024072926_朱燕妮_EAST5.0集团表8月报送.sql
-- 截止2024年7月末，报送在本行纳入集团授信的客户及授信情况
--SJ2024072906
-- 集团客户名称和编号、母公司客户名称和编号、成员客户名称和编号、实控人名称、币种、授信敞口金额、授信敞口余额、集团资产与负债、采集日期
DROP TABLE if EXISTS tmp_zyn_SJ2024072906 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_zyn_SJ2024072906 as
SELECT  T1.grp_no 集团编号
        ,T1.grp_nm 集团名称
        ,T1.prn_cmp_cst_id 母公司客户号
        ,T1.prn_cmp_nm 母公司名称
        ,T2.mbr_cst_id 成员客户号
        ,T2.cst_chn_nm 成员客户名称
        ,T1.actl_ctler_cst_id 实际控制人客户号
        ,T4.reg_cpt_ccy 注册资本币种
        ,T5.exps_amt 敞口金额
        ,T5.exps_bal 敞口余额
        ,T3.grp_ast_amt 集团资产总额
        ,T3.grp_lbl_tot_amt 集团负债总额
        ,T1.dt 采集日期
FROM    edw.loan_cst_grp_bsc T1 --集团客户基本信息
LEFT JOIN    (
                 SELECT  T2.grp_no
                         ,T2.mbr_cst_id
                         ,T3.cst_chn_nm
                 FROM    edw.loan_cst_grp_mbr T2 --集团客户成员信息
                 LEFT JOIN    edw.dws_cst_bas_inf_dd T3  --客户基础信息汇总表
                 ON      T2.mbr_cst_id = T3.cst_id
                 AND     T3.dt = '@@{yyyyMMdd}'
                 WHERE   T2.dt = '@@{yyyyMMdd}'
             ) T2
ON      T1.grp_no = T2.grp_no
LEFT JOIN    edw.loan_cst_corp_bsc T4 --企业客户基本信息
ON      T2.mbr_cst_id = T4.cst_id
AND     T4.dt = '@@{yyyyMMdd}'
left join adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD T5 --风险集市客户-单法人授信用信情况表
on T2.mbr_cst_id=T5.cst_id
and T5.dt='@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_grp_fin_rpt T3 --集团客户财报信息
ON      T1.grp_no = T3.grp_no
AND     T3.del_ind ='0'
AND     T3.dt = '@@{yyyyMMdd}'
WHERE   T1.dt = '@@{yyyyMMdd}'
;


SELECT * FROM edw.loan_cst_grp_bsc WHERE dt='@@{yyyyMMdd}'
and prn_cmp_cst_id in ('2000387682','2604577884','2000455958','2000595966')

desc  edw.loan_cst_grp

SELECT * FROM edw.loan_cst_grp WHERE dt='@@{yyyyMMdd}'
and prn_cmp_cst_id in ('2000387682','2604577884','2000455958','2000595966')



SELECT cst_id,cst_nm,reg_cpt_ccy from  edw.loan_cst_corp_bsc  --企业客户基本信息
where dt='@@{yyyyMMdd}'
and cst_nm like '%集团%'
;


SELECT * FROM tmp_zhc_fxglb_whw_20240802_08_3_JT








SELECT * FROM tmp_zyn_SJ2024072906    T
INNER JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240802_07_2 t1 --有未结清合同
ON      t1.customerid = t.成员客户号


 SELECT * FROM edw.loan_cst_grp_fin_rpt WHERE DT='20240731' AND  grp_no='JT20140603000266'


-- +------------------------------------------------------------------------------------+
-- | grp_no          | string     |       | 集团编号                                        |
-- | grp_nm          | string     |       | 集团名称                                        |
-- | grp_facl_typ    | string     |       | 集团授信类型                                      |
-- | prn_cmp_cst_id  | string     |       | 母公司客户号                                      |
-- | prn_cmp_lncrd_no | string     |       | 母公司中征码                                      |
-- | prn_cmp_nm      | string     |       | 母公司名称                                       |
-- | prn_cmp_cert_no | string     |       | 母公司证件号码                                     |
-- | actl_ctler_cst_id | string     |       | 实际控制人客户号                                    |
-- | upd_ofc_addr_dt | string     |       | 更新办公地址日期                                    |
-- | addr_dtl        | string     |       | 地址详情                                        |
-- | grp_prn_cmp_ic_reg_reg_no | string     |       | 集团母公司工商登记注册号                                |
-- | grp_dmst_ofc_addr_adiv | string     |       | 集团国内办公地址行政区划                                |
-- | grp_ccd         | string     |       | 集团紧密程度                                      |
-- | grp_cst_situ_dscr | string     |       | 集团客户情况说明                                    |
-- | rsk_wrn_sgnl    | string     |       | 风险预警信号                                      |
-- | cr_rtg_rslt     | string     |       | 信用评级结果                                      |
-- | fcs_evt_cd      | string     |       | 关注事件代码                                      |
-- | rsn_dscr        | string     |       | 原因描述                                        |
-- | bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
-- | del_ind         | string     |       | 删除标识                                        |
-- | sys_reg_psn     | string     |       | 系统登记人                                       |
-- | sys_reg_org     | string     |       | 系统登记机构                                      |
-- | sys_reg_tm      | string     |       | 系统登记时间                                      |
-- | last_upd_psn    | string     |       | 最后更新人                                       |
-- | last_upd_org    | string     |       | 最后更新机构                                      |
-- | last_upd_tm     | string     |       | 最后更新时间                                      |


-- SELECT * FROM  edw.loan_cst_grp_fin_rpt  --集团客户财报信息
-- WHERE dt='20240730' LIMIT 1000

-- | serno           | string     |       | 流水号                                         |
-- | grp_no          | string     |       | 集团编号                                        |
-- | rpt_end_to_dt   | string     |       | 报表截至日期                                      |
-- | grp_ast_amt     | decimal    |       | 集团资产总额                                      |
-- | grp_lbl_tot_amt | decimal    |       | 集团负债总额                                      |
-- | bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
-- | del_ind         | string     |       | 删除标识                                        |
-- | sys_reg_psn     | string     |       | 系统登记人                                       |
-- | sys_reg_org     | string     |       | 系统登记机构                                      |
-- | sys_reg_tm      | string     |       | 系统登记时间                                      |
-- | last_upd_psn    | string     |       | 最后更新人                                       |
-- | last_upd_org    | string     |       | 最后更新机构                                      |
-- | last_upd_tm     | string     |       | 最后更新时间                                      |
-- +------------------------------------------------------------------------------------+

-- SELECT * FROM edw.loan_cst_grp_mbr

--  desc edw.loan_cst_grp_mbr --集团客户成员信息
-- | serno           | string     |       | 流水号                                         |
-- | grp_no          | string     |       | 集团编号                                        |
-- | mbr_cst_id      | string     |       | 成员客户号                                       |
-- | grp_rel_typ     | string     |       | 集团关联类型                                      |
-- | mbr_usd_lmt     | decimal    |       | 成员已用额度                                      |
-- | grp_rel_rel_dscr | string     |       | 集团关联关系描述                                    |
-- | prn_cmp_ind     | string     |       | 是否母公司                                       |
-- | bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
-- | del_ind         | string     |       | 删除标识                                        |
-- | sys_reg_psn     | string     |       | 系统登记人                                       |
-- | sys_reg_org     | string     |       | 系统登记机构                                      |
-- | sys_reg_tm      | string     |       | 系统登记时间                                      |
-- | last_upd_psn    | string     |       | 最后更新人                                       |
-- | last_upd_org    | string     |       | 最后更新机构                                      |
-- | last_upd_tm     | string     |       | 最后更新时间                                      |
-- +------------------------------------------------------------------------------------+
**01-数据需求_总行风险_SJ2024082751_朱燕妮_EAST5.0集团表9月报送.sql
--SJ2024082751
--截止2024年8月末，报送在本行纳入集团授信的客户及授信情况。集团客户名称和编号、母公司客户名称和编号、成员客户名称和编号、实控人名称、币种、授信敞口金额、授信敞口余额、集团资产与负债、采集日期


---管护信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20240827_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20240827_02 AS
SELECT  t.cst_id                      AS 客户号
        ,t.cst_nm                     AS 客户名称
        ,b.prm_mgr_id                 AS 主管客户经理工号
        ,b1.empe_nm                   AS 主管客户经理姓名
        ,b.prm_org_id                 AS 主管护机构号
        ,b2.org_nm                    AS 主管护机构名称
        ,cd1.cd_val_dscr              AS 最新更新系统名称
        ,c.last_updated_ts            AS 最新更新时间
        ,cd2.cd_val_dscr              AS 创建源系统名称
        ,substr(d.cust_fol_dt, 1, 10) AS 客户建档日期
FROM    edw.dim_cst_entp_bas_inf_dd t  --企业客户基本信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd b  --客户主管护
ON      t.cst_id = b.cst_id
AND     b.dt = '${yyyyMMdd}'   -- DATE***
LEFT JOIN    edw.dws_hr_empe_inf_dd b1
ON      b1.empe_id = b.prm_mgr_id
AND     b1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dim_hr_org_bas_inf_dd b2
ON      b.prm_org_id = b2.org_id
AND     b2.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.ecif_t00_org_cust_no_rec c
ON      t.cst_id = c.cust_no
AND     c.dt = '${yyyyMMdd}'   -- DATE***
AND     c.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.ecif_t01_org_cust_info d
ON      c.party_id = d.party_id
AND     d.dt = '${yyyyMMdd}'   -- DATE***
AND     d.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.dwd_code_library_dd cd1
ON      c.last_system_id = cd1.cd_val
AND     cd1.tbl_nm = 'KFAB_JYTOZZ'
AND     cd1.fld_nm = 'XITONGBS'
AND     cd1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dwd_code_library_dd cd2
ON      c.init_system_id = cd2.cd_val
AND     cd2.tbl_nm = 'KFAB_JYTOZZ'
AND     cd2.fld_nm = 'XITONGBS'
AND     cd2.dt = '${yyyyMMdd}'
WHERE   t.dt = '${yyyyMMdd}';  -- DATE***



------在我行有业务的客户

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 AS
SELECT  DISTINCT CST_ID
FROM    (
            SELECT  CST_ID
            FROM    edw.dim_bus_dep_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --存款账户信息
            UNION
            SELECT  CST_ID
            FROM    edw.dws_bus_crd_cr_crd_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信用卡账户汇总信息
            UNION
            SELECT  CST_ID
            FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信贷合同信息
            UNION
            SELECT  GTOR_NO AS CST_ID
            FROM    edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(GTOR_NO, '') <> ''
            GROUP BY GTOR_NO
        ) a;



----有未结清的信贷合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_07_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_07_2 AS
SELECT  DISTINCT t1.cst_id  AS customerid
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '${yyyyMMdd}'
WHERE   t1.dt = '${yyyyMMdd}'
AND     T1.PRD_NO <> '2002010101001' --剔除信用卡合同
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08'
    OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date('${yyyyMMdd}', 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 );



--名字带有集团且有未结清合同的企业客户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT AS
SELECT  DISTINCT t.cst_id 客户号
                 ,t.cst_nm 客户名称
                 ,CASE
                    WHEN t2.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END 是否曾发生过业务
                 ,cr.rel_cst_id 实控人客户号
                 ,t4.cst_chn_nm 实控人名称
                 ,t4.ntn_cd 实控人国籍
                 ,t.reg_cpt_ccy 币种
                 ,t3.主管客户经理工号
                 ,t3.主管客户经理姓名
                 ,t3.主管护机构号
                 ,t3.主管护机构名称
                 ,t6.cmn_rsk_ctrl_id 同一风险控制号
                 ,t6.use_crdt_bal 用信余额
                 ,t6.exps_amt 敞口金额
                 ,t6.exps_bal 敞口余额
FROM    edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
INNER JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_07_2 t1 --有未结清合同
ON      t1.customerid = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 t2 -----有业务
ON      t2.cst_id = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw20240827_02 t3  --管护信息
ON      t3.客户号 = t.cst_id
LEFT JOIN    EDW.LOAN_cst_rel cr -- 客户实控人
ON      t.cst_id = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
ON      t.cst_id = t6.cst_id
AND     t6.DT = '${yyyyMMdd}'
WHERE   t.DT = '${yyyyMMdd}' -- DATE***
AND     t.cst_nm RLIKE '集团';



--占股50%以上的为母公司
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_1 AS
SELECT
    A1.csld_crd_cd
   ,A1.shh_nm
   ,A1.shh_typ
   ,A1.ctrb_rto
   ,A3.CST_ID AS 企业客户号
FROM (
       SELECT
            csld_crd_cd
           ,shh_nm
           ,shh_typ
           ,ctrb_rto
           ,RANK() OVER(PARTITION BY csld_crd_cd ORDER BY qry_tm DESC ) AS RN
       FROM edw.dim_cst_out_geb_shh_inf_dd --工商企业股东及出资信息
       WHERE DT = '${yyyyMMdd}'
    ) A1
LEFT JOIN edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON REPLACE(REPLACE(A1.shh_nm,'(','（'),')','）') =  REPLACE(REPLACE(A3.CST_CHN_NM,'(','（'),')','）')
AND A3.DT = '${yyyyMMdd}'
WHERE A1.shh_typ = '企业法人'
AND   REPLACE(A1.ctrb_rto ,'%','') >= 50 ;



--结果表
SELECT * FROM tmp_zhc_fxglb_whw_20240827_08_3_JT_2

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_2 AS
SELECT  T3.shh_nm    AS 母公司名称
        ,T3.企业客户号    AS 母公司客户号
        ,T3.ctrb_rto AS 母公司占股
        ,CASE
           WHEN T5.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END 母公司是否曾发生过业务
        ,cr.rel_cst_id 母公司实控人客户号
        ,t4.cst_chn_nm 母公司实控人名称
        ,t4.ntn_cd 母公司实控人国籍
        ,T1.客户号
        ,T1.客户名称
        ,T1.是否曾发生过业务
        ,T1.实控人客户号
        ,T1.实控人名称
        ,T1.实控人国籍
        ,T1.币种
        ,T1.主管客户经理工号
        ,T1.主管客户经理姓名
        ,T1.主管护机构号
        ,T1.主管护机构名称
        ,T1.同一风险控制号
        ,T1.用信余额
        ,T1.敞口金额
        ,T1.敞口余额
FROM    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20240827_08_3_JT_1 T3
ON      T2.DOC_NBR = T3.csld_crd_cd
LEFT JOIN    edw.loan_cst_rel cr -- 客户实控人
ON      T3.企业客户号 = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20240827_05 T5 -----有业务
ON      T3.企业客户号 = T5.cst_id;


---补充未识别到的敞口金额，敞口余额，只有14个有金额，其他无(是合同已结清或流失原因)

SELECT t6.cst_id 客户号
       ,t6.cst_chn_nm 客户名称
       ,T6.exps_amt 敞口金额
       ,T6.exps_bal 敞口余额
FROM adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
WHERE t6.dt='20240831'
and t6.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2002941732',
'2000449779',
'2000564959',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
)
;

SELECT t.cst_id,t.reg_cpt_ccy 币种
FROM  edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
WHERE t.dt='20240831'
and t.cst_id in ('2600429217',
'2604196165',
'2000979737',
'2607661614',
'2000635006',
'2601280412',
'2000381068',
'2000382625',
'2000395201',
'2000417484',
'2000688736',
'2002941732',
'2000449779',
'2000564959',
'2607634172',
'2001465769',
'2604072507',
'8606548519',
'2605243714',
'2001267088',
'8602202405',
'2000395713',
'2000387682',
'2602111177',
'2610113194',
'2606811947',
'2606878600'
);
**01-数据需求_总行风险_SJ2024082956_李娅玲_全行新信贷用户清单.sql
-- SJ2024082956
-- 存在连续30天未进行查询操作的全行新信贷用户清单。
-- 备注：据与信贷业务系统建设项目组运营小组陆宁（002442）前期沟通结论：新信贷后台记录中有最近登录日期和口令开立日期，根据这两个相关字段，可以算出连续30天未进行过查询操作的用户


-- 新信贷用户口令开立日期、新信贷用户口令最近登录日期、员工工号、用户名称、所属机构、角色名称、人力主岗位、人力所在机构、用户状态、角色对接人等

SELECT * FROM tmp_lyl_SJ2024082956 WHERE 最近登录日期 is not null

DROP TABLE if EXISTS tmp_lyl_SJ2024082956 purge;
CREATE TABLE IF NOT EXISTS tmp_lyl_SJ2024082956 as
SELECT DISTINCT asu.CREATE_DATE      AS 口令开立日期
        ,asu.LAST_LOGIN_TIME AS 最近登录日期
        ,asu.user_id as user_id
        ,asu.LOGIN_CODE      AS 员工工号
        ,asu.user_code 员工工号1
        ,asu.USER_NAME       AS 用户名称
        ,asu.ORG_ID      AS 所属机构
        ,ar.role_name  AS 角色名称
        -- ,wm_concat('||',ar.role_name)    AS 角色名称
        ,asu.HR_AT_DUTY      AS 人力主岗位
        ,b.pos_nm 人力主岗位名称
        ,asu.HR_AT_ORG       AS 人力所在机构
        ,c.org_nm        AS 人力所在机构名称
        ,CASE
           WHEN asu.user_sts = 'A' THEN '生效'
           WHEN asu.user_sts = 'I' THEN '失效'
           ELSE '待生效'
         END             AS 用户状态
FROM    edw.loan_admin_sm_user asu --信贷系统用户表
LEFT JOIN    edw.loan_admin_sm_user_role_rel arr --用户角色关联表
ON      asu.user_id = arr.USER_ID
AND     arr.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_admin_sm_role ar --系统角色表
ON      ar.ROLE_ID = arr.ROLE_ID
and ar.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_job_inf_dd b --职位信息
ON      asu.HR_AT_DUTY = b.pos_id
AND     b.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd c --机构树_考核维度
ON      asu.HR_AT_ORG = c.org_id
AND     c.dt = '@@{yyyyMMdd}'
WHERE   asu.dt = '@@{yyyyMMdd}'
;




desc edw.loan_admin_sm_user_role_rel  --用户角色关联表
user_role_rel_id | string     | 1     | 记录编号                                        |
| user_id         | string     |       | 用户编号                                        |
| role_id         | string     |       | 角色编号                                        |
| last_chg_usr    | string     |       | 最新变更用户                                      |
| last_chg_dt     | string     |       | 最新变更时间                                      |
| data_tenant_id  | string     |       | 数据所属租户id                                    |
| checked         | bigint     |       |                                             |
| org_id          | string     |       |                                             |
| last_use_time   | string     |       | 最后选择该机构角色的时

desc edw.loan_admin_sm_role  --系统角色表
 role_id         | string     |       | 记录编号                                        |
| role_code       | string     |       | 角色代码                                        |
| role_name       | string     |       | 角色名称                                        |
| org_id          | string     |       | 所属机构编号                                      |
| role_level      | string     |       | 角色层级                                        |
| role_sts        | string     | 1     | 状态：对应字典项=NORM_STS A：生效 I：失效 W：待生效           |
| last_chg_usr    | string     |       | 最新变更用户                                      |
| last_chg_dt     | string     |       | 最新变更时间                                      |
| data_tenant_id  | string     |       | 数据所属租户id                                    |
| role_avi_level  | string     |       | 角色适用机构层级                                    |
| ind_alw_cfg_domn_rgn | string     |       | 是否允许配置辖区                                    |
| auth_lvl        | string     |       | 授权层级                                        |
| ofc_dept_no     | string     |       | 主管部门                                        |
| role_usg        | string     |       | 角色用途                                        |
| role_rmk        | string     |       | ROLE_RMK                                    |
| lgp_id          | string     |       | 法人编号                                        |
| bel_mng_lgp_id  | string     |       | 归属管理法人编号                                    |
| create_user     | string     |       | 登记人                                         |
| create_org      | string     |       | 登记机构                                        |
| create_date     | string     |       | 登记时间                                        |
| update_org      | string     |       | 最后更新机构                                      |


select au.user_id,
      GROUP_CONCAT(ar.ROLE_NAME)
from edw.loan_admin_sm_user au
join edw.loan_admin_sm_user_role_rel arr --用户角色关联表
on arr.USER_ID = au.user_id
join edw.loan_admin_sm_role ar  --系统角色表
on ar.ROLE_ID = arr.ROLE_ID
where au.user_id = '000001' --董事长
group by au.user_id
;
**01-数据需求_总行风险_SJ2024101686_崔婷婷_信贷系统征信查看记录.sql
--转堡垒机处理

-- SJ2024101686
--新信贷上线所有征信查询查看记录（征信查询系统有记录，根据工号去重，取日期最近一次）

-- 字段工号、姓名、查询时间，岗位，机构（支行层级、分行层级）

--职能从信贷工厂，信贷系统查询到


--征信查看记录
SELECT * FROM tmp_ctt_SJ2024101686_01

DROP TABLE IF EXISTS tmp_ctt_SJ2024101686_01 PURGE;

CREATE TABLE IF NOT EXISTS tmp_ctt_SJ2024101686_01 AS
SELECT  t.user_id 工号
        ,t1.empe_nm 姓名
        ,t.viewtime 查看时间
        ,t11.pos_nm 岗位
        --  ,t.org_id 机构
        ,t2.org_nm 机构
        ,t2.brc_org_nm 分行
        ,t2.sbr_org_nm 支行
        ,CASE
           WHEN t.channel = 'B12'  THEN '信贷工厂PAD'
           WHEN t.channel = 'M01'  THEN '信贷管理系统'
           WHEN t.channel = 'L08 ' THEN '金融云平台'
         END AS 查询渠道
FROM    (
            SELECT  *
            FROM    (
                        SELECT  *
                                ,ROW_NUMBER() OVER ( PARTITION BY user_id ORDER BY replace(substr(viewtime,1,10),'-','') DESC ) AS rn
                        FROM    edw.ncip_zx_buriedpoint_collect --征信埋点采集表,增量表
                        WHERE   dt >= '20240719'
                        AND     channel IN ( 'B12' , 'M01' , 'L08' )  --B12     信贷工厂（PAD）   M01     信贷管理系统 L08     金融云平台;
                    ) a
            WHERE   a.rn = 1
        ) t
LEFT JOIN    edw.dws_hr_empe_inf_dd t1 --员工信息汇总表
ON      substr(t.user_id,1,6) = t1.empe_id
AND     t1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_job_inf_dd t11 --职位信息
ON      t1.pos_enc = t11.pos_id
AND     t11.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t2  --机构
ON      t.org_id = t2.org_id
AND     t2.dt = '@@{yyyyMMdd}'
;


--征信查询记录，新信贷上线后

--字段工号、姓名、查询时间，岗位，机构（支行层级、分行层级）

SELECT cpq.credit_user 征信用户
       ,cpq.operator 操作用户
       ,cpq.query_time 查询时间
FROM edw.ncip_cpq_resultinfo cpq  --个人信用报告查询记录,增量表
WHERE dt>='20240719'



SELECT *
FROM edw.ncip_ceq_resultinfo   ---企业信用报告查询记录，增量表
WHERE dt>='20240719'
**01-数据需求_总行风险_陆奇_集团客户报送_常态化.sql
--截止2024年12月末，报送在本行纳入集团授信的客户及授信情况。集团客户名称和编号、母公司客户名称和编号、成员客户名称和编号、实控人名称、币种、授信敞口金额、授信敞口余额、集团资产与负债、采集日期


---管护信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20250131_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw20250131_02 AS
SELECT  t.cst_id                      AS 客户号
        ,t.cst_nm                     AS 客户名称
        ,b.prm_mgr_id                 AS 主管客户经理工号
        ,b1.empe_nm                   AS 主管客户经理姓名
        ,b.prm_org_id                 AS 主管护机构号
        ,b2.org_nm                    AS 主管护机构名称
        ,cd1.cd_val_dscr              AS 最新更新系统名称
        ,c.last_updated_ts            AS 最新更新时间
        ,cd2.cd_val_dscr              AS 创建源系统名称
        ,substr(d.cust_fol_dt, 1, 10) AS 客户建档日期
FROM    edw.dim_cst_entp_bas_inf_dd t  --企业客户基本信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd b  --客户主管护
ON      t.cst_id = b.cst_id
AND     b.dt = '${yyyyMMdd}'   -- DATE***
LEFT JOIN    edw.dws_hr_empe_inf_dd b1
ON      b1.empe_id = b.prm_mgr_id
AND     b1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dim_hr_org_bas_inf_dd b2
ON      b.prm_org_id = b2.org_id
AND     b2.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.ecif_t00_org_cust_no_rec c
ON      t.cst_id = c.cust_no
AND     c.dt = '${yyyyMMdd}'   -- DATE***
AND     c.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.ecif_t01_org_cust_info d
ON      c.party_id = d.party_id
AND     d.dt = '${yyyyMMdd}'   -- DATE***
AND     d.UPDATED_TS = '9999-12-31 00:00:00'
LEFT JOIN    edw.dwd_code_library_dd cd1
ON      c.last_system_id = cd1.cd_val
AND     cd1.tbl_nm = 'KFAB_JYTOZZ'
AND     cd1.fld_nm = 'XITONGBS'
AND     cd1.dt = '${yyyyMMdd}'  -- DATE***
LEFT JOIN    edw.dwd_code_library_dd cd2
ON      c.init_system_id = cd2.cd_val
AND     cd2.tbl_nm = 'KFAB_JYTOZZ'
AND     cd2.fld_nm = 'XITONGBS'
AND     cd2.dt = '${yyyyMMdd}'
WHERE   t.dt = '${yyyyMMdd}';  -- DATE***



------在我行有业务的客户

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20250131_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20250131_05 AS
SELECT  DISTINCT CST_ID
FROM    (
            SELECT  CST_ID
            FROM    edw.dim_bus_dep_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --存款账户信息
            UNION
            SELECT  CST_ID
            FROM    edw.dws_bus_crd_cr_crd_act_inf_dd
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信用卡账户汇总信息
            UNION
            SELECT  CST_ID
            FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(cst_id, '') <> ''
            GROUP BY CST_ID
 --信贷合同信息
            UNION
            SELECT  GTOR_NO AS CST_ID
            FROM    edw.DIM_BUS_LOAN_GRNT_CTR_GTOR_INF_DD
            WHERE   DT = '${yyyyMMdd}'
            AND     NVL(GTOR_NO, '') <> ''
            GROUP BY GTOR_NO
        ) a;



----有未结清的信贷合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_07_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_07_2 AS
SELECT  DISTINCT t1.cst_id  AS customerid
FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
ON      t1.CTR_SERNO = t2.CTR_SERNO
AND     t2.dt = '${yyyyMMdd}'
WHERE   t1.dt = '${yyyyMMdd}'
AND     T1.PRD_NO <> '2002010101001' --剔除信用卡合同
AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
AND     ( t2.APLY_CHNL_CD <> 'L08'
    OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
    OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
AND     t1.TMT_DT = '18991231'
AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date('${yyyyMMdd}', 'yyyyMMdd') )
    OR t1.CTR_BAL > 0 );




--名字带有集团且有未结清合同的企业客户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT AS
SELECT  DISTINCT t.cst_id 客户号
                 ,t.cst_nm 客户名称
                 ,CASE
                    WHEN t2.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END 是否曾发生过业务
                 ,cr.rel_cst_id 实控人客户号
                 ,t4.cst_chn_nm 实控人名称
                 ,t4.ntn_cd 实控人国籍
                 ,t.reg_cpt_ccy 币种
                 ,t3.主管客户经理工号
                 ,t3.主管客户经理姓名
                 ,t3.主管护机构号
                 ,t3.主管护机构名称
                 ,t6.cmn_rsk_ctrl_id 同一风险控制号
                 ,t6.cprh_crdt_exps_amt 统一授信敞口金额
                 ,t6.use_crdt_bal 用信余额
                --  ,t6.exps_amt 敞口金额
                 ,t6.exps_bal 敞口余额
FROM    edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
INNER JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_07_2 t1 --有未结清合同
ON      t1.customerid = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20250131_05 t2 -----有业务
ON      t2.cst_id = t.cst_id
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw20250131_02 t3  --管护信息
ON      t3.客户号 = t.cst_id
LEFT JOIN    EDW.LOAN_cst_rel cr -- 客户实控人
ON      t.cst_id = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市_客户级授信用信敞口表
ON      t.cst_id = t6.cst_id
AND     t6.DT = '${yyyyMMdd}'
WHERE   t.DT = '${yyyyMMdd}' -- DATE***
AND     t.cst_nm RLIKE '集团';



--占股50%以上的为母公司
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT_1 AS
SELECT
    A1.csld_crd_cd
   ,A1.shh_nm
   ,A1.shh_typ
   ,A1.ctrb_rto
   ,A3.CST_ID AS 企业客户号
FROM (
       SELECT
            csld_crd_cd
           ,shh_nm
           ,shh_typ
           ,ctrb_rto
           ,RANK() OVER(PARTITION BY csld_crd_cd ORDER BY qry_tm DESC ) AS RN
       FROM edw.dim_cst_out_geb_shh_inf_dd --工商企业股东及出资信息
       WHERE DT = '${yyyyMMdd}'
    ) A1
LEFT JOIN edw.dws_cst_bas_inf_dd A3 --客户基础信息汇总表
ON REPLACE(REPLACE(A1.shh_nm,'(','（'),')','）') =  REPLACE(REPLACE(A3.CST_CHN_NM,'(','（'),')','）')
AND A3.DT = '${yyyyMMdd}'
WHERE A1.shh_typ = '企业法人'
AND   REPLACE(A1.ctrb_rto ,'%','') >= 50 ;



--结果表

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT_2 AS
SELECT  T3.shh_nm    AS 母公司名称
        ,T3.企业客户号    AS 母公司客户号
        ,T3.ctrb_rto AS 母公司占股
        ,CASE
           WHEN T5.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END 母公司是否曾发生过业务
        ,cr.rel_cst_id 母公司实控人客户号
        ,t4.cst_chn_nm 母公司实控人名称
        ,t4.ntn_cd 母公司实控人国籍
        ,T1.客户号
        ,T1.客户名称
        ,T1.是否曾发生过业务
        ,T1.实控人客户号
        ,T1.实控人名称
        ,T1.实控人国籍
        ,T1.币种
        ,T1.主管客户经理工号
        ,T1.主管客户经理姓名
        ,T1.主管护机构号
        ,T1.主管护机构名称
        ,T1.同一风险控制号
        ,T1.统一授信敞口金额
        ,T1.用信余额
        -- ,T1.敞口金额
        ,T1.敞口余额
FROM    lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_20250131_08_3_JT_1 T3
ON      T2.DOC_NBR = T3.csld_crd_cd
LEFT JOIN    edw.loan_cst_rel cr -- 客户实控人
ON      T3.企业客户号 = cr.cst_id
AND     cr.rel_typ = '0109'
AND     cr.DT = '${yyyyMMdd}'
LEFT JOIN    edw.dim_cst_idv_bas_inf_dd t4
ON      t4.cst_id = cr.rel_cst_id
AND     t4.dt = '${yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_zhc_fxglb_whw_yywkh_20250131_05 T5 -----有业务
ON      T3.企业客户号 = T5.cst_id;




---补充未识别到的敞口金额，敞口余额，币种，其他无金额(是合同已结清或流失原因)

--adm_rsk.ADM_RSK_APL_CST_USE_CRDT_CST_INFO_DD                    -- 风险集市客户-集团授信用信情况表
--adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD    -- 风险集市客户-单法人授信用信情况表

SELECT  t.cst_id               AS 客户号
        ,t.cst_nm              AS 客户名称
        ,t6.cprh_crdt_exps_amt AS 统一授信敞口金额
        ,t6.use_crdt_bal       AS 用信余额
        ,T6.exps_bal           AS 敞口余额
        ,t.reg_cpt_ccy         AS 币种
FROM    edw.loan_cst_corp_bsc t --所有集团客户，企业客户基本信息
LEFT JOIN    adm_rsk.ADM_RSK_APL_SNGL_LEGAL_PERSON_AUTHR_CRDT_USE_CRDT_DD t6 -- 风险集市客户-单法人授信用信情况表
ON      t.cst_id = t6.cst_id
AND     t6.dt = '20250228'
WHERE   t.dt = '20250228'
AND     t.cst_id IN ('2000635006',
'2000381068',
'2000395201',
'2000417484',
'2000688736',
'2001465769',
'8606548519',
'2605243714',
'2609937845',
'2000387682',
'2002833901'
)
**01-数据需求_村行_2025_D0102_长乐村行_陈飞_国税鉴损使用.sql
--SJ20241231126
--长乐村行
-- 一、随贷通（未结清借据）发放金额及余额明细查询
-- 取数口径：柜面系统5112；数据日期2019年1月1日至2024年12月31日，取数范围：详见附件
-- 二、随贷通（未结清借据）发放及还款明细
-- 取数口径：柜面系统5116；数据日期2019年1月1日至2024年12月31日，取数范围：详见附件

-- DROP TABLE if EXISTS tmp_sjxq_SJ20241231126_001 ;
-- CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241231126_001
-- (合同流水号 STRING
-- ,借据流水号 string
-- )
-- ;
-- INSERT INTO  TABLE tmp_sjxq_SJ20241231126_001
-- (合同流水号,借据流水号)
-- values




---是否未结清，如果要筛的话加一个klna_Dkzhzb的贷款账户状态不为1;

-- 一、随贷通（未结清借据）发放金额及余额明细查询  --5112
-- 随贷通卡号、借据流水号、借款日期、贷款状态、贷款总利息、贷款金额、贷款到期日、当前利率、贷款余额、贷款欠息、贷款利息罚息、贷款本金罚息。


DROP TABLE IF EXISTS tmp_sdt_fhkmx_SJ20241231126_5112  purge;
CREATE TABLE IF NOT EXISTS tmp_sdt_fhkmx_SJ20241231126_5112 as
SELECT  zb.hetongbh                                          AS 合同编号
        ,zb.dkjiejuh                                         AS 贷款借据号
        ,zb.Kaihriqi                                         AS 开户日期
        ,zb.qixiriqi                                         AS 起息日期
        ,zb.jiejuuje                                         AS 借据金额
        ,zb.hetongje                                         AS 合同金额
        ,zb.kffangje                                         AS 可发放金额
        ,zb.DKQIXIAN                                         AS 贷款期限_月
        ,zb.Daoqriqi                                         AS 到期日期
        -- ,zb.Dkzhhzht                                         AS 贷款账户状态 --未结清，贷款账户状态<>1
        -- ,zb.Daikxtai                                         AS 贷款形态
        -- ,zb.kuaijilb                                         AS 会计类别
        ,zb.kehmingc                                         AS 客户名称
        ,zb.kehuhaoo                                         AS 客户号
        ,zb.zhngjigo                                         AS 账务机构
        ,zb.chanpmch                                         AS 产品名称
        ,zb.Huobdhao                                         AS 货币代号
        ,zb.xiaohurq                                         AS 销户日期
        -- ,jx.nyuelilv                                         AS 年_月利率标识
        ,zb.dkzhangh                                         AS 贷款账号
        -- ,min(zb.ziczhtai)                                    AS 资产状态  0--不适用 1--正常 2--转让  3--证券化 4--化债 5--核销
        ,nvl(jx.zhchlilv,0) as 正常利率
        -- ,nvl(trim(to_char(jx.zhchlilv, '99990.9999999')), 0) AS 正常利率
        ,nvl(sum(zb.fafangje), 0)                            AS 已发放金额
        ,nvl(sum(zb.zhchbjin), 0)                            AS 正常本金
        ,nvl(sum(zb.yuqibjin), 0)                            AS 逾期本金
        ,nvl(sum(zb.dzhibjin), 0)                            AS 呆滞本金
        ,nvl(sum(zb.daizbjin), 0)                            AS 呆账本金
        ,nvl(sum(zb.ysyjlixi), 0)                            AS 应收应计利息
        ,nvl(sum(zb.csyjlixi), 0)                            AS 催收应计利息
        ,nvl(sum(zb.ysqianxi), 0)                            AS 应收欠息
        ,nvl(sum(zb.csqianxi), 0)                            AS 催收欠息
        ,nvl(sum(zb.ysyjfaxi), 0)                            AS 应收应计罚息
        ,nvl(sum(zb.csyjfaxi), 0)                            AS 催收应计罚息
        ,nvl(sum(zb.yshofaxi), 0)                            AS 应收罚息
        ,nvl(sum(zb.cshofaxi), 0)                            AS 催收罚息
        ,nvl(sum(zb.yingjifx), 0)                            AS 应计复息
        ,nvl(sum(zb.fuxiiiii), 0)                            AS 复息
        ,nvl(sum(zb.dianshje), 0)                            AS 垫税金额
        ,nvl(sum(zb.hexiaobj), 0)                            AS 核销本金
        ,nvl(sum(zb.hexiaolx), 0)                            AS 核销利息
        ,nvl(sum(zb.yihxbjlx), 0)                            AS 已核销本金利息
        -- ,nvl(sum(jc.YINHSHJE), 0)                            AS 印花税金额
FROM    (
            SELECT  t1 . *
                    ,t2.cst_act_id --随贷通客户账号即卡号
            FROM    tmp_sjxq_SJ20241231126_001 t1
            LEFT JOIN    edw.dwd_bus_loan_fnc_crd_lmt_inf_dd t2 --随贷通授信额度信息
            ON      t1.合同流水号 = t2.bus_ctr_id
            AND     t2.dt = '20241231'
            WHERE   t1.借据流水号 LIKE 'SXK%'
        ) a
LEFT JOIN    edw.core_klna_dkzhzb zb --贷款账户主表
ON      a.借据流水号 = zb.dkjiejuh
AND     zb.dt = '20241231'
-- LEFT JOIN    edw.core_klnb_dkjcsx jc --贷款账户基础表
-- ON      zb.dkjiejuh = jc.dkjiejuh
-- AND     jc.dt = '20241231'
-- LEFT JOIN    edw.core_kclb_dkedjj jj --贷款额度借据主表
-- ON      zb.dkjiejuh = jj.jiejuhao
-- AND     jj.dt = '20241231'
LEFT JOIN    edw.core_klnb_dkjxsx jx --贷款账户计息表
ON      zb.dkjiejuh = jx.dkjiejuh
AND     jx.dt = '20241231'
WHERE   zb.qixiriqi BETWEEN '20190101' AND '20241231'
GROUP BY zb.dkjiejuh , zb.Kaihriqi  ,zb.qixiriqi,zb.jiejuuje,zb.hetongje ,zb.kffangje,zb.dkzhangh, zb.DKQIXIAN , zb.Daoqriqi , zb.zhngjigo , zb.chanpmch , zb.Huobdhao , jx.zhchlilv , zb.shijchuo , zb.kehmingc , zb.kehuhaoo , zb.xiaohurq , zb.hetongbh;

;

-- 二、随贷通（未结清借据）还款及发放明细  --5116
-- 合同号、借据流水号、客户姓名 明细编号、贷款账号、营业机构、原交易日期、贷款入账账号、贷款入账账户 序号 放款金额 放款资金 处理方式 待销账序号 冻结编号 正常本金 逾期本金 呆滞本金 呆账本金 资金来源
-- 还款账号 还款账户 序号 可用金额 还款总额 还款状态 归还本金 归还应收应计利息 归还催收应计利息 归还应收欠息 归还催收欠息 归还应收应计罚息 归还催收应计罚息 归还应收罚 息归还催收罚息 归还应计复息 归还复息 归还罚金
-- 归还费用 原交易机构 原交易柜员 原服务处理流水号 交易事件 类型事件 说明 交易码 摘要 贷款归还方式 还款备注 维护日期 维护时间。

SELECT *,decode(还款状态,'1','提前还款','2','正常还款','3','逾期还款') as 还款状态 FROM tmp_sdt_fhkmx_SJ20241231126_5116;

--6014条数据

DROP TABLE IF EXISTS tmp_sdt_fhkmx_SJ20241231126_5116  purge;
CREATE TABLE IF NOT EXISTS tmp_sdt_fhkmx_SJ20241231126_5116 as
SELECT  a.合同流水号
        ,a.借据流水号
        ,jj.kehuhaoo 客户号
        ,jj.kehuzwmc 客户名
        ,jj.kehuzhao 客户账号
        ,mx.mingxibh 明细编号
        ,mx.dkzhangh 贷款账号
        ,mx.huobdhao 货币代号
        ,mx.yngyjigo 营业机构
        ,mx.jiaoyirq 交易日期
        ,mx.dkrzhzhh 贷款入账账号
        ,mx.dkrzhzxh 贷款入账账号子序号
        ,mx.fkjineee 放款金额
        ,mx.fkzjclfs 放款资金处理方式
        ,mx.daixzhxh 待销账序号
        ,mx.djiebhao 冻结编号
        ,mx.zhchbjin 正常本金
        ,mx.yuqibjin 逾期本金
        ,mx.dzhibjin 呆滞本金
        ,mx.daizbjin 呆账本金
        ,mx.zijnlaiy 资金来源
        ,mx.huankzhh 还款账号
        ,mx.hkzhhzxh 还款账号子序号
        ,mx.keyongje 可用金额
        ,mx.hkzongee 还款总额
        ,mx.huankzht 还款状态   --1--提前还款 2--正常还款 3--逾期还款
        ,mx.ghbenjin 归还本金
        ,mx.ghysyjlx 归还应收应计利息
        ,mx.ghcsyjlx 归还催收应计利息
        ,mx.ghynshqx 归还应收欠息
        ,mx.ghcushqx 归还催收欠息
        ,mx.ghysyjfx 归还应收应计罚息
        ,mx.ghcsyjfx 归还催收应计罚息
        ,mx.ghynshfx 归还应收罚息
        ,mx.ghcushfx 归还催收罚息
        ,mx.ghyjfuxi 归还应计复息
        ,mx.ghfxfuxi 归还复息
        ,mx.ghfajinn 归还罚金
        ,mx.ghfeiyin 归还费用
        ,mx.jiaoyijg 交易机构
        ,mx.jiaoyigy 交易柜员
        ,mx.jiaoyils 交易流水
        ,mx.jiaoyisj 交易事件
        ,mx.shjshuom 事件说明
        ,mx.jiaoyima 交易码
        ,mx.zhaiyoms 摘要
        ,mx.daikghfs 贷款归还方式
        ,mx.hkbeizhu 还款备注
        ,mx.weihguiy 维护柜员
        ,mx.weihjigo 维护机构
        ,mx.weihriqi 维护日期
        ,mx.weihshij 维护时间
FROM    (
            SELECT  t1 . *
                    ,t2.cst_act_id   --客户账号
            FROM    tmp_sjxq_SJ20241231126_001 t1
            LEFT JOIN    edw.dwd_bus_loan_fnc_crd_lmt_inf_dd t2 --随贷通授信额度信息
            ON      t1.合同流水号 = t2.bus_ctr_id
            AND     t2.dt = '@@{yyyyMMdd}'
            WHERE   t1.借据流水号 LIKE 'SXK%'
        ) a
LEFT JOIN    edw.core_kclb_dkedjj jj --贷款额度借据主表,全量表
ON      a.借据流水号 = jj.jiejuhao
AND     jj.dt = '20241231'
LEFT JOIN    edw.core_klnl_dkkhmx mx --贷款客户账户交易明细表，增量表
ON      jj.jiejuhao = mx.dkjiejuh
AND     mx.dt <= '20241231'
and     mx.dt>='20190101'
WHERE   mx.jiaoyirq >= '20190101'
AND     mx.jiaoyirq <= '20241231'
;
**01-数据需求_村行_2025_D0116_梁嘉慧_客户经理梁嘉慧_工号_023188_管户下的信贷客户.sql
-- SJ20250113141
-- 截止2025年1月13日，广东四会泰隆村镇银行营业五部客户经理梁嘉慧（工号：023188）管户下的信贷客户


--征信
DROP TABLE IF EXISTS tmp_zhengxinfen_SJ20250113141 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zhengxinfen_SJ20250113141 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id ORDER BY qry_tm DESC ) rn
FROM    (
            SELECT  cst_id
                    ,cst_nm
                    ,cr_sco_val                              AS 中证评分
                    ,rpt_id --报告编号
                    ,REPLACE(substr(qry_tm, 1, 10), '-', '') AS qry_tm
                    ,'单'                                     AS typ
            FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
            WHERE   dt <= '@@{yyyyMMdd}'
            UNION ALL
            SELECT  cst_id
                    ,cst_nm
                    ,cst_cr_grd_val                  AS 中证评分
                    ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id --报告编号
                    ,prd_dt                          AS qry_tm
                    ,'批'                             AS typ
            FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
            WHERE   dt <= '@@{yyyyMMdd}'
        ) t;

--精准贷后
DROP TABLE IF EXISTS tmp_jingzhundaihou_SJ20250113141 PURGE;

CREATE TABLE IF NOT EXISTS tmp_jingzhundaihou_SJ20250113141 AS
SELECT  T1.cst_id                                                                                                                   AS 客户号
        ,SUBSTR(REPLACE(REPLACE(T2.tsk_gen_dt, '-', ''), '/', ''), 1, 8)                                                            AS 精准贷后时间
        ,t21.cd_val_dscr                                                                                                            AS 贷后检查任务类型
        ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY SUBSTR(REPLACE(REPLACE(T2.tsk_gen_dt, '-', ''), '/', ''), 1, 8) DESC ) AS rn
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
LEFT JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd t21
ON      T2.pst_loan_chk_tsk_typ_cd = t21.cd_val
AND     t21.dt = '@@{yyyyMMdd}'
AND     t21.tbl_nm = upper('dwd_bus_loan_psp_chk_tsk_inf_dd')
AND     t21.fld_nm = upper('pst_loan_chk_tsk_typ_cd')
WHERE   T1.dt = '@@{yyyyMMdd}'
AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
ORDER BY T1.cst_id
;


-- 字段：客户号	姓名	身份证号	手机号码	户籍地址	居住地址	经营地址	合同金额	合同余额	最近一次征信查询时间	征信结果	最近一次精准贷后时间	精准贷后类型

---结果表
DROP TABLE IF EXISTS tmp_guanhujiaojie_SJ20250113141 PURGE;

CREATE TABLE IF NOT EXISTS tmp_guanhujiaojie_SJ20250113141 AS
SELECT
--  mgr.CTR_SERNO AS 合同流水号
mgr.MGR_ID        AS 管护人工号
,mgr.MGR_NM       AS 管护人名称
,ctr.cst_id       AS 客户号
,ctr.cst_nm       AS 客户名称
,sum(ctr.ctr_amt) AS 合同金额
,sum(ctr.ctr_bal) AS 合同余额
,cbs.doc_nbr      AS 身份证号
,cbs.mbl_nbr      AS 手机号码
,cbs.reg_adr      AS 户籍地址
,cbs.fml_adr      AS 居住地
,cbs.wrk_adr      AS 单位或经营地址
,zx.qry_tm        AS 最近一次征信查询时间
,zx.中证评分          AS 最近一次征信分
,dh.精准贷后时间        AS 最近一次精准贷后时间
,dh.贷后检查任务类型      AS 精准贷后类型
FROM    edw.dwd_bus_loan_ctr_mgr_inf_dd mgr --信贷合同管护信息
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd ctr
ON      mgr.CTR_SERNO = ctr.ctr_serno
AND     ctr.dt = '@@{yyyyMMdd}'
-- -未结清
AND     ( ( ctr.CTR_STS_CD IN ( '2' , '4' )
AND     ctr.TMT_DT = '18991231'
AND     to_date(ctr.CTR_MTU_DT, 'yyyyMMdd') >= to_date(ctr.DT, 'yyyyMMdd') )
    OR ctr.CTR_BAL > 0 )
LEFT JOIN    edw.dws_cst_bas_inf_dd cbs
ON      ctr.cst_id = cbs.cst_id
AND     cbs.dt = '@@{yyyyMMdd}'
LEFT JOIN    tmp_zhengxinfen_SJ20250113141 zx
ON      ctr.cst_id = zx.cst_id
AND     zx.rn = 1
LEFT JOIN    tmp_jingzhundaihou_SJ20250113141 dh
ON      ctr.cst_id = dh.客户号
AND     dh.rn = 1
WHERE   mgr.dt = '@@{yyyyMMdd}'
AND     mgr.MGR_ID = '023188'
AND     ctr.cst_id IS NOT NULL
GROUP BY mgr.MGR_ID , mgr.MGR_NM , ctr.cst_id , ctr.cst_nm , cbs.doc_nbr , cbs.mbl_nbr , cbs.reg_adr , cbs.fml_adr , cbs.wrk_adr , zx.qry_tm , zx.中证评分 , dh.精准贷后时间 , dh.贷后检查任务类型
**01-数据需求_村行_2025_D0121_汝南村行_姚瑞帆_存量_非新发生_风险贷款利息清收明细.sql
-- 2024年9月1日到2024年12月31日，汝南村行存量（非新发生）风险贷款利息清收明细
-- 合同流水号，借据号、客户名称、客户号、利息清收金额、本金逾期时间、利息逾期时间，业务状态，逾期天数，重组标识，条线，
-- 管户客户经理名称，管户客户经理工号，经办客户经理名称，经办客户经理工号，发放客户经理名称，发放客户经理工号。


-- SJ2025012181
-- loan_bal_fld	bal_fld_cmt
-- CSHOFAXI	催收罚息
-- CSQIANXI	催收欠息
-- CSYJFAXI	催收应计罚息
-- DAITANLX	待摊利息
-- DZHIBJIN	呆滞本金
-- FUXIIIII	复息
-- HEXIAOBJ	核销本金
-- HEXIAOLX	核销利息
-- YIHXBJLX	已核销本金利息
-- YINGJIFX	应计复息
-- YSHOFAXI	应收罚息
-- YSQIANXI	应收欠息
-- YSYJFAXI	应收应计罚息
-- YSYJLIXI	应收应计利息
-- YSYJXXSH	应收应计销项税
-- YUQIBJIN	逾期本金
-- ZHCHBJIN	正常本金

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_rn_fxdk_SJ2025012181_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_rn_fxdk_SJ2025012181_01 AS
SELECT  A1.ctr_srl_no     AS 合同流水号
        ,A1.dbil_srl_no   AS 借据号
        ,A1.cst_nm        AS 客户名称
        ,A1.cst_id        AS 客户号
        ,A5.回收利息_202409_20241231
        ,A1.prcp_ovd_date AS 本金逾期时间
        ,A1.intr_ovd_date AS 利息逾期时间
        ,A1.bsn_sts       AS 业务状态
        ,A1.ovd_day       AS 逾期天数
		,A1.is_rsk_loan   AS 是否风险贷款
        ,A1.hpn_rsk_date  AS 出险日期
        ,A1.is_yr_new_hpn AS 是否年度新发生
        ,A1.rfin_ctg      AS 重组分类
        ,A1.bsn_label     AS 业务标识
        ,A1.bsn_line      AS 条线
        ,A1.mng_empe_id   AS 管户客户经理工号
        ,A2.empe_nm       AS 管户客户经理名称
        ,SUBSTR(A1.opr_empe_id,1,6)   AS 经办客户经理工号
        ,SUBSTR(A1.opr_empe_id,7)       AS 经办客户经理名称
        ,A1.grant_empe_id AS 发放客户经理工号
        ,A4.empe_nm       AS 发放客户经理名称
FROM    adm_rsk.ADM_RSK_APL_INTER_ALL A1 --风险集市应用表-资产质量日常监测源表
LEFT JOIN    edw.dws_hr_empe_inf_dd A2 --员工汇总信息
ON      A1.mng_empe_id = A2.empe_id
AND     A2.DT = '20241231'
LEFT JOIN    edw.dws_hr_empe_inf_dd A4 --员工汇总信息
ON      A1.grant_empe_id = A4.empe_id
AND     A4.DT = '20241231'
LEFT JOIN    (
                 SELECT  T1.loan_dbil_id
                         ,SUM(T1.trx_amt) AS 回收利息_202409_20241231
                 FROM    edw.dwd_bus_loan_act_trx_dtl_di T1 --贷款账户交易明细
                 WHERE   T1.DT >= '20240901'
                 AND     T1.DT <= '20241231'
				 AND     T1.trx_dir	= 1
                 AND     T1.loan_bal_fld IN ( 'CSHOFAXI' , 'CSQIANXI' , 'CSYJFAXI' , 'DAITANLX' , 'FUXIIIII' , 'HEXIAOLX' , 'YINGJIFX' , 'YSHOFAXI' , 'YSQIANXI' , 'YSYJFAXI' , 'YSYJLIXI' )
                 AND     T1.trx_evt IN ( 'LN_BXTZ' , 'LN_HXGH' , 'LN_TQHK' , 'LN_ZCHK' , 'LN_YQHK' ) --本息调整、核销归还、提前还款、正常还款、逾期还款
                 GROUP BY T1.loan_dbil_id
             ) A5
ON      A1.dbil_srl_no = A5.loan_dbil_id
WHERE   A1.DT = '20241231'
AND     A1.is_rsk_loan = 'Y' -- 是否风险贷款
AND     SUBSTR(A1.mng_org_id, 1, 4) = '4162';
**01-数据需求_村行_2025_D0208_大冶村行_冯廷灯_综合积分兑换明细.sql
-- 大冶村行2024年综合积分兑换明细（之前有申请）
-- SJ2025020666
-- 交易流水号	客户号	客户姓名	积分类型	交易标识	借贷标志	积分发生额	物料编码	品名	规格	单位	市场价格	积分价格	扣减数量	物资来源	交易渠道	交易机构	交易柜员	交易状态	备注	交易时间

--经沟通，该数据有现成的报表，从库管系统查询积分兑换明细。不用取


-- DROP TABLE IF EXISTS tmp_sjxq_SJ2025020666 PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025020666 AS
-- SELECT  DISTINCT t1.transno          AS 交易流水号
--                  ,t1.customersid     AS 积分客户号
--                  ,t4.hostcustno      AS 客户号
--                  ,t5.cst_act_id      AS 客户账号
--                  ,t5.mgr_id          AS 管护客户经理工号
--                  ,t6.empe_nm         AS 管护客户经理名称
--                  ,t5.acs_org_id      AS 管护机构号
--                  ,t7.org_nm          AS 管护机构名称
--                  ,t1.pointstypeno    AS 积分类型
--                  ,t1.pointsamount    AS 积分数额
--                  ,CASE
--                     WHEN t1.transchannel = '104020' THEN '手机银行'
--                     ELSE ''
--                   END                AS 交易渠道
--                  -- ,t1.institutionid AS 机构id
--                  ,t8.institutionno   AS 机构号
--                  ,t8.institutionname AS 机构名称
--                  ,t1.transtypeno     AS 交易类型
--                  ,t9.description     AS 交易类型说明
--                  ,t1.transdate       AS 交易时间
--                  ,case when t1.transstatus='1' then '成功'
--                  when t1.transstatus='0' then '失败'
--                  end AS 交易状态
--                  ,CASE
--                     WHEN t1.debitorcredit = 'C' THEN '贷'
--                     WHEN t1.debitorcredit = 'D' THEN '借'
--                   END                AS 借贷标志
--                  ,CASE
--                     WHEN t1.reversedflag = '0' THEN '正常'
--                     WHEN t1.reversedflag = '1' THEN '冲正'
--                     WHEN t1.reversedflag = '2' THEN '撤销'
--                     WHEN t1.reversedflag = '3' THEN '退货'
--                   END                AS 冲正标志
--                  -- ,t1.belongbranch    AS 积分归属机构
--                  ,t1.custno          AS 商户号
--                 --  ,t1.beizhu          AS 备注
--                  ,t1.description     AS 摘要
-- FROM    edw.sirs_pointstrans t1 --积分交易流水表，增量表
-- LEFT JOIN    edw.sirs_customers t4 --客户表
-- ON      t1.customersid = t4.customersid
-- AND     t4.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_bus_dep_act_mgr_inf_dd t5 --存款账户管护
-- ON      t4.hostcustno = t5.cst_id
-- AND     t5.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t7 --机构树_考核维度
-- ON      t5.acs_org_id = t7.org_id
-- AND     T7.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
-- ON      t5.mgr_id = T6.empe_id
-- AND     T6.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.sirs_institution t8 --积分机构表
-- ON      t1.institutionid = t8.institutionid
-- AND     t8.dt = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.sirs_transtype t9 --交易类型
-- ON      t1.transtypeno = t9.transtypeno
-- AND     t9.dt = '@@{yyyyMMdd}'
-- WHERE   t1.dt >= '20240101'
-- AND     t1.pointstypeno = '0001'  --综合积分
-- -- AND     t1.transstatus = '1'  --交易正常
-- -- AND     t1.reversedflag = '0' --冲正标志正常
-- AND     t1.custno = '1007' --泰惠收
-- AND     t8.institutionno LIKE '4261%'  --大冶村行
;



---积分兑换

-- --综合积分
-- AND di . PNT_TYP_CD = '0001'
-- --冲正标志正常
-- AND di . RVS_IND = '0'
-- --交易状态成功
-- AND di . TRX_STS_CD = '1'
-- --借贷标识：借
-- AND di . crd_and_dbt_ind
-- --积分消费
-- AND di . TRX_TYP_CD = '1001'

-- --积分产生
-- and     a.crd_and_dbt_ind='C'
-- AND     a.rvs_ind = '0'  --正常
-- AND     a.trx_sts_cd = '1'  --交易成功
**01-数据需求_村行_2025_D0212_庆元村行_吴煜珍_庆元村行新型农业经营主体数据.sql
--SJ20250210146

-- 截止2025.1.31号。庆元村行新型农业经营主体数据

-- 统一社会信用代码，营业执照名称，贷款余额


----1.4 个人工商法人:存在客户号和客户名称都是空的
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wz_jczb_SJ20250210146_fr PURGE;

CREATE TABLE lab_bigdata_dev.tmp_wz_jczb_SJ20250210146_fr AS
SELECT  distinct B1.*
FROM    (
            SELECT  c.*
                    ,RANK() OVER ( PARTITION BY c.by_qry_psn_doc_nbr  ORDER BY substr(replace(DAT_INS_TM,'-',''),1,8) DESC ) AS RN   -- 取某个证件号最新一次（精确到天）的查询信息
            FROM    (
                        SELECT  CST_ID              AS CST_ID
                                ,BY_QRY_PSN_NM      AS BY_QRY_PSN_NM   --被查询人姓名
                                ,by_qry_psn_doc_nbr AS by_qry_psn_doc_nbr
                                ,DAT_INS_TM         AS DAT_INS_TM  --数据插入时间
                                ,USCC               AS USCC  --统代
                                ,entp_nm            AS entp_nm  --企业名称
                                ,ENTP_TYP           AS ENTP_TYP
                                ,ENTP_STS           AS ENTP_STS
                                ,PVC                AS PVC
                        FROM    edw.DIM_CST_OUT_GEB_IDV_PPL_LGP_INF_DD --工商个人人员法人信息事实表新
                        WHERE   DT = '20250131'
                        AND     by_qry_psn_doc_nbr <> ''
                        and (coalesce(uscc,'')<>'' or coalesce(entp_id,'') <>'' or coalesce(entp_nm,'')<>'')
                        UNION
                        SELECT  CST_ID       AS CST_ID
                                ,CST_NM      AS BY_QRY_PSN_NM
                                ,doc_nbr     AS by_qry_psn_doc_nbr
                                ,QRY_TM      AS DAT_INS_TM
                                ,CSLD_CRD_CD AS USCC  --统代
                                ,entp_nm     AS entp_nm
                                ,ENTP_TYP    AS ENTP_TYP
                                ,ENTP_STS    AS ENTP_STS
                                ,PVC         AS PVC
                        FROM    edw.DIM_CST_OUT_GEB_IDV_LGP_INF_DD  --工商个人人员法人信息事实表老
                        WHERE   DT = '20250131'
                        AND     doc_nbr <> ''
                        and (coalesce(csld_crd_cd,'')<>'' or coalesce(entp_id,'')<>'' or coalesce(entp_nm,'')<>'')
                    ) c
        ) B1
WHERE   B1.RN = 1;

--企业工商



----结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_wz_jczb_SJ20250210146_final PURGE;

CREATE TABLE lab_bigdata_dev.tmp_wz_jczb_SJ20250210146_final AS
SELECT  a.col_1                          AS 客户号
        ,b.cst_chn_nm                    AS 客户姓名
        ,coalesce(d.USCC, e.csld_crd_cd) AS 证件号码
        ,coalesce(d.entp_nm, e.cst_nm)   AS 营业执照企业名称
        ,coalesce(d.entp_sts, e.opr_sts) AS 公司经营状态
        ,sum(c.ctr_bal)                  AS 我行未结清贷款余额
FROM    qbi_file_20250212_10_55_15_0 a
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      a.col_1 = b.cst_id
AND     b.dt = '20250131'
-- LEFT JOIN    edw.dws_cst_bas_inf_dd b1
-- ON      a.col_1 = b1.cst_id
-- AND     b1.dt = '20250131'
-- AND     b1.doc_typ_cd IN ( 'A0500' , 'A0100' , 'A0400' )
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd c
ON      a.col_1 = c.cst_id
AND     c.dt = '20250131'
-- 未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( c.CTR_STS_CD IN ( '2' , '4' )
AND     c.TMT_DT = '18991231'
AND     to_date(c.CTR_MTU_DT, 'yyyyMMdd') >= to_date(c.DT, 'yyyyMMdd') )
    OR c.CTR_BAL > 0 )
LEFT JOIN    tmp_wz_jczb_SJ20250210146_fr d --个人工商
ON      a.col_1 = d.cst_id
AND     coalesce(d.cst_id, '') <> ''
LEFT JOIN    edw.dim_cst_out_geb_bas_inf_dd e --企业工商
ON      a.col_1 = e.cst_id
AND     e.dt = '20250131'
AND     coalesce(e.cst_id, '') <> ''
WHERE   a.pt <> ''
GROUP BY a.col_1 , b.cst_chn_nm , coalesce(d.USCC, e.csld_crd_cd) , coalesce(d.entp_nm, e.cst_nm) , coalesce(d.entp_sts, e.opr_sts)
order by a.col_1 , b.cst_chn_nm
;
**01-数据需求_村行_2025_D0224_汝南村行_张亚娟_信贷系统中黑名单数据库清单.sql
-- SJ2025022466
-- 截至2025年2月24日，汝南村行信贷系统中黑名单数据库清单

-- 客户号；客户姓名；黑名单状态；生效日期；失效日期；加入名单员工编号；来源部门编号

DROP TABLE if EXISTS tmp_sjxq_SJ2025022466_runan PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2025022466_runan as
SELECT  cb.cst_id 客户号
        ,cb.cst_nm 客户姓名
        ,decode(cb.blist_sts, '1', '已生效', '2', '已失效') 黑名单状态
        ,cb.eff_dt 生效日期
        ,cb.nvld_dt 失效日期
        ,cb.join_nm_list_empe_id 加入名单员工编号
        ,cb.src_dept_no 来源部门编号
FROM    edw.loan_cst_blst cb
WHERE   cb.dt = '@@{yyyyMMdd}'
AND     cb.src_dept_no LIKE '4162%' --汝南
-- and last_upd_org LIKE '4162%'
AND     COALESCE(cb.DEL_IND, '') <> '1'
;
**01-数据需求_村行_2025_D0228_吴美健_庆元村行催收走访记录_常态化_.sql
-- SJ2025031261
-- 20250101-20250228庆元村行催收走访记录

--走访人，走访时间、走访地点等
--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2025031261 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2025031261 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '20250228'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2025-01-01 00:00:00' and '2025-02-28 00:00:00'
ORDER BY t1.coln_date
;
**01-数据需求_村行_D0511_庆元村行_许巍文_客户风险数据.sql
-- 补充附件表格中'AK-AP'列，预评估结果、征信规则触发逾期内容、抗辩理由、法院预评估规则提示内容、最近一次精准贷后触犯时间、最近一次精准贷后触犯原因



--------附件临时表结构

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_fengxian_20240511_1530_01 PURGE;



-- CREATE TABLE lab_bigdata_dev.tmp_qinyuan_fengxian_20240511_1530_01

-- (

    -- ,序号                        STRING

    -- ,客户号                      STRING

    -- ,客户名称                    STRING

    -- ,主管户客户经理              STRING

    -- ,主管户客户经理名称          STRING

    -- ,是否客户经理                STRING

    -- ,主管户机构                  STRING

    -- ,正式客户标识                STRING

    -- ,有效户标识                  STRING

    -- ,有效存款户标识              STRING

    -- ,有效贷款户标识              STRING

    -- ,存款月日均                  STRING

    -- ,各项存款余额                STRING

    -- ,授信总额                    STRING

    -- ,用信余额                    STRING

    -- ,普惠子社区编号              STRING

    -- ,普惠子社区名称              STRING

    -- ,定人1                       STRING

    -- ,定人2                       STRING

    -- ,定人3                       STRING

    -- ,主地址类型                  STRING

    -- ,主地址                      STRING

    -- ,经营地址                    STRING

    -- ,经营地址街道                STRING

    -- ,单位地址                    STRING

    -- ,通讯地址                    STRING

    -- ,家庭地址                    STRING

    -- ,户籍地址                    STRING

    -- ,注册地址                    STRING

    -- ,存在问题                    STRING

    -- ,应归属机构                  STRING

    -- ,机构核实应归属机构是否有误 STRING

    -- ,是否同意带基数交接          STRING

    -- ,有误情况说明                STRING

    -- ,是否整改                    STRING

    -- ,备注                        STRING

-- )  ;





--结果表

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingyuan_fengxian_20240511_1530_02 PURGE;



CREATE TABLE lab_bigdata_dev.tmp_qingyuan_fengxian_20240511_1530_02 AS

SELECT  T1.序号

        ,T1.客户号

        ,T1.客户名称

        ,T1.主管户客户经理

        ,T1.主管户客户经理名称

        ,T1.是否客户经理

        ,T1.主管户机构

        ,T1.正式客户标识

        ,T1.有效户标识

        ,T1.有效存款户标识

        ,T1.有效贷款户标识

        ,T1.存款月日均

        ,T1.各项存款余额

        ,T1.授信总额

        ,T1.用信余额

        ,T1.普惠子社区编号

        ,T1.普惠子社区名称

        ,T1.定人1

        ,T1.定人2

        ,T1.定人3

        ,T1.主地址类型

        ,T1.主地址

        ,T1.经营地址

        ,T1.经营地址街道

        ,T1.单位地址

        ,T1.通讯地址

        ,T1.家庭地址

        ,T1.户籍地址

        ,T1.注册地址

        ,T1.存在问题

        ,T1.应归属机构

        ,T1.机构核实应归属机构是否有误

        ,T1.是否同意带基数交接

        ,T1.有误情况说明

        ,T1.是否整改

        ,T1.备注

        ,T2.预评估结果 AS 最近一次预评估结果

        ,T3.征信规则触发逾期内容

        ,T4.抗辩理由

        ,T5.法院预评估规则提示内容

        ,T6.最近一次精准贷后触犯时间

        ,T6.最近一次精准贷后触犯原因

FROM    lab_bigdata_dev.tmp_qinyuan_fengxian_20240511_1530_01 T1

LEFT JOIN    (

                 SELECT  A1.applyserialno

                         ,A1.customerid

                         ,A1.preevaluateresult --预评估结果

                         ,A2.cd_val_dscr                                                              AS 预评估结果

                         ,ROW_NUMBER() OVER ( PARTITION BY A1.customerid ORDER BY A1.inputdate DESC,serialno DESC ) AS RN --最最新一条预评估结果

                 FROM    edw.loan_customer_preevaluate_result A1 --预评估最终结果信息

                 LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表

                 ON      A1.preevaluateresult = A2.cd_val

                 AND     A2.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'

                 AND     A2.fld_nm = 'PREEVALUATERESULT'

                 AND     A2.dt = '@@{yyyyMMdd}'

                 WHERE   A1.dt = '@@{yyyyMMdd}'

             ) T2

ON      T1.客户号 = T2.customerid

AND     T2.RN = 1

LEFT JOIN    (

                 SELECT  apl_srl_nbr

                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 征信规则触发逾期内容

                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表

                 WHERE   DT = '@@{yyyyMMdd}'

                 AND     sgs_inf RLIKE '逾期'

                 AND     COALESCE(sgs_inf, '') <> ''

                 AND     qry_cntnt = '07' --查询内容征信规则

                 GROUP BY apl_srl_nbr

             ) T3

ON      T2.applyserialno = T3.apl_srl_nbr

LEFT JOIN    (

                 SELECT  applyserialno

                         ,WM_CONCAT(DISTINCT '||', opinion) AS 抗辩理由

                 FROM    edw.loan_defend_opinion --预评估抗辩意见

                 WHERE   opiniontype = '1' --抗辩理由

                 AND     COALESCE(opinion, '') <> ''

                 AND     DT = '@@{yyyyMMdd}'

                 GROUP BY applyserialno

             ) T4

ON      T2.applyserialno = T4.applyserialno

LEFT JOIN    (

                 SELECT  apl_srl_nbr

                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 法院预评估规则提示内容

                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表

                 WHERE   DT = '@@{yyyyMMdd}'

                 AND     COALESCE(sgs_inf, '') <> ''

                 AND     qry_cntnt = '05' --法院执行记录

                 GROUP BY apl_srl_nbr

             ) T5

ON      T2.applyserialno = T5.apl_srl_nbr

LEFT JOIN    (

                 SELECT  cst_id

                         ,vio_rsn_ana                                               AS 最近一次精准贷后触犯原因

                         ,tsk_mak_dt                                                AS 最近一次精准贷后触犯时间

                         ,RANK() OVER ( PARTITION BY cst_id ORDER BY srl_nbr DESC ) AS RN

                 FROM    edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd --精准贷后结果信息表

                 WHERE   DT = '@@{yyyyMMdd}'

                 AND     rsk_trg_typ_cd <> ''

             ) T6

ON      T1.客户号 = T6.cst_id

AND     T6.RN = 1;
**01-数据需求_村行_D0511_高昂_叶县村行全量信贷客户.sql
--用途：取历史发生过信贷业务的全量客户，将已结清业务的客户根据主地址挂靠至相应的子社区和管户客户经理，避免长期未发生业务的客户再次发生业务时，管户仍归属于原先的客户经理，但其实际地址不属于该客户经理的子社区。

--字段：客户号、客户名称、管户机构名称、管户客户经理名称、历史最高授信总额、24.04.30授信总额、24.04.30贷款余额、归属子社区编号、归属子社区名称、归属子社区主维护人、主地址、经营地址、户籍地址


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_kehushequ_yx_0430 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_kehushequ_yx_0430 AS
SELECT  a.cst_id 客户号
        ,a.cst_nm 客户名称
        ,f.prm_mgr_nm 主管护人
        ,f.prm_org_nm 主管护机构名称
        ,max(a.ctr_amt) 历史最高授信总额
        ,sum(a.ctr_amt) 授信总额
        ,sum(a.ctr_bal) 贷款余额
        ,g.sub_cmnt_id 子社区编号
        ,g.sub_cmnt_nm 子社区名称
        ,g.com_vindicate_id 子社区主维护人工号
        ,g.empe_nm 子社区主维护人姓名
        ,c.ful_adr 地址
        ,CASE
           WHEN c.PHY_ADR_TYP_CD = '050900' THEN '经营地址'
           WHEN c.PHY_ADR_TYP_CD = '050100' THEN '户籍地址'
           WHEN c.PHY_ADR_TYP_CD = '050800' THEN '注册地址'
           WHEN c.PHY_ADR_TYP_CD = '050200' THEN '家庭地址'
           WHEN c.PHY_ADR_TYP_CD = '050400' THEN '单位地址'
           WHEN c.PHY_ADR_TYP_CD = '050300' THEN '通讯地址'
           ELSE '其他地址'
         END AS 地址类型
        ,c.prm_adr_ind 主地址标志 --1为主地址
FROM    edw.dim_bus_loan_ctr_inf_dd a --信贷合同信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd f --客户主管护
ON      a.cst_id = f.cst_id
AND     f.dt = '20240430'
LEFT JOIN    (
                 SELECT  b.cst_id
                         ,b.sub_cmnt_id
                         ,b.sub_cmnt_nm
                         ,h.com_vindicate_id
                         ,J.empe_nm
                 FROM    edw.dwd_cst_mng_cmnt_rel_dd b --客户社区信息
                 LEFT JOIN    edw.xwdt_xw_community h --社区信息表
                 ON      b.sub_cmnt_id = h.com_code
                 AND     h.dt = '20240430'
				 LEFT JOIN   edw.dws_hr_empe_inf_dd J --员工汇总信息
                 ON     h.com_vindicate_id = J.empe_id
                 AND    J.dt = '20240430'
                 WHERE   b.dt = '20240430'
                 AND     b.dpd_sts_cd='1'   --挂靠状态，1,0
             ) g
ON      a.cst_id = g.cst_id
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd c --客户物理地址信息
ON      a.cst_id = c.cst_id
AND     c.dt = '20240430'
WHERE   a.dt = '20240430'
AND     a.END_DT <> '18991231' --已结清
AND     substr(a.hdl_org_id, 1, 4) = '4161'--叶县村行
GROUP BY a.cst_id
        ,a.cst_nm
        ,f.prm_mgr_nm
        ,f.prm_org_nm
       ,g.sub_cmnt_id
        ,g.sub_cmnt_nm
        ,g.com_vindicate_id
        ,g.empe_nm
        ,c.ful_adr
        ,c.PHY_ADR_TYP_CD
        ,c.prm_adr_ind
;


SELECT * FROM lab_bigdata_dev.tmp_kehushequ_yx_0430   WHERE 客户号='1617635015'
;

------客户表
--字段：客户号、客户名称、管户机构名称、管户客户经理名称、历史最高授信总额、24.04.30授信总额、24.04.30贷款余额、归属子社区编号、归属子社区名称、归属子社区主维护人、主地址、经营地址、户籍地址
---小鱼管家中的地址信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_kehushequ_yx_0430_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_kehushequ_yx_0430_01 AS
SELECT  a.cst_id 客户号
        ,a.cst_nm 客户名称
        ,max(a.ctr_amt) 历史最高授信总额
        ,sum(a.ctr_amt) 授信总额
        ,sum(a.ctr_bal) 贷款余额
        ,f.manager_no 管护人号
        ,f.manager_name 管护人名称
        ,f.manager_org_no 管护机构号
        ,f.manager_org_name 管护机构名称
        ,f.com_son_code 所属子社区编号
        ,f.com_son_name 所属子社区名称
        ,f.com_vindicate_name 归属子社区主维护人
        ,f.main_add_flag_n 主地址标示
        ,f.operate_add 经营地址
        ,f.con_regist_add 注册地址
        ,f.fam_add 家庭地址
        ,f.regist_add 户籍地址
        ,f.unit_add 单位地址
        ,f.comm_add 通讯地址
FROM    edw.dim_bus_loan_ctr_inf_dd a --信贷合同信息
LEFT JOIN    (
                 SELECT  b.cust_no --客户号
                         ,b.cust_name --客户姓名
                         ,b.manager_no --管护人号
                         ,b.manager_name --管护人名称
                         ,b.manager_org_no --管护机构号
                         ,b.manager_org_name --管护机构名称
                         ,b.com_son_code --所属子社区编号
                         ,b.com_son_name --所属子社区名称
                         ,j.com_vindicate_name
                         ,CASE
                            WHEN b.main_add_flag = '1' THEN '经营'
                            WHEN b.main_add_flag = '2' THEN '通讯'
                            WHEN b.main_add_flag = '3' THEN '家庭'
                            WHEN b.main_add_flag = '4' THEN '户籍'
                            WHEN b.main_add_flag = '5' THEN '办公'
                            WHEN b.main_add_flag = '6' THEN '注册'
                            ELSE '其他'
                          END AS main_add_flag_n
                         ,h.operate_add --经营地址
                         ,h.con_regist_add --注册地址
                         ,h.fam_add --家庭地址
                         ,h.regist_add --户籍地址
                         ,h.unit_add --单位地址
                         ,h.comm_add --通讯地址
                 FROM    edw.xwdt_xw_customer b --客户表（正潜灰）
                 LEFT JOIN    edw.xwdt_xw_customer_addr h --客户地址信息表(全量表)
                 ON      b.cust_no = h.cust_no
                 AND     h.dt = '20240430'
                 LEFT JOIN    edw.xwdt_xw_community j --社区信息表
                 ON      b.com_son_code = j.com_code
                 AND     j.dt = '20240430'
                 WHERE   b.dt = '20240430'
             ) f
ON      f.cust_no = a.cst_id
WHERE   a.dt = '20240430'
AND     a.END_DT <> '18991231' --已结清
AND     substr(a.hdl_org_id, 1, 4) = '4161'  --叶县村行
GROUP BY  a.cst_id
        ,a.cst_nm
        ,f.manager_no
        ,f.manager_name
        ,f.manager_org_no
        ,f.manager_org_name
        ,f.com_son_code
        ,f.com_son_name
        ,f.com_vindicate_name
        ,f.main_add_flag_n
        ,f.operate_add
        ,f.con_regist_add
        ,f.fam_add
        ,f.regist_add
        ,f.unit_add
        ,f.comm_add

;

SELECT * from lab_bigdata_dev.tmp_kehushequ_yx_0430_01 WHERE 所属子社区编号 is not null
**01-数据需求_村行_D0511_高昂_叶县村行全量信贷客户_n.sql
--用途：取历史发生过信贷业务的全量客户，将已结清业务的客户根据主地址挂靠至相应的子社区和管户客户经理，避免长期未发生业务的客户再次发生业务时，管户仍归属于原先的客户经理，但其实际地址不属于该客户经理的子社区。

--字段：客户号、客户名称、管户机构名称、管户客户经理名称、历史最高授信总额、24.04.30授信总额、24.04.30贷款余额、归属子社区编号、归属子社区名称、归属子社区主维护人、主地址、经营地址、户籍地址

--edw.dim_bus_loan_ctr_inf_dd  --信贷合同信息
--edw.dwd_cst_mng_cmnt_rel_dd   --客户社区信息
--app_ado.fct_ado_cst_view_adr_inf  --客户视图-地址信息表


SELECT * from app_ado.fct_ado_cst_view_adr_inf WHERE dt='20240430' LIMIT 1000
**01-数据需求_村行_D0514_庆元村行_吴文雅_客户风险数据.sql
--截止2024年4月30日庆元村行异地业务
--字段：工作单位地址/经营地址	预评估结果 征信规则触发逾期内容 抗辩理由 法院预评估规则提示内容	最近一次精准贷后触犯时间 最近一次精准贷后触犯原因 调查报告披露的经营项目 调查报告披露的经营基本情况分析



--附件表结构
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_20240514_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_20240514_01
-- (
   --  管护机构号                 STRING
   -- ,管户人工号                 STRING
   -- ,客户号                     STRING
   -- ,客户名称                   STRING
   -- ,合同号                     STRING
   -- ,证件号码                   STRING
   -- ,账户类型                   STRING
   -- ,合同起始日期               STRING
   -- ,合同到期日期               STRING
   -- ,合同金额                   STRING
   -- ,合同余额                   STRING
   -- ,客户授信总额               STRING
   -- ,工作单位地址_经营地址      STRING
   -- ,实际利率_月                STRING
   -- ,逾期天数                   STRING
   -- ,本金逾期日期               STRING
   -- ,利息逾期日期               STRING
   -- ,五级分类代码               STRING
   -- ,贷款担保方式_集市          STRING
   -- ,用途备注_信贷              STRING
   -- ,发生类型_信贷              STRING
   -- ,户籍地址_注册地址          STRING
 -- ) ;


------------------------------
--临时表二 客户最新一条预评估、精准贷后信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_20240514_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_20240514_02 AS
SELECT  T1.客户号
        ,T2.预评估结果             AS 最近一次预评估结果
        ,T3.征信规则触发逾期内容   AS 最近一次预评估征信规则触发逾期内容
        ,T4.抗辩理由               AS 最近一次预评估抗辩理由
        ,T5.法院预评估规则提示内容 AS 最近一次预评估法院规则提示内容
        ,T6.最近一次精准贷后触犯时间
        ,T6.最近一次精准贷后触犯原因
FROM    (
            SELECT  DISTINCT 客户号
            FROM    lab_bigdata_dev.tmp_qinyuan_dk_20240514_01
        ) T1
LEFT JOIN    (
                 SELECT  A1.applyserialno
                         ,A1.customerid
                         ,A1.preevaluateresult --预评估结果
                         ,A2.cd_val_dscr                                                                              AS 预评估结果
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.customerid ORDER BY A1.inputdate DESC , serialno DESC ) AS RN --最最新一条预评估结果
                 FROM    edw.loan_customer_preevaluate_result A1 --预评估最终结果信息
                 LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表
                 ON      A1.preevaluateresult = A2.cd_val
                 AND     A2.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'
                 AND     A2.fld_nm = 'PREEVALUATERESULT'
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
             ) T2
ON      T1.客户号 = T2.customerid
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 征信规则触发逾期内容
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     sgs_inf RLIKE '逾期'
                 AND     COALESCE(sgs_inf, '') <> ''
                 AND     qry_cntnt = '07' --查询内容征信规则
                 GROUP BY apl_srl_nbr
             ) T3
ON      T2.applyserialno = T3.apl_srl_nbr
LEFT JOIN    (
                 SELECT  applyserialno
                         ,WM_CONCAT(DISTINCT '||', opinion) AS 抗辩理由
                 FROM    edw.loan_defend_opinion --预评估抗辩意见
                 WHERE   opiniontype = '1' --抗辩理由
                 AND     COALESCE(opinion, '') <> ''
                 AND     DT = '@@{yyyyMMdd}'
                 GROUP BY applyserialno
             ) T4
ON      T2.applyserialno = T4.applyserialno
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 法院预评估规则提示内容
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     COALESCE(sgs_inf, '') <> ''
                 AND     qry_cntnt = '05' --法院执行记录
                 GROUP BY apl_srl_nbr
             ) T5
ON      T2.applyserialno = T5.apl_srl_nbr
LEFT JOIN    (
                 SELECT  cst_id
                         ,vio_rsn_ana                                               AS 最近一次精准贷后触犯原因
                         ,tsk_mak_dt                                                AS 最近一次精准贷后触犯时间
                         ,RANK() OVER ( PARTITION BY cst_id ORDER BY srl_nbr DESC ) AS RN
                 FROM    edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd --精准贷后结果信息表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     rsk_trg_typ_cd <> ''
             ) T6
ON      T1.客户号 = T6.cst_id
AND     T6.RN = 1;

------------------------------
--临时表三 合同准入时预评估信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_20240514_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_20240514_03 AS
SELECT  T1.合同号
        ,A2.cd_val_dscr            AS 准入时预评估结果
        ,T3.征信规则触发逾期内容   AS 准入时预评估征信规则触发逾期内容
        ,T4.抗辩理由               AS 准入时预评估抗辩理由
        ,T5.法院预评估规则提示内容 AS 准入时预评估法院规则提示内容
FROM    (
            SELECT  DISTINCT 合同号
            FROM    lab_bigdata_dev.tmp_qinyuan_dk_20240514_01
        ) T1
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd T11 --信贷合同信息
ON      T1.合同号 = T11.busi_ctr_id
AND     T11.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_customer_preevaluate_result T2 --预评估最终结果信息
ON      T11.pre_apl_srl_nbr = T2.serialno
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表
ON      T2.preevaluateresult = A2.cd_val
AND     A2.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'
AND     A2.fld_nm = 'PREEVALUATERESULT'
AND     A2.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 征信规则触发逾期内容
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     sgs_inf RLIKE '逾期'
                 AND     COALESCE(sgs_inf, '') <> ''
                 AND     qry_cntnt = '07' --查询内容征信规则
                 GROUP BY apl_srl_nbr
             ) T3
ON      T2.applyserialno = T3.apl_srl_nbr
LEFT JOIN    (
                 SELECT  applyserialno
                         ,WM_CONCAT(DISTINCT '||', opinion) AS 抗辩理由
                 FROM    edw.loan_defend_opinion --预评估抗辩意见
                 WHERE   opiniontype = '1' --抗辩理由
                 AND     COALESCE(opinion, '') <> ''
                 AND     DT = '@@{yyyyMMdd}'
                 GROUP BY applyserialno
             ) T4
ON      T2.applyserialno = T4.applyserialno
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 法院预评估规则提示内容
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     COALESCE(sgs_inf, '') <> ''
                 AND     qry_cntnt = '05' --法院执行记录
                 GROUP BY apl_srl_nbr
             ) T5
ON      T2.applyserialno = T5.apl_srl_nbr
;

------------------------------
--临时表四 信贷调查报告信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_20240514_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_20240514_04 AS
SELECT T1.合同号
         ,T3.opr_prj                                AS 调查报告披露的经营项目
         ,T3.opr_situ_dscr_and_evl                  AS 调查报告披露的经营基本情况分析
FROM    (
            SELECT  DISTINCT 合同号
            FROM    lab_bigdata_dev.tmp_qinyuan_dk_20240514_01
        ) T1
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd T11 --信贷合同信息
ON      T1.合同号 = T11.busi_ctr_id
AND     T11.DT = '@@{yyyyMMdd}'
LEFT JOIN   edw.dwd_bus_loan_cvy_main_inf_dd T2 --信贷业务调查报告主信息
ON     T1.busi_apl_id	 = T2.apl_srl_nbr
AND    T2.DT = '@@{yyyyMMdd}'
LEFT JOIN   edw.dwd_bus_loan_cvy_opr_inf_dd T3 --信贷业务调查报告-客户经营信息
ON     T2.rpt_srl_nbr	 = T3.bus_id
AND    T3.DT = '@@{yyyyMMdd}'
;

------------------------------
------------------------------
--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_20240514_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_20240514_05 AS
SELECT  T1.管护机构号
        ,T1.管户人工号
        ,T1.客户号
        ,T1.客户名称
        ,T1.合同号
        ,T1.证件号码
        ,T1.账户类型
        ,T1.合同起始日期
        ,T1.合同到期日期
        ,T1.合同金额
        ,T1.合同余额
        ,T1.客户授信总额
        ,T1.工作单位地址_经营地址
        ,T1.实际利率_月
        ,T1.逾期天数
        ,T1.本金逾期日期
        ,T1.利息逾期日期
        ,T1.五级分类代码
        ,T1.贷款担保方式_集市
        ,T1.用途备注_信贷
        ,T1.发生类型_信贷
        ,T1.户籍地址_注册地址
        ,T2.最近一次预评估结果
        ,T2.最近一次预评估征信规则触发逾期内容
        ,T2.最近一次预评估抗辩理由
        ,T2.最近一次预评估法院规则提示内容
        ,T2.最近一次精准贷后触犯时间
        ,T2.最近一次精准贷后触犯原因
        ,T3.准入时预评估结果
        ,T3.准入时预评估征信规则触发逾期内容
        ,T3.准入时预评估抗辩理由
        ,T3.准入时预评估法院规则提示内容
        ,T4.调查报告披露的经营项目
        ,T4.调查报告披露的经营基本情况分析
        ,T5.经营所在地地址
        ,T6.工作单位地址
FROM    lab_bigdata_dev.tmp_qinyuan_dk_20240514_01 T1
LEFT JOIN    lab_bigdata_dev.tmp_qinyuan_dk_20240514_02 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_qinyuan_dk_20240514_03 T3
ON      T1.合同号 = T3.合同号
LEFT JOIN    lab_bigdata_dev.tmp_qinyuan_dk_20240514_04 T4
ON      T1.合同号 = T4.合同号
LEFT JOIN    (
                 SELECT  cst_id
                         ,ful_adr                                                        AS 经营所在地地址
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY upd_dt DESC ) AS RN
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd --客户物理地址信息
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     phy_adr_typ_cd = '050900' --经营所在地地址
             ) T5
ON      T1.客户号 = T5.cst_id
AND     T5.RN = 1
LEFT JOIN    (
                 SELECT  cst_id
                         ,ful_adr                                                        AS 工作单位地址
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY upd_dt DESC ) AS RN
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd --客户物理地址信息
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     phy_adr_typ_cd = '050400' --工作单位地址
             ) T6
ON      T1.客户号 = T6.cst_id
AND     T6.RN = 1
;



SELECT count(*) FROM lab_bigdata_dev.tmp_qinyuan_dk_20240514_05
**01-数据需求_村行_D0515_汝南村行_耿鹏程_到期业务汝南村行预审批使用情况.sql
--截止目前，五月底前到期业务汝南村行预审批使用情况
--字段：客户编号 客户名称 原合同流水号	原合同发生类型	业务品种 合同金额 合同余额 执行利率 合同起始日	合同到期日	是否发起预审批	预审批发起时间

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240507141 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ20240507141 AS
SELECT  p.COL_1 客户编号
        ,p.COL_2 客户名称
        ,p.COL_3 原合同流水号
        ,p.COL_4 原合同发生类型
        ,p.COL_5 业务品种
        ,p.COL_6 合同金额
        ,p.COL_7 合同余额
        ,p.COL_8 执行利率
        ,substr(p.COL_9,1,10)  合同起始日
        ,substr(p.COL_10,1,10) 合同到期日
        ,decode(p3.occurtype, '011', '续做', '010', '首笔', '') AS 新发生类型
        ,CASE
           WHEN p3.isseamlessloan = '1' THEN '是'
           WHEN p3.isseamlessloan = '2' THEN '否'
           ELSE ''
         END AS 是否发起预审批
        ,p3.occurdate 预审批发起时间
        ,p3.putoutdate  预审批申请日期
        ,p3.serialno 业务申请流水号
        ,p2.serialno 对应合同流水号
FROM    lab_bigdata_dev.qbi_file_20240515_16_32_23 p --导入客户数据
LEFT JOIN    (
                 SELECT  t.customerid
                         ,t.occurdate
                         ,t.putoutdate
                         ,t.isseamlessloan
                         ,t.occurtype
                         ,t.serialno
                         ,ROW_NUMBER() OVER ( PARTITION BY t.customerid ORDER BY t.occurdate DESC ) AS rn
                 FROM    edw.loan_business_apply t  --业务申请表
                 WHERE   t.dt = '@@{yyyyMMdd}'
                 AND     t.seamlessloantype = '4'  --预审批标识
             ) p3
ON      p.col_1 = p3.customerid
AND     p3.rn = 1
LEFT JOIN    edw.loan_business_contract p2 --业务合同表
ON      p3.serialno = p2.relativeserialno   --申请流水号关联
AND     p2.dt = '@@{yyyyMMdd}'
AND     p2.seamlessloantype = '4' --预审批
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240515_16_32_23');




--SELECT * FROM lab_bigdata_dev.tmp_sjxq_SJ20240507141;
**01-数据需求_村行_D0517_龙海村行_黄瑄妮_是否农户.sql
--
--字段：龙海村行信贷系统有建档的客户；农户口径：信贷系统中&ldquo;是否农户&rdquo;；字段：客户号，2022年12月底农户类型为&ldquo;是&rdquo;、2023年12月底农户类型为&ldquo;否&rdquo;
--客户号，客户名称，是否农户_2022,是否农户_2023

--edw.loan_ind_info --个人信息表 ,farmer
--edw.loan_ent_info-- 企业基本信息,farmer
--edw.loan_customer_info --客户基本信息
--edw.loan_customer_belong --客户所属列表，belongattribute='1'，主管护;userid --管护人


--2022年是农户
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2022 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2022 AS
SELECT  *
FROM    (
            SELECT  cb.customerid 客户编号
                    ,T1.fullname 客户名称
                    ,case when T1.farmer='1' then '是'
                       when T1.farmer in ('2','0') then '否'
                    end as 是否农户_2022
            FROM    edw.loan_customer_belong cb --客户所属列表
            LEFT JOIN    edw.loan_ind_info T1 --个人信息表
            ON      cb.customerid = T1.customerid
            AND     T1.dt ='20221231'
            WHERE   cb.dt  ='20221231'
            AND     cb.belongattribute = '1' --当前主管护
            AND     substr(cb.orgid, 1, 4) = '3563' --龙海村行
            UNION ALL
            SELECT  cb.customerid 客户编号
                    ,T2.enterprisename 客户名称
                    ,case when T2.farmer='1' then '是'
                       when T2.farmer in ('2','0') then '否'
                    end as 是否农户_2022
            FROM    edw.loan_customer_belong cb --客户所属列表
            LEFT JOIN    edw.loan_ent_info T2 --企业信息表
            ON      cb.customerid = T2.customerid
            AND     T2.dt ='20221231'
            WHERE   cb.dt ='20221231'
            AND     cb.belongattribute = '1' --当前主管护
            AND     substr(cb.orgid,1,4) = '3563' --龙海村行
        ) T
WHERE   T.是否农户_2022 is not null;

SELECT * from lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2022 ;

--2023年
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2023 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2023 AS
SELECT  *
FROM    (
            SELECT  cb.customerid 客户编号
                    ,T1.fullname 客户名称
                    ,CASE
                       WHEN T1.farmer = '1'            THEN '是'
                       WHEN T1.farmer IN ( '2' , '0' ) THEN '否'
                     END AS isfarmer
            FROM    edw.loan_customer_belong cb --客户所属列表
            LEFT JOIN    edw.loan_ind_info T1 --个人信息表
            ON      cb.customerid = T1.customerid
            AND     T1.dt = '20231231'
            WHERE   cb.dt = '20231231'
            AND     cb.belongattribute = '1' --当前主管护
            AND     substr(cb.orgid, 1, 4) = '3563'  --龙海村行
            UNION ALL
            SELECT  cb.customerid 客户编号
                    ,T2.enterprisename 客户名称
                    ,CASE
                       WHEN T2.farmer = '1'            THEN '是'
                       WHEN T2.farmer IN ( '2' , '0' ) THEN '否'
                     END AS isfarmer
            FROM    edw.loan_customer_belong cb --客户所属列表
            LEFT JOIN    edw.loan_ent_info T2 --企业信息表
            ON      cb.customerid = T2.customerid
            AND     T2.dt = '20231231'
            WHERE   cb.dt = '20231231'
            AND     cb.belongattribute = '1' --当前主管护
            AND     substr(cb.orgid, 1, 4) = '3563'  --龙海村行
        ) T
WHERE   T.isfarmer IS NOT NULL
;


--SELECT * from lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2023;

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_lhchjdk_SJ2024051671 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_lhchjdk_SJ2024051671 AS
SELECT T1.客户编号
       ,T1.客户名称
       ,T1.是否农户_2022
       ,T2.isfarmer as 是否农户_2023
FROM  lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2022 T1
LEFT JOIN lab_bigdata_dev.tmp_lhchjdk_SJ2024051671_2023 T2
ON T1.客户编号=T2.客户编号
;

SELECT count(distinct 客户编号 ) FROM lab_bigdata_dev.tmp_lhchjdk_SJ2024051671
**01-数据需求_村行_D0520_庆元村行_吴美健_客户催收走访记录.sql
--2024年4月（20240401-20240430）庆元村行催收走访记录
--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024051186 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024051186 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     substr(t1.coln_date,1,7) ='2024-04'
;



SELECT count(*) FROM lab_bigdata_dev.tmp_sjxq_SJ2024051186
;
**01-数据需求_村行_D0520_龙海村行_张凯丽_随贷通客户信息.sql
-- 2024年1月1日至2024年4月30日龙海村行开立随贷通卡的业务。

-- 所属机构号、管户客户经理、客户编号、客户名称、授信总额、授信余额、是否为随贷通卡客户、征信分、现有贷款机构家数、我行历史逾期次数、

-- 该客户项下强关联客户对象（父母、配偶、子女、名下企业、企业法定代表人、合伙人等）。



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_longhai_sdt_20240530_01;



CREATE TABLE lab_bigdata_dev.tmp_longhai_sdt_20240530_01 AS

SELECT  T2.acs_org_id          AS 所属机构号

        ,T2.acs_mngr_id        AS 管户客户经理工号

        ,T3.empe_nm            AS 管户客户经理

        ,T1.busi_ctr_id        AS 合同号

        ,T1.cst_id             AS 客户编号

        ,T1.cst_nm             AS 客户名称

        ,T1.ctr_amt            AS 授信总额

        ,T1.ctr_bal            AS 授信余额

        ,'是'                   AS 是否为随贷通卡客户

        ,T4.idv_crd_sco_val    AS 征信分

        ,T4.curr_loan_bank_num AS 现有贷款机构家数

        ,T8.我行历史逾期借据数

        ,T6.cd_val_dscr        AS 关联关系类型

        ,T5.rel_cst_id         AS 关联客户编号

        ,T7.cst_chn_nm         AS 关联客户名称

FROM    edw.dim_bus_loan_ctr_inf_dd T1 --信贷合同信息

LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T2 --信贷合同管护信息

ON      T1.busi_ctr_id = T2.busi_ctr_id

AND     T2.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dws_hr_empe_inf_dd T3 --员工汇总信息

ON      T2.acs_mngr_id = T3.empe_id

AND     T3.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T4 --个人征信指标信息表

ON      T1.cst_id = T4.cst_id

AND     T4.report_dsc_rn = '1'

AND     T4.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dim_cst_rel_inf_dd T5 --客户关联关系信息

ON      T1.cst_id = T5.cst_id

AND     T5.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表

ON      T5.rel_typ_cd = T6.cd_val

AND     T6.tbl_nm = 'DIM_CST_REL_INF_DD'

AND     T6.fld_nm = 'REL_TYP_CD'

AND     T6.dt = '@@{yyyyMMdd}'

LEFT JOIN    edw.dws_cst_bas_inf_dd T7 --客户基础信息汇总表

ON      T5.rel_cst_id = T7.cst_id

AND     T7.DT = '@@{yyyyMMdd}'

LEFT JOIN    (

                 SELECT  cst_id

                         ,COUNT(1) AS 我行历史逾期借据数

                 FROM    edw.dim_bus_loan_dbil_inf_dd

                 WHERE   DT = '20240519'

                 AND     ovd_dt <> '18991231'

                 GROUP BY cst_id

             ) T8

ON      T1.cst_id = T8.cst_id

WHERE   T1.DT = '@@{yyyyMMdd}'

AND     T1.pd_cd LIKE '2010503%' --随贷通

AND     CASE WHEN T1.hpn_dt <> '18991231' THEN T1.hpn_dt ELSE T1.apnt_start_dt END >= '20240101'

AND     CASE WHEN T1.hpn_dt <> '18991231' THEN T1.hpn_dt ELSE T1.apnt_start_dt END <= '20240430'

AND     T2.acs_org_id LIKE '3563%'    --龙海村行

;



--SELECT * FROM lab_bigdata_dev.tmp_longhai_sdt_20240530_01
**01-数据需求_村行_D0521_龙海村行_黄瑄妮_地址匹配社区.sql
--edw.xwdt_xw_community 社区信息表

--edw.dwd_cst_mng_cmnt_rel_dd 客户社区信息表（dpd_typ_cd='1' --挂靠类型：1普惠，2小企业）或edw.dim_cst_mng_cmnt_inf_dd社区信息，CMNT_SRC_CD --社区来源代码 1：普惠 2：小企业

----edw.xwdt_xw_customer_addr 客户地址信息表(全量表)
--edw.xwdt_xw_customer, 客户表(正潜灰) --main_add_flag:主地址标示 1：经营 2：通讯 3：家庭 4：户籍   5：办公 6 : 注册
--龙海村行2023年7月1日至2024年4月30日建档的正式客户，取四个地址（居住地、户籍地、单位地、注册地）及其地址所匹配的社区，检查目前挂靠的社区是否为定人社区。
--字段1：客户号、管护人名称、建档日期、是否正式客户、主地址、目前挂靠子社区名称、目前挂靠社区是否为定人子社区、
--居住地址、居住地对应社区、居住地对应社区是否为定人社区、户籍地址、户籍地对应社区、户籍地对应社区是否为定人社区
--单位地址、单位地对应社区、单位地对应社区是否为定人社区、经营地址、经营地对应社区、经营地对应社区是否为定人社区

CREATE TABLE IF NOT EXISTS  tmp_SJ2024052121_0523 as
SELECT T1.cust_no
       ,T1.cust_name
       ,T1.manager_no
       ,T1.manager_name
       ,T1.update_time
       ,case when T1.is_official='0' then '正式'     --0：正式  1：潜在 2：灰色
        else '潜在'
        end as 是否正式客户
       ,decode(T1.main_add_flag,'1','经营','2','通讯','3','家庭','4','户籍') as 主地址标识  --1：经营 2：通讯 3：家庭 4：户籍
       ,T2.fam_add
       ,T2.regist_add
       ,T2.unit_add
       ,T2.con_regist_add
--        ,T1.com_son_code   --所属子社区,无数据
--        ,T1.com_son_name   --所属子社区名称，无数据
       ,T4.sub_cmnt_id
       ,T4.sub_cmnt_nm
       ,T3.com_order_id   --社区定人ID
       --,T3.com_order_name  --社区定人名称
from edw.xwdt_xw_customer T1 ---客户表(正潜灰)
LEFT JOIN edw.xwdt_xw_customer_addr T2      --客户地址信息表(全量表)
ON T1.cust_no=T2.cust_no
and T2.dt='20240430'
left JOIN edw.dwd_cst_mng_cmnt_rel_dd T4 --客户社区信息表（dpd_typ_cd='1' --挂靠类型：1普惠，2小企业）
ON T1.cust_no=T4.cst_id
and T4.dt='20240430'
and T4.dpd_sts_cd='1'
left JOIN edw.xwdt_xw_community T3    --社区信息表
ON T4.sub_cmnt_id=T3.com_code
and T3.dt='20240430'
WHERE T1.dt='20240430'
AND T1.update_time<='20240430'
and T1.update_time>='20230701'
and substr(T1.manager_org_no,1,4) like '3563%'  --龙海村行
;





SELECT count(DISTINCT cust_no)  FROM tmp_SJ2024052121_0523 where is_official='0';




-- SELECT *
-- FROM edw.dwd_code_library_dd
-- WHERE dt='20240430'
-- and tbl_nm=upper('xwdt_xw_customer')
-- AND fld_nm=upper('main_add_flag')
-- ;

-- SELECT *FROM  edw.dwd_cst_mng_cmnt_rel_dd T4 --客户社区信息表
-- WHERE T4.dt='20240430'
-- limit 1000;

-- SELECT T3.id,T3.com_order_name,T3.com_order_id,T3.com_code
-- FROM edw.xwdt_xw_community T3    --社区信息表
-- WHERE T3.dt='20240430'
**01-数据需求_村行_D0522_广东四会村行_陈雯雅_信贷客户数据.sql
--用途：主要用于提前排除村行内部税务风险。四会国家税务局要求自查2021-2023年度相关免税主体，我们需要对上述数据进行自查并提前排查风险点。

--字段：2019-2023年度、客户号、客户名称、合同编号、借据号、工作单位名称（客户基本情况-从业情况）、经营单位名称（经营情况-经营基本情况）、客户名称（关系人情况-投资及任职企业）、业务品种。



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_gdsh_SJ2024052256 PURGE;



CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_gdsh_SJ2024052256 AS

SELECT  DISTINCT SUBSTR(t1.dt, 1, 4) 年份

                 ,T1.cst_id 客户号

                 ,T1.cst_nm 客户名称

                 ,T1.bus_ctr_id 合同编号

                 ,T1.dbil_id 借据号

                 ,T2.workcorp 工作单位

                 ,T3.companyname 经营单位名称

                 ,T4.customername 客户名称_投资及任职企业

                 ,T5.pd_nm 业务品种

FROM    edw.dws_bus_loan_dbil_inf_dd T1 --贷款借据信息汇总

LEFT JOIN    edw.loan_ind_info T2 --个人信息表

ON      T1.cst_id = T2.customerid

AND     T2.dt = T1.dt

AND     T2.DT IN ( '20191231' , '20201231' , '20211231' , '20221231' , '20231231' )

LEFT JOIN    edw.loan_customer_operation T3 --客户经营情况基本表

ON      T1.cst_id = T3.customerid

AND     T3.dt = T1.dt

AND     T3.DT IN ( '20191231' , '20201231' , '20211231' , '20221231' , '20231231' )

LEFT JOIN    edw.loan_customer_relative T4 --客户关联关系

ON      T1.cst_id = T4.customerid

AND     ( T4.relationship LIKE '02%'

    OR T4.RelationShip LIKE '01%' ) --投资或任职企业

AND     T4.dt = T1.dt

AND     T4.DT IN ( '20191231' , '20201231' , '20211231' , '20221231' , '20231231' )

LEFT JOIN    edw.dim_bus_loan_pd_inf_dd T5 --信贷产品信息

ON      T1.pd_cd = T5.pd_cd

AND     T5.dt = T1.dt

AND     T5.DT IN ( '20191231' , '20201231' , '20211231' , '20221231' , '20231231' )

WHERE   T1.DT IN ( '20191231' , '20201231' , '20211231' , '20221231' , '20231231' )

AND     T1.acs_org_id LIKE '4462%'   --广东四会村行

;







SELECT count(distinct 客户号 )  FROM lab_bigdata_dev.tmp_gdsh_SJ2024052256;

SELECT *  FROM lab_bigdata_dev.tmp_gdsh_SJ2024052256;
**01-数据需求_村行_D0522_庆元村行_吴美健_客户案件情况_.sql
--近期发现一笔贷款客户2月份被冻结，但系统没有提示，另外了解客户案件更新情况。
--已有字段：支行机构编号	管户客户经理名称	客户号	客户名称	信贷合同流水号	产品编号码值	合同金额	合同余额	发生日期	发生类型码值	到期日期
--取数字段：是否有法院案件	案件情况	客户经理抗辩、上诉情况	是否有查询、冻结、扣划



-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_01
-- (
 -- 支行机构编号          STRING
-- ,管户客户经理名称	  STRING
-- ,客户号	              STRING
-- ,客户名称	          STRING
-- ,信贷合同流水号	      STRING
-- ,产品编号码值	      STRING
-- ,合同金额	          STRING
-- ,合同余额	          STRING
-- ,发生日期	          STRING
-- ,发生类型码值	      STRING
-- ,到期日期             STRING
-- )
-- ;

--1，取预评估客户经理抗辩理由，拦截原因
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_02 AS
SELECT  T1.客户号
        ,T4.抗辩理由               AS 最近一次预评估抗辩理由
        ,T5.法院预评估规则提示内容 AS 最近一次预评估法院规则提示内容
FROM    (
            SELECT  DISTINCT 客户号
            FROM    lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_01
        ) T1
LEFT JOIN    (
                 SELECT  A1.applyserialno
                         ,A1.customerid
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.customerid ORDER BY A1.inputdate DESC , A1.serialno DESC ) AS RN --最最新一条预评估结果
                 FROM    edw.loan_customer_preevaluate_result A1 --预评估最终结果信息
                 LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表
                 ON      A1.preevaluateresult = A2.cd_val
                 AND     A2.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'
                 AND     A2.fld_nm = 'PREEVALUATERESULT'
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
             ) T2
ON      T1.客户号 = T2.customerid
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  applyserialno
                         ,WM_CONCAT(DISTINCT '||', opinion) AS 抗辩理由
                 FROM    edw.loan_defend_opinion --预评估抗辩意见
                 WHERE   opiniontype = '1' --抗辩理由
                 AND     COALESCE(opinion, '') <> ''
                 AND     DT = '@@{yyyyMMdd}'
                 GROUP BY applyserialno
             ) T4
ON      T2.applyserialno = T4.applyserialno
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 法院预评估规则提示内容
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     COALESCE(sgs_inf, '') <> ''
                 AND     COALESCE(sgs_inf, '') <> '查询成功'
                 AND     qry_cntnt = '05' --法院执行记录
                 GROUP BY apl_srl_nbr
             ) T5
ON      T2.applyserialno = T5.apl_srl_nbr
;

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176 AS
SELECT  T1.支行机构编号
        ,T1.管户客户经理名称
        ,T1.客户号
        ,T1.客户名称
        ,T1.信贷合同流水号
        ,T1.产品编号码值
        ,T1.合同金额
        ,T1.合同余额
        ,T1.发生日期
        ,T1.发生类型码值
        ,T1.到期日期
        ,T2.最近一次预评估抗辩理由
        ,T2.最近一次预评估法院规则提示内容
        ,T5.hpn_dt     AS 案件发生日期
        ,T5.exe_cas_id AS 执行案号
        ,T5.exe_cntnt  AS 执行内容
        ,T5.exe_sts    AS 执行状态
        ,CASE
           WHEN T3.cst_id IS NOT NULL THEN '是'
           ELSE '否'
         END           AS 是否有司法查冻扣
FROM    lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_01 T1
LEFT JOIN    lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176_02 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    (
                 SELECT  DISTINCT cst_id
                 FROM    edw.dws_bus_dep_qry_frz_ddct_smy_inf_dd --司法查冻扣汇总信息
                 WHERE   DT = '@@{yyyyMMdd}'
             ) T3
ON      T1.客户号 = T3.cst_id
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T1.客户号 = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  hpn_dt
                         ,doc_nbr
                         ,exe_cas_id
                         ,exe_cntnt
                         ,exe_sts
                         ,ROW_NUMBER() OVER ( PARTITION BY doc_nbr ORDER BY hpn_dt DESC ) AS RN
                 FROM    edw.dim_cst_out_cort_ful_inf_dd --法院查询全量信息
                 --from    edw.nout_fy_query_quanliang  --法院全量信息表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     doc_nbr <> ''
             ) T5
ON      T4.doc_nbr = T5.doc_nbr
AND     T5.RN= 1;


--SELECT * FROM lab_bigdata_dev.tmp_qinyuan_dk_SJ2024051176
**01-数据需求_村行_D0522_旬阳村行_石头_存量泰e贷数据_除去已结清业务_.sql
-- 截止4.30日，陕西旬阳村行，存量泰e贷数据（除去已结清业务）
 -- 字段包括不限于：客户号、客户名字、合同金额、合同余额、管户人、管户机构、发放人、发放机构、担保方式、是否签署夫妻共债、上一次完成年审时间、是否关联配偶等


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xunyang_taied_SJ2024052281 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xunyang_taied_SJ2024052281 AS
SELECT  T1.cst_id         AS 客户号
        ,T1.cst_nm        AS 客户姓名
        ,T1.pd_cd         AS 产品代码
        ,T11.pd_nm        AS 产品名称
        ,T1.busi_ctr_id   AS 业务合同编号
        ,T1.apnt_start_dt AS 约定开始日期
        ,T1.apnt_mtu_dt   AS 约定到期日期
        ,T1.ctr_amt       AS 合同金额
        ,T1.ctr_bal       AS 合同余额
        ,T5.acs_mngr_id   AS 管户人工号
        ,T6.empe_nm       AS 管户人
        ,T5.acs_org_id    AS 管户机构号
        ,T7.org_nm        AS 管户机构
        ,T1.opr_id        AS 发放人工号
        ,T8.empe_nm       AS 发放人
        ,T1.hdl_org_id    AS 发放机构号
        ,T9.org_nm        AS 发放机构
        ,CASE
           WHEN T1.main_grnt_mth_cd = '020' THEN '抵押'
           WHEN T1.main_grnt_mth_cd = '010' THEN '保证'
           WHEN T1.main_grnt_mth_cd = '040' THEN '质押'
           WHEN T1.main_grnt_mth_cd = '005' THEN '信用'
         END              AS 担保方式
        ,CASE
           WHEN T1.sgn_spus_com_dbt_ind = '1' THEN '是'
           ELSE '否'
         END              AS 是否签署夫妻共债
        ,T10.aprv_dt      AS 上一次完成年审时间
        ,T14.cd_val_dscr  AS 婚姻状况
        ,T13.cst_chn_nm   AS 配偶姓名
FROM    edw.DIM_BUS_LOAN_CTR_INF_DD T1 -- 信贷合同信息
LEFT JOIN    edw.dwd_bus_loan_ctr_mgr_inf_dd T5 --信贷合同管护信息
ON      T1.busi_ctr_id = T5.busi_ctr_id
AND     T5.DT = '20240430'
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      T5.acs_mngr_id = T6.empe_id
AND     T6.DT = '20240430'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T7 --机构树_考核维度
ON      T5.acs_org_id = T7.org_id
AND     T7.DT = '20240430'
LEFT JOIN    edw.dws_hr_empe_inf_dd T8 --员工汇总信息
ON      T1.opr_id = T8.empe_id
AND     T8.DT = '20240430'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T9 --机构树_考核维度
ON      T1.hdl_org_id = T9.org_id
AND     T9.DT = '20240430'
LEFT JOIN    (
                 SELECT  ctr_no
                         ,aprv_dt
                         ,ROW_NUMBER() OVER ( PARTITION BY ctr_no ORDER BY aprv_dt DESC ) AS RN
                 FROM    edw.dwd_bus_loan_crc_ctr_year_chk_apl_inf_dd --循环贷款合同年审申请信息
                 WHERE   DT = '20240430'
                 AND     aprv_dt <> '18991231'
             ) T10
ON      T1.busi_ctr_id = T10.ctr_no
AND     T10.RN = 1
LEFT JOIN    edw.dim_bus_loan_pd_inf_dd T11 --信贷产品信息
ON      T1.pd_cd = T11.pd_cd
AND     T11.DT = '20240430'
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,b.cd_val_dscr
                 FROM    edw.dim_cst_idv_bas_inf_dd a --个人客户基本信息
                 LEFT JOIN    edw.dwd_code_library_dd b
                 ON      a.MRG_SITU_CD = b.cd_val
                 and     b.tbl_nm=upper('dim_cst_idv_bas_inf_dd')
                 and     b.fld_nm=upper('MRG_SITU_CD')
                 AND     b.dt = '20240430'
                 WHERE   a.dt = '20240430'
             ) T14
ON      T1.cst_id = T14.cst_id
LEFT JOIN    edw.dwd_cst_rel_inf_dd T12 --客户关联信息,也可用edw.loan_customer_relative  --信贷客户关联关系
ON      T1.cst_id = T12.cst_id
AND     T12.rel_rel_cd = '0301' --配偶
AND     T12.dt = '20240430'
LEFT JOIN    edw.dws_cst_bas_inf_dd T13 --客户基础信息汇总表
ON      T12.rel_cst_id = T13.cst_id
AND     T13.dt = '20240430'
WHERE   T1.PD_CD IN ( '201050102010146' , '201050101040348' )
AND     T1.DT = '20240430'
AND     ( T1.CTR_BAL > 0 --余额>0
    OR ( T1.CTR_BAL = 0
AND     T1.APNT_MTU_DT >= '@@{yyyyMMdd}' --约定到期日期大于等于当前
AND     NVL(T1.FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
AND     T1.END_DT = '18991231' --终结日期=18991231即为合同未终结
) ) --合同未结清
AND     T5.acs_org_id LIKE '6161%';--旬阳村行



--SELECT count(*) from lab_bigdata_dev.tmp_xunyang_taied_SJ2024052281

;
**01-数据需求_村行_D0523_龙海村行_程彩艳_随贷通小额卡方案.sql
-- 统计周期：截止2024年5月20日龙海村行所有客户。
-- 所属机构号、管户客户经理、客户号、客户名称、年龄、征信分、授信总额、授信余额、是否随贷通卡客户、所属子社区、他行贷款机构家数、他行贷款金额、
-- 他行贷款余额、他行信用卡张数、他行办信用卡机构数、他行信用卡授信金额、他行信用卡用信金额、他行经营性贷款金额、他行经营性贷款余额、经营行业、客群标签(经营、消费、农民、市民)。
-- SJ20240522141



--个人征信贷款
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_longhai_SJ20240522141_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_longhai_SJ20240522141_01 AS
SELECT  A1.cst_id
        ,A1.report_id
        -- ,SUM(CASE
               -- WHEN act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) THEN ctr_bal
             -- END)            AS 授信余额
        -- ,SUm(CASE
               -- WHEN act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) THEN ctr_amt
             -- END)            AS 授信总额
        ,COUNT(DISTINCT CASE
                          WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) THEN dtrb_org
                        END) AS 他行贷款机构家数
        ,SUM(CASE
               WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) THEN ctr_bal
             END)            AS 他行贷款余额
        ,SUm(CASE
               WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'D1' , 'R1' , 'R4' ) THEN ctr_amt
             END)            AS 他行贷款金额
        ,SUM(CASE
               WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' , 'R3' ) THEN 1
               ELSE 0
             END)            AS 他行信用卡张数
        ,COUNT(DISTINCT CASE
                          WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' , 'R3' ) THEN dtrb_org
                        END) AS 他行办信用卡机构数
        ,SUM(CASE
               WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' , 'R3' ) THEN ctr_amt
             END)            AS 他行信用卡授信金额
        ,SUM(CASE
               WHEN dtrb_org <> 'ZJTLCB' AND act_typ_cd IN ( 'R2' , 'R3' ) THEN ctr_bal
             END)            AS 他行信用卡用信金额
        ,SUM(DISTINCT CASE
                        WHEN dtrb_org <> 'ZJTLCB' AND pd_cd IN ( '41' , '42' , '52' ) THEN ctr_amt
                      END)   AS 他行经营性贷款金额
        ,SUM(DISTINCT CASE
                        WHEN dtrb_org <> 'ZJTLCB' AND pd_cd IN ( '41' , '42' , '52' ) THEN ctr_bal
                      END)   AS 他行经营性贷款余额
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     A1.cls_dt >= '@@{yyyyMMdd}'  --未关闭
AND     LENGTH(NVL(A1.cst_id, '')) > 0
GROUP BY A1.cst_id , A1.report_id;




--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_longhai_SJ20240522141_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_longhai_SJ20240522141_02 AS
SELECT  T1.ln_org_id	                                                                 AS 所属机构号
        ,T1.ln_org_nm	                                                                 AS 所属机构
        ,T1.ln_mgr_id	                                                                 AS 管户客户经理工号
        ,T1.ln_mgr_nm	                                                                 AS 管户客户经理
        ,T1.cst_id                                                                       AS 客户号
        ,T2.cst_chn_nm	                                                                 AS 客户名称
        ,DATEDIFF(TO_DATE('20240520', 'YYYYMMDD'), TO_DATE(T2.bth_dt, 'YYYYMMDD'), 'YYYY') AS 年龄
        ,greatest(T3.idv_crd_sco_val, T3.idv_crd_sco_val2)                                AS 征信分
        ,T4.授信总额
        ,T4.授信余额
        ,CASE
           WHEN T4.是否随贷通卡客户 =1 THEN '是'
           ELSE '否'
         END                                                                             AS 是否随贷通卡客户
        ,T2.sub_cmnt_id                                                                  AS 所属子社区编号
        ,T5.cmnt_nm                                                                      AS 所属子社区
        ,T7.他行贷款机构家数
        ,T7.他行贷款金额
        ,T7.他行贷款余额
        ,T7.他行信用卡张数
        ,T7.他行办信用卡机构数
        ,T7.他行信用卡授信金额
        ,T7.他行信用卡用信金额
        ,T7.他行经营性贷款金额
        ,T7.他行经营性贷款余额
        ,T6.cd_val_dscr                                                                  AS 经营行业
        ,CASE
           WHEN T8.two_people_ind = '1' THEN '市民'
           WHEN T8.two_people_ind = '2' THEN '农民'
         END                                                                             AS 农民_市民
        ,CASE
           WHEN T9.opr_cst = '1' THEN '是'
           ELSE '否'
         END                                                                             AS 是否经营性客户
        ,CASE
           WHEN T9.csm_cst = '1' THEN '是'
           ELSE '否'
         END                                                                             AS 是否消费性客户
FROM    adm_pub.adm_csm_cbas_mng_inf_dd T1 --客户集市-客户基础-客户管户信息
INNER JOIN    edw.dws_cst_idv_bas_inf_dd T2 --个人客户基本信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20240520'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
ON      T1.cst_id = T3.cst_id
AND     T3.report_dsc_rn = '1'
AND     T3.DT = '20240520'
LEFT JOIN    (
                 SELECT   cst_id
				          ,SUM(ctr_amt) AS 授信总额
				          ,SUM(CTR_BAL) AS 授信余额
						  ,MAX(CASE WHEN  pd_cd LIKE '2010503%' THEN 1 ELSE 0 END ) AS 是否随贷通卡客户
                 FROM    edw.dim_bus_loan_ctr_inf_dd  --信贷合同
                 WHERE    DT = '20240520'
				 GROUP BY cst_id
             ) T4
ON      T1.cst_id = T4.cst_id
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T5 --社区信息
ON      T2.sub_cmnt_id = T5.cmnt_enc
AND     T5.DT = '20240520'
LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表
ON      T2.job_unt_afl_idt = T6.cd_val
AND     T6.tbl_nm = 'DIM_CST_BAS_INF_DD'
AND     T6.fld_nm = 'IDT_CD'
AND     T6.DT = '20240520'
LEFT JOIN    lab_bigdata_dev.tmp_longhai_SJ20240522141_01 T7
ON      T1.cst_id = T7.cst_id
AND     T3.report_no = T7.report_id
LEFT JOIN    adm_pub.adm_csm_clab_cst_inf_cmpn_idv_inf_dd T8 --客户集市-客户标签信息-客户信息-营销-对私客户
ON      T1.cst_id = T8.cst_id
AND     T8.DT = '20240520'
LEFT JOIN    adm_pub.adm_csm_clab_ln_inf_dd T9 --客户集市-标签层-信贷客户标签信息表
ON      T1.cst_id = T9.cst_id
AND     T9.DT = '20240520'
WHERE   T1.DT = '20240520'
AND     T1.ln_org_id LIKE '3563%' --龙海村行
;

SELECT * from lab_bigdata_dev.tmp_longhai_SJ20240522141_02

-- SELECT T3.idv_crd_sco_val,T3.idv_crd_sco_val2,T3.report_dsc_rn,T3.report_asc_rn
-- FROM  edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
-- WHERE T3.dt='20240520'
-- and T3.cst_id='1605575758'
;
**01-数据需求_村行_D0529_庆元村行_吴文雅_分析存量业务担保方式出险情况及配偶未签署共债出险情况_客户案件情况_.sql
--庆元村行截止2024.5.26存量授信客户，分析存量业务担保方式出险情况及配偶未签署共债出险情况
--字段：机构名称、客户经理名称、客户经理工号、客户编号、客户名称、借款人婚姻状况、配偶客户号、配偶名称、业务合同编号、约定开始日期、约定到期日期、合同金额、合同余额、利率
--五级分类、担保方式、担保人客户号、担保人名称、配偶是否签署共同还款承诺书、预评估结果、征信规则触发逾期内容、最近一次精准贷后触犯时间、最近一次精准贷后触犯原因


--临时表1，存量有效信贷业务清单
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_SJ2024052761_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_SJ2024052761_01 AS
SELECT  bc.serialno 业务合同编号
        ,bc.customerid 客户号
        ,bc.customername 客户名称
        ,T.cd_val_dscr 借款人婚姻状况
        ,T1.rel_cst_id 配偶客户号
        ,T1.cst_chn_nm 配偶名称
        ,bc.businesssum 合同金额
        ,bc.balance 合同余额
        ,bc.businessrate 利率
        ,bc.putoutdate 约定开始日期
        ,bc.maturity 约定到期日期
        ,bc.manageorgid 当前管户机构
        ,T4.org_nm 管户机构名称
        ,bc.manageuserid 当前管户人
        ,T3.empe_nm 管户人姓名
        ,decode(bc.issignfamilycontract, '1', '是', '2', '否', '') 是否签订夫妻共同债务声明书 --1是，2否
        ,dc.cd_val_dscr 五级分类
        ,decode(bc.vouchtype, '005', '信用', '010', '保证', '020', '抵押', '040', '质押') 主要担保方式   --005 信用  010 保证  020 抵押   040 质押
        ,decode(T2.guarantytype,'005', '信用', '010', '保证', '020', '抵押', '040', '质押') 担保类型
        ,T2.serialno 担保合同编号
        ,T2.guarantyid  担保物编号
        ,T2.ownerid 担保人或权利人号
        ,T2.ownername 担保人或权利人名称
FROM    edw.loan_business_contract bc --业务合同表
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,b.cd_val_dscr
                 FROM    edw.dim_cst_idv_bas_inf_dd a --个人客户基本信息
                 LEFT JOIN    edw.dwd_code_library_dd b
                 ON      a.MRG_SITU_CD = b.cd_val
                 AND     b.tbl_nm = upper('dim_cst_idv_bas_inf_dd')
                 AND     b.fld_nm = upper('MRG_SITU_CD')
                 AND     b.dt = '@@{yyyyMMdd}'
                 WHERE   a.dt = '@@{yyyyMMdd}'
             ) T
ON      bc.customerid = T.cst_id
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.rel_cst_id
                         ,b.cst_chn_nm
                 FROM    edw.dwd_cst_rel_inf_dd a --客户关联信息 （全）
                 LEFT JOIN    edw.dws_cst_bas_inf_dd b --客户基础信息汇总表
                 ON      a.rel_cst_id = b.cst_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 WHERE   a.dt = '@@{yyyyMMdd}'
                 AND     a.rel_rel_cd = '0301'      --配偶
             ) T1
ON      bc.customerid = T1.cst_id
LEFT JOIN    (
                 SELECT  a.objectno
                         ,b.serialno
                         ,b.guarantytype
                         ,c.guarantyid
                         ,c.ownerid
                         ,c.ownername
                 FROM    edw.loan_guaranty_relative a --业务合同、担保合同与担保物关联表
                 LEFT JOIN    edw.loan_guaranty_contract b --担保合同
                 ON      a.contractno = b.serialno --担保合同号
                 AND     b.dt = '@@{yyyyMMdd}'
                 AND     b.contractstatus = '020' --已签合同
                 LEFT JOIN    edw.loan_guaranty_info c --担保物信息表
                 ON      a.guarantyid = c.guarantyid --担保物编号
                 AND     c.dt = '@@{yyyyMMdd}'
                 WHERE   a.dt = '@@{yyyyMMdd}'
             ) T2
ON      bc.serialno = T2.objectno
LEFT JOIN    edw.dws_hr_empe_inf_dd T3 --员工汇总
ON      bc.manageuserid = T3.empe_id
AND     T3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_bas_inf_dd T4 --机构
ON      bc.manageorgid = T4.org_id
AND     T4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd dc --码值表
ON      bc.classifyresult = dc.cd_val
AND     dc.tbl_nm = upper('dim_bus_loan_ctr_inf_dd')
AND     dc.fld_nm == upper('five_ctg_cd')
AND     dc.dt = '@@{yyyyMMdd}'
WHERE   bc.dt = '@@{yyyyMMdd}'
AND     ( bc.balance > 0 --余额>0
    OR ( bc.balance = 0
AND     bc.maturity >= '@@{yyyyMMdd}' --约定到期日期大于等于当前
AND     NVL(bc.freezeflag, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
AND     bc.finishdate = '18991231' --终结日期=18991231即为合同未终结
) --合同未结清
)
AND     substr(bc.manageorgid, 1, 4) = '3361'    --庆元村行
;



-- SELECT * from lab_bigdata_dev.tmp_qinyuan_SJ2024052761_01 WHERE  业务合同编号 in('BC2022062700000125' ,'BC2020060100000894');  可能既有保证，又有质押，还有抵押，信用没有担保合同

--临时表2， 客户最新一条预评估、精准贷后信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_SJ2024052761_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_SJ2024052761_02 AS
SELECT  T1.客户号
        ,T2.预评估结果             AS 最近一次预评估结果
        ,T3.征信规则触发逾期内容   AS 最近一次预评估征信规则触发逾期内容
        -- ,T4.抗辩理由               AS 最近一次预评估抗辩理由
        -- ,T5.法院预评估规则提示内容 AS 最近一次预评估法院规则提示内容
        ,T6.最近一次精准贷后触犯时间
        ,T6.最近一次精准贷后触犯原因
FROM    (
            SELECT  DISTINCT 客户号
            FROM    lab_bigdata_dev.tmp_qinyuan_SJ2024052761_01
        ) T1
LEFT JOIN    (
                 SELECT  A1.applyserialno
                         ,A1.customerid
                         ,A1.preevaluateresult --预评估结果
                         ,A2.cd_val_dscr                                                                              AS 预评估结果
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.customerid ORDER BY A1.inputdate DESC , serialno DESC ) AS RN --取最新一条预评估结果
                 FROM    edw.loan_customer_preevaluate_result A1 --预评估最终结果信息
                 LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表
                 ON      A1.preevaluateresult = A2.cd_val
                 AND     A2.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'
                 AND     A2.fld_nm = 'PREEVALUATERESULT'
                 AND     A2.dt = '@@{yyyyMMdd}'
                 WHERE   A1.dt = '@@{yyyyMMdd}'
             ) T2
ON      T1.客户号 = T2.customerid
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  apl_srl_nbr
                         ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 征信规则触发逾期内容
                 FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     sgs_inf RLIKE '逾期'
                 AND     COALESCE(sgs_inf, '') <> ''
                 AND     qry_cntnt = '07' --查询内容征信规则
                 GROUP BY apl_srl_nbr
             ) T3
ON      T2.applyserialno = T3.apl_srl_nbr
-- LEFT JOIN    (
--                  SELECT  applyserialno
--                          ,WM_CONCAT(DISTINCT '||', opinion) AS 抗辩理由
--                  FROM    edw.loan_defend_opinion --预评估抗辩意见
--                  WHERE   opiniontype = '1' --抗辩理由
--                  AND     COALESCE(opinion, '') <> ''
--                  AND     DT = '@@{yyyyMMdd}'
--                  GROUP BY applyserialno
--              ) T4
-- ON      T2.applyserialno = T4.applyserialno
-- LEFT JOIN    (
--                  SELECT  apl_srl_nbr
--                          ,WM_CONCAT(DISTINCT '||', sgs_inf) AS 法院预评估规则提示内容
--                  FROM    edw.dwd_bus_loan_cst_pre_ases_apl_rel_dd --客户预评估申请关联表
--                  WHERE   DT = '@@{yyyyMMdd}'
--                  AND     COALESCE(sgs_inf, '') <> ''
--                  AND     qry_cntnt = '05' --法院执行记录
--                  GROUP BY apl_srl_nbr
--              ) T5
-- ON      T2.applyserialno = T5.apl_srl_nbr
LEFT JOIN    (
                 SELECT  cst_id
                         ,vio_rsn_ana                                               AS 最近一次精准贷后触犯原因
                         ,tsk_mak_dt                                                AS 最近一次精准贷后触犯时间
                         ,RANK() OVER ( PARTITION BY cst_id ORDER BY srl_nbr DESC ) AS RN
                 FROM    edw.dwd_bus_loan_tgt_loan_post_rsl_inf_dd --精准贷后结果信息表
                 WHERE   DT = '@@{yyyyMMdd}'
                 AND     rsk_trg_typ_cd <> ''
             ) T6
ON      T1.客户号 = T6.cst_id
AND     T6.RN = 1;


--SELECT * FROM lab_bigdata_dev.tmp_qinyuan_SJ2024052761_02;

--结果表

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qinyuan_SJ2024052761_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qinyuan_SJ2024052761_03 AS
SELECT  distinct T1.*
       ,T2.最近一次预评估结果
       ,T2.最近一次预评估征信规则触发逾期内容
        ,T2.最近一次精准贷后触犯时间
        ,T2.最近一次精准贷后触犯原因
from lab_bigdata_dev.tmp_qinyuan_SJ2024052761_01 T1
left join lab_bigdata_dev.tmp_qinyuan_SJ2024052761_02 T2
on T1.客户号=T2.客户号
;


 SELECT count(*) FROM lab_bigdata_dev.tmp_qinyuan_SJ2024052761_03
**01-数据需求_村行_D0529_庆元村行_柳青_分析客户信贷需求_电话营销_客户走访.sql
--全量流失客户清单、预审批通过我行曾经有授信、预审批通过我行未有授信，泰惠收活跃户未配卡
--字段1：客户号	客户名称、同一风险控制号、配偶名字、配偶客户号、管户客户经理姓名、管护机构、年龄、地址、电话、
--用信机构数、他行授信金额合计、他行贷款余额合计、他行贷款利率、近6个月征信查询机构数合计
--担保方式为信用余额合计、担保方式为保证的余额合计、
--字段2：客户号	支行、客户经理、配偶名字、配偶客户号、管户客户经理姓名、管护机构、年龄、地址、电话、用信机构数、他行授信金额合计、他行贷款余额合计、近6个月征信查询机构数合计
--他行担保方式为信用余额合计、他行担保方式为保证的余额合计、他行贷款利率

--导入清单，qbi_file_20240529_17_16_08，	COL_2客户号，col_3 客户名称
--导入清单，qbi_file_20240529_17_17_29 ，COL_1客户号，col_2，支行，col_2 客户经理



---1、全量流失客户清单
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingyuan_SJ2024052361_001 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qingyuan_SJ2024052361_001  AS
SELECT  T.COL_1 清单类型
        ,T.COL_2 客户号
        ,T1.cst_nm 客户姓名
        ,T1.sam_rsk_ctrl_id 同一风险控制号
        ,T1.age 年龄
        ,T1.mbl_nbr 手机
        ,T1.cmn_adr 通讯地址
        ,T1.fml_adr 家庭地址
        ,T1.wrk_adr 工作单位地址或经营所在地地址
        ,T1.reg_adr 户籍地址或注册地址
        ,T1.rel_cst_id 配偶客户号
        ,T1.cst_chn_nm 配偶姓名
        ,T2.ln_mgr_id 管护人id
        ,T2.ln_mgr_nm 管护人姓名
        ,T2.ln_org_id 管护机构id
        ,T2.ln_org_nm 管护机构名称
        ,T4.他行贷款机构家数
        ,T4.他行贷款余额
        ,T4.他行贷款金额
        ,T4.mintr_rat 他行贷款月利率
        ,T3.late_hly_loan_org_num 最近6个月贷款审批查询机构数
        ,T4.他行担保方式为保证的贷款余额合计
        ,T4.他行担保方式为信用的贷款余额合计
FROM    qbi_file_20240529_17_16_08 T
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.cst_chn_nm                                                                         AS cst_nm
                         ,a.sam_rsk_ctrl_id
                         ,DATEDIFF(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(b.bth_dt, 'yyyymmdd'), 'yyyy') AS age
                         ,a.mbl_nbr --手机
                         ,a.cmn_adr --通讯地址
                         ,a.fml_adr --家庭地址
                         ,a.wrk_adr --工作单位地址或经营所在地地址
                         ,a.reg_adr --户籍地址或注册地址
                         ,c.rel_cst_id --配偶客户号
                         ,c.cst_chn_nm  --配偶姓名
                 FROM    edw.dws_cst_bas_inf_dd a --客户基础信息汇总表
                 LEFT JOIN    edw.dim_cst_idv_bas_inf_dd b --个人客户基本信息
                 ON      a.cst_id = b.cst_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  a.cst_id
                                          ,a.rel_cst_id
                                          ,b.cst_chn_nm
                                  FROM    edw.dwd_cst_rel_inf_dd a --客户关联信息 （全）
                                  LEFT JOIN    edw.dws_cst_bas_inf_dd b --客户基础信息汇总表
                                  ON      a.rel_cst_id = b.cst_id
                                  AND     b.dt = '@@{yyyyMMdd}'
                                  WHERE   a.dt = '@@{yyyyMMdd}'
                                  AND     a.rel_rel_cd = '0301'  --配偶
                              ) c
                 ON      a.cst_id = c.cst_id
                 WHERE   a.dt = '@@{yyyyMMdd}'
             ) T1
ON      T.COL_2 = T1.cst_id
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户集市-客户基础-客户管户信息
ON      T.COL_2 = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
ON      T.COL_2 = T3.cst_id
AND     T3.report_dsc_rn = '1'
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,T1.report_id
                         ,COUNT(DISTINCT t1.dtrb_org)      AS 他行贷款机构家数
                         ,SUM(t1.ctr_bal)                    AS 他行贷款余额
                         ,SUm(t1.ctr_amt)                 AS 他行贷款金额
                         ,WM_CONCAT(',', t3.intr_rat) AS mintr_rat --月利率
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '3' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为保证的贷款余额合计
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '4' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为信用的贷款余额合计
                 FROM    edw.dim_cst_ccrc_idv_loan_inf_dd t1 --个人征信客户贷款信息
                 LEFT JOIN    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t3 --个人征信借贷账户利率计算 intr_rat&permil;
                 ON      t1.report_id = t3.crd_rpt_id
                 AND     t1.act_id = t3.act_id
                 AND     t3.dt = '@@{yyyyMMdd}'
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 and  t1.dtrb_org <> 'ZJTLCB'
                 and  t1.dtrb_org_typ_cd in ( '11' , '12' , '14' , '15' )  --11商业银行,12村镇银行，14住房储蓄银行，15外资银行
                --  AND t1.act_typ_cd IN ( 'D1' , 'R1' , 'R4' )   --D1非循环贷账户,R1循环贷账户,R4循环额度下分账户
                 and t1.pd_cd in ('11','12','13','21','31','32','33','41','42','51','52','53','91','99')   --贷款类业务
                 AND     t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
                 AND     LENGTH(NVL(t1.cst_id, '')) > 0
                 GROUP BY t1.cst_id , T1.report_id
             ) T4
ON      T.COL_2 = T4.cst_id
AND     T3.report_no = T4.report_id
WHERE   pt = MAX_PT('lab_bigdata_dev.qbi_file_20240529_17_16_08')
AND     T.col_1 = '全量流失客户清单';

--SELECT * FROM lab_bigdata_dev.tmp_qingyuan_SJ2024052361_001 ;

---2、预审批通过我行曾经有授信
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingyuan_SJ2024052361_002 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qingyuan_SJ2024052361_002 AS
SELECT  T.COL_2 客户号
        ,T1.cst_nm 客户姓名
        ,T1.sam_rsk_ctrl_id 同一风险控制号
        ,T1.age 年龄
        ,T1.mbl_nbr 手机
        ,T1.cmn_adr 通讯地址
        ,T1.fml_adr 家庭地址
        ,T1.wrk_adr 工作单位地址或经营所在地地址
        ,T1.reg_adr 户籍地址或注册地址
        ,T1.rel_cst_id 配偶客户号
        ,T1.cst_chn_nm 配偶姓名
        ,T2.ln_mgr_id 管护人id
        ,T2.ln_mgr_nm 管护人姓名
        ,T2.ln_org_id 管护机构id
        ,T2.ln_org_nm 管护机构名称
        ,coalesce(T4.他行贷款机构家数_个人,T5.他行贷款授信机构数_企业) as 他行贷款机构家数
        ,coalesce(T4.他行贷款余额_个人,T5.他行贷款余额_企业) as 他行贷款余额
        ,coalesce(T4.他行贷款金额_个人,T5.他行贷款金额_企业) as 他行贷款金额
        ,coalesce(T4.mintr_rat,T5.irr_企业)as  他行贷款月利率
        ,coalesce(T3.late_hly_loan_org_num,T5.近6个月金融机构审批通过家数) as 最近6个月贷款审批查询机构数
        ,coalesce(T4.他行担保方式为保证的贷款余额合计_个人,T5.他行担保方式为保证的贷款余额合计_企业) as 他行担保方式为保证的贷款余额合计
        ,coalesce(T4.他行担保方式为信用的贷款余额合计_个人,T5.他行担保方式为信用的贷款余额合计_企业) as 他行担保方式为信用的贷款余额合计
FROM    qbi_file_20240529_17_16_08 T
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.cst_chn_nm                                                                         AS cst_nm
                         ,a.sam_rsk_ctrl_id
                         ,DATEDIFF(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(b.bth_dt, 'yyyymmdd'), 'yyyy') AS age
                         ,a.mbl_nbr --手机
                         ,a.cmn_adr --通讯地址
                         ,a.fml_adr --家庭地址
                         ,a.wrk_adr --工作单位地址或经营所在地地址
                         ,a.reg_adr --户籍地址或注册地址
                         ,c.rel_cst_id --配偶客户号
                         ,c.cst_chn_nm  --配偶姓名
                 FROM    edw.dws_cst_bas_inf_dd a --客户基础信息汇总表
                 LEFT JOIN    edw.dim_cst_idv_bas_inf_dd b --个人客户基本信息
                 ON      a.cst_id = b.cst_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  a.cst_id
                                          ,a.rel_cst_id
                                          ,b.cst_chn_nm
                                  FROM    edw.dwd_cst_rel_inf_dd a --客户关联信息 （全）
                                  LEFT JOIN    edw.dws_cst_bas_inf_dd b --客户基础信息汇总表
                                  ON      a.rel_cst_id = b.cst_id
                                  AND     b.dt = '@@{yyyyMMdd}'
                                  WHERE   a.dt = '@@{yyyyMMdd}'
                                  AND     a.rel_rel_cd = '0301'  --配偶
                              ) c
                 ON      a.cst_id = c.cst_id
                 WHERE   a.dt = '@@{yyyyMMdd}'
             ) T1
ON      T.COL_2 = T1.cst_id
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户集市-客户基础-客户管户信息
ON      T.COL_2 = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
ON      T.COL_2 = T3.cst_id
AND     T3.report_dsc_rn = '1'
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,T1.report_id
                         ,COUNT(DISTINCT t1.dtrb_org)      AS 他行贷款机构家数_个人
                         ,SUM(t1.ctr_bal)                    AS 他行贷款余额_个人
                         ,SUm(t1.ctr_amt)                 AS 他行贷款金额_个人
                         ,WM_CONCAT(',', t3.intr_rat) AS mintr_rat --月利率
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '3' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为保证的贷款余额合计_个人
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '4' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为信用的贷款余额合计_个人
                 FROM    edw.dim_cst_ccrc_idv_loan_inf_dd t1 --个人征信客户贷款信息
                 LEFT JOIN    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t3 --个人征信借贷账户利率计算 intr_rat&permil;
                 ON      t1.report_id = t3.crd_rpt_id
                 AND     t1.act_id = t3.act_id
                 AND     t3.dt = '@@{yyyyMMdd}'
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 and  t1.dtrb_org <> 'ZJTLCB'
                 and  t1.dtrb_org_typ_cd in ( '11' , '12' , '14' , '15' )  --11商业银行,12村镇银行，14住房储蓄银行，15外资银行
                --  AND t1.act_typ_cd IN ( 'D1' , 'R1' , 'R4' )   --D1非循环贷账户,R1循环贷账户,R4循环额度下分账户
                 and t1.pd_cd in ('11','12','13','21','31','32','33','41','42','51','52','53','91','99')   --贷款类业务
                 AND     t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
                 AND     LENGTH(NVL(t1.cst_id, '')) > 0
                 GROUP BY t1.cst_id , T1.report_id
             ) T4
ON      T.COL_2 = T4.cst_id
AND     T3.report_no = T4.report_id
left join lab_bigdata_dev.tmp_SJ2024010236_zhenxin_03 T5
on T.COL_2=T5.企业客户号
WHERE   pt = MAX_PT('lab_bigdata_dev.qbi_file_20240529_17_16_08')
AND     T.col_1 = '预审批通过我行曾经有授信';

--SELECT * FROM lab_bigdata_dev.tmp_qingyuan_SJ2024052361_002



--3、预审批通过我行未有授信
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingyuan_SJ2024052361_003 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qingyuan_SJ2024052361_003 AS
SELECT  T.COL_2 客户号
        ,T1.cst_nm 客户姓名
        ,T1.sam_rsk_ctrl_id 同一风险控制号
        ,T1.age 年龄
        ,T1.mbl_nbr 手机
        ,T1.cmn_adr 通讯地址
        ,T1.fml_adr 家庭地址
        ,T1.wrk_adr 工作单位地址或经营所在地地址
        ,T1.reg_adr 户籍地址或注册地址
        ,T1.rel_cst_id 配偶客户号
        ,T1.cst_chn_nm 配偶姓名
        ,T2.ln_mgr_id 管护人id
        ,T2.ln_mgr_nm 管护人姓名
        ,T2.ln_org_id 管护机构id
        ,T2.ln_org_nm 管护机构名称
        ,coalesce(T4.他行贷款机构家数_个人,T5.他行贷款授信机构数_企业) as 他行贷款机构家数
        ,coalesce(T4.他行贷款余额_个人,T5.他行贷款余额_企业) as 他行贷款余额
        ,coalesce(T4.他行贷款金额_个人,T5.他行贷款金额_企业) as 他行贷款金额
        ,coalesce(T4.mintr_rat,T5.irr_企业)as  他行贷款月利率
        ,coalesce(T3.late_hly_loan_org_num,T5.近6个月金融机构审批通过家数) as 最近6个月贷款审批查询机构数
        ,coalesce(T4.他行担保方式为保证的贷款余额合计_个人,T5.他行担保方式为保证的贷款余额合计_企业) as 他行担保方式为保证的贷款余额合计
        ,coalesce(T4.他行担保方式为信用的贷款余额合计_个人,T5.他行担保方式为信用的贷款余额合计_企业) as 他行担保方式为信用的贷款余额合计
FROM    qbi_file_20240529_17_16_08 T
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.cst_chn_nm                                                                         AS cst_nm
                         ,a.sam_rsk_ctrl_id
                         ,DATEDIFF(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(b.bth_dt, 'yyyymmdd'), 'yyyy') AS age
                         ,a.mbl_nbr --手机
                         ,a.cmn_adr --通讯地址
                         ,a.fml_adr --家庭地址
                         ,a.wrk_adr --工作单位地址或经营所在地地址
                         ,a.reg_adr --户籍地址或注册地址
                         ,c.rel_cst_id --配偶客户号
                         ,c.cst_chn_nm  --配偶姓名
                 FROM    edw.dws_cst_bas_inf_dd a --客户基础信息汇总表
                 LEFT JOIN    edw.dim_cst_idv_bas_inf_dd b --个人客户基本信息
                 ON      a.cst_id = b.cst_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  a.cst_id
                                          ,a.rel_cst_id
                                          ,b.cst_chn_nm
                                  FROM    edw.dwd_cst_rel_inf_dd a --客户关联信息 （全）
                                  LEFT JOIN    edw.dws_cst_bas_inf_dd b --客户基础信息汇总表
                                  ON      a.rel_cst_id = b.cst_id
                                  AND     b.dt = '@@{yyyyMMdd}'
                                  WHERE   a.dt = '@@{yyyyMMdd}'
                                  AND     a.rel_rel_cd = '0301'  --配偶
                              ) c
                 ON      a.cst_id = c.cst_id
                 WHERE   a.dt = '@@{yyyyMMdd}'
             ) T1
ON      T.COL_2 = T1.cst_id
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户集市-客户基础-客户管户信息
ON      T.COL_2 = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
ON      T.COL_2 = T3.cst_id
AND     T3.report_dsc_rn = '1'
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,T1.report_id
                         ,COUNT(DISTINCT t1.dtrb_org)      AS 他行贷款机构家数_个人
                         ,SUM(t1.ctr_bal)                    AS 他行贷款余额_个人
                         ,SUm(t1.ctr_amt)                 AS 他行贷款金额_个人
                         ,WM_CONCAT(',', t3.intr_rat) AS mintr_rat --月利率
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '3' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为保证的贷款余额合计_个人
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '4' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为信用的贷款余额合计_个人
                 FROM    edw.dim_cst_ccrc_idv_loan_inf_dd t1 --个人征信客户贷款信息
                 LEFT JOIN    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t3 --个人征信借贷账户利率计算 intr_rat&permil;
                 ON      t1.report_id = t3.crd_rpt_id
                 AND     t1.act_id = t3.act_id
                 AND     t3.dt = '@@{yyyyMMdd}'
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 and  t1.dtrb_org <> 'ZJTLCB'
                 and  t1.dtrb_org_typ_cd in ( '11' , '12' , '14' , '15' )  --11商业银行,12村镇银行，14住房储蓄银行，15外资银行
                --  AND t1.act_typ_cd IN ( 'D1' , 'R1' , 'R4' )   --D1非循环贷账户,R1循环贷账户,R4循环额度下分账户
                 and t1.pd_cd in ('11','12','13','21','31','32','33','41','42','51','52','53','91','99')   --贷款类业务
                 AND     t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
                 AND     LENGTH(NVL(t1.cst_id, '')) > 0
                 GROUP BY t1.cst_id , T1.report_id
             ) T4
ON      T.COL_2 = T4.cst_id
AND     T3.report_no = T4.report_id
left join lab_bigdata_dev.tmp_SJ2024010236_zhenxin_03 T5
on T.COL_2=T5.企业客户号
WHERE   pt = MAX_PT('lab_bigdata_dev.qbi_file_20240529_17_16_08')
AND     T.col_1 = '预审批通过我行未有授信';

--SELECT * FROM lab_bigdata_dev.tmp_qingyuan_SJ2024052361_003

--4、泰惠收活跃户未配卡
--COL_1客户号，col_2，支行，col_2 客户经理
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingyuan_SJ2024052361_004 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_qingyuan_SJ2024052361_004 AS
SELECT  T.COL_1 客户号
        ,T1.cst_nm 客户姓名
        ,T.COL_2 支行
        ,T.COL_3 客户经理
        ,T1.sam_rsk_ctrl_id 同一风险控制号
        ,T1.age 年龄
        ,T1.mbl_nbr 手机
        ,T1.cmn_adr 通讯地址
        ,T1.fml_adr 家庭地址
        ,T1.wrk_adr 工作单位地址或经营所在地地址
        ,T1.reg_adr 户籍地址或注册地址
        ,T1.rel_cst_id 配偶客户号
        ,T1.cst_chn_nm 配偶姓名
        ,T2.ln_mgr_id 管护人id
        ,T2.ln_mgr_nm 管护人姓名
        ,T2.ln_org_id 管护机构id
        ,T2.ln_org_nm 管护机构名称
        ,coalesce(T4.他行贷款机构家数_个人,T5.他行贷款授信机构数_企业) as 他行贷款机构家数
        ,coalesce(T4.他行贷款余额_个人,T5.他行贷款余额_企业) as 他行贷款余额
        ,coalesce(T4.他行贷款金额_个人,T5.他行贷款金额_企业) as 他行贷款金额
        ,coalesce(T4.mintr_rat,T5.irr_企业)as  他行贷款月利率
        ,coalesce(T3.late_hly_loan_org_num,T5.近6个月金融机构审批通过家数) as 最近6个月贷款审批查询机构数
        ,coalesce(T4.他行担保方式为保证的贷款余额合计_个人,T5.他行担保方式为保证的贷款余额合计_企业) as 他行担保方式为保证的贷款余额合计
        ,coalesce(T4.他行担保方式为信用的贷款余额合计_个人,T5.他行担保方式为信用的贷款余额合计_企业) as 他行担保方式为信用的贷款余额合计
FROM    lab_bigdata_dev.qbi_file_20240529_17_17_29 T
LEFT JOIN    (
                 SELECT  a.cst_id
                         ,a.cst_chn_nm                                                                         AS cst_nm
                         ,a.sam_rsk_ctrl_id
                         ,DATEDIFF(to_date('@@{yyyyMMdd}', 'yyyymmdd'), to_date(b.bth_dt, 'yyyymmdd'), 'yyyy') AS age
                         ,a.mbl_nbr --手机
                         ,a.cmn_adr --通讯地址
                         ,a.fml_adr --家庭地址
                         ,a.wrk_adr --工作单位地址或经营所在地地址
                         ,a.reg_adr --户籍地址或注册地址
                         ,c.rel_cst_id --配偶客户号
                         ,c.cst_chn_nm  --配偶姓名
                 FROM    edw.dws_cst_bas_inf_dd a --客户基础信息汇总表
                 LEFT JOIN    edw.dim_cst_idv_bas_inf_dd b --个人客户基本信息
                 ON      a.cst_id = b.cst_id
                 AND     b.dt = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  a.cst_id
                                          ,a.rel_cst_id
                                          ,b.cst_chn_nm
                                  FROM    edw.dwd_cst_rel_inf_dd a --客户关联信息 （全）
                                  LEFT JOIN    edw.dws_cst_bas_inf_dd b --客户基础信息汇总表
                                  ON      a.rel_cst_id = b.cst_id
                                  AND     b.dt = '@@{yyyyMMdd}'
                                  WHERE   a.dt = '@@{yyyyMMdd}'
                                  AND     a.rel_rel_cd = '0301'  --配偶
                              ) c
                 ON      a.cst_id = c.cst_id
                 WHERE   a.dt = '@@{yyyyMMdd}'
             ) T1
ON      T.COL_1  = T1.cst_id
LEFT JOIN    adm_pub.adm_csm_cbas_mng_inf_dd T2 --客户集市-客户基础-客户管户信息
ON      T.COL_1 = T2.cst_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T3 --个人征信指标信息表
ON      T.COL_1 = T3.cst_id
AND     T3.report_dsc_rn = '1'
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,T1.report_id
                         ,COUNT(DISTINCT t1.dtrb_org)      AS 他行贷款机构家数_个人
                         ,SUM(t1.ctr_bal)                    AS 他行贷款余额_个人
                         ,SUm(t1.ctr_amt)                 AS 他行贷款金额_个人
                         ,WM_CONCAT(',', t3.intr_rat) AS mintr_rat --月利率
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '3' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为保证的贷款余额合计_个人
                         ,sum(CASE
                                WHEN t1.grnt_mth_cd = '4' THEN t1.ctr_bal
                              END)                    AS 他行担保方式为信用的贷款余额合计_个人
                 FROM    edw.dim_cst_ccrc_idv_loan_inf_dd t1 --个人征信客户贷款信息
                 LEFT JOIN    edw.dim_cst_ccrc_idv_dbt_act_rat_dd t3 --个人征信借贷账户利率计算 intr_rat&permil;
                 ON      t1.report_id = t3.crd_rpt_id
                 AND     t1.act_id = t3.act_id
                 AND     t3.dt = '@@{yyyyMMdd}'
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 and  t1.dtrb_org <> 'ZJTLCB'
                 and  t1.dtrb_org_typ_cd in ( '11' , '12' , '14' , '15' )  --11商业银行,12村镇银行，14住房储蓄银行，15外资银行
                --  AND t1.act_typ_cd IN ( 'D1' , 'R1' , 'R4' )   --D1非循环贷账户,R1循环贷账户,R4循环额度下分账户
                 and t1.pd_cd in ('11','12','13','21','31','32','33','41','42','51','52','53','91','99')   --贷款类业务
                 AND     t1.cls_dt >= '@@{yyyyMMdd}' --未关闭
                 AND     LENGTH(NVL(t1.cst_id, '')) > 0
                 GROUP BY t1.cst_id , T1.report_id
             ) T4
ON      T.COL_1  = T4.cst_id
AND     T3.report_no = T4.report_id
left join lab_bigdata_dev.tmp_SJ2024010236_zhenxin_03 T5
on T.COL_1=T5.企业客户号
WHERE   pt = MAX_PT('lab_bigdata_dev.qbi_file_20240529_17_17_29')
;


SELECT * FROM lab_bigdata_dev.tmp_qingyuan_SJ2024052361_004;


--企业客户征信信息清单
--用信机构数、他行授信金额合计、他行贷款余额合计、近6个月征信查询机构数合计,他行担保方式为信用余额合计、他行担保方式为保证的余额合计、他行贷款利率
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SJ2024010236_zhenxin_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_SJ2024010236_zhenxin_03 AS
SELECT  A1.cst_id 企业客户号
       ,A1.report_no 企业报告编号
       ,A1.late_6mon_org_pass_num 近6个月金融机构审批通过家数
       ,T.他行贷款授信机构数_企业
       ,T.他行贷款余额_企业
       ,T.他行贷款金额_企业
       ,T.irr_企业
       ,T.他行担保方式为保证的贷款余额合计_企业
       ,T.他行担保方式为信用的贷款余额合计_企业
FROM  edw.dws_cst_ccrc_entp_ind_inf_dd A1  --企业征信指标信息表
left join (
          SELECT  A2.cst_id
        ,A2.report_id
        ,COUNT(DISTINCT A2.dtrb_org_cd) AS 他行贷款授信机构数_企业
        ,SUM(A2.loan_bal)               AS 他行贷款余额_企业
        ,SUM(A2.loan_amt)               AS 他行贷款金额_企业
        ,WM_CONCAT(',', A3.irr)         AS irr_企业 --月利率
        ,sum(CASE
               WHEN A2.grnt_mth_cd = '1' THEN A2.loan_bal
             END)                       AS 他行担保方式为保证的贷款余额合计_企业
        ,sum(CASE
               WHEN A2.grnt_mth_cd = '0' THEN A2.loan_bal
             END)                       AS 他行担保方式为信用的贷款余额合计_企业
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A2 --企业征信客户贷款信息
LEFT JOIN    edw.ncip_ceq_account_calculate A3 --征信企业借贷账户利率计算
ON      A2.report_id = A3.report_id
AND     A2.act_id = A3.le_acc_number
AND     A3.dt = '@@{yyyyMMdd}'
WHERE   A2.dt = '@@{yyyyMMdd}'
AND     A2.dtrb_org_typ_cd <> ''  --排除泰隆
and     A2.dtrb_org_typ_cd IN ( '11' , '12' , '14' , '15' )  --11商业银行,12村镇银行，14住房储蓄银行，15外资银行
-- AND     A2.loan_mtu_dt >= '@@{yyyyMMdd}' --未到期
AND     A2.cls_dt >= '@@{yyyyMMdd}' --未关闭
AND     A2.bus_pd_cls_cd = '11' --业务产品种类代码,贷款
AND     LENGTH(NVL(A2.cst_id, '')) > 0
GROUP BY A2.cst_id , A2.report_id
)T
ON A1.report_no = T.report_id
WHERE A1.DT = '@@{yyyyMMdd}'
and A1.report_dsc_rn = 1;

--SELECT * FROM lab_bigdata_dev.tmp_SJ2024010236_zhenxin_03
**01-数据需求_村行_D0530_大冶村行_程聪聪_常态化自查工作中排查我行信贷客户名下的关联企业及其征信查询情况.sql
--截至5月20日，大冶村行近一年发放业务对应的客户名下的关联企业及征信查询情况

-- 客户号 贷款金额 贷款余额 合同起始日、到期日 经办人 管户人  经办机构  管户机构  关联企业名称  系统是否录入   是否同一风险控制号   预评估是否查询  查询结果
-- SJ2024052822

-- lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 同需求SJ2024052856
-- lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03 同需求SJ2024052856
-- lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_04 同需求SJ2024052856
-- 截至5月20日，大冶村行近一年发放业务对应的客户号名下的关联企业及征信查询情况


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024052822_mingxia_qiye_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024052822_mingxia_qiye_01 AS
SELECT  DISTINCT B1.cst_id  AS 客户号
                 ,B1.cst_nm	 AS 客户名称
                 ,B1.ctr_amt	 AS 贷款金额
				 ,B1.ctr_bal	 AS 贷款余额
				 ,B1.apnt_start_dt	 AS 合同起始日
				 ,B1.apnt_mtu_dt	  AS 到期日
				 ,B1.opr_id   AS 经办人ID
				 ,B7.empe_nm	 AS 经办人
				 ,B1.hdl_org_id	 AS 经办机构ID
				 ,B6.org_nm	 AS 经办机构
				 ,B0.acs_mngr_id AS 管户人ID
				 ,B5.empe_nm  AS 管户人
				 ,B0.acs_org_id AS 管户机构ID
				 ,B4.org_nm AS 管户机构
                 ,T3.dt_gpr_entname AS 客户关联企业名称
                 ,T3.关系类型
                 ,T5.in_namecn      AS 股东姓名
                ,COALESCE (CASE
                              WHEN T3.关系类型 = '客户担任法人企业' THEN T2.cst_chn_nm
                             ELSE T4.in_namecn
                              END,T41.GEB_FRNAME  )             AS 法人姓名
                 ,CASE
                    WHEN T7.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END               AS 我行系统是否录入
                 ,CASE
                    WHEN B2.srl_nbr IS NOT NULL THEN '是'
                    ELSE '否'
                  END               AS 预评估是否查询
                 ,B3.cd_val_dscr    AS 查询结果
FROM     edw.dim_bus_loan_ctr_inf_dd B1 --信贷合同信息
LEFT JOIN edw.dwd_bus_loan_ctr_mgr_inf_dd B0 --信贷合同管护信息
ON  B1.busi_ctr_id= B0.busi_ctr_id
AND B0.DT = '20240520'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd B4 --机构树_考核维度
ON  B0.acs_org_id = B4.org_id
AND B4.DT = '20240520'
LEFT JOIN edw.dws_hr_empe_inf_dd B5 --员工汇总信息
ON  B0.acs_mngr_id = B5.empe_id
AND B5.DT = '20240520'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd B6 --机构树_考核维度
ON  B1.hdl_org_id = B6.org_id
AND B6.DT = '20240520'
LEFT JOIN edw.dws_hr_empe_inf_dd B7 --员工汇总信息
ON  B1.opr_id = B7.empe_id
AND B7.DT = '20240520'
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      B1.cst_id = T2.cst_id
AND     T2.DT = '20240520'
LEFT JOIN    (
                 SELECT  A1.in_ctfno
                         ,A1.dt_gpr_entname --企业(机构)名称
                         ,A1.dt_gpr_enttype --企业(机构)类型
                         ,A1.dt_gpr_entstatus --企业状态
                         ,A1.dt_gpr_creditcode --统一社会信用代码
                         ,'' AS dt_gpr_fundedratio
                         ,'客户担任法人企业' 关系类型
                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 A1 --法人
                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''
                 UNION ALL
                 SELECT  A1.in_ctfno
                         ,A1.dt_gpr_entname --企业(机构)名称
                         ,A1.dt_gpr_enttype --企业(机构)类型
                         ,A1.dt_gpr_entstatus --企业状态
                         ,A1.dt_gpr_creditcode --统一社会信用代码
                         ,A1.dt_gpr_fundedratio
                         ,'客户担任股东企业' 关系类型
                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03 A1 --股东
                 LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 A2 --法人
                 on     A1.in_namecn = A2.in_namecn
                 AND     A1.dt_gpr_entname = A2.dt_gpr_entname
                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''
                 AND     A2.in_namecn IS NULL --剔除客户担任法人的企业
             ) T3 --客户关联企业
ON      T2.doc_nbr = T3.in_ctfno
LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 T4 --取关联企业法人
ON      T3.dt_gpr_entname = T4.dt_gpr_entname
AND     T3.关系类型 = '客户担任股东企业'
LEFT JOIN  lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_04 T41 --取关联企业法人 工商信息补充
ON      T3.dt_gpr_entname = T41.GEB_ENTNAME
AND     T3.关系类型 = '客户担任股东企业'
LEFT JOIN    (
                 SELECT  A1.dt_gpr_entname --统一社会信用代码
                         ,WM_CONCAT(DISTINCT '||', A1.in_namecn) AS in_namecn
                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03 A1 --股东
                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''
                 AND     COALESCE(A1.in_namecn, '') <> ''
                 GROUP BY A1.dt_gpr_entname
             ) T5 --取关联企业股东
ON      T3.dt_gpr_entname = T5.dt_gpr_entname
LEFT JOIN    edw.dws_cst_bas_inf_dd T6 --客户基础信息汇总表   --取关联企业客户号
ON      T3.dt_gpr_creditcode = T6.doc_nbr
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_rel_inf_dd T7 --客户关联关系信息  --我行登记关联企业与客户是否关联
ON      B1.cst_id = T7.cst_id
AND     T6.cst_id = T7.rel_cst_id
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_pre_ases_rsl_dd B2 --预评估最终结果信息
ON      B1.pre_apl_srl_nbr = B2.srl_nbr
AND     B2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd B3 -- 码值表
ON      B2.pre_ases_rsl = B3.cd_val
AND     B3.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'
AND     B3.fld_nm = 'PREEVALUATERESULT'
AND     B3.dt = '@@{yyyyMMdd}'
WHERE   B1.DT='20240520'
AND     B1.apnt_start_dt>='20230520'
AND     (B4.brc_org_nm='湖北大冶泰隆村镇银行' or  B6.brc_org_nm='湖北大冶泰隆村镇银行' )
;

SELECT * from lab_bigdata_dev.tmp_dsj_SJ2024052822_mingxia_qiye_01
**01-数据需求_村行_D0530_大冶村行_程聪聪_排查我行信贷客户名下所有关联企业情况.sql
-- SJ2024052856





-- 关联企业名称股东信息（占股20%以上）法人我行系统是否录入预评估是否查询查询结果



--字段：客户名称	合同号	同一风险控制号	管户机构ID	管护机构名称	管护人名称	经办日期

--关联企业名称	股东信息（占股20%以上）		法人	我行系统是否录入	预评估是否查询	查询结果



-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_01 PURGE;



-- CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_01

-- (

 -- 客户号  STRING

-- ,客户名称    STRING

-- ,合同号     STRING

-- ,同一风险控制号  STRING

-- ,管户机构ID   STRING

-- ,管护机构名称  STRING

-- ,管护人名称   STRING

-- ,经办日期  STRING

-- ) ;





--临时表一：作为法人的企业信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 PURGE;



CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 AS

SELECT  *

FROM    (

            SELECT  *

                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk

            FROM    (

                        SELECT  dt

                                ,in_ctfno --高管证件号

				,in_namecn	 --高管姓名

                                ,dt_gpr_entname --企业(机构)名称

                                ,dt_gpr_enttype --企业(机构)类型

                                ,dt_gpr_entstatus --企业状态

                                ,dt_gpr_creditcode --统一社会信用代码

                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息

                        WHERE   dt <= '@@{yyyyMMdd}' ---------------xt:添加查得标识=1

                        AND     gpr_ifrichard = '1' --查的标识=1

                        UNION ALL

                        SELECT  dt

                                ,gpm_ctfno in_ctfno

				,gpm_namecn in_namecn

                                ,gpr_entname dt_gpr_entname

                                ,gpr_enttype dt_gpr_enttype

                                ,gpr_entstatus dt_gpr_entstatus --旧表

                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码

                        FROM    (

                                    SELECT  *

                                    FROM    (

                                                SELECT  c.dt

                                                        ,gpm_ctfno --被查询人证件号码

							,gpm_namecn	 --被查询人姓名

                                                        ,c.gpr_entname --企业(机构)名称

                                                        ,c.gpr_entstatus --企业状态

                                                        ,c.gpr_enttype --企业(机构)类型

                                                        ,c.gpr_creditcode --统一社会信用代码

                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn

                                                FROM    edw.outd_gs_person_main a --工商个人主表

                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息

                                                ON      a.gpm_flowno = c.gpr_flowno

                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为法人的企业信息

                                                WHERE   a.dt <= '@@{yyyyMMdd}'

                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'

                                            ) aa

                                    WHERE   aa.rn = 1

                                ) cc

                    ) bb

        ) d

WHERE   d.rk = 1

AND     d.dt_gpr_entstatus RLIKE '在营';









---临时表二： 作为股东的企业信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03;



CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03 AS

SELECT  *

FROM    (

            SELECT  *

                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk

            FROM    (

                        SELECT  dt

                                ,in_ctfno --高管证件号

				,in_namecn --高管姓名

                                ,dt_gpr_entname --企业(机构)名称

                                ,dt_gpr_enttype --企业(机构)类型

                                ,dt_gpr_entstatus --企业状态

                                ,dt_gpr_fundedratio --投资比例

                                ,dt_gpr_creditcode --统一社会信用代码

                        FROM    edw.nout_gs_prsn_ryposshatd --工商个人替代-人员股东信息

                        WHERE   dt <= '@@{yyyyMMdd}'

                        AND     REPLACE(dt_gpr_fundedratio, '%', '') >= 20 --占股20%以上

                        AND     gpr_ifrichard = '1' --查的标识=1

                        UNION ALL

                        SELECT  dt

                                ,gpm_ctfno in_ctfno

				,gpm_namecn in_namecn

                                ,gpr_entname dt_gpr_entname

                                ,gpr_enttype dt_gpr_enttype

                                ,gpr_entstatus dt_gpr_entstatus

                                ,gpr_fundedratio dt_gpr_fundedratio

                                ,gpr_creditcode dt_gpr_creditcode

                        FROM    (

                                    SELECT  *

                                    FROM    (

                                                SELECT  c.dt

                                                        ,gpm_ctfno

							,gpm_namecn

                                                        ,c.gpr_entname

                                                        ,c.gpr_entstatus

                                                        ,c.gpr_enttype

                                                        ,c.gpr_fundedratio

                                                        ,c.gpr_creditcode

                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn

                                                FROM    edw.outd_gs_person_main a --工商个人主表

                                                INNER JOIN    edw.outd_gs_person_rypossha c --工商个人-人员股东信息

                                                ON      a.gpm_flowno = c.gpr_flowno

                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为股东的企业信息

                                                WHERE   a.dt <= '@@{yyyyMMdd}'

                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'

                                                AND     REPLACE(gpr_fundedratio, '%', '') >= 20  --占股20%以上

                                            ) aa

                                    WHERE   rn = 1

                                ) bb

                    ) aa

        ) B

WHERE   B.rk = 1

AND     B.dt_gpr_entstatus RLIKE '在营';





-------临时表三 工商信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_04;



CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_04 AS

SELECT  GEB_ENTNAME -------客户名称,

        ,GEB_CREDITCODE -----统一社会信用代码,

        ,GEB_ENTTYPE -----企业机构类型,

        ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,

        ,GEB_ENTSTATUS -----经营状态,

        ,GEB_RECCAP -----实收资本万元,

        ,GEB_REGCAPCUR -----注册资本币种,

        ,GEB_REGORGCITY -----所在城市,

        ,GEB_REGORGDISTRICT -----所在区县,

        ,GEB_ZSOPSCOPE -----经营业务范围,

        ,GEB_DOM -----住所,

        ,GEB_INDUSTRYCONAME -----国民经济代码名称,

        ,geb_esdate

        ,geb_othertel --其他电话

        ,geb_regorgprovince  --所在省份

        ,geb_regorgcode  --注册地址行政编号

        ,ROW_NO

FROM    (

            SELECT  *

                    ,row_number() OVER ( PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC ) AS ROW_NO

            FROM    (

                        SELECT  GEB_ENTNAME -------客户名称,

                                ,GEB_CREDITCODE -----统一社会信用代码,

                                ,GEB_ENTTYPE -----企业机构类型,

                                ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,

                                ,GEB_ENTSTATUS -----经营状态,

                                ,GEB_RECCAP -----实收资本万元,

                                ,GEB_REGCAPCUR -----注册资本币种,

                                ,GEB_REGORGCITY -----所在城市,

                                ,GEB_REGORGDISTRICT -----所在区县,

                                ,GEB_ZSOPSCOPE -----经营业务范围,

                                ,GEB_DOM -----住所,

                                ,GEB_INDUSTRYCONAME -----国民经济代码名称,

                                ,geb_esdate ----成立日期

                                ,geb_othertel ----其他电话

                                ,GEB_HOSTSENDTIME ------geb_hostsendtime 交易发送主机时间

				,geb_regorgprovince  --所在省份

				,geb_regorgcode  --注册地址行政编号

                        FROM    edw.OUTD_GS_ENTINFO_BASIC --工商企业-企业基本信息

                        WHERE   dt <= '@@{yyyyMMdd}'

                        UNION ALL

                        SELECT  dt_entname             AS GEB_ENTNAME -----企业名称

                                ,dt_creditcode         AS GEB_CREDITCODE ---统一信用代码

                                ,dt_enttype            AS GEB_ENTTYPE -----企业类型

                                ,dt_frname             AS GEB_FRNAME -----法定代表人负责人执行事务合伙人

                                ,dt_entstatus          AS GEB_ENTSTATUS -----经营状态

                                ,dt_reccap             AS GEB_RECCAP -----实收资本万元

                                ,dt_regcapcur          AS GEB_REGCAPCUR -----注册资本币种

                                ,dt_regorgcity         AS GEB_REGORGCITY -----所在城市

                                ,dt_regorgdistrict     AS GEB_REGORGDISTRICT -----所在区县

                                ,dt_zsopscope          AS GEB_ZSOPSCOPE -----经营业务范围

                                ,dt_dom                AS GEB_DOM -----住所

                                ,dt_industryconame     AS GEB_INDUSTRYCONAME -----国民经济代码名称

                                ,dt_esdate             AS geb_esdate

                                ,dt_othertel           AS geb_othertel ----其他电话

                                ,insert_time_chinadaas AS GEB_HOSTSENDTIME

				,dt_regorgprovince     AS geb_regorgprovince  --所在省份

				,dt_regorgcode         AS geb_regorgcode  --注册地址行政编号

                        FROM    edw.nout_zs_ent_basic

                        WHERE   dt <= '@@{yyyyMMdd}'

                    ) t1

        ) t2

WHERE   t2.ROW_NO = 1;









--结果表

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_05 PURGE;



CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_05 AS

SELECT  DISTINCT B1.cst_id AS 客户号

                 ,T1.客户名称

                 ,T1.合同号

                 ,T1.同一风险控制号

                 ,T1.管户机构ID

                 ,T1.管护机构名称

                 ,T1.管护人名称

                 ,T1.经办日期

                 ,T3.dt_gpr_entname AS 客户关联企业名称

                 ,T3.关系类型

                 ,T5.in_namecn      AS 股东姓名

                 ,COALESCE (CASE

                              WHEN T3.关系类型 = '客户担任法人企业' THEN T2.cst_chn_nm

                             ELSE T4.in_namecn

                              END,T41.GEB_FRNAME  )             AS 法人姓名

                 ,CASE

                    WHEN T7.cst_id IS NOT NULL THEN '是'

                    ELSE '否'

                  END               AS 我行系统是否录入

                 ,CASE

                    WHEN B2.srl_nbr IS NOT NULL THEN '是'

                    ELSE '否'

                  END               AS 预评估是否查询

                 ,B3.cd_val_dscr    AS 查询结果

FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_01 T1

LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd B1 --信贷合同信息

ON      T1.合同号 = B1.busi_ctr_id

AND     B1.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表

ON      B1.cst_id = T2.cst_id

AND     T2.DT = '@@{yyyyMMdd}'

LEFT JOIN    (

                 SELECT  A1.in_ctfno

                         ,A1.dt_gpr_entname --企业(机构)名称

                         ,A1.dt_gpr_enttype --企业(机构)类型

                         ,A1.dt_gpr_entstatus --企业状态

                         ,A1.dt_gpr_creditcode --统一社会信用代码

                         ,'' AS dt_gpr_fundedratio

                         ,'客户担任法人企业' 关系类型

                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 A1 --法人

                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''

                 UNION ALL

                 SELECT  A1.in_ctfno

                         ,A1.dt_gpr_entname --企业(机构)名称

                         ,A1.dt_gpr_enttype --企业(机构)类型

                         ,A1.dt_gpr_entstatus --企业状态

                         ,A1.dt_gpr_creditcode --统一社会信用代码

                         ,A1.dt_gpr_fundedratio

                         ,'客户担任股东企业' 关系类型

                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03 A1 --股东

                 LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 A2 --法人

                 on     A1.in_namecn = A2.in_namecn

                 AND     A1.dt_gpr_entname = A2.dt_gpr_entname

                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''

                 AND     A2.in_namecn IS NULL --剔除客户担任法人的企业

             ) T3 --客户关联企业

ON      T2.doc_nbr = T3.in_ctfno

LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_02 T4 --取关联企业法人

ON      T3.dt_gpr_entname = T4.dt_gpr_entname

AND     T3.关系类型 = '客户担任股东企业'

LEFT JOIN  lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_04 T41 --取关联企业法人 工商信息补充

ON      T3.dt_gpr_entname = T41.GEB_ENTNAME

AND     T3.关系类型 = '客户担任股东企业'

LEFT JOIN    (

                 SELECT  A1.dt_gpr_entname --统一社会信用代码

                         ,WM_CONCAT(DISTINCT '||', A1.in_namecn) AS in_namecn

                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_03 A1 --股东

                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''

                 AND     COALESCE(A1.in_namecn, '') <> ''

                 GROUP BY A1.dt_gpr_entname

             ) T5 --取关联企业股东

ON      T3.dt_gpr_entname = T5.dt_gpr_entname

LEFT JOIN    edw.dws_cst_bas_inf_dd T6 --客户基础信息汇总表   --取关联企业客户号

ON      T3.dt_gpr_creditcode = T6.doc_nbr

AND     T6.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dim_cst_rel_inf_dd T7 --客户关联关系信息  --我行登记关联企业与客户是否关联

ON      B1.cst_id = T7.cst_id

AND     T6.cst_id = T7.rel_cst_id

AND     T7.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_bus_loan_pre_ases_rsl_dd B2 --预评估最终结果信息

ON      B1.pre_apl_srl_nbr = B2.srl_nbr

AND     B2.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd B3 -- 码值表

ON      B2.pre_ases_rsl = B3.cd_val

AND     B3.tbl_nm = 'CUSTOMER_PREEVALUATE_RESULT'

AND     B3.fld_nm = 'PREEVALUATERESULT'

AND     B3.dt = '@@{yyyyMMdd}';



SELECT * FROM lab_bigdata_dev.tmp_dsj_SJ2024052856_mingxia_qiye_05 WHERE 客户关联企业名称='大冶市广盛矿产品有限公司'
**01-数据需求_村行_D0531_长乐村行_林杰_全量贷款数据.sql
-- 字段：合同流水号、客户编号、客户名称、是否签署共同还款承诺书、配偶是否签入担保

-- 截止2024.05.28，长乐村行全量贷款数据

-- SJ2024052956

drop table IF EXISTS lab_bigdata_dev.tmp_changle_SJ2024052956_01 PURGE ;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_changle_SJ2024052956_01 as

SELECT

   T1.busi_ctr_id	 AS 合同流水号

   ,T1.cst_id	 AS 客户编号

   ,T1.cst_nm	 AS 客户名称

   ,T1.sgn_spus_com_dbt_ind	 AS 是否签署共同还款承诺书

   ,MAX(CASE WHEN T3.wrnt_cst_id IS NOT NULL THEN 1 ELSE 0 END) AS 配偶是否签入担保_1是0否

FROM edw.dim_bus_loan_ctr_inf_dd T1  --信贷合同信息

LEFT JOIN edw.loan_customer_relative T2 --信贷客户关联信息

ON T1.cst_id=T2.customerid

AND T2.relationship='0301' --配偶

AND T2.DT='20240528'

LEFT JOIN  edw.dws_bus_grnt_prsn_inf_dd T3 --担保人汇总信息

ON T1.busi_ctr_id=  T3.bus_ctr_id

AND T2.relativeid= T3.wrnt_cst_id	  --配偶客户号=担保人客户号

AND T3.DT='20240528'

WHERE T1.DT='20240528'

AND   T1.hdl_org_id	LIKE '3562%'  --经办机构长乐村行

AND     ( T1.CTR_BAL > 0 --余额>0

    OR ( T1.CTR_BAL = 0

AND     T1.APNT_MTU_DT >= '20240528' --约定到期日期大于等于当前

AND     NVL(T1.FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结

AND     T1.END_DT = '18991231' --终结日期=18991231即为合同未终结

) ) --合同未结清

GROUP BY  T1.busi_ctr_id,T1.cst_id,T1.cst_nm,T1.sgn_spus_com_dbt_ind

;



--SELECT * FROM lab_bigdata_dev.tmp_changle_SJ2024052956_01
**01-数据需求_村行_D0614_庆元村行_吴美健_客户5月催收走访记录.sql
--2024年05月（20240501-20240531）庆元村行催收走访记录
--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024061246 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024061246 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     substr(t1.coln_date,1,7) ='2024-05'
;



-- SELECT * FROM lab_bigdata_dev.tmp_sjxq_SJ2024061246
-- ;
**01-数据需求_村行_D0614_政和村行_张弛_客户地址信息.sql
--用途：	政和县税务局核查税收减免政策，需用我行存量贷款客户户籍地址，居住地址，经营地址
--2021年至2024年5月政和村行全行数据，客户号，客户姓名，户籍地址，居住地址，经营地址
DROP TABLE IF EXISTS zhenghedizhi_SJ20240613111 PURGE;

CREATE TABLE IF NOT EXISTS zhenghedizhi_SJ20240613111  AS
SELECT DISTINCT T.customerid 客户号
        ,T.cst_chn_nm 客户姓名
        ,CASE
           WHEN T1.PHY_ADR_TYP_CD = '050100' THEN T1.ful_adr
         END AS 户籍地址
        ,CASE
           WHEN T1.PHY_ADR_TYP_CD = '050300' THEN T1.ful_adr
         END AS 通讯地址
        ,CASE
           WHEN T1.PHY_ADR_TYP_CD = '050200' THEN T1.ful_adr
         END AS 家庭地址
        ,CASE
           WHEN T1.PHY_ADR_TYP_CD = '050900' THEN T1.ful_adr
         END AS 经营地址
FROM    (
            SELECT  cb.customerid --客户号
                    ,bi.cst_chn_nm --客户姓名
                    ,cb.orgid --管护机构
                    ,cb.userid --管护人
            FROM    edw.loan_customer_belong cb --客户所属列表
            LEFT JOIN    edw.dim_cst_bas_inf_dd bi
            ON      cb.customerid = bi.cst_id
            AND     bi.dt = '20240531'
            WHERE   cb.dt = '20240531'
            AND     cb.belongattribute = '1'
            AND     cb.orgid LIKE '3561%' --福建政和村行
            AND     cb.inputdate >= '20210101'
        ) T
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T1 --客户物理地址信息
ON      T.customerid = T1.cst_id
AND     T1.dt = '20240531'
;

-- SELECT count(DISTINCT 客户号)  FROM zhenghedizhi_SJ20240613111
**01-数据需求_村行_D0918_庆元村行_吴美健_的核心系统还款流水和利息减免流水.sql
-- 合同流水号900120151120000024(借款人吴海燕贷款金额60万元)\合同流水号900120170413000024(借款人吴树华贷款金额20万元)，两笔合同流水号的核心系统还款流水和利息减免流水。
-- 利息还款时间，利息减免时间，金额、转入日期、转入人户名和账户等。

-- 取转入字段，需关联 edw.core_klnl_dkkhmx  --贷款客户账户交易明细表。取还款账号，维护日期 ，用交易流水和交易日期2个字段关联
-- 还款对应事件：LN_BXTZ、LN_HXGH、LN_TQHK、LN_ZCHK、LN_YQHK  --本息调整、核销归还、提前还款、正常还款、逾期还款
-- 交易方向：
-- ZJ 0 增加
--  JS 1 减少 ，还款
-- 金额对应各种事件的汇总


--分别对应2条借据，
-- ctr_serno	        dbil_id	            cst_id	    cst_nm
-- 900120170413000024	900120170413000024	7005433772	吴树华
-- 900120151120000024	900120151120000025	1018353986	吴海燕

SELECT T1.ctr_serno ,T1.dbil_id,T1.cst_id,T1.cst_nm,T1.ctr_amt FROM edw.dim_bus_loan_dbil_inf_dd T1 --信贷借据信息
WHERE   T1.dt = '@@{yyyyMMdd}'
AND     T1.ctr_serno IN ( '900120151120000024' , '900120170413000024' );

--取还款时间
SELECT  a.kehuhaoo  AS 客户号
        ,a.kehmingc AS 客户名称
        ,a.dkjiejuh AS 借据号
        ,a.dkzhangh AS 贷款账户
        ,a.jiaoyirq AS 还款日期
        ,a.jiaoyije AS 交易金额
        ,a.jiaoyifx AS 交易方向
        ,a.yeziduan AS 贷款余额字段
        ,a.yuezdshm AS 余额字段说明
        ,a.jiaoyisj AS 交易事件
        ,a.shjshuom AS 事件说明
        ,a.jiaoyima AS 交易码
        ,a.zhaiyoms AS 摘要
FROM    edw.core_klnl_dkzhmx a  --贷款账户交易明细
-- LEFT JOIN    edw.core_klnl_dkkhmx b --贷款客户账户交易明细表
-- ON      a.jiaoyils = b.jiaoyils --交易流水
-- AND     a.jiaoyirq = b.jiaoyirq --交易日期
-- AND     b.dt >= '20171118'
WHERE   a.dt >= '20150101'
AND     a.jiaoyifx = '1' --还款
AND     a.jiaoyisj IN ( 'LN_BXTZ' , 'LN_HXGH' , 'LN_TQHK' , 'LN_ZCHK' , 'LN_YQHK' ) --本息调整、核销归还、提前还款、正常还款、逾期还款
AND     a.dkjiejuh IN ( '900120170413000024' , '900120151120000025' )
;

SELECT * FROM edw.core_klnl_dkzhmx a WHERE   a.dt >= '20150101' and a.dkjiejuh IN ('900120151120000025' )


--取利息减免日期
SELECT  a.kehuhaoo  AS 客户号
        ,a.kehmingc AS 客户名称
        ,a.dkjiejuh AS 借据号
        ,a.dkzhangh AS 贷款账户
        ,a.jiaoyirq AS 利息减免日期
        ,a.jiaoyije AS 交易金额
        ,a.jiaoyifx AS 交易方向
        ,a.yeziduan AS 贷款余额字段
        ,a.yuezdshm AS 余额字段说明
        ,a.jiaoyisj AS 交易事件
        ,a.shjshuom AS 事件说明
        ,a.jiaoyima AS 交易码
        ,a.zhaiyoms AS 摘要
FROM    edw.core_klnl_dkzhmx a --贷款账户交易明细
WHERE   a.DT >= '20150101'
AND     a.jiaoyisj IN ( 'LN_BXTZ' , 'LN_LXTZ' ) --本息调整，利息调整
-- AND     a.zhaiyoms NOT LIKE '%抵扣%' --需同业务确认抵扣算不算还款
-- AND     a.jiaoyima <> 'w02b' --转出转账撤销
AND     a.jiaoyima IN ( '2617a' , '2618b' , '5331' )
AND     a.dkjiejuh IN ( '900120170413000024' , '900120151120000025' )
;
**01-数据需求_村行_D0925_旬阳村行_石头_全量贷款客户征信分及中征分.sql
--SJ20240925101
-- 截止2024年9月24日，旬阳村行全量贷款客户
-- 字段包括不限于：客户名、客户名、授信总额、贷款余额、管护客户经理、管护机构（团队层级）、人行征信评分、中征分

--新版,中征分
-- EDW.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI 单笔的征信分
-- EDW.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI 月底批量的征信分
--旧版，人行征信评分。老表6月后的数据不更新
--edw.dws_cst_ccrc_idv_ind_inf_dd--个人征信指标信息表
--edw.dws_cst_ccrc_entp_ind_inf_dd -企业征信指标信息表，企业无征信分


DROP TABLE IF EXISTS tmp_st_SJ20240925101 PURGE;

CREATE TABLE IF NOT EXISTS tmp_st_SJ20240925101 AS
SELECT  a.cst_id                                         AS 客户号
        ,a.cst_nm                                        AS 客户名
        ,a.ctr_serno                                     AS 合同流水号
        ,a.ctr_amt                                       AS 合同金额
        ,a.ctr_bal                                       AS 合同余额
        ,d.prm_mgr_id                                    AS 主管护人工号
        ,d.prm_mgr_nm                                    AS 主管护人名称
        ,d.prm_org_id                                    AS 主管护机构号
        ,d.prm_org_nm                                    AS 主管护机构名称
        -- ,b.tem_org_nm                                    AS 团队层级机构名称
        -- ,a.mgr_id                                        AS 合同管护人工号
        -- ,a.mgr_org_id                                    AS 合同管护机构号
        ,greatest(c.idv_crd_sco_val, c.idv_crd_sco_val2) AS 人行征信评分
        ,t2.cst_cr_grd_val                               AS 中征分
FROM    (
            SELECT  t.cst_id
                    ,t.cst_nm
                    ,t.ctr_serno
                    ,t.ctr_amt
                    ,t.ctr_bal
                    --     ,sum(t.ctr_amt) AS sum_ctr_amt
                    --     ,sum(t.ctr_bal) AS sum_ctr_bal
                    ,t.mgr_id
                    ,t.mgr_org_id
            FROM    edw.dim_bus_loan_ctr_bse_inf_dd t --合同基础信息
            WHERE   t.dt = '20240924'
            --     GROUP BY t.cst_id , t.cst_nm , t.mgr_id , t.mgr_org_id
            ---未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
            AND     ( ( t.CTR_STS_CD IN ( '2' , '4' )
            AND     t.TMT_DT = '18991231'
            AND     to_date(t.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t.DT, 'yyyyMMdd') )
                OR t.CTR_BAL > 0 )
            AND     t.mgr_org_id LIKE '6161%'    --陕西旬阳村行
        ) a
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd d --客户主管护
ON      a.cst_id = d.cst_id
AND     d.dt = '20240924'
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd b
-- ON      d.prm_org_id = b.org_id
-- AND     b.dt = '20240924'
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd c --个人征信指标信息表
ON      a.cst_id = c.cst_id
AND     c.dt = '20240924'
AND     c.report_dsc_rn = 1
LEFT JOIN    (
                 SELECT  t.cst_id
                         ,t.prd_dt
                         ,t.cst_cr_grd_val
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) AS rn
                 FROM    (
                             SELECT  cst_id
                                     ,to_date(REPLACE(substr(qry_tm, 1, 10), '-', ''), 'yyyymmdd') AS prd_dt
                                     ,cr_sco_val                                                   AS cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI --单笔评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                             WHERE   dt <= '20240924'
                             UNION
                             SELECT  cst_id
                                     ,to_date(prd_dt, 'yyyymmdd') AS prd_dt
                                     ,cst_cr_grd_val
                             FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI --月底批量的征信分, 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                             WHERE   dt <= '20240924'
                         ) t
             ) t2
ON      a.cst_id = t2.cst_id
AND     t2.rn = 1;
**01-数据需求_村行_D1028_英德村行_廖志丽.sql
-- SJ2024102841
-- 截止2024年9月30日英德村行存量客户清单数据
-- 客户姓名、客户号、开户机构编号、开户日期、主管户机构、主管护机构名称、主管户客户经理、主管户客户经理名称、
-- 客户账号、存款账号、上月存款日均、账户状态、有效户标识、有效信贷户标识、有效存款户标识、是否授信客户
-- 同一风险控制号、子社区编号、子社区名称、户籍地址_注册地址、工作单位或经营地址、通讯地址、家庭地址



DROP TABLE IF EXISTS tmp_sjxq_SJ2024102841 PURGE ;
CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024102841 as
SELECT DISTINCT a.cst_id 客户号
        ,a.cst_nm 客户姓名
        ,b.opn_org 开户机构编号
        ,b.opn_dt 开户日期
        ,a.prm_org_id 主管户机构
        ,a.prm_org_nm 主管护机构名称
        ,a.prm_mgr_id 主管户客户经理
        ,a.prm_mgr_nm 主管户客户经理名称
        ,b.cst_act_id 客户账号
        ,b.dep_act_id 存款账号
        ,b.act_mth_acm_bal / 30 上月存款日均
        -- ,b.act_sts_cd 账户状态
        ,b1.cd_val_dscr 账户状态
        ,c.efe_cst_ind 有效户标识1是
        ,c.efe_loan_cst_ind 有效信贷户标识1是
        ,c.efe_dep_cst_ind 有效存款户标识1是
        ,CASE
           WHEN d.ctr_serno IS NOT NULL THEN '是'
           ELSE '否'
         END 是否授信客户
        ,e.sam_rsk_ctrl_id 同一风险控制号
        ,e.sub_cmnt_id 子社区编号
        ,d1.cmnt_nm 子社区名称
        ,e.reg_adr 户籍地址_注册地址
        ,e.wrk_adr 工作单位_经营地址
        ,e.cmn_adr 通讯地址
        ,e.fml_adr 家庭地址
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd a --主管护
LEFT JOIN    edw.dws_bus_dep_act_inf_dd b --存款账户
ON      a.cst_id = b.cst_id
AND     b.dt = '20240830'
LEFT JOIN    edw.dwd_code_library_dd b1
ON      b.act_sts_cd = b1.cd_val
AND     b1.tbl_nm = upper('dws_bus_dep_act_inf_dd')
AND     b1.fld_nm = upper('act_sts_cd')
AND     b1.dt = '20240830'
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd c --客户基础标识信息
ON      a.cst_id = c.cst_id
AND     c.dt = '20240930'
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd d --合同
ON      a.cst_id = d.cst_id
AND     d.dt = '20240930'
LEFT JOIN    edw.dws_cst_bas_inf_dd e --客户信息汇总
ON      a.cst_id = e.cst_id
AND     e.dt = '20240930'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd d1
ON      e.sub_cmnt_id = d1.cmnt_enc
AND     d1.dt = '20240930'
WHERE   a.dt = '20240930'
AND     a.prm_org_id LIKE '4461%'   --英德村行
;
**01-数据需求_村行_D1031_李初昀_征信报告查看记录.sql
-- SJ2024103151
-- 调取行内员工查看客户蓝志贤（客户号7693511494）征信报告的浏览记录，时间范围2024年6月至今。
--因存量数据未能结转，目前后台只能调取新信贷上线后的数据，故需提数据需求申请2024年6月至今该客户行内员工征信报告的浏览记录。
--查看人工号、查看人姓名、客户名称、客户号、查看人机构、渠道、查看时间、ip（参照附件）
SELECT  user_id   AS 用户号
        ,org_id   AS 机构号
        ,channel  AS 渠道
        ,viewtime AS 查看时间
        ,reportversion --征信报告版本(0-机构版,1-简版)
        ,reporttype --报告类型(0-个人,1-企业)
        ,reportid 报告编号
        ,d.client_ip IP
FROM    edw.ncip_zx_buriedpoint_collect C
INNER  JOIN    (
                 SELECT  REPORT_ID
                         ,client_ip
                 FROM    edw.ncip_cpq_resultinfo C --个人信用报告查询记录
                 WHERE   C.dt >= '20240601'
                 AND     C.customer_id = '7693511494'  --蓝志贤
                 UNION ALL
                 SELECT  REPORT_ID
                         ,client_ip
                 FROM    edw.ncip_ceq_resultinfo d --企业信用报告查询记录
                 WHERE   d.dt >= '20240601'
                 AND     d.customer_id = '7693511494'  --蓝志贤
             ) d
ON      c.reportid = d.REPORT_ID
WHERE   C.dt >= '20240601'
;

-- and reportid IN (
--                         SELECT  REPORT_ID
--                         FROM    edw.ncip_cpq_resultinfo C --个人信用报告查询记录
--                         WHERE  C.dt>='20240601'
--                         AND  C.customer_id = '7693511494'  --蓝志贤
--                         union all
--                         SELECT  REPORT_ID
--                         FROM    edw.ncip_ceq_resultinfo d --企业信用报告查询记录
--                         WHERE  d.dt>='20240601'
--                         AND  d.customer_id = '7693511494'  --蓝志贤
--                     );
**01-数据需求_村行_D1104_吴美健_10月_20241001_20241031_庆元村行催收走访记录.sql
-- SJ20241104106

-- 2024年10月（20241001-20241031）庆元村行催收走访记录，以走访时间为统计

--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期

-- SELECT * FROM tmp_sjxq_SJ20241104106;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ20241104106 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ20241104106 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '20241031'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2024-10-01 00:00:00' and '2024-10-31 00:00:00'
;
**01-数据需求_村行_D1104_吴美健_精准贷后和预评估情况检查.sql
-- SJ20241104111 庆元村行
-- 2023年11月-2024年10月精准贷后和预评估情况


-- 根据这个清单，预评估取抗辩上诉调查结论，精准贷后取触犯原因、触犯原因分析
-- 这个预评估导入的清单，qbi_file_20241125_10_55_11_0；精准贷后，qbi_file_20241125_10_58_08_0

--预评估--新信贷，走特殊通道


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_YPG_20241125_1600_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_YPG_20241125_1600_01 AS
SELECT distinct  T1.COL_1   AS 机构编号
        ,T1.COL_2  AS 申请日期
        ,T1.COL_3  AS 经办分行
        ,T1.COL_4  AS 经办支行
        ,T1.COL_5  AS 经办团队
        ,T1.COL_6  AS 经办人
        ,T1.COL_7  AS 经办人姓名
        ,T1.COL_8  AS 客户号
        ,T1.COL_9  AS 风险_隐
        ,T1.COL_10 AS 风险_隐患
        -- ,T1.COL_11 AS 申请日
        -- ,T1.COL_12 AS 申请日期
        ,T1.COL_11 AS 客户名称
        ,T1.COL_12 AS 上诉_抗辩通过出险_逾期
        ,T1.COL_13 AS 预评估申请流水号
        ,T1.COL_14 AS 客户角色
        ,int(T1.COL_15) AS 预评估策略结果
        ,T1.COL_16 AS 预评估人工结果
        ,T1.COL_17 AS 是否发起抗辩
        ,T1.COL_18 AS 是否发起上诉
        --,COL_21	AS 抗辩上诉调查结论
        ,T1.COL_20 AS 拦截类提示语
        ,T1.COL_21 AS 提示类提示语
        ,T1.COL_22 AS 征信报告号
        ,T1.COL_23 AS 新老客
        ,T1.COL_24 AS 是否重组业务
        ,T1.COL_25 AS 合同编号
        ,T1.COL_26 AS 是否预保预报业务
        ,T1.COL_27 AS 首笔支用日期
        ,T1.COL_28 AS 产品类型
        ,T1.COL_29 AS 是否风险贷款
        ,T1.COL_30 AS 最近出险日期
        ,T1.COL_31 AS 最新征信分日期
        ,T1.COL_32 AS 进件时征信分
        ,T1.COL_33 AS 最新征信分
        ,T1.COL_34 AS 合同余额_含核销_不含利息
        ,T1.COL_35 AS 当前逾期天数
        ,T1.COL_36 AS 好坏标签
        ,COALESCE(T2.抗辩上诉调查结果,T3.opinion) AS  抗辩上诉调查结果
FROM    qbi_file_20241125_10_55_11_0 T1
LEFT JOIN    (
                 SELECT  DISTINCT bl.pre_ases_serno
                                  ,sp.svy_rslt AS 抗辩上诉调查结果
                 FROM    edw.dwd_bus_loan_pre_spcl_chnl_aply_dd bl --特殊通道申请
                 LEFT JOIN    edw.dim_bus_loan_pre_spcl_chnl_exvrf_opnn_dd sp --特殊通道审核意见，取抗辩理由
                 ON      coalesce(bl.spcl_chnl_no) = sp.spcl_chnl_no
                 AND     sp.dt = '20241031'
                 WHERE   bl.dt = '20241031'
             ) T2
ON      T1.COL_13 = T2.pre_ases_serno
LEFT JOIN   (
                     SELECT  applyserialno
                         ,WM_CONCAT(DISTINCT '||', opinion) AS opinion   --抗辩理由
                 FROM    edw.loan_defend_opinion --预评估抗辩意见
                 WHERE   opiniontype = '1' --抗辩理由
                 AND     COALESCE(opinion, '') <> ''
                 AND     DT = '20240719'
                 GROUP BY applyserialno
) T3
ON      T1.COL_13 = T3.applyserialno
WHERE   T1.PT <> '';





--精准贷后
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_JZDH_20241125_1600_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_JZDH_20241125_1600_01 AS
SELECT  T1.COL_1 任务流水号
        ,T1.COL_2 客户名称
        ,T1.COL_3 审批状态
        ,T1.COL_4 任务状态
        ,T1.COL_5 任务来源
        ,T1.COL_6 任务类型
        --,COL_7	触犯原因
        --,COL_8	触犯原因分析
        ,T1.COL_9 精准贷后完成有效期
        ,T1.COL_10 是否有超期精准贷后
        ,T1.COL_11 超期天数
        ,T1.COL_12 客户经理提交日期
        ,T1.COL_13 检查完成日期
        ,T1.COL_14 批次流水号
        ,T1.COL_15 客户号
        ,T1.COL_16 证件类型
        ,T1.COL_17 证件号码
        ,T1.COL_18 自动处理标识
        ,T1.COL_19 任务生成日期
        ,T1.COL_20 客户风险程度
        ,T1.COL_21 风险分层
        ,T1.COL_22 调查方式
        ,T1.COL_23 管理方案级别
        ,T1.COL_24 客户_业务贷后管理方案
        ,T1.COL_25 检查人工号
        ,T1.COL_26 检查人姓名
        ,T1.COL_27 检查人机构号
        ,T1.COL_28 检查人机构名称
        ,T2.offend_rsn     AS 触犯原因
        ,T2.offend_rsn_ana AS 触犯原因分析
FROM    qbi_file_20241125_10_58_08_0 T1
LEFT JOIN    adm_rsk.adm_rsk_apl_prc_pst_loan_mnt_dd T2 --精准贷后-任务宽表
ON      T1.COL_1 = T2.serialno
AND     T2.DT = '@@{yyyyMMdd}'
WHERE   T1.PT <> '';




--1、预评估
-- 字段：预评估流水号	申请人编号	客户名称、客户角色集合、适用团队类型、申请渠道、申请状态，申请人类型、
--主借款人客户号	主借款人客户名称	申请机构	预评估结果	提示信息	抗辩和上诉理由	出险日期	系统登记人	系统登记机构	系统登记时间	最后更新人	最后更新时间

--26910条数据

-- DROP TABLE IF EXISTS tmp_wmj_SJ20241104111_ypg PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_wmj_SJ20241104111_ypg AS
-- SELECT  T1.pre_ases_serno   AS 预评估流水号
--         ,T1.cst_id          AS 申请人编号
--         ,T1.cst_nm          AS 客户名称
--         ,CASE
--            WHEN T1.cst_rol_colc = '01' THEN '主借款人'
--            WHEN T1.cst_rol_colc = '02' THEN '共同借款人'
--            WHEN T1.cst_rol_colc = '03' THEN '担保人'
--            WHEN T1.cst_rol_colc = '04' THEN '关联人'
--            WHEN T1.cst_rol_colc = '05' THEN '共同还款人'
--            WHEN T1.cst_rol_colc = '06' THEN '合作企业或关键人'
--            WHEN T1.cst_rol_colc = '07' THEN '无授权客户'
--          END                AS 客户角色集合
--         -- ,T1.app_team_typ_cd AS 适用团队类型
--         ,lb1.cd_val_dscr    AS 适用团队类型
--         -- ,T1.aply_chnl_cd    AS 申请渠道代码
--         ,lb2.cd_val_dscr    AS 申请渠道代码
--         -- ,T1.aply_sts_cd     AS 申请状态
--         ,lb3.cd_val_dscr    AS 申请状态
--         ,CASE
--            WHEN T1.aplc_typ_cd = '01' THEN '个人客户'
--            WHEN T1.aplc_typ_cd = '02' THEN '企业客户'
--            WHEN T1.aplc_typ_cd = '03' THEN '金融机构客户'
--          END                AS 申请人类型
--         ,T1.mbrwr_cst_id    AS 主借款人客户号
--         ,T1.aply_org_id     AS 申请机构号
--         ,org.org_nm         AS 申请机构
--         ,T.reslut           AS 最近一次预评估结果
--         ,T.sys_reg_tm	           AS 最近一次预评估时间
--         ,T.预评估触发规则          AS 触发规则
--         ,T.预评估提示信息          AS 提示信息
--         ,T.抗辩理由             AS 抗辩理由
--         ,T1.sys_reg_psn_id  AS 系统登记人
--         ,T1.sys_reg_org_id  AS 系统登记机构
--         ,T1.sys_reg_tm      AS 系统登记时间
--         ,T1.last_upd_psn_id AS 最后更新人
--         ,T1.last_upd_tm     AS 最后更新时间
-- FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估业务申请
-- INNER JOIN    (
--                   SELECT  T1 . *
--                           ,T2.cd_val_dscr                                                                     AS reslut
--                           ,T3.预评估触发规则
--                           ,T3.预评估提示信息
--                           ,T4.抗辩理由
--                           ,ROW_NUMBER() OVER ( PARTITION BY T1.pre_ases_serno ORDER BY T0.serno	 DESC ) AS RN
--                   FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估结果信息  --此表就提供 预评估结果流水号pre_ases_rslt_serno
--                   LEFT JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
--                   ON      T1.pre_ases_serno= T0.pre_ases_serno	 --预评估结果流水号=规则集流水号
--                   AND     T0.DT = '20241031'
--                   LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
--                   ON      T0.rul_set_rslt_cd = T2.cd_val
--                   AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD' --授信关联预评估信息表
--                   AND     T2.fld_nm = 'RUL_SET_RSLT_CD' --规则集结果代码|
--                   AND     T2.DT = '20241031'
--                   LEFT JOIN    (
--                                    SELECT  B1.rul_set_rslt_serno
--                                            ,WM_CONCAT('||', B1.rul_nm)    AS 预评估触发规则
--                                            ,WM_CONCAT('||', B1.prmpt_msg) AS 预评估提示信息
--                                    FROM    edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
--                                    WHERE   B1.DT = '20241031'
--                                    GROUP BY B1.rul_set_rslt_serno
--                                ) T3
--                   ON      T0.rul_set_rslt_serno = T3.rul_set_rslt_serno
--                   LEFT JOIN    (
--                                    SELECT  DISTINCT bl . *
--                                                     ,sp.svy_rslt AS 抗辩理由
--                                    FROM    edw.DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD bl --授信关联预评估信息表
--                                    LEFT JOIN    edw.dim_bus_loan_pre_spcl_chnl_exvrf_opnn_dd sp --特殊通道审核意见，取抗辩理由
--                                    ON      coalesce(bl.spcl_chnl_no) = sp.spcl_chnl_no
--                                    AND     sp.dt = '20241031'
--                                    WHERE   bl.dt = '20241031'
--                                ) T4
--                   ON      T1.pre_ases_serno = T4.pre_ases_serno
--                   WHERE   T1.DT = '20241031'
--               ) T
-- ON      T1.pre_ases_serno = T.pre_ases_serno
-- AND     T.rn = 1
-- LEFT JOIN    edw.dwd_code_library_dd lb1
-- ON      T1.app_team_typ_cd = lb1.cd_val
-- AND     lb1.dt = '20241031'
-- AND     lb1.tbl_nm = upper('dwd_bus_loan_pre_ases_bsn_aply_dd')
-- AND     lb1.fld_nm = upper('APP_TEAM_TYP_CD') --适用团队
-- LEFT JOIN    edw.dwd_code_library_dd lb2
-- ON      T1.aply_chnl_cd = lb2.cd_val
-- AND     lb2.dt = '20241031'
-- AND     lb2.tbl_nm = upper('dwd_bus_loan_pre_ases_bsn_aply_dd')
-- AND     lb2.fld_nm = upper('aply_chnl_cd') --申请渠道
-- LEFT JOIN    edw.dwd_code_library_dd lb3
-- ON      T1.aply_sts_cd = lb3.cd_val
-- AND     lb3.dt = '20241031'
-- AND     lb3.tbl_nm = upper('dwd_bus_loan_pre_ases_bsn_aply_dd')
-- AND     lb3.fld_nm = upper('aply_sts_cd') --申请状态
-- LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
-- ON      T1.aply_org_id = org.org_id
-- AND     org.dt = '20241031'
-- WHERE   T1.dt = '20241031'
-- AND     T1.aply_org_id LIKE '3361%' --庆元
-- AND     substr(REPLACE(T1.sys_reg_tm,'-',''), 1, 8) BETWEEN '20231101' AND '20241031'
-- ;


-- --2、精准贷后

-- -- 2023年11月-2024年10月精准贷后
-- --字段：
-- -- 检查人机构号	任务流水号	客户号	客户名称	审批状态	任务状态	任务来源	任务类型	精准贷后完成有效期	是否有超期精准贷后	超期天数	客户经理提交日期
-- -- 任务实际完成日期	检查完成日期	任务生成日期	客户风险程度	风险分层	调查方式	管理方案级别	客户/业务贷后管理方案	检查人工号	检查人姓名	检查人机构号
-- -- 触犯规则来源	触犯原因	触犯原因分析	资金使用是否存在异常	客户资产负债是否变化	经营/工作情况是否变化	担保人/物情况是否异常	客户是否存在其他异常信息
-- -- 财务状况分析	经营情况	资金流向	资产负债情况	其它信息	全部担保人担保能力总体评价	申请人与关联人经营情况总体评价	授信必要性和合理性	批复意见执行情况

-- --366362条数据

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_JZDH_20241107_01 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_JZDH_20241107_01 AS
-- SELECT distinct  T1.chk_psn_bel_org_no            AS 检查人机构号
--         ,T1.btch_serno                   AS 任务流水号
--         ,T1.cst_id                       AS 客户号
--         ,T1.cst_nm                       AS 客户名称
--         ,T1.aprv_sts_cd                  AS 审批状态代码
--         ,T4.cd_val_dscr                  AS 审批状态
--         ,T1.pst_loan_chk_btch_tsk_sts_cd AS 任务状态代码
--         ,T5.cd_val_dscr                  AS 任务状态
--         ,T2.pst_loan_chk_tsk_src_cd      AS 任务来源代码
--         ,CASE
--            WHEN T2.pst_loan_chk_tsk_src_cd = '02' THEN '常规贷后'
--            WHEN T2.pst_loan_chk_tsk_src_cd = '03' THEN '自主贷后'
--            WHEN T2.pst_loan_chk_tsk_src_cd = '04' THEN '精准贷后-信用卡'
--            WHEN T2.pst_loan_chk_tsk_src_cd = '01' THEN '精准贷后'
--          END                             AS 任务来源
--         ,T6.cd_val_dscr                  AS 任务类型
--         ,B1.due_dt                       AS 贷后检查有效期
--         ,''                              AS 是否有超期精准贷后
--         ,''                              AS 超期天数
--         ,T1.sys_reg_tm                   AS 客户经理提交日期
--         ,B1.realend_dt                   AS 任务实际完成日期
--         ,B1.end_dt                       AS 检查完成日期
--         ,B1.start_dt                     AS 任务生成日期
--         ,T1.cst_rsk_dgr_cd               AS 客户风险程度代码
--         ,CASE
--            WHEN T1.cst_rsk_dgr_cd = '01' THEN '正常'
--            WHEN T1.cst_rsk_dgr_cd = '02' THEN '风险可控'
--            WHEN T1.cst_rsk_dgr_cd = '03' THEN '存在风险隐患'
--            WHEN T1.cst_rsk_dgr_cd = '04' THEN '风险暴露'
--          END                             AS 客户风险程度
--         ,CASE
--            WHEN T1.ori_rsk_lyr_cd = '1' THEN '低风险'
--            WHEN T1.ori_rsk_lyr_cd = '5' THEN '高风险'
--            WHEN T1.ori_rsk_lyr_cd = '2' THEN '中低风险'
--            WHEN T1.ori_rsk_lyr_cd = '3' THEN '中风险'
--            WHEN T1.ori_rsk_lyr_cd = '4' THEN '中高风险'
--          END                             AS 原风险分层代码
--         ,CASE
--            WHEN T1.svy_rsk_lyr_cd = '1' THEN '低风险'
--            WHEN T1.svy_rsk_lyr_cd = '5' THEN '高风险'
--            WHEN T1.svy_rsk_lyr_cd = '2' THEN '中低风险'
--            WHEN T1.svy_rsk_lyr_cd = '3' THEN '中风险'
--            WHEN T1.svy_rsk_lyr_cd = '4' THEN '中高风险'
--          END                             AS 调查后风险分层代码
--         ,CASE
--            WHEN B2.svy_mod_cd = '04' THEN '侧面打听（现场）'
--            WHEN B2.svy_mod_cd = '01' THEN '现场（实地）'
--            WHEN B2.svy_mod_cd = '02' THEN '云调查'
--            WHEN B2.svy_mod_cd = '03' THEN '非现场'
--            WHEN B2.svy_mod_cd = '05' THEN '侧面打听（非现场）'
--            WHEN B2.svy_mod_cd = '06' THEN '侧面打听（批量）'
--          END                             AS 调查方式
--         ,B3.mng_pln_lvl_cd               AS 管理方案级别代码
--         ,CASE
--            WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '01' THEN '维持'
--            WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '02' THEN '标记观察'
--            WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '03' THEN '重组'
--            WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '04' THEN '退出'
--          END                             AS 客户级贷后管理方案代码
--         ,B4.业务贷后管理方案                     AS 业务贷后管理方案
--         ,T1.chk_psn_id                   AS 检查人工号
--         ,B5.empe_nm                      AS 检查人姓名
--         ,''                              AS 触犯规则来源
--         ,B1.trg_typ                      AS 触犯规则类型
--         ,B1.offend_rsn                   AS 触犯原因
--         ,B1.offend_rsn_ana               AS 触犯原因分析
--         ,B1.is_fnd_norm                  AS 资金使用是否存在异常
--         ,B1.is_assets_chg                AS 客户资产负债是否变化
--         ,B1.is_bus_chg                   AS 客户_业务贷后管理方案
--         ,B1.is_guaranty_norm             AS 担保人_物情况是否异常
--         ,B1.is_oth_norm                  AS 客户是否存在其他异常信息
--         ,B1.fin_stt                      AS 财务状况分析
--         ,B1.opr_situ                     AS 经营情况
--         ,B1.fnd_flw_dir                  AS 资金流向
--         ,B1.ast_lbl_situ                 AS 资产负债情况
--         ,''                              AS 其它信息
--         ,B1.guaranty_appraise            AS 全部担保人担保能力总体评价
--         ,B1.opr_appraise                 AS 申请人与关联人经营情况总体评价
--         ,B1.is_rational                  AS 授信必要性和合理性
--         ,B1.aprv_opnn                    AS 批复意见执行情况
-- FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
-- INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
-- ON      T1.btch_serno = T2.btch_serno
-- AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
-- --AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03' , '04' ) --01	处置1级, 02	处置2级, 03	预警类, 04	提示类
-- AND     T2.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    adm_rsk.adm_rsk_apl_prc_pst_loan_mnt_dd B1 --精准贷后-任务宽表
-- ON      T1.btch_serno = B1.serialno
-- AND     B1.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_bus_loan_psp_chk_rel_svy_dd B2 --贷后检查批次与调查记录关联关系
-- ON      T1.btch_serno = B2.btch_serno
-- AND     B2.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.loan_psp_chk_cnlu_info B3 --信贷调查结论信息
-- ON      T1.btch_serno = B3.btch_serno
-- AND     B3.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    (
--                  SELECT  A1.btch_serno
--                          ,WM_CONCAT('||', CONCAT(A1.ctr_serno, '-', A2.cd_val_dscr)) AS 业务贷后管理方案
--                  FROM    edw.dwd_bus_loan_bsn_mng_pln_dd A1 --业务贷后管理方案
--                  LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表
--                  ON      A1.PST_LOAN_MNG_PLN_CD = A2.cd_val
--                  AND     A2.tbl_nm = 'DWD_BUS_LOAN_BSN_MNG_PLN_DD'
--                  AND     A2.fld_nm = 'PST_LOAN_MNG_PLN_CD'
--                  AND     A2.DT = '@@{yyyyMMdd}'
--                  WHERE   A1.DT = '@@{yyyyMMdd}'
--                  GROUP BY A1.btch_serno
--              ) B4
-- ON      T1.btch_serno = B4.btch_serno
-- LEFT JOIN    edw.dws_hr_empe_inf_dd B5 --员工汇总信息
-- ON      T1.chk_psn_id = B5.empe_id
-- AND     B5.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    (
--                  SELECT  A1.btch_serno
--                          ,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)                                AS 触发规则
--                          ,A1.rul_ctg_nm --规则分类名称
--                          ,A1.rul_sub_clss_nm --规则细类名称
--                          ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
--                  FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
--                  WHERE   A1.DT = '@@{yyyyMMdd}'
--              ) T3
-- ON      T1.btch_serno = T3.btch_serno
-- AND     T3.RN = 1
-- LEFT JOIN    edw.dwd_code_library_dd T4 -- 码值表
-- ON      T1.aprv_sts_cd = T4.cd_val
-- AND     T4.tbl_nm = 'DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD'
-- AND     T4.fld_nm = 'APRV_STS_CD'
-- AND     T4.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表
-- ON      T1.pst_loan_chk_btch_tsk_sts_cd = T5.cd_val
-- AND     T5.tbl_nm = 'DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD'
-- AND     T5.fld_nm = 'PST_LOAN_CHK_BTCH_TSK_STS_CD'
-- AND     T5.DT = '@@{yyyyMMdd}'
-- LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表
-- ON      T2.pst_loan_chk_tsk_typ_cd = T6.cd_val
-- AND     T6.tbl_nm = 'DWD_BUS_LOAN_PSP_CHK_TSK_INF_DD'
-- AND     T6.fld_nm = 'PST_LOAN_CHK_TSK_TYP_CD'
-- AND     T6.DT = '@@{yyyyMMdd}'
-- WHERE   T1.DT = '@@{yyyyMMdd}'
-- AND     substr(REPLACE(T1.sys_reg_tm,'-',''), 1, 8) BETWEEN '20231101' AND '20241031'
-- ;































-- SELECT * FROM edw.dwd_code_library_dd WHERE dt= '20241031' and tbl_nm=upper('dwd_bus_loan_pre_ases_bsn_aply_dd') and fld_nm=upper('aply_sts_cd');

SELECT * FROM edw.dim_bus_loan_pre_ases_rslt_inf_dd WHERE dt='20241030'

--申请人类型
-- aplc_typ_cd
-- 01	个人客户
-- 03	金融机构客户
-- 02	企业客户
--客户角色集合
--app_cst_rol_cd 客户角色
-- 01	主借款人
-- 04	关联人
-- 05	共同还款人
-- 06	合作企业或关键人
-- 07	无授权客户
-- 02	共同借款人
-- 03	担保人
--适用团队类型
--APP_TEAM_TYP_CD
-- 04	直销银行
-- 07	国际业务
-- 09	财富管理
-- 10	资金运营
-- 13	总行营业部
-- 01	普惠
-- 02	小企业
-- 03	消费金融
-- 05	大客户理财
-- 06	银行卡
-- 08	科技企业
-- 11	资产保全
-- 12	E融事业
-- 14	其他
-- 15	储蓄专营
--预评估业务申请
-- APLY_STS_CD 申请状态
-- 01	执行中
-- 02	部分完成
-- 03	全部完成
-- 06	授权中
-- 07	执行失败
-- 08	授权已退回
-- 04	无数据（含征信）授权
-- 05	待提交
--预评估结果
-- RUL_SET_RSLT_CD
-- 10	未授权
-- 1010	通过
-- 2020	抗辩未通过
-- 2030	上诉不通过
-- 2040	不符合查询条件
-- 2050	强数据源调用失败
-- 3040	转反欺诈
-- 4020	抗辩详情补充
-- 1020	抗辩通过
-- 1030	上诉通过
-- 1040	异常
-- 11	授权成功
-- 12	授权失败
-- 2010	未通过
-- 3010	待审查岗确认
-- 3020	转客户经理
-- 3030	转中台
-- 4010	申请详情补充
-- 4030	上诉详情补充
-- 8	征信审核中
-- 9	征信重签
**01-数据需求_村行_D1104_耿鹏程_汝南村行授用信_贷后检查_单笔单批审批流程.sql
-- SJ2024110426
-- 2024年8月1日--10月31日，汝南村行授用信、贷后检查、单笔单批审批流程及时间。


-- 业务流水号 流程名称 客户编号 客户名称 当前节点 当前节点处理人 当前节点接收时间 提交至下一节点时间

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_runan_liucheng_SJ2024110196_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_runan_liucheng_SJ2024110196_01 AS
SELECT  T1.biz_id                        AS 业务流水号
        ,T1.flow_name                    AS 流程名称
        ,COALESCE(T3.cst_id, T4.cst_id) AS 客户编号
        ,COALESCE(T3.cst_nm, T4.cst_nm) AS 客户名称
        ,T2.node_name                   AS 当前节点
        ,T2.user_id                     AS 当前节点处理人工号
        ,T2.user_name                   AS 当前节点处理人名称
        ,T2.start_time                  AS 当前节点接收时间
        ,T2.end_time                    AS 提交至下一节点时间
FROM    edw.dwd_bus_loan_n_wf_instance_his_dd T1 --流程运行实例历史表
LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd T2 --流程办结表，流程在途的时候， 位于：loan_n_wf_instance， 当流程结束后， 位于：loan_n_wf_instance_his
ON      T1.main_instance_id = T2.instance_id
AND     T2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd T3 --授用信申请信息  取客户号
ON      T1.biz_id = T3.ahn_ltr_aply_serno
AND     T1.flow_starter = T3.sys_reg_psn_id ---- 授信申请登记者 = 流程发起者   不然会有多条记录
AND     T3.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_bus_loan_psp_chk_btch_inf_dd T4 --贷后检查批次信息表
ON      T1.biz_id = T4.btch_serno
AND     T1.flow_starter = T4.chk_psn_id ---- 授信申请登记者 =检查人工号   不然会有多条记录
AND     T4.dt = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     SUBSTR(T1.org_id,1,4) = '4162'	  --汝南
AND     SUBSTR(REPLACE(T1.start_time, '/', ''), 1, 8) >= '20240801'
AND     SUBSTR(REPLACE(T1.start_time, '/', ''), 1, 8) <= '20241031'
and T1.flow_id in ('195','165')    --授用信申请，贷后检查流程
ORDER BY T2.start_time



-- SELECT DISTINCT a.flow_id,a.flow_name FROM  edw.dwd_bus_loan_n_wf_instance_his_dd a WHERE dt='20241031'
**01-数据需求_村行_D1106_徐舒月_长乐村行_信贷系统客户送达地址.sql
-- 字段：客户号     客户名称     涉及有余额合同号（多个合同用;隔开）     客户角色（借款人/担保人）     送达地址是否为详细地址
-- 长乐村行
-- SJ2024110646


--长乐村行有余额的合同
drop table if exists lab_bigdata_dev.tmp_cl_SJ2024110646_01 purge ;
create table lab_bigdata_dev.tmp_cl_SJ2024110646_01  AS
SELECT
    T1.cst_id	          AS 客户号
	,T1.cst_nm	          AS 客户名称
	,T2.WRNT_CST_ID       AS 保证人客户编号
	,T2.WRNT_CST_NM       AS 保证人客户名称
	,WM_CONCAT(',',T1.ctr_serno) AS   涉及有余额合同号
FROM edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN edw.dws_bus_grnt_prsn_inf_dd T2 --担保人汇总信息
ON   T1.ctr_serno = T2.BUS_CTR_ID
AND  T2.DT = '@@{yyyyMMdd}'
WHERE T1.DT = '@@{yyyyMMdd}'
AND     (
         (    T1.CTR_STS_CD IN ( '2' , '4' ) AND T1.TMT_DT = '18991231' AND to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(t1.dt, 'yyyyMMdd') )
           OR t1.CTR_BAL > 0
		 )
AND    T1.sgn_ctr_prtfl_mod_cd = '3'		  --    电子合同（自助）
AND    SUBSTR(T1.mgr_org_id	,1,4)='3562'	  --	长乐村行
GROUP BY T1.cst_id,T1.cst_nm,T2.WRNT_CST_ID ,T2.WRNT_CST_NM
;



drop table if exists lab_bigdata_dev.tmp_cl_SJ2024110646_02 purge ;
create table lab_bigdata_dev.tmp_cl_SJ2024110646_02  AS
SELECT
     T1.客户号
     T1.客户名称
	 ,T2.dtl_addr AS 客户送达地址
     ,CASE WHEN T2.main_addr_ind = '1' THEN '是' ELSE '否' END AS 客户送达地址是否主地址
	 ,T21.dtl_addr  AS 客户主地址
     ,T1.保证人客户编号
     ,T1.保证人客户名称
	 ,T3.dtl_addr AS 保证人送达地址
     ,CASE WHEN T3.main_addr_ind = '1' THEN '是' ELSE '否' END AS 保证人送达地址是否主地址
	 ,T31.dtl_addr  AS 保证人主地址
	 ,T1.涉及有余额合同号
FROM lab_bigdata_dev.tmp_cl_SJ2024110646_01 T1
LEFT JOIN edw.loan_cst_ctc_addr T2 --联系地址信息
ON T1.客户号 = T2.cst_id
AND T2.lgl_imt_arrv_addr_ind	 = '1' --法律文书送达地址标志
AND T2.del_ind	<> '1'   --删除标识
AND T2.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_ctc_addr T21 --联系地址信息
ON T1.客户号 = T21.cst_id
AND T21.main_addr_ind	 = '1' --主地址
AND T21.del_ind	<> '1'   --删除标识
AND T21.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_ctc_addr T3 --联系地址信息
ON T1.保证人客户编号 = T3.cst_id
AND T3.lgl_imt_arrv_addr_ind	 = '1' --法律文书送达地址标志
AND T3.del_ind	<> '1'   --删除标识
AND T3.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.loan_cst_ctc_addr T31 --联系地址信息
ON T1.保证人客户编号 = T31.cst_id
AND T31.main_addr_ind	 = '1' --主地址
AND T31.del_ind	<> '1'   --删除标识
AND T31.DT = '@@{yyyyMMdd}'
;
**01-数据需求_村行_D1107_陶婉欣_河南叶县.sql
--SJ20241107126
--河南叶县村行
--根据逾期清单申请取发送催收短信数据
--客户号，客户名，合同号，业务流水号，身份证，开始逾期时间 逾期金额 手机号 所属机构 短信内容 短信发送时间

SELECT * FROM tmp_SJ20241107126_YQYW_01 WHERE  substr(发送时间,1,7) between '2024-08' and '2024-10'

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SJ20241107126_YQYW_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_SJ20241107126_YQYW_01 AS
SELECT  DISTINCT T1.cst_id      AS 客户号
                ,T1.cst_nm     AS 客户名
                ,T1.dbil_id    AS 借据号
                ,T1.ctr_serno  AS 合同号
                ,T1.id_no      AS 身份证号
                ,T1.ctr_bgn_dt AS 合同开始时间
                ,T1.ovd_dt     AS 开始逾期时间
                ,T1.ovrd_bal   AS 逾期金额
                ,T1.ovd_day    AS 逾期天数
                ,T1.mgr_org_id AS 所属机构
                ,T1.mgr_id     AS 所属客户经理
                ,T1.dt         AS 数据日期
                ,T2.CTC_TEL    AS 手机号
                ,T3.发送时间
                ,T3.短信发送内容
FROM    qbi_file_20241108_09_18_14_0 T1
LEFT JOIN   (
                         SELECT  cctr.CST_ID
                         ,cct.CTC_TEL
                 FROM    edw.loan_cst_ctc_tel cct --联系电话信息
                 LEFT JOIN    edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息
                 ON      cctr.REL_SERNO = cct.SERNO
                 AND     cct.DEL_IND = '0' --删除标识,0-否 1-是
                 AND     cctr.dt = '@@{yyyyMMdd}'
                 WHERE   cct.dt = '@@{yyyyMMdd}'
                 AND     cctr.SMS_RCV_TEL_NO_IND = '1' --短信接收号码标志,1-是 0-否
             --     AND     cctr.cr_crd_rsrv_tel_ind = '1' --信用卡预留电话标志 ,1-是 0-否
                 AND     cctr.REL_TYP = '0001' -- 关联类型，本人
)T2
on T1.cst_id=T2.CST_ID
LEFT JOIN    (
                 --SELECT  A1.phone AS phone
                 --        ,substr(REPLACE(A1.post_time, '-', ''), 1, 8) 发送时间
                 --        ,A1.sms_content 短信发送内容
                 --FROM    edw.dxpt_gsms_msg_ticket_sms A1    ---20190926-20221211：数仓
                 --WHERE   A1.DT >= '20230101'
                 --AND     A1.state = 1 --发送成功
                 --AND     ( A1.sms_content RLIKE '到期还款'
                 --    OR A1.sms_content RLIKE '征信报送'
                 --    OR A1.sms_content RLIKE '逾期' )
                 --UNION ALL
                --  SELECT  A1.mbl_nbr AS phone
                --          ,A1.sms_snd_tm   发送时间
                --          ,A1.sms_snd_cntnt 短信发送内容
                --  FROM    edw.ncrd_smscontent A1 --20230713-至今,银数短信,逾期短信通过银数发
                --  WHERE   A1.DT >= '20230101'
                --  AND     ( A1.sms_snd_cntnt RLIKE '征信报送'
                --      OR A1.sms_snd_cntnt RLIKE '逾期'
                --      OR A1.sms_snd_cntnt RLIKE '到期还款' )
                --  UNION ALL
                 SELECT  A1.phone AS phone
                         ,A1.post_time  发送时间
                         ,A1.sms_content 短信发送内容
                 FROM    edw.nsms_gsms_msg_ticket_sms A1 --20221109-至今4天前：数仓
                 WHERE   A1.DT >= '20221109' --20230101
                 and user_id in('811','691')  -- edzxbsxt 811 ,pldx 691
                 AND  numbers='0'   --0是整段短信
             ) T3
ON      T2.CTC_TEL = t3.phone
-- AND     T3.phone <> ''
-- AND     REPLACE(substr(T3.发送时间, 1, 10),'-','') >= T1.ovd_dt
WHERE   T1.PT <> '';










-- SELECT COUNT(1) FROM lab_bigdata_dev.tmp_SJ20241107126_YQYW_01;


-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SJ20241107126_YQYW_02 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_SJ20241107126_YQYW_02 AS
-- SELECT  DISTINCT T1.cst_id      AS 客户号
--                  ,T1.cst_nm     AS 客户名
--                  ,T1.dbil_id    AS 借据号
--                  ,T1.ctr_serno  AS 合同号
--                  ,T1.id_no      AS 身份证号
--                  ,T1.ctr_bgn_dt AS 合同开始时间
--                  ,T1.ovd_dt     AS 开始逾期时间
--                  ,T1.ovrd_bal   AS 逾期金额
--                  ,T1.ovd_day    AS 逾期天数
--                  ,T1.mgr_org_id AS 所属机构
--                  ,T1.mgr_id     AS 所属客户经理
--                  ,T1.dt         AS 数据日期
--                  ,T2.CTC_TEL    AS 信贷登记手机号
--                  ,T3.phone     AS   外呼手机号
--                  ,T3.coln_date AS 发送时间
--                  ,T3.coln_result  AS 短信发送内容
-- FROM    qbi_file_20241108_09_18_14_0 T1
-- LEFT JOIN    (
--                  SELECT  cctr.CST_ID
--                          ,cct.CTC_TEL
--                  FROM    edw.loan_cst_ctc_tel cct --联系电话信息
--                  LEFT JOIN    edw.loan_cst_ctc_tel_rel cctr ----联系电话关联信息
--                  ON      cctr.REL_SERNO = cct.SERNO
--                  AND     cct.DEL_IND = '0' --删除标识,0-否 1-是
--                  AND     cctr.dt = '@@{yyyyMMdd}'
--                  WHERE   cct.dt = '@@{yyyyMMdd}'
--                  AND     cctr.SMS_RCV_TEL_NO_IND = '1' --短信接收号码标志,1-是 0-否
--              --     AND     cctr.cr_crd_rsrv_tel_ind = '1' --信用卡预留电话标志 ,1-是 0-否
--                  AND     cctr.REL_TYP = '0001' -- 关联类型，本人
--              ) T2
-- ON      T1.cst_id = T2.cst_id
-- LEFT JOIN    edw.zcbq_risk_collect_record T3 --催收痕迹
-- ON      T1.ctr_serno = t3.cont_card_no
-- --AND     T2.CTC_TEL = T3.phone
-- AND     T3.dt = '@@{yyyyMMdd}'
-- AND     T3.coln_result RLIKE '征信报送温馨提示'
-- WHERE   T1.PT <> '';


-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_SJ20241107126_YQYW_03 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_SJ20241107126_YQYW_03 AS
-- SELECT *,ROW_NUMBER() OVER(ORDER BY 合同号,借据号,发送时间 ) AS RN  FROM lab_bigdata_dev.tmp_SJ20241107126_YQYW_02
-- WHERE 短信发送内容 IS NOT NULL;
**01-数据需求_村行_D1108_旬阳村行_鲁雨_普惠小微数据.sql
-- 客户号，客户姓名、客户类型、是否个体工商户主、是否小微企业主、信贷_是否个体工商户主、信贷_是否小微企业主、划型结果、划型状态、客户经理工号、管户客户经理名称，贷款余额
-- SJ2024110871
-- 旬阳村行


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xunyang_SJ2024110871_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xunyang_SJ2024110871_01 AS
SELECT  T1.CST_ID                                      AS 客户号
        ,T1.cst_nm                                     AS 客户姓名
        ,CASE
           WHEN T2.CST_ID IS NOT NULL  THEN '个人'
           WHEN T21.CST_ID IS NOT NULL THEN '企业'
         END                                           AS 客户类型
        ,CASE
           WHEN T2.IND_BUS_IND = '1' OR substr(T21.org_org_typ_cd, 1, 2) = '0500' THEN '是'   --个体工商户0500
           ELSE '否'
         END                                           AS 是否个体工商户主
        ,CASE
           WHEN T2.MIC_ENTP_OWN_IND = '1' THEN '是'
           ELSE '否'
         END                                           AS 是否小微企业主
        ,CASE
           WHEN T7.indiv_bsn_owr_ind = '1' OR T8.cst_typ = '07' OR T81.cst_typ = '0203' THEN '是'
           ELSE '否'
         END                                           AS 信贷_是否个体工商户主
        ,CASE
           WHEN T7.sme_owr_ind = '1' THEN '是'
           ELSE '否'
         END                                           AS 信贷_是否小微企业主
        ,COALESCE(T3.entp_div_rslt, T31.indiv_div_rslt) AS 企业划型结果代码
        ,T4.cd_val_dscr                                AS 企业划型结果
        ,COALESCE(T3.afm_sts, T3.afm_sts)              AS 认定状态代码
        ,T5.cd_val_dscr                                AS 认定状态
        ,T1.prm_mgr_id                                 AS 客户经理工号
        ,T1.prm_mgr_nm                                 AS 管户客户经理名称
        ,T6.贷款余额
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T2 --个人客户基本信息汇总表
ON      T1.CST_ID = T2.CST_ID
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_entp_bas_inf_dd T21 --企业客户基本信息
ON      T1.CST_ID = T21.CST_ID
AND     T21.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.entp_div_rslt -- 企业划型结果
                         ,A1.afm_sts -- 认定状态
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.sys_reg_tm DESC , A1.entp_data_year DESC ) AS RN
                 FROM    edw.loan_cst_corp_entp_siz A1
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.del_ind <> '1'   --删除标识
             ) T3
ON      T1.cst_id = T3.cst_id
AND     T3.RN = 1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.indiv_div_rslt -- 个人划型结果
                         ,A1.afm_sts -- 认定状态
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.last_upd_tm DESC , A1.sys_reg_tm DESC ) AS RN
                 FROM    edw.loan_cst_indiv_div A1
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.del_ind <> '1'   --删除标识
             ) T31
ON      T1.cst_id = T31.cst_id
AND     T31.RN = 1
LEFT JOIN    edw.dwd_code_library_dd T4 --码值表
ON      COALESCE(T3.entp_div_rslt, T31.indiv_div_rslt) = T4.cd_val   --企业划型结果包含个人划型结果
AND     T4.tbl_nm = 'DWD_CST_ENTP_CORP_ENTP_SIZ_DD'
AND     T4.fld_nm = 'ENTP_DIV_RSLT_CD'
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd T5 --码值表
ON      COALESCE(T3.afm_sts, T31.afm_sts) = T5.cd_val
AND     T5.tbl_nm = 'DWD_CST_ENTP_CORP_ENTP_SIZ_DD'
AND     T5.fld_nm = 'AFM_STS_CD'
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,SUM(ctr_bal) AS 贷款余额
                 FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
                 AND     A1.TMT_DT = '18991231'
                 AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.dt, 'yyyyMMdd') )
                     OR A1.CTR_BAL > 0 )
                 GROUP BY A1.cst_id
             ) T6
ON      T1.cst_id = T6.cst_id
LEFT JOIN    edw.loan_cst_indiv_ind T7 --个人客户标识信息
ON      T1.cst_id = T7.cst_id
AND     T7.del_ind <> '1' --删除标识
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_indiv_bsc T8 --个人客户基本信息
ON      T1.cst_id = T8.cst_id
AND     T8.del_ind <> '1' --删除标识
AND     T8.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.loan_cst_corp_bsc T81 --企业客户基本信息
ON      T1.cst_id = T81.cst_id
AND     T81.del_ind <> '1' --删除标识
AND     T81.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     SUBSTR(T1.prm_org_id, 1, 4) = '6161'   --陕西旬阳
;
**01-数据需求_村行_D1113_郭少聪_龙海村行_对今年新发生首笔业务进行电话回访_排查资金中介问题.sql
-- SJ20241113151
-- 2024年1月1日至2024年11月13日，发生类型为首笔的信贷业务
-- 管户机构名称，管户客户经理名称，客户号，客户名称，客户手机号码，产品类型
DROP TABLE IF EXISTS tmp_lh_sjxq_SJ20241113151 PURGE;

CREATE TABLE IF NOT EXISTS tmp_lh_sjxq_SJ20241113151 AS
SELECT  a.cst_id 客户号
        ,a.cst_nm 客户名称
        ,a.prm_mgr_id 管户客户经理ID
        ,a.prm_mgr_nm 管户客户经理名称
        ,a.prm_org_id 管户机构ID
        ,a.prm_org_nm 管户机构名称
        ,cb.prd_no 产品编号
        ,cb1.pd_nm 产品名称
        ,cb.hpn_typ_cd 发生类型
        ,b.mbl_nbr 客户手机号码
        -- ,cb.sys_reg_dt
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd a
INNER JOIN    edw.dim_bus_loan_ctr_bse_inf_dd cb
ON      a.cst_id = cb.cst_id
AND     cb.dt = '@@{yyyyMMdd}'
AND     cb.hpn_typ_cd = '010' --首笔
AND     cb.sys_reg_dt >= '20240101'
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd cb1
ON      cb.prd_no = cb1.prd_no
AND     cb1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd b
ON      a.cst_id = b.cst_id
AND     b.dt = '@@{yyyyMMdd}'
WHERE   a.dt = '@@{yyyyMMdd}'
AND     a.prm_org_id LIKE '3563%'  --龙海
;
**01-数据需求_村行_D1114_程聪聪_大冶_客户关联企业及征信查询信息.sql
--SJ2024111396

-- 提取2024年5月20日之后发放业务的客户关联企业及征信查询情况


--临时表一：作为法人的企业信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_02 AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
				,in_namecn	 --高管姓名
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息
                        WHERE   dt <= '@@{yyyyMMdd}' ---------------xt:添加查得标识=1
                        AND     gpr_ifrichard = '1' --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno in_ctfno
				,gpm_namecn in_namecn
                                ,gpr_entname dt_gpr_entname
                                ,gpr_enttype dt_gpr_enttype
                                ,gpr_entstatus dt_gpr_entstatus --旧表
                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno --被查询人证件号码
							,gpm_namecn	 --被查询人姓名
                                                        ,c.gpr_entname --企业(机构)名称
                                                        ,c.gpr_entstatus --企业状态
                                                        ,c.gpr_enttype --企业(机构)类型
                                                        ,c.gpr_creditcode --统一社会信用代码
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为法人的企业信息
                                                WHERE   a.dt <= '@@{yyyyMMdd}'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'
                                            ) aa
                                    WHERE   aa.rn = 1
                                ) cc
                    ) bb
        ) d
WHERE   d.rk = 1
AND     d.dt_gpr_entstatus RLIKE '在营';




---临时表二： 作为股东的企业信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_03;

CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_03 AS
SELECT  *
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk
            FROM    (
                        SELECT  dt
                                ,in_ctfno --高管证件号
				,in_namecn --高管姓名
                                ,dt_gpr_entname --企业(机构)名称
                                ,dt_gpr_enttype --企业(机构)类型
                                ,dt_gpr_entstatus --企业状态
                                ,dt_gpr_fundedratio --投资比例
                                ,dt_gpr_creditcode --统一社会信用代码
                        FROM    edw.nout_gs_prsn_ryposshatd --工商个人替代-人员股东信息
                        WHERE   dt <= '@@{yyyyMMdd}'
                        -- AND     REPLACE(dt_gpr_fundedratio, '%', '') >= 20 --占股20%以上
                        AND     gpr_ifrichard = '1' --查的标识=1
                        UNION ALL
                        SELECT  dt
                                ,gpm_ctfno as in_ctfno
				,gpm_namecn as in_namecn
                                ,gpr_entname as dt_gpr_entname
                                ,gpr_enttype as dt_gpr_enttype
                                ,gpr_entstatus as dt_gpr_entstatus
                                ,gpr_fundedratio as dt_gpr_fundedratio
                                ,gpr_creditcode as dt_gpr_creditcode
                        FROM    (
                                    SELECT  *
                                    FROM    (
                                                SELECT  c.dt
                                                        ,gpm_ctfno
							,gpm_namecn
                                                        ,c.gpr_entname
                                                        ,c.gpr_entstatus
                                                        ,c.gpr_enttype
                                                        ,c.gpr_fundedratio
                                                        ,c.gpr_creditcode
                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn
                                                FROM    edw.outd_gs_person_main a --工商个人主表
                                                INNER JOIN    edw.outd_gs_person_rypossha c --工商个人-人员股东信息
                                                ON      a.gpm_flowno = c.gpr_flowno
                                                AND     c.dt <= '@@{yyyyMMdd}' ---- 作为股东的企业信息
                                                WHERE   a.dt <= '@@{yyyyMMdd}'
                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '@@{yyyyMMdd}'
                                                -- AND     REPLACE(gpr_fundedratio, '%', '') >= 20  --占股20%以上
                                            ) aa
                                    WHERE   rn = 1
                                ) bb
                    ) aa
        ) B
WHERE   B.rk = 1
AND     B.dt_gpr_entstatus RLIKE '在营';


-------临时表三 工商信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_04;

CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_04 AS
SELECT  GEB_ENTNAME -------客户名称,
        ,GEB_CREDITCODE -----统一社会信用代码,
        ,GEB_ENTTYPE -----企业机构类型,
        ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,
        ,GEB_ENTSTATUS -----经营状态,
        ,GEB_RECCAP -----实收资本万元,
        ,GEB_REGCAPCUR -----注册资本币种,
        ,GEB_REGORGCITY -----所在城市,
        ,GEB_REGORGDISTRICT -----所在区县,
        ,GEB_ZSOPSCOPE -----经营业务范围,
        ,GEB_DOM -----住所,
        ,GEB_INDUSTRYCONAME -----国民经济代码名称,
        ,geb_esdate
        ,geb_othertel --其他电话
        ,geb_regorgprovince  --所在省份
        ,geb_regorgcode  --注册地址行政编号
        ,ROW_NO
FROM    (
            SELECT  *
                    ,row_number() OVER ( PARTITION BY GEB_CREDITCODE ORDER BY GEB_HOSTSENDTIME DESC ) AS ROW_NO
            FROM    (
                        SELECT  GEB_ENTNAME -------客户名称,
                                ,GEB_CREDITCODE -----统一社会信用代码,
                                ,GEB_ENTTYPE -----企业机构类型,
                                ,GEB_FRNAME -----法定代表人负责人执行事务合伙人,
                                ,GEB_ENTSTATUS -----经营状态,
                                ,GEB_RECCAP -----实收资本万元,
                                ,GEB_REGCAPCUR -----注册资本币种,
                                ,GEB_REGORGCITY -----所在城市,
                                ,GEB_REGORGDISTRICT -----所在区县,
                                ,GEB_ZSOPSCOPE -----经营业务范围,
                                ,GEB_DOM -----住所,
                                ,GEB_INDUSTRYCONAME -----国民经济代码名称,
                                ,geb_esdate ----成立日期
                                ,geb_othertel ----其他电话
                                ,GEB_HOSTSENDTIME ------geb_hostsendtime 交易发送主机时间
				,geb_regorgprovince  --所在省份
				,geb_regorgcode  --注册地址行政编号
                        FROM    edw.OUTD_GS_ENTINFO_BASIC --工商企业-企业基本信息
                        WHERE   dt <= '@@{yyyyMMdd}'
                        UNION ALL
                        SELECT  dt_entname             AS GEB_ENTNAME -----企业名称
                                ,dt_creditcode         AS GEB_CREDITCODE ---统一信用代码
                                ,dt_enttype            AS GEB_ENTTYPE -----企业类型
                                ,dt_frname             AS GEB_FRNAME -----法定代表人负责人执行事务合伙人
                                ,dt_entstatus          AS GEB_ENTSTATUS -----经营状态
                                ,dt_reccap             AS GEB_RECCAP -----实收资本万元
                                ,dt_regcapcur          AS GEB_REGCAPCUR -----注册资本币种
                                ,dt_regorgcity         AS GEB_REGORGCITY -----所在城市
                                ,dt_regorgdistrict     AS GEB_REGORGDISTRICT -----所在区县
                                ,dt_zsopscope          AS GEB_ZSOPSCOPE -----经营业务范围
                                ,dt_dom                AS GEB_DOM -----住所
                                ,dt_industryconame     AS GEB_INDUSTRYCONAME -----国民经济代码名称
                                ,dt_esdate             AS geb_esdate
                                ,dt_othertel           AS geb_othertel ----其他电话
                                ,insert_time_chinadaas AS GEB_HOSTSENDTIME
				,dt_regorgprovince     AS geb_regorgprovince  --所在省份
				,dt_regorgcode         AS geb_regorgcode  --注册地址行政编号
                        FROM    edw.nout_zs_ent_basic   --企业基本信息表
                        WHERE   dt <= '@@{yyyyMMdd}'
                    ) t1
        ) t2
WHERE   t2.ROW_NO = 1;


--结果表
-- 合同流水号	管户机构号	分行	客户名称	发放日期	到期日期	核心客户编号
--客户关联企业名称	关系类型	股东姓名	法人姓名	我行系统是否录入	预评估是否查询	查询结果

--12324

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_05 AS
SELECT  DISTINCT T1.col_1                       AS 合同流水号
                 ,T1.col_2                      AS 管户机构号
                 ,T1.col_3                      AS 分行
                 ,T1.col_4                      AS 客户名称
                 ,T1.col_5                      AS 发放日期
                 ,T1.col_6                      AS 到期日期
                 ,T1.col_7                      AS 核心客户编号
                 ,T3.dt_gpr_entname             AS 客户关联企业名称
                 ,T3.关系类型
                 ,T5.in_namecn                  AS 股东姓名
                 ,COALESCE(CASE
                             WHEN T3.关系类型 = '客户担任法人企业' THEN T2.cst_chn_nm
                             ELSE T4.in_namecn
                           END, T41.GEB_FRNAME) AS 法人姓名
                 ,CASE
                    WHEN T7.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END                           AS 我行系统是否录入
                 ,CASE
                    WHEN B2.cst_id IS NOT NULL THEN '是'
                    ELSE '否'
                  END                           AS 预评估是否查询
                 ,B2.cd_val_dscr                AS 查询结果
FROM    qbi_file_20241114_16_09_32_0 T1
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.col_7 = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.in_ctfno --高管证件号
                         ,A1.dt_gpr_entname --企业(机构)名称
                         ,A1.dt_gpr_enttype --企业(机构)类型
                         ,A1.dt_gpr_entstatus --企业状态
                         ,A1.dt_gpr_creditcode --统一社会信用代码
                         ,'' AS dt_gpr_fundedratio --投资比例
                         ,'客户担任法人企业' 关系类型
                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_02 A1 --法人
                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''
                 UNION ALL
                 SELECT  A1.in_ctfno
                         ,A1.dt_gpr_entname --企业(机构)名称
                         ,A1.dt_gpr_enttype --企业(机构)类型
                         ,A1.dt_gpr_entstatus --企业状态
                         ,A1.dt_gpr_creditcode --统一社会信用代码
                         ,A1.dt_gpr_fundedratio
                         ,'客户担任股东企业' 关系类型
                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_03 A1 --股东
                 LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_02 A2 --法人
                 ON      A1.in_namecn = A2.in_namecn
                 AND     A1.dt_gpr_entname = A2.dt_gpr_entname
                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''
                 AND     A2.in_namecn IS NULL    --剔除股东担任法人的企业
             ) T3 --客户关联企业
ON      T2.doc_nbr = T3.in_ctfno
LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_02 T4 --取关联企业法人
ON      T3.dt_gpr_entname = T4.dt_gpr_entname
AND     T3.关系类型 = '客户担任股东企业'
LEFT JOIN    lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_04 T41 --取关联企业法人 工商信息补充
ON      T3.dt_gpr_entname = T41.GEB_ENTNAME
AND     T3.关系类型 = '客户担任股东企业'
LEFT JOIN    (
                 SELECT  A1.dt_gpr_entname --统一社会信用代码
                         ,WM_CONCAT(DISTINCT '||', A1.in_namecn) AS in_namecn
                 FROM    lab_bigdata_dev.tmp_dsj_SJ2024111396_mingxia_qiye_03 A1 --股东
                 WHERE   COALESCE(A1.dt_gpr_entname, '') <> ''
                 AND     COALESCE(A1.in_namecn, '') <> ''
                 GROUP BY A1.dt_gpr_entname
             ) T5 --取关联企业股东
ON      T3.dt_gpr_entname = T5.dt_gpr_entname
LEFT JOIN    edw.dws_cst_bas_inf_dd T6 --客户基础信息汇总表   --取关联企业客户号
ON      T3.dt_gpr_creditcode = T6.doc_nbr
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_cst_rel_inf_dd T7 --客户关联关系信息  --我行登记关联企业与客户是否关联
ON      T1.col_7 = T7.cst_id
AND     T6.cst_id = T7.rel_cst_id
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,T2.cd_val_dscr
                         ,T1.sys_reg_tm
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T0.serno DESC ) AS RN
                 FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估业务申请
                 LEFT JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
                 ON      T1.PRE_ASES_SERNO = T0.pre_ases_serno
                 AND     T0.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
                 ON      T0.rul_set_rslt_cd = T2.cd_val
                 AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'   --授信关联预评估信息表
                 AND     T2.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     T2.DT = '@@{yyyyMMdd}'
                 WHERE   T1.DT = '@@{yyyyMMdd}'
             ) B2
ON      T1.col_7 = B2.cst_id
WHERE   T1.pt <> '';





--
**01-数据需求_村行_D1120_大冶_周霆_单个客户口径下的所有贷款产品.sql
-- SJ20241120126，截止11月20日，大冶村行单个客户口径下的所有贷款产品

-- 持有产品+授信金额+合同起始日（若有多笔授信的，分列显示）
-- 数据日期	管护机构	管护客户经理工号	管护客户经理名称	客户号	客户名称	授信总金额	用信余额	泰E贷授信金额	担保类型	授信到期日	融E贷
-- 担保类型	授信到期日	随贷通卡	担保类型	授信到期日	普贷1	担保类型	授信到期日	普贷2	担保类型	授信到期日	风险等级	模型分	相对位置
-- 征信评分	征信报告日期	上年征信评分	同一风险控制号	子社区编号	子社区名称



--1.客户合同信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_daye_SJ20241120126_01 AS
SELECT  T1.DT                                                                            AS 数据日期
        ,T1.cst_id
        ,T1.ctr_serno                                                                    AS 合同流水号
        ,T1.prd_no                                                                       AS 产品编号
        ,T2.pd_nm                                                                        AS 产品名称
        ,T1.ctr_amt                                                                      AS 授信金额
		,T1.ctr_bal	                                                                     AS 授信余额
        ,T1.ctr_bgn_dt                                                                   AS 合同起始日期
        ,T1.ctr_mtu_dt                                                                   AS 合同到期日期
        ,T3.grnt_mod_nm                                                                  AS 担保类型
        ,CASE
           WHEN T1.RVLG_TYP_CD = '1' AND substr(T1.PRD_NO, 1, 6) IN ( '200102' , '200101' , '100101' ) THEN '是'
           ELSE '否'
         END                                                                             AS 是否融E贷
        ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id  ORDER BY  T1.prd_no, T1.ctr_bgn_dt ) AS RN
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    edw.dim_bus_loan_prd_frml_dd T2 --产品信息
ON      T1.prd_no = T2.prd_no
AND     T2.DT = '20241120'
LEFT JOIN    (
                 SELECT  a.dt
                         ,a.ctr_serno
                         ,a.grnt_mod_colc
                         ,WM_CONCAT('|', COALESCE(b.cd_val_dscr)) AS grnt_mod_nm
                 FROM    (
                             SELECT  dt
                                     ,ctr_serno
                                     ,grnt_mod_colc
                                     ,grnt_mod_colc2
                             FROM    edw.dim_bus_loan_ctr_bse_inf_dd LATERAL VIEW explode(split(grnt_mod_colc, ',')) grnt_mod_colc AS grnt_mod_colc2
                             WHERE   dt = '20241120'
                             AND     grnt_mod_colc IS NOT NULL
                             AND     grnt_mod_colc <> ''
                         ) a
                 LEFT JOIN    edw.dwd_code_library_dd b --码值表
                 ON      a.grnt_mod_colc2 = b.cd_val
                 AND     b.tbl_nm = 'DIM_BUS_LOAN_CTR_GRNT_INF_DD'
                 AND     b.fld_nm = 'GRNT_MOD_CD'
                 AND     b.DT = '20241120'
                 GROUP BY a.dt , a.ctr_serno , a.grnt_mod_colc
             ) T3
ON      T1.ctr_serno = T3.ctr_serno
WHERE   T1.DT = '20241120'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( T1.CTR_STS_CD IN ( '2' , '4' ) AND T1.TMT_DT = '18991231' AND to_date(T1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T1.dt, 'yyyyMMdd') )
        OR T1.CTR_BAL > 0 )
;


--2.当前中征分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_02 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20241120'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id  ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20241120'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;

--3.上年中征分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_03 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_03 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20231231'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id  ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20231231'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;






-- 数据日期	管护机构	管护客户经理工号	管护客户经理名称	客户号	客户名称	授信总金额	用信余额	泰E贷授信金额	担保类型	授信到期日	融E贷
-- 担保类型	授信到期日	随贷通卡	担保类型	授信到期日	普贷1	担保类型	授信到期日	普贷2	担保类型	授信到期日	风险等级	模型分	相对位置
-- 征信评分	征信报告日期	上年征信评分	同一风险控制号	子社区编号	子社区名称


SELECT * FROM tmp_daye_SJ20241120126_04 WHERE 6_产品名称 IS NOT NULL

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_04 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_daye_SJ20241120126_04 AS
SELECT  T1.DT               AS 数据日期
        ,T1.prm_org_id      AS 管护机构号
        ,T1.prm_org_nm      AS 管护机构名称
        ,T1.prm_mgr_id      AS 管护客户经理工号
        ,T1.prm_mgr_nm      AS 管护客户经理名称
        ,T1.cst_id          AS 客户号
        ,T1.cst_nm          AS 客户名称
		,T8.授信总金额
		,T8.授信总余额
        ,T2.风险等级
        ,T2.模型分
        ,T2.相对位置
        ,T3.中证评分            AS 征信评分
        ,T3.qry_tm          AS 征信报告日期
        ,T4.中证评分            AS 上年征信评分
        ,T5.SAM_RSK_CTRL_ID AS 同一风险控制号
        ,T5.SUB_CMNT_ID     AS 子社区编号
        ,T6.cmnt_nm         AS 子社区名称
        ,T71.产品名称           AS 1_产品名称
        ,T71.是否融E贷          AS 1_是否融E贷
        ,T71.担保类型           AS 1_担保类型
        ,T71.授信金额           AS 1_授信金额
		,T71.授信余额           AS 1_授信余额
        ,T71.合同起始日期         AS 1_合同起始日期
        ,T71.合同到期日期         AS 1_合同到期日期
        ,T72.产品名称           AS 2_产品名称
        ,T72.是否融E贷          AS 2_是否融E贷
        ,T72.担保类型           AS 2_担保类型
        ,T72.授信金额           AS 2_授信金额
		,T72.授信余额           AS 2_授信余额
        ,T72.合同起始日期         AS 2_合同起始日期
        ,T72.合同到期日期         AS 2_合同到期日期
        ,T73.产品名称           AS 3_产品名称
        ,T73.是否融E贷          AS 3_是否融E贷
        ,T73.担保类型           AS 3_担保类型
        ,T73.授信金额           AS 3_授信金额
		,T73.授信余额           AS 3_授信余额
        ,T73.合同起始日期         AS 3_合同起始日期
        ,T73.合同到期日期         AS 3_合同到期日期
        ,T74.产品名称           AS 4_产品名称
        ,T74.是否融E贷          AS 4_是否融E贷
        ,T74.担保类型           AS 4_担保类型
        ,T74.授信金额           AS 4_授信金额
		,T74.授信余额           AS 4_授信余额
        ,T74.合同起始日期         AS 4_合同起始日期
        ,T74.合同到期日期         AS 4_合同到期日期
        ,T75.产品名称           AS 5_产品名称
        ,T75.是否融E贷          AS 5_是否融E贷
        ,T75.担保类型           AS 5_担保类型
        ,T75.授信金额           AS 5_授信金额
		,T75.授信余额           AS 5_授信余额
        ,T75.合同起始日期         AS 5_合同起始日期
        ,T75.合同到期日期         AS 5_合同到期日期
        ,T76.产品名称           AS 6_产品名称
        ,T76.是否融E贷          AS 6_是否融E贷
        ,T76.担保类型           AS 6_担保类型
        ,T76.授信金额           AS 6_授信金额
		,T76.授信余额           AS 6_授信余额
        ,T76.合同起始日期         AS 6_合同起始日期
        ,T76.合同到期日期         AS 6_合同到期日期
    --    ,T77.其它合同信息汇总
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,CASE
                            WHEN A1.rsk_lyr_cd = '1' THEN '低风险'
                            WHEN A1.rsk_lyr_cd = '5' THEN '高风险'
                            WHEN A1.rsk_lyr_cd = '2' THEN '中低风险'
                            WHEN A1.rsk_lyr_cd = '3' THEN '中风险'
                            WHEN A1.rsk_lyr_cd = '4' THEN '中高风险'
                          END                                                                          AS 风险等级
                         ,A1.modl_grd                                                                  AS 模型分
                         ,A1.pct                                                                       AS 相对位置
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.rsk_lyr_afm_tm DESC ) AS RN
                 FROM    edw.dim_cst_asst_rsk_lyr_dd A1
                 WHERE   A1.DT = '20241120'
                 AND     A1.rsk_lyr_cd <> ''
             ) T2
ON      T1.cst_id = T2.cst_id
AND     T2.RN = 1
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_02 T3
ON      T1.cst_id = T3.cst_id
AND     T3.rk = 1
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_03 T4
ON      T1.cst_id = T4.cst_id
AND     T4.rk = 1
LEFT JOIN    edw.dws_cst_bas_inf_dd T5 --客户基础信息汇总表
ON      T1.cst_id = T5.cst_id
AND     T5.DT = '20241120'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T6 --社区信息
ON      T5.SUB_CMNT_ID = T6.cmnt_enc
AND     T6.DT = '20241120'
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_01 T71
ON      T1.cst_id = T71.cst_id
AND     T71.RN = 1
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_01 T72
ON      T1.cst_id = T72.cst_id
AND     T72.RN = 2
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_01 T73
ON      T1.cst_id = T73.cst_id
AND     T73.RN = 3
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_01 T74
ON      T1.cst_id = T74.cst_id
AND     T74.RN = 4
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_01 T75
ON      T1.cst_id = T75.cst_id
AND     T75.RN = 5
LEFT JOIN    lab_bigdata_dev.tmp_daye_SJ20241120126_01 T76
ON      T1.cst_id = T76.cst_id
AND     T76.RN = 6
--LEFT JOIN    (
--                 SELECT  cst_id
--                         ,WM_CONCAT(', ', CONCAT(A1.产品名称, '-', A1.是否融E贷, '-', A1.担保类型,'-', A1.授信金额,'-', A1.授信余额, '-', A1.合同起始日期, '-', A1.合同到期日期)) AS 其它合同信息汇总
--                 FROM    lab_bigdata_dev.tmp_daye_SJ20241120126_01 A1
--                 WHERE   A1.RN > 6
--                 GROUP BY cst_id
--             ) T77
--ON      T1.cst_id = T77.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(授信金额)  AS 授信总金额
						 ,SUM(授信余额)  AS 授信总余额
                 FROM    lab_bigdata_dev.tmp_daye_SJ20241120126_01 A1
                 GROUP BY A1.cst_id
             ) T8
ON      T1.cst_id = T8.cst_id
WHERE   T1.DT = '20241120'
AND     SUBSTR(T1.prm_org_id,1,4) ='4261'  --大冶分行
AND     T71.cst_id IS NOT NULL
;
**01-数据需求_村行_D1126_王善民_福清村行_客户管护客户融资情况.sql
-- SJ2024112666。
-- 分析营业部业务三部丁聪_王寒晨本年度发放的贷款征信相关信息及准入执行情况。字段：
-- 同一风险控制号下银行融资家数、同一风险控制号下融资余额、上一笔贷款融资余额、上一笔贷款融资家数、最大一笔贷款余额、近6个月查询次数、非银机构融资家数

-- 025331	丁聪         福建福清泰隆村镇银行营业部业务三部
-- 017120	王寒晨       福建福清泰隆村镇银行营业部业务三部

--临时表1 插入附件
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_01 PURGE;

-- CREATE TABLE lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_01
-- (
  -- 合同登记流水号 STRING
  -- ,客户号        STRING
  -- ,客户名称      STRING
-- ) ;



--临时表2 征信贷款信息
drop table if exists lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_02 purge ;
create table lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_02  AS
SELECT  A1.dt
        ,A1.cst_id
        ,A1.report_id
        ,A1.dtrb_org
		,A1.dtrb_org_typ_cd	  --发放机构类型
		,A1.ctr_bal	     --贷款余额
		,A1.cls_dt
        ,RANK() OVER(PARTITION BY A1.cst_id ORDER BY A1.report_id DESC  ) AS RN
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND      A1.cls_dt > SUBSTR(A1.report_id,1,8) --关闭日期
AND      A1.dtrb_org <> 'ZJTLCB'   --剔除泰隆
UNION ALL
SELECT  A1.dt
        ,A1.cst_id
        ,A1.report_id
		,A1.dtrb_org_cd as dtrb_org
        ,A1.dtrb_org_typ_cd   --发放机构类型
		,A1.loan_bal as ctr_bal		      --贷款余额
		,A1.cls_dt
  	    ,RANK() OVER(PARTITION BY A1.cst_id ORDER BY A1.report_id DESC  ) AS RN
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND      A1.cls_dt > SUBSTR(A1.report_id,1,8) --关闭日期
AND     A1.dtrb_org_typ_cd <> ''   --剔除泰隆
 ;


--临时表3 合同发生时间
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_03 AS
SELECT   A1.合同登记流水号
        ,A1.客户号
        ,A1.合同起始日期
        ,A1.上一笔合同起始日期
		,A2.SAM_RSK_CTRL_ID AS 同一风险控制号
FROM    (
            SELECT  T1.合同登记流水号
                    ,T1.客户号
                    ,T2.ctr_bgn_dt                                                                      AS 合同起始日期
                    ,T3.ctr_bgn_dt                                                                      AS 上一笔合同起始日期
                    ,ROW_NUMBER() OVER ( PARTITION BY T1.合同登记流水号 , T1.客户号 ORDER BY T3.ctr_bgn_dt DESC ) AS RN
            FROM    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_01 T1
            LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2 --合同基础信息
            ON      T1.合同登记流水号 = T2.ctr_serno
            AND     T2.DT = '@@{yyyyMMdd}'
            LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T3 --合同基础信息  --取上一笔合同日期
            ON      T1.客户号 = T3.cst_id
            AND     T2.ctr_bgn_dt > T3.ctr_bgn_dt
            AND     T3.DT = '@@{yyyyMMdd}'
        ) A1
LEFT JOIN edw.dws_cst_bas_inf_dd A2  --客户基础信息汇总表
ON A1.客户号 = A2.CST_ID
AND A2.DT ='@@{yyyyMMdd}'
WHERE   A1.RN = 1;



--临时表4  同一风险控制号下银行融资家数、同一风险控制号下融资余额、上一笔贷款融资余额、上一笔贷款融资家数、最大一笔贷款余额、非银机构融资家数
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_04 AS
SELECT  B1.合同登记流水号
        ,B1.客户号
        ,B1.同一风险控制号下银行融资家数
        ,B1.同一风险控制号下融资余额
        ,B2.上一笔贷款融资家数
        ,B2.上一笔贷款融资余额
        ,B3.最大一笔贷款余额
        ,B3.非银机构融资家数
FROM    (
            SELECT  A1.合同登记流水号
                    ,A1.客户号
                    ,COUNT(DISTINCT A1.dtrb_org) AS 同一风险控制号下银行融资家数
                    ,SUM(A1.ctr_bal)             AS 同一风险控制号下融资余额
            FROM    (
                        SELECT  T1.合同登记流水号
                                ,T1.客户号
                                ,T3.ctr_bal
                                ,T3.dtrb_org_typ_cd
                                ,T3.dtrb_org
                                ,RANK() OVER ( PARTITION BY T1.客户号 , T1.合同登记流水号 , COALESCE(T2.CST_ID, T1.客户号) ORDER BY T3.report_id DESC ) AS RN
                        FROM    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_03 T1
                        LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
                        ON      T1.同一风险控制号 = T2.SAM_RSK_CTRL_ID
                        AND     T2.SAM_RSK_CTRL_ID <> ''
                        AND     T2.DT = '@@{yyyyMMdd}'
                        LEFT JOIN    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_02 T3
                        ON      COALESCE(T2.CST_ID, T1.客户号) = T3.cst_id
                        AND     T1.合同起始日期 >= SUBSTR(T3.report_id, 1, 8)    --发放时
                    ) A1
            WHERE   A1.RN = 1
            GROUP BY A1.合同登记流水号 , A1.客户号
        ) B1
LEFT JOIN    (
                 SELECT  A1.合同登记流水号
                         ,A1.客户号
                         ,COUNT(DISTINCT A1.dtrb_org) AS 上一笔贷款融资家数
                         ,SUM(A1.ctr_bal)             AS 上一笔贷款融资余额
                 FROM    (
                             SELECT  T1.合同登记流水号
                                     ,T1.客户号
                                     ,T3.ctr_bal
                                     ,T3.dtrb_org_typ_cd
                                     ,T3.dtrb_org
                                     ,RANK() OVER ( PARTITION BY T1.客户号 , T1.合同登记流水号 ORDER BY T3.report_id DESC ) AS RN
                             FROM    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_03 T1
                             LEFT JOIN    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_02 T3
                             ON      T1.客户号 = T3.cst_id
                             AND     T1.上一笔合同起始日期 >= SUBSTR(T3.report_id, 1, 8)  --上一笔
                         ) A1
                 WHERE   A1.RN = 1
                 GROUP BY A1.合同登记流水号 , A1.客户号
             ) B2
ON      B1.客户号 = B2.客户号
AND     B1.合同登记流水号 = B2.合同登记流水号
LEFT JOIN    (
                 SELECT  A1.合同登记流水号
                         ,A1.客户号
                         ,COUNT(DISTINCT CASE WHEN A1.dtrb_org_typ_cd NOT IN ( '11' , '12' , '14' , '15' ) THEN A1.dtrb_org END) AS 非银机构融资家数
                         ,MAX(A1.ctr_bal)     AS 最大一笔贷款余额
                 FROM    (
                             SELECT  T1.合同登记流水号
                                     ,T1.客户号
                                     ,T3.ctr_bal
                                     ,T3.dtrb_org_typ_cd
                                     ,T3.dtrb_org
                                     ,RANK() OVER ( PARTITION BY T1.客户号 , T1.合同登记流水号 ORDER BY T3.report_id DESC ) AS RN
                             FROM    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_03 T1
                             LEFT JOIN    lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_02 T3
                             ON      T1.客户号 = T3.cst_id
                             AND     T1.合同起始日期 >= SUBSTR(T3.report_id, 1, 8)
                         ) A1
                 WHERE   A1.RN = 1
                 GROUP BY A1.合同登记流水号 , A1.客户号
             ) B3
ON      B1.客户号 = B3.客户号
AND     B1.合同登记流水号 = B3.合同登记流水号;


--临时表5  近6个月查询次数
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_05 AS
SELECT A1.客户号
        ,A1.合同登记流水号
        ,SUM(CASE
               WHEN CAST(A1.qry_dt AS STRING) <> ''  AND DATEDIFF(TO_DATE(SUBSTR(A1.rpt_id, 1, 8), 'YYYYMMDD'), TO_DATE(SUBSTR(CAST(A1.qry_dt AS STRING), 1, 8), 'YYYYMMDD'), 'MM') <= 6 THEN 1
               ELSE 0
             END)     AS 近6个月查询次数
FROM   (
                  SELECT  T1.客户号
				          ,T1.合同登记流水号
                          ,T2.qry_dt
                          ,T2.qry_org_typ
						  ,T2.qry_rsn_cd
						  ,T2.rpt_id
						  ,RANK() OVER(PARTITION BY T1.客户号,T1.合同登记流水号 ORDER BY T2.rpt_id DESC, T2.DT DESC ) AS RN
                  FROM   lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_03 T1
				  LEFT  JOIN edw.dwd_cst_ccrc_ipcr_qry_rcd_di T2  --人行征信报告查询记录明细
				  ON    T1.客户号 = T2.qry_cst_id
				  AND   T1.合同起始日期 >=  SUBSTR(T2.rpt_id, 1, 8)
	    		  AND   T2.qry_org <> 'ZJTLCB'  --剔除泰隆
                  AND   T2.DT <= '@@{yyyyMMdd}'
				--  AND     qry_rsn_cd	 = '02' --贷款审批
              ) A1
WHERE A1.RN = 1
GROUP BY  A1.客户号,A1.合同登记流水号 ;



--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_JGB PURGE;

CREATE TABLE lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_JGB AS
SELECT
   T1.合同登记流水号
  ,T1.客户号
  ,T1.客户名称
  ,T2.同一风险控制号下银行融资家数
  ,T2.同一风险控制号下融资余额
  ,T2.上一笔贷款融资家数
  ,T2.上一笔贷款融资余额
  ,T2.最大一笔贷款余额
  ,T2.非银机构融资家数
  ,T3.近6个月查询次数
FROM lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_01 T1
LEFT JOIN lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_04 T2
ON  T1.客户号 = T2.客户号
AND T1.合同登记流水号 = T2.合同登记流水号
LEFT JOIN lab_bigdata_dev.tmp_fq_dkzx_SJ2024112666_05 T3
ON  T1.客户号 = T3.客户号
AND T1.合同登记流水号 = T3.合同登记流水号
;
**01-数据需求_村行_D1202_王玉婷_2024年大冶村行发放业务的调查地址类型及侧面打听信息.sql
--SJ20241202136
--2024年大冶村行发放业务的调查地址类型及侧面打听信息
--字段：客户号	客户名称	合同流水号	合同金额	合同余额	经办机构	客户经理	调查地址类型	侧面打听对象	侧面打听内容



DROP TABLE IF EXISTS tmp_sjxq_SJ20241202136 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241202136 AS
SELECT  DISTINCT ctr.ctr_serno          AS 合同流水号
                 ,ctr.cst_id            AS 客户号
                 ,ctr.cst_nm            AS 客户名称
                 ,ctr.ctr_amt           AS 合同金额
                 ,ctr.ctr_bal           AS 合同余额
                 ,ctr.hdl_org_id        AS 经办机构号
                 ,ctr.mgr_id            AS 管护人ID
                 ,hr.empe_nm            AS 管护人
                 ,ctr.mgr_org_id        AS 管护机构号
                 ,org.org_nm            AS 管护机构
                 ,CASE
                    WHEN svy.svy_mod_cd = '04' THEN '侧面打听（现场）'
                    WHEN svy.svy_mod_cd = '05' THEN '侧面打听（非现场）'
                    WHEN svy.svy_mod_cd = '06' THEN '侧面打听（批量）'
                  END                   AS 调查方式
                 ,svy.svy_addr          AS 调查地址
                 -- ,svy.svy_addr_typ_cd   AS 调查地址类型id
                 ,svy1.cd_val_dscr      AS 调查地址类型
                 ,obj.svy_obj_nm        AS 调查对象名称
                 --    ,obj.with_be_svy_psn_rel_cd as 与被调查人关系代码
                 ,obj1.cd_val_dscr      AS 与被调查人关系
                 ,svy.svy_ctnt_and_rslt AS 调查内容及结果
FROM    edw.dim_bus_loan_ctr_bse_inf_dd ctr
LEFT JOIN    (
                 SELECT  *
                         ,DENSE_RANK() OVER ( PARTITION BY cst_id ORDER BY svy_dt desc ) AS rn
                 FROM    edw.dwd_bus_loan_cst_svy_rcd_dd ---客户调查记录信息 ,一个客户会有多个调查结果,取最新
                 WHERE   dt = '@@{yyyyMMdd}'
             ) svy
ON      ctr.cst_id = svy.cst_id
AND     svy.rn = 1
-- AND     svy.cst_rol_cd = '01' --主借款人
LEFT JOIN    edw.dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd obj --调查记录关联调查对象信息
ON      svy.svy_rcd_serno = obj.rel_serno
AND     obj.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd obj1
ON      obj.with_be_svy_psn_rel_cd = obj1.cd_val
AND     obj1.dt = '@@{yyyyMMdd}'
AND     obj1.tbl_nm = upper('dwd_bus_loan_svy_rcd_rel_svy_obj_inf_dd')
AND     obj1.fld_nm = upper('with_be_svy_psn_rel_cd')
LEFT JOIN    edw.dwd_code_library_dd svy1
ON      svy.svy_addr_typ_cd = svy1.cd_val
AND     svy1.tbl_nm = upper('dwd_bus_loan_cst_svy_rcd_dd')
AND     svy1.fld_nm = upper('svy_addr_typ_cd')
AND     svy1.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd hr
ON      ctr.mgr_id = hr.empe_id
AND     hr.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd org
ON      ctr.mgr_org_id = org.org_id
AND     org.dt = '@@{yyyyMMdd}'
WHERE   ctr.dt = '@@{yyyyMMdd}'
--未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
AND     ( ( ctr.CTR_STS_CD IN ( '2' , '4' )
AND     ctr.TMT_DT = '18991231'
AND     to_date(ctr.CTR_MTU_DT, 'yyyyMMdd') >= to_date(ctr.DT, 'yyyyMMdd') )
    OR ctr.CTR_BAL > 0 )
AND     substr(ctr.ctr_bgn_dt, 1, 4) = '2024'
AND     ctr.mgr_org_id LIKE '4261%' --大冶
AND     svy.svy_mod_cd IN ( '04' , '05' , '06' ) --侧面打听（现场）/侧面打听（非现场）/侧面打听（批量）
ORDER BY ctr.ctr_serno , ctr.cst_id;




--调查方式
-- 04	侧面打听（现场）
-- 01	现场（实地）
-- 02	云调查
-- 03	非现场
-- 05	侧面打听（非现场）
-- 06	侧面打听（批量）

-- XXD_APP_CST_ROL	客户角色代码	新信贷	01	主借款人
-- XXD_APP_CST_ROL	客户角色代码	新信贷	04	关联人
-- XXD_APP_CST_ROL	客户角色代码	新信贷	05	共同还款人
-- XXD_APP_CST_ROL	客户角色代码	新信贷	06	合作企业或关键人
-- XXD_APP_CST_ROL	客户角色代码	新信贷	07	无授权客户
-- XXD_APP_CST_ROL	客户角色代码	新信贷	02	共同借款人
-- XXD_APP_CST_ROL	客户角色代码	新信贷	03	担保人


-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	09	社区关键人
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	11	实际控制人
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	12	股东
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	13	法定代表人或实际控制人配偶
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	15	配偶
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	16	父母
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	17	子女
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	01	家人
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	04	邻居
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	07	同事
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	10	法定代表人
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	14	本人
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	18	合伙人
-- XXD_WITH_BE_SVY_PSN_REL_CD	与被调查人关系代码	新信贷	19	其他
**01-数据需求_村行_D1210_庆元村行_许巍文_无效户联系方式.sql
--SJ20241209111
-- 为深入挖掘存量客户资源，村行统一提供存量无效户客户清单，申请匹配联系电话，用于机构开展电话营销（社区内非主维护人管护的客户，主维护人无权查询电话号码，因此需通过数据需求匹配信息）

DROP TABLE IF EXISTS tmp_sjxq_SJ20241209111 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ20241209111 AS
SELECT  a.col_1  AS 客户号
        ,a.col_2 AS 客户名称
        ,a.col_3 AS 主管户客户经理
        ,a.col_4 AS 主管户客户经理名称
        ,a.col_5 AS 主管户机构
        ,CASE
           WHEN coalesce(s.mbl_nbr, '') <> ''     THEN s.mbl_nbr
           WHEN coalesce(s.fml_tel_nbr, '') <> '' THEN s.fml_tel_nbr
           WHEN coalesce(s.cmp_tel_nbr, '') <> '' THEN s.cmp_tel_nbr
         END     AS 联系电话  --按照手机，家庭，公司电话优先级取
FROM    qbi_file_20241211_14_19_06_0 a
LEFT JOIN    edw.dws_cst_bas_inf_dd s
ON      a.col_1 = s.cst_id
AND     s.dt = '@@{yyyyMMdd}'
WHERE   a.pt <> '';
**01-数据需求_村行_D1212_董静怡_眉县村行_本金_利息逾期客户清单.sql
--眉县村行
-- SJ2024121271
-- 2024年第4期举一反三检查主题排查&ldquo;2024年以来利息逾期客户清单
-- &ldquo;2024年1月1日至2024年11月30日本金、利息逾期客户清单


-- 字段：客户编号  客户姓名  合同流水号  借据流水号  贷款金额 贷款余额  应还利息时间 实际还利息时间   管户机构 管户客户经理


-- 参考普通贷款逾期清单  app_ado.fct_ado_loan_ovd_list
-- 24年逾期借据信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_01;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_01 AS
SELECT  DBIL_ID
        ,DT
        ,MTU_DT       AS 逾期日期
        ,CUR_TRM      AS 期数
		,ini_prcp	  AS 初始本金
		,ini_intr	  AS 初始利息
FROM    edw.DWD_BUS_LOAN_TRM_PMT_INF_DD
WHERE   MTU_DT = DT
AND     CUR_STS_CD = '1'  --逾期
AND     DT >= '20240101'
AND     DT <= '20241130'
;


--利息还款日期
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_02;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_02 AS
SELECT  A1.DBIL_ID
        ,A1.DT
        ,A1.逾期日期
        ,A1.期数
        ,A1.初始本金
        ,A1.初始利息
        ,A2.还款日期
FROM    lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_01 A1
LEFT JOIN    (
                 SELECT  DBIL_ID
                         ,cur_trm
                         ,MAX(trx_dt)    as     还款日期                                                                                                                                                                                             AS 还款日期
                         ,SUM(RCV_ACR_INTR_AMT + CLCN_ACR_INTR_AMT + RCV_OVD_INTR_AMT + CLCN_OVD_INTR_AMT + RCV_ACR_INTR_PNTY_AMT
						     + CLCN_ACR_INTR_PNTY_AMT + RCV_INTR_PNTY_AMT + CLCN_INTR_PNTY_AMT + ACR_CMPD_INTR_AMT + CMPD_INTR_AMT) AS 实收利息金额
                 FROM    edw.DWD_BUS_LOAN_TRM_PMT_TRX_DTL_DI --贷款期供交易明细
                 WHERE   TRX_EVT <> 'LN_JIEX'
                 AND     DT >= '20240101'
                 AND     DT <= '20241130'
                 GROUP BY DBIL_ID , cur_trm
             ) A2
ON      A1.DBIL_ID = A2.DBIL_ID
AND     A1.期数 = A2.cur_trm ;

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_03;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_03 AS
SELECT
   T1.cst_id	 AS 客户编号
   ,T1.cst_nm    AS 客户姓名
   ,T1.bus_ctr_id	 AS 合同流水号
   ,T1.dbil_id	   AS 借据流水号
   ,T1.ctr_amt AS 合同金额
   ,T1.amt	  AS 借据金额
   ,T1.prcp_bal	 AS 借据余额
   ,T2.逾期日期
   ,CASE WHEN T2.初始利息> 0 THEN T2.逾期日期 END AS 应还利息时间
   ,T2.还款日期  AS 实际还利息时间
   ,T1.acs_org_id	 AS  管户机构ID
   ,T1.acs_org_nm AS 管户机构名称
   ,T1.cst_mngr_id	 AS 管户客户经理ID
   ,T1.cst_mngr_nm   AS 管户客户经理名称
FROM  edw.dws_bus_loan_dbil_inf_dd T1   --贷款借据信息汇总
INNER JOIN   lab_bigdata_dev.tmp_mx_SJ2024121271_yuqi_02 T2
ON    T1.DBIL_ID = T2.DBIL_ID
WHERE T1.DT ='20241130'
AND T1.acs_org_id LIKE '6162%'  --眉县村行
;
**01-数据需求_村行_D1220_大冶村行_冯廷灯_积分付抵扣客户清单.sql
--	SJ2024121846
--大冶村行2024年综合积分兑换合计206万，其中柜面、超级柜台、Pad三个端口兑换合计约180万，剩余26万是村行有积分余额客户与我行泰惠收商户积分付抵扣兑换。本次数据申请积分付抵扣部分具体兑换清单。具体维度详见数据内容
--字段：交易流水号	客户号	客户姓名		积分类型	交易标识	借贷标志 积分发生额	泰惠收积分付金额	积分兑换金额	交易渠道	交易机构	交易状态	备注	交易时间
--管护机构号	管护机构名称	管护客户经理工号	管护客户经理名称



DROP TABLE IF EXISTS tmp_sjxq_SJ2024121846 PURGE;

CREATE TABLE IF NOT EXISTS tmp_sjxq_SJ2024121846 AS
SELECT  DISTINCT t1.transno          AS 交易流水号
                 ,t1.customersid     AS 积分客户号
                 ,t4.hostcustno      AS 客户号
                 ,t5.cst_act_id      AS 客户账号
                 ,t5.mgr_id          AS 管护客户经理工号
                 ,t6.empe_nm         AS 管护客户经理名称
                 ,t5.acs_org_id      AS 管护机构号
                 ,t7.org_nm          AS 管护机构名称
                 ,t1.pointstypeno    AS 积分类型
                 ,t1.pointsamount    AS 积分数额
                 ,CASE
                    WHEN t1.transchannel = '104020' THEN '手机银行'
                    ELSE ''
                  END                AS 交易渠道
                 -- ,t1.institutionid AS 机构id
                 ,t8.institutionno   AS 机构号
                 ,t8.institutionname AS 机构名称
                 ,t1.transtypeno     AS 交易类型
                 ,t9.description     AS 交易类型说明
                 ,t1.transdate       AS 交易时间
                 ,case when t1.transstatus='1' then '成功'
                 when t1.transstatus='0' then '失败'
                 end AS 交易状态
                 ,CASE
                    WHEN t1.debitorcredit = 'C' THEN '贷'
                    WHEN t1.debitorcredit = 'D' THEN '借'
                  END                AS 借贷标志
                 ,CASE
                    WHEN t1.reversedflag = '0' THEN '正常'
                    WHEN t1.reversedflag = '1' THEN '冲正'
                    WHEN t1.reversedflag = '2' THEN '撤销'
                    WHEN t1.reversedflag = '3' THEN '退货'
                  END                AS 冲正标志
                 -- ,t1.belongbranch    AS 积分归属机构
                 ,t1.custno          AS 商户号
                --  ,t1.beizhu          AS 备注
                 ,t1.description     AS 摘要
FROM    edw.sirs_pointstrans t1 --积分交易流水表，增量表
LEFT JOIN    edw.sirs_customers t4 --客户表
ON      t1.customersid = t4.customersid
AND     t4.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_bus_dep_act_mgr_inf_dd t5 --存款账户管护
ON      t4.hostcustno = t5.cst_id
AND     t5.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd t7 --机构树_考核维度
ON      t5.acs_org_id = t7.org_id
AND     T7.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_hr_empe_inf_dd T6 --员工汇总信息
ON      t5.mgr_id = T6.empe_id
AND     T6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.sirs_institution t8 --积分机构表
ON      t1.institutionid = t8.institutionid
AND     t8.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.sirs_transtype t9 --交易类型
ON      t1.transtypeno = t9.transtypeno
AND     t9.dt = '@@{yyyyMMdd}'
WHERE   t1.dt >= '20240101'
AND     t1.pointstypeno = '0001'  --综合积分
-- AND     t1.transstatus = '1'  --交易正常
-- AND     t1.reversedflag = '0' --冲正标志正常
AND     t1.custno = '1007' --泰惠收
AND     t8.institutionno LIKE '4261%'  --大冶村行
;



---积分兑换

-- --综合积分
-- AND di . PNT_TYP_CD = '0001'
-- --冲正标志正常
-- AND di . RVS_IND = '0'
-- --交易状态成功
-- AND di . TRX_STS_CD = '1'
-- --借贷标识：借
-- AND di . crd_and_dbt_ind
-- --积分消费
-- AND di . TRX_TYP_CD = '1001'

-- --积分产生
-- and     a.crd_and_dbt_ind='C'
-- AND     a.rvs_ind = '0'  --正常
-- AND     a.trx_sts_cd = '1'  --交易成功
**01-数据需求_村行_D1224_吴美健_11月_20241101_20241130_庆元村行催收走访记录.sql
--
-- SJ2024122381

--2024年11月（20241101-20241130）庆元村行催收走访记录

--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024122381 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024122381 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '20241130'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2024-11-01 00:00:00' and '2024-11-30 00:00:00'
ORDER BY t1.coln_date
;
**01-数据需求_村行_SJ2024011506_庆元村行_许巍文_全量客户积分余额及累计兑换额.sql
-- **********************************************************************
--截止最近一天，庆元村行全量客户积分余额及累计兑换额
--字段：数据日期、客户号、客户名称、管户机构号、管户人工号、管户人名称、积分余额、积分累计兑换额
--积分交易明细，客户主管户信息

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qych_jf_20240117 PURGE;
create TABLE IF not EXISTS lab_bigdata_dev.tmp_qych_jf_20240117 as
SELECT  t.dt  日期
        ,t.cst_id 客户号
        ,t1.cst_nm 客户名称
        ,t1.prm_org_id 管户机构号
        ,t1.prm_mgr_id 管户人工号
        ,t1.prm_mgr_nm 管户人名称
        ,t.pnt_bal 积分余额
        ,t3.PNT_NBR_AMT 积分累计兑换额
FROM    edw.dim_bus_cmpn_pnt_act_inf_dd t    --积分账户信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t1      ------客户管护新表
ON      t1.dt = '20240117'
AND     t1.cst_id = t.cst_id
LEFT JOIN    (
                 SELECT  di.cst_id cst_id
                         ,SUM(di.PNT_NBR_AMT) PNT_NBR_AMT  ----积分数额
                 FROM    EDW.DWD_BUS_CMPN_PNT_TRX_DTL_DI di   ---积分明细表
                 WHERE   1 = 1
                 AND     di.dt <= '20240117'
                 --综合积分
                 AND     di.PNT_TYP_CD = '0001'
                 --冲正标志正常
                 AND     di.RVS_IND = '0'
                 --交易状态成功
                 AND     di.TRX_STS_CD = '1'
                 --借贷标识：借
                 AND     di.CRD_AND_DBT_IND = 'D'
                 --积分消费
                 AND     di.TRX_TYP_CD = '1001'
                 GROUP BY di.cst_id
             ) t3
ON      t3.cst_id = t.cst_id
WHERE   t.dt = '20240117'
AND T.PNT_TYP_CD = '0001'--综合积分
AND t1.prm_org_id LIKE '3361%'
;


SELECT *
from tmp_qych_jf_20240117
;
**01-数据需求_村行_SJ2024012371_福建福清_王善民_客户编号_客户名称_同一风险控制号_关联客户姓名_关联关系.sql
--客户编号、客户名称、同一风险控制号、关联客户姓名、关联关系，用于分析借款人与关联人是否为同一机构

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sam_rsk_ctrl_id_20240125_fuqing PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sam_rsk_ctrl_id_20240125_fuqing AS
SELECT  t1.cst_id 客户编号
        ,t1.cst_chn_nm 客户姓名
        ,t1.sam_rsk_ctrl_id  同一风险控制号
        ,t5.cst_chn_nm 关联客户姓名
        ,t4.cd_val_dscr 关联关系
        ,t6.prm_org_nm 主管护机构名称
        ,t3.rel_cst_id  关联客户编号
FROM    qbi_file_20240125_16_38_46 t0    ---业务提供的名单表
inner join  edw.dws_cst_bas_inf_dd t1   -- 客户基础信息汇总表
on t1.dt='@@{yyyyMMdd}' and t0.col_1=t1.cst_id

-- s2:找客户关联关系
LEFT JOIN (
select cst_id,rel_cst_id, rel_typ_cd from edw.dim_cst_rel_inf_dd where dt  = '@@{yyyyMMdd}'
union
select cst_id,rel_cst_id, REL_REL_CD as rel_typ_cd from edw.dwd_cst_rel_inf_dd where dt  = '@@{yyyyMMdd}'
)t3   --客户关联关系信息   --因dwd_cst_rel_inf_dd和dim_cst_rel_inf_dd两张表数据有交叉又有遗漏，都取了
ON  t1.cst_id=t3.cst_id

left join edw.dwd_code_library_dd t4    --码值表
on t4.dt='@@{yyyyMMdd}'
and t4.tbl_nm='DIM_CST_REL_INF_DD'
and t4.fld_nm='REL_TYP_CD'
and t4.cd_val=t3.rel_typ_cd
left join edw.dws_cst_bas_inf_dd t5   --客户基础信息表
on t5.dt='@@{yyyyMMdd}'
and t5.cst_id=t3.rel_cst_id
--s3:找客户主管护机构
LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t6   ---客户主管护机构
ON t1.cst_id=t6.cst_id
AND t6.dt='@@{yyyyMMdd}'
and t6.prm_org_id like '3564%'
where    substr(t0.pt,1,8)='20240125'
and t3.rel_cst_id  is not null
order by t1.cst_id
;

-- SELECT * FROM lab_bigdata_dev.tmp_sam_rsk_ctrl_id_20240125_fuqing;


--排查为啥查询的是空值
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sam_rsk_ctrl_id_20240125_fuqing PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sam_rsk_ctrl_id_20240125_fuqing AS
SELECT  t1.cst_id 客户编号
        ,t1.cst_chn_nm 客户姓名
        ,t1.sam_rsk_ctrl_id  同一风险控制号
        ,t5.cst_chn_nm 关联客户姓名
        ,t4.cd_val_dscr 关联关系
        ,t6.prm_org_nm 主管护机构名称
        ,t3.rel_cst_id  关联客户
FROM    qbi_file_20240125_16_38_46 t0    ---业务提供的名单表，从QUICKBI中数据源导入，创建物理表

inner join  edw.dws_cst_bas_inf_dd t1   -- 客户基础信息汇总表
on t1.dt='@@{yyyyMMdd}' and t0.col_1=t1.cst_id

-- s1:找客户关联关系
LEFT JOIN (
select cst_id,rel_cst_id, rel_typ_cd from edw.dim_cst_rel_inf_dd where dt  = '@@{yyyyMMdd}' --客户关联关系信息
union
select cst_id,rel_cst_id, REL_REL_CD as rel_typ_cd from edw.dwd_cst_rel_inf_dd where dt  = '@@{yyyyMMdd}'   --客户关联信息
)t3
ON  t1.cst_id=t3.cst_id

left join edw.dwd_code_library_dd t4    --码值表
on t4.cd_val=t3.rel_typ_cd
and t4.tbl_nm='DIM_CST_REL_INF_DD'
and t4.fld_nm='REL_TYP_CD'
and t4.dt='@@{yyyyMMdd}'

left join edw.dws_cst_bas_inf_dd t5   --客户基础信息汇总表
on t5.dt='@@{yyyyMMdd}'
and t5.cst_id=t3.rel_cst_id

--s2:找客户主管护机构
LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t6   ---客户主管护机构
ON t1.cst_id=t6.cst_id
AND t6.dt='@@{yyyyMMdd}'
and t6.prm_org_id like '3564%'
where    substr(t0.pt,1,8)='@@{yyyyMMdd}'
and t3.rel_cst_id  is not null
order by t1.cst_id
;
**01-数据需求_村行_SJ2024012916_客户经理800117名下贷款户.sql
--截止目前最新的授信客户清单，离职客户经理工号（800117），离职客户经理名称（吴贤柳）
--frz_sts_cd：1 正常,2冻结，3 到期失效 4 终止失效

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingdan01 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qingdan01 as
SELECT  t.prm_mgr_id 管护客户经理工号
        ,t.prm_mgr_nm 管护客户经理名称
        ,t.cst_id 客户号
        ,t.cst_nm 客户姓名
        ,t9.rpay_act_id 贷款户我行账号
        ,h1.empe_nm 存款管护客户经理
        ,t9.sum_ctr_amt 合同总金额
        ,t10.sub_cmnt_nm 子社区名称
        ,t3.rel_cst_id 配偶客户号
        ,t4.cst_chn_nm 配偶姓名
        ,h3.empe_nm 配偶信贷系统管户客户经理
        ,t6.cst_act_id 配偶我行存款账号
        ,h2.empe_nm 配偶我行存款管户客户经理
        ,t1.sam_rsk_ctrl_id 同一风险控制号
        ,t7.exps_bal 同一风险控制号敞口
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t --客户主管护信息
INNER JOIN    edw.dws_cst_bas_inf_dd t1 --客户基础信息汇总
ON      t1.dt = '@@{yyyyMMdd}'
AND     t1.cst_id = t.cst_id
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd t2 --客户存款账户管护信息表
ON      t2.dt = '@@{yyyyMMdd}'
AND     t2.cst_id = t1.cst_id
LEFT JOIN    edw.dim_cst_rel_inf_dd t3 --客户关联关系信息
ON      t3.dt = '@@{yyyyMMdd}'
AND     t3.cst_id = t1.cst_id
AND     t3.rel_typ_cd = '0301'
LEFT JOIN    edw.dws_cst_bas_inf_dd t4 --客户基础信息汇总
ON      t4.dt = '@@{yyyyMMdd}'
AND     t4.cst_id = t3.rel_cst_id --配偶的编号
LEFT JOIN    edw.loan_customer_belong t5 --信贷主管护信息
ON      t5.dt = '@@{yyyyMMdd}'
AND     t5.customerid = t3.rel_cst_id
AND     t5.belongattribute = '1'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd t6 --客户存款账户管护信息表
ON      t6.dt = '@@{yyyyMMdd}'
AND     t6.cst_id = t3.rel_cst_id --配偶的编号
LEFT JOIN    adm_pub.adm_rsk_apl_cst_use_crdt_cst_info_dd t7 --风险集市客户授信用信客户维度信息
ON      t7.dt = '@@{yyyyMMdd}'
AND     t7.cst_id = t1.cst_id
LEFT JOIN    edw.dws_hr_empe_inf_dd h1 --员工汇总信息
ON      h1.dt = '@@{yyyyMMdd}'
AND     h1.empe_id = t2.mgr_id
LEFT JOIN    edw.dws_hr_empe_inf_dd h2 --员工汇总信息
ON      h2.dt = '@@{yyyyMMdd}'
AND     h2.empe_id = t6.mgr_id
LEFT JOIN    edw.dws_hr_empe_inf_dd h3 --员工汇总信息
ON      h3.dt = '@@{yyyyMMdd}'
AND     h3.empe_id = t5.userid
LEFT JOIN    (
                 SELECT  p.cst_id
                         ,p.rpay_act_id
                         ,sum(p.ctr_amt) AS sum_ctr_amt
                 FROM    edw.dim_bus_loan_ctr_inf_dd p --信贷合同信息表
                 WHERE   p.dt = '@@{yyyyMMdd}'
                   AND     (    (
                         ( p.ctr_bal > 0  --余额>0
                           OR ( p.ctr_bal IS NULL AND     nvl(p.crc_ind, '0') = '0' )  --非循环贷有余额
                           OR ( ( nvl(p.crc_ind, '0') <> '0'   OR p.pd_cd LIKE '2010503%' ) AND     ( p.ctr_bal = 0  OR p.ctr_bal IS NULL )  AND     p.apnt_mtu_dt >= '@@{yyyyMMdd}' )  --（循环贷 或 随贷通） 且 余额为0 且 未到期
                         )
                     AND     nvl(p.frz_sts_cd, ' ') NOT IN ( '3' , '4' )  --3     到期失效  4     终止失效  冻结状态非到期失效，非终止失效
                    )
            OR ( p.ctr_bal > 0 AND     p.pd_cd LIKE '2010503%'  AND     p.apnt_mtu_dt <= '20231130'  AND     p.frz_sts_cd IN ( '3' , '4' ) )  --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
            ) ----未终结、未到期业务
                 GROUP BY p.cst_id , p.rpay_act_id
             ) t9
ON      t9.cst_id = t1.cst_id
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd t10 --社区信息表
ON      t10.cst_id = t1.cst_id
AND     t10.dt = '@@{yyyyMMdd}'
WHERE   t.dt = '@@{yyyyMMdd}'
AND     t.prm_mgr_id = '800117';

--找同一风险控制号下的客户
--字段：同一风险控制号下的客户名称、同一风险控制号下的客户号、同一风险控制号下的管户客户经理，
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingdan02 PURGE;
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qingdan02 as
SELECT  q . *
        ,q2.cst_id 同一风险控制号下的客户号
        ,q2.cst_chn_nm 同一风险控制号下的客户名称
        ,q3.prm_mgr_nm 同一风险控制号下的管护客户经理
FROM    lab_bigdata_dev.tmp_qingdan01 q --临时表
LEFT JOIN    edw.dws_cst_bas_inf_dd q1 --客户基础信息表
ON      q1.cst_id = q.客户号
AND     q1.dt = '@@{yyyyMMdd}'
AND     nvl(q1.sam_rsk_ctrl_id, '') <> ''
LEFT JOIN    edw.dws_cst_bas_inf_dd q2 --客户基础信息表
ON      q2.sam_rsk_ctrl_id = q1.sam_rsk_ctrl_id
AND     q2.dt = '@@{yyyyMMdd}'
AND     q2.cst_id <> q1.cst_id
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd q3 --客户主管护信息
ON      q3.cst_id = q2.cst_id
AND     q3.dt = '@@{yyyyMMdd}';


select COUNT(*) from lab_bigdata_dev.tmp_qingdan02;











-- -- --01：客户号、客户名称、贷款户我行账号、存款管户客户经理、客户合同总金额、子社区名称

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingdan01 PURGE;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qingdan01 as
-- SELECT t0.cst_id  CST_ID_risk   --客户号
--        ,t0.cst_nm 客户名称
--        ,t0.rpay_act_id 贷款户我行账号   --取合同表里面的还款账号，还款账号及贷款发放账号
--        ,t2.empe_nm 存款管护客户经理
--        ,sum(t0.ctr_amt) 合同金额
--         ,concat(t4.sub_cmnt_nm,'') 子社区名称
-- FROM edw.dim_bus_loan_ctr_inf_dd t0  --信贷合同信息表
-- INNER JOIN edw.dwd_cst_mng_cmnt_rel_dd t4  --客户社区信息表
-- on t4.cst_id=t0.cst_id
-- and t4.dt='@@{yyyyMMdd}'
-- left join edw.dwd_bus_dep_cst_act_mgr_inf_dd t1   --客户存款账户管护信息表
-- on t1.cst_id=t0.cst_id
-- and t1.dt='@@{yyyyMMdd}'
-- LEFT JOIN edw.dws_hr_empe_inf_dd t2  --员工汇总信息
-- ON t2.empe_id=t1.mgr_id
-- and t2.dt='@@{yyyyMMdd}'
-- WHERE t0.dt='@@{yyyyMMdd}'
-- GROUP BY t0.cst_id,t0.cst_nm ,t0.rpay_act_id ,t2.empe_nm,t4.sub_cmnt_nm
-- ;

-- -- --02：客户号，配偶姓名、配偶客户号、配偶信贷系统管户客户经理、配偶我行存款账号、配偶我行存款管户客户经理

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingdan02 PURGE;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qingdan02 as
-- SELECT t0.*
--        ,t1.rel_cst_id 配偶客户号
--        ,t3.cst_nm 配偶姓名
--        ,t3.prm_mgr_nm 配偶信贷系统管护人
--        ,t4.cst_act_id 配偶我行存款账号 --取客户账号
--        ,t5.empe_nm 配偶我行存款管护客户经理  --取主管护人名称
-- FROM lab_bigdata_dev.tmp_qingdan01 t0
-- left join edw.dim_cst_rel_inf_dd t1  --客户关联关系信息
-- on t1.cst_id=t0.CST_ID_risk
-- and t1.dt='@@{yyyyMMdd}'
-- and t1.rel_typ_cd='0301'  --配偶
-- LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t3 --客户主管护信息
-- ON t3.cst_id=t1.rel_cst_id
-- and t3.dt ='@@{yyyyMMdd}'
-- left join edw.dwd_bus_dep_cst_act_mgr_inf_dd t4   --客户存款账户管护信息
-- ON t4.cst_id=t3.cst_id
-- and t4.dt='@@{yyyyMMdd}'
-- LEFT JOIN edw.dws_hr_empe_inf_dd t5  --员工汇总信息
-- ON t5.empe_id=t4.mgr_id
-- and t5.dt='@@{yyyyMMdd}'
-- ;

-- --03：同一风险控制号、同一风险控制号敞口、同一风险控制号下的客户名称、同一风险控制号下的客户号、同一风险控制号下的管户客户经理

-- --找同一风险控制号下的客户

-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingdan03 PURGE ;
-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qingdan03 as
-- SELECT t1.*
--        ,t10.sam_rsk_ctrl_id 同一风险控制号
--        ,t5.sam_rsk_ctrl_cst_xpos_amt 同一风险控制号贷款敞口
--        ,t10.cst_chn_nm 同一风险控制号下的客户名称
--        ,t10.cst_id 同一风险控制号下的客户号
--        ,t4.prm_mgr_nm 同一风险控制号下的管护客户经理
-- from lab_bigdata_dev.tmp_qingdan02 t1
-- LEFT JOIN                                                    --Z找同一风险控制号下的客户
--     ( SELECT t2.cst_id
--              ,t2.sam_rsk_ctrl_id
--              ,t2.cst_chn_nm
--            FROM  edw.dws_cst_bas_inf_dd t2  --客户基础信息汇总
--         LEFT JOIN edw.dws_cst_bas_inf_dd t3  --客户基础信息汇总
--        on t3.sam_rsk_ctrl_id=t2.sam_rsk_ctrl_id
--        AND t3.dt='@@{yyyyMMdd}'
--        where t2.dt='@@{yyyyMMdd}'
--       ) t10
-- on t10.cst_id=t1.CST_ID_risk
-- left JOIN  edw.dws_bus_loan_sam_rsk_ctrl_inf_dd t5  --贷款同一风险控制号信息？？？？
-- ON t5.sam_rsk_ctrl_id=t10.sam_rsk_ctrl_id
-- and t5.dt='@@{yyyyMMdd}'
-- LEFT JOIN adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t4  --客户主管护信息
-- ON t4.cst_id=t10.cst_id
-- and t4.dt='@@{yyyyMMdd}'
-- ;


SELECT *
FROM edw.dwd_code_library_dd T
WHERE T.DT='@@{yyyyMMdd}'
AND t.tbl_nm=TOUPPER('dim_cst_rel_inf_dd')
AND t.fld_nm=TOUPPER('rel_typ_cd')
;
**01-数据需求_村行_SJ2024031271_庆元村行_许巍文_存量客户提取客户地址.sql
-- 客户号（个人和对公）	客户名称 主地址类型	主地址	经营地/工作地	居住地	户籍地/注册地
--edw.xwdt_xw_customer_addr 客户地址信息表(全量表)
--edw.xwdt_xw_customer, 客户表(正潜灰) --main_add_flag:主地址标示 1：经营 2：通讯 3：家庭 4：户籍   5：办公 6 : 注册
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_qingyuancladrr_0314 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_qingyuancladrr_0314 AS
SELECT  CAST(p.col_1 AS INT) 序号
        ,p.col_2 客户号
        ,p.col_3 客户名称
        ,CASE
           WHEN p1.main_add_flag = '1' THEN '经营'
           WHEN p1.main_add_flag = '2' THEN '通讯'
           WHEN p1.main_add_flag = '3' THEN '家庭'
           WHEN p1.main_add_flag = '4' THEN '户籍'
           WHEN p1.main_add_flag = '5' THEN '办公'
           WHEN p1.main_add_flag = '6' THEN '注册'
         END AS 主地址类型
        ,p1.main_add 主地址
        ,p0.operate_add 经营地址
        ,p0.operate_street 经营地址街道
        ,p0.unit_add 单位地址
        ,p0.unit_street 单位地址街道
        ,p0.comm_add 通讯地址
        ,p0.comm_street 通讯地址街道
        ,p0.fam_add 家庭地址
        ,p0.fam_street 家庭地址街道
        ,p0.regist_add 户籍地址
        ,p0.regist_street 户籍地址街道
        ,p0.con_regist_add 注册地址
        ,p0.con_regist_street 注册地址街道
FROM    lab_bigdata_dev.qbi_file_20240314_16_04_33 p
LEFT JOIN    edw.xwdt_xw_customer_addr p0 --客户地址信息表(全量表)
ON      p.col_2 = p0.cust_no
AND     p0.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_xw_customer p1 --客户表(正潜灰)
ON      p.col_2 = p1.cust_no
AND     p1.dt = '@@{yyyyMMdd}'
WHERE   p.pt = MAX_PT('lab_bigdata_dev.qbi_file_20240314_16_04_33')
ORDER BY CAST(p.col_1 AS INT) ASC;

SELECT * FROM edw.xwdt_xw_customer_addr p0 WHERE p0.dt='@@{@@yyyyMMdd}' and p0.cust_no='2601623400'



SELECT  * FROM    lab_bigdata_dev.tmp_qingyuancladrr_0314
**01-数据需求_村行_SJ2024040311_福建长乐_林心怡_普通贷款借据信息表数据.sql
--用途：监管要求自查2023年月末放款月初还款的客户，但自助取数只保留每个月月末的数据，故需要2023年2月至2024年1月期间每个月3号的普通贷款借据信息表数据

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_fjcl_linxinyin_20240407 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_fjcl_linxinyin_20240407 AS
SELECT  t.dt 日期
        ,t.dbil_id 借据编号
        ,t.bus_ctr_id 信贷合同编号
        ,t2.pd_nm 产品名称
        ,t.cst_id 客户编号
        ,t.cst_nm 客户名称
        ,t.amt 发放金额
        ,t.dtrb_dt 发放日期
        ,t.apnt_mtu_day 约定到期日期
        ,t.end_dt 终结日期
        ,t.prcp_bal 本金余额
        ,t.exe_intr_rat 执行利率
        ,t.acs_org_id 管护机构编号
        ,t.acs_org_nm 管护机构名称
        ,t.cst_mngr_id 管护客户经理编号
        ,t.cst_mngr_nm 管护客户经理姓名
        ,t.mon_acm_prcp_bal_acml / 3 本月本金余额日均
        ,t1.apnt_start_dt 合同起始日期
        ,t1.apnt_mtu_dt 合同到期日期
FROM    edw.dws_bus_loan_dbil_inf_dd t --贷款借据信息汇总
LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd t1 --信贷合同信息
ON      t.bus_ctr_id = t1.busi_ctr_id
AND     t1.dt = '20240131'
LEFT JOIN    edw.dim_bus_loan_pd_inf_dd t2 --信贷产品信息
ON      t.pd_cd = t2.pd_cd
AND     t2.dt = '@@{yyyyMMdd}'
WHERE   t.dt <= '20240131'
AND     t.dt >= '20230201'
AND     SUBSTR(t.dt, 7, 8) = '03'
AND     t.acs_org_id LIKE '3562%'
ORDER BY t.dt ASC;



SELECT * FROM lab_bigdata_dev.tmp_fjcl_linxinyin_20240407
**01-数据需求_村行_SJ2024062811_政和村行_张弛_农户小额_10万及以下_利息收入对应客户级明细清单.sql
--分析政和村行企业所得税，农户小额（10万及以下）利息收入对应客户级明细清单，2021年-2024年1季度，共13个季度数据。科目6011贷款利息收入客户明细。
--字段：客户号，客户名称，合同号，借据号，借款金额农户标识， 农户小额（10万及以下）利息收入
--6011贷款利息收入，单独查

DROP TABLE IF EXISTS tmp_zc_SJ2024062811 PURGE;

CREATE TABLE IF NOT EXISTS tmp_zc_SJ2024062811 AS
SELECT  SUBSTR(b.DT, 1, 6)                  AS 数据日期
        ,c.hetongbh                         AS 合同号
        ,b.dkjiejuh                         AS 借据号
        ,c.kehuhaoo                         AS 客户号
        ,c.kehmingc                         AS 客户名称
        ,CASE
           WHEN T5.farmer = '1' THEN '是'
           ELSE '否'
         END                                AS 农户标识
        -- ,c.yngyjigo                         AS 营业机构
        ,c.zhngjigo                         AS 账务机构
        -- ,c.dkzhangh                         AS 贷款账号
        ,c.hetongje                         AS 合同金额
        ,c.fafangje                         AS 已发放金额
        ,A.yeshux15                         AS 科目号
        ,COALESCE(T1.kemumnch, T2.kemumnch) AS 科目名称
        ,T4.int_act_id                      AS 内部账户
        ,T4.本期贷方余额
        ,T6.JIE_CUR_AMT                     AS 本日借方发生额
FROM    edw.core_klnb_dkkjsx b --贷款账户会计核算表
INNER JOIN    edw.core_kfap_yeshux a --余额属性参数表
ON      b.yewusx01 = substr(a.yewubima, 3)
AND     B.DT = a.DT
AND     a.mokuaiii = 'LN' --贷款模块
AND     ( a.yeshux15 IN ( '60110104' , '60110107' , '60110110' , '60110113' )
    OR substr(a.yeshux15, 6, 8) IN ( '60110104' , '60110107' , '60110110' , '60110113' ) )
AND     a.dt IN ( '20210331' , '20210630' , '20210930' , '20211231' , '20220331' , '20220630' , '20220930' , '20221231' , '20230331' , '20230630' , '20230930' , '20231231' , '20240331' )
LEFT JOIN    edw.core_klna_dkzhzb c --贷款账户主表,合同号，客户号，客户名称，
ON      b.dkjiejuh = c.dkjiejuh
AND     B.DT = C.DT
AND     c.dt IN ( '20210331' , '20210630' , '20210930' , '20211231' , '20220331' , '20220630' , '20220930' , '20221231' , '20230331' , '20230630' , '20230930' , '20231231' , '20240331' )
LEFT JOIN    edw.core_kfap_kjkemu T1 --会计科目
ON      A.yeshux15 = T1.kemuhaoo
AND     T1.DT = '20240331'
LEFT JOIN    edw.core_kfap_kjkemu T2 --会计科目
ON      substr(a.yeshux15, 6, 8) = T2.kemuhaoo
AND     T2.DT = '20240331'
LEFT JOIN    edw.core_kfap_neibhs T3 --内部管理核算表
ON      substr(a.yeshux15, 4) = T3.nbuhesdm
AND     B.DT = T3.DT
AND     T3.dt IN ( '20210331' , '20210630' , '20210930' , '20211231' , '20220331' , '20220630' , '20220930' , '20221231' , '20230331' , '20230630' , '20230930' , '20231231' , '20240331' )
LEFT JOIN    (
                 SELECT  A1.dt --日期
                         ,A1.LGP_ID --法人代码
                         ,A1.INT_ACT_ID --内部账号
                         ,A1.INT_ACT_ACT_NM --内部账户户名
                         ,A1.CCY_CD --货币代码
                         ,TRIM(A1.ACT_ORG_ID) AS 核算机构编号
                         ,TRIM(A1.ACT_ITM_ID) AS 会计科目编号
                         ,SUM(CASE
                                WHEN A1.BAL_DIR_CD = '0' THEN (
                                                              CASE
                                                                WHEN A1.LATE_BUS_DT > '@@{yyyyMMdd}' THEN A1.LAST_ACT_BAL
                                                                ELSE A1.ACT_BAL
                                                              END
                         )
                                ELSE 0
                              END)            AS 本期借方余额
                         ,SUM(CASE
                                WHEN A1.BAL_DIR_CD = '1' THEN (
                                                              CASE
                                                                WHEN A1.LATE_BUS_DT > '@@{yyyyMMdd}' THEN A1.LAST_ACT_BAL
                                                                ELSE A1.ACT_BAL
                                                              END
                         )
                                ELSE 0
                              END)            AS 本期贷方余额
                 FROM    edw.DIM_BUS_ACT_INT_ACT_INF_DD A1 --内部账户信息
                 WHERE   A1.dt IN ( '20210331' , '20210630' , '20210930' , '20211231' , '20220331' , '20220630' , '20220930' , '20221231' , '20230331' , '20230630' , '20230930' , '20231231' , '20240331' )
                 GROUP BY A1.DT , A1.LGP_ID , A1.INT_ACT_ID , A1.INT_ACT_ACT_NM , A1.CCY_CD , TRIM(A1.ACT_ORG_ID) , TRIM(A1.ACT_ITM_ID)
             ) T4
ON      CONCAT(SUBSTR(C.zhngjigo, 1, 7), C.huobdhao, '2', CASE
                                                            WHEN LENGTH(A.yeshux15) > 8 THEN T3.kemuhaoo
                                                            ELSE A.yeshux15
                                                          END, CASE
                                                                 WHEN LENGTH(A.yeshux15) > 8 THEN T3.zhanghxh
                                                                 ELSE '00001'
                                                               END) = T4.int_act_id
AND     B.DT = T4.DT
LEFT JOIN    (
                 SELECT  A2.dt --日期
                         ,A2.LGP_ID --法人代码
                         ,A2.ACT_ID --内部账号
                         ,A2.CCY_CD --货币代码
                         ,TRIM(A2.ACT_ORG) --核算机构编号
                         ,SUM(CASE
                                WHEN A2.CRD_AND_DBT_IND = 'D' THEN A2.BOK_ENTR_AMT
                                ELSE 0
                              END) AS JIE_CUR_AMT --本日借方发生额 0借 D
                         ,SUM(CASE
                                WHEN A2.CRD_AND_DBT_IND = 'C' THEN A2.BOK_ENTR_AMT
                                ELSE 0
                              END) AS DAI_CUR_AMT --本日贷方发生额 1贷 C
                 FROM    edw.DWD_BUS_ACT_INT_ACT_TRX_DTL_DI A2 --内部账户交易明细
                 WHERE   A2.dt IN ( '20210331' , '20210630' , '20210930' , '20211231' , '20220331' , '20220630' , '20220930' , '20221231' , '20230331' , '20230630' , '20230930' , '20231231' , '20240331' )
                 AND     A2.TRX_DT IN('20210331', '20210630', '20210930', '20211231', '20220331', '20220630', '20220930', '20221231', '20230331', '20230630', '20230930', '20231231', '20240331')
                 AND     A2.SMR_DSCR <> 'GL0666' --损益类账户剔除年终结转
                 GROUP BY A2.dt , A2.LGP_ID , A2.ACT_ID , A2.CCY_CD , TRIM(A2.ACT_ORG)
             ) T6
ON      CONCAT(SUBSTR(C.zhngjigo, 1, 7), C.huobdhao, '2', CASE
                                                            WHEN LENGTH(A.yeshux15) > 8 THEN T3.kemuhaoo
                                                            ELSE A.yeshux15
                                                          END, CASE
                                                                 WHEN LENGTH(A.yeshux15) > 8 THEN T3.zhanghxh
                                                                 ELSE '00001'
                                                               END) = T6.ACT_ID
AND     B.DT = T6.DT
LEFT JOIN    (
                 SELECT  T3.customerid
                         ,T3.farmer
                 FROM    (
                             SELECT  T1.customerid
                                     ,T1.farmer
                             FROM    edw.loan_ind_info T1 --个人信息表,farmer,1是，2和0是否
                             WHERE   T1.dt = '20240331'
                             UNION
                             SELECT  T2.customerid
                                     ,T2.farmer
                             FROM    edw.loan_ent_info T2 --企业信息表,farmer,1是，2和0是否
                             WHERE   T2.dt = '20240331'
                         ) T3  --判断是否农户
             ) T5
ON      c.kehuhaoo = T5.customerid
WHERE   b.dt IN ( '20210331' , '20210630' , '20210930' , '20211231' , '20220331' , '20220630' , '20220930' , '20221231' , '20230331' , '20230630' , '20230930' , '20231231' , '20240331' )
AND     c.zhngjigo LIKE '3561%'--政和村行
;




-- SELECT count(*) FROM tmp_zc_SJ2024062811












--参考代码
-- select b.dkjiejuh 借据号
--        ,c.hetongbh  合同号
--        ,c.hetongje 合同金额
--        ,c.fafangje 已发放金额
--        ,c.kehuhaoo 客户号
--        ,c.kehmingc 客户名称
--        ,c.yngyjigo --营业机构
--        ,c.zhngjigo  --账务机构
--        ,c.dkzhangh  --贷款账号
-- from edw.core_klnb_dkkjsx b   --贷款账户会计核算表
-- left join edw.core_klna_dkzhzb c --贷款账户主表,合同号，客户号，客户名称，
-- on b.dkjiejuh=c.dkjiejuh
-- and c.dt='20240331'
-- where b.dt='20240331'
-- and b.yewusx01 in
--  (select substr(a.yewubima,3)
--   from edw.core_kfap_yeshux a  --余额属性参数表
--   where a.dt='20240331'
--   and a.mokuaiii='LN'
--   and(a.yeshux15 in ('60110104','60110107','60110110','60110113')
--   or substr(a.yeshux15,6,8) in ('60110104','60110107','60110110','60110113')
--   ))
-- and c.zhngjigo like '3561%'  --政和村行
-- ;
**01-数据需求_村行_SJ2024070136_政和村行_张弛_泰隆一本通_含新泰隆一本通_成长乐_旧成长乐的存款数据.sql
-- 客户号、客户名称、客户账号、余额 、管户机构、管户客户经理、起息日、到期日
-- 2017年11月20日-2024年6月30日泰隆一本通（含新泰隆一本通）、成长乐、旧成长乐的存款数据

-- 00201030303	新泰隆一本通
-- 00201030304	泰隆一本通
-- 00201020105	新成长乐
-- 00201030502	成长乐


DROP TABLE IF EXISTS lab_bigdata_dev . tmp_zh_ck_SJ2024070136_01 PURGE ;

CREATE TABLE lab_bigdata_dev.tmp_zh_ck_SJ2024070136_01 AS
SELECT  T1.cst_id      AS 客户号
        ,T1.act_nm     AS 客户名称
        ,T1.cst_act_id AS 客户账号
        ,T1.dep_act_id AS 存款账号
        ,T1.gl_bal     AS 余额
        ,T2.acs_org_id AS 管户机构号
        ,T3.org_nm     AS 管户机构
        ,T2.mgr_id     AS 管户客户经理工号
        ,T4.empe_nm    AS 管户客户经理
        ,T1.int_val_dt AS 起息日
        ,T1.mtu_dt     AS 到期日
        ,T5.pd_cmt     AS 存款产品
        -- ,T5.pd_cmpn_cmt AS 产品营销说明
FROM    edw.dws_bus_dep_act_inf_dd T1 --存款账户信息汇总
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T2 --客户存款账户管护信息
ON      T1.cst_act_id = T2.cst_act_id
AND     T2.frs_ctc_ind = '1'
AND     T2.DT = '20240630'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.acs_org_id = T3.org_id
AND     T3.DT = '20240630'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T2.mgr_id = T4.empe_id
AND     T4.DT = '20240630'
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd T5 --存款产品基础信息表
ON      T1.prod_id = T5.pd_id
AND     T5.DT = '20240630'
WHERE   T1.DT = '20240630'
AND     T1.opn_dt >= '20171120'
AND     T1.opn_dt <= '20240630'
AND     T1.prod_id IN ( '00201030303' , '00201030304' , '00201020105' , '00201030502' )
AND     T2.acs_org_id LIKE '3561%'  --政和村行
;


-- SELECT count(*) FROM lab_bigdata_dev.tmp_zh_ck_SJ2024070136_01;
**01-数据需求_村行_SJ2024070571_庆元村行_吴美健_客户20240101_20240630催收走访记录.sql
--2024年上半年（20240101-20240630）庆元村行催收走访记录庆元村行催收走访记录
--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024070571 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024070571 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2024-01-01 00:00:00' and '2024-06-30 23:59:00'
;



-- SELECT count(*) FROM lab_bigdata_dev.tmp_sjxq_SJ2024070571
-- ;
**01-数据需求_村行_SJ2024070801_大冶村行_富林_全量增值税清单.sql
--	SJ2024070801
-- 2024年4月1日-2024年6月30日机构代码4261（大冶村行）计提增值税的贷款清单，清单范围为全量增值税清单，数据需要和增值税管理系统0707报表一致

--机构号、客户号、客户名称、客户类型、授信总额、合同编号、合同金额、借据号、借据金额、借据余额、subject、税码、应税销售额、销项税额、利息减免金额（如有）
--贷款投向（用途）、客户经营地、客户户籍地、客户居住地（判断是否为农户的重要依据）


DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_01 ;

-- 机构号、客户号、客户名称、客户类型、授信总额、合同编号、合同金额、借据号、借据金额、借据余额、subject、税码、应税销售额、销项税额
CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_01 AS
SELECT  T1.org --机构号
        ,T1.PERIOD_YEAR --年度
        ,T1.PERIOD_QUARTER --季度
        ,T1.tran_date --交易日期
        ,T1.tran_num --交易流水号
        ,T1.tran_line_num --流水行号
        ,CASE
           WHEN substr(T1.tran_num, 1, 1) <> 'G' THEN CONCAT(concat(substr(T1.tran_date, 1, 4), substr(T1.tran_date, 6, 2), substr(T1.tran_date, 9, 2)), T1.tran_num, T1.tran_line_num)
           ELSE CONCAT(concat(substr(T1.tran_date, 1, 4), substr(T1.tran_date, 6, 2), substr(T1.tran_date, 9, 2)), substr(T1.tran_num, 2, 100), T1.tran_line_num)
         END PPP --日期+流水+行号（与凭证表匹配客户/借据）
        ,CASE
           WHEN substr(T1.tran_num, 1, 1) <> 'G' THEN CONCAT(concat(substr(T1.tran_date, 1, 4), substr(T1.tran_date, 6, 2), substr(T1.tran_date, 9, 2)), T1.tran_num)
           ELSE CONCAT(concat(substr(T1.tran_date, 1, 4), substr(T1.tran_date, 6, 2), substr(T1.tran_date, 9, 2)), substr(T1.tran_num, 2, 100))
         END PP --日期+流水（与凭证表匹配客户/借据）
        ,T1.SUBJECT --科目号
        ,T1.SEGMENT3 --余额属性
        ,T1.ATTRIBUTE7 --LN92
        ,T1.rate_code --税码
        ,T2.dc_flag --借贷方
        ,T1.fun_sales --本币应税销售额
        ,T1.fun_out_taxes ---本币销项税额
        ,T1.tran_detail_id --来源交易明细ID
FROM    edw.vats_vat_output_detail T1 --销项明细表
LEFT JOIN    edw.vats_vat_tran_detail T2 --交易明细表
ON      T1.tran_detail_id = T2.id
AND     T2.dt >= '20240401'
AND     T2.dt <= '20240630'
WHERE   T1.divide_flag = 'H' --核心计税（贷款及贸易融资）
AND     T1.dt >= '20240401'
AND     T1.dt <= '20240630'
AND     SUBSTR(T1.SUBJECT, 1, 4) <> '1132' --剔除同业存放
AND     SUBSTR(T1.org, 1, 4) ='4261'  --限定大治村行
;

DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_02;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_02 AS
SELECT  T1.org --机构号
        ,T1.tran_date --交易日期
        ,T1.tran_num --交易流水号
        ,T1.tran_line_num --流水行号
        ,T2.cst_id --客户号
        ,T2.cst_nm --客户名称
        ,T2.act_nbr --借据号
        ,T1.SUBJECT --科目号
        ,T1.SEGMENT3 --余额属性
        ,T1.ATTRIBUTE7 --LN92
        ,T1.rate_code --税码
        ,T1.dc_flag --借贷方
        ,T1.fun_sales --本币应税销售额
        ,T1.fun_out_taxes ---本币销项税额
FROM    lab_bigdata_dev.sjxq_SJ2024070801_case5_01 T1
LEFT JOIN    edw.dwd_bus_act_gl_srl_dtl_di T2  --会计总账凭证流水明细
ON      T1.PPP = CONCAT(T2.trx_dt, T2.trx_srl, T2.bok_entr_vch_seq_nbr)
AND     T2.dt >= '20240401'
AND     T2.dt <= '20240630';


DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_03;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_03 AS
SELECT  T1.org --机构号
        ,T1.tran_date --交易日期
        ,T1.tran_num --交易流水号
        ,T1.tran_line_num --流水行号
        ,T1.cst_id --客户号
        ,T1.cst_nm --客户名称
        ,T2.loan_dbil_id --借据号
        ,T1.SUBJECT --科目号
        ,T1.SEGMENT3 --余额属性
        ,T1.ATTRIBUTE7 --LN92
        ,T1.rate_code --税码
        ,T1.dc_flag --借贷方
        ,T1.fun_sales --本币应税销售额
        ,T1.fun_out_taxes ---本币销项税额
FROM    lab_bigdata_dev.sjxq_SJ2024070801_case5_02 T1
LEFT JOIN    (
                 SELECT  DISTINCT loan_act_id
                                  ,loan_dbil_id
                 FROM    edw.dwd_bus_loan_act_trx_dtl_di --贷款账户交易明细
                 WHERE   dt <= '20240630'
             ) T2
ON      T1.act_nbr = T2.loan_act_id;

-- 机构号、客户号、客户名称、客户类型、授信总额、合同编号、合同金额、借据号、借据金额、借据余额、subject、税码、应税销售额、销项税额
DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_end;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_end AS
SELECT  T1.org 机构号
        -- ,T1.tran_date --交易日期
        -- ,T1.tran_num --交易流水号
        -- ,T1.tran_line_num --流水行号
        ,T1.cst_id 客户号
        ,T1.cst_nm 客户名称
        ,CASE
           WHEN T3.FARMER = '1' AND nvl(T3.isindindustry, '2') <> '1' THEN '农户'
           WHEN nvl(T3.isindindustry, '2') = '1'                      THEN '个体工商户主'
           WHEN T5.loan_cst_typ_cd = '0103'                           THEN ' 对公个体工商户'
           WHEN T4.SCOPE = '4'                                        THEN '小型企业'
           WHEN T4.SCOPE = '5'                                        THEN '微型企业'
           ELSE '其他'
         END 客户类型
        ,T6.bus_ctr_id 合同编号
        ,T6.ctr_amt 合同金额
        ,T1.loan_dbil_id 借据号
        ,T6.amt 借据金额
        ,T6.prcp_bal 借据余额
        ,T1.SUBJECT  --科目号
        -- ,T1.SEGMENT3 --余额属性
        -- ,T1.ATTRIBUTE7 --LN92
        ,T1.rate_code 税码
        -- ,T1.dc_flag --借贷方
        ,sum(T1.fun_sales) 应税销售额
        ,sum(T1.fun_out_taxes) 销项税额
FROM    lab_bigdata_dev.sjxq_SJ2024070801_case5_03 T1
LEFT JOIN    edw.LOAN_IND_INFO T3 --个人客户基本信息表
ON      T1.cst_id = T3.customerid
AND     T3.dt = '20240630'
LEFT JOIN    edw.LOAN_ENT_INFO T4 --对公客户基本信息表
ON      T1.cst_id = T4.customerid
AND     T4.dt = '20240630'
LEFT JOIN    edw.DIM_CST_BAS_INF_DD T5 --客户基本信息表
ON      T1.cst_id = T5.cst_id
AND     T5.dt = '20240630'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd T6 --贷款借据信息汇总
ON      T1.loan_dbil_id = T6.dbil_id
AND     T6.dt = '20240630'
LEFT JOIN  EDW.LOAN_ENT_INFO T7 --对公客户基本信息表
ON T1.CST_ID = T7.CUSTOMERID
AND T7.DT = '20240630'
GROUP BY T1.org , T1.cst_id , T1.cst_nm , T3.FARMER , T3.isindindustry , T5.loan_cst_typ_cd , T4.SCOPE , T6.bus_ctr_id , T6.ctr_amt , T1.loan_dbil_id , T6.amt , T6.prcp_bal , T1.SUBJECT , T1.rate_code;

--补充贷款投向（用途）、客户经营地、客户户籍地、客户居住地（判断是否为农户的重要依据）
DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_end_add;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024070801_case5_end_add AS
SELECT  t1 . *
        --,t2.dbil_id
        ,t2.loan_usg_cd  AS 贷款用途代码
        ,t3.cd_val_dscr  AS 贷款用途
        -- ,t2.exe_intr_rat AS 执行利率
        ,t4.wrk_adr      AS 工作单位地址_经营所在地地址
        ,t4.reg_adr      AS 户籍地址_注册地址
        ,t4.fml_adr      AS 家庭地址
FROM    lab_bigdata_dev.sjxq_SJ2024070801_case5_end t1
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd t2
ON      t1.借据号 = t2.dbil_id
AND     t2.dt = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd t3
ON      t2.loan_usg_cd = t3.cd_val
AND     t3.dt = '@@{yyyyMMdd}'
AND     t3.tbl_nm = TOUPPER('DIM_BUS_LOAN_CTR_INF_DD') ---要查的表名
AND     t3.fld_nm = TOUPPER('loan_usg_cd') ---要查的字段
LEFT JOIN    edw.dws_cst_bas_inf_dd t4  --客户基础信息汇总表
ON      t1.客户号 = t4.cst_id
AND     t4.dt = '@@{yyyyMMdd}'
-- WHERE   t1.subject IN ( '6011010400001' , '6011010400002' , '6011010400003' , '6011010700001' , '6011010700002' , '6011010700003' , '6011011000001' , '6011011000002' , '6011011000003' , '6011011300001' , '6011011300002' , '6011011300003' );
-- --限定农户
;

-- SELECT count(*) from lab_bigdata_dev.sjxq_SJ2024070801_case5_end_add
**01-数据需求_村行_SJ20240709141_村镇银行管理部_程义平_村行社区客户信息.sql
-- 对象：村行（子社区编号、子社区名称）
-- 时间：2024年7月10日较2024年2月29日
-- 净增值：净增FTP、净增存、贷规模、净增有效户、净增有效贷款户

-- 数据字段：客户编号、客户名称、机构（村行）、子社区、建档日期、挂靠日期、FTP、存款月日均、贷款月日均、是否有效户、是否有效贷款户。取的时间节点（2024年7月10日和2024年2月29日）


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_ch_sq_SJ20240709141_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_ch_sq_SJ20240709141_01 AS
SELECT  T1.cst_id                                                                         AS 客户编号
        ,T1.cst_nm                                                                        AS 客户名称
        ,T1.prm_org_id                                                                    AS 主管护机构号
        ,T1.prm_org_nm                                                                    AS 主管护机构名称
        ,T2.brc_org_id                                                                    AS 村行机构号
        ,T2.brc_org_nm                                                                    AS 村行名称
        ,T3.sub_cmnt_id                                                                   AS 子社区编号
        ,T3.sub_cmnt_nm                                                                   AS 子社区名称
        ,T4.file_dt                                                                       AS 建档日期
        ,SUBSTR(REPLACE(T3.dpd_tm, '-', ''), 1, 8)                                        AS 挂靠日期
        ,T5.cur_mon_ftp_inc                                                               AS 当月FTP利润收入_20240710
        ,T51.cur_mon_ftp_inc                                                              AS 当月FTP利润收入_20240229
        ,COALESCE(T5.cur_mon_ftp_inc, '0') - COALESCE(T51.cur_mon_ftp_inc, '0')           AS 净增FTP
        ,T6.dep_bal_mon_avg                                                               AS 存款月日均_20240710
        ,T61.dep_bal_mon_avg                                                              AS 存款月日均_20240229
        ,COALESCE(T6.dep_bal_mon_avg, '0') - COALESCE(T61.dep_bal_mon_avg, '0')           AS 净增存款月日均
        ,T7.loan_bal_acs_mon_avg                                                          AS 贷款月日均_20240710
        ,T71.loan_bal_acs_mon_avg                                                         AS 贷款月日均_20240229
        ,COALESCE(T7.loan_bal_acs_mon_avg, '0') - COALESCE(T71.loan_bal_acs_mon_avg, '0') AS 净增贷款月日均
        ,CASE
           WHEN T8.efe_cst_ind = '1' THEN '1'
           ELSE 0
         END                                                                              AS 是否有效户_20240710
        ,CASE
           WHEN T81.efe_cst_ind = '1' THEN '1'
           ELSE 0
         END                                                                              AS 是否有效户_20240229
        -- ,CASE
        --    WHEN T8.efe_cst_ind = '1' AND COALESCE(T81.efe_cst_ind, '') <> '1' THEN 1 --20240710是 20240229不是 则加1
        --    WHEN T8.efe_cst_ind <> '1' AND COALESCE(T81.efe_cst_ind, '') = '1'  THEN - 1 --20240710不是 20240229是 则减1
        --    ELSE 0 --其它0
        --  END                                                                              AS 有效户净增值
        ,CASE
           WHEN T8.efe_loan_cst_ind = '1' THEN '1'
           ELSE 0
         END                                                                              AS 是否有效贷款户_20240710
        ,CASE
           WHEN T81.efe_loan_cst_ind = '1' THEN '1'
           ELSE 0
         END                                                                              AS 是否有效贷款户_20240229
        -- ,CASE
        --    WHEN T8.efe_loan_cst_ind = '1' AND COALESCE(T81.efe_loan_cst_ind, '') <> '1' THEN 1 --20240710是 20240229不是 则加1
        --    WHEN T8.efe_loan_cst_ind <> '1' AND COALESCE(T81.efe_loan_cst_ind, '') = '1'  THEN - 1 --20240710不是 20240229是 则减1
        --    ELSE 0 --其它0
        --  END                                                                              AS 有效贷款户净增值
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T2 --机构树_考核维度
ON      T1.prm_org_id = T2.org_id
AND     T2.DT = '20240710'
LEFT JOIN    edw.dwd_cst_mng_cmnt_rel_dd T3 --客户社区信息
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20240710'
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20240710'
LEFT JOIN    adm_pub.adm_csm_cbus_ftp_inf_dd T5 --客户集市-业务信息-客户FTP业务   --20240710
ON      T1.cst_id = T5.cst_id
AND     T5.DT = '20240710'
LEFT JOIN    adm_pub.adm_csm_cbus_ftp_inf_dd T51 --客户集市-业务信息-客户FTP业务  --20240229
ON      T1.cst_id = T51.cst_id
AND     T51.DT = '20240229'
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd T6 --客户集市-业务信息-客户存款业务信息表  --20240710
ON      T1.cst_id = T6.cst_id
AND     T6.DT = '20240710'
LEFT JOIN    adm_pub.adm_csm_cbus_dep_inf_dd T61 --客户集市-业务信息-客户存款业务信息表  --20240229
ON      T1.cst_id = T61.cst_id
AND     T61.DT = '20240229'
LEFT JOIN    adm_pub.adm_csm_cbus_loan_inf_dd T7 --客户集市-业务信息-客户贷款业务信息表  --20240710
ON      T1.cst_id = T7.cst_id
AND     T7.DT = '20240710'
LEFT JOIN    adm_pub.adm_csm_cbus_loan_inf_dd T71 --客户集市-业务信息-客户贷款业务信息表  --20240229
ON      T1.cst_id = T71.cst_id
AND     T71.DT = '20240229'
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T8 --客户集市-基础信息-客户基础标识信息  --20240710
ON      T1.cst_id = T8.cst_id
AND     T8.DT = '20240710'
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T81 --客户集市-基础信息-客户基础标识信息  --20240229
ON      T1.cst_id = T81.cst_id
AND     T81.DT = '20240229'
WHERE   T1.DT = '20240710'
AND     T2.cpy_org_id = '999999997' --村行
and     T8.efe_cst_ind = '1'    --20240710,有效户是1
;





desc app_iftp.adm_papp_ftp_eva_acct_summ_rst_inf   --存贷款客户账户级汇总数据信息表

| data_dt         | string     | 1     | 数据日期                                        |
| acct_no         | string     | 3     | 账号                                          |
| freq_dt         | string     |       | 频率                                          |
| cust_id         | string     |       | 客户号                                         |
| cust_nm         | string     | 3     | 客户名称                                        |
| ctr_id          | string     |       | 合同号                                         |
| t_acct_no       | string     | 3     | 源账号                                         |
| ccy_cd          | string     |       | 币种                                          |
| conv_rmb_rate   | decimal    |       | 转人民币汇率                                      |
| prod_cd         | string     |       | 产品编码                                        |
| prod_nm         | string     |       | 产品名称                                        |
| mgr_no          | string     |       | 客户经理编号                                      |
| mgr_nm          | string     | 2     | 客户经理名称                                      |
| assess_org_cd   | string     |       | 考核机构号                                       |
| assess_org_nm   | string     |       | 考核机构名称                                      |
| start_dt        | string     |       | 起息日                                         |
| maturity_dt     | string     |       | 到期日                                         |
| cur_bal         | decimal    | 3     | 当前余额                                        |
| avg_bal         | decimal    |       | 日均余额                                        |
| exercise_interest_rate | decimal    |       | 执行利率                                        |
| cust_interest_rate | decimal    |       | 对客利率                                        |
| cust_accint     | decimal    |       | 对客利息                                        |
| is_offset       | string     |       | 利息冲减标识                                      |
| is_odue         | string     |       | 是否逾期                                        |
| cap_cost_type   | string     |       | 资本成本占用类型                                    |
| ftp_rate_sd     | decimal    |       | FTP利率-时点-核算                                 |
| ftp_rate_fs     | decimal    |       | FTP利率-反算-核算                                 |
| ftp_accint      | decimal    |       | FTP利息-核算                                    |
| org_ftp_rate_sd | decimal    |       | FTP利率-时点-机构考核                               |
| org_ftp_rate_fs | decimal    |       | FTP利率-反算-机构考核                               |
| org_ftp_accint  | decimal    |       | FTP利息-机构考核                                  |
| org_ftp_spread  | decimal    |       | FTP利差-机构考核                                  |
| org_ftp_bus_inc | decimal    |       | FTP营收-机构考核                                  |
| org_dep_insu_rate_sd | decimal    |       | 存款保险费率-时点-机构考核                              |
| org_dep_insu    | decimal    |       | 存款保险费-机构考核                                  |
| org_ln_trx_cost_rate_sd | decimal    |       | 免税额加回率-时点-机构考核                              |
| org_ln_trx_cost_rate_fs | decimal    |       | 免税额加回率-反算-机构考核                              |
| org_ln_trx_cost | decimal    |       | 免税额加回-机构考核                                  |
| cap_cost_rate_sd | decimal    |       | 资本成本率-时点-核算                                 |
| cap_cost_rate_fs | decimal    |       | 资本成本率-反算-核算                                 |
| cap_cost        | decimal    |       | 资本成本-核算                                     |
| org_cap_cost_rate_sd | decimal    |       | 资本成本率-时点-机构考核                               |
| org_cap_cost_rate_fs | decimal    |       | 资本成本率-反算-机构考核                               |
| org_cap_cost    | decimal    |       | 资本成本-机构考核                                   |
| org_ec_profit_spread_d | decimal    |       | 经济利润利差-机构考核-当前值                             |
| org_ec_profit_spread | decimal    |       | 经济利润利差-机构考核-累计值                             |
| org_ec_profit_d | decimal    |       | 最终经济利润-机构考核-当前值                             |
| org_ec_profit   | decimal    |       | 最终经济利润-机构考核-累计值                             |
| dt              | string     |       | 日期分区                                        |
**01-数据需求_村行_SJ20240709141_程义平_村行客户社区信息.sql
-- 对象：村行（子社区编号、子社区名称）
-- 时间：2024年7月10日较2024年2月29日
-- 净增值：净增FTP、净增存、贷规模、净增有效户、净增有效贷款户

-- 数据字段：客户编号、客户名称、机构（村行）、子社区、建档日期、挂靠日期、FTP、存款月日均、贷款月日均、是否有效户、是否有效贷款户。取的时间节点（2024年7月10日和2024年2月29日）

--20240229
DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240229 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240229 as
SELECT T1.cst_id 客户号
       ,T1.cst_nm 客户名称
    --    ,T1.lgp_id 法人编号
    --    ,T1.lgl_org_id 总行机构编号
    --    ,T1.lgl_org_nm 总行机构名称
       ,T1.brn_org_id 机构编号
       ,T1.brn_org_nm 机构名称
       ,T2.new_com_code 子社区编号
       ,T2.new_com_name 子社区名称
        ,T4.brc_org_id 社区所属机构编号
       ,T4.brc_org_nm	 社区所属机构名称
       ,T2.crt_dt 建档日期
       ,T2.new_com_put_up_date 子社区挂靠时间
       ,T1.ftp_year_pft FTP年累计
       ,T1.ftp_mon_pft FTP月累计
       ,T1.dep_mon_avg_bal 存款月日均
       ,T1.ln_mon_avg_bal 本行贷款当月月日均
       ,T1.vld_cst_ind 有效户标识
       ,T1.vld_ln_cst_ind 有效贷款户标识
       ,T1.acg_dt 会计日期
FROM app_ado.adm_subl_cst_bus_inf_dd T1  --客户业务信息汇总表
left join app_ado.FCT_CST_SMY_DD  T2 --客户信息汇总表
ON  T1.cst_id=T2.cst_id
and T2.dt='20240229'
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON   T2.new_com_code = T3.cmnt_enc
and T3.dt='20240229'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON   T3.afl_org_id = T4.org_id
and T4.dt='20240229'
-- left JOIN app_ado.ADM_HR_ORG_PATH_INF_KH T3  --多维度机构关系信息-考核
-- on T1.brn_org_id=T3.org_id
-- and T3.dt='20240229'
where T1.dt='20240229'
-- and T1.brn_org_nm like '%村镇%'
and T1.lgl_org_id= '999999997'   --村行
-- and T1.cst_id in('7601828980','7005262420')
;



----20240718
DROP TABLE IF EXISTS tmp_cyp_SJ20240709141_20240718 PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240718 AS
SELECT  T1.cst_id 客户号
        ,T1.cst_nm 客户名称
        --    ,T1.lgp_id 法人编号
        --    ,T1.lgl_org_id 总行机构编号
        --    ,T1.lgl_org_nm 总行机构名称
        ,T1.brn_org_id 机构编号
        ,T1.brn_org_nm 机构名称
        ,T2.new_com_code 子社区编号
        ,T2.new_com_name 子社区名称
        ,T4.brc_org_id 社区所属机构编号
        ,T4.brc_org_nm 社区所属机构名称
        ,T2.crt_dt 建档日期
        ,T2.new_com_put_up_date 子社区挂靠时间
        ,T1.ftp_year_pft FTP年累计
        ,T1.ftp_mon_pft FTP月累计
        ,T1.dep_mon_avg_bal 存款月日均
        ,T1.ln_mon_avg_bal 本行贷款当月月日均
        ,T1.vld_cst_ind 有效户标识
        ,T1.vld_ln_cst_ind 有效贷款户标识
        ,T1.acg_dt 会计日期
FROM    app_ado.adm_subl_cst_bus_inf_dd T1 --客户业务信息汇总表
LEFT JOIN    app_ado.FCT_CST_SMY_DD T2 --客户信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20240718'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON      T2.new_com_code = T3.cmnt_enc
AND     T3.dt = '20240718'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T3.afl_org_id = T4.org_id
AND     T4.dt = '20240718'
WHERE   T1.dt = '20240718'
AND    T1.lgl_org_id= '999999997'  --村行
;



-- 筛选出当前时间节点为建档0229（含）之前，但挂靠时间是0229以后（不含），这部分客户清单匹配0229客户清单，用子社区编号匹配：
-- 1.未匹配上，不处理  2.匹配上，且于0229子社区编号一致，不出来  3.匹配上，但与0229子社区编号不一致，需要算出客户的净增值，进行剔除

DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240718_0731 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240718_0731 as
SELECT
      T1.客户号   AS 0718客户号
	 ,T1.客户名称   AS 0718客户名称
	 ,T1.机构编号   AS 0718机构编号
	 ,T1.机构名称   AS 0718机构名称
	 ,T1.子社区编号   AS 0718子社区编号
	 ,T1.子社区名称   AS 0718子社区名称
	 ,T1.社区所属机构编号   AS 0718社区所属机构编号
	 ,T1.社区所属机构名称    AS 0718社区所属机构名称
	 ,T1.建档日期   AS 0718建档日期
	 ,T1.子社区挂靠时间   AS 0718子社区挂靠时间
	 ,T1.FTP年累计   AS 0718FTP年累计
	 ,T1.FTP月累计    AS 0718FTP月累计
	 ,T1.存款月日均   AS 0718存款月日均
	 ,T1.本行贷款当月月日均   AS 0718本行贷款当月月日均
	 ,T1.有效户标识   AS 0718有效户标识
	 ,T1.有效贷款户标识   AS 0718有效贷款户标识
	 ,T1.会计日期   AS 0718会计日期
     ,T2.客户号   AS 0229客户号
	 ,T2.客户名称   AS 0229客户名称
	 ,T2.机构编号   AS 0229机构编号
	 ,T2.机构名称   AS 0229机构名称
	 ,T2.子社区编号   AS 0229子社区编号
	 ,T2.子社区名称   AS 0229子社区名称
	 ,T2.社区所属机构编号   AS 0229社区所属机构编号
	 ,T2.社区所属机构名称    AS 0229社区所属机构名称
	 ,T2.建档日期   AS 0229建档日期
	 ,T2.子社区挂靠时间   AS 0229子社区挂靠时间
	 ,T2.FTP年累计   AS 0229FTP年累计
	 ,T2.FTP月累计    AS 0229FTP月累计
	 ,T2.存款月日均   AS 0229存款月日均
	 ,T2.本行贷款当月月日均   AS 0229本行贷款当月月日均
	 ,T2.有效户标识   AS 0229有效户标识
	 ,T2.有效贷款户标识   AS 0229有效贷款户标识
	 ,T2.会计日期	    AS 0229会计日期
FROM tmp_cyp_SJ20240709141_20240718 T1
INNER JOIN tmp_cyp_SJ20240709141_20240229 T2
ON  T1.客户号 = T2.客户号
AND T1.子社区编号 <> T2.子社区编号
WHERE T1.建档日期 <='20240229'
AND   SUBSTR(REPLACE(T1.子社区挂靠时间,'-',''),1,8) >'20240229'
;





----------------------------------------------------------------------------
----------------------------------------------------------------------------20240805
--第一步：全量客户层级清单&mdash;&mdash;算出单个客户净增值&mdash;&mdash;然后子社区透视算出净增值

--客户净增
DROP TABLE IF EXISTS tmp_cyp_SJ20240709141_20240805_01 PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240805_01 AS
SELECT  T1.子社区编号
        ,T1.子社区名称
		,T1.客户号
        ,COALESCE(T1.FTP年累计, 0) - COALESCE(T2.FTP年累计, 0)       AS 净增FTP_年
        ,COALESCE(T1.FTP月累计, 0) - COALESCE(T2.FTP月累计, 0)       AS 净增FTP_月
        ,COALESCE(T1.存款月日均, 0) - COALESCE(T2.存款月日均, 0)         AS 净增存款月日均
        ,COALESCE(T1.本行贷款当月月日均, 0) - COALESCE(T2.本行贷款当月月日均, 0) AS 净增贷款月日均
        ,CASE
           WHEN T1.有效户标识 = '1' AND COALESCE(T2.有效户标识, '') <> '1' THEN 1
           WHEN T1.有效户标识 <> '1' AND COALESCE(T2.有效户标识, '') = '1' THEN - 1
           ELSE 0
         END                                                   AS 有效户净增值
        ,CASE
           WHEN T1.有效贷款户标识 = '1' AND COALESCE(T2.有效贷款户标识, '') <> '1' THEN 1
           WHEN T1.有效贷款户标识 <> '1' AND COALESCE(T2.有效贷款户标识, '') = '1' THEN - 1
           ELSE 0
         END                                                   AS 有效贷款户净增值
FROM    tmp_cyp_SJ20240709141_20240718 T1
INNER JOIN    tmp_cyp_SJ20240709141_20240229 T2
ON      T1.客户号 = T2.客户号;


-- 第二步：需要提出特殊情况，具体如下，
-- 在当前客户级全量清单中筛选出建档0229（含）之前，但挂靠时间是0229以后（不含）客户，这部分客户清单去匹配0229客户清单，用子社区编号匹配：
-- 1.未匹配上，不处理  2.匹配上，且于0229子社区编号一致，不处理  3.匹配上，但与0229子社区编号不一致，需要算出客户的净增值，进行剔除

--结果表
DROP TABLE IF EXISTS tmp_cyp_SJ20240709141_20240805_02 PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240805_02 AS
SELECT  T1.子社区编号
        ,T1.子社区名称
        ,SUM(T1.净增FTP_年)  AS 净增FTP_年
        ,SUM(T1.净增FTP_月)  AS 净增FTP_月
        ,SUM(T1.净增存款月日均)  AS 净增存款月日均
        ,SUM(T1.净增贷款月日均)  AS 净增贷款月日均
        ,SUM(T1.有效户净增值)   AS 有效户净增值
        ,SUM(T1.有效贷款户净增值) AS 有效贷款户净增值
FROM    tmp_cyp_SJ20240709141_20240805_01 T1
LEFT JOIN    (
                  SELECT  DISTINCT T1.客户号
                  FROM    tmp_cyp_SJ20240709141_20240718 T1
                  INNER JOIN    tmp_cyp_SJ20240709141_20240229 T2
                  ON      T1.客户号 = T2.客户号
                  AND     T1.子社区编号 <> T2.子社区编号
                  WHERE   T1.建档日期 <= '20240229'
                  AND     SUBSTR(REPLACE(T1.子社区挂靠时间, '-', ''), 1, 8) > '20240229'
              ) T2
ON      T1.客户号 = T2.客户号
WHERE   T2.客户号 IS NULL  --剔除特殊部分
GROUP  BY T1.子社区编号 ,T1.子社区名称
**01-数据需求_村行_SJ2024071266_龙海村行_赵凯丽_分析新增客户是否符合相关业务准入标准.sql
--龙海村行
-- 抓取附件名单内客户在龙海泰隆最新的授信总额、授信余额、随贷通卡授信总额、随贷通卡授信余额、
-- 征信分、现有贷款机构家数、我行历史逾期次数、该客户项下强关联客户对象（父母、配偶、子女、名下企业、企业法定代表人、合伙人等）。


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_longhai_SJ2024071266_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_longhai_SJ2024071266_01
 (
   管户机构     STRING
   ,管户人      STRING
   ,客户号      STRING
   ,客户名称    STRING
 ) ;


INSERT INTO lab_bigdata_dev.tmp_longhai_SJ2024071266_01  VALUES
 ('356300111','林明珠','7635372804','林良云')
,('356300111','庄晓倩','7652405082','罗碧芳')
,('356300111','林明珠','1721226065','高智伟')
,('356300111','庄晓倩','7721062496','陈秋容')
,('356300111','林明珠','7679396160','周铭勇')
,('356300111','林明珠','1605586481','林伟杰')
,('356300111','林明珠','1605445649','施章孝')
,('356300111','林明珠','1605467908','黄密丽')
,('356300111','黄宇','7717900695','蔡慈勇')
,('356300111','林明珠','1615197887','施文传')
,('356300111','林明珠','1616660426','余梅英')
,('356300111','林明珠','7615593508','王兰珍')
,('356300111','林明珠','7639117643','郑志强')
,('356300111','林明珠','7676179518','陈小平')
,('356300111','林明珠','7689205908','陈晓健')
,('356300111','庄晓倩','7721048049','梁希红')
,('356300111','林明珠','7722150642','许鸿涓')
,('356300111','王瑞岚','7720901493','黄亚国')
,('356300111','林明珠','1613029989','郭招平')
,('356300111','黄宇','1638121883','陈艳明')
,('356300111','林明珠','1679476091','黄碧珠')
,('356300111','林明珠','1605981667','赖建智')
,('356300111','林明珠','1679443626','林保鑫')
,('356300111','林明珠','1610612626','陈小惠')
,('356300111','庄晓倩','7677597156','王玉珍')
,('356300111','庄晓倩','7721663670','卢子衡')
,('356300111','庄晓倩','7721663596','林仙茂')
,('356300111','林明珠','1611347700','江初中')
,('356300112','徐明强','1606025140','叶永富')
,('356300112','张帅鹏','7720899656','高扬')
,('356300112','杨莹','1635997305','卓志坚')
,('356300112','谢舒雅','7721024128','许玉花')
,('356300112','黄玮娜','1610167348','黄天辉')
,('356300112','张帅鹏','7718797662','陈木坤')
,('356300112','张帅鹏','7722065560','刘聪斌')
,('356300112','徐明强','1650758837','李委承')
,('356300112','徐明强','1605481592','叶永祝')
,('356300112','杨莹','7693097240','陈国兴')
,('356300112','谢舒雅','7721187629','许友义')
,('356300112','徐明强','1608707771','黄进福')
,('356300112','杨莹','1640443204','陈锦伟')
,('356300112','徐明强','1626237218','徐国文')
,('356300112','杨莹','7693106490','李卫端')
,('356300112','杨莹','7720906484','卓小小')
,('356300112','徐明强','1677396715','李志发')
,('356300112','杨莹','1620017156','卓俊杰')
,('356300112','黄玮娜','7645020734','林秀云')
,('356300112','徐明强','7712415305','卓艺松')
,('356300112','杨莹','1611005021','王辉俊')
,('356300112','张帅鹏','7685023134','陈秋强')
,('356300112','徐明强','1613869659','陈艺坤')
,('356300112','张帅鹏','7720846244','严志彬')
,('356300112','徐明强','7712126876','陈少武')
,('356300112','徐明强','7721104858','李金玉')
,('356300113','陈建槐','1638074908','谢富鹏')
,('356300113','陈建槐','7720741836','张聪明')
,('356300113','林伟强','7643419892','郭志辉')
,('356300113','王倩倩','7653050174','郭星露')
,('356300113','曾煌伟','1654487270','庄宝珠')
,('356300113','曾煌伟','7695074366','林逢木')
,('356300113','王倩倩','7687554840','凤小伍')
,('356300113','曾煌伟','7690419371','林雅娜')
,('356300113','曾煌伟','7721274127','林庆麟')
,('356300113','曾煌伟','7720763352','郭爱国')
,('356300201','钱超燕','1635196130','林丽琴')
,('356300201','钱超燕','7695764850','张进利')
,('356300201','黄家真','7652770639','黄典松')
,('356300201','钱超燕','1612637170','林跃进')
,('356300201','林俊鹏','1656387359','吴跃辉')
,('356300201','钱超燕','1634599327','林中蕊')
,('356300201','黄家真','1652500343','王明东')
,('356300201','黄家真','1613309388','林永强')
,('356300201','钱超燕','7712892634','林玉典')
,('356300201','黄家真','1652597971','黄国成')
,('356300201','黄家真','1626648980','黄艺萍')
,('356300201','钱超燕','1612690121','林瑞泉')
,('356300201','钱超燕','7685710672','李建明')
,('356300201','林俊鹏','1641600393','李福彪')
,('356300201','黄家真','7721263529','黄国强')
,('356300201','林俊鹏','1649425205','许聪明')
,('356300201','钱超燕','1638243956','林远明')
,('356300201','林俊鹏','7704409649','黄永标')
,('356300201','林俊鹏','7710110159','黄天滨')
,('356300201','林金山','1671787383','许建坤')
,('356300201','黄家真','1652992659','洪国仁')
,('356300201','黄家真','1652620577','黄顺忠')
,('356300201','钱超燕','1639589736','陈春勇')
,('356300201','林俊鹏','1632885699','陈建辉')
,('356300201','钱超燕','7711080127','林佳寅')
,('356300201','黄家真','7689786202','苏锦华')
,('356300201','林金山','7720777838','康瑞福')
,('356300201','林俊鹏','1636852089','陈艺平')
,('356300201','黄家真','7712105319','潘勇辉')
,('356300201','郭小敏','1654417020','洪春亮')
,('356300201','钱超燕','1644523451','林远辉')
,('356300201','钱超燕','1614847803','林小洪')
,('356300201','黄家真','1654117131','黄文辉')
,('356300201','钱超燕','7720828058','梁立民')
,('356300201','钱超燕','1634377736','林爱兵')
,('356300201','黄家真','1640764590','林沐熹')
,('356300201','钱超燕','1677154634','林鸿禧')
,('356300201','林俊鹏','1627644191','许建河')
,('356300202','李立尔','7636062334','欧继乡')
,('356300202','纪涵尹','7721547166','黄秀美')
,('356300202','纪涵尹','7690394865','黄怀明')
,('356300202','李立尔','7636001001','方小花')
,('356300202','纪涵尹','7721066996','黄鹏')
,('356300202','纪涵尹','7721400620','郑春仔')
,('356300202','魏鑫泽','1651428731','林跃明')
,('356300202','纪涵尹','7721402864','许佳欣')
,('356300202','李立尔','7636003588','游东锋')
,('356300202','林东鹏','1652629476','黄连泉')
,('356300202','李立尔','7636064503','黄雪红')
,('356300202','李立尔','7641560195','林丽森')
,('356300202','纪涵尹','7721406442','黄原春')
,('356300202','纪涵尹','7720767038','黄怀忠')
,('356300301','郑炎成','7720883781','林百金')
,('356300301','郑炎成','7721018572','陈振加')
,('356300301','甘逸龙','1656321731','谢必文')
,('356300301','郑炎成','7722134628','陈丽宾')
,('356300301','甘逸龙','7720957416','何燕川')
,('356300301','郑炎成','7720700808','唐春霞')
,('356300301','郑炎成','7720882543','陈聪保')
,('356300301','甘逸龙','1668841140','曾继道')
,('356300301','高志伟','1721262434','许劭杰')
,('356300301','郑炎成','7720769927','何荣珠')
,('356300301','郑炎成','7714341489','陈艺辉')
,('356300301','郑炎成','7720697445','黄骏泽')
,('356300301','郑炎成','1680622997','高智宏')
,('356300301','郑炎成','7720903638','郑华纯')
,('356300302','刘洋洋','1618861750','黄加山')
,('356300302','许文权','7713875235','江惠远')
,('356300302','朱明杰','7690089887','黄明勇')
,('356300302','许文权','7710311089','苏世艺')
,('356300302','朱明杰','7720896514','江海德')
,('356300302','许文权','7719079672','颜玉帖')
,('356300302','蓝逸鹏','7693511494','蓝志贤')
,('356300302','蓝逸鹏','7721054433','蓝杏成')
,('356300302','许文权','7718666373','江聪慧')
,('356300302','蓝逸鹏','7722083060','何荣宗')
,('356300302','朱明杰','7722145623','高妙芬')
,('356300302','蓝逸鹏','7710561427','蓝素莲')
,('356300302','刘洋洋','7720977379','江庆祥')
,('356300302','朱明杰','7721144887','黄翠燕')
,('356300302','黄艺宏','7720164489','陈毅平')
,('356300302','朱明杰','7720953092','林宝俊')
,('356300302','蓝宗正','7722270616','朱龙辉')
,('356300302','蓝宗正','7705393398','蓝美华')
,('356300302','许文权','7721151950','李丽勤')
,('356300302','黄艺宏','7719898354','林国伟')
,('356300302','蓝逸鹏','7711784395','蓝河清')
,('356300302','蓝宗正','1635089908','李毅勇')
,('356300302','黄艺宏','7721238222','董清溪')
,('356300302','刘洋洋','1617468992','江聪平')
,('356300302','蓝逸鹏','7720767539','蓝康安')
,('356300302','蓝逸鹏','7720318252','蓝玉成')
,('356300302','许文权','7720697327','苏志聪')
,('356300302','许文权','7721047760','周文强')
,('356300302','蓝宗正','7720957026','张加贺')
,('356300302','朱明杰','7720688706','谢文珍')
,('356300302','朱明杰','7721694240','林添泉')
,('356300302','黄艺宏','7652723571','黄永川')
,('356300302','朱明杰','7720883670','林碧松')
,('356300302','朱明杰','7721061181','王建新')
,('356300302','黄艺宏','1615682874','程旺枝')
,('356300302','蓝宗正','1635093387','陈庆川')
,('356300302','蓝宗正','1631964541','朱勇煌')
,('356300302','朱明杰','7692534365','林巧玲')
,('356300302','许文权','7712131040','严健斌')
,('356300401','吴静宽','7720924932','林荣山')
,('356300401','吴静宽','7637780574','何明华')
,('356300401','吴静宽','7720568843','陈阳德')
,('356300401','吴静宽','7720177807','陈智勇')
,('356300401','吴静宽','7720246526','陈良金')
,('356300401','吴静宽','7720700418','陈丽山')
,('356300401','黄瑛珲','7720760318','沈丽滨')
,('356300401','吴静宽','7722360340','陈树林')
,('356300401','吴静宽','7722380558','陈荣三')
,('356300401','吴静宽','7719180313','陈坤华')
,('356300401','蔡雪惠','7721211080','张建明')
,('356300402','郭艺聪','1634834749','陈志佳')
,('356300402','严弘','7720825186','林艺明')
,('356300402','严弘','7721068166','郑淼财')
,('356300402','严弘','1606000314','郑爱群')
,('356300402','郭少聪','7694268252','郑锦江')
,('356300402','郭艺聪','1677578063','郑荣斌')
,('356300402','郭艺聪','1617368602','蔡庆丰')
,('356300402','郭艺聪','7671905987','洪沿泉')
,('356300402','郭艺聪','7720972973','朱剑峰')
,('356300402','郭少聪','7721210225','蔡伟龙')
;


-- 抓取附件名单内客户在龙海泰隆最新的授信总额、授信余额、随贷通卡授信总额、随贷通卡授信余额、
-- 征信分、现有贷款机构家数、我行历史逾期次数、该客户项下强关联客户对象（父母、配偶、子女、名下企业、企业法定代表人、合伙人等）。

--结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_longhai_SJ2024071266_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_longhai_SJ2024071266_02 AS
SELECT  A1.管户机构
        ,A1.管户人
        ,A1.客户号
        ,A1.客户名称
        ,A2.授信总额
        ,A2.授信余额
        ,A2.随贷通卡授信总额
        ,A2.随贷通卡授信余额
        ,greatest(A3.idv_crd_sco_val, A3.idv_crd_sco_val2)      AS 征信分
        ,A3.cred_busi_org_out_wjq AS 现有贷款机构家数_不含未激活
        ,A4.我行历史逾期借据数
        ,A6.cd_val_dscr           AS 关联关系类型
        ,A5.rel_cst_id            AS 关联客户编号
        ,A7.cst_chn_nm            AS 关联客户名称
FROM    lab_bigdata_dev.tmp_longhai_SJ2024071266_01 A1
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,SUM(T1.ctr_amt) AS 授信总额
                         ,SUM(T1.ctr_bal) AS 授信余额
                         ,SUM(CASE
                                WHEN T1.PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN T1.ctr_amt
                              END)        AS 随贷通卡授信总额
                         ,SUM(CASE
                                WHEN T1.PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN T1.ctr_bal
                              END)        AS 随贷通卡授信余额
                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD t1 --合同基础信息
                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD t2 --合同其它明细信息
                 ON      t1.CTR_SERNO = t2.CTR_SERNO
                 AND     t2.dt = '@@{yyyyMMdd}'
                 WHERE   t1.dt = '@@{yyyyMMdd}'
                 AND     t1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款
                 AND     ( t2.APLY_CHNL_CD <> 'L08'
                     OR t1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期
                 AND     t1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗
                 AND     t1.PRD_NO <> '2001010101010' --剔除百度分期贷
                 AND     ( t1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )
                     OR nvl(t1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷
                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0
                 AND     ( ( t1.CTR_STS_CD IN ( '2' , '4' )
                 AND     t1.TMT_DT = '18991231'
                 AND     to_date(t1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T1.DT, 'yyyyMMdd') )
                     OR t1.CTR_BAL > 0 )
                 GROUP BY t1.cst_id
             ) A2
ON      A1.客户号 = A2.cst_id
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd A3 --个人征信指标信息表,征信分：greatest(idv_crd_sco_val, idv_crd_sco_val2)
ON      A1.客户号 = A3.cst_id
AND     A3.report_dsc_rn = '1'
AND     A3.dt = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  t1.cst_id
                         ,COUNT(DISTINCT t1.dbil_id) AS 我行历史逾期借据数
                 FROM    edw.dws_bus_loan_dbil_inf_dd t1
                 WHERE   t1.DT = '@@{yyyyMMdd}'
                 AND     t1.ovd_day > 0
				 GROUP BY t1.cst_id
             ) A4
ON      A1.客户号 = A4.cst_id
LEFT JOIN    edw.dwd_cst_rel_inf_dd A5 --客户关联信息
ON      A1.客户号 = A5.cst_id
AND     A5.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dwd_code_library_dd A6 --码值表
ON      A5.rel_rel_cd = A6.cd_val
AND     A6.tbl_nm = 'DIM_CST_REL_INF_DD'
AND     A6.fld_nm = 'REL_TYP_CD'
AND     A6.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_bas_inf_dd A7 --客户基础信息汇总表
ON      A5.rel_cst_id = A7.cst_id
AND     A7.DT = '@@{yyyyMMdd}';

-- SELECT * FROM tmp_longhai_SJ2024071266_02
**01-数据需求_村行_SJ20240716146_村行管理部_程义平_用于分析村行新增小额信贷业务情况.sql
-- 目的：用于分析村行新增小额信贷业务情况
-- 统计时间：统计2024年7月1日&mdash;2024年7月10日
-- 对象：村行
-- 数据指标（户数）：1.首笔新增贷款户   2.新发放随贷通卡

-- 1.同一个客户项下合同总金额必须&le;50万元
-- 2.单个客户用信日均必须&ge;2万元（若以下情形，需卡月日均垫款&ge;2万元，即历史上有过贷款业务，7月1日后首次发放随贷通卡业务）
--3、需要增加一个同一风险控制号，比如客户A在我行有业务，但是其配偶首次办理，也不能属于首笔

--临时表1  客户首次信贷业务时间
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xexd_SJ20240716146_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xexd_SJ20240716146_01 AS
SELECT  A1.cst_id
        ,A1.最早办理普贷时间
        ,A1.最早办理随贷通时间
        ,A3.合同总金额
        ,A2.随贷通用信日均
        ,A1.最早办理信贷业务时间
        ,A21.贷款用信日均
		,A4.同一风险控制号最早办理普贷时间
		,A4.同一风险控制号最早办理随贷通时间
		,A4.同一风险控制号最早办理信贷业务时间
FROM    (
            SELECT  T1.cst_id
                    ,MIN(CASE
                           WHEN SUBSTR(T1.pd_cd, 1, 7) <> '2010503' THEN T1.apnt_start_dt --CTR_BGN_DT，约定开始日期
                         END)              AS 最早办理普贷时间
                    ,MIN(CASE
                           WHEN SUBSTR(T1.pd_cd, 1, 7) = '2010503' THEN T1.apnt_start_dt --PRD_NO，产品编号
                         END)              AS 最早办理随贷通时间
                    ,MIN(T1.apnt_start_dt) AS 最早办理信贷业务时间
            FROM    edw.dim_bus_loan_ctr_inf_dd T1 --信贷合同信息，DIM_BUS_LOAN_CTR_BSE_INF_DD  --合同基础信息
            WHERE   T1.DT = '20240710'
            GROUP BY T1.cst_id
        ) A1
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,SUM(T1.mon_acm_prcp_bal_acml) / 10 AS 随贷通用信日均
                 FROM    edw.dws_bus_loan_fnc_crd_acm_inf_dd T1 --随贷通累计汇总信息
                 WHERE   T1.DT = '20240710'
                 GROUP BY cst_id
             ) A2
ON      A1.cst_id = A2.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(mon_acm_prcp_bal_acml) / 10 AS 贷款用信日均
                 FROM    edw.dws_bus_loan_dbil_inf_dd --贷款借据信息汇总
                 WHERE   DT = '20240710'
                 GROUP BY cst_id
             ) A21
ON      A1.cst_id = A21.cst_id
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,SUM(T1.ctr_amt) AS 合同总金额
                 FROM    edw.dim_bus_loan_ctr_inf_dd T1 --信贷合同信息
                 WHERE   T1.DT = '20240710'
                 AND     ( T1.CTR_BAL > 0 --余额>0
                     OR ( T1.CTR_BAL = 0
                 AND     T1.APNT_MTU_DT >= '20240710' --约定到期日期大于等于当前
                 AND     NVL(T1.FRZ_STS_CD, ' ') NOT IN ( '4' , '3' ) --个人经营性贷款业务未到期、未终结
                 AND     T1.END_DT = '18991231' --终结日期 = 18991231即为合同未终结
                          ) --合同未结清
                          )
                 GROUP BY T1.cst_id
             ) A3
ON      A1.cst_id = A3.cst_id
LEFT JOIN    (
                 SELECT  A1.CST_ID
                         ,A1.SAM_RSK_CTRL_ID
                         ,MIN(CASE
                                WHEN SUBSTR(A3.pd_cd, 1, 7) <> '2010503' THEN A3.apnt_start_dt --CTR_BGN_DT，约定开始日期
                              END)              AS 同一风险控制号最早办理普贷时间
                         ,MIN(CASE
                                WHEN SUBSTR(A3.pd_cd, 1, 7) = '2010503' THEN A3.apnt_start_dt --PRD_NO，产品编号
                              END)              AS 同一风险控制号最早办理随贷通时间
                         ,MIN(A3.apnt_start_dt) AS 同一风险控制号最早办理信贷业务时间
                 FROM    edw.dws_cst_bas_inf_dd A1 --客户基础信息汇总表
                 INNER JOIN    edw.dws_cst_bas_inf_dd A2 --客户基础信息汇总表
                 ON      A1.SAM_RSK_CTRL_ID = A2.SAM_RSK_CTRL_ID
                 AND     A2.SAM_RSK_CTRL_ID <> ''
                 AND     A2.DT = '20240710'
                 LEFT JOIN    edw.dim_bus_loan_ctr_inf_dd A3 --信贷合同信息
                 ON      A2.CST_ID = A3.CST_ID
                 AND     A3.DT = '20240710'
                 WHERE   A1.DT = '20240710'
                 GROUP BY A1.CST_ID , A1.SAM_RSK_CTRL_ID
             ) A4
ON      A1.cst_id = A4.cst_id
;



------------------清单1 首笔新增贷款户，剔除随贷通
-- 1.客户编号、客户名称、发放机构（村行）、发放人、发放人工号、贷款用信日均（若一笔普贷、一笔融e贷，月日均之和）、
-- 贷款加权年利率（若一笔普贷、一笔融e贷，求加权年利率）、贷款合同金额（若一笔普贷、一笔融e贷，合同总金额也可）
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xexd_SJ20240716146_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xexd_SJ20240716146_02 AS
SELECT  T2.cst_id          AS 客户编号
        ,T2.cst_nm         AS 客户名称
        ,T2.busi_ctr_id    AS 合同号
        ,T2.hdl_org_id     AS 发放机构号
        ,T3.org_nm         AS 发放机构
        ,T2.opr_id         AS 发放人工号
        ,T4.empe_nm        AS 发放人
        ,T5.贷款用信日均
        ,T2.intr_rat * 1.2 AS 贷款年利率
        ,T2.ctr_amt        AS 贷款合同金额
FROM    lab_bigdata_dev.tmp_xexd_SJ20240716146_01 T1
INNER JOIN    edw.dim_bus_loan_ctr_inf_dd T2 --信贷合同信息
ON      T1.cst_id = T2.cst_id
AND     T2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' , 'J' ) --剔除 员工贷款、重组贷款
AND     SUBSTR(T2.pd_cd, 1, 7) <> '2010503' --剔除随贷通
AND     T2.DT = '20240710'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.hdl_org_id = T3.org_id
AND     T3.cpy_org_id = '999999997' --村行
AND     T3.DT = '20240710'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T2.opr_id = T4.empe_id
AND     T4.DT = '20240710'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,SUM(mon_acm_prcp_bal_acml) / 10 AS 贷款用信日均
                 FROM    edw.dws_bus_loan_dbil_inf_dd --贷款借据信息汇总
                 WHERE   DT = '20240710'
                 GROUP BY bus_ctr_id
             ) T5
ON      T2.busi_ctr_id = T5.bus_ctr_id
WHERE   T1.最早办理信贷业务时间 >= '20240701'
AND     T1.最早办理普贷时间 >= '20240701'
AND     T1.最早办理普贷时间 <= '20240710'
AND     COALESCE(T1.同一风险控制号最早办理信贷业务时间,'') >='20240701'    --剔除同一风险控制号在20240701前办理过信贷业务的
AND     COALESCE(T1.最早办理随贷通时间,'') = ''                             --剔除办理随贷通的
AND     T1.合同总金额 <= 500000
AND     T1.贷款用信日均 >= 20000;

 --SELECT * from lab_bigdata_dev.tmp_xexd_SJ20240716146_02



-- 需要排查
-- 清单1中，既有随贷通又有贷款，如 7712547627 ， 7721334384
-- 7687026673 ，两笔发生类型是续做
-- 7722292782 ，先卡后贷款
-- 1607355341  发生类型是续做


------------------清单2.1 新发放随贷通卡，与我行从未发生过信贷业务
-- 2.客户编号、客户名称、发放机构（村行）、发放人、发放人工号、卡日均垫款、执行利率、绑定额度
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xexd_SJ20240716146_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xexd_SJ20240716146_03 AS
SELECT  T2.cst_id                AS 客户编号
        ,T2.cst_nm               AS 客户名称
        ,T2.busi_ctr_id          AS 随贷通合同号
        ,T2.hdl_org_id           AS 发放机构号
        ,T3.org_nm               AS 发放机构
        ,T2.opr_id               AS 发放人工号
        ,T4.empe_nm              AS 发放人
        ,T5.卡日均垫款
        ,T21.norm_intr_rat      AS 执行利率
        ,T21.bind_lmt            AS 绑定额度
FROM    lab_bigdata_dev.tmp_xexd_SJ20240716146_01 T1
INNER JOIN    edw.dim_bus_loan_ctr_inf_dd T2 --信贷合同信息
ON      T1.cst_id = T2.cst_id
AND     T2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' , 'J' ) --剔除 员工贷款、重组贷款
AND     SUBSTR(T2.pd_cd, 1, 7) = '2010503' --剔除随贷通
AND     T2.DT = '20240710'
INNER JOIN    edw.dwd_bus_loan_fnc_crd_lmt_inf_dd T21 --随贷通授信额度信息
ON      T2.busi_ctr_id = T21.bus_ctr_id
AND     T21.lmt_sts_cd = '0' --正常
AND     T21.DT = '20240710'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.hdl_org_id = T3.org_id
AND     T3.cpy_org_id = '999999997' --村行
AND     T3.DT = '20240710'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T2.opr_id = T4.empe_id
AND     T4.DT = '20240710'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,SUM(mon_acm_prcp_bal_acml) / 10 AS 卡日均垫款
                 FROM    edw.dws_bus_loan_fnc_crd_acm_inf_dd --随贷通累计汇总信息
                 WHERE   DT = '20240710'
                 GROUP BY bus_ctr_id
             ) T5
ON      T2.busi_ctr_id = T5.bus_ctr_id
WHERE   T1.最早办理信贷业务时间 >= '20240701'
AND     T1.最早办理随贷通时间 >= '20240701'
AND     T1.最早办理随贷通时间 <= '20240710'
AND     COALESCE(T1.同一风险控制号最早办理信贷业务时间,'') >='20240701'   --剔除同一风险控制号在20240701前办理过信贷业务的
AND     COALESCE(T1.最早办理普贷时间,'') = ''  --剔除办理普贷的
AND     T1.合同总金额 <= 500000
AND     T1.贷款用信日均 >= 20000;

SELECT * from lab_bigdata_dev.tmp_xexd_SJ20240716146_03 WHERE  客户编号 IN ('7720736391','7690089887','7718797662')
--需要排查：
--7720736391 ，首笔后卡片申请，需要纯卡片申请
--7690089887 先有卡片申请后有贷款
--7718797662 首笔后卡片申请


------------------清单2.2  新发放随贷通卡，之前有信贷业务
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xexd_SJ20240716146_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xexd_SJ20240716146_04 AS
SELECT  T2.cst_id                AS 客户编号
        ,T2.cst_nm               AS 客户名称
        ,T2.busi_ctr_id          AS 随贷通合同号
        ,T2.hdl_org_id           AS 发放机构号
        ,T3.org_nm               AS 发放机构
        ,T2.opr_id               AS 发放人工号
        ,T4.empe_nm              AS 发放人
        ,T5.卡日均垫款
        ,T21.norm_intr_rat      AS 执行利率
        ,T21.bind_lmt            AS 绑定额度
FROM    lab_bigdata_dev.tmp_xexd_SJ20240716146_01 T1
INNER JOIN    edw.dim_bus_loan_ctr_inf_dd T2 --信贷合同信息
ON      T1.cst_id = T2.cst_id
AND     T2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' , 'J' ) --剔除 员工贷款、重组贷款
AND     SUBSTR(T2.pd_cd, 1, 7) ='2010503' --剔除随贷通
AND     T2.DT = '20240710'
INNER JOIN    edw.dwd_bus_loan_fnc_crd_lmt_inf_dd T21 --随贷通授信额度信息
ON      T2.busi_ctr_id = T21.bus_ctr_id
AND     T21.lmt_sts_cd = '0' --正常
AND     T21.DT = '20240710'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.hdl_org_id = T3.org_id
AND     T3.cpy_org_id = '999999997' --村行
AND     T3.DT = '20240710'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T2.opr_id = T4.empe_id
AND     T4.DT = '20240710'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,SUM(mon_acm_prcp_bal_acml) / 10 AS 卡日均垫款
                 FROM    edw.dws_bus_loan_fnc_crd_acm_inf_dd --随贷通累计汇总信息
                 WHERE   DT = '20240710'
                 GROUP BY bus_ctr_id
             ) T5
ON      T2.busi_ctr_id = T5.bus_ctr_id
WHERE   (T1.最早办理信贷业务时间 < '20240701' OR   COALESCE(T1.同一风险控制号最早办理信贷业务时间,'') < '20240701' )
AND     T1.最早办理随贷通时间 >= '20240701'
AND     T1.最早办理随贷通时间 <= '20240710'
AND     T1.同一风险控制号最早办理随贷通时间>='20240701'   --剔除同一风险控制号在20240701前办理过随贷通的
AND     T1.随贷通用信日均 >= 20000
AND     T1.合同总金额 <= 500000;


------------------清单3 既有首笔新增贷款又首次办理随贷通卡客户清单
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xexd_SJ20240716146_05 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xexd_SJ20240716146_05 AS
SELECT  T2.cst_id          AS 客户编号
        ,T2.cst_nm         AS 客户名称
        ,T2.busi_ctr_id    AS 合同号
        ,T2.hdl_org_id     AS 发放机构号
        ,T3.org_nm         AS 发放机构
        ,T2.opr_id         AS 发放人工号
        ,T4.empe_nm        AS 发放人
        ,T5.贷款用信日均
        ,T2.intr_rat * 1.2 AS 贷款年利率
        ,T2.ctr_amt        AS 贷款合同金额
	,'普贷'            AS 业务品种
FROM    lab_bigdata_dev.tmp_xexd_SJ20240716146_01 T1
INNER JOIN    edw.dim_bus_loan_ctr_inf_dd T2 --信贷合同信息
ON      T1.cst_id = T2.cst_id
AND     T2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' , 'J' ) --剔除 员工贷款、重组贷款
AND     SUBSTR(T2.pd_cd, 1, 7) <> '2010503' --剔除随贷通
AND     T2.DT = '20240710'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.hdl_org_id = T3.org_id
AND     T3.cpy_org_id = '999999997' --村行
AND     T3.DT = '20240710'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T2.opr_id = T4.empe_id
AND     T4.DT = '20240710'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,SUM(mon_acm_prcp_bal_acml) / 10 AS 贷款用信日均
                 FROM    edw.dws_bus_loan_dbil_inf_dd --贷款借据信息汇总
                 WHERE   DT = '20240710'
                 GROUP BY bus_ctr_id
             ) T5
ON      T2.busi_ctr_id = T5.bus_ctr_id
WHERE   T1.最早办理信贷业务时间 >= '20240701'
AND     T1.最早办理普贷时间 >= '20240701'
AND     T1.最早办理普贷时间 <= '20240710'
AND     COALESCE(T1.同一风险控制号最早办理信贷业务时间,'') >='20240701'    --剔除同一风险控制号在20240701前办理过信贷业务的
AND     T1.最早办理随贷通时间 >='20240701'
AND     T1.最早办理随贷通时间 <='20240710'
AND     T1.合同总金额 <= 500000
AND     T1.贷款用信日均 >= 20000
UNION ALL
SELECT  T2.cst_id                AS 客户编号
        ,T2.cst_nm               AS 客户名称
        ,T2.busi_ctr_id          AS 随贷通合同号
        ,T2.hdl_org_id           AS 发放机构号
        ,T3.org_nm               AS 发放机构
        ,T2.opr_id               AS 发放人工号
        ,T4.empe_nm              AS 发放人
        ,T5.卡日均垫款
        ,T21.norm_intr_rat      AS 执行利率
        ,T21.bind_lmt            AS 绑定额度
		,'随贷通'            AS 业务品种
FROM    lab_bigdata_dev.tmp_xexd_SJ20240716146_01 T1
INNER JOIN    edw.dim_bus_loan_ctr_inf_dd T2 --信贷合同信息
ON      T1.cst_id = T2.cst_id
AND     T2.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' , 'J' ) --剔除 员工贷款、重组贷款
AND     SUBSTR(T2.pd_cd, 1, 7) = '2010503'
AND     T2.DT = '20240710'
INNER JOIN    edw.dwd_bus_loan_fnc_crd_lmt_inf_dd T21 --随贷通授信额度信息
ON      T2.busi_ctr_id = T21.bus_ctr_id
AND     T21.lmt_sts_cd = '0' --正常
AND     T21.DT = '20240710'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.hdl_org_id = T3.org_id
AND     T3.cpy_org_id = '999999997' --村行
AND     T3.DT = '20240710'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T2.opr_id = T4.empe_id
AND     T4.DT = '20240710'
LEFT JOIN    (
                 SELECT  bus_ctr_id
                         ,SUM(mon_acm_prcp_bal_acml) / 10 AS 卡日均垫款
                 FROM    edw.dws_bus_loan_fnc_crd_acm_inf_dd --随贷通累计汇总信息
                 WHERE   DT = '20240710'
                 GROUP BY bus_ctr_id
             ) T5
ON      T2.busi_ctr_id = T5.bus_ctr_id
WHERE   T1.最早办理信贷业务时间 >= '20240701'
AND     T1.最早办理普贷时间 >= '20240701'
AND     T1.最早办理普贷时间 <= '20240710'
AND     COALESCE(T1.同一风险控制号最早办理信贷业务时间,'') >='20240701'    --剔除同一风险控制号在20240701前办理过信贷业务的
AND     T1.最早办理随贷通时间 >='20240701'
AND     T1.最早办理随贷通时间 <='20240710'
AND     T1.合同总金额 <= 500000
AND     T1.贷款用信日均 >= 20000 ;
**01-数据需求_村行_SJ20240716156_政和村行_张弛_税务检查需要判定农户与非农户_需要地址清单.sql


-- 税务检查需要判定农户与非农户，需要地址清单
-- 系统：ecif

-- ecif系统数据：2021年至2023年 政和村行数据，客户号，客户姓名，户籍地址，居住地址，经营地址

--DROP TABLE IF EXISTS ${odps_lab_bdd}.tmp_ecif_lzh_address_20240717_01;

CREATE TABLE IF NOT EXISTS tmp_ecif_lzh_address_20240717_01
(
     cst_id            STRING COMMENT '客户号'
    ,gz               STRING COMMENT '工作单位地址'
    ,gz_city          STRING COMMENT '工作单位地址行政区划'
    ,gz_fourthaddress STRING COMMENT '工作单位地址四级地址区划'
    ,gz_name          STRING COMMENT '工作单位地址四级地址名称'
    ,gz_ismainaddress STRING COMMENT '工作单位地址是否主地址'
    ,is_gz            STRING COMMENT '工作单位地址是否农户'
    ,hj               STRING COMMENT '户籍地址'
    ,hj_city          STRING COMMENT '户籍地址行政区划'
    ,hj_fourthaddress STRING COMMENT '户籍地址四级地址区划'
    ,hj_name          STRING COMMENT '户籍地址四级地址名称'
    ,hj_ismainaddress STRING COMMENT '户籍地址是否主地址'
    ,is_hj            STRING COMMENT '户籍地址是否农户'
    ,zc               STRING COMMENT '注册地址'
    ,zc_city          STRING COMMENT '注册地址行政区划'
    ,zc_fourthaddress STRING COMMENT '注册地址四级地址'
    ,zc_name          STRING COMMENT '注册地址四级地址名称'
    ,zc_ismainaddress STRING COMMENT '注册地址是否主地址'
    ,is_zc            STRING COMMENT '注册地址是否农户'
    ,jy               STRING COMMENT '经营所在地地址'
    ,jy_city          STRING COMMENT '经营所在地地址行政区划'
    ,jy_fourthaddress STRING COMMENT '经营所在地地址四级地址'
    ,jy_name          STRING COMMENT '经营所在地地址四级地址名称'
    ,jy_ismainaddress STRING COMMENT '经营所在地地址是否主地址'
    ,is_jy            STRING COMMENT '经营所在地地址是否农户'
    ,jt               STRING COMMENT '家庭地址'
    ,jt_city          STRING COMMENT '家庭地址行政区划'
    ,jt_fourthaddress STRING COMMENT '家庭地址四级地址'
    ,jt_name          STRING COMMENT '家庭地址四级地址名称'
    ,jt_ismainaddress STRING COMMENT '家庭地址是否主地址'
    ,is_jt            STRING COMMENT '家庭地址是否农户'
    ,tx               STRING COMMENT '通讯地址'
    ,tx_city          STRING COMMENT '通讯地址行政区划'
    ,tx_fourthaddress STRING COMMENT '通讯地址四级地址'
    ,tx_name          STRING COMMENT '通讯地址四级地址名称'
    ,tx_ismainaddress STRING COMMENT '通讯地址是否主地址'
    ,is_tx           STRING COMMENT '通讯地址是否农户'
)
COMMENT '农户地址详情表'
PARTITIONED BY ( DT STRING COMMENT '日期分区')
;

-----支持重跑
drop table if EXISTS  tmp_ecif_lzh_dzxx_20230717 ;
CREATE TABLE tmp_ecif_lzh_dzxx_20230717 AS
SELECT  t.cst_id
        ,t1.address4 gz
        ,t1.city gz_city
        ,t1.ismainaddress gz_ismainaddress
        ,t1.fourthaddress  gz_fourthaddress
        ,tmp1.name          gz_name
        ,t3.address4 hj
        ,t3.city hj_city
        ,t3.ismainaddress hj_ismainaddress
        ,t3.fourthaddress  hj_fourthaddress
        ,tmp3.name         hj_name
        ,t2.address4 zc
        ,t2.city zc_city
        ,t2.ismainaddress  zc_ismainaddress
        ,t2.fourthaddress  zc_fourthaddress
        ,tmp2.name         zc_name
        ,t4.address4 jy
        ,t4.city jy_city
        ,t4.ismainaddress jy_ismainaddress
        ,t4.fourthaddress  jy_fourthaddress
        ,tmp4.name         jy_name
        ,t5.address4 jt
        ,t5.city jt_city
        ,t5.ismainaddress jt_ismainaddress
        ,t5.fourthaddress  jt_fourthaddress
        ,tmp5.name         jt_name
        ,t6.address4 tx
        ,t6.city tx_city
        ,t6.ismainaddress tx_ismainaddress
        ,t6.fourthaddress  tx_fourthaddress
        ,tmp6.name         tx_name
FROM    edw.dws_cst_bas_inf_dd t
LEFT JOIN    (
                 SELECT   cst_id customerid
                         ,ful_adr address4
                         ,cnr_lvl_id_cd city
                         ,prm_adr_ind ismainaddress
                         ,strt_cd fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id , PHY_ADR_TYP_CD ORDER BY upd_dt DESC ) rn
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd
                 WHERE   dt = '20211231'
                 AND     PHY_ADR_TYP_CD = '050400'
             ) t1 -----工作单位地址
ON      t.cst_id = t1.customerid
AND     t1.rn = 1
left join  tmp_hc_jddm tmp1
on t1.fourthaddress =tmp1.adcode
LEFT JOIN    (
                 SELECT   cst_id customerid
                         ,ful_adr address4
                         ,cnr_lvl_id_cd city
                         ,prm_adr_ind ismainaddress
                         ,strt_cd fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id , PHY_ADR_TYP_CD ORDER BY upd_dt DESC ) rn
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd
                 WHERE   dt = '20211231'
                 AND     PHY_ADR_TYP_CD = '050800'
             ) t2 ----:注册地址
ON      t.cst_id = t2.customerid
AND     t2.rn = 1
left join  tmp_hc_jddm tmp2
on t2.fourthaddress =tmp2.adcode
LEFT JOIN    (
                 SELECT   cst_id customerid
                         ,ful_adr address4
                         ,cnr_lvl_id_cd city
                         ,prm_adr_ind ismainaddress
                         ,strt_cd fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id , PHY_ADR_TYP_CD ORDER BY upd_dt DESC ) rn
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd
                 WHERE   dt = '20211231'
                 AND     PHY_ADR_TYP_CD = '050100'
             ) t3 ----:户籍地址
ON      t.cst_id = t3.customerid
AND     t3.rn = 1
left join  tmp_hc_jddm tmp3
on t3.fourthaddress =tmp3.adcode
LEFT JOIN    (
                 SELECT   cst_id customerid
                         ,ful_adr address4
                         ,cnr_lvl_id_cd city
                         ,prm_adr_ind ismainaddress
                         ,strt_cd fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id , PHY_ADR_TYP_CD ORDER BY upd_dt DESC ) rn
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd
                 WHERE   dt = '20211231'
                 AND     PHY_ADR_TYP_CD = '050900'
             ) t4 ----:经营所在地地址
ON      t.cst_id = t4.customerid
AND     t4.rn = 1
left join  tmp_hc_jddm tmp4
on t4.fourthaddress =tmp4.adcode
LEFT JOIN    (
                 SELECT   cst_id customerid
                         ,ful_adr address4
                         ,cnr_lvl_id_cd city
                         ,prm_adr_ind ismainaddress
                         ,strt_cd fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id , PHY_ADR_TYP_CD ORDER BY upd_dt DESC ) rn
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd
                 WHERE   dt = '20211231'
                 AND     PHY_ADR_TYP_CD = '050200'
             ) t5 ----:家庭地址
ON      t.cst_id = t5.customerid
AND     t5.rn = 1
left join  tmp_hc_jddm tmp5
on t5.fourthaddress =tmp5.adcode
LEFT JOIN    (
                 SELECT   cst_id customerid
                         ,ful_adr address4
                         ,cnr_lvl_id_cd city
                         ,prm_adr_ind ismainaddress
                         ,strt_cd fourthaddress
                         ,ROW_NUMBER() OVER ( PARTITION BY cst_id , PHY_ADR_TYP_CD ORDER BY upd_dt DESC ) rn
                 FROM    edw.dim_cst_bas_phy_adr_inf_dd
                 WHERE   dt = '20211231'
                 AND     PHY_ADR_TYP_CD = '050300'
             ) t6 ----:通讯地址
ON      t.cst_id = t6.customerid
AND     t6.rn = 1
left join  tmp_hc_jddm tmp6
on t6.fourthaddress =tmp6.adcode
WHERE   t.dt = '20211231'
;

select dt,count(1) from tmp_ecif_lzh_address_20240717_01
where dt>'20200101'
group by dt;

----- 判断 居住、户籍、办公、注册 是否农村   1是 0否
ALTER TABLE ${odps_lab_bdd}.tmp_ecif_lzh_address_20240717_01 DROP IF EXISTS PARTITION ( DT = '20211231' );
INSERT INTO ${odps_lab_bdd}.tmp_ecif_lzh_address_20240717_01 PARTITION (DT = '20211231')
SELECT
cst_id
,gz
,gz_city
,gz_fourthaddress
,gz_name
,gz_ismainaddress
,CASE
 WHEN NVL(gz_fourthaddress,'')<>'' and substr(gz_fourthaddress,7,6) <>'999999' AND NVL(gz_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(gz_fourthaddress,'')<>'' and substr(gz_fourthaddress,7,6) <>'999999' AND NVL(gz_name,'') LIKE '%镇'
        AND ( ( NVL(gz_name,'')  LIKE '%熊山镇'   AND gz_city ='350725' )---城关镇
           OR ( NVL(gz_name,'')  LIKE '%双溪镇'  AND  gz_city ='350721' )
           OR ( NVL(gz_name,'')  LIKE '%雪峰镇'  AND  gz_city ='350421' )
           OR ( NVL(gz_name,'')  LIKE '%龙津镇'  AND  gz_city ='350423' )
           OR ( NVL(gz_name,'')  LIKE '%杨舍镇'  AND  gz_city ='320582' )
           OR ( NVL(gz_name,'')  LIKE '%玉山镇'  AND  gz_city ='320583' )
           OR ( NVL(gz_name,'')  LIKE '%城厢镇'  AND  gz_city ='320585' )
           OR ( NVL(gz_name,'')  LIKE '%城关镇'  AND  gz_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(gz_name,'')  LIKE '%首善镇'  AND  gz_city ='610326' )
           OR ( NVL(gz_name,'')  LIKE '%高亭镇'  AND  gz_city ='330921' )
           OR ( NVL(gz_name,'')  LIKE '%华埠镇'  AND  gz_city ='330824' )
           OR ( NVL(gz_name,'')  LIKE '%灵溪镇'  AND  gz_city ='330327' )
           OR ( NVL(gz_name,'')  LIKE '%昆阳镇'  AND  gz_city ='330326' )
           OR ( NVL(gz_name,'')  LIKE '%罗阳镇'  AND  gz_city ='330329' )
           OR ( NVL(gz_name,'')  LIKE '%大峃镇'  AND  gz_city ='330328' )
           OR ( NVL(gz_name,'')  LIKE '%龙港镇'  AND  gz_city ='330383' ))
       AND NVL(gz,'')  LIKE '%村%'  AND NVL(gz,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(gz_fourthaddress,'') <>'' and substr(gz_fourthaddress,7,6) <>'999999'  AND  NVL(gz_name,'') LIKE '%镇'
        AND ((  NVL(gz_name,'')   LIKE '%熊山镇'   AND  gz_city  <> '350725' )---城关镇
           OR ( NVL(gz_name,'')   LIKE '%双溪镇'  AND  gz_city <>'350721' )
           OR ( NVL(gz_name,'')   LIKE '%雪峰镇'  AND  gz_city <>'350421' )
           OR ( NVL(gz_name,'')   LIKE '%龙津镇'  AND  gz_city <>'350423' )
           OR ( NVL(gz_name,'')   LIKE '%杨舍镇'  AND  gz_city <>'320582' )
           OR ( NVL(gz_name,'')   LIKE '%玉山镇'  AND  gz_city <>'320583' )
           OR ( NVL(gz_name,'')   LIKE '%城厢镇'  AND  gz_city <>'320585' )
           OR ( NVL(gz_name,'')   LIKE '%城关镇'  AND  gz_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(gz_name,'')   LIKE '%首善镇'  AND  gz_city <>'610326' )
           OR ( NVL(gz_name,'')   LIKE '%高亭镇'  AND  gz_city <>'330921' )
           OR ( NVL(gz_name,'')   LIKE '%华埠镇'  AND  gz_city <>'330824' )
           OR ( NVL(gz_name,'')   LIKE '%灵溪镇'  AND  gz_city <>'330327' )
           OR ( NVL(gz_name,'')   LIKE '%昆阳镇'  AND  gz_city <>'330326' )
           OR ( NVL(gz_name,'')   LIKE '%罗阳镇'  AND  gz_city <>'330329' )
           OR ( NVL(gz_name,'')   LIKE '%大峃镇'  AND  gz_city <>'330328' )
           OR ( NVL(gz_name,'')   LIKE '%龙港镇'  AND  gz_city <>'330383' ))
        THEN  '1'
WHEN NVL(gz_fourthaddress,'') <>'' and substr(gz_fourthaddress,7,6) <>'999999' AND  NVL(gz_name,'') LIKE '%镇'
        AND (  NVL(gz_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(gz_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(gz_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(gz_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(gz_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(gz_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(gz_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(gz_name,'')  NOT LIKE '%城关镇'
           AND  NVL(gz_name,'')  NOT LIKE '%首善镇'
           AND  NVL(gz_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(gz_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(gz_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(gz_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(gz_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(gz_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(gz_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(gz_fourthaddress,'')<>'' and substr(gz_fourthaddress,7,6) <>'999999' AND NVL(gz,'')  LIKE '%村%'  AND NVL(gz,'') not LIKE '%新村%'  THEN  '1'
when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and LENGTH(gz)-length(replace(gz,'乡',''))=1 and (
          gz not like '%肥乡区%'
     and  gz not like '%柏乡县%'
     and  gz not like '%平乡县%'
     and  gz not like '%武乡县%'
     and  gz not like '%乡宁县%'
     and  gz not like '%桐乡市%'
     and  gz not like '%萍乡市%'
     and  gz not like '%东乡区%'
     and  gz not like '%金乡县%'
     and  gz not like '%新乡市%'
     and  gz not like '%新乡县%'
     and  gz not like '%内乡县%'
     and  gz not like '%宁乡市%'
     and  gz not like '%湘乡市%'
     and  gz not like '%安乡县%'
     and  gz not like '%西乡塘区%'
     and  gz not like '%乡城县%'
     and  gz not like '%西乡县%'
     and  gz not like '%东乡族自治县%'
     and  gz not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and LENGTH(gz)-length(replace(gz,'乡',''))> 1 then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  LENGTH(gz)-length(replace(gz,'镇','')) =1  and
 (
          gz  like '%天镇县%'
     OR  gz  like '%丰镇市%'
     OR  gz  like '%北镇市%'
     OR  gz  like '%镇赉县%'
     OR  gz  like '%镇江市%'
     OR  gz  like '%镇海区%'
     OR  gz  like '%固镇县%'
     OR  gz  like '%景德镇市%'
     OR  gz  like '%镇平县%'
     OR  gz  like '%清镇市%'
     OR  gz  like '%镇宁布依族苗族自治县%'
     OR  gz  like '%镇远县%'
     OR  gz  like '%镇雄县%'
     OR  gz  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  gz  like '%镇康县%'
     OR  gz  like '%镇巴县%'
     OR  gz  like '%镇坪县%'
     OR  gz  like '%镇安县%'
     OR  gz  like '%镇原县%'   ---区县
     OR (gz  like '%熊山镇%'   and  gz_city ='350725' )---城关镇
     OR ( gz  like '%双溪镇%'  and  gz_city ='350721' )
     OR ( gz  like '%雪峰镇%'  and  gz_city ='350421' )
     OR ( gz  like '%龙津镇%'  and  gz_city ='350423' )
     OR ( gz  like '%杨舍镇%'  and  gz_city ='320582' )
     OR ( gz  like '%玉山镇%'  and  gz_city ='320583' )
     OR ( gz  like '%城厢镇%'  and  gz_city ='320585' )
     OR ( gz  like '%城关镇%'  and  gz_city  in ('610981','610928','610921','610929','610924','610926') )
     OR ( gz  like '%首善镇%'  and  gz_city ='610326' )
     OR ( gz  like '%高亭镇%'  and  gz_city ='330921' )
     OR ( gz  like '%华埠镇%'  and  gz_city ='330824' )
     OR ( gz  like '%灵溪镇%'  and  gz_city ='330327' )
     OR ( gz  like '%昆阳镇%'  and  gz_city ='330326' )
     OR ( gz  like '%罗阳镇%'  and  gz_city ='330329' )
     OR ( gz  like '%大峃镇%'  and  gz_city ='330328' )
     OR ( gz  like '%龙港镇%'  and  gz_city ='330383' )
 )  and gz  like '%村%'  and gz not like '%新村%'  then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  LENGTH(gz)-length(replace(gz,'镇','')) =1  and
(

   (      gz  like '%熊山镇%'   and gz_city  <>'350725' )---城关镇
     OR ( gz  like '%双溪镇%'  and  gz_city  <>'350721' )
     OR ( gz  like '%雪峰镇%'  and  gz_city <>'350421' )
     OR ( gz  like '%龙津镇%'  and  gz_city <>'350423' )
     OR ( gz  like '%杨舍镇%'  and  gz_city <>'320582' )
     OR ( gz  like '%玉山镇%'  and  gz_city <>'320583' )
     OR ( gz  like '%城厢镇%'  and  gz_city <>'320585' )
     OR ( gz  like '%城关镇%'  and  gz_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( gz  like '%首善镇%'  and  gz_city <> '610326' )
     OR ( gz  like '%高亭镇%'  and  gz_city <>'330921' )
     OR ( gz  like '%华埠镇%'  and  gz_city <>'330824' )
     OR ( gz  like '%灵溪镇%'  and  gz_city <>'330327' )
     OR ( gz  like '%昆阳镇%'  and  gz_city <>'330326' )
     OR ( gz  like '%罗阳镇%'  and  gz_city <>'330329' )
     OR ( gz  like '%大峃镇%'  and  gz_city <>'330328' )
     OR ( gz  like '%龙港镇%'  and  gz_city <>'330383' )
	 ) then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  LENGTH(gz)-length(replace(gz,'镇','')) =1  and
 (    ----区县
          gz not like '%天镇县%'
     and  gz not like '%丰镇市%'
     and  gz not like '%北镇市%'
     and  gz not like '%镇赉县%'
     and  gz not like '%镇江市%'
     and  gz not like '%镇海区%'
     and  gz not like '%固镇县%'
     and  gz not like '%景德镇市%'
     and  gz not like '%镇平县%'
     and  gz not like '%清镇市%'
     and  gz not like '%镇宁布依族苗族自治县%'
     and  gz not like '%镇远县%'
     and  gz not like '%镇雄县%'
     and  gz not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  gz not like '%镇康县%'
     and  gz not like '%镇巴县%'
     and  gz not like '%镇坪县%'
     and  gz not like '%镇安县%'
     and  gz not like '%镇原县%'
)
and (     gz not like '%熊山镇%'   ----城关镇
     and  gz not like '%双溪镇%'
     and  gz not like '%雪峰镇%'
     and  gz not like '%龙津镇%'
     and  gz not like '%杨舍镇%'
     and  gz not like '%玉山镇%'
     and  gz not like '%城厢镇%'
     and  gz not like '%城关镇%'
     and  gz not like '%首善镇%'
     and  gz not like '%高亭镇%'
     and  gz not like '%华埠镇%'
     and  gz not like '%灵溪镇%'
     and  gz not like '%昆阳镇%'
     and  gz not like '%罗阳镇%'
     and  gz not like '%大峃镇%'
     and  gz not like '%龙港镇%'
 )       then '1'
  when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  LENGTH(gz)-length(replace(gz,'镇','')) >1 and  (
         ( substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%熊山镇%'  and  gz_city ='350725' )---城关镇
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%双溪镇%'   and  gz_city ='350721' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%雪峰镇%'   and  gz_city ='350421' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%龙津镇%'   and  gz_city ='350423' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%杨舍镇%'   and  gz_city ='320582' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%玉山镇%'   and  gz_city ='320583' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%城厢镇%'   and  gz_city ='320585' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%城关镇%'  and  gz_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%首善镇%'  and  gz_city ='610326' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%高亭镇%'  and  gz_city='330921' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%华埠镇%'  and  gz_city='330824' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%灵溪镇%'  and  gz_city='330327' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%昆阳镇%'  and  gz_city='330326' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%罗阳镇%'  and  gz_city='330329' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%大峃镇%'  and  gz_city='330328' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%龙港镇%'  and  gz_city ='330383' )
 ) AND gz LIKE '%村%' AND gz not LIKE '%新村%' then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  LENGTH(gz)-length(replace(gz,'镇','')) >1 and  (
         ( substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%熊山镇%'  and  gz_city <>'350725' )---城关镇
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%双溪镇%'   and  gz_city <>'350721' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%雪峰镇%'   and  gz_city <>'350421' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%龙津镇%'   and  gz_city <>'350423' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%杨舍镇%'   and  gz_city <>'320582' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%玉山镇%'   and  gz_city <>'320583' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%城厢镇%'   and  gz_city <>'320585' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%城关镇%'  and  gz_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%首善镇%'  and  gz_city <>'610326' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%高亭镇%'  and  gz_city <>'330921' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%华埠镇%'  and  gz_city <> '330824' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%灵溪镇%'  and  gz_city <> '330327' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%昆阳镇%'  and  gz_city <>'330326' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%罗阳镇%'  and  gz_city <>'330329' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%大峃镇%'  and  gz_city <>'330328' )
     OR  (substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1))  like '%龙港镇%'  and  gz_city <>'330383' )
 )  then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  LENGTH(gz)-length(replace(gz,'镇','')) >1 and  (
          substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%熊山镇%'   ---城关镇
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%双溪镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%雪峰镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%龙津镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%杨舍镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%玉山镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%城厢镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%城关镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%首善镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%高亭镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%华埠镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%灵溪镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%昆阳镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%罗阳镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%大峃镇%'
     and  substr(gz,instr(gz,'镇',-2),instr(gz,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when (nvl(gz_fourthaddress,'')='' or substr(gz_fourthaddress,7,6) ='999999' ) and  gz like '%村%' and gz not like '%新村%'  then '1'
    else '0' end  is_gz
    ,hj
    ,hj_city
,hj_fourthaddress
,hj_name
,hj_ismainaddress
    ,CASE
     WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj_name,'') LIKE '%镇'
        AND ( ( NVL(hj_name,'')  LIKE '%熊山镇'   AND hj_city ='350725' )---城关镇
           OR ( NVL(hj_name,'')  LIKE '%双溪镇'  AND  hj_city ='350721' )
           OR ( NVL(hj_name,'')  LIKE '%雪峰镇'  AND  hj_city ='350421' )
           OR ( NVL(hj_name,'')  LIKE '%龙津镇'  AND  hj_city ='350423' )
           OR ( NVL(hj_name,'')  LIKE '%杨舍镇'  AND  hj_city ='320582' )
           OR ( NVL(hj_name,'')  LIKE '%玉山镇'  AND  hj_city ='320583' )
           OR ( NVL(hj_name,'')  LIKE '%城厢镇'  AND  hj_city ='320585' )
           OR ( NVL(hj_name,'')  LIKE '%城关镇'  AND  hj_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(hj_name,'')  LIKE '%首善镇'  AND  hj_city ='610326' )
           OR ( NVL(hj_name,'')  LIKE '%高亭镇'  AND  hj_city ='330921' )
           OR ( NVL(hj_name,'')  LIKE '%华埠镇'  AND  hj_city ='330824' )
           OR ( NVL(hj_name,'')  LIKE '%灵溪镇'  AND  hj_city ='330327' )
           OR ( NVL(hj_name,'')  LIKE '%昆阳镇'  AND  hj_city ='330326' )
           OR ( NVL(hj_name,'')  LIKE '%罗阳镇'  AND  hj_city ='330329' )
           OR ( NVL(hj_name,'')  LIKE '%大峃镇'  AND  hj_city ='330328' )
           OR ( NVL(hj_name,'')  LIKE '%龙港镇'  AND  hj_city ='330383' ))
       AND NVL(hj,'')  LIKE '%村%'  AND NVL(hj,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(hj_fourthaddress,'') <>''and  substr(hj_fourthaddress,7,6) <> '999999' AND  NVL(hj_name,'') LIKE '%镇'
        AND (  NVL(hj_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(hj_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(hj_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(hj_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(hj_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(hj_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(hj_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(hj_name,'')  NOT LIKE '%城关镇'
           AND  NVL(hj_name,'')  NOT LIKE '%首善镇'
           AND  NVL(hj_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(hj_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(hj_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(hj_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(hj_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(hj_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(hj_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj_name,'') LIKE '%镇'
        AND ((NVL(hj_name,'')   LIKE '%熊山镇'   AND  hj_city  <> '350725' )---城关镇
           OR ( NVL(hj_name,'')   LIKE '%双溪镇'  AND  hj_city <>'350721' )
           OR ( NVL(hj_name,'')   LIKE '%雪峰镇'  AND  hj_city <>'350421' )
           OR ( NVL(hj_name,'')   LIKE '%龙津镇'  AND  hj_city <>'350423' )
           OR ( NVL(hj_name,'')   LIKE '%杨舍镇'  AND  hj_city <>'320582' )
           OR ( NVL(hj_name,'')   LIKE '%玉山镇'  AND  hj_city <>'320583' )
           OR ( NVL(hj_name,'')   LIKE '%城厢镇'  AND  hj_city <>'320585' )
           OR ( NVL(hj_name,'')   LIKE '%城关镇'  AND  hj_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(hj_name,'')   LIKE '%首善镇'  AND  hj_city <>'610326' )
           OR ( NVL(hj_name,'')   LIKE '%高亭镇'  AND  hj_city <>'330921' )
           OR ( NVL(hj_name,'')   LIKE '%华埠镇'  AND  hj_city <>'330824' )
           OR ( NVL(hj_name,'')   LIKE '%灵溪镇'  AND  hj_city <>'330327' )
           OR ( NVL(hj_name,'')   LIKE '%昆阳镇'  AND  hj_city <>'330326' )
           OR ( NVL(hj_name,'')   LIKE '%罗阳镇'  AND  hj_city <>'330329' )
           OR ( NVL(hj_name,'')   LIKE '%大峃镇'  AND  hj_city <>'330328' )
           OR ( NVL(hj_name,'')   LIKE '%龙港镇'  AND  hj_city <>'330383' ))
        THEN  '1'
WHEN NVL(hj_fourthaddress,'')<>'' and  substr(hj_fourthaddress,7,6) <> '999999' AND NVL(hj,'')  LIKE '%村%'  AND NVL(hj,'') not LIKE '%新村%'  THEN  '1'
     when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'乡','')) =1 and (
          hj not like '%肥乡区%'
     and  hj not like '%柏乡县%'
     and  hj not like '%平乡县%'
     and  hj not like '%武乡县%'
     and  hj not like '%乡宁县%'
     and  hj not like '%桐乡市%'
     and  hj not like '%萍乡市%'
     and  hj not like '%东乡区%'
     and  hj not like '%金乡县%'
     and  hj not like '%新乡市%'
     and  hj not like '%新乡县%'
     and  hj not like '%内乡县%'
     and  hj not like '%宁乡市%'
     and  hj not like '%湘乡市%'
     and  hj not like '%安乡县%'
     and  hj not like '%西乡塘区%'
     and  hj not like '%乡城县%'
     and  hj not like '%西乡县%'
     and  hj not like '%东乡族自治县%'
     and  hj not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'乡',''))>1 then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) =1  and
 (
          hj  like '%天镇县%'
     OR  hj  like '%丰镇市%'
     OR  hj  like '%北镇市%'
     OR  hj  like '%镇赉县%'
     OR  hj  like '%镇江市%'
     OR  hj  like '%镇海区%'
     OR  hj  like '%固镇县%'
     OR  hj  like '%景德镇市%'
     OR  hj  like '%镇平县%'
     OR  hj  like '%清镇市%'
     OR  hj  like '%镇宁布依族苗族自治县%'
     OR  hj  like '%镇远县%'
     OR  hj  like '%镇雄县%'
     OR  hj  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  hj  like '%镇康县%'
     OR  hj  like '%镇巴县%'
     OR  hj  like '%镇坪县%'
     OR  hj  like '%镇安县%'
     OR  hj  like '%镇原县%'   ---区县
     OR ( hj  like '%熊山镇%'  and  hj_city ='350725' )---城关镇
     OR ( hj  like '%双溪镇%'  and  hj_city ='350721' )
     OR ( hj  like '%雪峰镇%'  and  hj_city ='350421' )
     OR ( hj  like '%龙津镇%'  and  hj_city ='350423' )
     OR ( hj  like '%杨舍镇%'  and  hj_city ='320582' )
     OR ( hj  like '%玉山镇%'  and  hj_city ='320583' )
     OR ( hj  like '%城厢镇%'  and  hj_city ='320585' )
     OR ( hj  like '%城关镇%'  and  hj_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( hj  like '%首善镇%'  and  hj_city ='610326' )
     OR ( hj  like '%高亭镇%'  and  hj_city ='330921' )
     OR ( hj  like '%华埠镇%'  and  hj_city ='330824' )
     OR ( hj  like '%灵溪镇%'  and  hj_city ='330327' )
     OR ( hj  like '%昆阳镇%'  and  hj_city ='330326' )
     OR ( hj  like '%罗阳镇%'  and  hj_city ='330329' )
     OR ( hj  like '%大峃镇%'  and  hj_city ='330328' )
     OR ( hj  like '%龙港镇%'  and  hj_city ='330383' )
 )   and hj like '%村%' and hj not like '%新村%'  then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) and  LENGTH(hj)-length(replace(hj,'镇','')) =1  and
(

   (      hj  like '%熊山镇%'   and hj_city  <>'350725' )---城关镇
     OR ( hj  like '%双溪镇%'  and  hj_city  <>'350721' )
     OR ( hj  like '%雪峰镇%'  and  hj_city <>'350421' )
     OR ( hj  like '%龙津镇%'  and  hj_city <>'350423' )
     OR ( hj  like '%杨舍镇%'  and  hj_city <>'320582' )
     OR ( hj  like '%玉山镇%'  and  hj_city <>'320583' )
     OR ( hj  like '%城厢镇%'  and  hj_city <>'320585' )
     OR ( hj  like '%城关镇%'  and  hj_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( hj  like '%首善镇%'  and  hj_city <> '610326' )
     OR ( hj  like '%高亭镇%'  and  hj_city <>'330921' )
     OR ( hj  like '%华埠镇%'  and  hj_city <>'330824' )
     OR ( hj  like '%灵溪镇%'  and  hj_city <>'330327' )
     OR ( hj  like '%昆阳镇%'  and  hj_city <>'330326' )
     OR ( hj  like '%罗阳镇%'  and  hj_city <>'330329' )
     OR ( hj  like '%大峃镇%'  and  hj_city <>'330328' )
     OR ( hj  like '%龙港镇%'  and  hj_city <>'330383' )

	 ) then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) =1  and
 (
          hj not like '%天镇县%'
     and  hj not like '%丰镇市%'
     and  hj not like '%北镇市%'
     and  hj not like '%镇赉县%'
     and  hj not like '%镇江市%'
     and  hj not like '%镇海区%'
     and  hj not like '%固镇县%'
     and  hj not like '%景德镇市%'
     and  hj not like '%镇平县%'
     and  hj not like '%清镇市%'
     and  hj not like '%镇宁布依族苗族自治县%'
     and  hj not like '%镇远县%'
     and  hj not like '%镇雄县%'
     and  hj not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  hj not like '%镇康县%'
     and  hj not like '%镇巴县%'
     and  hj not like '%镇坪县%'
     and  hj not like '%镇安县%'
     and  hj not like '%镇原县%'
)
and ( hj not like '%熊山镇%'
     and  hj not like '%双溪镇%'
     and  hj not like '%雪峰镇%'
     and  hj not like '%龙津镇%'
     and  hj not like '%杨舍镇%'
     and  hj not like '%玉山镇%'
     and  hj not like '%城厢镇%'
     and  hj not like '%城关镇%'
     and  hj not like '%首善镇%'
     and  hj not like '%高亭镇%'
     and  hj not like '%华埠镇%'
     and  hj not like '%灵溪镇%'
     and  hj not like '%昆阳镇%'
     and  hj not like '%罗阳镇%'
     and  hj not like '%大峃镇%'
     and  hj not like '%龙港镇%'
 )   then '1'
  when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) >1 and  (
         ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%熊山镇%' and  hj_city ='350725' )---城关镇
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%双溪镇%'  and  hj_city ='350721' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%雪峰镇%'  and  hj_city ='350421' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙津镇%'  and  hj_city ='350423' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%杨舍镇%'  and  hj_city ='320582' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%玉山镇%'  and  hj_city ='320583' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城厢镇%'  and  hj_city ='320585' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城关镇%'  and  hj_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%首善镇%'  and  hj_city ='610326' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%高亭镇%'  and  hj_city ='330921' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%华埠镇%'  and  hj_city ='330824' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%灵溪镇%'  and  hj_city ='330327' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%昆阳镇%'  and  hj_city ='330326' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%罗阳镇%'  and  hj_city ='330329' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%大峃镇%'  and  hj_city ='330328' )
     OR ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙港镇%'  and  hj_city ='330383' )
 ) AND hj LIKE '%村%' AND hj not LIKE '%新村%' then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) and  LENGTH(hj)-length(replace(hj,'镇','')) >1 and  (
         ( substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%熊山镇%'  and  hj_city <>'350725' )---城关镇
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%双溪镇%'   and  hj_city <>'350721' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%雪峰镇%'   and  hj_city <>'350421' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙津镇%'   and  hj_city <>'350423' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%杨舍镇%'   and  hj_city <>'320582' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%玉山镇%'   and  hj_city <>'320583' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城厢镇%'   and  hj_city <>'320585' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%城关镇%'  and  hj_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%首善镇%'  and  hj_city <>'610326' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%高亭镇%'  and  hj_city <>'330921' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%华埠镇%'  and  hj_city <> '330824' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%灵溪镇%'  and  hj_city <> '330327' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%昆阳镇%'  and  hj_city <>'330326' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%罗阳镇%'  and  hj_city <>'330329' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%大峃镇%'  and  hj_city <>'330328' )
     OR  (substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1))  like '%龙港镇%'  and  hj_city <>'330383' )
 )  then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND LENGTH(hj)-length(replace(hj,'镇','')) >1 and  (
          substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%熊山镇%' ---城关镇
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%双溪镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%雪峰镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%龙津镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%杨舍镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%玉山镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%城厢镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%城关镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%首善镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%高亭镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%华埠镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%灵溪镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%昆阳镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%罗阳镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%大峃镇%'
     and  substr(hj,instr(hj,'镇',-2),instr(hj,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when (NVL(hj_fourthaddress,'')='' or  substr(hj_fourthaddress,7,6) = '999999' ) AND hj like '%村%' and hj not like '%新村%'  then '1'
    else '0' end  is_hj
       ,zc
    ,zc_city
,zc_fourthaddress
,zc_name
,zc_ismainaddress
  ,CASE
   WHEN NVL(zc_fourthaddress,'')<>''  and   substr(zc_fourthaddress,7,6) <>'999999'  AND NVL(zc_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(zc_fourthaddress,'')<>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND NVL(zc_name,'') LIKE '%镇'
        AND ( ( NVL(zc_name,'')  LIKE '%熊山镇'   AND zc_city ='350725' )---城关镇
           OR ( NVL(zc_name,'')  LIKE '%双溪镇'  AND  zc_city ='350721' )
           OR ( NVL(zc_name,'')  LIKE '%雪峰镇'  AND  zc_city ='350421' )
           OR ( NVL(zc_name,'')  LIKE '%龙津镇'  AND  zc_city ='350423' )
           OR ( NVL(zc_name,'')  LIKE '%杨舍镇'  AND  zc_city ='320582' )
           OR ( NVL(zc_name,'')  LIKE '%玉山镇'  AND  zc_city ='320583' )
           OR ( NVL(zc_name,'')  LIKE '%城厢镇'  AND  zc_city ='320585' )
           OR ( NVL(zc_name,'')  LIKE '%城关镇'  AND  zc_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(zc_name,'')  LIKE '%首善镇'  AND  zc_city ='610326' )
           OR ( NVL(zc_name,'')  LIKE '%高亭镇'  AND  zc_city ='330921' )
           OR ( NVL(zc_name,'')  LIKE '%华埠镇'  AND  zc_city ='330824' )
           OR ( NVL(zc_name,'')  LIKE '%灵溪镇'  AND  zc_city ='330327' )
           OR ( NVL(zc_name,'')  LIKE '%昆阳镇'  AND  zc_city ='330326' )
           OR ( NVL(zc_name,'')  LIKE '%罗阳镇'  AND  zc_city ='330329' )
           OR ( NVL(zc_name,'')  LIKE '%大峃镇'  AND  zc_city ='330328' )
           OR ( NVL(zc_name,'')  LIKE '%龙港镇'  AND  zc_city ='330383' ))
       AND NVL(zc,'')  LIKE '%村%'  AND NVL(zc,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(zc_fourthaddress,'') <>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND  NVL(zc_name,'') LIKE '%镇'
        AND (  NVL(zc_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(zc_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(zc_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(zc_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(zc_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(zc_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(zc_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(zc_name,'')  NOT LIKE '%城关镇'
           AND  NVL(zc_name,'')  NOT LIKE '%首善镇'
           AND  NVL(zc_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(zc_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(zc_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(zc_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(zc_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(zc_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(zc_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(zc_fourthaddress,'')<>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND NVL(zc_name,'') LIKE '%镇'
        AND ((NVL(zc_name,'')   LIKE '%熊山镇'   AND  zc_city  <> '350725' )---城关镇
           OR ( NVL(zc_name,'')   LIKE '%双溪镇'  AND  zc_city <>'350721' )
           OR ( NVL(zc_name,'')   LIKE '%雪峰镇'  AND  zc_city <>'350421' )
           OR ( NVL(zc_name,'')   LIKE '%龙津镇'  AND  zc_city <>'350423' )
           OR ( NVL(zc_name,'')   LIKE '%杨舍镇'  AND  zc_city <>'320582' )
           OR ( NVL(zc_name,'')   LIKE '%玉山镇'  AND  zc_city <>'320583' )
           OR ( NVL(zc_name,'')   LIKE '%城厢镇'  AND  zc_city <>'320585' )
           OR ( NVL(zc_name,'')   LIKE '%城关镇'  AND  zc_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(zc_name,'')   LIKE '%首善镇'  AND  zc_city <>'610326' )
           OR ( NVL(zc_name,'')   LIKE '%高亭镇'  AND  zc_city <>'330921' )
           OR ( NVL(zc_name,'')   LIKE '%华埠镇'  AND  zc_city <>'330824' )
           OR ( NVL(zc_name,'')   LIKE '%灵溪镇'  AND  zc_city <>'330327' )
           OR ( NVL(zc_name,'')   LIKE '%昆阳镇'  AND  zc_city <>'330326' )
           OR ( NVL(zc_name,'')   LIKE '%罗阳镇'  AND  zc_city <>'330329' )
           OR ( NVL(zc_name,'')   LIKE '%大峃镇'  AND  zc_city <>'330328' )
           OR ( NVL(zc_name,'')   LIKE '%龙港镇'  AND  zc_city <>'330383' ))
        THEN  '1'
WHEN NVL(zc_fourthaddress,'')<>'' and   substr(zc_fourthaddress,7,6) <>'999999' AND NVL(zc,'')  LIKE '%村%'  AND NVL(zc,'') not LIKE '%新村%'  THEN  '1'
  when NVL(zc_fourthaddress,'')='' and   substr(zc_fourthaddress,7,6) <>'999999' AND LENGTH(zc)-length(replace(zc,'乡','')) =1 and (
          zc not like '%肥乡区%'
     and  zc not like '%柏乡县%'
     and  zc not like '%平乡县%'
     and  zc not like '%武乡县%'
     and  zc not like '%乡宁县%'
     and  zc not like '%桐乡市%'
     and  zc not like '%萍乡市%'
     and  zc not like '%东乡区%'
     and  zc not like '%金乡县%'
     and  zc not like '%新乡市%'
     and  zc not like '%新乡县%'
     and  zc not like '%内乡县%'
     and  zc not like '%宁乡市%'
     and  zc not like '%湘乡市%'
     and  zc not like '%安乡县%'
     and  zc not like '%西乡塘区%'
     and  zc not like '%乡城县%'
     and  zc not like '%西乡县%'
     and  zc not like '%东乡族自治县%'
     and  zc not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999') and LENGTH(zc)-length(replace(zc,'乡','')) >1 then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) =1  and
 (
          zc  like '%天镇县%'
     OR  zc  like '%丰镇市%'
     OR  zc  like '%北镇市%'
     OR  zc  like '%镇赉县%'
     OR  zc  like '%镇江市%'
     OR  zc  like '%镇海区%'
     OR  zc  like '%固镇县%'
     OR  zc  like '%景德镇市%'
     OR  zc  like '%镇平县%'
     OR  zc  like '%清镇市%'
     OR  zc  like '%镇宁布依族苗族自治县%'
     OR  zc  like '%镇远县%'
     OR  zc  like '%镇雄县%'
     OR  zc  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  zc  like '%镇康县%'
     OR  zc  like '%镇巴县%'
     OR  zc  like '%镇坪县%'
     OR  zc  like '%镇安县%'
     OR  zc  like '%镇原县%'   ---区县
     OR (zc  like '%熊山镇%'    and  zc_city ='350725' )---城关镇
     OR ( zc  like '%双溪镇%'   and  zc_city ='350721' )
     OR ( zc  like '%雪峰镇%'   and  zc_city ='350421' )
     OR ( zc  like '%龙津镇%'   and  zc_city ='350423' )
     OR ( zc  like '%杨舍镇%'   and  zc_city ='320582' )
     OR ( zc  like '%玉山镇%'   and  zc_city ='320583' )
     OR ( zc  like '%城厢镇%'   and  zc_city ='320585' )
     OR ( zc  like '%城关镇%'   and  zc_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( zc  like '%首善镇%'   and  zc_city ='610326' )
     OR ( zc  like '%高亭镇%'   and  zc_city ='330921' )
     OR ( zc  like '%华埠镇%'   and  zc_city ='330824' )
     OR ( zc  like '%灵溪镇%'   and  zc_city ='330327' )
     OR ( zc  like '%昆阳镇%'   and  zc_city ='330326' )
     OR ( zc  like '%罗阳镇%'   and  zc_city ='330329' )
     OR ( zc  like '%大峃镇%'   and  zc_city ='330328' )
     OR ( zc  like '%龙港镇%'   and  zc_city ='330383' )
 )   and zc like '%村%' and zc not like '%新村%'  then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and  LENGTH(zc)-length(replace(zc,'镇','')) =1  and
(

   (      zc  like '%熊山镇%'   and zc_city  <>'350725' )---城关镇
     OR ( zc  like '%双溪镇%'  and  zc_city  <>'350721' )
     OR ( zc  like '%雪峰镇%'  and  zc_city <>'350421' )
     OR ( zc  like '%龙津镇%'  and  zc_city <>'350423' )
     OR ( zc  like '%杨舍镇%'  and  zc_city <>'320582' )
     OR ( zc  like '%玉山镇%'  and  zc_city <>'320583' )
     OR ( zc  like '%城厢镇%'  and  zc_city <>'320585' )
     OR ( zc  like '%城关镇%'  and  zc_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( zc  like '%首善镇%'  and  zc_city <> '610326' )
     OR ( zc  like '%高亭镇%'  and  zc_city <>'330921' )
     OR ( zc  like '%华埠镇%'  and  zc_city <>'330824' )
     OR ( zc  like '%灵溪镇%'  and  zc_city <>'330327' )
     OR ( zc  like '%昆阳镇%'  and  zc_city <>'330326' )
     OR ( zc  like '%罗阳镇%'  and  zc_city <>'330329' )
     OR ( zc  like '%大峃镇%'  and  zc_city <>'330328' )
     OR ( zc  like '%龙港镇%'  and  zc_city <>'330383' )

	 ) then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) =1  and
 (
          zc not like '%天镇县%'
     and  zc not like '%丰镇市%'
     and  zc not like '%北镇市%'
     and  zc not like '%镇赉县%'
     and  zc not like '%镇江市%'
     and  zc not like '%镇海区%'
     and  zc not like '%固镇县%'
     and  zc not like '%景德镇市%'
     and  zc not like '%镇平县%'
     and  zc not like '%清镇市%'
     and  zc not like '%镇宁布依族苗族自治县%'
     and  zc not like '%镇远县%'
     and  zc not like '%镇雄县%'
     and  zc not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  zc not like '%镇康县%'
     and  zc not like '%镇巴县%'
     and  zc not like '%镇坪县%'
     and  zc not like '%镇安县%'
     and  zc not like '%镇原县%'
)
and ( zc not like '%熊山镇%'
     and  zc not like '%双溪镇%'
     and  zc not like '%雪峰镇%'
     and  zc not like '%龙津镇%'
     and  zc not like '%杨舍镇%'
     and  zc not like '%玉山镇%'
     and  zc not like '%城厢镇%'
     and  zc not like '%城关镇%'
     and  zc not like '%首善镇%'
     and  zc not like '%高亭镇%'
     and  zc not like '%华埠镇%'
     and  zc not like '%灵溪镇%'
     and  zc not like '%昆阳镇%'
     and  zc not like '%罗阳镇%'
     and  zc not like '%大峃镇%'
     and  zc not like '%龙港镇%'
 )  then '1'
  when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) >1 and  (
         ( substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%熊山镇%'  and  zc_city ='350725' )---城关镇
     OR  ( substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%双溪镇%'  and  zc_city ='350721' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%雪峰镇%'   and  zc_city ='350421' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙津镇%'   and  zc_city ='350423' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%杨舍镇%'   and  zc_city ='320582' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%玉山镇%'   and  zc_city ='320583' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城厢镇%'   and  zc_city ='320585' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城关镇%'   and  zc_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%首善镇%'   and  zc_city ='610326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%高亭镇%'   and  zc_city ='330921' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%华埠镇%'   and  zc_city ='330824' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%灵溪镇%'   and  zc_city ='330327' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%昆阳镇%'   and  zc_city ='330326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%罗阳镇%'   and  zc_city ='330329' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%大峃镇%'   and  zc_city ='330328' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙港镇%'   and  zc_city ='330383' )
 ) AND zc LIKE '%村%' AND zc not LIKE '%新村%' then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and  LENGTH(zc)-length(replace(zc,'镇','')) >1 and  (
         ( substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%熊山镇%'  and  zc_city <>'350725' )---城关镇
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%双溪镇%'   and  zc_city <>'350721' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%雪峰镇%'   and  zc_city <>'350421' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙津镇%'   and  zc_city <>'350423' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%杨舍镇%'   and  zc_city <>'320582' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%玉山镇%'   and  zc_city <>'320583' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城厢镇%'   and  zc_city <>'320585' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%城关镇%'  and  zc_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%首善镇%'  and  zc_city <>'610326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%高亭镇%'  and  zc_city <>'330921' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%华埠镇%'  and  zc_city <> '330824' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%灵溪镇%'  and  zc_city <> '330327' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%昆阳镇%'  and  zc_city <>'330326' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%罗阳镇%'  and  zc_city <>'330329' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%大峃镇%'  and  zc_city <>'330328' )
     OR  (substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1))  like '%龙港镇%'  and  zc_city <>'330383' )
 )  then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and LENGTH(zc)-length(replace(zc,'镇','')) >1 and  (
          substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%熊山镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%双溪镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%雪峰镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%龙津镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%杨舍镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%玉山镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%城厢镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%城关镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%首善镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%高亭镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%华埠镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%灵溪镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%昆阳镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%罗阳镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%大峃镇%'
     and  substr(zc,instr(zc,'镇',-2),instr(zc,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when ( NVL(zc_fourthaddress,'')='' or   substr(zc_fourthaddress,7,6) ='999999')  and zc like '%村%' and zc not like '%新村%'  then '1'
    else '0' end  is_zc
    ,jy
    ,jy_city
,jy_fourthaddress
,jy_name
,jy_ismainaddress
  ,CASE
   WHEN NVL(jy_fourthaddress,'')<>''  and   substr(jy_fourthaddress,7,6) <>'999999'  AND NVL(jy_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(jy_fourthaddress,'')<>'' and   substr(jy_fourthaddress,7,6) <>'999999' AND NVL(jy_name,'') LIKE '%镇'
        AND ( ( NVL(jy_name,'')  LIKE '%熊山镇'   AND jy_city ='350725' )---城关镇
           OR ( NVL(jy_name,'')  LIKE '%双溪镇'  AND  jy_city ='350721' )
           OR ( NVL(jy_name,'')  LIKE '%雪峰镇'  AND  jy_city ='350421' )
           OR ( NVL(jy_name,'')  LIKE '%龙津镇'  AND  jy_city ='350423' )
           OR ( NVL(jy_name,'')  LIKE '%杨舍镇'  AND  jy_city ='320582' )
           OR ( NVL(jy_name,'')  LIKE '%玉山镇'  AND  jy_city ='320583' )
           OR ( NVL(jy_name,'')  LIKE '%城厢镇'  AND  jy_city ='320585' )
           OR ( NVL(jy_name,'')  LIKE '%城关镇'  AND  jy_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(jy_name,'')  LIKE '%首善镇'  AND  jy_city ='610326' )
           OR ( NVL(jy_name,'')  LIKE '%高亭镇'  AND  jy_city ='330921' )
           OR ( NVL(jy_name,'')  LIKE '%华埠镇'  AND  jy_city ='330824' )
           OR ( NVL(jy_name,'')  LIKE '%灵溪镇'  AND  jy_city ='330327' )
           OR ( NVL(jy_name,'')  LIKE '%昆阳镇'  AND  jy_city ='330326' )
           OR ( NVL(jy_name,'')  LIKE '%罗阳镇'  AND  jy_city ='330329' )
           OR ( NVL(jy_name,'')  LIKE '%大峃镇'  AND  jy_city ='330328' )
           OR ( NVL(jy_name,'')  LIKE '%龙港镇'  AND  jy_city ='330383' ))
       AND NVL(jy,'')  LIKE '%村%'  AND NVL(jy,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(jy_fourthaddress,'') <>'' and   substr(jy_fourthaddress,7,6) <>'999999' AND  NVL(jy_name,'') LIKE '%镇'
        AND (  NVL(jy_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(jy_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(jy_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(jy_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(jy_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(jy_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(jy_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(jy_name,'')  NOT LIKE '%城关镇'
           AND  NVL(jy_name,'')  NOT LIKE '%首善镇'
           AND  NVL(jy_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(jy_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(jy_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(jy_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(jy_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(jy_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(jy_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(jy_fourthaddress,'')<>'' and   substr(jy_fourthaddress,7,6) <>'999999' AND NVL(jy_name,'') LIKE '%镇'
        AND ((NVL(jy_name,'')   LIKE '%熊山镇'   AND  jy_city  <> '350725' )---城关镇
           OR ( NVL(jy_name,'')   LIKE '%双溪镇'  AND  jy_city <>'350721' )
           OR ( NVL(jy_name,'')   LIKE '%雪峰镇'  AND  jy_city <>'350421' )
           OR ( NVL(jy_name,'')   LIKE '%龙津镇'  AND  jy_city <>'350423' )
           OR ( NVL(jy_name,'')   LIKE '%杨舍镇'  AND  jy_city <>'320582' )
           OR ( NVL(jy_name,'')   LIKE '%玉山镇'  AND  jy_city <>'320583' )
           OR ( NVL(jy_name,'')   LIKE '%城厢镇'  AND  jy_city <>'320585' )
           OR ( NVL(jy_name,'')   LIKE '%城关镇'  AND  jy_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(jy_name,'')   LIKE '%首善镇'  AND  jy_city <>'610326' )
           OR ( NVL(jy_name,'')   LIKE '%高亭镇'  AND  jy_city <>'330921' )
           OR ( NVL(jy_name,'')   LIKE '%华埠镇'  AND  jy_city <>'330824' )
           OR ( NVL(jy_name,'')   LIKE '%灵溪镇'  AND  jy_city <>'330327' )
           OR ( NVL(jy_name,'')   LIKE '%昆阳镇'  AND  jy_city <>'330326' )
           OR ( NVL(jy_name,'')   LIKE '%罗阳镇'  AND  jy_city <>'330329' )
           OR ( NVL(jy_name,'')   LIKE '%大峃镇'  AND  jy_city <>'330328' )
           OR ( NVL(jy_name,'')   LIKE '%龙港镇'  AND  jy_city <>'330383' ))
        THEN  '1'
WHEN NVL(jy_fourthaddress,'')<>'' and   substr(jy_fourthaddress,7,6) <>'999999' AND NVL(jy,'')  LIKE '%村%'  AND NVL(jy,'') not LIKE '%新村%'  THEN  '1'
  when NVL(jy_fourthaddress,'')='' and   substr(jy_fourthaddress,7,6) <>'999999' AND LENGTH(jy)-length(replace(jy,'乡','')) =1 and (
          jy not like '%肥乡区%'
     and  jy not like '%柏乡县%'
     and  jy not like '%平乡县%'
     and  jy not like '%武乡县%'
     and  jy not like '%乡宁县%'
     and  jy not like '%桐乡市%'
     and  jy not like '%萍乡市%'
     and  jy not like '%东乡区%'
     and  jy not like '%金乡县%'
     and  jy not like '%新乡市%'
     and  jy not like '%新乡县%'
     and  jy not like '%内乡县%'
     and  jy not like '%宁乡市%'
     and  jy not like '%湘乡市%'
     and  jy not like '%安乡县%'
     and  jy not like '%西乡塘区%'
     and  jy not like '%乡城县%'
     and  jy not like '%西乡县%'
     and  jy not like '%东乡族自治县%'
     and  jy not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999') and LENGTH(jy)-length(replace(jy,'乡','')) >1 then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and LENGTH(jy)-length(replace(jy,'镇','')) =1  and
 (
          jy  like '%天镇县%'
     OR  jy  like '%丰镇市%'
     OR  jy  like '%北镇市%'
     OR  jy  like '%镇赉县%'
     OR  jy  like '%镇江市%'
     OR  jy  like '%镇海区%'
     OR  jy  like '%固镇县%'
     OR  jy  like '%景德镇市%'
     OR  jy  like '%镇平县%'
     OR  jy  like '%清镇市%'
     OR  jy  like '%镇宁布依族苗族自治县%'
     OR  jy  like '%镇远县%'
     OR  jy  like '%镇雄县%'
     OR  jy  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  jy  like '%镇康县%'
     OR  jy  like '%镇巴县%'
     OR  jy  like '%镇坪县%'
     OR  jy  like '%镇安县%'
     OR  jy  like '%镇原县%'   ---区县
     OR (jy  like '%熊山镇%'    and  jy_city ='350725' )---城关镇
     OR ( jy  like '%双溪镇%'   and  jy_city ='350721' )
     OR ( jy  like '%雪峰镇%'   and  jy_city ='350421' )
     OR ( jy  like '%龙津镇%'   and  jy_city ='350423' )
     OR ( jy  like '%杨舍镇%'   and  jy_city ='320582' )
     OR ( jy  like '%玉山镇%'   and  jy_city ='320583' )
     OR ( jy  like '%城厢镇%'   and  jy_city ='320585' )
     OR ( jy  like '%城关镇%'   and  jy_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( jy  like '%首善镇%'   and  jy_city ='610326' )
     OR ( jy  like '%高亭镇%'   and  jy_city ='330921' )
     OR ( jy  like '%华埠镇%'   and  jy_city ='330824' )
     OR ( jy  like '%灵溪镇%'   and  jy_city ='330327' )
     OR ( jy  like '%昆阳镇%'   and  jy_city ='330326' )
     OR ( jy  like '%罗阳镇%'   and  jy_city ='330329' )
     OR ( jy  like '%大峃镇%'   and  jy_city ='330328' )
     OR ( jy  like '%龙港镇%'   and  jy_city ='330383' )
 )   and jy like '%村%' and jy not like '%新村%'  then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and  LENGTH(jy)-length(replace(jy,'镇','')) =1  and
(

   (      jy  like '%熊山镇%'   and jy_city  <>'350725' )---城关镇
     OR ( jy  like '%双溪镇%'  and  jy_city  <>'350721' )
     OR ( jy  like '%雪峰镇%'  and  jy_city <>'350421' )
     OR ( jy  like '%龙津镇%'  and  jy_city <>'350423' )
     OR ( jy  like '%杨舍镇%'  and  jy_city <>'320582' )
     OR ( jy  like '%玉山镇%'  and  jy_city <>'320583' )
     OR ( jy  like '%城厢镇%'  and  jy_city <>'320585' )
     OR ( jy  like '%城关镇%'  and  jy_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( jy  like '%首善镇%'  and  jy_city <> '610326' )
     OR ( jy  like '%高亭镇%'  and  jy_city <>'330921' )
     OR ( jy  like '%华埠镇%'  and  jy_city <>'330824' )
     OR ( jy  like '%灵溪镇%'  and  jy_city <>'330327' )
     OR ( jy  like '%昆阳镇%'  and  jy_city <>'330326' )
     OR ( jy  like '%罗阳镇%'  and  jy_city <>'330329' )
     OR ( jy  like '%大峃镇%'  and  jy_city <>'330328' )
     OR ( jy  like '%龙港镇%'  and  jy_city <>'330383' )

	 ) then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and LENGTH(jy)-length(replace(jy,'镇','')) =1  and
 (
          jy not like '%天镇县%'
     and  jy not like '%丰镇市%'
     and  jy not like '%北镇市%'
     and  jy not like '%镇赉县%'
     and  jy not like '%镇江市%'
     and  jy not like '%镇海区%'
     and  jy not like '%固镇县%'
     and  jy not like '%景德镇市%'
     and  jy not like '%镇平县%'
     and  jy not like '%清镇市%'
     and  jy not like '%镇宁布依族苗族自治县%'
     and  jy not like '%镇远县%'
     and  jy not like '%镇雄县%'
     and  jy not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  jy not like '%镇康县%'
     and  jy not like '%镇巴县%'
     and  jy not like '%镇坪县%'
     and  jy not like '%镇安县%'
     and  jy not like '%镇原县%'
)
and ( jy not like '%熊山镇%'
     and  jy not like '%双溪镇%'
     and  jy not like '%雪峰镇%'
     and  jy not like '%龙津镇%'
     and  jy not like '%杨舍镇%'
     and  jy not like '%玉山镇%'
     and  jy not like '%城厢镇%'
     and  jy not like '%城关镇%'
     and  jy not like '%首善镇%'
     and  jy not like '%高亭镇%'
     and  jy not like '%华埠镇%'
     and  jy not like '%灵溪镇%'
     and  jy not like '%昆阳镇%'
     and  jy not like '%罗阳镇%'
     and  jy not like '%大峃镇%'
     and  jy not like '%龙港镇%'
 )  then '1'
  when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and LENGTH(jy)-length(replace(jy,'镇','')) >1 and  (
         ( substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%熊山镇%'  and  jy_city ='350725' )---城关镇
     OR  ( substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%双溪镇%'  and  jy_city ='350721' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%雪峰镇%'   and  jy_city ='350421' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%龙津镇%'   and  jy_city ='350423' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%杨舍镇%'   and  jy_city ='320582' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%玉山镇%'   and  jy_city ='320583' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%城厢镇%'   and  jy_city ='320585' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%城关镇%'   and  jy_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%首善镇%'   and  jy_city ='610326' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%高亭镇%'   and  jy_city ='330921' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%华埠镇%'   and  jy_city ='330824' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%灵溪镇%'   and  jy_city ='330327' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%昆阳镇%'   and  jy_city ='330326' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%罗阳镇%'   and  jy_city ='330329' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%大峃镇%'   and  jy_city ='330328' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%龙港镇%'   and  jy_city ='330383' )
 ) AND jy LIKE '%村%' AND jy not LIKE '%新村%' then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and  LENGTH(jy)-length(replace(jy,'镇','')) >1 and  (
         ( substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%熊山镇%'  and  jy_city <>'350725' )---城关镇
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%双溪镇%'   and  jy_city <>'350721' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%雪峰镇%'   and  jy_city <>'350421' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%龙津镇%'   and  jy_city <>'350423' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%杨舍镇%'   and  jy_city <>'320582' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%玉山镇%'   and  jy_city <>'320583' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%城厢镇%'   and  jy_city <>'320585' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%城关镇%'  and  jy_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%首善镇%'  and  jy_city <>'610326' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%高亭镇%'  and  jy_city <>'330921' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%华埠镇%'  and  jy_city <> '330824' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%灵溪镇%'  and  jy_city <> '330327' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%昆阳镇%'  and  jy_city <>'330326' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%罗阳镇%'  and  jy_city <>'330329' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%大峃镇%'  and  jy_city <>'330328' )
     OR  (substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1))  like '%龙港镇%'  and  jy_city <>'330383' )
 )  then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and LENGTH(jy)-length(replace(jy,'镇','')) >1 and  (
          substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%熊山镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%双溪镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%雪峰镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%龙津镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%杨舍镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%玉山镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%城厢镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%城关镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%首善镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%高亭镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%华埠镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%灵溪镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%昆阳镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%罗阳镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%大峃镇%'
     and  substr(jy,instr(jy,'镇',-2),instr(jy,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when ( NVL(jy_fourthaddress,'')='' or   substr(jy_fourthaddress,7,6) ='999999')  and jy like '%村%' and jy not like '%新村%'  then '1'
    else '0' end  is_jy
  ,jt
  ,jt_city
,jt_fourthaddress
,jt_name
,jt_ismainaddress
  ,CASE
   WHEN NVL(jt_fourthaddress,'')<>'' and substr(jt_fourthaddress,7,6) <> '999999'  AND NVL(jt_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(jt_fourthaddress,'')<>'' and substr(jt_fourthaddress,7,6) <> '999999' AND NVL(jt_name,'') LIKE '%镇'
        AND ( ( NVL(jt_name,'')  LIKE '%熊山镇'   AND jt_city ='350725' )---城关镇
           OR ( NVL(jt_name,'')  LIKE '%双溪镇'  AND  jt_city ='350721' )
           OR ( NVL(jt_name,'')  LIKE '%雪峰镇'  AND  jt_city ='350421' )
           OR ( NVL(jt_name,'')  LIKE '%龙津镇'  AND  jt_city ='350423' )
           OR ( NVL(jt_name,'')  LIKE '%杨舍镇'  AND  jt_city ='320582' )
           OR ( NVL(jt_name,'')  LIKE '%玉山镇'  AND  jt_city ='320583' )
           OR ( NVL(jt_name,'')  LIKE '%城厢镇'  AND  jt_city ='320585' )
           OR ( NVL(jt_name,'')  LIKE '%城关镇'  AND  jt_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(jt_name,'')  LIKE '%首善镇'  AND  jt_city ='610326' )
           OR ( NVL(jt_name,'')  LIKE '%高亭镇'  AND  jt_city ='330921' )
           OR ( NVL(jt_name,'')  LIKE '%华埠镇'  AND  jt_city ='330824' )
           OR ( NVL(jt_name,'')  LIKE '%灵溪镇'  AND  jt_city ='330327' )
           OR ( NVL(jt_name,'')  LIKE '%昆阳镇'  AND  jt_city ='330326' )
           OR ( NVL(jt_name,'')  LIKE '%罗阳镇'  AND  jt_city ='330329' )
           OR ( NVL(jt_name,'')  LIKE '%大峃镇'  AND  jt_city ='330328' )
           OR ( NVL(jt_name,'')  LIKE '%龙港镇'  AND  jt_city ='330383' ))
       AND NVL(jt,'')  LIKE '%村%'  AND NVL(jt,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(jt_fourthaddress,'') <>'' and substr(jt_fourthaddress,7,6) <> '999999' AND  NVL(jt_name,'') LIKE '%镇'
        AND (  NVL(jt_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(jt_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(jt_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(jt_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(jt_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(jt_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(jt_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(jt_name,'')  NOT LIKE '%城关镇'
           AND  NVL(jt_name,'')  NOT LIKE '%首善镇'
           AND  NVL(jt_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(jt_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(jt_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(jt_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(jt_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(jt_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(jt_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(jt_fourthaddress,'')<>'' and substr(jt_fourthaddress,7,6) <> '999999' AND NVL(jt_name,'') LIKE '%镇'
        AND ((NVL(jt_name,'')   LIKE '%熊山镇'   AND  jt_city  <> '350725' )---城关镇
           OR ( NVL(jt_name,'')   LIKE '%双溪镇'  AND  jt_city <>'350721' )
           OR ( NVL(jt_name,'')   LIKE '%雪峰镇'  AND  jt_city <>'350421' )
           OR ( NVL(jt_name,'')   LIKE '%龙津镇'  AND  jt_city <>'350423' )
           OR ( NVL(jt_name,'')   LIKE '%杨舍镇'  AND  jt_city <>'320582' )
           OR ( NVL(jt_name,'')   LIKE '%玉山镇'  AND  jt_city <>'320583' )
           OR ( NVL(jt_name,'')   LIKE '%城厢镇'  AND  jt_city <>'320585' )
           OR ( NVL(jt_name,'')   LIKE '%城关镇'  AND  jt_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(jt_name,'')   LIKE '%首善镇'  AND  jt_city <>'610326' )
           OR ( NVL(jt_name,'')   LIKE '%高亭镇'  AND  jt_city <>'330921' )
           OR ( NVL(jt_name,'')   LIKE '%华埠镇'  AND  jt_city <>'330824' )
           OR ( NVL(jt_name,'')   LIKE '%灵溪镇'  AND  jt_city <>'330327' )
           OR ( NVL(jt_name,'')   LIKE '%昆阳镇'  AND  jt_city <>'330326' )
           OR ( NVL(jt_name,'')   LIKE '%罗阳镇'  AND  jt_city <>'330329' )
           OR ( NVL(jt_name,'')   LIKE '%大峃镇'  AND  jt_city <>'330328' )
           OR ( NVL(jt_name,'')   LIKE '%龙港镇'  AND  jt_city <>'330383' ))
        THEN  '1'
WHEN NVL(jt_fourthaddress,'')<>'' and substr(jt_fourthaddress,7,6) <> '999999' AND NVL(jt,'')  LIKE '%村%'  AND NVL(jt,'') not LIKE '%新村%'  THEN  '1'
   when  ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND LENGTH(jt)-length(replace(jt,'乡','')) =1 and (
          jt not like '%肥乡区%'
     and  jt not like '%柏乡县%'
     and  jt not like '%平乡县%'
     and  jt not like '%武乡县%'
     and  jt not like '%乡宁县%'
     and  jt not like '%桐乡市%'
     and  jt not like '%萍乡市%'
     and  jt not like '%东乡区%'
     and  jt not like '%金乡县%'
     and  jt not like '%新乡市%'
     and  jt not like '%新乡县%'
     and  jt not like '%内乡县%'
     and  jt not like '%宁乡市%'
     and  jt not like '%湘乡市%'
     and  jt not like '%安乡县%'
     and  jt not like '%西乡塘区%'
     and  jt not like '%乡城县%'
     and  jt not like '%西乡县%'
     and  jt not like '%东乡族自治县%'
     and  jt not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND LENGTH(jt)-length(replace(jt,'乡','')) >1 then '1'
 when  ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND LENGTH(jt)-length(replace(jt,'镇','')) =1  and
 (
          jt  like '%天镇县%'
     OR  jt  like '%丰镇市%'
     OR  jt  like '%北镇市%'
     OR  jt  like '%镇赉县%'
     OR  jt  like '%镇江市%'
     OR  jt  like '%镇海区%'
     OR  jt  like '%固镇县%'
     OR  jt  like '%景德镇市%'
     OR  jt  like '%镇平县%'
     OR  jt  like '%清镇市%'
     OR  jt  like '%镇宁布依族苗族自治县%'
     OR  jt  like '%镇远县%'
     OR  jt  like '%镇雄县%'
     OR  jt  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  jt  like '%镇康县%'
     OR  jt  like '%镇巴县%'
     OR  jt  like '%镇坪县%'
     OR  jt  like '%镇安县%'
     OR  jt  like '%镇原县%'   ---区县
     OR  (jt  like '%熊山镇%'  and  jt_city ='350725' )---城关镇
     OR  (jt  like '%双溪镇%'  and  jt_city ='350721' )
     OR  (jt  like '%雪峰镇%'  and  jt_city ='350421' )
     OR  (jt  like '%龙津镇%'  and  jt_city ='350423' )
     OR  (jt  like '%杨舍镇%'  and  jt_city ='320582' )
     OR  (jt  like '%玉山镇%'  and  jt_city ='320583' )
     OR  (jt  like '%城厢镇%'  and  jt_city ='320585' )
     OR  (jt  like '%城关镇%'  and  jt_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (jt  like '%首善镇%'  and  jt_city ='610326' )
     OR  (jt  like '%高亭镇%'  and  jt_city ='330921' )
     OR  (jt  like '%华埠镇%'  and  jt_city ='330824' )
     OR  (jt  like '%灵溪镇%'  and  jt_city ='330327' )
     OR  (jt  like '%昆阳镇%'  and  jt_city ='330326' )
     OR  (jt  like '%罗阳镇%'  and  jt_city ='330329' )
     OR  (jt  like '%大峃镇%'  and  jt_city ='330328' )
     OR  (jt  like '%龙港镇%'  and  jt_city ='330383' )
 )   and jt like '%村%' and jt not like '%新村%'  then '1'
 when ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) and  LENGTH(jt)-length(replace(jt,'镇','')) =1  and
(
   (      jt  like '%熊山镇%'   and jt_city  <>'350725' )---城关镇
     OR ( jt  like '%双溪镇%'  and  jt_city  <>'350721' )
     OR ( jt  like '%雪峰镇%'  and  jt_city <>'350421' )
     OR ( jt  like '%龙津镇%'  and  jt_city <>'350423' )
     OR ( jt  like '%杨舍镇%'  and  jt_city <>'320582' )
     OR ( jt  like '%玉山镇%'  and  jt_city <>'320583' )
     OR ( jt  like '%城厢镇%'  and  jt_city <>'320585' )
     OR ( jt  like '%城关镇%'  and  jt_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( jt  like '%首善镇%'  and  jt_city <> '610326' )
     OR ( jt  like '%高亭镇%'  and  jt_city <>'330921' )
     OR ( jt  like '%华埠镇%'  and  jt_city <>'330824' )
     OR ( jt  like '%灵溪镇%'  and  jt_city <>'330327' )
     OR ( jt  like '%昆阳镇%'  and  jt_city <>'330326' )
     OR ( jt  like '%罗阳镇%'  and  jt_city <>'330329' )
     OR ( jt  like '%大峃镇%'  and  jt_city <>'330328' )
     OR ( jt  like '%龙港镇%'  and  jt_city <>'330383' )
	 ) then '1'
 when  ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND LENGTH(jt)-length(replace(jt,'镇','')) =1  and
 (
          jt not like '%天镇县%'
     and  jt not like '%丰镇市%'
     and  jt not like '%北镇市%'
     and  jt not like '%镇赉县%'
     and  jt not like '%镇江市%'
     and  jt not like '%镇海区%'
     and  jt not like '%固镇县%'
     and  jt not like '%景德镇市%'
     and  jt not like '%镇平县%'
     and  jt not like '%清镇市%'
     and  jt not like '%镇宁布依族苗族自治县%'
     and  jt not like '%镇远县%'
     and  jt not like '%镇雄县%'
     and  jt not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  jt not like '%镇康县%'
     and  jt not like '%镇巴县%'
     and  jt not like '%镇坪县%'
     and  jt not like '%镇安县%'
     and  jt not like '%镇原县%'
)
and ( jt not like '%熊山镇%'     ---城关镇
     and  jt not like '%双溪镇%'
     and  jt not like '%雪峰镇%'
     and  jt not like '%龙津镇%'
     and  jt not like '%杨舍镇%'
     and  jt not like '%玉山镇%'
     and  jt not like '%城厢镇%'
     and  jt not like '%城关镇%'
     and  jt not like '%首善镇%'
     and  jt not like '%高亭镇%'
     and  jt not like '%华埠镇%'
     and  jt not like '%灵溪镇%'
     and  jt not like '%昆阳镇%'
     and  jt not like '%罗阳镇%'
     and  jt not like '%大峃镇%'
     and  jt not like '%龙港镇%'
 )   then '1'
  when  ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND LENGTH(jt)-length(replace(jt,'镇','')) >1 and  (
         ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%熊山镇%' and  jt_city ='350725' )---城关镇
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%双溪镇%'  and  jt_city ='350721' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%雪峰镇%'  and  jt_city ='350421' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%龙津镇%'  and  jt_city ='350423' )
     OR (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%杨舍镇%'   and  jt_city ='320582' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%玉山镇%'  and  jt_city ='320583' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%城厢镇%'  and  jt_city ='320585' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%城关镇%'  and  jt_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%首善镇%'  and  jt_city ='610326' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%高亭镇%'  and  jt_city ='330921' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%华埠镇%'  and  jt_city ='330824' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%灵溪镇%'  and  jt_city ='330327' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%昆阳镇%'  and  jt_city ='330326' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%罗阳镇%'  and  jt_city ='330329' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%大峃镇%'  and  jt_city ='330328' )
     OR ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%龙港镇%'  and  jt_city ='330383' )
 ) AND jt LIKE '%村%' AND jt not LIKE '%新村%' then '1'
 when ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) and  LENGTH(jt)-length(replace(jt,'镇','')) >1 and  (
         ( substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%熊山镇%'  and  jt_city <>'350725' )---城关镇
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%双溪镇%'   and  jt_city <>'350721' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%雪峰镇%'   and  jt_city <>'350421' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%龙津镇%'   and  jt_city <>'350423' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%杨舍镇%'   and  jt_city <>'320582' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%玉山镇%'   and  jt_city <>'320583' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%城厢镇%'   and  jt_city <>'320585' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%城关镇%'  and  jt_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%首善镇%'  and  jt_city <>'610326' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%高亭镇%'  and  jt_city <>'330921' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%华埠镇%'  and  jt_city <> '330824' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%灵溪镇%'  and  jt_city <> '330327' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%昆阳镇%'  and  jt_city <>'330326' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%罗阳镇%'  and  jt_city <>'330329' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%大峃镇%'  and  jt_city <>'330328' )
     OR  (substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1))  like '%龙港镇%'  and  jt_city <>'330383' )
 )  then '1'
 when  ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND LENGTH(jt)-length(replace(jt,'镇','')) >1 and  (
          substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%熊山镇%' ---城关镇
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%双溪镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%雪峰镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%龙津镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%杨舍镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%玉山镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%城厢镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%城关镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%首善镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%高亭镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%华埠镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%灵溪镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%昆阳镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%罗阳镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%大峃镇%'
     and  substr(jt,instr(jt,'镇',-2),instr(jt,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when  ( NVL(jt_fourthaddress,'')='' or substr(jt_fourthaddress,7,6) = '999999' ) AND jt like '%村%' and jt not like '%新村%'  then '1'
    else '0' end  is_jt
    ,tx
    ,tx_city
,tx_fourthaddress
,tx_name
,tx_ismainaddress
  ,CASE
   WHEN NVL(tx_fourthaddress,'')<>''  and   substr(tx_fourthaddress,7,6) <>'999999'  AND NVL(tx_name,'') LIKE '%乡' THEN  '1'
 WHEN NVL(tx_fourthaddress,'')<>'' and   substr(tx_fourthaddress,7,6) <>'999999' AND NVL(tx_name,'') LIKE '%镇'
        AND ( ( NVL(tx_name,'')  LIKE '%熊山镇'   AND tx_city ='350725' )---城关镇
           OR ( NVL(tx_name,'')  LIKE '%双溪镇'  AND  tx_city ='350721' )
           OR ( NVL(tx_name,'')  LIKE '%雪峰镇'  AND  tx_city ='350421' )
           OR ( NVL(tx_name,'')  LIKE '%龙津镇'  AND  tx_city ='350423' )
           OR ( NVL(tx_name,'')  LIKE '%杨舍镇'  AND  tx_city ='320582' )
           OR ( NVL(tx_name,'')  LIKE '%玉山镇'  AND  tx_city ='320583' )
           OR ( NVL(tx_name,'')  LIKE '%城厢镇'  AND  tx_city ='320585' )
           OR ( NVL(tx_name,'')  LIKE '%城关镇'  AND  tx_city  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(tx_name,'')  LIKE '%首善镇'  AND  tx_city ='610326' )
           OR ( NVL(tx_name,'')  LIKE '%高亭镇'  AND  tx_city ='330921' )
           OR ( NVL(tx_name,'')  LIKE '%华埠镇'  AND  tx_city ='330824' )
           OR ( NVL(tx_name,'')  LIKE '%灵溪镇'  AND  tx_city ='330327' )
           OR ( NVL(tx_name,'')  LIKE '%昆阳镇'  AND  tx_city ='330326' )
           OR ( NVL(tx_name,'')  LIKE '%罗阳镇'  AND  tx_city ='330329' )
           OR ( NVL(tx_name,'')  LIKE '%大峃镇'  AND  tx_city ='330328' )
           OR ( NVL(tx_name,'')  LIKE '%龙港镇'  AND  tx_city ='330383' ))
       AND NVL(tx,'')  LIKE '%村%'  AND NVL(tx,'') not LIKE '%新村%'  THEN '1'
WHEN NVL(tx_fourthaddress,'') <>'' and   substr(tx_fourthaddress,7,6) <>'999999' AND  NVL(tx_name,'') LIKE '%镇'
        AND (  NVL(tx_name,'')  NOT LIKE '%熊山镇'
           AND  NVL(tx_name,'')  NOT LIKE '%双溪镇'
           AND  NVL(tx_name,'')  NOT LIKE '%雪峰镇'
           AND  NVL(tx_name,'')  NOT LIKE '%龙津镇'
           AND  NVL(tx_name,'')  NOT LIKE '%杨舍镇'
           AND  NVL(tx_name,'')  NOT LIKE '%玉山镇'
           AND  NVL(tx_name,'')  NOT LIKE '%城厢镇'
           AND  NVL(tx_name,'')  NOT LIKE '%城关镇'
           AND  NVL(tx_name,'')  NOT LIKE '%首善镇'
           AND  NVL(tx_name,'')  NOT LIKE '%高亭镇'
           AND  NVL(tx_name,'')  NOT LIKE '%华埠镇'
           AND  NVL(tx_name,'')  NOT LIKE '%灵溪镇'
           AND  NVL(tx_name,'')  NOT LIKE '%昆阳镇'
           AND  NVL(tx_name,'')  NOT LIKE '%罗阳镇'
           AND  NVL(tx_name,'')  NOT LIKE '%大峃镇'
           AND  NVL(tx_name,'')  NOT LIKE '%龙港镇'
		   )
        THEN  '1'
WHEN NVL(tx_fourthaddress,'')<>'' and   substr(tx_fourthaddress,7,6) <>'999999' AND NVL(tx_name,'') LIKE '%镇'
        AND ((NVL(tx_name,'')   LIKE '%熊山镇'   AND  tx_city  <> '350725' )---城关镇
           OR ( NVL(tx_name,'')   LIKE '%双溪镇'  AND  tx_city <>'350721' )
           OR ( NVL(tx_name,'')   LIKE '%雪峰镇'  AND  tx_city <>'350421' )
           OR ( NVL(tx_name,'')   LIKE '%龙津镇'  AND  tx_city <>'350423' )
           OR ( NVL(tx_name,'')   LIKE '%杨舍镇'  AND  tx_city <>'320582' )
           OR ( NVL(tx_name,'')   LIKE '%玉山镇'  AND  tx_city <>'320583' )
           OR ( NVL(tx_name,'')   LIKE '%城厢镇'  AND  tx_city <>'320585' )
           OR ( NVL(tx_name,'')   LIKE '%城关镇'  AND  tx_city NOT  in ('610981','610928','610921','610929','610924','610926') )
           OR ( NVL(tx_name,'')   LIKE '%首善镇'  AND  tx_city <>'610326' )
           OR ( NVL(tx_name,'')   LIKE '%高亭镇'  AND  tx_city <>'330921' )
           OR ( NVL(tx_name,'')   LIKE '%华埠镇'  AND  tx_city <>'330824' )
           OR ( NVL(tx_name,'')   LIKE '%灵溪镇'  AND  tx_city <>'330327' )
           OR ( NVL(tx_name,'')   LIKE '%昆阳镇'  AND  tx_city <>'330326' )
           OR ( NVL(tx_name,'')   LIKE '%罗阳镇'  AND  tx_city <>'330329' )
           OR ( NVL(tx_name,'')   LIKE '%大峃镇'  AND  tx_city <>'330328' )
           OR ( NVL(tx_name,'')   LIKE '%龙港镇'  AND  tx_city <>'330383' ))
        THEN  '1'
WHEN NVL(tx_fourthaddress,'')<>'' and   substr(tx_fourthaddress,7,6) <>'999999' AND NVL(tx,'')  LIKE '%村%'  AND NVL(tx,'') not LIKE '%新村%'  THEN  '1'
  when NVL(tx_fourthaddress,'')='' and   substr(tx_fourthaddress,7,6) <>'999999' AND LENGTH(tx)-length(replace(tx,'乡','')) =1 and (
          tx not like '%肥乡区%'
     and  tx not like '%柏乡县%'
     and  tx not like '%平乡县%'
     and  tx not like '%武乡县%'
     and  tx not like '%乡宁县%'
     and  tx not like '%桐乡市%'
     and  tx not like '%萍乡市%'
     and  tx not like '%东乡区%'
     and  tx not like '%金乡县%'
     and  tx not like '%新乡市%'
     and  tx not like '%新乡县%'
     and  tx not like '%内乡县%'
     and  tx not like '%宁乡市%'
     and  tx not like '%湘乡市%'
     and  tx not like '%安乡县%'
     and  tx not like '%西乡塘区%'
     and  tx not like '%乡城县%'
     and  tx not like '%西乡县%'
     and  tx not like '%东乡族自治县%'
     and  tx not like '%积石山保安族东乡族撒拉族自治县%'
)  then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999') and LENGTH(tx)-length(replace(tx,'乡','')) >1 then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and LENGTH(tx)-length(replace(tx,'镇','')) =1  and
 (
          tx  like '%天镇县%'
     OR  tx  like '%丰镇市%'
     OR  tx  like '%北镇市%'
     OR  tx  like '%镇赉县%'
     OR  tx  like '%镇江市%'
     OR  tx  like '%镇海区%'
     OR  tx  like '%固镇县%'
     OR  tx  like '%景德镇市%'
     OR  tx  like '%镇平县%'
     OR  tx  like '%清镇市%'
     OR  tx  like '%镇宁布依族苗族自治县%'
     OR  tx  like '%镇远县%'
     OR  tx  like '%镇雄县%'
     OR  tx  like '%镇沅彝族哈尼族拉祜族自治县%'
     OR  tx  like '%镇康县%'
     OR  tx  like '%镇巴县%'
     OR  tx  like '%镇坪县%'
     OR  tx  like '%镇安县%'
     OR  tx  like '%镇原县%'   ---区县
     OR (tx  like '%熊山镇%'    and  tx_city ='350725' )---城关镇
     OR ( tx  like '%双溪镇%'   and  tx_city ='350721' )
     OR ( tx  like '%雪峰镇%'   and  tx_city ='350421' )
     OR ( tx  like '%龙津镇%'   and  tx_city ='350423' )
     OR ( tx  like '%杨舍镇%'   and  tx_city ='320582' )
     OR ( tx  like '%玉山镇%'   and  tx_city ='320583' )
     OR ( tx  like '%城厢镇%'   and  tx_city ='320585' )
     OR ( tx  like '%城关镇%'   and  tx_city in ('610981','610928','610921','610929','610924','610926') )
     OR ( tx  like '%首善镇%'   and  tx_city ='610326' )
     OR ( tx  like '%高亭镇%'   and  tx_city ='330921' )
     OR ( tx  like '%华埠镇%'   and  tx_city ='330824' )
     OR ( tx  like '%灵溪镇%'   and  tx_city ='330327' )
     OR ( tx  like '%昆阳镇%'   and  tx_city ='330326' )
     OR ( tx  like '%罗阳镇%'   and  tx_city ='330329' )
     OR ( tx  like '%大峃镇%'   and  tx_city ='330328' )
     OR ( tx  like '%龙港镇%'   and  tx_city ='330383' )
 )   and tx like '%村%' and tx not like '%新村%'  then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and  LENGTH(tx)-length(replace(tx,'镇','')) =1  and
(

   (      tx  like '%熊山镇%'   and tx_city  <>'350725' )---城关镇
     OR ( tx  like '%双溪镇%'  and  tx_city  <>'350721' )
     OR ( tx  like '%雪峰镇%'  and  tx_city <>'350421' )
     OR ( tx  like '%龙津镇%'  and  tx_city <>'350423' )
     OR ( tx  like '%杨舍镇%'  and  tx_city <>'320582' )
     OR ( tx  like '%玉山镇%'  and  tx_city <>'320583' )
     OR ( tx  like '%城厢镇%'  and  tx_city <>'320585' )
     OR ( tx  like '%城关镇%'  and  tx_city  not in ('610981','610928','610921','610929','610924','610926') )
     OR ( tx  like '%首善镇%'  and  tx_city <> '610326' )
     OR ( tx  like '%高亭镇%'  and  tx_city <>'330921' )
     OR ( tx  like '%华埠镇%'  and  tx_city <>'330824' )
     OR ( tx  like '%灵溪镇%'  and  tx_city <>'330327' )
     OR ( tx  like '%昆阳镇%'  and  tx_city <>'330326' )
     OR ( tx  like '%罗阳镇%'  and  tx_city <>'330329' )
     OR ( tx  like '%大峃镇%'  and  tx_city <>'330328' )
     OR ( tx  like '%龙港镇%'  and  tx_city <>'330383' )

	 ) then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and LENGTH(tx)-length(replace(tx,'镇','')) =1  and
 (
          tx not like '%天镇县%'
     and  tx not like '%丰镇市%'
     and  tx not like '%北镇市%'
     and  tx not like '%镇赉县%'
     and  tx not like '%镇江市%'
     and  tx not like '%镇海区%'
     and  tx not like '%固镇县%'
     and  tx not like '%景德镇市%'
     and  tx not like '%镇平县%'
     and  tx not like '%清镇市%'
     and  tx not like '%镇宁布依族苗族自治县%'
     and  tx not like '%镇远县%'
     and  tx not like '%镇雄县%'
     and  tx not like '%镇沅彝族哈尼族拉祜族自治县%'
     and  tx not like '%镇康县%'
     and  tx not like '%镇巴县%'
     and  tx not like '%镇坪县%'
     and  tx not like '%镇安县%'
     and  tx not like '%镇原县%'
)
and ( tx not like '%熊山镇%'
     and  tx not like '%双溪镇%'
     and  tx not like '%雪峰镇%'
     and  tx not like '%龙津镇%'
     and  tx not like '%杨舍镇%'
     and  tx not like '%玉山镇%'
     and  tx not like '%城厢镇%'
     and  tx not like '%城关镇%'
     and  tx not like '%首善镇%'
     and  tx not like '%高亭镇%'
     and  tx not like '%华埠镇%'
     and  tx not like '%灵溪镇%'
     and  tx not like '%昆阳镇%'
     and  tx not like '%罗阳镇%'
     and  tx not like '%大峃镇%'
     and  tx not like '%龙港镇%'
 )  then '1'
  when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and LENGTH(tx)-length(replace(tx,'镇','')) >1 and  (
         ( substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%熊山镇%'  and  tx_city ='350725' )---城关镇
     OR  ( substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%双溪镇%'  and  tx_city ='350721' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%雪峰镇%'   and  tx_city ='350421' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%龙津镇%'   and  tx_city ='350423' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%杨舍镇%'   and  tx_city ='320582' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%玉山镇%'   and  tx_city ='320583' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%城厢镇%'   and  tx_city ='320585' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%城关镇%'   and  tx_city in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%首善镇%'   and  tx_city ='610326' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%高亭镇%'   and  tx_city ='330921' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%华埠镇%'   and  tx_city ='330824' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%灵溪镇%'   and  tx_city ='330327' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%昆阳镇%'   and  tx_city ='330326' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%罗阳镇%'   and  tx_city ='330329' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%大峃镇%'   and  tx_city ='330328' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%龙港镇%'   and  tx_city ='330383' )
 ) AND tx LIKE '%村%' AND tx not LIKE '%新村%' then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and  LENGTH(tx)-length(replace(tx,'镇','')) >1 and  (
         ( substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%熊山镇%'  and  tx_city <>'350725' )---城关镇
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%双溪镇%'   and  tx_city <>'350721' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%雪峰镇%'   and  tx_city <>'350421' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%龙津镇%'   and  tx_city <>'350423' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%杨舍镇%'   and  tx_city <>'320582' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%玉山镇%'   and  tx_city <>'320583' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%城厢镇%'   and  tx_city <>'320585' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%城关镇%'  and  tx_city not in ('610981','610928','610921','610929','610924','610926') )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%首善镇%'  and  tx_city <>'610326' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%高亭镇%'  and  tx_city <>'330921' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%华埠镇%'  and  tx_city <> '330824' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%灵溪镇%'  and  tx_city <> '330327' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%昆阳镇%'  and  tx_city <>'330326' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%罗阳镇%'  and  tx_city <>'330329' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%大峃镇%'  and  tx_city <>'330328' )
     OR  (substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1))  like '%龙港镇%'  and  tx_city <>'330383' )
 )  then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and LENGTH(tx)-length(replace(tx,'镇','')) >1 and  (
          substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%熊山镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%双溪镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%雪峰镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%龙津镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%杨舍镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%玉山镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%城厢镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%城关镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%首善镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%高亭镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%华埠镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%灵溪镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%昆阳镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%罗阳镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%大峃镇%'
     and  substr(tx,instr(tx,'镇',-2),instr(tx,'镇',-1)) not like '%龙港镇%'
 ) then '1'
 when ( NVL(tx_fourthaddress,'')='' or   substr(tx_fourthaddress,7,6) ='999999')  and tx like '%村%' and tx not like '%新村%'  then '1'
    else '0' end  is_tx
 from tmp_ecif_lzh_dzxx_20230717 ;

--select count(distinct 客户号) from tmp_lzh_cst_lst_20240717;

--drop table tmp_lzh_cst_lst_20240717;

CREATE TABLE tmp_lzh_cst_lst_20240717 AS
SELECT  t1.cst_id 客户号
        ,t1.YEAR 年份
        ,t.gz 工作地址详情
        ,t.gz_city 工作地址三级行政区划
        ,gz_fourthaddress 工作地址四级行政区划
        ,t.gz_name 工作地址四级地址名称
        ,t.is_gz 工作地址是否农户
        ,t.hj 户籍地址详情
        ,t.hj_city 户籍地址三级行政区划
        ,t.hj_fourthaddress 户籍地址四级行政区划
        ,t.hj_name 户籍地址四级地址名称
        ,t.is_hj 户籍地址是否农户
        ,t.zc 注册地址详情
        ,t.zc_city 注册地址三级行政区划
        ,t.zc_fourthaddress 注册地址四级行政区划
        ,t.zc_name 注册地址四级地址名称
        ,t.is_zc 注册地址是否农户
        ,t.jy 经营地址详情
        ,t.jy_city 经营地址三级行政区划
        ,t.jy_fourthaddress 经营地址四级行政区划
        ,t.jy_name 经营地址四级地址名称
        ,t.is_jy 经营地址是否农户
        ,t.jt 家庭地址详情
        ,t.jt_city 家庭地址三级行政区划
        ,t.jt_fourthaddress 家庭地址四级行政区划
        ,t.jt_name 家庭地址四级地址名称
        ,t.is_jt 家庭地址是否农户
        ,t.tx 通讯地址详情
        ,t.tx_city 通讯地址三级行政区划
        ,t.tx_fourthaddress 通讯地址四级行政区划
        ,t.tx_name 通讯地址四级地址名称
        ,t.is_tx 通讯地址是否农户
FROM    tmp_ecif_lzh_address_20240717_01 t ----地址信息
INNER JOIN    zh_cst_lst t1 ----需要取数客户
ON      t.cst_id = t1.cst_id
AND     t1.YEAR = '2023'
WHERE   dt = '20231231'
UNION ALL
SELECT  t1.cst_id 客户号
        ,t1.YEAR 年份
        ,t.gz 工作地址详情
        ,t.gz_city 工作地址三级行政区划
        ,gz_fourthaddress 工作地址四级行政区划
        ,t.gz_name 工作地址四级地址名称
        ,t.is_gz 工作地址是否农户
        ,t.hj 户籍地址详情
        ,t.hj_city 户籍地址三级行政区划
        ,t.hj_fourthaddress 户籍地址四级行政区划
        ,t.hj_name 户籍地址四级地址名称
        ,t.is_hj 户籍地址是否农户
        ,t.zc 注册地址详情
        ,t.zc_city 注册地址三级行政区划
        ,t.zc_fourthaddress 注册地址四级行政区划
        ,t.zc_name 注册地址四级地址名称
        ,t.is_zc 注册地址是否农户
        ,t.jy 经营地址详情
        ,t.jy_city 经营地址三级行政区划
        ,t.jy_fourthaddress 经营地址四级行政区划
        ,t.jy_name 经营地址四级地址名称
        ,t.is_jy 经营地址是否农户
        ,t.jt 家庭地址详情
        ,t.jt_city 家庭地址三级行政区划
        ,t.jt_fourthaddress 家庭地址四级行政区划
        ,t.jt_name 家庭地址四级地址名称
        ,t.is_jt 家庭地址是否农户
        ,t.tx 通讯地址详情
        ,t.tx_city 通讯地址三级行政区划
        ,t.tx_fourthaddress 通讯地址四级行政区划
        ,t.tx_name 通讯地址四级地址名称
        ,t.is_tx 通讯地址是否农户
FROM    tmp_ecif_lzh_address_20240717_01 t ----地址信息
INNER JOIN    zh_cst_lst t1 ----需要取数客户
ON      t.cst_id = t1.cst_id
AND     t1.YEAR = '2022'
WHERE   dt = '20221231'
UNION ALL
SELECT  t1.cst_id 客户号
        ,t1.YEAR 年份
        ,t.gz 工作地址详情
        ,t.gz_city 工作地址三级行政区划
        ,gz_fourthaddress 工作地址四级行政区划
        ,t.gz_name 工作地址四级地址名称
        ,t.is_gz 工作地址是否农户
        ,t.hj 户籍地址详情
        ,t.hj_city 户籍地址三级行政区划
        ,t.hj_fourthaddress 户籍地址四级行政区划
        ,t.hj_name 户籍地址四级地址名称
        ,t.is_hj 户籍地址是否农户
        ,t.zc 注册地址详情
        ,t.zc_city 注册地址三级行政区划
        ,t.zc_fourthaddress 注册地址四级行政区划
        ,t.zc_name 注册地址四级地址名称
        ,t.is_zc 注册地址是否农户
        ,t.jy 经营地址详情
        ,t.jy_city 经营地址三级行政区划
        ,t.jy_fourthaddress 经营地址四级行政区划
        ,t.jy_name 经营地址四级地址名称
        ,t.is_jy 经营地址是否农户
        ,t.jt 家庭地址详情
        ,t.jt_city 家庭地址三级行政区划
        ,t.jt_fourthaddress 家庭地址四级行政区划
        ,t.jt_name 家庭地址四级地址名称
        ,t.is_jt 家庭地址是否农户
        ,t.tx 通讯地址详情
        ,t.tx_city 通讯地址三级行政区划
        ,t.tx_fourthaddress 通讯地址四级行政区划
        ,t.tx_name 通讯地址四级地址名称
        ,t.is_tx 通讯地址是否农户
FROM    tmp_ecif_lzh_address_20240717_01 t ----地址信息
INNER JOIN    zh_cst_lst t1 ----需要取数客户
ON      t.cst_id = t1.cst_id
AND     t1.YEAR = '2021'
WHERE   dt = '20211231'
;



**01-数据需求_村行_SJ2024072631_英德村行_余春燕_用于行内短信费用_签约率等分析.sql
-- 英德村行短信签约数据需求
-- 数据日期为2018年5月15日-2024年7月25日开业至今的存量数据


-- 所属村行	开户机构号	所属机构	客户类型	客户号	客户姓名	客户年龄	客户账号	开户时间	账户类型	开户渠道	开户人工号	手机号码	签约状态
-- 提醒起始金额	短信经办人	短信经办时间	解约渠道	短信发送量	短信费用	客户价值	客户综合回报	是否行内员工




-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_YD_DX_SJ2024072631_01;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_YD_DX_SJ2024072631_01 AS
-- SELECT  T1.brc_org_id            AS 所属分行
        -- ,T1.org_id               AS 开户机构号
        -- ,T1.org_nm               AS 所属机构
        -- ,T1.cst_typ_cd           AS 客户类型
        -- ,T1.cst_id               AS 客户号
        -- ,T1.cst_nm               AS 客户姓名
        -- ,T1.act_age              AS 客户年龄
        -- ,T1.act_id               AS 客户账号
        -- ,T1.opn_dt               AS 开户时间
        -- ,T1.cst_act_id_typ       AS 账户类型
        -- ,T1.opn_chnl_cd          AS 开户渠道
        -- ,T1.act_opn_tlr          AS 开户人工号
        -- ,T1.mbl_nbr              AS 手机号码
        -- ,T1.vld_ind              AS 签约状态
        -- ,T1.rmnd_bgn_amt         AS 提醒起始金额
        -- ,T1.hdl_mnl_id           AS 短信经办人
        -- ,T1.trx_tm               AS 短信经办时间
        -- ,T1.cncl_ctr_chnl        AS 解约渠道
        -- ,T2.20180515_20240725短信发送量
        -- ,T1.is_emp               AS 是否行内员工
        -- ,T3.cprh_contri_cur_year AS 2024年客户价值
        -- ,T4.cur_year_ftp_inc     AS 2024年客户综合回报
-- FROM    app_rpt.fct_txt_msg_plf_ctr_stat_rpt T1 --短信签约统计报表
-- LEFT JOIN    (
                 -- SELECT  A2.act_id
                         -- ,COUNT(1) AS 20180515_20240725短信发送量
                 -- FROM    edw.dwd_bus_com_sms_send_inf_di A2 --短信发送信息记录表
                 -- WHERE   A2.DT >= '20180515'
                 -- AND     A2.DT <= '20240725'
                 -- AND     A2.snd_sts_cd = '1' --发送成功
                 -- GROUP BY A2.act_id
             -- ) T2
-- ON      T1.act_id = T2.act_id
-- LEFT JOIN    adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd T3 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
-- ON      T1.cst_id = T3.cst_id
-- AND     T3.DT = '20240725'
-- LEFT JOIN    adm_pub.adm_csm_cbus_ftp_inf_dd T4 --客户集市-业务信息-客户FTP业务
-- ON      T1.cst_id = T4.cst_id
-- AND     T4.DT = '20240725'
-- WHERE   T1.DT = '20240725'
-- AND     SUBSTR(T1.brc_org_id, 1, 4) = '4461' --英德村行
-- ;



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_YD_DX_SJ2024072631_02;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_YD_DX_SJ2024072631_02 AS
SELECT  T3.brc_org_nm                                                                      AS 所属分行
        ,T2.opn_org                                                                        AS 开户机构号
        ,T3.org_nm                                                                         AS 所属机构
        ,CASE
           WHEN T5.CST_TYP_CD = '1' THEN '对私'
           WHEN T5.CST_TYP_CD = '2' THEN '对公'
         END                                                                               AS 客户类型
        ,T2.cst_id                                                                         AS 客户号
        ,T5.CST_CHN_NM                                                                     AS 客户姓名
        ,DATEDIFF(TO_DATE('20240725', 'YYYYMMDD'), TO_DATE(T4.BTH_DT, 'YYYYMMDD'), 'YYYY') AS 客户年龄
        ,T1.act_id                                                                         AS 客户账号
        ,T2.dep_act_id                                                                     AS 存款账号
        ,T2.opn_dt                                                                         AS 开户时间
        ,T9.cd_val_dscr                                                                    AS 对私账户类型
        ,T10.cd_val_dscr                                                                   AS 对公账户类型
		,T12.cd_val_dscr                                                                   AS 账户状态
        ,T6.cd_val_dscr                                                                    AS 开户渠道
        ,T2.act_opn_tlr                                                                    AS 开户人工号
        ,T1.mbl_nbr                                                                        AS 手机号码
        ,T1.ctr_sts                                                                        AS 短信签约状态
        ,CASE
           WHEN T1.vld_ind = '0' THEN '生效'
           WHEN T1.vld_ind = '1' THEN '注销或解约'
         END                                                                               AS 有效标志位
        ,T1.rmnd_bgn_amt                                                                   AS 提醒起始金额
        ,T1.trx_dt                                                                         AS 签约日期
        ,T1.trx_tm                                                                         AS 签约时间
        ,T1.hdl_mnl_id                                                                     AS 短信经办人
	    ,CASE
           WHEN M.MBL_NBR = '' AND T1.VLD_IND = '1'                                THEN COALESCE(L01.CD_VAL_DSCR, M.SRC_CHNL_CD, '')
           WHEN M02.MBL_NBR <> '' AND M02.MBL_NBR IS NOT NULL AND T1.VLD_IND = '1' THEN COALESCE(L02.CD_VAL_DSCR, M02.SRC_CHNL_CD, '')
           WHEN T1.VLD_IND = '1'                                                   THEN COALESCE(L03.CD_VAL_DSCR, M03.SRC_CHNL_CD, '')
           ELSE ''
         END                                                                               AS 解约渠道
        ,T7.近一年短信发送量
        ,CASE
           WHEN t4.OWN_EMPE_IND = '1' THEN '是'
           ELSE '否'
         END                                                                               AS 本行员工标志
        ,t8.cst_val_grd                                                                    AS 客户价值等级
        ,t11.cur_year_ftp_inc                                                              AS 2024年客户综合回报
		,CASE WHEN T14.bind_cst_act_id	IS NOT NULL THEN '是' ELSE '否' END                AS 是否绑定微信银行
FROM    edw.dwd_bus_dep_act_sms_ctr_inf_dd T1 --短信签约表
INNER JOIN    edw.dws_bus_dep_act_inf_dd T2 --存款账户信息汇总
ON      T1.act_id = T2.cst_act_id
AND     T2.act_sts_cd <> 'C'   --剔除销户
AND     T2.DT = '20240725'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T3 --机构树_考核维度
ON      T2.opn_org = T3.org_id
AND     T3.DT = '20240725'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T4 --个人客户基本信息汇总表
ON      T2.cst_id = T4.cst_id
AND     T4.DT = '20240725'
LEFT JOIN    edw.dws_cst_bas_inf_dd T5 --客户基础信息汇总表
ON      T2.cst_id = T5.cst_id
AND     T5.DT = '20240725'
LEFT JOIN    edw.dwd_code_library_dd T9 -- 码值表
ON      T2.act_ctg_cd_2 = T9.cd_val
AND     T9.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     T9.fld_nm = 'ACT_CTG_CD_2'
AND     T9.DT = '20240725'
LEFT JOIN    edw.dwd_code_library_dd T10 -- 码值表
ON      T2.act_ctg_cd_1 = T10.cd_val
AND     T10.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     T10.fld_nm = 'ACT_CTG_CD_1'
AND     T10.DT = '20240725'
LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表
ON      T2.opn_chnl_cd	 = T6.cd_val
AND     T6.tbl_nm = 'DIM_BUS_LOAN_COM_CTR_ATCH_INF_DD'
AND     T6.fld_nm = 'CHNL_CD'
AND     T6.DT = '20240725'
LEFT JOIN    (
                 SELECT  A2.act_id
                         ,COUNT(1) AS 近一年短信发送量
                 FROM    edw.dwd_bus_com_sms_send_inf_di A2 --短信发送信息记录表
                 WHERE   A2.DT >= '20230725'
                 AND     A2.DT <= '20240725'
                 AND     A2.snd_sts_cd = '1' --发送成功
                 GROUP BY A2.act_id
             ) t7
ON      T1.act_id = t7.act_id
LEFT JOIN    adm_pub.adm_csm_cbus_cst_val_der_ind_inf_dd t8 --客户集市-业务信息-客户价值信息-客户价值衍生指标信息
ON      T2.cst_id = t8.cst_id
AND     t8.DT = '20240725'
LEFT JOIN    adm_pub.adm_csm_cbus_ftp_inf_dd t11 --客户集市-业务信息-客户FTP业务
ON      t2.cst_id = t11.cst_id
AND     t11.DT = '20240725'
LEFT JOIN    edw.dwd_code_library_dd T12 -- 码值表
ON      T2.act_sts_cd	 = T12.cd_val
AND     T12.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     T12.fld_nm = 'ACT_STS_CD'
AND     T12.DT = '20240725'
LEFT JOIN    EDW.DWD_BUS_DEP_ACT_SMS_CTR_MDF_SRL_DI M
ON      T1.ACT_ID = M.ACT_ID
AND     M.OPR_TYP_CD = '3'
AND     M.MBL_NBR = ''
AND     M.DT = '20240725'
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD L01
ON      M.SRC_CHNL_CD = L01.CD_VAL
AND     L01.TBL_NM = 'DWD_BUS_DEP_ACT_SMS_CTR_MDF_SRL_DI'
AND     L01.FLD_NM = 'SRC_CHNL_CD'
AND     L01.DT = '20240725'
LEFT JOIN    EDW.DWD_BUS_DEP_ACT_SMS_CTR_MDF_SRL_DI M02
ON      T1.ACT_ID = M02.ACT_ID
AND     T1.MBL_NBR = M02.MBL_NBR
AND     M02.OPR_TYP_CD = '3'
AND     M02.DT = '20240725'
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD L02
ON      M02.SRC_CHNL_CD = L02.CD_VAL
AND     L02.TBL_NM = 'DWD_BUS_DEP_ACT_SMS_CTR_MDF_SRL_DI'
AND     L02.FLD_NM = 'SRC_CHNL_CD'
AND     L02.DT = '20240725'
LEFT JOIN    (
                 SELECT  ACT_ID
                         ,MAX(SRC_CHNL_CD) AS SRC_CHNL_CD
                 FROM    EDW.DWD_BUS_DEP_ACT_SMS_CTR_MDF_SRL_DI
                 WHERE   DT = '20240725'
                 AND     OPR_TYP_CD = '2'
                 GROUP BY ACT_ID
             ) M03
ON      T1.ACT_ID = M03.ACT_ID
LEFT JOIN    EDW.DWD_CODE_LIBRARY_DD L03
ON      M03.SRC_CHNL_CD = L03.CD_VAL
AND     L03.TBL_NM = 'DWD_BUS_DEP_ACT_SMS_CTR_MDF_SRL_DI'
AND     L03.FLD_NM = 'SRC_CHNL_CD'
AND     L03.DT = '20240725'
LEFT JOIN (SELECT DISTINCT bind_cst_act_id	 FROM  edw.dwd_bus_chnl_elec_wechat_bind_inf_dd WHERE DT='20240725' AND bind_sts_cd= '1' ) T14
ON      T1.ACT_ID = T14.bind_cst_act_id
WHERE   T1.DT = '20240725'
AND     T3.brc_org_nm = '广东英德泰隆村镇银行';
**01-数据需求_村行_SJ2024081476_庆元村行_吴美健_2024年07月催收走访记录.sql
-- 2024年07月（20240701-20240731）庆元村行催收走访记录

--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024081476 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024081476 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2024-07-01 00:00:00' and '2024-07-30 23:59:00'
;


-- SELECT * FROM lab_bigdata_dev.tmp_sjxq_SJ2024081476;
**01-数据需求_村行_SJ2024081956_庆元村行_许巍文_客户业务信息.sql
--SJ2024081956

-- 姓名	性别	居委会	客户号

--取数字段：管户机构号/管户人/行存款余额/我行授信总额/我行用信余额/随贷通卡金额/随贷通卡余额/他行融资家数/他行贷款余额/他行经营性贷款余额/他行消费性贷款余额/最近一期征信日期/联系电话



--现有203081,附件中有203063

--同一个证件号，会对应2个客户号，一个对公，一个对私







SELECT  cst_id,cst_nm,concat(doc_nbr,'%'),sex,juweihui,mbl_nbr

FROM tmp_cst_SJ2024081956_01 WHERE doc_nbr IN (

SELECT  doc_nbr FROM tmp_cst_SJ2024081956_01 WHERE cst_id IS NOT NULL

GROUP BY doc_nbr

having count(DISTINCT cst_id)>1

);



---导入附件中的表

DROP TABLE IF EXISTS tmp_cst_SJ2024081956_01 PURGE;



CREATE TABLE IF NOT EXISTS tmp_cst_SJ2024081956_01 AS

SELECT  a.col_1    AS cst_nm

        ,a.col_2   AS sex

        ,a.col_3   AS juweihui

        ,a.col_4   AS doc_nbr

        ,b.cst_id  AS cst_id

        ,b.mbl_nbr AS mbl_nbr

FROM    qbi_file_20240826_09_40_12 a

LEFT JOIN    edw.dws_cst_bas_inf_dd b  --客户基础信息汇总表

ON      a.col_4 = b.doc_nbr

AND     b.dt = '20240820'

WHERE   a.pt = MAX_PT('qbi_file_20240826_09_40_12');





---结果表

-- SELECT count(1) FROM tmp_cst_SJ2024081956_02 WHERE 客户号 is not null



DROP TABLE IF EXISTS lab_bigdata_dev.tmp_cst_SJ2024081956_02 PURGE;



CREATE TABLE lab_bigdata_dev.tmp_cst_SJ2024081956_02 AS

SELECT  T1.cst_nm                    AS 姓名

        ,T1.sex                      AS 性别

        ,T1.juweihui                 AS 居委会

        ,T1.cst_id                   AS 客户号

        ,T1.doc_nbr                  AS 证件号

        ,T1.mbl_nbr                  AS 联系电话

        ,T2.prm_mgr_id               AS 主管护人工号

        ,T2.prm_mgr_nm               AS 主管护人名称

        ,T2.prm_org_id               AS 主管护机构号

        ,T2.prm_org_nm               AS 主管护机构名称

        ,T4.我行存款余额

        ,T3.我行授信总额

        ,T3.我行用信余额

        ,T3.随贷通卡金额

        ,T3.随贷通卡余额

        ,T5.oth_bank_loan_org_num    AS 他行融资家数

        ,T5.oth_bank_loan_credit_bal AS 他行贷款余额

        ,T5.oth_bank_mngmt_loan_bal  AS 他行经营性贷款余额

        ,T5.oth_bank_xfx_loan_bal    AS 他行消费性贷款余额

        ,T5.report_dt                AS 最近一期征信日期

FROM    tmp_cst_SJ2024081956_01 T1

LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息

ON      T1.cst_id = T2.cst_id

AND     T2.DT = '20240820'

LEFT JOIN    (

                 SELECT  B1.cst_id

                         ,SUM(B1.ctr_amt) AS 我行授信总额

                         ,SUM(B1.ctr_bal) AS 我行用信余额

                         ,SUM(CASE

                                WHEN B1.PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN B1.ctr_amt

                                ELSE 0

                              END)        AS 随贷通卡金额

                         ,SUM(CASE

                                WHEN B1.PRD_NO IN ( '2001010101003' , '2001020101003' ) THEN B1.ctr_bal

                                ELSE 0

                              END)        AS 随贷通卡余额

                 FROM    EDW.DIM_BUS_LOAN_CTR_BSE_INF_DD B1 --合同基础信息

                 LEFT JOIN    EDW.DIM_BUS_LOAN_CTR_OTH_DTL_INF_DD B2 --合同其它明细信息

                 ON      B1.CTR_SERNO = B2.CTR_SERNO

                 AND     B2.dt = '20240820'

                 WHERE   B1.dt = '20240820'

                 AND     B1.BSN_MARK_CD NOT IN ( '01' ) --剔除  员工贷款

                 AND     ( B2.APLY_CHNL_CD <> 'L08' --渠道

                     OR B1.PRD_NO <> '2001010101007' ) --剔除  小鱼分期

                 AND     B1.PRD_NO <> '2001010101008' --剔除  蚂蚁借呗

                 AND     B1.PRD_NO <> '2001010101010' --剔除百度分期贷

                 AND     ( B1.PRD_NO NOT IN ( '2001020101002' , '2001010101002' )

                     OR nvl(B1.CTR_STS_CD, '') <> '' )  --剔除未签约的泰e贷

                 --未结清未终结新口径：状态为正常/冻结且终结日期为空且到期日未到期，或余额大于0

                 AND     ( ( B1.CTR_STS_CD IN ( '2' , '4' )

                 AND     B1.TMT_DT = '18991231'

                 AND     to_date(B1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(B1.DT, 'yyyyMMdd') )

                     OR B1.CTR_BAL > 0 )

                 GROUP BY B1.cst_id

             ) T3

ON      T1.cst_id = T3.cst_id

LEFT JOIN    (

                 SELECT  B1.cst_id

                         ,SUM(B1.gl_bal) AS 我行存款余额

                 FROM    edw.dws_bus_dep_act_inf_dd B1 --存款账户信息汇总

                 WHERE   B1.DT = '20240820'

                 GROUP BY B1.cst_id

             ) T4

ON      T1.cst_id = T4.cst_id

LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T5 --个人征信指标信息表

ON      T1.cst_id = T5.cst_id

AND     T5.report_dsc_rn = '1'

AND     T5.DT = '20240820';
**01-数据需求_村行_SJ2024082221_村行管理部_程义平_村行客户社区信息.sql
-- 对象：村行（子社区编号、子社区名称）
-- 时间：2024年8月20日较2024年2月29日
-- 净增值：净增FTP、净增存、贷规模、净增有效户、净增有效贷款户

-- 数据字段：客户编号、客户名称、机构（村行）、子社区、建档日期、挂靠日期、FTP、存款月日均、贷款月日均、是否有效户、是否有效贷款户。取的时间节点（2024年7月10日和2024年2月29日）

--20240229
DROP TABLE if EXISTS tmp_cyp_SJ2024082221_20240229_01 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_20240229_01 as
SELECT T1.cst_id 客户号
       ,T1.cst_nm 客户名称
    --    ,T1.lgp_id 法人编号
    --    ,T1.lgl_org_id 总行机构编号
    --    ,T1.lgl_org_nm 总行机构名称
       ,T1.brn_org_id 机构编号
       ,T1.brn_org_nm 机构名称
       ,T2.new_com_code 子社区编号
       ,T2.new_com_name 子社区名称
        ,T4.brc_org_id 社区所属机构编号
       ,T4.brc_org_nm	 社区所属机构名称
       ,T2.crt_dt 建档日期
       ,T2.new_com_put_up_date 子社区挂靠时间
       ,T1.ftp_year_pft FTP年累计
       ,T1.ftp_mon_pft FTP月累计
       ,T1.dep_mon_avg_bal 存款月日均
       ,T1.ln_mon_avg_bal 本行贷款当月月日均
       ,T1.vld_cst_ind 有效户标识
       ,T1.vld_ln_cst_ind 有效贷款户标识
       ,T1.acg_dt 会计日期
FROM app_ado.adm_subl_cst_bus_inf_dd T1  --客户业务信息汇总表
left join app_ado.FCT_CST_SMY_DD  T2 --客户信息汇总表
ON  T1.cst_id=T2.cst_id
and T2.dt='20240229'
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON   T2.new_com_code = T3.cmnt_enc
and T3.dt='20240229'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON   T3.afl_org_id = T4.org_id
and T4.dt='20240229'
-- left JOIN app_ado.ADM_HR_ORG_PATH_INF_KH T3  --多维度机构关系信息-考核
-- on T1.brn_org_id=T3.org_id
-- and T3.dt='20240229'
where T1.dt='20240229'
-- and T1.brn_org_nm like '%村镇%'
and T1.lgl_org_id= '999999997'   --村行
;



----20240820
DROP TABLE if EXISTS tmp_cyp_SJ2024082221_20240820_01 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_20240820_01 as
SELECT  T1.cst_id 客户号
        ,T1.cst_nm 客户名称
        --    ,T1.lgp_id 法人编号
        --    ,T1.lgl_org_id 总行机构编号
        --    ,T1.lgl_org_nm 总行机构名称
        ,T1.brn_org_id 机构编号
        ,T1.brn_org_nm 机构名称
        ,T2.new_com_code 子社区编号
        ,T2.new_com_name 子社区名称
        ,T4.brc_org_id 社区所属机构编号
        ,T4.brc_org_nm 社区所属机构名称
        ,T2.crt_dt 建档日期
        ,T2.new_com_put_up_date 子社区挂靠时间
        ,T1.ftp_year_pft FTP年累计
        ,T1.ftp_mon_pft FTP月累计
        ,T1.dep_mon_avg_bal 存款月日均
        ,T1.ln_mon_avg_bal 本行贷款当月月日均
        ,T1.vld_cst_ind 有效户标识
        ,T1.vld_ln_cst_ind 有效贷款户标识
        ,T1.acg_dt 会计日期
FROM    app_ado.adm_subl_cst_bus_inf_dd T1 --客户业务信息汇总表
LEFT JOIN    app_ado.FCT_CST_SMY_DD T2 --客户信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20240820'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON      T2.new_com_code = T3.cmnt_enc
AND     T3.dt = '20240820'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T3.afl_org_id = T4.org_id
AND     T4.dt = '20240820'
WHERE   T1.dt = '20240820'
AND    T1.lgl_org_id= '999999997'  --村行
;



--明细
-- DROP TABLE IF EXISTS tmp_cyp_SJ2024082221_mingxi PURGE;

-- CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_mingxi AS
-- SELECT  T1.客户号                                                      AS 0820客户号
        -- ,T1.客户名称                                                   AS 0820客户名称
        -- ,T1.机构编号                                                   AS 0820机构编号
        -- ,T1.机构名称                                                   AS 0820机构名称
        -- ,T1.子社区编号                                                 AS 0820子社区编号
        -- ,T1.子社区名称                                                 AS 0820子社区名称
        -- ,T1.社区所属机构编号                                           AS 0820社区所属机构编号
        -- ,T1.社区所属机构名称                                           AS 0820社区所属机构名称
        -- ,T1.建档日期                                                    AS 0820建档日期
        -- ,T1.子社区挂靠时间                                              AS 0820子社区挂靠时间
        -- ,T1.FTP年累计                                                   AS 0820FTP年累计
        -- ,T1.FTP月累计                                                   AS 0820FTP月累计
        -- ,T1.存款月日均                                                  AS 0820存款月日均
        -- ,T1.本行贷款当月月日均                                          AS 0820本行贷款当月月日均
        -- ,T1.有效户标识                                                  AS 0820有效户标识
        -- ,T1.有效贷款户标识                                              AS 0820有效贷款户标识
        -- ,T1.会计日期                                                    AS 0820会计日期
        -- ,T2.客户号                                                      AS 0229客户号
        -- ,T2.客户名称                                                    AS 0229客户名称
        -- ,T2.机构编号                                                    AS 0229机构编号
        -- ,T2.机构名称                                                    AS 0229机构名称
        -- ,T2.子社区编号                                                 AS 0229子社区编号
        -- ,T2.子社区名称                                                 AS 0229子社区名称
        -- ,T2.社区所属机构编号                                           AS 0229社区所属机构编号
        -- ,T2.社区所属机构名称                                           AS 0229社区所属机构名称
        -- ,T2.建档日期                                                   AS 0229建档日期
        -- ,T2.子社区挂靠时间                                            AS 0229子社区挂靠时间
        -- ,T2.FTP年累计                                                 AS 0229FTP年累计
        -- ,T2.FTP月累计                                                 AS 0229FTP月累计
        -- ,T2.存款月日均                                                AS 0229存款月日均
        -- ,T2.本行贷款当月月日均                                        AS 0229本行贷款当月月日均
        -- ,T2.有效户标识                                                 AS 0229有效户标识
        -- ,T2.有效贷款户标识                                            AS 0229有效贷款户标识
        -- ,T2.会计日期                                                  AS 0229会计日期
		-- ,CASE WHEN T1.建档日期 <= '20240229' AND  SUBSTR(REPLACE(T1.子社区挂靠时间, '-', ''), 1, 8) > '20240229' THEN '是' ELSE '否' END AS 是否建档日期早于0229且挂靠日期大于0209
		-- ,CASE WHEN T1.子社区编号 = T2.子社区编号 THEN  '是' ELSE '否' END AS 0820较0229子社区是否相同
        -- ,COALESCE(T1.FTP年累计, 0) - COALESCE(T2.FTP年累计, 0)         AS 净增FTP_年
        -- ,COALESCE(T1.FTP月累计, 0) - COALESCE(T2.FTP月累计, 0)         AS 净增FTP_月
        -- ,COALESCE(T1.存款月日均, 0) - COALESCE(T2.存款月日均, 0)         AS 净增存款月日均
        -- ,COALESCE(T1.本行贷款当月月日均, 0) - COALESCE(T2.本行贷款当月月日均, 0) AS 净增贷款月日均
        -- ,CASE
           -- WHEN T1.有效户标识 = '1' AND COALESCE(T2.有效户标识, '') <> '1' THEN 1
           -- WHEN T1.有效户标识 <> '1' AND COALESCE(T2.有效户标识, '') = '1' THEN - 1
           -- ELSE 0
         -- END                                                   AS 有效户净增值
        -- ,CASE
           -- WHEN T1.有效贷款户标识 = '1' AND COALESCE(T2.有效贷款户标识, '') <> '1' THEN 1
           -- WHEN T1.有效贷款户标识 <> '1' AND COALESCE(T2.有效贷款户标识, '') = '1' THEN - 1
           -- ELSE 0
         -- END                                                   AS 有效贷款户净增值
-- FROM    tmp_cyp_SJ2024082221_20240820_01 T1
-- INNER JOIN    tmp_cyp_SJ2024082221_20240229_01 T2
-- ON      T1.客户号 = T2.客户号;



----------------------------------------------------------------------------
----------------------------------------------------------------------------20240805
--第一步：全量客户层级清单&mdash;&mdash;算出单个客户净增值&mdash;&mdash;然后子社区透视算出净增值

--客户净增
DROP TABLE IF EXISTS tmp_cyp_SJ2024082221_jz_mingxi PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_jz_mingxi AS
SELECT   T1.子社区编号
        ,T1.子社区名称
        ,T1.社区所属机构编号
        ,T1.社区所属机构名称
		    ,T1.客户号
        ,COALESCE(T1.FTP年累计, 0) - COALESCE(T2.FTP年累计, 0)       AS 净增FTP_年
        ,COALESCE(T1.FTP月累计, 0) - COALESCE(T2.FTP月累计, 0)       AS 净增FTP_月
        ,COALESCE(T1.存款月日均, 0) - COALESCE(T2.存款月日均, 0)         AS 净增存款月日均
        ,COALESCE(T1.本行贷款当月月日均, 0) - COALESCE(T2.本行贷款当月月日均, 0) AS 净增贷款月日均
        ,CASE
           WHEN T1.有效户标识 = '1' AND COALESCE(T2.有效户标识, '') <> '1' THEN 1
           WHEN T1.有效户标识 <> '1' AND COALESCE(T2.有效户标识, '') = '1' THEN - 1
           ELSE 0
         END                                                   AS 有效户净增值
        ,CASE
           WHEN T1.有效贷款户标识 = '1' AND COALESCE(T2.有效贷款户标识, '') <> '1' THEN 1
           WHEN T1.有效贷款户标识 <> '1' AND COALESCE(T2.有效贷款户标识, '') = '1' THEN - 1
           ELSE 0
         END                                                   AS 有效贷款户净增值
FROM    tmp_cyp_SJ2024082221_20240820_01 T1
LEFT JOIN tmp_cyp_SJ2024082221_20240229_01 T2
ON      T1.客户号 = T2.客户号
WHERE   T1.社区所属机构名称  RLIKE '村镇银行'
;



-- 第二步：需要提出特殊情况，具体如下，
-- 在当前客户级全量清单中筛选出建档0229（含）之前，但挂靠时间是0229以后（不含）客户，这部分客户清单去匹配0229客户清单，用子社区编号匹配：
-- 1.未匹配上，不处理  2.匹配上，且于0229子社区编号一致，不处理  3.匹配上，但与0229子社区编号不一致，需要算出客户的净增值，进行剔除


DROP TABLE IF EXISTS tmp_cyp_SJ2024082221_jz_hz PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_jz_hz AS
SELECT  T1.子社区编号
        ,T1.子社区名称
        ,T1.社区所属机构编号
        ,T1.社区所属机构名称
        ,SUM(T1.净增FTP_年)       AS 净增FTP_年
        ,SUM(T1.净增FTP_月)       AS 净增FTP_月
        ,SUM(T1.净增存款月日均)   AS 净增存款月日均
        ,SUM(T1.净增贷款月日均)   AS 净增贷款月日均
        ,SUM(T1.有效户净增值)     AS 有效户净增值
        ,SUM(T1.有效贷款户净增值) AS 有效贷款户净增值
FROM    tmp_cyp_SJ2024082221_jz_mingxi T1
LEFT JOIN    (
                  SELECT  DISTINCT T1.客户号
                  FROM    tmp_cyp_SJ2024082221_20240820_01 T1
                  INNER JOIN    tmp_cyp_SJ2024082221_20240229_01 T2
                  ON      T1.客户号 = T2.客户号
                  AND     T1.子社区编号 <> T2.子社区编号
                  WHERE   T1.建档日期 <= '20240229'
                  AND     SUBSTR(REPLACE(T1.子社区挂靠时间, '-', ''), 1, 8) > '20240229'
              ) T2
ON      T1.客户号 = T2.客户号
WHERE   T2.客户号 IS NULL  --剔除特殊部分
GROUP  BY T1.子社区编号 ,T1.子社区名称    ,T1.社区所属机构编号        ,T1.社区所属机构名称
;


--20240826 加上当前明细
DROP TABLE IF EXISTS tmp_cyp_SJ2024082221_dq_hz PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_dq_hz AS
SELECT  T1.子社区编号
        ,T1.子社区名称
        ,T1.社区所属机构编号
        ,T1.社区所属机构名称
        ,SUM(T1.FTP年累计)  AS  0820FTP年累计
        ,SUM(T1.FTP月累计)  AS  0820FTP月累计
        ,SUM(T1.存款月日均)  AS 0820存款月日均
        ,SUM(T1.本行贷款当月月日均)  AS  0820贷款当月月日均
        ,SUM(CASE  WHEN T1.有效户标识 = '1' THEN 1 ELSE 0 END )   AS 0820有效户数
        ,SUM(CASE  WHEN T1.有效贷款户标识 = '1' THEN 1 ELSE 0 END )   AS 0820有效贷款户
FROM    tmp_cyp_SJ2024082221_20240820_01 T1
LEFT JOIN    (
                  SELECT  DISTINCT T1.客户号
                  FROM    tmp_cyp_SJ2024082221_20240820_01 T1
                  INNER JOIN    tmp_cyp_SJ2024082221_20240229_01 T2
                  ON      T1.客户号 = T2.客户号
                  AND     T1.子社区编号 <> T2.子社区编号
                  WHERE   T1.建档日期 <= '20240229'
                  AND     SUBSTR(REPLACE(T1.子社区挂靠时间, '-', ''), 1, 8) > '20240229'
              ) T2
ON      T1.客户号 = T2.客户号
WHERE   T2.客户号 IS NULL  --剔除特殊部分
and   T1.社区所属机构名称 RLIKE '村镇银行'
GROUP  BY T1.子社区编号 ,T1.子社区名称    ,T1.社区所属机构编号,T1.社区所属机构名称
;

--结果表
DROP TABLE IF EXISTS tmp_cyp_SJ2024082221_jgb_hz PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ2024082221_jgb_hz AS
SELECT
    T1.子社区编号
	,T1.子社区名称
  ,T1.社区所属机构编号
  ,T1.社区所属机构名称
	,T2.0820FTP年累计
	,T2.0820FTP月累计
	,T2.0820存款月日均
	,T2.0820贷款当月月日均
	,T2.0820有效户数
	,T2.0820有效贷款户
	,T1.净增FTP_年
	,T1.净增FTP_月
	,T1.净增存款月日均
	,T1.净增贷款月日均
	,T1.有效户净增值
	,T1.有效贷款户净增值
FROM tmp_cyp_SJ2024082221_jz_hz T1
LEFT JOIN tmp_cyp_SJ2024082221_dq_hz T2
ON  T1.子社区编号 = T2.子社区编号 ;
**01-数据需求_村行_SJ2024082736_大冶村行_王玉婷_合同基本信息.sql
-- 客户号	客户名称	经办人周天奇（810076）	发生类型	合同流水号	合同金额	合同余额	利率	合同起始日期	合同到期日期

CREATE TABLE IF NOT EXISTS tmp_wyt_SJ2024082736 as
SELECT a.cst_id 客户号
       ,a.cst_nm 客户名称
       ,a.hdl_opr_id 经办人工号
       ,case when a.hpn_typ_cd='010' then '首笔'
       when a.hpn_typ_cd='011' then '续做'
        end as 发生类型
       ,a.ctr_serno 合同流水号
       ,a.ctr_amt 合同金额
       ,a.ctr_bal 合同余额
       ,a.exec_intr_rat 执行利率
       ,a.ctr_bgn_dt 合同起始日期
       ,a.ctr_mtu_dt 合同到期日期
FROM edw.DIM_BUS_LOAN_CTR_BSE_INF_DD a --合同基础信息
WHERE a.dt='@@{yyyyMMdd}'
and a.HDL_OPR_ID='810076' --周天奇
;
**01-数据需求_村行_SJ2024082921_汝南村行_耿鹏程_查询配偶是否签担保.sql
--截止2024年8月28日，汝南村行信贷业务担保情况分析，主要用于查询配偶是否签担保

-- 合同登记流水号、客户号、客户名称、合同终结日期、管户机构名称管户人名称、配偶是否签担保

DROP TABLE IF EXISTS tmp_peiou_SJ2024082921 PURGE;

CREATE TABLE IF NOT EXISTS tmp_peiou_SJ2024082921 AS
SELECT  a.col_1             AS 合同流水号
        ,a.col_2            AS 客户号
        ,a.col_3            AS 客户名称
        ,bc.ctr_mtu_dt      AS 合同终结日期
        ,a.col_5            AS 管户机构名称
        ,a.col_6            AS 管户人名称
        ,CASE
           WHEN a.col_1 IN (
                               SELECT  gp.bus_ctr_id
                               FROM    edw.dim_cst_rel_inf_dd cr --客户关联关系信息
                               LEFT JOIN    edw.DWS_BUS_GRNT_PRSN_INF_DD gp --担保人信息汇总
                               ON      cr.rel_cst_id = gp.wrnt_cst_id AND gp.dt = '20240828'
                               WHERE   cr.dt = '20240828'
                               AND cr.REL_TYP_CD = '0301' --配偶
                               AND COALESCE(gp.wrnt_cst_id, '') <> ''
                           ) THEN '是'
           ELSE '否'
         END                AS 配偶是否签担保
FROM    qbi_file_20240903_10_56_33 a
LEFT JOIN    edw.DIM_BUS_LOAN_CTR_BSE_INF_DD bc --合同基础信息
ON      a.col_1 = bc.ctr_serno
AND     bc.dt = '20240828'
WHERE   a.pt <> '';



-- --担保人是配偶的全量业务合同
-- SELECT  cr.CST_ID
--         ,gp.bus_ctr_id
--         ,cr.REL_CST_ID
--         ,gp.wrnt_cst_id --保证人客户编号
--         ,gp.wrnt_cst_nm --保证人客户名称
--         ,gp.grnt_ctr_typ_cd --担保合同类型
--         ,gp.grnt_ctr_id --担保合同编号
-- FROM    edw.dim_cst_rel_inf_dd cr --客户关联关系信息
-- LEFT JOIN    edw.DWS_BUS_GRNT_PRSN_INF_DD gp --担保人信息汇总
-- ON      cr.rel_cst_id = gp.wrnt_cst_id
-- AND     gp.dt = '20240828'
-- WHERE   cr.dt = '20240828'
-- AND     cr.REL_TYP_CD = '0301' --配偶
-- AND     COALESCE(gp.wrnt_cst_id, '') <> ''
-- and cr.CST_ID='1622749236'
**01-数据需求_村行_SJ2024082931_四会村行_邓盈盈_新增有效户地址数据.sql
-- 四会村行1-7月新增有效户


-- 客户姓名、客户号、管户机构、管户人（只需取到客户经理，职能、服务经理不需要）、客户户籍、经营、办公、居住地址（均需精确到门牌号）、客户经理手工修改过地址并挂靠的疑点数据

--583条数据
-- SELECT count(1) FROM tmp_xqy_sh_SJ2024082931_01

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_xqy_sh_SJ2024082931_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_xqy_sh_SJ2024082931_01 AS
SELECT  T1.cst_id          AS 客户号
        ,T3.cst_nm         AS 客户姓名
        ,T3.prm_org_id     AS 主管护机构号
        ,T3.prm_org_nm     AS 主管护机构名称
        ,T3.prm_mgr_id     AS 主管护人工号
        ,T3.prm_mgr_nm     AS 主管护人名称
        ,T5.regist_add     AS 户籍地址
        ,T5.operate_add    AS 经营地址
        ,T5.con_regist_add AS 注册地址
        ,T5.unit_add       AS 单位地址
        ,T5.fam_add        AS 居住地址
        -- ,md5(T7.com_son_no)    AS 子社区编号
        ,C.com_name    AS 子社区名称
        ,CASE
           WHEN T7.attach_flag = '0' THEN '手动'
           WHEN T7.attach_flag = '1 'THEN '自动'
         END               AS 挂靠方式 -- 0：手动 1：自动
        ,coalesce(T7.put_up_date,'')    AS 挂靠时间
        ,NVL(T7.ATTACH_STATUS, '1')   as 挂靠状态0正常 --0:正常挂靠；1：错挂
        ,T5.data_date      AS 数据日期
FROM    adm_pub.adm_csm_cbas_ind_inf_dd T1 --客户集市-基础信息-客户基础标识信息
LEFT JOIN    adm_pub.adm_csm_cbas_ind_inf_dd T2 --客户集市-基础信息-客户基础标识信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20231231'
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T3 --客户主管户信息
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20240731'
LEFT JOIN    edw.dws_hr_empe_inf_dd T4 --员工汇总信息
ON      T3.prm_mgr_id = T4.empe_id
AND     T4.DT = '20240731'
LEFT JOIN    edw.xwdt_xw_customer_addr T5 --客户地址信息表(全量表)
ON      T1.cst_id = T5.cust_no
AND     T5.DT = '20240731'
LEFT JOIN    edw.xwdt_xw_cust_com T7 --客户与社区关联表
ON      T1.cst_id = T7.cust_no
AND     T7.DT = '20240731'
INNER JOIN    edw.XWDT_XW_COMMUNITY C --社区信息表
ON      T7.COM_SON_NO = C.ID
AND     ( ( C.STATE <> '-1'
AND     C.OPERATE_TYPE >= '2' )
    OR C.STATE > '4' ) ----审批状态<>-1 操作类型 是增加  审批状态审批状态 1草稿 3审批中 4审批拒绝 5审批通过 6草稿(审批通过修改) 7审批中(审批拒绝修改) -1已删除 9暂转移 10暂转移(修改)
AND     C.DT = '@@{yyyyMMdd}'
WHERE   T1.dt = '20240731'
AND     T1.efe_cst_ind = '1'
AND     (T2.efe_cst_ind <> '1' or T2.cst_id IS NULL )
AND     T4.pos_fam_nm = '客户经理类'
AND     T3.prm_org_id LIKE '4462%'   --四会村行
;
**01-数据需求_村行_SJ2024090346_庆元村行_吴美健_2024年08月催收走访记录.sql
-- 2024年08月（20240801-20240831）庆元村行催收走访记录

--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024081476 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024081476 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '20240831'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2024-08-01 00:00:00' and '2024-09-01 00:00:00'
;


-- SELECT * FROM lab_bigdata_dev.tmp_sjxq_SJ2024081476;
**01-数据需求_村行_SJ2024090611_大冶村行_富林_历年贴息情况排查.sql
-- 数据日期为截止2024年9月5日
-- 数据范围为大冶村行开业至今所有已开立的存款账户，包括已注销账户等

-- 客户号、客户名称、结算账户主账号、结算账户子账号、会计科目名称、存款产品名称、账户状态、开立机构、管户机构、管护客户经理工号、余额(折人民币)


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_HBDY_SJ2024090611_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_HBDY_SJ2024090611_01 AS
SELECT  T1.cst_id as 客户号
        ,T1.act_nm              AS 账户名称
        ,T1.cst_act_id          AS 客户账号
        ,T1.dep_act_id          AS 存款账号
        ,CASE
           WHEN T1.stl_act_ind = '1' THEN '是'
           ELSE '否'
         END                    AS 结算账户标志
        ,T1.bal_itm_id          AS 会计科目编号
        ,T2.act_itm_nm          AS 会计科目名称
        ,T1.prod_id             AS 存款产品编号
        ,T3.pd_cmt              AS 存款产品名称
        ,T4.cd_val_dscr         AS 账户状态
        ,T1.opn_org             AS 开立机构编号
        ,T5.org_nm              AS 开立机构
        ,T6.acs_org_id          AS 管户机构编号
        ,T8.org_nm              AS 管户机构
        ,T6.mgr_id              AS 管护客户经理工号
        ,T7.empe_nm             AS 管护客户经理
        ,T1.gl_bal * T9.cny_exr AS 余额折人民币
FROM    edw.dws_bus_dep_act_inf_dd T1 --存款账户信息汇总
LEFT JOIN    edw.dim_bus_act_itm_dd T2 --会计科目
ON      T1.bal_itm_id = T2.act_itm_id
AND     T2.DT = '20240905'
LEFT JOIN    edw.dim_bus_dep_pd_bas_inf_dd T3 --存款产品基础信息表
ON      T1.prod_id = T3.pd_id
AND     T3.DT = '20240905'
LEFT JOIN    edw.dwd_code_library_dd T4 -- 码值表
ON      T1.act_sts_cd = T4.cd_val
AND     T4.tbl_nm = 'DIM_BUS_DEP_ACT_INF_DD'
AND     T4.fld_nm = 'ACT_STS_CD'
AND     T4.DT = '20240905'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T5 --机构树_考核维度 管户
ON      T1.opn_org = T5.org_id
AND     T5.DT = '20240905'
LEFT JOIN    edw.dwd_bus_dep_cst_act_mgr_inf_dd T6 --客户存款账户管护信息
ON      T1.cst_act_id = T6.cst_act_id
AND     T6.frs_ctc_ind = '1'
AND     T6.DT = '20240905'
LEFT JOIN    edw.dws_hr_empe_inf_dd T7 --员工汇总信息 管户
ON      T6.mgr_id = T7.empe_id
AND     T7.DT = '20240905'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T8 --机构树_考核维度 管户
ON      T6.acs_org_id = T8.org_id
AND     T8.DT = '20240905'
LEFT JOIN    edw.dim_bus_com_exr_inf_dd T9 --汇率信息
ON      T1.ccy_cd = T9.ccy_cd
AND     T9.DT = '20240905'
WHERE   T1.DT = '20240905'
AND     T5.brc_org_nm = '湖北大冶泰隆村镇银行'   --大冶村行
;
**01-数据需求_村行_SJ2024100701_庆元村行_吴美健_2024年09月催收走访记录.sql
-- 2024年09月（20240901-20240930）庆元村行催收走访记录

--催收日期、合同号、客户号、客户名称、催收方式、催收地点、催收人员名称(行内)、催收人员名称(行外)、登记人、登记机构、登记日期

-- SELECT * FROM tmp_sjxq_SJ2024100701

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024100701 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_sjxq_SJ2024100701 AS
SELECT  t1.coln_date 催收日期
        ,t1.cont_card_no 合同号或卡号
        ,t1.cust_no 客户号
        ,t1.cust_nm 客户名称
        ,CASE
           WHEN t1.coln_way = '20' THEN '债务拆分'
           WHEN t1.coln_way = '14' THEN 'AI催收'
           WHEN t1.coln_way = '07' THEN '诉讼'
           WHEN t1.coln_way = '17' THEN '分期还款'
           WHEN t1.coln_way = '99' THEN '其他'
           WHEN t1.coln_way = '03' THEN '催收电子邮件'
           WHEN t1.coln_way = '13' THEN '律师函催收'
           WHEN t1.coln_way = '04' THEN '电话录音催收'
           WHEN t1.coln_way = '19' THEN '重组'
           WHEN t1.coln_way = '15' THEN '客户中心二组电话催收'
           WHEN t1.coln_way = '08' THEN '公安立案'
           WHEN t1.coln_way = '05' THEN '客户中心一组电话催收'
           WHEN t1.coln_way = '18' THEN '利息减免'
           WHEN t1.coln_way = '02' THEN '催收短信'
           WHEN t1.coln_way = '11' THEN '现场催收'
           WHEN t1.coln_way = '01' THEN '催收通知书'
           WHEN t1.coln_way = '16' THEN '催收函'
           WHEN t1.coln_way = '09' THEN '报纸公告'
           WHEN t1.coln_way = '06' THEN '上门催收'
           ELSE ''
         END 催收方式
        ,CASE
           WHEN t1.coln_place = '01' THEN '行内'
           WHEN t1.coln_place = '02' THEN '借款人家'
           WHEN t1.coln_place = '03' THEN '担保人家'
           WHEN t1.coln_place = '04' THEN '借款人工作场所'
           WHEN t1.coln_place = '05' THEN ' 担保人工作场所'
           WHEN t1.coln_place = '06' THEN ' 法院'
           ELSE '其他'
         END AS 催收地点
        ,t1.coln_usr_no 催收人员编号_行内
        ,t1.coln_user 催收人员名称_行内
        ,t1.out_person 催收人员名称_行外
        ,t1.input_usr_no 登记人
        ,t1.input_org_no 登记机构
        ,t1.input_date 登记日期
FROM    edw.zcbq_risk_collect_record t1 --催收痕迹
WHERE   t1.dt = '20240930'
AND     t1.input_org_no LIKE '3361%'--庆元村行
AND     t1.coln_date between '2024-09-01 00:00:00' and '2024-09-30 00:00:00'
;


-- SELECT * FROM lab_bigdata_dev.tmp_sjxq_SJ2024100701;
**01-数据需求_村行_SJ2024100981_汝南村行_潘静怡_有余额客户地址信息.sql
-- SJ2024100981
-- 数据日期：2024年9月30日，该时点有余额的客户，客户居住地址
-- 客户号；客户名称；农户标志；贷款余额；合同号；贷款编号；管护机构号；管户人工号；户籍地址/注册地址；工作单位地址/经营地址；居住地址


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_runan_SJ2024100981_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_runan_SJ2024100981_01 AS
SELECT  T1.cst_id      AS 客户号
        ,T1.cst_nm     AS 客户名称
        ,T5.fm_ind     AS 农户标志1是0否
        ,T2.ctr_bal    AS 合同余额
        ,T2.ctr_serno  AS 合同号
        ,T3.dbil_id    AS 贷款编号
        ,T3.prcp_bal   AS 借据余额
        ,T1.prm_mgr_id AS 主管护人工号
        ,T1.prm_org_id AS 主管护机构号
        ,T1.prm_mgr_nm AS 主管护人名称
        ,T1.prm_org_nm AS 主管护机构名称
        ,T4.reg_adr    AS 户籍地址_注册地址
        ,T4.wrk_adr    AS 工作单位地址_经营地址
        ,T4.fml_adr    AS 居住地址
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
INNER JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2 --合同基础信息
ON      T1.cst_id = T2.cst_id
AND     T2.ctr_bal > 0
AND     T2.DT = '20240930'
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd T3 --贷款借据信息汇总
ON      T2.ctr_serno = T3.bus_ctr_id
AND     T3.prcp_bal > 0
AND     T3.DT = '20240930'
LEFT JOIN    edw.dws_cst_bas_inf_dd T4 --客户基础信息汇总表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20240930'
LEFT JOIN    (
                 SELECT  T1.cst_id
                         ,T1.fm_ind
                 FROM    edw.dws_cst_idv_bas_inf_dd T1 --个人客户基本信息汇总表
                 WHERE   T1.dt = '20240930'
                 UNION ALL
                 SELECT  T2.cst_id
                         ,T2.fm_ind
                 FROM    edw.DIM_CST_ENTP_BAS_INF_DD T2 --企业客户基本信息
                 WHERE   T2.dt = '20240930'
             ) T5
ON      T1.cst_id = T5.cst_id
WHERE   T1.DT = '20240930'
AND     SUBSTR(T1.prm_org_id, 1, 4) = '4162';
**01-数据需求_村行_SJ2024101021_旬阳村行_刘少婷_2024年1_9月的全量续贷清单.sql
--SJ2024101021，旬阳村行 2024年1-9月的全量续贷清单
--字段：客户号、客户名称、借据号、产品名称、循环类型、发生类型，合同金额、合同利率、执行利率、上笔合同金额、上笔合同利率、上笔执行利率

--1、取1-9新发生的续贷合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XY_XD_SJ2024101021_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_XY_XD_SJ2024101021_01 AS
SELECT  T1.cst_id         AS 客户号
        ,T1.cst_nm        AS 客户名称
        ,T1.ctr_serno     AS 合同号
        ,T2.dbil_id       AS 借据号
        ,T1.prd_no        AS 产品代码
        ,T3.pd_nm         AS 产品名称
        ,CASE
           WHEN T1.rvlg_typ_cd = '0' THEN '非循环'
           WHEN T1.rvlg_typ_cd = '1' THEN '自助循环'
           WHEN T1.rvlg_typ_cd = '2' THEN '半自助循环'
         END              AS 循环类型
        ,CASE
           WHEN T1.hpn_typ_cd = '011' THEN '续做'
         END              AS 发生类型
        ,T1.ctr_amt       AS 合同金额
        ,T1.ref_intr_rat  AS 参考利率
        ,T1.exec_intr_rat AS 执行利率
        ,T1.ctr_bgn_dt    AS 合同起始日期
FROM    edw.dim_bus_loan_ctr_bse_inf_dd T1 --合同基础信息
LEFT JOIN    edw.dws_bus_loan_dbil_inf_dd T2 --贷款借据信息汇总
ON      T1.ctr_serno = T2.bus_ctr_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.DIM_BUS_LOAN_PRD_FRML_DD T3 --产品信息
ON      T1.prd_no = T3.prd_no
AND     T3.DT = '@@{yyyyMMdd}'
WHERE   T1.DT = '@@{yyyyMMdd}'
AND     SUBSTR(T1.mgr_org_id, 1, 4) = '6161' --旬阳村行
AND     T1.hpn_typ_cd = '011' --续做
AND     T1.ctr_bgn_dt >= '20240101'
AND     T1.ctr_bgn_dt <= '20240930';


--2、结果表，取上笔合同
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_XY_XD_SJ2024101021_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_XY_XD_SJ2024101021_02 AS
SELECT  A1.客户号
        ,A1.客户名称
        ,A1.合同号
        ,A1.借据号
        ,A1.产品代码
        ,A1.产品名称
        ,A1.循环类型
        ,A1.发生类型
        ,A1.合同金额
        ,A1.参考利率
        ,A1.执行利率
        ,A1.上笔合同金额
        ,A1.上笔合同参考利率
        ,A1.上笔合同执行利率
FROM    (
            SELECT  T1 . *
                    ,T2.ctr_amt                                                  AS 上笔合同金额
                    ,T2.ref_intr_rat                                             AS 上笔合同参考利率
                    ,T2.exec_intr_rat                                            AS 上笔合同执行利率
                    ,ROW_NUMBER() OVER ( PARTITION BY T1.客户号 ORDER BY CASE WHEN T2.tmt_dt <> '189912314' THEN LEAST(T2.tmt_dt, T2.ctr_mtu_dt) ELSE T2.ctr_mtu_dt END DESC ) AS RN
            FROM    lab_bigdata_dev.tmp_XY_XD_SJ2024101021_01 T1
            LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T2 --合同基础信息
            ON      T1.客户号 = T2.cst_id
            AND     T2.DT = '@@{yyyyMMdd}'
            AND     T1.合同起始日期 >= CASE WHEN T2.tmt_dt <> '189912314' THEN LEAST(T2.tmt_dt, T2.ctr_mtu_dt) ELSE T2.ctr_mtu_dt END  --新合同起始日期大于 已经终结的合同终结日期和到期日期的最小值
        ) A1
WHERE   A1.RN = 1;
**01-数据需求_村行_SJ2024101151_叶县村行_王凯莹_全量存款睡眠户客户.sql
--含联系方式和地址，转堡垒机处理。
-- 取开业至今的存款、贷款睡眠户清单，用于旺季营销时激活负债睡眠户与挽回流失，分析客户历史购买产品的特征，进行针对营销。

-- 表1：
-- 时间：2019年开业至2024年10月10日
-- 数据范围：叶县村行全量存款睡眠户客户
-- 表2：
-- 时间：2019年开业至2024年10月10日
-- 数据范围：叶县村行全量贷款睡眠户客户



-- 表1字段：客户号，客户姓名，性别，年龄，历史上存款月日均最大，最大存款时间，存款产品类型，所属子社区，管户经理工号，管户经理，管户机构名称，管户主地址，联系方式，工作单位
-- 表2字段：客户号，客户姓名，性别，年龄，历史最大授信额度，历史最大贷款月日均，同一风险控制号，管户经理工号，管户经理，管户机构名称，管户主地址，所属子社区，联系方式，工作单位


-- 1.最大存款月日均,最大存期
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yx_SJ2024101151_01 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yx_SJ2024101151_01 AS
SELECT  A1.cst_id AS 客户号
        ,MAX(A1.存款月日均) AS 最大存款月日均
        ,MAX(A1.最大存期)   AS 最大存期
FROM    (
            SELECT  T1.cst_id
                    ,T1.dt
                    ,SUM(T1.act_mth_acm_bal) / SUBSTR(T1.DT, 7, 2)                                      AS 存款月日均
                    ,MAX(T1.dep_trm * DECODE(SUBSTR(T1.dep_trm, - 1), 'D', '1', 'M', '30', 'Y', '365')) AS 最大存期
            FROM    edw.dws_bus_dep_act_inf_dd T1
            WHERE   T1.DT IN ( '20240131' , '20240229' , '20240331' , '20240430' , '20240531' , '20240630' , '20240731' , '20240831' , '20240930' , '20241010'
			                 , '20230131' , '20230228' , '20230331' , '20230430' , '20230531' , '20230630' , '20230731' , '20230831' , '20230930' , '20231031' , '20231130' , '20231231'
							 , '20220131' , '20220228' , '20220331' , '20220430' , '20220531' , '20220630' , '20220731' , '20220831' , '20220930' , '20221031' , '20221130' , '20221231'
							 , '20210131' , '20210228' , '20210331' , '20210430' , '20210531' , '20210630' , '20210731' , '20210831' , '20210930' , '20211031' , '20211130' , '20211231'
							 , '20200131' , '20200229' , '20200331' , '20200430' , '20200531' , '20200630' , '20200731' , '20200831' , '20200930' , '20201031' , '20201130' , '20201231'
							 , '20190131' , '20190228' , '20190331' , '20190430' , '20190531' , '20190630' , '20190731' , '20190831' , '20190930' , '20191031' , '20191130' , '20191231' )
           GROUP BY  T1.cst_id  ,T1.DT
		) A1
GROUP BY A1.cst_id;


-- 2.存款产品类型
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yx_SJ2024101151_02 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yx_SJ2024101151_02 AS
SELECT  T1.cst_id                           AS 客户号
        ,WM_CONCAT(DISTINCT '、', T2.pd_cmt) AS 存款产品类型
FROM    edw.dws_bus_dep_act_inf_dd T1 --存款账户信息汇总
INNER JOIN    edw.dim_bus_dep_pd_bas_inf_dd T2 --存款产品基础信息表
ON      T1.prod_id = T2.pd_id
AND     T2.DT = '20241010'
WHERE   T1.DT = '20241010'
GROUP BY T1.cst_id;



-- 3.最大贷款月日均,最大单笔授信额度
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yx_SJ2024101151_03 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yx_SJ2024101151_03 AS
SELECT  A1.cst_id AS 客户号
        ,MAX(A1.贷款月日均) AS        最大贷款月日均
        ,MAX(A1.最大单笔授信额度)  AS 最大单笔授信额度
FROM    (
            SELECT  T1.cst_id
                    ,T1.dt
                    ,SUM(T1.mon_acm_prcp_bal_acml) / SUBSTR(T1.DT, 7, 2)                                AS 贷款月日均
                    ,MAX(T1.ctr_amt) AS 最大单笔授信额度
            FROM    edw.dws_bus_loan_dbil_inf_dd T1  --贷款借据信息汇总
            WHERE   T1.DT IN ( '20240131' , '20240229' , '20240331' , '20240430' , '20240531' , '20240630' , '20240731' , '20240831' , '20240930' , '20241010'
			                 , '20230131' , '20230228' , '20230331' , '20230430' , '20230531' , '20230630' , '20230731' , '20230831' , '20230930' , '20231031' , '20231130' , '20231231'
							 , '20220131' , '20220228' , '20220331' , '20220430' , '20220531' , '20220630' , '20220731' , '20220831' , '20220930' , '20221031' , '20221130' , '20221231'
							 , '20210131' , '20210228' , '20210331' , '20210430' , '20210531' , '20210630' , '20210731' , '20210831' , '20210930' , '20211031' , '20211130' , '20211231'
							 , '20200131' , '20200229' , '20200331' , '20200430' , '20200531' , '20200630' , '20200731' , '20200831' , '20200930' , '20201031' , '20201130' , '20201231'
							 , '20190131' , '20190228' , '20190331' , '20190430' , '20190531' , '20190630' , '20190731' , '20190831' , '20190930' , '20191031' , '20191130' , '20191231' )
               GROUP BY  T1.cst_id  ,T1.DT
	   ) A1
GROUP BY A1.cst_id;



-- 4.客户基本信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yx_SJ2024101151_04 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yx_SJ2024101151_04 AS
SELECT  T1.cst_id                                                                     AS 客户号
        ,T3.CST_CHN_NM                                                                AS 客户姓名
        ,CASE
           WHEN T4.GDR_CD = '1' THEN '男'
           WHEN T4.GDR_CD = '2' THEN '女'
         END                                                                          AS 性别
        ,DATEDIFF(TO_DATE(T1.DT, 'yyyyMMdd'), TO_DATE(T4.BTH_DT, 'yyyyMMdd'), 'yyyy') AS 年龄
        ,T3.SUB_CMNT_ID                                                               AS 子社区编号
        ,T5.cmnt_nm                                                                   AS 社区名称
        ,T3.SAM_RSK_CTRL_ID                                                           AS 同一风险控制号
        ,T2.prm_mgr_id                                                                AS 主管护人工号
        ,T2.prm_mgr_nm                                                                AS 主管护人名称
        ,T2.prm_org_id                                                                AS 主管护机构号
        ,T2.prm_org_nm                                                                AS 主管护机构名称
        ,T7.ful_adr                                                                   AS 客户主地址
        -- ,T3.MBL_NBR                                                                   AS 联系方式
        ,T3.WRK_ADR                                                                   AS 工作单位
FROM    adm_pub.adm_csm_cbas_ind_inf_dd T1 --客户集市-基础信息-客户基础标识信息
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T2 --客户主管户信息
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '20241010'
LEFT JOIN    edw.dws_cst_bas_inf_dd T3 --客户基础信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '20241010'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T4 --个人客户基本信息汇总表
ON      T1.cst_id = T4.cst_id
AND     T4.DT = '20241010'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T5 --社区信息
ON      T3.SUB_CMNT_ID = T5.cmnt_enc
AND     T5.DT = '20241010'
LEFT JOIN    edw.dim_cst_bas_phy_adr_inf_dd T7 --客户物理地址信息
ON      T1.cst_id = T7.cst_id
AND     T7.prm_adr_ind = '1'
AND     T7.DT = '20241010'
WHERE   T1.DT = '20241010'
AND     T1.qefe_slp_cst_ind = '1' --睡眠户标识
AND     SUBSTR(T2.prm_org_id, 1, 4) = '4161' -- 叶县村行
;



-- 表1字段：客户号，客户姓名，性别，年龄，历史上存款月日均最大，最大存款时间，存款产品类型，所属子社区，管户经理工号，管户经理，管户机构名称，管户主地址，联系方式，工作单位
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yx_SJ2024101151_b1 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yx_SJ2024101151_b1 AS
SELECT
   T1.客户号
  ,T1.客户姓名
  ,T1.性别
  ,T1.年龄
  ,T2.最大存款月日均
  ,T2.最大存期
  ,T3.存款产品类型
  ,T1.子社区编号
  ,T1.社区名称
  ,T1.主管护人工号
  ,T1.主管护人名称
  ,T1.主管护机构号
  ,T1.主管护机构名称
  ,T1.客户主地址
  ,T1.联系方式
  ,T1.工作单位
FROM lab_bigdata_dev.tmp_yx_SJ2024101151_04 T1
LEFT JOIN  lab_bigdata_dev.tmp_yx_SJ2024101151_01  T2
ON  T1.客户号 = T2.客户号
LEFT JOIN  lab_bigdata_dev.tmp_yx_SJ2024101151_02  T3
ON  T1.客户号 = T3.客户号
WHERE COALESCE(T2.最大存款月日均,'')<>''  --历史有过存款
;


-- 表2字段：客户号，客户姓名，性别，年龄，历史最大授信额度，历史最大贷款月日均，同一风险控制号，管户经理工号，管户经理，管户机构名称，管户主地址，所属子社区，联系方式，工作单位

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_yx_SJ2024101151_b2 PURGE;

CREATE TABLE lab_bigdata_dev.tmp_yx_SJ2024101151_b2 AS
SELECT
   T1.客户号
  ,T1.客户姓名
  ,T1.性别
  ,T1.年龄
  ,T2.最大贷款月日均
  ,T2.最大单笔授信额度
  ,T1.同一风险控制号
  ,T1.主管护人工号
  ,T1.主管护人名称
  ,T1.主管护机构号
  ,T1.主管护机构名称
  ,T1.客户主地址
  ,T1.子社区编号
  ,T1.社区名称
--   ,T1.联系方式
  ,T1.工作单位
FROM lab_bigdata_dev.tmp_yx_SJ2024101151_04 T1
LEFT JOIN  lab_bigdata_dev.tmp_yx_SJ2024101151_03  T2
ON  T1.客户号 = T2.客户号
WHERE COALESCE(T2.最大贷款月日均,'')<>''   --历史有过贷款
;
**01-数据需求_村行_SJ2024101201_大冶村行_邓凤平_客户全面盘点.sql
-- 大冶村行所有客户的相关字段口径，字段内容中已经标记字段的需求时间
-- SJ2024101201

-- 1. 客户基本信息

-- 客户基本信息	客户号	姓名	年龄	子社区	是否主推子社区	本地/异地	同一风险控制号授信金额   	2023年12月同一风险控制号授信金额
-- 2022年12月同一风险控制号授信金额 	客户名下是否存在未到期未终结泰e贷、融e贷、随贷通，并且合同发生时间超过半年且当前未用信（是/否）
-- 客户我行加权利率	他行最高一笔利率	客户名下循环贷款（泰e贷、融e贷、随贷通）授信额度，不含非自助循环长授信、短风控
-- 客户名下循环贷款（泰e贷、融e贷、随贷通）绑定额度，不含非自助循环长授信、短风控	客户及配偶名下是否有随贷通卡	随贷通卡授信额度

--1.1 同一风险控制号授信金额
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_01 AS
SELECT  T1.DT
        ,T1.cst_id -- 客户号
        ,T1.sam_rsk_ctrl_id -- 同一风险控制号
        ,SUM(T3.ctr_amt) AS 同一风险控制号授信金额
FROM    edw.dws_cst_bas_inf_dd T1 --客户基础信息汇总表
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.sam_rsk_ctrl_id = T2.sam_rsk_ctrl_id
AND     T1.DT = T2.DT
AND     T2.sam_rsk_ctrl_id <> ''
AND     T2.DT IN ( '@@{yyyyMMdd}' , '20231231' , '20221231' )
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T3 --合同基础信息
ON      COALESCE(T2.cst_id, T1.cst_id) = T3.cst_id
AND     T1.DT = T3.DT
AND     ( ( T3.CTR_STS_CD IN ( '2' , '4' )
AND     T3.TMT_DT = '18991231'
AND     to_date(T3.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T3.DT, 'yyyyMMdd') )
    OR T3.CTR_BAL > 0 )
AND     T3.DT IN('@@{yyyyMMdd}', '20231231', '20221231')
WHERE   T1.DT IN('@@{yyyyMMdd}', '20231231', '20221231')
GROUP BY T1.DT , T1.cst_id , T1.sam_rsk_ctrl_id;


--1.2 泰e贷、融e贷、随贷通信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_02 AS
SELECT  A1.cst_id
        ,SUM(A1.ctr_amt * A1.exec_intr_rat * A1.facl_trm) / NULLIF(SUM(A1.ctr_amt * A1.facl_trm), 0) AS 客户级加权利率
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101002' , '2001020101002' ) THEN A1.ctr_amt
               ELSE 0
             END)                                                                                    AS 泰e贷授信额度
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101003' , '2001020101003' ) THEN A1.ctr_amt
               ELSE 0
             END)                                                                                    AS 随贷通授信额度   --2001010101003/2001020101003
        ,SUM(CASE
               WHEN A3.RVLG_PRD_CD = '02' THEN A1.ctr_amt
               ELSE 0
             END)                                                                                    AS 融e贷授信额度
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101002' , '2001020101002' ) THEN A1.strt_use_amt
               ELSE 0
             END)                                                                                    AS 泰e贷启用金额
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101003' , '2001020101003' ) THEN A1.strt_use_amt
               ELSE 0
             END)                                                                                    AS 随贷通启用金额
        ,SUM(CASE
               WHEN A3.RVLG_PRD_CD = '02' THEN A1.strt_use_amt
               ELSE 0
             END)                                                                                    AS 融e贷启用金额
        ,MAX(CASE
               WHEN ( A3.RVLG_PRD_CD = '02' OR A1.prd_no IN ( '2001010101002' , '2001020101002' ) OR A1.prd_no IN ( '2001010101003' , '2001020101003' ) ) AND A1.ctr_bgn_dt >= '@@{yyyyMMdd-6m}' AND A1.ctr_bal = 0 THEN '是'
               ELSE '否'
             END)                                                                                     AS 是否泰_随_融合同发生时间超过半年且当前未用信
FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
LEFT JOIN    edw.dwd_bus_loan_reply_biz_loan_dd A3 --贷款用信
ON      A1.rel_serno = A3.usc_aply_serno
AND     A3.DT = '@@{yyyyMMdd}'
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
AND     A1.TMT_DT = '18991231'
AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.DT, 'yyyyMMdd') )
    OR A1.CTR_BAL > 0 ) --未结清
GROUP BY A1.cst_id;



--1.3 他行最高一笔利率
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_03 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_03 AS
SELECT  A1.cst_id
        ,SUBSTR(A1.report_id, 1, 8)                                        AS 报告日期
        ,CAST(A2.intr_rat AS  STRING)        AS intr_rat
        ,A1.ctr_bal
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
INNER JOIN    edw.dim_cst_ccrc_idv_dbt_act_rat_dd A2 --个人征信借贷账户利率计算
ON      A1.report_id = A2.crd_rpt_id
AND     A1.act_id = A2.act_id
AND     COALESCE(A2.intr_rat, '') <> ''
AND     A2.intr_rat <> '-9999'
AND     A2.DT = '@@{yyyyMMdd}'
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     A1.dtrb_org <> 'ZJTLCB'
AND     A1.ctr_bal > 0
UNION ALL
SELECT  A1.cst_id
        ,SUBSTR(A1.report_id, 1, 8)                                        AS 报告日期
        ,CAST(A2.irr AS  STRING)        AS intr_rat
        ,A1.loan_bal                                                       AS ctr_bal
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
INNER JOIN    edw.ncip_ceq_account_calculate A2 --企业征信借贷账户利率计算
ON      A1.report_id = A2.report_id
AND     A1.act_id = A2.le_acc_number
AND     COALESCE(A2.irr, '') <> ''
AND     A2.irr <> '-9999'
AND     A2.DT <= '@@{yyyyMMdd}'
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     A1.dtrb_org_typ_cd <> ''
AND     A1.loan_bal > 0;



-- 1.4 客户基本信息汇总
-- SELECT sum(泰e贷授信额度) FROM tmp_dy_SJ2024101201_04
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_04 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_04 AS
SELECT  T1.cst_id                                                                     AS 客户号
        ,T1.cst_nm                                                                    AS 姓名
        ,DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(T3.BTH_DT, 'YYYYMMDD'), 'YYYY') AS 年龄
        ,T2.sub_cmnt_id                                                               AS 子社区编号
        ,T4.comm_sub_community_name                                                   AS 子社区
        ,CASE
           WHEN T4.developmentype = '主推' THEN '是'
           ELSE '否'
         END                                                                          AS 是否主推子社区
        ,CASE
           WHEN T2.REG_ADR RLIKE '大冶' THEN '本地'
           ELSE '异地'
         END                                                                          AS 本地_异地
        ,T5.同一风险控制号授信金额
        ,T51.同一风险控制号授信金额                                                              AS 2023年12月同一风险控制号授信金额
        ,T51.同一风险控制号授信金额                                                              AS 2022年12月同一风险控制号授信金额
        ,T6.是否泰_随_融合同发生时间超过半年且当前未用信
        ,T6.客户级加权利率
        ,T7.他行最高一笔利率
        ,T6.泰e贷授信额度
        ,T6.随贷通授信额度
        ,T6.融e贷授信额度
        ,T6.泰e贷启用金额
        ,T6.随贷通启用金额
        ,T6.融e贷启用金额
        ,CASE
           WHEN COALESCE(T6.随贷通授信额度,0) + COALESCE(T9.随贷通授信额度,0) > 0 THEN '是'
           ELSE '否'
         END                                                                          AS 客户及配偶名下是否有随贷通卡
        ,COALESCE(T6.随贷通授信额度,0) + COALESCE(T9.随贷通授信额度,0)                                                AS 客户及配偶名下随贷通授信额度
        ,T10.cd_val_dscr                                                              AS 所在行业
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_etl_xw_com_bi_dt_zsq T4 --社区经营情况明细报表(子社区)(T+2回流)
ON      T2.sub_cmnt_id = T4.comm_sub_community_no
AND     T4.DT = '@@{yyyyMMdd-1d}'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_01 T5 --当前
ON      T1.cst_id = T5.cst_id
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_01 T51 --23年
ON      T1.cst_id = T51.cst_id
AND     T51.DT = '20231231'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_01 T52 --22年
ON      T1.cst_id = T52.cst_id
AND     T52.DT = '20221231'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_02 T6
ON      T1.cst_id = T6.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,MAX(intr_rat) AS 他行最高一笔利率
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_03
                 WHERE   RN = 1
                 GROUP BY cst_id
             ) T7
ON      T1.cst_id = T7.cst_id
LEFT JOIN    edw.loan_cst_rel T8 -- 配偶
ON      T1.cst_id = T8.cst_id
AND     T8.rel_typ = '0301'
AND     T8.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_02 T9
ON      T8.rel_cst_id = T9.cst_id
LEFT JOIN    edw.dwd_code_library_dd T10 -- 码值表
ON      T2.idt_cd = T10.cd_val
AND     T10.tbl_nm = 'DWS_CST_BAS_INF_DD'
AND     T10.fld_nm = 'IDT_CD'
AND     T10.DT = '@@{yyyyMMdd}'
WHERE   SUBSTR(T1.prm_org_id, 1, 4) = '4261' --湖北大冶泰隆村镇银行
AND     T1.DT = '@@{yyyyMMdd}'
;




--2.资产负债指标
--总资产	可处置资产	应收账款占比	总负债	我行负债	他行负债	他行负债较上年最后一次查询征信的负债变化	应付账款
-- 资产负债率	可处置资产/负债	流动性资产	流动性负债/流动性资产	经营性负债（除房贷、消费贷、信用卡）	净资产

-- 2.1 客户资产明细
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_05 AS
SELECT  T1.客户号
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='8'  THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产现金
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='9'  THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产短期投资
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='10' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产长期投资
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='11' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产应收账款
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='12' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产预付账款
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='13' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产存货
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='14' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产生产设备
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='15' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产不动产
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='20' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产活体类
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='19' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产权利类
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='16' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产车辆情况
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='18' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产其它资产
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='21' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债民间借贷
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='22' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债金融机构
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='23' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债社会集资
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='24' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债预收
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='25' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债应付
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='26' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债其它负债
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='27' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  对外担保
FROM lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN edw.dwd_cst_asst_fnc_stat_cus_ass_lib_dtl_dd T2
ON T1.客户号 = T2.cst_id
AND T2.DT ='@@{yyyyMMdd}'
GROUP BY T1.客户号;


--2.2 客户总资产
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_06 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_06 AS
SELECT  T1.客户号
        ,T2.ast_amt      AS 资产总额
        ,T2.lbl_amt      AS 负债总额
        ,T2.net_ast_amt  AS 净资产总额
        ,T3.loan_bal_acs AS 我行负债
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    app_ado.adm_subl_cst_bus_inf_dd T2 --实验室应用层资产-客户业务信息汇总表
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbus_loan_inf_dd T3 --客户集市-业务信息-客户贷款业务信息表
ON      T1.客户号 = T3.cst_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    app_ado.adm_subl_cst_bus_inf_dd T6 --实验室应用层资产-客户业务信息汇总表 上年末
ON      T1.客户号 = T6.cst_id
AND     T6.DT = '20231231';




--2.3 客户他行征信负债
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_07 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_07 AS
SELECT  T1.客户号
        ,T2.他行征信负债
        ,T3.他行上一年征信负债
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(ctr_bal) AS 他行征信负债
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_03
                 WHERE   RN = 1
		 GROUP BY  cst_id
             ) T2
ON      T1.客户号 = T2.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(ctr_bal) AS 他行上一年征信负债
                 FROM    (
                             SELECT  cst_id
                                     ,ctr_bal
                                     ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.RN ) AS RN
                             FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_03 A1
                             WHERE   A1.报告日期 <= '20231231'
                         ) B1
                 WHERE   B1.RN = 1
		 GROUP BY  cst_id
             ) T3
ON      T1.客户号 = T3.cst_id;



--2.4 客户资产信息汇总
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_08 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_08 AS
SELECT  T1.客户号
        ,T1.资产现金
        ,T1.资产短期投资
        ,T1.资产长期投资
        ,T1.资产应收账款
        ,T1.资产预付账款
        ,T1.资产存货
        ,T1.资产生产设备
        ,T1.资产不动产
        ,T1.资产活体类
        ,T1.资产权利类
        ,T1.资产车辆情况
        ,T1.资产其它资产
        ,T1.负债民间借贷
        ,T1.负债金融机构
        ,T1.负债社会集资
        ,T1.负债预收
        ,T1.负债应付
        ,T1.负债其它负债
        ,T1.对外担保
        ,T2.资产总额
        ,T2.负债总额
        ,T2.净资产总额
        ,T2.我行负债
        ,T3.他行征信负债
        ,T3.他行上一年征信负债
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_05 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_06 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_07 T3
ON      T1.客户号 = T3.客户号;





-- 3 经营指标 销售收入	收入负债比/销售融资比	销售收入较去年变化幅度	我行近6个月（12个月）存款日均

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_1 AS
SELECT  cst_id
        ,bgn_dt                                                              AS 开始日期
        ,end_dt                                                              AS 结束日期
        ,sal_amt                                                             AS 销售额
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY last_upd_tm DESC ) AS RN
FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd  --信贷客户经营信息销售额及净利润信息
WHERE   DT = '@@{yyyyMMdd}';

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_2 AS
SELECT  cst_id
        ,bgn_dt                                                              AS 开始日期
        ,end_dt                                                              AS 结束日期
        ,sal_amt                                                             AS 销售额
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY last_upd_tm DESC ) AS RN
FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd
WHERE   DT = '20231231';

-- 3.1 年销售额 ,我行近6个月（12个月）存款日均
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09 AS
SELECT  T1.客户号
        ,T2.开始日期
        ,T2.结束日期
        ,T2.销售额
        ,T6.开始日期 AS 开始日期_上年末
        ,T6.结束日期 AS 结束日期_上年末
        ,T6.销售额  AS 销售额_上年末
        ,T7.我行近6个月存款日均
        ,T7.我行近12个月存款日均
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_09_1 T2 --
ON      T1.客户号 = T2.cst_id
AND     T2.RN = 1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_09_2 T6 -- 上年末
ON      T1.客户号 = T6.cst_id
AND     T6.RN = 1
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(last_90_days_gl_bal_acml) / 90   AS 我行近6个月存款日均
                         ,SUM(last_360_days_gl_bal_acml) / 360 AS 我行近12个月存款日均
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY cst_id
             ) T7
ON      T1.客户号 = T7.cst_id;






-- 4. 风险综合指标	风险等级	征信评分	上年最后一次查询征信评分（连续下降）	模型分	相对位置	是否隐患客户
-- 最近一次的预评估结果	预评估不通过的触发规则	最近一次的精准贷后结果（只选取近9个月的）	最近一次精准贷后触发的规则	最近一年触发精准贷后的次数

--4.1  征信评分	上年最后一次查询征信评分 是否隐患客户
--当前征信评分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_1 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;


--上年最后一次查询征信评分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_2 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20231231'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20231231'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_10 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_10 AS
SELECT  T1.客户号
        ,T2.中证评分 AS 征信评分
        ,T3.中证评分 AS 上年征信评分
        ,CASE
           WHEN T4.rsk_hidden_cst_ind = 1 THEN '是'
           ELSE '否'
         END     AS 是否风险隐患客户
        ,T5.风险等级
	,T5.模型分
	,T5.相对位置
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_1 T2 --个人征信指标信息表
ON      T1.客户号 = T2.cst_id
AND     T2.rk = 1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_2 T3 --个人征信指标信息表
ON      T1.客户号 = T3.cst_id
AND     T3.rk = 1
LEFT JOIN    adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd T4 --客户集市-风险信息-基础风险标签信息
ON      T1.客户号 = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,CASE
                            WHEN A1.rsk_lyr_cd = '1' THEN '低风险'
                            WHEN A1.rsk_lyr_cd = '5' THEN '高风险'
                            WHEN A1.rsk_lyr_cd = '2' THEN '中低风险'
                            WHEN A1.rsk_lyr_cd = '3' THEN '中风险'
                            WHEN A1.rsk_lyr_cd = '4' THEN '中高风险'
                          END                                                                          AS 风险等级
			 ,A1.modl_grd                  AS 模型分
			 ,A1.pct                       AS 相对位置
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.rsk_lyr_afm_tm DESC ) AS RN
                 FROM    edw.dim_cst_asst_rsk_lyr_dd A1  --风险分层信息
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.rsk_lyr_cd <> ''
             ) T5
ON      T1.客户号 = T5.cst_id
AND     T5.RN = 1;


--4.2.1 精准贷后明细信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_11 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_11 AS
SELECT  T1.cst_id      AS 客户号
        ,T2.tsk_gen_dt AS 精准贷后风险触发时间
        ,CASE
           WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
           WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
           WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
           WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类'
         END           AS 精准贷后触发类型
	,T3.触发规则分类
        ,T3.触发规则
	,T3.触发原因分析
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03' , '04' ) --01	处置1级, 02	处置2级, 03	预警类, 04	提示类
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.btch_serno
                         ,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)                                AS 触发规则分类
			 ,A1.rul_nm               AS 触发规则
			 ,A1.trg_rsn_anls         AS 触发原因分析
                         ,A1.rul_ctg_nm --规则分类名称
                         ,A1.rul_sub_clss_nm --规则细类名称
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
                 FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
                 WHERE   A1.DT = '@@{yyyyMMdd}'
             ) T3
ON      T1.btch_serno = T3.btch_serno
AND     T3.RN = 1
WHERE   T1.DT = '@@{yyyyMMdd}';


--4.2 精准贷后信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_12 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_12 AS
SELECT  T1.客户号
        ,T2.精准贷后风险触发时间 AS 近9个月内_最近一次精准贷后风险触发时间
        ,T2.精准贷后触发类型     AS 近9个月内_最近一次精准贷后触发类型
	,T2.触发规则分类         AS 近9个月内_最近一次触发规则分类
        ,T2.触发规则             AS 近9个月内_最近一次触发规则
	,T2.触发原因分析         AS 近9个月内_最近一次触发原因分析
        ,T3.最近一年触发精准贷后的次数
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    (
                 SELECT  A1.客户号
                         ,A1.精准贷后风险触发时间
                         ,A1.精准贷后触发类型
                         ,A1.触发规则
			 ,A1.触发原因分析
			 ,A1.触发规则分类
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.客户号 ORDER BY A1.精准贷后风险触发时间 DESC ) AS RN --倒序
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_11 A1
                 WHERE   A1.精准贷后风险触发时间 >= '@@{yyyyMMdd-9m}'  --近9个月
             ) T2
ON      T1.客户号 = T2.客户号
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  A1.客户号
                         ,COUNT(1) AS 最近一年触发精准贷后的次数
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_11 A1
                 WHERE   A1.精准贷后风险触发时间 >= '@@{yyyyMMdd-1y}' --近一年
                 GROUP BY A1.客户号
             ) T3
ON      T1.客户号 = T3.客户号;





--4.3 预评估信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_13 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_13 AS
SELECT  A1.客户号
        ,A2.最近一次预评估结果
        ,A2.最近一次预评估时间
        ,A2.预评估触发规则
		,A2.预评估提示信息
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 A1
LEFT JOIN    (
                 SELECT  T1.aplc_no                                                                          AS 客户号
                         ,T2.cd_val_dscr                                                                     AS 最近一次预评估结果
                         ,T1.gen_tm                                                                          AS 最近一次预评估时间
                         ,T3.预评估触发规则
			,T3.预评估提示信息
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.aplc_no ORDER BY T1.pre_ases_rslt_serno DESC ) AS RN
                 FROM    edw.dim_bus_loan_pre_ases_rslt_inf_dd T1 --预评估结果信息
                 LEFT JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
                 ON      T1.pre_ases_rslt_serno = T0.rul_set_rslt_serno
                 AND     T0.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
                 ON      T0.rul_set_rslt_cd = T2.cd_val
                 AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
                 AND     T2.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     T2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  B1.rul_set_rslt_serno
                                         ,WM_CONCAT('||',B1.rul_nm) AS 预评估触发规则
					,WM_CONCAT('||',B1.prmpt_msg) AS 预评估提示信息
                                  FROM    edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
                                  WHERE   B1.DT = '@@{yyyyMMdd}'
                                  GROUP BY B1.rul_set_rslt_serno
                              ) T3
                 ON      T0.rul_set_rslt_serno = T3.rul_set_rslt_serno
                 WHERE   T1.DT = '@@{yyyyMMdd}'
             ) A2
ON      A1.客户号 = A2.客户号
AND     A2.RN = 1;


-- 4.5 风险综合指标合并
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_14 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_14 AS
SELECT  T1.客户号
        ,T1.风险等级
	,T1.模型分
        ,T1.相对位置
        ,T1.征信评分
        ,T1.上年征信评分
        ,T1.是否风险隐患客户
	,T2.近9个月内_最近一次精准贷后风险触发时间
	,T2.近9个月内_最近一次精准贷后触发类型
	,T2.近9个月内_最近一次触发规则分类
	,T2.近9个月内_最近一次触发规则
	,T2.近9个月内_最近一次触发原因分析
        ,T2.最近一年触发精准贷后的次数
        ,T3.最近一次预评估结果
        ,T3.最近一次预评估时间
        ,T3.预评估触发规则
	,T3.预评估提示信息
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_10 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_12 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_13 T3
ON      T1.客户号 = T3.客户号;



-- 5.征信指标
-- 征信报告日期	授信总额（信用总额）	授信余额（信用总余额）	有信用业务的银行数	现有贷款授信银行数	现有信用卡授信银行数
-- 最近6个查询内审批查询机构数	最近6个查询非银内审批查询机构数	除房贷外当前有余额的贷款机构数	非银行机构授信余额	他行经营性贷款授信机构数
-- 对外担保金额	信用卡透支率	查询次数	当前逾期总额	贷款当前逾期总额	贷款当前最大逾期期数	贷记卡逾期账户数	呆账笔数
-- 呆账余额	保证人代偿笔数	保证人代偿余额	贷款五级分类为非正常的余额	贷款五级分类为非正常的笔数	非正常贷款对外担保笔数


-- 5.1 征信指标信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_15 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_15 AS
SELECT  T1.客户号
        ,COALESCE(T2.report_dt, T3.report_dt)                            AS 征信报告日期
        ,COALESCE(T2.cred_total_amt, T3.cred_total_amt)                  AS 授信总额_信用总额
        ,COALESCE(T2.cred_total_balan, T3.cred_total_balan)              AS 授信余额_信用总余额
        ,COALESCE(T2.cred_biz_bank_num, T3.unsett_cred_busi_org_num)     AS 有信用业务的银行数
        ,COALESCE(T2.curr_loan_bank_num, T3.un_sett_loan_rzbank_num)     AS 现有贷款授信银行数
        ,T2.curr_cred_bank_num                                           AS 现有信用卡授信银行数
        ,T2.rem_house_loan_unsett_org_num                                AS 除房贷外当前有余额的贷款机构数
        ,T2.loan_fyg_num_amt                                             AS 非银行机构授信余额
        ,T2.othr_bnk_mngmt_loan_org_num                                  AS 他行经营性贷款授信机构数
        ,COALESCE(T2.guar_contr_amt, T3.guar_contr_amt)                  AS 对外担保金额
        ,T2.c_cred_card_use_frequ                                        AS 信用卡透支率
        ,T2.c_od_amt                                                     AS 当前逾期总额
        ,T2.c_od_total_amt                                               AS 贷款当前逾期总额
        ,T2.c_od_max_num                                                 AS 贷款当前最大逾期期数
        ,T2.djk_od_acct_num                                              AS 贷记卡逾期账户数
        ,T2.dz_acct_num                                                  AS 呆账笔数
        ,T2.dz_acct_balan                                                AS 呆账余额
        ,COALESCE(T2.gu_comp_num, T3.guan_comp_num)                      AS 保证人代偿笔数
        ,COALESCE(T2.gu_comp_balan, T3.guan_comp_balan)                  AS 保证人代偿余额
        ,COALESCE(T2.un_normal_loan_balan, T3.un_normal_loan_balan)      AS 贷款五级分类为非正常的余额
        ,COALESCE(T2.un_normal_loan_num, T3.un_normal_loan_num)          AS 贷款五级分类为非正常的笔数
        ,COALESCE(T2.curr_bad_extguan_loan_num, T3.unnm_loan_guar_count) AS 非正常贷款对外担保笔数
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T2 --个人征信指标信息表
ON      T1.客户号 = T2.cst_id
AND     T2.report_dsc_rn = 1
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd T3 --企业征信指标信息表
ON      T1.客户号 = T3.cst_id
AND     T3.report_dsc_rn = 1
AND     T3.DT = '@@{yyyyMMdd}';



-- 5.2 征信查询信息
-- qry_rsn_cd	 = '02' --贷款审批  A1.qry_org_typ NOT IN ('11','12','14','15') --非银机构
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_16 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_16 AS
SELECT  A1.qry_cst_id AS 客户号
        ,COUNT(1)     AS 查询次数
        ,SUM(CASE
               WHEN CAST(A1.qry_dt AS STRING) <> '' AND A1.qry_rsn_cd = '02' AND DATEDIFF(TO_DATE(SUBSTR(A1.rpt_id, 1, 8), 'YYYYMMDD'), TO_DATE(SUBSTR(CAST(A1.qry_dt AS STRING), 1, 8), 'YYYYMMDD'), 'MM') <= 6 THEN 1
               ELSE 0
             END)     AS 近6个月审批查询机构数
        ,SUM(CASE
               WHEN CAST(A1.qry_dt AS STRING) <> '' AND A1.qry_rsn_cd = '02' AND A1.qry_org_typ NOT IN ( '11' , '12' , '14' , '15' ) AND DATEDIFF(TO_DATE(SUBSTR(A1.rpt_id, 1, 8), 'YYYYMMDD'), TO_DATE(SUBSTR(CAST(A1.qry_dt AS STRING), 1, 8), 'YYYYMMDD'), 'MM') <= 6 THEN 1
               ELSE 0
             END)     AS 近6个月非银机构审批查询机构数
FROM    edw.dwd_cst_ccrc_ipcr_qry_rcd_di A1 --人行征信报告查询记录明细
INNER JOIN    (
                  SELECT  qry_cst_id
                          ,MAX(rpt_id) AS rpt_id
                  FROM    edw.dwd_cst_ccrc_ipcr_qry_rcd_di --人行征信报告查询记录明细
                  WHERE   DT <= '@@{yyyyMMdd}'
                  GROUP BY qry_cst_id
              ) A2
ON      A1.rpt_id = A2.rpt_id
AND     A1.qry_cst_id = A2.qry_cst_id
WHERE   A1.DT <= '@@{yyyyMMdd}'
GROUP BY A1.qry_cst_id;



-- 5.征信指标
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_17 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_17 AS
SELECT  T1.客户号
        ,T1.征信报告日期
        ,T1.授信总额_信用总额
        ,T1.授信余额_信用总余额
        ,T1.有信用业务的银行数
        ,T1.现有贷款授信银行数
        ,T1.现有信用卡授信银行数
        ,T1.除房贷外当前有余额的贷款机构数
        ,T1.非银行机构授信余额
        ,T1.他行经营性贷款授信机构数
        ,T1.对外担保金额
        ,T1.信用卡透支率
        ,T1.当前逾期总额
        ,T1.贷款当前逾期总额
        ,T1.贷款当前最大逾期期数
        ,T1.贷记卡逾期账户数
        ,T1.呆账笔数
        ,T1.呆账余额
        ,T1.保证人代偿笔数
        ,T1.保证人代偿余额
        ,T1.贷款五级分类为非正常的余额
        ,T1.贷款五级分类为非正常的笔数
        ,T1.非正常贷款对外担保笔数
        ,T2.查询次数
        ,T2.近6个月审批查询机构数
        ,T2.近6个月非银机构审批查询机构数
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_15 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_16 T2
ON      T1.客户号 = T2.客户号;



--6 新加 最近一次的现场走访时间
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 AS
-- SELECT  T1.客户号
        -- ,T2.create_tm AS 最近一次的现场走访时间
-- FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
-- LEFT JOIN    (
                 -- SELECT  A1.cst_id
                         -- ,A1.create_tm
                         -- ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.create_tm DESC ) AS RN
                 -- FROM    edw.xwdt_xw_cst_vst_dtl_di A1
                 -- WHERE   A1.DT = '@@{yyyyMMdd}'
                 -- AND     A1.srv_type = '01' -- 服务类型（01-拜访 02-接待）
                 -- AND     A1.srv_cntnt NOT RLIKE '电访|短信|电话'
             -- ) T2
-- ON      T1.客户号 = T2.cst_id
-- AND     T2.RN = 1;


-- 04	侧面打听（现场）
-- 01	现场（实地）
-- 02	云调查
-- 03	非现场
-- 05	侧面打听（非现场）
-- 06	侧面打听（批量）


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 AS
SELECT  T1.客户号
        ,T2.svy_dt AS 最近一次的现场走访时间
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.svy_dt
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.svy_dt DESC ) AS RN
                 FROM    edw.dwd_bus_loan_cst_svy_rcd_dd A1
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.svy_mod_cd IN ( '01' , '04' ) --现场（实地）、侧面打听（现场）
             ) T2
ON      T1.客户号 = T2.cst_id
AND     T2.RN = 1;



-----------------------------------------------------------------------------
-----------------------------------------------------------------------------
-- 结果表

SELECT sum(泰e贷授信额度) FROM tmp_dy_SJ2024101201_JGB

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_JGB PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_JGB AS
SELECT
   --基本信息
   T1.客户号
   ,T1.姓名
   ,T1.年龄
   ,T1.子社区编号
   ,T1.子社区
   ,T1.是否主推子社区
   ,T1.本地_异地
   ,T1.同一风险控制号授信金额
   ,T1.2023年12月同一风险控制号授信金额
   ,T1.2022年12月同一风险控制号授信金额
   ,T1.是否泰_随_融合同发生时间超过半年且当前未用信
   ,T1.客户级加权利率
   ,T1.他行最高一笔利率
   ,T1.泰e贷授信额度
   ,T1.随贷通授信额度
   ,T1.融e贷授信额度
   ,T1.泰e贷启用金额
   ,T1.随贷通启用金额
   ,T1.融e贷启用金额
   ,T1.客户及配偶名下是否有随贷通卡
   ,T1.客户及配偶名下随贷通授信额度
   ,T1.所在行业
   --资产负债指标
   ,T2.资产现金
   ,T2.资产短期投资
   ,T2.资产长期投资
   ,T2.资产应收账款
   ,T2.资产预付账款
   ,T2.资产存货
   ,T2.资产生产设备
   ,T2.资产不动产
   ,T2.资产活体类
   ,T2.资产权利类
   ,T2.资产车辆情况
   ,T2.资产其它资产
   ,T2.负债民间借贷
   ,T2.负债金融机构
   ,T2.负债社会集资
   ,T2.负债预收
   ,T2.负债应付
   ,T2.负债其它负债
   ,T2.对外担保
   ,T2.资产总额
   ,T2.负债总额
   ,T2.净资产总额
   ,T2.我行负债
   ,T2.他行征信负债
   ,T2.他行上一年征信负债
   --经营指标
   ,T3.开始日期
   ,T3.结束日期
   ,T3.销售额
   ,T3.开始日期_上年末
   ,T3.结束日期_上年末
   ,T3.销售额_上年末
   ,T3.我行近6个月存款日均
   ,T3.我行近12个月存款日均
   --风险综合指标
   ,T4.风险等级
   ,T4.模型分
   ,T4.相对位置
   ,T4.征信评分
   ,T4.上年征信评分
   ,T4.是否风险隐患客户
   ,T4.近9个月内_最近一次精准贷后风险触发时间
   ,T4.近9个月内_最近一次精准贷后触发类型
   ,T4.近9个月内_最近一次触发规则分类
   ,T4.近9个月内_最近一次触发规则
   ,T4.近9个月内_最近一次触发原因分析
   ,T4.最近一年触发精准贷后的次数
   ,T4.最近一次预评估结果
   ,T4.最近一次预评估时间
   ,T4.预评估触发规则
   ,T4.预评估提示信息
   --征信指标
   ,T5.征信报告日期
   ,T5.授信总额_信用总额
   ,T5.授信余额_信用总余额
   ,T5.有信用业务的银行数
   ,T5.现有贷款授信银行数
   ,T5.现有信用卡授信银行数
   ,T5.除房贷外当前有余额的贷款机构数
   ,T5.非银行机构授信余额
   ,T5.他行经营性贷款授信机构数
   ,T5.对外担保金额
   ,T5.信用卡透支率
   ,T5.当前逾期总额
   ,T5.贷款当前逾期总额
   ,T5.贷款当前最大逾期期数
   ,T5.贷记卡逾期账户数
   ,T5.呆账笔数
   ,T5.呆账余额
   ,T5.保证人代偿笔数
   ,T5.保证人代偿余额
   ,T5.贷款五级分类为非正常的余额
   ,T5.贷款五级分类为非正常的笔数
   ,T5.非正常贷款对外担保笔数
   ,T5.查询次数
   ,T5.近6个月审批查询机构数
   ,T5.近6个月非银机构审批查询机构数
   ,T6.最近一次的现场走访时间
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_08 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_09 T3
ON      T1.客户号 = T3.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_14 T4
ON      T1.客户号 = T4.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_17 T5
ON      T1.客户号 = T5.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_18 T6
ON      T1.客户号 = T6.客户号;
**01-数据需求_村行_程义平_村行客户FTP数据_数字化运营.sql
-- 对象：村行（子社区编号、子社区名称）
-- 时间：2024年7月10日较2024年2月29日
-- 净增值：净增FTP、净增存、贷规模、净增有效户、净增有效贷款户

-- 数据字段：客户编号、客户名称、机构（村行）、子社区、建档日期、挂靠日期、FTP、存款月日均、贷款月日均、是否有效户、是否有效贷款户。取的时间节点（2024年7月10日和2024年2月29日）

--20240229
DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240229 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240229 as
SELECT T1.cst_id 客户号
       ,T1.cst_nm 客户名称
    --    ,T1.lgp_id 法人编号
    --    ,T1.lgl_org_id 总行机构编号
    --    ,T1.lgl_org_nm 总行机构名称
       ,T1.brn_org_id 机构编号
       ,T1.brn_org_nm 机构名称
       ,T2.new_com_code 子社区编号
       ,T2.new_com_name 子社区名称
        ,T4.brc_org_id 社区所属机构编号
       ,T4.brc_org_nm	 社区所属机构名称
       ,T2.crt_dt 建档日期
       ,T2.new_com_put_up_date 子社区挂靠时间
       ,T1.ftp_year_pft FTP年累计
       ,T1.ftp_mon_pft FTP月累计
       ,T1.dep_mon_avg_bal 存款月日均
       ,T1.ln_mon_avg_bal 本行贷款当月月日均
       ,T1.vld_cst_ind 有效户标识
       ,T1.vld_ln_cst_ind 有效贷款户标识
       ,T1.acg_dt 会计日期
FROM app_ado.adm_subl_cst_bus_inf_dd T1  --客户业务信息汇总表
left join app_ado.FCT_CST_SMY_DD  T2 --客户信息汇总表
ON  T1.cst_id=T2.cst_id
and T2.dt='20240229'
LEFT JOIN edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON   T2.new_com_code = T3.cmnt_enc
and T3.dt='20240229'
LEFT JOIN edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON   T3.afl_org_id = T4.org_id
and T4.dt='20240229'
-- left JOIN app_ado.ADM_HR_ORG_PATH_INF_KH T3  --多维度机构关系信息-考核
-- on T1.brn_org_id=T3.org_id
-- and T3.dt='20240229'
where T1.dt='20240229'
-- and T1.brn_org_nm like '%村镇%'
and T1.lgl_org_id= '999999997'   --村行
-- and T1.cst_id in('7601828980','7005262420')
;



----20240718
DROP TABLE IF EXISTS tmp_cyp_SJ20240709141_20240718 PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240718 AS
SELECT  T1.cst_id 客户号
        ,T1.cst_nm 客户名称
        --    ,T1.lgp_id 法人编号
        --    ,T1.lgl_org_id 总行机构编号
        --    ,T1.lgl_org_nm 总行机构名称
        ,T1.brn_org_id 机构编号
        ,T1.brn_org_nm 机构名称
        ,T2.new_com_code 子社区编号
        ,T2.new_com_name 子社区名称
        ,T4.brc_org_id 社区所属机构编号
        ,T4.brc_org_nm 社区所属机构名称
        ,T2.crt_dt 建档日期
        ,T2.new_com_put_up_date 子社区挂靠时间
        ,T1.ftp_year_pft FTP年累计
        ,T1.ftp_mon_pft FTP月累计
        ,T1.dep_mon_avg_bal 存款月日均
        ,T1.ln_mon_avg_bal 本行贷款当月月日均
        ,T1.vld_cst_ind 有效户标识
        ,T1.vld_ln_cst_ind 有效贷款户标识
        ,T1.acg_dt 会计日期
FROM    app_ado.adm_subl_cst_bus_inf_dd T1 --客户业务信息汇总表
LEFT JOIN    app_ado.FCT_CST_SMY_DD T2 --客户信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.dt = '20240718'
LEFT JOIN    edw.dim_cst_mng_cmnt_inf_dd T3 --社区信息
ON      T2.new_com_code = T3.cmnt_enc
AND     T3.dt = '20240718'
LEFT JOIN    edw.dim_hr_org_mng_org_tree_dd T4 --机构树_考核维度
ON      T3.afl_org_id = T4.org_id
AND     T4.dt = '20240718'
WHERE   T1.dt = '20240718'
AND    T1.lgl_org_id= '999999997'  --村行
;



DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240229_1 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240229_1 as
SELECT
  *
FROM tmp_cyp_SJ20240709141_20240229
WHERE 机构名称 IN ('广东四会泰隆村镇银行','广东英德泰隆村镇银行','河南叶县泰隆村镇银行','河南汝南泰隆村镇银行','浙江庆元泰隆村镇银行','湖北大冶泰隆村镇银行') ;

DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240229_2 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240229_2 as
SELECT
  *
FROM tmp_cyp_SJ20240709141_20240229
WHERE 机构名称 IN ('福建政和泰隆村镇银行','福建福清泰隆村镇银行','福建长乐泰隆村镇银行','福建龙海泰隆村镇银行','陕西旬阳泰隆村镇银行','陕西泾阳泰隆村镇银行','陕西眉县泰隆村镇银行') ;

DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240718_1 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240718_1 as
SELECT
  *
FROM tmp_cyp_SJ20240709141_20240718
WHERE 机构名称 IN ('广东四会泰隆村镇银行','广东英德泰隆村镇银行','河南叶县泰隆村镇银行','河南汝南泰隆村镇银行','浙江庆元泰隆村镇银行','湖北大冶泰隆村镇银行') ;

DROP TABLE if EXISTS tmp_cyp_SJ20240709141_20240718_2 purge;
CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_20240718_2 as
SELECT
  *
FROM tmp_cyp_SJ20240709141_20240718
WHERE 机构名称 IN ('福建政和泰隆村镇银行','福建福清泰隆村镇银行','福建长乐泰隆村镇银行','福建龙海泰隆村镇银行','陕西旬阳泰隆村镇银行','陕西泾阳泰隆村镇银行','陕西眉县泰隆村镇银行') ;




----取社区的汇总数据，结果表1
DROP TABLE IF EXISTS tmp_cyp_SJ20240709141_jingzeng PURGE;

CREATE TABLE IF NOT EXISTS tmp_cyp_SJ20240709141_jingzeng AS
SELECT  A1.机构编号
		,A1.机构名称
        ,A1.子社区编号
        ,A1.子社区名称
        ,COALESCE(A1.FTP年累计, 0) - COALESCE(A2.FTP年累计, 0)                AS FTP年累计净增
        -- ,COALESCE(A1.FTP月累计, 0) - COALESCE(A2.FTP月累计, 0)            AS FTP月累计净增
        ,COALESCE(A1.存款月日均, 0) - COALESCE(A2.存款月日均, 0)               AS 存款月日均净增
        ,COALESCE(A1.本行贷款当月月日均, 0) - COALESCE(A2.本行贷款当月月日均, 0)  AS 本行贷款当月月日均净增
        ,COALESCE(A1.有效户数, 0) - COALESCE(A2.有效户数, 0)                      AS 有效户数净增
        ,COALESCE(A1.有效贷款户标识, 0) - COALESCE(A2.有效贷款户标识, 0)          AS 有效贷款户数净增
FROM    (
            SELECT  T1.机构编号
                    ,T1.机构名称
				    ,T1.子社区编号
		            ,T1.子社区名称
                    ,SUM(T1.FTP年累计)    AS FTP年累计
                    -- ,SUM(T1.FTP月累计)    AS FTP月累计
                    ,SUM(T1.存款月日均)     AS 存款月日均
                    ,SUM(T1.本行贷款当月月日均) AS 本行贷款当月月日均
                    ,SUM(T1.有效户标识)     AS 有效户数
                    ,SUM(T1.有效贷款户标识)   AS 有效贷款户标识
            FROM    tmp_cyp_SJ20240709141_20240718 T1
            GROUP BY T1.子社区编号 , T1.子社区名称 ,T1.机构编号 ,T1.机构名称
        ) A1
LEFT JOIN    (
                 SELECT  T1.机构编号
                         ,T1.机构名称
				         ,T1.子社区编号
		                 ,T1.子社区名称
                         ,SUM(T1.FTP年累计)    AS FTP年累计
                        --  ,SUM(T1.FTP月累计)    AS FTP月累计
                         ,SUM(T1.存款月日均)     AS 存款月日均
                         ,SUM(T1.本行贷款当月月日均) AS 本行贷款当月月日均
                         ,SUM(T1.有效户标识)     AS 有效户数
                         ,SUM(T1.有效贷款户标识)   AS 有效贷款户标识
                 FROM    tmp_cyp_SJ20240709141_20240229 T1
                 GROUP BY T1.子社区编号 , T1.子社区名称,T1.机构编号 ,T1.机构名称
             ) A2
ON      A1.子社区编号 = A2.子社区编号
AND     A1.子社区名称 = A2.子社区名称
AND     A1.机构编号  = A2.机构编号
AND     A1.机构名称  = A2.机构名称
;

--SELECT * FROM tmp_cyp_SJ20240709141_20240718
--
--SELECT  SUM(T1.FTP年累计净增)   AS FTP年累计净增
--        --  ,SUM(T1.FTP月累计)    AS FTP月累计
--        ,SUM(T1.存款月日均净增)   AS 存款月日均净增
--        ,SUM(T1.本行贷款当月月日均净增) AS 本行贷款当月月日均净增
--        ,SUM(T1.有效户数净增)    AS 有效户数净增
--        ,SUM(T1.有效贷款户数净增)  AS 有效贷款户数净增
--FROM    tmp_cyp_SJ20240709141_jingzeng_1 T1
--
--
--
--SELECT  SUM(T1.FTP年累计)     AS FTP年累计
--        --  ,SUM(T1.FTP月累计)    AS FTP月累计
--        ,SUM(T1.存款月日均)     AS 存款月日均
--        ,SUM(T1.本行贷款当月月日均) AS 本行贷款当月月日均
--        ,SUM(T1.有效户标识)     AS 有效户数
--        ,SUM(T1.有效贷款户标识)   AS 有效贷款户标识
--FROM    tmp_cyp_SJ20240709141_20240229 T1



SELECT 14278162832.47-13785572934.72


---取社区不一样的客户明细，结果表2
DROP TABLE IF EXISTS tmp_SJ20240709141_ts PURGE;

CREATE TABLE IF NOT EXISTS tmp_SJ20240709141_ts AS
SELECT t1.客户号
       ,t1.客户名称
       ,t1.机构编号
       ,t1.机构名称
       ,t1.子社区编号  as 子社区编号0718
       ,t1.子社区名称 as 子社区名称0718
       ,T1.社区所属机构编号  as 社区所属机构编号0718
       ,T1.社区所属机构名称   as 社区所属机构名称0718
       ,t2.子社区编号 as 子社区编号0229
       ,t2.子社区名称 as 子社区名称0229
       ,T2.社区所属机构编号  as 社区所属机构编号0229
       ,T2.社区所属机构名称   as 社区所属机构名称0229
       ,t1.建档日期
       ,t1.子社区挂靠时间 as 子社区挂靠时间0718
       ,t2.子社区挂靠时间 as 子社区挂靠时间0229
       ,t1.FTP年累计 as FTP年累计0718
       ,t2.FTP年累计 as FTP年累计0229
       ,t1.存款月日均 as 存款月日均0718
       ,t2.存款月日均 as 存款月日均0229
       ,t1.本行贷款当月月日均 as 本行贷款当月月日均0718
       ,t2.本行贷款当月月日均 as 本行贷款当月月日均0229
       ,t1.有效户标识 as 有效户标识0718
       ,t2.有效户标识 as 有效户标识0229
       ,t1.有效贷款户标识 as 有效贷款户标识0718
       ,t2.有效贷款户标识 as 有效贷款户标识0229
from tmp_cyp_SJ20240709141_20240718 t1
left JOIN tmp_cyp_SJ20240709141_20240229 t2
ON t1.客户号=t2.客户号
where t1.子社区编号 <> t2.子社区编号
;

-- SELECT * from tmp_SJ20240709141_ts
--SELECT * FROM tmp_cyp_SJ20240709141_20240718 WHERE  子社区编号= '0332020903007493'


--SELECT count(1) FROM tmp_cyp_SJ20240709141_20240229

--SELECT * FROM edw.dim_cst_mng_cmnt_inf_dd WHERE DT='20240718' AND cmnt_enc	='0332020903007493'
**01-数据需求_村行_邓凤平_客户全面盘点_新.sql
-- 大冶村行所有客户的相关字段口径，字段内容中已经标记字段的需求时间
-- SJ2024101201




-- 1. 客户基本信息

-- 客户基本信息	客户号	姓名	年龄	子社区	是否主推子社区	本地/异地	同一风险控制号授信金额   	2023年12月同一风险控制号授信金额
-- 2022年12月同一风险控制号授信金额 	客户名下是否存在未到期未终结泰e贷、融e贷、随贷通，并且合同发生时间超过半年且当前未用信（是/否）
-- 客户我行加权利率	他行最高一笔利率	客户名下循环贷款（泰e贷、融e贷、随贷通）授信额度，不含非自助循环长授信、短风控
-- 客户名下循环贷款（泰e贷、融e贷、随贷通）绑定额度，不含非自助循环长授信、短风控	客户及配偶名下是否有随贷通卡	随贷通卡授信额度

--1.1 同一风险控制号授信金额
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_01 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_01 AS
SELECT  T1.DT
        ,T1.cst_id -- 客户号
        ,T1.sam_rsk_ctrl_id -- 同一风险控制号
        ,SUM(T3.ctr_amt) AS 同一风险控制号授信金额
FROM    edw.dws_cst_bas_inf_dd T1 --客户基础信息汇总表
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.sam_rsk_ctrl_id = T2.sam_rsk_ctrl_id
AND     T1.DT = T2.DT
AND     T2.sam_rsk_ctrl_id <> ''
AND     T2.DT IN ( '@@{yyyyMMdd}' , '20231231' , '20221231' )
LEFT JOIN    edw.dim_bus_loan_ctr_bse_inf_dd T3 --合同基础信息
ON      COALESCE(T2.cst_id, T1.cst_id) = T3.cst_id
AND     T1.DT = T3.DT
AND     ( ( T3.CTR_STS_CD IN ( '2' , '4' )
AND     T3.TMT_DT = '18991231'
AND     to_date(T3.CTR_MTU_DT, 'yyyyMMdd') >= to_date(T3.DT, 'yyyyMMdd') )
    OR T3.CTR_BAL > 0 )
AND     T3.DT IN('@@{yyyyMMdd}', '20231231', '20221231')
WHERE   T1.DT IN('@@{yyyyMMdd}', '20231231', '20221231')
GROUP BY T1.DT , T1.cst_id , T1.sam_rsk_ctrl_id;


--1.2 泰e贷、融e贷、随贷通信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_02 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_02 AS
SELECT  A1.cst_id
        ,SUM(A1.ctr_amt * A1.exec_intr_rat * A1.facl_trm) / NULLIF(SUM(A1.ctr_amt * A1.facl_trm), 0) AS 客户级加权利率
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101002' , '2001020101002' ) THEN A1.ctr_amt
               ELSE 0
             END)                                                                                    AS 泰e贷授信额度
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101003' , '2001020101003' ) THEN A1.ctr_amt
               ELSE 0
             END)                                                                                    AS 随贷通授信额度   --2001010101003/2001020101003
        ,SUM(CASE
               WHEN A3.RVLG_PRD_CD = '02' THEN A1.ctr_amt
               ELSE 0
             END)                                                                                    AS 融e贷授信额度
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101002' , '2001020101002' ) THEN A1.strt_use_amt
               ELSE 0
             END)                                                                                    AS 泰e贷启用金额
        ,SUM(CASE
               WHEN A1.prd_no IN ( '2001010101003' , '2001020101003' ) THEN A1.strt_use_amt
               ELSE 0
             END)                                                                                    AS 随贷通启用金额
        ,SUM(CASE
               WHEN A3.RVLG_PRD_CD = '02' THEN A1.strt_use_amt
               ELSE 0
             END)                                                                                    AS 融e贷启用金额
        ,MAX(CASE
               WHEN ( A3.RVLG_PRD_CD = '02' OR A1.prd_no IN ( '2001010101002' , '2001020101002' ) OR A1.prd_no IN ( '2001010101003' , '2001020101003' ) ) AND A1.ctr_bgn_dt >= '@@{yyyyMMdd-6m}' AND A1.ctr_bal = 0 THEN '是'
               ELSE '否'
             END)                                                                                     AS 是否泰_随_融合同发生时间超过半年且当前未用信
FROM    edw.dim_bus_loan_ctr_bse_inf_dd A1 --合同基础信息
LEFT JOIN    edw.dwd_bus_loan_reply_biz_loan_dd A3 --贷款用信
ON      A1.rel_serno = A3.usc_aply_serno
AND     A3.DT = '@@{yyyyMMdd}'
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     ( ( A1.CTR_STS_CD IN ( '2' , '4' )
AND     A1.TMT_DT = '18991231'
AND     to_date(A1.CTR_MTU_DT, 'yyyyMMdd') >= to_date(A1.DT, 'yyyyMMdd') )
    OR A1.CTR_BAL > 0 ) --未结清
GROUP BY A1.cst_id;



--1.3 他行最高一笔利率
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_03 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_03 AS
SELECT  A1.cst_id
        ,SUBSTR(A1.report_id, 1, 8)                                        AS 报告日期
        ,A1.ctr_bal
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     A1.dtrb_org <> 'ZJTLCB'
AND     A1.ctr_bal > 0
UNION ALL
SELECT  A1.cst_id
        ,SUBSTR(A1.report_id, 1, 8)                                        AS 报告日期
        ,A1.loan_bal                                                       AS ctr_bal
        ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.report_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息
WHERE   A1.DT = '@@{yyyyMMdd}'
AND     A1.dtrb_org_typ_cd <> ''
AND     A1.loan_bal > 0;

--1.3.1 利率表账户有空，与贷款信息关联有问题
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_03_11 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_03_11 AS
SELECT  A2.qry_cst_id                                                           AS cst_id
        ,A2.crd_rpt_id                                                          AS crd_rpt_id
        ,CAST(A2.intr_rat AS STRING)                                            AS intr_rat
        ,RANK() OVER ( PARTITION BY A2.qry_cst_id ORDER BY A2.crd_rpt_id DESC ) AS RN
FROM    edw.dim_cst_ccrc_idv_dbt_act_rat_dd A2 --个人征信借贷账户利率计算
WHERE   A2.DT = '@@{yyyyMMdd}'
AND     COALESCE(A2.intr_rat, '') <> ''
AND     A2.intr_rat <> '-9999'
UNION ALL
SELECT  A2.cst_id
        ,A2.rpt_no                                                      AS crd_rpt_id
        ,CAST(A2.mon_intr_rat AS STRING)                                AS intr_rat
        ,RANK() OVER ( PARTITION BY A2.cst_id ORDER BY A2.rpt_no DESC ) AS RN
FROM    edw.dwd_cst_ccrc_entp_dc_act_intr_rat_clc_dd A2 --企业征信借贷账户利率计算
WHERE   A2.DT = '@@{yyyyMMdd}'
AND     COALESCE(A2.mon_intr_rat, '') <> ''
AND     A2.mon_intr_rat <> '-9999';





--SELECT * FROM edw.dim_cst_ccrc_idv_dbt_act_rat_dd WHERE crd_rpt_id='2024101420292208585552' AND DT <='20241108'
--SELECT * FROM  edw.dim_cst_ccrc_idv_loan_inf_dd A1 WHERE cst_id='1672781635' AND DT ='20241108'
--AND     A1.dtrb_org <> 'ZJTLCB'
--AND     A1.ctr_bal > 0
--
--SELECT * FROM tmp_dy_SJ2024101201_03 WHERE cst_id='1672781635' and rn=1

-- 1.4 客户基本信息汇总

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_04 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_04 AS
SELECT DISTINCT  T1.cst_id                                                                     AS 客户号
                ,T1.cst_nm                                                                    AS 姓名
                ,DATEDIFF(TO_DATE(T1.DT, 'YYYYMMDD'), TO_DATE(T3.BTH_DT, 'YYYYMMDD'), 'YYYY') AS 年龄
                ,T2.sub_cmnt_id                                                               AS 子社区编号
                ,T4.comm_sub_community_name                                                   AS 子社区
                ,CASE
                   WHEN T4.developmentype = '主推' THEN '是'
                   ELSE '否'
                 END                                                                          AS 是否主推子社区
                -- ,CASE
                --    WHEN T2.REG_ADR RLIKE '大冶' THEN '本地'
                --    ELSE '异地'
                --  END                                                                          AS 本地_异地
                ,A1.dif_plc_bsn_ind   AS 1本地
                ,T5.同一风险控制号授信金额
                ,T51.同一风险控制号授信金额                                                              AS 2023年12月同一风险控制号授信金额
                ,T51.同一风险控制号授信金额                                                              AS 2022年12月同一风险控制号授信金额
                ,T6.是否泰_随_融合同发生时间超过半年且当前未用信
                ,T6.客户级加权利率
                ,T7.他行最高一笔利率
                ,T6.泰e贷授信额度
                ,T6.随贷通授信额度
                ,T6.融e贷授信额度
                ,T6.泰e贷启用金额
                ,T6.随贷通启用金额
                ,T6.融e贷启用金额
                ,CASE
                   WHEN COALESCE(T6.随贷通授信额度,0) + COALESCE(T9.随贷通授信额度,0) > 0 THEN '是'
                   ELSE '否'
                 END                                                                          AS 客户及配偶名下是否有随贷通卡
                ,COALESCE(T6.随贷通授信额度,0) + COALESCE(T9.随贷通授信额度,0)                                                AS 客户及配偶名下随贷通授信额度
                ,T10.cd_val_dscr                                                              AS 所在行业
FROM    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd T1 --客户主管户信息
LEFT JOIN    edw.dws_cst_bas_inf_dd T2 --客户基础信息汇总表
ON      T1.cst_id = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
left join (SELECT DISTINCT  cst_id ,dif_plc_bsn_ind FROM  edw.dim_bus_loan_ctr_bse_inf_dd WHERE DT ='@@{yyyyMMdd}' ) A1 --合同基础信息
on T1.cst_id=A1.cst_id
LEFT JOIN    edw.dws_cst_idv_bas_inf_dd T3 --个人客户基本信息汇总表
ON      T1.cst_id = T3.cst_id
AND     T3.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.xwdt_etl_xw_com_bi_dt_zsq T4 --社区经营情况明细报表(子社区)(T+2回流)
ON      T2.sub_cmnt_id = T4.comm_sub_community_no
AND     T4.DT = '@@{yyyyMMdd-1d}'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_01 T5 --当前
ON      T1.cst_id = T5.cst_id
AND     T5.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_01 T51 --23年
ON      T1.cst_id = T51.cst_id
AND     T51.DT = '20231231'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_01 T52 --22年
ON      T1.cst_id = T52.cst_id
AND     T52.DT = '20221231'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_02 T6
ON      T1.cst_id = T6.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,MAX(intr_rat) AS 他行最高一笔利率
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_03_11
                 WHERE   RN = 1
                 GROUP BY cst_id
             ) T7
ON      T1.cst_id = T7.cst_id
LEFT JOIN    edw.loan_cst_rel T8 -- 配偶
ON      T1.cst_id = T8.cst_id
AND     T8.rel_typ = '0301'
AND     T8.DT = '@@{yyyyMMdd}'
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_02 T9
ON      T8.rel_cst_id = T9.cst_id
LEFT JOIN    edw.dwd_code_library_dd T10 -- 码值表
ON      T2.idt_cd = T10.cd_val
AND     T10.tbl_nm = 'DWS_CST_BAS_INF_DD'
AND     T10.fld_nm = 'IDT_CD'
AND     T10.DT = '@@{yyyyMMdd}'
WHERE   SUBSTR(T1.prm_org_id, 1, 4) = '4261' --湖北大冶泰隆村镇银行
AND     T1.DT = '@@{yyyyMMdd}'
;




--2.资产负债指标
--总资产	可处置资产	应收账款占比	总负债	我行负债	他行负债	他行负债较上年最后一次查询征信的负债变化	应付账款
-- 资产负债率	可处置资产/负债	流动性资产	流动性负债/流动性资产	经营性负债（除房贷、消费贷、信用卡）	净资产

-- 2.1 客户资产明细
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_05 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_05 AS
SELECT  T1.客户号
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='8'  THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产现金
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='9'  THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产短期投资
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='10' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产长期投资
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='11' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产应收账款
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='12' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产预付账款
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='13' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产存货
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='14' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产生产设备
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='15' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产不动产
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='20' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产活体类
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='19' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产权利类
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='16' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产车辆情况
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='18' THEN T2.slf_ast_amt	  ELSE 0 END)   AS  资产其它资产
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='21' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债民间借贷
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='22' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债金融机构
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='23' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债社会集资
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='24' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债预收
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='25' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债应付
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='26' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  负债其它负债
        ,MAX(CASE WHEN T2.ast_lbl_typ_cd='27' THEN T2.slf_lbl_tot_amt ELSE 0 END)   AS  对外担保
FROM (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN edw.dwd_cst_asst_fnc_stat_cus_ass_lib_dtl_dd T2
ON T1.客户号 = T2.cst_id
AND T2.DT ='@@{yyyyMMdd}'
GROUP BY T1.客户号;


--2.2 客户总资产
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_06 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_06 AS
SELECT  T1.客户号
        ,T2.ast_amt      AS 资产总额
        ,T2.lbl_tot_amt	      AS 负债总额
        ,T2.net_ast	  AS 净资产总额
        ,T3.loan_bal_acs AS 我行负债
FROM   (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
--LEFT JOIN    app_ado.adm_subl_cst_bus_inf_dd T2 --实验室应用层资产-客户业务信息汇总表
--ON      T1.客户号 = T2.cst_id
--AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN edw.dwd_cst_asst_fnc_stat_cus_ass_lib_ovew_dd T2 --信贷客户资产负债概况
ON      T1.客户号 = T2.cst_id
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    adm_pub.adm_csm_cbus_loan_inf_dd T3 --客户集市-业务信息-客户贷款业务信息表
ON      T1.客户号 = T3.cst_id
AND     T3.DT = '@@{yyyyMMdd}'
;




--2.3 客户他行征信负债
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_07 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_07 AS
SELECT  T1.客户号
        ,T2.他行征信负债
        ,T3.他行上一年征信负债
FROM   (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(ctr_bal) AS 他行征信负债
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_03
                 WHERE   RN = 1
				 GROUP BY  cst_id
             ) T2
ON      T1.客户号 = T2.cst_id
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(ctr_bal) AS 他行上一年征信负债
                 FROM    (
                             SELECT  cst_id
                                     ,ctr_bal
                                     ,RANK() OVER ( PARTITION BY A1.cst_id ORDER BY A1.RN ) AS RN
                             FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_03 A1
                             WHERE   A1.报告日期 <= '20231231'
                         ) B1
                 WHERE   B1.RN = 1
		 GROUP BY  cst_id
             ) T3
ON      T1.客户号 = T3.cst_id;

SELECT * FROM tmp_dy_SJ2024101201_07 WHERE 客户号='1672781635';

--2.4 客户资产信息汇总
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_08 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_08 AS
SELECT  T1.客户号
        ,T1.资产现金
        ,T1.资产短期投资
        ,T1.资产长期投资
        ,T1.资产应收账款
        ,T1.资产预付账款
        ,T1.资产存货
        ,T1.资产生产设备
        ,T1.资产不动产
        ,T1.资产活体类
        ,T1.资产权利类
        ,T1.资产车辆情况
        ,T1.资产其它资产
        ,T1.负债民间借贷
        ,T1.负债金融机构
        ,T1.负债社会集资
        ,T1.负债预收
        ,T1.负债应付
        ,T1.负债其它负债
        ,T1.对外担保
        ,T2.资产总额
        ,T2.负债总额
        ,T2.净资产总额
        ,T2.我行负债
        ,T3.他行征信负债
        ,T3.他行上一年征信负债
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_05 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_06 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_07 T3
ON      T1.客户号 = T3.客户号;





-- 3 经营指标 销售收入	收入负债比/销售融资比	销售收入较去年变化幅度	我行近6个月（12个月）存款日均

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_1 AS
SELECT  cst_id
        ,bgn_dt                                                              AS 开始日期
        ,end_dt                                                              AS 结束日期
        ,sal_amt                                                             AS 销售额
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY last_upd_tm DESC ) AS RN
FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd
WHERE   DT = '@@{yyyyMMdd}';

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09_2 AS
SELECT  cst_id
        ,bgn_dt                                                              AS 开始日期
        ,end_dt                                                              AS 结束日期
        ,sal_amt                                                             AS 销售额
        ,ROW_NUMBER() OVER ( PARTITION BY cst_id ORDER BY last_upd_tm DESC ) AS RN
FROM    edw.dim_cst_asst_fin_opr_sal_amt_and_npft_dd
WHERE   DT = '20231231';

-- 3.1 年销售额 ,我行近6个月（12个月）存款日均
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_09 AS
SELECT  T1.客户号
        ,T2.开始日期
        ,T2.结束日期
        ,T2.销售额
        ,T6.开始日期 AS 开始日期_上年末
        ,T6.结束日期 AS 结束日期_上年末
        ,T6.销售额  AS 销售额_上年末
        ,T7.我行近6个月存款日均
        ,T7.我行近12个月存款日均
FROM   (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_09_1 T2 --
ON      T1.客户号 = T2.cst_id
AND     T2.RN = 1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_09_2 T6 -- 上年末
ON      T1.客户号 = T6.cst_id
AND     T6.RN = 1
LEFT JOIN    (
                 SELECT  cst_id
                         ,SUM(last_90_days_gl_bal_acml) / 90   AS 我行近6个月存款日均
                         ,SUM(last_360_days_gl_bal_acml) / 360 AS 我行近12个月存款日均
                 FROM    edw.dws_bus_dep_act_inf_dd --存款账户信息汇总
                 WHERE   DT = '@@{yyyyMMdd}'
                 GROUP BY cst_id
             ) T7
ON      T1.客户号 = T7.cst_id;





-- 4. 风险综合指标	风险等级	征信评分	上年最后一次查询征信评分（连续下降）	模型分	相对位置	是否隐患客户
-- 最近一次的预评估结果	预评估不通过的触发规则	最近一次的精准贷后结果（只选取近9个月的）	最近一次精准贷后触发的规则	最近一年触发精准贷后的次数

--4.1  征信评分	上年最后一次查询征信评分 是否隐患客户
--当前征信评分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_1 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_1 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '@@{yyyyMMdd}'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;


--上年最后一次查询征信评分
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_2 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_2 AS
SELECT  *
        ,row_number() OVER ( PARTITION BY cst_id  ORDER BY qry_tm DESC ) rk
FROM    (
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cr_sco_val                                 AS 中证评分
                                ,rpt_id
                                ,REPLACE(substring(qry_tm, 1, 10), '-', '') AS qry_tm
                                ,REPLACE(substring(qry_tm, 1, 7), '-', '')  AS qry_month
                                ,'单'                                        AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(qry_tm, 1, 7) ORDER BY qry_tm DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_qry_rcd_di --评分查询记录 --按日的查询1万多 与ncip_credit_rating_query_record 一致。
                        WHERE   dt <= '20231231'
                        AND     cr_sco_val IS NOT NULL
                    ) t
            WHERE   rk = 1
            UNION ALL
            SELECT  `(rk)?+.+`
            FROM    (
                        SELECT  cst_id
                                ,cst_nm
                                ,cst_cr_grd_val                  AS 中证评分
                                ,concat_ws(&quot;,&quot;, cst_id, file_nm) AS rpt_id
                                ,prd_dt                          AS qry_tm
                                ,substring(prd_dt, 1, 6)         AS qry_month
                                ,'批'                             AS typ
                                ,row_number() OVER ( PARTITION BY cst_id , substring(prd_dt, 1, 6) ORDER BY prd_dt DESC ) rk -- 取当月最新一条,去重
                        FROM    edw.dwd_cst_ccrc_idv_scor_btch_anlz_rslt_di -- 中征信评分批量解析结果表 ，按月查询dt不固定，每个dt150万以上
                        WHERE   dt <= '20231231'
                        AND     cst_cr_grd_val IS NOT NULL
                    ) t
            WHERE   rk = 1
        ) t;

DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_10 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_10 AS
SELECT  T1.客户号
        ,T2.中证评分 AS 征信评分
        ,T3.中证评分 AS 上年征信评分
        ,CASE
           WHEN T4.rsk_hidden_cst_ind = 1 THEN '是'
           ELSE '否'
         END     AS 是否风险隐患客户
        ,T5.风险等级
		,T5.模型分
		,T5.相对位置
FROM    (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_1 T2 --个人征信指标信息表
ON      T1.客户号 = T2.cst_id
AND     T2.rk = 1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_2 T3 --个人征信指标信息表
ON      T1.客户号 = T3.cst_id
AND     T3.rk = 1
LEFT JOIN    adm_pub.adm_csm_crisk_bas_crisk_lab_inf_dd T4 --客户集市-风险信息-基础风险标签信息
ON      T1.客户号 = T4.cst_id
AND     T4.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,CASE
                            WHEN A1.rsk_lyr_cd = '1' THEN '低风险'
                            WHEN A1.rsk_lyr_cd = '5' THEN '高风险'
                            WHEN A1.rsk_lyr_cd = '2' THEN '中低风险'
                            WHEN A1.rsk_lyr_cd = '3' THEN '中风险'
                            WHEN A1.rsk_lyr_cd = '4' THEN '中高风险'
                          END                                                                          AS 风险等级
						 ,A1.modl_grd                  AS 模型分
						 ,A1.pct                       AS 相对位置
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.rsk_lyr_afm_tm DESC ) AS RN
                 FROM    edw.dim_cst_asst_rsk_lyr_dd A1
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.rsk_lyr_cd <> ''
             ) T5
ON      T1.客户号 = T5.cst_id
AND     T5.RN = 1;


--4.2.1 精准贷后明细信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_11 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_11 AS
SELECT  T1.cst_id      AS 客户号
        ,T2.tsk_gen_dt AS 精准贷后风险触发时间
        ,CASE
           WHEN T2.pst_loan_chk_tsk_typ_cd = '01' THEN '处置1级'
           WHEN T2.pst_loan_chk_tsk_typ_cd = '02' THEN '处置2级'
           WHEN T2.pst_loan_chk_tsk_typ_cd = '03' THEN '预警类'
           WHEN T2.pst_loan_chk_tsk_typ_cd = '04' THEN '提示类'
         END           AS 精准贷后触发类型
		,T3.触发规则分类
        ,T3.触发规则
		,T3.触发原因分析
FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表
INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息
ON      T1.btch_serno = T2.btch_serno
AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码
AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03' , '04' ) --01	处置1级, 02	处置2级, 03	预警类, 04	提示类
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    (
                 SELECT  A1.btch_serno
                         ,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)                                AS 触发规则分类
						 ,A1.rul_nm               AS 触发规则
						 ,A1.trg_rsn_anls         AS 触发原因分析
                         ,A1.rul_ctg_nm --规则分类名称
                         ,A1.rul_sub_clss_nm --规则细类名称
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN
                 FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细
                 WHERE   A1.DT = '@@{yyyyMMdd}'
             ) T3
ON      T1.btch_serno = T3.btch_serno
AND     T3.RN = 1
WHERE   T1.DT = '@@{yyyyMMdd}';


--4.2 精准贷后信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_12 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_12 AS
SELECT  T1.客户号
        ,T2.精准贷后风险触发时间 AS 近9个月内_最近一次精准贷后风险触发时间
        ,T2.精准贷后触发类型     AS 近9个月内_最近一次精准贷后触发类型
		,T2.触发规则分类         AS 近9个月内_最近一次触发规则分类
        ,T2.触发规则             AS 近9个月内_最近一次触发规则
		,T2.触发原因分析         AS 近9个月内_最近一次触发原因分析
        ,T3.最近一年触发精准贷后的次数
FROM    (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN    (
                 SELECT  A1.客户号
                         ,A1.精准贷后风险触发时间
                         ,A1.精准贷后触发类型
                         ,A1.触发规则
						 ,A1.触发原因分析
						 ,A1.触发规则分类
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.客户号 ORDER BY A1.精准贷后风险触发时间 DESC ) AS RN --倒序
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_11 A1
                 WHERE   A1.精准贷后风险触发时间 >= '@@{yyyyMMdd-9m}'  --近9个月
             ) T2
ON      T1.客户号 = T2.客户号
AND     T2.RN = 1
LEFT JOIN    (
                 SELECT  A1.客户号
                         ,COUNT(1) AS 最近一年触发精准贷后的次数
                 FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_11 A1
                 WHERE   A1.精准贷后风险触发时间 >= '@@{yyyyMMdd-1y}' --近一年
                 GROUP BY A1.客户号
             ) T3
ON      T1.客户号 = T3.客户号;





--4.3 预评估信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_13 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_13 AS
SELECT  A1.客户号
        ,A2.最近一次预评估结果
        ,A2.最近一次预评估时间
        ,A2.预评估触发规则
		,A2.预评估提示信息
FROM   (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) A1
LEFT JOIN    (
                 SELECT  T1.aplc_no                                                                          AS 客户号
                         ,T2.cd_val_dscr                                                                     AS 最近一次预评估结果
                         ,T1.gen_tm                                                                          AS 最近一次预评估时间
                         ,T3.预评估触发规则
						 ,T3.预评估提示信息
                         ,ROW_NUMBER() OVER ( PARTITION BY T1.aplc_no ORDER BY T1.pre_ases_rslt_serno DESC ) AS RN
                 FROM    edw.dim_bus_loan_pre_ases_rslt_inf_dd T1 --预评估结果信息
                 LEFT JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系
                 ON      T1.pre_ases_rslt_serno = T0.rul_set_rslt_serno
                 AND     T0.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表
                 ON      T0.rul_set_rslt_cd = T2.cd_val
                 AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'
                 AND     T2.fld_nm = 'RUL_SET_RSLT_CD'
                 AND     T2.DT = '@@{yyyyMMdd}'
                 LEFT JOIN    (
                                  SELECT  B1.rul_set_rslt_serno
                                         ,WM_CONCAT('||',B1.rul_nm) AS 预评估触发规则
									     ,WM_CONCAT('||',B1.prmpt_msg) AS 预评估提示信息
                                  FROM    edw.dwd_bus_loan_pre_ases_rul_dtl_dd B1 --预评估规则明细
                                  WHERE   B1.DT = '@@{yyyyMMdd}'
                                  GROUP BY B1.rul_set_rslt_serno
                              ) T3
                 ON      T0.rul_set_rslt_serno = T3.rul_set_rslt_serno
                 WHERE   T1.DT = '@@{yyyyMMdd}'
             ) A2
ON      A1.客户号 = A2.客户号
AND     A2.RN = 1;


-- 4.5 风险综合指标合并
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_14 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_14 AS
SELECT  T1.客户号
        ,T1.风险等级
		,T1.模型分
        ,T1.相对位置
        ,T1.征信评分
        ,T1.上年征信评分
        ,T1.是否风险隐患客户
		,T2.近9个月内_最近一次精准贷后风险触发时间
		,T2.近9个月内_最近一次精准贷后触发类型
		,T2.近9个月内_最近一次触发规则分类
		,T2.近9个月内_最近一次触发规则
		,T2.近9个月内_最近一次触发原因分析
        ,T2.最近一年触发精准贷后的次数
        ,T3.最近一次预评估结果
        ,T3.最近一次预评估时间
        ,T3.预评估触发规则
		,T3.预评估提示信息
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_10 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_12 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_13 T3
ON      T1.客户号 = T3.客户号;



-- 5.征信指标
-- 征信报告日期	授信总额（信用总额）	授信余额（信用总余额）	有信用业务的银行数	现有贷款授信银行数	现有信用卡授信银行数
-- 最近6个查询内审批查询机构数	最近6个查询非银内审批查询机构数	除房贷外当前有余额的贷款机构数	非银行机构授信余额	他行经营性贷款授信机构数
-- 对外担保金额	信用卡透支率	查询次数	当前逾期总额	贷款当前逾期总额	贷款当前最大逾期期数	贷记卡逾期账户数	呆账笔数
-- 呆账余额	保证人代偿笔数	保证人代偿余额	贷款五级分类为非正常的余额	贷款五级分类为非正常的笔数	非正常贷款对外担保笔数


-- 5.1 征信指标信息
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_15 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_15 AS
SELECT  T1.客户号
        ,COALESCE(T2.report_dt, T3.report_dt)                            AS 征信报告日期
        ,COALESCE(T2.cred_total_amt, T3.cred_total_amt)                  AS 授信总额_信用总额
        ,COALESCE(T2.cred_total_balan, T3.cred_total_balan)              AS 授信余额_信用总余额
        ,COALESCE(T2.cred_biz_bank_num, T3.unsett_cred_busi_org_num)     AS 有信用业务的银行数
        ,COALESCE(T2.curr_loan_bank_num, T3.un_sett_loan_rzbank_num)     AS 现有贷款授信银行数
        ,T2.curr_cred_bank_num                                           AS 现有信用卡授信银行数
        ,T2.rem_house_loan_unsett_org_num                                AS 除房贷外当前有余额的贷款机构数
        ,T2.loan_fyg_num_amt                                             AS 非银行机构授信余额
        ,T2.othr_bnk_mngmt_loan_org_num                                  AS 他行经营性贷款授信机构数
        ,COALESCE(T2.guar_contr_amt, T3.guar_contr_amt)                  AS 对外担保金额
        ,T2.c_cred_card_use_frequ                                        AS 信用卡透支率
        ,T2.c_od_amt                                                     AS 当前逾期总额
        ,T2.c_od_total_amt                                               AS 贷款当前逾期总额
        ,T2.c_od_max_num                                                 AS 贷款当前最大逾期期数
        ,T2.djk_od_acct_num                                              AS 贷记卡逾期账户数
        ,T2.dz_acct_num                                                  AS 呆账笔数
        ,T2.dz_acct_balan                                                AS 呆账余额
        ,COALESCE(T2.gu_comp_num, T3.guan_comp_num)                      AS 保证人代偿笔数
        ,COALESCE(T2.gu_comp_balan, T3.guan_comp_balan)                  AS 保证人代偿余额
        ,COALESCE(T2.un_normal_loan_balan, T3.un_normal_loan_balan)      AS 贷款五级分类为非正常的余额
        ,COALESCE(T2.un_normal_loan_num, T3.un_normal_loan_num)          AS 贷款五级分类为非正常的笔数
        ,COALESCE(T2.curr_bad_extguan_loan_num, T3.unnm_loan_guar_count) AS 非正常贷款对外担保笔数
FROM    (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN    edw.dws_cst_ccrc_idv_ind_inf_dd T2 --个人征信指标信息表
ON      T1.客户号 = T2.cst_id
AND     T2.report_dsc_rn = 1
AND     T2.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.dws_cst_ccrc_entp_ind_inf_dd T3 --企业征信指标信息表
ON      T1.客户号 = T3.cst_id
AND     T3.report_dsc_rn = 1
AND     T3.DT = '@@{yyyyMMdd}';



-- 5.2 征信查询信息
-- qry_rsn_cd	 = '02' --贷款审批  A1.qry_org_typ NOT IN ('11','12','14','15') --非银机构
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_16 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_16 AS
SELECT  A1.qry_cst_id AS 客户号
        ,COUNT(1)     AS 查询次数
        ,SUM(CASE
               WHEN CAST(A1.qry_dt AS STRING) <> '' AND A1.qry_rsn_cd = '02' AND DATEDIFF(TO_DATE(SUBSTR(A1.rpt_id, 1, 8), 'YYYYMMDD'), TO_DATE(SUBSTR(CAST(A1.qry_dt AS STRING), 1, 8), 'YYYYMMDD'), 'MM') <= 6 THEN 1
               ELSE 0
             END)     AS 近6个月审批查询机构数
        ,SUM(CASE
               WHEN CAST(A1.qry_dt AS STRING) <> '' AND A1.qry_rsn_cd = '02' AND A1.qry_org_typ NOT IN ( '11' , '12' , '14' , '15' ) AND DATEDIFF(TO_DATE(SUBSTR(A1.rpt_id, 1, 8), 'YYYYMMDD'), TO_DATE(SUBSTR(CAST(A1.qry_dt AS STRING), 1, 8), 'YYYYMMDD'), 'MM') <= 6 THEN 1
               ELSE 0
             END)     AS 近6个月非银机构审批查询机构数
FROM    edw.dwd_cst_ccrc_ipcr_qry_rcd_di A1 --人行征信报告查询记录明细
INNER JOIN    (
                  SELECT  qry_cst_id
                          ,MAX(rpt_id) AS rpt_id
                  FROM    edw.dwd_cst_ccrc_ipcr_qry_rcd_di --人行征信报告查询记录明细
                  WHERE   DT <= '@@{yyyyMMdd}'
                  GROUP BY qry_cst_id
              ) A2
ON      A1.rpt_id = A2.rpt_id
AND     A1.qry_cst_id = A2.qry_cst_id
WHERE   A1.DT <= '@@{yyyyMMdd}'
GROUP BY A1.qry_cst_id;



-- 5.征信指标
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_17 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_17 AS
SELECT  T1.客户号
        ,T1.征信报告日期
        ,T1.授信总额_信用总额
        ,T1.授信余额_信用总余额
        ,T1.有信用业务的银行数
        ,T1.现有贷款授信银行数
        ,T1.现有信用卡授信银行数
        ,T1.除房贷外当前有余额的贷款机构数
        ,T1.非银行机构授信余额
        ,T1.他行经营性贷款授信机构数
        ,T1.对外担保金额
        ,T1.信用卡透支率
        ,T1.当前逾期总额
        ,T1.贷款当前逾期总额
        ,T1.贷款当前最大逾期期数
        ,T1.贷记卡逾期账户数
        ,T1.呆账笔数
        ,T1.呆账余额
        ,T1.保证人代偿笔数
        ,T1.保证人代偿余额
        ,T1.贷款五级分类为非正常的余额
        ,T1.贷款五级分类为非正常的笔数
        ,T1.非正常贷款对外担保笔数
        ,T2.查询次数
        ,T2.近6个月审批查询机构数
        ,T2.近6个月非银机构审批查询机构数
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_15 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_16 T2
ON      T1.客户号 = T2.客户号;



--6 新加 最近一次的现场走访时间
-- DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 PURGE;

-- CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 AS
-- SELECT  T1.客户号
        -- ,T2.create_tm AS 最近一次的现场走访时间
-- FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
-- LEFT JOIN    (
                 -- SELECT  A1.cst_id
                         -- ,A1.create_tm
                         -- ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.create_tm DESC ) AS RN
                 -- FROM    edw.xwdt_xw_cst_vst_dtl_di A1
                 -- WHERE   A1.DT = '@@{yyyyMMdd}'
                 -- AND     A1.srv_type = '01' -- 服务类型（01-拜访 02-接待）
                 -- AND     A1.srv_cntnt NOT RLIKE '电访|短信|电话'
             -- ) T2
-- ON      T1.客户号 = T2.cst_id
-- AND     T2.RN = 1;


-- 04	侧面打听（现场）
-- 01	现场（实地）
-- 02	云调查
-- 03	非现场
-- 05	侧面打听（非现场）
-- 06	侧面打听（批量）


DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_18 AS
SELECT  T1.客户号
        ,T2.svy_dt AS 最近一次的现场走访时间
FROM   (SELECT DISTINCT 客户号 FROM  lab_bigdata_dev.tmp_dy_SJ2024101201_04) T1
LEFT JOIN    (
                 SELECT  A1.cst_id
                         ,A1.svy_dt
                         ,ROW_NUMBER() OVER ( PARTITION BY A1.cst_id ORDER BY A1.svy_dt DESC ) AS RN
                 FROM    edw.dwd_bus_loan_cst_svy_rcd_dd A1
                 WHERE   A1.DT = '@@{yyyyMMdd}'
                 AND     A1.svy_mod_cd IN ( '01' , '04' ) --现场（实地）、侧面打听（现场）
             ) T2
ON      T1.客户号 = T2.cst_id
AND     T2.RN = 1;



-----------------------------------------------------------------------------
-----------------------------------------------------------------------------
-- 结果表
DROP TABLE IF EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_JGB PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.tmp_dy_SJ2024101201_JGB AS
SELECT
   --基本信息
   T1.客户号
   ,T1.姓名
   ,T1.年龄
   ,T1.子社区编号
   ,T1.子社区
   ,T1.是否主推子社区
   ,T1.1本地
   ,T1.同一风险控制号授信金额
   ,T1.2023年12月同一风险控制号授信金额
   ,T1.2022年12月同一风险控制号授信金额
   ,T1.是否泰_随_融合同发生时间超过半年且当前未用信
   ,T1.客户级加权利率
   ,T1.他行最高一笔利率
   ,T1.泰e贷授信额度
   ,T1.随贷通授信额度
   ,T1.融e贷授信额度
   ,T1.泰e贷启用金额
   ,T1.随贷通启用金额
   ,T1.融e贷启用金额
   ,T1.客户及配偶名下是否有随贷通卡
   ,T1.客户及配偶名下随贷通授信额度
   ,T1.所在行业
   --资产负债指标
   ,T2.资产现金
   ,T2.资产短期投资
   ,T2.资产长期投资
   ,T2.资产应收账款
   ,T2.资产预付账款
   ,T2.资产存货
   ,T2.资产生产设备
   ,T2.资产不动产
   ,T2.资产活体类
   ,T2.资产权利类
   ,T2.资产车辆情况
   ,T2.资产其它资产
   ,T2.负债民间借贷
   ,T2.负债金融机构
   ,T2.负债社会集资
   ,T2.负债预收
   ,T2.负债应付
   ,T2.负债其它负债
   ,T2.对外担保
   ,T2.资产总额
   ,T2.负债总额
   ,T2.净资产总额
   ,T2.我行负债
   ,T2.他行征信负债
   ,T2.他行上一年征信负债
   --经营指标
   ,T3.开始日期
   ,T3.结束日期
   ,T3.销售额
   ,T3.开始日期_上年末
   ,T3.结束日期_上年末
   ,T3.销售额_上年末
   ,T3.我行近6个月存款日均
   ,T3.我行近12个月存款日均
   --风险综合指标
   ,T4.风险等级
   ,T4.模型分
   ,T4.相对位置
   ,T4.征信评分
   ,T4.上年征信评分
   ,T4.是否风险隐患客户
   ,T4.近9个月内_最近一次精准贷后风险触发时间
   ,T4.近9个月内_最近一次精准贷后触发类型
   ,T4.近9个月内_最近一次触发规则分类
   ,T4.近9个月内_最近一次触发规则
   ,T4.近9个月内_最近一次触发原因分析
   ,T4.最近一年触发精准贷后的次数
   ,T4.最近一次预评估结果
   ,T4.最近一次预评估时间
   ,T4.预评估触发规则
   ,T4.预评估提示信息
   --征信指标
   ,T5.征信报告日期
   ,T5.授信总额_信用总额
   ,T5.授信余额_信用总余额
   ,T5.有信用业务的银行数
   ,T5.现有贷款授信银行数
   ,T5.现有信用卡授信银行数
   ,T5.除房贷外当前有余额的贷款机构数
   ,T5.非银行机构授信余额
   ,T5.他行经营性贷款授信机构数
   ,T5.对外担保金额
   ,T5.信用卡透支率
   ,T5.当前逾期总额
   ,T5.贷款当前逾期总额
   ,T5.贷款当前最大逾期期数
   ,T5.贷记卡逾期账户数
   ,T5.呆账笔数
   ,T5.呆账余额
   ,T5.保证人代偿笔数
   ,T5.保证人代偿余额
   ,T5.贷款五级分类为非正常的余额
   ,T5.贷款五级分类为非正常的笔数
   ,T5.非正常贷款对外担保笔数
   ,T5.查询次数
   ,T5.近6个月审批查询机构数
   ,T5.近6个月非银机构审批查询机构数
   ,T6.最近一次的现场走访时间
FROM    lab_bigdata_dev.tmp_dy_SJ2024101201_04 T1
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_08 T2
ON      T1.客户号 = T2.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_09 T3
ON      T1.客户号 = T3.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_14 T4
ON      T1.客户号 = T4.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_17 T5
ON      T1.客户号 = T5.客户号
LEFT JOIN    lab_bigdata_dev.tmp_dy_SJ2024101201_18 T6
ON      T1.客户号 = T6.客户号;
**01-数据需求_非金_D0514_史云_用于泰隆生活平台代运营商和行内与商户结算费用使用.sql
--用途：用于泰隆生活平台代运营商和行内与商户结算费用使用
--结算日期为2024年4月2日-2024年5月6日的所有已经完成和商户结算的交易
--订单号，店铺名称，支付方式，结算申请时间，商户实际结算金额，商户手续费分账金额 - 微信开票，平台手续费分账金额 - 微信开票卡券平台出资 - 给泰隆开票，
--实际行方活动补贴 - 给泰隆开票，实际积分支付  - 给泰隆开票，详情见附件表格需求描述


DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024051431 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024051431 AS
SELECT  t1.o_id                                                       --AS 订单号
        ,t1.order_id                                                  --AS 订单ID
        ,t2.store_name                                                --AS 店铺名称
        ,t2.payment_id                             --支付方式ID
        ,t2.payment_name                                              --AS 支付方式
        ,t1.apply_time                                                --AS 结算申请时间
        ,t1.complete_time                                             --AS 结算完成时间
        ,t1.reality_sa_amt_sh                                         --AS 商户实际结算金额
        ,t1.cmmssn_share_sh - t1.return_cmmssn_share_sh               AS col1 --商户手续费分账金额_微信开票
        ,t1.cmmssn_share_pt - t1.return_cmmssn_share_pt               AS col2 --平台手续费分账金额_微信开票
        ,t1.total_plat_share_total - t1.return_total_plat_share_total AS col3 --卡券平台出资_给泰隆开票
        ,t1.reality_hf_bt_amount                                      --AS 实际行方活动补贴
        ,t1.integral_all                                              --AS 实际积分支付
FROM    edw.tlsc_sunyardmall_payoff_log t1   --系统结算账单管理表
INNER JOIN    edw.tlsc_sunyardmall_orderform t2   --订单表
ON      t1.order_id = t2.order_id  --订单编号关联
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.payment_id IN ( '31' , '34' )   --支付方式
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.tenant_code = 'tlcard'     --多租户标识，泰隆商城
AND     t1.complete_time BETWEEN '2024-04-02 00:00:00' AND '2024-05-06 23:59:59'
;


---结果表：


DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024051431_end PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024051431_end AS
SELECT  t1.o_id                                       AS 订单号
        ,t1.order_id                                  AS 订单ID
        ,t1.store_name                                AS 店铺名称
        ,t1.payment_name                              AS 支付方式
        ,t1.apply_time                                AS 结算申请时间
        ,t1.complete_time                             AS 结算完成时间
        ,t1.reality_sa_amt_sh                         AS 商户实际结算金额
        ,t1.col1                                      AS 商户手续费分账金额_微信开票
        ,t1.col2                                      AS 平台手续费分账金额_微信开票
        ,t1.col3                                      AS 卡券平台出资_给泰隆开票
        ,t1.reality_hf_bt_amount                      AS 实际行方活动补贴_给泰隆开票
        ,t1.integral_all - NVL(t2.th_integral_all, 0) AS 实际积分支付_给泰隆开票
FROM    lab_bigdata_dev.sjxq_SJ2024051431 t1
LEFT JOIN    (
                 SELECT  return_order_id
                         ,sum(integral_all) AS th_integral_all
                 FROM    edw.tlsc_sunyardmall_returngoods_log  --退货商品日志表,用来记录所有退货操作
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     goods_return_status IN ( '11' , '13' )
                 GROUP BY return_order_id
             ) t2
ON      t1.o_id = t2.return_order_id
;


--SELECT * from  lab_bigdata_dev.sjxq_SJ2024051431_end
**01-数据需求_非金_SJ2024060626_史云_用于泰隆生活平台代运营商和行内与商户结算费用使用_copy.sql
--用途：用于泰隆生活平台代运营商和行内与商户结算费用使用

--2024年5月1日-2024年6月3日的所有已经完成和商户结算的交易
--订单号，店铺名称，支付方式，结算申请时间，商户实际结算金额，商户手续费分账金额 - 微信开票，平台手续费分账金额 - 微信开票卡券平台出资 - 给泰隆开票，
--实际行方活动补贴 - 给泰隆开票，实际积分支付  - 给泰隆开票，详情见附件表格需求描述


DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024060626 PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024060626 AS
SELECT  t1.o_id                                                       --AS 订单号
        ,t1.order_id                                                  --AS 订单ID
        ,t2.store_name                                                --AS 店铺名称
        ,t2.payment_id                             --支付方式ID
        ,t2.payment_name                                              --AS 支付方式
        ,t1.apply_time                                                --AS 结算申请时间
        ,t1.complete_time                                             --AS 结算完成时间
        ,t1.reality_sa_amt_sh                                         --AS 商户实际结算金额
        ,t1.cmmssn_share_sh - t1.return_cmmssn_share_sh               AS col1 --商户手续费分账金额_微信开票
        ,t1.cmmssn_share_pt - t1.return_cmmssn_share_pt               AS col2 --平台手续费分账金额_微信开票
        ,t1.total_plat_share_total - t1.return_total_plat_share_total AS col3 --卡券平台出资_给泰隆开票
        ,t1.reality_hf_bt_amount                                      --AS 实际行方活动补贴
        ,t1.integral_all                                              --AS 实际积分支付
FROM    edw.tlsc_sunyardmall_payoff_log t1   --系统结算账单管理表
INNER JOIN    edw.tlsc_sunyardmall_orderform t2   --订单表
ON      t1.order_id = t2.order_id  --订单编号关联
AND     t2.dt = '@@{yyyyMMdd}'
AND     t2.payment_id IN ( '31' , '34' )   --支付方式
WHERE   t1.dt = '@@{yyyyMMdd}'
AND     t1.tenant_code = 'tlcard'     --多租户标识，泰隆商城
AND     t1.complete_time BETWEEN '2024-05-01 00:00:00' AND '2024-06-03 23:59:59'
;


---结果表：


DROP TABLE IF EXISTS lab_bigdata_dev.sjxq_SJ2024060626_end PURGE;

CREATE TABLE IF NOT EXISTS lab_bigdata_dev.sjxq_SJ2024060626_end AS
SELECT  t1.o_id                                       AS 订单号
        ,t1.order_id                                  AS 订单ID
        ,t1.store_name                                AS 店铺名称
        ,t1.payment_name                              AS 支付方式
        ,t1.apply_time                                AS 结算申请时间
        ,t1.complete_time                             AS 结算完成时间
        ,t1.reality_sa_amt_sh                         AS 商户实际结算金额
        ,t1.col1                                      AS 商户手续费分账金额_微信开票
        ,t1.col2                                      AS 平台手续费分账金额_微信开票
        ,t1.col3                                      AS 卡券平台出资_给泰隆开票
        ,t1.reality_hf_bt_amount                      AS 实际行方活动补贴_给泰隆开票
        ,t1.integral_all - NVL(t2.th_integral_all, 0) AS 实际积分支付_给泰隆开票
FROM    lab_bigdata_dev.sjxq_SJ2024060626 t1
LEFT JOIN    (
                 SELECT  return_order_id
                         ,sum(integral_all) AS th_integral_all
                 FROM    edw.tlsc_sunyardmall_returngoods_log  --退货商品日志表,用来记录所有退货操作
                 WHERE   dt = '@@{yyyyMMdd}'
                 AND     goods_return_status IN ( '11' , '13' )
                 GROUP BY return_order_id
             ) t2
ON      t1.o_id = t2.return_order_id
;


-- SELECT * from  lab_bigdata_dev.sjxq_SJ2024060626_end
**01-数据需求_非金_SJ2024101226_史云_综合积分过期失效数据分析.sql
-- SJ2024101226
-- 到期积分兑换or失效比例：
时间、   机构号、机构名称、到期积分价值、其中：2021.12.31后发放的到期积分价值、到期已兑换积分价值	到期复活积分价值	失效积分价值

2022-1	到分行即可	ex：	到期日是22年1月的积分价值（即按发放积分时填写的到期日期在22年1月的积分都计入）	到期日是22年1月、发放时间是2022.01.01（含）之后的积分价值	到期日是22年1月的积分中，截止目前已经兑换的部分	到期日是22年1月的积分中，截止目前复活的部分	到期日是22年1月的积分中，截止目前失效的部分


-- 积分复活的话是流水表交易类型代码：9999，积分过期是：1999
-- edw.sirs_transtype t2 --积分交易类型表

SELECT  t3.belongbranch 成本分摊机构
        -- ,t3.transtypeno 交易类型
        ,count(DISTINCT t1.sourcetransno) 流水条目数
        ,count(DISTINCT t1.customersid) 客户数
        -- ,substr(t1.enddate, 1, 4) 过期年份
        ,substr(t3.transdate, 1, 4) 发放年份
        ,substr(t2.transdate, 1, 4) 过期年份
        ,substr(t1.createtime, 1, 4) 失效年份
        ,sum(t1.pointsamount) / 100 积分价值
FROM    edw.sirs_expiredrebirthminutes t1  --待复活积分过期表
LEFT JOIN    edw.sirs_pointstransminutes t2  --积分帐户详细记录表
ON      t1.sourcetransno = t2.transno
AND     t2.dt >= '20230101'
AND     t2.pointstypeno = '0001' --综合积分
JOIN    edw.sirs_pointstransminutes t3
ON      t2.sourcetransno = t3.transno
AND     t3.dt >= '20220101' --2022年以后发放的积分纳入统计
WHERE   t1.dt >= '20240101'
GROUP BY t3.belongbranch , substr(t1.createtime, 1, 4) , substr(t3.transdate, 1, 4) , substr(t2.transdate, 1, 4)
**02-排汰_排汰信贷表验收.sql
--app_ado.ADM_CST_VIEW_FOR_TELLER_IDV  --360视图-对私客户视图-基本信息
--app_ado.FCT_ADO_OUTD_HNHMD_DTL  --外部数据-黑名单分类
--app_ado.FCT_ADO_IDV_CST_REL_INF  --人企探查-行内客户关联企业


-- app_ado.imp_t_app_log_new   --泰隆数据app访问日志表


SELECT *
from app_ado.ADM_CST_VIEW_FOR_TELLER_IDV WHERE dt='20240531' LIMIT 1000;

SELECT *
from app_ado.FCT_ADO_OUTD_HNHMD_DTL WHERE dt='20240531' LIMIT 1000;


SELECT *
from app_ado.FCT_ADO_IDV_CST_REL_INF WHERE dt='20240501' LIMIT 1000;
**02-排汰_排汰数据探索.sql
--app_ado.ADM_CST_VIEW_FOR_TELLER_IDV  --360视图-对私客户视图-基本信息
--app_ado.FCT_ADO_OUTD_HNHMD_DTL  --外部数据-黑名单分类
--app_ado.FCT_ADO_IDV_CST_REL_INF  --人企探查-行内客户关联企业


SELECT *
from app_ado.ADM_CST_VIEW_FOR_TELLER_IDV WHERE dt='20240531' LIMIT 1000;

SELECT count(*)
from app_ado.FCT_ADO_OUTD_HNHMD_DTL WHERE dt='20240531' LIMIT 1000;


SELECT *
from app_ado.FCT_ADO_IDV_CST_REL_INF WHERE dt='20240501' LIMIT 1000;

SELECT t.cst_id,t.cst_act_id,t.dep_act_id,t.act_nm,t.cur_act_bal,t.opn_dt,t.last_day_prvs_intr FROM edw.dws_bus_dep_act_inf_dd t WHERE t.dt='20240708' and t.cst_act_id='6214808801033372836';

SELECT t.cst_id,t.cst_act_id,t.dep_act_id,t.act_nm,t.cur_act_bal,t.opn_dt,t.last_day_prvs_intr FROM edw.dws_bus_dep_act_inf_dd t WHERE t.dt='20240708' and t.cst_act_id='6214808801010331045';


SELECT substr(p.dt,1,6),sum(p.trx_amt) FROM edw.dwd_bus_dep_bal_chg_dtl_di p
WHERE substr(p.dt,1,6) in ('202401','202402','202403','202404','202405')
and p.cst_act_id='6214808801033372836'
and crd_and_dbt_ind='C'
GROUP BY p.dt
;

SELECT p.cst_act_id,p.dep_act_id,p.trx_dt,p.trx_tm,p.crd_and_dbt_ind,p.trx_amt,p.act_bal,p.cnt_pty_cst_act_id,cnt_pty_act_nm FROM edw.dwd_bus_dep_bal_chg_dtl_di p WHERE p.dt<='20240708' and p.dt>='20240701' and p.cst_act_id='6214808801010331045'


-- 贷(C)
-- 借(D)
**02-排汰_排汰监测表.sql
SELECT  A.QUERY_ID                      AS 查询编号
        ,A.DOC_ID                       AS 证件号
        ,A.CST_NM                       AS 客户名称
        ,C.QUERY_FILE_NAME              AS 文件名称
        ,A.QUERY_DATE                   AS 上传日期
        ,C.QUERY_USER                   AS 查询人工号
        ,D.EMPE_NM                      AS 查询人名称
        ,D.ORG_ID                       AS 查询人机构号
        ,E.ORG_NM                       AS 查询人机构名称
        ,'777777777'                    AS GRP_ORG_ID --集团
        ,COALESCE(F.ORG_ID_R, '')       AS LGL_ORG_ID --总行机构编号
        ,COALESCE(F.ORG_NM_R, '')       AS LGL_ORG_NM --总行机构名称
        ,COALESCE(F.ORG_ID_F, '')       AS BRN_ORG_ID --分行机构编号
        ,COALESCE(F.ORG_NM_F, '')       AS BRN_ORG_NM --分行机构名称
        ,COALESCE(F.ORG_ID_Z, '')       AS SUB_BRN_ORG_ID --支行机构编号
        ,COALESCE(F.ORG_NM_Z, '')       AS SUB_BRN_ORG_NM --支行机构名称
        ,C.CST_COUNT                    AS 客户数量
        ,COALESCE(B.ENT_RSK_SUM_CNT, 0) AS 风险信号数
        ,CASE
           WHEN B.ENT_RISK_LVL = '1' THEN '重点提示'
           WHEN B.ENT_RISK_LVL = '2' THEN '一般提示'
           ELSE '未命中'
         END                            AS 风险提示类型
        ,CASE
           WHEN B.ENT_JYYC_CNT > 0 THEN '是'
           ELSE '否'
         END                            AS 是否命中经营异常
        ,CASE
           WHEN B.ENT_TL_BLACK_CNT > 0 THEN '是'
           ELSE '否'
         END                            AS 是否命中黑名单
FROM    app_ado.FCT_ADO_CUSTOMER_INFO a  --大数据排汰-客户名单表
LEFT JOIN    app_ado.FCT_ADO_OUTD_ENT_TAG_INF B   ---企业客户排汰标签表
ON      B.DT = '@@{yyyyMMdd}'
AND     B.CSLD_CRD_CD = A.DOC_ID
LEFT JOIN    app_ado.fct_ado_upload_customer_record C  --客户查询
ON      C.QUERY_ID = A.QUERY_ID
AND     C.DT = '@@{yyyyMMdd}'
LEFT JOIN    edw.DWS_HR_EMPE_INF_DD D  --员工汇总信息
ON      D.DT = '@@{yyyyMMdd}'
AND     D.EMPE_ID = C.QUERY_USER
LEFT JOIN    edw.DIM_HR_ORG_BAS_INF_DD E  --机构基本信息
ON      E.DT = '@@{yyyyMMdd}'
AND     E.ORG_ID = D.ORG_ID
LEFT JOIN    app_ado.FCT_ORG_PATH_INF F  --数据集-机构信息表
ON      F.ORG_ID = D.ORG_ID
AND     F.ORG_RLTN_DIM_CD = 'WD1'
AND     F.DT = '@@{yyyyMMdd}'
WHERE   A.DT = '@@{yyyyMMdd}'
**02-排汰_核验.sql
DROP TABLE IF EXISTS ${odps_app_ado}.FCT_ADO_OUTD_HNHMD_DTL;
CREATE TABLE IF NOT EXISTS ${odps_app_ado}.FCT_ADO_OUTD_HNHMD_DTL
(
    ACG_DT    STRING COMMENT '数据日期'
    ,CST_ID   STRING COMMENT '客户号'
    ,CST_NM   STRING COMMENT '客户姓名'
    ,CST_TYP  STRING COMMENT '客户类型'
    ,DOC_ID   STRING COMMENT '证件号'
    ,JOIN_DT  STRING COMMENT '加入日期'
    ,JOIN_REN STRING COMMENT '加入原因'
    ,IF_WDW   STRING COMMENT '是否撤销'
    ,WDW_DT   STRING COMMENT '撤销日期'
    ,IND_TYP  STRING COMMENT '客户类别(JZ:禁止TS:提示CZ:重组)'
)
COMMENT
'外部数据-黑名单分类'
PARTITIONED BY
(
    DT STRING COMMENT '日期分区'
);

DROP TABLE IF EXISTS ${odps_app_ado}.TMP_FCT_ADO_OUTD_HNHMD_DTL_01;

CREATE TABLE IF NOT EXISTS ${odps_app_ado}.TMP_FCT_ADO_OUTD_HNHMD_DTL_01
(
    CST_ID    STRING  COMMENT '客户号'
    ,JOIN_DT  STRING  COMMENT '加入日期'
    ,JOIN_REN STRING  COMMENT '加入原因'
    ,WDW_DT   STRING  COMMENT '撤销日期'
    ,IND_TYP  STRING  COMMENT '客户类别(JZ:禁止TS:提示CZ:重组)'
    ,RN       DECIMAL COMMENT ''
);

INSERT INTO ${odps_app_ado}.TMP_FCT_ADO_OUTD_HNHMD_DTL_01
SELECT  CST_ID
        ,CONCAT_WS('-', SUBSTR(INPT_DT, 1, 4), SUBSTR(INPT_DT, 5, 2), SUBSTR(INPT_DT, 7, 2)) AS JOIN_DT --输入日期
        ,INC_THE_REA                                                                         AS JOIN_REN --列入原因
        ,REPLACE(WDW_TM, '/', '-')                                                           AS WDW_DT --撤销时间
        ,CASE
           WHEN SET_PRPT_2 = '50' THEN 'JZ'
           ELSE 'TS'
         END                                                                                 AS IND_TYP
        ,ROW_NUMBER() OVER ( PARTITION BY CST_ID , SET_PRPT_2 ORDER BY UPD_DT DESC )         AS RN
FROM    ${odps_edw}.DWD_BUS_LOAN_SPC_APT_CST_DD
WHERE   DT = '@@{yyyyMMdd}'
AND     TD_CST_TYP = '40' --问题客户
AND     STS_IND = '2' --未撤销 黑名单有效
AND     SET_PRPT_2 IN ( '50' , '60' ) --风险等级:50禁止,60提示
AND     COALESCE(CST_ID, '') <> ''
UNION ALL
SELECT  CST_ID
        ,CONCAT_WS('-', SUBSTR(APNT_START_DT, 1, 4), SUBSTR(APNT_START_DT, 5, 2), SUBSTR(APNT_START_DT, 7, 2)) AS JOIN_DT --开始日期                                                          AS JOIN_DT
        ,'贷款'                                                                                                  AS JOIN_REN --列入原因
        ,''                                                                                                    AS WDW_DT --撤销日期
        ,'CZ'                                                                                                  AS IND_TYP --客户类别(JZ:禁止TS:提示CZ:重组)
        ,ROW_NUMBER() OVER ( PARTITION BY CST_ID ORDER BY APNT_START_DT DESC )                                 AS RN
FROM    ${odps_edw}.DIM_BUS_LOAN_CTR_INF_DD
WHERE   DT = '@@{yyyyMMdd}'
AND     BUS_CD = 'J';

--删除当日数据
ALTER TABLE ${odps_app_ado}.FCT_ADO_OUTD_HNHMD_DTL DROP IF EXISTS PARTITION ( DT = '@@{yyyyMMdd}' );

--插入当日数据
INSERT INTO ${odps_app_ado}.FCT_ADO_OUTD_HNHMD_DTL PARTITION (DT = '@@{yyyyMMdd}')
SELECT  '@@{yyyy-MM-dd}'
        ,A.CST_ID
        ,A.CST_CHN_NM
        ,A.CST_TYP_CD
        ,A.DOC_NBR
        ,REPLACE(COALESCE(TRIM(B.JOIN_DT), ''), '\\N', '')  AS JOIN_DT --加入日期
        ,REPLACE(COALESCE(TRIM(B.JOIN_REN), ''), '\\N', '') AS JOIN_REN --加入原因
        ,CASE
           WHEN REPLACE(COALESCE(TRIM(B.WDW_DT), ''), '\\N', '') <> '' THEN '是'
           ELSE '否'
         END                                                AS IF_WDW --是否撤销
        ,REPLACE(COALESCE(TRIM(B.WDW_DT), ''), '\\N', '')   AS WDW_DT --撤销日期
        ,REPLACE(COALESCE(TRIM(B.IND_TYP), ''), '\\N', '')  AS IND_TYP --客户类别(JZ:禁止TS:提示CZ:重组)
FROM    ${odps_edw}.DWS_CST_BAS_INF_DD A
INNER JOIN    TMP_FCT_ADO_OUTD_HNHMD_DTL_01 B
ON      B.CST_ID = A.CST_ID
AND     B.RN = 1
WHERE   A.DT = '@@{yyyyMMdd}';


SELECT cst_id,rel_rel_cd 关系关系代码
 FROM edw.dwd_cst_rel_inf_dd WHERE dt='20231231' AND cst_id in ('1029116055',
'1035609417',
'1016350741',
'1029046091',
'1005105941',
'1031490044',
'1029741578',
'1608701044',
'1039349645',
'1026303144',
'1030452007',
'1003153818',
'1018461128',
'1030935151'
);

select t.cst_id,t.inpt_dt,concat(t.INC_THE_REA,'%'),t.WDW_TM FROM edw.dwd_bus_loan_spc_apt_cst_dd t WHERE dt='20231231' and cst_id in ('2002202895',
'2000389503',
'1000187130',
'1000220838',
'1000224763',
'1003242675',
'1004500297',
'1004980916'
);

select * from edw.DIM_CST_ASST_CRD_CST_OPR_BAS_SITU_DD p
where dt='20231231'
and  cst_id in ('1017020308',
'1012483791',
'1610498507',
'1012808925',
'1015111653',
'1709340352',
'1613005940',
'1011064012',
'1012412591',
'1011616640',
'1697569320',
'1021183358',
'1013175406',
'1012364755',
'1036402479',
'1015290800',
'1016254179');

SELECT  *
FROM  edw.dwd_code_library_dd WHERE dt='@@{yyyyMMdd}'
and tbl_nm=TOUPPER('DWD_CST_REL_INF_DD')
and fld_nm=TOUPPER('rel_rel_cd')
**tmp.sql
--截止2022年12月31、2023年12月31日期，温州分行150万以内个体经营性贷款清单

-- 个人客户，持有个人经营性贷款或用途为经营的随贷通卡（截至2023.12.31业务未到期），客户总授信&le;150万，剔除村行（代码参考附件）
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_01 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_01 AS
SELECT  t.cst_id
        ,sum(t.ctr_amt * t1.avg_prc / t1.quo_unt) AS sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd         t          --信贷合同
INNER JOIN    edw.dim_bus_com_exr_inf_dd    t1 --汇率信息表
ON      t.ccy_cd = t1.ccy_cd --币种代码
AND     t1.dt = '20221231'
WHERE   t.dt = '20221231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08' OR t.pd_cd <> '201050101040335' )  --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319'                            --剔除 百度分期贷
AND (t.pd_cd NOT IN ('201050102010146','201050101040348') OR t.frz_sts_cd<>'') --剔除未签约的泰e贷
AND
(
    (
        (t.ctr_bal > 0 OR (t.ctr_bal IS NULL AND nvl(t.crc_ind,'0')='0')      --非循环贷款有余额,非循环贷款标识：0，融e贷：1，随e贷：2
        OR ((nvl(t.crc_ind, '0') <> '0' OR t.pd_cd LIKE '2010503%')          --循环贷/随贷通余额为0,且未到期
            AND (t.ctr_bal = 0 OR t.ctr_bal IS NULL)
            AND t.apnt_mtu_dt >= '20221231')       --约定到期日
        )
        AND nvl(t.frz_sts_cd,' ') NOT IN ( '3' , '4' )   --未到期，未终止
    ) OR (t.ctr_bal > 0 AND t.pd_cd LIKE '2010503%' AND t.apnt_mtu_dt <= '20221231' AND t.frz_sts_cd IN ( '3' , '4' ))   --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
) ----未终结、未到期业务
AND NOT EXISTS (
    SELECT  'x'
    FROM    edw.dim_bus_loan_ctr_inf_dd t2
    WHERE   t.busi_ctr_id = t2.busi_ctr_id
    AND     t2.dt = '20221231'
    AND     t2.pd_cd LIKE '2010503%'
    AND     t2.apnt_start_dt > t2.dt
) --剔除提前续卡随贷通
GROUP BY t.cst_id
;

DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_02 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_02 AS
SELECT  DISTINCT T.BUSI_CTR_ID
    ,T.CST_ID,t.cst_nm
    ,t3.brc_org_nm,t3.SBR_ORG_NM,t3.ORG_NM
    ,t4.sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd t
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t2
ON      t.cst_id = t2.cst_id
AND     t2.dt = '20221231'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20221231'
AND     t3.brc_org_nm ='温州分行'
INNER JOIN SJXQ_SJ2024030776_CST_01     t4
ON      t.cst_id = t4.cst_id
AND     t4.sum_ctr_amt <= 1500000
WHERE   t.dt = '20221231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08'
    OR t.pd_cd <> '201050101040335' ) --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332' --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319' --剔除百度分期贷
AND     ( t.pd_cd NOT IN ( '201050102010146' , '201050101040348' )
    OR t.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( ( ( t.ctr_bal > 0
    OR ( t.ctr_bal IS NULL
AND     nvl(t.crc_ind, '0') = '0' )
    OR ( ( nvl(t.crc_ind, '0') <> '0'
    OR t.pd_cd LIKE '2010503%' )
AND     ( t.ctr_bal = 0
    OR t.ctr_bal IS NULL )
AND     t.apnt_mtu_dt >= '20221231' ) )
AND     nvl(t.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
    OR ( t.ctr_bal > 0
AND     t.pd_cd LIKE '2010503%'
AND     t.apnt_mtu_dt <= '20221231'
AND     t.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
AND     t.pd_cd NOT LIKE '2010402%'
AND     ( t.pd_cd LIKE '201050102%'
    OR ( t.pd_cd LIKE '2010503%'
AND     t.loan_usg_cd LIKE '01%' ) ) ---个人一般经营性贷款、经营用途随贷通
;

DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_03 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_03 AS
SELECT  t.cst_id
        ,sum(t.ctr_amt * t1.avg_prc / t1.quo_unt) AS sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd         t
INNER JOIN    edw.dim_bus_com_exr_inf_dd    t1 --汇率信息表
ON      t.ccy_cd = t1.ccy_cd --币种代码
AND     t1.dt = '20231231'
WHERE   t.dt = '20231231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08' OR t.pd_cd <> '201050101040335' )  --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319'                            --剔除 百度分期贷
AND (t.pd_cd NOT IN ('201050102010146','201050101040348') OR t.frz_sts_cd<>'') --剔除未签约的泰e贷
AND
(
    (
        (t.ctr_bal > 0 OR (t.ctr_bal IS NULL AND nvl(t.crc_ind,'0')='0')
        OR ((nvl(t.crc_ind, '0') <> '0' OR t.pd_cd LIKE '2010503%')
            AND (t.ctr_bal = 0 OR t.ctr_bal IS NULL)
            AND t.apnt_mtu_dt >= '20231231')
        )
        AND nvl(t.frz_sts_cd,' ') NOT IN ( '3' , '4' )
    ) OR (t.ctr_bal > 0 AND t.pd_cd LIKE '2010503%' AND t.apnt_mtu_dt <= '20231231' AND t.frz_sts_cd IN ( '3' , '4' ))
) ----未终结、未到期业务
AND NOT EXISTS (
    SELECT  'x'
    FROM    edw.dim_bus_loan_ctr_inf_dd t2
    WHERE   t.busi_ctr_id = t2.busi_ctr_id
    AND     t2.dt = '20231231'
    AND     t2.pd_cd LIKE '2010503%'
    AND     t2.apnt_start_dt > t2.dt
) --剔除提前续卡随贷通
GROUP BY t.cst_id
;

DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_04 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_04 AS
SELECT  DISTINCT T.BUSI_CTR_ID
    ,T.CST_ID,t.cst_nm
    ,t3.brc_org_nm,t3.SBR_ORG_NM,t3.ORG_NM
    ,t4.sum_ctr_amt
FROM    edw.dim_bus_loan_ctr_inf_dd t
LEFT JOIN    adm_pub_app.adm_pblc_cst_prm_mng_inf_dd t2
ON      t.cst_id = t2.cst_id
AND     t2.dt = '20231231'
INNER JOIN    edw.dim_hr_org_mng_org_tree_dd t3
ON      t2.prm_org_id = t3.org_id
AND     t3.dt = '20231231'
AND     t3.brc_org_nm ='温州分行'
INNER JOIN SJXQ_SJ2024030776_CST_01     t4
ON      t.cst_id = t4.cst_id
AND     t4.sum_ctr_amt <= 1500000
WHERE   t.dt = '20231231'
AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' ) --剔除 员工贷款
AND     ( t.chnl_cd <> 'L08'
    OR t.pd_cd <> '201050101040335' ) --剔除 小鱼分期
AND     t.pd_cd <> '201050101040332' --剔除 蚂蚁借呗
AND     t.pd_cd <> '201050101040319' --剔除百度分期贷
AND     ( t.pd_cd NOT IN ( '201050102010146' , '201050101040348' )
    OR t.frz_sts_cd <> '' ) --剔除未签约的泰e贷
AND     ( ( ( t.ctr_bal > 0
    OR ( t.ctr_bal IS NULL
AND     nvl(t.crc_ind, '0') = '0' )
    OR ( ( nvl(t.crc_ind, '0') <> '0'
    OR t.pd_cd LIKE '2010503%' )
AND     ( t.ctr_bal = 0
    OR t.ctr_bal IS NULL )
AND     t.apnt_mtu_dt >= '20231231' ) )
AND     nvl(t.frz_sts_cd, ' ') NOT IN ( '3' , '4' ) )
    OR ( t.ctr_bal > 0
AND     t.pd_cd LIKE '2010503%'
AND     t.apnt_mtu_dt <= '20231231'
AND     t.frz_sts_cd IN ( '3' , '4' ) ) ) ----未终结、未到期业务
AND     t.pd_cd NOT LIKE '2010402%'
AND     ( t.pd_cd LIKE '201050102%'
    OR ( t.pd_cd LIKE '2010503%'
AND     t.loan_usg_cd LIKE '01%' ) ) ---个人一般经营性贷款、经营用途随贷通
;


--字段汇总
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_05 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_05 AS
SElECT '20221231' data_dt,t1.*
    ,t2.frs_crd_dt	        --首次授信日期
    ,t3.efe_loan_cst_ind	--有效信贷户标识
from SJXQ_SJ2024030776_CST_02                   t1
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd  t2 --客户集市-业务信息-贷款-授信与额度
on  t1.cst_id=t2.cst_id
and t2.dt = '20221231'
left join adm_pub.adm_csm_cbas_ind_inf_dd	    t3 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id=t3.cst_id
and t3.dt = '20221231'
union all
SElECT '20231231' data_dt,t1.*
    ,t2.frs_crd_dt	        --首次授信日期
    ,t3.efe_loan_cst_ind	--有效信贷户标识
from SJXQ_SJ2024030776_CST_04                   t1
left join adm_pub.adm_csm_cbus_loan_crd_inf_dd  t2 --客户集市-业务信息-贷款-授信与额度
on  t1.cst_id=t2.cst_id
and t2.dt = '20231231'
left join adm_pub.adm_csm_cbas_ind_inf_dd	    t3 --客户集市-基础信息-客户基础标识信息
on  t1.cst_id=t3.cst_id
and t3.dt = '20231231'
;

--输出结果
DROP   TABLE IF     EXISTS SJXQ_SJ2024030776_CST_06 purge;
CREATE TABLE IF NOT EXISTS SJXQ_SJ2024030776_CST_06 AS
select data_dt          日期
    ,brc_org_nm 		管户分行
    ,sbr_org_nm         管户支行
    ,cst_id             客户号
    ,cst_nm             客户名称
    ,frs_crd_dt         首次授信时间
    ,efe_loan_cst_ind   是否有效信贷户
    ,busi_ctr_id        合同号
    ,sum_ctr_amt        合同金额
    ,org_nm             管户机构名称
from SJXQ_SJ2024030776_CST_05
;

SElECT '01' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_01
union all
SElECT '02' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_02
union all
SElECT '03' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_03
union all
SElECT '04' seq, count(1) cnt, count(distinct cst_id) custs
from SJXQ_SJ2024030776_CST_04
union all
SElECT '05' seq, count(1) cnt, count(distinct data_dt,cst_id) custs
from SJXQ_SJ2024030776_CST_05
union all
SElECT '06' seq, count(1) cnt, count(distinct 日期,客户号) custs
from SJXQ_SJ2024030776_CST_06
;

/*
01	745933	745933
02	18747	14130
03	776077	776077
04	15774	12183
05	34521	26313
06	34521	26313
*/



SELECT * from edw.dwd_code_library_dd t
WHERE t.dt='20240319'
and t.tbl_nm=upper('dim_bus_loan_ctr_inf_dd')
and t.fld_nm=TOUPPER('loan_usg_cd')
;

SELECT t.cst_id,t.pd_cd,t.itm_cd FROM edw.dws_bus_fin_ftp_act_smy_inf_dd t WHERE dt='20240201' LIMIT 100

SELECT p.act_itm_id,p.act_itm_nm FROM edw.dim_bus_act_itm_dd p WHERE dt='@@{yyyyMMdd}'
;

SELECT * FROM edw.dim_bus_com_exr_inf_dd t WHERE dt='@@{yyyyMMdd}'
**常用操作.sql
-- 【常用操作】：
-- **********************是否入模查询*****************************
-- select   src_guid ODS表
--         ,dst_guid   对应的模型层表
-- from edw.DIM_BUS_COM_TBL_DEP_INF f1
-- where replace(f1.src_guid,'	odps.','') = lower('edw.core_kcgb_sfdjbu')  --将&ldquo;edw.frzh_hl_black_list&rdquo;替换为待查的完整ODS表名
--   and (split_part(f1.dst_guid,'.',3) like 'dim%' or split_part(f1.dst_guid,'.',3) like 'dwd%' or split_part(f1.dst_guid,'.',3) like 'dws%')
--   and split_part(f1.dst_guid,'.',2) = 'edw'
-- **********************不删除表新增字段*****************************
-- alter table LAB_BIGDATA_DEV.DIM_CMPN_PNT_TRX_TYP_INF_DD add COLUMNS ( TRX_TYP_CD STRING COMMENT '交易类型编号')
-- **********************逗号空格处理*****************************
-- 替换数据中的逗号和回车，防止导出时excel错行：
-- REGEXP_REPLACE( REPLACE(t3.description, ',', '|'),'\\s','|')
-- **********************左右空格处理*****************************
-- trim(字段)
-- **********************正则匹配*****************************
-- T.id  regexp ','
-- **********************多行合并成一行去重*****************************
-- concat_ws(';', COLLECT_SET(a.一季度落实情况)) AS 一季度落实情况
-- **********************获取最大分区*****************************
-- where dt=max_pt('LAB_BIGDATA_DEV.HGL_ORG_TAG_IND_DD')
-- **********************批量追历史数据*****************************
-- insert OVERWRITE TABLE  xxx PARTITION (dt )  select 的最后一个字段要是dt
-- **********************分母为0处理*****************************
-- NULLIF() --当为0时置空，除空为空
-- --oracle两表之间用逗号连接为inner join
-- **********************连续排序数据相同时序号一致*****************************
-- DENSE_RANK() OVER ( PARTITION BY cst_id ORDER BY report_id DESC ) RN
-- *****************排序编序号***************
-- ROW_NUMBER() OVER(PARTITION BY P4.cr_crd_act_id ORDER BY P4.dt) RNO
-- ,ROW_NUMBER() OVER() RNO   --序号不重复排序
-- DENSE_RANK() over(order by ceshi) rn   --相同值序号重复排序
-- **********************手机号脱敏*****************************
-- concat(substr(T11.mbl_nbr,1,3) ,'****',substr(T11.mbl_nbr,8,4)) as 手机号码_tm
-- **********************数据累加*****************************
-- sum(ziduan) over()  --累加该字段
-- **********************普通折币*****************************
-- t2.ctr_bal * T3.cny_exr  as 合同余额_折人民币
-- LEFT JOIN    edw.dim_bus_com_exr_inf_dd T3 --汇率信息
-- ON      t2.ccy_cd = T3.ccy_cd
-- AND     T3.dt = '20221231'
-- ***********************监管集市折币*****************************
-- LEFT JOIN SMTMODS.L_PUBL_RATE U
--           ON A.CURR_CD = U.BASIC_CCY
--          AND U.DATA_DATE = I_DATADATE
--          AND U.FORWARD_CCY = 'CNY'
-- **********************营销标签*****************************
-- select a.busi_ctr_id
--        ,a.bus_lab_cd
--        ,WM_CONCAT('|', COALESCE(b.itemname)) AS bus_lab
-- from
-- (
--     select busi_ctr_id
--           ,bus_lab_cd
--           ,bus_lab_cd2
-- from   edw.dim_bus_loan_ctr_inf_dd LATERAL VIEW explode(split(bus_lab_cd, ',')) bus_lab_cd AS bus_lab_cd2
-- where  dt = '@@{yyyyMMdd}'
-- and    bus_lab_cd is not null
-- and    bus_lab_cd <> ''
-- ) a
-- left join edw.loan_business_productflag b  on a.bus_lab_cd2 = b.serialno and b.dt = '@@{yyyyMMdd}'
-- group by a.busi_ctr_id
--         ,a.bus_lab_cd
-- ****************受托支付*****************************
--    from   edw.dim_bus_loan_ctr_inf_dd a   -----信贷合同信息
--    left join edw.dwd_bus_loan_fdc_pay_obj_inf_dd  b ----受托支付对象信息
--    on  a.busi_ctr_id = b.obj_id and b.obj_typ = 'BusinessContract' and b.dt = '20220331'
-- *****************星期几***************
--    ,case when weekday (to_date(dt,'yyyymmdd'))=0 then '星期一'
--              when weekday (to_date(dt,'yyyymmdd'))=1 then '星期二'
--              when weekday (to_date(dt,'yyyymmdd'))=2 then '星期三'
--              when weekday (to_date(dt,'yyyymmdd'))=3 then '星期四'
--              when weekday (to_date(dt,'yyyymmdd'))=4 then '星期五'
--              when weekday (to_date(dt,'yyyymmdd'))=5 then '星期六'
--              when weekday (to_date(dt,'yyyymmdd'))=6 then '星期日'
--       end 星期几
-- *****************行业分类***************
-- ,SUBSTR(C.IDT_DIR_DTL, 1, 1)                  AS 一级行业代码
-- ,SUBSTR(C.IDT_DIR_DTL, 1, 3)                  AS 二级行业代码
-- ,SUBSTR(C.IDT_DIR_DTL, 1, 4)                  AS 三级行业代码
-- *****************机构***************
-- 3101	上海分行
-- 3202	苏州分行
-- 3301	台州分行
-- 3302	杭州分行
-- 3303	宁波分行
-- 3305	温州分行
-- 3306	丽水分行
-- 3307	绍兴分行
-- 3308	金华分行
-- 3309	嘉兴分行
-- 3310	湖州分行
-- 3311	衢州分行
-- 3312	舟山分行
-- 3361	浙江庆元泰隆村镇银行
-- 3561	福建政和泰隆村镇银行
-- 3562	福建长乐泰隆村镇银行
-- 3563	福建龙海泰隆村镇银行
-- 3564	福建福清泰隆村镇银行
-- 4161	河南叶县泰隆村镇银行
-- 4162	河南汝南泰隆村镇银行
-- 4261	湖北大冶泰隆村镇银行
-- 4461	广东英德泰隆村镇银行
-- 4462	广东四会泰隆村镇银行
-- 6161	陕西旬阳泰隆村镇银行
-- 6162	陕西眉县泰隆村镇银行
-- 6163	陕西泾阳泰隆村镇银行

--****************未终结，未到期，非循环贷有余额，随贷通也是贷款****************
-- AND     t.bus_cd NOT IN ( 'A' , 'B' , 'H' , 'I' , 'O' , 'P' )   --剔除 员工贷款
-- AND     ( t.chnl_cd <> 'L08' OR t.pd_cd <> '201050101040335' )  --剔除 小鱼分期
-- AND     t.pd_cd <> '201050101040332'                            --剔除 蚂蚁借呗
-- AND     t.pd_cd <> '201050101040319'                            --剔除 百度分期贷
-- AND (t.pd_cd NOT IN ('201050102010146','201050101040348') OR t.frz_sts_cd<>'') --剔除未签约的泰e贷
-- AND
-- (
--     (
--         (t.ctr_bal > 0 OR (t.ctr_bal IS NULL AND nvl(t.crc_ind,'0')='0')      --非循环贷款有余额,非循环贷款标识：0，融e贷：1，随e贷：2
--         OR ((nvl(t.crc_ind, '0') <> '0' OR t.pd_cd LIKE '2010503%')          --循环贷/随贷通余额为0,且未到期
--             AND (t.ctr_bal = 0 OR t.ctr_bal IS NULL)
--             AND t.apnt_mtu_dt >= '20221231')       --约定到期日
--         )
--         AND nvl(t.frz_sts_cd,' ') NOT IN ( '3' , '4' )   --未到期，未终止
--     ) OR (t.ctr_bal > 0 AND t.pd_cd LIKE '2010503%' AND t.apnt_mtu_dt <= '20221231' AND t.frz_sts_cd IN ( '3' , '4' ))   --余额>0  且 随贷通 且到期 且 冻结状态是到期失效、终止失效
-- ) ----未终结、未到期业务
-- AND NOT EXISTS (
--     SELECT  'x'
--     FROM    edw.dim_bus_loan_ctr_inf_dd t2
--     WHERE   t.busi_ctr_id = t2.busi_ctr_id
--     AND     t2.dt = '20221231'
--     AND     t2.pd_cd LIKE '2010503%'
--     AND     t2.apnt_start_dt > t2.dt
-- ) --剔除提前续卡随贷通
-- GROUP BY t.cst_id
-- ;
**通用代码_s1.sql
--************************地址省市区县***************************************

SELECT  A1.cst_id

        ,A1.dtl_addr

        ,A1.addr_typ

        ,A4.cd_val_dscr AS 省

        ,A3.cd_val_dscr AS 市

        ,A2.cd_val_dscr AS 区

FROM    edw.loan_cst_ctc_addr A1

LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表  区

ON      SUBSTR(A1.adiv, 1, 6) = A2.cd_val

AND     A2.tbl_nm = 'TB_STA_COMMUNICATION'

AND     A2.fld_nm = 'C_HOME_ADDRESS_A'

AND     A2.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd A3 -- 码值表   市

ON      RPAD(SUBSTR(A1.adiv, 1, 4), 6, '0') = A3.cd_val

AND     A3.tbl_nm = 'TB_STA_COMMUNICATION'

AND     A3.fld_nm = 'C_HOME_ADDRESS_A'

AND     A3.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd A4 -- 码值表  省

ON      RPAD(SUBSTR(A1.adiv, 1, 2), 6, '0') = A4.cd_val

AND     A4.tbl_nm = 'TB_STA_COMMUNICATION'

AND     A4.fld_nm = 'C_HOME_ADDRESS_A'

AND     A4.DT = '@@{yyyyMMdd}'

WHERE   A1.del_ind = '0'

AND     A1.DT = '@@{yyyyMMdd}'

AND     A1.addr_typ IN ( '050100' , '050200' , '050900' );





--***************行业分类*********************************



SELECT  T0.cst_id        AS 客户号

        ,T0.cst_nm       AS 企业名称

        ,T0.IDT_CTG_CD   AS 行业分类代码

        ,T31.cd_val_dscr AS 一级行业分类

        ,T32.cd_val_dscr AS 二级行业分类

        ,T33.cd_val_dscr AS 三级行业分类

        ,T3.cd_val_dscr  AS 四级行业分类

        ,CASE

           WHEN T0.ENTP_SIZ_CD = '2' THEN '大型企业'

           WHEN T0.ENTP_SIZ_CD = '5' THEN '微型企业'

           WHEN T0.ENTP_SIZ_CD = '9' THEN '其他'

           WHEN T0.ENTP_SIZ_CD = '3' THEN '中型企业'

           WHEN T0.ENTP_SIZ_CD = '4' THEN '小型企业'

         END             AS 企业规模

FROM    edw.dim_cst_entp_bas_inf_dd T0 --企业客户基本信息

LEFT JOIN    edw.dwd_code_library_dd T3 -- 码值表

ON      T0.IDT_CTG_CD = T3.cd_val

AND     T3.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'

AND     T3.fld_nm = 'IDT_CTG_CD'

AND     T3.DT = '20240719'

LEFT JOIN    edw.dwd_code_library_dd T31 -- 码值表

ON      SUBSTR(T0.IDT_CTG_CD, 1, 1) = T31.cd_val

AND     T31.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'

AND     T31.fld_nm = 'IDT_CTG_CD'

AND     T31.DT = '20240719'

LEFT JOIN    edw.dwd_code_library_dd T32 -- 码值表

ON      SUBSTR(T0.IDT_CTG_CD, 1, 3) = T32.cd_val

AND     T32.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'

AND     T32.fld_nm = 'IDT_CTG_CD'

AND     T32.DT = '20240719'

LEFT JOIN    edw.dwd_code_library_dd T33 -- 码值表

ON      SUBSTR(T0.IDT_CTG_CD, 1, 4) = T33.cd_val

AND     T33.tbl_nm = 'DIM_CST_ENTP_BAS_INF_DD'

AND     T33.fld_nm = 'IDT_CTG_CD'









--*************************联系电话************************





 SELECT  ct.cst_id

         ,WM_CONCAT(DISTINCT '|', ct.ctc_tel) AS ctc_tel

 FROM    edw.loan_CST_CTC_TEL ct --联系电话

 LEFT JOIN    edw.loan_CST_CTC_TEL_REL cr --联系电话关联信息

 ON      ct.serno = cr.rel_serno

 AND     ct.cst_id = cr.cst_id

 AND     cr.dt = '@@{yyyyMMdd}'

 AND     cr.rel_typ = '0001' --本人

 AND     COALESCE(cr.del_ind, '') <> '1'

 WHERE   ct.dt = '@@{yyyyMMdd}'

 AND      COALESCE(ct.del_ind, '') <> '1'

 GROUP BY ct.cst_id;





---***********************担保****************************************

-- CASE

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '010' THEN '家人'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '020' THEN '亲戚'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '030' THEN '朋友'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '040' THEN '合伙人'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '050' THEN '同事'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '060' THEN '邻居'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '070' THEN '法人与法定代表人'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '080' THEN '法人与实际控制人'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '090' THEN '法人与股东'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '100' THEN '上下游客户'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '102' THEN '借款人所在村村委'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '105' THEN '我行贷款户'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '108' THEN '社区关键人'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '110' THEN '其他'

-- WHEN loan_ctr_gtor_inf.with_brwr_rel = '6'   THEN '本人'

-- ELSE ''

-- END                                                                                     AS 与借款人关系

;



-- edw.loan_ctr_gtor_inf gr2 --保证人信息

-- edw.loan_svy_rel_gtor_inf gr3 --关联保证人信息

-- edw.dwd_bus_loan_ctr_grnt_ctr_grnt_rel_dd b2 --主合同、担保合同、担保物关系

-- edw.dwd_bus_loan_ctr_rel_grnt_dd  --主合同、担保合同关系。busi_typ_cd = '2' --信用卡业务







---*****人行征信***********



--征信分

SELECT  cst_id          AS 客户号

        ,prd_dt         AS 查询日期

        ,cst_cr_grd_val AS 最新征信分

        ,scor_rng       AS 最新征信分数段

        -- ,coalesce(scor_rng,cst_cr_grd_val) AS 最新征信分或分数段1

        ,CASE WHEN scor_rng IS NULL OR scor_rng='' THEN cst_cr_grd_val ELSE scor_rng END AS 最新征信分或分数段

        ,sc_src         AS 征信分来源表

FROM    (

            SELECT  cst_id

                    ,prd_dt

                    ,cst_cr_grd_val

                    ,scor_rng

                    ,sc_src

                    ,row_number() OVER ( PARTITION BY cst_id ORDER BY prd_dt DESC ) rn

            FROM    (

                        SELECT  cst_id

                                ,REPLACE(substr(qry_tm, 1, 10), '-', '') AS prd_dt

                                ,cr_sco_val                              AS cst_cr_grd_val

                                ,'' AS scor_rng

                                ,'中征分' sc_src

                        FROM    edw.DWD_CST_CCRC_IDV_SCOR_QRY_RCD_DI

                        WHERE   dt <= '@@{yyyyMMdd}'

                        AND     nvl(cr_sco_val, '') <> ''

                        UNION

                        SELECT  cst_id

                                ,prd_dt

                                ,cst_cr_grd_val

                                ,'' AS scor_rng

                                ,'中征分' sc_src

                        FROM    edw.DWD_CST_CCRC_IDV_SCOR_BTCH_ANLZ_RSLT_DI

                        WHERE   dt <= '@@{yyyyMMdd}'

                        AND     nvl(cst_cr_grd_val, '') <> ''

                        UNION

                        SELECT  cst_id

                                ,REPLACE(substr(report_dt, 1, 10), '-', '')

                                ,idv_crd_sco_val

                                ,scor_rng

                                ,'指标表' sc_src

                        FROM    edw.dws_cst_ccrc_idv_ind_inf_dd --个人征信指标信息表

                        WHERE   dt = '@@{yyyyMMdd}'

                        AND     nvl(idv_crd_sco_val, '') <> ''

                        UNION

                        SELECT  cst_id

                                ,SUBSTR(report_id, 1, 8)

                                ,CAST(digital_unscr AS INT)

                                ,'' AS scor_rng

                                ,'集市表' sc_src

                        FROM    adm_pub.adm_csm_cbus_out_crd_idv_bas_info_di

                        WHERE   dt <= '@@{yyyyMMdd}'

                        AND     nvl(digital_unscr, '') <> ''

                    ) t

        ) t

WHERE   rn = 1;



--

-- edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息

-- dtrb_org <> 'ZJTLCB' --发放机构不为泰隆

-- cls_dt >= '@@{yyyyMMdd}' --未关闭

-- pd_cd IN ( '11' , '12' , '13' , '21' , '31' , '32' , '33' , '41' , '51' , '52' , '53' , '91' , '99' ) --业务品种贷款&quot;



-- edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息

-- AND     A1.dtrb_org_typ_cd <> '' --排除发放机构为泰隆

-- AND     A1.cls_dt >= '@@{yyyyMMdd}' --未关闭

-- AND     A1.bus_pd_cls_cd = '11' --业务产品种类代码贷款

-- AND     LENGTH(NVL(A1.cst_id, '')) > 0&quot;

;



--  ,MAX(CASE WHEN A1.act_typ_cd not in ('R2' , 'R3' ,'C1')  THEN A1.ovd_trm END ) AS 他行贷款当前最大逾期期数   --账户类型不为 贷记卡、准贷记卡、催收账户

--            ,SUM(CASE WHEN A1.act_typ_cd not in ('R2' , 'R3' ,'C1')  THEN A1.ovd_amt END ) AS 他行贷款当前逾期金额

--            ,MAX(CASE WHEN A1.act_typ_cd  IN ('R2' , 'R3' )  THEN A1.ovd_trm END ) AS 他行信用卡当前最大逾期期数     --账户类型为 贷记卡、准贷记卡

--            ,SUM(CASE WHEN A1.act_typ_cd  IN ('R2' , 'R3' )  THEN A1.ovd_amt END ) AS 他行信用卡当前逾期金额

--            ,SUM(CASE WHEN A1.five_ctg_cd NOT IN ('1','2') THEN A1.ctr_bal END ) AS 他行不良余额    --五级分类不为正常，关注





--贷款征信机构家数和贷款余额

SELECT  A1.dt                     AS acct_dt

        ,A1.cst_id

        ,A1.report_id

        ,COUNT(DISTINCT dtrb_org) AS 贷款机构家数

        ,SUM(ctr_bal)             AS 贷款余额

FROM    edw.dim_cst_ccrc_idv_loan_inf_dd A1 --个人征信客户贷款信息

WHERE   A1.DT = '@@{yyyyMMdd}'

AND     ( A1.mtu_dt >= A1.DT

AND     ctr_bal > 0 ) --未到期

AND     A1.pd_cd IN ( '11' , '12' , '13' , '21' , '31' , '32' , '33' , '41' , '51' , '52' , '53' , '91' , '99' ) --业务品种贷款

AND     act_typ_cd NOT IN ( 'R2' , 'R3' , 'C1' ) --剔除贷记卡账户，准贷记卡账户，催收账户

GROUP BY A1.dt , A1.cst_id , A1.report_id

UNION ALL

SELECT  A1.dt                        AS acct_dt

        ,A1.cst_id

        ,A1.report_id

        ,COUNT(DISTINCT dtrb_org_cd) AS 贷款机构家数

        ,SUM(loan_bal)               AS 贷款余额

FROM    edw.dim_cst_ccrc_entp_loan_inf_dd A1 --企业征信客户贷款信息

WHERE   A1.DT = '@@{yyyyMMdd}'

AND     ( A1.loan_mtu_dt >= A1.DT

AND     loan_bal > 0 ) --未到期

AND     A1.bus_pd_cls_cd = '11' --业务产品种类代码贷款

AND     act_typ NOT IN ( 'D2' , 'C1' ) ---- 剔除催收账户和贴现账户

GROUP BY A1.dt , A1.cst_id , A1.report_id;





---外数：个人工商

--1.4 工商法人  存在客户号和客户名称都是空的



SELECT  distinct B1.*

FROM    (

            SELECT  A1.*

                    ,RANK() OVER ( PARTITION BY A1.by_qry_psn_doc_nbr  ORDER BY substr(replace(DAT_INS_TM,'-',''),1,8) DESC ) AS RN   -- 取某个证件号最新一次（精确到天）的查询信息

            FROM    (

                        SELECT  CST_ID              AS CST_ID

                                ,BY_QRY_PSN_NM      AS BY_QRY_PSN_NM

                                ,by_qry_psn_doc_nbr AS by_qry_psn_doc_nbr

                                ,DAT_INS_TM         AS DAT_INS_TM

                                ,USCC               AS USCC

                                ,entp_nm            AS entp_nm

                                ,ENTP_TYP           AS ENTP_TYP

                                ,ENTP_STS           AS ENTP_STS

                                ,PVC                AS PVC

                        FROM    edw.DIM_CST_OUT_GEB_IDV_PPL_LGP_INF_DD --工商个人人员法人信息事实表新

                        WHERE   DT = '20241231'

                        AND     by_qry_psn_doc_nbr <> ''

                        and (coalesce(uscc,'')<>'' or coalesce(entp_id,'') <>'' or coalesce(entp_nm,'')<>'')

                        UNION

                        SELECT  CST_ID       AS CST_ID

                                ,CST_NM      AS BY_QRY_PSN_NM

                                ,doc_nbr     AS by_qry_psn_doc_nbr

                                ,QRY_TM      AS DAT_INS_TM

                                ,CSLD_CRD_CD AS USCC

                                ,entp_nm     AS entp_nm

                                ,ENTP_TYP    AS ENTP_TYP

                                ,ENTP_STS    AS ENTP_STS

                                ,PVC         AS PVC

                        FROM    edw.DIM_CST_OUT_GEB_IDV_LGP_INF_DD  --工商个人人员法人信息事实表老

                        -- WHERE   DT = MAX_PT('${odps_edw}.DIM_CST_OUT_GEB_IDV_LGP_INF_DD');

                        WHERE   DT = '20241231'

                        AND     doc_nbr <> ''

                        and (coalesce(csld_crd_cd,'')<>'' or coalesce(entp_id,'')<>'' or coalesce(entp_nm,'')<>'')

                    ) A1

        ) B1

WHERE   B1.RN = 1;





---***********************个人担任企业法人****************************************

SELECT  *

FROM    (

            SELECT  *

                    ,row_number() OVER ( PARTITION BY in_ctfno , dt_gpr_creditcode ORDER BY dt DESC ) AS rk

            FROM    (

                        SELECT  dt

                                ,in_ctfno --高管证件号

                                ,in_namecn --高管姓名

                                ,dt_gpr_entname --企业(机构)名称

                                ,dt_gpr_enttype --企业(机构)类型

                                ,dt_gpr_entstatus --企业状态

                                ,dt_gpr_creditcode --统一社会信用代码

                        FROM    edw.nout_gs_prsn_ryposfrtd --工商个人替代-人员法人信息

                        WHERE   dt <= '20241023' ---------------xt:添加查得标识=1

                        AND     gpr_ifrichard = '1'  --查的标识=1

                        UNION ALL

                        SELECT  dt

                                ,gpm_ctfno in_ctfno

                                ,gpm_namecn in_namecn

                                ,gpr_entname dt_gpr_entname

                                ,gpr_enttype dt_gpr_enttype

                                ,gpr_entstatus dt_gpr_entstatus   --企业状态

                                ,gpr_creditcode AS dt_gpr_creditcode --统一社会信用代码

                        FROM    (

                                    SELECT  *

                                    FROM    (

                                                SELECT  c.dt

                                                        ,gpm_ctfno --被查询人证件号码

                                                        ,gpm_namecn --被查询人姓名

                                                        ,c.gpr_entname --企业(机构)名称

                                                        ,c.gpr_entstatus --企业状态

                                                        ,c.gpr_enttype --企业(机构)类型

                                                        ,c.gpr_creditcode --统一社会信用代码

                                                        ,ROW_NUMBER() OVER ( PARTITION BY gpm_ctfno ORDER BY gpm_hostsendtime DESC ) rn

                                                FROM    edw.outd_gs_person_main a --工商个人主表

                                                INNER JOIN    edw.outd_gs_person_ryposfr c --工商个人-人员法人信息

                                                ON      a.gpm_flowno = c.gpr_flowno

                                                AND     c.dt <= '20241023' ---- 作为法人的企业信息

                                                WHERE   a.dt <= '20241023'

                                                AND     substr(a.gpm_hostsendtime, 1, 8) <= '20241023'

                                            ) aa

                                    WHERE   aa.rn = 1

                                ) cc

                    ) bb

        ) d

WHERE   d.rk = 1

AND     d.dt_gpr_entstatus RLIKE '在营';







--******************************预评估********************************

SELECT  T1.cst_id                                                                  AS 客户号

        ,T2.cd_val_dscr                                                            AS 最近一次预评估结果

        ,T1.sys_reg_tm                                                             AS 最近一次预评估时间

        ,ROW_NUMBER() OVER ( PARTITION BY T1.cst_id ORDER BY T1.last_upd_tm DESC ) AS RN

FROM    edw.dwd_bus_loan_pre_ases_bsn_aply_dd T1 --预评估业务申请

LEFT JOIN    edw.dim_bus_loan_pre_ases_rul_set_rel_dd T0 --预评估规则集关系

ON      T1.PRE_ASES_SERNO = T0.pre_ases_serno

AND     T0.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd T2 -- 码值表

ON      T0.rul_set_rslt_cd = T2.cd_val

AND     T2.tbl_nm = 'DWD_BUS_LOAN_LMT_APLY_REL_ASES_DD'

AND     T2.fld_nm = 'RUL_SET_RSLT_CD'

AND     T2.DT = '@@{yyyyMMdd}'

WHERE   T1.DT = '@@{yyyyMMdd}'

;

-----

SELECT  DISTINCT bl.pre_ases_serno

                 ,sp.svy_rslt AS 抗辩上诉调查结果

FROM    edw.dwd_bus_loan_pre_spcl_chnl_aply_dd bl --特殊通道申请

LEFT JOIN    edw.dim_bus_loan_pre_spcl_chnl_exvrf_opnn_dd sp --特殊通道审核意见，取抗辩理由

ON      coalesce(bl.spcl_chnl_no) = sp.spcl_chnl_no

AND     sp.dt = '20241031'

WHERE   bl.dt = '20241031'







--******调查





-- edw.DIM_CST_BAS_AST_LBL_INF_DD   --信贷调查记录-客户资产负债信息



---******精准贷后*******

;

SELECT distinct  T1.chk_psn_bel_org_no            AS 检查人机构号

        ,T1.btch_serno                   AS 任务流水号

        ,T1.cst_id                       AS 客户号

        ,T1.cst_nm                       AS 客户名称

        ,T1.aprv_sts_cd                  AS 审批状态代码

        ,T4.cd_val_dscr                  AS 审批状态

        ,T1.pst_loan_chk_btch_tsk_sts_cd AS 任务状态代码

        ,T5.cd_val_dscr                  AS 任务状态

        ,T2.pst_loan_chk_tsk_src_cd      AS 任务来源代码

        ,CASE

           WHEN T2.pst_loan_chk_tsk_src_cd = '02' THEN '常规贷后'

           WHEN T2.pst_loan_chk_tsk_src_cd = '03' THEN '自主贷后'

           WHEN T2.pst_loan_chk_tsk_src_cd = '04' THEN '精准贷后-信用卡'

           WHEN T2.pst_loan_chk_tsk_src_cd = '01' THEN '精准贷后'

         END                             AS 任务来源

        ,T6.cd_val_dscr                  AS 任务类型

        ,B1.due_dt                       AS 贷后检查有效期

        ,''                              AS 是否有超期精准贷后

        ,''                              AS 超期天数

        ,T1.sys_reg_tm                   AS 客户经理提交日期

        ,B1.realend_dt                   AS 任务实际完成日期

        ,B1.end_dt                       AS 检查完成日期

        ,B1.start_dt                     AS 任务生成日期

        ,T1.cst_rsk_dgr_cd               AS 客户风险程度代码

        ,CASE

           WHEN T1.cst_rsk_dgr_cd = '01' THEN '正常'

           WHEN T1.cst_rsk_dgr_cd = '02' THEN '风险可控'

           WHEN T1.cst_rsk_dgr_cd = '03' THEN '存在风险隐患'

           WHEN T1.cst_rsk_dgr_cd = '04' THEN '风险暴露'

         END                             AS 客户风险程度

        ,CASE

           WHEN T1.ori_rsk_lyr_cd = '1' THEN '低风险'

           WHEN T1.ori_rsk_lyr_cd = '5' THEN '高风险'

           WHEN T1.ori_rsk_lyr_cd = '2' THEN '中低风险'

           WHEN T1.ori_rsk_lyr_cd = '3' THEN '中风险'

           WHEN T1.ori_rsk_lyr_cd = '4' THEN '中高风险'

         END                             AS 原风险分层代码

        ,CASE

           WHEN T1.svy_rsk_lyr_cd = '1' THEN '低风险'

           WHEN T1.svy_rsk_lyr_cd = '5' THEN '高风险'

           WHEN T1.svy_rsk_lyr_cd = '2' THEN '中低风险'

           WHEN T1.svy_rsk_lyr_cd = '3' THEN '中风险'

           WHEN T1.svy_rsk_lyr_cd = '4' THEN '中高风险'

         END                             AS 调查后风险分层代码

        ,CASE

           WHEN B2.svy_mod_cd = '04' THEN '侧面打听（现场）'

           WHEN B2.svy_mod_cd = '01' THEN '现场（实地）'

           WHEN B2.svy_mod_cd = '02' THEN '云调查'

           WHEN B2.svy_mod_cd = '03' THEN '非现场'

           WHEN B2.svy_mod_cd = '05' THEN '侧面打听（非现场）'

           WHEN B2.svy_mod_cd = '06' THEN '侧面打听（批量）'

         END                             AS 调查方式

        ,B3.mng_pln_lvl_cd               AS 管理方案级别代码

        ,CASE

           WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '01' THEN '维持'

           WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '02' THEN '标记观察'

           WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '03' THEN '重组'

           WHEN B3.cst_lvl_pst_loan_mng_pln_cd = '04' THEN '退出'

         END                             AS 客户级贷后管理方案代码

        ,B4.业务贷后管理方案                     AS 业务贷后管理方案

        ,T1.chk_psn_id                   AS 检查人工号

        ,B5.empe_nm                      AS 检查人姓名

        ,''                              AS 触犯规则来源

        ,B1.trg_typ                      AS 触犯规则类型

        ,B1.offend_rsn                   AS 触犯原因

        ,B1.offend_rsn_ana               AS 触犯原因分析

        ,B1.is_fnd_norm                  AS 资金使用是否存在异常

        ,B1.is_assets_chg                AS 客户资产负债是否变化

        ,B1.is_bus_chg                   AS 客户_业务贷后管理方案

        ,B1.is_guaranty_norm             AS 担保人_物情况是否异常

        ,B1.is_oth_norm                  AS 客户是否存在其他异常信息

        ,B1.fin_stt                      AS 财务状况分析

        ,B1.opr_situ                     AS 经营情况

        ,B1.fnd_flw_dir                  AS 资金流向

        ,B1.ast_lbl_situ                 AS 资产负债情况

        ,''                              AS 其它信息

        ,B1.guaranty_appraise            AS 全部担保人担保能力总体评价

        ,B1.opr_appraise                 AS 申请人与关联人经营情况总体评价

        ,B1.is_rational                  AS 授信必要性和合理性

        ,B1.aprv_opnn                    AS 批复意见执行情况

FROM    edw.dwd_bus_loan_psp_chk_btch_inf_dd T1 --贷后检查批次信息表

INNER JOIN    edw.dwd_bus_loan_psp_chk_tsk_inf_dd T2 --贷后检查任务信息

ON      T1.btch_serno = T2.btch_serno

AND     T2.pst_loan_chk_tsk_src_cd = '01' --精准贷后  贷后检查任务来源代码

--AND     T2.pst_loan_chk_tsk_typ_cd IN ( '01' , '02' , '03' , '04' ) --01 处置1级, 02 处置2级, 03 预警类, 04 提示类

AND     T2.DT = '@@{yyyyMMdd}'

LEFT JOIN    adm_rsk.adm_rsk_apl_prc_pst_loan_mnt_dd B1 --精准贷后-任务宽表

ON      T1.btch_serno = B1.serialno

AND     B1.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_bus_loan_psp_chk_rel_svy_dd B2 --贷后检查批次与调查记录关联关系

ON      T1.btch_serno = B2.btch_serno

AND     B2.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.loan_psp_chk_cnlu_info B3 --信贷调查结论信息

ON      T1.btch_serno = B3.btch_serno

AND     B3.DT = '@@{yyyyMMdd}'

LEFT JOIN    (

                 SELECT  A1.btch_serno

                         ,WM_CONCAT('||', CONCAT(A1.ctr_serno, '-', A2.cd_val_dscr)) AS 业务贷后管理方案

                 FROM    edw.dwd_bus_loan_bsn_mng_pln_dd A1 --业务贷后管理方案

                 LEFT JOIN    edw.dwd_code_library_dd A2 -- 码值表

                 ON      A1.PST_LOAN_MNG_PLN_CD = A2.cd_val

                 AND     A2.tbl_nm = 'DWD_BUS_LOAN_BSN_MNG_PLN_DD'

                 AND     A2.fld_nm = 'PST_LOAN_MNG_PLN_CD'

                 AND     A2.DT = '@@{yyyyMMdd}'

                 WHERE   A1.DT = '@@{yyyyMMdd}'

                 GROUP BY A1.btch_serno

             ) B4

ON      T1.btch_serno = B4.btch_serno

LEFT JOIN    edw.dws_hr_empe_inf_dd B5 --员工汇总信息

ON      T1.chk_psn_id = B5.empe_id

AND     B5.DT = '@@{yyyyMMdd}'

LEFT JOIN    (

                 SELECT  A1.btch_serno

                         ,CONCAT(A1.rul_ctg_nm, '-', A1.rul_sub_clss_nm)                                AS 触发规则

                         ,A1.rul_ctg_nm --规则分类名称

                         ,A1.rul_sub_clss_nm --规则细类名称

                         ,ROW_NUMBER() OVER ( PARTITION BY A1.btch_serno ORDER BY sgnl_rul_serno DESC ) AS RN

                 FROM    edw.dwd_bus_loan_psp_chk_tsk_rel_sgnl_dd A1 --任务关联信号明细

                 WHERE   A1.DT = '@@{yyyyMMdd}'

             ) T3

ON      T1.btch_serno = T3.btch_serno

AND     T3.RN = 1

LEFT JOIN    edw.dwd_code_library_dd T4 -- 码值表

ON      T1.aprv_sts_cd = T4.cd_val

AND     T4.tbl_nm = 'DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD'

AND     T4.fld_nm = 'APRV_STS_CD'

AND     T4.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd T5 -- 码值表

ON      T1.pst_loan_chk_btch_tsk_sts_cd = T5.cd_val

AND     T5.tbl_nm = 'DWD_BUS_LOAN_PSP_CHK_BTCH_INF_DD'

AND     T5.fld_nm = 'PST_LOAN_CHK_BTCH_TSK_STS_CD'

AND     T5.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_code_library_dd T6 -- 码值表

ON      T2.pst_loan_chk_tsk_typ_cd = T6.cd_val

AND     T6.tbl_nm = 'DWD_BUS_LOAN_PSP_CHK_TSK_INF_DD'

AND     T6.fld_nm = 'PST_LOAN_CHK_TSK_TYP_CD'

AND     T6.DT = '@@{yyyyMMdd}'

WHERE   T1.DT = '@@{yyyyMMdd}'

AND     substr(REPLACE(T1.sys_reg_tm,'-',''), 1, 8) BETWEEN '20231101' AND '20241031'

;





--**************风险集市************









--***********************催记***************



SELECT

        T1.col_1 As 提供卡号

        ,T2.coln_date    AS 催收日期

        ,T2.cont_card_no AS 合同号卡号

        ,T2.cust_nm      AS 客户名称

        ,T2.cust_no      As 客户编号

        ,CASE

           WHEN T2.col_obj = '01' THEN '本人'

           WHEN T2.col_obj = '02' THEN '担保人'

           WHEN T2.col_obj = '03' THEN '联系人'

           WHEN T2.col_obj = '04' THEN '第三方'

           ELSE ''

         END 催收对象

        ,T2.contact_name AS 催收对象名称

        ,CASE

           WHEN T2.coln_way = '20' THEN '债务拆分'

           WHEN T2.coln_way = '14' THEN 'AI催收'

           WHEN T2.coln_way = '07' THEN '诉讼'

           WHEN T2.coln_way = '17' THEN '分期还款'

           WHEN T2.coln_way = '99' THEN '其他'

           WHEN T2.coln_way = '03' THEN '催收电子邮件'

           WHEN T2.coln_way = '13' THEN '律师函催收'

           WHEN T2.coln_way = '04' THEN '电话录音催收'

           WHEN T2.coln_way = '19' THEN '重组'

           WHEN T2.coln_way = '15' THEN '客户中心二组电话催收'

           WHEN T2.coln_way = '08' THEN '公安立案'

           WHEN T2.coln_way = '05' THEN '客户中心一组电话催收'

           WHEN T2.coln_way = '18' THEN '利息减免'

           WHEN T2.coln_way = '02' THEN '催收短信'

           WHEN T2.coln_way = '11' THEN '现场催收'

           WHEN T2.coln_way = '01' THEN '催收通知书'

           WHEN T2.coln_way = '16' THEN '催收函'

           WHEN T2.coln_way = '09' THEN '报纸公告'

           WHEN T2.coln_way = '06' THEN '上门催收'

           ELSE ''

         END 催收方式

        ,T2.coln_usr_no  AS 催收人员编号行内

        ,T2.coln_user    AS 催收人员名称行内

        ,T2.out_person   AS 催收人员名称行外

        ,T2.input_usr_no 登记人

        ,t2.input_usr_name 登记人姓名

        ,T2.input_org_no 登记机构

        ,T2.input_date   AS 登记时间

        ,CASE

           WHEN t2.coln_source = '101060' THEN '金融移动服务站'

           WHEN t2.coln_source = '113010' THEN '小鱼泡泡'

           WHEN t2.coln_source = '202020' THEN '信贷系统'

           WHEN t2.coln_source = '202021' THEN 'PC'

           WHEN t2.coln_source = '413010' THEN '小鱼管家'

           WHEN t2.coln_source = '440010' THEN '智能AI'

           WHEN t2.coln_source = '449010' THEN '人工外呼'

           WHEN t2.coln_source = '102010' THEN '短信平台'

           ELSE ''

         END 催收渠道

        ,t2.coln_result  AS 催收内容

        ,T2.call_status  AS 外呼状态

        ,CASE

           WHEN t2.collect_status = '01' THEN '承诺还款'

           WHEN t2.collect_status = '02' THEN '谈判中'

           WHEN t2.collect_status = '05' THEN '其他'

           WHEN t2.collect_status = '03' THEN '转告还款'

           WHEN t2.collect_status = '04' THEN '无法触达'

           ELSE ''

         END 催收状态

        ,CASE

           WHEN T2.DC_THOGH_STATUS = '1'   THEN '无人接听'

           WHEN T2.DC_THOGH_STATUS = '100' THEN '未接通'

           WHEN T2.DC_THOGH_STATUS = '111' THEN '已告知，未明显表态，有效接通'

           WHEN T2.DC_THOGH_STATUS = '12'  THEN '已告知'

           WHEN T2.DC_THOGH_STATUS = '130' THEN '其他-请看催记备注'

           WHEN T2.DC_THOGH_STATUS = '131' THEN '否认消费（部分交易）'

           WHEN T2.DC_THOGH_STATUS = '132' THEN '否认消费（全部交易）'

           WHEN T2.DC_THOGH_STATUS = '134' THEN '拒绝还款，要投诉'

           WHEN T2.DC_THOGH_STATUS = '135' THEN '无还款能力'

           WHEN T2.DC_THOGH_STATUS = '136' THEN '其他-见催记备注'

           WHEN T2.DC_THOGH_STATUS = '137' THEN '失联'

           WHEN T2.DC_THOGH_STATUS = '138' THEN '生病'

           WHEN T2.DC_THOGH_STATUS = '139' THEN '涉刑'

           WHEN T2.DC_THOGH_STATUS = '140' THEN '欺诈情况'

           WHEN T2.DC_THOGH_STATUS = '141' THEN '反催特点'

           WHEN T2.DC_THOGH_STATUS = '142' THEN '死亡'

           WHEN T2.DC_THOGH_STATUS = '143' THEN '移交专家'

           WHEN T2.DC_THOGH_STATUS = '144' THEN '其他-详见催记备注'

           WHEN T2.DC_THOGH_STATUS = '145' THEN '分期'

           WHEN T2.DC_THOGH_STATUS = '146' THEN '减免'

           WHEN T2.DC_THOGH_STATUS = '147' THEN 'ZXT/ZD'

           WHEN T2.DC_THOGH_STATUS = '149' THEN '他人代偿（需登记关系）'

           WHEN T2.DC_THOGH_STATUS = '150' THEN '承诺一次性还款'

           WHEN T2.DC_THOGH_STATUS = '160' THEN '要求短分期（小于等于24期）'

           WHEN T2.DC_THOGH_STATUS = '161' THEN '要求长分期（大于24期）'

           WHEN T2.DC_THOGH_STATUS = '162' THEN '要求全额减免利息'

           WHEN T2.DC_THOGH_STATUS = '163' THEN '已承诺减免'

           WHEN T2.DC_THOGH_STATUS = '165' THEN '话务条异常'

           WHEN T2.DC_THOGH_STATUS = '168' THEN '空号/停机'

           WHEN T2.DC_THOGH_STATUS = '17'  THEN '通话中全部归还'

           WHEN T2.DC_THOGH_STATUS = '2'   THEN '拒接'

           WHEN T2.DC_THOGH_STATUS = '3'   THEN '忙音'

           WHEN T2.DC_THOGH_STATUS = '4'   THEN '错号'

           WHEN T2.DC_THOGH_STATUS = '5'   THEN '空号'

           WHEN T2.DC_THOGH_STATUS = '6'   THEN '停机'

           WHEN T2.DC_THOGH_STATUS = '7'   THEN '关机'

           WHEN T2.DC_THOGH_STATUS = '8'   THEN '呼叫限制'

           WHEN T2.DC_THOGH_STATUS = '9'   THEN '话务条异常'

           ELSE ''

         END             AS 电催结果

FROM    lab_bigdata_dev.qbi_file_20250205_11_02_25_0 T1 --导入数据

LEFT JOIN    edw.zcbq_risk_collect_record T2 --催收痕迹

ON      T1.col_1 = T2.cont_card_no

and T2.dt='@@{yyyyMMdd}'

-- and T2.coln_date BETWEEN '2022-01-01 00:00:00' AND '2024-12-31 23:59:00'

where  T1.pt<>''





---***审批结果**

SELECT  A1.usc_aply_serno

        ,A1.aply_epsr_amt

        ,A1.apl_amt

        ,t.exec_intr_rat

        ,B.user_name

        ,B.user_id

        ,B.node_name

        ,ROW_NUMBER() OVER ( PARTITION BY A1.usc_aply_serno ORDER BY B.end_time DESC ) AS RN

FROM    edw.dwd_bus_loan_lmt_aply_biz_dd A1 --用信方案

LEFT JOIN    edw.dwd_bus_loan_lmt_aply_info_dd t ---- 授用信申请信息

ON      T.ahn_ltr_aply_serno = A1.ahn_ltr_aply_serno

AND     T.cst_id = A1.cst_id

AND     T.DT = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_bus_loan_n_wf_instance_his_dd a --流程运行实例历史表

ON      t.ahn_ltr_aply_serno = a.biz_id

AND     t.sys_reg_psn_id = a.flow_starter ---- 授信申请登记者 = 流程发起者   不然会有多条记录

AND     a.dt = '@@{yyyyMMdd}'

LEFT JOIN    edw.dwd_bus_loan_n_wf_node_his_dd b --流程办结表  --只保留了最后一次流程提交或审批的时间

ON      a.main_instance_id = b.instance_id

AND     b.dt = '@@{yyyyMMdd}'

WHERE   A1.DT = '@@{yyyyMMdd}'

;



---********短信

-- 短信平台数据数仓保存期限

-- 20180730-20220101：数仓edw.dxpt_gsms_msg_ticket_sms

-- 20220101-20221117：短信平台玄武，无信用卡短信

--20230713-至今：edw.ncrd_smscontent  --银数短信,逾期短信通过银数发

-- 20221117-至今4天前：数仓edw.nsms_gsms_msg_ticket_sms

--  2008-2019 老短信平台（非玄武平台） 短信发送记录导出成文本备份在 20.3.21.31





SELECT  A1.phone                                                                                                                                                      AS 手机号

        ,'潘天宋'                                                                                                                                                        AS 姓名

        ,A1.sms_content                                                                                                                                               AS 短信内容

        ,to_char(A1.post_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                                 AS 提交时间

        ,to_char(A1.submit_resp_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                          AS 发送时间

        ,DATEDIFF(to_char(A1.submit_resp_time, 'yyyy-mm-dd hh:mm:ss'), to_char(A1.post_time, 'yyyy-mm-dd hh:mm:ss'), 'ss')                                            AS 发送时效

        ,CASE

           WHEN A1.state = '1' THEN '成功'

           WHEN A1.state = '7' THEN '失败'

           WHEN A1.state = '0' THEN '待发送'

         END                                                                                                                                                          AS 发送结果

        ,A1.spec_number                                                                                                                                               AS 发送端口

        ,A2.result

        ,A2.origin_result

        ,decode(A2.origin_result,'MI:0013', '停机', 'MI:0029', '关机', 'MK:0001', '空号', 'MK:0011', '停机', 'MK:0013', '手机终端问题', 'MK:0029', '用户关机，无法接通','DELIVRD', '', NULL, '') AS 号码状态

FROM    edw.nsms_gsms_msg_ticket_sms A1 --20221109-至今4天前：数仓,最早日期20221109

LEFT JOIN    edw.nsms_gsms_statereport A2 ---存放状态报告信息,最早日期20221109

ON      A1.msg_id = A2.msg_id

AND     A1.dt = A2.dt

AND     A2.dt >= '20221109'

WHERE   A1.DT >= '20221109'

AND     numbers = '0' --0是整段短信

AND     A1.phone = '13738635186'

UNION ALL

SELECT  T2.phone                                                                                                                                                      AS 手机号

        ,'潘天宋'                                                                                                                                                        AS 姓名

        ,T2.sms_content                                                                                                                                               AS 短信内容

        ,to_char(T2.post_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                                 AS 提交时间

        ,to_char(T2.submit_resp_time, 'yyyy-mm-dd hh:mm:ss')                                                                                                          AS 发送时间

        ,DATEDIFF(to_char(T2.submit_resp_time, 'yyyy-mm-dd hh:mm:ss'), to_char(T2.post_time, 'yyyy-mm-dd hh:mm:ss'), 'ss')                                            AS 发送时效

        ,CASE

           WHEN T2.state = '1' THEN '成功'

           WHEN T2.state = '7' THEN '失败'

           WHEN T2.state = '0' THEN '待发送'

         END                                                                                                                                                          AS 发送结果

        ,T2.spec_number                                                                                                                                               AS 发送端口

        ,A2.result

        ,A2.origin_result

        ,decode(A2.origin_result,'MI:0013', '停机', 'MI:0029', '关机', 'MK:0001', '空号', 'MK:0011', '停机', 'MK:0013', '手机终端问题', 'MK:0029', '用户关机，无法接通','DELIVRD', '', NULL, '') AS 号码状态

FROM    edw.dxpt_gsms_msg_ticket_sms T2 --20180730-20220101,最早20190926，最晚20221211

LEFT JOIN    edw.nsms_gsms_statereport A2 ---存放状态报告信息,最早日期20221109

ON      T2.msg_id = A2.msg_id

AND     A2.dt >= '20221109'

AND     A2.dt = T2.dt

WHERE   T2.dt <= '20221211'

AND     T2.phone = '13738635186'

AND     T2.number = '0' --整段

;





-- --短信记录为空,可以不用看这张表。

-- SELECT mbl_nbr  as 手机号

--       ,sms_snd_tm  as 发送时间

--       ,sms_snd_cntnt as 短息内容

-- FROM edw.ncrd_smscontent    --20230713至今

-- WHERE dt>='20230713'

-- and mbl_nbr= '13738635186'



--******冠字号

SELECT  c_term_id 终端编号

        ,c_seria_no  纸币冠字号码

        ,c_tran_date 交易时间

FROM    edw.gzhs_cml_sent_infos_day -- --纸币冠字号码日表,增量表

WHERE   dt ='20240626'

-- AND     c_tran_date > '20240626150000'

-- AND     c_tran_date < '20240626153500'

AND     c_pathcode IN (

                          SELECT  c_pathcode

                          FROM    edw.gzhs_org_info --机构

                          WHERE   dt = '20240626'

                          AND     c_orgcode = '330108700' --玉环沙门小微企业专营支行

)

AND     c_machine_type = '3'